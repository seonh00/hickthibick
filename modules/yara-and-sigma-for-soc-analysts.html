
<body>
  <div class="container">
<link rel="stylesheet" href="style.css">

<h1 id="yara-sigma-for-soc-analysts">YARA &amp; Sigma for SOC Analysts</h1>
<h2 id="introduction-to-yara-sigma">Introduction to YARA &amp; Sigma</h2>
<p><a href="https://virustotal.github.io/yara/">YARA</a> and <a href="https://github.com/SigmaHQ/sigma">Sigma</a> are two essential tools used by SOC analysts to enhance their threat detection and incident response capabilities. They empower analysts with improved threat detection capabilities, efficient log analysis, malware detection and classification, IOC identification, collaboration, customization, and integration with existing security tools.</p>
<p>Both YARA and Sigma rules grant SOC analysts potent capabilities to detect and respond to security threats. YARA excels in file and memory analysis, as well as pattern matching, whereas Sigma is particularly adept at log analysis and SIEM systems.</p>
<p>These detection rules utilize conditional logic applied to logs or files. Analysts craft these rules to pinpoint suspicious activities in logs or match patterns in files. These rules are pivotal in making detections more straightforward to compose, and thus, they constitute a crucial element of an effective threat detection strategy. Both YARA and Sigma adhere to standard formats that facilitate the creation and sharing of detection rules within the cybersecurity community.</p>
<h3 id="importance-of-yara-and-sigma-rules-for-soc-analysts">Importance of YARA and Sigma rules for SOC Analysts</h3>
<p>Let&#39;s explore the key reasons why YARA and Sigma are invaluable for SOC analysts:</p>
<ul>
<li><strong><code>Enhanced Threat Detection</code></strong>: YARA and Sigma rules allow SOC analysts to develop customized detection rules tailored to their unique environment and security needs. These rules empower analysts to discern patterns, behaviors, or indicators linked to security threats, thus enabling them to proactively detect and address potential incidents. Various Github repositories provide a wealth of examples of YARA and Sigma rules.<ul>
<li><code>YARA rules</code>: <a href="https://github.com/Yara-Rules/rules/tree/master/malware">https://github.com/Yara-Rules/rules/tree/master/malware</a>, <a href="https://github.com/mikesxrs/Open-Source-YARA-rules/tree/master">https://github.com/mikesxrs/Open-Source-YARA-rules/tree/master</a></li>
<li><code>Sigma rules</code> <a href="https://github.com/SigmaHQ/sigma/tree/master/rules">https://github.com/SigmaHQ/sigma/tree/master/rules</a>, <a href="https://github.com/joesecurity/sigma-rules">https://github.com/joesecurity/sigma-rules</a>, <a href="https://github.com/mdecrevoisier/SIGMA-detection-rules">https://github.com/mdecrevoisier/SIGMA-detection-rules</a></li>
</ul>
</li>
<li><strong><code>Efficient Log Analysis</code></strong>: Sigma rules are essential for log analysis in a SOC setting. Utilizing Sigma rules, analysts can filter and correlate log data from disparate sources, concentrating on events pertinent to security monitoring. This minimizes irrelevant data and enables analysts to prioritize their investigative efforts, leading to more efficient and effective incident response. An open-source tool called <a href="https://github.com/WithSecureLabs/chainsaw">Chainsaw</a> can be used to apply Sigma rules to event log files.</li>
<li><strong><code>Collaboration and Standardization</code></strong>: YARA and Sigma offer standardized formats and rule structures, fostering collaboration among SOC analysts and tapping into the collective expertise of the broader cybersecurity community. This encourages knowledge sharing, the formulation of best practices, and keeps analysts abreast of cutting-edge threat intelligence and detection methodologies. For instance, &quot;The <a href="https://thedfirreport.com/">DFIR Report</a>&quot; shares YARA and Sigma rules derived from their investigations.<ul>
<li><a href="https://github.com/The-DFIR-Report/Yara-Rules">https://github.com/The-DFIR-Report/Yara-Rules</a></li>
<li><a href="https://github.com/The-DFIR-Report/Sigma-Rules">https://github.com/The-DFIR-Report/Sigma-Rules</a></li>
</ul>
</li>
<li><strong><code>Integration with Security Tools</code></strong>: YARA and Sigma rules can be integrated seamlessly with a plethora of security tools, including SIEM platforms, log analysis systems, and incident response platforms. This integration enables automation, correlation, and enrichment of security events, allowing SOC analysts to incorporate the rules into their existing security infrastructure. As an example, <a href="https://uncoder.io/">Uncoder.io</a> facilitates the conversion of Sigma rules into tailor-made, performance-optimized queries ready for deployment in the chosen SIEM and XDR systems.</li>
<li><strong><code>Malware Detection and Classification</code></strong>: YARA rules are particularly useful for SOC analysts in pinpointing and classifying malware. Leveraging YARA rules, analysts can create specific patterns or signatures that correspond to known malware traits or behaviors. This aids in the prompt detection and mitigation of malware threats, bolstering the organization&#39;s overall security posture.</li>
<li><strong><code>Indicator of Compromise (IOC) Identification</code></strong>: Both YARA and Sigma rules empower SOC analysts to locate and identify IOCs, which are distinct artifacts or behaviors linked to security incidents or breaches. By embedding IOCs into their rules, analysts can swiftly detect and counter potential threats, thus mitigating the consequences of security incidents and curtailing the duration of attackers&#39; presence within the network.</li>
</ul>
<h2 id="yara-and-yara-rules">YARA and YARA Rules</h2>
<p><code>YARA</code> is a powerful pattern-matching tool and rule format used for identifying and classifying files based on specific patterns, characteristics, or content. SOC analysts commonly use YARA rules to detect and classify malware samples, suspicious files, or indicators of compromise (IOCs).</p>
<p>YARA rules are typically written in a rule syntax that defines the conditions and patterns to be matched within files. These rules can include various elements, such as strings, regular expressions, and Boolean logic operators, allowing analysts to create complex and precise detection rules. It&#39;s important to note that YARA rules can recognize both textual and binary patterns, and they can be applied to memory forensics activities as well.</p>
<p>When applied, YARA scans files or directories and matches them against the defined rules. If a file matches a specific pattern or condition, it can trigger an alert or warrant further examination as a potential security threat.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/234/yara\_intro.png" alt=""></p>
<p>YARA rules are especially useful for SOC analysts when analyzing malware samples, conducting forensic investigations, or performing threat hunting activities. The flexibility and extensibility of YARA make it a valuable tool in the cybersecurity community.</p>
<h3 id="usages-of-yara">Usages of Yara</h3>
<ul>
<li><strong><code>Malware Detection and Classification</code></strong>: YARA is commonly used for detecting and identifying malware samples based on specific patterns, characteristics, or indicators. YARA rules can be created to match against known malware signatures, behaviors, or file properties, aiding in the identification of malicious files and potentially preventing further compromise. Within the scope of digital forensics, YARA can also identify suspicious or malicious patterns in captured memory images.</li>
<li><strong><code>File Analysis and Classification</code></strong>: YARA is valuable for analyzing and classifying files based on specific patterns or attributes. Analysts can create YARA rules to categorize files by different file formats or file type, version, metadata, packers or other characteristics. This capability is useful in forensic analysis, malware research, or identifying specific file types within large datasets.</li>
<li><strong><code>Indicator of Compromise (IOC) Detection</code></strong>: YARA can be employed to search for specific indicators of compromise (IOCs) within files or directories. By defining YARA rules that target specific IOC patterns, such as file names, registry keys, or network artifacts, security teams can identify potential security breaches or ongoing attacks.</li>
<li><strong><code>Community-driven Rule Sharing</code></strong>: With YARA, we have the ability to tap into a community that regularly contributes and shares their detection rules. This ensures that we constantly update and refine our detection mechanisms.</li>
<li><strong><code>Create Custom Security Solutions</code></strong>: By combining YARA rules with other techniques like static and dynamic analysis, sandboxing, and behavior monitoring, effective security solutions can be created.</li>
<li><strong><code>Custom Yara Signatures/Rules</code></strong>: YARA allows us to create custom rules tailored to our organization&#39;s specific needs and environment. By deploying these custom rules in our security infrastructure, such as antivirus or endpoint detection and response (EDR) solutions, we can enhance our defense capabilities. Custom YARA rules can help identify unique or targeted threats that are specific to our organization&#39;s assets, applications, or industry.</li>
<li><strong><code>Incident Response</code></strong>: YARA aids in incident response by enabling analysts to quickly search and analyze files or memory images for specific patterns or indicators. By applying YARA rules during the investigation process, analysts can identify relevant artifacts, determine the scope of an incident, and gather critical information to aid in remediation efforts.</li>
<li><strong><code>Proactive Threat Hunting</code></strong>: Instead of waiting for an alert, we can leverage YARA to perform proactive searches across our environments, searching for potential threats or remnants of past infections.</li>
</ul>
<h3 id="how-does-yara-work-">How Does YARA Work?</h3>
<p>In summary, the YARA scan engine, equipped with YARA modules, scans a set of files by comparing their content against the patterns defined in a set of rules. When a file matches the patterns and conditions specified in a YARA rule, it is considered a detected file. This process allows analysts to efficiently identify files that exhibit specific behaviors or characteristics, aiding in malware detection, IOC identification, and threat hunting. This flow is demonstrated in the diagram below.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/234/yara\_working.png" alt="Image"></p>
<p>In the above diagram, we can see that the YARA scan engine, using YARA modules, matches patterns defined in a set of rules against a set of files, resulting in the detection of files that meet the specified patterns and conditions. This is how YARA rules are helpful to identify threats. Let&#39;s understand this in more detail.</p>
<ul>
<li><strong><code>Set of Rules (containing suspicious patterns)</code></strong>: First of all, we have one or more YARA rules, which are created by security analysts. These rules define specific patterns, characteristics, or indicators that need to be matched within files. Rules can include strings, regular expressions, byte sequences, and other indicators of interest. The rules are typically stored in a YARA rule file format (e.g., <code>.yara</code> or <code>.yar</code> file) for easy management and reuse.</li>
<li><strong><code>Set of Files (for scanning)</code></strong>: A set of files, such as executables, documents, or other binary or text-based files, are provided as input to the YARA scan engine. The files can be stored on a local disk, within a directory, or even within memory images or network traffic captures.</li>
<li><strong><code>YARA Scan Engine</code></strong>: The YARA scan engine is the core component responsible for performing the actual scanning and matching of files against the defined YARA rules. It utilizes YARA modules, which are sets of algorithms and techniques, to efficiently compare the content of files against the patterns specified in the rules.</li>
<li><strong><code>Scanning and Matching</code></strong>: The YARA scan engine iterates through each file in the set, one at a time. For each file, it analyzes the content byte by byte, looking for matches against the patterns defined in the YARA rules. The YARA scan engine uses various matching techniques, including string matching, regular expressions, and binary matching, to identify patterns and indicators within the files.</li>
<li><strong><code>Detection of Files</code></strong>: When a file matches the patterns and conditions specified in a YARA rule, it is considered a detected file. The YARA scan engine records information about the match, such as the matched rule, the file path, and the offset within the file where the match occurred and provides output indicating the detection, which can be further processed, logged, or used for subsequent actions.</li>
</ul>
<h3 id="yara-rule-structure">YARA Rule Structure</h3>
<p>Let&#39;s dive into the structure of a YARA rule. YARA rules consist of several components that define the conditions and patterns to be matched within files. An example of a YARA rule is as follows:</p>
<p>Code: yara</p>
<pre><code class="lang-yara">rule my_rule {

    meta:
        <span class="hljs-attr">author</span> = <span class="hljs-string">"Author Name"</span>
        <span class="hljs-attr">description</span> = <span class="hljs-string">"example rule"</span>
        <span class="hljs-attr">hash</span> = <span class="hljs-string">""</span>

    strings: 
        $<span class="hljs-attr">string1</span> = <span class="hljs-string">"test"</span>
        $<span class="hljs-attr">string2</span> = <span class="hljs-string">"rule"</span>
        $<span class="hljs-attr">string3</span> = <span class="hljs-string">"htb"</span>

    condition: 
        all of them
}
</code></pre>
<p>Each rule in YARA starts with the keyword <code>rule</code> followed by a <code>rule identifier</code>. Rule identifiers are case sensitive where the first character cannot be a digit, and cannot exceed 128 characters.</p>
<p>The following keywords are reserved and cannot be used as an identifier:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/234/yara\_keywords.png" alt="Image"></p>
<p>Now, let&#39;s go over the YARA rule structure using a rule that identifies strings associated with the <a href="https://www.mandiant.com/resources/blog/wannacry-malware-profile">WannaCry</a> ransomware as an example. The rule below instructs YARA to flag any file containing all three specified strings as <code>Ransomware_WannaCry</code>.</p>
<p>Code: yara</p>
<pre><code class="lang-yara">rule Ransomware_WannaCry {

    met<span class="hljs-variable">a:</span>
        author = <span class="hljs-string">"Madhukar Raina"</span>
        <span class="hljs-keyword">version</span> = <span class="hljs-string">"1.0"</span>
        description = <span class="hljs-string">"Simple rule to detect strings from WannaCry ransomware"</span>
        reference = <span class="hljs-string">"https://www.virustotal.com/gui/file/ed01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa/behavior"</span> 

    <span class="hljs-built_in">string</span><span class="hljs-variable">s:</span>
        $wannacry_payload_str1 = <span class="hljs-string">"tasksche.exe"</span> fullword <span class="hljs-keyword">ascii</span>
        $wannacry_payload_str2 = <span class="hljs-string">"www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com"</span> <span class="hljs-keyword">ascii</span>
        $wannacry_payload_str3 = <span class="hljs-string">"mssecsvc.exe"</span> fullword <span class="hljs-keyword">ascii</span>

    condition:
        <span class="hljs-keyword">all</span> of them
}
</code></pre>
<p>That&#39;s a basic structure of a YARA rule. It starts with a <code>header</code> containing <code>metadata</code>, followed by <code>conditions</code> that define the context of the files to be matched, and a <code>body</code> that specifies the patterns or indicators to be found. The use of metadata and <code>tags</code> helps in organizing and documenting the rules effectively.</p>
<p><strong>YARA Rule Breakdown</strong>:</p>
<ol>
<li><p><strong><code>Rule Header</code></strong>: The rule header provides metadata and identifies the rule. It typically includes:</p>
<ul>
<li><code>Rule name</code>: A descriptive name for the rule.</li>
<li><code>Rule tags</code>: Optional tags or labels to categorize the rule.</li>
<li><code>Rule metadata</code>: Additional information such as author, description, and creation date.</li>
</ul>
<p><strong>Example</strong>:</p>
<p>Code: yara</p>
<pre><code class="lang-yara"><span class="hljs-selector-tag">rule</span> <span class="hljs-selector-tag">Ransomware_WannaCry</span> {
    <span class="hljs-attribute">meta</span>:
  ...
}
</code></pre>
</li>
<li><p><strong><code>Rule Meta</code></strong>: The rule meta section allows for the definition of additional metadata for the rule. This metadata can include information about the rule&#39;s author, references, version, etc.</p>
<p><strong>Example</strong>:</p>
<p>Code: yara</p>
<pre><code class="lang-yara"><span class="hljs-keyword">rule</span> Ransomware_WannaCry {
    <span class="hljs-keyword">meta</span>:
        author = <span class="hljs-string">"Madhukar Raina"</span>
        <span class="hljs-keyword">version</span> = <span class="hljs-string">"1.0"</span>
        description = <span class="hljs-string">"Simple rule to detect strings from WannaCry ransomware"</span>
        <span class="hljs-keyword">reference</span> =     <span class="hljs-string">"https://www.virustotal.com/gui/file/ed01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa/behavior"</span> 
    ...
}
</code></pre>
</li>
<li><p><strong><code>Rule Body</code></strong>: The rule body contains the patterns or indicators to be matched within the files. This is where the actual detection logic is defined.</p>
<p><strong>Example</strong>:</p>
<p>Code: yara</p>
<pre><code class="lang-yara">rule Ransomware_WannaCry {

    ...    

    strings:
        <span class="hljs-built_in">$wannacry</span>_payload_str1 = <span class="hljs-string">"tasksche.exe"</span> fullword <span class="hljs-keyword">ascii</span>
        <span class="hljs-built_in">$wannacry</span>_payload_str2 = <span class="hljs-string">"www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com"</span> <span class="hljs-keyword">ascii</span>
        <span class="hljs-built_in">$wannacry</span>_payload_str3 = <span class="hljs-string">"mssecsvc.exe"</span> fullword <span class="hljs-keyword">ascii</span>

    ...

}
</code></pre>
</li>
<li><p><strong><code>Rule Conditions</code></strong>: Rule conditions define the context or characteristics of the files to be matched. Conditions can be based on file properties, strings, or other indicators. Conditions are specified within the condition section.</p>
<p><strong>Example</strong>:</p>
<p>Code: yara</p>
<pre><code class="lang-yara">rule Ransomware_WannaCry {
    ...

    condition:
        <span class="hljs-keyword">all</span> <span class="hljs-keyword">of</span> them
}
</code></pre>
<p>In this YARA rule, the condition section simply states <code>all of them</code>, which means that all the strings defined in the rule must be present for the rule to trigger a match.</p>
<p>Let us provide one more example of a condition which specifies that the file size of the analyzed file must be less than <code>100</code> kilobytes (KB).</p>
<p>Code: yara</p>
<pre><code class="lang-yara">    condition:
        filesize &lt; <span class="hljs-number">100</span>KB <span class="hljs-keyword">and</span> (<span class="hljs-built_in">uint16</span>(<span class="hljs-number">0</span>) == <span class="hljs-number">0x5A4D</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">uint16</span>(<span class="hljs-number">0</span>) == <span class="hljs-number">0x4D5A</span>)
</code></pre>
<p>This condition also specifies that the first 2 bytes of the file must be either <code>0x5A4</code> (ASCII <code>MZ</code>) or <code>0x4D5A</code> (ASCII <code>ZM</code>), by using <code>uint16(0)</code>:</p>
<p>Code: yara</p>
<pre><code class="lang-yara"><span class="hljs-function"><span class="hljs-title">uint16</span><span class="hljs-params">(offset)</span></span>
</code></pre>
<p>Here&#39;s how <code>uint16(0)</code> works:</p>
<ul>
<li><code>uint16</code>: This indicates the data type to be extracted, which is a <code>16</code>-bit unsigned integer (<code>2</code> bytes).</li>
<li><code>(0)</code>: The value inside the parentheses represents the offset from where the extraction should start. In this case, <code>0</code> means the function will extract the 16-bit value starting from the beginning of the data being scanned. The condition uses uint16(0) to compare the first 2 bytes of the file with specific values.</li>
</ul>
</li>
</ol>
<hr>
<p>It&#39;s important to note that YARA provides a flexible and extensible syntax, allowing for more advanced features and techniques such as modifiers, logical operators, and external modules. These features can enhance the expressiveness and effectiveness of YARA rules for specific detection scenarios.</p>
<p>Remember that YARA rules can be customized to suit our specific use cases and detection needs. Regular practice and experimentation will further enhance our understanding and proficiency with YARA rule creation. <a href="https://yara.readthedocs.io/en/latest/">YARA documentation</a> contain more details in depth.</p>
<h2 id="developing-yara-rules">Developing YARA Rules</h2>
<p>In this section, we&#39;ll cover manual and automated YARA rule development.</p>
<p>Let&#39;s now navigate to the bottom of this section and click on &quot;Click here to spawn the target system!&quot;. Then, let&#39;s SSH into the Target IP using the provided credentials. The vast majority of the actions/commands covered from this point up to end of this section can be replicated inside the target, offering a more comprehensive grasp of the topics presented.</p>
<p>Let&#39;s dive into the world of YARA rules using a sample named <code>svchost.exe</code> residing in the <code>/home/htb-student/Samples/YARASigma</code> directory of this section&#39;s target as an illustration. We want to understand the process behind crafting a YARA rule, so let&#39;s get our hands dirty.</p>
<p>Initially, we need to conduct a string analysis on our malware sample.</p>
<p>Developing YARA Rules</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ strings svchost<span class="hljs-selector-class">.exe</span>
!This program cannot be run <span class="hljs-keyword">in</span> DOS mode.
UPX0
UPX1
UPX2
<span class="hljs-number">3.96</span>
UPX!
<span class="hljs-number">8</span>MZu
HcP&lt;H
&lt;<span class="hljs-number">1</span>~o
VDgxt
D$ /
OAUATUWVSH
<span class="hljs-number">15384</span>
[^_]A\A]
^$&lt;V
---SNIP---
X]_^[H
QRAPH
(AXZY
KERNEL32<span class="hljs-selector-class">.DLL</span>
msvcrt<span class="hljs-selector-class">.dll</span>
ExitProcess
GetProcAddress
LoadLibraryA
VirtualProtect
exit
</code></pre>
<p>From the first few strings, it becomes evident that the file is packed using the UPX (Ultimate Packer for eXecutables) packer. Given this discovery, we can incorporate UPX-related strings to formulate a basic YARA rule targeting samples packed via UPX.</p>
<p>Code: yara</p>
<pre><code class="lang-yara"><span class="hljs-keyword">rule</span> UPX_packed_executable
{
    meta:
    description = <span class="hljs-string">"Detects UPX-packed executables"</span>

    strings: 
    <span class="hljs-variable">$string_1</span> = <span class="hljs-string">"UPX0"</span>
    <span class="hljs-variable">$string_2</span> = <span class="hljs-string">"UPX1"</span>
    <span class="hljs-variable">$string_3</span> = <span class="hljs-string">"UPX2"</span>

    condition:
    <span class="hljs-literal">all</span> of them
}
</code></pre>
<p>Here&#39;s a brief breakdown of our YARA rule crafted for detecting UPX-packed executables:</p>
<ul>
<li><code>Rule Name</code>: <code>UPX_packed_executable</code></li>
<li><code>Meta Description</code>: Provides a description of the rule, stating that it detects UPX-packed executables.</li>
<li><code>Strings Section</code>: <code>strings</code> defines the strings that the rule will search for within the files.<ul>
<li><code>$string_1</code> = &quot;UPX0&quot;: Matches the string <code>UPX0</code> within the file.</li>
<li><code>$string_2</code> = &quot;UPX1&quot;: Matches the string <code>UPX1</code> within the file.</li>
<li><code>$string_3</code> = &quot;UPX2&quot;: Matches the string <code>UPX2</code> within the file.</li>
</ul>
</li>
<li><code>Condition</code>: <code>condition</code> specifies the criteria that must be met for the rule to trigger a match.<ul>
<li><code>all of them</code>: Specifies that all the defined strings (<code>$string_1</code>, <code>$string_2</code>, and <code>$string_3</code>) must be found within the file.</li>
</ul>
</li>
</ul>
<p>In essence, our <code>UPX_packed_executable</code> rule (located inside this section&#39;s target at <code>/home/htb-student/Rules/yara/upx_packed.yar</code>) scans for the strings <code>UPX0</code>, <code>UPX1</code>, and <code>UPX2</code> inside a file. If the rule finds all three strings, it raises an alert, hinting that the file might be packed with the UPX packer. This rule is a handy tool when we&#39;re on the lookout for executables that have undergone compression or obfuscation using the UPX method.</p>
<h3 id="developing-a-yara-rule-through-yargen">Developing a YARA Rule Through yarGen</h3>
<p>Let&#39;s continue our dive into the world of YARA rules using a sample named <code>dharma_sample.exe</code> residing in the <code>/home/htb-student/Samples/YARASigma</code> directory of this section&#39;s target.</p>
<p>Once again, we need to conduct a string analysis on our malware sample.</p>
<p>Developing YARA Rules</p>
<pre><code class="lang-shell-session">root<span class="hljs-comment">@htb[/htb]$ strings dharma_sample.exe
!This program cannot be run in DOS mode.
Rich
.text
`.rdata
@</span>.data
<span class="hljs-number">9</span>A s
---SNIP---
~?h<span class="hljs-comment">@
~?hP
hz-A
u       jd
@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span>&gt;<span class="hljs-comment">@@</span><span class="hljs-comment">@?456789:;&lt;=@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span>
<span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span>
 !<span class="hljs-string">"#$%&amp;'()*+,-./0123@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/
---SNIP---
GetProcAddress
LoadLibraryA
WaitForSingleObject
InitializeCriticalSectionAndSpinCount
LeaveCriticalSection
GetLastError
EnterCriticalSection
ReleaseMutex
CloseHandle
KERNEL32.dll
RSDS%~m
C:\crysis\Release\PDB\payload.pdb
---SNIP---</span>
</code></pre>
<p>After we execute the <code>strings</code> command on <code>dharma_sample.exe</code>, we spot <code>C:\crysis\Release\PDB\payload.pdb</code>, which is pretty unique. Alongside other distinct strings, we can craft a more refined YARA rule. Let&#39;s employ <code>yarGen</code> to expedite this process.</p>
<p><a href="https://github.com/Neo23x0/yarGen">yarGen</a> is our go-to tool when we need an automatic YARA rule generator. What makes it a gem is its ability to churn out YARA rules based on strings found in malicious files while sidestepping strings common in benign software. This is possible because yarGen comes equipped with a vast database of goodware strings and opcodes. Before diving in, we need to unpack the ZIP archives containing these databases.</p>
<p>Here&#39;s how we get yarGen up and running:</p>
<ul>
<li>Download the latest release from the <code>release</code> section</li>
<li>Install all dependencies with <code>pip install -r requirements.txt</code></li>
<li>Run <code>python yarGen.py --update</code> to automatically download the built-in databases. They will be saved into the &#39;./dbs&#39; subfolder (Download: <code>913 MB</code>).</li>
<li>See help with <code>python yarGen.py --help</code> for more information on the command line parameters.</li>
</ul>
<p><strong>Note</strong>: yarGen can be found inside the <code>/home/htb-student/yarGen-0.23.4</code> directory of this section&#39;s target.</p>
<p>Let&#39;s place our sample in a <code>temp</code> directory (there is one available at <code>/home/htb-student/temp</code> inside this section&#39;s target) and specify the path using the following command-line arguments.</p>
<p>Developing YARA Rules</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ python3 yarGen.py -m /</span>home<span class="hljs-regexp">/htb-student/</span>temp -o htb_sample.yar

------------------------------------------------------------------------
                   _____
    __ _____ _____<span class="hljs-regexp">/ ___/</span>__ ___
   <span class="hljs-regexp">/ /</span><span class="hljs-regexp">/ /</span> _ `<span class="hljs-regexp">/ __/</span> (_ / -_) _ \
   \_, <span class="hljs-regexp">/\_,_/</span>_<span class="hljs-regexp">/  \___/\_</span>_<span class="hljs-regexp">/_/</span><span class="hljs-regexp">/_/</span>
  <span class="hljs-regexp">/___/</span>  Yara Rule Generator
         Florian Roth, July <span class="hljs-number">2020</span>, Version <span class="hljs-number">0.23</span><span class="hljs-number">.3</span>
<span class="hljs-symbol">
  Note:</span> Rules have to be post-processed
  See <span class="hljs-keyword">this</span> post <span class="hljs-keyword">for</span> <span class="hljs-string">details:</span> <span class="hljs-string">https:</span><span class="hljs-comment">//medium.com/@cyb3rops/121d29322282</span>
------------------------------------------------------------------------
[+] Using identifier <span class="hljs-string">'temp'</span>
[+] Using reference <span class="hljs-string">'https://github.com/Neo23x0/yarGen'</span>
[+] Using prefix <span class="hljs-string">'temp'</span>
[+] Processing PEStudio strings ...
[+] Reading goodware strings from database <span class="hljs-string">'good-strings.db'</span> ...
    (This could take some time and uses several Gigabytes of RAM depending on your db size)
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-imphashes-part3.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">4029</span> / Added <span class="hljs-number">4029</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-strings-part9.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">788</span> / Added <span class="hljs-number">788</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-strings-part8.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">332082</span> / Added <span class="hljs-number">331294</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-imphashes-part4.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">6426</span> / Added <span class="hljs-number">2397</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-strings-part2.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">1703601</span> / Added <span class="hljs-number">1371519</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-exports-part2.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">90960</span> / Added <span class="hljs-number">90960</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-strings-part4.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">3860655</span> / Added <span class="hljs-number">2157054</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-exports-part4.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">172718</span> / Added <span class="hljs-number">81758</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-exports-part7.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">223584</span> / Added <span class="hljs-number">50866</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-strings-part6.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">4571266</span> / Added <span class="hljs-number">710611</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-strings-part7.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">5828908</span> / Added <span class="hljs-number">1257642</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-exports-part1.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">293752</span> / Added <span class="hljs-number">70168</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-exports-part3.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">326867</span> / Added <span class="hljs-number">33115</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-imphashes-part9.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">6426</span> / Added <span class="hljs-number">0</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-exports-part9.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">326867</span> / Added <span class="hljs-number">0</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-imphashes-part5.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">13764</span> / Added <span class="hljs-number">7338</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-imphashes-part8.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">13947</span> / Added <span class="hljs-number">183</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-imphashes-part6.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">13976</span> / Added <span class="hljs-number">29</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-strings-part1.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">6893854</span> / Added <span class="hljs-number">1064946</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-imphashes-part7.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">17382</span> / Added <span class="hljs-number">3406</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-exports-part6.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">328525</span> / Added <span class="hljs-number">1658</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-imphashes-part2.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">18208</span> / Added <span class="hljs-number">826</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-exports-part8.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">332359</span> / Added <span class="hljs-number">3834</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-strings-part3.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">9152616</span> / Added <span class="hljs-number">2258762</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-strings-part5.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">12284943</span> / Added <span class="hljs-number">3132327</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-imphashes-part1.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">19764</span> / Added <span class="hljs-number">1556</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-exports-part5.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">404321</span> / Added <span class="hljs-number">71962</span> entries
[+] Processing malware files ...
[+] Processing <span class="hljs-regexp">/home/</span>htb-student<span class="hljs-regexp">/temp/</span>dharma_sample.exe ...
[+] Generating statistical data ...
[+] Generating Super Rules ... (a lot of magic)
[+] Generating Simple Rules ...
[-] Applying intelligent filters to string findings ...
[-] Filtering string set <span class="hljs-keyword">for</span> <span class="hljs-regexp">/home/</span>htb-student<span class="hljs-regexp">/temp/</span>dharma_sample.exe ...
[=] Generated <span class="hljs-number">1</span> SIMPLE rules.
[=] All rules written to htb_sample.yar
[+] yarGen run finished
</code></pre>
<p><strong>Command Breakdown</strong>:</p>
<ul>
<li><code>yarGen.py</code>: This is the name of the yarGen Python script that will be executed.</li>
<li><code>-m /home/htb-student/temp</code>: This option specifies the source directory where the sample files (e.g., malware or suspicious files) are located. The script will analyze these samples to generate YARA rules.</li>
<li><code>-o htb_sample.yar</code>: This option indicates the output file name for the generated YARA rules. In this case, the YARA rules will be saved to a file named <code>htb_sample.yar</code>.</li>
</ul>
<p>The resulting YARA rules will be written to the <code>htb_sample.yar</code> file inside the <code>/home/htb-student/yarGen-0.23.4</code> directory of this section&#39;s target. Let&#39;s see the content of the generated rule.</p>
<p>Developing YARA Rules</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat htb_sample.yar
<span class="hljs-comment">/*
   YARA Rule Set
   Author: yarGen Rule Generator
   Date: 2023-08-24
   Identifier: temp
   Reference: https://github.com/Neo23x0/yarGen
*/</span>

<span class="hljs-comment">/* Rule Set ----------------------------------------------------------------- */</span>

rule dharma_sample {
   meta:
      description = <span class="hljs-string">"temp - file dharma_sample.exe"</span>
      author = <span class="hljs-string">"yarGen Rule Generator"</span>
      reference = <span class="hljs-string">"https://github.com/Neo23x0/yarGen"</span>
      date = <span class="hljs-string">"2023-08-24"</span>
      hash1 = <span class="hljs-string">"bff6a1000a86f8edf3673d576786ec75b80bed0c458a8ca0bd52d12b74099071"</span>
   strings:
      <span class="hljs-built_in">$x</span>1 = <span class="hljs-string">"C:\\crysis\\Release\\PDB\\payload.pdb"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>2 = <span class="hljs-string">"sssssbs"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>3 = <span class="hljs-string">"sssssbsss"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>4 = <span class="hljs-string">"RSDS%~m"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>5 = <span class="hljs-string">"{RDqP^\\"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>6 = <span class="hljs-string">"QtVN$0w"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>7 = <span class="hljs-string">"Ffsc&lt;{"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>8 = <span class="hljs-string">"^N3Y.H_K"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>9 = <span class="hljs-string">"tb#w\\6"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>10 = <span class="hljs-string">"-j6EPUc"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>11 = <span class="hljs-string">"8QS#5@3"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>12 = <span class="hljs-string">"h1+LI;d8"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>13 = <span class="hljs-string">"H;B cl"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>14 = <span class="hljs-string">"Wy]z@p]E"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>15 = <span class="hljs-string">"ipgypA"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>16 = <span class="hljs-string">"+&gt;^wI{H"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>17 = <span class="hljs-string">"mF@S/]"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>18 = <span class="hljs-string">"OA_&lt;8X-|"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>19 = <span class="hljs-string">"s+aL%M"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>20 = <span class="hljs-string">"sXtY9P"</span> fullword <span class="hljs-keyword">ascii</span>
   condition:
      uint16(<span class="hljs-number">0</span>) == <span class="hljs-number">0</span>x5a4d and filesize &lt; <span class="hljs-number">300</span>KB and
      <span class="hljs-number">1</span> of (<span class="hljs-built_in">$x</span>*) and <span class="hljs-number">4</span> of them
}
</code></pre>
<p>Now, for the moment of truth. We&#39;ll unleash YARA with our newly minted rule to see if it sniffs out any matches when run against a malware sample repository located at <code>home/htb-student/Samples/YARASigma</code> inside this section&#39;s target.</p>
<p>Developing YARA Rules</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ yara htb_sample.yar /</span>home<span class="hljs-regexp">/htb-student/</span>Samples/YARASigma 
dharma_sample <span class="hljs-regexp">/home/</span>htb-student<span class="hljs-regexp">/Samples/</span>YARASigma/dharma_sample.exe
dharma_sample <span class="hljs-regexp">/home/</span>htb-student<span class="hljs-regexp">/Samples/</span>YARASigma/pdf_reader.exe
dharma_sample <span class="hljs-regexp">/home/</span>htb-student<span class="hljs-regexp">/Samples/</span>YARASigma/microsoft.com
dharma_sample <span class="hljs-regexp">/home/</span>htb-student<span class="hljs-regexp">/Samples/</span>YARASigma/check_updates.exe
dharma_sample <span class="hljs-regexp">/home/</span>htb-student<span class="hljs-regexp">/Samples/</span>YARASigma/KB5027505.exe
</code></pre>
<p>As we can see, the <code>pdf_reader.exe</code>, <code>microsoft.com</code>, <code>check_updates.exe</code>, and <code>KB5027505.exe</code> files are detected by this rule (in addition to <code>dharma_sample.exe</code> of course).</p>
<h3 id="manually-developing-a-yara-rule">Manually Developing a YARA Rule</h3>
<p><strong>Example 1: ZoxPNG RAT Used by APT17</strong></p>
<p>Let&#39;s now go a bit deeper...</p>
<p>We want to develop a YARA rule to scan for a specific variation of the <code>ZoxPNG</code> RAT used by <code>APT17</code> based on:</p>
<ul>
<li>A sample named <code>legit.exe</code> residing in the <code>/home/htb-student/Samples/YARASigma</code> directory of this section&#39;s target</li>
<li>A <a href="https://intezer.com/blog/research/evidence-aurora-operation-still-active-part-2-more-ties-uncovered-between-ccleaner-hack-chinese-hackers-2/">post from Intezer</a></li>
<li>String analysis</li>
<li>Imphash</li>
<li>Common sample file size</li>
</ul>
<p>Let&#39;s start with our string analysis endeavors as follows.</p>
<p>Developing YARA Rules</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ strings legit.exe
!This <span class="hljs-keyword">program</span> cannot be <span class="hljs-keyword">run</span> <span class="hljs-keyword">in</span> DOS mode.
Rich
.text
`.rdata
@.data
---SNIP---
ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/
 deflate 1.1.4 <span class="hljs-keyword">Copyright</span> 1995-2002 Jean-loup Gailly

 inflate 1.1.4 <span class="hljs-keyword">Copyright</span> 1995-2002 <span class="hljs-keyword">Mark</span> Adler
<span class="hljs-keyword">Sleep</span>
LocalAlloc
CloseHandle
GetLastError
VirtualFree
VirtualAlloc
GetProcAddress
LoadLibraryA
GetCurrentProcessId
GlobalMemoryStatusEx
GetCurrentProcess
GetACP
GetVersionExA
GetComputerNameA
GetTickCount
GetSystemTime
LocalFree
CreateProcessA
CreatePipe
TerminateProcess
ReadFile
PeekNamedPipe
WriteFile
SetFilePointer
CreateFileA
GetFileSize
GetDiskFreeSpaceExA
GetDriveTypeA
GetLogicalDriveStringsA
CreateDirectoryA
FindClose
FindNextFileA
FindFirstFileA
MoveFileExA
OpenProcess
KERNEL32.dll
LookupAccountSidA
ADVAPI32.dll
SHFileOperationA
SHELL32.dll
strcpy
rand
sprintf
memcpy
strncpy
srand
_snprintf
atoi
strcat
<span class="hljs-built_in">strlen</span>
printf
memset
strchr
memcmp
MSVCRT.dll
_exit
_XcptFilter
<span class="hljs-keyword">exit</span>
__p___initenv
__getmainargs
_initterm
__setusermatherr
_adjust_fdiv
__p__commode
__p__fmode
__set_app_type
_except_handler3
_controlfp
InternetCrackUrlA
InternetCloseHandle
InternetReadFile
HttpQueryInfoA
HttpSendRequestA
InternetSetOptionA
HttpAddRequestHeadersA
HttpOpenRequestA
InternetConnectA
InternetOpenA
WININET.dll
ObtainUserAgentString
urlmon.dll
WTSFreeMemory
WTSEnumerateProcessesA
WTSAPI32.dll
GetModuleFileNameExA
PSAPI.DLL
calloc
free
http:<span class="hljs-comment">//%s/imgres?q=A380&amp;hl=en-US&amp;sa=X&amp;biw=1440&amp;bih=809&amp;tbm=isus&amp;tbnid=aLW4-J8Q1lmYBM:&amp;imgrefurl=http://%s&amp;docid=1bi0Ti1ZVr4bEM&amp;imgurl=http://%s/%04d-%02d/%04d%02d%02d%02d%02d%02d.png&amp;w=800&amp;h=600&amp;ei=CnJcUcSBL4rFkQX444HYCw&amp;zoom=1&amp;ved=1t:3588,r:1,s:0,i:92&amp;iact=rc&amp;dur=368&amp;page=1&amp;tbnh=184&amp;tbnw=259&amp;start=0&amp;ndsp=20&amp;tx=114&amp;ty=58</span>
http:<span class="hljs-comment">//0.0.0.0/1</span>
http:<span class="hljs-comment">//0.0.0.0/2</span>
Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; WOW64; Trident/4.0; SLCC2; .NETCLR 2.0.50727)
image/pjpeg
image/jpeg
image/x-xbitmap
image/gif
Content-<span class="hljs-keyword">Type</span>: application/x-www-<span class="hljs-keyword">form</span>-urlencoded
B64:[%s]
Step 11
Step 10
Step 9
Step 8
Step 7
Step 6
Content-<span class="hljs-keyword">Type</span>: image/x-png
Step 5
Step 4
Connection: <span class="hljs-keyword">close</span>
Accept-Encoding: gzip, deflate
Accept-Language: <span class="hljs-keyword">en</span>-<span class="hljs-keyword">US</span>
Pragma: <span class="hljs-keyword">no</span>-cache
User-Agent:
Cookie: SESSIONID=%<span class="hljs-built_in">s</span>
Step 3
HTTP/1.1
Step 2
<span class="hljs-keyword">POST</span>
Step 1
Get URL Info <span class="hljs-keyword">Error</span>
[IISEND=0x%08X][Recv:] 0x%08X %<span class="hljs-built_in">s</span>
IISCMD <span class="hljs-keyword">Error</span>:%<span class="hljs-built_in">d</span>
hWritePipe2 <span class="hljs-keyword">Error</span>:%<span class="hljs-built_in">d</span>
kernel32.dll
QueryFullProcessImageName
Not Support This Function!
1.1.4
need dictionary
incorrect data check
incorrect header check
invalid <span class="hljs-keyword">window</span> size
unknown compression method
incompatible <span class="hljs-keyword">version</span>
buffer <span class="hljs-keyword">error</span>
insufficient <span class="hljs-keyword">memory</span>
data <span class="hljs-keyword">error</span>
stream <span class="hljs-keyword">error</span>
<span class="hljs-keyword">file</span> <span class="hljs-keyword">error</span>
stream end
invalid bit length <span class="hljs-keyword">repeat</span>
too many length or distance symbols
invalid stored block lengths
invalid block <span class="hljs-keyword">type</span>
invalid distance code
invalid literal/length code
incomplete dynamic bit lengths tree
oversubscribed dynamic bit lengths tree
incomplete literal/length tree
oversubscribed literal/length tree
empty distance tree with lengths
incomplete distance tree
oversubscribed distance tree
Z0X03
&gt;0!0
Western Cape1
Durbanville1
Thawte1
Thawte Certification1
Thawte Timestamping CA0
121221000000Z
201230235959Z0^1
Symantec Corporation100.
'Symantec Time Stamping Services <span class="hljs-keyword">CA</span> - G20
"W*o
]jxdE
`F~T
&amp;0<span class="hljs-variable">$0</span>"
http:<span class="hljs-comment">//ocsp.thawte.com0</span>
80604
.http:<span class="hljs-comment">//crl.thawte.com/ThawteTimestampingCA.crl0</span>
TimeStamp-2048-10
y@b%
thawte, Inc.1(0&amp;
Certification Services Division1806
/(c) 2006 thawte, Inc. - <span class="hljs-keyword">For</span> authorized <span class="hljs-keyword">use</span> only1
thawte Primary Root CA0
061117000000Z
360716235959Z0
thawte, Inc.1(0&amp;
Certification Services Division1806
/(c) 2006 thawte, Inc. - <span class="hljs-keyword">For</span> authorized <span class="hljs-keyword">use</span> only1
thawte Primary Root CA0
<span class="hljs-keyword">l</span>[HhIY7
tf/j8
S}+
&gt;<span class="hljs-keyword">n</span>)<span class="hljs-built_in">i</span>
B0@0
WHP0
Thawte, Inc.1<span class="hljs-variable">$0</span>"
Thawte Code Signing <span class="hljs-keyword">CA</span> - G20
110622000000Z
130721235959Z0
Seoul1
Seongdong-gu1
        4NB Corp.1"0
tigation Development Team1
        4NB Corp.0
LO'%
oWx6
IB-8l3
40200
<span class="hljs-comment">*http://cs-g2-crl.thawte.com/ThawteCSG2.crl0</span>
&amp;0<span class="hljs-variable">$0</span>"
http:<span class="hljs-comment">//ocsp.thawte.com0</span>
}1JBAe
^b/1
a{b2
Ti,[\{
thawte, Inc.1(0&amp;
Certification Services Division1806
/(c) 2006 thawte, Inc. - <span class="hljs-keyword">For</span> authorized <span class="hljs-keyword">use</span> only1
thawte Primary Root CA0
100208000000Z
200207235959Z0J1
Thawte, Inc.1<span class="hljs-variable">$0</span>"
Thawte Code Signing <span class="hljs-keyword">CA</span> - G20
,p&amp;7E
rqD=X
n8}v
-0+0)
#http:<span class="hljs-comment">//crl.thawte.com/ThawtePCA.crl0</span>
&amp;0<span class="hljs-variable">$0</span>"
http:<span class="hljs-comment">//ocsp.thawte.com0</span>
VeriSignMPKI-2-100
---SNIP---
Symantec Corporation100.
'Symantec Time Stamping Services <span class="hljs-keyword">CA</span> - G20
121018000000Z
201229235959Z0b1
Symantec Corporation1402
+Symantec Time Stamping Services Signer - G40
2oNW
a;<span class="hljs-keyword">EQ</span>
g0e0*
http:<span class="hljs-comment">//ts-ocsp.ws.symantec.com07</span>
+http:<span class="hljs-comment">//ts-aia.ws.symantec.com/tss-ca-g2.cer0&lt;</span>
50301
+http:<span class="hljs-comment">//ts-crl.ws.symantec.com/tss-ca-g2.crl0(</span>
TimeStamp-2048-20
---SNIP---
Thawte, Inc.1<span class="hljs-variable">$0</span>"
Thawte Code Signing <span class="hljs-keyword">CA</span> - G2
1(0&amp;
www.4nb.co.kr 0
#Ak_
$&gt;X[hL
0r0^1
Symantec Corporation100.
'Symantec Time Stamping Services <span class="hljs-keyword">CA</span> - G2
130529085845Z0#
<span class="hljs-comment">*PU19</span>
mOLT
}Jdf6
K%&amp;<span class="hljs-built_in">J</span>
(<span class="hljs-keyword">E</span>~<span class="hljs-built_in">Q</span>
Eev7aSp
</code></pre>
<p>Let&#39;s then use the hashes mentioned in Intezer&#39;s post to identify common sample sizes. It looks like there are no related samples whose size is bigger than 200KB. An example of an identified sample is the following. <a href="https://www.hybrid-analysis.com/sample/ee362a8161bd442073775363bf5fa1305abac2ce39b903d63df0d7121ba60550">https://www.hybrid-analysis.com/sample/ee362a8161bd442073775363bf5fa1305abac2ce39b903d63df0d7121ba60550</a>.</p>
<p>Finally, the sample&#39;s Imphash can be calculated as follows, using the <code>imphash_calc.py</code> script that resides in the <code>/home/htb-student</code> directory of this section&#39;s target.</p>
<p>Developing YARA Rules</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ python3 imphash_calc.py /</span>home<span class="hljs-regexp">/htb-student/</span>Samples<span class="hljs-regexp">/YARASigma/</span>legit.exe
<span class="hljs-number">414</span>bbd566b700ea021cfae3ad8f4d9b9
</code></pre>
<p>A good YARA rule to detect the aforementioned variation of ZoxPNG resides in the <code>/home/htb-student/Rules/yara</code> directory of this section&#39;s target, saved as <code>apt_apt17_mal_sep17_2.yar</code>.</p>
<p>Code: yara</p>
<pre><code class="lang-yara"><span class="hljs-comment">/*
   Yara Rule Set
   Author: Florian Roth
   Date: 2017-10-03
   Identifier: APT17 Oct 10
   Reference: https://goo.gl/puVc9q
*/</span>

<span class="hljs-comment">/* Rule Set ----------------------------------------------------------------- */</span>

<span class="hljs-built_in">import</span> <span class="hljs-string">"pe"</span>

rule APT17_Malware_Oct17_Gen {
   meta:
      <span class="hljs-attr">description</span> = <span class="hljs-string">"Detects APT17 malware"</span>
      <span class="hljs-attr">license</span> = <span class="hljs-string">"Detection Rule License 1.1 https://github.com/Neo23x0/signature-base/blob/master/LICENSE"</span>
      <span class="hljs-attr">author</span> = <span class="hljs-string">"Florian Roth (Nextron Systems)"</span>
      <span class="hljs-attr">reference</span> = <span class="hljs-string">"https://goo.gl/puVc9q"</span>
      <span class="hljs-attr">date</span> = <span class="hljs-string">"2017-10-03"</span>
      <span class="hljs-attr">hash1</span> = <span class="hljs-string">"0375b4216334c85a4b29441a3d37e61d7797c2e1cb94b14cf6292449fb25c7b2"</span>
      <span class="hljs-attr">hash2</span> = <span class="hljs-string">"07f93e49c7015b68e2542fc591ad2b4a1bc01349f79d48db67c53938ad4b525d"</span>
      <span class="hljs-attr">hash3</span> = <span class="hljs-string">"ee362a8161bd442073775363bf5fa1305abac2ce39b903d63df0d7121ba60550"</span>
   strings:
      $<span class="hljs-attr">x1</span> = <span class="hljs-string">"Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; WOW64; Trident/4.0; SLCC2; .NETCLR 2.0.50727)"</span> fullword ascii
      $<span class="hljs-attr">x2</span> = <span class="hljs-string">"http://%s/imgres?q=A380&amp;hl=en-US&amp;sa=X&amp;biw=1440&amp;bih=809&amp;tbm=isus&amp;tbnid=aLW4-J8Q1lmYBM"</span> ascii

      $<span class="hljs-attr">s1</span> = <span class="hljs-string">"hWritePipe2 Error:%d"</span> fullword ascii
      $<span class="hljs-attr">s2</span> = <span class="hljs-string">"Not Support This Function!"</span> fullword ascii
      $<span class="hljs-attr">s3</span> = <span class="hljs-string">"Cookie: SESSIONID=%s"</span> fullword ascii
      $<span class="hljs-attr">s4</span> = <span class="hljs-string">"http://0.0.0.0/1"</span> fullword ascii
      $<span class="hljs-attr">s5</span> = <span class="hljs-string">"Content-Type: image/x-png"</span> fullword ascii
      $<span class="hljs-attr">s6</span> = <span class="hljs-string">"Accept-Language: en-US"</span> fullword ascii
      $<span class="hljs-attr">s7</span> = <span class="hljs-string">"IISCMD Error:%d"</span> fullword ascii
      $<span class="hljs-attr">s8</span> = <span class="hljs-string">"[IISEND=0x%08X][Recv:] 0x%08X %s"</span> fullword ascii
   condition:
      ( uint16(<span class="hljs-number">0</span>) == <span class="hljs-number">0</span>x5a4d <span class="hljs-literal">and</span> filesize &lt; <span class="hljs-number">200</span>KB <span class="hljs-literal">and</span> (
            pe.imphash() == <span class="hljs-string">"414bbd566b700ea021cfae3ad8f4d9b9"</span> <span class="hljs-literal">or</span>
            <span class="hljs-number">1</span> of ($x*) <span class="hljs-literal">or</span>
            <span class="hljs-number">6</span> of them
         )
      )
}
</code></pre>
<p><strong>YARA Rule Breakdown</strong>:</p>
<ul>
<li><strong><code>Rule Imports</code></strong>: Modules are extensions to YARA&#39;s core functionality.<ul>
<li><code>import &quot;pe&quot;</code>: By importing the <a href="https://yara.readthedocs.io/en/stable/modules/pe.html">PE module</a> the YARA rule gains access to a set of specialized functions and structures that can inspect and analyze the details of <code>PE</code> files. This makes the rule more precise when it comes to detecting characteristics in Windows executables.</li>
</ul>
</li>
<li><strong><code>Rule Meta</code></strong>:<ul>
<li><code>description</code>: Tells us the main purpose of the rule, which is to detect APT17 malware.</li>
<li><code>license</code>: Points to the location and version of the license governing the use of this YARA rule.</li>
<li><code>author</code>: The rule was written by Florian Roth from Nextron Systems.</li>
<li><code>reference</code>: Provides a link that goes into more detail about the malware or context of this rule.</li>
<li><code>date</code>: The date the rule was either created or last updated, in this case, 3rd October 2017.</li>
<li><code>hash1</code>, <code>hash2</code>, <code>hash3</code>: Hash values, probably of samples related to APT17, which the author used as references or as foundational data to create the rule.</li>
</ul>
</li>
<li><strong><code>Rule Body</code></strong>: The rule contains a series of strings, which are potential indicators of the APT17 malware. These strings are split into two categories<ul>
<li><code>$x* strings</code></li>
<li><code>$s* strings</code></li>
</ul>
</li>
<li><strong><code>Rule Condition</code></strong>: This is the heart of the rule, where the actual detection logic resides.<ul>
<li><code>uint16(0) == 0x5a4d</code>: Checks if the first two bytes of the file are <code>MZ</code>, which is the magic number for Windows executables. So, we&#39;re focusing on detecting Windows binaries.</li>
<li><code>filesize &lt; 200KB</code>: Limits the rule to scan only small files, specifically those smaller than <code>200KB</code>.</li>
<li><code>pe.imphash() == &quot;414bbd566b700ea021cfae3ad8f4d9b9&quot;</code>: This checks the import hash (<code>imphash</code>) of the PE (Portable Executable) file. Imphashes are great for categorizing and clustering malware samples based on the libraries they import.</li>
<li><code>1 of ($x*)</code>: At least <code>one</code> of the <code>$x strings</code> (from the strings section) must be present in the file.</li>
<li><code>6 of them</code>: Requires that at least <code>six</code> of the strings (<code>from both $x and $s categories</code>) be found within the scanned file.</li>
</ul>
</li>
</ul>
<p><strong>Example 2: Neuron Used by Turla</strong></p>
<p>We want to develop a YARA rule to scan for instances of <code>Neuron Service</code> used by <code>Turla</code> based on:</p>
<ul>
<li>A sample named <code>Microsoft.Exchange.Service.exe</code> residing in the <code>/home/htb-student/Samples/YARASigma</code> directory of this section&#39;s target</li>
<li>An <a href="https://www.ncsc.gov.uk/static-assets/documents/Turla%20group%20using%20Neuron%20and%20Nautilus%20tools%20alongside%20Snake%20malware\_1.pdf">analysis report from the National Cyber Security Centre</a></li>
</ul>
<p>Since the report mentions that both the Neuron client and Neuron service are written using the .NET framework we will perform .NET &quot;reversing&quot; instead of string analysis.</p>
<p>This can be done using the <a href="https://www.mono-project.com/docs/tools+libraries/tools/monodis/">monodis</a> tool as follows.</p>
<p>Developing YARA Rules</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ monodis --output=<span class="hljs-selector-tag">code</span> Microsoft<span class="hljs-selector-class">.Exchange</span><span class="hljs-selector-class">.Service</span><span class="hljs-selector-class">.exe</span>
</code></pre>
<p>Developing YARA Rules</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat <span class="hljs-selector-tag">code</span>
<span class="hljs-selector-class">.assembly</span> extern System<span class="hljs-selector-class">.Configuration</span><span class="hljs-selector-class">.Install</span>
{
  <span class="hljs-selector-class">.ver</span> <span class="hljs-number">4</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>
  <span class="hljs-selector-class">.publickeytoken</span> = (B0 <span class="hljs-number">3</span>F <span class="hljs-number">5</span>F <span class="hljs-number">7</span>F <span class="hljs-number">11</span> D5 <span class="hljs-number">0</span>A <span class="hljs-number">3</span>A ) <span class="hljs-comment">// .?_....:</span>
}
---SNIP---
  <span class="hljs-selector-class">.class</span> public <span class="hljs-attribute">auto</span> ansi abstract sealed beforefieldinit StorageUtils
  } <span class="hljs-comment">// end of class Utils.StorageUtils</span>
---SNIP---
           default void ExecCMD (string path, string key, unsigned int8[] cmd, class Utils<span class="hljs-selector-class">.Config</span> cfg, class [mscorlib]System<span class="hljs-selector-class">.Threading</span><span class="hljs-selector-class">.ManualResetEvent</span> mre)  cil managed
        IL_0028:  ldsfld class [System.Core]System<span class="hljs-selector-class">.Runtime</span><span class="hljs-selector-class">.CompilerServices</span><span class="hljs-selector-class">.CallSite</span>`<span class="hljs-number">1</span>&lt;class [mscorlib]System.Func`<span class="hljs-number">5</span>&lt;class [System.Core]System<span class="hljs-selector-class">.Runtime</span><span class="hljs-selector-class">.CompilerServices</span><span class="hljs-selector-class">.CallSite</span>,class [mscorlib]System<span class="hljs-selector-class">.Type</span>,<span class="hljs-selector-tag">object</span>,class Utils<span class="hljs-selector-class">.Config</span>,class Utils.CommandScript&gt;&gt; Utils.Storage/<span class="hljs-string">'&lt;ExecCMD&gt;o__SiteContainer0'</span>::<span class="hljs-string">'&lt;&gt;p__Site1'</span>
        IL_0070:  stsfld class [System.Core]System<span class="hljs-selector-class">.Runtime</span><span class="hljs-selector-class">.CompilerServices</span><span class="hljs-selector-class">.CallSite</span>`<span class="hljs-number">1</span>&lt;class [mscorlib]System.Func`<span class="hljs-number">5</span>&lt;class [System.Core]System<span class="hljs-selector-class">.Runtime</span><span class="hljs-selector-class">.CompilerServices</span><span class="hljs-selector-class">.CallSite</span>,class [mscorlib]System<span class="hljs-selector-class">.Type</span>,<span class="hljs-selector-tag">object</span>,class Utils<span class="hljs-selector-class">.Config</span>,class Utils.CommandScript&gt;&gt; Utils.Storage/<span class="hljs-string">'&lt;ExecCMD&gt;o__SiteContainer0'</span>::<span class="hljs-string">'&lt;&gt;p__Site1'</span>
        IL_0075:  ldsfld class [System.Core]System<span class="hljs-selector-class">.Runtime</span><span class="hljs-selector-class">.CompilerServices</span><span class="hljs-selector-class">.CallSite</span>`<span class="hljs-number">1</span>&lt;class [mscorlib]System.Func`<span class="hljs-number">5</span>&lt;class [System.Core]System<span class="hljs-selector-class">.Runtime</span><span class="hljs-selector-class">.CompilerServices</span><span class="hljs-selector-class">.CallSite</span>,class [mscorlib]System<span class="hljs-selector-class">.Type</span>,<span class="hljs-selector-tag">object</span>,class Utils<span class="hljs-selector-class">.Config</span>,class Utils.CommandScript&gt;&gt; Utils.Storage/<span class="hljs-string">'&lt;ExecCMD&gt;o__SiteContainer0'</span>::<span class="hljs-string">'&lt;&gt;p__Site1'</span>
        IL_007f:  ldsfld class [System.Core]System<span class="hljs-selector-class">.Runtime</span><span class="hljs-selector-class">.CompilerServices</span><span class="hljs-selector-class">.CallSite</span>`<span class="hljs-number">1</span>&lt;class [mscorlib]System.Func`<span class="hljs-number">5</span>&lt;class [System.Core]System<span class="hljs-selector-class">.Runtime</span><span class="hljs-selector-class">.CompilerServices</span><span class="hljs-selector-class">.CallSite</span>,class [mscorlib]System<span class="hljs-selector-class">.Type</span>,<span class="hljs-selector-tag">object</span>,class Utils<span class="hljs-selector-class">.Config</span>,class Utils.CommandScript&gt;&gt; Utils.Storage/<span class="hljs-string">'&lt;ExecCMD&gt;o__SiteContainer0'</span>::<span class="hljs-string">'&lt;&gt;p__Site1'</span>
    } <span class="hljs-comment">// end of method Storage::ExecCMD</span>
  <span class="hljs-selector-class">.class</span> nested private <span class="hljs-attribute">auto</span> ansi abstract sealed beforefieldinit <span class="hljs-string">'&lt;ExecCMD&gt;o__SiteContainer0'</span>
  } <span class="hljs-comment">// end of class &lt;ExecCMD&gt;o__SiteContainer0</span>
        IL_0077:  call void class Utils<span class="hljs-selector-class">.Storage</span>::ExecCMD(string, string, unsigned int8[], class Utils<span class="hljs-selector-class">.Config</span>, class [mscorlib]System<span class="hljs-selector-class">.Threading</span><span class="hljs-selector-class">.ManualResetEvent</span>)
---SNIP---
        IL_0029:  ldftn void class Utils<span class="hljs-selector-class">.Storage</span>::KillOldThread()
           default void KillOldThread ()  cil managed
    } <span class="hljs-comment">// end of method Storage::KillOldThread</span>
---SNIP---

        IL_0201:  ldstr <span class="hljs-string">"EncryptScript"</span>
        IL_04a4:  call unsigned int8[] class Utils<span class="hljs-selector-class">.Crypt</span>::EncryptScript(unsigned int8[], unsigned int8[])
        IL_0eff:  call unsigned int8[] class Utils<span class="hljs-selector-class">.Crypt</span>::EncryptScript(unsigned int8[], unsigned int8[])
        IL_0f4e:  call unsigned int8[] class Utils<span class="hljs-selector-class">.Crypt</span>::EncryptScript(unsigned int8[], unsigned int8[])
        IL_0fec:  call unsigned int8[] class Utils<span class="hljs-selector-class">.Crypt</span>::EncryptScript(unsigned int8[], unsigned int8[])
        IL_102f:  call unsigned int8[] class Utils<span class="hljs-selector-class">.Crypt</span>::EncryptScript(unsigned int8[], unsigned int8[])
        IL_0018:  call unsigned int8[] class Utils<span class="hljs-selector-class">.Crypt</span>::EncryptScript(unsigned int8[], unsigned int8[])
        IL_00b1:  call unsigned int8[] class Utils<span class="hljs-selector-class">.Crypt</span>::EncryptScript(unsigned int8[], unsigned int8[])
          IL_009a:  call unsigned int8[] class Utils<span class="hljs-selector-class">.Crypt</span>::EncryptScript(unsigned int8[], unsigned int8[])
          IL_0142:  call unsigned int8[] class Utils<span class="hljs-selector-class">.Crypt</span>::EncryptScript(unsigned int8[], unsigned int8[])
           default unsigned int8[] EncryptScript (unsigned int8[] pwd, unsigned int8[] data)  cil managed
    } <span class="hljs-comment">// end of method Crypt::EncryptScript</span>
            IL_00a0:  call unsigned int8[] class Utils<span class="hljs-selector-class">.Crypt</span>::EncryptScript(unsigned int8[], unsigned int8[])
          IL_0052:  call unsigned int8[] class Utils<span class="hljs-selector-class">.Crypt</span>::EncryptScript(unsigned int8[], unsigned int8[])
---SNIP---
</code></pre>
<p>By going through the above we can identify functions and classes within the .NET assembly.</p>
<p><strong>Note</strong>: A better reversing solution would be to load the .NET assembly (<code>Microsoft.Exchange.Service.exe</code>) into a .NET debugger and assembly editor like <a href="https://github.com/dnSpy/dnSpy">dnSpy</a>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/234/dnSpy.png" alt=""></p>
<p>A good YARA rule to identify instances of Neuron Service resides in the <code>/home/htb-student/Rules/yara</code> directory of this section&#39;s target, saved as <code>neuron_1.yar</code>.</p>
<p>Code: yara</p>
<pre><code class="lang-yara">rule neuron_functions_classes_and_vars {
 meta:
   description = <span class="hljs-string">"Rule for detection of Neuron based on .NET functions and class names"</span>
   author = <span class="hljs-string">"NCSC UK"</span>
   reference = <span class="hljs-string">"https://www.ncsc.gov.uk/file/2691/download?token=RzXWTuAB"</span>
   reference2 = <span class="hljs-string">"https://www.ncsc.gov.uk/alerts/turla-group-malware"</span>
   hash = <span class="hljs-string">"d1d7a96fcadc137e80ad866c838502713db9cdfe59939342b8e3beacf9c7fe29"</span>
 strings:
   <span class="hljs-built_in">$class</span>1 = <span class="hljs-string">"StorageUtils"</span> <span class="hljs-keyword">ascii</span>
   <span class="hljs-built_in">$class</span>2 = <span class="hljs-string">"WebServer"</span> <span class="hljs-keyword">ascii</span>
   <span class="hljs-built_in">$class</span>3 = <span class="hljs-string">"StorageFile"</span> <span class="hljs-keyword">ascii</span>
   <span class="hljs-built_in">$class</span>4 = <span class="hljs-string">"StorageScript"</span> <span class="hljs-keyword">ascii</span>
   <span class="hljs-built_in">$class</span>5 = <span class="hljs-string">"ServerConfig"</span> <span class="hljs-keyword">ascii</span>
   <span class="hljs-built_in">$class</span>6 = <span class="hljs-string">"CommandScript"</span> <span class="hljs-keyword">ascii</span>
   <span class="hljs-built_in">$class</span>7 = <span class="hljs-string">"MSExchangeService"</span> <span class="hljs-keyword">ascii</span>
   <span class="hljs-built_in">$class</span>8 = <span class="hljs-string">"W3WPDIAG"</span> <span class="hljs-keyword">ascii</span>
   <span class="hljs-built_in">$func</span>1 = <span class="hljs-string">"AddConfigAsString"</span> <span class="hljs-keyword">ascii</span>
   <span class="hljs-built_in">$func</span>2 = <span class="hljs-string">"DelConfigAsString"</span> <span class="hljs-keyword">ascii</span>
   <span class="hljs-built_in">$func</span>3 = <span class="hljs-string">"GetConfigAsString"</span> <span class="hljs-keyword">ascii</span>
   <span class="hljs-built_in">$func</span>4 = <span class="hljs-string">"EncryptScript"</span> <span class="hljs-keyword">ascii</span>
   <span class="hljs-built_in">$func</span>5 = <span class="hljs-string">"ExecCMD"</span> <span class="hljs-keyword">ascii</span>
   <span class="hljs-built_in">$func</span>6 = <span class="hljs-string">"KillOldThread"</span> <span class="hljs-keyword">ascii</span>
   <span class="hljs-built_in">$func</span>7 = <span class="hljs-string">"FindSPath"</span> <span class="hljs-keyword">ascii</span>
   <span class="hljs-built_in">$dotnetMagic</span> = <span class="hljs-string">"BSJB"</span> <span class="hljs-keyword">ascii</span>
 condition:
   (uint16(<span class="hljs-number">0</span>) == <span class="hljs-number">0</span>x5A4D and uint16(uint32(<span class="hljs-number">0</span>x3c)) == <span class="hljs-number">0</span>x4550) and <span class="hljs-built_in">$dotnetMagic</span> and <span class="hljs-number">6</span> of them
}
</code></pre>
<p><strong>YARA Rule Breakdown</strong>:</p>
<ul>
<li><strong><code>Strings Section</code></strong>:<ul>
<li><code>$class1 = &quot;StorageUtils&quot; ascii</code> to <code>$class8 = &quot;W3WPDIAG&quot; ascii</code>: These are eight ASCII strings corresponding to class names within the .NET assembly.</li>
<li><code>$func1 = &quot;AddConfigAsString&quot; ascii</code> to <code>$func7 = &quot;FindSPath&quot; ascii</code>: These seven ASCII strings represent class or function names within the .NET assembly.</li>
<li><code>$dotnetMagic = &quot;BSJB&quot; ascii</code>: This signature is present in the CLI (Common Language Infrastructure) header of .NET binaries, and its presence can be used to indicate the file is a .NET assembly. Specifically, it&#39;s in the Signature field of the CLI header, which follows the PE header and additional tables.</li>
</ul>
</li>
<li><strong><code>Condition Section</code></strong>:<ul>
<li><code>uint16(0) == 0x5A4D</code>: This checks if the first two bytes at the start of the file are <code>MZ</code>, a magic number indicating a Windows Portable Executable (PE) format.</li>
<li><code>uint16(uint32(0x3c)) == 0x4550</code>: A two-step check. First, it reads a 32-bit (4 bytes) value from offset <code>0x3c</code> of the file. In PE files, this offset typically contains a pointer to the PE header. It then checks whether the two bytes at that pointer are <code>PE</code> (<code>0x4550</code>), indicating a valid PE header. This ensures the file is a legitimate PE format and not a corrupted or obfuscated one.</li>
<li><code>$dotnetMagic</code>: Verifies the presence of the <code>BSJB</code> string. This signature is present in the CLI (Common Language Infrastructure) header of .NET binaries, and its presence can be used to indicate the file is a .NET assembly.</li>
<li><code>6 of them</code>: This condition states that at least six of the previously defined strings (either classes or functions) must be found within the file. This ensures that even if a few signatures are absent or have been modified, the rule will still trigger if a substantial number remain.</li>
</ul>
</li>
</ul>
<p><strong>Example 3: Stonedrill Used in Shamoon 2.0 Attacks</strong></p>
<p>We want to develop a YARA rule to scan for instances of <code>Stonedrill</code> used in <code>Shamoon 2.0</code> attacks based on:</p>
<ul>
<li>A sample named <code>sham2.exe</code> residing in the <code>/home/htb-student/Samples/YARASigma</code> directory of this section&#39;s target</li>
<li>An <a href="https://kas.pr/9s5A">analysis report from Kaspersky</a></li>
</ul>
<p>The report mentions: <em>... many samples had one additional <code>encrypted</code> resource with a specific, although non-unique name <code>101</code>.</em></p>
<p>Encrypted/compressed/obfuscated in PE files usually means high <a href="https://cocomelonc.github.io/malware/2022/11/05/malware-analysis-6.html">entropy</a>. We can use the <code>entropy_pe_section.py</code> script that resides in the <code>/home/htb-student</code> directory of this section&#39;s target to check if our sample&#39;s resource section contains anything encrypted/compressed as follows.</p>
<p>Developing YARA Rules</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ python3 entropy_pe_section<span class="hljs-selector-class">.py</span> -f /home/htb-student/Samples/YARASigma/sham2<span class="hljs-selector-class">.exe</span>
        virtual <span class="hljs-selector-tag">address</span>: <span class="hljs-number">0</span>x1000
        virtual size: <span class="hljs-number">0</span>x25f86
        raw size: <span class="hljs-number">0</span>x26000
        entropy: <span class="hljs-number">6.4093453613451885</span>
<span class="hljs-selector-class">.rdata</span>
        virtual <span class="hljs-selector-tag">address</span>: <span class="hljs-number">0</span>x27000
        virtual size: <span class="hljs-number">0</span>x62d2
        raw size: <span class="hljs-number">0</span>x6400
        entropy: <span class="hljs-number">4.913675128870228</span>
<span class="hljs-selector-class">.data</span>
        virtual <span class="hljs-selector-tag">address</span>: <span class="hljs-number">0</span>x2e000
        virtual size: <span class="hljs-number">0</span>xb744
        raw size: <span class="hljs-number">0</span>x9000
        entropy: <span class="hljs-number">1.039771174750106</span>
<span class="hljs-selector-class">.rsrc</span>
        virtual <span class="hljs-selector-tag">address</span>: <span class="hljs-number">0</span>x3a000
        virtual size: <span class="hljs-number">0</span>xc888
        raw size: <span class="hljs-number">0</span>xca00
        entropy: <span class="hljs-number">7.976847940518103</span>
</code></pre>
<p>We notice that the resource section (<code>.rsrc</code>) has high entropy (<code>8.0</code> is the maximum entropy value). We can take for granted that the resource section contains something suspicious.</p>
<p>A good YARA rule to identify instances of Stonedrill resides in the <code>/home/htb-student/Rules/yara</code> directory of this section&#39;s target, saved as <code>stonedrill.yar</code>.</p>
<p>Code: yara</p>
<pre><code class="lang-yara">import <span class="hljs-string">"pe"</span>
import <span class="hljs-string">"math"</span>

rule susp_file_enumerator_with_encrypted_resource_101 {
meta:
  copyright = <span class="hljs-string">"Kaspersky Lab"</span>
  description = <span class="hljs-string">"Generic detection for samples that enumerate files with encrypted resource called 101"</span>
  reference = <span class="hljs-string">"https://securelist.com/from-shamoon-to-stonedrill/77725/"</span>
  hash = <span class="hljs-string">"2cd0a5f1e9bcce6807e57ec8477d222a"</span>
  hash = <span class="hljs-string">"c843046e54b755ec63ccb09d0a689674"</span>
  version = <span class="hljs-string">"1.4"</span>
strings:
  <span class="hljs-variable">$mz</span> = <span class="hljs-string">"This program cannot be run in DOS mode."</span>
  <span class="hljs-variable">$a1</span> = <span class="hljs-string">"FindFirstFile"</span> ascii wide nocase
  <span class="hljs-variable">$a2</span> = <span class="hljs-string">"FindNextFile"</span> ascii wide nocase
  <span class="hljs-variable">$a3</span> = <span class="hljs-string">"FindResource"</span> ascii wide nocase
  <span class="hljs-variable">$a4</span> = <span class="hljs-string">"LoadResource"</span> ascii wide nocase

condition:
<span class="hljs-function"><span class="hljs-title">uint16</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span> == <span class="hljs-number">0</span>x5A4D and
all of them and
filesize &lt; <span class="hljs-number">700000</span> and
pe<span class="hljs-selector-class">.number_of_sections</span> &gt; <span class="hljs-number">4</span> and
pe<span class="hljs-selector-class">.number_of_signatures</span> == <span class="hljs-number">0</span> and
pe<span class="hljs-selector-class">.number_of_resources</span> &gt; <span class="hljs-number">1</span> and pe<span class="hljs-selector-class">.number_of_resources</span> &lt; <span class="hljs-number">15</span> and <span class="hljs-keyword">for</span> any <span class="hljs-selector-tag">i</span> <span class="hljs-keyword">in</span> (<span class="hljs-number">0</span>.<span class="hljs-selector-class">.pe</span><span class="hljs-selector-class">.number_of_resources</span> - <span class="hljs-number">1</span>):
( (math.entropy(pe<span class="hljs-selector-class">.resources</span>[i]<span class="hljs-selector-class">.offset</span>, pe<span class="hljs-selector-class">.resources</span>[i].length) &gt; <span class="hljs-number">7.8</span>) and pe<span class="hljs-selector-class">.resources</span>[i]<span class="hljs-selector-class">.id</span> == <span class="hljs-number">101</span> and
pe<span class="hljs-selector-class">.resources</span>[i]<span class="hljs-selector-class">.length</span> &gt; <span class="hljs-number">20000</span> and
pe<span class="hljs-selector-class">.resources</span>[i]<span class="hljs-selector-class">.language</span> == <span class="hljs-number">0</span> and
not (<span class="hljs-variable">$mz</span> <span class="hljs-keyword">in</span> (pe<span class="hljs-selector-class">.resources</span>[i]<span class="hljs-selector-class">.offset</span>.<span class="hljs-selector-class">.pe</span><span class="hljs-selector-class">.resources</span>[i]<span class="hljs-selector-class">.offset</span> + pe<span class="hljs-selector-class">.resources</span>[i].length))
)
}
</code></pre>
<p><strong>YARA Rule Breakdown</strong>:</p>
<ul>
<li><strong><code>Rule Imports</code></strong>: Modules are extensions to YARA&#39;s core functionality.<ul>
<li><code>import &quot;pe&quot;</code>: By importing the <a href="https://yara.readthedocs.io/en/stable/modules/pe.html">PE module</a> the YARA rule gains access to a set of specialized functions and structures that can inspect and analyze the details of <code>PE</code> files. This makes the rule more precise when it comes to detecting characteristics in Windows executables.</li>
<li><code>import &quot;math&quot;</code>: Imports the math module, providing mathematical functions like entropy calculations.</li>
</ul>
</li>
<li><strong><code>Rule Meta</code></strong>:<ul>
<li><code>copyright = &quot;Kaspersky Lab&quot;</code>: The rule was authored or copyrighted by Kaspersky Lab.</li>
<li><code>description = &quot;Generic detection for samples that enumerate files with encrypted resource called 101&quot;</code>: The rule aims to detect samples that list files and have an encrypted resource with the identifier &quot;101&quot;.</li>
<li><code>reference = &quot;https://securelist.com/from-shamoon-to-stonedrill/77725/&quot;</code>: Provides an URL for additional context or information about the rule.</li>
<li><code>hash</code>: Two hashes are given, probably as examples of known malicious files that match this rule.</li>
<li><code>version = &quot;1.4&quot;</code>: The version number of the YARA rule.</li>
</ul>
</li>
<li><strong><code>Strings Section</code></strong>:<ul>
<li><code>$mz = &quot;This program cannot be run in DOS mode.&quot;</code>: The ASCII string that typically appears in the DOS stub part of a PE file.</li>
<li><code>$a1 = &quot;FindFirstFile&quot;, $a2 = &quot;FindNextFile&quot;</code>: Strings for Windows API functions used to enumerate files. The usage of <code>FindFirstFileW</code> and <code>FindNextFileW</code> API functions can be idenfitied through string analysis.</li>
<li><code>$a3 = &quot;FindResource&quot;, $a4 = &quot;LoadResource&quot;</code>: As already mentioned Stonedrill samples feature encrypted resources. These strings can be found through string analysis and they are related to Windows API functions used for handling resources within the executable.</li>
</ul>
</li>
<li><strong><code>Rule Condition</code></strong>:<ul>
<li><code>uint16(0) == 0x5A4D</code>: Checks if the first two bytes of the file are &quot;MZ,&quot; indicating a Windows PE file.</li>
<li><code>all of them</code>: All the strings $a1, $a2, $a3, $a4 must be present in the file.</li>
<li><code>filesize &lt; 700000</code>: The file size must be less than <code>700,000</code> bytes.</li>
<li><code>pe.number_of_sections &gt; 4</code>: The PE file must have more than <code>four</code> sections.</li>
<li><code>pe.number_of_signatures == 0</code>: The file must not be digitally signed.</li>
<li><code>pe.number_of_resources &gt; 1 and pe.number_of_resources &lt; 15</code>: The file must contain more than one but fewer than <code>15</code> resources.</li>
<li><code>for any i in (0..pe.number_of_resources - 1): ( (math.entropy(pe.resources[i].offset, pe.resources[i].length) &gt; 7.8) and pe.resources[i].id == 101 and pe.resources[i].length &gt; 20000 and pe.resources[i].language == 0 and not ($mz in (pe.resources[i].offset..pe.resources[i].offset + pe.resources[i].length)))</code>: Go through each resource in the file and check if the entropy of the resource data is more than <code>7.8</code> and the resource identifier is <code>101</code> and the resource length is greater than <code>20,000</code> bytes and the language identifier of the resource is <code>0</code> and the DOS stub string is not present in the resource. It&#39;s not required for all resources to match the condition; only one resource meeting all the criteria is sufficient for the overall YARA rule to be a match.</li>
</ul>
</li>
</ul>
<h3 id="yara-rule-development-resources">YARA Rule Development Resources</h3>
<p>As you can imagine, the best YARA rule development resource is the official documentation, which can be found at the following <a href="https://yara.readthedocs.io/en/latest/writingrules.html">link</a>.</p>
<p>The next best resource on effective YARA rule developement comes from <a href="https://www.slideshare.net/KasperskyLabGlobal/upping-the-apt-hunting-game-learn-the-best-yara-practices-from-kaspersky">Kaspersky</a>.</p>
<p>Below are some blog posts that offer a more detailed explanation on how to use <code>yarGen</code> for YARA rule development:</p>
<ul>
<li><a href="https://www.nextron-systems.com/2015/02/16/write-simple-sound-yara-rules/">How to Write Simple but Sound Yara Rules - Part 1</a></li>
<li><a href="https://www.nextron-systems.com/2015/10/17/how-to-write-simple-but-sound-yara-rules-part-2/">How to Write Simple but Sound Yara Rules - Part 2</a></li>
<li><a href="https://www.nextron-systems.com/2016/04/15/how-to-write-simple-but-sound-yara-rules-part-3/">How to Write Simple but Sound Yara Rules - Part 3</a></li>
</ul>
<p><code>yarGen</code> is a great tool to develop some good yara rules by extracting unique patterns. Once the rule is developed with the help of yarGen, we definitely need to review and add/remove some more patterns to make it an effective rule.</p>
<p>In <a href="https://cyb3rops.medium.com/how-to-post-process-yara-rules-generated-by-yargen-121d29322282">this</a> blogpost, Florian Roth has mentioned that the main purpose of yarGen is to develop the best possible rules for manual post-processing which might sound like a tedious task, but the combination of clever automatic preselection and a critical human analyst beats both the fully manual and fully automatic generation process.</p>
<hr>
<p>Continuing forward, we&#39;ll dig deeper into using YARA, expanding our hunt for threats from our filesystem to memory and also within memory images.</p>
<h2 id="hunting-evil-with-yara-windows-edition-">Hunting Evil with YARA (Windows Edition)</h2>
<p>In this section, we&#39;ll explore using YARA on Windows systems for identifying threats both on disk and in memory.</p>
<p>Let&#39;s now navigate to the bottom of this section and click on &quot;Click here to spawn the target system!&quot;. Then, let&#39;s RDP into the Target IP using the provided credentials. The vast majority of the actions/commands covered from this point up to end of this section can be replicated inside the target, offering a more comprehensive grasp of the topics presented.</p>
<h3 id="hunting-for-malicious-executables-on-disk-with-yara">Hunting for Malicious Executables on Disk with YARA</h3>
<p>As we saw in the previous section, YARA is a potent weapon in the arsenal of cybersecurity professionals for detecting and hunting malicious executables on a disk. With custom YARA rules or established ones at our disposal, we can pinpoint suspicious or potentially malicious files based on distinct patterns, traits, or behaviors.</p>
<p>We will be using a sample that we analyzed previously named <code>dharma_sample.exe</code> residing in the <code>C:\Samples\YARASigma</code> directory of this section&#39;s target.</p>
<p>We&#39;ll first examine the malware sample inside a hex editor (<code>HxD</code>, located at <code>C:\Program Files\HxD</code>) to identify the previously discovered string <code>C:\crysis\Release\PDB\payload.pdb</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/234/1.png" alt=""></p>
<p><img src="https://academy.hackthebox.com/storage/modules/234/2.png" alt=""></p>
<p>If we scroll almost to the bottom, we will notice yet another seemingly unique <code>sssssbsss</code> string.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/234/3.png" alt=""></p>
<p>Going forward, we will craft a rule grounded in these patterns and then utilize the YARA utility to scour the filesystem for similar executables.</p>
<hr>
<p><strong>Note</strong>: In a Linux machine the <code>hexdump</code> utility could have been used to identify the aforementioned hex bytes as follows.</p>
<p>Hunting Evil with YARA (Windows Edition)</p>
<pre><code class="lang-shell-session">remnux@remnux:~$ hexdump dharma_sample.exe -C | grep crysis -n3
3140-0000c7e0 <span class="hljs-number"> 52 </span>00<span class="hljs-number"> 43 </span>6c 6f<span class="hljs-number"> 73 </span>65<span class="hljs-number"> 48 </span><span class="hljs-number"> 61 </span>6e<span class="hljs-number"> 64 </span>6c<span class="hljs-number"> 65 </span>00 4b<span class="hljs-number"> 45 </span> |R.CloseHandle.KE|
3141-0000c7f0 <span class="hljs-number"> 52 </span>4e<span class="hljs-number"> 45 </span>4c<span class="hljs-number"> 33 </span>32 2e<span class="hljs-number"> 64 </span> 6c 6c<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 52 </span>53<span class="hljs-number"> 44 </span>53  |RNEL32.dll..RSDS|
3142-0000c800 <span class="hljs-number"> 25 </span>7e 6d<span class="hljs-number"> 90 </span>fc<span class="hljs-number"> 96 </span>43<span class="hljs-number"> 42 </span> 8e c3<span class="hljs-number"> 87 </span>23 6b<span class="hljs-number"> 61 </span>a4<span class="hljs-number"> 92 </span> |%~m...CB...<span class="hljs-comment">#ka..|</span>
3143:0000c810 <span class="hljs-number"> 03 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 43 </span>3a 5c<span class="hljs-number"> 63 </span><span class="hljs-number"> 72 </span>79<span class="hljs-number"> 73 </span>69<span class="hljs-number"> 73 </span>5c<span class="hljs-number"> 52 </span>65  |....C:\crysis\Re|
3144-0000c820  6c<span class="hljs-number"> 65 </span>61<span class="hljs-number"> 73 </span>65 5c<span class="hljs-number"> 50 </span>44 <span class="hljs-number"> 42 </span>5c<span class="hljs-number"> 70 </span>61<span class="hljs-number"> 79 </span>6c 6f<span class="hljs-number"> 61 </span> |lease\PDB\payloa|
3145-0000c830 <span class="hljs-number"> 64 </span>2e<span class="hljs-number"> 70 </span>64<span class="hljs-number"> 62 </span>00<span class="hljs-number"> 00 </span>00 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00  |d.pdb...........|
3146-0000c840 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00  |................|
</code></pre>
<p>Hunting Evil with YARA (Windows Edition)</p>
<pre><code class="lang-shell-session">remnux@remnux:~$ hexdump dharma_sample.exe -C | grep sssssbsss -n3
5738-00016be0  3d<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>26<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span><span class="hljs-number"> 73 </span>73<span class="hljs-number"> 73 </span>64<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00  |=...&amp;...sssd....|
5739-00016bf0 <span class="hljs-number"> 26 </span>61 6c 6c 3d<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span><span class="hljs-number"> 73 </span>64<span class="hljs-number"> 00 </span>00 2d<span class="hljs-number"> 00 </span>61<span class="hljs-number"> 00 </span> |&amp;all=...sd..-.a.|
5740-00016c00 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 73 </span>00<span class="hljs-number"> 73 </span>00 <span class="hljs-number"> 62 </span>00<span class="hljs-number"> 73 </span>00<span class="hljs-number"> 73 </span>00<span class="hljs-number"> 00 </span>00  |....s.s.b.s.s...|
5741:00016c10 <span class="hljs-number"> 73 </span>73<span class="hljs-number"> 73 </span>73<span class="hljs-number"> 73 </span>62<span class="hljs-number"> 73 </span>73 <span class="hljs-number"> 73 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 73 </span>73<span class="hljs-number"> 73 </span>73  |sssssbsss...ssss|
5742-00016c20 <span class="hljs-number"> 73 </span>62<span class="hljs-number"> 73 </span>00<span class="hljs-number"> 22 </span>00<span class="hljs-number"> 00 </span>00 <span class="hljs-number"> 22 </span>00<span class="hljs-number"> 00 </span>00 5c<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span> |sbs."..."...\...|
5743-00016c30  5c<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>5c<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span> 5c<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>5c<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span> |\...\...\...\...|
5744-00016c40 <span class="hljs-number"> 22 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 20 </span>00<span class="hljs-number"> 22 </span>00 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00 5c<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span> |"... .".....\...|
</code></pre>
<hr>
<p>Let&#39;s incorporate all identified hex bytes into a rule, enhancing our ability to detect this string across any disk-based executable.</p>
<p>Code: yara</p>
<pre><code class="lang-yara">rule ransomware_dharma {

    meta:
        <span class="hljs-attr">author</span> = <span class="hljs-string">"Madhukar Raina"</span>
        <span class="hljs-attr">version</span> = <span class="hljs-string">"1.0"</span>
        <span class="hljs-attr">description</span> = <span class="hljs-string">"Simple rule to detect strings from Dharma ransomware"</span>
        <span class="hljs-attr">reference</span> = <span class="hljs-string">"https://www.virustotal.com/gui/file/bff6a1000a86f8edf3673d576786ec75b80bed0c458a8ca0bd52d12b74099071/behavior"</span>

    strings:
        $<span class="hljs-attr">string_pdb</span> = {  <span class="hljs-number">433</span>A5C6372797369735C52656C656173655C5044425C7061796C6F61642E706462 }
        $<span class="hljs-attr">string_ssss</span> = { <span class="hljs-number">73</span> <span class="hljs-number">73</span> <span class="hljs-number">73</span> <span class="hljs-number">73</span> <span class="hljs-number">73</span> <span class="hljs-number">62</span> <span class="hljs-number">73</span> <span class="hljs-number">73</span> <span class="hljs-number">73</span> }

        condition: all of them
}
</code></pre>
<p>This rule (<code>dharma_ransomware.yar</code>) can be found inside the <code>C:\Rules\yara</code> directory of this section&#39;s target.</p>
<p>Initiating the YARA executable with this rule, let&#39;s observe if it highlights other analogous samples on the disk.</p>
<p>Hunting Evil with YARA (Windows Edition)</p>
<pre><code class="lang-powershell-session">PS C:\Users\htb-student&gt; yara64.exe -s C:\Rules\yara\dharma_ransomware.yar C:\Samples\YARASigma\ -r 2&gt;null
ransomware_dharma C:\Samples\YARASigma\\dharma_sample.exe
0xc814:$string_pdb:<span class="hljs-number"> 43 </span>3A 5C<span class="hljs-number"> 63 </span>72<span class="hljs-number"> 79 </span>73<span class="hljs-number"> 69 </span>73 5C<span class="hljs-number"> 52 </span>65 6C<span class="hljs-number"> 65 </span>61<span class="hljs-number"> 73 </span>65 5C<span class="hljs-number"> 50 </span>44<span class="hljs-number"> 42 </span>5C<span class="hljs-number"> 70 </span>61<span class="hljs-number"> 79 </span>6C 6F<span class="hljs-number"> 61 </span>64 2E<span class="hljs-number"> 70 </span>64 62
0x16c10:$string_ssss:<span class="hljs-number"> 73 </span>73<span class="hljs-number"> 73 </span>73<span class="hljs-number"> 73 </span>62<span class="hljs-number"> 73 </span>73 73
ransomware_dharma C:\Samples\YARASigma\\check_updates.exe
0xc814:$string_pdb:<span class="hljs-number"> 43 </span>3A 5C<span class="hljs-number"> 63 </span>72<span class="hljs-number"> 79 </span>73<span class="hljs-number"> 69 </span>73 5C<span class="hljs-number"> 52 </span>65 6C<span class="hljs-number"> 65 </span>61<span class="hljs-number"> 73 </span>65 5C<span class="hljs-number"> 50 </span>44<span class="hljs-number"> 42 </span>5C<span class="hljs-number"> 70 </span>61<span class="hljs-number"> 79 </span>6C 6F<span class="hljs-number"> 61 </span>64 2E<span class="hljs-number"> 70 </span>64 62
0x16c10:$string_ssss:<span class="hljs-number"> 73 </span>73<span class="hljs-number"> 73 </span>73<span class="hljs-number"> 73 </span>62<span class="hljs-number"> 73 </span>73 73
ransomware_dharma C:\Samples\YARASigma\\microsoft.com
0xc814:$string_pdb:<span class="hljs-number"> 43 </span>3A 5C<span class="hljs-number"> 63 </span>72<span class="hljs-number"> 79 </span>73<span class="hljs-number"> 69 </span>73 5C<span class="hljs-number"> 52 </span>65 6C<span class="hljs-number"> 65 </span>61<span class="hljs-number"> 73 </span>65 5C<span class="hljs-number"> 50 </span>44<span class="hljs-number"> 42 </span>5C<span class="hljs-number"> 70 </span>61<span class="hljs-number"> 79 </span>6C 6F<span class="hljs-number"> 61 </span>64 2E<span class="hljs-number"> 70 </span>64 62
0x16c10:$string_ssss:<span class="hljs-number"> 73 </span>73<span class="hljs-number"> 73 </span>73<span class="hljs-number"> 73 </span>62<span class="hljs-number"> 73 </span>73 73
ransomware_dharma C:\Samples\YARASigma\\KB5027505.exe
0xc814:$string_pdb:<span class="hljs-number"> 43 </span>3A 5C<span class="hljs-number"> 63 </span>72<span class="hljs-number"> 79 </span>73<span class="hljs-number"> 69 </span>73 5C<span class="hljs-number"> 52 </span>65 6C<span class="hljs-number"> 65 </span>61<span class="hljs-number"> 73 </span>65 5C<span class="hljs-number"> 50 </span>44<span class="hljs-number"> 42 </span>5C<span class="hljs-number"> 70 </span>61<span class="hljs-number"> 79 </span>6C 6F<span class="hljs-number"> 61 </span>64 2E<span class="hljs-number"> 70 </span>64 62
0x16c10:$string_ssss:<span class="hljs-number"> 73 </span>73<span class="hljs-number"> 73 </span>73<span class="hljs-number"> 73 </span>62<span class="hljs-number"> 73 </span>73 73
ransomware_dharma C:\Samples\YARASigma\\pdf_reader.exe
0xc814:$string_pdb:<span class="hljs-number"> 43 </span>3A 5C<span class="hljs-number"> 63 </span>72<span class="hljs-number"> 79 </span>73<span class="hljs-number"> 69 </span>73 5C<span class="hljs-number"> 52 </span>65 6C<span class="hljs-number"> 65 </span>61<span class="hljs-number"> 73 </span>65 5C<span class="hljs-number"> 50 </span>44<span class="hljs-number"> 42 </span>5C<span class="hljs-number"> 70 </span>61<span class="hljs-number"> 79 </span>6C 6F<span class="hljs-number"> 61 </span>64 2E<span class="hljs-number"> 70 </span>64 62
0x16c10:$string_ssss:<span class="hljs-number"> 73 </span>73<span class="hljs-number"> 73 </span>73<span class="hljs-number"> 73 </span>62<span class="hljs-number"> 73 </span>73 73
</code></pre>
<p><strong>Command Breakdown</strong>:</p>
<ul>
<li><code>yara64.exe</code>: Refers to the YARA64 executable, which is the YARA scanner specifically designed for 64-bit systems.</li>
<li><code>-s C:\Rules\yara\dharma_ransomware.yar</code>: Specifies the YARA rules file to be used for scanning. In this case, the rules file named <code>dharma_ransomware.yar</code> located in the <code>C:\Rules\yara</code> directory is provided.</li>
<li><code>C:\Samples\YARASigma</code>: Specifies the path or directory to be scanned by YARA. In this case, the directory being scanned is <code>C:\Samples\YARASigma</code>.</li>
<li><code>-r</code>: Indicates that the scanning operation should be performed recursively, meaning YARA will scan files within subdirectories of the specified directory as well.</li>
<li><code>2&gt;nul</code>: Redirects the error output (stream <code>2</code>) to a null device, effectively hiding any error messages that might occur during the scanning process.</li>
</ul>
<p>As we can see, the <code>pdf_reader.exe</code>, <code>microsoft.com</code>, <code>check_updates.exe</code>, and <code>KB5027505.exe</code> files are detected by this rule (in addition to <code>dharma_sample.exe</code> of course).</p>
<p>Now, let&#39;s pivot, applying YARA rules to live processes.</p>
<h3 id="hunting-for-evil-within-running-processes-with-yara">Hunting for Evil Within Running Processes with YARA</h3>
<p>To ascertain if malware lurks in ongoing processes, we&#39;ll unleash the YARA scanner on the system&#39;s active processes. Let&#39;s demonstrate using a YARA rule that targets Metasploit&#39;s meterpreter shellcode, believed to be lurking in a running process.</p>
<p><strong>YARA Rule Source</strong>: <a href="https://github.com/cuckoosandbox/community/blob/master/data/yara/shellcode/metasploit.yar">https://github.com/cuckoosandbox/community/blob/master/data/yara/shellcode/metasploit.yar</a></p>
<p>Code: yara</p>
<pre><code class="lang-yara">rule meterpreter_reverse_tcp_shellcode {
    meta:
        author = <span class="hljs-string">"FDD @ Cuckoo sandbox"</span>
        description = <span class="hljs-string">"Rule for metasploit's  meterpreter reverse tcp raw shellcode"</span>

    strings:
        <span class="hljs-variable">$s1</span> = { fce8 <span class="hljs-number">8</span>?<span class="hljs-number">00</span> <span class="hljs-number">0000</span> <span class="hljs-number">60</span> }     <span class="hljs-regexp">//</span> shellcode prologe <span class="hljs-keyword">in</span> metasploit
        <span class="hljs-variable">$s2</span> = { <span class="hljs-number">648</span>b ??<span class="hljs-number">30</span> }             <span class="hljs-regexp">//</span> mov edx, fs:[???+<span class="hljs-number">0</span>x30]
        <span class="hljs-variable">$s3</span> = { <span class="hljs-number">4</span>c77 <span class="hljs-number">2607</span> }             <span class="hljs-regexp">//</span> kernel32 checksum
        <span class="hljs-variable">$s4</span> = <span class="hljs-string">"ws2_"</span>                    <span class="hljs-regexp">//</span> ws2_32.dll
        <span class="hljs-variable">$s5</span> = { <span class="hljs-number">2980</span> <span class="hljs-number">6</span>b00 }             <span class="hljs-regexp">//</span> WSAStartUp checksum
        <span class="hljs-variable">$s6</span> = { ea0f dfe0 }             <span class="hljs-regexp">//</span> WSASocket checksum
        <span class="hljs-variable">$s7</span> = { <span class="hljs-number">99</span>a5 <span class="hljs-number">7461</span> }             <span class="hljs-regexp">//</span> connect checksum

    condition:
        <span class="hljs-number">5</span> of them
}
</code></pre>
<p>We will be using a sample that we analyzed previously named <code>htb_sample_shell.exe</code> residing in the <code>C:\Samples\YARASigma</code> directory of this section&#39;s targe</p>
<p><code>htb_sample_shell.exe</code> injects Metasploit&#39;s meterpreter shellcode into the <code>cmdkey.exe</code> process. Let&#39;s activate it, ensuring successful injection.</p>
<p><strong>Note</strong>: Make sure you launch PowerShell as an administrator.</p>
<p>Hunting Evil with YARA (Windows Edition)</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-string">\Samples\YARASigma&gt;</span> .<span class="hljs-string">\htb_sample_shell.exe</span>

&lt;-- Hack the box sample <span class="hljs-keyword">for</span> yara signatures<span class="hljs-function"> --&gt;</span>

[+] Parent process <span class="hljs-keyword">with</span> PID <span class="hljs-number">7972</span> <span class="hljs-keyword">is</span> created : C:<span class="hljs-string">\Samples\YARASigma\htb_sample_shell.exe</span>
[+] Child process <span class="hljs-keyword">with</span> PID <span class="hljs-number">9084</span> <span class="hljs-keyword">is</span> created : C:<span class="hljs-string">\Windows\System32\cmdkey.exe</span>
[+] Shellcode <span class="hljs-keyword">is</span> written at address <span class="hljs-number">000002686</span>B1C0000 <span class="hljs-keyword">in</span> remote process C:<span class="hljs-string">\Windows\System32\cmdkey.exe</span>
[+] Remote thread <span class="hljs-keyword">to</span> execute the shellcode <span class="hljs-keyword">is</span> started <span class="hljs-keyword">with</span> thread ID <span class="hljs-number">368</span>

Press enter key <span class="hljs-keyword">to</span> terminate...
</code></pre>
<p>With the injection executed, let&#39;s scan every active system process as follows, through another PowerShell terminal (<code>Run as administrator</code>).</p>
<p>Hunting Evil with YARA (Windows Edition)</p>
<pre><code class="lang-powershell-session">PS C:\Windows\system32&gt; Get-Process | ForEach-Object { <span class="hljs-string">"Scanning with Yara for meterpreter shellcode on PID "</span>+$_.<span class="hljs-built_in">id</span>; &amp; <span class="hljs-string">"yara64.exe"</span> <span class="hljs-string">"C:\Rules\yara\meterpreter_shellcode.yar"</span> $_.<span class="hljs-built_in">id</span> }
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">9000</span>
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">9016</span>
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">4940</span>
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">5716</span>
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">9084</span>
meterpreter_reverse_tcp_shellcode <span class="hljs-number">9084</span>
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">7112</span>
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">8400</span>
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">9180</span>
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">416</span>
<span class="hljs-keyword">error</span> scanning <span class="hljs-number">416</span>: can <span class="hljs-keyword">not</span> attach <span class="hljs-keyword">to</span> process (<span class="hljs-keyword">try</span> <span class="hljs-built_in">running</span> <span class="hljs-keyword">as</span> root)
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">492</span>
<span class="hljs-keyword">error</span> scanning <span class="hljs-number">492</span>: can <span class="hljs-keyword">not</span> attach <span class="hljs-keyword">to</span> process (<span class="hljs-keyword">try</span> <span class="hljs-built_in">running</span> <span class="hljs-keyword">as</span> root)
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">1824</span>
<span class="hljs-keyword">error</span> scanning <span class="hljs-number">1824</span>: can <span class="hljs-keyword">not</span> attach <span class="hljs-keyword">to</span> process (<span class="hljs-keyword">try</span> <span class="hljs-built_in">running</span> <span class="hljs-keyword">as</span> root)
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">8268</span>
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">3940</span>
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">7960</span>
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">988</span>
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">6276</span>
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">4228</span>
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">772</span>
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">780</span>
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">1192</span>
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">7972</span>
meterpreter_reverse_tcp_shellcode <span class="hljs-number">7972</span>
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">0</span>
<span class="hljs-keyword">error</span> scanning <span class="hljs-number">0</span>: could <span class="hljs-keyword">not</span> open <span class="hljs-built_in">file</span>
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">6788</span>
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">924</span>
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">636</span>
Scanning <span class="hljs-keyword">with</span> Yara <span class="hljs-keyword">for</span> meterpreter shellcode <span class="hljs-keyword">on</span> PID <span class="hljs-number">1780</span>
<span class="hljs-keyword">error</span> scanning <span class="hljs-number">1780</span>: can <span class="hljs-keyword">not</span> attach <span class="hljs-keyword">to</span> process (<span class="hljs-keyword">try</span> <span class="hljs-built_in">running</span> <span class="hljs-keyword">as</span> root)
</code></pre>
<p>We&#39;re leveraging a concise PowerShell script. The <code>Get-Process</code> command fetches running processes, and with the help of the pipe symbol (<code>|</code>), this data funnels into the script block (<code>{...}</code>). Here, <code>ForEach-Object</code> dissects each process, prompting <code>yara64.exe</code> to apply our YARA rule on each process&#39;s memory.</p>
<p>Let&#39;s observe if the child process (<code>PID 9084</code>) gets flagged.</p>
<p>From the results, the meterpreter shellcode seems to have infiltrated a process with <code>PID 9084</code>. We can also guide the YARA scanner with a specific PID as follows.</p>
<p>Hunting Evil with YARA (Windows Edition)</p>
<pre><code class="lang-powershell-session">PS C:\Windows\system32&gt; yara64<span class="hljs-selector-class">.exe</span> C:\Rules\yara\meterpreter_shellcode<span class="hljs-selector-class">.yar</span> <span class="hljs-number">9084</span> --print-strings
meterpreter_reverse_tcp_shellcode <span class="hljs-number">9084</span>
<span class="hljs-number">0</span>x2686b1c0104:<span class="hljs-variable">$s3</span>: <span class="hljs-number">4</span>C <span class="hljs-number">77</span> <span class="hljs-number">26</span> <span class="hljs-number">07</span>
<span class="hljs-number">0</span>xe3fea7fef8:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x2686b1c00d9:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x7ffbfdad4490:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x7ffbfe85723f:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x7ffbfe857f07:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x7ffbfe8580a7:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x7ffbfe858147:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x7ffbfe8581b7:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x7ffbfe8581f7:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x7ffbfe858227:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x7ffbfe85833f:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x7ffbfe8587cf:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x7ffbfe8588c7:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x7ffbfe858917:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x7ffbfe858947:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x7ffbfe858987:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x7ffbfe8589d7:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x7ffbfe858a17:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x7ffbfe859c90:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x7ffbfe859cc6:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x7ffbfe859cee:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x7ffbfe859d16:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x7ffbfe859d42:<span class="hljs-variable">$s4</span>: ws2_
<span class="hljs-number">0</span>x2686b1c0115:<span class="hljs-variable">$s5</span>: <span class="hljs-number">29</span> <span class="hljs-number">80</span> <span class="hljs-number">6</span>B <span class="hljs-number">00</span>
<span class="hljs-number">0</span>x2686b1c0135:<span class="hljs-variable">$s6</span>: EA <span class="hljs-number">0</span>F DF E0
<span class="hljs-number">0</span>x2686b1c014a:<span class="hljs-variable">$s7</span>: <span class="hljs-number">99</span> A5 <span class="hljs-number">74</span> <span class="hljs-number">61</span>
</code></pre>
<p>The screenshot below shows an overview of what we discussed above.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/234/4.png" alt=""></p>
<h3 id="hunting-for-evil-within-etw-data-with-yara">Hunting for Evil Within ETW Data with YARA</h3>
<p>In the module titled <code>Windows Event Logs &amp; Finding Evil</code> we explored <code>ETW</code> and introduced <a href="https://github.com/mandiant/SilkETW">SilkETW</a>. In this section, we&#39;ll circle back to ETW data, highlighting how YARA can be used to filter or tag certain events.</p>
<p>A quick recap first. According to Microsoft, <code>Event Tracing For Windows (ETW)</code> is a general-purpose, high-speed tracing facility provided by the operating system. Using a buffering and logging mechanism implemented in the kernel, ETW provides a tracing mechanism for events raised by both user-mode applications and kernel-mode device drivers.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/234/yara\_etw.png" alt=""></p>
<ul>
<li><code>Controllers</code>: Controllers possess functionalities that encompass initiating and terminating trace sessions. They also have the capability to enable or disable providers within a specific trace.</li>
<li><code>Providers</code>: Providers are crucial, as they generate events and channel them to the designated ETW sessions.</li>
<li><code>Consumers</code>: Consumers are the subscribers to specific events. They tap into these events and then receive them for in-depth processing or analysis.</li>
</ul>
<p><strong>Useful Providers</strong></p>
<ul>
<li><code>Microsoft-Windows-Kernel-Process</code>: This ETW provider is instrumental in monitoring process-related activity within the Windows kernel. It can aid in detecting unusual process behaviors such as process injection, process hollowing, and other tactics commonly used by malware and advanced persistent threats (APTs).</li>
<li><code>Microsoft-Windows-Kernel-File</code>: As the name suggests, this provider focuses on file-related operations. It can be employed for detection scenarios involving unauthorized file access, changes to critical system files, or suspicious file operations indicative of exfiltration or ransomware activity.</li>
<li><code>Microsoft-Windows-Kernel-Network</code>: This ETW provider offers visibility into network-related activity at the kernel level. It&#39;s especially useful in detecting network-based attacks such as data exfiltration, unauthorized network connections, and potential signs of command and control (C2) communication.</li>
<li><code>Microsoft-Windows-SMBClient/SMBServer</code>: These providers monitor Server Message Block (SMB) client and server activity, providing insights into file sharing and network communication. They can be used to detect unusual SMB traffic patterns, potentially indicating lateral movement or data exfiltration.</li>
<li><code>Microsoft-Windows-DotNETRuntime</code>: This provider focuses on .NET runtime events, making it ideal for identifying anomalies in .NET application execution, potential exploitation of .NET vulnerabilities, or malicious .NET assembly loading.</li>
<li><code>OpenSSH</code>: Monitoring the OpenSSH ETW provider can provide important insights into Secure Shell (SSH) connection attempts, successful and failed authentications, and potential brute force attacks.</li>
<li><code>Microsoft-Windows-VPN-Client</code>: This provider enables tracking of Virtual Private Network (VPN) client events. It can be useful for identifying unauthorized or suspicious VPN connections.</li>
<li><code>Microsoft-Windows-PowerShell</code>: This ETW provider tracks PowerShell execution and command activity, making it invaluable for detecting suspicious PowerShell usage, script block logging, and potential misuse or exploitation.</li>
<li><code>Microsoft-Windows-Kernel-Registry</code>: This provider monitors registry operations, making it useful for detection scenarios related to changes in registry keys, often associated with persistence mechanisms, malware installation, or system configuration changes.</li>
<li><code>Microsoft-Windows-CodeIntegrity</code>: This provider monitors code and driver integrity checks, which can be key in identifying attempts to load unsigned or malicious drivers or code.</li>
<li><code>Microsoft-Antimalware-Service</code>: This ETW provider can be employed to detect potential issues with the antimalware service, including disabled services, configuration changes, or potential evasion techniques employed by malware.</li>
<li><code>WinRM</code>: Monitoring the Windows Remote Management (WinRM) provider can reveal unauthorized or suspicious remote management activity, often indicative of lateral movement or remote command execution.</li>
<li><code>Microsoft-Windows-TerminalServices-LocalSessionManager</code>: This provider tracks local Terminal Services sessions, making it useful for detecting unauthorized or suspicious remote desktop activity.</li>
<li><code>Microsoft-Windows-Security-Mitigations</code>: This provider keeps tabs on the effectiveness and operations of security mitigations in place. It&#39;s essential for identifying potential bypass attempts of these security controls.</li>
<li><code>Microsoft-Windows-DNS-Client</code>: This ETW provider gives visibility into DNS client activity, which is crucial for detecting DNS-based attacks, including DNS tunneling or unusual DNS requests that may indicate C2 communication.</li>
<li><code>Microsoft-Antimalware-Protection</code>: This provider monitors the operations of antimalware protection mechanisms. It can be used to detect any issues with these mechanisms, such as disabled protection features, configuration changes, or signs of evasion techniques employed by malicious actors.</li>
</ul>
<p><strong>YARA Rule Scanning on ETW (Using SilkETW)</strong></p>
<p>SilkETW is an open-source tool to work with Event Tracing for Windows (ETW) data. SilkETW provides enhanced visibility and analysis of Windows events for security monitoring, threat hunting, and incident response purposes. The best part of SilkETW is that it also has an option to integrate YARA rules. It includes YARA functionality to filter or tag event data.</p>
<p>SilkETW resides in the <code>C:\Tools\SilkETW\v8\SilkETW</code> directory of this section&#39;s target.</p>
<p>Hunting Evil with YARA (Windows Edition)</p>
<pre><code class="lang-powershell-session">PS C:\Tools\SilkETW\v8\SilkETW&gt; .\SilkETW.<span class="hljs-keyword">exe</span> -h

███████╗██╗██╗   ██╗  ██╗███████╗████████╗██╗    ██╗
██╔════╝██║██║   ██║ ██╔╝██╔════╝╚══██╔══╝██║    ██║
███████╗██║██║   █████╔╝ █████╗     ██║   ██║ █╗ ██║
╚════██║██║██║   ██╔═██╗ ██╔══╝     ██║   ██║███╗██║
███████║██║█████╗██║  ██╗███████╗   ██║   ╚███╔███╔╝
╚══════╝╚═╝╚════╝╚═╝  ╚═╝╚══════╝   ╚═╝    ╚══╝╚══╝
                  [v0.<span class="hljs-number">8</span> - Ruben Boonen =&gt; @FuzzySec]


 &gt;--~~--&gt; Args? &lt;--~~--&lt;

-h  (--<span class="hljs-keyword">help</span>)          This <span class="hljs-keyword">help</span> <span class="hljs-keyword">menu</span>
-s  (--silk)          Trivia about Silk
-t  (--<span class="hljs-built_in">type</span>)          Specify <span class="hljs-keyword">if</span> we are using <span class="hljs-keyword">a</span> Kernel <span class="hljs-built_in">or</span> User collector
-kk (--kernelkeyword) Valid keyword<span class="hljs-variable">s:</span> Process, Thread, ImageLoad, ProcessCounters, ContextSwitch,
                      DeferedProcedureCalls, Interrupt, SystemCall, DiskIO, DiskFileIO, DiskIOInit,
                      Dispatcher, Memory, MemoryHardFaults, VirtualAlloc, VAMap, NetworkTCPIP, Registry,
                      AdvancedLocalProcedureCalls, SplitIO, Handle, Driver, OS, Profile, Default,
                      ThreadTime, FileIO, FileIOInit, Verbose, All, IOQueue, ThreadPriority,
                      ReferenceSet, PMCProfile, NonContainer
-uk (--userkeyword)   Define <span class="hljs-keyword">a</span> mask of valid keywords, eg <span class="hljs-number">0</span>x2038 -&gt; JitKeyword|InteropKeyword|
                      LoaderKeyword|NGenKeyword
-pn (--providername)  User ETW provider name, eg <span class="hljs-string">"Microsoft-Windows-DotNETRuntime"</span> <span class="hljs-built_in">or</span> its
                      corresponding GUID eg <span class="hljs-string">"e13c0d23-ccbc-4e12-931b-d9cc2eee27e4"</span>
-<span class="hljs-keyword">l</span>  (--level)         Logging leve<span class="hljs-variable">l:</span> Always, Critical, Error, Warning, Informational, Verbose
-ot (--outputtype)    Output <span class="hljs-built_in">type</span>: POST <span class="hljs-keyword">to</span> <span class="hljs-string">"URL"</span>, <span class="hljs-keyword">write</span> <span class="hljs-keyword">to</span> <span class="hljs-string">"file"</span> <span class="hljs-built_in">or</span> <span class="hljs-keyword">write</span> <span class="hljs-keyword">to</span> <span class="hljs-string">"eventlog"</span>
-<span class="hljs-keyword">p</span>  (--path)          Full output <span class="hljs-keyword">file</span> path <span class="hljs-built_in">or</span> URL. Event logs are automatically written <span class="hljs-keyword">to</span>
                      <span class="hljs-string">"Applications and Services Logs\SilkETW-Log"</span>
-<span class="hljs-keyword">f</span>  (--<span class="hljs-built_in">filter</span>)        Filter <span class="hljs-built_in">type</span><span class="hljs-variable">s:</span> None, EventName, ProcessID, ProcessName, Opcode
-fv (--filtervalue)   Filter <span class="hljs-built_in">type</span> capture value, eg <span class="hljs-string">"svchost"</span> <span class="hljs-keyword">for</span> ProcessName
-<span class="hljs-keyword">y</span>  (--yara)          Full path <span class="hljs-keyword">to</span> folder containing Yara rules
-yo (--yaraoptions)   Either record <span class="hljs-string">"All"</span> events <span class="hljs-built_in">or</span> <span class="hljs-keyword">only</span> <span class="hljs-string">"Matches"</span>

 &gt;--~~--&gt; Usage? &lt;--~~--&lt;

# Use <span class="hljs-keyword">a</span> VirtualAlloc Kernel collector, POST results <span class="hljs-keyword">to</span> Elasticsearch
SilkETW.<span class="hljs-keyword">exe</span> -t kernel -kk VirtualAlloc -ot url -<span class="hljs-keyword">p</span> http<span class="hljs-variable">s:</span>//some.elk:<span class="hljs-number">9200</span>/valloc/_doc/

# Use <span class="hljs-keyword">a</span> Process Kernel collector, <span class="hljs-built_in">filter</span> <span class="hljs-keyword">on</span> PID
SilkETW.<span class="hljs-keyword">exe</span> -t kernel -kk Process -ot url -<span class="hljs-keyword">p</span> http<span class="hljs-variable">s:</span>//some.elk:<span class="hljs-number">9200</span>/kproc/_doc/ -<span class="hljs-keyword">f</span> ProcessID -fv <span class="hljs-number">11223</span>

# Use <span class="hljs-keyword">a</span> .Net User collector, specify mask, <span class="hljs-built_in">filter</span> <span class="hljs-keyword">on</span> EventName, <span class="hljs-keyword">write</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">file</span>
SilkETW.<span class="hljs-keyword">exe</span> -t user -pn Microsoft-Windows-DotNETRuntime -uk <span class="hljs-number">0</span>x2038 -ot <span class="hljs-keyword">file</span> -<span class="hljs-keyword">p</span> C:\Some\Path\out.json -<span class="hljs-keyword">f</span> EventName -fv Method/LoadVerbose

# Use <span class="hljs-keyword">a</span> DNS User collector, specify <span class="hljs-built_in">log</span> level, <span class="hljs-keyword">write</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">file</span>
SilkETW.<span class="hljs-keyword">exe</span> -t user -pn Microsoft-Windows-DNS-Client -<span class="hljs-keyword">l</span> Always -ot <span class="hljs-keyword">file</span> -<span class="hljs-keyword">p</span> C:\Some\Path\out.json

# Use <span class="hljs-keyword">an</span> LDAP User collector, perform Yara matching, POST matches <span class="hljs-keyword">to</span> Elasticsearch
SilkETW.<span class="hljs-keyword">exe</span> -t user -pn Microsoft-Windows-Ldap-Client -ot url -<span class="hljs-keyword">p</span> http<span class="hljs-variable">s:</span>//some.elk:<span class="hljs-number">9200</span>/ldap/_doc/ -<span class="hljs-keyword">y</span> C:\Some\Yara\Rule\Folder -yo matches

# Specify <span class="hljs-string">"Microsoft-Windows-COM-Perf"</span> by its GUID, <span class="hljs-keyword">write</span> results <span class="hljs-keyword">to</span> the event <span class="hljs-built_in">log</span>
SilkETW.<span class="hljs-keyword">exe</span> -t user -pn b8d6861b-d20f-<span class="hljs-number">4</span>eec-bbae-<span class="hljs-number">87</span>e0dd80602b -ot eventlog
</code></pre>
<p>The help menu provides many examples of how we can use the tool. Let&#39;s experiment with some of the YARA scanning options on a few ETW providers.</p>
<p><strong>Example 1: YARA Rule Scanning on Microsoft-Windows-PowerShell ETW Data</strong></p>
<p>The command below executes the SilkETW tool with specific options to perform event tracing and analysis on PowerShell-related events in Windows.</p>
<p><strong>Note</strong>: Make sure you launch PowerShell as an administrator.</p>
<p>Hunting Evil with YARA (Windows Edition)</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\T</span>ools<span class="hljs-symbol">\S</span>ilkETW<span class="hljs-symbol">\v</span>8<span class="hljs-symbol">\S</span>ilkETW&gt; .<span class="hljs-symbol">\S</span>ilkETW.exe -t user -pn Microsoft-Windows-PowerShell -ot file -p ./etw_ps_logs.json -l verbose -y C:<span class="hljs-symbol">\R</span>ules<span class="hljs-symbol">\y</span>ara  -yo Matches

███████╗██╗██╗   ██╗  ██╗███████╗████████╗██╗    ██╗
██╔════╝██║██║   ██║ ██╔╝██╔════╝╚══██╔══╝██║    ██║
███████╗██║██║   █████╔╝ █████╗     ██║   ██║ █╗ ██║
╚════██║██║██║   ██╔═██╗ ██╔══╝     ██║   ██║███╗██║
███████║██║█████╗██║  ██╗███████╗   ██║   ╚███╔███╔╝
╚══════╝╚═╝╚════╝╚═╝  ╚═╝╚══════╝   ╚═╝    ╚══╝╚══╝
                  [v0.8 - Ruben Boonen =&gt; @FuzzySec]

[+] Collector parameter validation success..
[&gt;] Starting trace collector (Ctrl-c to stop)..
[?] Events captured: 0
</code></pre>
<p><strong>Command Breakdown</strong>:</p>
<ul>
<li><code>-t user</code>: Specifies the event tracing mode. In this case, it is set to &quot;user,&quot; indicating that the tool will trace user-mode events (events generated by user applications).</li>
<li><code>-pn Microsoft-Windows-PowerShell</code>: Specifies the name of the provider or event log that you want to trace. In this command, it targets events from the &quot;Microsoft-Windows-PowerShell&quot; provider, which is responsible for generating events related to PowerShell activity.</li>
<li><code>-ot file</code>: Specifies the output format for the collected event data. In this case, it is set to &quot;file,&quot; meaning that the tool will save the event data to a file.</li>
<li><code>-p ./etw_ps_logs.json</code>: Specifies the output file path and filename. The tool will save the collected event data in JSON format to a file named &quot;etw_ps_logs.json&quot; in the current directory.</li>
<li><code>-l verbose</code>: Sets the logging level to &quot;verbose.&quot; This option enables more detailed logging information during the event tracing and analysis process.</li>
<li><code>-y C:\Rules\yara</code>: Enables YARA scanning and specifies a path containing YARA rules. This option indicates that the tool will perform YARA scanning on the collected event data.</li>
<li><code>-yo Matches</code>: Specifies the YARA output option. In this case, it is set to &quot;Matches,&quot; meaning that the tool will display YARA matches found during the scanning process.</li>
</ul>
<p>Inside the <code>C:\Rules\yara</code> directory of this section&#39;s target there is a YARA rules file named <code>etw_powershell_hello.yar</code> that looks for certain strings in PowerShell script blocks.</p>
<p>Code: yara</p>
<pre><code class="lang-yara">rule powershell_hello_world_yara {
    strings:
        <span class="hljs-built_in">$s</span>0 = <span class="hljs-string">"Write-Host"</span> <span class="hljs-keyword">ascii</span> wide nocase
        <span class="hljs-built_in">$s</span>1 = <span class="hljs-string">"Hello"</span> <span class="hljs-keyword">ascii</span> wide nocase
        <span class="hljs-built_in">$s</span>2 = <span class="hljs-string">"from"</span> <span class="hljs-keyword">ascii</span> wide nocase
        <span class="hljs-built_in">$s</span>3 = <span class="hljs-string">"PowerShell"</span> <span class="hljs-keyword">ascii</span> wide nocase
    condition:
        <span class="hljs-number">3</span> of (<span class="hljs-built_in">$s</span>*)
}
</code></pre>
<p>Let&#39;s now execute the following PowerShell command through another PowerShell terminal and see if it will get detected by SilkETW (where the abovementioned YARA rule has been loaded).</p>
<p>Hunting Evil with YARA (Windows Edition)</p>
<pre><code class="lang-powershell-session">PS C:\Users\htb-student&gt; <span class="hljs-built_in">Invoke-Command</span> -ScriptBlock {<span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Hello from PowerShell"</span>}
</code></pre>
<p>We have a match!</p>
<p>Hunting Evil with YARA (Windows Edition)</p>
<pre><code class="lang-powershell-session">PS C:\Tools\SilkETW\v8\SilkETW&gt; .\SilkETW.exe -t user -pn Microsoft-Windows-PowerShell -ot <span class="hljs-keyword">file</span> -p ./etw_ps_logs.json -l verbose -y C:\Rules\yara  -yo Matches

███████╗██╗██╗   ██╗  ██╗███████╗████████╗██╗    ██╗
██╔════╝██║██║   ██║ ██╔╝██╔════╝╚══██╔══╝██║    ██║
███████╗██║██║   █████╔╝ █████╗     ██║   ██║ █╗ ██║
╚════██║██║██║   ██╔═██╗ ██╔══╝     ██║   ██║███╗██║
███████║██║█████╗██║  ██╗███████╗   ██║   ╚███╔███╔╝
╚══════╝╚═╝╚════╝╚═╝  ╚═╝╚══════╝   ╚═╝    ╚══╝╚══╝
                  [v0<span class="hljs-number">.8</span> - Ruben Boonen =&gt; @FuzzySec]

[+] Collector <span class="hljs-keyword">parameter</span> validation <span class="hljs-comment">success..</span>
[&gt;] Starting <span class="hljs-comment">trace collector (Ctrl-c to stop)..</span>
[?] Events <span class="hljs-comment">captured: 28</span>
     -&gt; Yara <span class="hljs-comment">match: powershell_hello_world_yara</span>
     -&gt; Yara <span class="hljs-comment">match: powershell_hello_world_yara</span>
</code></pre>
<p><strong>Example 2: YARA Rule Scanning on Microsoft-Windows-DNS-Client ETW Data</strong></p>
<p>The command below executes the SilkETW tool with specific options to perform event tracing and analysis on DNS-related events in Windows.</p>
<p>Hunting Evil with YARA (Windows Edition)</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\T</span>ools<span class="hljs-symbol">\S</span>ilkETW<span class="hljs-symbol">\v</span>8<span class="hljs-symbol">\S</span>ilkETW&gt; .<span class="hljs-symbol">\S</span>ilkETW.exe -t user -pn Microsoft-Windows-DNS-Client -ot file -p ./etw_dns_logs.json -l verbose -y C:<span class="hljs-symbol">\R</span>ules<span class="hljs-symbol">\y</span>ara  -yo Matches

███████╗██╗██╗   ██╗  ██╗███████╗████████╗██╗    ██╗
██╔════╝██║██║   ██║ ██╔╝██╔════╝╚══██╔══╝██║    ██║
███████╗██║██║   █████╔╝ █████╗     ██║   ██║ █╗ ██║
╚════██║██║██║   ██╔═██╗ ██╔══╝     ██║   ██║███╗██║
███████║██║█████╗██║  ██╗███████╗   ██║   ╚███╔███╔╝
╚══════╝╚═╝╚════╝╚═╝  ╚═╝╚══════╝   ╚═╝    ╚══╝╚══╝
                  [v0.8 - Ruben Boonen =&gt; @FuzzySec]

[+] Collector parameter validation success..
[&gt;] Starting trace collector (Ctrl-c to stop)..
[?] Events captured: 0
</code></pre>
<p>Inside the <code>C:\Rules\yara</code> directory of this section&#39;s target there is a YARA rules file named <code>etw_dns_wannacry.yar</code> that looks for a hardcoded domain that exists in Wannacry ransomware samples in DNS events.</p>
<p>Code: yara</p>
<pre><code class="lang-yara"><span class="hljs-selector-tag">rule</span> <span class="hljs-selector-tag">dns_wannacry_domain</span> {
    <span class="hljs-attribute">strings</span>:
        $s1 = <span class="hljs-string">"iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com"</span> ascii wide nocase
    condition:
        $s1
}
</code></pre>
<p>Let&#39;s now execute the following command through another PowerShell terminal and see if it will get detected by SilkETW (where the abovementioned YARA rule has been loaded).</p>
<p>Hunting Evil with YARA (Windows Edition)</p>
<pre><code class="lang-powershell-session">PS C:\Users\htb-student&gt; ping iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com
Reply from <span class="hljs-number">104.17</span>.<span class="hljs-number">244.81</span>: <span class="hljs-attr">bytes=32</span> <span class="hljs-attr">time=14ms</span> <span class="hljs-attr">TTL=56</span>
Reply from <span class="hljs-number">104.17</span>.<span class="hljs-number">244.81</span>: <span class="hljs-attr">bytes=32</span> <span class="hljs-attr">time=14ms</span> <span class="hljs-attr">TTL=56</span>
Reply from <span class="hljs-number">104.17</span>.<span class="hljs-number">244.81</span>: <span class="hljs-attr">bytes=32</span> <span class="hljs-attr">time=14ms</span> <span class="hljs-attr">TTL=56</span>
Reply from <span class="hljs-number">104.17</span>.<span class="hljs-number">244.81</span>: <span class="hljs-attr">bytes=32</span> <span class="hljs-attr">time=14ms</span> <span class="hljs-attr">TTL=56</span>

Ping statistics for <span class="hljs-number">104.17</span>.<span class="hljs-number">244.81</span>:
    Packets: <span class="hljs-attr">Sent</span> = <span class="hljs-number">4</span>, <span class="hljs-attr">Received</span> = <span class="hljs-number">4</span>, <span class="hljs-attr">Lost</span> = <span class="hljs-number">0</span> (<span class="hljs-number">0</span>% loss),
Approximate round trip times <span class="hljs-keyword">in</span> milli-seconds:
    <span class="hljs-attr">Minimum</span> = <span class="hljs-number">14</span>ms, <span class="hljs-attr">Maximum</span> = <span class="hljs-number">14</span>ms, <span class="hljs-attr">Average</span> = <span class="hljs-number">14</span>ms
</code></pre>
<p>We have a match!</p>
<p>Hunting Evil with YARA (Windows Edition)</p>
<pre><code class="lang-powershell-session">PS C:\Tools\SilkETW\v8\SilkETW&gt; .\SilkETW.exe -t user -pn Microsoft-Windows-DNS-Client -ot <span class="hljs-keyword">file</span> -p ./etw_dns_logs.json -l verbose -y C:\Rules\yara  -yo Matches

███████╗██╗██╗   ██╗  ██╗███████╗████████╗██╗    ██╗
██╔════╝██║██║   ██║ ██╔╝██╔════╝╚══██╔══╝██║    ██║
███████╗██║██║   █████╔╝ █████╗     ██║   ██║ █╗ ██║
╚════██║██║██║   ██╔═██╗ ██╔══╝     ██║   ██║███╗██║
███████║██║█████╗██║  ██╗███████╗   ██║   ╚███╔███╔╝
╚══════╝╚═╝╚════╝╚═╝  ╚═╝╚══════╝   ╚═╝    ╚══╝╚══╝
                  [v0<span class="hljs-number">.8</span> - Ruben Boonen =&gt; @FuzzySec]

[+] Collector <span class="hljs-keyword">parameter</span> validation <span class="hljs-comment">success..</span>
[&gt;] Starting <span class="hljs-comment">trace collector (Ctrl-c to stop)..</span>
[?] Events <span class="hljs-comment">captured: 60</span>
     -&gt; Yara <span class="hljs-comment">match: dns_wannacry_domain</span>
     -&gt; Yara <span class="hljs-comment">match: dns_wannacry_domain</span>
</code></pre>
<h2 id="hunting-evil-with-yara-linux-edition-">Hunting Evil with YARA (Linux Edition)</h2>
<p>Let&#39;s face the reality of cybersecurity operations: often, as Security Analysts, we don’t get the luxury of direct access to a potentially compromised system. Imagine, we&#39;ve got suspicious flags waving from a remote machine, but due to organizational boundaries, permissions, or logistical issues, we just can&#39;t lay our hands on it. It feels like knowing there&#39;s a potential fire but not being able to see or touch it directly. This situation can be nerve-wracking, but it&#39;s a challenge we&#39;ve learned to tackle.</p>
<p>Here&#39;s where things get interesting. Even if we can&#39;t access the machine, in many cases, a memory capture (or memory dump) from the suspicious system can be handed over to us in the Security Operations Center (SOC). It&#39;s akin to receiving a snapshot of everything happening in the system at a particular moment. And just because we have this snapshot, doesn&#39;t mean our hands are tied.</p>
<p>Luckily, our trusty tool YARA comes to the rescue. We can run YARA-based scans directly on these memory images. It&#39;s like having x-ray vision: we can peer into the state of the system, looking for signs of malicious activity or compromised indicators, all without ever having direct access to the machine itself. This capability not only enhances our investigative prowess but also ensures that even remote, inaccessible systems don&#39;t remain black boxes to us. So, while the direct path may be blocked, with tools like YARA and our expertise, we always find a way to shine a light into the shadows.</p>
<h3 id="hunting-for-evil-within-memory-images-with-yara">Hunting for Evil Within Memory Images with YARA</h3>
<p>Incorporating YARA extends the capabilities of memory forensics, a pivotal technique in malware analysis and incident response. It equips us to traverse memory content, hunting for telltale signs or compromise indicators.</p>
<p>YARA&#39;s memory image scanning mirrors its disk-based counterpart. Let&#39;s map out the process:</p>
<ul>
<li><strong><code>Create YARA Rules</code></strong>: Either develop bespoke YARA rules or lean on existing ones that target memory-based malware traits or dubious behaviors.</li>
<li><strong><code>Compile YARA Rules</code></strong>: Compile the YARA rules into a binary format using the <code>yarac</code> tool (YARA Compiler). This step creates a file containing the compiled YARA rules with a <code>.yrc</code> extension. This step is optional, as we can use the normal rules in text format as well. While it is possible to use YARA in its human-readable format, compiling the rules is a best practice when deploying YARA-based detection systems or working with a large number of rules to ensure optimal performance and effectiveness. Also, compiling rules provides some level of protection by converting them into binary format, making it harder for others to view the actual rule content.</li>
<li><strong><code>Obtain Memory Image</code></strong>: Capture a memory image using tools such as <a href="https://www.magnetforensics.com/resources/magnet-dumpit-for-windows/">DumpIt</a>, <a href="http://www.nirsoft.net/utils/nircmd.html">MemDump</a>, <a href="https://belkasoft.com/ram-capturer">Belkasoft RAM Capturer</a>, <a href="https://www.magnetforensics.com/resources/magnet-ram-capture/">Magnet RAM Capture</a>, <a href="https://www.exterro.com/ftk-imager">FTK Imager</a>, and <a href="https://github.com/504ensicsLabs/LiME">LiME (Linux Memory Extractor)</a>.</li>
<li><strong><code>Memory Image Scanning with YARA</code></strong>: Use the <code>yara</code> tool and the compiled YARA rules to scan the memory image for possible matches.</li>
</ul>
<p>Let&#39;s now navigate to the bottom of this section and click on &quot;Click here to spawn the target system!&quot;. Then, let&#39;s SSH into the Target IP using the provided credentials. The vast majority of the actions/commands covered from this point up to end of this section can be replicated inside the target, offering a more comprehensive grasp of the topics presented.</p>
<p>For instance, we have a memory snapshot named <code>compromised_system.raw</code> (residing in the <code>/home/htb-student/MemoryDumps</code> directory of this section&#39;s target) originating from a system under the siege of <code>WannaCry</code> ransomware. Let&#39;s confront this image with the <code>wannacry_artifacts_memory.yar</code> YARA rule (residing in the <code>/home/htb-student/Rules/yara</code> directory of this section&#39;s target).</p>
<p>Here&#39;s an example command for YARA-based memory scanning:</p>
<p>Hunting Evil with YARA (Linux Edition)</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ yara /home/htb-student/Rules/yara/wannacry_artifacts_memory<span class="hljs-selector-class">.yar</span> /home/htb-student/MemoryDumps/compromised_system<span class="hljs-selector-class">.raw</span> --print-strings
Ransomware_WannaCry /home/htb-student/MemoryDumps/compromised_system<span class="hljs-selector-class">.raw</span>
<span class="hljs-number">0</span>x4e140:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x1cb9b24:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>xdb564d8:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x13bac36c:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x16a2ae44:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x16ce55d8:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x17bf1fe6:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x17cb8002:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x17cb80d0:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x17cb80f8:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x18a68f50:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x18a9b4b8:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x18dc15a8:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x18df37d0:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x19a4b522:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x1aac0600:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x1c07ed9a:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x1c59cd32:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x1d1593f0:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x1d1c6fe2:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x1d92632a:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x1dd65c34:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x1e607a1e:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x1e607dca:<span class="hljs-variable">$wannacry_payload_str1</span>: tasksche<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x13bac3d7:<span class="hljs-variable">$wannacry_payload_str2</span>: www<span class="hljs-selector-class">.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea</span><span class="hljs-selector-class">.com</span>
<span class="hljs-number">0</span>x197ba5e0:<span class="hljs-variable">$wannacry_payload_str2</span>: www<span class="hljs-selector-class">.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea</span><span class="hljs-selector-class">.com</span>
<span class="hljs-number">0</span>x1a07cedf:<span class="hljs-variable">$wannacry_payload_str2</span>: www<span class="hljs-selector-class">.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea</span><span class="hljs-selector-class">.com</span>
<span class="hljs-number">0</span>x1a2cb300:<span class="hljs-variable">$wannacry_payload_str2</span>: www<span class="hljs-selector-class">.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea</span><span class="hljs-selector-class">.com</span>
<span class="hljs-number">0</span>x1b644cd8:<span class="hljs-variable">$wannacry_payload_str2</span>: www<span class="hljs-selector-class">.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea</span><span class="hljs-selector-class">.com</span>
<span class="hljs-number">0</span>x1d15945b:<span class="hljs-variable">$wannacry_payload_str2</span>: www<span class="hljs-selector-class">.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea</span><span class="hljs-selector-class">.com</span>
<span class="hljs-number">0</span>x1dd65c9f:<span class="hljs-variable">$wannacry_payload_str2</span>: www<span class="hljs-selector-class">.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea</span><span class="hljs-selector-class">.com</span>
<span class="hljs-number">0</span>x450b048:<span class="hljs-variable">$wannacry_payload_str3</span>: mssecsvc<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x5a7f3d4:<span class="hljs-variable">$wannacry_payload_str3</span>: mssecsvc<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>xda1c350:<span class="hljs-variable">$wannacry_payload_str3</span>: mssecsvc<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x12481048:<span class="hljs-variable">$wannacry_payload_str3</span>: mssecsvc<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x17027910:<span class="hljs-variable">$wannacry_payload_str3</span>: mssecsvc<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x17f0dc18:<span class="hljs-variable">$wannacry_payload_str3</span>: mssecsvc<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x18c360cc:<span class="hljs-variable">$wannacry_payload_str3</span>: mssecsvc<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x1a2a02f0:<span class="hljs-variable">$wannacry_payload_str3</span>: mssecsvc<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x13945408:<span class="hljs-variable">$wannacry_payload_str4</span>: diskpart<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">0</span>x19a28480:<span class="hljs-variable">$wannacry_payload_str4</span>: diskpart.exe
</code></pre>
<p>Beyond standalone tools, diving deeper into memory forensics offers a plethora of avenues. Integrating YARA within memory forensics frameworks amplifies its potential. With the Volatility framework and YARA operating in tandem, WannaCry-specific IOCs can be detected seamlessly.</p>
<p>The <a href="https://www.volatilityfoundation.org/releases">Volatility framework</a> is a powerful open-source memory forensics tool used to analyze memory images from various operating systems. YARA can be integrated into the Volatility framework as a plugin called <code>yarascan</code> allowing for the application of YARA rules to memory analysis.</p>
<p>The Volatility framework is covered in detail inside HTB Academy&#39;s <code>Introduction to Digital Forensics</code> module.</p>
<p>For now, let&#39;s only discuss how YARA can be used as a plugin in the Volatility framework.</p>
<p><strong>Single Pattern YARA Scanning Against a Memory Image</strong></p>
<p>In this case, we&#39;ll specify a YARA rule pattern directly in the command-line which is searched within the memory image by the <code>yarascan</code> plugin of Volatility. The string should be enclosed in quotes (<code>&quot;</code>) after the <code>-U</code> option. This is useful when we have a specific YARA rule or pattern that we want to apply without creating a separate YARA rules file.</p>
<p>From previous analysis we know that WannaCry malware attempt to connect to the following hard-coded URI <code>www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com</code></p>
<p>Introducing this pattern within the command line using <code>-U &quot;www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com&quot;</code> prompts a search within the <code>compromised_system.raw</code> memory image.</p>
<p>Hunting Evil with YARA (Linux Edition)</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ vol.py -f /home/htb-student/MemoryDumps/compromised_system.raw yarascan -U "www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com"
Volatility Foundation Volatility Framework 2.6.1
/usr/local/lib/python2.7/dist-packages/volatility/plugins/community/YingLi/ssh_agent_key.py:12: CryptographyDeprecationWarning: Python<span class="hljs-number"> 2 </span>is no longer supported by the Python core team. Support for it is now deprecated in cryptography, and will be removed in the next release.
  from cryptography.hazmat.backends.openssl import backend
Rule: r1
Owner: Process svchost.exe Pid 1576
0x004313d7 <span class="hljs-number"> 77 </span>77<span class="hljs-number"> 77 </span>2e<span class="hljs-number"> 69 </span>75<span class="hljs-number"> 71 </span>65<span class="hljs-number"> 72 </span>66<span class="hljs-number"> 73 </span>6f<span class="hljs-number"> 64 </span>70<span class="hljs-number"> 39 </span>69   www.iuqerfsodp9i
0x004313e7 <span class="hljs-number"> 66 </span>6a<span class="hljs-number"> 61 </span>70 6f<span class="hljs-number"> 73 </span>64<span class="hljs-number"> 66 </span>6a<span class="hljs-number"> 68 </span>67 6f<span class="hljs-number"> 73 </span>75<span class="hljs-number"> 72 </span>69   fjaposdfjhgosuri
0x004313f7  6a<span class="hljs-number"> 66 </span>61<span class="hljs-number"> 65 </span>77<span class="hljs-number"> 72 </span>77<span class="hljs-number"> 65 </span>72<span class="hljs-number"> 67 </span>77<span class="hljs-number"> 65 </span>61 2e<span class="hljs-number"> 63 </span>6f   jfaewrwergwea.co
0x00431407  6d<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>  m...............
0x00431417 <span class="hljs-number"> 00 </span>f0 5d<span class="hljs-number"> 17 </span>00 ff ff ff ff<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>  ..].............
0x00431427 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>20<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>04<span class="hljs-number"> 00 </span>00   ................
0x00431437 <span class="hljs-number"> 00 </span>01<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x00431447 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x00431457 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>50<span class="hljs-number"> 51 </span>17<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   .....PQ.........
0x00431467 <span class="hljs-number"> 00 </span>13<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>b8<span class="hljs-number"> 43 </span>03<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ......C.........
0x00431477 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x00431487 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x00431497 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x004314a7 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x004314b7 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x004314c7 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
Rule: r1
Owner: Process svchost.exe Pid 1576
0x0013dcd8 <span class="hljs-number"> 77 </span>77<span class="hljs-number"> 77 </span>2e<span class="hljs-number"> 69 </span>75<span class="hljs-number"> 71 </span>65<span class="hljs-number"> 72 </span>66<span class="hljs-number"> 73 </span>6f<span class="hljs-number"> 64 </span>70<span class="hljs-number"> 39 </span>69   www.iuqerfsodp9i
0x0013dce8 <span class="hljs-number"> 66 </span>6a<span class="hljs-number"> 61 </span>70 6f<span class="hljs-number"> 73 </span>64<span class="hljs-number"> 66 </span>6a<span class="hljs-number"> 68 </span>67 6f<span class="hljs-number"> 73 </span>75<span class="hljs-number"> 72 </span>69   fjaposdfjhgosuri
0x0013dcf8  6a<span class="hljs-number"> 66 </span>61<span class="hljs-number"> 65 </span>77<span class="hljs-number"> 72 </span>77<span class="hljs-number"> 65 </span>72<span class="hljs-number"> 67 </span>77<span class="hljs-number"> 65 </span>61 2e<span class="hljs-number"> 63 </span>6f   jfaewrwergwea.co
0x0013dd08  6d<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>  m...............
---SNIP<span class="yaml"><span class="hljs-meta">---</span></span>
</code></pre>
<p>This option allows us to directly specify a YARA rule string within the command-line itself. Let&#39;s see how we can search for the content of a whole YARA rule file (i.e. <code>.yar</code> rule file) in memory image files.</p>
<p><strong>Multiple YARA Rule Scanning Against a Memory Image</strong></p>
<p>When we have multiple YARA rules or a set of complex rules that we want to apply to a memory image, we can use the <code>-y</code> option followed by the rule file path in the Volatility framework, which allows us to specify the path to a YARA rules file. The YARA rules file (<code>wannacry_artifacts_memory.yar</code> in our case) should contain one or more YARA rules in a separate file.</p>
<p>The YARA rules file we will use for demostration purposes is the following.</p>
<p>Hunting Evil with YARA (Linux Edition)</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat /home/htb-student/Rules/yara/wannacry_artifacts_memory.yar
rule Ransomware_WannaCry {

    meta:
        author = <span class="hljs-string">"Madhukar Raina"</span>
        version = <span class="hljs-string">"1.1"</span>
        description = <span class="hljs-string">"Simple rule to detect strings from WannaCry ransomware"</span>
        reference = <span class="hljs-string">"https://www.virustotal.com/gui/file/ed01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa/behavior"</span>


    strings:
        <span class="hljs-built_in">$wannacry</span>_payload_str1 = <span class="hljs-string">"tasksche.exe"</span> fullword <span class="hljs-keyword">ascii</span>
        <span class="hljs-built_in">$wannacry</span>_payload_str2 = <span class="hljs-string">"www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com"</span> <span class="hljs-keyword">ascii</span>
        <span class="hljs-built_in">$wannacry</span>_payload_str3 = <span class="hljs-string">"mssecsvc.exe"</span> fullword <span class="hljs-keyword">ascii</span>
        <span class="hljs-built_in">$wannacry</span>_payload_str4 = <span class="hljs-string">"diskpart.exe"</span> fullword <span class="hljs-keyword">ascii</span>
        <span class="hljs-built_in">$wannacry</span>_payload_str5 = <span class="hljs-string">"lhdfrgui.exe"</span> fullword <span class="hljs-keyword">ascii</span>

    condition:
        <span class="hljs-number">3</span> of them
</code></pre>
<p>Let&#39;s run Volatility with the rule <code>wannacry_artifacts_memory.yar</code> (residing in the <code>/home/htb-student/Rules/yara</code> directory) to scan the memory image <code>compromised_system.raw</code> (residing in the <code>/home/htb-student/MemoryDumps</code> directory)</p>
<p>Hunting Evil with YARA (Linux Edition)</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ vol.py -f /home/htb-student/MemoryDumps/compromised_system.raw yarascan -y /home/htb-student/Rules/yara/wannacry_artifacts_memory.yar
Volatility Foundation Volatility Framework 2.6.1
/usr/local/lib/python2.7/dist-packages/volatility/plugins/community/YingLi/ssh_agent_key.py:12: CryptographyDeprecationWarning: Python<span class="hljs-number"> 2 </span>is no longer supported by the Python core team. Support for it is now deprecated in cryptography, and will be removed in the next release.
  from cryptography.hazmat.backends.openssl import backend
Rule: Ransomware_WannaCry
Owner: Process svchost.exe Pid 1576
0x0043136c <span class="hljs-number"> 74 </span>61<span class="hljs-number"> 73 </span>6b<span class="hljs-number"> 73 </span>63<span class="hljs-number"> 68 </span>65 2e<span class="hljs-number"> 65 </span>78<span class="hljs-number"> 65 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>  tasksche.exe....
0x0043137c <span class="hljs-number"> 52 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 43 </span>6c 6f<span class="hljs-number"> 73 </span>65<span class="hljs-number"> 48 </span>61 6e<span class="hljs-number"> 64 </span>6c<span class="hljs-number"> 65 </span>00   R...CloseHandle.
0x0043138c <span class="hljs-number"> 57 </span>72<span class="hljs-number"> 69 </span>74<span class="hljs-number"> 65 </span>46<span class="hljs-number"> 69 </span>6c<span class="hljs-number"> 65 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 43 </span>72<span class="hljs-number"> 65 </span>61   WriteFile...Crea
0x0043139c <span class="hljs-number"> 74 </span>65<span class="hljs-number"> 46 </span>69 6c<span class="hljs-number"> 65 </span>41<span class="hljs-number"> 00 </span>43<span class="hljs-number"> 72 </span>65<span class="hljs-number"> 61 </span>74<span class="hljs-number"> 65 </span>50<span class="hljs-number"> 72 </span>  teFileA.CreatePr
0x004313ac  6f<span class="hljs-number"> 63 </span>65<span class="hljs-number"> 73 </span>73<span class="hljs-number"> 41 </span>00<span class="hljs-number"> 00 </span>6b<span class="hljs-number"> 00 </span>65<span class="hljs-number"> 00 </span>72<span class="hljs-number"> 00 </span>6e<span class="hljs-number"> 00 </span>  ocessA..k.e.r.n.
0x004313bc <span class="hljs-number"> 65 </span>00 6c<span class="hljs-number"> 00 </span>33<span class="hljs-number"> 00 </span>32<span class="hljs-number"> 00 </span>2e<span class="hljs-number"> 00 </span>64<span class="hljs-number"> 00 </span>6c<span class="hljs-number"> 00 </span>6c<span class="hljs-number"> 00 </span>  e.l.3.2...d.l.l.
0x004313cc <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 68 </span>74<span class="hljs-number"> 74 </span>70 3a 2f 2f<span class="hljs-number"> 77 </span>77<span class="hljs-number"> 77 </span>2e<span class="hljs-number"> 69 </span>  ....http://www.i
0x004313dc <span class="hljs-number"> 75 </span>71<span class="hljs-number"> 65 </span>72<span class="hljs-number"> 66 </span>73 6f<span class="hljs-number"> 64 </span>70<span class="hljs-number"> 39 </span>69<span class="hljs-number"> 66 </span>6a<span class="hljs-number"> 61 </span>70 6f   uqerfsodp9ifjapo
0x004313ec <span class="hljs-number"> 73 </span>64<span class="hljs-number"> 66 </span>6a<span class="hljs-number"> 68 </span>67 6f<span class="hljs-number"> 73 </span>75<span class="hljs-number"> 72 </span>69 6a<span class="hljs-number"> 66 </span>61<span class="hljs-number"> 65 </span>77   sdfjhgosurijfaew
0x004313fc <span class="hljs-number"> 72 </span>77<span class="hljs-number"> 65 </span>72<span class="hljs-number"> 67 </span>77<span class="hljs-number"> 65 </span>61 2e<span class="hljs-number"> 63 </span>6f 6d<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   rwergwea.com....
0x0043140c <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00 f0 5d<span class="hljs-number"> 17 </span>00   .............]..
0x0043141c  ff ff ff ff<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x0043142c <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 20 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 04 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 00 </span>00   ................
0x0043143c <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x0043144c <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x0043145c <span class="hljs-number"> 50 </span>51<span class="hljs-number"> 17 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 13 </span>00<span class="hljs-number"> 00 </span>00   PQ..............
Rule: Ransomware_WannaCry
Owner: Process svchost.exe Pid 1576
0x004313d7 <span class="hljs-number"> 77 </span>77<span class="hljs-number"> 77 </span>2e<span class="hljs-number"> 69 </span>75<span class="hljs-number"> 71 </span>65<span class="hljs-number"> 72 </span>66<span class="hljs-number"> 73 </span>6f<span class="hljs-number"> 64 </span>70<span class="hljs-number"> 39 </span>69   www.iuqerfsodp9i
0x004313e7 <span class="hljs-number"> 66 </span>6a<span class="hljs-number"> 61 </span>70 6f<span class="hljs-number"> 73 </span>64<span class="hljs-number"> 66 </span>6a<span class="hljs-number"> 68 </span>67 6f<span class="hljs-number"> 73 </span>75<span class="hljs-number"> 72 </span>69   fjaposdfjhgosuri
0x004313f7  6a<span class="hljs-number"> 66 </span>61<span class="hljs-number"> 65 </span>77<span class="hljs-number"> 72 </span>77<span class="hljs-number"> 65 </span>72<span class="hljs-number"> 67 </span>77<span class="hljs-number"> 65 </span>61 2e<span class="hljs-number"> 63 </span>6f   jfaewrwergwea.co
0x00431407  6d<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>  m...............
0x00431417 <span class="hljs-number"> 00 </span>f0 5d<span class="hljs-number"> 17 </span>00 ff ff ff ff<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>  ..].............
0x00431427 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>20<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>04<span class="hljs-number"> 00 </span>00   ................
0x00431437 <span class="hljs-number"> 00 </span>01<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x00431447 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x00431457 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>50<span class="hljs-number"> 51 </span>17<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   .....PQ.........
0x00431467 <span class="hljs-number"> 00 </span>13<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>b8<span class="hljs-number"> 43 </span>03<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ......C.........
0x00431477 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x00431487 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x00431497 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x004314a7 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x004314b7 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x004314c7 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
Rule: Ransomware_WannaCry
Owner: Process svchost.exe Pid 1576
0x0040e048  6d<span class="hljs-number"> 73 </span>73<span class="hljs-number"> 65 </span>63<span class="hljs-number"> 73 </span>76<span class="hljs-number"> 63 </span>2e<span class="hljs-number"> 65 </span>78<span class="hljs-number"> 65 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>  mssecsvc.exe....
0x0040e058 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x0040e068 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x0040e078 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x0040e088 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x0040e098 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x0040e0a8 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x0040e0b8 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x0040e0c8 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x0040e0d8 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x0040e0e8 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x0040e0f8 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x0040e108 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x0040e118 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x0040e128 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
0x0040e138 <span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00   ................
Rule: Ransomware_WannaCry
Owner: Process svchost.exe Pid 1576
---SNIP<span class="yaml"><span class="hljs-meta">---</span></span>
</code></pre>
<p>We can see in the results that the <code>yarascan</code> plugin in Volatility is able to find the process <code>svchost.exe</code> with PID <code>1576</code> in the memory image of the compromised system.</p>
<p>In summary, the <code>-U</code> option allows us to directly specify a YARA rule string within the command-line, while the <code>-y</code> option is used to specify the path to a file containing one or more YARA rules. The choice between the two options depends on our specific requirements and whether we have a single rule or a set of rules to apply during the analysis.</p>
<h2 id="hunting-evil-with-yara-web-edition-">Hunting Evil with YARA (Web Edition)</h2>
<p><a href="https://unpac.me/">Unpac.Me</a> is tool tailored for malware unpacking. The great thing about <code>Unpac.Me</code> is that it grants us the capability to run our YARA rules over their amassed database of malware submissions. Considering the hurdles of gaining access to commercialized malware datasets, Unpac.Me emerges as a prime asset for those dedicated SOC analysts and persistent malware enthusiasts.</p>
<h3 id="hunting-for-evil-within-online-datasets-with-yara">Hunting for Evil Within Online Datasets with YARA</h3>
<p>Suppose we want to test out the following YARA rule.</p>
<p>Code: yara</p>
<pre><code class="lang-yara">rule ransomware_dharma {

    meta:
        <span class="hljs-attr">author</span> = <span class="hljs-string">"Madhukar Raina"</span>
        <span class="hljs-attr">version</span> = <span class="hljs-string">"1.0"</span>
        <span class="hljs-attr">description</span> = <span class="hljs-string">"Simple rule to detect strings from Dharma ransomware"</span>
        <span class="hljs-attr">reference</span> = <span class="hljs-string">"https://www.virustotal.com/gui/file/bff6a1000a86f8edf3673d576786ec75b80bed0c458a8ca0bd52d12b74099071/behavior"</span> 

    strings:
        $<span class="hljs-attr">string_pdb</span> = {  <span class="hljs-number">433</span>A5C6372797369735C52656C656173655C5044425C7061796C6F61642E706462 }
    $<span class="hljs-attr">string_ssss</span> = { <span class="hljs-number">73</span> <span class="hljs-number">73</span> <span class="hljs-number">73</span> <span class="hljs-number">73</span> <span class="hljs-number">73</span> <span class="hljs-number">62</span> <span class="hljs-number">73</span> <span class="hljs-number">73</span> <span class="hljs-number">73</span> }

        condition: all of them
}
</code></pre>
<p>So, how do we get started?</p>
<ul>
<li>Register for zero-cost access and hop into the platform.</li>
<li>Head over to <code>Yara Hunt</code> and choose <code>New Hunt</code>. <img src="https://academy.hackthebox.com/storage/modules/234/unpac1.png" alt=""></li>
<li>Enter the YARA rule into the designated rule space. <img src="https://academy.hackthebox.com/storage/modules/234/unpac33.png" alt=""></li>
<li>First hit <code>Validate</code> and then <code>Scan</code>. <img src="https://academy.hackthebox.com/storage/modules/234/unpac44.png" alt=""></li>
<li><p>Scan results get displayed right in front of our eyes. Taking a quick glance at our example, the system hustled through all malware submissions in a couple of minutes, spotting 1 match.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/234/unpac55.png" alt=""></p>
</li>
</ul>
<p>For individuals and organizations with limited resources, Unpac.Me and similar platforms can serve as stepping stones to enhance their malware analysis and detection capabilities, enabling them to make meaningful contributions to the field of cybersecurity.</p>
<h2 id="sigma-and-sigma-rules">Sigma and Sigma Rules</h2>
<p><code>Sigma</code> is a generic signature format used for describing detection rules for log analysis and SIEM systems. It allows SOC analysts to create and share rules that help identify specific patterns or behaviors indicative of security threats or malicious activities. Sigma rules are typically written in YAML format and can be used with various security tools and platforms.</p>
<p>SOC analysts use Sigma rules to define and detect security events by analyzing log data generated by various systems, such as firewalls, intrusion detection systems, and endpoint protection solutions. These rules can be customized to match specific use cases and can include conditions, filters, and other parameters to determine when an event should trigger an alert.</p>
<p>The main advantage of Sigma rules is their portability and compatibility with multiple SIEM and log analysis systems, enabling analysts to write rules once and use them across different platforms.</p>
<p>Sigma can be considered as standardized format for analysts to create and share detection rules. It helps in converting the IOCs into queries and can be easily integrated with security tools, including SIEM and EDRs. Sigma rules can be used to detect suspicious activities in various log sources. This also helps in building efficient processes for Detection as Code by automating the creation and deployment of detection rules.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/234/sigma\_intro.png" alt=""></p>
<p><strong>Usages of Sigma</strong></p>
<ul>
<li><strong><code>Universal Log Analytics Tool</code></strong>: We can write detection rules once and then convert them to various SIEM and log analytics tool formats, sparing us the repetitive task of rewriting logic across different platforms.</li>
<li><strong><code>Community-driven Rule Sharing</code></strong>: With Sigma, we have the ability to tap into a community that regularly contributes and shares their detection rules. This ensures that we constantly update and refine our detection mechanisms.</li>
<li><strong><code>Incident Response</code></strong>: Sigma aids in incident response by enabling analysts to quickly search and analyze logs for specific patterns or indicators.</li>
<li><strong><code>Proactive Threat Hunting</code></strong>: We can use Sigma rules for proactive threat hunting sessions. By leveraging specific patterns, we can comb through our datasets to pinpoint anomalies or signs of adversarial activity.</li>
<li><strong><code>Seamless Integration with Automation Tools</code></strong>: By converting Sigma rules into appropriate formats, we can seamlessly integrate them with our SOAR platforms and other automation tools, enabling automated responses based on specific detections.</li>
<li><strong><code>Customization for Specific Environments</code></strong>: The flexibility of Sigma rules means that we can tailor them according to the unique characteristics of our environment. Custom rules can address the specific threats or scenarios we&#39;re concerned about.</li>
<li><strong><code>Gap Identification</code></strong>: By aligning our rule set with the broader community, we can perform gap analysis, identifying areas where our detection capabilities might need enhancement.</li>
</ul>
<h3 id="how-does-sigma-work-">How Does Sigma Work?</h3>
<p>At its heart, Sigma is about expressing patterns found in log events in a structured manner. So, instead of having a variety of rule descriptions scattered in various proprietary formats, with Sigma, we have a unified, open standard. This unified format becomes the lingua franca for log-based threat detection.</p>
<p>Sigma rules are written in YAML. Each Sigma rule describes a particular pattern of log events which might correlate with malicious activity. The rule encompasses a title, description, log source, and the pattern itself.</p>
<p>But here comes the magic. The true power of Sigma lies in its convertibility. We might ask, &quot;If it&#39;s a standard format, how do we use it with our specific logging tools and platforms?&quot; That&#39;s where the Sigma converter (<code>sigmac</code>) steps in. This converter is the linchpin of our workflow, transforming our Sigma rules into queries or configurations compatible with a multitude of SIEMs, log management solutions, and other security analytics tools.</p>
<p>With <code>sigmac</code>, we can take a rule written in the Sigma format and translate it for ElasticSearch, QRadar, Splunk, and many more, almost instantaneously.</p>
<p><strong>Note</strong>: <a href="https://github.com/SigmaHQ/pySigma">pySigma</a> is increasingly becoming the go-to option for rule translation, as <code>sigmac</code> is now considered obsolete.</p>
<h3 id="sigma-rule-structure">Sigma Rule Structure</h3>
<p>As mentioned already, Sigma rule files are written in YAML format. Below is the structure of a Sigma rule.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/234/sigma\_structure.png" alt=""></p>
<p><strong>Source</strong>: <a href="https://github.com/SigmaHQ/sigma/wiki/Specification">https://github.com/SigmaHQ/sigma/wiki/Specification</a></p>
<p>Let&#39;s understand the structure of a Sigma rule with an example.</p>
<pre><code class="lang-yaml"><span class="hljs-attribute">title</span>: Potential LethalHTA Technique Execution 
<span class="hljs-attribute">id</span>: ed5d72a6-f8f4-<span class="hljs-number">479</span>d-ba79-<span class="hljs-number">02</span>f6a80d7471 
<span class="hljs-attribute">status</span>: test 
<span class="hljs-attribute">description</span>: Detects potential LethalHTA technique where <span class="hljs-string">"mshta.exe"</span> is spawned by an <span class="hljs-string">"svchost.exe"</span> process
<span class="hljs-attribute">references</span>:
    - <span class="hljs-attribute">https</span>:<span class="hljs-comment">//codewhitesec.blogspot.com/2018/07/lethalhta.html</span>
<span class="hljs-attribute">author</span>: Markus Neis 
<span class="hljs-attribute">date</span>: <span class="hljs-number">2018</span>/<span class="hljs-number">06</span>/<span class="hljs-number">07</span> 
<span class="hljs-attribute">tags</span>: 
    - attack.defense_evasion 
    - attack.t1218.<span class="hljs-number">005</span> 
<span class="hljs-attribute">logsource</span>: 
    <span class="hljs-attribute">category</span>: process_creation  
    <span class="hljs-attribute">product</span>: windows
<span class="hljs-attribute">detection</span>:
    <span class="hljs-attribute">selection</span>: 
        ParentImage|<span class="hljs-attribute">endswith</span>: <span class="hljs-string">'\svchost.exe'</span>
        Image|<span class="hljs-attribute">endswith</span>: <span class="hljs-string">'\mshta.exe'</span>
    <span class="hljs-attribute">condition</span>: selection
<span class="hljs-attribute">falsepositives</span>: 
    - Unknown
<span class="hljs-attribute">level</span>: high
</code></pre>
<p>The below screenshot shows the different components that form a Sigma Rule:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/234/sigma\_structure\_example.png" alt=""></p>
<p><strong>Sigma Rule Breakdown</strong> (based on <a href="https://github.com/SigmaHQ/sigma-specification/blob/main/Sigma\_specification.md">Sigma&#39;s specification</a>):</p>
<ul>
<li><code>title</code>: A brief title for the rule that should contain what the rule is supposed to detect (max. 256 characters)</li>
</ul>
<pre><code class="lang-yaml"><span class="hljs-symbol">title:</span> Potential LethalHTA Technique Execution
...
</code></pre>
<ul>
<li><code>id</code>: Sigma rules should be identified by a globally unique identifier in the id attribute. For this purpose <a href="https://www.uuidgenerator.net/version4">randomly generated UUIDs (version 4)</a> are recommended but not mandatory.</li>
</ul>
<pre><code class="lang-yaml"><span class="hljs-symbol">title:</span> Potential LethalHTA Technique Execution
<span class="hljs-symbol">id:</span> ed5d72a6-f8f4<span class="hljs-number">-479</span>d-ba79<span class="hljs-number">-02</span>f6a80d7471
...
</code></pre>
<ul>
<li><code>status</code> (optional): Declares the status of the rule.<ul>
<li><code>stable</code>: The rule didn&#39;t produce any obvious false positives in multiple environments over a long period of time</li>
<li><code>test</code>: The rule doesn&#39;t show any obvious false positives on a limited set of test systems</li>
<li><code>experimental</code>: A new rule that hasn&#39;t been tested outside of lab environments and could lead to many false positives</li>
<li><code>deprecated</code>: The rule is to replace or cover another one. The link between rules is made via the related field.</li>
<li><code>unsupported</code>: The rule can not be used in its current state (special correlation log, home-made fields, etc.)</li>
</ul>
</li>
</ul>
<pre><code class="lang-yaml"><span class="hljs-symbol">title:</span> Potential LethalHTA Technique Execution
<span class="hljs-symbol">id:</span> ed5d72a6-f8f4<span class="hljs-number">-479</span>d-ba79<span class="hljs-number">-02</span>f6a80d7471
<span class="hljs-symbol">status:</span> test
...
</code></pre>
<ul>
<li><code>description</code> (optional): A short description of the rule and the malicious activity that can be detected (max. 65,535 characters)</li>
</ul>
<pre><code class="lang-yaml">title: Potential LethalHTA Technique Execution
<span class="hljs-built_in">id</span>: ed5d72a6-f8f4<span class="hljs-number">-479</span>d-ba79<span class="hljs-number">-02</span>f6a80d7471
status: test
description: Detects potential LethalHTA technique <span class="hljs-keyword">where</span> <span class="hljs-string">"mshta.exe"</span> <span class="hljs-keyword">is</span> spawned <span class="hljs-keyword">by</span> an <span class="hljs-string">"svchost.exe"</span> process
...
</code></pre>
<ul>
<li><code>references</code> (optional): Citations to the original source from which the rule was inspired. These might include blog posts, academic articles, presentations, or even tweets.</li>
</ul>
<pre><code class="lang-yaml"><span class="hljs-string">title:</span> Potential LethalHTA Technique Execution
<span class="hljs-string">id:</span> ed5d72a6-f8f4<span class="hljs-number">-479</span>d-ba79<span class="hljs-number">-02</span>f6a80d7471
<span class="hljs-string">status:</span> test
<span class="hljs-string">description:</span> Detects potential LethalHTA technique where <span class="hljs-string">"mshta.exe"</span> is spawned by an <span class="hljs-string">"svchost.exe"</span> process
<span class="hljs-string">references:</span>
    - <span class="hljs-string">https:</span><span class="hljs-comment">//codewhitesec.blogspot.com/2018/07/lethalhta.html</span>
...
</code></pre>
<ul>
<li><code>author</code> (optional): Creator of the rule (can be a name, nickname, twitter handle, etc).</li>
</ul>
<pre><code class="lang-yaml"><span class="hljs-string">title:</span> Potential LethalHTA Technique Execution
<span class="hljs-string">id:</span> ed5d72a6-f8f4<span class="hljs-number">-479</span>d-ba79<span class="hljs-number">-02</span>f6a80d7471
<span class="hljs-string">status:</span> test
<span class="hljs-string">description:</span> Detects potential LethalHTA technique where <span class="hljs-string">"mshta.exe"</span> is spawned by an <span class="hljs-string">"svchost.exe"</span> process
<span class="hljs-string">references:</span>
    - <span class="hljs-string">https:</span><span class="hljs-comment">//codewhitesec.blogspot.com/2018/07/lethalhta.html</span>
<span class="hljs-string">author:</span> Markus Neis
...
</code></pre>
<ul>
<li><code>date</code> (optional): Rule creation date. Use the format <code>YYYY/MM/DD</code>.</li>
</ul>
<pre><code class="lang-yaml"><span class="hljs-string">title:</span> Potential LethalHTA Technique Execution
<span class="hljs-string">id:</span> ed5d72a6-f8f4<span class="hljs-number">-479</span>d-ba79<span class="hljs-number">-02</span>f6a80d7471
<span class="hljs-string">status:</span> test
<span class="hljs-string">description:</span> Detects potential LethalHTA technique where <span class="hljs-string">"mshta.exe"</span> is spawned by an <span class="hljs-string">"svchost.exe"</span> process
<span class="hljs-string">references:</span>
    - <span class="hljs-string">https:</span><span class="hljs-comment">//codewhitesec.blogspot.com/2018/07/lethalhta.html</span>
<span class="hljs-string">author:</span> Markus Neis
<span class="hljs-string">date:</span> <span class="hljs-number">2018</span><span class="hljs-regexp">/06/</span><span class="hljs-number">07</span>
...
</code></pre>
<ul>
<li><p><code>logsource</code>: This section describes the log data on which the detection is meant to be applied to. It describes the log source, the platform, the application and the type that is required in the detection. More information can be found in the following link: <a href="https://github.com/SigmaHQ/sigma/tree/master/documentation/logsource-guides">https://github.com/SigmaHQ/sigma/tree/master/documentation/logsource-guides</a></p>
<p>It consists of three attributes that are evaluated automatically by the converters and an arbitrary number of optional elements. We recommend using a &quot;definition&quot; value when further explanation is necessary.</p>
<ul>
<li><code>category</code>: The <code>category</code> value is used to select all log files written by a certain group of products, like firewalls or web server logs. The automatic converter will use the keyword as a selector for multiple indices. Examples: <code>firewall</code>, <code>web</code>, <code>antivirus</code>, etc.</li>
<li><code>product</code>: The <code>product</code> value is used to select all log outputs of a certain product, e.g. all Windows event log types including <code>Security</code>, <code>System</code>, <code>Application</code> and newer types like <code>AppLocker</code> and <code>Windows Defender</code>. Examples: <code>windows</code>, <code>apache</code>, <code>check point fw1</code>, etc.</li>
<li><code>service</code>: The <code>service</code> value is used to select only a subset of a product&#39;s logs, like the <code>sshd</code> on Linux or the <code>Security</code> event log on Windows systems. Examples: <code>sshd</code>, <code>applocker</code>, etc.</li>
</ul>
</li>
</ul>
<pre><code class="lang-yaml"><span class="hljs-attribute">title</span>: Potential LethalHTA Technique Execution
<span class="hljs-attribute">id</span>: ed5d72a6-f8f4-<span class="hljs-number">479</span>d-ba79-<span class="hljs-number">02</span>f6a80d7471
<span class="hljs-attribute">status</span>: test
<span class="hljs-attribute">description</span>: Detects potential LethalHTA technique where <span class="hljs-string">"mshta.exe"</span> is spawned by an <span class="hljs-string">"svchost.exe"</span> process
<span class="hljs-attribute">references</span>:
    - <span class="hljs-attribute">https</span>:<span class="hljs-comment">//codewhitesec.blogspot.com/2018/07/lethalhta.html</span>
<span class="hljs-attribute">author</span>: Markus Neis
<span class="hljs-attribute">date</span>: <span class="hljs-number">2018</span>/<span class="hljs-number">06</span>/<span class="hljs-number">07</span>
<span class="hljs-attribute">logsource</span>:
    <span class="hljs-attribute">category</span>: process_creation
    <span class="hljs-attribute">product</span>: windows
...
</code></pre>
<ul>
<li><p><code>detection</code>: A set of search-identifiers that represent properties of searches on log data. Detection is made up of two components:</p>
<ul>
<li>Search Identifiers</li>
<li>Condition</li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/234/001.jpg" alt=""></p>
<p><strong>Source</strong>: <a href="https://docs.blusapphire.io/sigma-rules/sigma-detection-attributes">blusapphire.io</a></p>
</li>
</ul>
<pre><code class="lang-yaml"><span class="hljs-attribute">title</span>: Potential LethalHTA Technique Execution
<span class="hljs-attribute">id</span>: ed5d72a6-f8f4-<span class="hljs-number">479</span>d-ba79-<span class="hljs-number">02</span>f6a80d7471
<span class="hljs-attribute">status</span>: test
<span class="hljs-attribute">description</span>: Detects potential LethalHTA technique where <span class="hljs-string">"mshta.exe"</span> is spawned by an <span class="hljs-string">"svchost.exe"</span> process
<span class="hljs-attribute">references</span>:
    - <span class="hljs-attribute">https</span>:<span class="hljs-comment">//codewhitesec.blogspot.com/2018/07/lethalhta.html</span>
<span class="hljs-attribute">author</span>: Markus Neis
<span class="hljs-attribute">date</span>: <span class="hljs-number">2018</span>/<span class="hljs-number">06</span>/<span class="hljs-number">07</span>
<span class="hljs-attribute">logsource</span>:
    <span class="hljs-attribute">category</span>: process_creation
    <span class="hljs-attribute">product</span>: windows
<span class="hljs-attribute">detection</span>:
    <span class="hljs-attribute">selection</span>:
        ParentImage|<span class="hljs-attribute">endswith</span>: <span class="hljs-string">'\svchost.exe'</span>
        Image|<span class="hljs-attribute">endswith</span>: <span class="hljs-string">'\mshta.exe'</span>
    <span class="hljs-attribute">condition</span>: selection
...
</code></pre>
<hr>
<p>The values contained in Sigma rules can be modified by value modifiers. Value modifiers are appended after the field name with a pipe character (<code>|</code>) as separator and can also be chained, e.g. <code>fieldname|mod1|mod2: value</code>. The value modifiers are applied in the given order to the value.</p>
<p>The behavior of search identifiers is changed by value modifiers as shown in the table below :</p>
<table>
<thead>
<tr>
<th>Value Modifier</th>
<th>Explanation</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>contains</td>
<td>Adds wildcard (<code>*</code>) characters around the value(s)</td>
<td>CommandLine\</td>
<td>contains</td>
</tr>
<tr>
<td>all</td>
<td>Links all elements of a list with a logical &quot;AND&quot; (instead of the default &quot;OR&quot;)</td>
<td>CommandLine\</td>
<td>contains\</td>
<td>all</td>
</tr>
<tr>
<td>startswith</td>
<td>Adds a wildcard (<code>*</code>) character at the end of the field value</td>
<td>ParentImage\</td>
<td>startswith</td>
</tr>
<tr>
<td>endswith</td>
<td>Adds a wildcard (<code>*</code>) character at the begining of the field value</td>
<td>Image\</td>
<td>endswith</td>
</tr>
<tr>
<td>re:</td>
<td>This value is handled as regular expression by backends</td>
<td>CommandLine\</td>
<td>re: &#39;\[String\]\s*\$VerbosePreference</td>
</tr>
</tbody>
</table>
<p><strong>Source</strong>: <a href="https://docs.blusapphire.io/sigma-rules/sigma-detection-attributes">blusapphire.io</a></p>
<p>Search identifiers include multiple values in two different data structures:</p>
<ol>
<li><p><code>Lists</code>, which can contain:</p>
<ul>
<li><code>strings</code> that are applied to the full log message and are linked with a logical <code>OR</code>.</li>
<li><code>maps</code> (see below). All map items of a list are linked with a logical <code>OR</code>.</li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/234/002.jpg" alt=""></p>
<p><strong>Source</strong>: <a href="https://docs.blusapphire.io/sigma-rules/sigma-detection-attributes">blusapphire.io</a></p>
</li>
</ol>
<p>Example list of strings that matches on <code>evilservice</code> or <code>svchost.exe -n evil</code>.</p>
<pre><code class="lang-yaml">detection:
     keywords:
        -<span class="ruby"> evilservice
</span>         -<span class="ruby"> svchost.exe -n evil</span>
</code></pre>
<p>Example list of maps that matches on image file <code>example.exe</code> or on a executable whose description contains the string <code>Test executable</code>.</p>
<pre><code class="lang-yaml"><span class="hljs-attribute">detection</span>:
    <span class="hljs-attribute">selection</span>:
         - Image|<span class="hljs-attribute">endswith</span>: <span class="hljs-string">'\example.exe'</span>
        - Description|<span class="hljs-attribute">contains</span>: <span class="hljs-string">'Test executable'</span>
</code></pre>
<ol>
<li><code>Maps</code>: Maps (or dictionaries) consist of key/value pairs, in which the key is a field in the log data and the value a string or integer value. All elements of a map are joined with a logical <code>AND</code>.</li>
</ol>
<p>Example that matches on event log <code>Security</code> and (<code>Event ID 517</code> or <code>Event ID 1102</code>)</p>
<pre><code class="lang-yaml"><span class="hljs-symbol">detection:</span>
<span class="hljs-symbol">    selection:</span>
<span class="hljs-symbol">          EventLog:</span> Security
<span class="hljs-symbol">          EventID:</span>
            - <span class="hljs-number">517</span>
           - <span class="hljs-number">1102</span>
<span class="hljs-symbol">    condition:</span> selection
</code></pre>
<p>Example that matches on event log <code>Security</code> and <code>Event ID 4679</code> and <code>TicketOptions 0x40810000</code> and <code>TicketEncryption 0x17</code>.</p>
<pre><code class="lang-yaml"><span class="hljs-attribute">detection</span>:
    <span class="hljs-attribute">selection</span>:
        <span class="hljs-attribute">EventLog</span>: Security
        <span class="hljs-attribute">EventID</span>: <span class="hljs-number">4769</span>
        <span class="hljs-attribute">TicketOptions</span>: <span class="hljs-string">'0x40810000'</span>
        <span class="hljs-attribute">TicketEncryption</span>: <span class="hljs-string">'0x17'</span>
    <span class="hljs-attribute">condition</span>: selection
</code></pre>
<ul>
<li><code>Condition</code>: Condition defines how fields are related to each other. If there&#39;s anything to filter, it can be defined in the condition. It uses various operators to define relationships for multiple fields which are explained below.</li>
</ul>
<table>
<thead>
<tr>
<th>Operator</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>Logical AND/OR</td>
<td><code>keywords1 or keywords2</code></td>
</tr>
<tr>
<td>1/all of them</td>
<td><code>all of them</code></td>
</tr>
<tr>
<td>1/all of search-identifier-pattern</td>
<td><code>all of selection*</code></td>
</tr>
<tr>
<td>1/all of search-id-pattern</td>
<td><code>all of filter_*</code></td>
</tr>
<tr>
<td>Negation with &#39;not&#39;</td>
<td><code>keywords and not filters</code></td>
</tr>
<tr>
<td>Brackets - Order of operation &#39;()&#39;</td>
<td><code>selection1 and (keywords1 or keywords2)</code></td>
</tr>
</tbody>
</table>
<p><strong>Source</strong>: <a href="https://docs.blusapphire.io/sigma-rules/sigma-detection-attributes">blusapphire.io</a></p>
<p>Example of a condition:</p>
<pre><code class="lang-yaml"><span class="hljs-symbol">condition:</span> selection1 <span class="hljs-keyword">or</span> selection2 <span class="hljs-keyword">or</span> selection3
</code></pre>
<hr>
<h3 id="sigma-rule-development-best-practices">Sigma Rule Development Best Practices</h3>
<p><a href="https://github.com/SigmaHQ/sigma-specification/blob/version\_2/Sigma\_specification.md">Sigma&#39;s specification repository</a> contains everything you may need around Sigma rules.</p>
<p>Sigma rule development best practices and common pitfalls can be found on <a href="https://github.com/SigmaHQ/sigma/wiki/Rule-Creation-Guide">Sigma&#39;s Rule Creation Guide</a>.</p>
<h2 id="developing-sigma-rules">Developing Sigma Rules</h2>
<p>In this section, we&#39;ll cover manual Sigma rule development.</p>
<p>Let&#39;s now navigate to the bottom of this section and click on &quot;Click here to spawn the target system!&quot;. Then, let&#39;s RDP into the Target IP using the provided credentials. The vast majority of the actions/commands covered from this point up to end of this section can be replicated inside the target, offering a more comprehensive grasp of the topics presented.</p>
<h3 id="manually-developing-a-sigma-rule">Manually Developing a Sigma Rule</h3>
<p><strong>Example 1: LSASS Credential Dumping</strong></p>
<p>Let&#39;s dive into the world of Sigma rules using a sample named <code>shell.exe</code> (a renamed version of <a href="https://en.wikipedia.org/wiki/Mimikatz">mimikatz</a>) residing in the <code>C:\Samples\YARASigma</code> directory of this section&#39;s target as an illustration. We want to understand the process behind crafting a Sigma rule, so let&#39;s get our hands dirty.</p>
<p>After executing <code>shell.exe</code> as follows, we collected the most critical events and saved them as <code>lab_events.evtx</code> inside the <code>C:\Events\YARASigma</code> directory of this section&#39;s target.</p>
<p>The process created by <code>shell.exe</code> (mimikatz) will try to access the process memory of <code>lsass.exe</code>. The system monitoring tool <a href="https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon">Sysmon</a> was running in the background and captured this activity in the event logs (Event ID <a href="https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon#event-id-10-processaccess">10</a>).</p>
<p>Developing Sigma Rules</p>
<pre><code class="lang-shell-session">C:\Samples\YARASigma&gt;shell.exe

  .#####.   mimikatz <span class="hljs-number">2.2</span>.<span class="hljs-number">0</span> (x64) #<span class="hljs-number">19041</span> Sep <span class="hljs-number">19</span> <span class="hljs-number">2022</span> <span class="hljs-number">17</span>:<span class="hljs-number">44</span>:<span class="hljs-number">08</span>
 .## ^ ##.  <span class="hljs-string">"A La Vie, A L'Amour"</span> - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        &gt; https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # privilege::debug
Privilege '<span class="hljs-number">20</span>' OK

mimikatz # sekurlsa::logonpasswords
<span class="hljs-comment">---SNIP---</span>
Authentication Id : 0 ; <span class="hljs-number">100080</span> (<span class="hljs-number">00000000</span>:<span class="hljs-number">000186</span>f0)
Session           : <span class="hljs-type">Interactive</span> from <span class="hljs-number">1</span>
User Name         : <span class="hljs-type">htb</span>-student
Domain            : <span class="hljs-type">DESKTOP</span>-VJF8GH8
Logon Server      : <span class="hljs-type">DESKTOP</span>-VJF8GH8
Logon Time        : 8/25/2023 2:17:20 <span class="hljs-type">PM</span>
SID               : <span class="hljs-type">S</span>-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">1412399592</span>-<span class="hljs-number">1502967738</span>-<span class="hljs-number">1150298762</span>-<span class="hljs-number">1001</span>
        msv :
         [00000003] <span class="hljs-type">Primary</span>
         * Username : <span class="hljs-type">htb</span>-student
         * Domain   : .
         * NTLM     : 3<span class="hljs-type">c0e5d303ec84884ad5c3b7876a06ea6</span>
         * SHA1     : <span class="hljs-type">b2978f9abc2f356e45cb66ec39510b1ccca08a0e</span>
        tspkg :
        <span class="hljs-type">wdigest</span> :
         * <span class="hljs-type">Username</span> : <span class="hljs-type">htb</span>-student
         * Domain   : <span class="hljs-type">DESKTOP</span>-VJF8GH8
         * Password : (<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)
        kerberos :
         * <span class="hljs-type">Username</span> : <span class="hljs-type">htb</span>-student
         * Domain   : <span class="hljs-type">DESKTOP</span>-VJF8GH8
         * Password : (<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)
        ssp :
        <span class="hljs-type">credman</span> :
        <span class="hljs-type">cloudap</span> :

<span class="hljs-type">Authentication</span> Id : 0 ; <span class="hljs-number">100004</span> (<span class="hljs-number">00000000</span>:<span class="hljs-number">000186</span>a4)
Session           : <span class="hljs-type">Interactive</span> from <span class="hljs-number">1</span>
User Name         : <span class="hljs-type">htb</span>-student
Domain            : <span class="hljs-type">DESKTOP</span>-VJF8GH8
Logon Server      : <span class="hljs-type">DESKTOP</span>-VJF8GH8
Logon Time        : 8/25/2023 2:17:20 <span class="hljs-type">PM</span>
SID               : <span class="hljs-type">S</span>-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">1412399592</span>-<span class="hljs-number">1502967738</span>-<span class="hljs-number">1150298762</span>-<span class="hljs-number">1001</span>
        msv :
         [00000003] <span class="hljs-type">Primary</span>
         * Username : <span class="hljs-type">htb</span>-student
         * Domain   : .
         * NTLM     : 3<span class="hljs-type">c0e5d303ec84884ad5c3b7876a06ea6</span>
         * SHA1     : <span class="hljs-type">b2978f9abc2f356e45cb66ec39510b1ccca08a0e</span>
        tspkg :
        <span class="hljs-type">wdigest</span> :
         * <span class="hljs-type">Username</span> : <span class="hljs-type">htb</span>-student
         * Domain   : <span class="hljs-type">DESKTOP</span>-VJF8GH8
         * Password : (<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)
        kerberos :
         * <span class="hljs-type">Username</span> : <span class="hljs-type">htb</span>-student
         * Domain   : <span class="hljs-type">DESKTOP</span>-VJF8GH8
         * Password : <span class="hljs-type">HTB</span>_@cademy_stdnt!
        ssp :
        <span class="hljs-type">credman</span> :
        <span class="hljs-type">cloudap</span> :
---<span class="hljs-type">SNIP</span><span class="hljs-comment">---</span>
</code></pre>
<p>First off, Sysmon <code>Event ID 10</code> is triggered when a process accesses another process, and it logs the permission flags in the <code>GrantedAccess</code> field. This event log contains two important fields, <code>TargetImage</code> and <code>GrantedAccess</code>. In a typical LSASS memory dumping scenario, the malicious process needs specific permissions to access the memory space of the LSASS process. These permissions are often read/write access, among other things.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/234/sigma\_evt\_log.png" alt=""></p>
<p>Now, why is <code>0x1010</code> crucial here? This hexadecimal flag essentially combines <code>PROCESS_VM_READ (0x0010)</code> and <code>PROCESS_QUERY_INFORMATION (0x0400)</code> permissions. To translate that: the process is asking for read access to the virtual memory of LSASS and the ability to query certain information from the process. While <code>0x0410</code> is the most common GrantedAccess flag used for reading LSASS memory, <code>0x1010</code> implies both reading and querying information from the process and is also frequently observed during credential dumping attacks.</p>
<p>So how can we weaponize this information for detection? Well, in our security monitoring stack, we would configure Sysmon to flag or alert on any <code>Event ID 10</code> where the <code>TargetImage</code> is <code>lsass.exe</code> and <code>GrantedAccess</code> is set to <code>0x1010</code>.</p>
<p>A Sigma rule that checks for the abovementioned conditions can be found below.</p>
<p>Code: yaml</p>
<pre><code class="lang-yaml"><span class="hljs-attribute">title</span>: LSASS Access with rare GrantedAccess flag 
<span class="hljs-attribute">status</span>: experimental
<span class="hljs-attribute">description</span>: This rule will detect when a process tries to access LSASS memory with suspicious access flag <span class="hljs-number">0</span>x1010
<span class="hljs-attribute">date</span>: <span class="hljs-number">2023</span>/<span class="hljs-number">07</span>/<span class="hljs-number">08</span>
<span class="hljs-attribute">tags</span>:
    - attack.credential_access
    - attack.t1003.<span class="hljs-number">001</span>
<span class="hljs-attribute">logsource</span>:
    <span class="hljs-attribute">category</span>: process_access
    <span class="hljs-attribute">product</span>: windows
<span class="hljs-attribute">detection</span>:
    <span class="hljs-attribute">selection</span>:
        TargetImage|<span class="hljs-attribute">endswith</span>: <span class="hljs-string">'\lsass.exe'</span>
        GrantedAccess|<span class="hljs-attribute">endswith</span>: <span class="hljs-string">'0x1010'</span>
    <span class="hljs-attribute">condition</span>: selection
</code></pre>
<p><strong>Sigma Rule Breakdown</strong></p>
<ul>
<li><code>title</code>: This title offers a concise overview of the rule&#39;s objective, specifically aimed at detecting interactions with LSASS memory involving a particular access flag.</li>
</ul>
<p>Code: yaml</p>
<pre><code class="lang-yaml">title: LSASS <span class="hljs-keyword">Access</span> <span class="hljs-keyword">with</span> rare GrantedAccess flag
</code></pre>
<ul>
<li><code>status</code>: This field signals that the rule is in the testing phase, suggesting that additional fine-tuning or validation may be necessary.</li>
</ul>
<p>Code: yaml</p>
<pre><code class="lang-yaml"><span class="hljs-symbol">status:</span> experimental
</code></pre>
<ul>
<li><code>description</code>: Rule description.</li>
</ul>
<p>Code: yaml</p>
<pre><code class="lang-yaml">description: This rule will detect <span class="hljs-keyword">when</span> a <span class="hljs-keyword">process</span> tries <span class="hljs-keyword">to</span> <span class="hljs-keyword">access</span> LSASS memory <span class="hljs-keyword">with</span> suspicious <span class="hljs-keyword">access</span> flag <span class="hljs-number">0</span>x1010
</code></pre>
<ul>
<li><code>date</code>: This field marks the date when the rule was either updated or originally created.</li>
</ul>
<p>Code: yaml</p>
<pre><code class="lang-yaml"><span class="hljs-string">date:</span> <span class="hljs-number">2023</span><span class="hljs-regexp">/07/</span><span class="hljs-number">08</span>
</code></pre>
<ul>
<li><code>tags</code>: The rule is tagged with <code>attack.credential_access</code> and <code>attack.t1003.001</code>. These tags help categorize the rule based on known attack techniques or tactics related to credential access.</li>
</ul>
<p>Code: yaml</p>
<pre><code class="lang-yaml"><span class="hljs-keyword">tags:</span>
    - attack.credential_access
    - attack.t1003.001`
</code></pre>
<ul>
<li><code>logsource</code>: The logsource specifies the log source that the rule is intended to analyze. It contains <code>category</code> as <code>process_access</code> which indicates that the rule focuses on log events related to process access (<code>Sysmon Event ID 10</code>, if we use Sigma&#39;s default config files). Also, <code>product: windows</code> specifies that the rule is specifically designed for Windows operating systems.</li>
</ul>
<p>Code: yaml</p>
<pre><code class="lang-yaml"><span class="hljs-symbol">logsource:</span>
<span class="hljs-symbol">    category:</span> process_access
<span class="hljs-symbol">    product:</span> windows
</code></pre>
<ul>
<li><code>detection</code>: The detection section defines the conditions that must be met for the rule to trigger an alert. The selection part specifies the criteria for selecting relevant log events where the <code>TargetImage</code> field ends with <code>\lsass.exe</code> and <code>GrantedAccess</code> field ends with the hexadecimal value <code>0x1010</code>. The <code>GrantedAccess</code> field represents the access rights or permissions associated with the process. In this case, it targets events with a specific access flag of <code>0x1010</code>. Finally, the condition part specifies that the selection criteria must be met for the rule to trigger an alert. In this case, both the <code>TargetImage</code> and <code>GrantedAccess</code> criteria must be met.</li>
</ul>
<p>Code: yaml</p>
<pre><code class="lang-yaml"><span class="hljs-attribute">detection</span>:
    <span class="hljs-attribute">selection</span>:
        TargetImage|<span class="hljs-attribute">endswith</span>: <span class="hljs-string">'\lsass.exe'</span>
        GrantedAccess|<span class="hljs-attribute">endswith</span>: <span class="hljs-string">'0x1010'</span>
    <span class="hljs-attribute">condition</span>: selection
</code></pre>
<hr>
<p>Οur first Sigma rule above can be found inside the <code>C:\Rules\sigma</code> directory of this section&#39;s target as <code>proc_access_win_lsass_access.yml</code>. Let&#39;s explore the <code>sigmac</code> tool that can help us transform this rule into queries or configurations compatible with a multitude of SIEMs, log management solutions, and other security analytics tools.</p>
<p>The <code>sigmac</code> tool can be found inside the <code>C:\Tools\sigma-0.21\tools</code> directory of this section&#39;s target.</p>
<p>Suppose that we wanted to convert our Sigma rule into a PowerShell (<code>Get-WinEvent</code>) query. This could have been accomplished with the help of <code>sigmac</code> as follows.</p>
<p>Developing Sigma Rules</p>
<pre><code class="lang-powershell-session">PS C:\Tools\sigma-0.21\tools&gt; python sigmac -t powershell <span class="hljs-string">'C:\Rules\sigma\proc_access_win_lsass_access.yml'</span>
Get-WinEvent | <span class="hljs-keyword">where</span> {(<span class="hljs-variable">$_</span>.ID -eq <span class="hljs-string">"10"</span> -<span class="hljs-keyword">and</span> <span class="hljs-variable">$_</span>.<span class="hljs-literal">message</span> -match <span class="hljs-string">"TargetImage.*.*\\lsass.exe"</span> -<span class="hljs-keyword">and</span> <span class="hljs-variable">$_</span>.<span class="hljs-literal">message</span> -match <span class="hljs-string">"GrantedAccess.*.*0x1010"</span>) } | select TimeCreated,Id,RecordId,ProcessId,MachineName,Message
</code></pre>
<p>Let&#39;s adjust the Get-WinEvent query above by specifying the .evtx file that is related to LSASS access by another process (<code>lab_events.evtx</code> inside the <code>C:\Events\YARASigma</code> directory of this section&#39;s target) and see if it will identify the Sysmon event (<code>ID 10</code>) that we analyzed at the beginning of this section.</p>
<p><strong>Note</strong>: Please open a PowerShell terminal as administrator to run the query.</p>
<p>Developing Sigma Rules</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\T</span>ools<span class="hljs-symbol">\s</span>igma-0.21<span class="hljs-symbol">\t</span>ools&gt; Get-WinEvent -Path C:<span class="hljs-symbol">\E</span>vents<span class="hljs-symbol">\Y</span>ARASigma<span class="hljs-symbol">\l</span>ab_events.evtx | where {($_.ID -eq "10" -and $_.message -match "TargetImage.*.*<span class="hljs-symbol">\\</span>lsass.exe" -and $_.message -match "GrantedAccess.*.*0x1010") } | select TimeCreated,Id,RecordId,ProcessId,MachineName,Message


TimeCreated : 7/9/2023 7:44:14 AM
Id          : 10
RecordId    : 7810
ProcessId   : 3324
MachineName : RDSEMVM01
Message     : Process accessed:
              RuleName:
              UtcTime: 2023-07-09 14:44:14.260
              SourceProcessGUID: {e7bf76b7-c7ba-64aa-0000-0010e8e9a602}
              SourceProcessId: 1884
              SourceThreadId: 7872
              SourceImage: C:<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\s</span>amples<span class="hljs-symbol">\s</span>hell.exe
              TargetProcessGUID: {e7bf76b7-d7ec-6496-0000-001027d60000}
              TargetProcessId: 668
              TargetImage: C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\l</span>sass.exe
              GrantedAccess: 0x1010
              CallTrace: C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\S</span>YSTEM32<span class="hljs-symbol">\n</span>tdll.dll+9d4c4|C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\S</span>ystem32<span class="hljs-symbol">\K</span>ERNELBASE.dll+2c13e|C:<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\s</span>amples<span class="hljs-symbol">\s</span>h
              ell.exe+c291e|C:<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\s</span>amples<span class="hljs-symbol">\s</span>hell.exe+c2cf5|C:<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\s</span>amples<span class="hljs-symbol">\s</span>hell.exe+c285d|C:<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\s</span>amples<span class="hljs-symbol">\s</span>hell.exe+85a4
              4|C:<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\s</span>amples<span class="hljs-symbol">\s</span>hell.exe+8587c|C:<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\s</span>amples<span class="hljs-symbol">\s</span>hell.exe+85647|C:<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\s</span>amples<span class="hljs-symbol">\s</span>hell.exe+c97a5|C:<span class="hljs-symbol">\W</span>indows
              <span class="hljs-symbol">\S</span>ystem32<span class="hljs-symbol">\K</span>ERNEL32.DLL+17034|C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\S</span>YSTEM32<span class="hljs-symbol">\n</span>tdll.dll+526a1
              SourceUser: <span class="hljs-variable">%12
              TargetUser: %</span>13
</code></pre>
<p>The related Sysmon event with ID 10 is successfully identified!</p>
<hr>
<p>But let&#39;s not stop there - remember, false positives are the enemy of effective security monitoring.</p>
<ul>
<li>We should also cross-reference the <code>SourceImage</code> (the process initiating the access) against a list of known, safe processes that commonly interact with LSASS.</li>
<li>If we see an unfamiliar or unusual process trying to read LSASS with a <code>GrantedAccess</code> that ends with <code>10</code>, <code>30</code>, <code>50</code>, <code>70</code>, <code>90</code>, <code>B0</code>, <code>D0</code>, <code>F0</code>, <code>18</code>, <code>38</code>, <code>58</code>, <code>78</code>, <code>98</code>, <code>B8</code>, <code>D8</code>, <code>F8</code>, <code>1A</code>, <code>3A</code>, <code>5A</code>, <code>7A</code>, <code>9A</code>, <code>BA</code>, <code>DA</code>, <code>FA</code>, <code>0x14C2</code>, and <code>FF</code> (these suffixes come from studying the <code>GrantedAccess</code> values that various LSASS credential dumping techniques require), that&#39;s a red flag, and our incident response protocol should kick in.</li>
<li>Especially, if the <code>SourceImage</code> resides in suspicious paths containing, <code>\Temp\</code>, <code>\Users\Public\</code>, <code>\PerfLogs\</code>, <code>\AppData\</code>, <code>\htb\</code> etc. that&#39;s another red flag, and our incident response protocol should kick in.</li>
</ul>
<p>A more robust version of the Sigma rule we created taking the above points into consideration can be found inside the <code>C:\Rules\sigma</code> directory of this section&#39;s target as <code>proc_access_win_lsass_access_robust.yml</code></p>
<p>Code: yaml</p>
<pre><code class="lang-yaml">title: LSASS Access From Program in Potentially Suspicious Folder
id: fa34b441-961a-42fa-a100-ecc28c886725
status: experimental
description: Detects process access to LSASS memory with suspicious access flags and from a potentially suspicious folder
references:
    -<span class="ruby"> <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/docs.microsoft.com/en</span>-us/windows/win32/procthread/process-security-<span class="hljs-keyword">and</span>-access-rights
</span>    -<span class="ruby"> <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/onedrive.live.com/view</span>.aspx?resid=D026B4699190F1E6!<span class="hljs-number">2843</span>&amp;ithint=file%<span class="hljs-number">2</span>cpptx&amp;app=PowerPoint&amp;authkey=!AMvCRTKB_V1J5ow
</span>    -<span class="ruby"> <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/web.archive.org/web</span><span class="hljs-regexp">/20230208123920/https</span><span class="hljs-symbol">://cyberwardog</span>.blogspot.com/<span class="hljs-number">2017</span>/<span class="hljs-number">03</span>/chronicles-of-threat-hunter-hunting-for_22.html
</span>    -<span class="ruby"> <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/www.slideshare.net/heirhabarov</span><span class="hljs-regexp">/hunting-for-credentials-dumping-in-windows-environment
</span></span>    -<span class="ruby"><span class="hljs-regexp"> http:/</span><span class="hljs-regexp">/security-research.dyndns.org/pub</span><span class="hljs-regexp">/slides/</span>FIRST2017/FIRST-<span class="hljs-number">2017_</span>Tom-Ueltschi_Sysmon_FINAL_notes.pdf
</span>author: Florian Roth (Nextron Systems)
date: 2021/11/27
modified: 2023/05/05
tags:
    -<span class="ruby"> attack.credential_access
</span>    -<span class="ruby"> attack.t1003.<span class="hljs-number">001</span>
</span>    -<span class="ruby"> attack.s0002
</span>logsource:
    category: process_access
    product: windows
detection:
    selection:
        TargetImage|endswith: '\lsass.exe'
        GrantedAccess|endswith:
            -<span class="ruby"> <span class="hljs-string">'10'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'30'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'50'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'70'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'90'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'B0'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'D0'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'F0'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'18'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'38'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'58'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'78'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'98'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'B8'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'D8'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'F8'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'1A'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'3A'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'5A'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'7A'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'9A'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'BA'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'DA'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'FA'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'0x14C2'</span>  <span class="hljs-comment"># https://github.com/b4rtik/ATPMiniDump/blob/76304f93b390af3bb66e4f451ca16562a479bdc9/ATPMiniDump/ATPMiniDump.c</span>
</span>            -<span class="ruby"> <span class="hljs-string">'FF'</span>
</span>        SourceImage|contains:
            -<span class="ruby"> <span class="hljs-string">'\Temp\'
</span></span>            -<span class="ruby"><span class="hljs-string"> '</span>\Users\Public\<span class="hljs-string">'
</span></span>            -<span class="ruby"><span class="hljs-string"> '</span>\PerfLogs\<span class="hljs-string">'
</span></span>            -<span class="ruby"><span class="hljs-string"> '</span>\AppData\<span class="hljs-string">'
</span></span>            -<span class="ruby"><span class="hljs-string"> '</span>\htb\<span class="hljs-string">'
</span></span>    filter_optional_generic_appdata:
        SourceImage|startswith: 'C:\Users\'
        SourceImage|contains: '\AppData\Local\'
        SourceImage|endswith:
            -<span class="ruby"><span class="hljs-string"> '</span>\Microsoft VS Code\Code.exe<span class="hljs-string">'
</span></span>            -<span class="ruby"><span class="hljs-string"> '</span>\software_reporter_tool.exe<span class="hljs-string">'
</span></span>            -<span class="ruby"><span class="hljs-string"> '</span>\DropboxUpdate.exe<span class="hljs-string">'
</span></span>            -<span class="ruby"><span class="hljs-string"> '</span>\MBAMInstallerService.exe<span class="hljs-string">'
</span></span>            -<span class="ruby"><span class="hljs-string"> '</span>\WebexMTA.exe<span class="hljs-string">'
</span></span>            -<span class="ruby"><span class="hljs-string"> '</span>\WebEx\WebexHost.exe<span class="hljs-string">'
</span></span>            -<span class="ruby"><span class="hljs-string"> '</span>\JetBrains\Toolbox\bin\jetbrains-toolbox.exe<span class="hljs-string">'
</span></span>        GrantedAccess: '0x410'
    filter_optional_dropbox_1:
        SourceImage|startswith: 'C:\Windows\Temp\'
        SourceImage|endswith: '.tmp\DropboxUpdate.exe'
        GrantedAccess:
            -<span class="ruby"><span class="hljs-string"> '</span><span class="hljs-number">0x410</span><span class="hljs-string">'
</span></span>            -<span class="ruby"><span class="hljs-string"> '</span><span class="hljs-number">0x1410</span><span class="hljs-string">'
</span></span>    filter_optional_dropbox_2:
        SourceImage|startswith: 'C:\Users\'
        SourceImage|contains: '\AppData\Local\Temp\'
        SourceImage|endswith: '.tmp\DropboxUpdate.exe'
        GrantedAccess: '0x1410'
    filter_optional_dropbox_3:
        SourceImage|startswith:
            -<span class="ruby"><span class="hljs-string"> '</span><span class="hljs-symbol">C:</span>\Program Files (x86)\Dropbox\<span class="hljs-string">'
</span></span>            -<span class="ruby"><span class="hljs-string"> '</span><span class="hljs-symbol">C:</span>\Program Files\Dropbox\<span class="hljs-string">'
</span></span>        SourceImage|endswith: '\DropboxUpdate.exe'
        GrantedAccess: '0x1410'
    filter_optional_nextron:
        SourceImage|startswith:
            -<span class="ruby"><span class="hljs-string"> '</span><span class="hljs-symbol">C:</span>\Windows\Temp\asgard2-agent\<span class="hljs-string">'
</span></span>            -<span class="ruby"><span class="hljs-string"> '</span><span class="hljs-symbol">C:</span>\Windows\Temp\asgard2-agent-sc\<span class="hljs-string">'
</span></span>        SourceImage|endswith:
            -<span class="ruby"><span class="hljs-string"> '</span>\thor64.exe<span class="hljs-string">'
</span></span>            -<span class="ruby"><span class="hljs-string"> '</span>\thor.exe<span class="hljs-string">'
</span></span>            -<span class="ruby"><span class="hljs-string"> '</span>\aurora-agent-<span class="hljs-number">64</span>.exe<span class="hljs-string">'
</span></span>            -<span class="ruby"><span class="hljs-string"> '</span>\aurora-agent.exe<span class="hljs-string">'
</span></span>        GrantedAccess:
            -<span class="ruby"><span class="hljs-string"> '</span><span class="hljs-number">0x1fffff</span><span class="hljs-string">'
</span></span>            -<span class="ruby"><span class="hljs-string"> '</span><span class="hljs-number">0x1010</span><span class="hljs-string">'
</span></span>            -<span class="ruby"><span class="hljs-string"> '</span><span class="hljs-number">0x101010</span><span class="hljs-string">'
</span></span>    filter_optional_ms_products:
        SourceImage|startswith: 'C:\Users\'
        SourceImage|contains|all:
            -<span class="ruby"><span class="hljs-string"> '</span>\AppData\Local\Temp\<span class="hljs-string">'
</span></span>            -<span class="ruby"><span class="hljs-string"> '</span>\vs_bootstrapper<span class="hljs-number">_</span><span class="hljs-string">'
</span></span>        GrantedAccess: '0x1410'
    filter_optional_chrome_update:
        SourceImage|startswith: 'C:\Program Files (x86)\Google\Temp\'
        SourceImage|endswith: '.tmp\GoogleUpdate.exe'
        GrantedAccess:
            -<span class="ruby"><span class="hljs-string"> '</span><span class="hljs-number">0x410</span><span class="hljs-string">'
</span></span>            -<span class="ruby"><span class="hljs-string"> '</span><span class="hljs-number">0x1410</span><span class="hljs-string">'
</span></span>    filter_optional_keybase:
        SourceImage|startswith: 'C:\Users\'
        SourceImage|endswith: \AppData\Local\Keybase\keybase.exe
        GrantedAccess: '0x1fffff'
    filter_optional_avira:
        SourceImage|contains: '\AppData\Local\Temp\is-'
        SourceImage|endswith: '.tmp\avira_system_speedup.tmp'
        GrantedAccess: '0x1410'
    filter_optional_viberpc_updater:
        SourceImage|startswith: 'C:\Users\'
        SourceImage|contains: '\AppData\Roaming\ViberPC\'
        SourceImage|endswith: '\updater.exe'
        TargetImage|endswith: '\winlogon.exe'
        GrantedAccess: '0x1fffff'
    filter_optional_adobe_arm_helper:
        SourceImage|startswith:  # Example path: 'C:\Program Files (x86)\Common Files\Adobe\ARM\1.0\Temp\2092867405\AdobeARMHelper.exe'
            -<span class="ruby"><span class="hljs-string"> '</span><span class="hljs-symbol">C:</span>\Program Files\Common Files\Adobe\ARM\<span class="hljs-string">'
</span></span>            -<span class="ruby"><span class="hljs-string"> '</span><span class="hljs-symbol">C:</span>\Program Files (x86)\Common Files\Adobe\ARM\<span class="hljs-string">'
</span></span>        SourceImage|endswith: '\AdobeARMHelper.exe'
        GrantedAccess: '0x1410'
    condition: selection and not 1 of filter_optional_*
fields:
    -<span class="ruby"><span class="hljs-string"> User
</span></span>    -<span class="ruby"><span class="hljs-string"> SourceImage
</span></span>    -<span class="ruby"><span class="hljs-string"> GrantedAccess
</span></span>falsepositives:
    -<span class="ruby"><span class="hljs-string"> Updaters and installers are typical false positives. Apply custom filters depending on your environment
</span></span>level: medium
</code></pre>
<p>Notice how the condition filters out false positives (selection <code>and not 1 of filter_optional_*</code>).</p>
<hr>
<p><strong>Example 2: Multiple Failed Logins From Single Source (Based on Event 4776)</strong></p>
<p>According to Microsoft, <a href="https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4776">Event 4776</a> generates every time that a credential validation occurs using NTLM authentication.</p>
<p>This event occurs only on the computer that is authoritative for the provided credentials. For domain accounts, the domain controller is authoritative. For local accounts, the local computer is authoritative.</p>
<p>It shows successful and unsuccessful credential validation attempts.</p>
<p>It shows only the computer name (<code>Source Workstation</code>) from which the authentication attempt was performed (authentication source). For example, if you authenticate from CLIENT-1 to SERVER-1 using a domain account you&#39;ll see CLIENT-1 in the <code>Source Workstation</code> field. Information about the destination computer (SERVER-1) isn&#39;t presented in this event.</p>
<p>If a credential validation attempt fails, you&#39;ll see a Failure event with Error Code parameter value not equal to <code>0x0</code>.</p>
<p><code>lab_events_2.evtx</code> inside the <code>C:\Events\YARASigma</code> directory of this section&#39;s target contains events related to multiple failed login attempts against <code>NOUSER</code> (thanks to <a href="https://twitter.com/mdecrevoisier">mdecrevoisier</a>).</p>
<p><img src="https://academy.hackthebox.com/storage/modules/234/4776.png" alt=""></p>
<p><img src="https://academy.hackthebox.com/storage/modules/234/4776\_2.png" alt=""></p>
<p>A valid Sigma rule to detect multiple failed login attempts originating from the same source can be found inside the <code>C:\Rules\sigma</code> directory of this section&#39;s target, saved as <code>win_security_susp_failed_logons_single_source2.yml</code></p>
<p>Code: yaml</p>
<pre><code class="lang-yaml"><span class="hljs-attribute">title</span>: Failed NTLM Logins with Different Accounts from Single Source System
<span class="hljs-attribute">id</span>: <span class="hljs-number">6309</span>ffc4-<span class="hljs-number">8</span>fa2-<span class="hljs-number">47</span>cf-<span class="hljs-number">96</span>b8-a2f72e58e538
<span class="hljs-attribute">related</span>:
    - <span class="hljs-attribute">id</span>: e98374a6-e2d9-<span class="hljs-number">4076</span>-<span class="hljs-number">9</span>b5c-<span class="hljs-number">11</span>bdb2569995
      <span class="hljs-attribute">type</span>: derived
<span class="hljs-attribute">status</span>: unsupported
<span class="hljs-attribute">description</span>: Detects suspicious failed logins with different user accounts from a single source system
<span class="hljs-attribute">author</span>: Florian Roth (Nextron Systems)
<span class="hljs-attribute">date</span>: <span class="hljs-number">2017</span>/<span class="hljs-number">01</span>/<span class="hljs-number">10</span>
<span class="hljs-attribute">modified</span>: <span class="hljs-number">2023</span>/<span class="hljs-number">02</span>/<span class="hljs-number">24</span>
<span class="hljs-attribute">tags</span>:
    - attack.persistence
    - attack.privilege_escalation
    - attack.t1078
<span class="hljs-attribute">logsource</span>:
    <span class="hljs-attribute">product</span>: windows
    <span class="hljs-attribute">service</span>: security
<span class="hljs-attribute">detection</span>:
    <span class="hljs-attribute">selection2</span>:
        <span class="hljs-attribute">EventID</span>: <span class="hljs-number">4776</span>
        <span class="hljs-attribute">TargetUserName</span>: <span class="hljs-string">'*'</span>
        <span class="hljs-attribute">Workstation</span>: <span class="hljs-string">'*'</span>
    <span class="hljs-attribute">condition</span>: selection2 | count(TargetUserName) by Workstation &gt; <span class="hljs-number">3</span>
<span class="hljs-attribute">falsepositives</span>:
    - Terminal servers
    - Jump servers
    - Other multiuser systems like Citrix server farms
    - Workstations with frequently changing users
<span class="hljs-attribute">level</span>: medium
</code></pre>
<p><strong>Sigma Rule Breakdown</strong>:</p>
<ul>
<li><code>logsource</code>: This section specifies that the rule is intended for Windows systems (<code>product: windows</code>) and focuses only on <code>Security</code> event logs (<code>service: security</code>).</li>
</ul>
<p>Code: yaml</p>
<pre><code class="lang-yaml"><span class="hljs-symbol">logsource:</span>
<span class="hljs-symbol">    product:</span> windows
<span class="hljs-symbol">    service:</span> security
</code></pre>
<ul>
<li><code>detection</code>: <code>selection2</code> is essentially the filter. It&#39;s looking for logs with EventID <code>4776</code> (<code>EventID: 4776</code>) regardless of the <code>TargetUserName</code> or <code>Workstation</code> values (<code>TargetUserName: &#39;*&#39;</code>, <code>Workstation: &#39;*&#39;</code>). <code>condition</code> counts instances of <code>TargetUserName</code> grouped by <code>Workstation</code> and checks if a workstation has more than <code>three</code> failed login attempts.</li>
</ul>
<hr>
<h3 id="sigma-rule-development-resources">Sigma Rule Development Resources</h3>
<p>As you can imagine, the best Sigma rule development resource is the official documentation, which can be found at the following links.</p>
<ul>
<li><a href="https://github.com/SigmaHQ/sigma/wiki/Rule-Creation-Guide">https://github.com/SigmaHQ/sigma/wiki/Rule-Creation-Guide</a></li>
<li><a href="https://github.com/SigmaHQ/sigma-specification">https://github.com/SigmaHQ/sigma-specification</a></li>
</ul>
<p>The following series of articles is the next best resource on Sigma rule developement.</p>
<ul>
<li><a href="https://tech-en.netlify.app/articles/en510480/">https://tech-en.netlify.app/articles/en510480/</a></li>
<li><a href="https://tech-en.netlify.app/articles/en513032/">https://tech-en.netlify.app/articles/en513032/</a></li>
<li><a href="https://tech-en.netlify.app/articles/en515532/">https://tech-en.netlify.app/articles/en515532/</a></li>
</ul>
<hr>
<p>In the upcoming section, we&#39;ll explore how to use Sigma rules for large-scale analysis of event logs with the aim of swiftly identifying threats.</p>
<h2 id="hunting-evil-with-sigma-chainsaw-edition-">Hunting Evil with Sigma (Chainsaw Edition)</h2>
<p>In cybersecurity, time is of the essence. Rapid analysis allows us to not just identify but also respond to threats before they escalate.</p>
<p>When we&#39;re up against the clock, racing to find a needle in a haystack of Windows Event Logs without access to a SIEM, Sigma rules combined with tools like <a href="https://github.com/WithSecureLabs/chainsaw">Chainsaw</a> and <a href="https://github.com/wagga40/Zircolite">Zircolite</a> are our best allies.</p>
<p>Both tools allow us to use Sigma rules to scan not just one, but multiple EVTX files concurrently, offering a broader and more comprehensive scan in a very efficient manner.</p>
<p>Let&#39;s now navigate to the bottom of this section and click on &quot;Click here to spawn the target system!&quot;. Then, let&#39;s RDP into the Target IP using the provided credentials. The vast majority of the actions/commands covered from this point up to end of this section can be replicated inside the target, offering a more comprehensive grasp of the topics presented.</p>
<h3 id="scanning-windows-event-logs-with-chainsaw">Scanning Windows Event Logs With Chainsaw</h3>
<p>Chainsaw is a freely available tool designed to swiftly pinpoint security threats within Windows Event Logs. This tool enables efficient keyword-based event log searches and is equipped with integrated support for Sigma detection rules as well as custom Chainsaw rules. Therefore, it serves as a valuable asset for validating our Sigma rules by applying them to actual event logs. Let&#39;s download the Chainsaw from the official Github repository and run it with some sigma rules:</p>
<p>Chainsaw can be found inside the <code>C:\Tools\chainsaw</code> directory of this section&#39;s target.</p>
<p>Let&#39;s first run Chainsaw with <code>-h</code> flag to see the help menu.</p>
<p>Hunting Evil with Sigma (Chainsaw Edition)</p>
<pre><code class="lang-powershell-session">PS C:\Tools\chainsaw&gt; .\chainsaw_x86_64-pc-windows-msvc.exe -h
Rapidly work <span class="hljs-keyword">with</span> Forensic Artefacts

Usage: chainsaw_x86_64-pc-windows-msvc.exe [OPTIONS] &lt;COMMAND&gt;

Commands:
  dump     Dump <span class="hljs-keyword">an</span> artefact <span class="hljs-keyword">into</span> <span class="hljs-keyword">a</span> different <span class="hljs-built_in">format</span>
  hunt     Hunt through artefacts <span class="hljs-keyword">using</span> detection rules <span class="hljs-keyword">for</span> threat detection
  lint     Lint provided rules <span class="hljs-built_in">to</span> ensure that they <span class="hljs-built_in">load</span> correctly
  search   Search through forensic artefacts <span class="hljs-keyword">for</span> keywords
  analyse  Perform various analyses <span class="hljs-keyword">on</span> <span class="hljs-title">artifacts</span>
  help     Print this message <span class="hljs-keyword">or</span> <span class="hljs-keyword">the</span> help <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> given subcommand(s)

Options:
      <span class="hljs-comment">--no-banner                  Hide Chainsaw's banner</span>
      <span class="hljs-comment">--num-threads &lt;NUM_THREADS&gt;  Limit the thread number (default: num of CPUs)</span>
  -h, <span class="hljs-comment">--help                       Print help</span>
  -V, <span class="hljs-comment">--version                    Print version</span>

Examples:

    Hunt <span class="hljs-keyword">with</span> Sigma <span class="hljs-keyword">and</span> Chainsaw Rules:
        ./chainsaw hunt evtx_attack_samples/ -s sigma/ <span class="hljs-comment">--mapping mappings/sigma-event-logs-all.yml -r rules/</span>

    Hunt <span class="hljs-keyword">with</span> Sigma rules <span class="hljs-keyword">and</span> output <span class="hljs-keyword">in</span> JSON:
        ./chainsaw hunt evtx_attack_samples/ -s sigma/ <span class="hljs-comment">--mapping mappings/sigma-event-logs-all.yml --json</span>

    Search <span class="hljs-keyword">for</span> <span class="hljs-keyword">the</span> <span class="hljs-keyword">case</span>-insensitive <span class="hljs-built_in">word</span> <span class="hljs-string">'mimikatz'</span>:
        ./chainsaw search mimikatz -i evtx_attack_samples/

    Search <span class="hljs-keyword">for</span> Powershell Script Block Events (EventID <span class="hljs-number">4014</span>):
        ./chainsaw search -t <span class="hljs-string">'Event.System.EventID: =4104'</span> evtx_attack_samples/
</code></pre>
<hr>
<p><strong>Example 1: Hunting for Multiple Failed Logins From Single Source With Sigma</strong></p>
<p>Let&#39;s put Chainsaw to work by applying our most recent Sigma rule, <code>win_security_susp_failed_logons_single_source2.yml</code> (available at <code>C:\Rules\sigma</code>), to <code>lab_events_2.evtx</code> (available at <code>C:\Events\YARASigma\lab_events_2.evtx</code>) that contains multiple failed login attempts from the same source.</p>
<p>Hunting Evil with Sigma (Chainsaw Edition)</p>
<pre><code class="lang-powershell-session">PS C:\Tools\chainsaw&gt; .\chainsaw_x86_64-pc-windows-msvc<span class="hljs-selector-class">.exe</span> hunt C:\Events\YARASigma\lab_events_2<span class="hljs-selector-class">.evtx</span> -s C:\Rules\sigma\win_security_susp_failed_logons_single_source2<span class="hljs-selector-class">.yml</span> --mapping .\mappings\sigma-event-logs-all<span class="hljs-selector-class">.yml</span>

 ██████╗██╗  ██╗ █████╗ ██╗███╗   ██╗███████╗ █████╗ ██╗    ██╗
██╔════╝██║  ██║██╔══██╗██║████╗  ██║██╔════╝██╔══██╗██║    ██║
██║     ███████║███████║██║██╔██╗ ██║███████╗███████║██║ █╗ ██║
██║     ██╔══██║██╔══██║██║██║╚██╗██║╚════██║██╔══██║██║███╗██║
╚██████╗██║  ██║██║  ██║██║██║ ╚████║███████║██║  ██║╚███╔███╔╝
 ╚═════╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝ ╚══╝╚══╝
    By Countercept (@FranticTyping, @AlexKornitzer)

[+] Loading detection rules from: C:\Rules\sigma\win_security_susp_failed_logons_single_source2<span class="hljs-selector-class">.yml</span>
[+] Loaded <span class="hljs-number">1</span> detection rules
[+] Loading forensic artefacts from: C:\Events\YARASigma\lab_events_2<span class="hljs-selector-class">.evtx</span> (extensions: <span class="hljs-selector-class">.evt</span>, .evtx)
[+] Loaded <span class="hljs-number">1</span> forensic artefacts (<span class="hljs-number">69.6</span> KB)
[+] Hunting: [========================================] <span class="hljs-number">1</span>/<span class="hljs-number">1</span> -
[+] Group: Sigma
┌─────────────────────┬───────────────────────────┬───────┬────────────────────────────────┬──────────┬───────────┬─────────────────┬────────────────────────────────┐
│      timestamp      │        detections         │ count │     Event<span class="hljs-selector-class">.System</span><span class="hljs-selector-class">.Provider</span>      │ Event ID │ Record ID │    Computer     │           Event Data           │
├─────────────────────┼───────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼─────────────────┼────────────────────────────────┤
│ <span class="hljs-number">2021</span>-<span class="hljs-number">05</span>-<span class="hljs-number">20</span> <span class="hljs-number">12</span>:<span class="hljs-number">49</span>:<span class="hljs-number">52</span> │ + Failed NTLM Logins with │ <span class="hljs-number">5</span>     │ Microsoft-Windows-Security-Aud │ <span class="hljs-number">4776</span>     │ <span class="hljs-number">1861986</span>   │ fs01<span class="hljs-selector-class">.offsec</span><span class="hljs-selector-class">.lan</span> │ PackageName: MICROSOFT_AUTHENT │
│                     │ Different Accounts from   │       │ iting                          │          │           │                 │ ICATION_PACKAGE_V1_0           │
│                     │ Single Source System      │       │                                │          │           │                 │ Status: <span class="hljs-string">'0xc0000064'</span>           │
│                     │                           │       │                                │          │           │                 │ TargetUserName: NOUSER         │
│                     │                           │       │                                │          │           │                 │ Workstation: FS01              │
└─────────────────────┴───────────────────────────┴───────┴────────────────────────────────┴──────────┴───────────┴─────────────────┴────────────────────────────────┘

[+] <span class="hljs-number">1</span> Detections found on <span class="hljs-number">1</span> documents
PS C:\Tools\chainsaw&gt;
</code></pre>
<p>Our Sigma rule was able to identify the multiple failed login attempts against <code>NOUSER</code>.</p>
<p>Using the <code>-s</code> parameter, we can specify a directory containing Sigma detection rules (or one Sigma detection rule) and Chainsaw will automatically load, convert and run these rules against the provided event logs. The mapping file (specified through the <code>--mapping</code> parameter) tells Chainsaw which fields in the event logs to use for rule matching.</p>
<hr>
<p><strong>Example 2: Hunting for Abnormal PowerShell Command Line Size With Sigma (Based on Event ID 4688)</strong></p>
<p>Firstly, let&#39;s set the stage by recognizing that PowerShell, being a highly flexible scripting language, is an attractive target for attackers. Its deep integration with Windows APIs and .NET Framework makes it an ideal candidate for a variety of post-exploitation activities.</p>
<p>To conceal their actions, attackers utilize complex encoding layers or misuse cmdlets for purposes they weren&#39;t designed for. This leads to abnormally long PowerShell commands that often incorporate Base64 encoding, string merging, and several variables containing fragmented parts of the command.</p>
<p>A Sigma rule that can detect abnormally long PowerShell command lines can be found inside the <code>C:\Rules\sigma</code> directory of this section&#39;s target, saved as <code>proc_creation_win_powershell_abnormal_commandline_size.yml</code>.</p>
<p>Code: yaml</p>
<pre><code class="lang-yaml"><span class="hljs-attribute">title</span>: Unusually Long PowerShell CommandLine
<span class="hljs-attribute">id</span>: d0d28567-<span class="hljs-number">4</span>b9a-<span class="hljs-number">45</span>e2-<span class="hljs-number">8</span>bbc-fb1b66a1f7f6
<span class="hljs-attribute">status</span>: test
<span class="hljs-attribute">description</span>: Detects unusually long PowerShell command lines with a length of <span class="hljs-number">1000</span> characters or more
<span class="hljs-attribute">references</span>:
    - <span class="hljs-attribute">https</span>:<span class="hljs-comment">//speakerdeck.com/heirhabarov/hunting-for-powershell-abuse</span>
<span class="hljs-attribute">author</span>: oscd.community, Natalia Shornikova / HTB Academy, Dimitrios Bougioukas
<span class="hljs-attribute">date</span>: <span class="hljs-number">2020</span>/<span class="hljs-number">10</span>/<span class="hljs-number">06</span>
<span class="hljs-attribute">modified</span>: <span class="hljs-number">2023</span>/<span class="hljs-number">04</span>/<span class="hljs-number">14</span>
<span class="hljs-attribute">tags</span>:
    - attack.execution
    - attack.t1059.<span class="hljs-number">001</span>
    - detection.threat_hunting
<span class="hljs-attribute">logsource</span>:
    <span class="hljs-attribute">category</span>: process_creation
    <span class="hljs-attribute">product</span>: windows
<span class="hljs-attribute">detection</span>:
    <span class="hljs-attribute">selection</span>:
        <span class="hljs-attribute">EventID</span>: <span class="hljs-number">4688</span>
        NewProcessName|<span class="hljs-attribute">endswith</span>:
            - <span class="hljs-string">'\powershell.exe'</span>
            - <span class="hljs-string">'\pwsh.exe'</span>
            - <span class="hljs-string">'\cmd.exe'</span>
    <span class="hljs-attribute">selection_powershell</span>:
        CommandLine|<span class="hljs-attribute">contains</span>:
            - <span class="hljs-string">'powershell.exe'</span>
            - <span class="hljs-string">'pwsh.exe'</span>
    <span class="hljs-attribute">selection_length</span>:        
        CommandLine|<span class="hljs-attribute">re</span>: <span class="hljs-string">'.{1000,}'</span>
    <span class="hljs-attribute">condition</span>: selection and selection_powershell and selection_length
<span class="hljs-attribute">falsepositives</span>:
    - Unknown
<span class="hljs-attribute">level</span>: low
</code></pre>
<p><strong>Sigma Rule Breakdown</strong>:</p>
<ul>
<li><code>logsource</code>: The rule looks into logs under the category of <a href="https://github.com/SigmaHQ/sigma/blob/master/documentation/logsource-guides/windows/category/process\_creation.md">process_creation</a> and is designed to work against Windows machines.</li>
</ul>
<p>Code: yaml</p>
<pre><code class="lang-yaml"><span class="hljs-symbol">logsource:</span>
<span class="hljs-symbol">    category:</span> process_creation
<span class="hljs-symbol">    product:</span> windows
</code></pre>
<ul>
<li><code>detection</code>: The <code>selection</code> section checks if any Windows events with ID <a href="https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4688">4688</a> exist and also checks if the <code>NewProcessName</code> field ends with <code>\powershell.exe</code>, <code>\pwsh.exe</code>, or <code>\cmd.exe</code>. The <code>selection_powershell</code> section checks if the executed command line includes PowerShell-related executables and finally, the <code>selection_length</code> section checks if the <code>CommandLine</code> field of the <code>4688</code> event contains 1,000 characters or more. The <code>condition</code> section checks if the selection criteria inside the <code>selection</code>, <code>selection_powershell</code>, and <code>selection_length</code> sections are all met.</li>
</ul>
<p>Code: yaml</p>
<pre><code class="lang-yaml">detection:
    selection:
        EventID: 4688
        NewProcessName|endswith:
            -<span class="ruby"> <span class="hljs-string">'\powershell.exe'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'\pwsh.exe'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'\cmd.exe'</span>
</span>    selection_powershell:
        CommandLine|contains:
            -<span class="ruby"> <span class="hljs-string">'powershell.exe'</span>
</span>            -<span class="ruby"> <span class="hljs-string">'pwsh.exe'</span>
</span>    selection_length:        
        CommandLine|re: '.{1000,}'
    condition: selection and selection_powershell and selection_length
</code></pre>
<p>Let&#39;s put Chainsaw to work by applying the abovementioned Sigma rule, <code>proc_creation_win_powershell_abnormal_commandline_size.yml</code> (available at <code>C:\Rules\sigma</code>), to <code>lab_events_3.evtx</code> (available at <code>C:\Events\YARASigma\lab_events_3.evtx</code>, thanks to <a href="https://twitter.com/mdecrevoisier">mdecrevoisier</a>) that contains <code>4688</code> events with abnormally long PowerShell commands.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/234/4688.png" alt=""></p>
<p>Hunting Evil with Sigma (Chainsaw Edition)</p>
<pre><code class="lang-powershell-session"><span class="hljs-selector-tag">PS</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">Tools</span>\<span class="hljs-selector-tag">chainsaw</span>&gt; .\<span class="hljs-selector-tag">chainsaw_x86_64-pc-windows-msvc</span><span class="hljs-selector-class">.exe</span> <span class="hljs-selector-tag">hunt</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">Events</span>\<span class="hljs-selector-tag">YARASigma</span>\<span class="hljs-selector-tag">lab_events_3</span><span class="hljs-selector-class">.evtx</span> <span class="hljs-selector-tag">-s</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">Rules</span>\<span class="hljs-selector-tag">sigma</span>\<span class="hljs-selector-tag">proc_creation_win_powershell_abnormal_commandline_size</span><span class="hljs-selector-class">.yml</span> <span class="hljs-selector-tag">--mapping</span> .\<span class="hljs-selector-tag">mappings</span>\<span class="hljs-selector-tag">sigma-event-logs-all</span><span class="hljs-selector-class">.yml</span>

 ██████╗██╗  ██╗ █████╗ ██╗███╗   ██╗███████╗ █████╗ ██╗    ██╗
██╔════╝██║  ██║██╔══██╗██║████╗  ██║██╔════╝██╔══██╗██║    ██║
██║     ███████║███████║██║██╔██╗ ██║███████╗███████║██║ █╗ ██║
██║     ██╔══██║██╔══██║██║██║╚██╗██║╚════██║██╔══██║██║███╗██║
╚██████╗██║  ██║██║  ██║██║██║ ╚████║███████║██║  ██║╚███╔███╔╝
 ╚═════╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝ ╚══╝╚══╝
    <span class="hljs-selector-tag">By</span> <span class="hljs-selector-tag">Countercept</span> (<span class="hljs-variable">@FranticTyping</span>, <span class="hljs-variable">@AlexKornitzer</span>)

<span class="hljs-selector-attr">[+]</span> <span class="hljs-selector-tag">Loading</span> <span class="hljs-selector-tag">detection</span> <span class="hljs-selector-tag">rules</span> <span class="hljs-selector-tag">from</span>: <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">Rules</span>\<span class="hljs-selector-tag">sigma</span>\<span class="hljs-selector-tag">proc_creation_win_powershell_abnormal_commandline_size</span><span class="hljs-selector-class">.yml</span>
<span class="hljs-selector-attr">[+]</span> <span class="hljs-selector-tag">Loaded</span> <span class="hljs-selector-tag">1</span> <span class="hljs-selector-tag">detection</span> <span class="hljs-selector-tag">rules</span>
<span class="hljs-selector-attr">[+]</span> <span class="hljs-selector-tag">Loading</span> <span class="hljs-selector-tag">forensic</span> <span class="hljs-selector-tag">artefacts</span> <span class="hljs-selector-tag">from</span>: <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">Events</span>\<span class="hljs-selector-tag">YARASigma</span>\<span class="hljs-selector-tag">lab_events_3</span><span class="hljs-selector-class">.evtx</span> (<span class="hljs-attribute">extensions</span>: .evt, .evtx)
<span class="hljs-selector-attr">[+]</span> <span class="hljs-selector-tag">Loaded</span> <span class="hljs-selector-tag">1</span> <span class="hljs-selector-tag">forensic</span> <span class="hljs-selector-tag">artefacts</span> (<span class="hljs-number">69.6</span> KB)
<span class="hljs-selector-attr">[+]</span> <span class="hljs-selector-tag">Hunting</span>: <span class="hljs-selector-attr">[========================================]</span> <span class="hljs-selector-tag">1</span>/<span class="hljs-selector-tag">1</span> <span class="hljs-selector-tag">-</span>
<span class="hljs-selector-attr">[+]</span> <span class="hljs-selector-tag">0</span> <span class="hljs-selector-tag">Detections</span> <span class="hljs-selector-tag">found</span> <span class="hljs-selector-tag">on</span> <span class="hljs-selector-tag">0</span> <span class="hljs-selector-tag">documents</span>
</code></pre>
<p>Our Sigma doesn&#39;t seem to be able to identify the abnormally long PowerShell commands within these <code>4688</code> events.</p>
<p>Does this mean that our Sigma rule is flawed? No! As discussed previously, Chainsaw&#39;s mapping file (specified through the <code>--mapping</code> parameter) tells it which fields in the event logs to use for rule matching.</p>
<p>It looks like the <code>NewProcessName</code> field was missing from the <code>sigma-event-logs-all.yml</code> mapping file.</p>
<p>We introduced the <code>NewProcessName</code> field into a <code>sigma-event-logs-all-new.yml</code> mapping file inside the <code>C:\Tools\chainsaw\mappings</code> directory of this section&#39;s target.</p>
<p>Let&#39;s run Chainsaw again with this new mapping file.</p>
<p>Hunting Evil with Sigma (Chainsaw Edition)</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-tag">\<span class="hljs-name">Tools</span></span><span class="hljs-tag">\<span class="hljs-name">chainsaw</span></span>&gt; .<span class="hljs-tag">\<span class="hljs-name">chainsaw</span></span>_x86_64-pc-windows-msvc.exe hunt C:<span class="hljs-tag">\<span class="hljs-name">Events</span></span><span class="hljs-tag">\<span class="hljs-name">YARASigma</span></span><span class="hljs-tag">\<span class="hljs-name">lab</span></span>_events_3.evtx -s C:<span class="hljs-tag">\<span class="hljs-name">Rules</span></span><span class="hljs-tag">\<span class="hljs-name">sigma</span></span><span class="hljs-tag">\<span class="hljs-name">proc</span></span>_creation_win_powershell_abnormal_commandline_size.yml --mapping .<span class="hljs-tag">\<span class="hljs-name">mappings</span></span><span class="hljs-tag">\<span class="hljs-name">sigma</span></span>-event-logs-all-new.yml

 ██████╗██╗  ██╗ █████╗ ██╗███╗   ██╗███████╗ █████╗ ██╗    ██╗
██╔════╝██║  ██║██╔══██╗██║████╗  ██║██╔════╝██╔══██╗██║    ██║
██║     ███████║███████║██║██╔██╗ ██║███████╗███████║██║ █╗ ██║
██║     ██╔══██║██╔══██║██║██║╚██╗██║╚════██║██╔══██║██║███╗██║
╚██████╗██║  ██║██║  ██║██║██║ ╚████║███████║██║  ██║╚███╔███╔╝
 ╚═════╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝ ╚══╝╚══╝
    By Countercept (@FranticTyping, @AlexKornitzer)

[+] Loading detection rules from: C:<span class="hljs-tag">\<span class="hljs-name">Rules</span></span><span class="hljs-tag">\<span class="hljs-name">sigma</span></span><span class="hljs-tag">\<span class="hljs-name">proc</span></span>_creation_win_powershell_abnormal_commandline_size.yml
[+] Loaded 1 detection rules
[+] Loading forensic artefacts from: C:<span class="hljs-tag">\<span class="hljs-name">Events</span></span><span class="hljs-tag">\<span class="hljs-name">YARASigma</span></span><span class="hljs-tag">\<span class="hljs-name">lab</span></span>_events_3.evtx (extensions: .evtx, .evt)
[+] Loaded 1 forensic artefacts (69.6 KB)
[+] Hunting: [========================================] 1/1 -
[+] Group: Sigma
┌─────────────────────┬─────────────────────────────┬───────┬────────────────────────────────┬──────────┬───────────┬─────────────────────┬──────────────────────────────────┐
│      timestamp      │         detections          │ count │     Event.System.Provider      │ Event ID │ Record ID │      Computer       │            Event Data            │
├─────────────────────┼─────────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼─────────────────────┼──────────────────────────────────┤
│ 2021-04-22 08:51:04 │ + Unusually Long PowerShell │ 1     │ Microsoft-Windows-Security-Aud │ 4688     │ 435121    │ fs03vuln.offsec.lan │ CommandLine: powershell.exe -n   │
│                     │ CommandLine                 │       │ iting                          │          │           │                     │ op -w hidden -noni -c "if([Int   │
│                     │                             │       │                                │          │           │                     │ Ptr]::Size -eq 4){<span class="hljs-formula">$b='powershe   │
│                     │                             │       │                                │          │           │                     │ ll.exe'}else{$</span>b=<span class="hljs-formula">$env:windir+'<span class="hljs-tag">\<span class="hljs-name"> </span></span>  │
│                     │                             │       │                                │          │           │                     │ syswow64<span class="hljs-tag">\<span class="hljs-name">WindowsPowerShell</span></span><span class="hljs-tag">\<span class="hljs-name">v</span></span>1.   │
│                     │                             │       │                                │          │           │                     │ 0<span class="hljs-tag">\<span class="hljs-name">powershell</span></span>.exe'};$</span>s=New-Obje   │
│                     │                             │       │                                │          │           │                     │ ct System.Diagnostics.ProcessS   │
│                     │                             │       │                                │          │           │                     │ tartInfo;<span class="hljs-formula">$s.FileName=$</span>b;<span class="hljs-formula">$s.Arg   │
│                     │                             │       │                                │          │           │                     │ uments='-noni -nop -w hidden -   │
│                     │                             │       │                                │          │           │                     │ c &amp;([scriptblock]::create((New   │
│                     │                             │       │                                │          │           │                     │ -Object System.IO.StreamReader   │
│                     │                             │       │                                │          │           │                     │ (New-Object System.IO.Compress   │
│                     │                             │       │                                │          │           │                     │ ion.GzipStream((New-Object Sys   │
│                     │                             │       │                                │          │           │                     │ tem.IO.MemoryStream(,[System.C   │
│                     │                             │       │                                │          │           │                     │ onvert]::FromBase64String(''H4   │
│                     │                             │       │                                │          │           │                     │ sIAPg2gWACA7VWbW+bSBD+nEj5D6iy   │
│                     │                             │       │                                │          │           │                     │ ...                              │
│                     │                             │       │                                │          │           │                     │ (use --full to show all content) │
│                     │                             │       │                                │          │           │                     │ NewProcessId: '0x7f0'            │
│                     │                             │       │                                │          │           │                     │ NewProcessName: C:<span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">Sys</span></span>   │
│                     │                             │       │                                │          │           │                     │ tem32<span class="hljs-tag">\<span class="hljs-name">WindowsPowerShell</span></span><span class="hljs-tag">\<span class="hljs-name">v</span></span>1.0<span class="hljs-tag">\<span class="hljs-name">p</span></span>   │
│                     │                             │       │                                │          │           │                     │ owershell.exe                    │
│                     │                             │       │                                │          │           │                     │ ProcessId: '0x6e8'               │
│                     │                             │       │                                │          │           │                     │ SubjectDomainName: OFFSEC        │
│                     │                             │       │                                │          │           │                     │ SubjectLogonId: '0x3e7'          │
│                     │                             │       │                                │          │           │                     │ SubjectUserName: FS03VULN$</span>       │
│                     │                             │       │                                │          │           │                     │ SubjectUserSid: S-1-5-18         │
│                     │                             │       │                                │          │           │                     │ TokenElevationType: '<span class="hljs-comment">%%1936'     │</span>
├─────────────────────┼─────────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼─────────────────────┼──────────────────────────────────┤
│ 2021-04-22 08:51:04 │ + Unusually Long PowerShell │ 1     │ Microsoft-Windows-Security-Aud │ 4688     │ 435120    │ fs03vuln.offsec.lan │ CommandLine: C:<span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">system</span></span>   │
│                     │ CommandLine                 │       │ iting                          │          │           │                     │ 32<span class="hljs-tag">\<span class="hljs-name">cmd</span></span>.exe /b /c start /b /min   │
│                     │                             │       │                                │          │           │                     │  powershell.exe -nop -w hidden   │
│                     │                             │       │                                │          │           │                     │  -noni -c "if([IntPtr]::Size -   │
│                     │                             │       │                                │          │           │                     │ eq 4){<span class="hljs-formula">$b='powershell.exe'}else   │
│                     │                             │       │                                │          │           │                     │ {$</span>b=<span class="hljs-formula">$env:windir+'<span class="hljs-tag">\<span class="hljs-name">syswow</span></span>64<span class="hljs-tag">\<span class="hljs-name">Win</span></span>   │
│                     │                             │       │                                │          │           │                     │ dowsPowerShell<span class="hljs-tag">\<span class="hljs-name">v</span></span>1.0<span class="hljs-tag">\<span class="hljs-name">powershell</span></span>   │
│                     │                             │       │                                │          │           │                     │ .exe'};$</span>s=New-Object System.Di   │
│                     │                             │       │                                │          │           │                     │ agnostics.ProcessStartInfo;<span class="hljs-formula">$s.   │
│                     │                             │       │                                │          │           │                     │ FileName=$</span>b;<span class="hljs-formula">$s.Arguments='-non   │
│                     │                             │       │                                │          │           │                     │ i -nop -w hidden -c &amp;([scriptb   │
│                     │                             │       │                                │          │           │                     │ lock]::create((New-Object Syst   │
│                     │                             │       │                                │          │           │                     │ em.IO.StreamReader(New-Object    │
│                     │                             │       │                                │          │           │                     │ System.IO.Compression.GzipStre   │
│                     │                             │       │                                │          │           │                     │ am((New-Object System.IO.Memor   │
│                     │                             │       │                                │          │           │                     │ yStream(,[System.Convert]::Fro   │
│                     │                             │       │                                │          │           │                     │ ...                              │
│                     │                             │       │                                │          │           │                     │ (use --full to show all content) │
│                     │                             │       │                                │          │           │                     │ NewProcessId: '0x6e8'            │
│                     │                             │       │                                │          │           │                     │ NewProcessName: C:<span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">Sys</span></span>   │
│                     │                             │       │                                │          │           │                     │ tem32<span class="hljs-tag">\<span class="hljs-name">cmd</span></span>.exe                    │
│                     │                             │       │                                │          │           │                     │ ProcessId: '0x1d0'               │
│                     │                             │       │                                │          │           │                     │ SubjectDomainName: OFFSEC        │
│                     │                             │       │                                │          │           │                     │ SubjectLogonId: '0x3e7'          │
│                     │                             │       │                                │          │           │                     │ SubjectUserName: FS03VULN$</span>       │
│                     │                             │       │                                │          │           │                     │ SubjectUserSid: S-1-5-18         │
│                     │                             │       │                                │          │           │                     │ TokenElevationType: '<span class="hljs-comment">%%1936'     │</span>
├─────────────────────┼─────────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼─────────────────────┼──────────────────────────────────┤
│ 2021-04-22 08:51:05 │ + Unusually Long PowerShell │ 1     │ Microsoft-Windows-Security-Aud │ 4688     │ 435124    │ fs03vuln.offsec.lan │ CommandLine: '"C:<span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">sysw</span></span>   │
│                     │ CommandLine                 │       │ iting                          │          │           │                     │ ow64<span class="hljs-tag">\<span class="hljs-name">WindowsPowerShell</span></span><span class="hljs-tag">\<span class="hljs-name">v</span></span>1.0<span class="hljs-tag">\<span class="hljs-name">po</span></span>   │
│                     │                             │       │                                │          │           │                     │ wershell.exe" -noni -nop -w hi   │
│                     │                             │       │                                │          │           │                     │ dden -c &amp;([scriptblock]::creat   │
│                     │                             │       │                                │          │           │                     │ e((New-Object System.IO.Stream   │
│                     │                             │       │                                │          │           │                     │ Reader(New-Object System.IO.Co   │
│                     │                             │       │                                │          │           │                     │ mpression.GzipStream((New-Obje   │
│                     │                             │       │                                │          │           │                     │ ct System.IO.MemoryStream(,[Sy   │
│                     │                             │       │                                │          │           │                     │ stem.Convert]::FromBase64Strin   │
│                     │                             │       │                                │          │           │                     │ g(''H4sIAPg2gWACA7VWbW+bSBD+nE   │
│                     │                             │       │                                │          │           │                     │ j5D6iyBKiOIbbbvEiVbgFju4kdbBI7   │
│                     │                             │       │                                │          │           │                     │ sWud1rCGbRbWgSWO0/a/32CgTa/pXX   │
│                     │                             │       │                                │          │           │                     │ vSIb/sy8zszDPPzrDKYk9QHku+w91M   │
│                     │                             │       │                                │          │           │                     │ +nSwv+fgBEeSUouy9fqkLtXSsaPu7c   │
│                     │                             │       │                                │          │           │                     │ FGjXd7+K30TlLmaL22eIRpvDg7M7Mk   │
│                     │                             │       │                                │          │           │                     │ IbEo5o0uEShNSbRklKSKKn2WpiFJyO   │
│                     │                             │       │                                │          │           │                     │ ...                              │
│                     │                             │       │                                │          │           │                     │ (use --full to show all content) │
│                     │                             │       │                                │          │           │                     │ NewProcessId: '0x8f0'            │
│                     │                             │       │                                │          │           │                     │ NewProcessName: C:<span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">Sys</span></span>   │
│                     │                             │       │                                │          │           │                     │ WOW64<span class="hljs-tag">\<span class="hljs-name">WindowsPowerShell</span></span><span class="hljs-tag">\<span class="hljs-name">v</span></span>1.0<span class="hljs-tag">\<span class="hljs-name">p</span></span>   │
│                     │                             │       │                                │          │           │                     │ owershell.exe                    │
│                     │                             │       │                                │          │           │                     │ ProcessId: '0x7f0'               │
│                     │                             │       │                                │          │           │                     │ SubjectDomainName: OFFSEC        │
│                     │                             │       │                                │          │           │                     │ SubjectLogonId: '0x3e7'          │
│                     │                             │       │                                │          │           │                     │ SubjectUserName: FS03VULN<span class="hljs-formula">$       │
│                     │                             │       │                                │          │           │                     │ SubjectUserSid: S-1-5-18         │
│                     │                             │       │                                │          │           │                     │ TokenElevationType: '%%1936'     │
└─────────────────────┴─────────────────────────────┴───────┴────────────────────────────────┴──────────┴───────────┴─────────────────────┴──────────────────────────────────┘

[+] 3 Detections found on 3 documents</span>
</code></pre>
<p>Our Sigma rule successfully uncovered all three abnormally long PowerShell commands that exist inside <code>lab_events_3.evtx</code></p>
<p>Remember that configuration when it comes to using or tranlating Sigma rules is of paramount importance!</p>
<h2 id="hunting-evil-with-sigma-splunk-edition-">Hunting Evil with Sigma (Splunk Edition)</h2>
<p>As discussed when introducing Sigma, Sigma rules revolutionize our approach to log analysis and threat detection. What we&#39;re dealing with here is a sort of Rosetta Stone for SIEM systems. Sigma is like a universal translator that brings in a level of abstraction to event logs, taking away the painful element of SIEM-specific query languages.</p>
<p>Let&#39;s validate this assertion by converting two Sigma rules into their corresponding SPL formats and examining the outcomes.</p>
<p><strong>Example 1: Hunting for MiniDump Function Abuse to Dump LSASS&#39;s Memory (comsvcs.dll via rundll32)</strong></p>
<p>A Sigma rule named <code>proc_access_win_lsass_dump_comsvcs_dll.yml</code> can be found inside the <code>C:\Tools\chainsaw\sigma\rules\windows\process_access</code> directory of the <code>previous</code> section&#39;s target.</p>
<p>This Sigma rule detects adversaries leveraging the <code>MiniDump</code> export function of <code>comsvcs.dll</code> via <code>rundll32</code> to perform a memory dump from LSASS.</p>
<p>We can translate this rule into a Splunk search with <code>sigmac</code> (available at <code>C:\Tools\sigma-0.21\tools</code>) as follows.</p>
<p>Hunting Evil with Sigma (Splunk Edition)</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\T</span>ools<span class="hljs-symbol">\s</span>igma-0.21<span class="hljs-symbol">\t</span>ools&gt; python sigmac -t splunk C:<span class="hljs-symbol">\T</span>ools<span class="hljs-symbol">\c</span>hainsaw<span class="hljs-symbol">\s</span>igma<span class="hljs-symbol">\r</span>ules<span class="hljs-symbol">\w</span>indows<span class="hljs-symbol">\p</span>rocess_access<span class="hljs-symbol">\p</span>roc_access_win_lsass_dump_comsvcs_dll.yml -c .<span class="hljs-symbol">\c</span>onfig<span class="hljs-symbol">\s</span>plunk-windows.yml
(TargetImage="*<span class="hljs-symbol">\\</span>lsass.exe" SourceImage="C:<span class="hljs-symbol">\\</span>Windows<span class="hljs-symbol">\\</span>System32<span class="hljs-symbol">\\</span>rundll32.exe" CallTrace="*comsvcs.dll*")
</code></pre>
<p>Let&#39;s now navigate to the bottom of this section and click on <code>Click here to spawn the target system!</code>. Then, let&#39;s navigate to <code>http://[Target IP]:8000</code>, open the &quot;Search &amp; Reporting&quot; application, and submit the Splunk search <code>sigmac</code> provided us with.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/234/splunk\_1.png" alt=""></p>
<p>The Splunk search provided by <code>sigmac</code> was indeed able to detect MiniDump function abuse to dump LSASS&#39;s memory.</p>
<hr>
<p><strong>Example 2: Hunting for Notepad Spawning Suspicious Child Process</strong></p>
<p>A Sigma rule named <code>proc_creation_win_notepad_susp_child.yml</code> can be found inside the <code>C:\Rules\sigma</code> directory of the <code>previous</code> section&#39;s target.</p>
<p>This Sigma rule detects <code>notepad.exe</code> spawning a suspicious child process.</p>
<p>We can translate this rule into a Splunk search with <code>sigmac</code> (available at <code>C:\Tools\sigma-0.21\tools</code>) as follows.</p>
<p>Hunting Evil with Sigma (Splunk Edition)</p>
<pre><code class="lang-powershell-session">PS C:\Tools\sigma-<span class="hljs-number">0.21</span>\tools&gt; python sigmac -t splunk C:\Rules\sigma\proc_creation_win_notepad_susp_child.yml -c .\config\splunk-windows.yml
(ParentImage=<span class="hljs-string">"*\\notepad.exe"</span> (<span class="hljs-built_in">Image</span>=<span class="hljs-string">"*\\powershell.exe"</span> <span class="hljs-built_in">OR</span> <span class="hljs-built_in">Image</span>=<span class="hljs-string">"*\\pwsh.exe"</span> <span class="hljs-built_in">OR</span> <span class="hljs-built_in">Image</span>=<span class="hljs-string">"*\\cmd.exe"</span> <span class="hljs-built_in">OR</span> <span class="hljs-built_in">Image</span>=<span class="hljs-string">"*\\mshta.exe"</span> <span class="hljs-built_in">OR</span> <span class="hljs-built_in">Image</span>=<span class="hljs-string">"*\\cscript.exe"</span> <span class="hljs-built_in">OR</span> <span class="hljs-built_in">Image</span>=<span class="hljs-string">"*\\wscript.exe"</span> <span class="hljs-built_in">OR</span> <span class="hljs-built_in">Image</span>=<span class="hljs-string">"*\\taskkill.exe"</span> <span class="hljs-built_in">OR</span> <span class="hljs-built_in">Image</span>=<span class="hljs-string">"*\\regsvr32.exe"</span> <span class="hljs-built_in">OR</span> <span class="hljs-built_in">Image</span>=<span class="hljs-string">"*\\rundll32.exe"</span> <span class="hljs-built_in">OR</span> <span class="hljs-built_in">Image</span>=<span class="hljs-string">"*\\calc.exe"</span>))
</code></pre>
<p>Let&#39;s now navigate to the bottom of this section and click on <code>Click here to spawn the target system!</code>, if we haven&#39;t done that already. Then, let&#39;s navigate to <code>http://[Target IP]:8000</code>, open the &quot;Search &amp; Reporting&quot; application, and submit the Splunk search <code>sigmac</code> provided us with.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/234/splunk\_2.png" alt=""></p>
<p>The Splunk search provided by <code>sigmac</code> was indeed able to detect <code>notepad.exe</code> spawning suspicious processes (such as PowerShell).</p>
<hr>
<p>Please note that more frequently than not you will have to tamper with Sigma&#39;s config files (available inside the <code>C:\Tools\sigma-0.21\tools\config</code> directory of the previous section&#39;s target) in order for the SIEM queries to be readily usable.</p>
