
<body>
  <div class="container">
<link rel="stylesheet" href="style.css">


<h1 id="introduction-to-malware-analysis">Introduction to Malware Analysis</h1>
<h2 id="windows-internals">Windows Internals</h2>
<p>To conduct effective malware analysis, a profound understanding of Windows internals is essential. Windows operating systems function in two main modes:</p>
<ul>
<li><code>User Mode</code>: This mode is where most applications and user processes operate. Applications in user mode have limited access to system resources and must interact with the operating system through Application Programming Interfaces (APIs). These processes are isolated from each other and cannot directly access hardware or critical system functions. However, in this mode, malware can still manipulate files, registry settings, network connections, and other user-accessible resources, and it may attempt to escalate privileges to gain more control over the system.</li>
<li><code>Kernel Mode</code>: In contrast, kernel mode is a highly privileged mode where the Windows kernel runs. The kernel has unrestricted access to system resources, hardware, and critical functions. It provides core operating system services, manages system resources, and enforces security and stability. Device drivers, which facilitate communication with hardware devices, also run in kernel mode. If malware operates in kernel mode, it gains elevated control and can manipulate system behavior, conceal its presence, intercept system calls, and tamper with security mechanisms.</li>
</ul>
<h3 id="windows-architecture-at-a-high-level">Windows Architecture At A High Level</h3>
<p>The below image showcases a simplified version of Windows&#39; architecture.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/windows\_architecture.png" alt="Image"></p>
<p>The simplified Windows architecture comprises both user-mode and kernel-mode components, each with distinct responsibilities in the system&#39;s functioning.</p>
<h4 id="user-mode-components">User-mode Components</h4>
<p><code>User-mode components</code> are those parts of the operating system that don&#39;t have direct access to hardware or kernel data structures. They interact with system resources through APIs and system calls. Let&#39;s discuss some of them:</p>
<ul>
<li><code>System Support Processes</code>: These are essential components that provide crucial functionalities and services such as logon processes (<code>winlogon.exe</code>), Session Manager (<code>smss.exe</code>), and Service Control Manager (<code>services.exe</code>). These aren&#39;t Windows services but they are necessary for the proper functioning of the system.</li>
<li><code>Service Processes</code>: These processes host Windows services like the <code>Windows Update Service</code>, <code>Task Scheduler</code>, and <code>Print Spooler</code> services. They usually run in the background, executing tasks according to their configuration and parameters.</li>
<li><code>User Applications</code>: These are the processes created by user programs, including both 32-bit and 64-bit applications. They interact with the operating system through <a href="https://en.wikipedia.org/wiki/Windows\_API">APIs</a> provided by Windows. These API calls get redirected to <a href="https://en.wikipedia.org/wiki/Microsoft\_Windows\_library\_files#NTDLL.DLL">NTDLL.DLL</a>, triggering a transition from user mode to kernel mode, where the system call gets executed. The result is then returned to the user-mode application, and a transition back to user mode occurs.</li>
<li><code>Environment Subsystems</code>: These components are responsible for providing execution environments for specific types of applications or processes. They include the <a href="https://en.wikipedia.org/wiki/Architecture\_of\_Windows\_NT#Win32\_environment\_subsystem">Win32 Subsystem</a>, <a href="https://en.wikipedia.org/wiki/Microsoft\_POSIX\_subsystem">POSIX</a>, and <a href="https://en.wikipedia.org/wiki/OS/2">OS/2</a>.</li>
<li><code>Subsystem DLLs</code>: These dynamic-link libraries translate documented functions into appropriate internal native system calls, primarily implemented in <code>NTDLL.DLL</code>. Examples include <code>kernelbase.dll</code>, <code>user32.dll</code>, <code>wininet.dll</code>, and <code>advapi32.dll</code>.</li>
</ul>
<h4 id="kernel-mode-components">Kernel-mode Components</h4>
<p><code>Kernel-mode components</code> are those parts of the operating system that have direct access to hardware and kernel data structures. These include:</p>
<ul>
<li><code>Executive</code>: This upper layer in kernel mode gets accessed through functions from <code>NTDLL.DLL</code>. It consists of components like the <code>I/O Manager</code>, <code>Object Manager</code>, <code>Security Reference Monitor</code>, <code>Process Manager</code>, and others, managing the core aspects of the operating system such as I/O operations, object management, security, and processes. It runs some checks first, and then passes the call to kernel, or calls the appropriate device driver to perform the requested operation.</li>
<li><code>Kernel</code>: This component manages system resources, providing low-level services like <code>thread scheduling</code>, <code>interrupt and exception dispatching</code>, and <code>multiprocessor synchronization</code>.</li>
<li><code>Device Drivers</code>: These software components enable the OS to interact with hardware devices. They serve as intermediaries, allowing the system to manage and control hardware and software resources.</li>
<li><code>Hardware Abstraction Layer (HAL)</code>: This component provides an abstraction layer between the hardware devices and the OS. It allows software developers to interact with hardware in a consistent and platform-independent manner.</li>
<li><code>Windowing and Graphics System (Win32k.sys)</code>: This subsystem is responsible for managing the graphical user interface (GUI) and rendering visual elements on the screen.</li>
</ul>
<p>Now, let&#39;s discuss in what happens behind the scenes when an user application calls a Windows API function.</p>
<h3 id="windows-api-call-flow">Windows API Call Flow</h3>
<p>Malware often utilize Windows API calls to interact with the system and carry out malicious operations. By understanding the internal details of API functions, their parameters, and expected behavior, analysts can identify suspicious or unauthorized API usage.</p>
<p>Let&#39;s consider an example of a Windows API call flow, where a user-mode application tries to access privileged operations and system resources using the <a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-readprocessmemory">ReadProcessMemory function</a>. This function allows a process to read the memory of a different process.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/wininternals\_syscall.png" alt="Image"></p>
<p>When this function is called, some required parameters are also passed to it, such as the handle to the target process, the source address to read from, a buffer in its own memory space to store the read data, and the number of bytes to read. Below is the syntax of <code>ReadProcessMemory</code> WINAPI function as per Microsoft documentation.</p>
<p>Windows Internals</p>
<pre><code class="lang-shell-session"><span class="hljs-function">BOOL <span class="hljs-title">ReadProcessMemory</span>(<span class="hljs-params">
  [<span class="hljs-keyword">in</span>]  HANDLE  hProcess,
  [<span class="hljs-keyword">in</span>]  LPCVOID lpBaseAddress,
  [<span class="hljs-keyword">out</span>] LPVOID  lpBuffer,
  [<span class="hljs-keyword">in</span>]  SIZE_T  nSize,
  [<span class="hljs-keyword">out</span>] SIZE_T  *lpNumberOfBytesRead
</span>)</span>;
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/227/msdn\_003\_readprocessmemory.png" alt="Image"></p>
<p><code>ReadProcessMemory</code> is a Windows API function that belongs to the <code>kernel32.dll</code> library. So, this call is invoked via the <code>kernel32.dll</code> module which serves as the user mode interface to the Windows API. Internally, the <code>kernel32.dll</code> module interacts with the <code>NTDLL.DLL</code> module, which provides a lower-level interface to the Windows kernel. Then, this function request is translated to the corresponding Native API call, which is <code>NtReadVirtualMemory</code>. The below screenshot from <code>x64dbg</code> demonstrates how this looks like in a debugger.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/x64dbg\_readprocessmemory.png" alt="Image"></p>
<p>The <code>NTDLL.DLL</code> module utilizes system calls (syscalls).</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/msdn\_004\_syscall\_instruction.png" alt="Image"></p>
<p>The <code>syscall</code> instruction triggers the system call using the parameters set in the previous instructions. It transfers control from user mode to kernel mode, where the kernel performs the requested operation after validating the parameters and checking the access rights of the calling process.</p>
<p>If the request is authorized, the thread is transitioned from user mode into the kernel mode. The kernel maintains a table known as the <code>System Service Descriptor Table (SSDT)</code> or the <code>syscall table (System Call Table)</code>, which is a data structure that contains pointers to the various system service routines. These routines are responsible for handling system calls made by user-mode applications. Each entry in the syscall table corresponds to a specific system call number, and the associated pointer points to the corresponding kernel function that implements the requested operation.</p>
<p>The syscall responsible for <code>ReadProcessMemory</code> is executed in the kernel, where the Windows memory management and process isolation mechanisms are leveraged. The kernel performs necessary validations, access checks, and memory operations to read the memory from the target process. The kernel retrieves the physical memory pages corresponding to the requested virtual addresses and copies the data into the provided buffer.</p>
<p>Once the kernel has finished reading the memory, it transitions the thread back to user mode and control is handed back to the original user mode application. The application can then access the data that was read from the target process&#39;s memory and continue its execution.</p>
<p>Let&#39;s now navigate to the bottom of this section and click on &quot;Click here to spawn the target system!&quot;. Then, let&#39;s RDP into the Target IP using the provided credentials. The vast majority of the actions/commands covered from this point up to end of this section can be replicated inside the target, offering a more comprehensive grasp of the topics presented.</p>
<p>Windows Internals</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ xfreerdp /u</span><span class="hljs-symbol">:htb-student</span> /<span class="hljs-symbol">p:</span><span class="hljs-string">'HTB_@cademy_stdnt!'</span> /<span class="hljs-symbol">v:</span>[Target IP] /dynamic-resolution
</code></pre>
<h3 id="portable-executable">Portable Executable</h3>
<p>Windows operating systems employ the <code>Portable Executable (PE)</code> format to encapsulate executable programs, <code>DLLs (Dynamic Link Libraries)</code>, and other integral system components. In the realm of malware analysis, an intricate understanding of the PE file format is indispensable. It allows us to gain significant insights into the executable&#39;s structure, operations, and potential malign activities embedded within the file.</p>
<p>PE files accommodate a wide variety of data types including <code>executables (.exe)</code>, <code>dynamic link libraries (.dll)</code>, <code>kernel modules (.srv)</code>, <code>control panel applications (.cpl)</code>, and many more. The PE file format is fundamentally a data structure containing the vital information required for the Windows OS loader to manage the executable code, effectively loading it into memory.</p>
<h4 id="pe-sections">PE Sections</h4>
<p>The PE Structure also houses a <code>Section Table</code>, an element comprising several sections dedicated to distinct purposes. The sections are essentially the repositories where the actual content of the file, including the data, resources utilized by the program, and the executable code, is stored. The <code>.text</code> section is often under scrutiny for potential artifacts related to injection attacks.</p>
<p>Common PE sections include:</p>
<ul>
<li><code>Text Section (.text)</code>: The hub where the executable code of the program resides.</li>
<li><code>Data Section (.data)</code>: A storage for initialized global and static data variables.</li>
<li><code>Read-only initialized data (.rdata)</code>: Houses read-only data such as constant values, string literals, and initialized global and static variables.</li>
<li><code>Exception information (.pdata)</code>: A collection of function table entries utilized for exception handling.</li>
<li><code>BSS Section (.bss)</code>: Holds uninitialized global and static data variables.</li>
<li><code>Resource Section (.rsrc)</code>: Safeguards resources such as images, icons, strings, and version information.</li>
<li><code>Import Section (.idata)</code>: Details about functions imported from other DLLs.</li>
<li><code>Export Section (.edata)</code>: Information about functions exported by the executable.</li>
<li><code>Relocation Section (.reloc)</code>: Details for relocating the executable&#39;s code and data when loaded at a different memory address.</li>
</ul>
<p>We can visualize the sections of a portable executable using a tool like <code>pestudio</code> as demonstrated below.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/pe\_sections.png" alt="Image"></p>
<p>Delving into the Portable Executable (PE) file format is pivotal for malware analysis, offering insights into the file&#39;s structure, code analysis, import and export functions, resource analysis, anti-analysis techniques, and extraction of indicators of compromise. Our comprehension of this foundation paves the way for efficacious malware analysis.</p>
<h3 id="processes">Processes</h3>
<p>In the simplest terms, a process is an instance of an executing program. It represents a slice of a program&#39;s execution in memory and consists of various resources, including memory, file handles, threads, and security contexts.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/process\_internals.png" alt="Image"></p>
<p>Each process is characterized by:</p>
<ul>
<li><code>A unique PID (Process Identifier)</code>: A unique Process Identifier (PID) is assigned to each process within the operating system. This numeric identifier facilitates the tracking and management of the process by the operating system.</li>
<li><code>Virtual Address Space (VAS)</code>: In the Windows OS, every process is allocated its own virtual address space, offering a virtualized view of the memory for the process. The VAS is sectioned into segments, including code, data, and stack segments, allowing the process isolated memory access.</li>
<li><code>Executable Code (Image File on Disk)</code>: The executable code, or the image file, signifies the binary executable file stored on the disk. It houses the instructions and resources necessary for the process to operate.</li>
<li><code>Table of Handles to System Objects</code>: Processes maintain a table of handles, a reference catalogue for various system objects. System objects can span files, devices, registry keys, synchronization objects, and other resources.</li>
<li><code>Security Context (Access Token)</code>: Each process has a security context associated with it, embodied by an <code>Access Token</code>. This <code>Access Token</code> encapsulates information about the process&#39;s security privileges, including the user account under which the process operates and the access rights granted to the process.</li>
<li><code>One or More Threads Running in its Context</code>: Processes consist of one or more threads, where a thread embodies a unit of execution within the process. Threads enable concurrent execution within the process and facilitate multitasking.</li>
</ul>
<h3 id="dynamic-link-library-dll-">Dynamic-link library (DLL)</h3>
<p>A Dynamic-link library (DLL) is a type of PE which represents &quot;Microsoft&#39;s implementation of the shared library concept in the Microsoft Windows OS&quot;. DLLs expose an array of functions which can be exploited by malware, which weâ€™ll scrutinize later. First, let&#39;s unravel the import and export functions in a DLL.</p>
<h4 id="import-functions">Import Functions</h4>
<ul>
<li>Import functions are functionalities that a binary dynamically links to from external libraries or modules during runtime. These functions enable the binary to leverage the functionalities offered by these libraries.</li>
<li>During malware analysis, examining import functions may shed light on the external libraries or modules that the malware is dependent on. This information aids in identifying the APIs that the malware might interact with, and also the resources such as the file system, processes, registry etc.</li>
<li>By identifying specific functions imported, it becomes possible to ascertain the actions the malware can perform, such as file operations, network communication, registry manipulation, and more.</li>
<li>Import function names or hashes can serve as IOCs (Indicators of Compromise) that assist in identifying malware variants or related samples.</li>
</ul>
<p>Below is an example of identifying process injection using DLL imports and function names:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/process\_injection\_fn.png" alt="Image"></p>
<p>In this diagram, the malware process (<code>shell.exe</code>) performs process injection to inject code into a target process (<code>notepad.exe</code>) using the following functions imported from the DLL <code>kernel32.exe</code>:</p>
<ul>
<li><code>OpenProcess</code>: Opens a handle to the target process (notepad.exe), providing the necessary access rights to manipulate its memory.</li>
<li><code>VirtualAllocEx</code>: Allocates a block of memory within the address space of the target process to store the injected code.</li>
<li><code>WriteProcessMemory</code>: Writes the desired code into the allocated memory block of the target process.</li>
<li><code>CreateRemoteThread</code>: Creates a new thread within the target process, specifying the entry point of the injected code as the starting point.</li>
</ul>
<p>As a result, the injected code is executed within the context of the target process by the newly created remote thread. This technique allows the malware to run arbitrary code within the target process.</p>
<p>The functions above are WINAPI (Windows API) functions. Don&#39;t worry about WINAPI functions as of now. We&#39;ll discuss these in detail later.</p>
<p>We can examine the DLL imports of <code>shell.exe</code> (residing in the <code>C:\Samples\MalwareAnalysis</code> directory) using <code>CFF Explorer</code> (available at <code>C:\Tools\Explorer Suite</code>) as follows.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/imports\_.png" alt="Image"></p>
<h4 id="export-functions">Export Functions</h4>
<ul>
<li>Export functions are the functions that a binary exposes for use by other modules or applications.</li>
<li>These functions provide an interface for other software to interact with the binary.</li>
</ul>
<hr>
<p>In the below screenshot, we can see an example of DLL imports (using <code>CFF Explorer</code>) and exports (using <code>x64dbg</code> - <code>Symbols</code> tab):</p>
<ul>
<li><code>Imports</code>: This shows the DLLs and their functions imported by an executable <code>Utilman.exe</code>.</li>
<li><code>Exports</code>: This shows the functions exported by a DLL <code>Kernel32.dll</code>.</li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/227/dll\_imports\_exports.png" alt="Image"></p>
<p>In the context of malware analysis, understanding import and export functions assists in discerning the behavior, capabilities, and interactions of the binary with external entities. It yields valuable information for threat detection, classification, and gauging the impact of the malware on the system.</p>
<h2 id="static-analysis-on-linux">Static Analysis On Linux</h2>
<p>In the realm of malware analysis, we exercise a method called static analysis to scrutinize malware without necessitating its execution. This involves the meticulous investigation of malware&#39;s code, data, and structural components, serving as a vital precursor for further, more detailed analysis.</p>
<p>Through static analysis, we endeavor to extract pivotal information which includes:</p>
<ul>
<li>File type</li>
<li>File hash</li>
<li>Strings</li>
<li>Embedded elements</li>
<li>Packer information</li>
<li>Imports</li>
<li>Exports</li>
<li>Assembly code</li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/227/static\_analysis\_flow.png" alt="Image"></p>
<p>Let&#39;s now navigate to the bottom of this section and click on &quot;Click here to spawn the target system!&quot;. Then, let&#39;s SSH into the Target IP using the provided credentials. The vast majority of the actions/commands covered from this point up to end of this section can be replicated inside the target, offering a more comprehensive grasp of the topics presented.</p>
<h3 id="identifying-the-file-type">Identifying The File Type</h3>
<p>Our first port of call in this stage is to ascertain the rudimentary information about the malware specimen to lay the groundwork for our investigation. Given that file extensions can be manipulated and changed, our task is to devise a method to identify the actual file type we are encountering. Establishing the file type plays an integral role in static analysis, ensuring that the procedures we apply are appropriate and the results obtained are accurate.</p>
<p>Let&#39;s use a Windows-based malware named <code>Ransomware.wannacry.exe</code> residing in the <code>/home/htb-student/Samples/MalwareAnalysis</code> directory of this section&#39;s target as an illustration.</p>
<p>The command for checking the file type of this malware would be the following.</p>
<p>Static Analysis On Linux</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ file /</span>home<span class="hljs-regexp">/htb-student/</span>Samples<span class="hljs-regexp">/MalwareAnalysis/</span>Ransomware.wannacry.exe
<span class="hljs-regexp">/home/</span>htb-student<span class="hljs-regexp">/Samples/</span>MalwareAnalysis/Ransomware.wannacry.<span class="hljs-string">exe:</span> PE32 executable (GUI) Intel <span class="hljs-number">80386</span>, <span class="hljs-keyword">for</span> MS Windows
</code></pre>
<p>We can also do the same by manually checking the header with the help of the <code>hexdump</code> command as follows.</p>
<p>Static Analysis On Linux</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ hexdump -C /home/htb-student/Samples/MalwareAnalysis/Ransomware.wannacry.exe | more
<span class="hljs-number">00000000</span>  <span class="hljs-number">4</span>d <span class="hljs-number">5</span>a <span class="hljs-number">90</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">04</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ff ff <span class="hljs-number">00</span> <span class="hljs-number">00</span>  |MZ..............|
<span class="hljs-number">00000010</span>  b8 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  |........@.......|
<span class="hljs-number">00000020</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  |................|
<span class="hljs-number">00000030</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> f8 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  |................|
<span class="hljs-number">00000040</span>  <span class="hljs-number">0</span>e <span class="hljs-number">1</span>f ba <span class="hljs-number">0</span>e <span class="hljs-number">00</span> b4 <span class="hljs-number">09</span> cd  <span class="hljs-number">21</span> b8 <span class="hljs-number">01</span> <span class="hljs-number">4</span>c cd <span class="hljs-number">21</span> <span class="hljs-number">54</span> <span class="hljs-number">68</span>  |........!..L.!Th|
<span class="hljs-number">00000050</span>  <span class="hljs-number">69</span> <span class="hljs-number">73</span> <span class="hljs-number">20</span> <span class="hljs-number">70</span> <span class="hljs-number">72</span> <span class="hljs-number">6</span>f <span class="hljs-number">67</span> <span class="hljs-number">72</span>  <span class="hljs-number">61</span> <span class="hljs-number">6</span>d <span class="hljs-number">20</span> <span class="hljs-number">63</span> <span class="hljs-number">61</span> <span class="hljs-number">6</span>e <span class="hljs-number">6</span>e <span class="hljs-number">6</span>f  |is program canno|
<span class="hljs-number">00000060</span>  <span class="hljs-number">74</span> <span class="hljs-number">20</span> <span class="hljs-number">62</span> <span class="hljs-number">65</span> <span class="hljs-number">20</span> <span class="hljs-number">72</span> <span class="hljs-number">75</span> <span class="hljs-number">6</span>e  <span class="hljs-number">20</span> <span class="hljs-number">69</span> <span class="hljs-number">6</span>e <span class="hljs-number">20</span> <span class="hljs-number">44</span> <span class="hljs-number">4</span>f <span class="hljs-number">53</span> <span class="hljs-number">20</span>  |t be run in DOS |
<span class="hljs-number">00000070</span>  <span class="hljs-number">6</span>d <span class="hljs-number">6</span>f <span class="hljs-number">64</span> <span class="hljs-number">65</span> <span class="hljs-number">2</span>e <span class="hljs-number">0</span>d <span class="hljs-number">0</span>d <span class="hljs-number">0</span>a  <span class="hljs-number">24</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  |mode....$.......|
<span class="hljs-number">00000080</span>  <span class="hljs-number">55</span> <span class="hljs-number">3</span>c <span class="hljs-number">53</span> <span class="hljs-number">90</span> <span class="hljs-number">11</span> <span class="hljs-number">5</span>d <span class="hljs-number">3</span>d c3  <span class="hljs-number">11</span> <span class="hljs-number">5</span>d <span class="hljs-number">3</span>d c3 <span class="hljs-number">11</span> <span class="hljs-number">5</span>d <span class="hljs-number">3</span>d c3  |U&lt;S..]=..]=..]=.|
<span class="hljs-number">00000090</span>  <span class="hljs-number">6</span>a <span class="hljs-number">41</span> <span class="hljs-number">31</span> c3 <span class="hljs-number">10</span> <span class="hljs-number">5</span>d <span class="hljs-number">3</span>d c3  <span class="hljs-number">92</span> <span class="hljs-number">41</span> <span class="hljs-number">33</span> c3 <span class="hljs-number">15</span> <span class="hljs-number">5</span>d <span class="hljs-number">3</span>d c3  |jA1..]=..A3..]=.|
<span class="hljs-number">000000</span>a0  <span class="hljs-number">7</span>e <span class="hljs-number">42</span> <span class="hljs-number">37</span> c3 <span class="hljs-number">1</span>a <span class="hljs-number">5</span>d <span class="hljs-number">3</span>d c3  <span class="hljs-number">7</span>e <span class="hljs-number">42</span> <span class="hljs-number">36</span> c3 <span class="hljs-number">10</span> <span class="hljs-number">5</span>d <span class="hljs-number">3</span>d c3  |~B7..]=.~B6..]=.|
<span class="hljs-number">000000</span>b0  <span class="hljs-number">7</span>e <span class="hljs-number">42</span> <span class="hljs-number">39</span> c3 <span class="hljs-number">15</span> <span class="hljs-number">5</span>d <span class="hljs-number">3</span>d c3  d2 <span class="hljs-number">52</span> <span class="hljs-number">60</span> c3 <span class="hljs-number">1</span>a <span class="hljs-number">5</span>d <span class="hljs-number">3</span>d c3  |~B9..]=..R`..]=.|
<span class="hljs-number">000000</span>c0  <span class="hljs-number">11</span> <span class="hljs-number">5</span>d <span class="hljs-number">3</span>c c3 <span class="hljs-number">4</span>a <span class="hljs-number">5</span>d <span class="hljs-number">3</span>d c3  <span class="hljs-number">27</span> <span class="hljs-number">7</span>b <span class="hljs-number">36</span> c3 <span class="hljs-number">10</span> <span class="hljs-number">5</span>d <span class="hljs-number">3</span>d c3  |.]&lt;.J]=.'{<span class="hljs-number">6.</span>.]=.|
<span class="hljs-number">000000</span>d0  d6 <span class="hljs-number">5</span>b <span class="hljs-number">3</span>b c3 <span class="hljs-number">10</span> <span class="hljs-number">5</span>d <span class="hljs-number">3</span>d c3  <span class="hljs-number">52</span> <span class="hljs-number">69</span> <span class="hljs-number">63</span> <span class="hljs-number">68</span> <span class="hljs-number">11</span> <span class="hljs-number">5</span>d <span class="hljs-number">3</span>d c3  |.[;..]=.Rich.]=.|
<span class="hljs-number">000000e0</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  |................|
<span class="hljs-number">000000</span>f0  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">50</span> <span class="hljs-number">45</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">4</span>c <span class="hljs-number">01</span> <span class="hljs-number">04</span> <span class="hljs-number">00</span>  |........PE..L...|
<span class="hljs-number">00000100</span>  cc <span class="hljs-number">8</span>e e7 <span class="hljs-number">4</span>c <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> e0 <span class="hljs-number">00</span> <span class="hljs-number">0</span>f <span class="hljs-number">01</span>  |...L............|
<span class="hljs-number">00000110</span>  <span class="hljs-number">0</span>b <span class="hljs-number">01</span> <span class="hljs-number">06</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">90</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">30</span> <span class="hljs-number">38</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  |........<span class="hljs-number">.08</span>.....|
<span class="hljs-number">00000120</span>  <span class="hljs-number">16</span> <span class="hljs-number">9</span>a <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> a0 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span>  |..............@.|
<span class="hljs-number">00000130</span>  <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">04</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  |................|
<span class="hljs-number">00000140</span>  <span class="hljs-number">04</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> b0 <span class="hljs-number">66</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  |..........f.....|
<span class="hljs-number">00000150</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  |................|
<span class="hljs-number">00000160</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  |................|
<span class="hljs-number">00000170</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  e0 a1 <span class="hljs-number">00</span> <span class="hljs-number">00</span> a0 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  |................|
<span class="hljs-number">00000180</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">31</span> <span class="hljs-number">00</span> <span class="hljs-number">54</span> a4 <span class="hljs-number">35</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  |.<span class="hljs-number">.1</span>.T<span class="hljs-number">.5</span>.........|
<span class="hljs-number">00000190</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  |................|
*
</code></pre>
<p>On a Windows system, the presence of the ASCII string <code>MZ</code> (in hexadecimal: <code>4D 5A</code>) at the start of a file (known as the &quot;magic number&quot;) denotes an executable file. <code>MZ</code> stands for Mark Zbikowski, a key architect of MS-DOS.</p>
<h3 id="malware-fingerprinting">Malware Fingerprinting</h3>
<p>In this stage, our mission is to create a unique identifier for the malware sample. This typically takes the form of a cryptographic hash - MD5, SHA1, or SHA256.</p>
<p>Fingerprinting is employed for numerous purposes, encompassing:</p>
<ul>
<li>Identification and tracking of malware samples</li>
<li>Scanning an entire system for the presence of identical malware</li>
<li>Confirmation of previous encounters and analyses of the same malware</li>
<li>Sharing with stakeholders as IoC (Indicators of Compromise) or as part of threat intelligence reports</li>
</ul>
<p>As an illustration, to check the MD5 file hash of the abovementioned malware the command would be the following.</p>
<p>Static Analysis On Linux</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ md5sum /</span>home<span class="hljs-regexp">/htb-student/</span>Samples<span class="hljs-regexp">/MalwareAnalysis/</span>Ransomware.wannacry.exe
db349b97c37d22f5ea1d1841e3c89eb4  <span class="hljs-regexp">/home/</span>htb-student<span class="hljs-regexp">/Samples/</span>MalwareAnalysis/Ransomware.wannacry.exe
</code></pre>
<p>To check the SHA256 file hash of the abovementioned malware the command would be the following.</p>
<p>Static Analysis On Linux</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sha256sum /</span>home<span class="hljs-regexp">/htb-student/</span>Samples<span class="hljs-regexp">/MalwareAnalysis/</span>Ransomware.wannacry.exe
<span class="hljs-number">24</span>d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c  <span class="hljs-regexp">/home/</span>htb-student<span class="hljs-regexp">/Samples/</span>MalwareAnalysis/Ransomware.wannacry.exe
</code></pre>
<h3 id="file-hash-lookup">File Hash Lookup</h3>
<p>The ensuing step involves checking the file hash produced in the prior step against online malware scanners and sandboxes such as Cuckoo sandbox. For instance, VirusTotal, an online malware scanning engine, which collaborates with various antivirus vendors, allows us to search for the file hash. This step aids us in comparing our results with existing knowledge about the malware sample.</p>
<p>The following image displays the results from <a href="https://www.virustotal.com/gui/home/search">VirusTotal</a> after the SHA256 file hash of the aforementioned malware was submitted.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/virustotal\_scan.png" alt="Image"></p>
<p>Even though a file hash like MD5, SHA1, or SHA256 is valuable for identifying identical samples with disparate names, it falls short when identifying similar malware samples. This is primarily because a malware author can alter the file hash value by making minor modifications to the code and recompiling it.</p>
<p>Nonetheless, there exist techniques that can aid in identifying similar samples:</p>
<h4 id="import-hashing-imphash-">Import Hashing (IMPHASH)</h4>
<p><code>IMPHASH</code>, an abbreviation for &quot;Import Hash&quot;, is a cryptographic hash calculated from the import functions of a Windows Portable Executable (PE) file. Its algorithm functions by first converting all imported function names to lowercase. Following this, the DLL names and function names are fused together and arranged in alphabetical order. Finally, an MD5 hash is generated from the resulting string. Therefore, two PE files with identical import functions, in the same sequence, will share an <code>IMPHASH</code> value.</p>
<p>We can find the <code>IMPHASH</code> in the <code>Details</code> tab of the VirusTotal results.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/imphash\_vt1.png" alt="Image"></p>
<p>Note that we can also use the <a href="https://pypi.org/project/pefile/">pefile</a> Python module to compute the IMPHASH of a file as follows.</p>
<p>Code: python</p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> pefile
<span class="hljs-keyword">import</span> peutils

pe_file = sys.argv[<span class="hljs-number">1</span>]
pe = pefile.<span class="hljs-type">PE</span>(pe_file)
imphash = pe.get_imphash()

<span class="hljs-built_in">print</span>(imphash)
</code></pre>
<p>To check the IMPHASH of the abovementioned <a href="https://www.fortinet.com/resources/cyberglossary/wannacry-ransomware-attack">WannaCry</a> malware the command would be the following. <code>imphash_calc.py</code> (available at <code>/home/htb-student</code>) contains the Python code above.</p>
<p>Static Analysis On Linux</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ python3 imphash_calc<span class="hljs-selector-class">.py</span> /home/htb-student/Samples/MalwareAnalysis/Ransomware<span class="hljs-selector-class">.wannacry</span><span class="hljs-selector-class">.exe</span>
<span class="hljs-number">9</span>ecee117164e0b870a53dd187cdd7174
</code></pre>
<h4 id="fuzzy-hashing-ssdeep-">Fuzzy Hashing (SSDEEP)</h4>
<p><code>Fuzzy Hashing (SSDEEP)</code>, also referred to as context-triggered piecewise hashing (CTPH), is a hashing technique designed to compute a hash value indicative of content similarity between two files. This technique dissects a file into smaller, fixed-size blocks and calculates a hash for each block. The resulting hash values are then consolidated to generate the final fuzzy hash.</p>
<p>The <code>SSDEEP</code> algorithm allocates more weight to longer sequences of common blocks, making it highly effective in identifying files that have undergone minor modifications, or are similar but not identical, such as different variations of a malicious sample.</p>
<p>We can find the <code>SSDEEP</code> hash of a malware in the <code>Details</code> tab of the VirusTotal results.</p>
<p>We can also use the <code>ssdeep</code> command to calculate the <code>SSDEEP</code> hash of a file. To check the <code>SSDEEP</code> hash of the abovementioned WannaCry malware the command would be the following.</p>
<p>Static Analysis On Linux</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ ssdeep /</span>home<span class="hljs-regexp">/htb-student/</span>Samples<span class="hljs-regexp">/MalwareAnalysis/</span>Ransomware.wannacry.exe
ssdeep,<span class="hljs-number">1.1</span>--<span class="hljs-string">blocksize:</span><span class="hljs-string">hash:</span>hash,filename
<span class="hljs-number">98304</span>:<span class="hljs-string">wDqPoBhz1aRxcSUDk36SAEdhvxWa9P593R8yAVp2g3R:</span>wDqPe1Cxcxk3ZAEUadzR8yc4gB,<span class="hljs-string">"/home/htb-student/Samples/MalwareAnalysis/Ransomware.wannacry.exe"</span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ssdeep\_vt1.png" alt="Image"></p>
<p>The command line arguments <code>-pb</code> can be used to initiate matching mode in <code>SSDEEP</code> (while we are on the directory where the malware samples are stored - <code>/home/htb-student/Samples/MalwareAnalysis</code> in our case).</p>
<p>Static Analysis On Linux</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ssdeep -pb *
potato.<span class="hljs-keyword">exe</span> matches svchost.<span class="hljs-keyword">exe</span> (<span class="hljs-number">99</span>)

svchost.<span class="hljs-keyword">exe</span> matches potato.<span class="hljs-keyword">exe</span> (<span class="hljs-number">99</span>)
</code></pre>
<p><code>-p</code> denotes Pretty matching mode, and <code>-b</code> is used to display only the file names, sans the full path.</p>
<p>In the example above, a 99% similarity was observed between two malware samples (<code>svchost.exe</code> and <code>potato.exe</code>) using <code>SSDEEP</code>.</p>
<h4 id="section-hashing-hashing-pe-sections-">Section Hashing (Hashing PE Sections)</h4>
<p><code>Section hashing</code>, (hashing PE sections) is a powerful technique that allows analysts to identify sections of a Portable Executable (PE) file that have been modified. This can be particularly useful for identifying minor variations in malware samples, a common tactic employed by attackers to evade detection.</p>
<p>The <code>Section Hashing</code> technique works by calculating the cryptographic hash of each of these sections. When comparing two PE files, if the hash of corresponding sections in the two files matches, it suggests that the particular section has not been modified between the two versions of the file.</p>
<p>By applying <code>section hashing</code>, security analysts can identify parts of a PE file that have been tampered with or altered. This can help identify similar malware samples, even if they have been slightly modified to evade traditional signature-based detection methods.</p>
<p>Tools such as <code>pefile</code> in Python can be used to perform <code>section hashing</code>. In Python, for example, you can use the pefile module to access and hash the data in individual sections of a PE file as follows.</p>
<p>Code: python</p>
<pre><code class="lang-python">import sys
import pefile
pe_file = sys<span class="hljs-selector-class">.argv</span>[<span class="hljs-number">1</span>]
pe = pefile.PE(pe_file)
<span class="hljs-keyword">for</span> <span class="hljs-selector-tag">section</span> <span class="hljs-keyword">in</span> pe<span class="hljs-selector-class">.sections</span>:
    print (<span class="hljs-selector-tag">section</span><span class="hljs-selector-class">.Name</span>, <span class="hljs-string">"MD5 hash:"</span>, <span class="hljs-selector-tag">section</span>.get_hash_md5())
    print (<span class="hljs-selector-tag">section</span><span class="hljs-selector-class">.Name</span>, <span class="hljs-string">"SHA256 hash:"</span>, <span class="hljs-selector-tag">section</span>.get_hash_sha256())
</code></pre>
<p>Remember that while <code>section hashing</code> is a powerful technique, it is not foolproof. Malware authors might employ tactics like section name obfuscation or dynamically generating section names to try and bypass this kind of analysis.</p>
<p>As an illustration, to check the MD5 and SHA256 PE section hashes of a Wannacry executable stored in the <code>/home/htb-student/Samples/MalwareAnalysis</code> directory, the command would be the following. <code>section_hashing.py</code> (available at <code>/home/htb-student</code>) contains the Python code above.</p>
<p>Static Analysis On Linux</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ python3 section_hashing.py /home/htb-student/Samples/MalwareAnalysis/Ransomware.wannacry.exe
b'.text<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00' MD5 hash: c7613102e2ecec5dcefc144f83189153
b'.text<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00' SHA256 hash: 7609ecc798a357dd1a2f0134f9a6ea06511a8885ec322c7acd0d84c569398678
b'.rdata<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00' MD5 hash: d8037d744b539326c06e897625751cc9
b'.rdata<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00' SHA256 hash: 532e9419f23eaf5eb0e8828b211a7164cbf80ad54461bc748c1ec2349552e6a2
b'.data<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00' MD5 hash: 22a8598dc29cad7078c291e94612ce26
b'.data<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00' SHA256 hash: 6f93fb1b241a990ecc281f9c782f0da471628f6068925aaf580c1b1de86bce8a
b'.rsrc<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00' MD5 hash: 12e1bd7375d82cca3a51ca48fe22d1a9
b'.rsrc<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00' SHA256 hash: 1efe677209c1284357ef0c7996a1318b7de3836dfb11f97d85335d6d3b8a8e42
</code></pre>
<h3 id="string-analysis">String Analysis</h3>
<p>In this phase, our objective is to extract strings (ASCII &amp; Unicode) from a binary. Strings can furnish clues and valuable insight into the functionality of the malware. Occasionally, we can unearth unique embedded strings in a malware sample, such as:</p>
<ul>
<li>Embedded filenames (e.g., dropped files)</li>
<li>IP addresses or domain names</li>
<li>Registry paths or keys</li>
<li>Windows API functions</li>
<li>Command-line arguments</li>
<li>Unique information that might hint at a particular threat actor</li>
</ul>
<p>The Linux <code>strings</code> command can be deployed to display the strings contained within a malware. For instance, the command below will reveal strings for a ransomware sample named <code>dharma_sample.exe</code> residing in the <code>/home/htb-student/Samples/MalwareAnalysis</code> directory of this section&#39;s target.</p>
<p>Static Analysis On Linux</p>
<pre><code class="lang-shell-session">root<span class="hljs-comment">@htb[/htb]$ strings -n 15 /home/htb-student/Samples/MalwareAnalysis/dharma_sample.exe
!This program cannot be run in DOS mode.
@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span>&gt;<span class="hljs-comment">@@</span><span class="hljs-comment">@?456789:;&lt;=@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span>
!<span class="hljs-string">"#$%&amp;'()*+,-./0123@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/
WaitForSingleObject
InitializeCriticalSectionAndSpinCount
LeaveCriticalSection
EnterCriticalSection
C:\crysis\Release\PDB\payload.pdb
0123456789ABCDEF</span>
</code></pre>
<p><code>-n</code> specifies to print a sequence of at least the number specified - in our case, <code>15</code>.</p>
<p>Occasionally, string analysis can facilitate the linkage of a malware sample to a specific threat group if significant similarities are identified. For <a href="https://thedfirreport.com/2020/06/16/the-little-ransomware-that-couldnt-dharma/">example</a>, in the link provided, a string containing a PDB path was used to link the malware sample to the Dharma/Crysis family of ransomware.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/dharma.png" alt="Image"></p>
<hr>
<p>It should be noted that another string analysis solution exists called <code>FLOSS</code>. <code>FLOSS</code>, short for &quot;FireEye Labs Obfuscated String Solver&quot;, is a tool developed by FireEye&#39;s FLARE team to automatically deobfuscate strings in malware. It&#39;s designed to supplement the use of traditional string tools, like the strings command in Unix-based systems, which can miss obfuscated strings that are commonly used by malware to evade detection.</p>
<p>For instance, the command below will reveal strings for a ransomware sample named <code>dharma_sample.exe</code> residing in the <code>/home/htb-student/Samples/MalwareAnalysis</code> directory of this section&#39;s target.</p>
<p>Static Analysis On Linux</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ floss /home/htb-student/Samples/MalwareAnalysis/dharma<span class="hljs-emphasis">_sample.exe
INFO: floss: extracting static strings...
finding decoding function features: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 238/238 [00:00&lt;00:00, 838.37 functions/s, skipped 5 library functions (2%)]
INFO: floss.stackstrings: extracting stackstrings from 223 functions
INFO: floss.results: %sh(
extracting stackstrings: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 223/223 [00:01&lt;00:00, 133.51 functions/s]
INFO: floss.tightstrings: extracting tightstrings from 10 functions...
extracting tightstrings from function 0x4065e0: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 10/10 [00:01&lt;00:00,  5.91 functions/s]
INFO: floss.string_</span>decoder: decoding strings
INFO: floss.results: EEED
INFO: floss.results: EEEDnnn
INFO: floss.results: uOKm
INFO: floss.results: %sh(
INFO: floss.results: uBIA
INFO: floss.results: uBIA
INFO: floss.results: \t\t\t\t\t\t\t\t
emulating function 0x405840 (call 4/9): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 25/25 [00:11&lt;00:00,  2.19 functions/s]
INFO: floss: finished execution after 23.56 seconds

<span class="hljs-section">FLARE FLOSS RESULTS (version v2.0.0-0-gdd9bea8)
+------------------------+------------------------------------------------------------------------------------+</span>
| file path              | /home/htb-student/Samples/MalwareAnalysis/dharma<span class="hljs-emphasis">_sample.exe                        |
| extracted strings      |                                                                                    |
|  static strings        | 720                                                                                |
|  stack strings         | 1                                                                                  |
|  tight strings         | 0                                                                                  |
|  decoded strings       | 7                                                                                  |
+------------------------+------------------------------------------------------------------------------------+

</span><span class="hljs-code">------------------------------
| FLOSS STATIC STRINGS (720) |
------------------------------</span>
<span class="hljs-code">-----------------------------
| FLOSS ASCII STRINGS (716) |
-----------------------------</span>
!This program cannot be run in DOS mode.
Rich
<span class="hljs-title">.text</span>
`.rdata
@.data
9A s
9A$v
A +B$
---SNIP---
+o*7
0123456789ABCDEF

<span class="hljs-code">------------------------------
| FLOSS UTF-16LE STRINGS (4) |
------------------------------</span>
jjjj
%sh(
ssbss
0123456789ABCDEF

<span class="hljs-code">---------------------------
| FLOSS STACK STRINGS (1) |
---------------------------</span>
%sh(

<span class="hljs-code">---------------------------
| FLOSS TIGHT STRINGS (0) |
---------------------------</span>

<span class="hljs-code">-----------------------------
| FLOSS DECODED STRINGS (7) |
-----------------------------</span>
EEED
EEEDnnn
uOKm
%sh(
uBIA
uBIA
\t\t\t\t\t\t\t\t
</code></pre>
<h3 id="unpacking-upx-packed-malware">Unpacking UPX-packed Malware</h3>
<p>In our static analysis, we might stumble upon a malware sample that&#39;s been compressed or obfuscated using a technique referred to as packing. Packing serves several purposes:</p>
<ul>
<li>It obfuscates the code, making it more challenging to discern its structure or functionality.</li>
<li>It reduces the size of the executable, making it quicker to transfer or less conspicuous.</li>
<li>It confounds security researchers by hindering traditional reverse engineering attempts.</li>
</ul>
<p>This can impair string analysis because the references to strings are typically obscured or eliminated. It also replaces or camouflages conventional PE sections with a compact loader stub, which retrieves the original code from a compressed data section. As a result, the malware file becomes both smaller and more difficult to analyze, as the original code isn&#39;t directly observable.</p>
<p>A popular packer used in many malware variants is the <code>Ultimate Packer for Executables (UPX)</code>.</p>
<p>Let&#39;s first see what happens when we run the <code>strings</code> command on a UPX-packed malware sample named <code>credential_stealer.exe</code> residing in the <code>/home/htb-student/Samples/MalwareAnalysis/packed</code> directory of this section&#39;s target.</p>
<p>Static Analysis On Linux</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ strings /home</span><span class="hljs-regexp">/htb-student/</span>Samples/MalwareAnalysis/packed/credential_stealer.exe
!This program cannot be run <span class="hljs-keyword">in</span> DOS mode.
UPX<span class="hljs-number">0</span>
UPX1
UPX2
<span class="hljs-number">3.96</span>
UPX!
<span class="hljs-number">8</span>MZu
HcP&lt;H
VDgxt
<span class="hljs-variable">$ </span>/uX
OAUATUWVSH
%0rv
o?H9
c`fG
[^<span class="hljs-number">_</span>]A\A]
&gt; -P
        fo{Wnl
c9<span class="hljs-string">"^$!=
v/7&gt;
07ZC
_L$AAl
mug.%(
#8%,X
e]'^
---SNIP---</span>
</code></pre>
<p>Observe the strings that include <code>UPX</code>, and take note that the remainder of the output doesn&#39;t yield any valuable information regarding the functionality of the malware.</p>
<p>We can unpack the malware using the <code>UPX</code> tool with the following command (while we are on the directory where the packed malware samples are stored - <code>/home/htb-student/Samples/MalwareAnalysis/packed</code> in our case).</p>
<p>Static Analysis On Linux</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ upx -d -o unpacked_credential_stealer.exe credential_stealer.exe
                       Ultimate Packer for eXecutables
                          Copyright (C) <span class="hljs-number">1996</span> - <span class="hljs-number">2020</span>
UPX <span class="hljs-number">3.96</span>        Markus Oberhumer, Laszlo Molnar &amp; John Reiser   Jan <span class="hljs-number">23</span>rd <span class="hljs-number">2020</span>

        File size         Ratio      Format      Name
   --------------------   ------   -----------   -----------
     <span class="hljs-number">16896</span> &lt;-      <span class="hljs-number">8704</span>   <span class="hljs-number">51.52</span>%    win64/pe     unpacked_credential_stealer.exe

Unpacked <span class="hljs-number">1</span> file.
</code></pre>
<p>Let&#39;s now run the <code>strings</code> command on the unpacked sample.</p>
<p>Static Analysis On Linux</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ strings unpacked_credential_stealer.exe
!This program cannot be run <span class="hljs-keyword">in</span> DOS mode.
.<span class="hljs-keyword">text</span>
P<span class="hljs-string">`.data
.rdata
`</span>@.pdata
<span class="hljs-number">0</span>@.xdata
<span class="hljs-number">0</span>@.bss
.idata
.CRT
.tls
---SNIP---
AVAUATH
@A\A]A^
SeDebugPrivilege
SE Debug Privilege is adjusted
lsass.exe
Searching lsass PID
Lsass PID is: %lu
Error is - %lu
lsassmem.dmp
LSASS Memory is dumped successfully
Err <span class="hljs-number">2</span>: %lu
Unknown <span class="hljs-keyword">error</span>
Argument domain <span class="hljs-keyword">error</span> (DOMAIN)
Overflow range <span class="hljs-keyword">error</span> (OVERFLOW)
Partial loss of significance (PLOSS)
Total loss of significance (TLOSS)
The result is too small to be represented (UNDERFLOW)
Argument singularity (SIGN)
_matherr(): %s <span class="hljs-keyword">in</span> %s(%g, %g)  (retval=%g)
Mingw-w64 runtime failure:
Address %p has no <span class="hljs-keyword">image</span>-section
  VirtualQuery failed <span class="hljs-keyword">for</span> %d bytes at address %p
  VirtualProtect failed with code <span class="hljs-number">0</span>x%x
  Unknown pseudo relocation protocol version %d.
  Unknown pseudo relocation bit <span class="hljs-keyword">size</span> %d.
.pdata
AdjustTokenPrivileges
LookupPrivilegeValueA
OpenProcessToken
MiniDumpWriteDump
CloseHandle
CreateFileA
CreateToolhelp32Snapshot
DeleteCriticalSection
EnterCriticalSection
GetCurrentProcess
GetCurrentProcessId
GetCurrentThreadId
GetLastError
GetStartupInfoA
GetSystemTimeAsFileTime
GetTickCount
InitializeCriticalSection
LeaveCriticalSection
OpenProcess
Process32First
Process32Next
QueryPerformanceCounter
RtlAddFunctionTable
RtlCaptureContext
RtlLookupFunctionEntry
RtlVirtualUnwind
SetUnhandledExceptionFilter
Sleep
TerminateProcess
TlsGetValue
UnhandledExceptionFilter
VirtualProtect
VirtualQuery
__C_specific_handler
__getmainargs
__initenv
__iob_func
__lconv_init
__set_app_type
__setusermatherr
_acmdln
_amsg_exit
_cexit
_fmode
_initterm
_onexit
abort
calloc
exit
fprintf
free
<span class="hljs-keyword">fwrite</span>
malloc
memcpy
printf
puts
signal
<span class="hljs-keyword">strcmp</span>
strlen
strncmp
vfprintf
ADVAPI32.dll
dbghelp.dll
KERNEL32.DLL
msvcrt.dll
</code></pre>
<p>Now, we observe a more comprehensible output that includes the actual strings present in the sample.</p>
<h2 id="static-analysis-on-windows">Static Analysis On Windows</h2>
<p>In this segment, our focus will be on reproducing some of the static analysis tasks we carried out on a Linux machine, but this time, we&#39;ll be employing a Windows machine.</p>
<p>Let&#39;s now navigate to the bottom of this section and click on &quot;Click here to spawn the target system!&quot;. Then, let&#39;s RDP into the Target IP using the provided credentials. The vast majority of the actions/commands covered from this point up to end of this section can be replicated inside the target, offering a more comprehensive grasp of the topics presented.</p>
<p>Static Analysis On Windows</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ xfreerdp /u</span><span class="hljs-symbol">:htb-student</span> /<span class="hljs-symbol">p:</span><span class="hljs-string">'HTB_@cademy_stdnt!'</span> /<span class="hljs-symbol">v:</span>[Target IP] /dynamic-resolution
</code></pre>
<h3 id="identifying-the-file-type">Identifying The File Type</h3>
<p>Our first port of call in this stage is to ascertain the rudimentary information about the malware specimen to lay the groundwork for our investigation. Given that file extensions can be manipulated and changed, our task is to devise a method to identify the actual file type we are encountering. Establishing the file type plays an integral role in static analysis, ensuring that the procedures we apply are appropriate and the results obtained are accurate.</p>
<p>Let&#39;s use a Windows-based malware named <code>Ransomware.wannacry.exe</code> residing in the <code>C:\Samples\MalwareAnalysis</code> directory of this section&#39;s target as an illustration.</p>
<p>We can use a solution like <code>CFF Explorer</code> (available at <code>C:\Tools\Explorer Suite</code>) to check the file type of this malware as follows.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/filetype1.png" alt="Image"></p>
<p>On a Windows system, the presence of the ASCII string <code>MZ</code> (in hexadecimal: <code>4D 5A</code>) at the start of a file (known as the &quot;magic number&quot;) denotes an executable file. <code>MZ</code> stands for Mark Zbikowski, a key architect of MS-DOS.</p>
<h3 id="malware-fingerprinting">Malware Fingerprinting</h3>
<p>In this stage, our mission is to create a unique identifier for the malware sample. This typically takes the form of a cryptographic hash - MD5, SHA1, or SHA256.</p>
<p>Fingerprinting is employed for numerous purposes, encompassing:</p>
<ul>
<li>Identification and tracking of malware samples</li>
<li>Scanning an entire system for the presence of identical malware</li>
<li>Confirmation of previous encounters and analyses of the same malware</li>
<li>Sharing with stakeholders as IoC (Indicators of Compromise) or as part of threat intelligence reports</li>
</ul>
<p>As an illustration, to check the MD5 file hash of the abovementioned malware we can use the <code>Get-FileHash</code> PowerShell cmdlet as follows.</p>
<p>Static Analysis On Windows</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb-student&gt; Get-FileHash -Algorithm MD5 C:<span class="hljs-symbol">\S</span>amples<span class="hljs-symbol">\M</span>alwareAnalysis<span class="hljs-symbol">\R</span>ansomware.wannacry.exe

Algorithm       Hash                                                                   Path
---------       ----                                                                   ----
MD5             DB349B97C37D22F5EA1D1841E3C89EB4                                       C:<span class="hljs-symbol">\S</span>amples<span class="hljs-symbol">\M</span>alwareAnalysis<span class="hljs-symbol">\R</span>a...
</code></pre>
<p>To check the SHA256 file hash of the abovementioned malware the command would be the following.</p>
<p>Static Analysis On Windows</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb-student&gt; Get-FileHash -Algorithm SHA256 C:<span class="hljs-symbol">\S</span>amples<span class="hljs-symbol">\M</span>alwareAnalysis<span class="hljs-symbol">\R</span>ansomware.wannacry.exe

Algorithm       Hash                                                                   Path
---------       ----                                                                   ----
SHA256          24D004A104D4D54034DBCFFC2A4B19A11F39008A575AA614EA04703480B1022C       C:<span class="hljs-symbol">\S</span>amples<span class="hljs-symbol">\M</span>alwareAnalysis<span class="hljs-symbol">\R</span>a...
</code></pre>
<h3 id="file-hash-lookup">File Hash Lookup</h3>
<p>The ensuing step involves checking the file hash produced in the prior step against online malware scanners and sandboxes such as Cuckoo sandbox. For instance, VirusTotal, an online malware scanning engine, which collaborates with various antivirus vendors, allows us to search for the file hash. This step aids us in comparing our results with existing knowledge about the malware sample.</p>
<p>The following image displays the results from <a href="https://www.virustotal.com/gui/home/search">VirusTotal</a> after the SHA256 file hash of the aforementioned malware was submitted.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/virustotal\_scan.png" alt="Image"></p>
<p>Even though a file hash like MD5, SHA1, or SHA256 is valuable for identifying identical samples with disparate names, it falls short when identifying similar malware samples. This is primarily because a malware author can alter the file hash value by making minor modifications to the code and recompiling it.</p>
<p>Nonetheless, there exist techniques that can aid in identifying similar samples:</p>
<h4 id="import-hashing-imphash-">Import Hashing (IMPHASH)</h4>
<p><code>IMPHASH</code>, an abbreviation for &quot;Import Hash&quot;, is a cryptographic hash calculated from the import functions of a Windows Portable Executable (PE) file. Its algorithm functions by first converting all imported function names to lowercase. Following this, the DLL names and function names are fused together and arranged in alphabetical order. Finally, an MD5 hash is generated from the resulting string. Therefore, two PE files with identical import functions, in the same sequence, will share an <code>IMPHASH</code> value.</p>
<p>We can find the <code>IMPHASH</code> in the <code>Details</code> tab of the VirusTotal results.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/imphash\_vt1.png" alt="Image"></p>
<p>Note that we can also use the <a href="https://pypi.org/project/pefile/">pefile</a> Python module to compute the <code>IMPHASH</code> of a file as follows.</p>
<p>Code: python</p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> pefile
<span class="hljs-keyword">import</span> peutils

pe_file = sys.argv[<span class="hljs-number">1</span>]
pe = pefile.<span class="hljs-type">PE</span>(pe_file)
imphash = pe.get_imphash()

<span class="hljs-built_in">print</span>(imphash)
</code></pre>
<p>To check the <code>IMPHASH</code> of the abovementioned WannaCry malware the command would be the following. <code>imphash_calc.py</code> contains the Python code above.</p>
<p>Static Analysis On Windows</p>
<pre><code class="lang-cmd-session">C:\Scripts&gt; python imphash_calc<span class="hljs-selector-class">.py</span> C:\Samples\MalwareAnalysis\Ransomware<span class="hljs-selector-class">.wannacry</span><span class="hljs-selector-class">.exe</span>
<span class="hljs-number">9</span>ecee117164e0b870a53dd187cdd7174
</code></pre>
<h4 id="fuzzy-hashing-ssdeep-">Fuzzy Hashing (SSDEEP)</h4>
<p><code>Fuzzy Hashing (SSDEEP)</code>, also referred to as context-triggered piecewise hashing (CTPH), is a hashing technique designed to compute a hash value indicative of content similarity between two files. This technique dissects a file into smaller, fixed-size blocks and calculates a hash for each block. The resulting hash values are then consolidated to generate the final fuzzy hash.</p>
<p>The <code>SSDEEP</code> algorithm allocates more weight to longer sequences of common blocks, making it highly effective in identifying files that have undergone minor modifications, or are similar but not identical, such as different variations of a malicious sample.</p>
<p>We can find the <code>SSDEEP</code> hash of a malware in the <code>Details</code> tab of the VirusTotal results.</p>
<p>We can also use the <code>ssdeep</code> tool (available at <code>C:\Tools\ssdeep-2.14.1</code>) to calculate the <code>SSDEEP</code> hash of a file. To check the <code>SSDEEP</code> hash of the abovementioned WannaCry malware the command would be the following.</p>
<p>Static Analysis On Windows</p>
<pre><code class="lang-cmd-session"><span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">Tools</span>\<span class="hljs-selector-tag">ssdeep-2</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.1</span>&gt; <span class="hljs-selector-tag">ssdeep</span><span class="hljs-selector-class">.exe</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">Samples</span>\<span class="hljs-selector-tag">MalwareAnalysis</span>\<span class="hljs-selector-tag">Ransomware</span><span class="hljs-selector-class">.wannacry</span><span class="hljs-selector-class">.exe</span>
<span class="hljs-selector-tag">ssdeep</span>,1<span class="hljs-selector-class">.1--blocksize</span><span class="hljs-selector-pseudo">:hash</span><span class="hljs-selector-pseudo">:hash</span>,<span class="hljs-selector-tag">filename</span>
98304<span class="hljs-selector-pseudo">:wDqPoBhz1aRxcSUDk36SAEdhvxWa9P593R8yAVp2g3R</span><span class="hljs-selector-pseudo">:wDqPe1Cxcxk3ZAEUadzR8yc4gB</span>,"<span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">Samples</span>\<span class="hljs-selector-tag">MalwareAnalysis</span>\<span class="hljs-selector-tag">Ransomware</span><span class="hljs-selector-class">.wannacry</span><span class="hljs-selector-class">.exe</span>"
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/227/win\_ssdeep.png" alt="Image"></p>
<h4 id="section-hashing-hashing-pe-sections-">Section Hashing (Hashing PE Sections)</h4>
<p><code>Section hashing</code>, (hashing PE sections) is a powerful technique that allows analysts to identify sections of a Portable Executable (PE) file that have been modified. This can be particularly useful for identifying minor variations in malware samples, a common tactic employed by attackers to evade detection.</p>
<p>The <code>Section Hashing</code> technique works by calculating the cryptographic hash of each of these sections. When comparing two PE files, if the hash of corresponding sections in the two files matches, it suggests that the particular section has not been modified between the two versions of the file.</p>
<p>By applying <code>section hashing</code>, security analysts can identify parts of a PE file that have been tampered with or altered. This can help identify similar malware samples, even if they have been slightly modified to evade traditional signature-based detection methods.</p>
<p>Tools such as <code>pefile</code> in Python can be used to perform <code>section hashing</code>. In Python, for example, you can use the pefile module to access and hash the data in individual sections of a PE file as follows.</p>
<p>Code: python</p>
<pre><code class="lang-python">import sys
import pefile
pe_file = sys<span class="hljs-selector-class">.argv</span>[<span class="hljs-number">1</span>]
pe = pefile.PE(pe_file)
<span class="hljs-keyword">for</span> <span class="hljs-selector-tag">section</span> <span class="hljs-keyword">in</span> pe<span class="hljs-selector-class">.sections</span>:
    print (<span class="hljs-selector-tag">section</span><span class="hljs-selector-class">.Name</span>, <span class="hljs-string">"MD5 hash:"</span>, <span class="hljs-selector-tag">section</span>.get_hash_md5())
    print (<span class="hljs-selector-tag">section</span><span class="hljs-selector-class">.Name</span>, <span class="hljs-string">"SHA256 hash:"</span>, <span class="hljs-selector-tag">section</span>.get_hash_sha256())
</code></pre>
<p>Remember that while <code>section hashing</code> is a powerful technique, it is not foolproof. Malware authors might employ tactics like section name obfuscation or dynamically generating section names to try and bypass this kind of analysis.</p>
<p>As an illustration, to check the MD5 file hash of the abovementioned malware we can use <code>pestudio</code> (available at <code>C:\Tools\pestudio\pestudio</code>) as follows.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/win\_section\_hashing.png" alt="Image"></p>
<h3 id="string-analysis">String Analysis</h3>
<p>In this phase, our objective is to extract strings (ASCII &amp; Unicode) from a binary. Strings can furnish clues and valuable insight into the functionality of the malware. Occasionally, we can unearth unique embedded strings in a malware sample, such as:</p>
<ul>
<li>Embedded filenames (e.g., dropped files)</li>
<li>IP addresses or domain names</li>
<li>Registry paths or keys</li>
<li>Windows API functions</li>
<li>Command-line arguments</li>
<li>Unique information that might hint at a particular threat actor</li>
</ul>
<p>The Windows <code>strings</code> binary from <code>Sysinternals</code> can be deployed to display the strings contained within a malware. For instance, the command below will reveal strings for a ransomware sample named <code>dharma_sample.exe</code> residing in the <code>C:\Samples\MalwareAnalysis</code> directory of this section&#39;s target.</p>
<p>Static Analysis On Windows</p>
<pre><code class="lang-cmd-session">C:\Users\htb-student&gt; strings C:\Samples\MalwareAnalysis\dharma_sample.exe

Strings v2.54 - <span class="hljs-keyword">Search</span> <span class="hljs-keyword">for</span> ANSI and Unicode strings <span class="hljs-keyword">in</span> binary images.
<span class="hljs-keyword">Copyright</span> (C) 1999-2021 <span class="hljs-keyword">Mark</span> Russinovich
Sysinternals - www.sysinternals.com

!This <span class="hljs-keyword">program</span> cannot be <span class="hljs-keyword">run</span> <span class="hljs-keyword">in</span> DOS mode.
gaT
Rich
.text
`.rdata
@.data
HQh
9A <span class="hljs-built_in">s</span>
9A<span class="hljs-variable">$v</span>
---SNIP---
GetProcAddress
LoadLibraryA
WaitForSingleObject
InitializeCriticalSectionAndSpinCount
LeaveCriticalSection
GetLastError
EnterCriticalSection
ReleaseMutex
CloseHandle
KERNEL32.dll
RSDS%~<span class="hljs-built_in">m</span>
#ka
C:\crysis\Release\PDB\payload.pdb
---SNIP---
</code></pre>
<p>Occasionally, string analysis can facilitate the linkage of a malware sample to a specific threat group if significant similarities are identified. For <a href="https://thedfirreport.com/2020/06/16/the-little-ransomware-that-couldnt-dharma/">example</a>, in the link provided, a string containing a PDB path was used to link the malware sample to the Dharma/Crysis family of ransomware.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/dharma.png" alt="Image"></p>
<hr>
<p>It should be noted that the <code>FLOSS</code> tool is also available for Windows Operating Systems.</p>
<p>The command below will reveal strings for a malware sample named <code>shell.exe</code> residing in the <code>C:\Samples\MalwareAnalysis</code> directory of this section&#39;s target.</p>
<p>Static Analysis On Windows</p>
<pre><code class="lang-cmd-session">C:\Samples\MalwareAnalysis&gt; floss <span class="hljs-keyword">shell</span>.<span class="hljs-keyword">exe</span>
INFO: flos<span class="hljs-variable">s:</span> extracting static strings...
finding decoding <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">features</span>: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 85/85 [00:00&lt;00:00, 1361.51 <span class="hljs-title">functions</span>/<span class="hljs-title">s</span>, <span class="hljs-title">skipped</span> 0 <span class="hljs-title">library</span> <span class="hljs-title">functions</span>]</span>
INFO: floss.stackstring<span class="hljs-variable">s:</span> extracting stackstrings from <span class="hljs-number">56</span> functions
INFO: floss.result<span class="hljs-variable">s:</span> AQAPRQVH1
INFO: floss.result<span class="hljs-variable">s:</span> JJM1
INFO: floss.result<span class="hljs-variable">s:</span> RAQH
INFO: floss.result<span class="hljs-variable">s:</span> AXAX^YZAXAYAZH
INFO: floss.result<span class="hljs-variable">s:</span> XAYZH
INFO: floss.result<span class="hljs-variable">s:</span> ws232
extracting stackstring<span class="hljs-variable">s:</span> <span class="hljs-number">100</span>%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| <span class="hljs-number">56</span>/<span class="hljs-number">56</span> [<span class="hljs-number">00</span>:<span class="hljs-number">00</span>&lt;<span class="hljs-number">00</span>:<span class="hljs-number">00</span>, <span class="hljs-number">81.46</span> functions/s]
INFO: floss.tightstring<span class="hljs-variable">s:</span> extracting tightstrings from <span class="hljs-number">4</span> functions...
extracting tightstrings from <span class="hljs-function"><span class="hljs-keyword">function</span> 0<span class="hljs-title">x402a90</span>: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 4/4 [00:00&lt;00:00, 25.59 <span class="hljs-title">functions</span>/<span class="hljs-title">s</span>]</span>
INFO: floss.string_decoder: decoding strings
emulating <span class="hljs-function"><span class="hljs-keyword">function</span> 0<span class="hljs-title">x402a90</span> <span class="hljs-params">(call 1/1)</span>: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 22/22 [00:14&lt;00:00,  1.51 <span class="hljs-title">functions</span>/<span class="hljs-title">s</span>]</span>
INFO: flos<span class="hljs-variable">s:</span> finished execution after <span class="hljs-number">25.20</span> seconds


FLARE FLOSS RESULTS (<span class="hljs-keyword">version</span> v2.<span class="hljs-number">3.0</span>-<span class="hljs-number">0</span>-g037fc4b)

+------------------------+------------------------------------------------------------------------------------+
| <span class="hljs-keyword">file</span> path              | <span class="hljs-keyword">shell</span>.<span class="hljs-keyword">exe</span>                                                                          |
| extracted strings      |                                                                                    |
|  static strings        | <span class="hljs-number">254</span>                                                                                |
|  stack strings         | <span class="hljs-number">6</span>                                                                                  |
|  tight strings         | <span class="hljs-number">0</span>                                                                                  |
|  decoded strings       | <span class="hljs-number">0</span>                                                                                  |
+------------------------+------------------------------------------------------------------------------------+


 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  FLOSS STATIC STRINGS
 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

+-----------------------------------+
| FLOSS STATIC STRINGS: ASCII (<span class="hljs-number">254</span>) |
+-----------------------------------+

!This program cannot <span class="hljs-keyword">be</span> run in DOS <span class="hljs-keyword">mode</span>.
.text
<span class="hljs-keyword">P</span>`.data
.rdata
`@.pdata
<span class="hljs-number">0</span>@.xdata
<span class="hljs-number">0</span>@.bss
.idata
.CRT
.tls
<span class="hljs-number">8</span>MZu
HcP&lt;H
D$ H
AUATUWVSH
D$ L
---SNIP---
C:\Windows\System32\notepad.<span class="hljs-keyword">exe</span>
Message
Connection sent <span class="hljs-keyword">to</span> C2
[-] Error code <span class="hljs-keyword">is</span> : %<span class="hljs-keyword">lu</span>
AQAPRQVH1
JJM1
RAQH
AXAX^YZAXAYAZH
XAYZH
ws2_32
PPM1
APAPH
WWWM1
VPAPAPAPI
Windows-Update/<span class="hljs-number">7.6</span>.<span class="hljs-number">7600.256</span> %s
<span class="hljs-number">1</span>Lbcfr7sAHTD9CgdQo3HTMTkV8LK4ZnX71
<span class="hljs-keyword">open</span>
SOFTWARE\Microsoft\Windows\CurrentVersion\Run
WindowsUpdater
---SNIP---
TEMP
svchost.<span class="hljs-keyword">exe</span>
%s\%s
http://ms-windows-<span class="hljs-keyword">update</span>.<span class="hljs-keyword">com</span>/svchost.<span class="hljs-keyword">exe</span>
<span class="hljs-number">45.33</span>.<span class="hljs-number">32.156</span>
Sandbox detected
iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.<span class="hljs-keyword">com</span>
SOFTWARE\VMware, Inc.\VMware Tools
InstallPath
C:\Program Files\VMware\VMware Tools\
Failed <span class="hljs-keyword">to</span> <span class="hljs-keyword">open</span> the registry key.
Unknown error
Argument domain error (DOMAIN)
Overflow <span class="hljs-built_in">range</span> error (OVERFLOW)
Partial loss of significance (PLOSS)
Total loss of significance (TLOSS)
The result <span class="hljs-keyword">is</span> too small <span class="hljs-keyword">to</span> <span class="hljs-keyword">be</span> represented (UNDERFLOW)
Argument singularity (SIGN)
_matherr(): %s in %s(%g, %g)  (retval=%g)
Mingw-w64 <span class="hljs-keyword">runtime</span> failure:
Address %<span class="hljs-keyword">p</span> <span class="hljs-built_in">has</span> <span class="hljs-keyword">no</span> image-section
  VirtualQuery failed <span class="hljs-keyword">for</span> %d bytes at address %<span class="hljs-keyword">p</span>
  VirtualProtect failed with code <span class="hljs-number">0</span><span class="hljs-keyword">x</span>%<span class="hljs-keyword">x</span>
  Unknown pseudo relocation protocol <span class="hljs-keyword">version</span> %d.
  Unknown pseudo relocation bit size %d.
.pdata
RegCloseKey
RegOpenKeyExA
RegQueryValueExA
RegSetValueExA
CloseHandle
CreateFileA
CreateProcessA
CreateRemoteThread
DeleteCriticalSection
EnterCriticalSection
GetComputerNameA
GetCurrentProcess
GetCurrentProcessId
GetCurrentThreadId
GetLastError
GetStartupInfoA
GetSystemTimeAsFileTime
GetTickCount
InitializeCriticalSection
LeaveCriticalSection
OpenProcess
QueryPerformanceCounter
RtlAddFunctionTable
RtlCaptureContext
RtlLookupFunctionEntry
RtlVirtualUnwind
SetUnhandledExceptionFilter
Sleep
TerminateProcess
TlsGetValue
UnhandledExceptionFilter
VirtualAllocEx
VirtualProtect
VirtualQuery
WriteFile
WriteProcessMemory
__C_specific_handler
__getmainargs
__initenv
__iob_func
__lconv_init
__set_app_type
__setusermatherr
_acmdln
_amsg_exit
_cexit
_fmode
_initterm
_onexit
_vsnprintf
abort
calloc
<span class="hljs-keyword">exit</span>
fprintf
free
fwrite
getenv
malloc
memcpy
<span class="hljs-built_in">printf</span>
puts
signal
sprintf
strcmp
<span class="hljs-built_in">strlen</span>
strncmp
vfprintf
ShellExecuteA
MessageBoxA
InternetCloseHandle
InternetOpenA
InternetOpenUrlA
InternetReadFile
WSACleanup
WSAStartup
closesocket
connect
freeaddrinfo
getaddrinfo
htons
inet_addr
socket
ADVAPI32.dll
KERNEL32.dll
msvcrt.dll
SHELL32.dll
USER32.dll
WININET.dll
WS2_32.dll


+------------------------------------+
| FLOSS STATIC STRINGS: UTF-<span class="hljs-number">16</span>LE (<span class="hljs-number">0</span>) |
+------------------------------------+





 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  FLOSS STACK STRINGS
 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

AQAPRQVH1
JJM1
RAQH
AXAX^YZAXAYAZH
XAYZH
ws232


 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  FLOSS TIGHT STRINGS
 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€



 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  FLOSS DECODED STRINGS
 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
</code></pre>
<h3 id="unpacking-upx-packed-malware">Unpacking UPX-packed Malware</h3>
<p>In our static analysis, we might stumble upon a malware sample that&#39;s been compressed or obfuscated using a technique referred to as packing. Packing serves several purposes:</p>
<ul>
<li>It obfuscates the code, making it more challenging to discern its structure or functionality.</li>
<li>It reduces the size of the executable, making it quicker to transfer or less conspicuous.</li>
<li>It confounds security researchers by hindering traditional reverse engineering attempts.</li>
</ul>
<p>This can impair string analysis because the references to strings are typically obscured or eliminated. It also replaces or camouflages conventional PE sections with a compact loader stub, which retrieves the original code from a compressed data section. As a result, the malware file becomes both smaller and more difficult to analyze, as the original code isn&#39;t directly observable.</p>
<p>A popular packer used in many malware variants is the <code>Ultimate Packer for Executables (UPX)</code>.</p>
<p>Let&#39;s first see what happens when we run the <code>strings</code> command on a UPX-packed malware sample named <code>credential_stealer.exe</code> residing in the <code>C:\Samples\MalwareAnalysis\packed</code> directory of this section&#39;s target.</p>
<p>Static Analysis On Windows</p>
<pre><code class="lang-cmd-session">C:\Users\htb-student&gt; strings C:\Samples\MalwareAnalysis\packed\credential_stealer.exe

Strings v2.54 - <span class="hljs-keyword">Search</span> <span class="hljs-keyword">for</span> ANSI and Unicode strings <span class="hljs-keyword">in</span> binary images.
<span class="hljs-keyword">Copyright</span> (C) 1999-2021 <span class="hljs-keyword">Mark</span> Russinovich
Sysinternals - www.sysinternals.com

!This <span class="hljs-keyword">program</span> cannot be <span class="hljs-keyword">run</span> <span class="hljs-keyword">in</span> DOS mode.
UPX0
UPX1
UPX2
3.96
UPX!
ff.
8MZu
HcP&lt;<span class="hljs-built_in">H</span>
<span class="hljs-keyword">tY</span>)
<span class="hljs-keyword">L</span>~o
tK1
7c0
VDgxt
amE
8#v
$ /uX
OAUATUWVSH
Z6L
&lt;=<span class="hljs-built_in">h</span>
%0rv
o?H9
7sk
3H{
HZu
'.}
c|/
c`fG
Iq%
[^_]A\A]
&gt; -P
fo{Wnl
c9"^$!=
;\V
%&amp;<span class="hljs-built_in">m</span>
')A
v/7&gt;
07ZC
_L<span class="hljs-variable">$AAl</span>
mug.%(
t%<span class="hljs-keyword">n</span>
#8%,X
<span class="hljs-keyword">e</span>]'^
(hk
Dks
zC:
Vj&lt;
w~5
<span class="hljs-keyword">m</span>&lt;6
|<span class="hljs-variable">$PD</span>
c(t
\3_
---SNIP---
</code></pre>
<p>Observe the strings that include <code>UPX</code>, and take note that the remainder of the output doesn&#39;t yield any valuable information regarding the functionality of the malware.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/upx\_sections.png" alt="Image"></p>
<p>We can unpack the malware using the <code>UPX</code> tool (available at <code>C:\Tools\upx\upx-4.0.2-win64</code>) with the following command.</p>
<p>Static Analysis On Windows</p>
<pre><code class="lang-cmd-session">C:\Tools\upx\upx-<span class="hljs-number">4.0</span>.<span class="hljs-number">2</span>-win64&gt; upx -d -o unpacked_credential_stealer<span class="hljs-selector-class">.exe</span> C:\Samples\MalwareAnalysis\packed\credential_stealer<span class="hljs-selector-class">.exe</span>
                       Ultimate Packer <span class="hljs-keyword">for</span> eXecutables
                          Copyright (C) <span class="hljs-number">1996</span> - <span class="hljs-number">2023</span>
UPX <span class="hljs-number">4.0</span>.<span class="hljs-number">2</span>       Markus Oberhumer, Laszlo Molnar &amp; John Reiser   Jan <span class="hljs-number">30</span>th <span class="hljs-number">2023</span>

        File size         Ratio      Format      Name
   --------------------   ------   -----------   -----------
     <span class="hljs-number">16896</span> &lt;-      <span class="hljs-number">8704</span>   <span class="hljs-number">51.52%</span>    win64/pe     unpacked_credential_stealer<span class="hljs-selector-class">.exe</span>

Unpacked <span class="hljs-number">1</span> file.
</code></pre>
<p>Let&#39;s now run the <code>strings</code> command on the unpacked sample.</p>
<p>Static Analysis On Windows</p>
<pre><code class="lang-cmd-session">C:\Tools\upx\upx-4.0.2-win64&gt; strings unpacked_credential_stealer.exe

Strings v2.54 - <span class="hljs-keyword">Search</span> <span class="hljs-keyword">for</span> ANSI and Unicode strings <span class="hljs-keyword">in</span> binary images.
<span class="hljs-keyword">Copyright</span> (C) 1999-2021 <span class="hljs-keyword">Mark</span> Russinovich
Sysinternals - www.sysinternals.com

!This <span class="hljs-keyword">program</span> cannot be <span class="hljs-keyword">run</span> <span class="hljs-keyword">in</span> DOS mode.
.text
P`.data
.rdata
`@.pdata
0@.xdata
0@.bss
.idata
.CRT
.tls
ff.
8MZu
HcP&lt;<span class="hljs-built_in">H</span>
---SNIP---
<span class="hljs-keyword">D</span>$(
<span class="hljs-keyword">D</span>$
<span class="hljs-keyword">D</span><span class="hljs-variable">$0</span>
<span class="hljs-keyword">D</span>$(
<span class="hljs-keyword">D</span>$
t'<span class="hljs-built_in">H</span>
%5T
@A\A]A^
SeDebugPrivilege
<span class="hljs-keyword">SE</span> Debug Privilege is adjusted
lsass.exe
Searching lsass PID
Lsass PID is: %lu
<span class="hljs-keyword">Error</span> is - %lu
lsassmem.dmp
LSASS <span class="hljs-keyword">Memory</span> is dumped successfully
<span class="hljs-keyword">Err</span> 2: %lu
@<span class="hljs-keyword">u</span>@
`p@
Unknown <span class="hljs-keyword">error</span>
Argument domain <span class="hljs-keyword">error</span> (DOMAIN)
Overflow <span class="hljs-keyword">range</span> <span class="hljs-keyword">error</span> (OVERFLOW)
Partial loss of significance (PLOSS)
<span class="hljs-keyword">Total</span> loss of significance (TLOSS)
The result is too small to be represented (UNDERFLOW)
Argument singularity (SIGN)
_matherr(): %s <span class="hljs-keyword">in</span> %<span class="hljs-built_in">s</span>(%<span class="hljs-keyword">g</span>, %<span class="hljs-keyword">g</span>)  (retval=%<span class="hljs-keyword">g</span>)
Mingw-w64 runtime failure:
Address %p has <span class="hljs-keyword">no</span> image-section
  VirtualQuery failed <span class="hljs-keyword">for</span> %<span class="hljs-keyword">d</span> bytes at address %p
  VirtualProtect failed with code 0x%x
  Unknown pseudo relocation protocol <span class="hljs-keyword">version</span> %<span class="hljs-keyword">d</span>.
  Unknown pseudo relocation bit size %<span class="hljs-keyword">d</span>.
.pdata
 0@
00@
`<span class="hljs-keyword">E</span>@
`<span class="hljs-keyword">E</span>@
@v@
hy@
`y@
@p@
0v@
Pp@
AdjustTokenPrivileges
LookupPrivilegeValueA
OpenProcessToken
MiniDumpWriteDump
CloseHandle
CreateFileA
CreateToolhelp32Snapshot
DeleteCriticalSection
EnterCriticalSection
GetCurrentProcess
GetCurrentProcessId
GetCurrentThreadId
GetLastError
GetStartupInfoA
GetSystemTimeAsFileTime
GetTickCount
InitializeCriticalSection
LeaveCriticalSection
OpenProcess
Process32First
Process32Next
QueryPerformanceCounter
RtlAddFunctionTable
RtlCaptureContext
RtlLookupFunctionEntry
RtlVirtualUnwind
SetUnhandledExceptionFilter
<span class="hljs-keyword">Sleep</span>
TerminateProcess
TlsGetValue
UnhandledExceptionFilter
VirtualProtect
VirtualQuery
__C_specific_handler
__getmainargs
__initenv
__iob_func
__lconv_init
__set_app_type
__setusermatherr
_acmdln
_amsg_exit
_cexit
_fmode
_initterm
_onexit
abort
calloc
<span class="hljs-keyword">exit</span>
fprintf
free
fwrite
malloc
memcpy
printf
puts
signal
strcmp
<span class="hljs-built_in">strlen</span>
strncmp
vfprintf
ADVAPI32.dll
dbghelp.dll
KERNEL32.DLL
msvcrt.dll
</code></pre>
<p>Now, we observe a more comprehensible output that includes the actual strings present in the sample.</p>
<h2 id="dynamic-analysis">Dynamic Analysis</h2>
<p>When it comes to the domain of malware analysis, dynamic or behavioral analysis represents an indispensable approach in our investigative arsenal. In dynamic analysis, we observe and interpret the behavior of the malware while it is running, or in action. This is a critical contrast to static analysis, where we dissect the malware&#39;s properties and contents without executing it. The primary goal of dynamic analysis is to document and understand the real-world impact of the malware on its host environment, making it an integral part of comprehensive malware analysis.</p>
<p>In executing dynamic analysis, we encapsulate the malware within a tightly controlled, monitored, and usually isolated environment to prevent any unintentional spread or damage. This environment is typically a virtual machine (VM) to which the malware is oblivious. It believes it is interacting with a genuine system, while we, as researchers, have full control over its interactions and can document its behavior thoroughly.</p>
<p>Our dynamic analysis procedure can be broken down into the following steps:</p>
<ul>
<li><code>Environment Setup</code>: We first establish a secure and controlled environment, typically a <code>VM</code>, isolated from the rest of the network to prevent inadvertent contamination or propagation of the malware. The VM setup should mimic a real-world system, complete with software, applications, and network configurations that an actual user might have.</li>
<li><code>Baseline Capture</code>: After the environment is set up, we capture a snapshot of the system&#39;s clean state. This includes <code>system files</code>, <code>registry states</code>, <code>running processes</code>, <code>network configuration</code>, and more. This baseline serves as a reference point to identify changes made by the malware post-execution.</li>
<li><code>Tool Deployment (Pre-Execution)</code>: To capture the activities of the malware effectively, we deploy various monitoring and logging tools. Tools such as <code>Process Monitor (Procmon)</code> from Sysinternals Suite are used to log system calls, file system activity, registry operations, etc. We can also employ utilities like <code>Wireshark</code>, <code>tcpdump</code>, and <code>Fiddler</code> for capturing network traffic, and <code>Regshot</code> to take before-and-after snapshots of the system registry. Finally, tools such as <code>INetSim</code>, <code>FakeDNS</code>, and <code>FakeNet-NG</code> are used to simulate internet services.</li>
<li><code>Malware Execution</code>: With our tools running and ready, we proceed to execute the malware sample in the isolated environment. During execution, the monitoring tools capture and log all activities, including process creation, file and registry modifications, network traffic, etc.</li>
<li><code>Observation and Logging</code>: The malware sample is allowed to execute for a sufficient duration. All the while, our monitoring tools are diligently recording its every move, which will provide us with comprehensive insight into its behavior and modus operandi.</li>
<li><code>Analysis of Collected Data</code>: After the malware has run its course, we halt its execution and stop the monitoring tools. We now examine the logs and data collected, comparing the system&#39;s state to our initial baseline to identify the changes introduced by the malware.</li>
</ul>
<p>In some cases, when the malware is particularly evasive or complex, we might employ sandboxed environments for dynamic analysis. Sandboxes, such as <code>Cuckoo Sandbox</code>, <code>Joe Sandbox</code>, or <code>FireEye&#39;s Dynamic Threat Intelligence cloud</code>, provide an automated, safe, and highly controlled environment for malware execution. They come equipped with numerous features for in-depth behavioral analysis and generate detailed reports regarding the malware&#39;s network behavior, file system interaction, memory footprint, and more.</p>
<p>However, it&#39;s important to remember that while sandbox environments are valuable tools, they are not foolproof. Some advanced malware can detect sandbox environments and alter their behavior accordingly, making it harder for researchers to ascertain their true nature.</p>
<p>Let&#39;s now navigate to the bottom of this section and click on &quot;Click here to spawn the target system!&quot;. Then, let&#39;s RDP into the Target IP using the provided credentials. The vast majority of the actions/commands covered from this point up to end of this section can be replicated inside the target, offering a more comprehensive grasp of the topics presented.</p>
<p>Dynamic Analysis</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ xfreerdp /u</span><span class="hljs-symbol">:htb-student</span> /<span class="hljs-symbol">p:</span><span class="hljs-string">'HTB_@cademy_stdnt!'</span> /<span class="hljs-symbol">v:</span>[Target IP] /dynamic-resolution
</code></pre>
<h3 id="dynamic-analysis-with-noriben">Dynamic Analysis With Noriben</h3>
<p><a href="https://github.com/Rurik/Noriben">Noriben</a> is a powerful tool in our dynamic analysis toolkit, essentially acting as a Python wrapper for Sysinternals <code>ProcMon</code>, a comprehensive system monitoring utility. It orchestrates the operation of <code>ProcMon</code>, refines the output, and adds a layer of malware-specific intelligence to the process. Leveraging <code>Noriben</code>, we can capture malware behaviors more conveniently and understand them more precisely.</p>
<p>To understand how <code>Noriben</code> empowers our dynamic analysis efforts, let&#39;s first quickly review <code>ProcMon</code>. This tool, from <code>Sysinternals Suite</code>, monitors real-time file system, Registry, and process/thread activity. It combines the features of utilities like <code>Filemon</code>, <code>Regmon</code>, and advanced features like filtering, advanced highlighting, and extensive event properties, making it a powerful system monitoring tool for malware analysis.</p>
<p>However, the volume and breadth of information that <code>ProcMon</code> collects can be overwhelming. Without proper filtering and contextual analysis, sifting through this raw data becomes a considerable challenge. This is where Noriben steps in. It uses <code>ProcMon</code> to capture system events but then filters and analyzes this data to extract meaningful information and pinpoint malicious activities.</p>
<p>In our dynamic malware analysis process, here&#39;s how we employ Noriben:</p>
<ul>
<li><code>Setting Up Noriben</code>: We initiate <code>Noriben</code> by launching it from the command line. The tool supports numerous command-line arguments to customize its operation. For instance, we can define the duration of data collection, specify a custom malware sample for execution, or select a personalized <code>ProcMon</code> configuration file.</li>
<li><code>Launching ProcMon</code>: Upon initiation, <code>Noriben</code> starts <code>ProcMon</code> with a predefined configuration. This configuration contains a set of filters designed to exclude normal system activity and focus on potential indicators of malicious actions.</li>
<li><code>Executing the Malware Sample</code>: With <code>ProcMon</code> running, <code>Noriben</code> executes the selected malware sample. During this phase, <code>ProcMon</code> captures all system activities, including process operations, file system changes, and registry modifications.</li>
<li><code>Monitoring and Logging</code>: <code>Noriben</code> controls the duration of monitoring, and once it concludes, it commands <code>ProcMon</code> to save the collected data to a CSV file and then terminates ProcMon.</li>
<li><code>Data Analysis and Reporting</code>: This is where <code>Noriben</code> shines. It processes the CSV file generated by <code>ProcMon</code>, applying additional filters and performing contextual analysis. <code>Noriben</code> identifies potentially suspicious activities and organizes them into different categories, such as file system activity, process operations, and network connections. This process results in a clear, readable report in HTML or TXT format, highlighting the behavioral traits of the analyzed malware.</li>
</ul>
<p>Noriben&#39;s integration with YARA rules is another notable feature. We can leverage YARA rules to enhance our data filtering capabilities, allowing us to identify patterns of interest more efficiently.</p>
<hr>
<p>For demonstration purposes, we&#39;ll conduct dynamic analysis on a malware specimen named <code>shell.exe</code>, found in the <code>C:\Samples\MalwareAnalysis</code> directory on this section&#39;s target machine. Follow these steps:</p>
<ul>
<li>Launch a new Command Line interface and make your way to the <code>C:\Tools\Noriben-master</code> directory.</li>
<li>Initiate Noriben as indicated.</li>
</ul>
<p>Dynamic Analysis</p>
<pre><code class="lang-cmd-session">C:\Tools\Noriben-master&gt; <span class="hljs-keyword">python</span> .\Noriben.<span class="hljs-keyword">py</span>
[*] Using <span class="hljs-built_in">filter</span> <span class="hljs-keyword">file</span>: ProcmonConfiguration.PMC
[*] Using procmon EXE: C:\ProgramData\chocolatey\bin\procmon.<span class="hljs-keyword">exe</span>
[*] Procmon session saved <span class="hljs-keyword">to</span>: Noriben_27_Jul_23__23_40_319983.pml
[*] Launching Procmon ...
[*] Procmon <span class="hljs-keyword">is</span> running. Run your <span class="hljs-built_in">executable</span> now.
[*] When <span class="hljs-keyword">runtime</span> <span class="hljs-keyword">is</span> <span class="hljs-built_in">complete</span>, press CTRL+C <span class="hljs-keyword">to</span> <span class="hljs-keyword">stop</span> logging.
</code></pre>
<ul>
<li>Upon seeing the <code>User Account Control</code> prompt, select <code>Yes</code>.</li>
<li>Proceed to <code>C:\Samples\MalwareAnalysis</code> and activate <code>shell.exe</code> by double-clicking.</li>
<li><code>shell.exe</code> will identify it is running within a sandbox. Close the window it created.</li>
<li>Terminate <code>ProcMon</code>.</li>
<li>In the Command Prompt running Noriben, use the <code>Ctrl+C</code> command to cease its operation.</li>
</ul>
<p>Dynamic Analysis</p>
<pre><code class="lang-cmd-session"><span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">Tools</span>\<span class="hljs-selector-tag">Noriben-master</span>&gt; <span class="hljs-selector-tag">python</span> .\<span class="hljs-selector-tag">Noriben</span><span class="hljs-selector-class">.py</span>
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Using</span> <span class="hljs-selector-tag">filter</span> <span class="hljs-selector-tag">file</span>: <span class="hljs-selector-tag">ProcmonConfiguration</span><span class="hljs-selector-class">.PMC</span>
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Using</span> <span class="hljs-selector-tag">procmon</span> <span class="hljs-selector-tag">EXE</span>: <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">ProgramData</span>\<span class="hljs-selector-tag">chocolatey</span>\<span class="hljs-selector-tag">bin</span>\<span class="hljs-selector-tag">procmon</span><span class="hljs-selector-class">.exe</span>
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Procmon</span> <span class="hljs-selector-tag">session</span> <span class="hljs-selector-tag">saved</span> <span class="hljs-selector-tag">to</span>: <span class="hljs-selector-tag">Noriben_27_Jul_23__23_40_319983</span><span class="hljs-selector-class">.pml</span>
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Launching</span> <span class="hljs-selector-tag">Procmon</span> ...
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Procmon</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">running</span>. <span class="hljs-selector-tag">Run</span> <span class="hljs-selector-tag">your</span> <span class="hljs-selector-tag">executable</span> <span class="hljs-selector-tag">now</span>.
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">When</span> <span class="hljs-selector-tag">runtime</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">complete</span>, <span class="hljs-selector-tag">press</span> <span class="hljs-selector-tag">CTRL</span>+<span class="hljs-selector-tag">C</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">stop</span> <span class="hljs-selector-tag">logging</span>.

<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Termination</span> <span class="hljs-selector-tag">of</span> <span class="hljs-selector-tag">Procmon</span> <span class="hljs-selector-tag">commencing</span>... <span class="hljs-selector-tag">please</span> <span class="hljs-selector-tag">wait</span>
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Procmon</span> <span class="hljs-selector-tag">terminated</span>
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Saving</span> <span class="hljs-selector-tag">report</span> <span class="hljs-selector-tag">to</span>: <span class="hljs-selector-tag">Noriben_27_Jul_23__23_42_335666</span><span class="hljs-selector-class">.txt</span>
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Saving</span> <span class="hljs-selector-tag">timeline</span> <span class="hljs-selector-tag">to</span>: <span class="hljs-selector-tag">Noriben_27_Jul_23__23_42_335666_timeline</span><span class="hljs-selector-class">.csv</span>
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Exiting</span> <span class="hljs-selector-tag">with</span> <span class="hljs-selector-tag">error</span> <span class="hljs-selector-tag">code</span>: 0: <span class="hljs-selector-tag">Normal</span> <span class="hljs-selector-tag">exit</span>
</code></pre>
<p>You&#39;ll observe that Noriben generates a <code>.txt</code> report inside it&#39;s directory, compiling all the behavioral information it managed to gather.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/noriben2.png" alt="Image"></p>
<p>As discussed, <code>Noriben</code> uses <code>ProcMon</code> to capture system events but then filters and analyzes this data to extract meaningful information and pinpoint malicious activities.</p>
<p><code>Noriben</code> might filter out some potentially valuable information. For instance, we don&#39;t receive any insightful data from Noriben&#39;s report about how <code>shell.exe</code> recognized that it was functioning within a sandbox or virtual machine.</p>
<p>Let&#39;s take a different approach and manually launch <code>ProcMon</code> (available at <code>C:\Tools\sysinternals</code>) using its default, more inclusive, configuration. Following this, let&#39;s re-run <code>shell.exe</code>. This might give us insights into how <code>shell.exe</code> detects the presence of a sandbox or virtual machine.</p>
<p>Then, let&#39;s configure the filter (<code>Ctrl+L</code>) as follows and press <code>Apply</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/filter.png" alt="Image"></p>
<p>Finally, let&#39;s navigate to the end of the results. There can observe that <code>shell.exe</code> conducts sandbox or virtual machine detection by querying the registry for the presence of <code>VMware Tools</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/results1.png" alt="Image"></p>
<h2 id="code-analysis">Code Analysis</h2>
<h3 id="reverse-engineering-code-analysis">Reverse Engineering &amp; Code Analysis</h3>
<p><code>Reverse engineering</code> is a process that takes us beneath the surface of executable files or compiled machine code, enabling us to decode their functionality, behavioral traits, and structure. With the absence of source code, we turn to the analysis of disassembled code instructions, also known as <code>assembly code analysis</code>. This deeper level of understanding helps us to uncover obscured or elusive functionalities that remain hidden even after static and dynamic analysis.</p>
<p>To untangle the complex web of machine code, we turn to a duo of powerful tools: <code>Disassemblers</code> and <code>Debuggers</code>.</p>
<ul>
<li>A <code>Disassembler</code> is our tool of choice when we wish to conduct a static analysis of the code, meaning that we need not execute the code. This type of analysis is invaluable as it helps us to understand the structure and logic of the code without activating potentially harmful functionalities. Some prime examples of disassemblers include <code>IDA</code>, <code>Cutter</code>, and <code>Ghidra</code>.</li>
<li>A <code>Debugger</code>, on the other hand, serves a dual purpose. Like a disassembler, it decodes machine code into assembly instructions. Additionally, it allows us to execute code in a controlled manner, proceeding instruction by instruction, skipping to specific locations, or halting the execution flow at designated points using breakpoints. Examples of debuggers include <code>x32dbg</code>, <code>x64dbg</code>, <code>IDA</code>, and <code>OllyDbg</code>.</li>
</ul>
<p>Let&#39;s take a step back and understand the challenge before us. The journey of code from human-readable high-level languages, such as C or C++, to <code>machine code</code> is a one-way ticket, guided by the compiler. <code>Machine code</code>, a binary language that computers process directly, is a cryptic narrative for human analysts. Here&#39;s where the assembly language comes into play, acting as a bridge between us and the machine code, enabling us to decode the latter&#39;s story.</p>
<p>A disassembler transforms machine code back into assembly language, presenting us with a readable sequence of instructions. Understanding assembly and its mnemonics is pivotal in dissecting the functionality of malware.</p>
<hr>
<p><code>Code analysis</code> is the process of scrutinizing and deciphering the behavior and functionality of a compiled program or binary. This involves analyzing the instructions, control flow, and data structures within the code, ultimately shedding light on the purpose, functionality, and potential <code>indicators of compromise (IOCs)</code>.</p>
<p>Understanding a program or a piece of malware often requires us to reverse the compilation process. This is where <code>Disassembly</code> comes into the picture. By converting machine code back into assembly language instructions, we end up with a set of instructions that are symbolic and mnemonic, enabling us to decode the logic and workings of the program.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/disassembly.png" alt="Image"></p>
<p>Disassemblers are our allies in this process. These specialized tools take the binary code, generate the corresponding assembly instructions, and often supplement them with additional context such as memory addresses, function names, and control flow analysis. One such powerful tool is <a href="https://hex-rays.com/ida-free/">IDA</a>, a widely used disassembler and debugger revered for its advanced analysis features. It supports multiple executable file formats and architectures, presenting a comprehensive disassembly view and potent analysis capabilities.</p>
<p>Let&#39;s now navigate to the bottom of this section and click on &quot;Click here to spawn the target system!&quot;. Then, let&#39;s RDP into the Target IP using the provided credentials. The vast majority of the actions/commands covered from this point up to end of this section can be replicated inside the target, offering a more comprehensive grasp of the topics presented.</p>
<p>Code Analysis</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ xfreerdp /u</span><span class="hljs-symbol">:htb-student</span> /<span class="hljs-symbol">p:</span><span class="hljs-string">'HTB_@cademy_stdnt!'</span> /<span class="hljs-symbol">v:</span>[Target IP] /dynamic-resolution
</code></pre>
<h3 id="code-analysis-example-shell-exe">Code Analysis Example: shell.exe</h3>
<p>Let&#39;s persist with the analysis of the <code>shell.exe</code> malware sample residing in the <code>C:\Samples\MalwareAnalysis</code> directory of this section&#39;s target. Up until this point, we&#39;ve discovered that it conducts <code>sandbox detection</code>, and that it includes a possible sleep mechanism - a <code>5-second ping</code> delay - before executing its intended operations.</p>
<h4 id="importing-a-malware-sample-into-the-disassembler-ida">Importing a Malware Sample into the Disassembler - IDA</h4>
<p>For the next stage in our investigation, we must scrutinize the code in <code>IDA</code> to ascertain its further actions and discover how to circumvent the sandbox check employed by the malware sample.</p>
<p>We can initiate <code>IDA</code> either by double-clicking the <code>IDA</code> shortcut that is placed on the Desktop or by right-clicking it and selecting <code>Run as administrator</code> to ensure proper access rights. At first, it will display the license information and subsequently prompt us to open a new executable for analysis.</p>
<p>Next, opt for <code>New</code> and select the <code>shell.exe</code> sample residing in the <code>C:\Samples\MalwareAnalysis</code> directory of this section&#39;s target to dissect.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_intro.png" alt="Image"></p>
<p>The <code>Load a new file</code> dialog box that pops up next is where we can select the processor architecture. Choose the correct one and click <code>OK</code>. By default, <code>IDA</code> determines the appropriate processor type.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_intro\_processor.png" alt="Image"></p>
<p>After we hit <code>OK</code>, <code>IDA</code> will load the executable file into memory and disassemble the machine code to render the disassembled output for us. The screenshot below illustrates the different views in <code>IDA</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_intro\_views.png" alt="Image"></p>
<p>Once the executable is loaded and the analysis completes, the disassembled code of the sample <code>shell.exe</code> will be exhibited in the main <code>IDA-View</code> window. We can traverse through the code using the cursor keys or the scroll bar and zoom in or out using the mouse wheel or the zoom controls.</p>
<h4 id="text-and-graph-views">Text and Graph Views</h4>
<p>The disassembled code is presented in two modes, namely the <code>Graph view</code> and the <code>Text view</code>. The default view is the <code>Graph view</code>, which provides a graphic illustration of the function&#39;s basic blocks and their interconnections. Basic blocks are instruction sequences with a single entry and exit point. These basic blocks are symbolized as nodes in the graph view, with the connections between them as edges.</p>
<p>To toggle between the graph and text views, simply press the <code>spacebar</code> button.</p>
<ul>
<li><p>The <code>Graph view</code> offers a pictorial representation of the program&#39;s control flow, facilitating a better understanding of execution flow, identification of loops, conditionals, and jumps, and a visualization of how the program branches or cycles through different code paths.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_graph\_view.png" alt="Image"></p>
<p>The functions are displayed as <code>nodes</code> in the <code>Graph view</code>. Each function is depicted as a distinct node with a unique identifier and additional details such as the <code>function name</code>, <code>address</code>, and <code>size</code>.</p>
</li>
<li><p>The <code>Text view</code> displays the assembly instructions along with their corresponding memory addresses. Each line in the <code>Text view</code> represents an <code>instruction or a data element</code> in the code, beginning with the <code>section name:virtual address</code> format (for example, <code>.text:00000000004014F0</code>, where the section name is <code>.text</code> and the virtual address is <code>00000000004014F0</code>).</p>
<p>Code: ida</p>
<pre><code class="lang-ida"><span class="hljs-string">text:</span><span class="hljs-number">00000000004014</span>F0 ; =============== S U B R O U T I N E =======================================
<span class="hljs-string">text:</span><span class="hljs-number">00000000004014</span>F0
<span class="hljs-string">text:</span><span class="hljs-number">00000000004014</span>F0
<span class="hljs-string">text:</span><span class="hljs-number">00000000004014</span>F0                 <span class="hljs-keyword">public</span> start
<span class="hljs-string">text:</span><span class="hljs-number">00000000004014</span>F0 start           proc near               ; DATA <span class="hljs-string">XREF:</span> .<span class="hljs-string">pdata:</span><span class="hljs-number">000000000040603</span>Câ†“o
<span class="hljs-string">text:</span><span class="hljs-number">00000000004014</span>F0
<span class="hljs-string">text:</span><span class="hljs-number">00000000004014</span>F0 ; FUNCTION CHUNK AT             .<span class="hljs-string">text:</span><span class="hljs-number">00000000004022</span>A0 SIZE <span class="hljs-number">000001</span>B0 BYTES
<span class="hljs-string">text:</span><span class="hljs-number">00000000004014</span>F0
<span class="hljs-string">text:</span><span class="hljs-number">00000000004014</span>F0 ; __unwind { <span class="hljs-comment">// __C_specific_handler</span>
<span class="hljs-string">text:</span><span class="hljs-number">00000000004014</span>F0                 sub     rsp, <span class="hljs-number">28</span>h
<span class="hljs-string">text:</span><span class="hljs-number">00000000004014</span>F4
<span class="hljs-string">text:</span><span class="hljs-number">00000000004014</span>F4 <span class="hljs-string">loc_4014F4:</span>                             ; DATA <span class="hljs-string">XREF:</span> .<span class="hljs-string">xdata:</span><span class="hljs-number">0000000000407058</span>â†“o
<span class="hljs-string">text:</span><span class="hljs-number">00000000004014</span>F4 ;   __try { <span class="hljs-comment">// __except at loc_40150C</span>
<span class="hljs-string">text:</span><span class="hljs-number">00000000004014</span>F4                 mov     rax, <span class="hljs-string">cs:</span>off_405850
<span class="hljs-string">text:</span><span class="hljs-number">00000000004014</span>FB                 mov     dword ptr [rax], <span class="hljs-number">0</span>
<span class="hljs-string">text:</span><span class="hljs-number">0000000000401501</span>                 call    sub_401650
<span class="hljs-string">text:</span><span class="hljs-number">0000000000401506</span>                 call    sub_401180
<span class="hljs-string">text:</span><span class="hljs-number">000000000040150</span>B                 nop
<span class="hljs-string">text:</span><span class="hljs-number">000000000040150</span>B ;   } <span class="hljs-comment">// starts at 4014F4</span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_text\_view.png" alt="Image"></p>
<p><code>IDA</code>&#39;s <code>Text view</code> employs arrows to signify different types of control flow instructions and jumps. Here are some commonly seen arrows and their interpretations:</p>
<ul>
<li><code>Solid Arrow (â†’)</code>: A solid arrow denotes a direct jump or branch instruction, indicating an unconditional shift in the program&#39;s flow where execution moves from one location to another. This occurs when a jump or branch instruction like <code>jmp</code> or <code>call</code> is encountered.</li>
<li><code>Dashed Arrow (---â†’)</code>: A dashed arrow represents a conditional jump or branch instruction, suggesting that the program&#39;s flow might change based on a specific condition. The destination of the jump depends on the condition&#39;s outcome. For instance, a <code>jz</code> (jump if zero) instruction will trigger a jump only if a previous comparison yielded a zero value. <img src="https://academy.hackthebox.com/storage/modules/227/ida\_text\_view\_arrows.png" alt="Image"></li>
</ul>
</li>
</ul>
<p>By default, IDA initially exhibits the main function or the function at the program&#39;s designated entry point. However, we have the liberty to explore and examine other functions in the graph view.</p>
<h4 id="recognizing-the-main-function-in-ida">Recognizing the Main Function in IDA</h4>
<p>The following screenshot demonstrates the <code>start</code> function, which is the program&#39;s entry point and is generally responsible for setting up the runtime environment before invoking the actual <code>main</code> function. This is the initial <code>start</code> function shown by IDA after the executable is loaded.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_\_001\_start.png" alt="Image"></p>
<p>Our objective is to locate the actual main function, which necessitates further exploration of the disassembly. We will search for function calls or jumps that lead to other functions, as one of them is likely to be the main function. <code>IDA</code>&#39;s graph view, cross-references, or function list can aid in navigating through the disassembly and identifying the <code>main</code> function.</p>
<p>However, to reach the <code>main</code> function, we first need to understand the function of this <code>start</code> function. This function primarily consists of some initialization code, exception handling, and function calls. It eventually jumps to the <code>loc_40150C</code> label, which is an exception handler. Therefore, we can infer that this is not the actual main function where the program logic typically resides. We will inspect the other function calls to identify the <code>main</code> function.</p>
<p>The code commences by subtracting <code>0x28</code> (40 in decimal) from the <code>rsp</code> (stack pointer) register, effectively creating space on the stack for local variables and preserving the previous stack contents.</p>
<p>Code: ida</p>
<pre><code class="lang-ida">public start
start proc near

; FUNCTION CHUNK AT .text:<span class="hljs-number">00000000004022A0</span> SIZE <span class="hljs-number">000001B0</span> BYTES

; __unwind { // __C_specific_handler
sub     rsp, 28h
</code></pre>
<p>The middle block in the screenshot above represents an exception handling mechanism that uses <code>structured exception handling (SEH)</code> in the code. The <code>__try</code> and <code>__except</code> keywords suggest the setup of an exception handling block. Within this, the subsequent <code>call</code> instructions call two subroutines (functions) named <code>sub_401650</code> and <code>sub_401180</code>, respectively. These are placeholder names automatically generated by IDA to denote subroutines, program locations, and data. The autogenerated names usually bear one of the following prefixes followed by their corresponding virtual addresses: <code>sub_&lt;virtual_address&gt;</code> or <code>loc_&lt;virtual_address&gt;</code> etc.</p>
<p>Code: ida</p>
<pre><code class="lang-ida"><span class="hljs-symbol">loc_4014F4:</span>
<span class="hljs-comment">;   __try { // __except at loc_40150C</span>
<span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rax</span>, <span class="hljs-built_in">cs</span>:off_405850
<span class="hljs-keyword">mov</span>     <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rax</span>], <span class="hljs-number">0</span>
<span class="hljs-keyword">call</span>    sub_401650         <span class="hljs-comment">; Will inspect this function</span>
<span class="hljs-keyword">call</span>    sub_401180         <span class="hljs-comment">; Will inspect this function</span>
<span class="hljs-keyword">nop</span>
<span class="hljs-comment">;   } // starts at 4014F4</span>

-----------------------------------------------
<span class="hljs-symbol">
loc_40150C:</span>
<span class="hljs-comment">;   __except(TopLevelExceptionFilter) // owned by 4014F4</span>
<span class="hljs-keyword">nop</span>
<span class="hljs-keyword">add</span>     <span class="hljs-built_in">rsp</span>, <span class="hljs-number">28h</span>
<span class="hljs-keyword">retn</span>
<span class="hljs-comment">; } // starts at 4014F0</span>
start endp
</code></pre>
<h4 id="navigating-through-functions-in-ida">Navigating Through Functions in IDA</h4>
<p>Let&#39;s inspect the contents of these two functions <code>sub_401650</code> and <code>sub_401180</code> by navigating within each function to peruse the disassembled code.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_function\_calls.png" alt="Image"></p>
<p>We will initially open the first function/subroutine <code>sub_401650</code>. To enter a function in <code>IDA</code>&#39;s disassembly view, place the cursor on the instruction that represents the function call (or jump instruction) we want to follow, then right-click on the instruction and select <code>Jump to Operand</code> from the context menu. Alternatively, we can press the <code>Enter</code> key on our keyboard.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_function\_enter.png" alt="Image"></p>
<p>Then, <code>IDA</code> will guide us to the target location of the jump or function call, taking us to the start of the called function or the destination of the jump.</p>
<p>Now that we&#39;re inside the first function/subroutine <code>sub_401650</code>, let&#39;s strive to understand it in order to determine if it&#39;s the <code>main</code> function. If not, we&#39;ll navigate through other functions and discern the call to the <code>main</code> function.</p>
<p>In this subroutine <code>sub_401650</code>, we can see call instructions to the functions such as <code>GetSystemTimeAsFileTime</code>, <code>GetCurrentProcessId</code>, <code>GetCurrentThreadId</code>, <code>GetTickCount</code>, and <code>QueryPerformanceCounter</code>. This pattern is frequently observed at the beginning of disassembled executable code and typically consists of setting up the initial stack frame and carrying out some system-related initialization tasks.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_\_002\_initial\_stack.png" alt="Image"></p>
<p>The type of instructions detailed here are typically found in the executable code produced by compilers targeting the x86/x64 architecture. When an executable is loaded and run by the operating system, it falls to the operating system to ready the execution environment for the program. This process involves tasks such as stack setup, register initialization, and preparation of system-relevant data structures.</p>
<p>Broadly speaking, this section of code is part of the initial execution environment setup, carrying out necessary system-related initialization tasks before the program&#39;s main logic executes. The goal here is to guarantee that the program launches in a consistent state, with access to necessary system resources and information. To clarify, this isn&#39;t where the program&#39;s main logic resides, and so we need to explore other function calls to pinpoint the <code>main</code> function.</p>
<p>Let&#39;s return to and open the second subroutine, <code>sub_401180</code>, to examine its contents.</p>
<hr>
<p>To backtrack to the previous function we were scrutinizing, we can press the <code>Esc</code> key on our keyboard, or alternatively, we can click the <code>Jump Back</code> button in the toolbar.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_go\_back.png" alt="Image"></p>
<p><code>IDA</code> will transport us back to the previous function we were inspecting <code>(loc_4014F4</code>), taking us to where we were prior to shifting to the current function or location. We&#39;re now back at the preceding location, which contains the call instructions to the current function, <code>sub_401650</code>, as well as another function, <code>sub_401180</code>.</p>
<p>From here, we can position the cursor on the instruction to call <code>sub_401180</code> and press <code>Enter</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_go\_back\_enter.png" alt="Image"></p>
<p>This will guide us into the function <code>sub_401180</code>, where we will endeavor to identify the <code>main</code> function in which the program logic is situated.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_\_003\_startupinfo.png" alt="Image"></p>
<p>Upon examination, we can observe that this function seems to be implicated in initializing the <code>StartupInfo</code> structure and performing certain checks relative to its value. The <code>rep stosq</code> instruction nullifies a block of memory, while subsequent instructions modify the contents of registers and execute conditional jumps based on register values. This does not seem to be the <code>main</code> function in which the program logic resides, but it does contain a few <code>call</code> instructions which could potentially lead us to the <code>main</code> function. We will investigate all the <code>call</code> instructions prior to the return of this function.</p>
<p>We need to scroll to this function&#39;s endpoint and begin searching for <code>call</code> instructions from the bottommost one.</p>
<p>On scrolling upwards from the endpoint of this block (where the function returns), we observe a call to another subroutine, <code>sub_403250</code>, prior to this function&#39;s return.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_004\_intmain.png" alt="Image"></p>
<p>Our objective is to traverse the function calls preceding the program&#39;s exit in order to locate the main function, which might contain the initial code for registry check (sandbox detection) we witnessed in process monitor and strings.</p>
<p>We must now navigate to the function <code>sub_403250</code> to investigate its contents. To enter this function, we should position the cursor on the call instruction below:</p>
<p>Code: ida</p>
<pre><code class="lang-ida"><span class="hljs-built_in">call</span>    sub_403250
</code></pre>
<p>We can right-click on the instruction and select <code>Jump to Operand</code> from the context menu, or alternatively, we can press the <code>Enter</code> key. This action will reveal the disassembled function for <code>sub_403250</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_005\_main.png" alt="Image"></p>
<p>Upon reviewing the instructions, it appears that the function is querying the registry for the value associated with the <code>SOFTWARE\\VMware, Inc.\\VMware Tools</code> path and performing a comparison to discern whether VMWare Tools is installed on the machine. Generally speaking, it seems probable that this is the <code>main</code> function, which was referenced in the process monitor and strings.</p>
<p>We can observe that the registry query is performed using the function <code>RegOpenKeyExA</code>, as shown in the instruction <code>call cs:RegOpenKeyExA</code> in the disassembled code that follows:</p>
<p>Code: ida</p>
<pre><code class="lang-ida"><span class="hljs-keyword">xor</span>     <span class="hljs-built_in">r8d</span>, <span class="hljs-built_in">r8d</span>        <span class="hljs-comment">; ulOptions</span>
<span class="hljs-keyword">mov</span>     [<span class="hljs-built_in">rsp</span>+<span class="hljs-number">148h</span>+cbData], <span class="hljs-number">100h</span>
<span class="hljs-keyword">mov</span>     [<span class="hljs-built_in">rsp</span>+<span class="hljs-number">148h</span>+phkResult], <span class="hljs-built_in">rax</span> <span class="hljs-comment">; phkResult</span>
<span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r9d</span>, <span class="hljs-number">20019h</span>     <span class="hljs-comment">; samDesired</span>
<span class="hljs-keyword">lea</span>     <span class="hljs-built_in">rdx</span>, aSoftwareVmware <span class="hljs-comment">; "SOFTWARE\\VMware, Inc.\\VMware Tools"</span>
<span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rcx</span>, <span class="hljs-number">0FFFFFFFF80000002h</span> <span class="hljs-comment">; hKey</span>
<span class="hljs-keyword">call</span>    <span class="hljs-built_in">cs</span>:RegOpenKeyExA
</code></pre>
<p>In the code block above, the final instruction, <code>call cs:RegOpenKeyExA</code>, is presumably a representation of the <code>RegOpenKeyExA</code> function call, prefaced by <code>cs</code>. The function <code>RegOpenKeyExA</code> is a part of the Windows Registry API and is utilized to open a handle to a specified registry key. This function enables access to the Windows registry. The <code>A</code> in the function name signifies that it is the <code>ANSI version</code> of the function, which operates on ANSI-encoded strings.</p>
<p>In <code>IDA</code>, <code>cs</code> is a segment register that usually refers to the code segment. When we click on <code>cs:RegOpenKeyExA</code> and press <code>Enter</code>, this action takes us to the <code>.idata</code> section, which includes import-related data and the import address of the function <code>RegOpenKeyExA</code>. In this scenario, the <code>RegOpenKeyExA</code> function is imported from an external library (advapi32.dll), with its address stored in the <code>.idata</code> section for future use.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_winapi.png" alt="Image"></p>
<p>Code: ida</p>
<pre><code class="lang-ida"><span class="hljs-selector-class">.idata</span><span class="hljs-selector-pseudo">:0000000000409370</span> ; <span class="hljs-selector-tag">LSTATUS</span> (__<span class="hljs-selector-tag">stdcall</span> *<span class="hljs-selector-tag">RegOpenKeyExA</span>)(<span class="hljs-selector-tag">HKEY</span> <span class="hljs-selector-tag">hKey</span>, <span class="hljs-selector-tag">LPCSTR</span> <span class="hljs-selector-tag">lpSubKey</span>, <span class="hljs-selector-tag">DWORD</span> <span class="hljs-selector-tag">ulOptions</span>, <span class="hljs-selector-tag">REGSAM</span> <span class="hljs-selector-tag">samDesired</span>, <span class="hljs-selector-tag">PHKEY</span> <span class="hljs-selector-tag">phkResult</span>)
<span class="hljs-selector-class">.idata</span><span class="hljs-selector-pseudo">:0000000000409370</span>                 <span class="hljs-selector-tag">extrn</span> <span class="hljs-selector-tag">RegOpenKeyExA</span><span class="hljs-selector-pseudo">:qword</span>
<span class="hljs-selector-class">.idata</span><span class="hljs-selector-pseudo">:0000000000409370</span>                                         ; <span class="hljs-selector-tag">CODE</span> <span class="hljs-selector-tag">XREF</span>: <span class="hljs-selector-tag">sub_403160</span>+3<span class="hljs-selector-tag">E</span>â†‘<span class="hljs-selector-tag">p</span>
<span class="hljs-selector-class">.idata</span><span class="hljs-selector-pseudo">:0000000000409370</span>                                         ; <span class="hljs-selector-tag">sub_403220</span>+3<span class="hljs-selector-tag">C</span>â†‘<span class="hljs-selector-tag">p</span>
<span class="hljs-selector-class">.idata</span><span class="hljs-selector-pseudo">:0000000000409370</span>                                         ; <span class="hljs-selector-tag">DATA</span> <span class="hljs-selector-tag">XREF</span>: ...
</code></pre>
<p>This is not the actual address of the <code>RegOpenKeyExA</code> function, but rather the address of the entry in the <code>IAT (Import Address Table)</code> for <code>RegOpenKeyExA</code>. The IAT entry houses the address that will be dynamically resolved at runtime to point to the actual function implementation in the respective DLL (in this case, advapi32.dll).</p>
<p>The line <code>extrn RegOpenKeyExA:qword</code> indicates that <code>RegOpenKeyExA</code> is an external symbol to be resolved at runtime. This alerts the assembler that the function is defined in another module or library, and the linker will handle the resolution of its address during the linking process.</p>
<p><a href="https://learn.microsoft.com/en-us/windows/win32/debug/pe-format#import-address-table">Reference: https://learn.microsoft.com/en-us/windows/win32/debug/pe-format#import-address-table</a></p>
<p>In actuality, <code>cs:RegOpenKeyExA</code> is a means of accessing the <code>IAT</code> entry for <code>RegOpenKeyExA</code> in the code segment using a relative reference. The actual address of <code>RegOpenKeyExA</code> will be resolved and stored in the IAT during runtime by the operating system&#39;s dynamic linker/loader.</p>
<p>Based on the overall structure of this function, we can conjecture that this is the possible <code>main</code> function. Let&#39;s rename it to <code>assumed_Main</code> for easy recollection in the event we come across references to this function in the future.</p>
<hr>
<p>To rename a function in <code>IDA</code>, we should proceed as follows:</p>
<ul>
<li>Position the cursor on the function name (<code>sub_403250</code>) or the line containing the function definition. Then, press the <code>N</code> key on the keyboard, or right-click and select <code>Rename</code> from the context menu.</li>
<li>Input the new name for the function and press <code>Enter</code>.</li>
</ul>
<p>IDA will update the function name throughout the disassembly view and any references to the function within the binary.</p>
<p><strong>Note</strong>: Renaming a function in <code>IDA</code> does not modify the actual binary file. It only alters the representation within <code>IDA</code>&#39;s analysis.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_006\_assumed\_main.png" alt="Image"></p>
<p>Let&#39;s now delve into the instructions present in this block of code.</p>
<p>We can identify two function calls emanating from this function (<code>sub_401610</code> and <code>sub_403110</code>) prior to calling the Windows API function <code>RegOpenKeyExA</code>. Let&#39;s examine both of these before we advance to the WINAPI functions.</p>
<p>Let&#39;s delve into these functions by directing the cursor to their respective <code>call</code> instructions and tapping <code>Enter</code> to glimpse within.</p>
<p>Begin by examining the disassembled code for the first subroutine <code>sub_401610</code>. Initiate the journey into the subroutine by pressing <code>Enter</code> on the call instruction for <code>sub_401610</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_enter\_init\_checks\_.png" alt="Image"></p>
<p>We find ourselves in the first subroutine <code>sub_401610</code>, which examines the value of a variable (<code>cs:dword_408030</code>). If its value is zero, it is redefined as one. It subsequently redirects to <code>sub_4015A0</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_007\_init\_checks.png" alt="Image"></p>
<p>The following instructions detail <code>sub_401610</code>. Let&#39;s strive to comprehend its nuances.</p>
<p>Code: ida</p>
<pre><code class="lang-ida">sub_401610 <span class="hljs-keyword">proc</span><span class="hljs-title"> near</span>
<span class="hljs-title">
mov</span> <span class="hljs-title">    eax,</span> cs:dword_408030<span class="hljs-title">
test</span> <span class="hljs-title">   eax,</span> eax<span class="hljs-title">
jz</span> <span class="hljs-title">     short</span> loc_401620<span class="hljs-title"> 

loc_401620:</span>
mov<span class="hljs-title">     cs:dword_408030,</span> 1<span class="hljs-title">
jmp</span> <span class="hljs-title">    sub_4015A0</span>
sub_401610<span class="hljs-title"> endp</span>
</code></pre>
<p>It initiates by transferring the value of the variable <code>dword_408030</code> into the <code>eax</code> register. It then conducts a <code>bitwise AND</code> operation with <code>eax</code> and itself, essentially evaluating whether the value is <code>zero</code>. If the result of the preceding test instruction deems <code>eax</code> as <code>zero</code>, it redirects to <code>sub_4015A0</code>. Let&#39;s dissect its code further.</p>
<p>Code: ida</p>
<pre><code class="lang-ida">sub_4015A0 proc <span class="hljs-built_in">near</span>

<span class="hljs-keyword">push</span>    <span class="hljs-built_in">rsi</span>
<span class="hljs-keyword">push</span>    <span class="hljs-built_in">rbx</span>
<span class="hljs-keyword">sub</span>     <span class="hljs-built_in">rsp</span>, <span class="hljs-number">28h</span>
<span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rdx</span>, <span class="hljs-built_in">cs</span>:off_405730
<span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rax</span>, [<span class="hljs-built_in">rdx</span>]
<span class="hljs-keyword">mov</span>     <span class="hljs-built_in">ecx</span>, <span class="hljs-built_in">eax</span>
<span class="hljs-keyword">cmp</span>     <span class="hljs-built_in">eax</span>, <span class="hljs-number">0FFFFFFFFh</span>
<span class="hljs-keyword">jz</span>      short loc_4015F0
</code></pre>
<p>By pressing <code>Enter</code> while the cursor is on the function name <code>sub_4015A0</code>, we navigate to the disassembled code, revealing that the function commences by pushing the values of the <code>rsi</code> and <code>rbx</code> registers onto the stack, preserving the register values. Subsequently, it allots space on the stack by subtracting <code>28h (40 decimal)</code> bytes from the stack pointer (<code>rsp</code>). It then retrieves a function pointer from the address encapsulated in <code>off_405730</code> and stashes it in the <code>rax</code> register.</p>
<p>In essence, they seem to execute initialization checks and operations related to function pointers before the program proceeds to call the second subroutine <code>sub_403110</code> and the WINAPI function for registry operations. This isn&#39;t the actual main function hosting the program logic, so we&#39;ll scrutinize other function calls to pinpoint the <code>main</code> function.</p>
<p>We can rename this function as <code>initCheck</code> for our remembrance by pressing <code>N</code> and typing in the new function name.</p>
<p>At this point, we either press the <code>Esc</code> key or select the <code>Jump Back</code> button in the toolbar to revert to the second subroutine <code>sub_403110</code> and explore its inner workings.</p>
<p>Once we&#39;ve navigated back to the previous function (<code>assumed_Main</code>), we should position the cursor on the <code>call sub_403110</code> instruction and hit <code>Enter</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/correction.png" alt="Image"></p>
<p>This transition lands us in the disassembled code for this function. Let&#39;s examine it to determine its operation.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_008\_shellexecutea.png" alt="Image"></p>
<p>The variables <code>Parameters</code>, <code>File</code> and <code>Operation</code> are string variables stowed in the <code>.rdata</code> section of the executable. The <code>lea</code> instructions are utilized to obtain the memory addresses of these strings, which are subsequently passed as arguments to the <code>ShellExecuteA</code> function. This block of code is accountable for a <code>sleep</code> duration of <code>5 seconds</code>. Following that, it reverts to the preceding function. Having understood the code, we can rename this function as <code>pingSleep</code> by right-clicking and choosing rename.</p>
<p>Now that we&#39;ve encountered some references for Windows API functions, let&#39;s elucidate how WINAPI functions are interpreted in the disassembled code.</p>
<hr>
<p>After investigating the operations within the two function calls (<code>sub_401610</code> and <code>sub_403110</code>) from this function and before invoking the Windows API function <code>RegOpenKeyExA</code>, let&#39;s inspect the calls made to WINAPI function <code>RegOpenKeyExA</code>. In this <code>IDA</code> disassembly view, the arguments passed to the WINAPI function call are depicted above the <code>call</code> instruction. This standard convention in disassemblers offers a lucid representation of the function call along with its corresponding arguments.</p>
<p>The Windows API function, <code>RegOpenKeyExA</code>, is utilized here to unlock a registry key. The syntax of this function, as per Microsoft documentation, is presented below.</p>
<p>Code: ida</p>
<pre><code class="lang-ida"><span class="hljs-function">LSTATUS <span class="hljs-title">RegOpenKeyExA</span>(<span class="hljs-params">
  [<span class="hljs-keyword">in</span>]           HKEY   hKey,
  [<span class="hljs-keyword">in</span>, optional] LPCSTR lpSubKey,
  [<span class="hljs-keyword">in</span>]           DWORD  ulOptions,
  [<span class="hljs-keyword">in</span>]           REGSAM samDesired,
  [<span class="hljs-keyword">out</span>]          PHKEY  phkResult
</span>)</span>;
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/227/msdn\_001\_regopenkey.png" alt="Image"></p>
<p>Let&#39;s deconstruct the code for this function as it appears in the <code>IDA</code> disassembled view.</p>
<p>Code: ida</p>
<pre><code class="lang-ida"><span class="hljs-keyword">lea</span>     <span class="hljs-built_in">rax</span>, [<span class="hljs-built_in">rsp</span>+<span class="hljs-number">148h</span>+hKey]      <span class="hljs-comment">; Calculate the address of hKey</span>
<span class="hljs-keyword">xor</span>     <span class="hljs-built_in">r8d</span>, <span class="hljs-built_in">r8d</span>                  <span class="hljs-comment">; Clear r8d register (ulOptions)</span>
<span class="hljs-keyword">mov</span>     [<span class="hljs-built_in">rsp</span>+<span class="hljs-number">148h</span>+phkResult], <span class="hljs-built_in">rax</span> <span class="hljs-comment">; Store the calculated address of hKey in phkResult</span>
<span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r9d</span>, <span class="hljs-number">20019h</span>               <span class="hljs-comment">; Set samDesired to 0x20019h (which is KEY_READ in MS-DOCS)</span>
<span class="hljs-keyword">lea</span>     <span class="hljs-built_in">rdx</span>, aSoftwareVmware      <span class="hljs-comment">; Load address of string "SOFTWARE\\VMware, Inc.\\VMware Tools"</span>
<span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rcx</span>, <span class="hljs-number">0FFFFFFFF80000002h</span>   <span class="hljs-comment">; Set hKey to 0xFFFFFFFF80000002h (HKEY_LOCAL_MACHINE)</span>
<span class="hljs-keyword">call</span>    <span class="hljs-built_in">cs</span>:RegOpenKeyExA          <span class="hljs-comment">; Call the RegOpenKeyExA function</span>
<span class="hljs-keyword">test</span>    <span class="hljs-built_in">eax</span>, <span class="hljs-built_in">eax</span>                  <span class="hljs-comment">; Check the return value</span>
<span class="hljs-keyword">jnz</span>     short loc_40330F          <span class="hljs-comment">; Jump if the return value is not zero (error condition)</span>
</code></pre>
<p>The <code>lea</code> instruction calculates the address of the <code>hKey</code> variable, presumably a handle to a registry key. Then, <code>mov rcx, 0FFFFFFFF80000002h</code> pushes <code>HKEY_LOCAL_MACHINE</code> as the first argument (<code>rcx</code>) to the function. The <code>lea rdx, aSoftwareVmware</code> instruction employs the <code>load effective address (LEA)</code> operation to calculate the effective address of the memory location storing the string <code>Software\\VMware, Inc.\\VMware Tools</code>. This calculated address is then stowed in the <code>rdx</code> register, the function&#39;s second argument.</p>
<p>The third argument to this function is passed to the <code>r8d</code> register via the instruction <code>xor r8d, r8d</code> which empties the <code>r8d</code> register by implementing an <code>XOR</code> operation with itself, effectively resetting it to zero. In the context of this code, it indicates that the third argument (<code>ulOptions</code>) passed to the <code>RegOpenKeyExA</code> function bears a value of <code>0</code>.</p>
<p>The fourth argument is <code>mov r9d, 20019h</code>, corresponding to <code>KEY_READ</code> in <a href="https://learn.microsoft.com/en-us/windows/win32/sysinfo/registry-key-security-and-access-rights">MS-DOCS</a>.</p>
<p>The fifth argument, <code>phkResult</code>, is on the stack. By adding <code>rsp+148h</code> to the base stack pointer <code>rsp</code>, the code accesses the memory location on the stack where the <code>phkResult</code> parameter resides. The <code>mov [rsp+148h+phkResult], rax</code> instruction duplicates the value of <code>rax</code> (which holds the address of <code>hKey</code>) to the memory location pointed to by <code>phkResult</code>, essentially storing the address of <code>hKey</code> in <code>phkResult</code> (which is passed to the next function as the first argument).</p>
<p>From this point onward, whenever we stumble upon a WINAPI function reference in the code, we&#39;ll resort to the Microsoft documentation for that function to grasp its syntax, parameters, and the return value. This will assist us in understanding the probable values in the registers when these functions are invoked.</p>
<p>Should we scroll down the graph view, we encounter the next WINAPI function <code>RegQueryValueExA</code> which retrieves the type and data for the specified value name associated with an open registry key. The key data is compared, and upon a match, a message box stating <code>Sandbox Detected</code> is displayed. If it does not match, then it redirects to another subroutine <code>sub_402EA0</code>. We&#39;ll also rectify this sandbox detection in the debugger later. The image below outlines the overall flow of this operation.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_009\_after\_sandbox.png" alt="Image"></p>
<p>Let&#39;s press <code>Enter</code> on the upcoming call instruction for the function <code>sub_402EA0</code> to enable us to scrutinize this subroutine and figure out its operations.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_010\_getaddrinfo.png" alt="Image"></p>
<p>Upon pressing <code>Enter</code>, we uncover its functionality. This subroutine seems to execute network-related operations using the <code>Windows Sockets API (Winsock)</code>. It initially invokes the <code>WSAStartup</code> function to set up the <code>Winsock</code> library, then it calls the <code>WSAAPI</code> function <code>getaddrinfo</code> which is used to fetch address information for the specified node name (<code>pNodeName</code>) based on the provided hints <code>pHints</code>. The subroutine verifies the success of the address resolution using the <code>getaddrinfo</code> function.</p>
<p>If the <code>getaddrinfo</code> function yields a return value of <code>zero</code> (indicating success), this implies that the address has been successfully resolved to an IP. Following this event, if indeed successful, the sequence jumps to a MessageBox which displays <code>Sandbox detected</code>. If not, it directs the flow to the subroutine <code>sub_402D00</code>.</p>
<p>Subsequently, it prompts the invocation of the <code>WSACleanup</code> function. This action initiates the cleanup of resources related to <code>Winsock</code>, irrespective of whether the address resolution process was successful or unsuccessful. For the sake of clarity, we&#39;ll christen this function as <code>DomainSandboxCheck</code>.</p>
<p><strong>Possible IOC</strong>: Kindly note the domain name <code>iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com</code> as a component of potential <code>IOC</code>s.</p>
<p>To explore the consequences of bypassing the sandbox check, we&#39;ll delve into the subroutine <code>sub_402D00</code>. We can scrutinize this subroutine by hitting <code>Enter</code> on the ensuing <code>call</code> instruction related to the <code>sub_402D00</code> function. An image attached below displays the disassembled code for this function.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_011\_func\_check.png" alt="Image"></p>
<p>This function first reserves space on the stack for local variables before calling <code>sub_402C20</code>, a distinct function. The output of this function is then stored within the <code>eax</code> register. Depending on the results derived from the <code>sub_402C20</code> function, the sequence either returns (<code>retn</code>) or leaps to <code>sub_402D20</code>.</p>
<p>Consequently, we&#39;ll select the first highlighted function, <code>sub_402C20</code>, by pressing <code>Enter</code> to examine its instructions. Upon thorough analysis of <code>sub_402C20</code>, we&#39;ll loop back to this block to evaluate the second highlighted function, <code>sub_402D20</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_012\_socketconnect.png" alt="Image"></p>
<p>Upon hitting <code>Enter</code>, we are greeted with its instructions as portrayed in the image above. This function initiates the <code>Winsock</code> library, generates a socket, and connects to IP address <code>45.33.32.156</code> via port <code>31337</code>. It evaluates the return value (<code>eax</code>) to ascertain if the connection was successful. However, there is a twist; post-function invocation, the instruction <code>inc eax</code> increments the <code>eax</code> register&#39;s value by <code>1</code>. Subsequent to the <code>inc eax</code> instruction, the code appraises the value of <code>eax</code> using the <code>jnz (jump if not zero)</code> instruction.</p>
<p>Should the connection to the aforementioned port and IP address fail, this function should return <code>-1</code>, as specified in the documentation.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_013\_socketerror.png" alt="Image"></p>
<p>Code: ida</p>
<pre><code class="lang-ida"><span class="hljs-keyword">call</span>    <span class="hljs-built_in">cs</span>:connect
<span class="hljs-keyword">inc</span>     <span class="hljs-built_in">eax</span>
<span class="hljs-keyword">jnz</span>     short loc_402CD0
</code></pre>
<p>Given that <code>eax</code> is incremented by <code>1</code> post-function call, this should reduce to <code>0</code>. Consequently, the <code>MessageBox</code> will print <code>Sandbox detected</code>. This implies that the function is examining the state of the internet connection.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_014\_jump\_check.png" alt="Image"></p>
<p>If, on the other hand, the connection is successful, it will produce a <code>non-zero</code> value, prompting the code to leap to <code>loc_402CD0</code>. This location houses a call to another function, <code>sub_402F40</code>. With a clear understanding of this function&#39;s operations, we&#39;ll rename it as <code>InternetSandboxCheck</code>.</p>
<p><strong>Possible IOC</strong>: Remember to note this IP address <code>45.33.32.156</code> and port <code>31337</code> as components of potential <code>IOC</code>s.</p>
<p>Next, we&#39;ll proceed to function <code>sub_402F40</code> to decipher its operations. We can do this by right-clicking and selecting <code>Jump to Operand</code>, or by pressing <code>Enter</code> on its <code>call</code> instruction.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_015\_svchost.png" alt="Image"></p>
<p>This function calls upon the <code>getenv</code> function (with <code>rcx</code> acting as the argument passer for <code>TEMP</code>) and saves its result in the <code>eax</code> register. This action retrieves the <code>TEMP</code> environment variable&#39;s value.</p>
<p>Code: ida</p>
<pre><code class="lang-ida"><span class="hljs-keyword">lea</span>     <span class="hljs-built_in">rcx</span>, VarName    <span class="hljs-comment">; "TEMP"</span>
<span class="hljs-keyword">call</span>    getenv
</code></pre>
<p>To verify the output, we can use powershell to print the <code>TEMP</code> environment variable&#39;s value.</p>
<p>Code Analysis</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\&gt;</span> Get-ChildItem env:TEMP

Name                           Value
----                           -----
TEMP                           C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb-student<span class="hljs-symbol">\A</span>ppData<span class="hljs-symbol">\L</span>ocal<span class="hljs-symbol">\T</span>emp
</code></pre>
<p>It then employs the <code>sprintf</code> function to append the obtained <code>TEMP</code> path to the string <code>svchost.exe</code>, yielding a complete file path. Thereafter, the <code>GetComputerNameA</code> function is called to retrieve the computer&#39;s name, which is then stored in a buffer.</p>
<p>If the computer name is non-existent, it skips to the label <code>loc_4030F8</code> (which houses instructions for returning). Conversely, if the computer name is not empty (<code>non-zero</code> value), the code progresses to the subsequent instruction as displayed on the left side of the image.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_016\_svchost\_download.png" alt="Image"></p>
<p>In subsequent instructions, we find a call to the function <code>sub_403220</code>. We can access it by double-clicking on the function name.</p>
<p>The left side of the attached image above displays the function <code>sub_403220</code>, which formats a string housing a custom <code>user-agent</code> value with the string <code>Windows-Update/7.6.7600.256 %s</code>. The <code>%s</code> placeholder is replaced with the previously obtained computer name, which is transmitted to this function in the <code>rcx</code> register.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_016\_svchost\_temp.png" alt="Image"></p>
<p>Now, the complete value reads <code>Windows-Update/7.6.7600.256 HOSTNAME</code>, where <code>HOSTNAME</code> is the result of <code>GetComputerNameA</code> (the computer&#39;s name).</p>
<p>It&#39;s crucial to note this unique custom <code>user-agent</code>, wherein the hostname is also transmitted in the request when the malware initiates a network connection.</p>
<p>Back to the previous function, it subsequently calls the <code>InternetOpenA</code> WINAPI function to commence an internet access session and configure the parameters for the <code>InternetOpenUrlA</code> function. It then proceeds to call the latter to open the URL <code>http://ms-windows-update.com/svchost.exe</code>.</p>
<p><strong>Possible IOC</strong>: Do note this URL <code>http[:]//ms-windows-update[.]com/svchost[.]exe</code> as potential <code>IOC</code>. The malware is downloading an additional executable from this location.</p>
<p>If the URL opens successfully, the code leaps to the label <code>loc_40301E</code>. Let&#39;s probe the instructions at <code>loc_40301E</code> by double-clicking on it.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_017\_createfile.png" alt="Image"></p>
<p>Upon opening the function, we observe a call to the Windows API function <code>CreateFileA</code>, which is used to generate a file on the local system, designating the previously obtained file path.</p>
<p>The code then enters a loop, repeatedly invoking the <code>InternetReadFile</code> function to pull data from the opened URL <code>http[:]//ms-windows-update[.]com/svchost[.]exe</code>. If the data reading operation proves successful, the code advances to write the received data to the created file (<code>svchost.exe</code> located in the <code>TEMP</code> directory) using the <code>WriteFile</code> function.</p>
<p>Note this unique technique, where the malware downloads and deposits an executable file <code>svchost.exe</code> in the <code>temp</code> directory.</p>
<p>The aforementioned loop is illustrated in the image below.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_018\_readfile.png" alt="Image"></p>
<p>After the data writing operation, the code cycles back to read more data until the <code>InternetReadFile</code> function returns a value that indicates the end of the data stream. Once all data has been read and written, the opened file and the internet handles are closed using the appropriate functions (<code>CloseHandle</code> and <code>InternetCloseHandle</code>). Subsequently, the code leaps to <code>loc_4030D3</code>, where it calls upon the function <code>sub_403190</code>.</p>
<p>We&#39;ll double-click on <code>sub_403190</code> to unveil its contents.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_018\_writefile.png" alt="Image"></p>
<p>The function <code>sub_403190</code> is now exposed, revealing a series of WINAPI calls related to registry modifications, such as <code>RegOpenKeyExA</code> and <code>RegSetValueExA</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_19\_reg.png" alt="Image"></p>
<p>It appears that this function places the file (<code>svchost.exe</code> located in the <code>TEMP</code> directory) into the registry key path <code>SOFTWARE\Microsoft\Windows\CurrentVersion\Run</code> with the value name <code>WindowsUpdater</code>, then seals the registry key. This technique is frequently employed by both malware and legitimate applications to maintain their grip on the system across reboots, ensuring automatic operation each time the system initiates or a user logs in. We&#39;ve taken the liberty of renaming this function in <code>IDA</code> to <code>persistence_registry</code> for the sake of clarity.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_020\_regvalue.png" alt="Image"></p>
<p><strong>Possible IOC</strong>: Highlight this technique in which the malware modifies the registry to achieve persistence. It does so by adding an entry for <code>svchost.exe</code> under the <code>WindowsUpdater</code> name in the <code>SOFTWARE\Microsoft\Windows\CurrentVersion\Run</code> registry key.</p>
<p>Upon establishing the registry, it initiates another function, <code>sub_403150</code>, which sets in motion the dropped file <code>svchost.exe</code> and funnels an argument into it. A rudimentary Google search suggests that this argument could potentially be a <code>Bitcoin wallet address</code>. Thus, it&#39;s reasonable to postulate that the dropped executable could be a coin miner.</p>
<p>By rewinding our steps and inspecting the functions systematically, we can identify any residual functions that we&#39;ve not yet scrutinized. The <code>Esc</code> key or the <code>Jump Back</code> button in the toolbar facilitates this reverse tracking.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_021\_pendingfunction.png" alt="Image"></p>
<p>After tracing back on the analysed code, we&#39;ve reached this block, where a subroutine <code>sub_402D20</code> is pending for analysis. So let&#39;s double click to open it and see what&#39;s inside it.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_022\_notepad.png" alt="Image"></p>
<p>Upon opening the subroutine, it&#39;s clear that it&#39;s setting up the necessary parameters for the <code>CreateProcessA</code> function to generate a new process. It then proceeds to instigate a new process, <code>notepad.exe</code>, situated in the <code>C:\Windows\System32</code> directory.</p>
<p>Here is the syntax for the CreateProcessA function.</p>
<p>Code: ida</p>
<pre><code class="lang-ida">BOOL CreateProcessA(
  [<span class="hljs-keyword">in</span>, <span class="hljs-keyword">optional</span>]      LPCSTR                lpApplicationName,
  [<span class="hljs-keyword">in</span>, <span class="hljs-keyword">out</span>, <span class="hljs-keyword">optional</span>] LPSTR                 lpCommandLine,
  [<span class="hljs-keyword">in</span>, <span class="hljs-keyword">optional</span>]      LPSECURITY_ATTRIBUTES lpProcessAttributes,
  [<span class="hljs-keyword">in</span>, <span class="hljs-keyword">optional</span>]      LPSECURITY_ATTRIBUTES lpThreadAttributes,
  [<span class="hljs-keyword">in</span>]                BOOL                  bInheritHandles,
  [<span class="hljs-keyword">in</span>]                DWORD                 dwCreationFlags,
  [<span class="hljs-keyword">in</span>, <span class="hljs-keyword">optional</span>]      LPVOID                lpEnvironment,
  [<span class="hljs-keyword">in</span>, <span class="hljs-keyword">optional</span>]      LPCSTR                lpCurrentDirectory,
  [<span class="hljs-keyword">in</span>]                LPSTARTUPINFOA        lpStartupInfo,
  [<span class="hljs-keyword">out</span>]               LPPROCESS_INFORMATION lpProcessInformation
);
</code></pre>
<p>With <code>rdx</code> observed in the code, we see that the second argument to this function is pinpointed as <code>C:\\Windows\\System32\\notepad.exe</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_createProcess.png" alt="Image"></p>
<p>We note in the <code>CreateProcessA</code> function documentation that a <code>nonzero</code> return value indicates successful function execution. Consequently, if successful, it won&#39;t jump to <code>loc_402E89</code> but will continue to the next block of instructions.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_023\_procInj.png" alt="Image"></p>
<p>The subsequent block of instructions hints at a commonplace type of process injection, wherein <code>shellcode</code> is inserted into the newly created process using <code>VirtualAllocEx</code>, <code>WriteProcessMemory</code>, and <code>CreateRemoteThread</code> functions.</p>
<p>Let&#39;s decipher the process injection based on our observations of the code.</p>
<p>A fresh <code>notepad.exe</code> process is fabricated via the <code>CreateProcessA</code> function. Following this, memory is allocated within this process using <code>VirtualAllocEx</code>. The <code>shellcode</code> is then inscribed into the allocated memory of the remote process <code>notepad.exe</code> using the WINAPI function <code>WriteProcessMemory</code>. Lastly, a remote thread is established in <code>notepad.exe</code>, initiating the <code>shellcode</code> execution via the <code>CreateRemoteThread</code> function.</p>
<p>If the injection is triumphant, a message box manifests, declaring <code>Connection sent to C2</code>. Conversely, an error message surfaces in the event of failure.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_023\_conn\_sent.png" alt="Image"></p>
<p>For the sake of ease, let&#39;s rename the function <code>sub_402D20</code> as <code>process_Injection</code>.</p>
<p>At the outset of this function, we can spot an unknown address <code>unk_405057</code>, the effective address of which is loaded into the <code>rsi</code> register via the instruction <code>lea rsi, unk_405057</code>. Executed prior to the WINAPI functions call for the process injection, the reason for loading the effective address into <code>rsi</code> could be manifold - it might function as a data-accessing pointer or as a function call argument. There is, however, the possibility that this address houses potential <code>shellcode</code>. We will verify this when <code>debugging</code> these WINAPI functions using a debugger like <code>x64dbg</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_024\_shellcode.png" alt="Image"></p>
<p>Upon analyzing and renaming this process injection function, we will continue to retrace our steps to the preceding functions to ensure that no function has been overlooked.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_025\_backtomain.png" alt="Image"></p>
<p><code>IDA</code> also offers a feature that visualizes the execution flow between functions in an executable via a <code>call flow graph</code>. This potent visual tool aids analysts in navigating and understanding the control flow and the interactions among functions.</p>
<p>Here&#39;s how to generate and examine the graph to identify the links among different functions:</p>
<ul>
<li>Switch to the disassembly view.</li>
<li>Locate the <code>View</code> menu at the top of the <code>IDA</code> interface.</li>
<li>Hover over the <code>Graphs</code> option.</li>
<li>From the submenu, choose <code>Function calls</code>.</li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_graph\_flow.png" alt="Image"></p>
<p><code>IDA</code> will then forge the function calls flow graph for all functions in the binary and present it in a new window. This graph offers an overview of the calls made between the various functions in the program, enabling us to scrutinize the control flow and dependencies among functions. An example of how this graph appears is shown in the screenshot below.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_026\_callflowgraph.png" alt="Image"></p>
<p>Contrary to viewing the relationship graph for all function calls, we can also focus on specific functions. To generate the reference graph for the function calls flow related to a specific function, these steps can be followed.</p>
<ul>
<li>Navigate to the function whose function call flow graph we wish to examine.</li>
<li>To open the function in the disassembly view, either double-click the function name or press <code>Enter</code>.</li>
<li>In the disassembly view, right-click anywhere and opt for either <code>Xrefs graph to...</code> or <code>Xrefs graph from...</code>, based on whether we want to observe the function calls made by the selected function or the function calls leading to the selected function.</li>
<li><code>IDA</code> will craft the function calls flow graph and exhibit it in a new window.</li>
</ul>
<p>Looking ahead, we will delve into debugging in the subsequent section. There, we&#39;ll launch the executable within a debugger and establish breakpoints on the requisite instructions and select critical WINAPI functions. This strategy allows us to comprehend and manage the execution flow in real time as the program operates.</p>
<h2 id="debugging">Debugging</h2>
<p>Debugging adds a dynamic, interactive layer to code analysis, offering a real-time view of malware behavior. It empowers analysts to confirm their discoveries, witness runtime impacts, and deepen their comprehension of the program execution. Uniting code analysis and debugging allows for a comprehensive understanding of the malware, leading to the effective exposure of harmful behavior.</p>
<p>We could deploy a debugger like <code>x64dbg</code>, a user-friendly tool tailored for analyzing and debugging 64-bit Windows executables. It comes equipped with a graphical interface for visualizing disassembled code, implementing breakpoints, examining memory and registers, and controlling the execution of programs.</p>
<p>Let&#39;s now navigate to the bottom of this section and click on &quot;Click here to spawn the target system!&quot;. Then, let&#39;s RDP into the Target IP using the provided credentials. The vast majority of the actions/commands covered from this point up to end of this section can be replicated inside the target, offering a more comprehensive grasp of the topics presented.</p>
<pre><code class="lang-shell-session">[!bash!]$ xfreerdp <span class="hljs-regexp">/u:htb-student /</span><span class="hljs-string">p:</span><span class="hljs-string">'HTB_@cademy_stdnt!'</span> <span class="hljs-regexp">/v:[Target IP] /</span>dynamic-resolution
</code></pre>
<p>Here&#39;s how to run a sample within <code>x64dbg</code> to familiarize with its operations.</p>
<ul>
<li>Launch <code>x64dbg</code>.</li>
<li>At the top of the <code>x64dbg</code> interface, click the <code>File</code> menu.</li>
<li>Select <code>Open</code> to choose the executable file we wish to debug.</li>
<li>Browse to the directory containing the executable and select it.</li>
<li>Optionally, command-line arguments or the working directory can be specified in the dialog box that appears.</li>
<li>Click <code>OK</code> to load the executable into <code>x64dbg</code>.</li>
</ul>
<p>Upon opening, the default window halts at a default breakpoint at the program&#39;s entry point.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/x64dbg\_001\_views.png" alt="Image"></p>
<p>Loading an executable into <code>x64dbg</code> reveals the disassembly view, showcasing the assembly instructions of the program, thereby aiding in understanding the code flow. To the right, the register window divulges the values of CPU registers, shedding light on the program&#39;s state. Beneath the register window, the stack view displays the current stack frame, enabling the inspection of function calls and local variables. Lastly, on the bottom left corner, we find the memory dump view, providing a pictorial representation of the program&#39;s memory, facilitating the analysis of data structures and variables.</p>
<h3 id="simulating-internet-services">Simulating Internet Services</h3>
<p>The role of <code>INetSim</code> in simulating typical internet services in our restricted testing environment is pivotal. It offers support for a multitude of services, encompassing <code>DNS</code>, <code>HTTP</code>, <code>FTP</code>, <code>SMTP</code>, among others. We can fine-tune it to reproduce specific responses, thereby enabling a more tailored examination of the malware&#39;s behavior. Our approach will involve keeping <code>InetSim</code> operational so that it can intercept any <code>DNS</code>, <code>HTTP</code>, or other requests emanating from the malware sample (<code>shell.exe</code>), thereby providing it with controlled, synthetic responses.</p>
<p><strong>Note</strong>: It is highly recommended that we use your own VM/machine for running <code>InetSim</code>. Our VM/machine should be connected to VPN using the provided VPN config file that resides at the end of this section.</p>
<p>We should configure <code>INetSim</code> as follows.</p>
<pre><code class="lang-shell-session">[!bash!]$ sudo nano /etc/inetsim/inetsim.conf
</code></pre>
<p>The below need to be uncommented and specified.</p>
<pre><code class="lang-shell-session">service<span class="hljs-number">_</span>bind<span class="hljs-number">_</span>address &lt;Our machine<span class="hljs-string">'s/VM'</span>s TUN IP&gt;
dns<span class="hljs-number">_</span><span class="hljs-keyword">default</span><span class="hljs-number">_</span>ip &lt;Our machine<span class="hljs-string">'s/VM'</span>s TUN IP&gt;
dns<span class="hljs-number">_</span><span class="hljs-keyword">default</span><span class="hljs-number">_</span>hostname www
dns<span class="hljs-number">_</span><span class="hljs-keyword">default</span><span class="hljs-number">_</span>domainname iuqerfsodp<span class="hljs-number">9</span>ifjaposdfjhgosurijfaewrwergwea.com
</code></pre>
<p>Initiating <code>INetSim</code> involves executing the following command.</p>
<pre><code class="lang-shell-session">[<span class="hljs-name">!bash!</span>]$ sudo inetsim 
INetSim <span class="hljs-number">1.3</span>.2 (<span class="hljs-name">2020-05-19</span>) by Matthias Eckert &amp; Thomas Hungenberg
Using log directory:      /var/log/inetsim/
Using data directory:     /var/lib/inetsim/
Using report directory:   /var/log/inetsim/report/
Using configuration file: /etc/inetsim/inetsim.conf
Parsing configuration file.
Configuration file parsed successfully.
=== INetSim main process started (<span class="hljs-name">PID</span> <span class="hljs-number">34711</span>) ===
Session ID:     <span class="hljs-number">34711</span>
Listening on:   <span class="hljs-number">0.0</span>.0.0
Real Date/Time: <span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-11</span> <span class="hljs-number">00</span>:18:44
Fake Date/Time: <span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-11</span> <span class="hljs-number">00</span>:18:44 (<span class="hljs-name">Delta:</span> <span class="hljs-number">0</span> seconds)
 Forking services...
  * dns_53_tcp_udp - started (<span class="hljs-name">PID</span> <span class="hljs-number">34715</span>)
  * smtps_465_tcp - started (<span class="hljs-name">PID</span> <span class="hljs-number">34719</span>)
  * pop3_110_tcp - started (<span class="hljs-name">PID</span> <span class="hljs-number">34720</span>)
  * smtp_25_tcp - started (<span class="hljs-name">PID</span> <span class="hljs-number">34718</span>)
  * http_80_tcp - started (<span class="hljs-name">PID</span> <span class="hljs-number">34716</span>)
  * ftp_21_tcp - started (<span class="hljs-name">PID</span> <span class="hljs-number">34722</span>)
  * https_443_tcp - started (<span class="hljs-name">PID</span> <span class="hljs-number">34717</span>)
  * pop3s_995_tcp - started (<span class="hljs-name">PID</span> <span class="hljs-number">34721</span>)
  * ftps_990_tcp - started (<span class="hljs-name">PID</span> <span class="hljs-number">34723</span>)
 done.
Simulation running.
</code></pre>
<p>A more elaborate resource on configuring <code>INetSim</code> is the following: <a href="https://medium.com/@xNymia/malware-analysis-first-steps-creating-your-lab-21b769fb2a64">https://medium.com/@xNymia/malware-analysis-first-steps-creating-your-lab-21b769fb2a64</a></p>
<p>Finally, the spawned target&#39;s DNS should be pointed to the machine/VM where <code>INetSim</code> is running.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/point\_.png" alt="Image"></p>
<h3 id="applying-the-patches-to-bypass-sandbox-checks">Applying the Patches to Bypass Sandbox Checks</h3>
<p>Given that sandbox checks hinder the malware&#39;s direct execution on the machine, we need to patch these checks to circumvent the sandbox detection. Here&#39;s how we can dodge sandbox detection checks while debugging with <code>x64dbg</code>. Several methods can lead us to the instructions where sandbox detection is performed. We will discuss a few of these.</p>
<h4 id="by-copying-the-address-from-ida">By Copying the Address from IDA</h4>
<p>During code analysis, we observed the sandbox detection check related to the registry key. We can extract the address of the first <code>cmp</code> instruction directly from <code>IDA</code>.</p>
<p>To find the address, let&#39;s revert to the IDA windows, open the first function we had renamed as <code>assumed_Main</code>, and look for the <code>cmp</code> instruction. To view the addresses, we can transition from graph view to text view by pressing the spacebar button.</p>
<p>This exposes the address (as highlighted in the below screenshot)</p>
<p>We can copy the address <code>00000000004032C8</code> from <code>IDA</code>.</p>
<pre><code class="lang-ida"><span class="hljs-selector-class">.text</span><span class="hljs-selector-pseudo">:00000000004032C8</span>                 <span class="hljs-selector-tag">cmp</span>     <span class="hljs-selector-attr">[rsp+148h+Type]</span>, 1
</code></pre>
<p>In <code>x64dbg</code>, we can right-click anywhere on the disassembly view (CPU) and select <code>Go to</code> &gt; <code>Expression</code>. Alternatively, we can press <code>Ctrl+G</code> (go to expression) as a shortcut.</p>
<p>We can enter the copied address here, as shown in the screenshot. This navigates us to the comparison instruction where we can implement changes.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/ida\_027\_addresscp.png" alt="Image"></p>
<h4 id="by-searching-through-the-strings-">By Searching Through the Strings.</h4>
<p>Let&#39;s look for <code>Sandbox detected</code> in the <code>String references</code>, and set a <code>breakpoint</code>, so that when we hit run, the execution should pause at this point.</p>
<p>To do this, first click on the <code>Run</code> button once and then right-click anywhere on the disassembly view, and choose <code>Search for</code> &gt; <code>Current Module</code> &gt; <code>String references</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/x64dbg\_002\_strings\_.png" alt="Image"></p>
<p>Next, we can add a breakpoint to mark the location, then study the instructions before this Sandbox <code>MessageBox</code> to discern how the jump was made to the instruction printing <code>Sandbox detected</code>.</p>
<p>Let&#39;s start by adding a breakpoint at the last <code>Sandbox detected</code> string as follows.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/x64dbg\_002\_strings\_\_.png" alt="Image"></p>
<p>We can then double-click on the string to go to the address where the instructions to print <code>Sandbox detected</code> are located.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/x64dbg\_003\_cmp.png" alt="Image"></p>
<p>As observed, a <code>cmp</code> instruction is present above this <code>MessageBox</code> which compares the value with <code>1</code> after a registry path comparison has been performed. Let&#39;s modify this comparison value to match with <code>0</code> instead. This can be done by placing the cursor on that instruction and pressing <code>Spacebar</code> on the keyboard. This allows us to edit the assembly code instructions.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/x64dbg\_004\_assemble\_patch1.png" alt="Image"></p>
<p>We can change the comparison value of <code>0x1</code> to <code>0x0</code>. Changing the comparison to <code>0</code> may shift the control flow of the code, and it should not jump to the address where <code>MessageBox</code> is displayed.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/x64dbg\_004\_patch1.png" alt="Image"></p>
<p>Upon clicking on <code>Run</code> in <code>x64dbg</code> or pressing <code>F9</code>, it won&#39;t hit the breakpoint for the first sandbox detection message code. This means that we successfully patched the instructions.</p>
<p>In a similar manner, we can add a breakpoint on the next sandbox detection function before it prints a <code>MessageBox</code> as well. To do that, the breakpoint should be placed at the <code>second to last</code> <code>Sandbox detected</code> string (<code>0000000000402F13</code>). If we double-click this string we will notice there&#39;s a <code>jump</code> instruction which we can skip, directing the execution flow to the next instruction that calls another function. That&#39;s exactly what we need â€“ instead of the sandbox detection <code>MessageBox</code>, it jumps to another function.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/x64dbg\_005\_patch2.png" alt="Image"></p>
<p>We can alter the instruction from <code>je shell.402F09</code> to <code>jne shell.402F09</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/x64dbg\_006\_jne.png" alt="Image"></p>
<p><code>shell.exe</code> performs sandbox detection by checking for internet connectivity. This section&#39;s target doesn&#39;t have internet connectivity. For this reason we should patch this sandbox detection method as well. We can do that by clicking on the first <code>Sandbox detected</code> string (<code>0000000000402CBD</code>) and patching the following instruction.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/patch3.png" alt="Image"></p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/patch3\_.png" alt="Image"></p>
<p>Now, when we press <code>Run</code>, the patched <code>shell.exe</code> proceeds further, downloads the default executable from <code>INetSim</code>, and executes it.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/both\_messagebox.png" alt="Image"></p>
<p>With the sandbox checks bypassed, the actual functionality is unveiled. We can save the patched executable by pressing <code>Ctrl+P</code> and clicking on <code>Patch File</code>. This action stores the patched file, which skips the sandbox checks.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/patch3\_\_.png" alt="Image"></p>
<p>We undertake this process to ensure that the next time we run the saved patched file, it executes directly without the sandbox checks, and we can observe all the events in <code>ProcessMonitor</code>.</p>
<h3 id="analyzing-malware-traffic">Analyzing Malware Traffic</h3>
<p>Keep in mind that traffic analysis not only can be, but ideally should be incorporated as an integral part of Dynamic Analysis.</p>
<p>Let&#39;s now employ <code>Wireshark</code>, to capture and examine the network traffic generated by the malware. Be mindful of the color-coded traffic: red corresponds to client-to-server traffic, while blue denotes the server-to-client exchanges.</p>
<p>Examining the HTTP Request reveals that the malware sample appends the computer hostname to the user agent field (in this case it was <code>RDSEMVM01</code>).</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/wireshark\_request.png" alt="Image"></p>
<p>When inspecting the HTTP Response, it becomes evident that <code>InetSim</code> has returned its default binary as a response to the malware.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/wireshark\_response.png" alt="Image"></p>
<p>The malware&#39;s request for <code>svchost.exe</code> solicits the default binary from <code>InetSim</code>. This binary responds with a <code>MessageBox</code> featuring the message: <code>This is the INetSim default binary</code>.</p>
<p>Additionally, DNS requests for a random domain and the address <code>ms-windows-update[.]com</code> were sent by the malware, with <code>INetSim</code> responding with fake responses (in this case <code>INetSim</code> was running on <code>10.10.10.100</code>).</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/wireshark\_dns.png" alt="Image"></p>
<h3 id="analyzing-process-injection-memory-region">Analyzing Process Injection &amp; Memory Region</h3>
<p>On the journey of code analysis, we discovered that our executable performs process injection on <code>notepad.exe</code> and displays a <code>MessageBox</code> stating <code>Connection sent to C2</code>.</p>
<p>To probe deeper into the process injection, we propose setting breakpoints at WINAPI functions <code>VirtualAllocEx</code>, <code>WriteProcessMemory</code>, and <code>CreateRemoteThread</code>. These breakpoints will allow us to scrutinize the content held in the registers during the process injection. Here&#39;s the procedure to set these breakpoints:</p>
<ul>
<li>Access the <code>x64dbg</code> interface and navigate to the <code>Symbols</code> tab, located at the top.</li>
<li>In the symbol search box, search for the desired DLL name on the left and function names, such as <code>VirtualAllocEx</code>, <code>WriteProcessMemory</code>, and <code>CreateRemoteThread</code>, on the right within the <code>Kernel32.dll</code> DLL.</li>
<li>As the function names materialize in the search results, right-click and select <code>Toggle breakpoint</code> from the context menu for each function. An alternative shortcut is to press <code>F2</code>.</li>
</ul>
<p>Executing these steps sets a breakpoint at each function&#39;s entry point. We&#39;ll replicate these steps for all the functions we intend to scrutinize.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/x64dbg\_008\_bp\_wpm.png" alt="Image"></p>
<p>After setting breakpoints, we press <code>F9</code> or select <code>Run</code> from the toolbar until we reach the breakpoint for <code>WriteProcessMemory</code>. Up until this moment, <code>notepad</code> has been launched, but the <code>shellcode</code> has not yet been written into notepad&#39;s memory.</p>
<h4 id="attaching-another-running-process-in-x64dbg">Attaching Another Running Process In x64dbg</h4>
<p>In order to delve further, let&#39;s open another instance of <code>x64dbg</code> and attach it to <code>notepad.exe</code>.</p>
<ul>
<li>Start a new instance of <code>x64dbg</code>.</li>
<li>Navigate to the <code>File</code> menu and select <code>Attach</code> or use the <code>Alt + A</code> keyboard shortcut.</li>
<li>In the <code>Attach</code> dialog box, a list of running processes will appear. Choose <code>notepad.exe</code> from the list.</li>
<li>Click the <code>Attach</code> button to begin the attachment process.</li>
</ul>
<p>Once the attachment is successful, <code>x64dbg</code> initiates the debugging of the target process, and the main window displays the assembly code along with other debugging information.</p>
<p>Now, we can establish breakpoints, step through the code, inspect registers and memory, and study the behavior of the attached notepad.exe process using <code>x64dbg</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/x64dbg\_009\_attach.png" alt="Image"></p>
<p>The 2nd argument of <code>WriteProcessMemory</code> is <code>lpBaseAddress</code> which contains a pointer to the base address in the specified process to which data is written. In our case, it should be in the <code>RDX</code> register.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/msdn\_002\_writeprocessmemory.png" alt="Image"></p>
<p>When invoking the <code>WriteProcessMemory</code> function, the <code>rdx</code> register holds the <code>lpBaseAddress</code> parameter. This parameter represents the address within the target process&#39;s address space where the data will be written.</p>
<p>We aim to examine the registers when the <code>WriteProcessMemory</code> function is invoked in the <code>x64dbg</code> instance running the <code>shell.exe</code> process. This will reveal the address within <code>notepad.exe</code> where the shellcode will be written.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/x64dbg\_010\_register\_wpm.png" alt="Image"></p>
<p>We copy this address to examine its content in the memory dump of the attached <code>notepad.exe</code> process in the second <code>x64dbg</code> instance.</p>
<p>We now select <code>Go to</code> &gt; <code>Expression</code> by right-clicking anywhere on the memory dump in the second <code>x64dbg</code> instance running <code>notepad.exe</code>.</p>
<p>With the copied address entered, the content at this address is displayed (by right-clicking on the address and choosing <code>Follow in Dump</code> &gt; <code>Selected Address</code>), which currently is empty.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/x64dbg\_011\_shellcode\_write.png" alt="Image"></p>
<p>Next, we execute shell.exe in the first <code>x64dbg</code> instance by clicking on the <code>Run</code> button. We observe what is inscribed into this memory region of <code>notepad.exe</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/x64dbg\_shellcodecopy\_.png" alt="Image"></p>
<p>Following its execution, we identify the injected <code>shellcode</code>, which aligns with what we discovered earlier during code analysis. We can verify this in <code>Process Hacker</code> and save it to a file for subsequent examination.</p>
<h2 id="creating-detection-rules">Creating Detection Rules</h2>
<p>Having now uncovered the Tactics, Techniques, and Procedures (TTPs) employed by this malware, we can proceed to design detection rules, such as <code>Yara</code> and <code>Sigma</code> rules.</p>
<p>While we will begin to delve into the concepts of Yara and Sigma rule development in this section, we&#39;ll only scratch the surface. These are extensive topics with a lot of depth, necessitating a comprehensive study. Hence, we will be dedicating a complete module named &#39;YARA &amp; Sigma for SOC Analysts&#39; to help you truly master these crucial areas of cyber defense.</p>
<p>Let&#39;s now navigate to the bottom of this section and click on &quot;Click here to spawn the target system!&quot;. Then, let&#39;s SSH into the Target IP using the provided credentials. The vast majority of the actions/commands covered from this point up to end of this section can be replicated inside the target, offering a more comprehensive grasp of the topics presented.</p>
<h3 id="yara">Yara</h3>
<p><code>YARA (Yet Another Recursive Acronym)</code>, a widely used open-source pattern matching tool and rule-based malware detection and classification framework let&#39;s us create custom rules to spot specific patterns or characteristics in files, processes, or memory. To draft a <code>YARA</code> rule for our sample, we&#39;ll need to examine the behavior, features, or specific strings/patterns unique to the sample we aim to detect.</p>
<p>Here&#39;s a simple example of a <code>YARA</code> rule that matches the presence of the string <code>Sandbox detected</code> in a process. We remind you that <code>shell.exe</code> demonstrated such behavior.</p>
<p>Code: yara</p>
<pre><code class="lang-yara"><span class="hljs-selector-tag">rule</span> <span class="hljs-selector-tag">Shell_Sandbox_Detection</span> {
    <span class="hljs-attribute">strings</span>:
        $sandbox_string = <span class="hljs-string">"Sandbox detected"</span>
    condition:
        $sandbox_string
}
</code></pre>
<p>Now let&#39;s add a lot more strings and patterns into the rule to make it better.</p>
<p>We can utilize the <code>yarGen</code> tool, which automates the process of generating <code>YARA</code> rules, with the prime objective of crafting the best possible rules for manual post-processing. This, however, necessitates a shrewd automatic preselection and a discerning human analyst to generate a robust rule.</p>
<p>First let&#39;s create a new directory called <code>Test</code> inside the <code>/home/htb-student/Samples/MalwareAnalysis</code> directory of this section&#39;s target and then let&#39;s copy <code>shell.exe</code> (residing in the <code>/home/htb-student/Samples/MalwareAnalysis</code> directory) to the newly created <code>Test</code> directory as follows.</p>
<p>Creating Detection Rules</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ mkdir /</span>home<span class="hljs-regexp">/htb-student/</span>Samples<span class="hljs-regexp">/MalwareAnalysis/</span>Test
</code></pre>
<p>Creating Detection Rules</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ cp /</span>home<span class="hljs-regexp">/htb-student/</span>Samples<span class="hljs-regexp">/MalwareAnalysis/</span>shell.exe <span class="hljs-regexp">/home/</span>htb-student<span class="hljs-regexp">/Samples/</span>MalwareAnalysis<span class="hljs-regexp">/Test/</span>
</code></pre>
<p>To automatically create a Yara rule for <code>shell.exe</code> we should execute the following (inside the <code>/home/htb-student/yarGen-0.23.4</code> directory).</p>
<p>Creating Detection Rules</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo python3 yarGen.py -m /</span>home<span class="hljs-regexp">/htb-student/</span>Samples<span class="hljs-regexp">/MalwareAnalysis/</span>Test/
------------------------------------------------------------------------
                   _____            
    __ _____ _____<span class="hljs-regexp">/ ___/</span>__ ___      
   <span class="hljs-regexp">/ /</span><span class="hljs-regexp">/ /</span> _ `<span class="hljs-regexp">/ __/</span> (_ / -_) _ \     
   \_, <span class="hljs-regexp">/\_,_/</span>_<span class="hljs-regexp">/  \___/\_</span>_<span class="hljs-regexp">/_/</span><span class="hljs-regexp">/_/</span>     
  <span class="hljs-regexp">/___/</span>  Yara Rule Generator        
         Florian Roth, July <span class="hljs-number">2020</span>, Version <span class="hljs-number">0.23</span><span class="hljs-number">.3</span>
<span class="hljs-symbol">
  Note:</span> Rules have to be post-processed
  See <span class="hljs-keyword">this</span> post <span class="hljs-keyword">for</span> <span class="hljs-string">details:</span> <span class="hljs-string">https:</span><span class="hljs-comment">//medium.com/@cyb3rops/121d29322282</span>
------------------------------------------------------------------------
[+] Using identifier <span class="hljs-string">'Test'</span>
[+] Using reference <span class="hljs-string">'https://github.com/Neo23x0/yarGen'</span>
[+] Using prefix <span class="hljs-string">'Test'</span>
[+] Processing PEStudio strings ...
[+] Reading goodware strings from database <span class="hljs-string">'good-strings.db'</span> ...
    (This could take some time and uses several Gigabytes of RAM depending on your db size)
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-imphashes-part3.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">4029</span> / Added <span class="hljs-number">4029</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-strings-part9.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">788</span> / Added <span class="hljs-number">788</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-strings-part8.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">332082</span> / Added <span class="hljs-number">331294</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-imphashes-part4.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">6426</span> / Added <span class="hljs-number">2397</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-strings-part2.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">1703601</span> / Added <span class="hljs-number">1371519</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-exports-part2.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">90960</span> / Added <span class="hljs-number">90960</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-strings-part4.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">3860655</span> / Added <span class="hljs-number">2157054</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-exports-part4.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">172718</span> / Added <span class="hljs-number">81758</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-exports-part7.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">223584</span> / Added <span class="hljs-number">50866</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-strings-part6.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">4571266</span> / Added <span class="hljs-number">710611</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-strings-part7.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">5828908</span> / Added <span class="hljs-number">1257642</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-exports-part1.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">293752</span> / Added <span class="hljs-number">70168</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-exports-part3.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">326867</span> / Added <span class="hljs-number">33115</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-imphashes-part9.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">6426</span> / Added <span class="hljs-number">0</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-exports-part9.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">326867</span> / Added <span class="hljs-number">0</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-imphashes-part5.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">13764</span> / Added <span class="hljs-number">7338</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-imphashes-part8.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">13947</span> / Added <span class="hljs-number">183</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-imphashes-part6.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">13976</span> / Added <span class="hljs-number">29</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-strings-part1.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">6893854</span> / Added <span class="hljs-number">1064946</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-imphashes-part7.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">17382</span> / Added <span class="hljs-number">3406</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-exports-part6.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">328525</span> / Added <span class="hljs-number">1658</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-imphashes-part2.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">18208</span> / Added <span class="hljs-number">826</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-exports-part8.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">332359</span> / Added <span class="hljs-number">3834</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-strings-part3.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">9152616</span> / Added <span class="hljs-number">2258762</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-strings-part5.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">12284943</span> / Added <span class="hljs-number">3132327</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-imphashes-part1.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">19764</span> / Added <span class="hljs-number">1556</span> entries
[+] Loading .<span class="hljs-regexp">/dbs/</span>good-exports-part5.db ...
[+] <span class="hljs-string">Total:</span> <span class="hljs-number">404321</span> / Added <span class="hljs-number">71962</span> entries
[+] Processing malware files ...
[+] Processing <span class="hljs-regexp">/home/</span>htb-student<span class="hljs-regexp">/Samples/</span>MalwareAnalysis<span class="hljs-regexp">/Test/</span>shell.exe ...
[+] Generating statistical data ...
[+] Generating Super Rules ... (a lot of magic)
[+] Generating Simple Rules ...
[-] Applying intelligent filters to string findings ...
[-] Filtering string set <span class="hljs-keyword">for</span> <span class="hljs-regexp">/home/</span>htb-student<span class="hljs-regexp">/Samples/</span>MalwareAnalysis<span class="hljs-regexp">/Test/</span>shell.exe ...
[=] Generated <span class="hljs-number">1</span> SIMPLE rules.
[=] All rules written to yargen_rules.yar
[+] yarGen run finished
</code></pre>
<p>We will notice that a file named <code>yargen_rule.yar</code> is generated by <code>yarGen</code> that incorporates unique strings, which are automatically extracted and inserted into the rule.</p>
<p>Creating Detection Rules</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat yargen_rules.yar 
<span class="hljs-comment">/*
   YARA Rule Set
   Author: yarGen Rule Generator
   Date: 2023-08-02
   Identifier: Test
   Reference: https://github.com/Neo23x0/yarGen
*/</span>

<span class="hljs-comment">/* Rule Set ----------------------------------------------------------------- */</span>

rule _home_htb_student_Samples_MalwareAnalysis_Test_shell {
   meta:
      description = <span class="hljs-string">"Test - file shell.exe"</span>
      author = <span class="hljs-string">"yarGen Rule Generator"</span>
      reference = <span class="hljs-string">"https://github.com/Neo23x0/yarGen"</span>
      date = <span class="hljs-string">"2023-08-02"</span>
      hash1 = <span class="hljs-string">"bd841e796feed0088ae670284ab991f212cf709f2391310a85443b2ed1312bda"</span>
   strings:
      <span class="hljs-built_in">$x</span>1 = <span class="hljs-string">"C:\\Windows\\System32\\cmd.exe"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>2 = <span class="hljs-string">"http://ms-windows-update.com/svchost.exe"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>3 = <span class="hljs-string">"C:\\Windows\\System32\\notepad.exe"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>4 = <span class="hljs-string">"/k ping 127.0.0.1 -n 5"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>5 = <span class="hljs-string">"iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>6 = <span class="hljs-string">"  VirtualQuery failed for %d bytes at address %p"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>7 = <span class="hljs-string">"[-] Error code is : %lu"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>8 = <span class="hljs-string">"C:\\Program Files\\VMware\\VMware Tools\\"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>9 = <span class="hljs-string">"Failed to open the registry key."</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>10 = <span class="hljs-string">"  VirtualProtect failed with code 0x%x"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>11 = <span class="hljs-string">"Connection sent to C2"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>12 = <span class="hljs-string">"VPAPAPAPI"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>13 = <span class="hljs-string">"AWAVAUATVSH"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>14 = <span class="hljs-string">"45.33.32.156"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>15 = <span class="hljs-string">"  Unknown pseudo relocation protocol version %d."</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>16 = <span class="hljs-string">"AQAPRQVH1"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>17 = <span class="hljs-string">"connect"</span> fullword <span class="hljs-keyword">ascii</span> <span class="hljs-comment">/* Goodware String - occured 429 times */</span>
      <span class="hljs-built_in">$s</span>18 = <span class="hljs-string">"socket"</span> fullword <span class="hljs-keyword">ascii</span> <span class="hljs-comment">/* Goodware String - occured 452 times */</span>
      <span class="hljs-built_in">$s</span>19 = <span class="hljs-string">"tSIcK&lt;L"</span> fullword <span class="hljs-keyword">ascii</span>
      <span class="hljs-built_in">$s</span>20 = <span class="hljs-string">"Windows-Update/7.6.7600.256 %s"</span> fullword <span class="hljs-keyword">ascii</span>
   condition:
      uint16(<span class="hljs-number">0</span>) == <span class="hljs-number">0</span>x5a4d and filesize &lt; <span class="hljs-number">60</span>KB and
      <span class="hljs-number">1</span> of (<span class="hljs-built_in">$x</span>*) and <span class="hljs-number">4</span> of them
}
</code></pre>
<p>We can review the rule and modify it as necessary, adding more strings and conditions to enhance its reliability and effectiveness.</p>
<hr>
<h3 id="detecting-malware-using-yara-rules">Detecting Malware Using Yara Rules</h3>
<p>We can then use this rule to scan a directory as follows.</p>
<p>Creating Detection Rules</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ yara /</span>home<span class="hljs-regexp">/htb-student/</span>yarGen<span class="hljs-number">-0.23</span><span class="hljs-number">.4</span><span class="hljs-regexp">/yargen_rules.yar /</span>home<span class="hljs-regexp">/htb-student/</span>Samples<span class="hljs-regexp">/MalwareAnalysis/</span>
home_htb_student_Samples_MalwareAnalysis_Test_shell <span class="hljs-regexp">/home/</span>htb-student<span class="hljs-regexp">/Samples/</span>MalwareAnalysis<span class="hljs-comment">//shell.exe</span>
</code></pre>
<p>We will notice that <code>shell.exe</code> is returned!</p>
<p><strong>Below are some references for YARA rules</strong>:</p>
<ul>
<li>Yara documentation : <a href="https://yara.readthedocs.io/en/stable/writingrules.html">https://yara.readthedocs.io/en/stable/writingrules.html</a></li>
<li>Yara resources - <a href="https://github.com/InQuest/awesome-yara">https://github.com/InQuest/awesome-yara</a></li>
<li>The DFIR Report - <a href="https://github.com/The-DFIR-Report/Yara-Rules">https://github.com/The-DFIR-Report/Yara-Rules</a></li>
</ul>
<h3 id="sigma">Sigma</h3>
<p><code>Sigma</code> is a comprehensive and standardized rule format extensively used by security analysts and <code>Security Information and Event Management (SIEM)</code> systems. The objective is to detect and identify specific patterns or behaviors that could potentially signify security threats or events. The standardized format of <code>Sigma</code> rules enables security teams to define and disseminate detection logic across diverse security platforms.</p>
<p>To construct a <code>Sigma</code> rule based on certain actions - for instance, dropping a file in a temporary location - we can devise a sample rule along these lines.</p>
<p>Code: sigma</p>
<pre><code class="lang-sigma">title: Suspicious File <span class="hljs-keyword">Drop</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">Users</span> Temp Location
<span class="hljs-keyword">status</span>: experimental
description: Detects suspicious activity <span class="hljs-keyword">where</span> a <span class="hljs-keyword">file</span> <span class="hljs-keyword">is</span> dropped <span class="hljs-keyword">in</span> the temp location

logsource:
    <span class="hljs-keyword">category</span>: process_creation
detection:
    selection:
        TargetFilename:
            - <span class="hljs-string">'*\\AppData\\Local\\Temp\\svchost.exe'</span>
    condition: selection
    <span class="hljs-keyword">level</span>: <span class="hljs-keyword">high</span>

falsepositives:
    - Legitimate exe <span class="hljs-keyword">file</span> drops <span class="hljs-keyword">in</span> temp location
</code></pre>
<p>In this instance, the rule is designed to identify when the file <code>svchost.exe</code> is dropped in the <code>Temp</code> directory.</p>
<p>During analysis, it&#39;s advantageous to have a system monitoring agent operating continuously. In this context, we&#39;ve chosen <code>Sysmon</code> to gather the logs. <code>Sysmon</code> is a powerful tool that captures detailed event data and aids in the creation of <code>Sigma</code> rules. Its log categories encompass process creation (<code>EventID 1</code>), network connection (<code>EventID 3</code>), file creation (<code>EventID 11</code>), registry modification (<code>EventID 13</code>), among others. The scrutiny of these events assists in pinpointing indicators of compromise (<code>IOC</code>s) and understanding behavior patterns, thus facilitating the crafting of effective detection rules.</p>
<p>For instance, <code>Sysmon</code> has collected logs such as <code>process creation</code>, <code>process access</code>, <code>file creation</code>, and <code>network connection</code>, among others, in response to the activities conducted by <code>shell.exe</code>. This compiled information proves instrumental in enhancing our understanding of the sample&#39;s behavior and developing more precise and effective detection rules.</p>
<p><strong>Process Create Logs</strong>:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/sysmon\_01\_process.png" alt="Image"></p>
<p><strong>Process Access Logs</strong> (not configured in the Windows targets of this module):</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/sysmon\_10\_access.png" alt="Image"></p>
<p><strong>File Creation Logs</strong>:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/sysmon\_11\_file.png" alt="Image"></p>
<p><strong>Network Connection Logs</strong>:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/227/sysmon\_03\_network.png" alt="Image"></p>
<p><strong>Below are some references for Sigma rules</strong>:</p>
<ul>
<li>Sigma documentation : <a href="https://github.com/SigmaHQ/sigma/wiki/Specification">https://github.com/SigmaHQ/sigma/wiki/Specification</a></li>
<li>Sigma resources - <a href="https://github.com/SigmaHQ/sigma/tree/master/rules">https://github.com/SigmaHQ/sigma/tree/master/rules</a></li>
<li>The DFIR Report - <a href="https://github.com/The-DFIR-Report/Sigma-Rules/tree/main/rules">https://github.com/The-DFIR-Report/Sigma-Rules/tree/main/rules</a></li>
</ul>
