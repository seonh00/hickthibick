
<body>
  <div class="container">
<link rel="stylesheet" href="style.css">


<h1 id="working-with-ids-ips">Working with IDS/IPS</h1>
<h2 id="introduction-to-ids-ips">Introduction To IDS/IPS</h2>
<p>In network security monitoring (NSM) operations, the use of <code>Intrusion Detection Systems (IDS)</code> and <code>Intrusion Prevention Systems (IPS)</code> is paramount. The purpose of these systems is not only to identify potential threats but also to mitigate their impact.</p>
<p>An <code>IDS</code> is a device or application that monitors network or system activities for malicious activities or policy violations and produces reports primarily to a management station. Such a system gives us a clear sense of what&#39;s happening within our network, ensuring we have visibility on any potentially harmful actions. It should be noted that an IDS doesn&#39;t prevent an intrusion but alerts us when one occurs.</p>
<ul>
<li>The IDS operates in two main modes: signature-based detection and anomaly-based detection. In <code>signature-based detection</code>, the IDS recognizes bad patterns, such as malware signatures and previously identified attack patterns. However, this method is limited to only known threats. For this reason, we also implement <code>anomaly-based detection</code>, which establishes a baseline of normal behavior and sends an alert when it detects behavior deviating from this baseline. It&#39;s a more proactive approach but is susceptible to false positives, hence why we use both methods to balance each other out.</li>
</ul>
<p>On the other hand, an <code>IPS</code> sits directly behind the firewall and provides an additional layer of protection. It does not just passively monitor the network traffic, but actively prevents any detected potential threats. Such a system doesn&#39;t just alert us of intruders, but also actively stops them from entering.</p>
<ul>
<li>An IPS also operates in a similar mode to IDS, offering both signature-based and anomaly-based detection. Once a potential threat is detected, it takes actions such as dropping malicious packets, blocking network traffic, and resetting the connection. The goal is to interrupt or halt activities that are deemed dangerous to our network or against our policy.</li>
</ul>
<p>When deploying IDS and IPS, they are typically integrated into the network at different points, each having its optimal place depending on its function and the overall network design. Both IDS and IPS devices are generally positioned behind the firewall, closer to the resources they protect. As they both work by examining network traffic, it makes sense to place them where they can see as much of the relevant traffic as possible, which is typically on the internal network side of the firewall.</p>
<ul>
<li>Intrusion Detection Systems (IDS) passively monitor network traffic, detecting potential threats and generating alerts. By placing them behind the firewall, we can ensure they&#39;re analyzing traffic that has already passed the first line of defense, allowing us to focus on potentially more subtle or complex threats that have bypassed the firewall.</li>
<li>Intrusion Prevention Systems (IPS), on the other hand, actively intervene to stop detected threats. This means they need to be placed at a point in the network where they can not only see potentially malicious traffic but also have the authority to stop it. This is usually achieved by placing them inline on the network, often directly behind the firewall.</li>
</ul>
<p>The deployment may vary based on the network&#39;s specific requirements and the kind of traffic we need to monitor. IDS/IPS can also be implemented on the host level, known as Host-based Intrusion Detection Systems (HIDS) and Host-based Intrusion Prevention Systems (HIPS), which monitor the individual host&#39;s inbound and outbound traffic for any suspicious activity.</p>
<p>Please note that the placement of these systems is an integral part of a defense-in-depth strategy, where multiple layers of security measures are used to protect the network. The exact architecture will depend on various factors, including the nature of the network, the sensitivity of the data, and the threat landscape.</p>
<h3 id="ids-ips-updates">IDS/IPS Updates</h3>
<p>Moreover, to ensure these systems perform at their best, we consistently update them with the latest threat signatures and fine-tune their anomaly detection algorithms. This requires a diligent, ongoing effort from our security team, but it&#39;s absolutely essential given the continually evolving threat landscape.</p>
<p>It&#39;s also important to mention the role of Security Information and Event Management (SIEM) systems in our network security monitoring operations. By collecting and aggregating logs from IDS and IPS along with other devices in our network, we can correlate events (analyzing the relationships) from different sources and use advanced analytics to detect complex, coordinated attacks. This way, we have a complete, unified view of our network&#39;s security, enabling us to respond quickly to threats.</p>
<h3 id="coming-up">Coming Up</h3>
<p>In this module, we will explore the fundamentals of <code>Suricata</code>, <code>Snort</code>, and <code>Zeek</code>, along with providing insights into signature development and intrusion detection for each of these systems.</p>
<h2 id="suricata-fundamentals">Suricata Fundamentals</h2>
<p>Regarded as a potent instrument for Network Intrusion Detection Systems (IDS), Intrusion Prevention Systems (IPS), and Network Security Monitoring (NSM), Suricata represents a cornerstone of network security. This open-source powerhouse, managed and developed by the Open Information Security Foundation (OISF), is a testament to the strength of a community-led, non-profit initiative.</p>
<p>The objective of Suricata is to dissect every iota of network traffic, seeking potential signs of malicious activities. Its strength lies in the ability to not only conduct a sweeping evaluation of our network&#39;s condition but also delve into the details of individual application-layer transactions. The key to Suricata&#39;s successful operation lies in an intricately designed set of rules. These guidelines direct Suricata&#39;s analysis process, identifying potential threats and areas of interest. Equipped to perform at high velocities on both off-the-shelf and specifically designed hardware, Suricata&#39;s efficiency is second to none.</p>
<h3 id="suricata-operation-modes">Suricata Operation Modes</h3>
<p>Suricata operates in four (4) distinct modes:</p>
<ol>
<li>The <code>Intrusion Detection System (IDS) mode</code> positions Suricata as a silent observer. In this capacity, Suricata meticulously examines traffic, flagging potential attacks but refraining from any form of intervention. By providing an in-depth view of network activities and accelerating response times, this mode augments network visibility, albeit without offering direct protection.</li>
<li>In the <code>Intrusion Prevention System (IPS) mode</code>, Suricata adopts a proactive stance. All network traffic must pass through Suricata&#39;s stringent checks and is only granted access to the internal network upon Suricata&#39;s approval. This mode bolsters security by proactively thwarting attacks before they penetrate our internal network. Deploying Suricata in IPS mode demands an intimate understanding of the network landscape to prevent the inadvertent blocking of legitimate traffic. Furthermore, each rule activation necessitates rigorous testing and validation. While this mode enhances security, the inspection process may introduce latency.</li>
<li>The <code>Intrusion Detection Prevention System (IDPS) mode</code> brings together the best of both IDS and IPS. While Suricata continues to passively monitor traffic, it possesses the ability to actively transmit RST packets in response to abnormal activities. This mode strikes a balance between active protection and maintaining low latency, crucial for seamless network operations.</li>
<li>In its <code>Network Security Monitoring (NSM) mode</code>, Suricata transitions into a dedicated logging mechanism, eschewing active or passive traffic analysis or prevention capabilities. It meticulously logs every piece of network information it encounters, providing a valuable wealth of data for retrospective security incident investigations, despite the high volume of data generated.</li>
</ol>
<h3 id="suricata-inputs">Suricata Inputs</h3>
<p>Regarding Suricata inputs, there are two main categories:</p>
<ol>
<li><code>Offline Input:</code> This involves reading PCAP files for processing previously captured packets in the <code>LibPCAP</code> file format. It is not only advantageous for conducting post-mortem data examination but also instrumental when experimenting with various rule sets and configurations.</li>
<li><code>Live Input</code>: Live input can be facilitated via <code>LibPCAP</code>, where packets are read directly from network interfaces. However, <code>LibPCAP</code> is somewhat hamstrung by its performance limitations and lack of load-balancing capabilities. For inline operations, <code>NFQ</code> and <code>AF_PACKET</code> options are available. <code>NFQ</code>, a Linux-specific inline IPS mode, collaborates with IPTables to divert packets from the kernel space into Suricata for detailed scrutiny. Commonly used inline, <code>NFQ</code> necessitates drop rules for Suricata to effectively obstruct packets. Conversely, <code>AF_PACKET</code> provides a performance improvement over <code>LibPCAP</code> and supports multi-threading. Nevertheless, it&#39;s not compatible with older Linux distributions and can&#39;t be employed inline if the machine is also tasked with routing packets.</li>
</ol>
<p>Please note that there are other, less commonly used or more advanced inputs available.</p>
<h3 id="suricata-outputs">Suricata Outputs</h3>
<p>Suricata creates multiple outputs, including logs, alerts, and additional network-related data such as DNS requests and network flows. One of the most critical outputs is <code>EVE</code>, a JSON formatted log that records a wide range of event types including alerts, HTTP, DNS, TLS metadata, drop, SMTP metadata, flow, netflow, and more. Tools such as Logstash can easily consume this output, facilitating data analysis.</p>
<p>We might encounter <code>Unified2</code> Suricata output, which is essentially a Snort binary alert format, enabling integration with other software that leverages Unified2. Any Unified2 output can be read using Snort’s <code>u2spewfoo</code> tool, which is a straightforward and effective method to gain insight into the alert data.</p>
<p>Let&#39;s now navigate to the bottom of this section and click on &quot;Click here to spawn the target system!&quot;. Then, let&#39;s SSH into the Target IP using the provided credentials. The vast majority of the commands covered from this point up to end of this section can be replicated inside the target, offering a more comprehensive grasp of the topics presented.</p>
<h3 id="configuring-suricata-custom-rules">Configuring Suricata &amp; Custom Rules</h3>
<p>Once we&#39;ve accessed the deployed Suricata instance over SSH, we can get an overview of all the rule files with a simple execution command.</p>
<p>Suricata Fundamentals</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ls -lah /etc/suricata/rules/
total 27M
drwxr-xr-x<span class="hljs-number"> 2 </span>root root 4.0K Jun<span class="hljs-number"> 28 </span>12:10 .
drwxr-xr-x<span class="hljs-number"> 3 </span>root root 4.0K Jul <span class="hljs-number"> 4 </span>14:44 ..
-rw-r--r--<span class="hljs-number"> 1 </span>root root  31K Jun<span class="hljs-number"> 27 </span>20:55 3coresec.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root 1.9K Jun<span class="hljs-number"> 15 </span>05:51 app-layer-events.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root 2.1K Jun<span class="hljs-number"> 27 </span>20:55 botcc.portgrouped.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root  27K Jun<span class="hljs-number"> 27 </span>20:55 botcc.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root 109K Jun<span class="hljs-number"> 27 </span>20:55 ciarmy.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root  12K Jun<span class="hljs-number"> 27 </span>20:55 compromised.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root  21K Jun<span class="hljs-number"> 15 </span>05:51 decoder-events.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 468 </span>Jun<span class="hljs-number"> 15 </span>05:51 dhcp-events.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root 1.2K Jun<span class="hljs-number"> 15 </span>05:51 dnp3-events.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root 1.2K Jun<span class="hljs-number"> 15 </span>05:51 dns-events.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root  32K Jun<span class="hljs-number"> 27 </span>20:55 drop.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root 2.7K Jun<span class="hljs-number"> 27 </span>20:55 dshield.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root 365K Jun<span class="hljs-number"> 27 </span>20:55 emerging-activex.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root 613K Jun<span class="hljs-number"> 27 </span>20:55 emerging-adware_pup.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root 650K Jun<span class="hljs-number"> 27 </span>20:55 emerging-attack_response.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root  33K Jun<span class="hljs-number"> 27 </span>20:55 emerging-chat.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root  19K Jun<span class="hljs-number"> 27 </span>20:55 emerging-coinminer.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root 119K Jun<span class="hljs-number"> 27 </span>20:55 emerging-current_events.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root 1.7M Jun<span class="hljs-number"> 27 </span>20:55 emerging-deleted.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root  20K Jun<span class="hljs-number"> 27 </span>20:55 emerging-dns.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root  62K Jun<span class="hljs-number"> 27 </span>20:55 emerging-dos.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root 606K Jun<span class="hljs-number"> 27 </span>20:55 emerging-exploit_kit.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root 1.1M Jun<span class="hljs-number"> 27 </span>20:55 emerging-exploit.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root  45K Jun<span class="hljs-number"> 27 </span>20:55 emerging-ftp.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root  37K Jun<span class="hljs-number"> 27 </span>20:55 emerging-games.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root 572K Jun<span class="hljs-number"> 27 </span>20:55 emerging-hunting.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root  18K Jun<span class="hljs-number"> 27 </span>20:55 emerging-icmp_info.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root  11K Jun<span class="hljs-number"> 27 </span>20:55 emerging-icmp.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root  15K Jun<span class="hljs-number"> 27 </span>20:55 emerging-imap.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root  11K Jun<span class="hljs-number"> 27 </span>20:55 emerging-inappropriate.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root 2.9M Jun<span class="hljs-number"> 27 </span>20:55 emerging-info.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root  48K Jun<span class="hljs-number"> 27 </span>20:55 emerging-ja3.rules
-rw-r--r--<span class="hljs-number"> 1 </span>root root 8.2M Jun<span class="hljs-number"> 27 </span>20:55 emerging-malware.rules
---SNIP<span class="yaml"><span class="hljs-meta">---</span></span>
</code></pre>
<p>The rules can be seen in a straightforward list format and be inspected to understand their functionality, as follows.</p>
<p>Suricata Fundamentals</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ more /etc/suricata/rules/emerging-malware.rules
<span class="hljs-comment"># Emerging Threats</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># This distribution may contain rules under two different licenses.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#  Rules with sids 1 through 3464, and 100000000 through 100000908 are under the GPLv2.</span>
<span class="hljs-comment">#  A copy of that license is available at http://www.gnu.org/licenses/gpl-2.0.html</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#  Rules with sids 2000000 through 2799999 are from Emerging Threats and are covered under the BSD License</span>
<span class="hljs-comment">#  as follows:</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#*************************************************************</span>
<span class="hljs-comment">#  Copyright (c) 2003-2022, Emerging Threats</span>
<span class="hljs-comment">#  All rights reserved.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#  Redistribution and use in source and binary forms, with or without modification, are permitted provided that the</span>
<span class="hljs-comment">#  following conditions are met:</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#  * Redistributions of source code must retain the above copyright notice, this list of conditions and the following</span>
<span class="hljs-comment">#    disclaimer.</span>
<span class="hljs-comment">#  * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the</span>
<span class="hljs-comment">#    following disclaimer in the documentation and/or other materials provided with the distribution.</span>
<span class="hljs-comment">#  * Neither the name of the nor the names of its contributors may be used to endorse or promote products derived</span>
<span class="hljs-comment">#    from this software without specific prior written permission.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY EXPRESS OR IMPLIED WARRANTIES,</span>
<span class="hljs-comment">#  INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="hljs-comment">#  DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<span class="hljs-comment">#  SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
<span class="hljs-comment">#  SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,</span>
<span class="hljs-comment">#  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE</span>
<span class="hljs-comment">#  USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#*************************************************************</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#</span>

<span class="hljs-comment"># This Ruleset is EmergingThreats Open optimized for suricata-5.0-enhanced.</span>

<span class="hljs-comment">#alert tcp $HOME_NET any -&gt; $EXTERNAL_NET any (msg:"ET MALWARE Psyb0t joining an IRC Channel"; flow:established,to_server; flowbits:isset,is_proto_irc; content:"</span>
JOIN <span class="hljs-comment">#mipsel"; reference:url,www.adam.com.au/bogaurd/PSYB0T.pdf; reference:url,doc.emergingthreats.net/2009172; classtype:trojan-activity; sid:2009172; rev:2; me</span>
tadata:created_at 2010_07_30, updated_at 2010_07_30;)

alert tcp <span class="hljs-variable">$HOME_NET</span> any -&gt; <span class="hljs-variable">$EXTERNAL_NET</span> 25 (msg:<span class="hljs-string">"ET MALWARE SC-KeyLog Keylogger Installed - Sending Initial Email Report"</span>; flow:established,to_server; content:<span class="hljs-string">"
Installation of SC-KeyLog on host "</span>; nocase; content:<span class="hljs-string">"&lt;p&gt;You will receive a log report every "</span>; nocase; reference:url,www.soft-central.net/keylog.php; reference:
url,doc.emergingthreats.net/2002979; classtype:trojan-activity; sid:2002979; rev:4; metadata:created_at 2010_07_30, updated_at 2010_07_30;)

alert tcp <span class="hljs-variable">$HOME_NET</span> any -&gt; <span class="hljs-variable">$EXTERNAL_NET</span> 25 (msg:<span class="hljs-string">"ET MALWARE SC-KeyLog Keylogger Installed - Sending Log Email Report"</span>; flow:established,to_server; content:<span class="hljs-string">"SC-K
eyLog log report"</span>; nocase; content:<span class="hljs-string">"See attached file"</span>; nocase; content:<span class="hljs-string">".log"</span>; nocase; reference:url,www.soft-central.net/keylog.php; reference:url,doc.emerging
threats.net/2008348; classtype:trojan-activity; sid:2008348; rev:2; metadata:created_at 2010_07_30, updated_at 2010_07_30;)
---SNIP---
</code></pre>
<p>Rules might be commented out, meaning they aren&#39;t loaded and don&#39;t affect the system. This usually happens when a new version of the rule comes into play or if the threat associated with the rule becomes outdated or irrelevant.</p>
<p>Each rule usually involves specific variables, such as <code>$HOME_NET</code> and <code>$EXTERNAL_NET</code>. The rule examines traffic from the IP addresses specified in the <code>$HOME_NET</code> variable heading towards the IP addresses in the <code>$EXTERNAL_NET</code> variable.</p>
<p>These variables can be defined in the <code>suricata.yaml</code> configuration file.</p>
<p>Suricata Fundamentals</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ more <span class="hljs-meta-keyword">/etc/</span>suricata/suricata.yaml
%YAML <span class="hljs-number">1.1</span>
---

<span class="hljs-meta"># Suricata configuration file. In addition to the comments describing all</span>
<span class="hljs-meta"># options in this file, full documentation can be found at:</span>
<span class="hljs-meta"># https:<span class="hljs-comment">//suricata.readthedocs.io/en/latest/configuration/suricata-yaml.html</span></span>

<span class="hljs-meta"># This configuration file generated by Suricata 6.0.13.</span>
suricata-version: <span class="hljs-string">"6.0"</span>

<span class="hljs-meta">##</span>
<span class="hljs-meta">## Step 1: Inform Suricata about your network</span>
<span class="hljs-meta">##</span>
<span class="hljs-symbol">
vars:</span>
  <span class="hljs-meta"># more specific is better for alert accuracy and performance</span>
  address-groups:
<span class="hljs-symbol">    HOME_NET:</span> <span class="hljs-string">"[10.0.0.0/8]"</span>
    <span class="hljs-meta">#HOME_NET: <span class="hljs-string">"[192.168.0.0/16]"</span></span>
    <span class="hljs-meta">#HOME_NET: <span class="hljs-string">"[10.0.0.0/8]"</span></span>
    <span class="hljs-meta">#HOME_NET: <span class="hljs-string">"[172.16.0.0/12]"</span></span>
    <span class="hljs-meta">#HOME_NET: <span class="hljs-string">"any"</span></span>
<span class="hljs-symbol">
    EXTERNAL_NET:</span> <span class="hljs-string">"!$HOME_NET"</span>
    <span class="hljs-meta">#EXTERNAL_NET: <span class="hljs-string">"any"</span></span>
<span class="hljs-symbol">
    HTTP_SERVERS:</span> <span class="hljs-string">"$HOME_NET"</span>
<span class="hljs-symbol">    SMTP_SERVERS:</span> <span class="hljs-string">"$HOME_NET"</span>
<span class="hljs-symbol">    SQL_SERVERS:</span> <span class="hljs-string">"$HOME_NET"</span>
<span class="hljs-symbol">    DNS_SERVERS:</span> <span class="hljs-string">"$HOME_NET"</span>
<span class="hljs-symbol">    TELNET_SERVERS:</span> <span class="hljs-string">"$HOME_NET"</span>
<span class="hljs-symbol">    AIM_SERVERS:</span> <span class="hljs-string">"$EXTERNAL_NET"</span>
<span class="hljs-symbol">    DC_SERVERS:</span> <span class="hljs-string">"$HOME_NET"</span>
<span class="hljs-symbol">    DNP3_SERVER:</span> <span class="hljs-string">"$HOME_NET"</span>
---SNIP---
</code></pre>
<p>This allows us to customize these variables according to our specific network environment and even define our own variables.</p>
<p>Finally, to configure Suricata to load signatures from a custom rules file, such as <code>local.rules</code> in the <code>/home/htb-student</code> directory, we would execute the below.</p>
<p>Suricata Fundamentals</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ sudo vim /etc</span><span class="hljs-regexp">/suricata/suricata</span>.yaml
</code></pre>
<ol>
<li>Add <code>/home/htb-student/local.rules</code> to <code>rule-files:</code></li>
<li>Press the <code>Esc</code> key</li>
<li>Enter <code>:wq</code> and then, press the <code>Enter</code> key</li>
</ol>
<p>The local.rules file that resides in the /home/htb-student directory of this section&#39;s target already contains a Suricata rule. This rule is adequate for this section&#39;s learning objectives. We will elaborate more on Suricata rule development in the next section.</p>
<h3 id="hands-on-with-suricata-inputs">Hands-on With Suricata Inputs</h3>
<p>With Suricata inputs, we can experiment with both offline and live input:</p>
<ol>
<li><p>For offline input (reading PCAP files - <a href="https://dingtoffee.medium.com/holiday-hack-challenge-2022-writeup-stage-2-recover-the-tolkien-ring-3f76fcd7dab9">suspicious.pcap</a> in this case), the following command needs to be executed, and Suricata will create various logs (mainly <code>eve.json</code>, <code>fast.log</code>, and <code>stats.log</code>).</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ suricata -r /home/htb-student/pcaps/suspicious.pcap
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">35</span>:<span class="hljs-number">51</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - This <span class="hljs-keyword">is</span> Suricata <span class="hljs-keyword">version</span> <span class="hljs-number">6.0</span>.<span class="hljs-number">13</span> RELEASE running in USER <span class="hljs-keyword">mode</span>
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">35</span>:<span class="hljs-number">51</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - <span class="hljs-keyword">all</span> <span class="hljs-number">3</span> packet processing threads, <span class="hljs-number">4</span> management threads initialized, engine started.
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">35</span>:<span class="hljs-number">51</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - Signal Received.  Stopping engine.
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">35</span>:<span class="hljs-number">51</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - Pcap-<span class="hljs-keyword">file</span> module <span class="hljs-keyword">read</span> <span class="hljs-number">1</span> <span class="hljs-keyword">files</span>, <span class="hljs-number">5172</span> packets, <span class="hljs-number">3941260</span> bytes
</code></pre>
<p>An alternative command can be executed to bypass checksums (<code>-k</code> flag) and log in a different directory (<code>-l</code> flag).</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ suricata -r /home/htb-student/pcaps/suspicious.pcap -<span class="hljs-keyword">k</span> none -<span class="hljs-keyword">l</span> .
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">37</span>:<span class="hljs-number">43</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - This <span class="hljs-keyword">is</span> Suricata <span class="hljs-keyword">version</span> <span class="hljs-number">6.0</span>.<span class="hljs-number">13</span> RELEASE running in USER <span class="hljs-keyword">mode</span>
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">37</span>:<span class="hljs-number">43</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - <span class="hljs-keyword">all</span> <span class="hljs-number">3</span> packet processing threads, <span class="hljs-number">4</span> management threads initialized, engine started.
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">37</span>:<span class="hljs-number">43</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - Signal Received.  Stopping engine.
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">37</span>:<span class="hljs-number">43</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - Pcap-<span class="hljs-keyword">file</span> module <span class="hljs-keyword">read</span> <span class="hljs-number">1</span> <span class="hljs-keyword">files</span>, <span class="hljs-number">5172</span> packets, <span class="hljs-number">3941260</span> bytes
</code></pre>
</li>
<li><p>For live input, we can try Suricata’s (Live) <code>LibPCAP</code> mode as follows.</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ifconfig
ens160: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
    inet 10.129.205.193  netmask 255.255.0.0  broadcast 10.129.255.255
    inet6 dead:beef::250:56ff:feb9:68dc  prefixlen<span class="hljs-number"> 64 </span> scopeid 0x0&lt;global&gt;
    inet6 fe80::250:56ff:feb9:68dc  prefixlen<span class="hljs-number"> 64 </span> scopeid 0x20&lt;link&gt;
    ether 00:50:56:b9:68:dc  txqueuelen<span class="hljs-number"> 1000 </span> (Ethernet)
    RX packets<span class="hljs-number"> 281625 </span> bytes<span class="hljs-number"> 84557478 </span>(84.5 MB)
    RX errors<span class="hljs-number"> 0 </span> dropped<span class="hljs-number"> 0 </span> overruns<span class="hljs-number"> 0 </span> frame 0
    TX packets<span class="hljs-number"> 62276 </span> bytes<span class="hljs-number"> 23518127 </span>(23.5 MB)
    TX errors<span class="hljs-number"> 0 </span> dropped<span class="hljs-number"> 0 </span>overruns<span class="hljs-number"> 0 </span> carrier<span class="hljs-number"> 0 </span> collisions 0

lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
    inet 127.0.0.1  netmask 255.0.0.0
    inet6 ::1  prefixlen<span class="hljs-number"> 128 </span> scopeid 0x10&lt;host&gt;
    loop  txqueuelen<span class="hljs-number"> 1000 </span> (Local Loopback)
    RX packets<span class="hljs-number"> 888 </span> bytes<span class="hljs-number"> 64466 </span>(64.4 KB)
    RX errors<span class="hljs-number"> 0 </span> dropped<span class="hljs-number"> 0 </span> overruns<span class="hljs-number"> 0 </span> frame 0
    TX packets<span class="hljs-number"> 888 </span> bytes<span class="hljs-number"> 64466 </span>(64.4 KB)
    TX errors<span class="hljs-number"> 0 </span> dropped<span class="hljs-number"> 0 </span>overruns<span class="hljs-number"> 0 </span> carrier<span class="hljs-number"> 0 </span> collisions 0
</code></pre>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo suricata --pcap=ens160 -vv
[sudo] password <span class="hljs-keyword">for</span> htb-student:
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Notice&gt;</span> - This is Suricata version <span class="hljs-number">6.0</span>.<span class="hljs-number">13</span> RELEASE running <span class="hljs-keyword">in</span> SYSTEM mode
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Info&gt;</span> - CPUs/cores online: <span class="hljs-number">2</span>
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Info&gt;</span> - Setting engine mode <span class="hljs-keyword">to</span> IDS mode by <span class="hljs-keyword">default</span>
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Info&gt;</span> - Found an MTU of <span class="hljs-number">1500</span> <span class="hljs-keyword">for</span> 'ens160'
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Info&gt;</span> - Found an MTU of <span class="hljs-number">1500</span> <span class="hljs-keyword">for</span> 'ens160'
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Info&gt;</span> - fast output device (regular) initialized: fast.<span class="hljs-keyword">log</span>
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Info&gt;</span> - eve-log output device (regular) initialized: eve.json
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Info&gt;</span> - stats output device (regular) initialized: stats.<span class="hljs-keyword">log</span>
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Info&gt;</span> - Running <span class="hljs-keyword">in</span> live mode, activating unix socket
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - using shared mpm ctx' <span class="hljs-keyword">for</span> http_uri
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - using shared mpm ctx' <span class="hljs-keyword">for</span> http_uri
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - using shared mpm ctx' <span class="hljs-keyword">for</span> http_raw_uri
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - using shared mpm ctx' <span class="hljs-keyword">for</span> http_raw_uri
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Info&gt;</span> - <span class="hljs-number">1</span> <span class="hljs-keyword">rule</span> files processed. <span class="hljs-number">1</span> rules successfully loaded, <span class="hljs-number">0</span> rules failed
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Info&gt;</span> - Threshold config parsed: <span class="hljs-number">0</span> <span class="hljs-keyword">rule</span>(s) found
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - using shared mpm ctx' <span class="hljs-keyword">for</span> tcp-packet
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - using shared mpm ctx' <span class="hljs-keyword">for</span> tcp-stream
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - using shared mpm ctx' <span class="hljs-keyword">for</span> udp-packet
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - using shared mpm ctx' <span class="hljs-keyword">for</span> other-ip
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Info&gt;</span> - <span class="hljs-number">1</span> signatures processed. <span class="hljs-number">0</span> are IP-only rules, <span class="hljs-number">0</span> are inspecting packet payload, <span class="hljs-number">1</span> inspect application layer, <span class="hljs-number">0</span> are decoder event only
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - TCP toserver: <span class="hljs-number">1</span> <span class="hljs-keyword">port</span> groups, <span class="hljs-number">1</span> unique SGH's, <span class="hljs-number">0</span> copies
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - TCP toclient: <span class="hljs-number">0</span> <span class="hljs-keyword">port</span> groups, <span class="hljs-number">0</span> unique SGH's, <span class="hljs-number">0</span> copies
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - UDP toserver: <span class="hljs-number">1</span> <span class="hljs-keyword">port</span> groups, <span class="hljs-number">1</span> unique SGH's, <span class="hljs-number">0</span> copies
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - UDP toclient: <span class="hljs-number">0</span> <span class="hljs-keyword">port</span> groups, <span class="hljs-number">0</span> unique SGH's, <span class="hljs-number">0</span> copies
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - OTHER toserver: <span class="hljs-number">0</span> <span class="hljs-keyword">proto</span> groups, <span class="hljs-number">0</span> unique SGH's, <span class="hljs-number">0</span> copies
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - OTHER toclient: <span class="hljs-number">0</span> <span class="hljs-keyword">proto</span> groups, <span class="hljs-number">0</span> unique SGH's, <span class="hljs-number">0</span> copies
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - Unique <span class="hljs-keyword">rule</span> groups: <span class="hljs-number">2</span>
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - Builtin MPM <span class="hljs-string">"toserver TCP packet"</span>: <span class="hljs-number">0</span>
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - Builtin MPM <span class="hljs-string">"toclient TCP packet"</span>: <span class="hljs-number">0</span>
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - Builtin MPM <span class="hljs-string">"toserver TCP stream"</span>: <span class="hljs-number">0</span>
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - Builtin MPM <span class="hljs-string">"toclient TCP stream"</span>: <span class="hljs-number">0</span>
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - Builtin MPM <span class="hljs-string">"toserver UDP packet"</span>: <span class="hljs-number">0</span>
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - Builtin MPM <span class="hljs-string">"toclient UDP packet"</span>: <span class="hljs-number">0</span>
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - Builtin MPM <span class="hljs-string">"other IP packet"</span>: <span class="hljs-number">0</span>
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - AppLayer MPM <span class="hljs-string">"toserver dns_query (dns)"</span>: <span class="hljs-number">1</span>
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Info&gt;</span> - Using <span class="hljs-number">1</span> live device(s).
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Info&gt;</span> - using interface ens160
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - ens160: disabling rxcsum offloading
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - ens160: disabling txcsum offloading
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Info&gt;</span> - running <span class="hljs-keyword">in</span> 'auto' checksum mode. Detection of interface <span class="hljs-keyword">state</span> will require <span class="hljs-number">1000</span>ULL packets
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Info&gt;</span> - Found an MTU of <span class="hljs-number">1500</span> <span class="hljs-keyword">for</span> 'ens160'
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Info&gt;</span> - Set snaplen <span class="hljs-keyword">to</span> <span class="hljs-number">1524</span> <span class="hljs-keyword">for</span> 'ens160'
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - NIC offloading <span class="hljs-keyword">on</span> ens160: RX unset TX unset
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Perf&gt;</span> - NIC offloading <span class="hljs-keyword">on</span> ens160: SG: unset, GRO: unset, LRO: unset, TSO: unset, GSO: unset
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Info&gt;</span> - RunModeIdsPcapAutoFp initialised
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Info&gt;</span> - Running <span class="hljs-keyword">in</span> live mode, activating unix socket
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Info&gt;</span> - Using unix socket file '/var/run/suricata/suricata-command.socket'
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01</span> - <span class="hljs-variable">&lt;Notice&gt;</span> - <span class="hljs-literal">all</span> <span class="hljs-number">3</span> packet processing threads, <span class="hljs-number">4</span> management threads initialized, engine started.
</code></pre>
</li>
<li><p>For Suricata in Inline (<code>NFQ</code>) mode, the following command should be executed first.</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ sudo iptables -I FORWARD -j NFQUEUE
</code></pre>
<p>Then, we should be able to execute the following.</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo suricata -q <span class="hljs-number">0</span>
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">38</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - This <span class="hljs-keyword">is</span> Suricata <span class="hljs-keyword">version</span> <span class="hljs-number">6.0</span>.<span class="hljs-number">13</span> RELEASE running in SYSTEM <span class="hljs-keyword">mode</span>
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">39</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - <span class="hljs-keyword">all</span> <span class="hljs-number">4</span> packet processing threads, <span class="hljs-number">4</span> management threads initialized, engine started.
</code></pre>
<p>Moreover, to try Suricata in <code>IDS</code> mode with <code>AF_PACKET</code> input, execute one of the below.</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo suricata -i ens160
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">53</span>:<span class="hljs-number">35</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - This <span class="hljs-keyword">is</span> Suricata <span class="hljs-keyword">version</span> <span class="hljs-number">6.0</span>.<span class="hljs-number">13</span> RELEASE running in SYSTEM <span class="hljs-keyword">mode</span>
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">53</span>:<span class="hljs-number">35</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - <span class="hljs-keyword">all</span> <span class="hljs-number">1</span> packet processing threads, <span class="hljs-number">4</span> management threads initialized, engine started.
</code></pre>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo suricata --af-packet=ens160
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">54</span>:<span class="hljs-number">34</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - This <span class="hljs-keyword">is</span> Suricata <span class="hljs-keyword">version</span> <span class="hljs-number">6.0</span>.<span class="hljs-number">13</span> RELEASE running in SYSTEM <span class="hljs-keyword">mode</span>
<span class="hljs-number">5</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">13</span>:<span class="hljs-number">54</span>:<span class="hljs-number">34</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - <span class="hljs-keyword">all</span> <span class="hljs-number">1</span> packet processing threads, <span class="hljs-number">4</span> management threads initialized, engine started.
</code></pre>
</li>
</ol>
<p>To observe Suricata dealing with &quot;live&quot; traffic, let&#39;s establish an additional SSH connection and utilize <code>tcpreplay</code> to replay network traffic from a PCAP file (<code>suspicious.pcap</code> in this case).</p>
<p>Suricata Fundamentals</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo  tcpreplay -i ens160 /</span>home<span class="hljs-regexp">/htb-student/</span>pcaps/suspicious.pcap
^C User interrupt...
sendpacket_abort
<span class="hljs-string">Actual:</span> <span class="hljs-number">730</span> packets (<span class="hljs-number">663801</span> bytes) sent <span class="hljs-keyword">in</span> <span class="hljs-number">22.84</span> seconds
<span class="hljs-string">Rated:</span> <span class="hljs-number">29060.3</span> Bps, <span class="hljs-number">0.232</span> Mbps, <span class="hljs-number">31.95</span> pps
Statistics <span class="hljs-keyword">for</span> network <span class="hljs-string">device:</span> ens160
        Successful <span class="hljs-string">packets:</span>        <span class="hljs-number">729</span>
        Failed <span class="hljs-string">packets:</span>            <span class="hljs-number">0</span>
        Truncated <span class="hljs-string">packets:</span>         <span class="hljs-number">0</span>
        Retried packets (ENOBUFS): <span class="hljs-number">0</span>
        Retried packets (EAGAIN):  <span class="hljs-number">0</span>
</code></pre>
<p>Then, feel free to terminate both tcpreplay and Suricata. The logs from the observed (replayed) traffic will be available at <code>/var/log/suricata</code></p>
<p>The -i option helps Suricata choose the best input option. In the case of Linux, the best input option is AF_PACKET. If pcap mode is needed, the --pcap option is recommended. Configuration of (Live) LibPCAP can be achieved via the suricata.yaml file, including settings for buffer size, BPF or tcpdump filters, checksum validation, threads, promiscuous mode, snap length, etc.</p>
<h3 id="hands-on-with-suricata-outputs">Hands-on With Suricata Outputs</h3>
<p>Suricata records a variety of data into logs that reside in the <code>/var/log/suricata</code> directory by default. For us to access and manipulate these logs, we require root-level access. Among these logs, we find the <code>eve.json</code>, <code>fast.log</code>, and <code>stats.log</code> files, which provide invaluable insight into the network activity. Let&#39;s delve into each:</p>
<ol>
<li><p><code>eve.json</code>: This file is Suricata&#39;s recommended output and contains JSON objects, each carrying diverse information such as timestamps, flow_id, event_type, and more. Try inspecting the content of <code>old_eve.json</code> residing at <code>/var/log/suricata</code> as follows.</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ less /var/log/suricata/old_eve.json
{<span class="hljs-string">"timestamp"</span>:<span class="hljs-string">"2023-07-06T08:34:24.526482+0000"</span>,<span class="hljs-string">"event_type"</span>:<span class="hljs-string">"stats"</span>,<span class="hljs-string">"stats"</span>:{<span class="hljs-string">"uptime"</span>:<span class="hljs-number">8</span>,<span class="hljs-string">"capture"</span>:{<span class="hljs-string">"kernel_packets"</span>:<span class="hljs-number">4</span>,<span class="hljs-string">"kernel_drops"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"errors"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"decoder"</span>:{<span class="hljs-string">"pkts"</span>:<span class="hljs-number">3</span>,<span class="hljs-string">"bytes"</span>:<span class="hljs-number">212</span>,<span class="hljs-string">"invalid"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ipv4"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ipv6"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"ethernet"</span>:<span class="hljs-number">3</span>,<span class="hljs-string">"chdlc"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"raw"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"null"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"sll"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"tcp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"udp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"sctp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"icmpv4"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"icmpv6"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"ppp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"pppoe"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"geneve"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"gre"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"vlan"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"vlan_qinq"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"vxlan"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"vntag"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ieee8021ah"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"teredo"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ipv4_in_ipv6"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ipv6_in_ipv6"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"mpls"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"avg_pkt_size"</span>:<span class="hljs-number">70</span>,<span class="hljs-string">"max_pkt_size"</span>:<span class="hljs-number">110</span>,<span class="hljs-string">"max_mac_addrs_src"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"max_mac_addrs_dst"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"erspan"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"event"</span>:{<span class="hljs-string">"ipv4"</span>:{<span class="hljs-string">"pkt_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"hlen_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"iplen_smaller_than_hlen"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"trunc_pkt"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"opt_invalid"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"opt_invalid_len"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"opt_malformed"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"opt_pad_required"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"opt_eol_required"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"opt_duplicate"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"opt_unknown"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"wrong_ip_version"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"icmpv6"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"frag_pkt_too_large"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"frag_overlap"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"frag_ignored"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"icmpv4"</span>:{<span class="hljs-string">"pkt_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"unknown_type"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"unknown_code"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ipv4_trunc_pkt"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ipv4_unknown_ver"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"icmpv6"</span>:{<span class="hljs-string">"unknown_type"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"unknown_code"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"pkt_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ipv6_unknown_version"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ipv6_trunc_pkt"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"mld_message_with_invalid_hl"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"unassigned_type"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"experimentation_type"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"ipv6"</span>:{<span class="hljs-string">"pkt_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"trunc_pkt"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"trunc_exthdr"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"exthdr_dupl_fh"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"exthdr_useless_fh"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"exthdr_dupl_rh"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"exthdr_dupl_hh"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"exthdr_dupl_dh"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"exthdr_dupl_ah"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"exthdr_dupl_eh"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"exthdr_invalid_optlen"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"wrong_ip_version"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"exthdr_ah_res_not_null"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"hopopts_unknown_opt"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"hopopts_only_padding"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"dstopts_unknown_opt"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"dstopts_only_padding"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"rh_type_0"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"zero_len_padn"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"fh_non_zero_reserved_field"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"data_after_none_header"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"unknown_next_header"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"icmpv4"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"frag_pkt_too_large"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"frag_overlap"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"frag_invalid_length"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"frag_ignored"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ipv4_in_ipv6_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ipv4_in_ipv6_wrong_version"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ipv6_in_ipv6_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ipv6_in_ipv6_wrong_version"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"tcp"</span>:{<span class="hljs-string">"pkt_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"hlen_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"invalid_optlen"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"opt_invalid_len"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"opt_duplicate"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"udp"</span>:{<span class="hljs-string">"pkt_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"hlen_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"hlen_invalid"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"len_invalid"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"sll"</span>:{<span class="hljs-string">"pkt_too_small"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"ethernet"</span>:{<span class="hljs-string">"pkt_too_small"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"ppp"</span>:{<span class="hljs-string">"pkt_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"vju_pkt_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ip4_pkt_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ip6_pkt_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"wrong_type"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"unsup_proto"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"pppoe"</span>:{<span class="hljs-string">"pkt_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"wrong_code"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"malformed_tags"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"gre"</span>:{<span class="hljs-string">"pkt_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"wrong_version"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"version0_recur"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"version0_flags"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"version0_hdr_too_big"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"version0_malformed_sre_hdr"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"version1_chksum"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"version1_route"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"version1_ssr"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"version1_recur"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"version1_flags"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"version1_no_key"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"version1_wrong_protocol"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"version1_malformed_sre_hdr"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"version1_hdr_too_big"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"vlan"</span>:{<span class="hljs-string">"header_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"unknown_type"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"too_many_layers"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"ieee8021ah"</span>:{<span class="hljs-string">"header_too_small"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"vntag"</span>:{<span class="hljs-string">"header_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"unknown_type"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"ipraw"</span>:{<span class="hljs-string">"invalid_ip_version"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"ltnull"</span>:{<span class="hljs-string">"pkt_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"unsupported_type"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"sctp"</span>:{<span class="hljs-string">"pkt_too_small"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"mpls"</span>:{<span class="hljs-string">"header_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"pkt_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"bad_label_router_alert"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"bad_label_implicit_null"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"bad_label_reserved"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"unknown_payload_type"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"vxlan"</span>:{<span class="hljs-string">"unknown_payload_type"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"geneve"</span>:{<span class="hljs-string">"unknown_payload_type"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"erspan"</span>:{<span class="hljs-string">"header_too_small"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"unsupported_version"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"too_many_vlan_layers"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"dce"</span>:{<span class="hljs-string">"pkt_too_small"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"chdlc"</span>:{<span class="hljs-string">"pkt_too_small"</span>:<span class="hljs-number">0</span>}},<span class="hljs-string">"too_many_layers"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"tcp"</span>:{<span class="hljs-string">"syn"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"synack"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"rst"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"sessions"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ssn_memcap_drop"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"pseudo"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"pseudo_failed"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"invalid_checksum"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"midstream_pickups"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"pkt_on_wrong_thread"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"segment_memcap_drop"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"stream_depth_reached"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"reassembly_gap"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"overlap"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"overlap_diff_data"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"insert_data_normal_fail"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"insert_data_overlap_fail"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"insert_list_fail"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"memuse"</span>:<span class="hljs-number">606208</span>,<span class="hljs-string">"reassembly_memuse"</span>:<span class="hljs-number">98304</span>},<span class="hljs-string">"flow"</span>:{<span class="hljs-string">"memcap"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"tcp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"udp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"icmpv4"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"icmpv6"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"tcp_reuse"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"get_used"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"get_used_eval"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"get_used_eval_reject"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"get_used_eval_busy"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"get_used_failed"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"wrk"</span>:{<span class="hljs-string">"spare_sync_avg"</span>:<span class="hljs-number">100</span>,<span class="hljs-string">"spare_sync"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"spare_sync_incomplete"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"spare_sync_empty"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"flows_evicted_needs_work"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"flows_evicted_pkt_inject"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"flows_evicted"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"flows_injected"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"mgr"</span>:{<span class="hljs-string">"full_hash_pass"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"closed_pruned"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"new_pruned"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"est_pruned"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"bypassed_pruned"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"rows_maxlen"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"flows_checked"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"flows_notimeout"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"flows_timeout"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"flows_timeout_inuse"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"flows_evicted"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"flows_evicted_needs_work"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"spare"</span>:<span class="hljs-number">9900</span>,<span class="hljs-string">"emerg_mode_entered"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"emerg_mode_over"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"memuse"</span>:<span class="hljs-number">7394304</span>},<span class="hljs-string">"defrag"</span>:{<span class="hljs-string">"ipv4"</span>:{<span class="hljs-string">"fragments"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"reassembled"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"timeouts"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"ipv6"</span>:{<span class="hljs-string">"fragments"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"reassembled"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"timeouts"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"max_frag_hits"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"flow_bypassed"</span>:{<span class="hljs-string">"local_pkts"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"local_bytes"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"local_capture_pkts"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"local_capture_bytes"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"closed"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"pkts"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"bytes"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"detect"</span>:{<span class="hljs-string">"engines"</span>:[{<span class="hljs-string">"id"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"last_reload"</span>:<span class="hljs-string">"2023-07-06T08:34:16.502768+0000"</span>,<span class="hljs-string">"rules_loaded"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"rules_failed"</span>:<span class="hljs-number">0</span>}],<span class="hljs-string">"alert"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"alert_queue_overflow"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"alerts_suppressed"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"app_layer"</span>:{<span class="hljs-string">"flow"</span>:{<span class="hljs-string">"http"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ftp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"smtp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"tls"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ssh"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"imap"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"smb"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"dcerpc_tcp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"dns_tcp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"nfs_tcp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ntp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ftp-data"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"tftp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ikev2"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"krb5_tcp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"dhcp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"snmp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"sip"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"rfb"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"mqtt"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"rdp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"failed_tcp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"dcerpc_udp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"dns_udp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"nfs_udp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"krb5_udp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"failed_udp"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"tx"</span>:{<span class="hljs-string">"http"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ftp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"smtp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"tls"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ssh"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"imap"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"smb"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"dcerpc_tcp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"dns_tcp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"nfs_tcp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ntp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ftp-data"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"tftp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"ikev2"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"krb5_tcp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"dhcp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"snmp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"sip"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"rfb"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"mqtt"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"rdp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"dcerpc_udp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"dns_udp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"nfs_udp"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"krb5_udp"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"expectations"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"http"</span>:{<span class="hljs-string">"memuse"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"memcap"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"ftp"</span>:{<span class="hljs-string">"memuse"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"memcap"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"file_store"</span>:{<span class="hljs-string">"open_files"</span>:<span class="hljs-number">0</span>}}}
---SNIP---
</code></pre>
<p>If we wish to filter out only alert events, for example, we can utilize the <code>jq</code> command-line JSON processor as follows.</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat /var/log/suricata/old_eve.json | jq -c <span class="hljs-string">'select(.event_type == "alert")'</span>
{<span class="hljs-string">"timestamp"</span>:<span class="hljs-string">"2023-07-06T08:34:35.003163+0000"</span>,<span class="hljs-string">"flow_id"</span>:<span class="hljs-number">1959965318909019</span>,<span class="hljs-string">"in_iface"</span>:<span class="hljs-string">"ens160"</span>,<span class="hljs-string">"event_type"</span>:<span class="hljs-string">"alert"</span>,<span class="hljs-string">"src_ip"</span>:<span class="hljs-string">"10.9.24.101"</span>,<span class="hljs-string">"src_port"</span>:<span class="hljs-number">51833</span>,<span class="hljs-string">"d est_ip"</span>:<span class="hljs-string">"10.9.24.1"</span>,<span class="hljs-string">"dest_port"</span>:<span class="hljs-number">53</span>,<span class="hljs-string">"proto"</span>:<span class="hljs-string">"UDP"</span>,<span class="hljs-string">"tx_id"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"alert"</span>:{<span class="hljs-string">"action"</span>:<span class="hljs-string">"allowed"</span>,<span class="hljs-string">"gid"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"signature_id"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"rev"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"signature"</span>:<span class="hljs-string">"Known bad DNS lookup, possible Dridex infection"</span>,<span class="hljs-string">"category"</span>:<span class="hljs-string">""</span>,<span class="hljs-string">"severity"</span>:<span class="hljs-number">3</span>},<span class="hljs-string">"dns"</span>:{<span class="hljs-string">"query"</span>:[{<span class="hljs-string">"type"</span>:<span class="hljs-string">"query"</span>,<span class="hljs-string">"id"</span>:<span class="hljs-number">6430</span>,<span class="hljs-string">"rrname"</span>:<span class="hljs-string">"adv.epostoday.uk"</span>,<span class="hljs-string">"rrtype"</span>:<span class="hljs-string">"A"</span>,<span class="hljs-string">"tx_id"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"opcode"</span>:<span class="hljs-number">0</span>}    ]},<span class="hljs-string">"app_proto"</span>:<span class="hljs-string">"dns"</span>,<span class="hljs-string">"flow"</span>:{<span class="hljs-string">"pkts_toserver"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"pkts_toclient"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"bytes_toserver"</span>:<span class="hljs-number">76</span>,<span class="hljs-string">"bytes_toclient"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"start"</span>:<span class="hljs-string">"2023-07-06T08:34:35.003163+0000"</span>}}
</code></pre>
<p>If we wish to identify the earliest DNS event, for example, we can utilize the <code>jq</code> command-line JSON processor as follows.</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat /var/log/suricata/old_eve.json | <span class="hljs-type">jq</span> -c 'select(.event_type == <span class="hljs-string">"dns"</span>)' | <span class="hljs-type">head</span> <span class="hljs-number">-1</span> | <span class="hljs-type">jq</span> .
{
 <span class="hljs-string">"timestamp"</span>: <span class="hljs-string">"2023-07-06T08:34:35.003163+0000"</span>,
 <span class="hljs-string">"flow_id"</span>: <span class="hljs-number">1959965318909019</span>,
 <span class="hljs-string">"in_iface"</span>: <span class="hljs-string">"ens160"</span>,
  <span class="hljs-string">"event_type"</span>: <span class="hljs-string">"dns"</span>,
  <span class="hljs-string">"src_ip"</span>: <span class="hljs-string">"10.9.24.101"</span>,
 <span class="hljs-string">"src_port"</span>: <span class="hljs-number">51833</span>,
 <span class="hljs-string">"dest_ip"</span>: <span class="hljs-string">"10.9.24.1"</span>,
 <span class="hljs-string">"dest_port"</span>: <span class="hljs-number">53</span>,
 <span class="hljs-string">"proto"</span>: <span class="hljs-string">"UDP"</span>,
 <span class="hljs-string">"dns"</span>: {
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"query"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">6430</span>,
     <span class="hljs-string">"rrname"</span>: <span class="hljs-string">"adv.epostoday.uk"</span>,
     <span class="hljs-string">"rrtype"</span>: <span class="hljs-string">"A"</span>,
     <span class="hljs-string">"tx_id"</span>: <span class="hljs-number">0</span>,
    <span class="hljs-string">"opcode"</span>: <span class="hljs-number">0</span>
 }
}
</code></pre>
<p>We can also use similar commands to filter for other event types like TLS and SSH.</p>
<p><code>flow_id</code>: This is a unique identifier assigned by Suricata to each network flow. A flow, in Suricata terms, is defined as a set of IP packets passing through a network interface in a specific direction and between a given pair of source and destination endpoints. Each of these flows gets a unique flow_id. This identifier helps us track and correlate various events related to the same network flow in the EVE JSON log. Using <code>flow_id</code>, we can associate different pieces of information related to the same flow, such as alerts, network transactions, and packets, providing a cohesive view of what is happening on a specific communication channel.</p>
<p><code>pcap_cnt</code>: This is a counter that Suricata increments for each packet it processes from the network traffic or from a PCAP file (in offline mode). <code>pcap_cnt</code> allows us to trace a packet back to its original order in the PCAP file or network stream. This is beneficial in understanding the sequence of network events as they occurred. It can help to precisely pinpoint when an alert was triggered in relation to other packets, which can provide valuable context in an investigation.</p>
</li>
<li><p><code>fast.log</code>: This is a text-based log format that records alerts only and is enabled by default. Try inspecting the content of <code>old_fast.log</code> residing at <code>/var/log/suricata</code> as follows.</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ cat /var/log/suricata/old_fast.log
<span class="hljs-number">07</span>/<span class="hljs-number">06</span>/<span class="hljs-number">2023</span>-<span class="hljs-number">08</span>:<span class="hljs-number">34</span>:<span class="hljs-number">35.003163</span>  [**] [<span class="hljs-number">1</span>:<span class="hljs-number">1</span>:<span class="hljs-number">0</span>] Known bad DNS lookup, possible Dridex infection [**] [Classification: (null)] [Priority: <span class="hljs-number">3</span>] {<span class="hljs-selector-tag">UDP</span>} 10<span class="hljs-selector-class">.9</span><span class="hljs-selector-class">.24</span><span class="hljs-selector-class">.101</span><span class="hljs-selector-pseudo">:51833</span> <span class="hljs-selector-tag">-</span>&gt; 10<span class="hljs-selector-class">.9</span><span class="hljs-selector-class">.24</span><span class="hljs-selector-class">.1</span><span class="hljs-selector-pseudo">:53</span>
</code></pre>
</li>
<li><p><code>stats.log</code>: This is a human-readable statistics log, which can be particularly useful while debugging Suricata deployments. Try inspecting the content of <code>old_stats.log</code> residing at <code>/var/log/suricata</code> as follows.</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb[/htb]$</span> cat /var/log/suricata/old_stats.log
------------------------------------------------------------------------------------
Date: 7/6/2023 -- 08:34:24 (uptime: 0d, 00h 00m 08s)
------------------------------------------------------------------------------------
Counter                                       |<span class="hljs-string"> TM Name                   </span>|<span class="hljs-string"> Value
------------------------------------------------------------------------------------
capture.kernel_packets                        </span>|<span class="hljs-string"> Total                     </span>|<span class="hljs-string"> 4
decoder.pkts                                  </span>|<span class="hljs-string"> Total                     </span>|<span class="hljs-string"> 3
decoder.bytes                                 </span>|<span class="hljs-string"> Total                     </span>|<span class="hljs-string"> 212
decoder.ipv6                                  </span>|<span class="hljs-string"> Total                     </span>|<span class="hljs-string"> 1
decoder.ethernet                              </span>|<span class="hljs-string"> Total                     </span>|<span class="hljs-string"> 3
decoder.icmpv6                                </span>|<span class="hljs-string"> Total                     </span>|<span class="hljs-string"> 1
decoder.avg_pkt_size                          </span>|<span class="hljs-string"> Total                     </span>|<span class="hljs-string"> 70
decoder.max_pkt_size                          </span>|<span class="hljs-string"> Total                     </span>|<span class="hljs-string"> 110
flow.icmpv6                                   </span>|<span class="hljs-string"> Total                     </span>|<span class="hljs-string"> 1
flow.wrk.spare_sync_avg                       </span>|<span class="hljs-string"> Total                     </span>|<span class="hljs-string"> 100
flow.wrk.spare_sync                           </span>|<span class="hljs-string"> Total                     </span>|<span class="hljs-string"> 1
flow.mgr.full_hash_pass                       </span>|<span class="hljs-string"> Total                     </span>|<span class="hljs-string"> 1
flow.spare                                    </span>|<span class="hljs-string"> Total                     </span>|<span class="hljs-string"> 9900
tcp.memuse                                    </span>|<span class="hljs-string"> Total                     </span>|<span class="hljs-string"> 606208
tcp.reassembly_memuse                         </span>|<span class="hljs-string"> Total                     </span>|<span class="hljs-string"> 98304
flow.memuse                                   </span>|<span class="hljs-string"> Total                     </span>|<span class="hljs-string"> 7394304
------------------------------------------------------------------------------------
---SNIP---</span>
</code></pre>
</li>
</ol>
<hr>
<p>For those of us who want a more focused output strategy, there&#39;s an option to deactivate the comprehensive <code>EVE</code> output and activate particular outputs instead. Take <code>http-log</code>, for instance. By activating this, every time Suricata is run and encounters HTTP events, a fresh <code>http.log</code> file will be generated.</p>
<h3 id="hands-on-with-suricata-outputs-file-extraction">Hands-on With Suricata Outputs - File Extraction</h3>
<p>Suricata, has an underused yet highly potent feature - <a href="https://docs.suricata.io/en/suricata-6.0.13/file-extraction/file-extraction.html">file extraction</a>. This feature allows us to capture and store files transferred over a number of different protocols, providing invaluable data for threat hunting, forensics, or simply data analysis.</p>
<p>Here&#39;s how we go about enabling file extraction in Suricata.</p>
<p>We start by making changes to the Suricata configuration file (<code>suricata.yaml</code>). In this file, we&#39;ll find a section named <code>file-store</code>. This is where we tell Suricata how to handle the files it extracts. Specifically, we need to set <code>version</code> to <code>2</code>, enabled to <code>yes</code>, and the <code>force-filestore</code> option also to <code>yes</code>. The resulting section should look something like this.</p>
<p>Suricata Fundamentals</p>
<pre><code class="lang-shell-session"><span class="hljs-attr">file-store:</span>
<span class="hljs-attr">  version:</span> <span class="hljs-number">2</span>
<span class="hljs-attr">  enabled:</span> <span class="hljs-literal">yes</span>
<span class="hljs-attr">  force-filestore:</span> <span class="hljs-literal">yes</span>
</code></pre>
<p>In the same <code>file-store</code> section, we define where Suricata stores the extracted files. We set the <code>dir</code> option to the directory of our choice.</p>
<p>As a quick exercise, let&#39;s enable file extraction and run Suricata on the <code>/home/htb-student/pcaps/vm-2.pcap</code> file from <a href="https://www.netresec.com/?page=PcapFiles">www.netresec.com</a>.</p>
<p>In accordance with the guidelines put forth in Suricata&#39;s documentation, file extraction isn&#39;t an automatic process that occurs without our explicit instructions. It&#39;s fundamentally crucial for us to craft a specific rule that instructs Suricata when and what kind of files it should extract.</p>
<p>The simplest rule we can add to our <code>local.rules</code> file to experiment with file extraction is the following.</p>
<p>Suricata Fundamentals</p>
<pre><code class="lang-shell-session">alert <span class="hljs-keyword">http</span> <span class="hljs-keyword">any</span> <span class="hljs-keyword">any</span> -&gt; <span class="hljs-keyword">any</span> <span class="hljs-keyword">any</span> (msg:<span class="hljs-string">"FILE store all"</span>; filestore; sid:<span class="hljs-number">2</span>; rev:<span class="hljs-number">1</span>;)
</code></pre>
<p>If we configured Suricata correctly, multiple files will be stored inside the <code>filestore</code> directory.</p>
<p>Let&#39;s run Suricata on the <code>/home/htb-student/pcaps/vm-2.pcap</code> file.</p>
<p>Suricata Fundamentals</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ suricata -r /home/htb-student/pcaps/<span class="hljs-keyword">vm</span>-<span class="hljs-number">2</span>.pcap
<span class="hljs-number">7</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">25</span>:<span class="hljs-number">57</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - This <span class="hljs-keyword">is</span> Suricata <span class="hljs-keyword">version</span> <span class="hljs-number">6.0</span>.<span class="hljs-number">13</span> RELEASE running in USER <span class="hljs-keyword">mode</span>
<span class="hljs-number">7</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">25</span>:<span class="hljs-number">57</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - <span class="hljs-keyword">all</span> <span class="hljs-number">3</span> packet processing threads, <span class="hljs-number">4</span> management threads initialized, engine started.
<span class="hljs-number">7</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">25</span>:<span class="hljs-number">57</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - Signal Received.  Stopping engine.
<span class="hljs-number">7</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">25</span>:<span class="hljs-number">57</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - Pcap-<span class="hljs-keyword">file</span> module <span class="hljs-keyword">read</span> <span class="hljs-number">1</span> <span class="hljs-keyword">files</span>, <span class="hljs-number">803</span> packets, <span class="hljs-number">683915</span> bytes
</code></pre>
<p>We will notice that <code>eve.json</code>, <code>fast.log</code>, <code>stats.log</code>, and <code>suricata.log</code> were created, alongside a new directory called <code>filestore</code>. <code>filestore</code>&#39;s content in terms of the files it contains can be inspected as follows.</p>
<p>Suricata Fundamentals</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cd filestore
root@htb[/htb]$ find . -type f
./fb/fb20d18d00c806deafe14859052072aecfb9f46be6210acfce80289740f2e20e
./<span class="hljs-number">21</span>/<span class="hljs-number">214306</span>c98a3483048d6a69eec6bf3b50497363bc2c98ed3cd954203ec52455e5
./<span class="hljs-number">21</span>/<span class="hljs-number">21742</span>fc621f83041db2e47b0899f5aea6caa00a4b67dbff0aae823e6817c5433
./<span class="hljs-number">26</span>/<span class="hljs-number">2694</span>f69c4abf2471e09f6263f66eb675a0ca6ce58050647dcdcfebaf69f11ff4
./<span class="hljs-number">2</span>c/<span class="hljs-number">2</span>ca1a0cd9d8727279f0ba99fd051e1c0acd621448ad4362e1c9fc78700015228
./<span class="hljs-number">7</span>d/<span class="hljs-number">7</span>d4c00f96f38e0ffd89bc2d69005c4212ef577354cc97d632a09f51b2d37f877
./<span class="hljs-number">6</span>b/<span class="hljs-number">6</span>b7fee8a4b813b6405361db2e70a4f5a213b34875dd2793667519117d8ca0e4e
./<span class="hljs-number">2</span>e/<span class="hljs-number">2e2</span>cb2cac099f08bc51abba263d9e3f8ac7176b54039cc30bbd4a45cfa769018
./<span class="hljs-number">50</span>/<span class="hljs-number">508</span>c47dd306da3084475faae17b3acd5ff2700d2cd85d71428cdfaae28c9fd41
./c2/c210f737f55716a089a33daf42658afe771cfb43228ffa405d338555a9918815
./ea/ea0936257b8d96ee6ae443adee0f3dacc3eff72b559cd5ee3f9d6763cf5ee2ab
./<span class="hljs-number">1</span>a/<span class="hljs-number">1</span>aab7d9c153887dfa63853534f684e5d46ecd17ba60cd3d61050f7f231c4babb
./c4/c4775e980c97b162fd15e0010663694c4e09f049ff701d9671e1578958388b9f
./<span class="hljs-number">63</span>/<span class="hljs-number">63</span>de4512dfbd0087f929b0e070cc90d534d6baabf2cdfbeaf76bee24ff9b1638
./<span class="hljs-number">48</span>/<span class="hljs-number">482</span>d9972c2152ca96616dc23bbaace55804c9d52f5d8b253b617919bb773d3bb
./<span class="hljs-number">8</span>e/<span class="hljs-number">8</span>ea3146c676ba436c0392c3ec26ee744155af4e4eca65f4e99ec68574a747a14
./<span class="hljs-number">8</span>e/<span class="hljs-number">8e23160</span>cc504b4551a94943e677f6985fa331659a1ba58ef01afb76574d2ad7c
./a5/a52dac473b33c22112a6f53c6a625f39fe0d6642eb436e5d125342a24de44581
</code></pre>
<p>Again in accordance with the guidelines put forth in Suricata&#39;s documentation the <code>file-store</code> module uses its own log directory (default: <code>filestore</code> in the default logging directory) and logs files using the SHA256 of the contents as the filename. Each file is then placed in a directory named 00 to ff where the directory shares the first 2 characters of the filename. For example, if the SHA256 hex string of an extracted file starts with <code>f9bc6d...</code> the file we be placed in the directory <code>filestore/f9</code>.</p>
<p>If we wanted to inspect, for example, the <code>/21/21742fc621f83041db2e47b0899f5aea6caa00a4b67dbff0aae823e6817c5433</code> file inside the <code>filestore</code> directory, we could use the <code>xxd</code> tool as follows.</p>
<p>Suricata Fundamentals</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cd filestore
root@htb[/htb]$ xxd ./<span class="hljs-number">21</span>/<span class="hljs-number">21742</span>fc621f83041db2e47b0899f5aea6caa00a4b67dbff0aae823e6817c5433 | head
<span class="hljs-number">00000000</span>: <span class="hljs-number">4</span>d5a <span class="hljs-number">9000</span> <span class="hljs-number">0300</span> <span class="hljs-number">0000</span> <span class="hljs-number">0400</span> <span class="hljs-number">0000</span> ffff <span class="hljs-number">0000</span>  MZ..............
<span class="hljs-number">00000010</span>: b800 <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">4000</span> <span class="hljs-number">0000</span> e907 <span class="hljs-number">0000</span>  ........@.......
<span class="hljs-number">00000020</span>: <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span>  ................
<span class="hljs-number">00000030</span>: <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">8000</span> <span class="hljs-number">0000</span>  ................
<span class="hljs-number">00000040</span>: <span class="hljs-number">0e1</span>f ba0e <span class="hljs-number">00</span>b4 <span class="hljs-number">09</span>cd <span class="hljs-number">21</span>b8 <span class="hljs-number">014</span>c cd21 <span class="hljs-number">5468</span>  ........!..L.!Th
<span class="hljs-number">00000050</span>: <span class="hljs-number">6973</span> <span class="hljs-number">2070</span> <span class="hljs-number">726</span>f <span class="hljs-number">6772</span> <span class="hljs-number">616</span>d <span class="hljs-number">2063</span> <span class="hljs-number">616</span>e <span class="hljs-number">6e6</span>f  is program canno
<span class="hljs-number">00000060</span>: <span class="hljs-number">7420</span> <span class="hljs-number">6265</span> <span class="hljs-number">2072</span> <span class="hljs-number">756</span>e <span class="hljs-number">2069</span> <span class="hljs-number">6e20</span> <span class="hljs-number">444</span>f <span class="hljs-number">5320</span>  t be run <span class="hljs-keyword">in</span> DOS
<span class="hljs-number">00000070</span>: <span class="hljs-number">6</span>d6f <span class="hljs-number">6465</span> <span class="hljs-number">2e0</span>d <span class="hljs-number">0</span>d0a <span class="hljs-number">2400</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span>  mode....$.......
<span class="hljs-number">00000080</span>: <span class="hljs-number">5045</span> <span class="hljs-number">0000</span> <span class="hljs-number">4</span>c01 <span class="hljs-number">0300</span> fc90 <span class="hljs-number">8448</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span>  PE..L......H....
<span class="hljs-number">00000090</span>: <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> e000 <span class="hljs-number">0</span>f01 <span class="hljs-number">0</span>b01 <span class="hljs-number">0600</span> <span class="hljs-number">00</span>d0 <span class="hljs-number">0000</span>  ................
</code></pre>
<p>In this case, the file was a Windows executable based on the file&#39;s header. More about the MS-DOS EXE format can be found in following resource <a href="https://wiki.osdev.org/MZ">MZ</a>.</p>
<h3 id="live-rule-reloading-feature-updating-suricata-rulesets">Live Rule Reloading Feature &amp; Updating Suricata Rulesets</h3>
<p>Live rule reloading is a crucial feature in Suricata that allows us to update our ruleset without interrupting ongoing traffic inspection. This feature provides continuous monitoring and minimizes the chances of missing any malicious activity.</p>
<p>To enable live rule reloading in Suricata, we need to configure our Suricata configuration file (<code>suricata.yaml</code>). In the <code>suricata.yaml</code> file, we should locate the <code>detect-engine</code> section and set the value of the <code>reload</code> parameter to <code>true</code>. It looks something like this:</p>
<p>Suricata Fundamentals</p>
<pre><code class="lang-shell-session">detect-<span class="hljs-string">engine:</span>
  - <span class="hljs-string">reload:</span> <span class="hljs-literal">true</span>
</code></pre>
<p>Proceed to execute the following <code>kill</code> command, which will signal the Suricata process (determined by <code>$(pidof suricata)</code>) to refresh its rule set without necessitating a complete restart.</p>
<p>Suricata Fundamentals</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ sudo kill -usr2 $(pidof suricata)
</code></pre>
<p>This modification tells Suricata to check for changes in the ruleset periodically and apply them without needing to restart the service.</p>
<p>Most of the commands below cannot be replicated inside this section&#39;s target since they require internet connectivity.</p>
<p>Updating Suricata&#39;s ruleset can be performed using the <code>suricata-update</code> tool. We can perform a simple update to the Suricata ruleset using the following command.</p>
<p>Suricata Fundamentals</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ sudo suricata-update
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">44</span> - &lt;Info&gt; -- Using data-directory <span class="hljs-regexp">/var/</span>lib/suricata.
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">44</span> - &lt;Info&gt; -- Using Suricata configuration <span class="hljs-regexp">/etc/</span>suricata/suricata.yaml
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">44</span> - &lt;Info&gt; -- Using <span class="hljs-regexp">/etc/</span>suricata/rules <span class="hljs-keyword">for</span> Suricata provided rules.
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">44</span> - &lt;Info&gt; -- Found Suricata version <span class="hljs-number">6.0</span><span class="hljs-number">.13</span> at <span class="hljs-regexp">/usr/</span>bin/suricata.
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">44</span> - &lt;Info&gt; -- Loading <span class="hljs-regexp">/etc/</span>suricata/suricata.yaml
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">44</span> - &lt;Info&gt; -- Disabling rules <span class="hljs-keyword">for</span> protocol http2
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">44</span> - &lt;Info&gt; -- Disabling rules <span class="hljs-keyword">for</span> protocol modbus
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">44</span> - &lt;Info&gt; -- Disabling rules <span class="hljs-keyword">for</span> protocol dnp3
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">44</span> - &lt;Info&gt; -- Disabling rules <span class="hljs-keyword">for</span> protocol enip
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">44</span> - &lt;Info&gt; -- No sources configured, will use Emerging Threats Open
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">44</span> - &lt;Info&gt; -- Fetching <span class="hljs-string">https:</span><span class="hljs-comment">//rules.emergingthreats.net/open/suricata-6.0.13/emerging.rules.tar.gz.</span>
 <span class="hljs-number">100</span>% - <span class="hljs-number">3963342</span>/<span class="hljs-number">3963342</span>
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">45</span> - &lt;Info&gt; -- Done.
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">45</span> - &lt;Info&gt; -- Loading distribution rule file <span class="hljs-regexp">/etc/</span>suricata<span class="hljs-regexp">/rules/</span>app-layer-events.rules
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">45</span> - &lt;Info&gt; -- Loading distribution rule file <span class="hljs-regexp">/etc/</span>suricata<span class="hljs-regexp">/rules/</span>decoder-events.rules
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">45</span> - &lt;Info&gt; -- Loading distribution rule file <span class="hljs-regexp">/etc/</span>suricata<span class="hljs-regexp">/rules/</span>dhcp-events.rules
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">45</span> - &lt;Info&gt; -- Loading distribution rule file <span class="hljs-regexp">/etc/</span>suricata<span class="hljs-regexp">/rules/</span>dnp3-events.rules
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">45</span> - &lt;Info&gt; -- Loading distribution rule file <span class="hljs-regexp">/etc/</span>suricata<span class="hljs-regexp">/rules/</span>dns-events.rules
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">45</span> - &lt;Info&gt; -- Loading distribution rule file <span class="hljs-regexp">/etc/</span>suricata<span class="hljs-regexp">/rules/</span>files.rules
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">45</span> - &lt;Info&gt; -- Loading distribution rule file <span class="hljs-regexp">/etc/</span>suricata<span class="hljs-regexp">/rules/</span>http-events.rules
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">45</span> - &lt;Info&gt; -- Loading distribution rule file <span class="hljs-regexp">/etc/</span>suricata<span class="hljs-regexp">/rules/</span>ipsec-events.rules
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">45</span> - &lt;Info&gt; -- Loading distribution rule file <span class="hljs-regexp">/etc/</span>suricata<span class="hljs-regexp">/rules/</span>kerberos-events.rules
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">45</span> - &lt;Info&gt; -- Loading distribution rule file <span class="hljs-regexp">/etc/</span>suricata<span class="hljs-regexp">/rules/</span>modbus-events.rules
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">45</span> - &lt;Info&gt; -- Loading distribution rule file <span class="hljs-regexp">/etc/</span>suricata<span class="hljs-regexp">/rules/</span>nfs-events.rules
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">45</span> - &lt;Info&gt; -- Loading distribution rule file <span class="hljs-regexp">/etc/</span>suricata<span class="hljs-regexp">/rules/</span>ntp-events.rules
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">45</span> - &lt;Info&gt; -- Loading distribution rule file <span class="hljs-regexp">/etc/</span>suricata<span class="hljs-regexp">/rules/</span>smb-events.rules
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">45</span> - &lt;Info&gt; -- Loading distribution rule file <span class="hljs-regexp">/etc/</span>suricata<span class="hljs-regexp">/rules/</span>smtp-events.rules
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">45</span> - &lt;Info&gt; -- Loading distribution rule file <span class="hljs-regexp">/etc/</span>suricata<span class="hljs-regexp">/rules/</span>stream-events.rules
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">45</span> - &lt;Info&gt; -- Loading distribution rule file <span class="hljs-regexp">/etc/</span>suricata<span class="hljs-regexp">/rules/</span>tls-events.rules
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">45</span> - &lt;Info&gt; -- Ignoring file rules/emerging-deleted.rules
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">48</span> - &lt;Info&gt; -- Loaded <span class="hljs-number">43453</span> rules.
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">48</span> - &lt;Info&gt; -- Disabled <span class="hljs-number">14</span> rules.
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">48</span> - &lt;Info&gt; -- Enabled <span class="hljs-number">0</span> rules.
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">48</span> - &lt;Info&gt; -- Modified <span class="hljs-number">0</span> rules.
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">48</span> - &lt;Info&gt; -- Dropped <span class="hljs-number">0</span> rules.
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">48</span> - &lt;Info&gt; -- Enabled <span class="hljs-number">131</span> rules <span class="hljs-keyword">for</span> flowbit dependencies.
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">48</span> - &lt;Info&gt; -- Creating directory <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/suricata/</span>rules.
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">48</span> - &lt;Info&gt; -- Backing up current rules.
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">49</span> - &lt;Info&gt; -- Writing rules to <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/suricata/</span>rules/suricata.<span class="hljs-string">rules:</span> <span class="hljs-string">total:</span> <span class="hljs-number">43453</span>; <span class="hljs-string">enabled:</span> <span class="hljs-number">34465</span>; <span class="hljs-string">added:</span> <span class="hljs-number">43453</span>; removed <span class="hljs-number">0</span>; <span class="hljs-string">modified:</span> <span class="hljs-number">0</span>
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">49</span> - &lt;Info&gt; -- Writing <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/suricata/</span>rules/classification.config
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">46</span>:<span class="hljs-number">49</span> - &lt;Info&gt; -- Testing with suricata -T.
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">47</span>:<span class="hljs-number">11</span> - &lt;Info&gt; -- Done.
</code></pre>
<p>As displayed in the example above, the output indicates that the <code>suricata-update</code> command has successfully retrieved the rules by establishing a connection with <code>https://rules.emergingthreats.net/open/</code>. Subsequently, the command saves the newly obtained rules to the <code>/var/lib/suricata/rules/</code> directory.</p>
<p>Moving forward, let&#39;s execute the command provided below to generate a comprehensive list of all ruleset providers.</p>
<p>Suricata Fundamentals</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo suricata-update list-sources
<span class="hljs-number">6</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">59</span>:<span class="hljs-number">29</span> - <span class="hljs-params">&lt;Info&gt;</span> -- Using data-directory <span class="hljs-meta-keyword">/var/</span>lib/suricata.
<span class="hljs-number">6</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">59</span>:<span class="hljs-number">29</span> - <span class="hljs-params">&lt;Info&gt;</span> -- Using Suricata configuration <span class="hljs-meta-keyword">/etc/</span>suricata/suricata.yaml
<span class="hljs-number">6</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">59</span>:<span class="hljs-number">29</span> - <span class="hljs-params">&lt;Info&gt;</span> -- Using <span class="hljs-meta-keyword">/etc/</span>suricata/rules for Suricata provided rules.
<span class="hljs-number">6</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">59</span>:<span class="hljs-number">29</span> - <span class="hljs-params">&lt;Info&gt;</span> -- Found Suricata version <span class="hljs-number">6.0</span><span class="hljs-number">.13</span> at <span class="hljs-meta-keyword">/usr/</span>bin/suricata.
<span class="hljs-number">6</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">59</span>:<span class="hljs-number">29</span> - <span class="hljs-params">&lt;Info&gt;</span> -- No source index found, running update-sources
<span class="hljs-number">6</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">59</span>:<span class="hljs-number">29</span> - <span class="hljs-params">&lt;Info&gt;</span> -- Downloading https:<span class="hljs-comment">//www.openinfosecfoundation.org/rules/index.yaml</span>
<span class="hljs-number">6</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">59</span>:<span class="hljs-number">29</span> - <span class="hljs-params">&lt;Info&gt;</span> -- Adding all sources
<span class="hljs-number">6</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">06</span>:<span class="hljs-number">59</span>:<span class="hljs-number">29</span> - <span class="hljs-params">&lt;Info&gt;</span> -- Saved <span class="hljs-meta-keyword">/var/</span>lib<span class="hljs-meta-keyword">/suricata/</span>update<span class="hljs-meta-keyword">/cache/</span>index.yaml
<span class="hljs-symbol">Name:</span> et/open
<span class="hljs-symbol">  Vendor:</span> Proofpoint
<span class="hljs-symbol">  Summary:</span> Emerging Threats Open Ruleset
<span class="hljs-symbol">  License:</span> MIT
<span class="hljs-symbol">Name:</span> et/pro
<span class="hljs-symbol">  Vendor:</span> Proofpoint
<span class="hljs-symbol">  Summary:</span> Emerging Threats Pro Ruleset
<span class="hljs-symbol">  License:</span> Commercial
<span class="hljs-symbol">  Replaces:</span> et/open
<span class="hljs-symbol">  Parameters:</span> secret-code
<span class="hljs-symbol">  Subscription:</span> https:<span class="hljs-comment">//www.proofpoint.com/us/threat-insight/et-pro-ruleset</span>
<span class="hljs-symbol">Name:</span> oisf/trafficid
<span class="hljs-symbol">  Vendor:</span> OISF
<span class="hljs-symbol">  Summary:</span> Suricata Traffic ID ruleset
<span class="hljs-symbol">  License:</span> MIT
<span class="hljs-symbol">Name:</span> scwx/enhanced
<span class="hljs-symbol">  Vendor:</span> Secureworks
<span class="hljs-symbol">  Summary:</span> Secureworks suricata-enhanced ruleset
<span class="hljs-symbol">  License:</span> Commercial
<span class="hljs-symbol">  Parameters:</span> secret-code
<span class="hljs-symbol">  Subscription:</span> https:<span class="hljs-comment">//www.secureworks.com/contact/ (Please reference CTU Countermeasures)</span>
<span class="hljs-symbol">Name:</span> scwx/malware
<span class="hljs-symbol">  Vendor:</span> Secureworks
<span class="hljs-symbol">  Summary:</span> Secureworks suricata-malware ruleset
<span class="hljs-symbol">  License:</span> Commercial
<span class="hljs-symbol">  Parameters:</span> secret-code
<span class="hljs-symbol">  Subscription:</span> https:<span class="hljs-comment">//www.secureworks.com/contact/ (Please reference CTU Countermeasures)</span>
<span class="hljs-symbol">Name:</span> scwx/security
<span class="hljs-symbol">  Vendor:</span> Secureworks
<span class="hljs-symbol">  Summary:</span> Secureworks suricata-security ruleset
<span class="hljs-symbol">  License:</span> Commercial
<span class="hljs-symbol">  Parameters:</span> secret-code
<span class="hljs-symbol">  Subscription:</span> https:<span class="hljs-comment">//www.secureworks.com/contact/ (Please reference CTU Countermeasures)</span>
<span class="hljs-symbol">Name:</span> sslbl/ssl-fp-blacklist
<span class="hljs-symbol">  Vendor:</span> Abuse.ch
<span class="hljs-symbol">  Summary:</span> Abuse.ch SSL Blacklist
<span class="hljs-symbol">  License:</span> Non-Commercial
<span class="hljs-symbol">Name:</span> sslbl/ja3-fingerprints
<span class="hljs-symbol">  Vendor:</span> Abuse.ch
<span class="hljs-symbol">  Summary:</span> Abuse.ch Suricata JA3 Fingerprint Ruleset
<span class="hljs-symbol">  License:</span> Non-Commercial
<span class="hljs-symbol">Name:</span> etnetera/aggressive
<span class="hljs-symbol">  Vendor:</span> Etnetera a.s.
<span class="hljs-symbol">  Summary:</span> Etnetera aggressive IP blacklist
<span class="hljs-symbol">  License:</span> MIT
<span class="hljs-symbol">Name:</span> tgreen/hunting
<span class="hljs-symbol">  Vendor:</span> tgreen
<span class="hljs-symbol">  Summary:</span> Threat hunting rules
<span class="hljs-symbol">  License:</span> GPLv3
<span class="hljs-symbol">Name:</span> malsilo/win-malware
<span class="hljs-symbol">  Vendor:</span> malsilo
<span class="hljs-symbol">  Summary:</span> Commodity malware rules
<span class="hljs-symbol">  License:</span> MIT
<span class="hljs-symbol">Name:</span> stamus/lateral
<span class="hljs-symbol">  Vendor:</span> Stamus Networks
<span class="hljs-symbol">  Summary:</span> Lateral movement rules
<span class="hljs-symbol">  License:</span> GPL<span class="hljs-number">-3.0</span>-only
</code></pre>
<p>Let&#39;s make a note from the output above of a specific ruleset name from which we want Suricata to fetch rulesets. The <code>et/open</code> rulesets serve as an excellent choice for demonstration purposes.</p>
<p>Next, let&#39;s proceed with executing the following command to retrieve and enable the <code>et/open</code> rulesets within our Suricata rules.</p>
<p>Suricata Fundamentals</p>
<pre><code class="lang-shell-session">root@htb[<span class="hljs-regexp">/htb]$ sudo suricata-update enable-source et/open</span>
<span class="hljs-number">6</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">07</span>:<span class="hljs-number">02</span>:<span class="hljs-number">08</span> - &lt;Info&gt; -- Using data-directory /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">suricata</span>.</span>
<span class="hljs-number">6</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">07</span>:<span class="hljs-number">02</span>:<span class="hljs-number">08</span> - &lt;Info&gt; -- Using Suricata configuration /etc/suricata/suricata.yaml
<span class="hljs-number">6</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">07</span>:<span class="hljs-number">02</span>:<span class="hljs-number">08</span> - &lt;Info&gt; -- Using /etc/suricata/rules <span class="hljs-keyword">for</span> Suricata provided rules.
<span class="hljs-number">6</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">07</span>:<span class="hljs-number">02</span>:<span class="hljs-number">08</span> - &lt;Info&gt; -- Found Suricata version <span class="hljs-number">6.0</span>.<span class="hljs-number">13</span> at /usr/bin/suricata.
<span class="hljs-number">6</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">07</span>:<span class="hljs-number">02</span>:<span class="hljs-number">08</span> - &lt;Info&gt; -- Creating directory /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">suricata</span>/<span class="hljs-title">update</span>/<span class="hljs-title">sources</span></span>
<span class="hljs-number">6</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">07</span>:<span class="hljs-number">02</span>:<span class="hljs-number">08</span> - &lt;Info&gt; -- Source et/open enabled
</code></pre>
<p>Lastly, let&#39;s reissue the <code>suricata-update</code> command to load the newly acquired ruleset.</p>
<p>Suricata Fundamentals</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ sudo suricata-update
</code></pre>
<p>A Suricata service restart may also be required.</p>
<p>Suricata Fundamentals</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ sudo systemctl restart suricata
</code></pre>
<h3 id="validating-suricata-s-configuration">Validating Suricata&#39;s Configuration</h3>
<p>Validation of Suricata&#39;s configuration is also an essential part of maintaining the robustness of our IDS/IPS setup. To validate the configuration, we can use the <code>-T</code> option provided by the Suricata command. This command runs a test to check if the configuration file is valid and all files referenced in the configuration are accessible.</p>
<p>Here is how we can do this.</p>
<p>Suricata Fundamentals</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo suricata -T -c /</span>etc<span class="hljs-regexp">/suricata/</span>suricata.yaml
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">07</span>:<span class="hljs-number">13</span>:<span class="hljs-number">29</span> - &lt;Info&gt; - Running suricata under test mode
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">07</span>:<span class="hljs-number">13</span>:<span class="hljs-number">29</span> - &lt;Notice&gt; - This is Suricata version <span class="hljs-number">6.0</span><span class="hljs-number">.13</span> RELEASE running <span class="hljs-keyword">in</span> SYSTEM mode
<span class="hljs-number">6</span><span class="hljs-regexp">/7/</span><span class="hljs-number">2023</span> -- <span class="hljs-number">07</span>:<span class="hljs-number">13</span>:<span class="hljs-number">29</span> - &lt;Notice&gt; - Configuration provided was successfully loaded. Exiting.
</code></pre>
<h3 id="suricata-documentation">Suricata Documentation</h3>
<p>Suricata is an incredibly versatile tool with extensive functionality. We highly recommend exploring <a href="https://docs.suricata.io/">Suricata&#39;s documentation</a> to gain a deeper understanding of its capabilities.</p>
<h3 id="suricata-key-features">Suricata Key Features</h3>
<p>Key features that bolster Suricata&#39;s effectiveness include:</p>
<ul>
<li>Deep packet inspection and packet capture logging</li>
<li>Anomaly detection and Network Security Monitoring</li>
<li>Intrusion Detection and Prevention, with a hybrid mode available</li>
<li>Lua scripting</li>
<li>Geographic IP identification (GeoIP)</li>
<li>Full IPv4 and IPv6 support</li>
<li>IP reputation</li>
<li>File extraction</li>
<li>Advanced protocol inspection</li>
<li>Multitenancy</li>
</ul>
<p><strong>Note</strong>: Suricata can also be used to detect &quot;non-standard/anomalous&quot; traffic. We can leverage strategies outlined in Suricata&#39;s <a href="https://redmine.openinfosecfoundation.org/projects/suricata/wiki/Protocol\_Anomalies\_Detection">Protocol Anomalies Detection page</a>. This approach enhances our visibility into unusual or non-compliant behavior within our network, thus augmenting our security posture.</p>
<h2 id="suricata-rule-development-part-1">Suricata Rule Development Part 1</h2>
<p>At its core, a rule in Suricata serves as a directive, instructing the engine to actively watch for certain markers in the network traffic. When such specific markers appear, we will receive a notification.</p>
<p>Suricata rules are not exclusively focused on the detection of nefarious activities or potentially harmful traffic. In many instances, rules can be designed to furnish network defenders or blue team members with critical insights or contextual data regarding ongoing network activity.</p>
<p>The specificity or generality of the rules is in our hands. Striking a balance is paramount to, say, identify variations of a certain malware strain while evading false positives.</p>
<p>The development of these rules often leverages crucial information provided by the infosec communities and threat intelligence. However, it&#39;s worth noting that each rule we deploy consumes a portion of the host&#39;s CPU and memory resources. Hence, Suricata provides specific guidelines for writing effective rules.</p>
<h3 id="suricata-rule-anatomy">Suricata Rule Anatomy</h3>
<p>A sample Suricata rule can be found below. Let&#39;s break it down.</p>
<p>Suricata Rule Development Part 1</p>
<pre><code class="lang-shell-session">action protocol from_ip port -&gt; to_ip port (msg:<span class="hljs-string">"Known malicious behavior, possible X malware infection"</span>; <span class="hljs-attribute">content</span>:<span class="hljs-string">"some thing"</span>; <span class="hljs-attribute">content</span>:<span class="hljs-string">"some other thing"</span>; sid:<span class="hljs-number">10000001</span>; rev:<span class="hljs-number">1</span>;)
</code></pre>
<ul>
<li><strong>Header</strong> (<code>action protocol from_ip port -&gt; to_ip port</code> part): The <code>header</code> section of a rule encapsulates the intended action of the rule, along with the protocol where the rule is expected to be applied. Additionally, it includes IP addresses, port information, and an arrow indicating traffic directionality.<ul>
<li><code>action</code> instructs Suricata on what steps to take if the contents match. This could range from generating an alert (<code>alert</code>), logging the traffic without an alert (<code>log</code>), ignoring the packet (<code>pass</code>), dropping the packet in IPS mode (<code>drop</code>), or sending TCP RST packets (<code>reject</code>).</li>
<li><code>protocol</code> can vary, including <code>tcp</code>, <code>udp</code>, <code>icmp</code>, <code>ip</code>, <code>http</code>, <code>tls</code>, <code>smb</code>, or <code>dns</code>.</li>
<li>Traffic directionality is declared using <code>rule host variables</code> (such as <code>$HOME_NET</code>, <code>$EXTERNAL_NET</code>, etc. that we saw inside <code>suricata.yaml</code>) and <code>rule direction</code>. The direction arrow between the two IP-Port pairs informs Suricata about the traffic flow.<ul>
<li>Examples:<ul>
<li>Outbound: <code>$HOME_NET any -&gt; $EXTERNAL_NET 9090</code></li>
<li>Inbound: <code>$EXTERNAL_NET any -&gt; $HOME_NET 8443</code></li>
<li>Bidirectional: <code>$EXTERNAL_NET any &lt;&gt; $HOME_NET any</code></li>
</ul>
</li>
</ul>
</li>
<li><code>Rule ports</code> define the ports at which the traffic for this rule will be evaluated.<ul>
<li>Examples:<ul>
<li><code>alert tcp $HOME_NET any -&gt; $EXTERNAL_NET 9443</code></li>
<li><code>alert tcp $HOME_NET any -&gt; $EXTERNAL_NET $UNCOMMON_PORTS</code><ul>
<li>$UNCOMMON_PORTS can be defined inside <code>suricata.yaml</code></li>
</ul>
</li>
<li><code>alert tcp $HOME_NET any -&gt; $EXTERNAL_NET [8443,8080,7001:7002,!8443]</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><strong>Rule message &amp; content</strong> (<code>(msg:&quot;Known malicious behavior, possible X malware infection&quot;; content:&quot;some thing&quot;; content:&quot;some other thing&quot;;</code> part): The <code>rule message &amp; content</code> section contains the message we wish to be displayed to the analysts or ourselves when an activity we want to be notified about is detected. <code>content</code> are the segments of the traffic that we deem essential for such detections.<ul>
<li><code>Rule message (msg)</code> is an arbitrary text displayed when the rule is triggered. Ideally, the rule messages we create should contain details about malware architecture, family, and action.<ul>
<li><code>flow</code> identifies the originator and responder. Always remember, when crafting rules, to have the engine monitor &quot;established&quot; tcp sessions.<ul>
<li>Examples:<ul>
<li><code>alert tcp any any -&gt; 192.168.1.0/24 22 (msg:&quot;SSH connection attempt&quot;; flow:to_server; sid:1001;)</code></li>
<li><code>alert udp 10.0.0.0/24 any -&gt; any 53 (msg:&quot;DNS query&quot;; flow:from_client; sid:1002;)</code></li>
<li><code>alert tcp $EXTERNAL_NET any -&gt; $HOME_NET 80 (msg:&quot;Potential HTTP-based attack&quot;; flow:established,to_server; sid:1003;)</code></li>
</ul>
</li>
</ul>
</li>
<li><code>dsize</code> matches using the payload size of the packet. It relies on TCP segment length, not the total packet length.<ul>
<li>Example: <code>alert http any any -&gt; any any (msg:&quot;Large HTTP response&quot;; dsize:&gt;10000; content:&quot;HTTP/1.1 200 OK&quot;; sid:2003;)</code></li>
</ul>
</li>
</ul>
</li>
<li><code>Rule content</code> comprises unique values that help identify specific network traffic or activities. Suricata matches these unique content values in packets for detection.<ul>
<li>Example: <code>content:&quot;User-Agent|3a 20|Go-http-client/1.1|0d 0a|Accept-Encoding|3a 20|gzip&quot;;</code><ul>
<li><code>|3a 20|</code>: This represents the hexadecimal representation of the characters &quot;:&quot;, followed by a space character. It is used to match the exact byte sequence in the packet payload.</li>
<li><code>|0d 0a|</code>: This represents the hexadecimal representation of the characters &quot;\r\n&quot;, which signifies the end of a line in HTTP headers.</li>
</ul>
</li>
<li>By using <code>Rule Buffers</code>, we don&#39;t have to search the entire packet for every content match. This saves time and resources. More details can be found here: <a href="https://suricata.readthedocs.io/en/latest/rules/http-keywords.html">https://suricata.readthedocs.io/en/latest/rules/http-keywords.html</a><ul>
<li>Example: <code>alert http any any -&gt; any any (http.accept; content:&quot;image/gif&quot;; sid:1;)</code><ul>
<li><code>http.accept</code>: Sticky buffer to match on the HTTP Accept header. Only contains the header value. The  after the header are not part of the buffer.</li>
</ul>
</li>
</ul>
</li>
<li><code>Rule options</code> act as additional modifiers to aid detection, helping Suricata locate the exact location of contents.<ul>
<li><code>nocase</code> ensures rules are not bypassed through case changes.<ul>
<li>Example: <code>alert tcp any any -&gt; any any (msg:&quot;Detect HTTP traffic with user agent Mozilla&quot;; content:&quot;User-Agent: Mozilla&quot;; nocase; sid:8001;)</code></li>
</ul>
</li>
<li><code>offset</code> informs Suricata about the start position inside the packet for matching.<ul>
<li>Example: <code>alert tcp any any -&gt; any any (msg:&quot;Detect specific protocol command&quot;; content:&quot;|01 02 03|&quot;; offset:0; depth:5; sid:3003;)</code><ul>
<li>This rule triggers an alert when Suricata detects a specific protocol command represented by the byte sequence <code>|01 02 03|</code> in the TCP payload. The <code>offset:0</code> keyword sets the content match to start from the beginning of the payload, and <code>depth:5</code> specifies a length of five bytes to be considered for matching.</li>
</ul>
</li>
</ul>
</li>
<li><code>distance</code> tells Suricata to look for the specified content <code>n</code> bytes relative to the previous match.<ul>
<li>Example: <code>alert tcp any any -&gt; any any (msg:&quot;Detect suspicious URL path&quot;; content:&quot;/admin&quot;; offset:4; depth:10; distance:20; within:50; sid:3001;)</code><ul>
<li>This rule triggers an alert when Suricata detects the string <code>/admin</code> in the TCP payload, starting from the fifth byte (<code>offset:4</code>) and considering a length of ten bytes (<code>depth:10</code>). The <code>distance:20</code> keyword specifies that subsequent matches of <code>/admin</code> should not occur within the next 20 bytes after a previous match. The <code>within:50</code> keyword ensures that the content match occurs within the next 50 bytes after a previous match.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><strong>Rule metadata</strong> (<code>sid:10000001; rev:1;</code> part):<ul>
<li><code>reference</code> provides us with a lead, a trail that takes us back to the original source of information that inspired the creation of the rule.</li>
<li><code>sid</code> (signature ID). The unique quality of this numeric identifier makes it essential for the rule writer to manage and distinguish between rules.</li>
<li><code>revision</code> offers insights into the rule&#39;s version. It serves as an indicator of the evolution of the rule over time, highlighting modifications and enhancements made.</li>
</ul>
</li>
</ul>
<p>Having discussed the crux of Suricata rules, it&#39;s now time to shed light on a powerful tool in rule development: <code>PCRE</code> or <code>Pearl Compatible Regular Expression</code>. Utilizing PCRE can be a game-changer when crafting rules. To employ PCRE, we use the <code>pcre</code> statement, which is then followed by a regular expression. Keep in mind that the PCRE should be encased in leading and trailing forward slashes, with any flags positioned after the last slash.</p>
<p>Also, note that anchors are positioned after and before the encasing slashes, and certain characters demand escaping with a backslash. A piece of advice from the trenches - steer clear from authoring a rule that relies solely on PCRE.</p>
<ul>
<li>Example: <code>alert http any any -&gt; $HOME_NET any (msg: &quot;ATTACK [PTsecurity] Apache Continuum &lt;= v1.4.2 CMD Injection&quot;; content: &quot;POST&quot;; http_method; content: &quot;/continuum/saveInstallation.action&quot;; offset: 0; depth: 34; http_uri; content: &quot;installation.varValue=&quot;; nocase; http_client_body; pcre: !&quot;/^\$?[\sa-z\\_0-9.-]*(\&amp;|$)/iRP&quot;; flow: to_server, established;sid: 10000048; rev: 1;)</code><ul>
<li>Firstly, the rule triggers on HTTP traffic (<code>alert http</code>) from any source and destination to any port on the home network (<code>any any -&gt; $HOME_NET any</code>).</li>
<li>The msg field gives a human-readable description of what the alert is for, namely <code>ATTACK [PTsecurity] Apache Continuum &lt;= v1.4.2 CMD Injection</code>.</li>
<li>Next, the rule checks for the <code>POST</code> string in the HTTP method using the <code>content</code> and <code>http_method</code> keywords. The rule will match if the HTTP method used is a POST request.</li>
<li>The <code>content</code> keyword is then used with <code>http_uri</code> to match the URI <code>/continuum/saveInstallation.action</code>, starting at <code>offset 0</code> and going to a <code>depth</code> of <code>34</code> bytes. This specifies the targeted endpoint, which in this case is the <code>saveInstallation</code> action of the Apache Continuum application.</li>
<li>Following this, another content keyword searches for <code>installation.varValue=</code> in the HTTP client body, case insensitively (<code>nocase</code>). This string may be part of the command injection payload that the attacker is trying to deliver.</li>
<li>Next, we see a <code>pcre</code> keyword, which is used to implement Perl Compatible Regular Expressions.<ul>
<li><code>^</code> marks the start of the line.</li>
<li><code>\$?</code> checks for an optional dollar sign at the start.</li>
<li><code>[\sa-z\\_0-9.-]*</code> matches zero or more (<code>*</code>) of the characters in the set. The set includes:<ul>
<li><code>\s</code> a space</li>
<li><code>a-z</code> any lowercase letter</li>
<li><code>\\</code> a backslash</li>
<li><code>_</code> an underscore</li>
<li><code>0-9</code> any digit</li>
<li><code>.</code> a period</li>
<li><code>-</code> a hyphen</li>
<li><code>(\&amp;|$)</code> checks for either an ampersand or the end of the line.</li>
<li><code>/iRP</code> at the end indicates this is an inverted match (meaning the rule triggers when the match does not occur), case insensitive (<code>i</code>), and relative to the buffer position (<code>RP</code>).</li>
</ul>
</li>
</ul>
</li>
<li>Finally, the <code>flow</code> keyword is used to specify that the rule triggers on <code>established</code>, inbound traffic towards the server.</li>
</ul>
</li>
</ul>
<p>For those who seek to broaden their understanding of Suricata rules and delve deeper into rule development, the following resource serves as a comprehensive guide: <a href="https://docs.suricata.io/en/latest/rules/index.html">https://docs.suricata.io/en/latest/rules/index.html</a>.</p>
<h3 id="ids-ips-rule-development-approaches">IDS/IPS Rule Development Approaches</h3>
<p>When it comes to creating rules for Intrusion Detection Systems (IDS) and Intrusion Prevention Systems (IPS), there&#39;s an art and a science behind it. It requires a comprehensive understanding of network protocols, malware behaviors, system vulnerabilities, and the threat landscape in general.</p>
<p>A key strategy that we employ while crafting these rules involves the detection of specific elements within network traffic that are unique to malware. This is often referred to as signature-based detection, and it&#39;s the classic approach that most IDS/IPS rely on. Signatures can range from simple patterns in packet payloads, such as the detection of a specific command or a distinctive string associated with a particular malware, to complex patterns that match a series of packets or packet characteristics. Signature-based detection is highly effective when dealing with known threats as it can identify these threats with high precision, however, it struggles to detect novel threats for which no signature exists yet.</p>
<p>Another approach focuses on identifying specific behaviors that are characteristic to malware. This is typically referred to as anomaly-based or behavior-based detection. For instance, a certain HTTP response size constantly appearing within a threshold, or a specific beaconing interval might be indicative of a malware communication pattern. Other behaviors can include unusually high volumes of data transfers and uncommon ports being used. The advantage of this approach is its ability to potentially identify zero-day attacks or novel threats that would not be detected by signature-based systems. However, it also tends to have higher false-positive rates due to the dynamic nature of network behaviors.</p>
<p>A third approach that we utilize in crafting IDS/IPS rules is stateful protocol analysis. This technique involves understanding and tracking the state of network protocols and comparing observed behaviors to the expected state transitions of these protocols. By keeping track of the state of each connection, we can identify deviations from expected behavior which might suggest a malicious activity.</p>
<p>Let&#39;s now navigate to the bottom of this section and click on &quot;Click here to spawn the target system!&quot;. Then, let&#39;s RDP into the Target IP using the provided credentials. The vast majority of the commands covered from this point up to end of this section can be replicated inside the target, offering a more comprehensive grasp of the topics presented.</p>
<p>Please wait for approximately 5-6 minutes before initiating a connection using Remote Desktop Protocol (RDP). You may have to try 2-3 times before a successful RDP connection is established!</p>
<p>Suricata Rule Development Part 1</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ xfreerdp /u</span><span class="hljs-symbol">:htb-student</span> /<span class="hljs-symbol">p:</span><span class="hljs-string">'HTB_@cademy_stdnt!'</span> /<span class="hljs-symbol">v:</span>[Target IP] /dynamic-resolution /relax-order-checks +glyph-cache
</code></pre>
<p>Now, we will explore several examples of Suricata rule development to gain a solid understanding of the different approaches we can take and the structure of a rule.</p>
<h3 id="suricata-rule-development-example-1-detecting-powershell-empire">Suricata Rule Development Example 1: Detecting PowerShell Empire</h3>
<p>Suricata Rule Development Part 1</p>
<pre><code class="lang-shell-session">alert http <span class="hljs-variable">$HOME_NET</span> any -&gt; <span class="hljs-variable">$EXTERNAL_NET</span> any (msg:<span class="hljs-string">"ET MALWARE Possible PowerShell Empire Activity Outbound"</span>; flow:established,to_server; <span class="hljs-attribute">content</span>:<span class="hljs-string">"GET"</span>; http_method; <span class="hljs-attribute">content</span>:<span class="hljs-string">"/"</span>; http_uri; depth:<span class="hljs-number">1</span>; pcre:<span class="hljs-string">"/^(?:login\/process|admin\/get|news)\.php$/RU"</span>; <span class="hljs-attribute">content</span>:<span class="hljs-string">"session="</span>; http_cookie; pcre:<span class="hljs-string">"/^(?:[A-Z0-9+/]{4})*(?:[A-Z0-9+/]{2}==|[A-Z0-9+/]{3}=|[A-Z0-9+/]{4})$/CRi"</span>; <span class="hljs-attribute">content</span>:<span class="hljs-string">"Mozilla|2f|5.0|20 28|Windows|20|NT|20|6.1"</span>; http_user_agent; http_start; <span class="hljs-attribute">content</span>:<span class="hljs-string">".php|20|HTTP|2f|1.1|0d 0a|Cookie|3a 20|session="</span>; fast_pattern; http_header_names; <span class="hljs-attribute">content</span>:!<span class="hljs-string">"Referer"</span>; <span class="hljs-attribute">content</span>:!<span class="hljs-string">"Cache"</span>; <span class="hljs-attribute">content</span>:!<span class="hljs-string">"Accept"</span>; sid:<span class="hljs-number">2027512</span>; rev:<span class="hljs-number">1</span>;)
</code></pre>
<p>The Suricata rule above is designed to detect possible outbound activity from <a href="https://github.com/EmpireProject/Empire">PowerShell Empire</a>, a common post-exploitation framework used by attackers. Let&#39;s break down the important parts of this rule to understand its workings.</p>
<ul>
<li><code>alert</code>: This is the rule action, indicating that Suricata should generate an alert whenever the conditions specified in the rule options are met.</li>
<li><code>http</code>: This is the rule protocol. It specifies that the rule applies to HTTP traffic.</li>
<li><code>$HOME_NET any -&gt; $EXTERNAL_NET any</code>: These are the source and destination IP address specifications. The rule will be triggered when HTTP traffic originates from any port (any) on a host within the <code>$HOME_NET</code> (internal network) and is destined to any port (any) on a host in the <code>$EXTERNAL_NET</code> (external network).</li>
<li><code>msg:&quot;ET MALWARE Possible PowerShell Empire Activity Outbound&quot;</code>: This is the message that will be included in the alert to describe what the rule is looking for.</li>
<li><code>flow:established,to_server</code>: This specifies the direction of the traffic. The rule is looking for established connections where data is flowing to the server.</li>
<li><code>content:&quot;GET&quot;; http_method;</code>: This matches the HTTP GET method in the HTTP request.</li>
<li><code>content:&quot;/&quot;; http_uri; depth:1;</code>: This matches the root directory (&quot;/&quot;) in the URI.</li>
<li><code>pcre:&quot;/^(?:login\/process|admin\/get|news)\.php$/RU&quot;;</code>: This Perl Compatible Regular Expression (PCRE) is looking for URIs that end with login/process.php, admin/get.php, or news.php.<ul>
<li><code>PowerShell Empire</code> is an open-source Command and Control (C2) framework. Its agent can be explored via the following repository.<a href="https://github.com/EmpireProject/Empire/blob/master/data/agent/agent.ps1#L78">https://github.com/EmpireProject/Empire/blob/master/data/agent/agent.ps1#L78</a></li>
<li>Examine the <code>psempire.pcap</code> file which is located in the <code>/home/htb-student/pcaps</code> directory of this section&#39;s target using Wireshark to pinpoint the related requests.</li>
</ul>
</li>
<li><code>content:&quot;session=&quot;; http_cookie;</code>: This is looking for the string &quot;session=&quot; in the HTTP cookie.</li>
<li><code>pcre:&quot;/^(?:[A-Z0-9+/]{4})*(?:[A-Z0-9+/]{2}==|[A-Z0-9+/]{3}=|[A-Z0-9+/]{4})$/CRi&quot;;</code>: This PCRE is checking for base64-encoded data in the Cookie.<ul>
<li>A plethora of articles examining <code>PowerShell Empire</code> exist, here is one noting that the cookies utilized by PowerShell Empire adhere to the Base64 encoding standard. <a href="https://www.keysight.com/blogs/tech/nwvs/2021/06/16/empire-c2-networking-into-the-dark-side">https://www.keysight.com/blogs/tech/nwvs/2021/06/16/empire-c2-networking-into-the-dark-side</a></li>
</ul>
</li>
<li><code>content:&quot;Mozilla|2f|5.0|20 28|Windows|20|NT|20|6.1&quot;; http_user_agent; http_start;</code>: This matches a specific User-Agent string that includes &quot;Mozilla/5.0 (Windows NT 6.1&quot;.<ul>
<li><a href="https://github.com/EmpireProject/Empire/blob/master/data/agent/agent.ps1#L78">https://github.com/EmpireProject/Empire/blob/master/data/agent/agent.ps1#L78</a></li>
</ul>
</li>
<li><code>content:&quot;.php|20|HTTP|2f|1.1|0d 0a|Cookie|3a 20|session=&quot;; fast_pattern; http_header_names;</code>: This matches a pattern in the HTTP headers that starts with &quot;.php HTTP/1.1\r\nCookie: session=&quot;.</li>
<li><code>content:!&quot;Referer&quot;; content:!&quot;Cache&quot;; content:!&quot;Accept&quot;;</code>: These are negative content matches. The rule will only trigger if the HTTP headers do not contain &quot;Referer&quot;, &quot;Cache&quot;, and &quot;Accept&quot;.</li>
</ul>
<p>This Suricata rule triggers an alert when it detects an established HTTP GET request from our network to an external network, with a specific pattern in the URI, cookie, and user-agent fields, and excluding certain headers.</p>
<p>The above rule is already incorporated in the <code>local.rules</code> file found in the <code>/home/htb-student</code> directory of this section&#39;s target. To test it, first, you need to uncomment the rule. Then, execute Suricata on the <code>psempire.pcap</code> file, which is located in the <code>/home/htb-student/pcaps</code> directory.</p>
<p>Suricata Rule Development Part 1</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo suricata -r /home/htb-student/pcaps/psempire.pcap -<span class="hljs-keyword">l</span> . -<span class="hljs-keyword">k</span> none
 <span class="hljs-number">15</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">03</span>:<span class="hljs-number">57</span>:<span class="hljs-number">42</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - This <span class="hljs-keyword">is</span> Suricata <span class="hljs-keyword">version</span> <span class="hljs-number">4.0</span>.<span class="hljs-number">0</span>-beta1 RELEASE
<span class="hljs-number">15</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">03</span>:<span class="hljs-number">57</span>:<span class="hljs-number">42</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - <span class="hljs-keyword">all</span> <span class="hljs-number">5</span> packet processing threads, <span class="hljs-number">4</span> management threads initialized, engine started.
<span class="hljs-number">15</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">03</span>:<span class="hljs-number">57</span>:<span class="hljs-number">42</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - Signal Received.  Stopping engine.
<span class="hljs-number">15</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">03</span>:<span class="hljs-number">57</span>:<span class="hljs-number">42</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - Pcap-<span class="hljs-keyword">file</span> module <span class="hljs-keyword">read</span> <span class="hljs-number">511</span> packets, <span class="hljs-number">101523</span> bytes
</code></pre>
<p>Suricata Rule Development Part 1</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ cat fast.log
<span class="hljs-number">11</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2017</span>-<span class="hljs-number">05</span>:<span class="hljs-number">04</span>:<span class="hljs-number">53</span>.<span class="hljs-number">950737</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2027512:1]</span> ET MALWARE Possible PowerShell Empire Activity Outbound <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 3]</span> {TCP} <span class="hljs-number">192.168.56.14:50447</span> -&gt; <span class="hljs-number">51.15.197.127:80</span>
<span class="hljs-number">11</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2017</span>-<span class="hljs-number">05</span>:<span class="hljs-number">04</span>:<span class="hljs-number">01</span>.<span class="hljs-number">308390</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2027512:1]</span> ET MALWARE Possible PowerShell Empire Activity Outbound <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 3]</span> {TCP} <span class="hljs-number">192.168.56.14:50436</span> -&gt; <span class="hljs-number">51.15.197.127:80</span>
<span class="hljs-number">11</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2017</span>-<span class="hljs-number">05</span>:<span class="hljs-number">05</span>:<span class="hljs-number">20</span>.<span class="hljs-number">249515</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2027512:1]</span> ET MALWARE Possible PowerShell Empire Activity Outbound <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 3]</span> {TCP} <span class="hljs-number">192.168.56.14:50452</span> -&gt; <span class="hljs-number">51.15.197.127:80</span>
<span class="hljs-number">11</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2017</span>-<span class="hljs-number">05</span>:<span class="hljs-number">05</span>:<span class="hljs-number">56</span>.<span class="hljs-number">849190</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2027512:1]</span> ET MALWARE Possible PowerShell Empire Activity Outbound <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 3]</span> {TCP} <span class="hljs-number">192.168.56.14:50459</span> -&gt; <span class="hljs-number">51.15.197.127:80</span>
<span class="hljs-number">11</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2017</span>-<span class="hljs-number">05</span>:<span class="hljs-number">06</span>:<span class="hljs-number">02</span>.<span class="hljs-number">062235</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2027512:1]</span> ET MALWARE Possible PowerShell Empire Activity Outbound <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 3]</span> {TCP} <span class="hljs-number">192.168.56.14:50460</span> -&gt; <span class="hljs-number">51.15.197.127:80</span>
<span class="hljs-number">11</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2017</span>-<span class="hljs-number">05</span>:<span class="hljs-number">06</span>:<span class="hljs-number">17</span>.<span class="hljs-number">750895</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2027512:1]</span> ET MALWARE Possible PowerShell Empire Activity Outbound <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 3]</span> {TCP} <span class="hljs-number">192.168.56.14:50463</span> -&gt; <span class="hljs-number">51.15.197.127:80</span>
<span class="hljs-number">11</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2017</span>-<span class="hljs-number">05</span>:<span class="hljs-number">04</span>:<span class="hljs-number">11</span>.<span class="hljs-number">988856</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2027512:1]</span> ET MALWARE Possible PowerShell Empire Activity Outbound <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 3]</span> {TCP} <span class="hljs-number">192.168.56.14:50439</span> -&gt; <span class="hljs-number">51.15.197.127:80</span>
---SNIP---
</code></pre>
<p>The <code>local.rules</code> file contains another rule for detecting <code>PowerShell Empire</code>, located directly below the rule we just examined. Invest some time in scrutinizing both the <code>psempire.pcap</code> file using <code>Wireshark</code> and this newly found rule to comprehend how it works.</p>
<h3 id="suricata-rule-development-example-2-detecting-covenant">Suricata Rule Development Example 2: Detecting Covenant</h3>
<p>Suricata Rule Development Part 1</p>
<pre><code class="lang-shell-session">alert tcp any any -&gt; <span class="hljs-variable">$HOME_NET</span> any (msg:<span class="hljs-string">"detected by body"</span>; <span class="hljs-attribute">content</span>:<span class="hljs-string">"&lt;title&gt;Hello World!&lt;/title&gt;"</span>; detection_filter: track by_src, count <span class="hljs-number">4</span> , seconds <span class="hljs-number">10</span>; priority:<span class="hljs-number">1</span>; sid:<span class="hljs-number">3000011</span>;)
</code></pre>
<p><strong>Rule source</strong>: <a href="https://repositorio-aberto.up.pt/bitstream/10216/142718/2/572020.pdf">Signature-based IDS for Encrypted C2 Traffic Detection - Eduardo Macedo</a></p>
<p>The (inefficient) Suricata rule above is designed to detect certain variations of <a href="https://github.com/cobbr/Covenant">Covenant</a>, another common post-exploitation framework used by attackers. Let&#39;s break down the important parts of this rule to understand its workings.</p>
<ul>
<li><code>alert</code>: This is the rule action. When the conditions in the rule options are met, Suricata will generate an alert.</li>
<li><code>tcp</code>: This is the rule protocol. The rule applies to TCP traffic.</li>
<li><code>any any -&gt; $HOME_NET any</code>: These are the source and destination IP address and port specifications. The rule is watching for TCP traffic that originates from any IP and any port (<code>any any</code>) and is destined for any port (<code>any</code>) on a host in the <code>$HOME_NET</code> (internal network).</li>
<li><code>content:&quot;&lt;title&gt;Hello World!&lt;/title&gt;&quot;;</code>: This instructs Suricata to look for the string <code>&lt;title&gt;Hello World!&lt;/title&gt;</code> in the TCP payload.<ul>
<li><code>Covenant</code> is an open-source Command and Control (C2) framework. Its underpinnings can be explored via the following repository.<a href="https://github.com/cobbr/Covenant/blob/master/Covenant/Data/Profiles/DefaultHttpProfile.yaml#L35">https://github.com/cobbr/Covenant/blob/master/Covenant/Data/Profiles/DefaultHttpProfile.yaml#L35</a></li>
<li>Examine the <code>covenant.pcap</code> file which is located in the <code>/home/htb-student/pcaps</code> directory of this section&#39;s target using Wireshark to pinpoint the related requests.</li>
</ul>
</li>
<li><code>detection_filter: track by_src, count 4, seconds 10;</code>: This is a post-detection filter. It specifies that the rule should track the source IP address (<code>by_src</code>) and will only trigger an alert if this same detection happens at least 4 times (<code>count 4</code>) within a 10-second window (<code>seconds 10</code>).<ul>
<li>Examine the <code>covenant.pcap</code> file which is located in the <code>/home/htb-student/pcaps</code> directory of this section&#39;s target using Wireshark to pinpoint the related requests.</li>
</ul>
</li>
</ul>
<p>This Suricata rule is designed to generate a high-priority alert if it detects at least four instances of TCP traffic within ten seconds that contain the string <code>&lt;title&gt;Hello World!&lt;/title&gt;</code> in the payload, originating from the same source IP and headed towards any host on our internal network.</p>
<p>The above rule is already incorporated in the <code>local.rules</code> file found in the <code>/home/htb-student</code> directory of this section&#39;s target. To test it, first, you need to uncomment the rule. Then, execute Suricata on the <code>covenant.pcap</code> file, which is located in the <code>/home/htb-student/pcaps</code> directory.</p>
<p>Suricata Rule Development Part 1</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo suricata -r /home/htb-student/pcaps/covenant.pcap -<span class="hljs-keyword">l</span> . -<span class="hljs-keyword">k</span> none
<span class="hljs-number">15</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">04</span>:<span class="hljs-number">47</span>:<span class="hljs-number">15</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - This <span class="hljs-keyword">is</span> Suricata <span class="hljs-keyword">version</span> <span class="hljs-number">4.0</span>.<span class="hljs-number">0</span>-beta1 RELEASE
<span class="hljs-number">15</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">04</span>:<span class="hljs-number">47</span>:<span class="hljs-number">15</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - <span class="hljs-keyword">all</span> <span class="hljs-number">5</span> packet processing threads, <span class="hljs-number">4</span> management threads initialized, engine started.
<span class="hljs-number">15</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">04</span>:<span class="hljs-number">47</span>:<span class="hljs-number">16</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - Signal Received.  Stopping engine.
<span class="hljs-number">15</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">04</span>:<span class="hljs-number">47</span>:<span class="hljs-number">16</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - Pcap-<span class="hljs-keyword">file</span> module <span class="hljs-keyword">read</span> <span class="hljs-number">27384</span> packets, <span class="hljs-number">3125549</span> bytes
</code></pre>
<p>Suricata Rule Development Part 1</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ cat fast.log
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">06</span>:<span class="hljs-number">38</span>:<span class="hljs-number">51</span>.<span class="hljs-number">250048</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000011:0]</span> detected by body <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61:50366</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">06</span>:<span class="hljs-number">40</span>:<span class="hljs-number">55</span>.<span class="hljs-number">021993</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000011:0]</span> detected by body <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61:50375</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">06</span>:<span class="hljs-number">36</span>:<span class="hljs-number">21</span>.<span class="hljs-number">280144</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000011:0]</span> detected by body <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61:50358</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">06</span>:<span class="hljs-number">41</span>:<span class="hljs-number">53</span>.<span class="hljs-number">395248</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000011:0]</span> detected by body <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61:50378</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">06</span>:<span class="hljs-number">42</span>:<span class="hljs-number">21</span>.<span class="hljs-number">582624</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000011:0]</span> detected by body <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61:50379</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">06</span>:<span class="hljs-number">41</span>:<span class="hljs-number">25</span>.<span class="hljs-number">215525</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000011:0]</span> detected by body <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61:50377</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">07</span>:<span class="hljs-number">17</span>:<span class="hljs-number">01</span>.<span class="hljs-number">778365</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000011:0]</span> detected by body <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61:50462</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">07</span>:<span class="hljs-number">12</span>:<span class="hljs-number">55</span>.<span class="hljs-number">294094</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000011:0]</span> detected by body <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61:50454</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">07</span>:<span class="hljs-number">14</span>:<span class="hljs-number">27</span>.<span class="hljs-number">846352</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000011:0]</span> detected by body <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61:50457</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">07</span>:<span class="hljs-number">17</span>:<span class="hljs-number">29</span>.<span class="hljs-number">981168</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000011:0]</span> detected by body <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61:50463</span>
---SNIP---
</code></pre>
<p>The <code>local.rules</code> file contains three (3) other rules for detecting <code>Covenant</code>, located directly below the rule we just examined. Invest some time in scrutinizing <a href="https://github.com/cobbr/Covenant/blob/master/Covenant/Data/Profiles/DefaultHttpProfile.yaml">https://github.com/cobbr/Covenant/blob/master/Covenant/Data/Profiles/DefaultHttpProfile.yaml</a>, the <code>covenant.pcap</code> file using <code>Wireshark</code>, and these newly found rule to comprehend how they work. These rules may yield false-positive results, and hence for optimal performance, it&#39;s advisable to integrate them with other detection rules.</p>
<h3 id="suricata-rule-development-example-3-detecting-covenant-using-analytics-">Suricata Rule Development Example 3: Detecting Covenant (Using Analytics)</h3>
<p>Suricata Rule Development Part 1</p>
<pre><code class="lang-shell-session">alert tcp <span class="hljs-variable">$HOME_NET</span> any -&gt; any any (msg:<span class="hljs-string">"detected by size and counter"</span>; dsize:<span class="hljs-number">312</span>; detection_filter: track by_src, count <span class="hljs-number">3</span> , seconds <span class="hljs-number">10</span>; priority:<span class="hljs-number">1</span>; sid:<span class="hljs-number">3000001</span>;)
</code></pre>
<p>The <code>local.rules</code> file also contains the above rule for detecting <code>Covenant</code>. Let&#39;s break down the important parts of this rule to understand its workings.</p>
<ul>
<li><code>dsize:312;</code>: This instructs Suricata to look for TCP traffic with a data payload size of exactly 312 bytes.</li>
<li><code>detection_filter: track by_src, count 3 , seconds 10;</code>: This is a post-detection filter. It says that the rule should keep track of the source IP address (<code>by_src</code>), and it will only trigger an alert if it detects the same rule hit at least 3 times (<code>count 3</code>) within a 10-second window (<code>seconds 10</code>).</li>
</ul>
<p>This Suricata rule is designed to generate a high-priority alert if it detects at least three instances of TCP traffic within ten seconds that each contain a data payload of exactly 312 bytes, all originating from the same source IP within our network and headed anywhere.</p>
<p>The above rule is already incorporated in the <code>local.rules</code> file found in the <code>/home/htb-student</code> directory of this section&#39;s target. To test it, first, you need to uncomment the rule. Then, execute Suricata on the <code>covenant.pcap</code> file, which is located in the <code>/home/htb-student/pcaps</code> directory.</p>
<p>Suricata Rule Development Part 1</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo suricata -r /home/htb-student/pcaps/covenant.pcap -<span class="hljs-keyword">l</span> . -<span class="hljs-keyword">k</span> none
<span class="hljs-number">15</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">05</span>:<span class="hljs-number">29</span>:<span class="hljs-number">19</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - This <span class="hljs-keyword">is</span> Suricata <span class="hljs-keyword">version</span> <span class="hljs-number">4.0</span>.<span class="hljs-number">0</span>-beta1 RELEASE
<span class="hljs-number">15</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">05</span>:<span class="hljs-number">29</span>:<span class="hljs-number">19</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - <span class="hljs-keyword">all</span> <span class="hljs-number">5</span> packet processing threads, <span class="hljs-number">4</span> management threads initialized, engine started.
<span class="hljs-number">15</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">05</span>:<span class="hljs-number">29</span>:<span class="hljs-number">20</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - Signal Received.  Stopping engine.
<span class="hljs-number">15</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">05</span>:<span class="hljs-number">29</span>:<span class="hljs-number">20</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - Pcap-<span class="hljs-keyword">file</span> module <span class="hljs-keyword">read</span> <span class="hljs-number">27384</span> packets, <span class="hljs-number">3125549</span> bytes
</code></pre>
<p>Suricata Rule Development Part 1</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ cat fast.log
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">06</span>:<span class="hljs-number">45</span>:<span class="hljs-number">21</span>.<span class="hljs-number">609212</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000001:0]</span> detected by size and counter <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61</span>:
<span class="hljs-number">50386</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">06</span>:<span class="hljs-number">48</span>:<span class="hljs-number">49</span>.<span class="hljs-number">965761</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000001:0]</span> detected by size and counter <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61</span>:
<span class="hljs-number">50395</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">06</span>:<span class="hljs-number">42</span>:<span class="hljs-number">49</span>.<span class="hljs-number">682887</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000001:0]</span> detected by size and counter <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61</span>:
<span class="hljs-number">50380</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">06</span>:<span class="hljs-number">49</span>:<span class="hljs-number">20</span>.<span class="hljs-number">143398</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000001:0]</span> detected by size and counter <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61</span>:
<span class="hljs-number">50396</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">06</span>:<span class="hljs-number">50</span>:<span class="hljs-number">49</span>.<span class="hljs-number">706170</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000001:0]</span> detected by size and counter <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61</span>:
<span class="hljs-number">50400</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">06</span>:<span class="hljs-number">51</span>:<span class="hljs-number">21</span>.<span class="hljs-number">905950</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000001:0]</span> detected by size and counter <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61</span>:
<span class="hljs-number">50401</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">06</span>:<span class="hljs-number">50</span>:<span class="hljs-number">18</span>.<span class="hljs-number">527587</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000001:0]</span> detected by size and counter <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61</span>:
<span class="hljs-number">50399</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">06</span>:<span class="hljs-number">52</span>:<span class="hljs-number">52</span>.<span class="hljs-number">484676</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000001:0]</span> detected by size and counter <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61</span>:
<span class="hljs-number">50406</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">06</span>:<span class="hljs-number">51</span>:<span class="hljs-number">51</span>.<span class="hljs-number">090923</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000001:0]</span> detected by size and counter <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61</span>:
<span class="hljs-number">50404</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">06</span>:<span class="hljs-number">55</span>:<span class="hljs-number">56</span>.<span class="hljs-number">650678</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000001:0]</span> detected by size and counter <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61</span>:
<span class="hljs-number">50413</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">06</span>:<span class="hljs-number">53</span>:<span class="hljs-number">22</span>.<span class="hljs-number">680676</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000001:0]</span> detected by size and counter <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61</span>:
<span class="hljs-number">50407</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">06</span>:<span class="hljs-number">54</span>:<span class="hljs-number">25</span>.<span class="hljs-number">067327</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000001:0]</span> detected by size and counter <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61</span>:
<span class="hljs-number">50409</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">06</span>:<span class="hljs-number">54</span>:<span class="hljs-number">55</span>.<span class="hljs-number">275951</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000001:0]</span> detected by size and counter <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61</span>:
<span class="hljs-number">50410</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">06</span>:<span class="hljs-number">57</span>:<span class="hljs-number">25</span>.<span class="hljs-number">201284</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000001:0]</span> detected by size and counter <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61</span>:
<span class="hljs-number">50416</span>
<span class="hljs-number">01</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">06</span>:<span class="hljs-number">57</span>:<span class="hljs-number">53</span>.<span class="hljs-number">387489</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:3000001:0]</span> detected by size and counter <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 1]</span> {TCP} <span class="hljs-number">157.230.93.100:80</span> -&gt; <span class="hljs-number">10.0.0.61</span>:
<span class="hljs-number">50417</span>
---SNIP---
</code></pre>
<p>Invest some time in scrutinizing both the <code>covenant.pcap</code> file using <code>Wireshark</code> and this newly found rule to comprehend how it works.</p>
<h3 id="suricata-rule-development-example-4-detecting-sliver">Suricata Rule Development Example 4: Detecting Sliver</h3>
<p>Suricata Rule Development Part 1</p>
<pre><code class="lang-shell-session">alert tcp any any -&gt; any any (msg:<span class="hljs-string">"Sliver C2 Implant Detected"</span>; content:<span class="hljs-string">"<span class="hljs-keyword">POST</span>"</span>; pcre:<span class="hljs-string">"/\/(php|api|upload|actions|rest|v1|oauth2callback|authenticate|oauth2|oauth|auth|database|db|namespaces)(.*?)((login|signin|api|samples|rpc|index|admin|register|sign-up)\.php)\?[a-z_]{1,2}=[a-z0-9]{1,10}/i"</span>; sid:<span class="hljs-number">1000007</span>; rev:<span class="hljs-number">1</span>;)
</code></pre>
<p><strong>Rule source</strong>: <a href="https://www.bilibili.com/read/cv19510951/">https://www.bilibili.com/read/cv19510951/</a></p>
<p>The Suricata rule above is designed to detect certain variations of <a href="https://github.com/BishopFox/sliver">Sliver</a>, yet another common post-exploitation framework used by attackers. Let&#39;s break down the important parts of this rule to understand its workings.</p>
<ul>
<li><code>content:&quot;POST&quot;;</code>: This option instructs Suricata to look for TCP traffic containing the string &quot;POST&quot;.</li>
<li><code>pcre:&quot;/\/(php|api|upload|actions|rest|v1|oauth2callback|authenticate|oauth2|oauth|auth|database|db|namespaces)(.*?)((login|signin|api|samples|rpc|index|admin|register|sign-up)\.php)\?[a-z_]{1,2}=[a-z0-9]{1,10}/i&quot;;</code>: This regular expression is utilized to identify specific URI patterns in the traffic. It will match URIs that contain particular directory names followed by file names ending with a PHP extension.<ul>
<li><code>Sliver</code> is an open-source Command and Control (C2) framework. Its underpinnings can be explored via the following repository.<a href="https://github.com/BishopFox/sliver/blob/master/server/configs/http-c2.go#L294">https://github.com/BishopFox/sliver/blob/master/server/configs/http-c2.go#L294</a></li>
<li>Examine the <code>sliver.pcap</code> file which is located in the <code>/home/htb-student/pcaps</code> directory of this section&#39;s target using Wireshark to pinpoint the related requests.</li>
</ul>
</li>
</ul>
<p>The above rule is already incorporated in the <code>local.rules</code> file found in the <code>/home/htb-student</code> directory of this section&#39;s target. To test it, first, you need to uncomment the rule. Then, execute Suricata on the <code>sliver.pcap</code> file, which is located in the <code>/home/htb-student/pcaps</code> directory.</p>
<p>Suricata Rule Development Part 1</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo suricata -r /home/htb-student/pcaps/sliver.pcap -<span class="hljs-keyword">l</span> . -<span class="hljs-keyword">k</span> none
<span class="hljs-number">16</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">02</span>:<span class="hljs-number">27</span>:<span class="hljs-number">50</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - This <span class="hljs-keyword">is</span> Suricata <span class="hljs-keyword">version</span> <span class="hljs-number">4.0</span>.<span class="hljs-number">0</span>-beta1 RELEASE
<span class="hljs-number">16</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">02</span>:<span class="hljs-number">27</span>:<span class="hljs-number">50</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - <span class="hljs-keyword">all</span> <span class="hljs-number">5</span> packet processing threads, <span class="hljs-number">4</span> management threads initialized, engine started.
<span class="hljs-number">16</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">02</span>:<span class="hljs-number">27</span>:<span class="hljs-number">50</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - Signal Received.  Stopping engine.
<span class="hljs-number">16</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">02</span>:<span class="hljs-number">27</span>:<span class="hljs-number">50</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - Pcap-<span class="hljs-keyword">file</span> module <span class="hljs-keyword">read</span> <span class="hljs-number">36</span> packets, <span class="hljs-number">18851</span> bytes
</code></pre>
<p>Suricata Rule Development Part 1</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ cat fast.log
<span class="hljs-number">01</span>/<span class="hljs-number">23</span>/<span class="hljs-number">2023</span>-<span class="hljs-number">15</span>:<span class="hljs-number">14</span>:<span class="hljs-number">46</span>.<span class="hljs-number">988537</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:1000002:1]</span> Sliver C2 Implant Detected - POST <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 3]</span> {TCP} <span class="hljs-number">192.168.4.90:50681</span> -&gt; <span class="hljs-number">192.168.4.85:80</span>
<span class="hljs-number">01</span>/<span class="hljs-number">23</span>/<span class="hljs-number">2023</span>-<span class="hljs-number">15</span>:<span class="hljs-number">14</span>:<span class="hljs-number">47</span>.<span class="hljs-number">321224</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:1000002:1]</span> Sliver C2 Implant Detected - POST <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 3]</span> {TCP} <span class="hljs-number">192.168.4.90:50684</span> -&gt; <span class="hljs-number">192.168.4.85:80</span>
<span class="hljs-number">01</span>/<span class="hljs-number">23</span>/<span class="hljs-number">2023</span>-<span class="hljs-number">15</span>:<span class="hljs-number">14</span>:<span class="hljs-number">48</span>.<span class="hljs-number">074797</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:1000002:1]</span> Sliver C2 Implant Detected - POST <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 3]</span> {TCP} <span class="hljs-number">192.168.4.90:50687</span> -&gt; <span class="hljs-number">192.168.4.85:80</span>
</code></pre>
<p>The <code>local.rules</code> file contains another rule for detecting <code>Sliver</code>, located directly below the rule we just examined.</p>
<p>Suricata Rule Development Part 1</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">alert</span> <span class="hljs-selector-tag">tcp</span> <span class="hljs-selector-tag">any</span> <span class="hljs-selector-tag">any</span> <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">any</span> <span class="hljs-selector-tag">any</span> (<span class="hljs-attribute">msg</span>:<span class="hljs-string">"Sliver C2 Implant Detected - Cookie"</span>; <span class="hljs-attribute">content</span>:<span class="hljs-string">"Set-Cookie"</span>; <span class="hljs-attribute">pcre</span>:<span class="hljs-string">"/(PHPSESSID|SID|SSID|APISID|csrf-state|AWSALBCORS)\=[a-z0-9]{32}\;/"</span>; <span class="hljs-attribute">sid</span>:<span class="hljs-number">1000003</span>; <span class="hljs-attribute">rev</span>:<span class="hljs-number">1</span>;)
</code></pre>
<p>Let&#39;s break down the important parts of this rule to understand its workings.</p>
<ul>
<li><code>content:&quot;Set-Cookie&quot;;</code>: This option instructs Suricata to look for TCP traffic containing the string <code>Set-Cookie</code>.</li>
<li><code>pcre:&quot;/(PHPSESSID|SID|SSID|APISID|csrf-state|AWSALBCORS)\=[a-z0-9]{32}\;/&quot;;</code>: This is a regular expression used to identify specific cookie-setting patterns in the traffic. It matches the <code>Set-Cookie</code> header when it&#39;s setting specific cookie names (PHPSESSID, SID, SSID, APISID, csrf-state, AWSALBCORS) with a value that&#39;s a 32-character alphanumeric string.</li>
</ul>
<p>Invest some time in scrutinizing the <code>sliver.pcap</code> file using <code>Wireshark</code> to identify the related requests.</p>
<h2 id="suricata-rule-development-part-2-encrypted-traffic-">Suricata Rule Development Part 2 (Encrypted Traffic)</h2>
<p>In the ever-evolving landscape of network security, we&#39;re often faced with a significant challenge: encrypted traffic. Encrypted traffic can pose significant obstacles when it comes to effectively analyzing traffic and developing reliable Intrusion Detection System (IDS) and Intrusion Prevention System (IPS) rules.</p>
<p>There are still several aspects we can leverage to detect potential security threats. Specifically, we can turn our attention to the elements within SSL/TLS certificates and the JA3 fingerprint.</p>
<p>SSL/TLS certificates, exchanged during the initial handshake of an SSL/TLS connection, contain a plethora of details that remain unencrypted. These details can include the issuer, the issue date, the expiry date, and the subject (containing information about who the certificate is for and the domain name). Suspicious or malicious domains might utilize SSL/TLS certificates with anomalous or unique characteristics. Recognizing these anomalies in SSL/TLS certificates can be a stepping stone to crafting effective Suricata rules.</p>
<p>Further, we can also utilize the <a href="https://github.com/salesforce/ja3">JA3</a> hash — a fingerprinting method that provides a unique representation for each SSL/TLS client. The JA3 hash combines details from the client hello packet during the SSL/TLS handshake, creating a digest that could be unique for specific malware families or suspicious software. Again, these hashes can be a powerful tool in formulating detection rules for encrypted traffic.</p>
<p>Let&#39;s now navigate to the bottom of this section and click on &quot;Click here to spawn the target system!&quot;. Then, let&#39;s SSH into the Target IP using the provided credentials. The vast majority of the commands covered from this point up to end of this section can be replicated inside the target, offering a more comprehensive grasp of the topics presented.</p>
<h3 id="suricata-rule-development-example-5-detecting-dridex-tls-encrypted-">Suricata Rule Development Example 5: Detecting Dridex (TLS Encrypted)</h3>
<p>Suricata Rule Development Part 2 (Encrypted Traffic)</p>
<pre><code class="lang-shell-session">alert tls $EXTERNAL<span class="hljs-emphasis">_NET any -&gt; $HOME_</span>NET any (msg:"ET MALWARE ABUSE.CH SSL Blacklist Malicious SSL certificate detected (Dridex)"; flow:established,from<span class="hljs-emphasis">_server; content:"|16|"; content:"|0b|"; within:8; byte_</span>test:3,<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">,1200,0,relative;</span> <span class="hljs-attr">content:</span>"|<span class="hljs-attr">03</span> <span class="hljs-attr">02</span> <span class="hljs-attr">01</span> <span class="hljs-attr">02</span> <span class="hljs-attr">02</span> <span class="hljs-attr">09</span> <span class="hljs-attr">00</span>|"; <span class="hljs-attr">fast_pattern</span>; <span class="hljs-attr">content:</span>"|<span class="hljs-attr">30</span> <span class="hljs-attr">09</span> <span class="hljs-attr">06</span> <span class="hljs-attr">03</span> <span class="hljs-attr">55</span> <span class="hljs-attr">04</span> <span class="hljs-attr">06</span> <span class="hljs-attr">13</span> <span class="hljs-attr">02</span>|"; <span class="hljs-attr">distance:0</span>; <span class="hljs-attr">pcre:</span>"/^[<span class="hljs-attr">A-Z</span>]{<span class="hljs-attr">2</span>}/<span class="hljs-attr">R</span>"; <span class="hljs-attr">content:</span>"|<span class="hljs-attr">55</span> <span class="hljs-attr">04</span> <span class="hljs-attr">07</span>|"; <span class="hljs-attr">distance:0</span>; <span class="hljs-attr">content:</span>"|<span class="hljs-attr">55</span> <span class="hljs-attr">04</span> <span class="hljs-attr">0a</span>|"; <span class="hljs-attr">distance:0</span>; <span class="hljs-attr">pcre:</span>"/^<span class="hljs-attr">.</span>{<span class="hljs-attr">2</span>}[<span class="hljs-attr">A-Z</span>][<span class="hljs-attr">a-z</span>]{<span class="hljs-attr">3</span>,}\<span class="hljs-attr">s</span>(?<span class="hljs-attr">:</span>[<span class="hljs-attr">A-Z</span>][<span class="hljs-attr">a-z</span>]{<span class="hljs-attr">3</span>,}\<span class="hljs-attr">s</span>)?(?<span class="hljs-attr">:</span>[<span class="hljs-attr">A-Z</span>](?<span class="hljs-attr">:</span>[<span class="hljs-attr">A-Za-z</span>]{<span class="hljs-attr">0</span>,<span class="hljs-attr">4</span>}?[<span class="hljs-attr">A-Z</span>]|(?<span class="hljs-attr">:</span>\<span class="hljs-attr">.</span>[<span class="hljs-attr">A-Za-z</span>]){<span class="hljs-attr">1</span>,<span class="hljs-attr">3</span>})|[<span class="hljs-attr">A-Z</span>]?[<span class="hljs-attr">a-z</span>]+|[<span class="hljs-attr">a-z</span>](?<span class="hljs-attr">:</span>\<span class="hljs-attr">.</span>[<span class="hljs-attr">A-Za-z</span>]){<span class="hljs-attr">1</span>,<span class="hljs-attr">3</span>})\<span class="hljs-attr">.</span>?[<span class="hljs-attr">01</span>]/<span class="hljs-attr">Rs</span>"; <span class="hljs-attr">content:</span>"|<span class="hljs-attr">55</span> <span class="hljs-attr">04</span> <span class="hljs-attr">03</span>|"; <span class="hljs-attr">distance:0</span>; <span class="hljs-attr">byte_test:1</span>,&gt;</span></span>,13,1,relative; content:!"www."; distance:2; within:4; pcre:"/^.{2}(?P<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">CN</span>&gt;</span></span>(?:(?:\d?[<span class="hljs-string">A-Z</span>]?|[<span class="hljs-string">A-Z</span>]?\d?)(?:[<span class="hljs-string">a-z</span>]{3,20}|[<span class="hljs-string">a-z</span>]{3,6}[<span class="hljs-string">0-9_</span>][<span class="hljs-symbol">a-z</span>]{3,6})\.){0,2}?(?:\d?[<span class="hljs-string">A-Z</span>]?|[<span class="hljs-string">A-Z</span>]?\d?)[<span class="hljs-string">a-z</span>]{3,}(?:[<span class="hljs-string">0-9_-</span>][<span class="hljs-symbol">a-z</span>]{3,})?\.(?!com|org|net|tv)[a-z]{2,9})[01].*?(?P=CN)[01]/Rs"; content:!"|2a 86 48 86 f7 0d 01 09 01|"; content:!"GoDaddy"; sid:2023476; rev:5;)
</code></pre>
<p>The rule above triggers an alert upon detecting a TLS session from the external network to the home network, where the payload of the session contains specific byte patterns and meets several conditions. These patterns and conditions correspond to SSL certificates that have been linked to certain variations of the Dridex trojan, as referenced by the SSL blacklist on <code>abuse.ch</code>.</p>
<p>No need to understand the rule in its entirety, but let&#39;s break down the important parts of it.</p>
<ul>
<li><code>content:&quot;|16|&quot;; content:&quot;|0b|&quot;; within:8;</code>: The rule looks for the hex values 16 and 0b within the first 8 bytes of the payload. These represent the handshake message (0x16) and the certificate type (0x0b) in the TLS record.</li>
<li><code>content:&quot;|03 02 01 02 02 09 00|&quot;; fast_pattern;</code>: The rule looks for this specific pattern of bytes in the packet, which may be characteristic of the certificates used by Dridex.</li>
<li><code>content:&quot;|30 09 06 03 55 04 06 13 02|&quot;; distance:0; pcre:&quot;/^[A-Z]{2}/R&quot;</code>;: This checks for the &#39;countryName&#39; field in the certificate&#39;s subject. The content match here corresponds to an ASN.1 sequence specifying an attribute type and value for &#39;countryName&#39; (OID 2.5.4.6). The following PCRE checks that the value for &#39;countryName&#39; begins with two uppercase letters, which is a standard format for country codes.</li>
<li><code>content:&quot;|55 04 07|&quot;; distance:0;</code>: This checks for the &#39;localityName&#39; field in the certificate&#39;s subject (OID 2.5.4.7).</li>
<li><code>content:&quot;|55 04 0a|&quot;; distance:0;</code>: This checks for the <code>organizationName</code> field in the certificate&#39;s subject (OID 2.5.4.10).</li>
<li><code>content:&quot;|55 04 03|&quot;; distance:0; byte_test:1,&gt;,13,1,relative;</code>: This checks for the <code>commonName</code> field in the certificate&#39;s subject (OID 2.5.4.3). The following byte_test checks that the length of the <code>commonName</code> field is more than 13.</li>
<li>Please also give this very interesting <a href="https://unit42.paloaltonetworks.com/wireshark-tutorial-dridex-infection-traffic/">resource on Dridex SSL certificates</a> a look.</li>
</ul>
<p>The mentioned OIDs (Object Identifiers) are part of the X.509 standard for PKI and are used to uniquely identify the types of fields contained within certificates.</p>
<p>The above rule is already incorporated in the <code>local.rules</code> file found in the <code>/home/htb-student</code> directory of this section&#39;s target. To test it, first, you need to uncomment the rule. Then, execute Suricata on the <code>dridex.pcap</code> file, which is located in the <code>/home/htb-student/pcaps</code> directory.</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo suricata -r /home/htb-student/pcaps/dridex.pcap -<span class="hljs-keyword">l</span> . -<span class="hljs-keyword">k</span> none
<span class="hljs-number">15</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">20</span>:<span class="hljs-number">34</span>:<span class="hljs-number">11</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - This <span class="hljs-keyword">is</span> Suricata <span class="hljs-keyword">version</span> <span class="hljs-number">6.0</span>.<span class="hljs-number">13</span> RELEASE running in USER <span class="hljs-keyword">mode</span>
<span class="hljs-number">15</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">20</span>:<span class="hljs-number">34</span>:<span class="hljs-number">11</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - <span class="hljs-keyword">all</span> <span class="hljs-number">3</span> packet processing threads, <span class="hljs-number">4</span> management threads initialized, engine started.
<span class="hljs-number">15</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">20</span>:<span class="hljs-number">34</span>:<span class="hljs-number">11</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - Signal Received.  Stopping engine.
<span class="hljs-number">15</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">20</span>:<span class="hljs-number">34</span>:<span class="hljs-number">11</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - Pcap-<span class="hljs-keyword">file</span> module <span class="hljs-keyword">read</span> <span class="hljs-number">1</span> <span class="hljs-keyword">files</span>, <span class="hljs-number">3683</span> packets, <span class="hljs-number">3276706</span> bytes
</code></pre>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ cat fast.log
<span class="hljs-number">07</span>/<span class="hljs-number">09</span>/<span class="hljs-number">2019</span>-<span class="hljs-number">18</span>:<span class="hljs-number">26</span>:<span class="hljs-number">31</span>.<span class="hljs-number">480302</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2023476:5]</span> ET MALWARE ABUSE.CH SSL Blacklist Malicious SSL certificate detected (Dridex) <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[P             riority: 3]</span> {TCP} <span class="hljs-number">188.166.156.241:443</span> -&gt; <span class="hljs-number">10.7.9.101:49206</span>
<span class="hljs-number">07</span>/<span class="hljs-number">09</span>/<span class="hljs-number">2019</span>-<span class="hljs-number">18</span>:<span class="hljs-number">26</span>:<span class="hljs-number">33</span>.<span class="hljs-number">937036</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2023476:5]</span> ET MALWARE ABUSE.CH SSL Blacklist Malicious SSL certificate detected (Dridex) <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[P             riority: 3]</span> {TCP} <span class="hljs-number">188.166.156.241:443</span> -&gt; <span class="hljs-number">10.7.9.101:49207</span>
<span class="hljs-number">07</span>/<span class="hljs-number">09</span>/<span class="hljs-number">2019</span>-<span class="hljs-number">18</span>:<span class="hljs-number">26</span>:<span class="hljs-number">39</span>.<span class="hljs-number">373287</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2023476:5]</span> ET MALWARE ABUSE.CH SSL Blacklist Malicious SSL certificate detected (Dridex) <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[P             riority: 3]</span> {TCP} <span class="hljs-number">188.166.156.241:443</span> -&gt; <span class="hljs-number">10.7.9.101:49208</span>
<span class="hljs-number">07</span>/<span class="hljs-number">09</span>/<span class="hljs-number">2019</span>-<span class="hljs-number">18</span>:<span class="hljs-number">26</span>:<span class="hljs-number">29</span>.<span class="hljs-number">628847</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2023476:5]</span> ET MALWARE ABUSE.CH SSL Blacklist Malicious SSL certificate detected (Dridex) <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[P             riority: 3]</span> {TCP} <span class="hljs-number">188.166.156.241:443</span> -&gt; <span class="hljs-number">10.7.9.101:49205</span>
<span class="hljs-number">07</span>/<span class="hljs-number">09</span>/<span class="hljs-number">2019</span>-<span class="hljs-number">18</span>:<span class="hljs-number">30</span>:<span class="hljs-number">08</span>.<span class="hljs-number">787378</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:2023476:5]</span> ET MALWARE ABUSE.CH SSL Blacklist Malicious SSL certificate detected (Dridex) <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[P             riority: 3]</span> {TCP} <span class="hljs-number">72.205.170.179:443</span> -&gt; <span class="hljs-number">10.7.9.101:49212</span>
---SNIP---
</code></pre>
<h3 id="suricata-rule-development-example-6-detecting-sliver-tls-encrypted-">Suricata Rule Development Example 6: Detecting Sliver (TLS Encrypted)</h3>
<p>Suricata Rule Development Part 2 (Encrypted Traffic)</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">alert</span> <span class="hljs-selector-tag">tls</span> <span class="hljs-selector-tag">any</span> <span class="hljs-selector-tag">any</span> <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">any</span> <span class="hljs-selector-tag">any</span> (<span class="hljs-attribute">msg</span>:<span class="hljs-string">"Sliver C2 SSL"</span>; ja3.hash; <span class="hljs-attribute">content</span>:<span class="hljs-string">"473cd7cb9faa642487833865d516e578"</span>; <span class="hljs-attribute">sid</span>:<span class="hljs-number">1002</span>; <span class="hljs-attribute">rev</span>:<span class="hljs-number">1</span>;)
</code></pre>
<p>The Suricata rule above is designed to detect certain variations of <a href="https://github.com/BishopFox/sliver">Sliver</a> whenever it identifies a TLS connection with a specific JA3 hash.</p>
<p>A PCAP file named <code>sliverenc.pcap</code> containing encrypted Sliver traffic is located in the <code>/home/htb-student/pcaps</code> directory of this section&#39;s target.</p>
<p>The JA3 hash can be calculated as follows.</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ja3 -a --json /home/htb-student/pcaps/sliverenc.pcap
[
    {
        "destination_ip": "<span class="hljs-number">23.152.0.91</span>",
        "destination_port": <span class="hljs-number">443</span>,
        "ja3": "<span class="hljs-number">771,49195</span>-<span class="hljs-number">49199-49196</span>-<span class="hljs-number">49200-52393</span>-<span class="hljs-number">52392-49161</span>-<span class="hljs-number">49171-49162</span>-<span class="hljs-number">49172-156-157</span>-<span class="hljs-number">47-53-49170</span>-<span class="hljs-number">10</span>-<span class="hljs-number">4865-4866</span>-<span class="hljs-number">4867,0-5</span>-<span class="hljs-number">10</span>-<span class="hljs-number">11-13-65281</span>-<span class="hljs-number">18-43-51,29</span>-<span class="hljs-number">23-24-25,0</span>",
        "ja3_digest": "<span class="hljs-number">473</span>cd7cb9faa642487833865d<span class="hljs-number">516e578</span>",
        "source_ip": "<span class="hljs-number">10.10.20.101</span>",
        "source_port": <span class="hljs-number">53222</span>,
        "timestamp": <span class="hljs-number">1634749464</span>.<span class="hljs-number">600896</span>
    },
    {
        "destination_ip": "<span class="hljs-number">23.152.0.91</span>",
        "destination_port": <span class="hljs-number">443</span>,
        "ja3": "<span class="hljs-number">771,49195</span>-<span class="hljs-number">49199-49196</span>-<span class="hljs-number">49200-52393</span>-<span class="hljs-number">52392-49161</span>-<span class="hljs-number">49171-49162</span>-<span class="hljs-number">49172-156-157</span>-<span class="hljs-number">47-53-49170</span>-<span class="hljs-number">10</span>-<span class="hljs-number">4865-4866</span>-<span class="hljs-number">4867,0-5</span>-<span class="hljs-number">10</span>-<span class="hljs-number">11-13-65281</span>-<span class="hljs-number">18-43-51,29</span>-<span class="hljs-number">23-24-25,0</span>",
        "ja3_digest": "<span class="hljs-number">473</span>cd7cb9faa642487833865d<span class="hljs-number">516e578</span>",
        "source_ip": "<span class="hljs-number">10.10.20.101</span>",
        "source_port": <span class="hljs-number">53225</span>,
        "timestamp": <span class="hljs-number">1634749465</span>.<span class="hljs-number">069819</span>
    },
    {
        "destination_ip": "<span class="hljs-number">23.152.0.91</span>",
        "destination_port": <span class="hljs-number">443</span>,
        "ja3": "<span class="hljs-number">771,49195</span>-<span class="hljs-number">49199-49196</span>-<span class="hljs-number">49200-52393</span>-<span class="hljs-number">52392-49161</span>-<span class="hljs-number">49171-49162</span>-<span class="hljs-number">49172-156-157</span>-<span class="hljs-number">47-53-49170</span>-<span class="hljs-number">10</span>-<span class="hljs-number">4865-4866</span>-<span class="hljs-number">4867,0-5</span>-<span class="hljs-number">10</span>-<span class="hljs-number">11-13-65281</span>-<span class="hljs-number">18-43-51,29</span>-<span class="hljs-number">23-24-25,0</span>",
        "ja3_digest": "<span class="hljs-number">473</span>cd7cb9faa642487833865d<span class="hljs-number">516e578</span>",
        "source_ip": "<span class="hljs-number">10.10.20.101</span>",
        "source_port": <span class="hljs-number">53229</span>,
        "timestamp": <span class="hljs-number">1634749585</span>.<span class="hljs-number">240773</span>
    },
---SNIP---
</code></pre>
<p>The above rule is already incorporated in the <code>local.rules</code> file found in the <code>/home/htb-student</code> directory of this section&#39;s target. To test it, first, you need to uncomment the rule. Then, execute Suricata on the <code>sliverenc.pcap</code> file, which is located in the <code>/home/htb-student/pcaps</code> directory.</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo suricata -r /home/htb-student/pcaps/sliverenc.pcap -<span class="hljs-keyword">l</span> . -<span class="hljs-keyword">k</span> none
<span class="hljs-number">15</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">22</span>:<span class="hljs-number">30</span>:<span class="hljs-number">37</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - This <span class="hljs-keyword">is</span> Suricata <span class="hljs-keyword">version</span> <span class="hljs-number">6.0</span>.<span class="hljs-number">13</span> RELEASE running in USER <span class="hljs-keyword">mode</span>
<span class="hljs-number">15</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">22</span>:<span class="hljs-number">30</span>:<span class="hljs-number">37</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - <span class="hljs-keyword">all</span> <span class="hljs-number">3</span> packet processing threads, <span class="hljs-number">4</span> management threads initialized, engine started.
<span class="hljs-number">15</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">22</span>:<span class="hljs-number">30</span>:<span class="hljs-number">37</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - Signal Received.  Stopping engine.
<span class="hljs-number">15</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2023</span> -- <span class="hljs-number">22</span>:<span class="hljs-number">30</span>:<span class="hljs-number">37</span> - <span class="hljs-symbol">&lt;Notice&gt;</span> - Pcap-<span class="hljs-keyword">file</span> module <span class="hljs-keyword">read</span> <span class="hljs-number">1</span> <span class="hljs-keyword">files</span>, <span class="hljs-number">15547</span> packets, <span class="hljs-number">11904606</span> bytes
</code></pre>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ cat fast.log
<span class="hljs-number">10</span>/<span class="hljs-number">20</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">17</span>:<span class="hljs-number">04</span>:<span class="hljs-number">25</span>.<span class="hljs-number">166658</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:1002:1]</span> Sliver C2 SSL <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 3]</span> {TCP} <span class="hljs-number">10.10.20.101:53225</span> -&gt; <span class="hljs-number">23.152.0.91:443</span>
<span class="hljs-number">10</span>/<span class="hljs-number">20</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">17</span>:<span class="hljs-number">07</span>:<span class="hljs-number">25</span>.<span class="hljs-number">315183</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:1002:1]</span> Sliver C2 SSL <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 3]</span> {TCP} <span class="hljs-number">10.10.20.101:53231</span> -&gt; <span class="hljs-number">23.152.0.91:443</span>
<span class="hljs-number">10</span>/<span class="hljs-number">20</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">17</span>:<span class="hljs-number">04</span>:<span class="hljs-number">24</span>.<span class="hljs-number">700690</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:1002:1]</span> Sliver C2 SSL <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 3]</span> {TCP} <span class="hljs-number">10.10.20.101:53222</span> -&gt; <span class="hljs-number">23.152.0.91:443</span>
<span class="hljs-number">10</span>/<span class="hljs-number">20</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">17</span>:<span class="hljs-number">06</span>:<span class="hljs-number">25</span>.<span class="hljs-number">328173</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:1002:1]</span> Sliver C2 SSL <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 3]</span> {TCP} <span class="hljs-number">10.10.20.101:53229</span> -&gt; <span class="hljs-number">23.152.0.91:443</span>
<span class="hljs-number">10</span>/<span class="hljs-number">20</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">17</span>:<span class="hljs-number">10</span>:<span class="hljs-number">25</span>.<span class="hljs-number">311929</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:1002:1]</span> Sliver C2 SSL <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 3]</span> {TCP} <span class="hljs-number">10.10.20.101:53234</span> -&gt; <span class="hljs-number">23.152.0.91:443</span>
<span class="hljs-number">10</span>/<span class="hljs-number">20</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">17</span>:<span class="hljs-number">08</span>:<span class="hljs-number">25</span>.<span class="hljs-number">312485</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:1002:1]</span> Sliver C2 SSL <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 3]</span> {TCP} <span class="hljs-number">10.10.20.101:53232</span> -&gt; <span class="hljs-number">23.152.0.91:443</span>
<span class="hljs-number">10</span>/<span class="hljs-number">20</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">17</span>:<span class="hljs-number">09</span>:<span class="hljs-number">25</span>.<span class="hljs-number">210256</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:1002:1]</span> Sliver C2 SSL <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 3]</span> {TCP} <span class="hljs-number">10.10.20.101:53233</span> -&gt; <span class="hljs-number">23.152.0.91:443</span>
<span class="hljs-number">10</span>/<span class="hljs-number">20</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">17</span>:<span class="hljs-number">14</span>:<span class="hljs-number">25</span>.<span class="hljs-number">235711</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:1002:1]</span> Sliver C2 SSL <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 3]</span> {TCP} <span class="hljs-number">10.10.20.101:53243</span> -&gt; <span class="hljs-number">23.152.0.91:443</span>
<span class="hljs-number">10</span>/<span class="hljs-number">20</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">17</span>:<span class="hljs-number">11</span>:<span class="hljs-number">25</span>.<span class="hljs-number">213759</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:1002:1]</span> Sliver C2 SSL <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 3]</span> {TCP} <span class="hljs-number">10.10.20.101:53240</span> -&gt; <span class="hljs-number">23.152.0.91:443</span>
<span class="hljs-number">10</span>/<span class="hljs-number">20</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">17</span>:<span class="hljs-number">12</span>:<span class="hljs-number">25</span>.<span class="hljs-number">302237</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:1002:1]</span> Sliver C2 SSL <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 3]</span> {TCP} <span class="hljs-number">10.10.20.101:53241</span> -&gt; <span class="hljs-number">23.152.0.91:443</span>
<span class="hljs-number">10</span>/<span class="hljs-number">20</span>/<span class="hljs-number">2021</span>-<span class="hljs-number">17</span>:<span class="hljs-number">13</span>:<span class="hljs-number">25</span>.<span class="hljs-number">236776</span>  <span class="hljs-string">[**]</span> <span class="hljs-string">[1:1002:1]</span> Sliver C2 SSL <span class="hljs-string">[**]</span> <span class="hljs-string">[Classification: (null)]</span> <span class="hljs-string">[Priority: 3]</span> {TCP} <span class="hljs-number">10.10.20.101:53242</span> -&gt; <span class="hljs-number">23.152.0.91:443</span>
---SNIP---
</code></pre>
<h2 id="snort-fundamentals">Snort Fundamentals</h2>
<p>Snort is an open-source tool, which serves as both an Intrusion Detection System (IDS) and Intrusion Prevention System (IPS), but can also function as a packet logger or sniffer, akin to Suricata. By thoroughly inspecting all network traffic, Snort has the capability to identify and log all activity within that traffic, providing a comprehensive view of the situation and detailed logs of all application layer transactions. We require specific rule sets to instruct Snort on how to perform its inspection and what exactly it needs to identify. Snort was created to operate efficiently on both general-purpose and custom hardware.</p>
<h3 id="snort-operation-modes">Snort Operation Modes</h3>
<p>Snort typically operates in the following modes:</p>
<ul>
<li>Inline IDS/IPS</li>
<li>Passive IDS</li>
<li>Network-based IDS</li>
<li>Host-based IDS (however, Snort is not ideally a host-based IDS. We would recommend opting for more specialized tools for this.)</li>
</ul>
<p><strong>According to</strong> <a href="https://docs.snort.org/start/inspection"><strong>Snort&#39;s documentation</strong></a>:</p>
<p>&quot;With certain DAQ modules, Snort is able to utilize two different modes of operation: <code>passive</code> and <code>inline</code>. <code>Passive mode</code> gives Snort the ability to observe and detect traffic on a network interface, but it prevents outright blocking of traffic. <code>Inline mode</code> on the other hand, does give Snort the ability to block traffic if a particular packet warrants such an event.</p>
<p>Snort will infer the particular mode of operation based on the options used at the command line. For example, reading from a pcap file with the <code>-r</code> option or listening on an interface with <code>-i</code> will cause Snort to run in passive mode by default. If the DAQ supports inline, however, then users can specify the <code>-Q</code> flag to run Snort inline.</p>
<p>One DAQ module that supports inline mode is <code>afpacket</code>, which is a module that gives Snort access to packets received on Linux network devices.&quot;</p>
<h3 id="snort-architecture">Snort Architecture</h3>
<p>In order for Snort to transition from a simple packet sniffer to a robust IDS, several key components were added: <code>Preprocessor</code>, <code>Detection Engine</code>, <code>Logging and Alerting System</code>, and various <code>Output modules</code>.</p>
<ul>
<li>The packet sniffer (which includes the Packet Decoder) extracts network traffic, recognizing the structure of each packet. The raw packets that are collected are subsequently forwarded to the <code>Preprocessors</code>.</li>
<li><code>Preprocessors</code> within Snort identify the type or behaviour of the forwarded packets. Snort has an array of <code>Preprocessor</code> plugins, like the HTTP plugin that distinguishes HTTP-related packets or the <code>port_scan Preprocessor</code> which identifies potential port scanning attempts based on predefined protocols, types of scans, and thresholds. After the <code>Preprocessors</code> have completed their task, information is passed to the <code>Detection Engine</code>. The configuration of these <code>Preprocessors</code> can be found within the Snort configuration file, <code>snort.lua</code>.</li>
<li>The <code>Detection Engine</code> compares each packet with a predefined set of Snort rules. If a match is found, information is forwarded to the <code>Logging and Alerting System</code>.</li>
<li>The <code>Logging and Alerting System</code> and <code>Output modules</code> are in charge of recording or triggering alerts as determined by each rule action. Logs are generally stored in <code>syslog</code> or <code>unified2</code> formats or directly in a database. The <code>Output modules</code> are configured within the Snort configuration file, <code>snort.lua</code>.</li>
</ul>
<p>Let&#39;s now navigate to the bottom of this section and click on &quot;Click here to spawn the target system!&quot;. Then, let&#39;s SSH into the Target IP using the provided credentials. The vast majority of the commands covered from this point up to end of this section can be replicated inside the target, offering a more comprehensive grasp of the topics presented.</p>
<h3 id="snort-configuration-validating-snort-s-configuration">Snort Configuration &amp; Validating Snort&#39;s Configuration</h3>
<p>Snort offers a wide range of configuration options, and fortunately, the open-source Snort 3 provides users with pre-configured files to facilitate a quick start. These default configuration files, namely <code>snort.lua</code> and <code>snort_defaults.lua</code>, serve as the foundation for setting up Snort and getting it operational in no time. They provide a standard configuration framework for Snort users.</p>
<p>The <code>snort.lua</code> file serves as the principal configuration file for Snort. This file contains the following sections:</p>
<ul>
<li>Network variables</li>
<li>Decoder configuration</li>
<li>Base detection engine configuration</li>
<li>Dynamic library configuration</li>
<li>Preprocessor configuration</li>
<li>Output plugin configuration</li>
<li>Rule set customization</li>
<li>Preprocessor and decoder rule set customization</li>
<li>Shared object rule set customization</li>
</ul>
<p>Let&#39;s browse the <code>snort.lua</code> file residing in this section&#39;s target as follows.</p>
<p>Snort Fundamentals</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo more /root/snorty/etc/snort/snort.lua
-<span class="ruby">--------------------------------------------------------------------------
</span>-<span class="ruby">- Snort++ configuration
</span>-<span class="ruby">--------------------------------------------------------------------------
</span>
-<span class="ruby">- there are over <span class="hljs-number">200</span> modules available to tune your policy.
</span>-<span class="ruby">- many can be used with defaults w/o any explicit configuration.
</span>-<span class="ruby">- use this conf as a template <span class="hljs-keyword">for</span> your specific configuration.
</span>
-<span class="ruby">- <span class="hljs-number">1</span>. configure defaults
</span>-<span class="ruby">- <span class="hljs-number">2</span>. configure inspection
</span>-<span class="ruby">- <span class="hljs-number">3</span>. configure bindings
</span>-<span class="ruby">- <span class="hljs-number">4</span>. configure performance
</span>-<span class="ruby">- <span class="hljs-number">5</span>. configure detection
</span>-<span class="ruby">- <span class="hljs-number">6</span>. configure filters
</span>-<span class="ruby">- <span class="hljs-number">7</span>. configure outputs
</span>-<span class="ruby">- <span class="hljs-number">8</span>. configure tweaks
</span>
-<span class="ruby">--------------------------------------------------------------------------
</span>-<span class="ruby">- <span class="hljs-number">1</span>. configure defaults
</span>-<span class="ruby">--------------------------------------------------------------------------
</span>
-<span class="ruby">- HOME_NET <span class="hljs-keyword">and</span> EXTERNAL_NET must be set now
</span>-<span class="ruby">- setup the network addresses you are protecting
</span>HOME_NET = 'any'

-<span class="ruby">- set up the external network addresses.
</span>-<span class="ruby">- (leave as <span class="hljs-string">"any"</span> <span class="hljs-keyword">in</span> most situations)
</span>EXTERNAL_NET = 'any'

include 'snort_defaults.lua'

-<span class="ruby">--------------------------------------------------------------------------
</span>-<span class="ruby">- <span class="hljs-number">2</span>. configure inspection
</span>-<span class="ruby">--------------------------------------------------------------------------
</span>
-<span class="ruby">- mod = { } uses internal defaults
</span>-<span class="ruby">- you can see them with snort --help-<span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">mod</span></span>
</span>
-<span class="ruby">- mod = default_mod uses external defaults
</span>-<span class="ruby">- you can see them <span class="hljs-keyword">in</span> snort_defaults.lua
</span>
-<span class="ruby">- the following are quite capable with <span class="hljs-symbol">defaults:</span>
</span>
stream = { }
stream_ip = { }
stream_icmp = { }
stream_tcp = { }
stream_udp = { }
stream_user = { }
stream_file = { }
-<span class="ruby">--SNIP---</span>
</code></pre>
<p>Enabling and fine-tuning Snort <code>modules</code> is a significant aspect of the configuration process. To explore the complete list and get a brief description of all Snort 3 modules, you can use the following command.</p>
<p>Snort Fundamentals</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ snort <span class="hljs-comment">--help-modules</span>
ack (ips_option): rule option <span class="hljs-built_in">to</span> match <span class="hljs-keyword">on</span> <span class="hljs-title">TCP</span> <span class="hljs-title">ack</span> <span class="hljs-title">numbers</span>
active (basic): configure responses
address_space_selector (policy_selector): configure traffic processing based <span class="hljs-keyword">on</span> <span class="hljs-title">address</span> <span class="hljs-title">space</span>
alert_csv (logger): output event <span class="hljs-keyword">in</span> csv <span class="hljs-built_in">format</span>
alert_fast (logger): output event <span class="hljs-keyword">with</span> brief <span class="hljs-keyword">text</span> <span class="hljs-built_in">format</span>
alert_full (logger): output event <span class="hljs-keyword">with</span> full packet dump
alert_json (logger): output event <span class="hljs-keyword">in</span> json <span class="hljs-built_in">format</span>
alert_syslog (logger): output event <span class="hljs-built_in">to</span> syslog
alert_talos (logger): output event <span class="hljs-keyword">in</span> Talos alert <span class="hljs-built_in">format</span>
alert_unixsock (logger): output event over unix <span class="hljs-built_in">socket</span>
alerts (basic): configure alerts
appid (inspector): application <span class="hljs-keyword">and</span> service identification
appids (ips_option): detection option <span class="hljs-keyword">for</span> application ids
arp (codec): support <span class="hljs-keyword">for</span> address resolution protocol
arp_spoof (inspector): detect ARP attacks <span class="hljs-keyword">and</span> anomalies
<span class="hljs-comment">---SNIP---</span>
</code></pre>
<p>These modules are enabled and configured within the <code>snort.lua</code> configuration file as Lua table literals. If a module is initialized as an empty table, it implies that it is utilizing its predefined &quot;default&quot; settings. To view these default settings, you can utilize the following command.</p>
<p>Snort Fundamentals</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ snort --help-config arp_spoof
ip4 arp_spoof<span class="hljs-selector-class">.hosts</span>[]<span class="hljs-selector-class">.ip</span>: host ip <span class="hljs-selector-tag">address</span>
mac arp_spoof<span class="hljs-selector-class">.hosts</span>[]<span class="hljs-selector-class">.mac</span>: host mac address
</code></pre>
<p>Passing (and validating) configuration files to Snort can be done as follows.</p>
<p>Snort Fundamentals</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq
<span class="hljs-code">--------------------------------------------------
o")~   Snort++ 3.1.64.0
--------------------------------------------------</span>
Loading /root/snorty/etc/snort/snort.lua:
Loading snort<span class="hljs-emphasis">_defaults.lua:
Finished snort_</span>defaults.lua:
<span class="hljs-code">        output</span>
<span class="hljs-code">        ips</span>
<span class="hljs-code">        classifications</span>
<span class="hljs-code">        references</span>
<span class="hljs-code">        binder</span>
<span class="hljs-code">        file_id</span>
<span class="hljs-code">        ftp_server</span>
<span class="hljs-code">        smtp</span>
<span class="hljs-code">        port_scan</span>
<span class="hljs-code">        gtp_inspect</span>
<span class="hljs-code">        dce_smb</span>
<span class="hljs-code">        s7commplus</span>
<span class="hljs-code">        modbus</span>
<span class="hljs-code">        ssh</span>
<span class="hljs-code">        active</span>
<span class="hljs-code">        alerts</span>
<span class="hljs-code">        daq</span>
<span class="hljs-code">        decode</span>
<span class="hljs-code">        host_cache</span>
<span class="hljs-code">        host_tracker</span>
<span class="hljs-code">        hosts</span>
<span class="hljs-code">        network</span>
<span class="hljs-code">        packets</span>
<span class="hljs-code">        process</span>
<span class="hljs-code">        search_engine</span>
<span class="hljs-code">        so_proxy</span>
<span class="hljs-code">        stream_icmp</span>
<span class="hljs-code">        normalizer</span>
<span class="hljs-code">        stream</span>
<span class="hljs-code">        stream_ip</span>
<span class="hljs-code">        stream_tcp</span>
<span class="hljs-code">        stream_udp</span>
<span class="hljs-code">        stream_user</span>
<span class="hljs-code">        stream_file</span>
<span class="hljs-code">        arp_spoof</span>
<span class="hljs-code">        back_orifice</span>
<span class="hljs-code">        dns</span>
<span class="hljs-code">        imap</span>
<span class="hljs-code">        netflow</span>
<span class="hljs-code">        pop</span>
<span class="hljs-code">        rpc_decode</span>
<span class="hljs-code">        sip</span>
<span class="hljs-code">        ssl</span>
<span class="hljs-code">        telnet</span>
<span class="hljs-code">        cip</span>
<span class="hljs-code">        dnp3</span>
<span class="hljs-code">        iec104</span>
<span class="hljs-code">        mms</span>
<span class="hljs-code">        dce_tcp</span>
<span class="hljs-code">        dce_udp</span>
<span class="hljs-code">        dce_http_proxy</span>
<span class="hljs-code">        dce_http_server</span>
<span class="hljs-code">        ftp_client</span>
<span class="hljs-code">        ftp_data</span>
<span class="hljs-code">        http_inspect</span>
<span class="hljs-code">        http2_inspect</span>
<span class="hljs-code">        file_policy</span>
<span class="hljs-code">        js_norm</span>
<span class="hljs-code">        appid</span>
<span class="hljs-code">        wizard</span>
<span class="hljs-code">        trace</span>
Finished /root/snorty/etc/snort/snort.lua:
Loading file<span class="hljs-emphasis">_id.rules_</span>file:
Loading file<span class="hljs-emphasis">_magic.rules:
Finished file_</span>magic.rules:
<span class="hljs-section">Finished file_id.rules_file:
--------------------------------------------------</span>
ips policies rule stats
<span class="hljs-code">              id  loaded  shared enabled    file</span>
<span class="hljs-section">               0     208       0     208    /root/snorty/etc/snort/snort.lua
--------------------------------------------------</span>
rule counts
<span class="hljs-code">       total rules loaded: 208</span>
<span class="hljs-code">               text rules: 208</span>
<span class="hljs-code">            option chains: 208</span>
<span class="hljs-section">            chain headers: 1
--------------------------------------------------</span>
service rule counts          to-srv  to-cli
<span class="hljs-code">                  file_id:      208     208</span>
<span class="hljs-section">                    total:      208     208
--------------------------------------------------</span>
fast pattern groups
<span class="hljs-code">                to_server: 1</span>
<span class="hljs-section">                to_client: 1
--------------------------------------------------</span>
search engine (ac<span class="hljs-emphasis">_bnfa)
                instances: 2
                 patterns: 416
            pattern chars: 2508
               num states: 1778
         num match states: 370
             memory scale: KB
             total memory: 68.5879
           pattern memory: 18.6973
        match list memory: 27.3281
        transition memory: 22.3125
appid: MaxRss diff: 3084
appid: patterns loaded: 300
--------------------------------------------------
pcap DAQ configured to passive.

</span>Snort successfully validated the configuration (with 0 warnings).
o")~   Snort exiting
</code></pre>
<p><strong>Note</strong>: <code>--daq-dir /usr/local/lib/daq</code> is not required to pass and validate a configuration file. It is added so that we can replicate the command in this section&#39;s target.</p>
<p>Since we mentioned <code>DAQ</code>, Snort 3 should know where to find the appropriate <code>LibDAQ</code>. <code>LibDAQ</code> is the &quot;Data Acquisition Library&quot;, and at a high-level, it&#39;s an abstraction layer used by <code>modules</code> to communicate with both hardware and software network data sources.</p>
<p>We highly recommend taking the time to read the comments inside the <code>snort.lua</code> file as they provide valuable insights.</p>
<h3 id="snort-inputs">Snort Inputs</h3>
<p>To observe Snort in action, the easiest method is to execute it against a packet capture file. By providing the name of the pcap file as an argument to the <code>-r</code> option in the command line, Snort will process the file accordingly.</p>
<p>Snort Fundamentals</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq -r /home/htb-student/pcaps/icmp.pcap
[sudo] password for htb-student:
<span class="hljs-code">--------------------------------------------------
o")~   Snort++ 3.1.64.0
--------------------------------------------------</span>
Loading /root/snorty/etc/snort/snort.lua:
Loading snort<span class="hljs-emphasis">_defaults.lua:
Finished snort_</span>defaults.lua:
---SNIP---
Finished /root/snorty/etc/snort/snort.lua:
Loading file<span class="hljs-emphasis">_id.rules_</span>file:
Loading file<span class="hljs-emphasis">_magic.rules:
Finished file_</span>magic.rules:
<span class="hljs-section">Finished file_id.rules_file:
--------------------------------------------------</span>
ips policies rule stats
<span class="hljs-code">              id  loaded  shared enabled    file</span>
<span class="hljs-section">               0     208       0     208    /root/snorty/etc/snort/snort.lua
--------------------------------------------------</span>
rule counts
<span class="hljs-code">       total rules loaded: 208</span>
<span class="hljs-code">               text rules: 208</span>
<span class="hljs-code">            option chains: 208</span>
<span class="hljs-section">            chain headers: 1
--------------------------------------------------</span>
service rule counts          to-srv  to-cli
<span class="hljs-code">                  file_id:      208     208</span>
<span class="hljs-section">                    total:      208     208
--------------------------------------------------</span>
fast pattern groups
<span class="hljs-code">                to_server: 1</span>
<span class="hljs-section">                to_client: 1
--------------------------------------------------</span>
search engine (ac<span class="hljs-emphasis">_bnfa)
                instances: 2
                 patterns: 416
            pattern chars: 2508
               num states: 1778
         num match states: 370
             memory scale: KB
             total memory: 68.5879
           pattern memory: 18.6973
        match list memory: 27.3281
        transition memory: 22.3125
appid: MaxRss diff: 3024
appid: patterns loaded: 300
--------------------------------------------------
pcap DAQ configured to read-file.
Commencing packet processing
++ [0] /home/htb-student/pcaps/icmp.pcap
-- [0] /home/htb-student/pcaps/icmp.pcap
--------------------------------------------------
Packet Statistics
--------------------------------------------------
daq
                    pcaps: 1
                 received: 8
                 analyzed: 8
                    allow: 8
                 rx_</span>bytes: 592
<span class="hljs-code">--------------------------------------------------
codec
                    total: 8            (100.000%)
                      eth: 8            (100.000%)
                    icmp4: 8            (100.000%)
                     ipv4: 8            (100.000%)
--------------------------------------------------</span>
<span class="hljs-section">Module Statistics
--------------------------------------------------</span>
appid
<span class="hljs-code">                  packets: 8</span>
<span class="hljs-code">        processed_packets: 8</span>
<span class="hljs-section">           total_sessions: 1
--------------------------------------------------</span>
binder
<span class="hljs-code">                new_flows: 1</span>
<span class="hljs-section">                 inspects: 1
--------------------------------------------------</span>
detection
<span class="hljs-section">                 analyzed: 8
--------------------------------------------------</span>
port<span class="hljs-emphasis">_scan
                  packets: 8
                 trackers: 2
--------------------------------------------------
stream
                    flows: 1
--------------------------------------------------
stream_</span>icmp
<span class="hljs-code">                 sessions: 1</span>
<span class="hljs-code">                      max: 1</span>
<span class="hljs-code">                  created: 1</span>
<span class="hljs-section">                 released: 1
--------------------------------------------------</span>
<span class="hljs-section">Summary Statistics
--------------------------------------------------</span>
timing
<span class="hljs-code">                  runtime: 00:00:00</span>
<span class="hljs-code">                  seconds: 0.033229</span>
<span class="hljs-code">                 pkts/sec: 241</span>
o")~   Snort exiting
</code></pre>
<p>Snort also has the capability to listen on active network interfaces. To specify this behavior, you can utilize the <code>-i</code> option followed by the names of the interfaces on which Snort should run.</p>
<p>Snort Fundamentals</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq -i ens160
<span class="hljs-code">--------------------------------------------------
o")~   Snort++ 3.1.64.0
--------------------------------------------------</span>
Loading /root/snorty/etc/snort/snort.lua:
Loading snort<span class="hljs-emphasis">_defaults.lua:
Finished snort_</span>defaults.lua:
---SNIP---
Finished /root/snorty/etc/snort/snort.lua:
Loading file<span class="hljs-emphasis">_id.rules_</span>file:
Loading file<span class="hljs-emphasis">_magic.rules:
Finished file_</span>magic.rules:
<span class="hljs-section">Finished file_id.rules_file:
--------------------------------------------------</span>
ips policies rule stats
<span class="hljs-code">              id  loaded  shared enabled    file</span>
<span class="hljs-section">               0     208       0     208    /root/snorty/etc/snort/snort.lua
--------------------------------------------------</span>
rule counts
<span class="hljs-code">       total rules loaded: 208</span>
<span class="hljs-code">               text rules: 208</span>
<span class="hljs-code">            option chains: 208</span>
<span class="hljs-section">            chain headers: 1
--------------------------------------------------</span>
service rule counts          to-srv  to-cli
<span class="hljs-code">                  file_id:      208     208</span>
<span class="hljs-section">                    total:      208     208
--------------------------------------------------</span>
fast pattern groups
<span class="hljs-code">                to_server: 1</span>
<span class="hljs-section">                to_client: 1
--------------------------------------------------</span>
search engine (ac<span class="hljs-emphasis">_bnfa)
                instances: 2
                 patterns: 416
            pattern chars: 2508
               num states: 1778
         num match states: 370
             memory scale: KB
             total memory: 68.5879
           pattern memory: 18.6973
        match list memory: 27.3281
        transition memory: 22.3125
appid: MaxRss diff: 2820
appid: patterns loaded: 300
--------------------------------------------------
pcap DAQ configured to passive.
Commencing packet processing
++ [0] ens160
^C** caught int signal
== stopping
-- [0] ens160
--------------------------------------------------
Packet Statistics
--------------------------------------------------
daq
                 received: 33
                 analyzed: 33
                    allow: 33
                     idle: 9
                 rx_</span>bytes: 2756
<span class="hljs-code">--------------------------------------------------
codec
                    total: 33           (100.000%)
                 discards: 2            (  6.061%)
                      arp: 13           ( 39.394%)
                      eth: 33           (100.000%)
                    icmp4: 12           ( 36.364%)
                    icmp6: 3            (  9.091%)
                     ipv4: 17           ( 51.515%)
                     ipv6: 3            (  9.091%)
                      tcp: 5            ( 15.152%)
--------------------------------------------------</span>
<span class="hljs-section">Module Statistics
--------------------------------------------------</span>
appid
<span class="hljs-code">                  packets: 18</span>
<span class="hljs-code">        processed_packets: 16</span>
<span class="hljs-code">          ignored_packets: 2</span>
<span class="hljs-section">           total_sessions: 3
--------------------------------------------------</span>
arp<span class="hljs-emphasis">_spoof
                  packets: 13
--------------------------------------------------
binder
              raw_</span>packets: 15
<span class="hljs-code">                new_flows: 3</span>
<span class="hljs-section">                 inspects: 18
--------------------------------------------------</span>
detection
<span class="hljs-section">                 analyzed: 33
--------------------------------------------------</span>
port<span class="hljs-emphasis">_scan
                  packets: 20
                 trackers: 8
--------------------------------------------------
stream
                    flows: 3
--------------------------------------------------
stream_</span>icmp
<span class="hljs-code">                 sessions: 2</span>
<span class="hljs-code">                      max: 2</span>
<span class="hljs-code">                  created: 2</span>
<span class="hljs-section">                 released: 2
--------------------------------------------------</span>
stream<span class="hljs-emphasis">_tcp
                 sessions: 1
                      max: 1
                  created: 1
                 released: 1
             instantiated: 1
                   setups: 1
            data_</span>trackers: 1
<span class="hljs-code">              segs_queued: 1</span>
<span class="hljs-code">            segs_released: 1</span>
<span class="hljs-code">                 max_segs: 1</span>
<span class="hljs-section">                max_bytes: 64
--------------------------------------------------</span>
tcp
<span class="hljs-section">        bad_tcp4_checksum: 2
--------------------------------------------------</span>
<span class="hljs-section">Appid Statistics
--------------------------------------------------</span>
detected apps and services
<span class="hljs-code">              Application: Services   Clients    Users      Payloads   Misc       Referred</span>
<span class="hljs-section">                  unknown: 1          0          0          0          0          0
--------------------------------------------------</span>
<span class="hljs-section">Summary Statistics
--------------------------------------------------</span>
process
<span class="hljs-section">                  signals: 1
--------------------------------------------------</span>
timing
<span class="hljs-code">                  runtime: 00:00:25</span>
<span class="hljs-code">                  seconds: 25.182182</span>
<span class="hljs-code">                 pkts/sec: 1</span>
o")~   Snort exiting
</code></pre>
<h3 id="snort-rules">Snort Rules</h3>
<p>Snort rules, which resemble Suricata rules, are composed of a <code>rule header</code> and <code>rule options</code>. Even though Snort rules share similarities with Suricata rules, we strongly suggest studying Snort rule writing from the following resources: <a href="https://docs.snort.org/">https://docs.snort.org/</a>, <a href="https://docs.suricata.io/en/latest/rules/differences-from-snort.html">https://docs.suricata.io/en/latest/rules/differences-from-snort.html</a>. The most recent Snort rules can be obtained from the Snort website or the Emerging Threats website.</p>
<p>In Snort deployments, we have flexibility in managing rules. It&#39;s possible to place rules (for example, <code>local.rules</code> residing at <code>/home/htb-student</code>) directly within the <code>snort.lua</code> configuration file using the <code>ips</code> module as follows.</p>
<p>Snort Fundamentals</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ sudo vim /root</span><span class="hljs-regexp">/snorty/etc</span><span class="hljs-regexp">/snort/snort</span>.lua
</code></pre>
<p>Snort Fundamentals</p>
<pre><code class="lang-shell-session">-<span class="ruby">--SNIP---
</span>ips =
{
    -<span class="ruby">- use this to enable decoder <span class="hljs-keyword">and</span> inspector alerts
</span>    -<span class="ruby">-enable_builtin_rules = <span class="hljs-literal">true</span>,
</span>
    -<span class="ruby">- use <span class="hljs-keyword">include</span> <span class="hljs-keyword">for</span> rules files; be sure to set your path
</span>    -<span class="ruby">- note that rules files can <span class="hljs-keyword">include</span> other rules files
</span>    -<span class="ruby">- (see also related path vars at the top of snort_defaults.lua)
</span>
    { variables = default_variables, include = '/home/htb-student/local.rules' }
}
-<span class="ruby">--SNIP---</span>
</code></pre>
<p>Then, the &quot;included&quot; rules will be automatically loaded.</p>
<p>In our Snort deployment, we have an alternative approach to incorporate rules directly from the command line. We can pass either a single rules file or a path to a directory containing rules files directly to Snort. This can be achieved using two options:</p>
<ul>
<li>For a single rules file, we can use the <code>-R</code> option followed by the path to the rules file. This allows us to specify a specific rules file to be utilized by Snort.</li>
<li>To include an entire directory of rules files, we can use the <code>--rule-path</code> option followed by the path to the rules directory. This enables us to provide Snort with a directory containing multiple rules files.</li>
</ul>
<h3 id="snort-outputs">Snort Outputs</h3>
<p>In our Snort deployment, we may encounter a significant amount of data. To provide a summary of the core output types, let&#39;s explore the key aspects:</p>
<ul>
<li><code>Basic Statistics</code>: Upon shutdown, Snort generates various counts based on the configuration and processed traffic. This includes:<ul>
<li><code>Packet Statistics</code>: It includes information from the DAQ and decoders, such as the number of received packets and UDP packets.</li>
<li><code>Module Statistics</code>: Each module keeps track of activity through peg counts, indicating the frequency of observed or performed actions. Examples include the count of processed HTTP GET requests and trimmed TCP reset packets.</li>
<li><code>File Statistics</code>: This section provides a breakdown of file types, bytes, and signatures.</li>
<li><code>Summary Statistics</code>: It encompasses the total runtime for packet processing, packets per second, and, if configured, profiling data.</li>
</ul>
</li>
<li><p><code>Alerts</code>: When rules are configured, it is necessary to enable alerting (using the <code>-A</code> option) to view the details of detection events. There are multiple types of alert outputs available, including:</p>
<ul>
<li><code>-A cmg</code>: This option combines <code>-A fast -d -e</code> and displays alert information along with packet headers and payload.</li>
<li><code>-A u2</code>: This option is equivalent to <code>-A unified2</code> and logs events and triggering packets in a binary file, which can be used for post-processing with other tools.</li>
<li><code>-A csv</code>: This option outputs fields in comma-separated value format, providing customization options and facilitating pcap analysis.</li>
</ul>
<p>To discover the available alert types, we can execute the following command.</p>
</li>
</ul>
<p>Snort Fundamentals</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ snort --<span class="hljs-built_in">list</span>-plugins | grep logger
logger::alert_csv v0 <span class="hljs-keyword">static</span>
logger::alert_fast v0 <span class="hljs-keyword">static</span>
logger::alert_full v0 <span class="hljs-keyword">static</span>
logger::alert_json v0 <span class="hljs-keyword">static</span>
logger::alert_syslog v0 <span class="hljs-keyword">static</span>
logger::alert_talos v0 <span class="hljs-keyword">static</span>
logger::alert_unixsock v0 <span class="hljs-keyword">static</span>
logger::log_codecs v0 <span class="hljs-keyword">static</span>
logger::log_hext v0 <span class="hljs-keyword">static</span>
logger::log_pcap v0 <span class="hljs-keyword">static</span>
logger::unified2 v0 <span class="hljs-keyword">static</span>
</code></pre>
<ul>
<li><code>Performance Statistics</code>: Beyond the aforementioned outputs, additional data can be obtained. By configuring the <code>perf_monitor</code> module, we can capture a customizable set of <code>peg</code> counts during runtime. This data can be fed into an external program to monitor Snort&#39;s activity without interrupting its operation. The <code>profiler</code> module allows tracking of time and space usage by modules and rules. This information is valuable for optimizing system performance. The profiler output appears under <code>Summary Statistics</code> during shutdown.</li>
</ul>
<p>Let&#39;s see an example of the <code>cmg</code> output.</p>
<p>Snort Fundamentals</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq -r /home/htb-student/pcaps/icmp.pcap -A cmg
<span class="hljs-code">--------------------------------------------------
o")~   Snort++ 3.1.64.0
--------------------------------------------------</span>
Loading /root/snorty/etc/snort/snort.lua:
Loading snort<span class="hljs-emphasis">_defaults.lua:
Finished snort_</span>defaults.lua:
--SNIP---
Finished /root/snorty/etc/snort/snort.lua:
Loading file<span class="hljs-emphasis">_id.rules_</span>file:
Loading file<span class="hljs-emphasis">_magic.rules:
Finished file_</span>magic.rules:
Finished file<span class="hljs-emphasis">_id.rules_</span>file:
Loading /home/htb-student/local.rules:
<span class="hljs-section">Finished /home/htb-student/local.rules:
--------------------------------------------------</span>
ips policies rule stats
<span class="hljs-code">              id  loaded  shared enabled    file</span>
<span class="hljs-section">               0     209       0     209    /root/snorty/etc/snort/snort.lua
--------------------------------------------------</span>
rule counts
<span class="hljs-code">       total rules loaded: 209</span>
<span class="hljs-code">               text rules: 209</span>
<span class="hljs-code">            option chains: 209</span>
<span class="hljs-section">            chain headers: 2
--------------------------------------------------</span>
port rule counts
<span class="hljs-code">             tcp     udp    icmp      ip</span>
<span class="hljs-code">     any       0       0       1       0</span>
<span class="hljs-section">   total       0       0       1       0
--------------------------------------------------</span>
service rule counts          to-srv  to-cli
<span class="hljs-code">                  file_id:      208     208</span>
<span class="hljs-section">                    total:      208     208
--------------------------------------------------</span>
fast pattern groups
<span class="hljs-code">                to_server: 1</span>
<span class="hljs-section">                to_client: 1
--------------------------------------------------</span>
search engine (ac<span class="hljs-emphasis">_bnfa)
                instances: 2
                 patterns: 416
            pattern chars: 2508
               num states: 1778
         num match states: 370
             memory scale: KB
             total memory: 68.5879
           pattern memory: 18.6973
        match list memory: 27.3281
        transition memory: 22.3125
appid: MaxRss diff: 3024
appid: patterns loaded: 300
--------------------------------------------------
pcap DAQ configured to read-file.
Commencing packet processing
++ [0] /home/htb-student/pcaps/icmp.pcap
06/19-08:45:56.838904 [**] [1:1000001:1] "ICMP test" [**] [Classification: Generic ICMP event] [Priority: 3] {ICMP} 192.168.158.139 -&gt; 174.137.42.77
00:0C:29:34:0B:DE -&gt; 00:50:56:E0:14:49 type:0x800 len:0x4A
192.168.158.139 -&gt; 174.137.42.77 ICMP TTL:128 TOS:0x0 ID:55107 IpLen:20 DgmLen:60
Type:8  Code:0  ID:512   Seq:8448  ECHO

</span>snort.raw[32]:
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
61 62 63 64 65 66 67 68  69 6A 6B 6C 6D 6E 6F 70  abcdefgh ijklmnop
71 72 73 74 75 76 77 61  62 63 64 65 66 67 68 69  qrstuvwa bcdefghi
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

06/19-08:45:57.055699 [*<span class="hljs-strong">*] [1:1000001:1] "ICMP test" [*</span><span class="hljs-strong">*] [Classification: Generic ICMP event] [Priority: 3] {ICMP} 174.137.42.77 -&gt; 192.168.158.139
00:50:56:E0:14:49 -&gt; 00:0C:29:34:0B:DE type:0x800 len:0x4A
174.137.42.77 -&gt; 192.168.158.139 ICMP TTL:128 TOS:0x0 ID:30433 IpLen:20 DgmLen:60
Type:0  Code:0  ID:512  Seq:8448  ECHO REPLY

</span>snort.raw[32]:
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
61 62 63 64 65 66 67 68  69 6A 6B 6C 6D 6E 6F 70  abcdefgh ijklmnop
71 72 73 74 75 76 77 61  62 63 64 65 66 67 68 69  qrstuvwa bcdefghi
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

06/19-08:45:57.840049 [*<span class="hljs-strong">*] [1:1000001:1] "ICMP test" [*</span><span class="hljs-strong">*] [Classification: Generic ICMP event] [Priority: 3] {ICMP} 192.168.158.139 -&gt; 174.137.42.77
00:0C:29:34:0B:DE -&gt; 00:50:56:E0:14:49 type:0x800 len:0x4A
192.168.158.139 -&gt; 174.137.42.77 ICMP TTL:128 TOS:0x0 ID:55110 IpLen:20 DgmLen:60
Type:8  Code:0  ID:512   Seq:8704  ECHO

</span>snort.raw[32]:
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
61 62 63 64 65 66 67 68  69 6A 6B 6C 6D 6E 6F 70  abcdefgh ijklmnop
71 72 73 74 75 76 77 61  62 63 64 65 66 67 68 69  qrstuvwa bcdefghi
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

06/19-08:45:58.044196 [*<span class="hljs-strong">*] [1:1000001:1] "ICMP test" [*</span><span class="hljs-strong">*] [Classification: Generic ICMP event] [Priority: 3] {ICMP} 174.137.42.77 -&gt; 192.168.158.139
00:50:56:E0:14:49 -&gt; 00:0C:29:34:0B:DE type:0x800 len:0x4A
174.137.42.77 -&gt; 192.168.158.139 ICMP TTL:128 TOS:0x0 ID:30436 IpLen:20 DgmLen:60
Type:0  Code:0  ID:512  Seq:8704  ECHO REPLY

</span>snort.raw[32]:
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
61 62 63 64 65 66 67 68  69 6A 6B 6C 6D 6E 6F 70  abcdefgh ijklmnop
71 72 73 74 75 76 77 61  62 63 64 65 66 67 68 69  qrstuvwa bcdefghi
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

06/19-08:45:58.841168 [*<span class="hljs-strong">*] [1:1000001:1] "ICMP test" [*</span><span class="hljs-strong">*] [Classification: Generic ICMP event] [Priority: 3] {ICMP} 192.168.158.139 -&gt; 174.137.42.77
00:0C:29:34:0B:DE -&gt; 00:50:56:E0:14:49 type:0x800 len:0x4A
192.168.158.139 -&gt; 174.137.42.77 ICMP TTL:128 TOS:0x0 ID:55113 IpLen:20 DgmLen:60
Type:8  Code:0  ID:512   Seq:8960  ECHO

</span>snort.raw[32]:
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
61 62 63 64 65 66 67 68  69 6A 6B 6C 6D 6E 6F 70  abcdefgh ijklmnop
71 72 73 74 75 76 77 61  62 63 64 65 66 67 68 69  qrstuvwa bcdefghi
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

06/19-08:45:59.085428 [*<span class="hljs-strong">*] [1:1000001:1] "ICMP test" [*</span><span class="hljs-strong">*] [Classification: Generic ICMP event] [Priority: 3] {ICMP} 174.137.42.77 -&gt; 192.168.158.139
00:50:56:E0:14:49 -&gt; 00:0C:29:34:0B:DE type:0x800 len:0x4A
174.137.42.77 -&gt; 192.168.158.139 ICMP TTL:128 TOS:0x0 ID:30448 IpLen:20 DgmLen:60
Type:0  Code:0  ID:512  Seq:8960  ECHO REPLY

</span>snort.raw[32]:
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
61 62 63 64 65 66 67 68  69 6A 6B 6C 6D 6E 6F 70  abcdefgh ijklmnop
71 72 73 74 75 76 77 61  62 63 64 65 66 67 68 69  qrstuvwa bcdefghi
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

06/19-08:45:59.841775 [*<span class="hljs-strong">*] [1:1000001:1] "ICMP test" [*</span><span class="hljs-strong">*] [Classification: Generic ICMP event] [Priority: 3] {ICMP} 192.168.158.139 -&gt; 174.137.42.77
00:0C:29:34:0B:DE -&gt; 00:50:56:E0:14:49 type:0x800 len:0x4A
192.168.158.139 -&gt; 174.137.42.77 ICMP TTL:128 TOS:0x0 ID:55118 IpLen:20 DgmLen:60
Type:8  Code:0  ID:512   Seq:9216  ECHO

</span>snort.raw[32]:
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
61 62 63 64 65 66 67 68  69 6A 6B 6C 6D 6E 6F 70  abcdefgh ijklmnop
71 72 73 74 75 76 77 61  62 63 64 65 66 67 68 69  qrstuvwa bcdefghi
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

06/19-08:46:00.042354 [*<span class="hljs-strong">*] [1:1000001:1] "ICMP test" [*</span><span class="hljs-strong">*] [Classification: Generic ICMP event] [Priority: 3] {ICMP} 174.137.42.77 -&gt; 192.168.158.139
00:50:56:E0:14:49 -&gt; 00:0C:29:34:0B:DE type:0x800 len:0x4A
174.137.42.77 -&gt; 192.168.158.139 ICMP TTL:128 TOS:0x0 ID:30453 IpLen:20 DgmLen:60
Type:0  Code:0  ID:512  Seq:9216  ECHO REPLY

</span>snort.raw[32]:
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
61 62 63 64 65 66 67 68  69 6A 6B 6C 6D 6E 6F 70  abcdefgh ijklmnop
71 72 73 74 75 76 77 61  62 63 64 65 66 67 68 69  qrstuvwa bcdefghi
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

<span class="hljs-bullet">-- </span>[0] /home/htb-student/pcaps/icmp.pcap
<span class="hljs-code">--------------------------------------------------
Packet Statistics
--------------------------------------------------</span>
daq
<span class="hljs-code">                    pcaps: 1</span>
<span class="hljs-code">                 received: 8</span>
<span class="hljs-code">                 analyzed: 8</span>
<span class="hljs-code">                    allow: 8</span>
<span class="hljs-section">                 rx_bytes: 592
--------------------------------------------------</span>
codec
<span class="hljs-code">                    total: 8            (100.000%)</span>
<span class="hljs-code">                      eth: 8            (100.000%)</span>
<span class="hljs-code">                    icmp4: 8            (100.000%)</span>
<span class="hljs-section">                     ipv4: 8            (100.000%)
--------------------------------------------------</span>
<span class="hljs-section">Module Statistics
--------------------------------------------------</span>
appid
<span class="hljs-code">                  packets: 8</span>
<span class="hljs-code">        processed_packets: 8</span>
<span class="hljs-section">           total_sessions: 1
--------------------------------------------------</span>
binder
<span class="hljs-code">                new_flows: 1</span>
<span class="hljs-section">                 inspects: 1
--------------------------------------------------</span>
detection
<span class="hljs-code">                 analyzed: 8</span>
<span class="hljs-code">               hard_evals: 8</span>
<span class="hljs-code">                   alerts: 8</span>
<span class="hljs-code">             total_alerts: 8</span>
<span class="hljs-section">                   logged: 8
--------------------------------------------------</span>
port<span class="hljs-emphasis">_scan
                  packets: 8
                 trackers: 2
--------------------------------------------------
search_</span>engine
<span class="hljs-section">         qualified_events: 8
--------------------------------------------------</span>
stream
<span class="hljs-section">                    flows: 1
--------------------------------------------------</span>
stream<span class="hljs-emphasis">_icmp
                 sessions: 1
                      max: 1
                  created: 1
                 released: 1
--------------------------------------------------
Summary Statistics
--------------------------------------------------
timing
                  runtime: 00:00:00
                  seconds: 0.042473
                 pkts/sec: 188
o")~   Snort exiting</span>
</code></pre>
<p>The same command but using a <code>.rules</code> files that may not be &quot;included&quot; in <code>snort.lua</code> is the following.</p>
<p>Snort Fundamentals</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq -r /home/htb-student/pcaps/icmp.pcap -R /home/htb-student/local.rules -A cmg
<span class="hljs-code">--------------------------------------------------
o")~   Snort++ 3.1.64.0
--------------------------------------------------</span>
Loading /root/snorty/etc/snort/snort.lua:
Loading snort<span class="hljs-emphasis">_defaults.lua:
Finished snort_</span>defaults.lua:
--SNIP---
Finished /root/snorty/etc/snort/snort.lua:
Loading file<span class="hljs-emphasis">_id.rules_</span>file:
Loading file<span class="hljs-emphasis">_magic.rules:
Finished file_</span>magic.rules:
Finished file<span class="hljs-emphasis">_id.rules_</span>file:
Loading /home/htb-student/local.rules:
<span class="hljs-section">Finished /home/htb-student/local.rules:
--------------------------------------------------</span>
ips policies rule stats
<span class="hljs-code">             id  loaded  shared enabled    file</span>
<span class="hljs-section">              0     209       0     209    /root/snorty/etc/snort/snort.lua
--------------------------------------------------</span>
rule counts
<span class="hljs-code">      total rules loaded: 209</span>
<span class="hljs-code">              text rules: 209</span>
<span class="hljs-code">           option chains: 209</span>
<span class="hljs-section">           chain headers: 2
--------------------------------------------------</span>
port rule counts
<span class="hljs-code">            tcp     udp    icmp      ip</span>
<span class="hljs-code">    any       0       0       1       0</span>
<span class="hljs-section">  total       0       0       1       0
--------------------------------------------------</span>
service rule counts          to-srv  to-cli
<span class="hljs-code">                 file_id:      208     208</span>
<span class="hljs-section">                   total:      208     208
--------------------------------------------------</span>
fast pattern groups
<span class="hljs-code">               to_server: 1</span>
<span class="hljs-section">               to_client: 1
--------------------------------------------------</span>
search engine (ac<span class="hljs-emphasis">_bnfa)
               instances: 2
                patterns: 416
           pattern chars: 2508
              num states: 1778
        num match states: 370
            memory scale: KB
            total memory: 68.5879
          pattern memory: 18.6973
       match list memory: 27.3281
       transition memory: 22.3125
appid: MaxRss diff: 3024
appid: patterns loaded: 300
--------------------------------------------------
pcap DAQ configured to read-file.
Commencing packet processing
++ [0] /home/htb-student/pcaps/icmp.pcap
06/19-08:45:56.838904 [**] [1:1000001:1] "ICMP test" [**] [Classification: Generic ICMP event] [Priority: 3] {ICMP} 192.168.158.139 -&gt; 174.137.42.77
00:0C:29:34:0B:DE -&gt; 00:50:56:E0:14:49 type:0x800 len:0x4A
192.168.158.139 -&gt; 174.137.42.77 ICMP TTL:128 TOS:0x0 ID:55107 IpLen:20 DgmLen:60
Type:8  Code:0  ID:512   Seq:8448  ECHO

</span>snort.raw[32]:
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
61 62 63 64 65 66 67 68  69 6A 6B 6C 6D 6E 6F 70  abcdefgh ijklmnop
71 72 73 74 75 76 77 61  62 63 64 65 66 67 68 69  qrstuvwa bcdefghi
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

06/19-08:45:57.055699 [*<span class="hljs-strong">*] [1:1000001:1] "ICMP test" [*</span><span class="hljs-strong">*] [Classification: Generic ICMP event] [Priority: 3] {ICMP} 174.137.42.77 -&gt; 192.168.158.139
00:50:56:E0:14:49 -&gt; 00:0C:29:34:0B:DE type:0x800 len:0x4A
174.137.42.77 -&gt; 192.168.158.139 ICMP TTL:128 TOS:0x0 ID:30433 IpLen:20 DgmLen:60
Type:0  Code:0  ID:512  Seq:8448  ECHO REPLY

</span>snort.raw[32]:
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
61 62 63 64 65 66 67 68  69 6A 6B 6C 6D 6E 6F 70  abcdefgh ijklmnop
71 72 73 74 75 76 77 61  62 63 64 65 66 67 68 69  qrstuvwa bcdefghi
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

06/19-08:45:57.840049 [*<span class="hljs-strong">*] [1:1000001:1] "ICMP test" [*</span><span class="hljs-strong">*] [Classification: Generic ICMP event] [Priority: 3] {ICMP} 192.168.158.139 -&gt; 174.137.42.77
00:0C:29:34:0B:DE -&gt; 00:50:56:E0:14:49 type:0x800 len:0x4A
192.168.158.139 -&gt; 174.137.42.77 ICMP TTL:128 TOS:0x0 ID:55110 IpLen:20 DgmLen:60
Type:8  Code:0  ID:512   Seq:8704  ECHO

</span>snort.raw[32]:
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
61 62 63 64 65 66 67 68  69 6A 6B 6C 6D 6E 6F 70  abcdefgh ijklmnop
71 72 73 74 75 76 77 61  62 63 64 65 66 67 68 69  qrstuvwa bcdefghi
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

06/19-08:45:58.044196 [*<span class="hljs-strong">*] [1:1000001:1] "ICMP test" [*</span><span class="hljs-strong">*] [Classification: Generic ICMP event] [Priority: 3] {ICMP} 174.137.42.77 -&gt; 192.168.158.139
00:50:56:E0:14:49 -&gt; 00:0C:29:34:0B:DE type:0x800 len:0x4A
174.137.42.77 -&gt; 192.168.158.139 ICMP TTL:128 TOS:0x0 ID:30436 IpLen:20 DgmLen:60
Type:0  Code:0  ID:512  Seq:8704  ECHO REPLY

</span>snort.raw[32]:
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
61 62 63 64 65 66 67 68  69 6A 6B 6C 6D 6E 6F 70  abcdefgh ijklmnop
71 72 73 74 75 76 77 61  62 63 64 65 66 67 68 69  qrstuvwa bcdefghi
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

06/19-08:45:58.841168 [*<span class="hljs-strong">*] [1:1000001:1] "ICMP test" [*</span><span class="hljs-strong">*] [Classification: Generic ICMP event] [Priority: 3] {ICMP} 192.168.158.139 -&gt; 174.137.42.77
00:0C:29:34:0B:DE -&gt; 00:50:56:E0:14:49 type:0x800 len:0x4A
192.168.158.139 -&gt; 174.137.42.77 ICMP TTL:128 TOS:0x0 ID:55113 IpLen:20 DgmLen:60
Type:8  Code:0  ID:512   Seq:8960  ECHO

</span>snort.raw[32]:
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
61 62 63 64 65 66 67 68  69 6A 6B 6C 6D 6E 6F 70  abcdefgh ijklmnop
71 72 73 74 75 76 77 61  62 63 64 65 66 67 68 69  qrstuvwa bcdefghi
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

06/19-08:45:59.085428 [*<span class="hljs-strong">*] [1:1000001:1] "ICMP test" [*</span><span class="hljs-strong">*] [Classification: Generic ICMP event] [Priority: 3] {ICMP} 174.137.42.77 -&gt; 192.168.158.139
00:50:56:E0:14:49 -&gt; 00:0C:29:34:0B:DE type:0x800 len:0x4A
174.137.42.77 -&gt; 192.168.158.139 ICMP TTL:128 TOS:0x0 ID:30448 IpLen:20 DgmLen:60
Type:0  Code:0  ID:512  Seq:8960  ECHO REPLY

</span>snort.raw[32]:
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
61 62 63 64 65 66 67 68  69 6A 6B 6C 6D 6E 6F 70  abcdefgh ijklmnop
71 72 73 74 75 76 77 61  62 63 64 65 66 67 68 69  qrstuvwa bcdefghi
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

06/19-08:45:59.841775 [*<span class="hljs-strong">*] [1:1000001:1] "ICMP test" [*</span><span class="hljs-strong">*] [Classification: Generic ICMP event] [Priority: 3] {ICMP} 192.168.158.139 -&gt; 174.137.42.77
00:0C:29:34:0B:DE -&gt; 00:50:56:E0:14:49 type:0x800 len:0x4A
192.168.158.139 -&gt; 174.137.42.77 ICMP TTL:128 TOS:0x0 ID:55118 IpLen:20 DgmLen:60
Type:8  Code:0  ID:512   Seq:9216  ECHO

</span>snort.raw[32]:
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
61 62 63 64 65 66 67 68  69 6A 6B 6C 6D 6E 6F 70  abcdefgh ijklmnop
71 72 73 74 75 76 77 61  62 63 64 65 66 67 68 69  qrstuvwa bcdefghi
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

06/19-08:46:00.042354 [*<span class="hljs-strong">*] [1:1000001:1] "ICMP test" [*</span><span class="hljs-strong">*] [Classification: Generic ICMP event] [Priority: 3] {ICMP} 174.137.42.77 -&gt; 192.168.158.139
00:50:56:E0:14:49 -&gt; 00:0C:29:34:0B:DE type:0x800 len:0x4A
174.137.42.77 -&gt; 192.168.158.139 ICMP TTL:128 TOS:0x0 ID:30453 IpLen:20 DgmLen:60
Type:0  Code:0  ID:512  Seq:9216  ECHO REPLY

</span>snort.raw[32]:
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
61 62 63 64 65 66 67 68  69 6A 6B 6C 6D 6E 6F 70  abcdefgh ijklmnop
71 72 73 74 75 76 77 61  62 63 64 65 66 67 68 69  qrstuvwa bcdefghi
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

<span class="hljs-bullet">-- </span>[0] /home/htb-student/pcaps/icmp.pcap
<span class="hljs-code">--------------------------------------------------
Packet Statistics
--------------------------------------------------</span>
daq
<span class="hljs-code">                   pcaps: 1</span>
<span class="hljs-code">                received: 8</span>
<span class="hljs-code">                analyzed: 8</span>
<span class="hljs-code">                   allow: 8</span>
<span class="hljs-section">                rx_bytes: 592
--------------------------------------------------</span>
codec
<span class="hljs-code">                   total: 8            (100.000%)</span>
<span class="hljs-code">                     eth: 8            (100.000%)</span>
<span class="hljs-code">                   icmp4: 8            (100.000%)</span>
<span class="hljs-section">                    ipv4: 8            (100.000%)
--------------------------------------------------</span>
<span class="hljs-section">Module Statistics
--------------------------------------------------</span>
appid
<span class="hljs-code">                 packets: 8</span>
<span class="hljs-code">       processed_packets: 8</span>
<span class="hljs-section">          total_sessions: 1
--------------------------------------------------</span>
binder
<span class="hljs-code">               new_flows: 1</span>
<span class="hljs-section">                inspects: 1
--------------------------------------------------</span>
detection
<span class="hljs-code">                analyzed: 8</span>
<span class="hljs-code">              hard_evals: 8</span>
<span class="hljs-code">                  alerts: 8</span>
<span class="hljs-code">            total_alerts: 8</span>
<span class="hljs-section">                  logged: 8
--------------------------------------------------</span>
port<span class="hljs-emphasis">_scan
                 packets: 8
                trackers: 2
--------------------------------------------------
search_</span>engine
<span class="hljs-section">        qualified_events: 8
--------------------------------------------------</span>
stream
<span class="hljs-section">                   flows: 1
--------------------------------------------------</span>
stream<span class="hljs-emphasis">_icmp
                sessions: 1
                     max: 1
                 created: 1
                released: 1
--------------------------------------------------
Summary Statistics
--------------------------------------------------
timing
                 runtime: 00:00:00
                 seconds: 0.042473
                pkts/sec: 188
o")~   Snort exiting</span>
</code></pre>
<h3 id="snort-key-features">Snort Key Features</h3>
<p>Key features that bolster Snort&#39;s effectiveness include:</p>
<ul>
<li>Deep packet inspection, packet capture, and logging</li>
<li>Intrusion detection</li>
<li>Network Security Monitoring</li>
<li>Anomaly detection</li>
<li>Support for multiple tenants</li>
<li>Both IPv6 and IPv4 are supported</li>
</ul>
<h2 id="snort-rule-development">Snort Rule Development</h2>
<p>A Snort rule, at its core, is a powerful tool that we use to identify and flag potential malicious activity in network traffic.</p>
<p>As already discussed, Snort rules resemble Suricata rules. They are composed of a <code>rule header</code> and <code>rule options</code>. Even though Snort rules share similarities with Suricata rules, we strongly suggest studying Snort rule writing from the following resources: <a href="https://docs.snort.org/">https://docs.snort.org/</a>, <a href="https://docs.suricata.io/en/latest/rules/differences-from-snort.html">https://docs.suricata.io/en/latest/rules/differences-from-snort.html</a>.</p>
<p>Let&#39;s now navigate to the bottom of this section and click on &quot;Click here to spawn the target system!&quot;. Then, let&#39;s SSH into the Target IP using the provided credentials. The vast majority of the commands covered from this point up to end of this section can be replicated inside the target, offering a more comprehensive grasp of the topics presented.</p>
<p>Let&#39;s move forward and explore some examples of crafting Snort rules to counter real-world malware threats.</p>
<h3 id="snort-rule-development-example-1-detecting-ursnif-inefficiently-">Snort Rule Development Example 1: Detecting Ursnif (Inefficiently)</h3>
<p>Snort Rule Development</p>
<pre><code class="lang-shell-session">alert tcp any any -&gt; any any (msg:<span class="hljs-string">"Possible Ursnif C2 Activity"</span>; flow:established,to_server; <span class="hljs-attribute">content</span>:<span class="hljs-string">"/images/"</span>, depth <span class="hljs-number">12</span>; <span class="hljs-attribute">content</span>:<span class="hljs-string">"_2F"</span>; <span class="hljs-attribute">content</span>:<span class="hljs-string">"_2B"</span>; <span class="hljs-attribute">content</span>:<span class="hljs-string">"User-Agent|3a 20|Mozilla/4.0 (compatible|3b| MSIE 8.0|3b| Windows NT"</span>; <span class="hljs-attribute">content</span>:!<span class="hljs-string">"Accept"</span>; <span class="hljs-attribute">content</span>:!<span class="hljs-string">"Cookie|3a|"</span>; <span class="hljs-attribute">content</span>:!<span class="hljs-string">"Referer|3a|"</span>; sid:<span class="hljs-number">1000002</span>; rev:<span class="hljs-number">1</span>;)
</code></pre>
<p>The Snort rule above is designed to detect certain variations of <a href="https://www.fortinet.com/blog/threat-research/ursnif-variant-spreading-word-document">Ursnif</a> malware. The rule is inefficient since it misses HTTP sticky buffers. Let&#39;s break down the important parts of this rule to understand its workings.</p>
<ul>
<li><code>flow:established,to_server;</code> ensures that this rule only matches established TCP connections where data is flowing from the client to the server.</li>
<li><code>content:&quot;/images/&quot;, depth 12;</code> instructs Snort to look for the string <code>/images/</code> within the first <code>12</code> bytes of the packet payload.</li>
<li><code>content:&quot;_2F&quot;;</code> and <code>content:&quot;_2B&quot;;</code> direct Snort to search for the strings <code>_2F</code> and <code>_2B</code> anywhere in the payload.</li>
<li><code>content:&quot;User-Agent|3a 20|Mozilla/4.0 (compatible|3b| MSIE 8.0|3b| Windows NT&quot;;</code> is looking for a specific <code>User-Agent</code>. The <code>|3a 20|</code> and <code>|3b|</code> in the rule are hexadecimal representations of the <code>:</code> and <code>;</code> characters respectively.</li>
<li><code>content:!&quot;Accept&quot;; content:!&quot;Cookie|3a|&quot;; content:!&quot;Referer|3a|&quot;;</code> look for the absence of certain standard HTTP headers, such as <code>Accept</code>, <code>Cookie:</code> and <code>Referer:</code>. The <code>!</code> indicates negation.</li>
</ul>
<p>The above rule is already incorporated in the <code>local.rules</code> file found in the <code>/home/htb-student</code> directory of this section&#39;s target. To test it, first, you need to uncomment the rule. Then, execute Snort on the <code>ursnif.pcap</code> file, which is located in the <code>/home/htb-student/pcaps</code> directory.</p>
<p>Snort Rule Development</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq -R /home/htb-student/local.rules -r /home/htb-student/pcaps/ursnif.pcap -A cmg
<span class="hljs-code">--------------------------------------------------
o")~   Snort++ 3.1.64.0
--------------------------------------------------</span>
Loading /root/snorty/etc/snort/snort.lua:
Loading snort<span class="hljs-emphasis">_defaults.lua:
Finished snort_</span>defaults.lua:
<span class="hljs-code">        hosts</span>
---SNIP---
<span class="hljs-code">        host_tracker</span>
Finished /root/snorty/etc/snort/snort.lua:
Loading file<span class="hljs-emphasis">_id.rules_</span>file:
Loading file<span class="hljs-emphasis">_magic.rules:
Finished file_</span>magic.rules:
Finished file<span class="hljs-emphasis">_id.rules_</span>file:
Loading /home/htb-student/local.rules:
Finished /home/htb-student/local.rules:
Loading rule args:
Loading /home/htb-student/local.rules:
Finished /home/htb-student/local.rules:
<span class="hljs-section">Finished rule args:
--------------------------------------------------</span>
ips policies rule stats
<span class="hljs-code">              id  loaded  shared enabled    file</span>
<span class="hljs-section">               0     210       2     210    /root/snorty/etc/snort/snort.lua
--------------------------------------------------</span>
rule counts
<span class="hljs-code">       total rules loaded: 210</span>
<span class="hljs-code">          duplicate rules: 2</span>
<span class="hljs-code">               text rules: 210</span>
<span class="hljs-code">            option chains: 210</span>
<span class="hljs-section">            chain headers: 5
--------------------------------------------------</span>
port rule counts
<span class="hljs-code">             tcp     udp    icmp      ip</span>
<span class="hljs-code">     any       1       0       1       0</span>
<span class="hljs-section">   total       1       0       1       0
--------------------------------------------------</span>
service rule counts          to-srv  to-cli
<span class="hljs-code">                  file_id:      208     208</span>
<span class="hljs-section">                    total:      208     208
--------------------------------------------------</span>
fast pattern groups
<span class="hljs-code">                      any: 2</span>
<span class="hljs-code">                to_server: 1</span>
<span class="hljs-section">                to_client: 1
--------------------------------------------------</span>
search engine (ac<span class="hljs-emphasis">_bnfa)
                instances: 3
                 patterns: 417
            pattern chars: 2566
               num states: 1836
         num match states: 371
             memory scale: KB
             total memory: 70.9639
           pattern memory: 18.792
        match list memory: 27.8125
        transition memory: 23.9844
appid: MaxRss diff: 3024
appid: patterns loaded: 300
--------------------------------------------------
pcap DAQ configured to read-file.
Commencing packet processing
++ [0] /home/htb-student/pcaps/ursnif.pcap
07/21-19:27:47.161230 [**] [1:1000002:1] "Possible Ursnif C2 Activity" [**] [Priority: 0] {TCP} 10.10.10.104:49191 -&gt; 192.42.116.41:80
00:1F:E2:10:8B:C9 -&gt; 00:0C:29:C9:67:00 type:0x800 len:0x18C
10.10.10.104:49191 -&gt; 192.42.116.41:80 TCP TTL:128 TOS:0x0 ID:20640 IpLen:20 DgmLen:382 DF
***AP*** Seq: 0x12E06BB  Ack: 0xE061E225  Win: 0x4029  TcpLen: 20

</span>snort.raw[342]:
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
47 45 54 20 2F 69 6D 61  67 65 73 2F 70 32 52 55  GET /ima ges/p2RU
52 68 5F 32 2F 42 6B 32  76 72 31 4F 59 52 46 31  Rh<span class="hljs-emphasis">_2/Bk2 vr1OYRF1
57 47 75 35 6E 67 5F 32  46 73 66 73 2F 57 4F 57  WGu5ng_</span>2 Fsfs/WOW
72 47 54 45 54 79 4B 2F  37 4D 7A 4D 5F 32 42 6E  rGTETyK/ 7MzM<span class="hljs-emphasis">_2Bn
47 5A 51 52 32 6A 73 67  50 2F 73 5F 32 42 70 53  GZQR2jsg P/s_</span>2BpS
34 31 4B 37 41 67 2F 4F  75 4A 6A 51 66 41 61 63  41K7Ag/O uJjQfAac
32 64 2F 76 6D 46 5F 32  46 31 4B 42 50 72 4B 5F  2d/vmF<span class="hljs-emphasis">_2 F1KBPrK_</span>
32 2F 46 36 36 38 32 64  67 64 69 61 47 31 7A 75  2/F6682d gdiaG1zu
56 43 7A 37 47 68 64 2F  62 4C 37 36 57 66 35 71  VCz7Ghd/ bL76Wf5q
64 71 77 56 35 76 7A 52  2F 32 65 31 41 38 79 42  dqwV5vzR /2e1A8yB
49 64 6B 6D 49 5F 32 42  2F 6F 67 79 7A 4E 55 57  IdkmI<span class="hljs-emphasis">_2B /ogyzNUW
33 47 72 2F 67 4B 42 5A  57 58 78 2E 67 69 66 20  3Gr/gKBZ WXx.gif
48 54 54 50 2F 31 2E 31  0D 0A 55 73 65 72 2D 41  HTTP/1.1 ..User-A
67 65 6E 74 3A 20 4D 6F  7A 69 6C 6C 61 2F 34 2E  gent: Mo zilla/4.
30 20 28 63 6F 6D 70 61  74 69 62 6C 65 3B 20 4D  0 (compa tible; M
53 49 45 20 38 2E 30 3B  20 57 69 6E 64 6F 77 73  SIE 8.0;  Windows
20 4E 54 20 36 2E 31 29  0D 0A 48 6F 73 74 3A 20   NT 6.1) ..Host:
62 6C 75 65 77 61 74 65  72 73 74 6F 6E 65 2E 72  bluewate rstone.r
75 0D 0A 43 6F 6E 6E 65  63 74 69 6F 6E 3A 20 4B  u..Conne ction: K
65 65 70 2D 41 6C 69 76  65 0D 0A 43 61 63 68 65  eep-Aliv e..Cache
2D 43 6F 6E 74 72 6F 6C  3A 20 6E 6F 2D 63 61 63  -Control : no-cac
68 65 0D 0A 0D 0A                                 he....
- - - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

</span><span class="hljs-bullet">-- </span>[0] /home/htb-student/pcaps/ursnif.pcap
<span class="hljs-code">--------------------------------------------------
Packet Statistics
--------------------------------------------------</span>
daq
<span class="hljs-code">                    pcaps: 1</span>
<span class="hljs-code">                 received: 49</span>
<span class="hljs-code">                 analyzed: 49</span>
<span class="hljs-code">                    allow: 49</span>
<span class="hljs-section">                 rx_bytes: 5925
--------------------------------------------------</span>
codec
<span class="hljs-code">                    total: 49           (100.000%)</span>
<span class="hljs-code">                      eth: 49           (100.000%)</span>
<span class="hljs-code">                     ipv4: 49           (100.000%)</span>
<span class="hljs-code">                      tcp: 16           ( 32.653%)</span>
<span class="hljs-section">                      udp: 33           ( 67.347%)
--------------------------------------------------</span>
<span class="hljs-section">Module Statistics
--------------------------------------------------</span>
appid
<span class="hljs-code">                  packets: 49</span>
<span class="hljs-code">        processed_packets: 49</span>
<span class="hljs-code">           total_sessions: 15</span>
<span class="hljs-code">       service_cache_adds: 5</span>
<span class="hljs-code">             bytes_in_use: 760</span>
<span class="hljs-section">             items_in_use: 5
--------------------------------------------------</span>
back<span class="hljs-emphasis">_orifice
                  packets: 33
--------------------------------------------------
binder
                new_</span>flows: 12
<span class="hljs-code">          service_changes: 2</span>
<span class="hljs-section">                 inspects: 12
--------------------------------------------------</span>
detection
<span class="hljs-code">                 analyzed: 49</span>
<span class="hljs-code">             raw_searches: 2</span>
<span class="hljs-code">          cooked_searches: 1</span>
<span class="hljs-code">             pkt_searches: 3</span>
<span class="hljs-code">            file_searches: 1</span>
<span class="hljs-code">                   alerts: 1</span>
<span class="hljs-code">             total_alerts: 1</span>
<span class="hljs-section">                   logged: 1
--------------------------------------------------</span>
dns
<span class="hljs-code">                  packets: 19</span>
<span class="hljs-code">                 requests: 12</span>
<span class="hljs-section">                responses: 7
--------------------------------------------------</span>
file<span class="hljs-emphasis">_id
              total_</span>files: 1
<span class="hljs-code">          total_file_data: 304</span>
<span class="hljs-section">     max_concurrent_files: 1
--------------------------------------------------</span>
http<span class="hljs-emphasis">_inspect
                    flows: 2
                    scans: 9
              reassembles: 9
              inspections: 9
                 requests: 2
                responses: 2
             get_</span>requests: 1
<span class="hljs-code">            post_requests: 1</span>
<span class="hljs-code">           request_bodies: 1</span>
<span class="hljs-code">  max_concurrent_sessions: 2</span>
<span class="hljs-section">              total_bytes: 1603
--------------------------------------------------</span>
port<span class="hljs-emphasis">_scan
                  packets: 49
                 trackers: 7
--------------------------------------------------
search_</span>engine
<span class="hljs-code">               max_queued: 1</span>
<span class="hljs-code">            total_flushed: 2</span>
<span class="hljs-code">            total_inserts: 2</span>
<span class="hljs-code">             total_unique: 2</span>
<span class="hljs-code">     non_qualified_events: 1</span>
<span class="hljs-code">         qualified_events: 1</span>
<span class="hljs-section">           searched_bytes: 2192
--------------------------------------------------</span>
stream
<span class="hljs-code">                    flows: 12</span>
<span class="hljs-code">             total_prunes: 7</span>
<span class="hljs-section">idle_prunes_proto_timeout: 7
--------------------------------------------------</span>
stream<span class="hljs-emphasis">_tcp
                 sessions: 2
                      max: 2
                  created: 2
                 released: 2
             instantiated: 2
                   setups: 2
                 restarts: 2
             syn_</span>trackers: 2
<span class="hljs-code">              segs_queued: 4</span>
<span class="hljs-code">            segs_released: 4</span>
<span class="hljs-code">                segs_used: 4</span>
<span class="hljs-code">          rebuilt_packets: 9</span>
<span class="hljs-code">            rebuilt_bytes: 1627</span>
<span class="hljs-code">                     syns: 2</span>
<span class="hljs-code">                 syn_acks: 2</span>
<span class="hljs-code">                   resets: 2</span>
<span class="hljs-code">                 max_segs: 1</span>
<span class="hljs-section">                max_bytes: 981
--------------------------------------------------</span>
stream<span class="hljs-emphasis">_udp
                 sessions: 10
                      max: 10
                  created: 13
                 released: 13
                 timeouts: 3
              total_</span>bytes: 1964
<span class="hljs-code">--------------------------------------------------
wizard
                tcp_scans: 2
                 tcp_hits: 2
                udp_scans: 3
               udp_misses: 3
--------------------------------------------------</span>
<span class="hljs-section">Appid Statistics
--------------------------------------------------</span>
detected apps and services
<span class="hljs-code">              Application: Services   Clients    Users      Payloads   Misc       Referred</span>
<span class="hljs-section">                  unknown: 11         9          0          2          0          0
--------------------------------------------------</span>
<span class="hljs-section">Summary Statistics
--------------------------------------------------</span>
timing
<span class="hljs-code">                  runtime: 00:00:00</span>
<span class="hljs-code">                  seconds: 0.039200</span>
<span class="hljs-code">                 pkts/sec: 1250</span>
<span class="hljs-code">                Mbits/sec: 1</span>
o")~   Snort exiting
</code></pre>
<p>Invest some time in scrutinizing both the <code>ursnif.pcap</code> file using <code>Wireshark</code> and this rule to comprehend how it works.</p>
<p>We can download the PCAP file into the current directory of either Pwnbox or our own VM as follows.</p>
<p>Snort Rule Development</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ scp htb-student@[TARGET IP]:/home</span><span class="hljs-regexp">/htb-student/pcaps</span><span class="hljs-regexp">/ursnif.pcap .</span>
</code></pre>
<h3 id="snort-rule-development-example-2-detecting-cerber">Snort Rule Development Example 2: Detecting Cerber</h3>
<p>Snort Rule Development</p>
<pre><code class="lang-shell-session">alert udp <span class="hljs-variable">$HOME_NET</span> any -&gt; <span class="hljs-variable">$EXTERNAL_NET</span> any (msg:<span class="hljs-string">"Possible Cerber Check-in"</span>; dsize:<span class="hljs-number">9</span>; <span class="hljs-attribute">content</span>:<span class="hljs-string">"hi"</span>, depth <span class="hljs-number">2</span>, fast_pattern; pcre:<span class="hljs-string">"/^[af0-9]{7}$/R"</span>; detection_filter:track by_src, count <span class="hljs-number">1</span>, seconds <span class="hljs-number">60</span>; sid:<span class="hljs-number">2816763</span>; rev:<span class="hljs-number">4</span>;)
</code></pre>
<p>The Snort rule above is designed to detect certain variations of <a href="https://blog.checkpoint.com/research/14959/">Cerber</a> malware. Let&#39;s break down the important parts of this rule to understand its workings.</p>
<ul>
<li><code>$HOME_NET any -&gt; $EXTERNAL_NET any</code> signifies the rule applies to any <code>UDP</code> traffic going from any port in the home network to any port on external networks.</li>
<li><code>dsize:9;</code>: This is a condition that restricts the rule to UDP datagrams that have a payload data size of exactly <code>9</code> bytes.</li>
<li><code>content:&quot;hi&quot;, depth 2, fast_pattern;</code>: This checks the payload&#39;s first <code>2</code> bytes for the string <code>hi</code>. The <code>fast_pattern</code> modifier makes the pattern matcher search for this pattern before any others in the rule, optimizing the rule&#39;s performance.</li>
<li><code>pcre:&quot;/^[af0-9]{7}$/R&quot;;</code>: This stands for Perl Compatible Regular Expressions. The rule is looking for seven hexadecimal characters (from the set <code>a-f</code> and <code>0-9</code>) starting at the beginning of the payload (after the <code>hi</code>), and this should be the complete payload (signified by the <code>$</code> end anchor).</li>
<li><code>detection_filter:track by_src, count 1, seconds 60;</code>: The <code>detection_filter</code> keyword in Snort rule language is used to suppress alerts unless a certain threshold of matched events occurs within a specified time frame. In this rule, the filter is set to track by source IP (<code>by_src</code>), with a count of <code>1</code> and within a time frame of <code>60</code> seconds. This means that the rule will trigger an alert only if it matches more than one event (specifically, more than count events which is <code>1</code> here) from the same source IP address within <code>60</code> seconds.</li>
</ul>
<p>The above rule is already incorporated in the <code>local.rules</code> file found in the <code>/home/htb-student</code> directory of this section&#39;s target. To test it, first, you need to uncomment the rule. Then, execute Snort on the <code>cerber.pcap</code> file, which is located in the <code>/home/htb-student/pcaps</code> directory.</p>
<p>Snort Rule Development</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq -R /home/htb-student/local.rules -r /home/htb-student/pcaps/cerber.pcap -A cmg
<span class="hljs-code">--------------------------------------------------
o")~   Snort++ 3.1.64.0
--------------------------------------------------</span>
Loading /root/snorty/etc/snort/snort.lua:
Loading snort<span class="hljs-emphasis">_defaults.lua:
Finished snort_</span>defaults.lua:
<span class="hljs-code">        output</span>
---SNIP---
<span class="hljs-code">        trace</span>
Finished /root/snorty/etc/snort/snort.lua:
Loading file<span class="hljs-emphasis">_id.rules_</span>file:
Loading file<span class="hljs-emphasis">_magic.rules:
Finished file_</span>magic.rules:
Finished file<span class="hljs-emphasis">_id.rules_</span>file:
Loading /home/htb-student/local.rules:
Finished /home/htb-student/local.rules:
Loading rule args:
Loading /home/htb-student/local.rules:
Finished /home/htb-student/local.rules:
<span class="hljs-section">Finished rule args:
--------------------------------------------------</span>
ips policies rule stats
<span class="hljs-code">              id  loaded  shared enabled    file</span>
<span class="hljs-section">               0     210       2     210    /root/snorty/etc/snort/snort.lua
--------------------------------------------------</span>
rule counts
<span class="hljs-code">       total rules loaded: 210</span>
<span class="hljs-code">          duplicate rules: 2</span>
<span class="hljs-code">               text rules: 210</span>
<span class="hljs-code">            option chains: 210</span>
<span class="hljs-section">            chain headers: 5
--------------------------------------------------</span>
port rule counts
<span class="hljs-code">             tcp     udp    icmp      ip</span>
<span class="hljs-code">     any       0       1       1       0</span>
<span class="hljs-section">   total       0       1       1       0
--------------------------------------------------</span>
service rule counts          to-srv  to-cli
<span class="hljs-code">                  file_id:      208     208</span>
<span class="hljs-section">                    total:      208     208
--------------------------------------------------</span>
fast pattern groups
<span class="hljs-code">                      any: 2</span>
<span class="hljs-code">                to_server: 1</span>
<span class="hljs-section">                to_client: 1
--------------------------------------------------</span>
search engine (ac<span class="hljs-emphasis">_bnfa)
                instances: 3
                 patterns: 417
            pattern chars: 2511
               num states: 1781
         num match states: 371
             memory scale: KB
             total memory: 69.8359
           pattern memory: 18.7383
        match list memory: 27.3828
        transition memory: 23.3398
appid: MaxRss diff: 3024
appid: patterns loaded: 300
--------------------------------------------------
pcap DAQ configured to read-file.
Commencing packet processing
++ [0] /home/htb-student/pcaps/cerber.pcap
07/22-02:17:56.486663 [**] [1:2816763:4] "Possible Cerber Check-in" [**] [Priority: 0] {UDP} 10.0.2.15:1046 -&gt; 31.184.234.1:6892
08:00:27:A9:8C:97 -&gt; 52:54:00:12:35:02 type:0x800 len:0x3C
10.0.2.15:1046 -&gt; 31.184.234.1:6892 UDP TTL:128 TOS:0x0 ID:83 IpLen:20 DgmLen:37
Len: 9

</span>snort.raw[9]:
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
68 69 30 30 37 32 38 39  35                       hi007289 5
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

07/22-02:17:56.486795 [*<span class="hljs-strong">*] [1:2816763:4] "Possible Cerber Check-in" [*</span><span class="hljs-strong">*] [Priority: 0] {UDP} 10.0.2.15:1046 -&gt; 31.184.234.2:6892
08:00:27:A9:8C:97 -&gt; 52:54:00:12:35:02 type:0x800 len:0x3C
10.0.2.15:1046 -&gt; 31.184.234.2:6892 UDP TTL:128 TOS:0x0 ID:84 IpLen:20 DgmLen:37
Len: 9

</span>snort.raw[9]:
<span class="hljs-bullet">- </span>- - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
68 69 30 30 37 32 38 39  35                       hi007289 5
---SNIP---
<span class="hljs-bullet">-- </span>[0] /home/htb-student/pcaps/cerber.pcap
<span class="hljs-code">--------------------------------------------------
Packet Statistics
--------------------------------------------------</span>
daq
<span class="hljs-code">                    pcaps: 1</span>
<span class="hljs-code">                 received: 1035</span>
<span class="hljs-code">                 analyzed: 1035</span>
<span class="hljs-code">                    allow: 1035</span>
<span class="hljs-section">                 rx_bytes: 65672
--------------------------------------------------</span>
codec
<span class="hljs-code">                    total: 1035         (100.000%)</span>
<span class="hljs-code">                      eth: 1035         (100.000%)</span>
<span class="hljs-code">                     ipv4: 1035         (100.000%)</span>
<span class="hljs-code">                      tcp: 9            (  0.870%)</span>
<span class="hljs-section">                      udp: 1026         ( 99.130%)
--------------------------------------------------</span>
<span class="hljs-section">Module Statistics
--------------------------------------------------</span>
appid
<span class="hljs-code">                  packets: 1035</span>
<span class="hljs-code">        processed_packets: 1035</span>
<span class="hljs-code">           total_sessions: 1026</span>
<span class="hljs-code">       service_cache_adds: 514</span>
<span class="hljs-code">             bytes_in_use: 78128</span>
<span class="hljs-section">             items_in_use: 514
--------------------------------------------------</span>
back<span class="hljs-emphasis">_orifice
                  packets: 514
--------------------------------------------------
binder
                new_</span>flows: 1026
<span class="hljs-code">          service_changes: 1</span>
<span class="hljs-section">                 inspects: 1026
--------------------------------------------------</span>
detection
<span class="hljs-code">                 analyzed: 1035</span>
<span class="hljs-code">             raw_searches: 1026</span>
<span class="hljs-code">             pkt_searches: 1026</span>
<span class="hljs-code">            file_searches: 1</span>
<span class="hljs-code">                   alerts: 511</span>
<span class="hljs-code">             total_alerts: 511</span>
<span class="hljs-section">                   logged: 511
--------------------------------------------------</span>
dns
<span class="hljs-code">                  packets: 2</span>
<span class="hljs-code">                 requests: 1</span>
<span class="hljs-section">                responses: 1
--------------------------------------------------</span>
file<span class="hljs-emphasis">_id
              total_</span>files: 1
<span class="hljs-code">          total_file_data: 164</span>
<span class="hljs-section">     max_concurrent_files: 1
--------------------------------------------------</span>
http<span class="hljs-emphasis">_inspect
                    flows: 1
                    scans: 5
              reassembles: 5
              inspections: 5
                 requests: 1
                responses: 1
             get_</span>requests: 1
<span class="hljs-code">  max_concurrent_sessions: 1</span>
<span class="hljs-section">              total_bytes: 462
--------------------------------------------------</span>
pcre
<span class="hljs-code">               pcre_rules: 2</span>
<span class="hljs-section">              pcre_native: 2
--------------------------------------------------</span>
port<span class="hljs-emphasis">_scan
                  packets: 1035
                 trackers: 516
--------------------------------------------------
search_</span>engine
<span class="hljs-code">               max_queued: 1</span>
<span class="hljs-code">            total_flushed: 512</span>
<span class="hljs-code">            total_inserts: 512</span>
<span class="hljs-code">             total_unique: 512</span>
<span class="hljs-code">     non_qualified_events: 1</span>
<span class="hljs-code">         qualified_events: 511</span>
<span class="hljs-section">           searched_bytes: 17146
--------------------------------------------------</span>
stream
<span class="hljs-section">                    flows: 1026
--------------------------------------------------</span>
stream<span class="hljs-emphasis">_tcp
                 sessions: 1
                      max: 1
                  created: 1
                 released: 1
             instantiated: 1
                   setups: 1
                 restarts: 1
             syn_</span>trackers: 1
<span class="hljs-code">              segs_queued: 2</span>
<span class="hljs-code">            segs_released: 2</span>
<span class="hljs-code">                segs_used: 2</span>
<span class="hljs-code">          rebuilt_packets: 5</span>
<span class="hljs-code">            rebuilt_bytes: 474</span>
<span class="hljs-code">                     syns: 1</span>
<span class="hljs-code">                 syn_acks: 1</span>
<span class="hljs-code">                     fins: 1</span>
<span class="hljs-code">                 max_segs: 1</span>
<span class="hljs-section">                max_bytes: 435
--------------------------------------------------</span>
stream<span class="hljs-emphasis">_udp
                 sessions: 1025
                      max: 1025
                  created: 1025
                 released: 1025
              total_</span>bytes: 16982
<span class="hljs-code">--------------------------------------------------
wizard
                tcp_scans: 1
                 tcp_hits: 1
                udp_scans: 1024
               udp_misses: 1024
--------------------------------------------------</span>
<span class="hljs-section">Appid Statistics
--------------------------------------------------</span>
detected apps and services
<span class="hljs-code">              Application: Services   Clients    Users      Payloads   Misc       Referred</span>
<span class="hljs-section">                  unknown: 2          1          0          1          0          0
--------------------------------------------------</span>
<span class="hljs-section">Summary Statistics
--------------------------------------------------</span>
timing
<span class="hljs-code">                  runtime: 00:01:11</span>
<span class="hljs-code">                  seconds: 71.153373</span>
<span class="hljs-code">                 pkts/sec: 15</span>
o")~   Snort exiting
</code></pre>
<p>Invest some time in scrutinizing both the <code>cerber.pcap</code> file using <code>Wireshark</code> and this rule to comprehend how it works.</p>
<p>We can download the PCAP file into the current directory of either Pwnbox or our own VM as follows.</p>
<p>Snort Rule Development</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ scp htb-student@[TARGET IP]:/home</span><span class="hljs-regexp">/htb-student/pcaps</span><span class="hljs-regexp">/cerber.pcap .</span>
</code></pre>
<h3 id="snort-rule-development-example-3-detecting-patchwork">Snort Rule Development Example 3: Detecting Patchwork</h3>
<p>Snort Rule Development</p>
<pre><code class="lang-shell-session">alert http <span class="hljs-variable">$HOME_NET</span> any -&gt; <span class="hljs-variable">$EXTERNAL_NET</span> any (msg:<span class="hljs-string">"OISF TROJAN Targeted AutoIt FileStealer/Downloader CnC Beacon"</span>; flow:established,to_server; http_method; <span class="hljs-attribute">content</span>:<span class="hljs-string">"POST"</span>; http_uri; <span class="hljs-attribute">content</span>:<span class="hljs-string">".php?profile="</span>; http_client_body; <span class="hljs-attribute">content</span>:<span class="hljs-string">"ddager="</span>, depth <span class="hljs-number">7</span>; http_client_body; <span class="hljs-attribute">content</span>:<span class="hljs-string">"&amp;r1="</span>, distance <span class="hljs-number">0</span>; http_header; <span class="hljs-attribute">content</span>:!<span class="hljs-string">"Accept"</span>; http_header; <span class="hljs-attribute">content</span>:!<span class="hljs-string">"Referer|3a|"</span>; sid:<span class="hljs-number">10000006</span>; rev:<span class="hljs-number">1</span>;)
</code></pre>
<p>The Snort rule above is designed to detect certain variations of malware used by the <a href="https://paper.seebug.org/papers/APT/APT\_CyberCriminal\_Campagin/2016/2016.07.07.UNVEILING\_PATCHWORK/Unveiling-Patchwork.pdf">Patchwork</a> APT. Please notice the use of HTTP sticky buffers in this rule. Let&#39;s break down the important parts of this rule to understand its workings.</p>
<ul>
<li><code>flow:established,to_server;</code>: This keyword is used to specify the direction of the traffic we are interested in. In this case, we&#39;re looking at established connections where the traffic is going from the client to the server.</li>
<li><code>http_method; content:&quot;POST&quot;;</code>: We are looking for HTTP traffic where the method used is <code>POST</code>.</li>
<li><code>http_uri; content:&quot;.php?profile=&quot;;</code>: This specifies that we&#39;re looking for HTTP URIs that contain the string <code>.php?profile=</code>.</li>
<li><code>http_client_body; content:&quot;ddager=&quot;, depth 7;</code>: We&#39;re examining the body of the HTTP request. Specifically, we&#39;re looking for the string <code>ddager=</code> within the first <code>7</code> bytes of the body.</li>
<li><code>http_client_body; content:&quot;&amp;r1=&quot;, distance 0;</code>: We&#39;re still examining the body of the HTTP request, but now we&#39;re looking for the string <code>&amp;r1=</code> immediately following the previous content match.</li>
<li><code>http_header; content:!&quot;Accept&quot;; http_header; content:!&quot;Referer|3a|&quot;;</code>: These conditions are looking for the absence of the <code>Accept</code> and <code>Referer</code> HTTP headers. The <code>!</code> before the content means <code>not</code>, so we&#39;re looking for situations where these headers are not present.</li>
</ul>
<p>The above rule is already incorporated in the <code>local.rules</code> file found in the <code>/home/htb-student</code> directory of this section&#39;s target. To test it, first, you need to uncomment the rule. Then, execute Snort on the <code>patchwork.pcap</code> file, which is located in the <code>/home/htb-student/pcaps</code> directory.</p>
<p>Snort Rule Development</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo snort -<span class="hljs-keyword">c</span> /root/snorty/etc/snort/snort.<span class="hljs-keyword">lua</span> --daq-dir /usr/local/lib/daq -R /home/htb-student/local.rules -r /home/htb-student/pcaps/patchwork.pcap -A cmg
--------------------------------------------------
<span class="hljs-keyword">o</span><span class="hljs-comment">")~   Snort++ 3.1.64.0</span>
--------------------------------------------------
Loading /root/snorty/etc/snort/snort.<span class="hljs-keyword">lu</span><span class="hljs-variable">a:</span>
Loading snort_defaults.<span class="hljs-keyword">lu</span><span class="hljs-variable">a:</span>
Finished snort_defaults.<span class="hljs-keyword">lu</span><span class="hljs-variable">a:</span>
        output
---SNIP--- 
        trace
Finished /root/snorty/etc/snort/snort.<span class="hljs-keyword">lu</span><span class="hljs-variable">a:</span>
Loading file_id.rules_file:
Loading file_magic.rule<span class="hljs-variable">s:</span>
Finished file_magic.rule<span class="hljs-variable">s:</span>
Finished file_id.rules_file:
Loading /home/htb-student/local.rule<span class="hljs-variable">s:</span>
Finished /home/htb-student/local.rule<span class="hljs-variable">s:</span>
Loading rule arg<span class="hljs-variable">s:</span>
Loading /home/htb-student/local.rule<span class="hljs-variable">s:</span>
Finished /home/htb-student/local.rule<span class="hljs-variable">s:</span>
Finished rule arg<span class="hljs-variable">s:</span>
--------------------------------------------------
ips policies rule stats
              id  loaded  shared enabled    <span class="hljs-keyword">file</span>
               <span class="hljs-number">0</span>     <span class="hljs-number">210</span>       <span class="hljs-number">2</span>     <span class="hljs-number">210</span>    /root/snorty/etc/snort/snort.<span class="hljs-keyword">lua</span>
--------------------------------------------------
rule counts
       total rules loaded: <span class="hljs-number">210</span>
          duplicate rule<span class="hljs-variable">s:</span> <span class="hljs-number">2</span>
               text rule<span class="hljs-variable">s:</span> <span class="hljs-number">210</span>
            option chain<span class="hljs-variable">s:</span> <span class="hljs-number">210</span>
            chain header<span class="hljs-variable">s:</span> <span class="hljs-number">5</span>
--------------------------------------------------
port rule counts
             tcp     udp    icmp      ip
     any       <span class="hljs-number">0</span>       <span class="hljs-number">0</span>       <span class="hljs-number">1</span>       <span class="hljs-number">0</span>
   total       <span class="hljs-number">0</span>       <span class="hljs-number">0</span>       <span class="hljs-number">1</span>       <span class="hljs-number">0</span>
--------------------------------------------------
service rule counts          <span class="hljs-keyword">to</span>-srv  <span class="hljs-keyword">to</span>-cli
                  file_id:      <span class="hljs-number">208</span>     <span class="hljs-number">208</span>
                     http:        <span class="hljs-number">1</span>       <span class="hljs-number">0</span>
                    http2:        <span class="hljs-number">1</span>       <span class="hljs-number">0</span>
                    http3:        <span class="hljs-number">1</span>       <span class="hljs-number">0</span>
                    tota<span class="hljs-variable">l:</span>      <span class="hljs-number">211</span>     <span class="hljs-number">208</span>
--------------------------------------------------
fast pattern groups
                to_server: <span class="hljs-number">4</span>
                to_clien<span class="hljs-variable">t:</span> <span class="hljs-number">1</span>
--------------------------------------------------
<span class="hljs-built_in">search</span> engine (ac_bnfa)
                instance<span class="hljs-variable">s:</span> <span class="hljs-number">5</span>
                 pattern<span class="hljs-variable">s:</span> <span class="hljs-number">419</span>
            pattern char<span class="hljs-variable">s:</span> <span class="hljs-number">2550</span>
               num state<span class="hljs-variable">s:</span> <span class="hljs-number">1820</span>
         num <span class="hljs-keyword">match</span> state<span class="hljs-variable">s:</span> <span class="hljs-number">373</span>
             memory scale: KB
             total memory: <span class="hljs-number">73.0088</span>
           pattern memory: <span class="hljs-number">18.8525</span>
        <span class="hljs-keyword">match</span> <span class="hljs-keyword">list</span> memory: <span class="hljs-number">27.75</span>
        transition memory: <span class="hljs-number">25.7812</span>
appid: MaxRss diff: <span class="hljs-number">2964</span>
appid: patterns loaded: <span class="hljs-number">300</span>
--------------------------------------------------
pcap DAQ configured <span class="hljs-keyword">to</span> <span class="hljs-keyword">read</span>-<span class="hljs-keyword">file</span>.
Commencing packet processing
++ [<span class="hljs-number">0</span>] /home/htb-student/pcaps/patchwork.pcap
<span class="hljs-number">06</span>/<span class="hljs-number">01</span>-<span class="hljs-number">19</span>:<span class="hljs-number">24</span>:<span class="hljs-number">43.339294</span> [**] [<span class="hljs-number">1</span>:<span class="hljs-number">10000006</span>:<span class="hljs-number">1</span>] <span class="hljs-string">"OISF TROJAN Targeted AutoIt FileStealer/Downloader CnC Beacon"</span> [**] [Priority: <span class="hljs-number">0</span>] {TCP} <span class="hljs-number">192.168</span>.<span class="hljs-number">1.37</span>:<span class="hljs-number">49176</span> -&gt; <span class="hljs-number">212.129</span>.<span class="hljs-number">13.110</span>:<span class="hljs-number">8</span>
<span class="hljs-number">0</span>

http_inspect.http_method[<span class="hljs-number">4</span>]:
- - - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
<span class="hljs-number">50</span> <span class="hljs-number">4</span>F <span class="hljs-number">53</span> <span class="hljs-number">54</span>                                       POST
- - - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

http_inspect.http_version[<span class="hljs-number">8</span>]:
- - - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
<span class="hljs-number">48</span> <span class="hljs-number">54</span> <span class="hljs-number">54</span> <span class="hljs-number">50</span> <span class="hljs-number">2</span>F <span class="hljs-number">31</span> <span class="hljs-number">2</span>E <span class="hljs-number">31</span>                           HTTP/<span class="hljs-number">1.1</span>
- - - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

http_inspect.http_uri[<span class="hljs-number">37</span>]:
- - - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
<span class="hljs-number">2</span>F <span class="hljs-number">64</span> <span class="hljs-number">72</span> <span class="hljs-number">6</span>F <span class="hljs-number">70</span> <span class="hljs-number">70</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span>  <span class="hljs-number">2</span>E <span class="hljs-number">70</span> <span class="hljs-number">68</span> <span class="hljs-number">70</span> <span class="hljs-number">3</span>F <span class="hljs-number">70</span> <span class="hljs-number">72</span> <span class="hljs-number">6</span>F  /dropper .php?<span class="hljs-keyword">pro</span>
<span class="hljs-number">66</span> <span class="hljs-number">69</span> <span class="hljs-number">6</span>C <span class="hljs-number">65</span> <span class="hljs-number">3</span>D <span class="hljs-number">63</span> <span class="hljs-number">6</span>D <span class="hljs-number">56</span>  <span class="hljs-number">6</span>B <span class="hljs-number">63</span> <span class="hljs-number">30</span> <span class="hljs-number">42</span> <span class="hljs-number">43</span> <span class="hljs-number">55</span> <span class="hljs-number">45</span> <span class="hljs-number">46</span>  <span class="hljs-keyword">file</span>=cmV kc0BCUEF
<span class="hljs-number">4</span>A <span class="hljs-number">54</span> <span class="hljs-number">67</span> <span class="hljs-number">3</span>D <span class="hljs-number">3</span>D                                    JTg==
- - - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

http_inspect.http_header[<span class="hljs-number">167</span>]:
- - - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
<span class="hljs-number">43</span> <span class="hljs-number">6</span>F <span class="hljs-number">6</span>E <span class="hljs-number">6</span>E <span class="hljs-number">65</span> <span class="hljs-number">63</span> <span class="hljs-number">74</span> <span class="hljs-number">69</span>  <span class="hljs-number">6</span>F <span class="hljs-number">6</span>E <span class="hljs-number">3</span>A <span class="hljs-number">20</span> <span class="hljs-number">4</span>B <span class="hljs-number">65</span> <span class="hljs-number">65</span> <span class="hljs-number">70</span>  Connecti <span class="hljs-keyword">on</span>: Keep
<span class="hljs-number">2</span>D <span class="hljs-number">41</span> <span class="hljs-number">6</span>C <span class="hljs-number">69</span> <span class="hljs-number">76</span> <span class="hljs-number">65</span> <span class="hljs-number">0</span>D <span class="hljs-number">0</span>A  <span class="hljs-number">43</span> <span class="hljs-number">6</span>F <span class="hljs-number">6</span>E <span class="hljs-number">74</span> <span class="hljs-number">65</span> <span class="hljs-number">6</span>E <span class="hljs-number">74</span> <span class="hljs-number">2</span>D  -Alive.. Content-
<span class="hljs-number">54</span> <span class="hljs-number">79</span> <span class="hljs-number">70</span> <span class="hljs-number">65</span> <span class="hljs-number">3</span>A <span class="hljs-number">20</span> <span class="hljs-number">61</span> <span class="hljs-number">70</span>  <span class="hljs-number">70</span> <span class="hljs-number">6</span>C <span class="hljs-number">69</span> <span class="hljs-number">63</span> <span class="hljs-number">61</span> <span class="hljs-number">74</span> <span class="hljs-number">69</span> <span class="hljs-number">6</span>F  Type: ap plicatio
<span class="hljs-number">6</span>E <span class="hljs-number">2</span>F <span class="hljs-number">78</span> <span class="hljs-number">2</span>D <span class="hljs-number">77</span> <span class="hljs-number">77</span> <span class="hljs-number">77</span> <span class="hljs-number">2</span>D  <span class="hljs-number">66</span> <span class="hljs-number">6</span>F <span class="hljs-number">72</span> <span class="hljs-number">6</span>D <span class="hljs-number">2</span>D <span class="hljs-number">75</span> <span class="hljs-number">72</span> <span class="hljs-number">6</span>C  n/<span class="hljs-keyword">x</span>-www- form-url
<span class="hljs-number">65</span> <span class="hljs-number">6</span>E <span class="hljs-number">63</span> <span class="hljs-number">6</span>F <span class="hljs-number">64</span> <span class="hljs-number">65</span> <span class="hljs-number">64</span> <span class="hljs-number">0</span>D  <span class="hljs-number">0</span>A <span class="hljs-number">55</span> <span class="hljs-number">73</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">2</span>D <span class="hljs-number">41</span> <span class="hljs-number">67</span>  encoded. .User-Ag
<span class="hljs-number">65</span> <span class="hljs-number">6</span>E <span class="hljs-number">74</span> <span class="hljs-number">3</span>A <span class="hljs-number">20</span> <span class="hljs-number">4</span>D <span class="hljs-number">6</span>F <span class="hljs-number">7</span>A  <span class="hljs-number">69</span> <span class="hljs-number">6</span>C <span class="hljs-number">6</span>C <span class="hljs-number">61</span> <span class="hljs-number">2</span>F <span class="hljs-number">35</span> <span class="hljs-number">2</span>E <span class="hljs-number">30</span>  <span class="hljs-keyword">en</span><span class="hljs-variable">t:</span> Moz illa/<span class="hljs-number">5.0</span>
<span class="hljs-number">20</span> <span class="hljs-number">46</span> <span class="hljs-number">69</span> <span class="hljs-number">72</span> <span class="hljs-number">65</span> <span class="hljs-number">66</span> <span class="hljs-number">6</span>F <span class="hljs-number">78</span>  <span class="hljs-number">20</span> <span class="hljs-number">28</span> <span class="hljs-number">4</span>C <span class="hljs-number">69</span> <span class="hljs-number">6</span>B <span class="hljs-number">65</span> <span class="hljs-number">20</span> <span class="hljs-number">53</span>   Firefox  (Like S
<span class="hljs-number">61</span> <span class="hljs-number">66</span> <span class="hljs-number">61</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">2</span>F <span class="hljs-number">57</span> <span class="hljs-number">65</span>  <span class="hljs-number">62</span> <span class="hljs-number">6</span>B <span class="hljs-number">69</span> <span class="hljs-number">74</span> <span class="hljs-number">29</span> <span class="hljs-number">0</span>D <span class="hljs-number">0</span>A <span class="hljs-number">43</span>  afari/We bkit)..C
<span class="hljs-number">6</span>F <span class="hljs-number">6</span>E <span class="hljs-number">74</span> <span class="hljs-number">65</span> <span class="hljs-number">6</span>E <span class="hljs-number">74</span> <span class="hljs-number">2</span>D <span class="hljs-number">4</span>C  <span class="hljs-number">65</span> <span class="hljs-number">6</span>E <span class="hljs-number">67</span> <span class="hljs-number">74</span> <span class="hljs-number">68</span> <span class="hljs-number">3</span>A <span class="hljs-number">20</span> <span class="hljs-number">36</span>  ontent-L ength: <span class="hljs-number">6</span>
<span class="hljs-number">34</span> <span class="hljs-number">0</span>D <span class="hljs-number">0</span>A <span class="hljs-number">48</span> <span class="hljs-number">6</span>F <span class="hljs-number">73</span> <span class="hljs-number">74</span> <span class="hljs-number">3</span>A  <span class="hljs-number">20</span> <span class="hljs-number">32</span> <span class="hljs-number">31</span> <span class="hljs-number">32</span> <span class="hljs-number">2</span>E <span class="hljs-number">31</span> <span class="hljs-number">32</span> <span class="hljs-number">39</span>  <span class="hljs-number">4</span>..Hos<span class="hljs-variable">t:</span>  <span class="hljs-number">212.129</span>
<span class="hljs-number">2</span>E <span class="hljs-number">31</span> <span class="hljs-number">33</span> <span class="hljs-number">2</span>E <span class="hljs-number">31</span> <span class="hljs-number">31</span> <span class="hljs-number">30</span>                             .<span class="hljs-number">13.110</span>
- - - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

http_inspect.http_client_body[<span class="hljs-number">64</span>]:
- - - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
<span class="hljs-number">64</span> <span class="hljs-number">64</span> <span class="hljs-number">61</span> <span class="hljs-number">67</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">3</span>D <span class="hljs-number">30</span>  <span class="hljs-number">26</span> <span class="hljs-number">72</span> <span class="hljs-number">31</span> <span class="hljs-number">3</span>D <span class="hljs-number">56</span> <span class="hljs-number">30</span> <span class="hljs-number">6</span>C <span class="hljs-number">4</span>F  ddager=<span class="hljs-number">0</span> &amp;r1=V0lO
<span class="hljs-number">58</span> <span class="hljs-number">7</span>A <span class="hljs-number">63</span> <span class="hljs-number">3</span>D <span class="hljs-number">26</span> <span class="hljs-number">72</span> <span class="hljs-number">32</span> <span class="hljs-number">3</span>D  <span class="hljs-number">57</span> <span class="hljs-number">44</span> <span class="hljs-number">59</span> <span class="hljs-number">30</span> <span class="hljs-number">26</span> <span class="hljs-number">72</span> <span class="hljs-number">33</span> <span class="hljs-number">3</span>D  Xzc=&amp;r2= WDY0&amp;r3=
<span class="hljs-number">4</span>D <span class="hljs-number">53</span> <span class="hljs-number">34</span> <span class="hljs-number">78</span> <span class="hljs-number">26</span> <span class="hljs-number">72</span> <span class="hljs-number">34</span> <span class="hljs-number">3</span>D  <span class="hljs-number">4</span>D <span class="hljs-number">41</span> <span class="hljs-number">3</span>D <span class="hljs-number">3</span>D <span class="hljs-number">26</span> <span class="hljs-number">72</span> <span class="hljs-number">35</span> <span class="hljs-number">3</span>D  MS4x&amp;r4= MA==&amp;r5=
<span class="hljs-number">49</span> <span class="hljs-number">43</span> <span class="hljs-number">41</span> <span class="hljs-number">3</span>D <span class="hljs-number">26</span> <span class="hljs-number">72</span> <span class="hljs-number">36</span> <span class="hljs-number">3</span>D  <span class="hljs-number">56</span> <span class="hljs-number">48</span> <span class="hljs-number">4</span>A <span class="hljs-number">31</span> <span class="hljs-number">5</span>A <span class="hljs-number">51</span> <span class="hljs-number">3</span>D <span class="hljs-number">3</span>D  ICA=&amp;r6= VHJ1ZQ==
- - - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

<span class="hljs-number">06</span>/<span class="hljs-number">01</span>-<span class="hljs-number">19</span>:<span class="hljs-number">25</span>:<span class="hljs-number">09.059391</span> [**] [<span class="hljs-number">1</span>:<span class="hljs-number">10000006</span>:<span class="hljs-number">1</span>] <span class="hljs-string">"OISF TROJAN Targeted AutoIt FileStealer/Downloader CnC Beacon"</span> [**] [Priority: <span class="hljs-number">0</span>] {TCP} <span class="hljs-number">192.168</span>.<span class="hljs-number">1.37</span>:<span class="hljs-number">49186</span> -&gt; <span class="hljs-number">212.129</span>.<span class="hljs-number">13.110</span>:<span class="hljs-number">8</span>
<span class="hljs-number">0</span>
---SNIP---
-- [<span class="hljs-number">0</span>] /home/htb-student/pcaps/patchwork.pcap
--------------------------------------------------
Packet Statistics
--------------------------------------------------
daq
                    pcap<span class="hljs-variable">s:</span> <span class="hljs-number">1</span>
                 received: <span class="hljs-number">4868</span>
                 analyzed: <span class="hljs-number">4868</span>
                    allo<span class="hljs-variable">w:</span> <span class="hljs-number">4155</span>
                whitelis<span class="hljs-variable">t:</span> <span class="hljs-number">713</span>
                 rx_byte<span class="hljs-variable">s:</span> <span class="hljs-number">3561155</span>
--------------------------------------------------
codec
                    tota<span class="hljs-variable">l:</span> <span class="hljs-number">4868</span>         (<span class="hljs-number">100.000</span>%)
                 discard<span class="hljs-variable">s:</span> <span class="hljs-number">1</span>            (  <span class="hljs-number">0.021</span>%)
                      eth: <span class="hljs-number">4868</span>         (<span class="hljs-number">100.000</span>%)
                     ipv4: <span class="hljs-number">4868</span>         (<span class="hljs-number">100.000</span>%)
                      tcp: <span class="hljs-number">4834</span>         ( <span class="hljs-number">99.302</span>%)
                      udp: <span class="hljs-number">33</span>           (  <span class="hljs-number">0.678</span>%)
--------------------------------------------------
Module Statistics
--------------------------------------------------
appid
                  packet<span class="hljs-variable">s:</span> <span class="hljs-number">4867</span>
        processed_packet<span class="hljs-variable">s:</span> <span class="hljs-number">4867</span>
           total_session<span class="hljs-variable">s:</span> <span class="hljs-number">11</span>
       service_cache_add<span class="hljs-variable">s:</span> <span class="hljs-number">6</span>
             bytes_in_use: <span class="hljs-number">912</span>
             items_in_use: <span class="hljs-number">6</span>
--------------------------------------------------
back_orifice
                  packet<span class="hljs-variable">s:</span> <span class="hljs-number">33</span>
--------------------------------------------------
binder
              raw_packet<span class="hljs-variable">s:</span> <span class="hljs-number">1</span>
                new_flow<span class="hljs-variable">s:</span> <span class="hljs-number">10</span>
          service_change<span class="hljs-variable">s:</span> <span class="hljs-number">7</span>
                 inspect<span class="hljs-variable">s:</span> <span class="hljs-number">11</span>
--------------------------------------------------
dce_smb
                 session<span class="hljs-variable">s:</span> <span class="hljs-number">1</span>
                  packet<span class="hljs-variable">s:</span> <span class="hljs-number">17</span>
            ignored_byte<span class="hljs-variable">s:</span> <span class="hljs-number">287</span>
 max_outstanding_request<span class="hljs-variable">s:</span> <span class="hljs-number">1</span>
  max_concurrent_session<span class="hljs-variable">s:</span> <span class="hljs-number">1</span>
      total_smb1_session<span class="hljs-variable">s:</span> <span class="hljs-number">1</span>
--------------------------------------------------
detection
                 analyzed: <span class="hljs-number">4868</span>
             pdu_searche<span class="hljs-variable">s:</span> <span class="hljs-number">257</span>
            file_searche<span class="hljs-variable">s:</span> <span class="hljs-number">514</span>
                   alert<span class="hljs-variable">s:</span> <span class="hljs-number">257</span>
             total_alert<span class="hljs-variable">s:</span> <span class="hljs-number">257</span>
                   logged: <span class="hljs-number">257</span>
--------------------------------------------------
file_id
              total_file<span class="hljs-variable">s:</span> <span class="hljs-number">514</span>
          total_file_dat<span class="hljs-variable">a:</span> <span class="hljs-number">390466</span>
     max_concurrent_file<span class="hljs-variable">s:</span> <span class="hljs-number">1</span>
--------------------------------------------------
http_inspect
                    flow<span class="hljs-variable">s:</span> <span class="hljs-number">4</span>
                    scan<span class="hljs-variable">s:</span> <span class="hljs-number">2822</span>
              reassemble<span class="hljs-variable">s:</span> <span class="hljs-number">2822</span>
              inspection<span class="hljs-variable">s:</span> <span class="hljs-number">1542</span>
                 request<span class="hljs-variable">s:</span> <span class="hljs-number">257</span>
                response<span class="hljs-variable">s:</span> <span class="hljs-number">257</span>
            post_request<span class="hljs-variable">s:</span> <span class="hljs-number">257</span>
           request_bodie<span class="hljs-variable">s:</span> <span class="hljs-number">257</span>
  max_concurrent_session<span class="hljs-variable">s:</span> <span class="hljs-number">1</span>
              total_byte<span class="hljs-variable">s:</span> <span class="hljs-number">2081981</span>
--------------------------------------------------
normalizer
        test_tcp_trim_win: <span class="hljs-number">8</span>
--------------------------------------------------
port_scan
                  packet<span class="hljs-variable">s:</span> <span class="hljs-number">4867</span>
                 tracker<span class="hljs-variable">s:</span> <span class="hljs-number">8</span>
--------------------------------------------------
search_engine
               max_queued: <span class="hljs-number">1</span>
            total_flushed: <span class="hljs-number">513</span>
            total_insert<span class="hljs-variable">s:</span> <span class="hljs-number">513</span>
             total_unique: <span class="hljs-number">513</span>
     non_qualified_event<span class="hljs-variable">s:</span> <span class="hljs-number">256</span>
         qualified_event<span class="hljs-variable">s:</span> <span class="hljs-number">257</span>
           searched_byte<span class="hljs-variable">s:</span> <span class="hljs-number">399719</span>
--------------------------------------------------
ssl
                  packet<span class="hljs-variable">s:</span> <span class="hljs-number">71</span>
                  decoded: <span class="hljs-number">71</span>
             client_hello: <span class="hljs-number">2</span>
             server_hello: <span class="hljs-number">2</span>
              certificate: <span class="hljs-number">2</span>
              server_done: <span class="hljs-number">6</span>
      client_key_exchange: <span class="hljs-number">2</span>
            change_cipher: <span class="hljs-number">4</span>
       client_application: <span class="hljs-number">3</span>
       server_application: <span class="hljs-number">56</span>
                    aler<span class="hljs-variable">t:</span> <span class="hljs-number">1</span>
     unrecognized_record<span class="hljs-variable">s:</span> <span class="hljs-number">6</span>
     handshakes_completed: <span class="hljs-number">1</span>
         sessions_ignored: <span class="hljs-number">1</span>
  max_concurrent_session<span class="hljs-variable">s:</span> <span class="hljs-number">1</span>
--------------------------------------------------
stream
                    flow<span class="hljs-variable">s:</span> <span class="hljs-number">10</span>
             total_prune<span class="hljs-variable">s:</span> <span class="hljs-number">3</span>
idle_prunes_proto_timeou<span class="hljs-variable">t:</span> <span class="hljs-number">3</span>
--------------------------------------------------
stream_tcp
                 session<span class="hljs-variable">s:</span> <span class="hljs-number">7</span>
                      <span class="hljs-built_in">max</span>: <span class="hljs-number">7</span>
                  created: <span class="hljs-number">7</span>
                 released: <span class="hljs-number">7</span>
             instantiated: <span class="hljs-number">7</span>
                   setup<span class="hljs-variable">s:</span> <span class="hljs-number">7</span>
                 restart<span class="hljs-variable">s:</span> <span class="hljs-number">7</span>
          invalid_seq_num: <span class="hljs-number">8</span>
             syn_tracker<span class="hljs-variable">s:</span> <span class="hljs-number">7</span>
              segs_queued: <span class="hljs-number">2735</span>
            segs_released: <span class="hljs-number">2735</span>
                segs_used: <span class="hljs-number">2734</span>
          rebuilt_packet<span class="hljs-variable">s:</span> <span class="hljs-number">1631</span>
            rebuilt_byte<span class="hljs-variable">s:</span> <span class="hljs-number">2981239</span>
                     gap<span class="hljs-variable">s:</span> <span class="hljs-number">6</span>
                     syn<span class="hljs-variable">s:</span> <span class="hljs-number">8</span>
                 syn_ack<span class="hljs-variable">s:</span> <span class="hljs-number">7</span>
                   reset<span class="hljs-variable">s:</span> <span class="hljs-number">1</span>
                     <span class="hljs-keyword">fin</span><span class="hljs-variable">s:</span> <span class="hljs-number">10</span>
                 max_seg<span class="hljs-variable">s:</span> <span class="hljs-number">15</span>
                max_byte<span class="hljs-variable">s:</span> <span class="hljs-number">20520</span>
--------------------------------------------------
stream_udp
                 session<span class="hljs-variable">s:</span> <span class="hljs-number">3</span>
                      <span class="hljs-built_in">max</span>: <span class="hljs-number">3</span>
                  created: <span class="hljs-number">4</span>
                 released: <span class="hljs-number">4</span>
                 timeout<span class="hljs-variable">s:</span> <span class="hljs-number">1</span>
              total_byte<span class="hljs-variable">s:</span> <span class="hljs-number">2359</span>
--------------------------------------------------
wizard
                tcp_scan<span class="hljs-variable">s:</span> <span class="hljs-number">9</span>
                 tcp_hit<span class="hljs-variable">s:</span> <span class="hljs-number">7</span>
                udp_scan<span class="hljs-variable">s:</span> <span class="hljs-number">3</span>
               udp_misse<span class="hljs-variable">s:</span> <span class="hljs-number">3</span>
--------------------------------------------------
Appid Statistics
--------------------------------------------------
detected apps <span class="hljs-built_in">and</span> services
              Application: Services   Clients    Users      Payloads   Misc       Referred
                  unknown: <span class="hljs-number">9</span>          <span class="hljs-number">4</span>          <span class="hljs-number">0</span>          <span class="hljs-number">6</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>
--------------------------------------------------
Summary Statistics
--------------------------------------------------
timing
                  <span class="hljs-keyword">runtime</span>: <span class="hljs-number">00</span>:<span class="hljs-number">01</span>:<span class="hljs-number">21</span>
                  second<span class="hljs-variable">s:</span> <span class="hljs-number">81.152785</span>
                 pkts/sec: <span class="hljs-number">60</span>
<span class="hljs-keyword">o</span><span class="hljs-comment">")~   Snort exiting</span>
</code></pre>
<p>Invest some time in scrutinizing both the <code>patchwork.pcap</code> file using <code>Wireshark</code> and this rule to comprehend how it works.</p>
<p>We can download the PCAP file into the current directory of either Pwnbox or our own VM as follows.</p>
<p>Snort Rule Development</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ scp htb-student@[TARGET IP]:/home</span><span class="hljs-regexp">/htb-student/pcaps</span><span class="hljs-regexp">/patchwork.pcap .</span>
</code></pre>
<h3 id="snort-rule-development-example-4-detecting-patchwork-ssl-">Snort Rule Development Example 4: Detecting Patchwork (SSL)</h3>
<p>Snort Rule Development</p>
<pre><code class="lang-shell-session">alert tcp <span class="hljs-variable">$EXTERNAL_NET</span> any -&gt; <span class="hljs-variable">$HOME_NET</span> any (msg:<span class="hljs-string">"Patchwork SSL Cert Detected"</span>; flow:established,from_server; <span class="hljs-attribute">content</span>:<span class="hljs-string">"|55 04 03|"</span>; <span class="hljs-attribute">content</span>:<span class="hljs-string">"|08|toigetgf"</span>, distance <span class="hljs-number">1</span>, within <span class="hljs-number">9</span>; classtype:trojan-activity; sid:<span class="hljs-number">10000008</span>; rev:<span class="hljs-number">1</span>;)
</code></pre>
<p>The Snort rule above is designed to detect certain variations of malware used by the Patchwork APT. Let&#39;s break down the important parts of this rule to understand its workings.</p>
<ul>
<li><code>flow:established,from_server;</code>: This keyword pair signifies that we&#39;re interested in observing <code>established</code> flows of traffic originating from the server.</li>
<li><code>content:&quot;|55 04 03|&quot;;</code>: This rule is looking for the specific hex values <code>55 04 03</code> within the payload of the packet. These hex values represent the ASN.1 (Abstract Syntax Notation One) tag for the &quot;common name&quot; field in an X.509 certificate, which is often used in SSL/TLS certificates to denote the domain name that the certificate applies to.</li>
<li><code>content:&quot;|08|toigetgf&quot;, distance 1, within 9;</code>: Following the common name field, this rule looks for the string <code>toigetgf</code>. The distance <code>1</code> means that Snort should start looking for the string <code>toigetgf</code> <code>1</code> byte after the end of the previous content match. The within <code>9</code> sets an upper limit on how far into the packet&#39;s payload Snort should search, starting from the beginning of this content field.</li>
</ul>
<p>The above rule is already incorporated in the <code>local.rules</code> file found in the <code>/home/htb-student</code> directory of this section&#39;s target. To test it, first, you need to uncomment the rule. Then, execute Snort on the <code>patchwork.pcap</code> file, which is located in the <code>/home/htb-student/pcaps</code> directory.</p>
<p>Snort Rule Development</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo snort -c /root/snorty/etc/snort/snort.lua --daq-dir /usr/local/lib/daq -R /home/htb-student/local.rules -r /home/htb-student/pcaps/patchwork.pcap -A cmg

-----------------------------------------------<span class="yaml"><span class="hljs-meta">---</span>
o<span class="hljs-string">")~   Snort++ 3.1.64.0
--------------------------------------------------
Loading /root/snorty/etc/snort/snort.lua:
Loading snort_defaults.lua:
Finished snort_defaults.lua:
        ips
--SNIP---
        trace
        active
Finished /root/snorty/etc/snort/snort.lua:
Loading file_id.rules_file:
Loading file_magic.rules:
Finished file_magic.rules:
Finished file_id.rules_file:
Loading /home/htb-student/local.rules:
Finished /home/htb-student/local.rules:
Loading rule args:
Loading /home/htb-student/local.rules:
Finished /home/htb-student/local.rules:
Finished rule args:
--------------------------------------------------
ips policies rule stats
              id  loaded  shared enabled    file
               0     210       2     210    /root/snorty/etc/snort/snort.lua
--------------------------------------------------
rule counts
       total rules loaded: 210
          duplicate rules: 2
               text rules: 210
            option chains: 210
            chain headers: 5
--------------------------------------------------
port rule counts
             tcp     udp    icmp      ip
     any       1       0       1       0
   total       1       0       1       0
--------------------------------------------------
service rule counts          to-srv  to-cli
                  file_id:      208     208
                    total:      208     208
--------------------------------------------------
fast pattern groups
                      any: 2
                to_server: 1
                to_client: 1
--------------------------------------------------
search engine (ac_bnfa)
                instances: 3
                 patterns: 417
            pattern chars: 2518
               num states: 1788
         num match states: 371
             memory scale: KB
             total memory: 69.9795
           pattern memory: 18.7451
        match list memory: 27.4375
        transition memory: 23.4219
appid: MaxRss diff: 3084
appid: patterns loaded: 300
--------------------------------------------------
pcap DAQ configured to read-file.
Commencing packet processing
++ [0] /home/htb-student/pcaps/patchwork.pcap
06/01-19:25:29.876240 [**] [1:10000008:1] "</span>Patchwork SSL Cert Detected<span class="hljs-string">" [**] [Classification: A Network Trojan was detected] [Priority: 1] {TCP} 45.43.192.172:8443 -&gt; 192.168.1.37:49211

ssl.stream_tcp[807]:
- - - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
16 03 03 00 51 02 00 00  4D 03 03 74 19 1E 0B 50  ....Q... M..t...P
F2 80 7F 3F 81 1C 07 CF  58 0B A0 48 B0 F7 A7 D4  ...?.... X..H....</span></span>
8B<span class="hljs-number"> 08 </span>53 2D<span class="hljs-number"> 10 </span>62 F9<span class="hljs-number"> 23 </span> F0 CD<span class="hljs-number"> 76 </span>20 A3<span class="hljs-number"> 17 </span>4D A2  ..S-.b.<span class="hljs-comment"># ..v ..M.</span>
35<span class="hljs-number"> 58 </span>EC 8B 4A F2<span class="hljs-number"> 74 </span>6D <span class="hljs-number"> 72 </span>7F CC<span class="hljs-number"> 80 </span>45 E8 1E<span class="hljs-number"> 73 </span> 5X..J.tm r...E..s
2E<span class="hljs-number"> 22 </span>18<span class="hljs-number"> 99 </span>75 FB D1 FF  0E<span class="hljs-number"> 97 </span>C8<span class="hljs-number"> 04 </span>00 3C<span class="hljs-number"> 00 </span>00  ."..u... .....&lt;..
05 FF<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 16 </span>03 <span class="hljs-number"> 03 </span>02 C3 0B<span class="hljs-number"> 00 </span>02 BF<span class="hljs-number"> 00 </span> ........ ........
02 BC<span class="hljs-number"> 00 </span>02 B9<span class="hljs-number"> 30 </span>82<span class="hljs-number"> 02 </span> B5<span class="hljs-number"> 30 </span>82<span class="hljs-number"> 01 </span>9D A0<span class="hljs-number"> 03 </span>02  .....0.. .0......
01<span class="hljs-number"> 02 </span>02<span class="hljs-number"> 08 </span>44 0E<span class="hljs-number"> 87 </span>29 <span class="hljs-number"> 65 </span>41 6D 2A<span class="hljs-number"> 30 </span>0D<span class="hljs-number"> 06 </span>09  ....D..) eAm*0...
2A<span class="hljs-number"> 86 </span>48<span class="hljs-number"> 86 </span>F7 0D<span class="hljs-number"> 01 </span>01  0B<span class="hljs-number"> 05 </span>00<span class="hljs-number"> 30 </span>13<span class="hljs-number"> 31 </span>11<span class="hljs-number"> 30 </span> *.H..... ...0.1.0
0F<span class="hljs-number"> 06 </span>03<span class="hljs-number"> 55 </span>04<span class="hljs-number"> 03 </span>0C<span class="hljs-number"> 08 </span><span class="hljs-number"> 74 </span>6F<span class="hljs-number"> 69 </span>67<span class="hljs-number"> 65 </span>74<span class="hljs-number"> 67 </span>66  ...U.... toigetgf
30 1E<span class="hljs-number"> 17 </span>0D<span class="hljs-number"> 31 </span>34<span class="hljs-number"> 31 </span>31 <span class="hljs-number"> 31 </span>38<span class="hljs-number"> 30 </span>36<span class="hljs-number"> 30 </span>38<span class="hljs-number"> 33 </span>38  0...1411 18060838
5A<span class="hljs-number"> 17 </span>0D<span class="hljs-number"> 32 </span>34<span class="hljs-number"> 31 </span>31<span class="hljs-number"> 31 </span><span class="hljs-number"> 35 </span>30<span class="hljs-number"> 36 </span>30<span class="hljs-number"> 38 </span>33<span class="hljs-number"> 38 </span>5A  Z..24111 5060838Z
30<span class="hljs-number"> 13 </span>31<span class="hljs-number"> 11 </span>30 0F<span class="hljs-number"> 06 </span>03 <span class="hljs-number"> 55 </span>04<span class="hljs-number"> 03 </span>0C<span class="hljs-number"> 08 </span>74 6F<span class="hljs-number"> 69 </span> 0.1.0... U....toi
67<span class="hljs-number"> 65 </span>74<span class="hljs-number"> 67 </span>66<span class="hljs-number"> 30 </span>82<span class="hljs-number"> 01 </span><span class="hljs-number"> 22 </span>30 0D<span class="hljs-number"> 06 </span>09 2A<span class="hljs-number"> 86 </span>48  getgf0.. "0...*.H
86 F7 0D<span class="hljs-number"> 01 </span>01<span class="hljs-number"> 01 </span>05<span class="hljs-number"> 00 </span><span class="hljs-number"> 03 </span>82<span class="hljs-number"> 01 </span>0F<span class="hljs-number"> 00 </span>30<span class="hljs-number"> 82 </span>01  ........ .....0..
0A<span class="hljs-number"> 02 </span>82<span class="hljs-number"> 01 </span>01<span class="hljs-number"> 00 </span>C6 B9  1B<span class="hljs-number"> 97 </span>5C 6E DA<span class="hljs-number"> 23 </span>4C<span class="hljs-number"> 02 </span> ........ ..\n.<span class="hljs-comment">#L.</span>
EC A6 A8<span class="hljs-number"> 09 </span>56 FA<span class="hljs-number"> 85 </span>5E <span class="hljs-number"> 35 </span>75 A8 BB<span class="hljs-number"> 63 </span>B5<span class="hljs-number"> 81 </span>30  ....V..^ 5u..c..0
90<span class="hljs-number"> 91 </span>45 D7<span class="hljs-number"> 19 </span>36 0B<span class="hljs-number"> 20 </span> DF<span class="hljs-number"> 70 </span>37 0E<span class="hljs-number"> 91 </span>05 FB<span class="hljs-number"> 86 </span> ..E..6.  .p7.....
22 E8<span class="hljs-number"> 56 </span>3D A5<span class="hljs-number"> 89 </span>BA<span class="hljs-number"> 13 </span><span class="hljs-number"> 01 </span>60 DF<span class="hljs-number"> 43 </span>A6 F0<span class="hljs-number"> 05 </span>7B  ".V=.... .`.C...{
5A<span class="hljs-number"> 04 </span>7F<span class="hljs-number"> 53 </span>14<span class="hljs-number"> 80 </span>C1<span class="hljs-number"> 64 </span> EA 9C<span class="hljs-number"> 09 </span>98 A2 B8<span class="hljs-number"> 99 </span>EA  Z..S...d ........
91<span class="hljs-number"> 26 </span>52<span class="hljs-number"> 81 </span>62 D3 BB CE  A2 4E E7 BB<span class="hljs-number"> 97 </span>C9<span class="hljs-number"> 19 </span>D2  .&amp;R.b... .N......
EF<span class="hljs-number"> 61 </span>8A A5<span class="hljs-number"> 50 </span>9A D7 6B  9F 9D<span class="hljs-number"> 54 </span>7B AE E2 6F<span class="hljs-number"> 53 </span> .a..P..k ..T{..oS
BB 7A B4 D2<span class="hljs-number"> 93 </span>06<span class="hljs-number"> 73 </span>96  CD<span class="hljs-number"> 04 </span>19<span class="hljs-number"> 55 </span>D3 7A DA<span class="hljs-number"> 34 </span> .z....s. ...U.z.4
8F<span class="hljs-number"> 05 </span>2D 2E<span class="hljs-number"> 98 </span>7F 6C 9E  0B C8<span class="hljs-number"> 41 </span>A2<span class="hljs-number"> 49 </span>BA FB CC  ..-...l. ..A.I...
A4<span class="hljs-number"> 20 </span>BD 8A E5<span class="hljs-number"> 18 </span>27<span class="hljs-number"> 88 </span> BB<span class="hljs-number"> 87 </span>F9 F6 F3<span class="hljs-number"> 56 </span>8F<span class="hljs-number"> 73 </span> . ....'. .....V.s
D6 BA<span class="hljs-number"> 92 </span>29 F9 F0 A6 AB  F5 FD 5F E0<span class="hljs-number"> 92 </span>C6<span class="hljs-number"> 96 </span>2D  ...).... .._....-
41<span class="hljs-number"> 80 </span>FA 0B 4C C9 9B AE  2D<span class="hljs-number"> 69 </span>F7 9D B5 4B<span class="hljs-number"> 14 </span>81  A...L... -i...K..
AD F8<span class="hljs-number"> 71 </span>6F 2B A8<span class="hljs-number"> 59 </span>66  6E FD B5 8B 3B<span class="hljs-number"> 14 </span>09 F7  ..qo+.Yf n...;...
B8 FC<span class="hljs-number"> 20 </span>EF 7D A0 D5<span class="hljs-number"> 40 </span> D6<span class="hljs-number"> 66 </span>BB<span class="hljs-number"> 65 </span>B6 FC<span class="hljs-number"> 92 </span>3A  .. .}..@ .f.e...:
71 F5 BA 5B F1<span class="hljs-number"> 07 </span>A5 FD  E3<span class="hljs-number"> 11 </span>F2 A9<span class="hljs-number"> 51 </span>6C<span class="hljs-number"> 16 </span>8F  q..[.... ....Ql..
C8<span class="hljs-number"> 72 </span>B7 A0 D7<span class="hljs-number"> 26 </span>43 3A <span class="hljs-number"> 18 </span>7B F8 7B<span class="hljs-number"> 38 </span>72<span class="hljs-number"> 01 </span>37  .r...&amp;C: .{.{8r.7
4F<span class="hljs-number"> 42 </span>28<span class="hljs-number"> 42 </span>2F<span class="hljs-number"> 01 </span>02<span class="hljs-number"> 03 </span><span class="hljs-number"> 01 </span>00<span class="hljs-number"> 01 </span>A3 0D<span class="hljs-number"> 30 </span>0B<span class="hljs-number"> 30 </span> OB(B/... .....0.0
09<span class="hljs-number"> 06 </span>03<span class="hljs-number"> 55 </span>1D<span class="hljs-number"> 13 </span>04<span class="hljs-number"> 02 </span><span class="hljs-number"> 30 </span>00<span class="hljs-number"> 30 </span>0D<span class="hljs-number"> 06 </span>09 2A<span class="hljs-number"> 86 </span> ...U.... 0.0...*.
48<span class="hljs-number"> 86 </span>F7 0D<span class="hljs-number"> 01 </span>01 0B<span class="hljs-number"> 05 </span><span class="hljs-number"> 00 </span>03<span class="hljs-number"> 82 </span>01<span class="hljs-number"> 01 </span>00 2D 0E  H....... ......-.
CC D5<span class="hljs-number"> 50 </span>AB DF<span class="hljs-number"> 20 </span>37 BB <span class="hljs-number"> 71 </span>10<span class="hljs-number"> 31 </span>C5 1F<span class="hljs-number"> 17 </span>EC F9  ..P.. 7. q.1.....
D7<span class="hljs-number"> 20 </span>1A<span class="hljs-number"> 19 </span>39 F4 DE D8  BA C1 A3 F5<span class="hljs-number"> 57 </span>E0 E0 6B  . ..9... ....W..k
DC 6F E1 1F 6B<span class="hljs-number"> 07 </span>98 FB <span class="hljs-number"> 38 </span>1A 0A<span class="hljs-number"> 77 </span>BD B4 0A<span class="hljs-number"> 94 </span> .o..k... 8..w....
01<span class="hljs-number"> 45 </span>95 0C<span class="hljs-number"> 09 </span>F1<span class="hljs-number"> 43 </span>D5  7D<span class="hljs-number"> 57 </span>E7 D6 E7<span class="hljs-number"> 74 </span>98 6C  .E....C. }W...t.l
4F D0<span class="hljs-number"> 46 </span>81 F2 9D 5A<span class="hljs-number"> 29 </span> 1E BD 7F<span class="hljs-number"> 03 </span>5B<span class="hljs-number"> 64 </span>B3<span class="hljs-number"> 98 </span> O.F...Z) ....[d..
D4<span class="hljs-number"> 52 </span>B0 E1 CE<span class="hljs-number"> 11 </span>62<span class="hljs-number"> 68 </span><span class="hljs-number"> 31 </span>1D CC 0F DD B6 AA 5C  .R....bh 1......\
44 D0<span class="hljs-number"> 44 </span>18 9E 3D AE<span class="hljs-number"> 30 </span> C7<span class="hljs-number"> 10 </span>C6<span class="hljs-number"> 97 </span>F6 C1 C9 D7  D.D..=.0 ........
11<span class="hljs-number"> 13 </span>44 AA B4 C9 2D 0C  AC 2B AD 9A CB 7B 5D<span class="hljs-number"> 51 </span> ..D...-. .+...{]Q
3F<span class="hljs-number"> 45 </span>C6 2E<span class="hljs-number"> 99 </span>CF<span class="hljs-number"> 71 </span>F6 <span class="hljs-number"> 66 </span>9A<span class="hljs-number"> 09 </span>28<span class="hljs-number"> 44 </span>28<span class="hljs-number"> 34 </span>3B  ?E....q. f..(D(4;
EC 0B A6 F4 E3 5F FE 7E <span class="hljs-number"> 30 </span>59 DC 3D 4E<span class="hljs-number"> 33 </span>22<span class="hljs-number"> 11 </span> ....._.~ 0Y.=N3".
BA CA 8A 4B<span class="hljs-number"> 41 </span>5D<span class="hljs-number"> 97 </span>3E  CD BB 3C DD<span class="hljs-number"> 28 </span>37<span class="hljs-number"> 12 </span>47  ...KA].&gt; ..&lt;.(7.G
E0 BE AC 3B<span class="hljs-number"> 13 </span>EC<span class="hljs-number"> 59 </span>A0  E3 1A CE<span class="hljs-number"> 28 </span>B2<span class="hljs-number"> 11 </span>5D 3B  ...;..Y. ...(..];
AC AD CF<span class="hljs-number"> 32 </span>F5 EA CB B2 <span class="hljs-number"> 92 </span>20 BC 5C 3C 4C B9<span class="hljs-number"> 43 </span> ...2.... . .\&lt;L.C
5A BC 1B 2F E3 F3 DF DC <span class="hljs-number"> 04 </span>DB<span class="hljs-number"> 24 </span>6A<span class="hljs-number"> 73 </span>13 EA E5  Z../.... ..$js...
32<span class="hljs-number"> 45 </span>6A F6 D9 CC<span class="hljs-number"> 66 </span>9C <span class="hljs-number"> 80 </span>99 3D EC D9 2D<span class="hljs-number"> 13 </span>9A  2Ej...f. ..=..-..
9A 6F<span class="hljs-number"> 90 </span>69<span class="hljs-number"> 47 </span>95 B6<span class="hljs-number"> 46 </span> D8 F2 E8 EF CC CA<span class="hljs-number"> 16 </span>03  .o.iG..F ........
03<span class="hljs-number"> 00 </span>04 0E<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>                            .......
- - - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

06/01-19:25:44.259156 [**] [1:10000008:1] "Patchwork SSL Cert Detected" [**] [Classification: A Network Trojan was detected] [Priority: 1] {TCP} 45.43.192.172:8443 -&gt; 192.168.1.37:49219

ssl.stream_tcp[807]:
- - - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -
16<span class="hljs-number"> 03 </span>01<span class="hljs-number"> 00 </span>51<span class="hljs-number"> 02 </span>00<span class="hljs-number"> 00 </span> 4D<span class="hljs-number"> 03 </span>01 BA<span class="hljs-number"> 21 </span>1C<span class="hljs-number"> 95 </span>C6  ....Q... M...!...
8A<span class="hljs-number"> 83 </span>F3 C8<span class="hljs-number"> 31 </span>16 EF<span class="hljs-number"> 25 </span><span class="hljs-number"> 32 </span>C4<span class="hljs-number"> 63 </span>7E<span class="hljs-number"> 82 </span>B0 7D D0  ....1..% 2.c~..}.
01 EF 6C 7B DC A3 CD<span class="hljs-number"> 53 </span><span class="hljs-number"> 97 </span>18<span class="hljs-number"> 62 </span>20 C6 FE 9D B0  ..l{...S ..b ....
B0 F4 9B 9A 6E 1D 6B<span class="hljs-number"> 74 </span><span class="hljs-number"> 64 </span>4D E4 CC<span class="hljs-number"> 30 </span>2E<span class="hljs-number"> 05 </span>B8  ....n.kt dM..0...
30 1A<span class="hljs-number"> 34 </span>D0<span class="hljs-number"> 30 </span>94 5B FA  AB<span class="hljs-number"> 64 </span>27<span class="hljs-number"> 09 </span>00 2F<span class="hljs-number"> 00 </span>00  0.4.0.[. .d'../..
05 FF<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 16 </span>03 <span class="hljs-number"> 01 </span>02 C3 0B<span class="hljs-number"> 00 </span>02 BF<span class="hljs-number"> 00 </span> ........ ........
02 BC<span class="hljs-number"> 00 </span>02 B9<span class="hljs-number"> 30 </span>82<span class="hljs-number"> 02 </span> B5<span class="hljs-number"> 30 </span>82<span class="hljs-number"> 01 </span>9D A0<span class="hljs-number"> 03 </span>02  .....0.. .0......
01<span class="hljs-number"> 02 </span>02<span class="hljs-number"> 08 </span>44 0E<span class="hljs-number"> 87 </span>29 <span class="hljs-number"> 65 </span>41 6D 2A<span class="hljs-number"> 30 </span>0D<span class="hljs-number"> 06 </span>09  ....D..) eAm*0...
2A<span class="hljs-number"> 86 </span>48<span class="hljs-number"> 86 </span>F7 0D<span class="hljs-number"> 01 </span>01  0B<span class="hljs-number"> 05 </span>00<span class="hljs-number"> 30 </span>13<span class="hljs-number"> 31 </span>11<span class="hljs-number"> 30 </span> *.H..... ...0.1.0
0F<span class="hljs-number"> 06 </span>03<span class="hljs-number"> 55 </span>04<span class="hljs-number"> 03 </span>0C<span class="hljs-number"> 08 </span><span class="hljs-number"> 74 </span>6F<span class="hljs-number"> 69 </span>67<span class="hljs-number"> 65 </span>74<span class="hljs-number"> 67 </span>66  ...U.... toigetgf
30 1E<span class="hljs-number"> 17 </span>0D<span class="hljs-number"> 31 </span>34<span class="hljs-number"> 31 </span>31 <span class="hljs-number"> 31 </span>38<span class="hljs-number"> 30 </span>36<span class="hljs-number"> 30 </span>38<span class="hljs-number"> 33 </span>38  0...1411 18060838
5A<span class="hljs-number"> 17 </span>0D<span class="hljs-number"> 32 </span>34<span class="hljs-number"> 31 </span>31<span class="hljs-number"> 31 </span><span class="hljs-number"> 35 </span>30<span class="hljs-number"> 36 </span>30<span class="hljs-number"> 38 </span>33<span class="hljs-number"> 38 </span>5A  Z..24111 5060838Z
30<span class="hljs-number"> 13 </span>31<span class="hljs-number"> 11 </span>30 0F<span class="hljs-number"> 06 </span>03 <span class="hljs-number"> 55 </span>04<span class="hljs-number"> 03 </span>0C<span class="hljs-number"> 08 </span>74 6F<span class="hljs-number"> 69 </span> 0.1.0... U....toi
67<span class="hljs-number"> 65 </span>74<span class="hljs-number"> 67 </span>66<span class="hljs-number"> 30 </span>82<span class="hljs-number"> 01 </span><span class="hljs-number"> 22 </span>30 0D<span class="hljs-number"> 06 </span>09 2A<span class="hljs-number"> 86 </span>48  getgf0.. "0...*.H
86 F7 0D<span class="hljs-number"> 01 </span>01<span class="hljs-number"> 01 </span>05<span class="hljs-number"> 00 </span><span class="hljs-number"> 03 </span>82<span class="hljs-number"> 01 </span>0F<span class="hljs-number"> 00 </span>30<span class="hljs-number"> 82 </span>01  ........ .....0..
0A<span class="hljs-number"> 02 </span>82<span class="hljs-number"> 01 </span>01<span class="hljs-number"> 00 </span>C6 B9  1B<span class="hljs-number"> 97 </span>5C 6E DA<span class="hljs-number"> 23 </span>4C<span class="hljs-number"> 02 </span> ........ ..\n.<span class="hljs-comment">#L.</span>
EC A6 A8<span class="hljs-number"> 09 </span>56 FA<span class="hljs-number"> 85 </span>5E <span class="hljs-number"> 35 </span>75 A8 BB<span class="hljs-number"> 63 </span>B5<span class="hljs-number"> 81 </span>30  ....V..^ 5u..c..0
90<span class="hljs-number"> 91 </span>45 D7<span class="hljs-number"> 19 </span>36 0B<span class="hljs-number"> 20 </span> DF<span class="hljs-number"> 70 </span>37 0E<span class="hljs-number"> 91 </span>05 FB<span class="hljs-number"> 86 </span> ..E..6.  .p7.....
22 E8<span class="hljs-number"> 56 </span>3D A5<span class="hljs-number"> 89 </span>BA<span class="hljs-number"> 13 </span><span class="hljs-number"> 01 </span>60 DF<span class="hljs-number"> 43 </span>A6 F0<span class="hljs-number"> 05 </span>7B  ".V=.... .`.C...{
5A<span class="hljs-number"> 04 </span>7F<span class="hljs-number"> 53 </span>14<span class="hljs-number"> 80 </span>C1<span class="hljs-number"> 64 </span> EA 9C<span class="hljs-number"> 09 </span>98 A2 B8<span class="hljs-number"> 99 </span>EA  Z..S...d ........
91<span class="hljs-number"> 26 </span>52<span class="hljs-number"> 81 </span>62 D3 BB CE  A2 4E E7 BB<span class="hljs-number"> 97 </span>C9<span class="hljs-number"> 19 </span>D2  .&amp;R.b... .N......
EF<span class="hljs-number"> 61 </span>8A A5<span class="hljs-number"> 50 </span>9A D7 6B  9F 9D<span class="hljs-number"> 54 </span>7B AE E2 6F<span class="hljs-number"> 53 </span> .a..P..k ..T{..oS
BB 7A B4 D2<span class="hljs-number"> 93 </span>06<span class="hljs-number"> 73 </span>96  CD<span class="hljs-number"> 04 </span>19<span class="hljs-number"> 55 </span>D3 7A DA<span class="hljs-number"> 34 </span> .z....s. ...U.z.4
8F<span class="hljs-number"> 05 </span>2D 2E<span class="hljs-number"> 98 </span>7F 6C 9E  0B C8<span class="hljs-number"> 41 </span>A2<span class="hljs-number"> 49 </span>BA FB CC  ..-...l. ..A.I...
A4<span class="hljs-number"> 20 </span>BD 8A E5<span class="hljs-number"> 18 </span>27<span class="hljs-number"> 88 </span> BB<span class="hljs-number"> 87 </span>F9 F6 F3<span class="hljs-number"> 56 </span>8F<span class="hljs-number"> 73 </span> . ....'. .....V.s
D6 BA<span class="hljs-number"> 92 </span>29 F9 F0 A6 AB  F5 FD 5F E0<span class="hljs-number"> 92 </span>C6<span class="hljs-number"> 96 </span>2D  ...).... .._....-
41<span class="hljs-number"> 80 </span>FA 0B 4C C9 9B AE  2D<span class="hljs-number"> 69 </span>F7 9D B5 4B<span class="hljs-number"> 14 </span>81  A...L... -i...K..
AD F8<span class="hljs-number"> 71 </span>6F 2B A8<span class="hljs-number"> 59 </span>66  6E FD B5 8B 3B<span class="hljs-number"> 14 </span>09 F7  ..qo+.Yf n...;...
B8 FC<span class="hljs-number"> 20 </span>EF 7D A0 D5<span class="hljs-number"> 40 </span> D6<span class="hljs-number"> 66 </span>BB<span class="hljs-number"> 65 </span>B6 FC<span class="hljs-number"> 92 </span>3A  .. .}..@ .f.e...:
71 F5 BA 5B F1<span class="hljs-number"> 07 </span>A5 FD  E3<span class="hljs-number"> 11 </span>F2 A9<span class="hljs-number"> 51 </span>6C<span class="hljs-number"> 16 </span>8F  q..[.... ....Ql..
C8<span class="hljs-number"> 72 </span>B7 A0 D7<span class="hljs-number"> 26 </span>43 3A <span class="hljs-number"> 18 </span>7B F8 7B<span class="hljs-number"> 38 </span>72<span class="hljs-number"> 01 </span>37  .r...&amp;C: .{.{8r.7
4F<span class="hljs-number"> 42 </span>28<span class="hljs-number"> 42 </span>2F<span class="hljs-number"> 01 </span>02<span class="hljs-number"> 03 </span><span class="hljs-number"> 01 </span>00<span class="hljs-number"> 01 </span>A3 0D<span class="hljs-number"> 30 </span>0B<span class="hljs-number"> 30 </span> OB(B/... .....0.0
09<span class="hljs-number"> 06 </span>03<span class="hljs-number"> 55 </span>1D<span class="hljs-number"> 13 </span>04<span class="hljs-number"> 02 </span><span class="hljs-number"> 30 </span>00<span class="hljs-number"> 30 </span>0D<span class="hljs-number"> 06 </span>09 2A<span class="hljs-number"> 86 </span> ...U.... 0.0...*.
48<span class="hljs-number"> 86 </span>F7 0D<span class="hljs-number"> 01 </span>01 0B<span class="hljs-number"> 05 </span><span class="hljs-number"> 00 </span>03<span class="hljs-number"> 82 </span>01<span class="hljs-number"> 01 </span>00 2D 0E  H....... ......-.
CC D5<span class="hljs-number"> 50 </span>AB DF<span class="hljs-number"> 20 </span>37 BB <span class="hljs-number"> 71 </span>10<span class="hljs-number"> 31 </span>C5 1F<span class="hljs-number"> 17 </span>EC F9  ..P.. 7. q.1.....
D7<span class="hljs-number"> 20 </span>1A<span class="hljs-number"> 19 </span>39 F4 DE D8  BA C1 A3 F5<span class="hljs-number"> 57 </span>E0 E0 6B  . ..9... ....W..k
DC 6F E1 1F 6B<span class="hljs-number"> 07 </span>98 FB <span class="hljs-number"> 38 </span>1A 0A<span class="hljs-number"> 77 </span>BD B4 0A<span class="hljs-number"> 94 </span> .o..k... 8..w....
01<span class="hljs-number"> 45 </span>95 0C<span class="hljs-number"> 09 </span>F1<span class="hljs-number"> 43 </span>D5  7D<span class="hljs-number"> 57 </span>E7 D6 E7<span class="hljs-number"> 74 </span>98 6C  .E....C. }W...t.l
4F D0<span class="hljs-number"> 46 </span>81 F2 9D 5A<span class="hljs-number"> 29 </span> 1E BD 7F<span class="hljs-number"> 03 </span>5B<span class="hljs-number"> 64 </span>B3<span class="hljs-number"> 98 </span> O.F...Z) ....[d..
D4<span class="hljs-number"> 52 </span>B0 E1 CE<span class="hljs-number"> 11 </span>62<span class="hljs-number"> 68 </span><span class="hljs-number"> 31 </span>1D CC 0F DD B6 AA 5C  .R....bh 1......\
44 D0<span class="hljs-number"> 44 </span>18 9E 3D AE<span class="hljs-number"> 30 </span> C7<span class="hljs-number"> 10 </span>C6<span class="hljs-number"> 97 </span>F6 C1 C9 D7  D.D..=.0 ........
11<span class="hljs-number"> 13 </span>44 AA B4 C9 2D 0C  AC 2B AD 9A CB 7B 5D<span class="hljs-number"> 51 </span> ..D...-. .+...{]Q
3F<span class="hljs-number"> 45 </span>C6 2E<span class="hljs-number"> 99 </span>CF<span class="hljs-number"> 71 </span>F6 <span class="hljs-number"> 66 </span>9A<span class="hljs-number"> 09 </span>28<span class="hljs-number"> 44 </span>28<span class="hljs-number"> 34 </span>3B  ?E....q. f..(D(4;
EC 0B A6 F4 E3 5F FE 7E <span class="hljs-number"> 30 </span>59 DC 3D 4E<span class="hljs-number"> 33 </span>22<span class="hljs-number"> 11 </span> ....._.~ 0Y.=N3".
BA CA 8A 4B<span class="hljs-number"> 41 </span>5D<span class="hljs-number"> 97 </span>3E  CD BB 3C DD<span class="hljs-number"> 28 </span>37<span class="hljs-number"> 12 </span>47  ...KA].&gt; ..&lt;.(7.G
E0 BE AC 3B<span class="hljs-number"> 13 </span>EC<span class="hljs-number"> 59 </span>A0  E3 1A CE<span class="hljs-number"> 28 </span>B2<span class="hljs-number"> 11 </span>5D 3B  ...;..Y. ...(..];
AC AD CF<span class="hljs-number"> 32 </span>F5 EA CB B2 <span class="hljs-number"> 92 </span>20 BC 5C 3C 4C B9<span class="hljs-number"> 43 </span> ...2.... . .\&lt;L.C
5A BC 1B 2F E3 F3 DF DC <span class="hljs-number"> 04 </span>DB<span class="hljs-number"> 24 </span>6A<span class="hljs-number"> 73 </span>13 EA E5  Z../.... ..$js...
32<span class="hljs-number"> 45 </span>6A F6 D9 CC<span class="hljs-number"> 66 </span>9C <span class="hljs-number"> 80 </span>99 3D EC D9 2D<span class="hljs-number"> 13 </span>9A  2Ej...f. ..=..-..
9A 6F<span class="hljs-number"> 90 </span>69<span class="hljs-number"> 47 </span>95 B6<span class="hljs-number"> 46 </span> D8 F2 E8 EF CC CA<span class="hljs-number"> 16 </span>03  .o.iG..F ........
01<span class="hljs-number"> 00 </span>04 0E<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>                            .......
- - - - - - - - - - - -  - - - - - - - - - - - -  - - - - - - - - -

-- [0] /home/htb-student/pcaps/patchwork.pcap
-----------------------------------------------<span class="yaml"><span class="hljs-string">---
Packet Statistics
--------------------------------------------------
daq
                    pcaps: 1
                 received: 4868
                 analyzed: 4868
                    allow: 4155
                whitelist: 713
                 rx_bytes: 3561155
--------------------------------------------------
codec
                    total: 4868         (100.000%)
                 discards: 1            (  0.021%)
                      eth: 4868         (100.000%)
                     ipv4: 4868         (100.000%)
                      tcp: 4834         ( 99.302%)
                      udp: 33           (  0.678%)
--------------------------------------------------
Module Statistics
--------------------------------------------------
appid
                  packets: 4867
        processed_packets: 4867
           total_sessions: 11
       service_cache_adds: 6
             bytes_in_use: 912
             items_in_use: 6
--------------------------------------------------
back_orifice
                  packets: 33
--------------------------------------------------
binder
              raw_packets: 1
                new_flows: 10
          service_changes: 7
                 inspects: 11
--------------------------------------------------
dce_smb
                 sessions: 1
                  packets: 17
            ignored_bytes: 287
 max_outstanding_requests: 1
  max_concurrent_sessions: 1
      total_smb1_sessions: 1
--------------------------------------------------
detection
                 analyzed: 4868
             raw_searches: 21
          cooked_searches: 619
             pkt_searches: 640
            file_searches: 514
                   alerts: 2
             total_alerts: 2
                   logged: 2
--------------------------------------------------
file_id
              total_files: 514
          total_file_data: 390466
     max_concurrent_files: 1
--------------------------------------------------
http_inspect
                    flows: 4
                    scans: 2822
              reassembles: 2822
              inspections: 1542
                 requests: 257
                responses: 257
            post_requests: 257
           request_bodies: 257
  max_concurrent_sessions: 1
              total_bytes: 2081981
--------------------------------------------------
normalizer
        test_tcp_trim_win: 8
--------------------------------------------------
port_scan
                  packets: 4867
                 trackers: 8
--------------------------------------------------
search_engine
               max_queued: 1
            total_flushed: 258
            total_inserts: 258
             total_unique: 258
     non_qualified_events: 256
         qualified_events: 2
           searched_bytes: 3260955
--------------------------------------------------
ssl
                  packets: 71
                  decoded: 71
             client_hello: 2
             server_hello: 2
              certificate: 2
              server_done: 6
      client_key_exchange: 2
            change_cipher: 4
       client_application: 3
       server_application: 56
                    alert: 1
     unrecognized_records: 6
     handshakes_completed: 1
         sessions_ignored: 1
  max_concurrent_sessions: 1
--------------------------------------------------
stream
                    flows: 10
             total_prunes: 3
idle_prunes_proto_timeout: 3
--------------------------------------------------
stream_tcp
                 sessions: 7
                      max: 7
                  created: 7
                 released: 7
             instantiated: 7
                   setups: 7
                 restarts: 7
          invalid_seq_num: 8
             syn_trackers: 7
              segs_queued: 2735
            segs_released: 2735
                segs_used: 2734
          rebuilt_packets: 1631
            rebuilt_bytes: 2981239
                     gaps: 6
                     syns: 8
                 syn_acks: 7
                   resets: 1
                     fins: 10
                 max_segs: 15
                max_bytes: 20520
--------------------------------------------------
stream_udp
                 sessions: 3
                      max: 3
                  created: 4
                 released: 4
                 timeouts: 1
              total_bytes: 2359
--------------------------------------------------
wizard
                tcp_scans: 9
                 tcp_hits: 7
                udp_scans: 3
               udp_misses: 3
--------------------------------------------------
Appid Statistics
--------------------------------------------------
detected apps and services
              Application: Services   Clients    Users      Payloads   Misc       Referred
                  unknown: 9          4          0          6          0          0
--------------------------------------------------
Summary Statistics
--------------------------------------------------
timing
                  runtime: 00:00:00
                  seconds: 0.078293
                 pkts/sec: 62177
                Mbits/sec: 347
o"</span>)~   Snort exiting</span>
</code></pre>
<p>Invest some time in scrutinizing both the <code>patchwork.pcap</code> file using <code>Wireshark</code> and this rule to comprehend how it works.</p>
<p>We can download the PCAP file into the current directory of either Pwnbox or our own VM as follows.</p>
<p>Snort Rule Development</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ scp htb-student@[TARGET IP]:/home</span><span class="hljs-regexp">/htb-student/pcaps</span><span class="hljs-regexp">/patchwork.pcap .</span>
</code></pre>
<h2 id="zeek-fundamentals">Zeek Fundamentals</h2>
<p>Zeek, as defined by its developers, is an open-source network traffic analyzer. It is typically employed to scrutinize every bit of traffic on a network, digging deep for any signs of suspicious or malicious activity. But, Zeek isn&#39;t limited to just that. It can also be a handy tool for troubleshooting network issues and conducting a variety of measurements within a network. Once we deploy Zeek, our defensive cybersecurity teams (or blue teams) can immediately tap into a wealth of log files, which offer an elevated view of all types of network activity. Specifically, these logs contain detailed records of every connection made over the network, along with transcripts of application-layer activities such as DNS queries and responses, HTTP sessions, and more. But Zeek&#39;s capabilities extend beyond mere logging. It comes bundled with a suite of functions for analyzing and detecting network activities.</p>
<p>What sets Zeek apart is its highly capable scripting language, which allows users to craft Zeek scripts that are functionally similar to Suricata rules. This powerful feature enables Zeek to be fully customizable and extendable, letting blue team members develop their own logic and strategies for network analysis and intrusion detection.</p>
<p>Considering Zeek&#39;s functionality, combined with its ability to run on standard hardware and the powerful scripting language, it becomes clear that we&#39;re not looking at another signature-based IDS. Instead, Zeek is a platform that can facilitate semantic misuse detection, anomaly detection, and behavioral analysis..</p>
<h3 id="zeek-s-operation-modes">Zeek&#39;s Operation Modes</h3>
<p>Zeek operates in the following modes:</p>
<ul>
<li>Fully passive traffic analysis</li>
<li>libpcap interface for packet capture</li>
<li>Real-time and offline (e.g., PCAP-based) analysis</li>
<li>Cluster support for large-scale deployments</li>
</ul>
<h3 id="zeek-s-architecture">Zeek&#39;s Architecture</h3>
<p>Zeek&#39;s architecture comprises two primary components: the <code>event engine</code> (or core) and the <code>script interpreter</code>.</p>
<p>The <code>event engine</code> takes an incoming packet stream and transforms it into a series of high-level <code>events</code>. In Zeek&#39;s context, these <code>events</code> describe network activity in policy-neutral terms, meaning they inform us of what&#39;s happening, but they don&#39;t offer an interpretation or evaluation of it. For instance, an HTTP request will be transformed into an <code>http_request</code> event. While this event provides all the details of the request, it doesn&#39;t offer any judgement or analysis, such as whether a port corresponds to a port known to be used by malware.</p>
<p>Such interpretation or analysis is provided by Zeek&#39;s <code>script interpreter</code>, which executes a set of event handlers written in Zeek&#39;s scripting language (Zeek scripts). These scripts express the site&#39;s security policy, defining actions to be taken upon the detection of certain events.</p>
<p>Events generated by Zeek&#39;s core are queued in an orderly manner, awaiting their turn to be processed on a first-come, first-served basis. Most of Zeek&#39;s events are defined in <code>.bif</code> files located in the <code>/scripts/base/bif/plugins/</code> directory. For a more comprehensive list of events, refer to the following resource: <a href="https://docs.zeek.org/en/stable/scripts/base/bif">https://docs.zeek.org/en/stable/scripts/base/bif/</a></p>
<h3 id="zeek-logs">Zeek Logs</h3>
<p>As for Zeek&#39;s logging, when we use Zeek for offline analysis of a PCAP file, the logs will be stored in the current directory.</p>
<p>Among the diverse array of logs Zeek produces, some familiar ones include:</p>
<ul>
<li><code>conn.log</code>: This log provides details about IP, TCP, UDP, and ICMP connections.</li>
<li><code>dns.log</code>: Here, you&#39;ll find the details of DNS queries and responses.</li>
<li><code>http.log</code>: This log captures the details of HTTP requests and responses.</li>
<li><code>ftp.log</code>: Details of FTP requests and responses are logged here.</li>
<li><code>smtp.log</code>: This log covers SMTP transactions, such as sender and recipient details.</li>
</ul>
<p>Let&#39;s consider the <code>http.log</code> as an example. It is chock-full of valuable data like:</p>
<ul>
<li><code>host</code>: The HTTP domain/IP.</li>
<li><code>uri</code>: The HTTP URI.</li>
<li><code>referrer</code>: The referrer of the HTTP request.</li>
<li><code>user_agent</code>: The client&#39;s user agent.</li>
<li><code>status_code</code>: The HTTP status code.</li>
</ul>
<p>For a more exhaustive list of common Zeek logs and their respective fields, refer to the following resource: <a href="https://docs.zeek.org/en/master/logs/index.html">https://docs.zeek.org/en/master/logs/index.html</a></p>
<p>It&#39;s noteworthy to mention that Zeek, in its standard configuration, applies gzip compression to log files every hour. The older logs are then transferred into a directory named in the <code>YYYY-MM-DD</code> format. When dealing with these compressed logs, alternative tools like <code>gzcat</code> for printing logs or <code>zgrep</code> for searching within logs can come in handy.</p>
<p>You can find examples on how to work with gzip-compressed Zeek logs at this link: <a href="https://blog.rapid7.com/2016/06/02/working-with-bro-logs-queries-by-example/">https://blog.rapid7.com/2016/06/02/working-with-bro-logs-queries-by-example/</a></p>
<p>As stated earlier, when interacting with Zeek log files, we can utilize native Unix commands such as cat or grep. However, Zeek also provides a specialized tool known as <code>zeek-cut</code> for handling log files. This utility accepts Zeek log files via standard input using pipelines or stream redirections and then delivers the specified columns to the standard output.</p>
<p>If you&#39;re interested in exploring Zeek examples, use cases, and learning the basics of writing Zeek scripts, take a look at the following link: <a href="https://docs.zeek.org/en/stable/examples/index.html">https://docs.zeek.org/en/stable/examples/index.html</a></p>
<p>For a quick start guide to Zeek, refer to the following link: <a href="https://docs.zeek.org/en/stable/quickstart/index.html">https://docs.zeek.org/en/stable/quickstart/index.html</a></p>
<h3 id="zeek-key-features">Zeek Key Features</h3>
<p>Key features that bolster Zeek&#39;s effectiveness include:</p>
<ul>
<li>Comprehensive logging of network activities</li>
<li>Analysis of application-layer protocols (irrespective of the port, covering protocols like HTTP, DNS, FTP, SMTP, SSH, SSL, etc.)</li>
<li>Ability to inspect file content exchanged over application-layer protocols</li>
<li>IPv6 support</li>
<li>Tunnel detection and analysis</li>
<li>Capability to conduct sanity checks during protocol analysis</li>
<li>IDS-like pattern matching</li>
<li>Powerful, domain-aware scripting language that allows for expressing arbitrary analysis tasks and managing network state over time</li>
<li>Interfacing that outputs to well-structured ASCII logs by default and offers alternative backends for ElasticSearch and DataSeries</li>
<li>Real-time integration of external input into analyses</li>
<li>External C library for sharing Zeek events with external programs</li>
<li>Capability to trigger arbitrary external processes from within the scripting language</li>
</ul>
<h2 id="intrusion-detection-with-zeek">Intrusion Detection With Zeek</h2>
<p>As already discussed, Zeek, formerly known as Bro, is a powerful network security monitoring tool that allows us to delve deep into our network traffic and extract useful insights.</p>
<p>The flexibility and extensibility of Zeek make it a cornerstone of advanced network-based intrusion detection and investigation. With its rich set of logs and extensive scripting capabilities, we can customize it to suit our specific detection requirements and continuously improve our security posture.</p>
<p>Let&#39;s now navigate to the bottom of this section and click on &quot;Click here to spawn the target system!&quot;. Then, let&#39;s SSH into the Target IP using the provided credentials. The vast majority of the commands covered from this point up to end of this section can be replicated inside the target, offering a more comprehensive grasp of the topics presented.</p>
<p>Let&#39;s move forward and explore some examples of detecting intrusions with Zeek.</p>
<h3 id="intrusion-detection-with-zeek-example-1-detecting-beaconing-malware">Intrusion Detection With Zeek Example 1: Detecting Beaconing Malware</h3>
<p>Beaconing is a process by which malware communicates with its command and control (C2) server to receive instructions or exfiltrate data. It&#39;s usually characterized by a consistent or patterned interval of outbound communications.</p>
<p>By analyzing connection logs (<code>conn.log</code>), we can look for patterns in outbound traffic. These patterns can include repetitive connections to the same destination IP or domain, constant data size in the sent data, or the connection timing. These are all indicative of potential beaconing behavior. Anomalies can be further explored using Zeek scripts specifically designed to spot beaconing patterns.</p>
<p>Intrusion Detection With Zeek</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ /</span>usr<span class="hljs-regexp">/local/</span>zeek<span class="hljs-regexp">/bin/</span>zeek -C -r <span class="hljs-regexp">/home/</span>htb-student<span class="hljs-regexp">/pcaps/</span>psempire.pcap
</code></pre>
<p>Intrusion Detection With Zeek</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat conn.log
<span class="hljs-comment">#separator \x09</span>
<span class="hljs-comment">#set_separator  ,</span>
<span class="hljs-comment">#empty_field    (empty)</span>
<span class="hljs-comment">#unset_field    -</span>
<span class="hljs-comment">#path   conn</span>
<span class="hljs-comment">#open   2023-07-16-12-15-40</span>
<span class="hljs-comment">#fields ts      uid     id.orig_h       id.orig_p       id.resp_h       id.resp_p       proto   service duration        orig_bytes      resp_bytes      conn_state      local_orig      local_resp      missed_bytes    history o_pkts   orig_ip_bytes   resp_pkts       resp_ip_bytes   tunnel_parents</span>
<span class="hljs-comment">#types  time    string  addr    port    addr    port    enum    string  interval        count   count   string  bool    bool    count   string  count   count   count   count   set[string]</span>
1511269439.125289       CuQYC98rE69BBb7jb       192.168.56.14  <span class="hljs-number"> 50436 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    2.186789       <span class="hljs-number"> 204 </span>   <span class="hljs-number"> 5557 </span>   SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 416 </span>   <span class="hljs-number"> 8 </span>     <span class="hljs-number"> 5889 </span>   -
1511269436.547667       CTc2Qc2kleCjVaU0V1      fe80::ec23:e8b7:91cb:974d      <span class="hljs-number"> 61431 </span>  ff02::1:3      <span class="hljs-number"> 5355 </span>   udp     dns     0.094916       <span class="hljs-number"> 44 </span>    <span class="hljs-number"> 0 </span>      S0      -       -      <span class="hljs-number"> 0 </span>      D      <span class="hljs-number"> 2 </span>     <span class="hljs-number"> 140 </span>   <span class="hljs-number"> 0 </span>      0
1511269436.548234       Cd4aTbH02m0iB9XS9       192.168.56.14  <span class="hljs-number"> 64755 </span>  224.0.0.252    <span class="hljs-number"> 5355 </span>   udp     dns     0.094893       <span class="hljs-number"> 44 </span>    <span class="hljs-number"> 0 </span>      S0      -       -      <span class="hljs-number"> 0 </span>      D      <span class="hljs-number"> 2 </span>     <span class="hljs-number"> 100 </span>   <span class="hljs-number"> 0 </span>     <span class="hljs-number"> 0 </span>      -
1511269445.266039       CjKEcE3tUWBHhYM93d      192.168.56.14  <span class="hljs-number"> 50437 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.214611       <span class="hljs-number"> 683 </span>   <span class="hljs-number"> 482 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 6 </span>     <span class="hljs-number"> 935 </span>   <span class="hljs-number"> 6 </span>     <span class="hljs-number"> 734 </span>    -
1511269446.190550       CNah6o4OZz5Sr5wGq1      192.168.56.14  <span class="hljs-number"> 50438 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.150132       <span class="hljs-number"> 436 </span>   <span class="hljs-number"> 39502 </span>  SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 11 </span>    <span class="hljs-number"> 888 </span>   <span class="hljs-number"> 33 </span>    <span class="hljs-number"> 40834 </span>  -
1511269451.891317       CA6iaN3UgCDI0Sy9x4      192.168.56.14  <span class="hljs-number"> 50439 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.098543       <span class="hljs-number"> 199 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 411 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269457.130160       ChcRft1mTccVo2yQfa      192.168.56.14  <span class="hljs-number"> 50440 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.119445       <span class="hljs-number"> 208 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 420 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269462.359918       Clja4s40wWlk8bkAW4      192.168.56.14  <span class="hljs-number"> 50441 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.129297       <span class="hljs-number"> 199 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 411 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269467.593242       CyE3Th1j6AunL5E3Pl      192.168.56.14  <span class="hljs-number"> 50442 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.181411       <span class="hljs-number"> 204 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 416 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269472.881671       CwuY7B34I442zmY0hf      192.168.56.14  <span class="hljs-number"> 50443 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.121359       <span class="hljs-number"> 199 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 411 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269478.120597       CVPMlj3atDGkCy1xyk      192.168.56.14  <span class="hljs-number"> 50444 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.121619       <span class="hljs-number"> 208 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 420 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269483.366011       Ckn8aZn8c67nuAE19       192.168.56.14  <span class="hljs-number"> 50445 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.122851       <span class="hljs-number"> 208 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 420 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269488.593094       CfeRTH1oejGg6gA5Li      192.168.56.14  <span class="hljs-number"> 50446 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.121150       <span class="hljs-number"> 199 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 411 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269493.824701       CWmiwT4QR8u71xp0h       192.168.56.14  <span class="hljs-number"> 50447 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.126577       <span class="hljs-number"> 204 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 416 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269499.116879       C113hs4IWwgOGe0hxf      192.168.56.14  <span class="hljs-number"> 50448 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.122739       <span class="hljs-number"> 199 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 411 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269504.350011       CHI1AHQLm8ybrQ5ti       192.168.56.14  <span class="hljs-number"> 50449 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.117855       <span class="hljs-number"> 204 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 416 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269509.574454       CIpoyx4Sx3XEyiKbjh      192.168.56.14  <span class="hljs-number"> 50450 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.156094       <span class="hljs-number"> 204 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 416 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269514.842106       CDLbbm2nnHbr3RO9F9      192.168.56.14  <span class="hljs-number"> 50451 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.100951       <span class="hljs-number"> 208 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 420 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269520.114079       CipCM33FvSh7hWVHnc      192.168.56.14  <span class="hljs-number"> 50452 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.135885       <span class="hljs-number"> 204 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 416 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269525.359633       CwMhAI3giczB1gTeR2      192.168.56.14  <span class="hljs-number"> 50453 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.105601       <span class="hljs-number"> 204 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 416 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269530.579134       CowTCpq1Lon2Rp5T2       192.168.56.14  <span class="hljs-number"> 50454 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.115933       <span class="hljs-number"> 199 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 411 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269535.801940       CpYwvc23LmuhPsuuMc      192.168.56.14  <span class="hljs-number"> 50455 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.106631       <span class="hljs-number"> 204 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 416 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269541.044084       Cnvsqj2QcNcWSLBqH7      192.168.56.14  <span class="hljs-number"> 50456 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.121668       <span class="hljs-number"> 199 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 411 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269546.278570       CgbzqfgMFulKOP1xe       192.168.56.14  <span class="hljs-number"> 50457 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.121052       <span class="hljs-number"> 204 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 416 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269551.506084       CUlFD949mmSfKATJpc      192.168.56.14  <span class="hljs-number"> 50458 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.096607       <span class="hljs-number"> 204 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 416 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269556.712264       Cbc1No4FSSjiRQFoNc      192.168.56.14  <span class="hljs-number"> 50459 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.137852       <span class="hljs-number"> 199 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 411 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269561.963394       CYwON91Js8ssOY4503      192.168.56.14  <span class="hljs-number"> 50460 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.099626       <span class="hljs-number"> 199 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 411 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269567.178812       Cryspb4A5KOHbIWDY       192.168.56.14  <span class="hljs-number"> 50461 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.154607       <span class="hljs-number"> 199 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 411 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269572.442802       CRpXje3yCwJlayfhnj      192.168.56.14  <span class="hljs-number"> 50462 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.104125       <span class="hljs-number"> 208 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 420 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269577.652288       CkudtR34qPv7fMdMJ6      192.168.56.14  <span class="hljs-number"> 50463 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.099126       <span class="hljs-number"> 199 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 411 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269582.860772       Cmmlvl4K523e8SjCN6      192.168.56.14  <span class="hljs-number"> 50464 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.164748       <span class="hljs-number"> 199 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 411 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269588.129256       CPaFSTAJAIqVHwzPb       192.168.56.14  <span class="hljs-number"> 50465 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.109133       <span class="hljs-number"> 208 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 420 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269593.348262       CVz6Zn4A42L2kupGIg      192.168.56.14  <span class="hljs-number"> 50466 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.120536       <span class="hljs-number"> 208 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 420 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269598.574770       CHfjXhviIEXv6plH9       192.168.56.14  <span class="hljs-number"> 50467 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.121539       <span class="hljs-number"> 199 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 411 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269603.841610       CuLnP82MDaJG5EGhXf      192.168.56.14  <span class="hljs-number"> 50468 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.100802       <span class="hljs-number"> 204 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 416 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269609.055326       Cx6Ucw4sZSdBcmcIC4      192.168.56.14  <span class="hljs-number"> 50469 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.119905       <span class="hljs-number"> 199 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 411 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269614.297715       C1Fmoa1eqrmEFyfoZe      192.168.56.14  <span class="hljs-number"> 50470 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.101035       <span class="hljs-number"> 204 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 416 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269619.505350       C6d8iu18n9TSiDnsl2      192.168.56.14  <span class="hljs-number"> 50471 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.099847       <span class="hljs-number"> 204 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 416 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269624.718056       CmMGUH37oYmbgIBhlg      192.168.56.14  <span class="hljs-number"> 50472 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.105994       <span class="hljs-number"> 204 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 416 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269629.930502       CzI2GE1TrzEeBO1cTi      192.168.56.14  <span class="hljs-number"> 50473 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.101906       <span class="hljs-number"> 208 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 420 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269635.148168       CjyA8G3Z8uvE4tJVF9      192.168.56.14  <span class="hljs-number"> 50474 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.119757       <span class="hljs-number"> 204 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 416 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269640.373506       CYyb4A2VWcRgAYvWag      192.168.56.14  <span class="hljs-number"> 50475 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.169011       <span class="hljs-number"> 199 </span>   <span class="hljs-number"> 287 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 411 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 499 </span>    -
1511269641.021152       CrYW4H0ghoFV71hA        192.168.56.14  <span class="hljs-number"> 50476 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.455491       <span class="hljs-number"> 438 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 6 </span>     <span class="hljs-number"> 690 </span>   <span class="hljs-number"> 6 </span>     <span class="hljs-number"> 651 </span>    -
1511269646.585189       CbUYsK3SLFNyu6kw1       192.168.56.14  <span class="hljs-number"> 50477 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.101870       <span class="hljs-number"> 204 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 416 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269651.808258       C9p1Kbt661hlXmlXj       192.168.56.14  <span class="hljs-number"> 50478 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.102826       <span class="hljs-number"> 204 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 416 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269657.016924       CvxhCA2BroRtMx3fn8      192.168.56.14  <span class="hljs-number"> 50479 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.115444       <span class="hljs-number"> 199 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 411 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
1511269662.249219       C9uc9Y3j6g4RlJCQE7      192.168.56.14  <span class="hljs-number"> 50480 </span>  51.15.197.127  <span class="hljs-number"> 80 </span>     tcp     http    0.101768       <span class="hljs-number"> 199 </span>   <span class="hljs-number"> 399 </span>    SF      -       -      <span class="hljs-number"> 0 </span>      ShADadfF       <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 411 </span>   <span class="hljs-number"> 5 </span>     <span class="hljs-number"> 611 </span>    -
<span class="hljs-comment">#close  2023-07-16-12-15-40</span>
</code></pre>
<p>If we look carefully enough we will notice connections being made to <code>51.15.197.127:80</code> approximately every 5 seconds, which is indicative of a malware beaconing.</p>
<p>The <code>psempire.pcap</code> file, which is located in the <code>/home/htb-student/pcaps</code> directory includes traffic related to PowerShell Empire. PowerShell Empire indeed beacons every 5 seconds in its default configuration.</p>
<p>Invest some time in scrutinizing the <code>psempire.pcap</code> file using <code>Wireshark</code>.</p>
<p>We can download the PCAP file into the current directory of either Pwnbox or our own VM as follows.</p>
<p>Intrusion Detection With Zeek</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ scp htb-student@[TARGET IP]:/home</span><span class="hljs-regexp">/htb-student/pcaps</span><span class="hljs-regexp">/psempire.pcap .</span>
</code></pre>
<h3 id="intrusion-detection-with-zeek-example-2-detecting-dns-exfiltration">Intrusion Detection With Zeek Example 2: Detecting DNS Exfiltration</h3>
<p>Zeek is also useful when we suspect data exfiltration. Data exfiltration can be difficult to detect as it often mimics normal network traffic. However, with Zeek, we can analyze our network traffic at a deeper level.</p>
<p>Zeek&#39;s files.log can be used to identify large amounts of data being sent to an unusual external destination, or over non-standard ports, which may suggest data exfiltration. The http.log and dns.log can also be utilized to identify potential covert exfiltration channels, such as DNS tunneling or HTTP POST requests to a suspicious domain.</p>
<p>Furthermore, Zeek’s ability to reassemble files transferred over the network (regardless of the protocol used) can assist in identifying the nature of the data being exfiltrated.</p>
<p><strong>PCAP credits to</strong>: <a href="https://twitter.com/LeOleg97">Oleh Levytskyi</a> and <a href="https://twitter.com/bogdanvennyk">Bogdan Vennyk</a></p>
<p>Intrusion Detection With Zeek</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ /</span>usr<span class="hljs-regexp">/local/</span>zeek<span class="hljs-regexp">/bin/</span>zeek -C -r <span class="hljs-regexp">/home/</span>htb-student<span class="hljs-regexp">/pcaps/</span>dnsexfil.pcapng
</code></pre>
<p>Intrusion Detection With Zeek</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat dns.log
#separator \x09
#set_separator  ,
#empty_field    (empty)
#unset_field    -
#path   dns
#open   <span class="hljs-number">2023</span><span class="hljs-number">-07</span><span class="hljs-number">-16</span><span class="hljs-number">-12</span><span class="hljs-number">-28</span><span class="hljs-number">-33</span>
#fields ts      uid     id.orig_h       id.orig_p       id.resp_h       id.resp_p       proto   trans_id        rtt     query   qclass  qclass_name     qtype
        qtype_name      rcode   rcode_name      AA      TC      RD      RA      Z       answers TTLs    rejected
#types  time    <span class="hljs-type">string</span>  addr    port    addr    port    enum    count   interval        <span class="hljs-type">string</span>  count   <span class="hljs-type">string</span>  count   <span class="hljs-type">string</span>  count   <span class="hljs-type">string</span>  bool    boolbool     bool    count   <span class="hljs-type">vector</span>[<span class="hljs-type">string</span>]  <span class="hljs-type">vector</span>[interval]        bool
<span class="hljs-number">1630061362.889769</span>       CogoDL3T2prsNPkXhe      <span class="hljs-number">192.168</span><span class="hljs-number">.38</span><span class="hljs-number">.104</span>  <span class="hljs-number">65463</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.38</span><span class="hljs-number">.102</span>  <span class="hljs-number">53</span>      udp     <span class="hljs-number">53252</span>   <span class="hljs-number">0.043481</span>        safebrowsing.google.com <span class="hljs-number">1</span>   C_INTERNET       <span class="hljs-number">1</span>       A       <span class="hljs-number">0</span>       NOERROR F       F       T       T       <span class="hljs-number">0</span>       sb.l.google.com,<span class="hljs-number">142.250</span><span class="hljs-number">.186</span><span class="hljs-number">.142</span> <span class="hljs-number">18994.000000</span>,<span class="hljs-number">300.000000</span> F
<span class="hljs-number">1630061369.739218</span>       CTlobe1QTqUhc1CzS3      <span class="hljs-number">192.168</span><span class="hljs-number">.38</span><span class="hljs-number">.104</span>  <span class="hljs-number">56692</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.38</span><span class="hljs-number">.102</span>  <span class="hljs-number">53</span>      udp     <span class="hljs-number">32394</span>   <span class="hljs-number">0.145503</span>        <span class="hljs-number">456</span>c54f2.blue.letsgohunt.onli
ne      <span class="hljs-number">1</span>       C_INTERNET      <span class="hljs-number">1</span>       A       <span class="hljs-number">0</span>       NOERROR F       F       T       T       <span class="hljs-number">0</span>       <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span> <span class="hljs-number">0.000000</span>        F
<span class="hljs-number">1630061429.886391</span>       CQPUxP37HbTlSOdLF6      <span class="hljs-number">192.168</span><span class="hljs-number">.38</span><span class="hljs-number">.104</span>  <span class="hljs-number">49611</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.38</span><span class="hljs-number">.102</span>  <span class="hljs-number">53</span>      udp     <span class="hljs-number">64402</span>   <span class="hljs-number">0.142414</span>        <span class="hljs-number">456</span>c54f2.blue.letsgohunt.onli
ne      <span class="hljs-number">1</span>       C_INTERNET      <span class="hljs-number">1</span>       A       <span class="hljs-number">0</span>       NOERROR F       F       T       T       <span class="hljs-number">0</span>       <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span> <span class="hljs-number">1.000000</span>        F
<span class="hljs-number">1630061469.956241</span>       C0JPXx3z0WuxTE9Tbg      <span class="hljs-number">192.168</span><span class="hljs-number">.38</span><span class="hljs-number">.103</span>  <span class="hljs-number">51888</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.38</span><span class="hljs-number">.102</span>  <span class="hljs-number">53</span>      udp     <span class="hljs-number">34124</span>   -       wpad.windomain.local    <span class="hljs-number">1</span>       C_INT
ERNET   <span class="hljs-number">1</span>       A       <span class="hljs-number">3</span>       NXDOMAIN        F       F       T       F       <span class="hljs-number">0</span>       -       -       F
<span class="hljs-number">1630061490.031632</span>       CIMbmp4Wgt287yiERh      <span class="hljs-number">192.168</span><span class="hljs-number">.38</span><span class="hljs-number">.104</span>  <span class="hljs-number">52584</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.38</span><span class="hljs-number">.102</span>  <span class="hljs-number">53</span>      udp     <span class="hljs-number">57411</span>   <span class="hljs-number">0.143350</span>        <span class="hljs-number">456</span>c54f2.blue.letsgohunt.onli
ne      <span class="hljs-number">1</span>       C_INTERNET      <span class="hljs-number">1</span>       A       <span class="hljs-number">0</span>       NOERROR F       F       T       T       <span class="hljs-number">0</span>       <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.241</span>       <span class="hljs-number">1.000000</span>        F
<span class="hljs-number">1630061490.175977</span>       CLwvTc2MIadaIReXQd      <span class="hljs-number">192.168</span><span class="hljs-number">.38</span><span class="hljs-number">.104</span>  <span class="hljs-number">61385</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.38</span><span class="hljs-number">.102</span>  <span class="hljs-number">53</span>      udp     <span class="hljs-number">31811</span>   <span class="hljs-number">0.139366</span>        www<span class="hljs-number">.180</span><span class="hljs-number">.0</span>c9a5671<span class="hljs-number">.456</span>c54f2.blu
e.letsgohunt.online     <span class="hljs-number">1</span>       C_INTERNET      <span class="hljs-number">1</span>       A       <span class="hljs-number">0</span>       NOERROR F       F       T       T       <span class="hljs-number">0</span>       <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span> <span class="hljs-number">1.000000</span>        F
<span class="hljs-number">1630061490.316414</span>       CqbrTf39jEUB1hHd37      <span class="hljs-number">192.168</span><span class="hljs-number">.38</span><span class="hljs-number">.104</span>  <span class="hljs-number">60333</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.38</span><span class="hljs-number">.102</span>  <span class="hljs-number">53</span>      udp     <span class="hljs-number">41259</span>   <span class="hljs-number">0.137040</span>        www<span class="hljs-number">.1204192</span>da26d109d4<span class="hljs-number">.1</span>c9a567
<span class="hljs-number">1.456</span>c54f2.blue.letsgohunt.online       <span class="hljs-number">1</span>       C_INTERNET      <span class="hljs-number">1</span>       A       <span class="hljs-number">0</span>       NOERROR F       F       T       T       <span class="hljs-number">0</span>       <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span> <span class="hljs-number">0.000000</span>    F
<span class="hljs-number">1630061490.454478</span>       CQAWsr3oTT6nmG7Hp4      <span class="hljs-number">192.168</span><span class="hljs-number">.38</span><span class="hljs-number">.104</span>  <span class="hljs-number">53312</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.38</span><span class="hljs-number">.102</span>  <span class="hljs-number">53</span>      udp     <span class="hljs-number">28300</span>   <span class="hljs-number">0.143220</span>        www<span class="hljs-number">.11</span>a1855b98d2b71c3<span class="hljs-number">.2</span>c9a567
<span class="hljs-number">1.456</span>c54f2.blue.letsgohunt.online       <span class="hljs-number">1</span>       C_INTERNET      <span class="hljs-number">1</span>       A       <span class="hljs-number">0</span>       NOERROR F       F       T       T       <span class="hljs-number">0</span>       <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span> <span class="hljs-number">1.000000</span>    F
<span class="hljs-number">1630061490.598615</span>       CF17ZJ2eHvUosEjVC       <span class="hljs-number">192.168</span><span class="hljs-number">.38</span><span class="hljs-number">.104</span>  <span class="hljs-number">64078</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.38</span><span class="hljs-number">.102</span>  <span class="hljs-number">53</span>      udp     <span class="hljs-number">33505</span>   <span class="hljs-number">0.142812</span>        www<span class="hljs-number">.122</span>aa166873fda051<span class="hljs-number">.3</span>c9a567
<span class="hljs-number">1.456</span>c54f2.blue.letsgohunt.online       <span class="hljs-number">1</span>       C_INTERNET      <span class="hljs-number">1</span>       A       <span class="hljs-number">0</span>       NOERROR F       F       T       T       <span class="hljs-number">0</span>       <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span> <span class="hljs-number">1.000000</span>    F
<span class="hljs-number">1630061490.742694</span>       CS0QSmWZe9bUEpNwf       <span class="hljs-number">192.168</span><span class="hljs-number">.38</span><span class="hljs-number">.104</span>  <span class="hljs-number">54465</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.38</span><span class="hljs-number">.102</span>  <span class="hljs-number">53</span>      udp     <span class="hljs-number">5391</span>    <span class="hljs-number">0.144439</span>        www<span class="hljs-number">.1</span>d91f26756080c945<span class="hljs-number">.4</span>c9a567
<span class="hljs-number">1.456</span>c54f2.blue.letsgohunt.online       <span class="hljs-number">1</span>       C_INTERNET      <span class="hljs-number">1</span>       A       <span class="hljs-number">0</span>       NOERROR F       F       T       T       <span class="hljs-number">0</span>       <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span> <span class="hljs-number">1.000000</span>    F
---SNIP---
</code></pre>
<p>Let&#39;s focus on the requested (sub)domains by leveraging <code>zeek-cut</code> as follows.</p>
<p>Intrusion Detection With Zeek</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat dns.log | /usr/local/zeek/bin/zeek-cut query | cut -d . -f1<span class="hljs-number">-7</span>
safebrowsing.google.com
<span class="hljs-number">456</span>c54f2.blue.letsgohunt.online
<span class="hljs-number">456</span>c54f2.blue.letsgohunt.online
wpad.windomain.local
<span class="hljs-number">456</span>c54f2.blue.letsgohunt.online
www<span class="hljs-number">.180</span><span class="hljs-number">.0</span>c9a5671<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
www<span class="hljs-number">.1204192</span>da26d109d4<span class="hljs-number">.1</span>c9a5671<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
www<span class="hljs-number">.11</span>a1855b98d2b71c3<span class="hljs-number">.2</span>c9a5671<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
www<span class="hljs-number">.122</span>aa166873fda051<span class="hljs-number">.3</span>c9a5671<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
www<span class="hljs-number">.1</span>d91f26756080c945<span class="hljs-number">.4</span>c9a5671<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
www<span class="hljs-number">.1302</span>c3663cc8a94f9<span class="hljs-number">.5</span>c9a5671<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
www<span class="hljs-number">.1</span>adef2977e4b3653f<span class="hljs-number">.6</span>c9a5671<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
www<span class="hljs-number">.111</span>edd479a7512c9c<span class="hljs-number">.7</span>c9a5671<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
www<span class="hljs-number">.11483</span>ec078e733131<span class="hljs-number">.8</span>c9a5671<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
www<span class="hljs-number">.1</span>f5e94740470d0157<span class="hljs-number">.9</span>c9a5671<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
www<span class="hljs-number">.114</span>cbea690a81874a.ac9a5671<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
www<span class="hljs-number">.10</span>db7634eade0b736.bc9a5671<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
www<span class="hljs-number">.1</span>d5aee37e1c25ba02.cc9a5671<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
www<span class="hljs-number">.1</span>d4f517cdcf8807c2.dc9a5671<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
www<span class="hljs-number">.14</span>d71477201813b75.ec9a5671<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
www<span class="hljs-number">.1e3723505</span>f4ebd907.fc9a5671<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
www<span class="hljs-number">.1</span>aa645b2d<span class="hljs-number">.10</span>c9a5671<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
www<span class="hljs-number">.1</span>cf2bfe54<span class="hljs-number">.11</span>c9a5671<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn<span class="hljs-number">.0600553</span>f0<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn<span class="hljs-number">.1600553</span>f0<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn<span class="hljs-number">.2600553</span>f0<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn<span class="hljs-number">.3600553</span>f0<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn<span class="hljs-number">.4600553</span>f0<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn<span class="hljs-number">.5600553</span>f0<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn<span class="hljs-number">.6600553</span>f0<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn<span class="hljs-number">.7600553</span>f0<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn<span class="hljs-number">.8600553</span>f0<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn<span class="hljs-number">.9600553</span>f0<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn.a600553f0<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn.b600553f0<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn.c600553f0<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn.d600553f0<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn.e600553f0<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn.f600553f0<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn<span class="hljs-number">.10600553</span>f0<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.140</span><span class="hljs-number">.0346</span>c53ab<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.10</span>bb13b53<span class="hljs-number">.1346</span>c53ab<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.104</span>fb3984<span class="hljs-number">.2346</span>c53ab<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1</span>bdfe1d1e<span class="hljs-number">.3346</span>c53ab<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.19</span>f3acfa6<span class="hljs-number">.4346</span>c53ab<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.18</span>daa4c69<span class="hljs-number">.5346</span>c53ab<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.107</span>f7e44c<span class="hljs-number">.6346</span>c53ab<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1</span>ab508fac<span class="hljs-number">.7346</span>c53ab<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.18</span>ae33d21<span class="hljs-number">.8346</span>c53ab<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.11</span>edd6ce8<span class="hljs-number">.9346</span>c53ab<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1979</span>ee0a5.a346c53ab<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1</span>cc9dd9e9.b346c53ab<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.17</span>b865d4d.c346c53ab<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1212</span>da6de.d346c53ab<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.177</span>a1fc1a.e346c53ab<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.19e7</span>d023b.f346c53ab<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1100</span>b6576<span class="hljs-number">.10346</span>c53ab<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
www<span class="hljs-number">.1</span>f5e94740470d0157<span class="hljs-number">.9</span>c9a5671<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
sgtqrgcask.windomain.local
zvfepxzuazrlds.windomain.local
kohaqbopxlq.windomain.local
www<span class="hljs-number">.1</span>cf2bfe54<span class="hljs-number">.11</span>c9a5671<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
sgtqrgcask.windomain.local
zvfepxzuazrlds.windomain.local
kohaqbopxlq.windomain.local
<span class="hljs-number">456</span>c54f2.blue.letsgohunt.online
wpad.windomain.local
<span class="hljs-number">456</span>c54f2.blue.letsgohunt.online
<span class="hljs-number">456</span>c54f2.blue.letsgohunt.online
cdn<span class="hljs-number">.013821</span>c34<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn<span class="hljs-number">.113821</span>c34<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn<span class="hljs-number">.213821</span>c34<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn<span class="hljs-number">.313821</span>c34<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn<span class="hljs-number">.313821</span>c34<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn<span class="hljs-number">.413821</span>c34<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn<span class="hljs-number">.513821</span>c34<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn<span class="hljs-number">.613821</span>c34<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn<span class="hljs-number">.713821</span>c34<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn<span class="hljs-number">.813821</span>c34<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn<span class="hljs-number">.913821</span>c34<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn.a13821c34<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn.b13821c34<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
cdn.c13821c34<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
<span class="hljs-number">456</span>c54f2.blue.letsgohunt.online
<span class="hljs-number">456</span>c54f2.blue.letsgohunt.online
<span class="hljs-number">456</span>c54f2.blue.letsgohunt.online
<span class="hljs-number">456</span>c54f2.blue.letsgohunt.online
<span class="hljs-number">456</span>c54f2.blue.letsgohunt.online
v10.vortex-win.data.microsoft.com
<span class="hljs-number">456</span>c54f2.blue.letsgohunt.online
<span class="hljs-number">456</span>c54f2.blue.letsgohunt.online
<span class="hljs-number">456</span>c54f2.blue.letsgohunt.online
---SNIP---
post<span class="hljs-number">.1460</span><span class="hljs-number">.0467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.11</span>a878166<span class="hljs-number">.1467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.12</span>c1c89cf<span class="hljs-number">.2467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1</span>bdcdb1fb<span class="hljs-number">.3467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1</span>a6c6349c<span class="hljs-number">.4467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.14</span>f3d0809<span class="hljs-number">.5467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.172</span>d6c024<span class="hljs-number">.6467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.162</span>ef0f19<span class="hljs-number">.7467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.15</span>b5a7d2f<span class="hljs-number">.8467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1286</span>fe5b0<span class="hljs-number">.9467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1</span>fe01b96d.a467121d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1</span>ed530f2f.b467121d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1</span>c8d291d4.c467121d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.153699937</span>.d467121d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.158</span>c0e1f4.e467121d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.139</span>cc5d29.f467121d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1e189482</span>f<span class="hljs-number">.10467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.189</span>c8f742<span class="hljs-number">.11467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1</span>f6a4e146<span class="hljs-number">.12467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.16</span>ec2a953<span class="hljs-number">.13467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.170</span>c0d25b<span class="hljs-number">.14467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.113540390</span><span class="hljs-number">.15467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1</span>ca92006c<span class="hljs-number">.16467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.19092e499</span><span class="hljs-number">.17467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1767e291</span>d<span class="hljs-number">.18467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.15</span>bb03130<span class="hljs-number">.19467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.180</span>fe71ad<span class="hljs-number">.1</span>a467121d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.196</span>a0026d<span class="hljs-number">.1</span>b467121d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.11</span>a2ec7e4<span class="hljs-number">.1</span>c467121d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.179</span>b5c2cb<span class="hljs-number">.1</span>d467121d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1065838</span>ef<span class="hljs-number">.1e467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.10113</span>b20d<span class="hljs-number">.1</span>f467121d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1</span>d78debc8<span class="hljs-number">.20467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.155</span>a1b219<span class="hljs-number">.21467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1</span>b7ccee56<span class="hljs-number">.22467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.13</span>cbcd295<span class="hljs-number">.23467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1</span>adefc484<span class="hljs-number">.24467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1</span>cf6a99a5<span class="hljs-number">.25467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1</span>cc391010<span class="hljs-number">.26467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.18</span>f94bc21<span class="hljs-number">.27467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1</span>bfb7033c<span class="hljs-number">.28467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.18e36</span>fa94<span class="hljs-number">.29467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1</span>d141f783<span class="hljs-number">.2</span>a467121d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.16</span>a96aac3<span class="hljs-number">.2</span>b467121d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1</span>f30c5795<span class="hljs-number">.2</span>c467121d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.196711e3</span>e<span class="hljs-number">.2</span>d467121d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1297</span>f6300<span class="hljs-number">.2e467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.16e18</span>e7dd<span class="hljs-number">.2</span>f467121d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.16</span>a187dd4<span class="hljs-number">.30467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1</span>b164078f<span class="hljs-number">.31467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.15e30</span>ba0e<span class="hljs-number">.32467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1829</span>f67d4<span class="hljs-number">.33467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.17675</span>f25b<span class="hljs-number">.34467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.135</span>fc439b<span class="hljs-number">.35467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.13</span>c0803cb<span class="hljs-number">.36467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
post<span class="hljs-number">.1</span>dbcb3f1b<span class="hljs-number">.37467121</span>d5<span class="hljs-number">.456</span>c54f2.blue.letsgohunt.online
---SNIP---
</code></pre>
<p>Upon close inspection, it becomes evident that the domain <code>letsgohunt.online</code> possesses a significant number of subdomains, similar to cloud providers. However, it&#39;s worth noting that interactions with dozens or even hundreds of subdomains are generally not considered typical behavior.</p>
<p>The <code>dnsexfil.pcapng</code> file, which is located in the <code>/home/htb-student/pcaps</code> directory includes traffic related to DNS exfiltration.</p>
<p>Invest some time in scrutinizing the <code>dnsexfil.pcapng</code> file using <code>Wireshark</code>.</p>
<p>We can download the PCAP file into the current directory of either Pwnbox or our own VM as follows.</p>
<p>Intrusion Detection With Zeek</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ scp htb-student@[TARGET IP]:/home</span><span class="hljs-regexp">/htb-student/pcaps</span><span class="hljs-regexp">/dnsexfil.pcapng .</span>
</code></pre>
<h3 id="intrusion-detection-with-zeek-example-3-detecting-tls-exfiltration">Intrusion Detection With Zeek Example 3: Detecting TLS Exfiltration</h3>
<p><strong>PCAP credits to</strong>: <a href="https://twitter.com/LeOleg97">Oleh Levytskyi</a> and <a href="https://twitter.com/bogdanvennyk">Bogdan Vennyk</a></p>
<p>Let&#39;s now go over an example of detecting data exfiltration over TLS.</p>
<p>Intrusion Detection With Zeek</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ /</span>usr<span class="hljs-regexp">/local/</span>zeek<span class="hljs-regexp">/bin/</span>zeek -C -r <span class="hljs-regexp">/home/</span>htb-student<span class="hljs-regexp">/pcaps/</span>tlsexfil.pcap
</code></pre>
<p>Intrusion Detection With Zeek</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat conn.log
<span class="hljs-comment">#separator \x09</span>
<span class="hljs-comment">#set_separator  ,</span>
<span class="hljs-comment">#empty_field    (empty)</span>
<span class="hljs-comment">#unset_field    -</span>
<span class="hljs-comment">#path   conn</span>
<span class="hljs-comment">#open   2023-07-16-12-48-53</span>
<span class="hljs-comment">#fields ts      uid     id.orig_h       id.orig_p       id.resp_h       id.resp_p       proto   service duration        orig_bytes      resp_bytes      conn_</span>
state   local_orig      local_resp      missed_bytes    history orig_pkts       orig_ip_bytes   resp_pkts       resp_ip_bytes   tunnel_parents
<span class="hljs-comment">#types  time    string  addr    port    addr    port    enum    string  interval        count   count   string  bool    bool    count   string  count   count</span>
        count   count   set[string]
1628867750.258715       CdU24818il2WrB5gx9      fe80::4996:7026:833f:a154      <span class="hljs-number"> 546 </span>    ff02::1:2      <span class="hljs-number"> 547 </span>    udp     -       -       -       -       S0  --      <span class="hljs-number"> 0 </span>      D      <span class="hljs-number"> 1 </span>     <span class="hljs-number"> 152 </span>   <span class="hljs-number"> 0 </span>     <span class="hljs-number"> 0 </span>      -
1628867814.448052       CD4narIi677g3tdG7       10.0.10.100    <span class="hljs-number"> 54754 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     0.097507       <span class="hljs-number"> 646 </span>   <span class="hljs-number"> 1452 </span>   SF      -   -0       ShADadfFR      <span class="hljs-number"> 15 </span>    <span class="hljs-number"> 1258 </span>  <span class="hljs-number"> 13 </span>    <span class="hljs-number"> 1984 </span>   -
1628867874.573558       CCXldM1iyIuyhNiBe2      10.0.10.100    <span class="hljs-number"> 53905 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     0.021315       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 410 </span>    SF      -   -0       ShADadfF       <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 1008 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 782 </span>    -
1628867877.614701       Cg9e9K1AuI0k4cLZd9      10.0.10.100    <span class="hljs-number"> 53906 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     0.010393       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 316 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 10 </span>    <span class="hljs-number"> 1048 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 688 </span>    -
1628867883.643943       CA91RA1mwdLcwUJbEi      10.0.10.100    <span class="hljs-number"> 53931 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     0.007428       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 394 </span>    SF      -   -0       ShADadfF       <span class="hljs-number"> 10 </span>    <span class="hljs-number"> 1048 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 766 </span>    -
1628867880.629877       CpYf8hQlyAnrcCcm3       10.0.10.100    <span class="hljs-number"> 53907 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     6.044923       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 316 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 11 </span>    <span class="hljs-number"> 1088 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 688 </span>    -
1628867883.655898       CGYvJ3saMB5dphXmd       10.0.10.100    <span class="hljs-number"> 53932 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     6.032257       <span class="hljs-number"> 602 </span>   <span class="hljs-number"> 301 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 11 </span>    <span class="hljs-number"> 1054 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 673 </span>    -
1628867889.688558       CM7Uex4iNNNdDuXQI9      10.0.10.100    <span class="hljs-number"> 53935 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     0.058204       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 761668 </span> SF      -   -0       ShADadfFR      <span class="hljs-number"> 251 </span>   <span class="hljs-number"> 10688 </span> <span class="hljs-number"> 530 </span>   <span class="hljs-number"> 782880 </span> -
1628867890.907805       CA797aXtJqeOtKwq2       10.0.10.100    <span class="hljs-number"> 53936 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     0.007216       <span class="hljs-number"> 6489 </span>  <span class="hljs-number"> 301 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 15 </span>    <span class="hljs-number"> 7101 </span>  <span class="hljs-number"> 13 </span>    <span class="hljs-number"> 833 </span>    -
1628867886.675238       CMSija4yWhe79PvBRa      10.0.10.100    <span class="hljs-number"> 53933 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     10.263047      <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 316 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 11 </span>    <span class="hljs-number"> 1088 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 688 </span>    -
1628867893.923082       C08H2y2GdUfnpjolb8      10.0.10.100    <span class="hljs-number"> 53937 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     6.030951       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 316 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 11 </span>    <span class="hljs-number"> 1088 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 688 </span>    -
1628867896.938711       CkM3724NFKT3yly1ba      10.0.10.100    <span class="hljs-number"> 53938 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     6.030904       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 316 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 11 </span>    <span class="hljs-number"> 1088 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 688 </span>    -
1628867902.969959       CPT4hK31bvSaURqWH3      10.0.10.100    <span class="hljs-number"> 53940 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     0.007301       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 316 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 10 </span>    <span class="hljs-number"> 1048 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 688 </span>    -
1628867899.954481       Ccz3Dq202Zm8LFrzWl      10.0.10.100    <span class="hljs-number"> 53939 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     9.046324       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 316 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 11 </span>    <span class="hljs-number"> 1088 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 688 </span>    -
1628867909.001101       C19Vw03nPSvVEqus6a      10.0.10.100    <span class="hljs-number"> 53943 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     0.006624       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 316 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 10 </span>    <span class="hljs-number"> 1048 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 688 </span>    -
1628867912.016361       CNhVAiOpkgAh1R8sc       10.0.10.100    <span class="hljs-number"> 53944 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     0.006317       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 316 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 11 </span>    <span class="hljs-number"> 1088 </span>  <span class="hljs-number"> 10 </span>    <span class="hljs-number"> 728 </span>    -
1628867813.135021       C6tGC34oP3F21KORAa      10.0.10.100    <span class="hljs-number"> 54753 </span>  192.168.151.181<span class="hljs-number"> 80 </span>     tcp     http    100.022854     <span class="hljs-number"> 71 </span>    <span class="hljs-number"> 223946 </span> SF      -   -0       ShADadfFr      <span class="hljs-number"> 61 </span>    <span class="hljs-number"> 2523 </span>  <span class="hljs-number"> 158 </span>   <span class="hljs-number"> 230278 </span> -
1628867915.031768       CFt2xn0eYzCSJ8Tm3       10.0.10.100    <span class="hljs-number"> 53945 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     0.006337       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 316 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 10 </span>    <span class="hljs-number"> 1048 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 688 </span>    -
1628867905.985349       CVQgKN1WiXXgZIEy16      10.0.10.100    <span class="hljs-number"> 53941 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     15.077758      <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 316 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 11 </span>    <span class="hljs-number"> 1088 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 688 </span>    -
1628867921.063426       CPAfjN16aDWelGoQa5      10.0.10.100    <span class="hljs-number"> 53947 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     0.006175       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 316 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 10 </span>    <span class="hljs-number"> 1048 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 688 </span>    -
1628867924.078851       C0p8fW3d4pYpG44Jph      10.0.10.100    <span class="hljs-number"> 53948 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     0.006009       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 394 </span>    SF      -   -0       ShADadfF       <span class="hljs-number"> 10 </span>    <span class="hljs-number"> 1048 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 766 </span>    -
1628867924.087301       CEw1Dx2GLoPquSbp4a      10.0.10.100    <span class="hljs-number"> 53949 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     0.006812       <span class="hljs-number"> 635 </span>   <span class="hljs-number"> 301 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 11 </span>    <span class="hljs-number"> 1087 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 673 </span>    -
1628867918.047485       CgnReehqaJvQprHy        10.0.10.100    <span class="hljs-number"> 53946 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     6.375404       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 316 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 11 </span>    <span class="hljs-number"> 1088 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 688 </span>    -
1628867927.110654       CkC7Zh1hj0i8MwNLJ4      10.0.10.100    <span class="hljs-number"> 53951 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     0.012658       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 94934 </span>  SF      -   -0       ShADadfF       <span class="hljs-number"> 40 </span>    <span class="hljs-number"> 2248 </span>  <span class="hljs-number"> 73 </span>    <span class="hljs-number"> 97866 </span>  -
1628867931.281818       CaKMQO2fekZSAErjP       10.0.10.100    <span class="hljs-number"> 53952 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     0.005757       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 316 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 10 </span>    <span class="hljs-number"> 1048 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 688 </span>    -
1628867931.288461       CjcDcAwMHgOaoxGu6       10.0.10.100    <span class="hljs-number"> 53953 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     0.005921       <span class="hljs-number"> 635 </span>   <span class="hljs-number"> 301 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 11 </span>    <span class="hljs-number"> 1087 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 673 </span>    -
1628867934.297398       CiEfhC2odzlHli49Q2      10.0.10.100    <span class="hljs-number"> 53954 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     0.006077       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 316 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 10 </span>    <span class="hljs-number"> 1048 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 688 </span>    -
1628867937.313352       CfW6Lb4WRMgJUS7Rn8      10.0.10.100    <span class="hljs-number"> 53955 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     3.022240       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 316 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 11 </span>    <span class="hljs-number"> 1088 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 688 </span>    -
1628867940.328753       CerXJm10bIAxgVVqz5      10.0.10.100    <span class="hljs-number"> 53956 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     3.015564       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 316 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 11 </span>    <span class="hljs-number"> 1088 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 688 </span>    -
1628867940.336125       CsAfy6jGo3uLtDAA5       10.0.10.100    <span class="hljs-number"> 53957 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     6.023655       <span class="hljs-number"> 635 </span>   <span class="hljs-number"> 301 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 11 </span>    <span class="hljs-number"> 1087 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 673 </span>    -
1628867946.360157       CFtJB71l1uIyBiy4bl      10.0.10.100    <span class="hljs-number"> 53959 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     0.006221       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 316 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 11 </span>    <span class="hljs-number"> 1088 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 688 </span>    -
1628867949.375797       CXmWZc344kNYukfAZa      10.0.10.100    <span class="hljs-number"> 53961 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     0.005946       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 316 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 10 </span>    <span class="hljs-number"> 1048 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 688 </span>    -
1628867943.344713       C0tEUWB7VYkFzPRVk       10.0.10.100    <span class="hljs-number"> 53958 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     12.062123      <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 316 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 11 </span>    <span class="hljs-number"> 1088 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 688 </span>    -
1628867955.407292       C4BsWIqN2EivsCq78       10.0.10.100    <span class="hljs-number"> 60677 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     0.006345       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 316 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 10 </span>    <span class="hljs-number"> 1048 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 688 </span>    -
1628867952.391209       CQ16vl3UTaFE6CAuP1      10.0.10.100    <span class="hljs-number"> 53962 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     6.037476       <span class="hljs-number"> 636 </span>   <span class="hljs-number"> 316 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 11 </span>    <span class="hljs-number"> 1088 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 688 </span>    -
1628867958.429096       CCgRqF34Zw0NJKdtc7      10.0.10.100    <span class="hljs-number"> 61579 </span>  192.168.151.181<span class="hljs-number"> 443 </span>    tcp     ssl     0.005344       <span class="hljs-number"> 602 </span>   <span class="hljs-number"> 301 </span>    SF      -   -0       ShADadfFR      <span class="hljs-number"> 10 </span>    <span class="hljs-number"> 1014 </span>  <span class="hljs-number"> 9 </span>     <span class="hljs-number"> 673 </span>    -
1628867959.112081       CrCSPSO195LUPz6t2       10.0.10.100    <span class="hljs-number"> 61682 </span>  10.0.10.1      <span class="hljs-number"> 6000 </span>   tcp     -       3.013302       <span class="hljs-number"> 0 </span>     <span class="hljs-number"> 0 </span>      S0      -   -0       S      <span class="hljs-number"> 3 </span>     <span class="hljs-number"> 156 </span>   <span class="hljs-number"> 0 </span>     <span class="hljs-number"> 0 </span>      -
1628867959.112205       CCuH0D1XNvS6KOMR4j      10.0.10.100    <span class="hljs-number"> 61683 </span>  10.0.10.1      <span class="hljs-number"> 5999 </span>   tcp     -       3.013185       <span class="hljs-number"> 0 </span>     <span class="hljs-number"> 0 </span>      S0      -   -0       S      <span class="hljs-number"> 3 </span>     <span class="hljs-number"> 156 </span>   <span class="hljs-number"> 0 </span>     <span class="hljs-number"> 0 </span>      -
1628867959.112399       CpYbPQ1Ea1arKY1GQk      10.0.10.100    <span class="hljs-number"> 61684 </span>  10.0.10.1      <span class="hljs-number"> 5998 </span>   tcp     -       3.012992       <span class="hljs-number"> 0 </span>     <span class="hljs-number"> 0 </span>      S0      -   -0       S      <span class="hljs-number"> 3 </span>     <span class="hljs-number"> 156 </span>   <span class="hljs-number"> 0 </span>     <span class="hljs-number"> 0 </span>      -
1628867959.112573       CpHaau3yHk4ZtqPtS2      10.0.10.100    <span class="hljs-number"> 61685 </span>  10.0.10.1      <span class="hljs-number"> 5997 </span>   tcp     -       3.012820       <span class="hljs-number"> 0 </span>     <span class="hljs-number"> 0 </span>      S0      -   -0       S      <span class="hljs-number"> 3 </span>     <span class="hljs-number"> 156 </span>   <span class="hljs-number"> 0 </span>     <span class="hljs-number"> 0 </span>      -
1628867959.112748       CISSiF3c92oAe9BJPd      10.0.10.100    <span class="hljs-number"> 61686 </span>  10.0.10.1      <span class="hljs-number"> 5996 </span>   tcp     -       3.012646       <span class="hljs-number"> 0 </span>     <span class="hljs-number"> 0 </span>      S0      -   -0       S      <span class="hljs-number"> 3 </span>     <span class="hljs-number"> 156 </span>   <span class="hljs-number"> 0 </span>     <span class="hljs-number"> 0 </span>      -
---SNIP<span class="yaml"><span class="hljs-meta">---</span></span>
</code></pre>
<p>The output is a bit tricky to analyze. Let&#39;s narrow things down by using <code>zeek-cut</code> one more time.</p>
<p><strong>One-liner source</strong>: <a href="https://www.activecountermeasures.com/">activecountermeasures</a></p>
<p>Intrusion Detection With Zeek</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat conn.log | /usr/local/zeek/bin/zeek-cut id.orig_h id.resp_h orig_bytes | sort | grep -v -e '^$' | grep -v '-' | datamash -g <span class="hljs-number">1</span>,<span class="hljs-number">2</span> sum <span class="hljs-number">3</span> | sort -k <span class="hljs-number">3</span> -rn | head <span class="hljs-number">-10</span>
<span class="hljs-number">10.0</span><span class="hljs-number">.10</span><span class="hljs-number">.100</span>     <span class="hljs-number">192.168</span><span class="hljs-number">.151</span><span class="hljs-number">.181</span> <span class="hljs-number">270775912</span>
<span class="hljs-number">10.0</span><span class="hljs-number">.10</span><span class="hljs-number">.100</span>     <span class="hljs-number">10.0</span><span class="hljs-number">.10</span><span class="hljs-number">.1</span>       <span class="hljs-number">0</span>
</code></pre>
<p>Let&#39;s analyze the command above.</p>
<ul>
<li><code>cat conn.log</code>: This command is used to read the content of the conn.log file. The <code>conn.log</code> file, generated by Zeek, provides a record of all connections that have taken place in our network.</li>
<li><code>/usr/local/zeek/bin/zeek-cut id.orig_h id.resp_h orig_bytes</code>: In this case, we&#39;re extracting the <code>id.orig_h</code> (originating host), <code>id.resp_h</code> (responding host), and <code>orig_bytes</code> (number of bytes sent by the originating host) fields.</li>
<li><code>sort</code>: This command is used to sort the output from the previous command. By default, sort will arrange the lines in ascending order based on the contents of the first field (in this case <code>id.orig_h</code>).</li>
<li><code>grep -v -e &#39;^$&#39;</code>: This command filters out any empty lines. The <code>-v</code> option inverts the selection, the <code>-e option allows for a regular expression, and</code> &#39;^$&#39;` matches empty lines.</li>
<li><code>grep -v &#39;-&#39;</code>: This command filters out lines containing a dash <code>-</code>. In the context of Zeek logs, a dash often represents a missing value or an undefined field.</li>
<li><code>datamash -g 1,2 sum 3</code>: <code>datamash</code> is a command-line tool that performs basic numeric, textual, and statistical operations. The <code>-g 1,2</code> option groups the output by the first two fields (the IP addresses of the originating and responding hosts), and <code>sum 3</code> computes the sum of the third field (the number of bytes sent) for each group.</li>
<li><code>sort -k 3 -rn</code>: This command sorts the output of the previous command in descending order (<code>-r</code>) based on the numerical value (<code>-n</code>) of the third field (<code>-k 3</code>), which is the sum of <code>orig_bytes</code> for each pair of IP addresses.</li>
<li><code>head -10</code>: This command is used to limit the output to the top 10 lines, thus showing the top 10 pairs of IP addresses by total bytes sent from the originating host to the responding host.</li>
</ul>
<p>We notice that ~270 MB (actually a bit less) of data have been sent to <code>192.168.151.181</code>.</p>
<p>The <code>tlsexfil.pcap</code> file, which is located in the <code>/home/htb-student/pcaps</code> directory includes traffic related to data exfiltration over TLS.</p>
<p>Invest some time in scrutinizing the <code>tlsexfil.pcap</code> file using <code>Wireshark</code>.</p>
<p>We can download the PCAP file into the current directory of either Pwnbox or our own VM as follows.</p>
<p>Intrusion Detection With Zeek</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ scp htb-student@[TARGET IP]:/home</span><span class="hljs-regexp">/htb-student/pcaps</span><span class="hljs-regexp">/tlsexfil.pcap .</span>
</code></pre>
<h3 id="intrusion-detection-with-zeek-example-4-detecting-psexec">Intrusion Detection With Zeek Example 4: Detecting PsExec</h3>
<p><code>PsExec</code>, a part of the Sysinternals Suite, is frequently used for remote administration within Active Directory environments. Given its powerful capabilities, it&#39;s no surprise that adversaries often prefer <code>PsExec</code> when they carry out remote code execution attacks.</p>
<p>To illustrate a typical attack sequence, let&#39;s consider this: an attacker transfers the binary file <code>PSEXESVC.exe</code> to a target machine using the <code>ADMIN$</code> share, a special shared folder used in Windows networks, via the SMB (Server Message Block) protocol. Following this, the attacker remotely launches this file as a temporary service by utilizing the <code>IPC$</code> share, another special shared resource that enables Inter-Process Communication.</p>
<p>We can identify SMB transfers and the typical use of <code>PsExec</code> using Zeek&#39;s <code>smb_files.log</code>, <code>dce_rpc.log</code>, and <code>smb_mapping.log</code> as follows.</p>
<p><strong>PCAP source</strong>: <a href="https://github.com/401TRG/detections/raw/master/pcaps/20171220\_smb\_psexec\_add\_user.pcap">401TRG</a></p>
<p>Intrusion Detection With Zeek</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ /</span>usr<span class="hljs-regexp">/local/</span>zeek<span class="hljs-regexp">/bin/</span>zeek -C -r <span class="hljs-regexp">/home/</span>htb-student<span class="hljs-regexp">/pcaps/</span>psexec_add_user.pcap
</code></pre>
<p>Intrusion Detection With Zeek</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat smb_files<span class="hljs-selector-class">.log</span>
<span class="hljs-selector-id">#separator</span> \x09
<span class="hljs-selector-id">#set_separator</span>  ,
<span class="hljs-selector-id">#empty_field</span>    (empty)
<span class="hljs-selector-id">#unset_field</span>    -
<span class="hljs-selector-id">#path</span>   smb_files
<span class="hljs-selector-id">#open</span>   <span class="hljs-number">2023</span>-<span class="hljs-number">07</span>-<span class="hljs-number">16</span>-<span class="hljs-number">17</span>-<span class="hljs-number">39</span>-<span class="hljs-number">49</span>
<span class="hljs-selector-id">#fields</span> ts      uid     id<span class="hljs-selector-class">.orig_h</span>       id<span class="hljs-selector-class">.orig_p</span>       id<span class="hljs-selector-class">.resp_h</span>       id<span class="hljs-selector-class">.resp_p</span>       fuid    action  path    name    size    prev_name       times<span class="hljs-selector-class">.modified</span>  times<span class="hljs-selector-class">.accessed</span>        times<span class="hljs-selector-class">.created</span>   times<span class="hljs-selector-class">.changed</span>
<span class="hljs-selector-id">#types</span>  <span class="hljs-selector-tag">time</span>    string  addr    port    addr    port    string  enum    string  string  count   string  <span class="hljs-selector-tag">time</span>    <span class="hljs-selector-tag">time</span>    <span class="hljs-selector-tag">time</span>    <span class="hljs-selector-tag">time</span>
<span class="hljs-number">1507567479.268789</span>       CksrR04Pziy7EPYOT6      <span class="hljs-number">192.168</span>.<span class="hljs-number">10.31</span>   <span class="hljs-number">49282</span>   <span class="hljs-number">192.168</span>.<span class="hljs-number">10.10</span>   <span class="hljs-number">445</span>     -       SMB::FILE_OPEN  \\\\dc1\\ADMIN$ PSEXESVC<span class="hljs-selector-class">.exe</span>    <span class="hljs-number">0</span>       -    <span class="hljs-number">1507567479.122923</span>        <span class="hljs-number">1507567479.122923</span>       <span class="hljs-number">1507567479.122923</span>       <span class="hljs-number">1507567479.122923</span>
<span class="hljs-number">1507567500.496785</span>       CgPykN2qCki9kzhoh6      <span class="hljs-number">192.168</span>.<span class="hljs-number">10.31</span>   <span class="hljs-number">49285</span>   <span class="hljs-number">192.168</span>.<span class="hljs-number">10.10</span>   <span class="hljs-number">445</span>     -       SMB::FILE_OPEN  \\\\dc1\\ADMIN$ PSEXESVC<span class="hljs-selector-class">.exe</span>    <span class="hljs-number">145568</span>  -    <span class="hljs-number">1507567479.122923</span>        <span class="hljs-number">1507567479.122923</span>       <span class="hljs-number">1507567479.122923</span>       <span class="hljs-number">1507567479.122923</span>
<span class="hljs-number">1507567500.496785</span>       CgPykN2qCki9kzhoh6      <span class="hljs-number">192.168</span>.<span class="hljs-number">10.31</span>   <span class="hljs-number">49285</span>   <span class="hljs-number">192.168</span>.<span class="hljs-number">10.10</span>   <span class="hljs-number">445</span>     -       SMB::FILE_DELETE        \\\\dc1\\ADMIN$ PSEXESVC<span class="hljs-selector-class">.exe</span>    <span class="hljs-number">145568</span>-       <span class="hljs-number">1507567479.122923</span>       <span class="hljs-number">1507567479.122923</span>       <span class="hljs-number">1507567479.122923</span>       <span class="hljs-number">1507567479.122923</span>
<span class="hljs-selector-id">#close</span>  <span class="hljs-number">2023</span>-<span class="hljs-number">07</span>-<span class="hljs-number">16</span>-<span class="hljs-number">17</span>-<span class="hljs-number">39</span>-<span class="hljs-number">49</span>
</code></pre>
<p>Intrusion Detection With Zeek</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat dce_rpc.log
#separator \x09
#set_separator  ,
#empty_field    (empty)
#unset_field    -
#path   dce_rpc
#open   <span class="hljs-number">2023</span><span class="hljs-number">-07</span><span class="hljs-number">-16</span><span class="hljs-number">-17</span><span class="hljs-number">-39</span><span class="hljs-number">-49</span>
#fields ts      uid     id.orig_h       id.orig_p       id.resp_h       id.resp_p       rtt     named_pipe      endpoint        operation
#types  time    <span class="hljs-type">string</span>  addr    port    addr    port    interval        <span class="hljs-type">string</span>  <span class="hljs-type">string</span>  <span class="hljs-type">string</span>
<span class="hljs-number">1507567479.286323</span>       CBZaDq4j7VDeXjASO4      <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.31</span>   <span class="hljs-number">49283</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span>   <span class="hljs-number">135</span>     <span class="hljs-number">0.000286</span>        <span class="hljs-number">135</span>     epmapper        ept_map
<span class="hljs-number">1507567500.281997</span>       CgPykN2qCki9kzhoh6      <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.31</span>   <span class="hljs-number">49285</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span>   <span class="hljs-number">445</span>     <span class="hljs-number">0.000276</span>        \\pipe\\ntsvcs  svcctl  OpenSCManagerW
<span class="hljs-number">1507567500.282353</span>       CgPykN2qCki9kzhoh6      <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.31</span>   <span class="hljs-number">49285</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span>   <span class="hljs-number">445</span>     <span class="hljs-number">0.019995</span>        \\pipe\\ntsvcs  svcctl  CreateServiceWOW64W
<span class="hljs-number">1507567500.302505</span>       CgPykN2qCki9kzhoh6      <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.31</span>   <span class="hljs-number">49285</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span>   <span class="hljs-number">445</span>     <span class="hljs-number">0.000336</span>        \\pipe\\ntsvcs  svcctl  CloseServiceHandle
<span class="hljs-number">1507567500.302907</span>       CgPykN2qCki9kzhoh6      <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.31</span>   <span class="hljs-number">49285</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span>   <span class="hljs-number">445</span>     <span class="hljs-number">0.000281</span>        \\pipe\\ntsvcs  svcctl  OpenServiceW
<span class="hljs-number">1507567500.303301</span>       CgPykN2qCki9kzhoh6      <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.31</span>   <span class="hljs-number">49285</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span>   <span class="hljs-number">445</span>     <span class="hljs-number">0.010072</span>        \\pipe\\ntsvcs  svcctl  StartServiceW
<span class="hljs-number">1507567500.313520</span>       CgPykN2qCki9kzhoh6      <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.31</span>   <span class="hljs-number">49285</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span>   <span class="hljs-number">445</span>     <span class="hljs-number">0.000785</span>        \\pipe\\ntsvcs  svcctl  QueryServiceStatus
<span class="hljs-number">1507567500.418004</span>       CgPykN2qCki9kzhoh6      <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.31</span>   <span class="hljs-number">49285</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span>   <span class="hljs-number">445</span>     <span class="hljs-number">0.000503</span>        \\pipe\\ntsvcs  svcctl  QueryServiceStatus
<span class="hljs-number">1507567500.418589</span>       CgPykN2qCki9kzhoh6      <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.31</span>   <span class="hljs-number">49285</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span>   <span class="hljs-number">445</span>     <span class="hljs-number">0.000323</span>        \\pipe\\ntsvcs  svcctl  CloseServiceHandle
<span class="hljs-number">1507567500.418987</span>       CgPykN2qCki9kzhoh6      <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.31</span>   <span class="hljs-number">49285</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span>   <span class="hljs-number">445</span>     <span class="hljs-number">0.000319</span>        \\pipe\\ntsvcs  svcctl  CloseServiceHandle
<span class="hljs-number">1507567500.490481</span>       CgPykN2qCki9kzhoh6      <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.31</span>   <span class="hljs-number">49285</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span>   <span class="hljs-number">445</span>     <span class="hljs-number">0.000264</span>        \\pipe\\ntsvcs  svcctl  OpenSCManagerW
<span class="hljs-number">1507567500.490791</span>       CgPykN2qCki9kzhoh6      <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.31</span>   <span class="hljs-number">49285</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span>   <span class="hljs-number">445</span>     <span class="hljs-number">0.000365</span>        \\pipe\\ntsvcs  svcctl  OpenServiceW
<span class="hljs-number">1507567500.491208</span>       CgPykN2qCki9kzhoh6      <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.31</span>   <span class="hljs-number">49285</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span>   <span class="hljs-number">445</span>     <span class="hljs-number">0.000717</span>        \\pipe\\ntsvcs  svcctl  ControlService
<span class="hljs-number">1507567500.491979</span>       CgPykN2qCki9kzhoh6      <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.31</span>   <span class="hljs-number">49285</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span>   <span class="hljs-number">445</span>     <span class="hljs-number">0.000541</span>        \\pipe\\ntsvcs  svcctl  QueryServiceStatus
<span class="hljs-number">1507567500.492567</span>       CgPykN2qCki9kzhoh6      <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.31</span>   <span class="hljs-number">49285</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span>   <span class="hljs-number">445</span>     <span class="hljs-number">0.001564</span>        \\pipe\\ntsvcs  svcctl  CloseServiceHandle
<span class="hljs-number">1507567500.494209</span>       CgPykN2qCki9kzhoh6      <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.31</span>   <span class="hljs-number">49285</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span>   <span class="hljs-number">445</span>     <span class="hljs-number">0.000314</span>        \\pipe\\ntsvcs  svcctl  OpenServiceW
<span class="hljs-number">1507567500.494619</span>       CgPykN2qCki9kzhoh6      <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.31</span>   <span class="hljs-number">49285</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span>   <span class="hljs-number">445</span>     <span class="hljs-number">0.000399</span>        \\pipe\\ntsvcs  svcctl  DeleteService
<span class="hljs-number">1507567500.495069</span>       CgPykN2qCki9kzhoh6      <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.31</span>   <span class="hljs-number">49285</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span>   <span class="hljs-number">445</span>     <span class="hljs-number">0.000374</span>        \\pipe\\ntsvcs  svcctl  CloseServiceHandle
<span class="hljs-number">1507567500.495494</span>       CgPykN2qCki9kzhoh6      <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.31</span>   <span class="hljs-number">49285</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span>   <span class="hljs-number">445</span>     <span class="hljs-number">0.000265</span>        \\pipe\\ntsvcs  svcctl  CloseServiceHandle
#close  <span class="hljs-number">2023</span><span class="hljs-number">-07</span><span class="hljs-number">-16</span><span class="hljs-number">-17</span><span class="hljs-number">-39</span><span class="hljs-number">-49</span>
</code></pre>
<p>Intrusion Detection With Zeek</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat smb_mapping.log
#separator \x09
#set_separator  ,
#empty_field    (empty)
#unset_field    -
#path   smb_mapping
#open   <span class="hljs-number">2023</span><span class="hljs-number">-07</span><span class="hljs-number">-16</span><span class="hljs-number">-17</span><span class="hljs-number">-39</span><span class="hljs-number">-49</span>
#fields ts      uid     id.orig_h       id.orig_p       id.resp_h       id.resp_p       path    service native_file_system      share_type
#types  time    <span class="hljs-type">string</span>  addr    port    addr    port    <span class="hljs-type">string</span>  <span class="hljs-type">string</span>  <span class="hljs-type">string</span>  <span class="hljs-type">string</span>
<span class="hljs-number">1507567479.268407</span>       CksrR04Pziy7EPYOT6      <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.31</span>   <span class="hljs-number">49282</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span>   <span class="hljs-number">445</span>     \\\\dc1\\ADMIN$ -       -       DISK
<span class="hljs-number">1507567500.280462</span>       CgPykN2qCki9kzhoh6      <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.31</span>   <span class="hljs-number">49285</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span>   <span class="hljs-number">445</span>     \\\\dc1\\IPC$   -       -       PIPE
<span class="hljs-number">1507567500.496371</span>       CgPykN2qCki9kzhoh6      <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.31</span>   <span class="hljs-number">49285</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span>   <span class="hljs-number">445</span>     \\\\dc1\\ADMIN$ -       -       DISK
#close  <span class="hljs-number">2023</span><span class="hljs-number">-07</span><span class="hljs-number">-16</span><span class="hljs-number">-17</span><span class="hljs-number">-39</span><span class="hljs-number">-49</span>
</code></pre>
<p>The temporary service creation is apparent in the last two logs above.</p>
<p>The <code>psexec_add_user.pcap</code> file, which is located in the <code>/home/htb-student/pcaps</code> directory includes traffic related to typical PsExec usage.</p>
<p>Invest some time in scrutinizing the <code>psexec_add_user.pcap</code> file using <code>Wireshark</code>.</p>
<p>We can download the PCAP file into the current directory of either Pwnbox or our own VM as follows.</p>
<p>Intrusion Detection With Zeek</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ scp htb-student@[TARGET IP]:/home</span><span class="hljs-regexp">/htb-student/pcaps</span><span class="hljs-regexp">/psexec_add_user.pcap .</span>
</code></pre>
