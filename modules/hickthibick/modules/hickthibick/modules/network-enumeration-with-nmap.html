<body>
  <div class="container">
<link rel="stylesheet" href="style.css">


<h1 id="1-network-enumeration-with-nmap">1. Network Enumeration with Nmap</h1>
<h2 id="-cheat-sheet-"><strong>Cheat Sheet</strong></h2>
<p>The cheat sheet is a useful command reference for this module.</p>
<h3 id="scanning-options">Scanning Options</h3>
<table>
<thead>
<tr>
<th><strong>Nmap Option</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.10.10.0/24</code></td>
<td>Target network range.</td>
</tr>
<tr>
<td><code>-sn</code></td>
<td>Disables port scanning.</td>
</tr>
<tr>
<td><code>-Pn</code></td>
<td>Disables ICMP Echo Requests</td>
</tr>
<tr>
<td><code>-n</code></td>
<td>Disables DNS Resolution.</td>
</tr>
<tr>
<td><code>-PE</code></td>
<td>Performs the ping scan by using ICMP Echo Requests against the target.</td>
</tr>
<tr>
<td><code>--packet-trace</code></td>
<td>Shows all packets sent and received.</td>
</tr>
<tr>
<td><code>--reason</code></td>
<td>Displays the reason for a specific result.</td>
</tr>
<tr>
<td><code>--disable-arp-ping</code></td>
<td>Disables ARP Ping Requests.</td>
</tr>
<tr>
<td><code>--top-ports=&lt;num&gt;</code></td>
<td>Scans the specified top ports that have been defined as most frequent.</td>
</tr>
<tr>
<td><code>-p-</code></td>
<td>Scan all ports.</td>
</tr>
<tr>
<td><code>-p22-110</code></td>
<td>Scan all ports between 22 and 110.</td>
</tr>
<tr>
<td><code>-p22,25</code></td>
<td>Scans only the specified ports 22 and 25.</td>
</tr>
<tr>
<td><code>-F</code></td>
<td>Scans top 100 ports.</td>
</tr>
<tr>
<td><code>-sS</code></td>
<td>Performs an TCP SYN-Scan.</td>
</tr>
<tr>
<td><code>-sA</code></td>
<td>Performs an TCP ACK-Scan.</td>
</tr>
<tr>
<td><code>-sU</code></td>
<td>Performs an UDP Scan.</td>
</tr>
<tr>
<td><code>-sV</code></td>
<td>Scans the discovered services for their versions.</td>
</tr>
<tr>
<td><code>-sC</code></td>
<td>Perform a Script Scan with scripts that are categorized as &quot;default&quot;.</td>
</tr>
<tr>
<td><code>--script &lt;script&gt;</code></td>
<td>Performs a Script Scan by using the specified scripts.</td>
</tr>
<tr>
<td><code>-O</code></td>
<td>Performs an OS Detection Scan to determine the OS of the target.</td>
</tr>
<tr>
<td><code>-A</code></td>
<td>Performs OS Detection, Service Detection, and traceroute scans.</td>
</tr>
<tr>
<td><code>-D RND:5</code></td>
<td>Sets the number of random Decoys that will be used to scan the target.</td>
</tr>
<tr>
<td><code>-e</code></td>
<td>Specifies the network interface that is used for the scan.</td>
</tr>
<tr>
<td><code>-S 10.10.10.200</code></td>
<td>Specifies the source IP address for the scan.</td>
</tr>
<tr>
<td><code>-g</code></td>
<td>Specifies the source port for the scan.</td>
</tr>
<tr>
<td><code>--dns-server &lt;ns&gt;</code></td>
<td>DNS resolution is performed by using a specified name server.</td>
</tr>
</tbody>
</table>
<h3 id="output-options">Output Options</h3>
<table>
<thead>
<tr>
<th><strong>Nmap Option</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-oA filename</code></td>
<td>Stores the results in all available formats starting with the name of &quot;filename&quot;.</td>
</tr>
<tr>
<td><code>-oN filename</code></td>
<td>Stores the results in normal format with the name &quot;filename&quot;.</td>
</tr>
<tr>
<td><code>-oG filename</code></td>
<td>Stores the results in &quot;grepable&quot; format with the name of &quot;filename&quot;.</td>
</tr>
<tr>
<td><code>-oX filename</code></td>
<td>Stores the results in XML format with the name of &quot;filename&quot;.</td>
</tr>
</tbody>
</table>
<h3 id="performance-options">Performance Options</h3>
<table>
<thead>
<tr>
<th><strong>Nmap Option</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--max-retries &lt;num&gt;</code></td>
<td>Sets the number of retries for scans of specific ports.</td>
</tr>
<tr>
<td><code>--stats-every=5s</code></td>
<td>Displays scan&#39;s status every 5 seconds.</td>
</tr>
<tr>
<td><code>-v/-vv</code></td>
<td>Displays verbose output during the scan.</td>
</tr>
<tr>
<td><code>--initial-rtt-timeout 50ms</code></td>
<td>Sets the specified time value as initial RTT timeout.</td>
</tr>
<tr>
<td><code>--max-rtt-timeout 100ms</code></td>
<td>Sets the specified time value as maximum RTT timeout.</td>
</tr>
<tr>
<td><code>--min-rate 300</code></td>
<td>Sets the number of packets that will be sent simultaneously.</td>
</tr>
<tr>
<td><code>-T &lt;0-5&gt;</code></td>
<td>Specifies the specific timing template.</td>
</tr>
</tbody>
</table>
<h2 id="enumeration">Enumeration</h2>
<hr>
<p><code>Enumeration</code> is the most critical part of all. The art, the difficulty, and the goal are not to gain access to our target computer. Instead, it is identifying all of the ways we could attack a target we must find.</p>
<p>It is not just based on the tools we use. They will only do much good if we know what to do with the information we get from them. The tools are just tools, and tools alone should never replace our knowledge and our attention to detail. Here it is much more about actively interacting with the individual services to see what information they provide us and what possibilities they offer us.</p>
<p>It is essential to understand how these services work and what syntax they use for effective communication and interaction with the different services.</p>
<p>This phase aims to improve our knowledge and understanding of the technologies, protocols, and how they work and learn to deal with new information and adapt to our already acquired knowledge. Enumeration is collecting as much information as possible. The more information we have, the easier it will be for us to find vectors of attack.</p>
<p>Imagine the following situation:</p>
<p>Our partner is not at home and has misplaced our car keys. We call our partner and ask where the keys are. If we get an answer like &quot;in the living room,&quot; it is entirely unclear and can take much time to find them there. However, what if our partner tells us something like &quot;in the living room on the white shelf, next to the TV, in the third drawer&quot;? As a result, it will be much easier to find them.</p>
<p>It&#39;s not hard to get access to the target system once we know how to do it. Most of the ways we can get access we can narrow down to the following two points:</p>
<p>When scanning and inspecting, we look exactly for these two possibilities. Most of the information we get comes from misconfigurations or neglect of security for the respective services. Misconfigurations are either the result of ignorance or a wrong security mindset. For example, if the administrator only relies on the firewall, Group Policy Objects (GPOs), and continuous updates, it is often not enough to secure the network.</p>
<p><code>Enumeration is the key</code>.</p>
<p>That&#39;s what most people say, and they are right. However, it is too often misunderstood. Most people understand that they haven&#39;t tried all the tools to get the information they need. Most of the time, however, it&#39;s not the tools we haven&#39;t tried, but rather the fact that we don&#39;t know how to interact with the service and what&#39;s relevant.</p>
<p>That&#39;s precisely the reason why so many people stay stuck in one spot and don&#39;t get ahead. Had these people invested a couple of hours learning more about the service, how it works, and what it is meant for, they would save a few hours or even days from reaching their goal and get access to the system.</p>
<p><code>Manual enumeration</code> is a <code>critical</code> component. Many scanning tools simplify and accelerate the process. However, these cannot always bypass the security measures of the services. The easiest way to illustrate this is to use the following example:</p>
<p>Most scanning tools have a timeout set until they receive a response from the service. If this tool does not respond within a specific time, this service/port will be marked as closed, filtered, or unknown. In the last two cases, we will still be able to work with it. However, if a port is marked as closed and Nmap doesn&#39;t show it to us, we will be in a bad situation. This service/port may provide us with the opportunity to find a way to access the system. Therefore, this result can take much unnecessary time until we find it.</p>
<h2 id="introduction-to-nmap">Introduction to Nmap</h2>
<hr>
<p>Network Mapper (<code>Nmap</code>) is an open-source network analysis and security auditing tool written in C, C++, Python, and Lua. It is designed to scan networks and identify which hosts are available on the network using raw packets, and services and applications, including the name and version, where possible. It can also identify the operating systems and versions of these hosts. Besides other features, Nmap also offers scanning capabilities that can determine if packet filters, firewalls, or intrusion detection systems (IDS) are configured as needed.</p>
<hr>
<h3 id="use-cases">Use Cases</h3>
<p>The tool is one of the most used tools by network administrators and IT security specialists. It is used to:</p>
<ul>
<li>Audit the security aspects of networks</li>
<li>Simulate penetration tests</li>
<li>Check firewall and IDS settings and configurations</li>
<li>Types of possible connections</li>
<li>Network mapping</li>
<li>Response analysis</li>
<li>Identify open ports</li>
<li>Vulnerability assessment as well.</li>
</ul>
<hr>
<h3 id="nmap-architecture">Nmap Architecture</h3>
<p>Nmap offers many different types of scans that can be used to obtain various results about our targets. Basically, Nmap can be divided into the following scanning techniques:</p>
<ul>
<li>Host discovery</li>
<li>Port scanning</li>
<li>Service enumeration and detection</li>
<li>OS detection</li>
<li>Scriptable interaction with the target service (Nmap Scripting Engine)</li>
</ul>
<hr>
<h3 id="syntax">Syntax</h3>
<p>The syntax for Nmap is fairly simple and looks like this:</p>
<p>Introduction to Nmap</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb[/htb]$</span> nmap <span class="hljs-variable">&lt;scan types&gt;</span> <span class="hljs-variable">&lt;options&gt;</span> <span class="hljs-variable">&lt;target&gt;</span>
</code></pre>
<hr>
<h3 id="scan-techniques">Scan Techniques</h3>
<p>Nmap offers many different scanning techniques, making different types of connections and using differently structured packets to send. Here we can see all the scanning techniques Nmap offers:</p>
<p>Introduction to Nmap</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ nmap --help

&lt;SNIP&gt;
SCAN TECHNIQUES:
  -<span class="ruby">sS/sT/sA/sW/<span class="hljs-symbol">sM:</span> TCP SYN/Connect()/ACK/Window/Maimon scans
</span>  -<span class="ruby"><span class="hljs-symbol">sU:</span> UDP Scan
</span>  -<span class="ruby">sN/sF/<span class="hljs-symbol">sX:</span> TCP Null, FIN, <span class="hljs-keyword">and</span> Xmas scans
</span>  -<span class="ruby">-scanflags &lt;flags&gt;: Customize TCP scan flags
</span>  -<span class="ruby">sI &lt;zombie host[<span class="hljs-symbol">:probeport</span>]&gt;: Idle scan
</span>  -<span class="ruby">sY/<span class="hljs-symbol">sZ:</span> SCTP INIT/COOKIE-ECHO scans
</span>  -<span class="ruby"><span class="hljs-symbol">sO:</span> IP protocol scan
</span>  -<span class="ruby">b &lt;FTP relay host&gt;: FTP bounce scan
</span>&lt;SNIP&gt;
</code></pre>
<p>For example, the TCP-SYN scan (<code>-sS</code>) is one of the default settings unless we have defined otherwise and is also one of the most popular scan methods. This scan method makes it possible to scan several thousand ports per second. The TCP-SYN scan sends one packet with the SYN flag and, therefore, never completes the three-way handshake, which results in not establishing a full TCP connection to the scanned port.</p>
<ul>
<li>If our target sends an <code>SYN-ACK</code> flagged packet back to the scanned port, Nmap detects that the port is <code>open</code>.</li>
<li>If the packet receives an <code>RST</code> flag, it is an indicator that the port is <code>closed</code>.</li>
<li>If Nmap does not receive a packet back, it will display it as <code>filtered</code>. Depending on the firewall configuration, certain packets may be dropped or ignored by the firewall.</li>
</ul>
<p>Let us take an example of such a scan.</p>
<p>Introduction to Nmap</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo <span class="hljs-keyword">nmap</span> -sS localhost

Starting Nmap <span class="hljs-number">7.80</span> ( http<span class="hljs-variable">s:</span>//<span class="hljs-keyword">nmap</span>.org ) at <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">11</span> <span class="hljs-number">22</span>:<span class="hljs-number">50</span> UTC
Nmap scan report <span class="hljs-keyword">for</span> localhost (<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>)
Host <span class="hljs-keyword">is</span> <span class="hljs-keyword">up</span> (<span class="hljs-number">0.000010</span>s latency).
Not shown: <span class="hljs-number">996</span> closed ports
PORT     STATE SERVICE
<span class="hljs-number">22</span>/tcp   <span class="hljs-keyword">open</span>  ssh
<span class="hljs-number">80</span>/tcp   <span class="hljs-keyword">open</span>  http
<span class="hljs-number">5432</span>/tcp <span class="hljs-keyword">open</span>  postgresql
<span class="hljs-number">5901</span>/tcp <span class="hljs-keyword">open</span>  vnc-<span class="hljs-number">1</span>

Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host <span class="hljs-keyword">up</span>) scanned in <span class="hljs-number">0.18</span> seconds
</code></pre>
<p>In this example, we can see that we have four different TCP ports open. In the first column, we see the number of the port. Then, in the second column, we see the service&#39;s status and then what kind of service it is.</p>
<h2 id="host-discovery">Host Discovery</h2>
<hr>
<p>When we need to conduct an internal penetration test for the entire network of a company, for example, then we should, first of all, get an overview of which systems are online that we can work with. To actively discover such systems on the network, we can use various <code>Nmap</code> host discovery options. There are many options <code>Nmap</code> provides to determine whether our target is alive or not. The most effective host discovery method is to use <strong>ICMP echo requests</strong>, which we will look into.</p>
<p>It is always recommended to store every single scan. This can later be used for comparison, documentation, and reporting. After all, different tools may produce different results. Therefore it can be beneficial to distinguish which tool produces which results.</p>
<p><strong>Scan Network Range</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> -sn -oA tnet | grep for | cut -d<span class="hljs-string">" "</span> -f5

<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.4</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.10</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.11</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.18</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.19</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.20</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span>
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.0/24</code></td>
<td>Target network range.</td>
</tr>
<tr>
<td><code>-sn</code></td>
<td>Disables port scanning.</td>
</tr>
<tr>
<td><code>-oA tnet</code></td>
<td>Stores the results in all formats starting with the name &#39;tnet&#39;.</td>
</tr>
</tbody>
</table>
<p>This scanning method works only if the firewalls of the hosts allow it. Otherwise, we can use other scanning techniques to find out if the hosts are active or not. We will take a closer look at these techniques in &quot;<code>Firewall and IDS Evasion</code>&quot;.</p>
<hr>
<h3 id="scan-ip-list">Scan IP List</h3>
<p>During an internal penetration test, it is not uncommon for us to be provided with an IP list with the hosts we need to test. <code>Nmap</code> also gives us the option of working with lists and reading the hosts from this list instead of manually defining or typing them in.</p>
<p>Such a list could look something like this:</p>
<pre><code class="lang-shell-session">[!bash!]$ cat hosts.lst

<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.4</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.10</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.11</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.18</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.19</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.20</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span>
</code></pre>
<p>If we use the same scanning technique on the predefined list, the command will look like this:</p>
<pre><code class="lang-shell-session">[!bash!]$ sudo nmap -sn -oA tnet -iL hosts.lst | grep for | cut -d<span class="hljs-string">" "</span> -f5

<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.18</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.19</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.20</span>
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-sn</code></td>
<td>Disables port scanning.</td>
</tr>
<tr>
<td><code>-oA tnet</code></td>
<td>Stores the results in all formats starting with the name &#39;tnet&#39;.</td>
</tr>
<tr>
<td><code>-iL</code></td>
<td>Performs defined scans against targets in provided &#39;hosts.lst&#39; list.</td>
</tr>
</tbody>
</table>
<p>In this example, we see that only 3 of 7 hosts are active. Remember, this may mean that the other hosts ignore the default <strong>ICMP echo requests</strong> because of their firewall configurations. Since <code>Nmap</code> does not receive a response, it marks those hosts as inactive.</p>
<hr>
<h3 id="scan-multiple-ips">Scan Multiple IPs</h3>
<p>It can also happen that we only need to scan a small part of a network. An alternative to the method we used last time is to specify multiple IP addresses.</p>
<pre><code class="lang-shell-session">[!bash!]$ sudo nmap -sn -oA tnet <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.18</span> <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.19</span> <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.20</span>| grep for | cut -d<span class="hljs-string">" "</span> -f5

<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.18</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.19</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.20</span>
</code></pre>
<p>If these IP addresses are next to each other, we can also define the range in the respective octet.</p>
<pre><code class="lang-shell-session">[!bash!]$ sudo nmap -sn -oA tnet <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.18</span><span class="hljs-number">-20</span>| grep for | cut -d<span class="hljs-string">" "</span> -f5

<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.18</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.19</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.20</span>
</code></pre>
<hr>
<h3 id="scan-single-ip">Scan Single IP</h3>
<p>Before we scan a single host for open ports and its services, we first have to determine if it is alive or not. For this, we can use the same method as before.</p>
<pre><code class="lang-shell-session">[!bash!]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.18</span> -sn -oA host 

Starting Nmap <span class="hljs-number">7.80</span> ( <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org ) at 2020-06-14 23:59 CEST</span>
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.18</span>
Host is up (<span class="hljs-number">0.087</span>s latency).
MAC <span class="hljs-string">Address:</span> <span class="hljs-string">DE:</span><span class="hljs-string">AD:</span><span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-string">BE:</span>EF
Nmap <span class="hljs-string">done:</span> <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.11</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.18</code></td>
<td>Performs defined scans against the target.</td>
</tr>
<tr>
<td><code>-sn</code></td>
<td>Disables port scanning.</td>
</tr>
<tr>
<td><code>-oA host</code></td>
<td>Stores the results in all formats starting with the name &#39;host&#39;.</td>
</tr>
</tbody>
</table>
<p>If we disable port scan (<code>-sn</code>), Nmap automatically ping scan with <code>ICMP Echo Requests</code> (<code>-PE</code>). Once such a request is sent, we usually expect an <code>ICMP reply</code> if the pinging host is alive. The more interesting fact is that our previous scans did not do that because before Nmap could send an ICMP echo request, it would send an <code>ARP ping</code> resulting in an <code>ARP reply</code>. We can confirm this with the &quot;<code>--packet-trace</code>&quot; option. To ensure that ICMP echo requests are sent, we also define the option (<code>-PE</code>) for this.</p>
<pre><code class="lang-shell-session">[!bash!]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span> -sn -oA host -PE --packet-trace 

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">00</span>:<span class="hljs-number">08</span> CEST
SENT (<span class="hljs-number">0.</span>0074s) ARP who-has <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span> tell <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>
RCVD (<span class="hljs-number">0.</span>0309s) ARP reply <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span> is-<span class="hljs-meta">at</span> DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>023s latency).
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF
Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.05</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.18</code></td>
<td>Performs defined scans against the target.</td>
</tr>
<tr>
<td><code>-sn</code></td>
<td>Disables port scanning.</td>
</tr>
<tr>
<td><code>-oA host</code></td>
<td>Stores the results in all formats starting with the name &#39;host&#39;.</td>
</tr>
<tr>
<td><code>-PE</code></td>
<td>Performs the ping scan by using &#39;ICMP Echo requests&#39; against the target.</td>
</tr>
<tr>
<td><code>--packet-trace</code></td>
<td>Shows all packets sent and received</td>
</tr>
</tbody>
</table>
<hr>
<p>Another way to determine why Nmap has our target marked as &quot;alive&quot; is with the &quot;<code>--reason</code>&quot; option.</p>
<pre><code class="lang-shell-session">[!bash!]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span> -sn -oA host -PE --reason 

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span> CEST
SENT (<span class="hljs-number">0.</span>0074s) ARP who-has <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span> tell <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>
RCVD (<span class="hljs-number">0.</span>0309s) ARP reply <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span> is-<span class="hljs-meta">at</span> DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span>
Host is <span class="hljs-meta">up</span>, received arp-response (<span class="hljs-number">0.</span>028s latency).
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF
Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.03</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.18</code></td>
<td>Performs defined scans against the target.</td>
</tr>
<tr>
<td><code>-sn</code></td>
<td>Disables port scanning.</td>
</tr>
<tr>
<td><code>-oA host</code></td>
<td>Stores the results in all formats starting with the name &#39;host&#39;.</td>
</tr>
<tr>
<td><code>-PE</code></td>
<td>Performs the ping scan by using &#39;ICMP Echo requests&#39; against the target.</td>
</tr>
<tr>
<td><code>--reason</code></td>
<td>Displays the reason for specific result.</td>
</tr>
</tbody>
</table>
<hr>
<p>We see here that <code>Nmap</code> does indeed detect whether the host is alive or not through the <code>ARP request</code> and <code>ARP reply</code> alone. To disable ARP requests and scan our target with the desired <code>ICMP echo requests</code>, we can disable ARP pings by setting the &quot;<code>--disable-arp-ping</code>&quot; option. Then we can scan our target again and look at the packets sent and received.</p>
<pre><code class="lang-shell-session">[!bash!]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span> -sn -oA host -PE --packet-trace --disable-arp-ping 

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">00</span>:<span class="hljs-number">12</span> CEST
SENT (<span class="hljs-number">0.</span>0107s) ICMP [<span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span> Echo request (type=<span class="hljs-number">8</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">13607</span> seq=<span class="hljs-number">0</span>] <span class="hljs-built_in">IP</span> [ttl=<span class="hljs-number">255</span> id=<span class="hljs-number">23541</span> iplen=<span class="hljs-number">28</span> ]
RCVD (<span class="hljs-number">0.</span>0152s) ICMP [<span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span> &gt; <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span> Echo reply (type=<span class="hljs-number">0</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">13607</span> seq=<span class="hljs-number">0</span>] <span class="hljs-built_in">IP</span> [ttl=<span class="hljs-number">128</span> id=<span class="hljs-number">40622</span> iplen=<span class="hljs-number">28</span> ]
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>086s latency).
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF
Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.11</span> seconds
</code></pre>
<p>We have already mentioned in the &quot;<code>Learning Process</code>,&quot; and at the beginning of this module, it is essential to pay attention to details. An <code>ICMP echo request</code> can help us determine if our target is alive and identify its system. More strategies about host discovery can be found at:</p>
<p>{% embed url=&quot;<a href="https://nmap.org/book/host-discovery-strategies.html">https://nmap.org/book/host-discovery-strategies.html</a>&quot; %}</p>
<h2 id="host-and-port-scanning">Host and Port Scanning</h2>
<hr>
<p>It is essential to understand how the tool we use works and how it performs and processes the different functions. We will only understand the results if we know what they mean and how they are obtained. Therefore we will take a closer look at and analyze some of the scanning methods. After we have found out that our target is alive, we want to get a more accurate picture of the system. The information we need includes:</p>
<ul>
<li>Open ports and its services</li>
<li>Service versions</li>
<li>Information that the services provided</li>
<li>Operating system</li>
</ul>
<p>There are a total of 6 different states for a scanned port we can obtain:</p>
<table>
<thead>
<tr>
<th><strong>State</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>open</code></td>
<td>This indicates that the connection to the scanned port has been established. These connections can be <strong>TCP connections</strong>, <strong>UDP datagrams</strong> as well as <strong>SCTP associations</strong>.</td>
</tr>
<tr>
<td><code>closed</code></td>
<td>When the port is shown as closed, the TCP protocol indicates that the packet we received back contains an <code>RST</code> flag. This scanning method can also be used to determine if our target is alive or not.</td>
</tr>
<tr>
<td><code>filtered</code></td>
<td>Nmap cannot correctly identify whether the scanned port is open or closed because either no response is returned from the target for the port or we get an error code from the target.</td>
</tr>
<tr>
<td><code>unfiltered</code></td>
<td>This state of a port only occurs during the <strong>TCP-ACK</strong> scan and means that the port is accessible, but it cannot be determined whether it is open or closed.</td>
</tr>
<tr>
<td>`open\</td>
<td>filtered`</td>
<td>If we do not get a response for a specific port, <code>Nmap</code> will set it to that state. This indicates that a firewall or packet filter may protect the port.</td>
</tr>
<tr>
<td>`closed\</td>
<td>filtered`</td>
<td>This state only occurs in the <strong>IP ID idle</strong> scans and indicates that it was impossible to determine if the scanned port is closed or filtered by a firewall.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="discovering-open-tcp-ports">Discovering Open TCP Ports</h3>
<p>By default, <code>Nmap</code> scans the top 1000 TCP ports with the SYN scan (<code>-sS</code>). This SYN scan is set only to default when we run it as root because of the socket permissions required to create raw TCP packets. Otherwise, the TCP scan (<code>-sT</code>) is performed by default. This means that if we do not define ports and scanning methods, these parameters are set automatically. We can define the ports one by one (<code>-p 22,25,80,139,445</code>), by range (<code>-p 22-445</code>), by top ports (<code>--top-ports=10</code>) from the <code>Nmap</code> database that have been signed as most frequent, by scanning all ports (<code>-p-</code>) but also by defining a fast port scan, which contains top 100 ports (<code>-F</code>).</p>
<p><strong>Scanning Top 10 TCP Ports</strong></p>
<p>Host and Port Scanning</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span> <span class="hljs-comment">--top-ports=10 </span>

Starting Nmap <span class="hljs-number">7.80</span> ( <span class="hljs-keyword">https</span>://nmap.org ) <span class="hljs-keyword">at</span> <span class="hljs-number">2020</span><span class="hljs-number">-06</span><span class="hljs-number">-15</span> <span class="hljs-number">15</span>:<span class="hljs-number">36</span> CEST
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span>
Host is up (<span class="hljs-number">0.021</span>s latency).

PORT     STATE    SERVICE
<span class="hljs-number">21</span>/tcp   closed   <span class="hljs-keyword">ftp</span>
<span class="hljs-number">22</span>/tcp   <span class="hljs-built_in">open</span>     ssh
<span class="hljs-number">23</span>/tcp   closed   telnet
<span class="hljs-number">25</span>/tcp   <span class="hljs-built_in">open</span>     smtp
<span class="hljs-number">80</span>/tcp   <span class="hljs-built_in">open</span>     <span class="hljs-keyword">http</span>
<span class="hljs-number">110</span>/tcp  <span class="hljs-built_in">open</span>     pop3
<span class="hljs-number">139</span>/tcp  filtered netbios-ssn
<span class="hljs-number">443</span>/tcp  closed   <span class="hljs-keyword">https</span>
<span class="hljs-number">445</span>/tcp  filtered microsoft-ds
<span class="hljs-number">3389</span>/tcp closed   ms-wbt-server
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)

Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">1.44</span> <span class="hljs-built_in">seconds</span>
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.28</code></td>
<td>Scans the specified target.</td>
</tr>
<tr>
<td><code>--top-ports=10</code></td>
<td>Scans the specified top ports that have been defined as most frequent.</td>
</tr>
</tbody>
</table>
<hr>
<p>We see that we only scanned the top 10 TCP ports of our target, and <code>Nmap</code> displays their state accordingly. If we trace the packets <code>Nmap</code> sends, we will see the <code>RST</code> flag on <code>TCP port 21</code> that our target sends back to us. To have a clear view of the SYN scan, we disable the ICMP echo requests (<code>-Pn</code>), DNS resolution (<code>-n</code>), and ARP ping scan (<code>--disable-arp-ping</code>).</p>
<p><strong>Nmap - Trace the Packets</strong></p>
<p>Host and Port Scanning</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -p <span class="hljs-number">21</span> --packet-trace -Pn -n --disable-arp-ping

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">15</span>:<span class="hljs-number">39</span> CEST
SENT (<span class="hljs-number">0.</span>0429s) TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">63090</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">21</span> S ttl=<span class="hljs-number">56</span> id=<span class="hljs-number">57322</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">1699105818</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
RCVD (<span class="hljs-number">0.</span>0573s) TCP <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">21</span> &gt; <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">63090</span> RA ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">0</span> iplen=<span class="hljs-number">40</span>  seq=<span class="hljs-number">0</span> win=<span class="hljs-number">0</span>
Nmap scan report for <span class="hljs-number">10.11</span><span class="hljs-meta">.1</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>014s latency).

PORT   STATE  SERVICE
<span class="hljs-number">21</span>/tcp closed ftp
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.07</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.28</code></td>
<td>Scans the specified target.</td>
</tr>
<tr>
<td><code>-p 21</code></td>
<td>Scans only the specified port.</td>
</tr>
<tr>
<td><code>--packet-trace</code></td>
<td>Shows all packets sent and received.</td>
</tr>
<tr>
<td><code>-n</code></td>
<td>Disables DNS resolution.</td>
</tr>
<tr>
<td><code>--disable-arp-ping</code></td>
<td>Disables ARP ping.</td>
</tr>
</tbody>
</table>
<hr>
<p>We can see from the SENT line that we (<code>10.10.14.2</code>) sent a TCP packet with the <code>SYN</code> flag (<code>S</code>) to our target (<code>10.129.2.28</code>). In the next RCVD line, we can see that the target responds with a TCP packet containing the <code>RST</code> and <code>ACK</code> flags (<code>RA</code>). <code>RST</code> and <code>ACK</code> flags are used to acknowledge receipt of the TCP packet (<code>ACK</code>) and to end the TCP session (<code>RST</code>).</p>
<p><strong>Request</strong></p>
<table>
<thead>
<tr>
<th><strong>Message</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SENT (0.0429s)</code></td>
<td>Indicates the SENT operation of Nmap, which sends a packet to the target.</td>
</tr>
<tr>
<td><code>TCP</code></td>
<td>Shows the protocol that is being used to interact with the target port.</td>
</tr>
<tr>
<td><code>10.10.14.2:63090 &gt;</code></td>
<td>Represents our IPv4 address and the source port, which will be used by Nmap to send the packets.</td>
</tr>
<tr>
<td><code>10.129.2.28:21</code></td>
<td>Shows the target IPv4 address and the target port.</td>
</tr>
<tr>
<td><code>S</code></td>
<td>SYN flag of the sent TCP packet.</td>
</tr>
<tr>
<td><code>ttl=56 id=57322 iplen=44 seq=1699105818 win=1024 mss 1460</code></td>
<td>Additional TCP Header parameters.</td>
</tr>
</tbody>
</table>
<p><strong>Response</strong></p>
<table>
<thead>
<tr>
<th><strong>Message</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>RCVD (0.0573s)</code></td>
<td>Indicates a received packet from the target.</td>
</tr>
<tr>
<td><code>TCP</code></td>
<td>Shows the protocol that is being used.</td>
</tr>
<tr>
<td><code>10.129.2.28:21 &gt;</code></td>
<td>Represents targets IPv4 address and the source port, which will be used to reply.</td>
</tr>
<tr>
<td><code>10.10.14.2:63090</code></td>
<td>Shows our IPv4 address and the port that will be replied to.</td>
</tr>
<tr>
<td><code>RA</code></td>
<td>RST and ACK flags of the sent TCP packet.</td>
</tr>
<tr>
<td><code>ttl=64 id=0 iplen=40 seq=0 win=0</code></td>
<td>Additional TCP Header parameters.</td>
</tr>
</tbody>
</table>
<p><strong>Connect Scan</strong></p>
<p>The Nmap <a href="https://nmap.org/book/scan-methods-connect-scan.html">TCP Connect Scan</a> (<code>-sT</code>) uses the TCP three-way handshake to determine if a specific port on a target host is open or closed. The scan sends an <code>SYN</code> packet to the target port and waits for a response. It is considered open if the target port responds with an <code>SYN-ACK</code> packet and closed if it responds with an <code>RST</code> packet.</p>
<p>The <code>Connect</code> scan is useful because it is the most accurate way to determine the state of a port, and it is also the most stealthy. Unlike other types of scans, such as the SYN scan, the Connect scan does not leave any unfinished connections or unsent packets on the target host, which makes it less likely to be detected by intrusion detection systems (IDS) or intrusion prevention systems (IPS). It is useful when we want to map the network and don&#39;t want to disturb the services running behind it, thus causing a minimal impact and sometimes considered a more polite scan method.</p>
<p>It is also useful when the target host has a personal firewall that drops incoming packets but allows outgoing packets. In this case, a Connect scan can bypass the firewall and accurately determine the state of the target ports. However, it is important to note that the Connect scan is slower than other types of scans because it requires the scanner to wait for a response from the target after each packet it sends, which could take some time if the target is busy or unresponsive.</p>
<p><strong>Connect Scan on TCP Port 443</strong></p>
<p>Host and Port Scanning</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -p <span class="hljs-number">443</span> --packet-trace --disable-arp-ping -Pn -n --reason -<span class="hljs-built_in">sT</span> 

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">16</span>:<span class="hljs-number">26</span> CET
CONN (<span class="hljs-number">0.</span>0385s) TCP localhost &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">443</span> =&gt; Operation now <span class="hljs-keyword">in</span> progress
CONN (<span class="hljs-number">0.</span>0396s) TCP localhost &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">443</span> =&gt; Connected
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span>, received user-set (<span class="hljs-number">0.</span>013s latency).

PORT    STATE SERVICE REASON
<span class="hljs-number">443</span>/tcp open  https   syn-ack

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.04</span> seconds
</code></pre>
<hr>
<h3 id="filtered-ports">Filtered Ports</h3>
<p>When a port is shown as filtered, it can have several reasons. In most cases, firewalls have certain rules set to handle specific connections. The packets can either be <code>dropped</code>, or <code>rejected</code>. When a packet gets dropped, <code>Nmap</code> receives no response from our target, and by default, the retry rate (<code>--max-retries</code>) is set to 1. This means <code>Nmap</code> will resend the request to the target port to determine if the previous packet was not accidentally mishandled.</p>
<p>Let us look at an example where the firewall <code>drops</code> the TCP packets we send for the port scan. Therefore we scan the TCP port <strong>139</strong>, which was already shown as filtered. To be able to track how our sent packets are handled, we deactivate the ICMP echo requests (<code>-Pn</code>), DNS resolution (<code>-n</code>), and ARP ping scan (<code>--disable-arp-ping</code>) again.</p>
<p>Host and Port Scanning</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -p <span class="hljs-number">139</span> --packet-trace -n --disable-arp-ping -Pn

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">15</span>:<span class="hljs-number">45</span> CEST
SENT (<span class="hljs-number">0.</span>0381s) TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">60277</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">139</span> S ttl=<span class="hljs-number">47</span> id=<span class="hljs-number">14523</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">4175236769</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
SENT (<span class="hljs-number">1.</span>0411s) TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">60278</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">139</span> S ttl=<span class="hljs-number">45</span> id=<span class="hljs-number">7372</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">4175171232</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span>.

PORT    STATE    SERVICE
<span class="hljs-number">139</span>/tcp filtered netbios-ssn
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">2.06</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.28</code></td>
<td>Scans the specified target.</td>
</tr>
<tr>
<td><code>-p 139</code></td>
<td>Scans only the specified port.</td>
</tr>
<tr>
<td><code>--packet-trace</code></td>
<td>Shows all packets sent and received.</td>
</tr>
<tr>
<td><code>-n</code></td>
<td>Disables DNS resolution.</td>
</tr>
<tr>
<td><code>--disable-arp-ping</code></td>
<td>Disables ARP ping.</td>
</tr>
<tr>
<td><code>-Pn</code></td>
<td>Disables ICMP Echo requests.</td>
</tr>
</tbody>
</table>
<hr>
<p>We see in the last scan that <code>Nmap</code> sent two TCP packets with the SYN flag. By the duration (<code>2.06s</code>) of the scan, we can recognize that it took much longer than the previous ones (<code>~0.05s</code>). The case is different if the firewall rejects the packets. For this, we look at TCP port <code>445</code>, which is handled accordingly by such a rule of the firewall.</p>
<p>Host and Port Scanning</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -p <span class="hljs-number">445</span> --packet-trace -n --disable-arp-ping -Pn

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">15</span>:<span class="hljs-number">55</span> CEST
SENT (<span class="hljs-number">0.</span>0388s) TCP <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">52472</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span> S ttl=<span class="hljs-number">49</span> id=<span class="hljs-number">21763</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">1418633433</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
RCVD (<span class="hljs-number">0.</span>0487s) ICMP [<span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> Port <span class="hljs-number">445</span> unreachable (type=<span class="hljs-number">3</span>/code=<span class="hljs-number">3</span>) ] <span class="hljs-built_in">IP</span> [ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">20998</span> iplen=<span class="hljs-number">72</span> ]
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>0099s latency).

PORT    STATE    SERVICE
<span class="hljs-number">445</span>/tcp filtered microsoft-<span class="hljs-built_in">ds</span>
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.05</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.28</code></td>
<td>Scans the specified target.</td>
</tr>
<tr>
<td><code>-p 445</code></td>
<td>Scans only the specified port.</td>
</tr>
<tr>
<td><code>--packet-trace</code></td>
<td>Shows all packets sent and received.</td>
</tr>
<tr>
<td><code>-n</code></td>
<td>Disables DNS resolution.</td>
</tr>
<tr>
<td><code>--disable-arp-ping</code></td>
<td>Disables ARP ping.</td>
</tr>
<tr>
<td><code>-Pn</code></td>
<td>Disables ICMP Echo requests.</td>
</tr>
</tbody>
</table>
<p>As a response, we receive an <code>ICMP</code> reply with <code>type 3</code> and <code>error code 3</code>, which indicates that the desired port is unreachable. Nevertheless, if we know that the host is alive, we can strongly assume that the firewall on this port is rejecting the packets, and we will have to take a closer look at this port later.</p>
<hr>
<h3 id="discovering-open-udp-ports">Discovering Open UDP Ports</h3>
<p>Some system administrators sometimes forget to filter the UDP ports in addition to the TCP ones. Since <code>UDP</code> is a <code>stateless protocol</code> and does not require a three-way handshake like TCP. We do not receive any acknowledgment. Consequently, the timeout is much longer, making the whole <code>UDP scan</code> (<code>-sU</code>) much slower than the <code>TCP scan</code> (<code>-sS</code>).</p>
<p>Let&#39;s look at an example of what a UDP scan (<code>-sU</code>) can look like and what results it gives us.</p>
<p><strong>UDP Port Scan</strong></p>
<p>Host and Port Scanning</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo <span class="hljs-keyword">nmap</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">2.28</span> -F -sU

Starting Nmap <span class="hljs-number">7.80</span> ( http<span class="hljs-variable">s:</span>//<span class="hljs-keyword">nmap</span>.org ) at <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">16</span>:<span class="hljs-number">01</span> CEST
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">2.28</span>
Host <span class="hljs-keyword">is</span> <span class="hljs-keyword">up</span> (<span class="hljs-number">0.059</span>s latency).
Not shown: <span class="hljs-number">95</span> closed ports
PORT     STATE         SERVICE
<span class="hljs-number">68</span>/udp   <span class="hljs-keyword">open</span>|filtered dhcpc
<span class="hljs-number">137</span>/udp  <span class="hljs-keyword">open</span>          netbios-ns
<span class="hljs-number">138</span>/udp  <span class="hljs-keyword">open</span>|filtered netbios-dgm
<span class="hljs-number">631</span>/udp  <span class="hljs-keyword">open</span>|filtered ipp
<span class="hljs-number">5353</span>/udp <span class="hljs-keyword">open</span>          zeroconf
MAC Addres<span class="hljs-variable">s:</span> DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)

Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host <span class="hljs-keyword">up</span>) scanned in <span class="hljs-number">98.07</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.28</code></td>
<td>Scans the specified target.</td>
</tr>
<tr>
<td><code>-F</code></td>
<td>Scans top 100 ports.</td>
</tr>
<tr>
<td><code>-sU</code></td>
<td>Performs a UDP scan.</td>
</tr>
</tbody>
</table>
<hr>
<p>Another disadvantage of this is that we often do not get a response back because <code>Nmap</code> sends empty datagrams to the scanned UDP ports, and we do not receive any response. So we cannot determine if the UDP packet has arrived at all or not. If the UDP port is <code>open</code>, we only get a response if the application is configured to do so.</p>
<p>Host and Port Scanning</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -sU -Pn -n --disable-arp-ping --packet-trace -p <span class="hljs-number">137</span> --reason 

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">16</span>:<span class="hljs-number">15</span> CEST
SENT (<span class="hljs-number">0.</span>0367s) UDP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">55478</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">137</span> ttl=<span class="hljs-number">57</span> id=<span class="hljs-number">9122</span> iplen=<span class="hljs-number">78</span>
RCVD (<span class="hljs-number">0.</span>0398s) UDP <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">137</span> &gt; <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">55478</span> ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">13222</span> iplen=<span class="hljs-number">257</span>
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span>, received user-set (<span class="hljs-number">0.</span>0031s latency).

PORT    STATE SERVICE    REASON
<span class="hljs-number">137</span>/udp open  netbios-ns udp-response ttl <span class="hljs-number">64</span>
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.04</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.28</code></td>
<td>Scans the specified target.</td>
</tr>
<tr>
<td><code>-sU</code></td>
<td>Performs a UDP scan.</td>
</tr>
<tr>
<td><code>-Pn</code></td>
<td>Disables ICMP Echo requests.</td>
</tr>
<tr>
<td><code>-n</code></td>
<td>Disables DNS resolution.</td>
</tr>
<tr>
<td><code>--disable-arp-ping</code></td>
<td>Disables ARP ping.</td>
</tr>
<tr>
<td><code>--packet-trace</code></td>
<td>Shows all packets sent and received.</td>
</tr>
<tr>
<td><code>-p 137</code></td>
<td>Scans only the specified port.</td>
</tr>
<tr>
<td><code>--reason</code></td>
<td>Displays the reason a port is in a particular state.</td>
</tr>
</tbody>
</table>
<hr>
<p>If we get an ICMP response with <code>error code 3</code> (port unreachable), we know that the port is indeed <code>closed</code>.</p>
<p>Host and Port Scanning</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -sU -Pn -n --disable-arp-ping --packet-trace -p <span class="hljs-number">100</span> --reason 

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">16</span>:<span class="hljs-number">25</span> CEST
SENT (<span class="hljs-number">0.</span>0445s) UDP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">63825</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">100</span> ttl=<span class="hljs-number">57</span> id=<span class="hljs-number">29925</span> iplen=<span class="hljs-number">28</span>
RCVD (<span class="hljs-number">0.</span>1498s) ICMP [<span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> &gt; <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span> Port unreachable (type=<span class="hljs-number">3</span>/code=<span class="hljs-number">3</span>) ] <span class="hljs-built_in">IP</span> [ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">11903</span> iplen=<span class="hljs-number">56</span> ]
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span>, received user-set (<span class="hljs-number">0.</span>11s latency).

PORT    STATE  SERVICE REASON
<span class="hljs-number">100</span>/udp closed unknown port-unreach ttl <span class="hljs-number">64</span>
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span>  <span class="hljs-number">0.15</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.28</code></td>
<td>Scans the specified target.</td>
</tr>
<tr>
<td><code>-sU</code></td>
<td>Performs a UDP scan.</td>
</tr>
<tr>
<td><code>-Pn</code></td>
<td>Disables ICMP Echo requests.</td>
</tr>
<tr>
<td><code>-n</code></td>
<td>Disables DNS resolution.</td>
</tr>
<tr>
<td><code>--disable-arp-ping</code></td>
<td>Disables ARP ping.</td>
</tr>
<tr>
<td><code>--packet-trace</code></td>
<td>Shows all packets sent and received.</td>
</tr>
<tr>
<td><code>-p 100</code></td>
<td>Scans only the specified port.</td>
</tr>
<tr>
<td><code>--reason</code></td>
<td>Displays the reason a port is in a particular state.</td>
</tr>
</tbody>
</table>
<hr>
<p>For all other ICMP responses, the scanned ports are marked as (<code>open|filtered</code>).</p>
<p>Host and Port Scanning</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -sU -Pn -n --disable-arp-ping --packet-trace -p <span class="hljs-number">138</span> --reason 

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">16</span>:<span class="hljs-number">32</span> CEST
SENT (<span class="hljs-number">0.</span>0380s) UDP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">52341</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">138</span> ttl=<span class="hljs-number">50</span> id=<span class="hljs-number">65159</span> iplen=<span class="hljs-number">28</span>
SENT (<span class="hljs-number">1.</span>0392s) UDP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">52342</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">138</span> ttl=<span class="hljs-number">40</span> id=<span class="hljs-number">24444</span> iplen=<span class="hljs-number">28</span>
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span>, received user-set.

PORT    STATE         SERVICE     REASON
<span class="hljs-number">138</span>/udp open|filtered netbios-dgm no-response
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">2.06</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.28</code></td>
<td>Scans the specified target.</td>
</tr>
<tr>
<td><code>-sU</code></td>
<td>Performs a UDP scan.</td>
</tr>
<tr>
<td><code>-Pn</code></td>
<td>Disables ICMP Echo requests.</td>
</tr>
<tr>
<td><code>-n</code></td>
<td>Disables DNS resolution.</td>
</tr>
<tr>
<td><code>--disable-arp-ping</code></td>
<td>Disables ARP ping.</td>
</tr>
<tr>
<td><code>--packet-trace</code></td>
<td>Shows all packets sent and received.</td>
</tr>
<tr>
<td><code>-p 138</code></td>
<td>Scans only the specified port.</td>
</tr>
<tr>
<td><code>--reason</code></td>
<td>Displays the reason a port is in a particular state.</td>
</tr>
</tbody>
</table>
<p>Another handy method for scanning ports is the <code>-sV</code> option which is used to get additional available information from the open ports. This method can identify versions, service names, and details about our target.</p>
<p><strong>Version Scan</strong></p>
<p>Host and Port Scanning</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -Pn -n --disable-arp-ping --packet-trace -p <span class="hljs-number">445</span> --reason  -sV

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2022</span>-<span class="hljs-number">11</span>-<span class="hljs-number">04</span> <span class="hljs-number">11</span>:<span class="hljs-number">10</span> GMT
SENT (<span class="hljs-number">0.</span>3426s) TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">44641</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span> S ttl=<span class="hljs-number">55</span> id=<span class="hljs-number">43401</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">3589068008</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
RCVD (<span class="hljs-number">0.</span>3556s) TCP <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span> &gt; <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">44641</span> SA ttl=<span class="hljs-number">63</span> id=<span class="hljs-number">0</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">2881527699</span> win=<span class="hljs-number">29200</span> &lt;mss <span class="hljs-number">1337</span>&gt;
NSOCK INFO [<span class="hljs-number">0.</span>4980s] nsock_iod_new2(): nsock_iod_new (IOD #<span class="hljs-number">1</span>)
NSOCK INFO [<span class="hljs-number">0.</span>4980s] nsock_connect_tcp(): TCP connection requested to <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span> (IOD #<span class="hljs-number">1</span>) EID <span class="hljs-number">8</span>
NSOCK INFO [<span class="hljs-number">0.</span>5130s] nsock_trace_handler_callback(): Callback: CONNECT SUCCESS for EID <span class="hljs-number">8</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span>]
Service scan sending probe NULL to <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span> (tcp)
NSOCK INFO [<span class="hljs-number">0.</span>5130s] nsock_read(): Read request from IOD #<span class="hljs-number">1</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span>] (timeout: 6000ms) EID <span class="hljs-number">18</span>
NSOCK INFO [<span class="hljs-number">6.</span>5190s] nsock_trace_handler_callback(): Callback: READ TIMEOUT for EID <span class="hljs-number">18</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span>]
Service scan sending probe SMBProgNeg to <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span> (tcp)
NSOCK INFO [<span class="hljs-number">6.</span>5190s] nsock_write(): Write request for <span class="hljs-number">168</span> bytes to IOD #<span class="hljs-number">1</span> EID <span class="hljs-number">27</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span>]
NSOCK INFO [<span class="hljs-number">6.</span>5190s] nsock_read(): Read request from IOD #<span class="hljs-number">1</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span>] (timeout: 5000ms) EID <span class="hljs-number">34</span>
NSOCK INFO [<span class="hljs-number">6.</span>5190s] nsock_trace_handler_callback(): Callback: WRITE SUCCESS for EID <span class="hljs-number">27</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span>]
NSOCK INFO [<span class="hljs-number">6.</span>5320s] nsock_trace_handler_callback(): Callback: READ SUCCESS for EID <span class="hljs-number">34</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span>] (<span class="hljs-number">135</span> bytes)
Service scan match (Probe SMBProgNeg matched with SMBProgNeg line <span class="hljs-number">13836</span>): <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span> is netbios-ssn.  Version: |Samba smbd|<span class="hljs-number">3.</span>X - <span class="hljs-number">4.</span>X|workgroup: WORKGROUP|
NSOCK INFO [<span class="hljs-number">6.</span>5320s] nsock_iod_delete(): nsock_iod_delete (IOD #<span class="hljs-number">1</span>)
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span>, received user-set (<span class="hljs-number">0.</span>013s latency).

PORT    STATE SERVICE     REASON         VERSION
<span class="hljs-number">445</span>/tcp open  netbios-ssn syn-ack ttl <span class="hljs-number">63</span> Samba smbd <span class="hljs-number">3.</span>X - <span class="hljs-number">4.</span>X (workgroup: WORKGROUP)
Service Info: Host: Ubuntu

Service detection performed. Please report any incorrect results <span class="hljs-meta">at</span> https://nmap.org/submit/ .
Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">6.55</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.28</code></td>
<td>Scans the specified target.</td>
</tr>
<tr>
<td><code>-Pn</code></td>
<td>Disables ICMP Echo requests.</td>
</tr>
<tr>
<td><code>-n</code></td>
<td>Disables DNS resolution.</td>
</tr>
<tr>
<td><code>--disable-arp-ping</code></td>
<td>Disables ARP ping.</td>
</tr>
<tr>
<td><code>--packet-trace</code></td>
<td>Shows all packets sent and received.</td>
</tr>
<tr>
<td><code>-p 445</code></td>
<td>Scans only the specified port.</td>
</tr>
<tr>
<td><code>--reason</code></td>
<td>Displays the reason a port is in a particular state.</td>
</tr>
<tr>
<td><code>-sV</code></td>
<td>Performs a service scan.</td>
</tr>
</tbody>
</table>
<p>More information about port scanning techniques we can find at: <a href="https://nmap.org/book/man-port-scanning-techniques.html">https://nmap.org/book/man-port-scanning-techniques.html</a></p>
<h2 id="host-discovery">Host Discovery</h2>
<hr>
<p>When we need to conduct an internal penetration test for the entire network of a company, for example, then we should, first of all, get an overview of which systems are online that we can work with. To actively discover such systems on the network, we can use various <code>Nmap</code> host discovery options. There are many options <code>Nmap</code> provides to determine whether our target is alive or not. The most effective host discovery method is to use <strong>ICMP echo requests</strong>, which we will look into.</p>
<p>It is always recommended to store every single scan. This can later be used for comparison, documentation, and reporting. After all, different tools may produce different results. Therefore it can be beneficial to distinguish which tool produces which results.</p>
<p><strong>Scan Network Range</strong></p>
<p>Host Discovery</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> -sn -oA tnet | grep for | cut -d<span class="hljs-string">" "</span> -f5

<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.4</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.10</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.11</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.18</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.19</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.20</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span>
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.0/24</code></td>
<td>Target network range.</td>
</tr>
<tr>
<td><code>-sn</code></td>
<td>Disables port scanning.</td>
</tr>
<tr>
<td><code>-oA tnet</code></td>
<td>Stores the results in all formats starting with the name &#39;tnet&#39;.</td>
</tr>
</tbody>
</table>
<p>This scanning method works only if the firewalls of the hosts allow it. Otherwise, we can use other scanning techniques to find out if the hosts are active or not. We will take a closer look at these techniques in &quot;<code>Firewall and IDS Evasion</code>&quot;.</p>
<hr>
<h3 id="scan-ip-list">Scan IP List</h3>
<p>During an internal penetration test, it is not uncommon for us to be provided with an IP list with the hosts we need to test. <code>Nmap</code> also gives us the option of working with lists and reading the hosts from this list instead of manually defining or typing them in.</p>
<p>Such a list could look something like this:</p>
<p>Host Discovery</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat hosts.lst

<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.4</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.10</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.11</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.18</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.19</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.20</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span>
</code></pre>
<p>If we use the same scanning technique on the predefined list, the command will look like this:</p>
<p>Host Discovery</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap -sn -oA tnet -iL hosts.lst | grep for | cut -d<span class="hljs-string">" "</span> -f5

<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.18</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.19</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.20</span>
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-sn</code></td>
<td>Disables port scanning.</td>
</tr>
<tr>
<td><code>-oA tnet</code></td>
<td>Stores the results in all formats starting with the name &#39;tnet&#39;.</td>
</tr>
<tr>
<td><code>-iL</code></td>
<td>Performs defined scans against targets in provided &#39;hosts.lst&#39; list.</td>
</tr>
</tbody>
</table>
<p>In this example, we see that only 3 of 7 hosts are active. Remember, this may mean that the other hosts ignore the default <strong>ICMP echo requests</strong> because of their firewall configurations. Since <code>Nmap</code> does not receive a response, it marks those hosts as inactive.</p>
<hr>
<h3 id="scan-multiple-ips">Scan Multiple IPs</h3>
<p>It can also happen that we only need to scan a small part of a network. An alternative to the method we used last time is to specify multiple IP addresses.</p>
<p>Host Discovery</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap -sn -oA tnet <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.18</span> <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.19</span> <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.20</span>| grep for | cut -d<span class="hljs-string">" "</span> -f5

<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.18</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.19</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.20</span>
</code></pre>
<p>If these IP addresses are next to each other, we can also define the range in the respective octet.</p>
<p>Host Discovery</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap -sn -oA tnet <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.18</span><span class="hljs-number">-20</span>| grep for | cut -d<span class="hljs-string">" "</span> -f5

<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.18</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.19</span>
<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.20</span>
</code></pre>
<hr>
<h3 id="scan-single-ip">Scan Single IP</h3>
<p>Before we scan a single host for open ports and its services, we first have to determine if it is alive or not. For this, we can use the same method as before.</p>
<p>Host Discovery</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.18</span> -sn -oA host 

Starting Nmap <span class="hljs-number">7.80</span> ( <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org ) at 2020-06-14 23:59 CEST</span>
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.18</span>
Host is up (<span class="hljs-number">0.087</span>s latency).
MAC <span class="hljs-string">Address:</span> <span class="hljs-string">DE:</span><span class="hljs-string">AD:</span><span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-string">BE:</span>EF
Nmap <span class="hljs-string">done:</span> <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.11</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.18</code></td>
<td>Performs defined scans against the target.</td>
</tr>
<tr>
<td><code>-sn</code></td>
<td>Disables port scanning.</td>
</tr>
<tr>
<td><code>-oA host</code></td>
<td>Stores the results in all formats starting with the name &#39;host&#39;.</td>
</tr>
</tbody>
</table>
<p>If we disable port scan (<code>-sn</code>), Nmap automatically ping scan with <code>ICMP Echo Requests</code> (<code>-PE</code>). Once such a request is sent, we usually expect an <code>ICMP reply</code> if the pinging host is alive. The more interesting fact is that our previous scans did not do that because before Nmap could send an ICMP echo request, it would send an <code>ARP ping</code> resulting in an <code>ARP reply</code>. We can confirm this with the &quot;<code>--packet-trace</code>&quot; option. To ensure that ICMP echo requests are sent, we also define the option (<code>-PE</code>) for this.</p>
<p>Host Discovery</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span> -sn -oA host -PE --packet-trace 

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">00</span>:<span class="hljs-number">08</span> CEST
SENT (<span class="hljs-number">0.</span>0074s) ARP who-has <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span> tell <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>
RCVD (<span class="hljs-number">0.</span>0309s) ARP reply <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span> is-<span class="hljs-meta">at</span> DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>023s latency).
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF
Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.05</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.18</code></td>
<td>Performs defined scans against the target.</td>
</tr>
<tr>
<td><code>-sn</code></td>
<td>Disables port scanning.</td>
</tr>
<tr>
<td><code>-oA host</code></td>
<td>Stores the results in all formats starting with the name &#39;host&#39;.</td>
</tr>
<tr>
<td><code>-PE</code></td>
<td>Performs the ping scan by using &#39;ICMP Echo requests&#39; against the target.</td>
</tr>
<tr>
<td><code>--packet-trace</code></td>
<td>Shows all packets sent and received</td>
</tr>
</tbody>
</table>
<hr>
<p>Another way to determine why Nmap has our target marked as &quot;alive&quot; is with the &quot;<code>--reason</code>&quot; option.</p>
<p>Host Discovery</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span> -sn -oA host -PE --reason 

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span> CEST
SENT (<span class="hljs-number">0.</span>0074s) ARP who-has <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span> tell <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>
RCVD (<span class="hljs-number">0.</span>0309s) ARP reply <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span> is-<span class="hljs-meta">at</span> DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span>
Host is <span class="hljs-meta">up</span>, received arp-response (<span class="hljs-number">0.</span>028s latency).
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF
Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.03</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.18</code></td>
<td>Performs defined scans against the target.</td>
</tr>
<tr>
<td><code>-sn</code></td>
<td>Disables port scanning.</td>
</tr>
<tr>
<td><code>-oA host</code></td>
<td>Stores the results in all formats starting with the name &#39;host&#39;.</td>
</tr>
<tr>
<td><code>-PE</code></td>
<td>Performs the ping scan by using &#39;ICMP Echo requests&#39; against the target.</td>
</tr>
<tr>
<td><code>--reason</code></td>
<td>Displays the reason for specific result.</td>
</tr>
</tbody>
</table>
<hr>
<p>We see here that <code>Nmap</code> does indeed detect whether the host is alive or not through the <code>ARP request</code> and <code>ARP reply</code> alone. To disable ARP requests and scan our target with the desired <code>ICMP echo requests</code>, we can disable ARP pings by setting the &quot;<code>--disable-arp-ping</code>&quot; option. Then we can scan our target again and look at the packets sent and received.</p>
<p>Host Discovery</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span> -sn -oA host -PE --packet-trace --disable-arp-ping 

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">00</span>:<span class="hljs-number">12</span> CEST
SENT (<span class="hljs-number">0.</span>0107s) ICMP [<span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span> Echo request (type=<span class="hljs-number">8</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">13607</span> seq=<span class="hljs-number">0</span>] <span class="hljs-built_in">IP</span> [ttl=<span class="hljs-number">255</span> id=<span class="hljs-number">23541</span> iplen=<span class="hljs-number">28</span> ]
RCVD (<span class="hljs-number">0.</span>0152s) ICMP [<span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span> &gt; <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span> Echo reply (type=<span class="hljs-number">0</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">13607</span> seq=<span class="hljs-number">0</span>] <span class="hljs-built_in">IP</span> [ttl=<span class="hljs-number">128</span> id=<span class="hljs-number">40622</span> iplen=<span class="hljs-number">28</span> ]
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.18</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>086s latency).
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF
Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.11</span> seconds
</code></pre>
<p>We have already mentioned in the &quot;<code>Learning Process</code>,&quot; and at the beginning of this module, it is essential to pay attention to details. An <code>ICMP echo request</code> can help us determine if our target is alive and identify its system. More strategies about host discovery can be found at:</p>
<p><a href="https://nmap.org/book/host-discovery-strategies.html">https://nmap.org/book/host-discovery-strategies.html</a></p>
<h2 id="host-and-port-scanning">Host and Port Scanning</h2>
<hr>
<p>It is essential to understand how the tool we use works and how it performs and processes the different functions. We will only understand the results if we know what they mean and how they are obtained. Therefore we will take a closer look at and analyze some of the scanning methods. After we have found out that our target is alive, we want to get a more accurate picture of the system. The information we need includes:</p>
<ul>
<li>Open ports and its services</li>
<li>Service versions</li>
<li>Information that the services provided</li>
<li>Operating system</li>
</ul>
<p>There are a total of 6 different states for a scanned port we can obtain:</p>
<table>
<thead>
<tr>
<th><strong>State</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>open</code></td>
<td>This indicates that the connection to the scanned port has been established. These connections can be <strong>TCP connections</strong>, <strong>UDP datagrams</strong> as well as <strong>SCTP associations</strong>.</td>
</tr>
<tr>
<td><code>closed</code></td>
<td>When the port is shown as closed, the TCP protocol indicates that the packet we received back contains an <code>RST</code> flag. This scanning method can also be used to determine if our target is alive or not.</td>
</tr>
<tr>
<td><code>filtered</code></td>
<td>Nmap cannot correctly identify whether the scanned port is open or closed because either no response is returned from the target for the port or we get an error code from the target.</td>
</tr>
<tr>
<td><code>unfiltered</code></td>
<td>This state of a port only occurs during the <strong>TCP-ACK</strong> scan and means that the port is accessible, but it cannot be determined whether it is open or closed.</td>
</tr>
<tr>
<td>`open\</td>
<td>filtered`</td>
<td>If we do not get a response for a specific port, <code>Nmap</code> will set it to that state. This indicates that a firewall or packet filter may protect the port.</td>
</tr>
<tr>
<td>`closed\</td>
<td>filtered`</td>
<td>This state only occurs in the <strong>IP ID idle</strong> scans and indicates that it was impossible to determine if the scanned port is closed or filtered by a firewall.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="discovering-open-tcp-ports">Discovering Open TCP Ports</h3>
<p>By default, <code>Nmap</code> scans the top 1000 TCP ports with the SYN scan (<code>-sS</code>). This SYN scan is set only to default when we run it as root because of the socket permissions required to create raw TCP packets. Otherwise, the TCP scan (<code>-sT</code>) is performed by default. This means that if we do not define ports and scanning methods, these parameters are set automatically. We can define the ports one by one (<code>-p 22,25,80,139,445</code>), by range (<code>-p 22-445</code>), by top ports (<code>--top-ports=10</code>) from the <code>Nmap</code> database that have been signed as most frequent, by scanning all ports (<code>-p-</code>) but also by defining a fast port scan, which contains top 100 ports (<code>-F</code>).</p>
<p><strong>Scanning Top 10 TCP Ports</strong></p>
<p>Host and Port Scanning</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span> <span class="hljs-comment">--top-ports=10 </span>

Starting Nmap <span class="hljs-number">7.80</span> ( <span class="hljs-keyword">https</span>://nmap.org ) <span class="hljs-keyword">at</span> <span class="hljs-number">2020</span><span class="hljs-number">-06</span><span class="hljs-number">-15</span> <span class="hljs-number">15</span>:<span class="hljs-number">36</span> CEST
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span>
Host is up (<span class="hljs-number">0.021</span>s latency).

PORT     STATE    SERVICE
<span class="hljs-number">21</span>/tcp   closed   <span class="hljs-keyword">ftp</span>
<span class="hljs-number">22</span>/tcp   <span class="hljs-built_in">open</span>     ssh
<span class="hljs-number">23</span>/tcp   closed   telnet
<span class="hljs-number">25</span>/tcp   <span class="hljs-built_in">open</span>     smtp
<span class="hljs-number">80</span>/tcp   <span class="hljs-built_in">open</span>     <span class="hljs-keyword">http</span>
<span class="hljs-number">110</span>/tcp  <span class="hljs-built_in">open</span>     pop3
<span class="hljs-number">139</span>/tcp  filtered netbios-ssn
<span class="hljs-number">443</span>/tcp  closed   <span class="hljs-keyword">https</span>
<span class="hljs-number">445</span>/tcp  filtered microsoft-ds
<span class="hljs-number">3389</span>/tcp closed   ms-wbt-server
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)

Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">1.44</span> <span class="hljs-built_in">seconds</span>
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.28</code></td>
<td>Scans the specified target.</td>
</tr>
<tr>
<td><code>--top-ports=10</code></td>
<td>Scans the specified top ports that have been defined as most frequent.</td>
</tr>
</tbody>
</table>
<hr>
<p>We see that we only scanned the top 10 TCP ports of our target, and <code>Nmap</code> displays their state accordingly. If we trace the packets <code>Nmap</code> sends, we will see the <code>RST</code> flag on <code>TCP port 21</code> that our target sends back to us. To have a clear view of the SYN scan, we disable the ICMP echo requests (<code>-Pn</code>), DNS resolution (<code>-n</code>), and ARP ping scan (<code>--disable-arp-ping</code>).</p>
<p><strong>Nmap - Trace the Packets</strong></p>
<p>Host and Port Scanning</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -p <span class="hljs-number">21</span> --packet-trace -Pn -n --disable-arp-ping

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">15</span>:<span class="hljs-number">39</span> CEST
SENT (<span class="hljs-number">0.</span>0429s) TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">63090</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">21</span> S ttl=<span class="hljs-number">56</span> id=<span class="hljs-number">57322</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">1699105818</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
RCVD (<span class="hljs-number">0.</span>0573s) TCP <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">21</span> &gt; <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">63090</span> RA ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">0</span> iplen=<span class="hljs-number">40</span>  seq=<span class="hljs-number">0</span> win=<span class="hljs-number">0</span>
Nmap scan report for <span class="hljs-number">10.11</span><span class="hljs-meta">.1</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>014s latency).

PORT   STATE  SERVICE
<span class="hljs-number">21</span>/tcp closed ftp
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.07</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.28</code></td>
<td>Scans the specified target.</td>
</tr>
<tr>
<td><code>-p 21</code></td>
<td>Scans only the specified port.</td>
</tr>
<tr>
<td><code>--packet-trace</code></td>
<td>Shows all packets sent and received.</td>
</tr>
<tr>
<td><code>-n</code></td>
<td>Disables DNS resolution.</td>
</tr>
<tr>
<td><code>--disable-arp-ping</code></td>
<td>Disables ARP ping.</td>
</tr>
</tbody>
</table>
<hr>
<p>We can see from the SENT line that we (<code>10.10.14.2</code>) sent a TCP packet with the <code>SYN</code> flag (<code>S</code>) to our target (<code>10.129.2.28</code>). In the next RCVD line, we can see that the target responds with a TCP packet containing the <code>RST</code> and <code>ACK</code> flags (<code>RA</code>). <code>RST</code> and <code>ACK</code> flags are used to acknowledge receipt of the TCP packet (<code>ACK</code>) and to end the TCP session (<code>RST</code>).</p>
<p><strong>Request</strong></p>
<table>
<thead>
<tr>
<th><strong>Message</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SENT (0.0429s)</code></td>
<td>Indicates the SENT operation of Nmap, which sends a packet to the target.</td>
</tr>
<tr>
<td><code>TCP</code></td>
<td>Shows the protocol that is being used to interact with the target port.</td>
</tr>
<tr>
<td><code>10.10.14.2:63090 &gt;</code></td>
<td>Represents our IPv4 address and the source port, which will be used by Nmap to send the packets.</td>
</tr>
<tr>
<td><code>10.129.2.28:21</code></td>
<td>Shows the target IPv4 address and the target port.</td>
</tr>
<tr>
<td><code>S</code></td>
<td>SYN flag of the sent TCP packet.</td>
</tr>
<tr>
<td><code>ttl=56 id=57322 iplen=44 seq=1699105818 win=1024 mss 1460</code></td>
<td>Additional TCP Header parameters.</td>
</tr>
</tbody>
</table>
<p><strong>Response</strong></p>
<table>
<thead>
<tr>
<th><strong>Message</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>RCVD (0.0573s)</code></td>
<td>Indicates a received packet from the target.</td>
</tr>
<tr>
<td><code>TCP</code></td>
<td>Shows the protocol that is being used.</td>
</tr>
<tr>
<td><code>10.129.2.28:21 &gt;</code></td>
<td>Represents targets IPv4 address and the source port, which will be used to reply.</td>
</tr>
<tr>
<td><code>10.10.14.2:63090</code></td>
<td>Shows our IPv4 address and the port that will be replied to.</td>
</tr>
<tr>
<td><code>RA</code></td>
<td>RST and ACK flags of the sent TCP packet.</td>
</tr>
<tr>
<td><code>ttl=64 id=0 iplen=40 seq=0 win=0</code></td>
<td>Additional TCP Header parameters.</td>
</tr>
</tbody>
</table>
<p><strong>Connect Scan</strong></p>
<p>The Nmap <a href="https://nmap.org/book/scan-methods-connect-scan.html">TCP Connect Scan</a> (<code>-sT</code>) uses the TCP three-way handshake to determine if a specific port on a target host is open or closed. The scan sends an <code>SYN</code> packet to the target port and waits for a response. It is considered open if the target port responds with an <code>SYN-ACK</code> packet and closed if it responds with an <code>RST</code> packet.</p>
<p>The <code>Connect</code> scan is useful because it is the most accurate way to determine the state of a port, and it is also the most stealthy. Unlike other types of scans, such as the SYN scan, the Connect scan does not leave any unfinished connections or unsent packets on the target host, which makes it less likely to be detected by intrusion detection systems (IDS) or intrusion prevention systems (IPS). It is useful when we want to map the network and don&#39;t want to disturb the services running behind it, thus causing a minimal impact and sometimes considered a more polite scan method.</p>
<p>It is also useful when the target host has a personal firewall that drops incoming packets but allows outgoing packets. In this case, a Connect scan can bypass the firewall and accurately determine the state of the target ports. However, it is important to note that the Connect scan is slower than other types of scans because it requires the scanner to wait for a response from the target after each packet it sends, which could take some time if the target is busy or unresponsive.</p>
<p><strong>Connect Scan on TCP Port 443</strong></p>
<p>Host and Port Scanning</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -p <span class="hljs-number">443</span> --packet-trace --disable-arp-ping -Pn -n --reason -<span class="hljs-built_in">sT</span> 

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">16</span>:<span class="hljs-number">26</span> CET
CONN (<span class="hljs-number">0.</span>0385s) TCP localhost &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">443</span> =&gt; Operation now <span class="hljs-keyword">in</span> progress
CONN (<span class="hljs-number">0.</span>0396s) TCP localhost &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">443</span> =&gt; Connected
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span>, received user-set (<span class="hljs-number">0.</span>013s latency).

PORT    STATE SERVICE REASON
<span class="hljs-number">443</span>/tcp open  https   syn-ack

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.04</span> seconds
</code></pre>
<hr>
<h3 id="filtered-ports">Filtered Ports</h3>
<p>When a port is shown as filtered, it can have several reasons. In most cases, firewalls have certain rules set to handle specific connections. The packets can either be <code>dropped</code>, or <code>rejected</code>. When a packet gets dropped, <code>Nmap</code> receives no response from our target, and by default, the retry rate (<code>--max-retries</code>) is set to 1. This means <code>Nmap</code> will resend the request to the target port to determine if the previous packet was not accidentally mishandled.</p>
<p>Let us look at an example where the firewall <code>drops</code> the TCP packets we send for the port scan. Therefore we scan the TCP port <strong>139</strong>, which was already shown as filtered. To be able to track how our sent packets are handled, we deactivate the ICMP echo requests (<code>-Pn</code>), DNS resolution (<code>-n</code>), and ARP ping scan (<code>--disable-arp-ping</code>) again.</p>
<p>Host and Port Scanning</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -p <span class="hljs-number">139</span> --packet-trace -n --disable-arp-ping -Pn

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">15</span>:<span class="hljs-number">45</span> CEST
SENT (<span class="hljs-number">0.</span>0381s) TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">60277</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">139</span> S ttl=<span class="hljs-number">47</span> id=<span class="hljs-number">14523</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">4175236769</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
SENT (<span class="hljs-number">1.</span>0411s) TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">60278</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">139</span> S ttl=<span class="hljs-number">45</span> id=<span class="hljs-number">7372</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">4175171232</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span>.

PORT    STATE    SERVICE
<span class="hljs-number">139</span>/tcp filtered netbios-ssn
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">2.06</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.28</code></td>
<td>Scans the specified target.</td>
</tr>
<tr>
<td><code>-p 139</code></td>
<td>Scans only the specified port.</td>
</tr>
<tr>
<td><code>--packet-trace</code></td>
<td>Shows all packets sent and received.</td>
</tr>
<tr>
<td><code>-n</code></td>
<td>Disables DNS resolution.</td>
</tr>
<tr>
<td><code>--disable-arp-ping</code></td>
<td>Disables ARP ping.</td>
</tr>
<tr>
<td><code>-Pn</code></td>
<td>Disables ICMP Echo requests.</td>
</tr>
</tbody>
</table>
<hr>
<p>We see in the last scan that <code>Nmap</code> sent two TCP packets with the SYN flag. By the duration (<code>2.06s</code>) of the scan, we can recognize that it took much longer than the previous ones (<code>~0.05s</code>). The case is different if the firewall rejects the packets. For this, we look at TCP port <code>445</code>, which is handled accordingly by such a rule of the firewall.</p>
<p>Host and Port Scanning</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -p <span class="hljs-number">445</span> --packet-trace -n --disable-arp-ping -Pn

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">15</span>:<span class="hljs-number">55</span> CEST
SENT (<span class="hljs-number">0.</span>0388s) TCP <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">52472</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span> S ttl=<span class="hljs-number">49</span> id=<span class="hljs-number">21763</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">1418633433</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
RCVD (<span class="hljs-number">0.</span>0487s) ICMP [<span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> Port <span class="hljs-number">445</span> unreachable (type=<span class="hljs-number">3</span>/code=<span class="hljs-number">3</span>) ] <span class="hljs-built_in">IP</span> [ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">20998</span> iplen=<span class="hljs-number">72</span> ]
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>0099s latency).

PORT    STATE    SERVICE
<span class="hljs-number">445</span>/tcp filtered microsoft-<span class="hljs-built_in">ds</span>
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.05</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.28</code></td>
<td>Scans the specified target.</td>
</tr>
<tr>
<td><code>-p 445</code></td>
<td>Scans only the specified port.</td>
</tr>
<tr>
<td><code>--packet-trace</code></td>
<td>Shows all packets sent and received.</td>
</tr>
<tr>
<td><code>-n</code></td>
<td>Disables DNS resolution.</td>
</tr>
<tr>
<td><code>--disable-arp-ping</code></td>
<td>Disables ARP ping.</td>
</tr>
<tr>
<td><code>-Pn</code></td>
<td>Disables ICMP Echo requests.</td>
</tr>
</tbody>
</table>
<p>As a response, we receive an <code>ICMP</code> reply with <code>type 3</code> and <code>error code 3</code>, which indicates that the desired port is unreachable. Nevertheless, if we know that the host is alive, we can strongly assume that the firewall on this port is rejecting the packets, and we will have to take a closer look at this port later.</p>
<hr>
<h3 id="discovering-open-udp-ports">Discovering Open UDP Ports</h3>
<p>Some system administrators sometimes forget to filter the UDP ports in addition to the TCP ones. Since <code>UDP</code> is a <code>stateless protocol</code> and does not require a three-way handshake like TCP. We do not receive any acknowledgment. Consequently, the timeout is much longer, making the whole <code>UDP scan</code> (<code>-sU</code>) much slower than the <code>TCP scan</code> (<code>-sS</code>).</p>
<p>Let&#39;s look at an example of what a UDP scan (<code>-sU</code>) can look like and what results it gives us.</p>
<p><strong>UDP Port Scan</strong></p>
<p>Host and Port Scanning</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo <span class="hljs-keyword">nmap</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">2.28</span> -F -sU

Starting Nmap <span class="hljs-number">7.80</span> ( http<span class="hljs-variable">s:</span>//<span class="hljs-keyword">nmap</span>.org ) at <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">16</span>:<span class="hljs-number">01</span> CEST
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">2.28</span>
Host <span class="hljs-keyword">is</span> <span class="hljs-keyword">up</span> (<span class="hljs-number">0.059</span>s latency).
Not shown: <span class="hljs-number">95</span> closed ports
PORT     STATE         SERVICE
<span class="hljs-number">68</span>/udp   <span class="hljs-keyword">open</span>|filtered dhcpc
<span class="hljs-number">137</span>/udp  <span class="hljs-keyword">open</span>          netbios-ns
<span class="hljs-number">138</span>/udp  <span class="hljs-keyword">open</span>|filtered netbios-dgm
<span class="hljs-number">631</span>/udp  <span class="hljs-keyword">open</span>|filtered ipp
<span class="hljs-number">5353</span>/udp <span class="hljs-keyword">open</span>          zeroconf
MAC Addres<span class="hljs-variable">s:</span> DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)

Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host <span class="hljs-keyword">up</span>) scanned in <span class="hljs-number">98.07</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.28</code></td>
<td>Scans the specified target.</td>
</tr>
<tr>
<td><code>-F</code></td>
<td>Scans top 100 ports.</td>
</tr>
<tr>
<td><code>-sU</code></td>
<td>Performs a UDP scan.</td>
</tr>
</tbody>
</table>
<hr>
<p>Another disadvantage of this is that we often do not get a response back because <code>Nmap</code> sends empty datagrams to the scanned UDP ports, and we do not receive any response. So we cannot determine if the UDP packet has arrived at all or not. If the UDP port is <code>open</code>, we only get a response if the application is configured to do so.</p>
<p>Host and Port Scanning</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -sU -Pn -n --disable-arp-ping --packet-trace -p <span class="hljs-number">137</span> --reason 

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">16</span>:<span class="hljs-number">15</span> CEST
SENT (<span class="hljs-number">0.</span>0367s) UDP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">55478</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">137</span> ttl=<span class="hljs-number">57</span> id=<span class="hljs-number">9122</span> iplen=<span class="hljs-number">78</span>
RCVD (<span class="hljs-number">0.</span>0398s) UDP <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">137</span> &gt; <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">55478</span> ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">13222</span> iplen=<span class="hljs-number">257</span>
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span>, received user-set (<span class="hljs-number">0.</span>0031s latency).

PORT    STATE SERVICE    REASON
<span class="hljs-number">137</span>/udp open  netbios-ns udp-response ttl <span class="hljs-number">64</span>
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.04</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.28</code></td>
<td>Scans the specified target.</td>
</tr>
<tr>
<td><code>-sU</code></td>
<td>Performs a UDP scan.</td>
</tr>
<tr>
<td><code>-Pn</code></td>
<td>Disables ICMP Echo requests.</td>
</tr>
<tr>
<td><code>-n</code></td>
<td>Disables DNS resolution.</td>
</tr>
<tr>
<td><code>--disable-arp-ping</code></td>
<td>Disables ARP ping.</td>
</tr>
<tr>
<td><code>--packet-trace</code></td>
<td>Shows all packets sent and received.</td>
</tr>
<tr>
<td><code>-p 137</code></td>
<td>Scans only the specified port.</td>
</tr>
<tr>
<td><code>--reason</code></td>
<td>Displays the reason a port is in a particular state.</td>
</tr>
</tbody>
</table>
<hr>
<p>If we get an ICMP response with <code>error code 3</code> (port unreachable), we know that the port is indeed <code>closed</code>.</p>
<p>Host and Port Scanning</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -sU -Pn -n --disable-arp-ping --packet-trace -p <span class="hljs-number">100</span> --reason 

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">16</span>:<span class="hljs-number">25</span> CEST
SENT (<span class="hljs-number">0.</span>0445s) UDP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">63825</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">100</span> ttl=<span class="hljs-number">57</span> id=<span class="hljs-number">29925</span> iplen=<span class="hljs-number">28</span>
RCVD (<span class="hljs-number">0.</span>1498s) ICMP [<span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> &gt; <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span> Port unreachable (type=<span class="hljs-number">3</span>/code=<span class="hljs-number">3</span>) ] <span class="hljs-built_in">IP</span> [ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">11903</span> iplen=<span class="hljs-number">56</span> ]
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span>, received user-set (<span class="hljs-number">0.</span>11s latency).

PORT    STATE  SERVICE REASON
<span class="hljs-number">100</span>/udp closed unknown port-unreach ttl <span class="hljs-number">64</span>
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span>  <span class="hljs-number">0.15</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.28</code></td>
<td>Scans the specified target.</td>
</tr>
<tr>
<td><code>-sU</code></td>
<td>Performs a UDP scan.</td>
</tr>
<tr>
<td><code>-Pn</code></td>
<td>Disables ICMP Echo requests.</td>
</tr>
<tr>
<td><code>-n</code></td>
<td>Disables DNS resolution.</td>
</tr>
<tr>
<td><code>--disable-arp-ping</code></td>
<td>Disables ARP ping.</td>
</tr>
<tr>
<td><code>--packet-trace</code></td>
<td>Shows all packets sent and received.</td>
</tr>
<tr>
<td><code>-p 100</code></td>
<td>Scans only the specified port.</td>
</tr>
<tr>
<td><code>--reason</code></td>
<td>Displays the reason a port is in a particular state.</td>
</tr>
</tbody>
</table>
<hr>
<p>For all other ICMP responses, the scanned ports are marked as (<code>open|filtered</code>).</p>
<p>Host and Port Scanning</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -sU -Pn -n --disable-arp-ping --packet-trace -p <span class="hljs-number">138</span> --reason 

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">16</span>:<span class="hljs-number">32</span> CEST
SENT (<span class="hljs-number">0.</span>0380s) UDP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">52341</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">138</span> ttl=<span class="hljs-number">50</span> id=<span class="hljs-number">65159</span> iplen=<span class="hljs-number">28</span>
SENT (<span class="hljs-number">1.</span>0392s) UDP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">52342</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">138</span> ttl=<span class="hljs-number">40</span> id=<span class="hljs-number">24444</span> iplen=<span class="hljs-number">28</span>
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span>, received user-set.

PORT    STATE         SERVICE     REASON
<span class="hljs-number">138</span>/udp open|filtered netbios-dgm no-response
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">2.06</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.28</code></td>
<td>Scans the specified target.</td>
</tr>
<tr>
<td><code>-sU</code></td>
<td>Performs a UDP scan.</td>
</tr>
<tr>
<td><code>-Pn</code></td>
<td>Disables ICMP Echo requests.</td>
</tr>
<tr>
<td><code>-n</code></td>
<td>Disables DNS resolution.</td>
</tr>
<tr>
<td><code>--disable-arp-ping</code></td>
<td>Disables ARP ping.</td>
</tr>
<tr>
<td><code>--packet-trace</code></td>
<td>Shows all packets sent and received.</td>
</tr>
<tr>
<td><code>-p 138</code></td>
<td>Scans only the specified port.</td>
</tr>
<tr>
<td><code>--reason</code></td>
<td>Displays the reason a port is in a particular state.</td>
</tr>
</tbody>
</table>
<p>Another handy method for scanning ports is the <code>-sV</code> option which is used to get additional available information from the open ports. This method can identify versions, service names, and details about our target.</p>
<p><strong>Version Scan</strong></p>
<p>Host and Port Scanning</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -Pn -n --disable-arp-ping --packet-trace -p <span class="hljs-number">445</span> --reason  -sV

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2022</span>-<span class="hljs-number">11</span>-<span class="hljs-number">04</span> <span class="hljs-number">11</span>:<span class="hljs-number">10</span> GMT
SENT (<span class="hljs-number">0.</span>3426s) TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">44641</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span> S ttl=<span class="hljs-number">55</span> id=<span class="hljs-number">43401</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">3589068008</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
RCVD (<span class="hljs-number">0.</span>3556s) TCP <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span> &gt; <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">44641</span> SA ttl=<span class="hljs-number">63</span> id=<span class="hljs-number">0</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">2881527699</span> win=<span class="hljs-number">29200</span> &lt;mss <span class="hljs-number">1337</span>&gt;
NSOCK INFO [<span class="hljs-number">0.</span>4980s] nsock_iod_new2(): nsock_iod_new (IOD #<span class="hljs-number">1</span>)
NSOCK INFO [<span class="hljs-number">0.</span>4980s] nsock_connect_tcp(): TCP connection requested to <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span> (IOD #<span class="hljs-number">1</span>) EID <span class="hljs-number">8</span>
NSOCK INFO [<span class="hljs-number">0.</span>5130s] nsock_trace_handler_callback(): Callback: CONNECT SUCCESS for EID <span class="hljs-number">8</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span>]
Service scan sending probe NULL to <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span> (tcp)
NSOCK INFO [<span class="hljs-number">0.</span>5130s] nsock_read(): Read request from IOD #<span class="hljs-number">1</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span>] (timeout: 6000ms) EID <span class="hljs-number">18</span>
NSOCK INFO [<span class="hljs-number">6.</span>5190s] nsock_trace_handler_callback(): Callback: READ TIMEOUT for EID <span class="hljs-number">18</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span>]
Service scan sending probe SMBProgNeg to <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span> (tcp)
NSOCK INFO [<span class="hljs-number">6.</span>5190s] nsock_write(): Write request for <span class="hljs-number">168</span> bytes to IOD #<span class="hljs-number">1</span> EID <span class="hljs-number">27</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span>]
NSOCK INFO [<span class="hljs-number">6.</span>5190s] nsock_read(): Read request from IOD #<span class="hljs-number">1</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span>] (timeout: 5000ms) EID <span class="hljs-number">34</span>
NSOCK INFO [<span class="hljs-number">6.</span>5190s] nsock_trace_handler_callback(): Callback: WRITE SUCCESS for EID <span class="hljs-number">27</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span>]
NSOCK INFO [<span class="hljs-number">6.</span>5320s] nsock_trace_handler_callback(): Callback: READ SUCCESS for EID <span class="hljs-number">34</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span>] (<span class="hljs-number">135</span> bytes)
Service scan match (Probe SMBProgNeg matched with SMBProgNeg line <span class="hljs-number">13836</span>): <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">445</span> is netbios-ssn.  Version: |Samba smbd|<span class="hljs-number">3.</span>X - <span class="hljs-number">4.</span>X|workgroup: WORKGROUP|
NSOCK INFO [<span class="hljs-number">6.</span>5320s] nsock_iod_delete(): nsock_iod_delete (IOD #<span class="hljs-number">1</span>)
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span>, received user-set (<span class="hljs-number">0.</span>013s latency).

PORT    STATE SERVICE     REASON         VERSION
<span class="hljs-number">445</span>/tcp open  netbios-ssn syn-ack ttl <span class="hljs-number">63</span> Samba smbd <span class="hljs-number">3.</span>X - <span class="hljs-number">4.</span>X (workgroup: WORKGROUP)
Service Info: Host: Ubuntu

Service detection performed. Please report any incorrect results <span class="hljs-meta">at</span> https://nmap.org/submit/ .
Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">6.55</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.28</code></td>
<td>Scans the specified target.</td>
</tr>
<tr>
<td><code>-Pn</code></td>
<td>Disables ICMP Echo requests.</td>
</tr>
<tr>
<td><code>-n</code></td>
<td>Disables DNS resolution.</td>
</tr>
<tr>
<td><code>--disable-arp-ping</code></td>
<td>Disables ARP ping.</td>
</tr>
<tr>
<td><code>--packet-trace</code></td>
<td>Shows all packets sent and received.</td>
</tr>
<tr>
<td><code>-p 445</code></td>
<td>Scans only the specified port.</td>
</tr>
<tr>
<td><code>--reason</code></td>
<td>Displays the reason a port is in a particular state.</td>
</tr>
<tr>
<td><code>-sV</code></td>
<td>Performs a service scan.</td>
</tr>
</tbody>
</table>
<p>More information about port scanning techniques we can find at: <a href="https://nmap.org/book/man-port-scanning-techniques.html">https://nmap.org/book/man-port-scanning-techniques.html</a></p>
<h2 id="saving-the-results">Saving the Results</h2>
<hr>
<h3 id="different-formats">Different Formats</h3>
<p>While we run various scans, we should always save the results. We can use these later to examine the differences between the different scanning methods we have used. <code>Nmap</code> can save the results in 3 different formats.</p>
<ul>
<li>Normal output (<code>-oN</code>) with the <code>.nmap</code> file extension</li>
<li>Grepable output (<code>-oG</code>) with the <code>.gnmap</code> file extension</li>
<li>XML output (<code>-oX</code>) with the <code>.xml</code> file extension</li>
</ul>
<p>We can also specify the option (<code>-oA</code>) to save the results in all formats. The command could look like this:</p>
<p>Saving the Results</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span> -p- -oA target

Starting Nmap <span class="hljs-number">7.80</span> ( <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org ) at 2020-06-16 12:14 CEST</span>
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span>
Host is up (<span class="hljs-number">0.0091</span>s latency).
Not <span class="hljs-string">shown:</span> <span class="hljs-number">65525</span> closed ports
PORT      STATE SERVICE
<span class="hljs-number">22</span>/tcp    open  ssh
<span class="hljs-number">25</span>/tcp    open  smtp
<span class="hljs-number">80</span>/tcp    open  http
MAC <span class="hljs-string">Address:</span> <span class="hljs-string">DE:</span><span class="hljs-string">AD:</span><span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-string">BE:</span>EF (Intel Corporate)

Nmap <span class="hljs-string">done:</span> <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">10.22</span> seconds
</code></pre>
<table data-header-hidden><thead><tr><th width="188"></th><th></th></tr></thead><tbody><tr><td><strong>Scanning Options</strong></td><td><strong>Description</strong></td></tr><tr><td><code>10.129.2.28</code></td><td>Scans the specified target.</td></tr><tr><td><code>-p-</code></td><td>Scans all ports.</td></tr><tr><td><code>-oA target</code></td><td>Saves the results in all formats, starting the name of each file with &#39;target&#39;.</td></tr></tbody></table>

<p>If no full path is given, the results will be stored in the directory we are currently in. Next, we look at the different formats <code>Nmap</code> has created for us.</p>
<p>Saving the Results</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ ls

<span class="hljs-keyword">target</span>.gnmap <span class="hljs-keyword">target</span>.xml  <span class="hljs-keyword">target</span>.nmap
</code></pre>
<p><strong>Normal Output</strong></p>
<p>Saving the Results</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ <span class="hljs-keyword">cat</span> target.<span class="hljs-keyword">nmap</span>

# Nmap <span class="hljs-number">7.80</span> scan initiated Tue Jun <span class="hljs-number">16</span> <span class="hljs-number">12</span>:<span class="hljs-number">14</span>:<span class="hljs-number">53</span> <span class="hljs-number">2020</span> <span class="hljs-keyword">a</span><span class="hljs-variable">s:</span> <span class="hljs-keyword">nmap</span> -<span class="hljs-keyword">p</span>- -oA target <span class="hljs-number">10.129</span>.<span class="hljs-number">2.28</span>
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">2.28</span>
Host <span class="hljs-keyword">is</span> <span class="hljs-keyword">up</span> (<span class="hljs-number">0.053</span>s latency).
Not shown: <span class="hljs-number">4</span> closed ports
PORT   STATE SERVICE
<span class="hljs-number">22</span>/tcp <span class="hljs-keyword">open</span>  ssh
<span class="hljs-number">25</span>/tcp <span class="hljs-keyword">open</span>  smtp
<span class="hljs-number">80</span>/tcp <span class="hljs-keyword">open</span>  http
MAC Addres<span class="hljs-variable">s:</span> DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)

# Nmap done at Tue Jun <span class="hljs-number">16</span> <span class="hljs-number">12</span>:<span class="hljs-number">15</span>:<span class="hljs-number">03</span> <span class="hljs-number">2020</span> -- <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host <span class="hljs-keyword">up</span>) scanned in <span class="hljs-number">10.22</span> seconds
</code></pre>
<p><strong>Grepable Output</strong></p>
<p>Saving the Results</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ <span class="hljs-keyword">cat</span> target.gnmap

# Nmap <span class="hljs-number">7.80</span> scan initiated Tue Jun <span class="hljs-number">16</span> <span class="hljs-number">12</span>:<span class="hljs-number">14</span>:<span class="hljs-number">53</span> <span class="hljs-number">2020</span> <span class="hljs-keyword">a</span><span class="hljs-variable">s:</span> <span class="hljs-keyword">nmap</span> -<span class="hljs-keyword">p</span>- -oA target <span class="hljs-number">10.129</span>.<span class="hljs-number">2.28</span>
Hos<span class="hljs-variable">t:</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">2.28</span> ()    Statu<span class="hljs-variable">s:</span> Up
Hos<span class="hljs-variable">t:</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">2.28</span> ()    Port<span class="hljs-variable">s:</span> <span class="hljs-number">22</span>/<span class="hljs-keyword">open</span>/tcp//ssh///, <span class="hljs-number">25</span>/<span class="hljs-keyword">open</span>/tcp//smtp///, <span class="hljs-number">80</span>/<span class="hljs-keyword">open</span>/tcp//http///    Ignored State: closed (<span class="hljs-number">4</span>)
# Nmap done at Tue Jun <span class="hljs-number">16</span> <span class="hljs-number">12</span>:<span class="hljs-number">14</span>:<span class="hljs-number">53</span> <span class="hljs-number">2020</span> -- <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host <span class="hljs-keyword">up</span>) scanned in <span class="hljs-number">10.22</span> seconds
</code></pre>
<p><strong>XML Output</strong></p>
<p>Saving the Results</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat target.xml

<span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-meta">&lt;!DOCTYPE nmaprun&gt;</span>
<span class="php"><span class="hljs-meta">&lt;?</span>xml-stylesheet href=<span class="hljs-string">"file:///usr/local/bin/../share/nmap/nmap.xsl"</span> type=<span class="hljs-string">"text/xsl"</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-comment">&lt;!-- Nmap 7.80 scan initiated Tue Jun 16 12:14:53 2020 as: nmap -p- -oA target 10.129.2.28 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">nmaprun</span> <span class="hljs-attr">scanner</span>=<span class="hljs-string">"nmap"</span> <span class="hljs-attr">args</span>=<span class="hljs-string">"nmap -p- -oA target 10.129.2.28"</span> <span class="hljs-attr">start</span>=<span class="hljs-string">"12145301719"</span> <span class="hljs-attr">startstr</span>=<span class="hljs-string">"Tue Jun 16 12:15:03 2020"</span> <span class="hljs-attr">version</span>=<span class="hljs-string">"7.80"</span> <span class="hljs-attr">xmloutputversion</span>=<span class="hljs-string">"1.04"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">scaninfo</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"syn"</span> <span class="hljs-attr">protocol</span>=<span class="hljs-string">"tcp"</span> <span class="hljs-attr">numservices</span>=<span class="hljs-string">"65535"</span> <span class="hljs-attr">services</span>=<span class="hljs-string">"1-65535"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">verbose</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"0"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">debugging</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"0"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">host</span> <span class="hljs-attr">starttime</span>=<span class="hljs-string">"12145301719"</span> <span class="hljs-attr">endtime</span>=<span class="hljs-string">"12150323493"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">status</span> <span class="hljs-attr">state</span>=<span class="hljs-string">"up"</span> <span class="hljs-attr">reason</span>=<span class="hljs-string">"arp-response"</span> <span class="hljs-attr">reason_ttl</span>=<span class="hljs-string">"0"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">address</span> <span class="hljs-attr">addr</span>=<span class="hljs-string">"10.129.2.28"</span> <span class="hljs-attr">addrtype</span>=<span class="hljs-string">"ipv4"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">address</span> <span class="hljs-attr">addr</span>=<span class="hljs-string">"DE:AD:00:00:BE:EF"</span> <span class="hljs-attr">addrtype</span>=<span class="hljs-string">"mac"</span> <span class="hljs-attr">vendor</span>=<span class="hljs-string">"Intel Corporate"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hostnames</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hostnames</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">ports</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">extraports</span> <span class="hljs-attr">state</span>=<span class="hljs-string">"closed"</span> <span class="hljs-attr">count</span>=<span class="hljs-string">"4"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">extrareasons</span> <span class="hljs-attr">reason</span>=<span class="hljs-string">"resets"</span> <span class="hljs-attr">count</span>=<span class="hljs-string">"4"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">extraports</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">port</span> <span class="hljs-attr">protocol</span>=<span class="hljs-string">"tcp"</span> <span class="hljs-attr">portid</span>=<span class="hljs-string">"22"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">state</span> <span class="hljs-attr">state</span>=<span class="hljs-string">"open"</span> <span class="hljs-attr">reason</span>=<span class="hljs-string">"syn-ack"</span> <span class="hljs-attr">reason_ttl</span>=<span class="hljs-string">"64"</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">service</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ssh"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"table"</span> <span class="hljs-attr">conf</span>=<span class="hljs-string">"3"</span>/&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">port</span> <span class="hljs-attr">protocol</span>=<span class="hljs-string">"tcp"</span> <span class="hljs-attr">portid</span>=<span class="hljs-string">"25"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">state</span> <span class="hljs-attr">state</span>=<span class="hljs-string">"open"</span> <span class="hljs-attr">reason</span>=<span class="hljs-string">"syn-ack"</span> <span class="hljs-attr">reason_ttl</span>=<span class="hljs-string">"64"</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">service</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"smtp"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"table"</span> <span class="hljs-attr">conf</span>=<span class="hljs-string">"3"</span>/&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">port</span> <span class="hljs-attr">protocol</span>=<span class="hljs-string">"tcp"</span> <span class="hljs-attr">portid</span>=<span class="hljs-string">"80"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">state</span> <span class="hljs-attr">state</span>=<span class="hljs-string">"open"</span> <span class="hljs-attr">reason</span>=<span class="hljs-string">"syn-ack"</span> <span class="hljs-attr">reason_ttl</span>=<span class="hljs-string">"64"</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">service</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"http"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"table"</span> <span class="hljs-attr">conf</span>=<span class="hljs-string">"3"</span>/&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ports</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">times</span> <span class="hljs-attr">srtt</span>=<span class="hljs-string">"52614"</span> <span class="hljs-attr">rttvar</span>=<span class="hljs-string">"75640"</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"355174"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">runstats</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">finished</span> <span class="hljs-attr">time</span>=<span class="hljs-string">"12150323493"</span> <span class="hljs-attr">timestr</span>=<span class="hljs-string">"Tue Jun 16 12:14:53 2020"</span> <span class="hljs-attr">elapsed</span>=<span class="hljs-string">"10.22"</span> <span class="hljs-attr">summary</span>=<span class="hljs-string">"Nmap done at Tue Jun 16 12:15:03 2020; 1 IP address (1 host up) scanned in 10.22 seconds"</span> <span class="hljs-attr">exit</span>=<span class="hljs-string">"success"</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">hosts</span> <span class="hljs-attr">up</span>=<span class="hljs-string">"1"</span> <span class="hljs-attr">down</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">total</span>=<span class="hljs-string">"1"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">runstats</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">nmaprun</span>&gt;</span>
</code></pre>
<hr>
<h3 id="style-sheets">Style sheets</h3>
<p>With the XML output, we can easily create HTML reports that are easy to read, even for non-technical people. This is later very useful for documentation, as it presents our results in a detailed and clear way. To convert the stored results from XML format to HTML, we can use the tool <code>xsltproc</code>.</p>
<p>Saving the Results</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ xsltproc <span class="hljs-keyword">target</span>.xml -o <span class="hljs-keyword">target</span>.html
</code></pre>
<p>If we now open the HTML file in our browser, we see a clear and structured presentation of our results.</p>
<p><strong>Nmap Report</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/19/nmap-report.png" alt="image"></p>
<p>More information about the output formats can be found at: <a href="https://nmap.org/book/output.html">https://nmap.org/book/output.html</a></p>
<h2 id="service-enumeration">Service Enumeration</h2>
<hr>
<p>For us, it is essential to determine the application and its version as accurately as possible. We can use this information to scan for known vulnerabilities and analyze the source code for that version if we find it. An exact version number allows us to search for a more precise exploit that fits the service and the operating system of our target.</p>
<hr>
<h3 id="service-version-detection">Service Version Detection</h3>
<p>It is recommended to perform a quick port scan first, which gives us a small overview of the available ports. This causes significantly less traffic, which is advantageous for us because otherwise we can be discovered and blocked by the security mechanisms. We can deal with these first and run a port scan in the background, which shows all open ports (<code>-p-</code>). We can use the version scan to scan the specific ports for services and their versions (<code>-sV</code>).</p>
<p>A full port scan takes quite a long time. To view the scan status, we can press the <code>[Space Bar]</code> during the scan, which will cause <code>Nmap</code> to show us the scan status.</p>
<p>Service Enumeration</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ sudo nmap <span class="hljs-number">10.129</span>.<span class="hljs-number">2.28</span> -p- -sV

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) at <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">19</span>:<span class="hljs-number">44</span> CEST
[Space Bar]
Stats: <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">03</span> elapsed; 0 <span class="hljs-selector-tag">hosts</span> <span class="hljs-selector-tag">completed</span> (1 <span class="hljs-selector-tag">up</span>), 1 <span class="hljs-selector-tag">undergoing</span> <span class="hljs-selector-tag">SYN</span> <span class="hljs-selector-tag">Stealth</span> <span class="hljs-selector-tag">Scan</span>
<span class="hljs-selector-tag">SYN</span> <span class="hljs-selector-tag">Stealth</span> <span class="hljs-selector-tag">Scan</span> <span class="hljs-selector-tag">Timing</span>: <span class="hljs-selector-tag">About</span> 3<span class="hljs-selector-class">.64</span>% <span class="hljs-selector-tag">done</span>; <span class="hljs-selector-tag">ETC</span>: 19<span class="hljs-selector-pseudo">:45</span> (0<span class="hljs-selector-pseudo">:00</span><span class="hljs-selector-pseudo">:53</span> <span class="hljs-selector-tag">remaining</span>)
</code></pre>
<table data-header-hidden><thead><tr><th width="192"></th><th></th></tr></thead><tbody><tr><td><strong>Scanning Options</strong></td><td><strong>Description</strong></td></tr><tr><td><code>10.129.2.28</code></td><td>Scans the specified target.</td></tr><tr><td><code>-p-</code></td><td>Scans all ports.</td></tr><tr><td><code>-sV</code></td><td>Performs service version detection on specified ports.</td></tr></tbody></table>

<hr>
<p>Another option (<code>--stats-every=5s</code>) that we can use is defining how periods of time the status should be shown. Here we can specify the number of seconds (<code>s</code>) or minutes (<code>m</code>), after which we want to get the status.</p>
<p>Service Enumeration</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ sudo nmap <span class="hljs-number">10.129</span>.<span class="hljs-number">2.28</span> -p- -sV --stats-every=<span class="hljs-number">5s</span>

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) at <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">15</span> <span class="hljs-number">19</span>:<span class="hljs-number">46</span> CEST
Stats: <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">05</span> elapsed; 0 <span class="hljs-selector-tag">hosts</span> <span class="hljs-selector-tag">completed</span> (1 <span class="hljs-selector-tag">up</span>), 1 <span class="hljs-selector-tag">undergoing</span> <span class="hljs-selector-tag">SYN</span> <span class="hljs-selector-tag">Stealth</span> <span class="hljs-selector-tag">Scan</span>
<span class="hljs-selector-tag">SYN</span> <span class="hljs-selector-tag">Stealth</span> <span class="hljs-selector-tag">Scan</span> <span class="hljs-selector-tag">Timing</span>: <span class="hljs-selector-tag">About</span> 13<span class="hljs-selector-class">.91</span>% <span class="hljs-selector-tag">done</span>; <span class="hljs-selector-tag">ETC</span>: 19<span class="hljs-selector-pseudo">:49</span> (0<span class="hljs-selector-pseudo">:00</span><span class="hljs-selector-pseudo">:31</span> <span class="hljs-selector-tag">remaining</span>)
<span class="hljs-selector-tag">Stats</span>: 0<span class="hljs-selector-pseudo">:00</span><span class="hljs-selector-pseudo">:10</span> <span class="hljs-selector-tag">elapsed</span>; 0 <span class="hljs-selector-tag">hosts</span> <span class="hljs-selector-tag">completed</span> (1 <span class="hljs-selector-tag">up</span>), 1 <span class="hljs-selector-tag">undergoing</span> <span class="hljs-selector-tag">SYN</span> <span class="hljs-selector-tag">Stealth</span> <span class="hljs-selector-tag">Scan</span>
<span class="hljs-selector-tag">SYN</span> <span class="hljs-selector-tag">Stealth</span> <span class="hljs-selector-tag">Scan</span> <span class="hljs-selector-tag">Timing</span>: <span class="hljs-selector-tag">About</span> 39<span class="hljs-selector-class">.57</span>% <span class="hljs-selector-tag">done</span>; <span class="hljs-selector-tag">ETC</span>: 19<span class="hljs-selector-pseudo">:48</span> (0<span class="hljs-selector-pseudo">:00</span><span class="hljs-selector-pseudo">:15</span> <span class="hljs-selector-tag">remaining</span>)
</code></pre>
<table data-header-hidden><thead><tr><th width="233"></th><th></th></tr></thead><tbody><tr><td><strong>Scanning Options</strong></td><td><strong>Description</strong></td></tr><tr><td><code>10.129.2.28</code></td><td>Scans the specified target.</td></tr><tr><td><code>-p-</code></td><td>Scans all ports.</td></tr><tr><td><code>-sV</code></td><td>Performs service version detection on specified ports.</td></tr><tr><td><code>--stats-every=5s</code></td><td>Shows the progress of the scan every 5 seconds.</td></tr></tbody></table>

<hr>
<p>We can also increase the <code>verbosity level</code> (<code>-v</code> / <code>-vv</code>), which will show us the open ports directly when <code>Nmap</code> detects them.</p>
<p>Service Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span> -p- -sV -v 

Starting Nmap <span class="hljs-number">7.80</span> ( <span class="hljs-keyword">https</span>://nmap.org ) <span class="hljs-keyword">at</span> <span class="hljs-number">2020</span><span class="hljs-number">-06</span><span class="hljs-number">-15</span> <span class="hljs-number">20</span>:<span class="hljs-number">03</span> CEST
NSE: Loaded <span class="hljs-number">45</span> scripts <span class="hljs-keyword">for</span> scanning.
Initiating ARP Ping Scan <span class="hljs-keyword">at</span> <span class="hljs-number">20</span>:<span class="hljs-number">03</span>
Scanning <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span> [<span class="hljs-number">1</span> port]
Completed ARP Ping Scan <span class="hljs-keyword">at</span> <span class="hljs-number">20</span>:<span class="hljs-number">03</span>, <span class="hljs-number">0.03</span>s elapsed (<span class="hljs-number">1</span> total hosts)
Initiating Parallel DNS resolution <span class="hljs-keyword">of</span> <span class="hljs-number">1</span> host. <span class="hljs-keyword">at</span> <span class="hljs-number">20</span>:<span class="hljs-number">03</span>
Completed Parallel DNS resolution <span class="hljs-keyword">of</span> <span class="hljs-number">1</span> host. <span class="hljs-keyword">at</span> <span class="hljs-number">20</span>:<span class="hljs-number">03</span>, <span class="hljs-number">0.02</span>s elapsed
Initiating SYN Stealth Scan <span class="hljs-keyword">at</span> <span class="hljs-number">20</span>:<span class="hljs-number">03</span>
Scanning <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span> [<span class="hljs-number">65535</span> ports]
Discovered <span class="hljs-built_in">open</span> port <span class="hljs-number">995</span>/tcp <span class="hljs-keyword">on</span> <span class="hljs-title">10</span><span class="hljs-number">.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span>
Discovered <span class="hljs-built_in">open</span> port <span class="hljs-number">80</span>/tcp <span class="hljs-keyword">on</span> <span class="hljs-title">10</span><span class="hljs-number">.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span>
Discovered <span class="hljs-built_in">open</span> port <span class="hljs-number">993</span>/tcp <span class="hljs-keyword">on</span> <span class="hljs-title">10</span><span class="hljs-number">.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span>
Discovered <span class="hljs-built_in">open</span> port <span class="hljs-number">143</span>/tcp <span class="hljs-keyword">on</span> <span class="hljs-title">10</span><span class="hljs-number">.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span>
Discovered <span class="hljs-built_in">open</span> port <span class="hljs-number">25</span>/tcp <span class="hljs-keyword">on</span> <span class="hljs-title">10</span><span class="hljs-number">.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span>
Discovered <span class="hljs-built_in">open</span> port <span class="hljs-number">110</span>/tcp <span class="hljs-keyword">on</span> <span class="hljs-title">10</span><span class="hljs-number">.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span>
Discovered <span class="hljs-built_in">open</span> port <span class="hljs-number">22</span>/tcp <span class="hljs-keyword">on</span> <span class="hljs-title">10</span><span class="hljs-number">.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span>
&lt;SNIP&gt;
</code></pre>
<table data-header-hidden><thead><tr><th width="203"></th><th></th></tr></thead><tbody><tr><td><strong>Scanning Options</strong></td><td><strong>Description</strong></td></tr><tr><td><code>10.129.2.28</code></td><td>Scans the specified target.</td></tr><tr><td><code>-p-</code></td><td>Scans all ports.</td></tr><tr><td><code>-sV</code></td><td>Performs service version detection on specified ports.</td></tr><tr><td><code>-v</code></td><td>Increases the verbosity of the scan, which displays more detailed information.</td></tr></tbody></table>

<hr>
<h3 id="banner-grabbing">Banner Grabbing</h3>
<p>Once the scan is complete, we will see all TCP ports with the corresponding service and their versions that are active on the system.</p>
<p>Service Enumeration</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span> -p- -sV

Starting Nmap <span class="hljs-number">7.80</span> ( <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org ) at 2020-06-15 20:00 CEST</span>
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span>
Host is up (<span class="hljs-number">0.013</span>s latency).
Not <span class="hljs-string">shown:</span> <span class="hljs-number">65525</span> closed ports
PORT      STATE    SERVICE      VERSION
<span class="hljs-number">22</span>/tcp    open     ssh          OpenSSH <span class="hljs-number">7.6</span>p1 Ubuntu <span class="hljs-number">4</span>ubuntu0<span class="hljs-number">.3</span> (Ubuntu Linux; protocol <span class="hljs-number">2.0</span>)
<span class="hljs-number">25</span>/tcp    open     smtp         Postfix smtpd
<span class="hljs-number">80</span>/tcp    open     http         Apache httpd <span class="hljs-number">2.4</span><span class="hljs-number">.29</span> ((Ubuntu))
<span class="hljs-number">110</span>/tcp   open     pop3         Dovecot pop3d
<span class="hljs-number">139</span>/tcp   filtered netbios-ssn
<span class="hljs-number">143</span>/tcp   open     imap         Dovecot imapd (Ubuntu)
<span class="hljs-number">445</span>/tcp   filtered microsoft-ds
<span class="hljs-number">993</span><span class="hljs-regexp">/tcp   open     ssl/</span>imap     Dovecot imapd (Ubuntu)
<span class="hljs-number">995</span><span class="hljs-regexp">/tcp   open     ssl/</span>pop3     Dovecot pop3d
MAC <span class="hljs-string">Address:</span> <span class="hljs-string">DE:</span><span class="hljs-string">AD:</span><span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-string">BE:</span>EF (Intel Corporate)
Service <span class="hljs-string">Info:</span> <span class="hljs-string">Host:</span>  inlane; <span class="hljs-string">OS:</span> Linux; <span class="hljs-string">CPE:</span> <span class="hljs-string">cpe:</span>/<span class="hljs-string">o:</span><span class="hljs-string">linux:</span>linux_kernel

Service detection performed. Please report any incorrect results at <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org/submit/ .</span>
Nmap <span class="hljs-string">done:</span> <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">91.73</span> seconds
</code></pre>
<table data-header-hidden><thead><tr><th width="185"></th><th></th></tr></thead><tbody><tr><td><strong>Scanning Options</strong></td><td><strong>Description</strong></td></tr><tr><td><code>10.129.2.28</code></td><td>Scans the specified target.</td></tr><tr><td><code>-p-</code></td><td>Scans all ports.</td></tr><tr><td><code>-sV</code></td><td>Performs service version detection on specified ports.</td></tr></tbody></table>

<hr>
<p>Primarily, <code>Nmap</code> looks at the banners of the scanned ports and prints them out. If it cannot identify versions through the banners, <code>Nmap</code> attempts to identify them through a signature-based matching system, but this significantly increases the scan&#39;s duration. One disadvantage to <code>Nmap</code>&#39;s presented results is that the automatic scan can miss some information because sometimes <code>Nmap</code> does not know how to handle it. Let us look at an example of this.</p>
<p>Service Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span> -p- -sV -Pn -n <span class="hljs-comment">--disable-arp-ping --packet-trace</span>

Starting Nmap <span class="hljs-number">7.80</span> ( <span class="hljs-keyword">https</span>://nmap.org ) <span class="hljs-keyword">at</span> <span class="hljs-number">2020</span><span class="hljs-number">-06</span><span class="hljs-number">-16</span> <span class="hljs-number">20</span>:<span class="hljs-number">10</span> CEST
&lt;SNIP&gt;
NSOCK INFO [<span class="hljs-number">0.4200</span>s] nsock_trace_handler_callback(): Callback: READ SUCCESS <span class="hljs-keyword">for</span> EID <span class="hljs-number">18</span> [<span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span>:<span class="hljs-number">25</span>] (<span class="hljs-number">35</span> <span class="hljs-keyword">bytes</span>): <span class="hljs-number">220</span> inlane ESMTP Postfix (Ubuntu)..
Service scan match (Probe <span class="hljs-literal">NULL</span> matched <span class="hljs-keyword">with</span> <span class="hljs-literal">NULL</span> <span class="hljs-built_in">line</span> <span class="hljs-number">3104</span>): <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span>:<span class="hljs-number">25</span> is smtp.  Version: |Postfix smtpd|||
NSOCK INFO [<span class="hljs-number">0.4200</span>s] nsock_iod_delete(): nsock_iod_delete (IOD <span class="hljs-comment">#1)</span>
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span>
Host is up (<span class="hljs-number">0.076</span>s latency).

PORT   STATE SERVICE VERSION
<span class="hljs-number">25</span>/tcp <span class="hljs-built_in">open</span>  smtp    Postfix smtpd
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)
Service Info: Host:  inlane

Service detection performed. Please report <span class="hljs-keyword">any</span> incorrect results <span class="hljs-keyword">at</span> <span class="hljs-keyword">https</span>://nmap.org/submit/ .
Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.47</span> <span class="hljs-built_in">seconds</span>
</code></pre>
<table data-header-hidden><thead><tr><th width="249"></th><th></th></tr></thead><tbody><tr><td><strong>Scanning Options</strong></td><td><strong>Description</strong></td></tr><tr><td><code>10.129.2.28</code></td><td>Scans the specified target.</td></tr><tr><td><code>-p-</code></td><td>Scans all ports.</td></tr><tr><td><code>-sV</code></td><td>Performs service version detection on specified ports.</td></tr><tr><td><code>-Pn</code></td><td>Disables ICMP Echo requests.</td></tr><tr><td><code>-n</code></td><td>Disables DNS resolution.</td></tr><tr><td><code>--disable-arp-ping</code></td><td>Disables ARP ping.</td></tr><tr><td><code>--packet-trace</code></td><td>Shows all packets sent and received.</td></tr></tbody></table>

<hr>
<p>If we look at the results from <code>Nmap</code>, we can see the port&#39;s status, service name, and hostname. Nevertheless, let us look at this line here:</p>
<ul>
<li><code>NSOCK INFO [0.4200s] nsock_trace_handler_callback(): Callback: READ SUCCESS for EID 18 [10.129.2.28:25] (35 bytes): 220 inlane ESMTP Postfix (Ubuntu)..</code></li>
</ul>
<p>Then we see that the SMTP server on our target gave us more information than <code>Nmap</code> showed us. Because here, we see that it is the Linux distribution <code>Ubuntu</code>. It happens because, after a successful three-way handshake, the server often sends a banner for identification. This serves to let the client know which service it is working with. At the network level, this happens with a <code>PSH</code> flag in the TCP header. However, it can happen that some services do not immediately provide such information. It is also possible to remove or manipulate the banners from the respective services. If we <code>manually</code> connect to the SMTP server using <code>nc</code>, grab the banner, and intercept the network traffic using <code>tcpdump</code>, we can see what <code>Nmap</code> did not show us.</p>
<p><strong>Tcpdump</strong></p>
<p>Service Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo tcpdump -i eth0 host 10.10.14.2 and 10.129.2.28

tcpdump: verbose output suppressed, <span class="hljs-keyword">use</span> -v <span class="hljs-keyword">or</span> -vv <span class="hljs-keyword">for</span> <span class="hljs-keyword">full</span> protocol <span class="hljs-keyword">decode</span>
listening <span class="hljs-keyword">on</span> eth0, <span class="hljs-keyword">link</span>-<span class="hljs-keyword">type</span> EN10MB (Ethernet), capture <span class="hljs-keyword">size</span> <span class="hljs-number">262144</span> <span class="hljs-keyword">bytes</span>
</code></pre>
<p><strong>Nc</strong></p>
<p>Service Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$  nc -nv <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span> <span class="hljs-number">25</span>

Connection to <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span> port <span class="hljs-number">25</span> [tcp<span class="hljs-comment">/*] succeeded!
220 inlane ESMTP Postfix (Ubuntu)</span>
</code></pre>
<p><strong>Tcpdump - Intercepted Traffic</strong></p>
<p>Service Enumeration</p>
<pre><code class="lang-shell-session">18<span class="hljs-selector-pseudo">:28</span><span class="hljs-selector-pseudo">:07.128564</span> <span class="hljs-selector-tag">IP</span> 10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.2</span><span class="hljs-selector-class">.59618</span> &gt; 10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.2</span><span class="hljs-selector-class">.28</span><span class="hljs-selector-class">.smtp</span>: <span class="hljs-selector-tag">Flags</span> <span class="hljs-selector-attr">[S]</span>, <span class="hljs-selector-tag">seq</span> 1798872233, <span class="hljs-selector-tag">win</span> 65535, <span class="hljs-selector-tag">options</span> <span class="hljs-selector-attr">[mss 1460,nop,wscale 6,nop,nop,TS val 331260178 ecr 0,sackOK,eol]</span>, <span class="hljs-selector-tag">length</span> 0
18<span class="hljs-selector-pseudo">:28</span><span class="hljs-selector-pseudo">:07.255151</span> <span class="hljs-selector-tag">IP</span> 10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.2</span><span class="hljs-selector-class">.28</span><span class="hljs-selector-class">.smtp</span> &gt; 10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.2</span><span class="hljs-selector-class">.59618</span>: <span class="hljs-selector-tag">Flags</span> <span class="hljs-selector-attr">[S.]</span>, <span class="hljs-selector-tag">seq</span> 1130574379, <span class="hljs-selector-tag">ack</span> 1798872234, <span class="hljs-selector-tag">win</span> 65160, <span class="hljs-selector-tag">options</span> <span class="hljs-selector-attr">[mss 1460,sackOK,TS val 1800383922 ecr 331260178,nop,wscale 7]</span>, <span class="hljs-selector-tag">length</span> 0
18<span class="hljs-selector-pseudo">:28</span><span class="hljs-selector-pseudo">:07.255281</span> <span class="hljs-selector-tag">IP</span> 10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.2</span><span class="hljs-selector-class">.59618</span> &gt; 10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.2</span><span class="hljs-selector-class">.28</span><span class="hljs-selector-class">.smtp</span>: <span class="hljs-selector-tag">Flags</span> <span class="hljs-selector-attr">[.]</span>, <span class="hljs-selector-tag">ack</span> 1, <span class="hljs-selector-tag">win</span> 2058, <span class="hljs-selector-tag">options</span> <span class="hljs-selector-attr">[nop,nop,TS val 331260304 ecr 1800383922]</span>, <span class="hljs-selector-tag">length</span> 0
18<span class="hljs-selector-pseudo">:28</span><span class="hljs-selector-pseudo">:07.319306</span> <span class="hljs-selector-tag">IP</span> 10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.2</span><span class="hljs-selector-class">.28</span><span class="hljs-selector-class">.smtp</span> &gt; 10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.2</span><span class="hljs-selector-class">.59618</span>: <span class="hljs-selector-tag">Flags</span> <span class="hljs-selector-attr">[P.]</span>, <span class="hljs-selector-tag">seq</span> 1<span class="hljs-selector-pseudo">:36</span>, <span class="hljs-selector-tag">ack</span> 1, <span class="hljs-selector-tag">win</span> 510, <span class="hljs-selector-tag">options</span> <span class="hljs-selector-attr">[nop,nop,TS val 1800383985 ecr 331260304]</span>, <span class="hljs-selector-tag">length</span> 35: <span class="hljs-selector-tag">SMTP</span>: 220 <span class="hljs-selector-tag">inlane</span> <span class="hljs-selector-tag">ESMTP</span> <span class="hljs-selector-tag">Postfix</span> (<span class="hljs-selector-tag">Ubuntu</span>)
18<span class="hljs-selector-pseudo">:28</span><span class="hljs-selector-pseudo">:07.319426</span> <span class="hljs-selector-tag">IP</span> 10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.2</span><span class="hljs-selector-class">.59618</span> &gt; 10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.2</span><span class="hljs-selector-class">.28</span><span class="hljs-selector-class">.smtp</span>: <span class="hljs-selector-tag">Flags</span> <span class="hljs-selector-attr">[.]</span>, <span class="hljs-selector-tag">ack</span> 36, <span class="hljs-selector-tag">win</span> 2058, <span class="hljs-selector-tag">options</span> <span class="hljs-selector-attr">[nop,nop,TS val 331260368 ecr 1800383985]</span>, <span class="hljs-selector-tag">length</span> 0
</code></pre>
<p>The first three lines show us the three-way handshake.</p>
<table><thead><tr><th width="75"></th><th width="156"></th><th></th></tr></thead><tbody><tr><td>1.</td><td><code>[SYN]</code></td><td><code>18:28:07.128564 IP 10.10.14.2.59618 &gt; 10.129.2.28.smtp: Flags [S], &#x3C;SNIP&gt;</code></td></tr><tr><td>2.</td><td><code>[SYN-ACK]</code></td><td><code>18:28:07.255151 IP 10.129.2.28.smtp &gt; 10.10.14.2.59618: Flags [S.], &#x3C;SNIP&gt;</code></td></tr><tr><td>3.</td><td><code>[ACK]</code></td><td><code>18:28:07.255281 IP 10.10.14.2.59618 &gt; 10.129.2.28.smtp: Flags [.], &#x3C;SNIP&gt;</code></td></tr></tbody></table>

<p>After that, the target SMTP server sends us a TCP packet with the <code>PSH</code> and <code>ACK</code> flags, where <code>PSH</code> states that the target server is sending data to us and with <code>ACK</code> simultaneously informs us that all required data has been sent.</p>
<table><thead><tr><th width="86"></th><th width="154"></th><th></th></tr></thead><tbody><tr><td>4.</td><td><code>[PSH-ACK]</code></td><td><code>18:28:07.319306 IP 10.129.2.28.smtp &gt; 10.10.14.2.59618: Flags [P.], &#x3C;SNIP&gt;</code></td></tr></tbody></table>

<p>The last TCP packet that we sent confirms the receipt of the data with an <code>ACK</code>.</p>
<table><thead><tr><th width="69"></th><th width="112"></th><th></th></tr></thead><tbody><tr><td>5.</td><td><code>[ACK]</code></td><td><code>18:28:07.319426 IP 10.10.14.2.59618 &gt; 10.129.2.28.smtp: Flags [.], &#x3C;SNIP&gt;</code></td></tr></tbody></table>

<h2 id="nmap-scripting-engine">Nmap Scripting Engine</h2>
<hr>
<p>Nmap Scripting Engine (<code>NSE</code>) is another handy feature of <code>Nmap</code>. It provides us with the possibility to create scripts in Lua for interaction with certain services. There are a total of 14 categories into which these scripts can be divided:</p>
<table data-header-hidden><thead><tr><th width="170"></th><th></th></tr></thead><tbody><tr><td><strong>Category</strong></td><td><strong>Description</strong></td></tr><tr><td><code>auth</code></td><td>Determination of authentication credentials.</td></tr><tr><td><code>broadcast</code></td><td>Scripts, which are used for host discovery by broadcasting and the discovered hosts, can be automatically added to the remaining scans.</td></tr><tr><td><code>brute</code></td><td>Executes scripts that try to log in to the respective service by brute-forcing with credentials.</td></tr><tr><td><code>default</code></td><td>Default scripts executed by using the <code>-sC</code> option.</td></tr><tr><td><code>discovery</code></td><td>Evaluation of accessible services.</td></tr><tr><td><code>dos</code></td><td>These scripts are used to check services for denial of service vulnerabilities and are used less as it harms the services.</td></tr><tr><td><code>exploit</code></td><td>This category of scripts tries to exploit known vulnerabilities for the scanned port.</td></tr><tr><td><code>external</code></td><td>Scripts that use external services for further processing.</td></tr><tr><td><code>fuzzer</code></td><td>This uses scripts to identify vulnerabilities and unexpected packet handling by sending different fields, which can take much time.</td></tr><tr><td><code>intrusive</code></td><td>Intrusive scripts that could negatively affect the target system.</td></tr><tr><td><code>malware</code></td><td>Checks if some malware infects the target system.</td></tr><tr><td><code>safe</code></td><td>Defensive scripts that do not perform intrusive and destructive access.</td></tr><tr><td><code>version</code></td><td>Extension for service detection.</td></tr><tr><td><code>vuln</code></td><td>Identification of specific vulnerabilities.</td></tr></tbody></table>

<p>We have several ways to define the desired scripts in <code>Nmap</code>.</p>
<p><strong>Default Scripts</strong></p>
<p>Nmap Scripting Engine</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ sudo nmap &lt;<span class="hljs-keyword">target</span>&gt; -sC
</code></pre>
<p><strong>Specific Scripts Category</strong></p>
<p>Nmap Scripting Engine</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb[/htb]$</span> sudo nmap <span class="hljs-variable">&lt;target&gt;</span> --script <span class="hljs-variable">&lt;category&gt;</span>
</code></pre>
<p><strong>Defined Scripts</strong></p>
<p>Nmap Scripting Engine</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb[/htb]$</span> sudo nmap <span class="hljs-variable">&lt;target&gt;</span> --script <span class="hljs-variable">&lt;script-name&gt;</span>,<span class="hljs-variable">&lt;script-name&gt;</span>,...
</code></pre>
<p>For example, let us keep working with the target SMTP port and see the results we get with two defined scripts.</p>
<p><strong>Nmap - Specifying Scripts</strong></p>
<p>Nmap Scripting Engine</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span> -p <span class="hljs-number">25</span> --script banner,smtp-commands

Starting Nmap <span class="hljs-number">7.80</span> ( <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org ) at 2020-06-16 23:21 CEST</span>
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span>
Host is up (<span class="hljs-number">0.050</span>s latency).

PORT   STATE SERVICE
<span class="hljs-number">25</span>/tcp open  smtp
|<span class="hljs-string">_banner:</span> <span class="hljs-number">220</span> inlane ESMTP Postfix (Ubuntu)
|_smtp-<span class="hljs-string">commands:</span> inlane, PIPELINING, SIZE <span class="hljs-number">10240000</span>, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, <span class="hljs-number">8</span>BITMIME, DSN, SMTPUTF8,
MAC <span class="hljs-string">Address:</span> <span class="hljs-string">DE:</span><span class="hljs-string">AD:</span><span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-string">BE:</span>EF (Intel Corporate)
</code></pre>
<table data-header-hidden><thead><tr><th width="277"></th><th></th></tr></thead><tbody><tr><td><strong>Scanning Options</strong></td><td><strong>Description</strong></td></tr><tr><td><code>10.129.2.28</code></td><td>Scans the specified target.</td></tr><tr><td><code>-p 25</code></td><td>Scans only the specified port.</td></tr><tr><td><code>--script banner,smtp-commands</code></td><td>Uses specified NSE scripts.</td></tr></tbody></table>

<p>We see that we can recognize the <strong>Ubuntu</strong> distribution of Linux by using the&#39; banner&#39; script. The <code>smtp-commands</code> script shows us which commands we can use by interacting with the target SMTP server. In this example, such information may help us to find out existing users on the target. <code>Nmap</code> also gives us the ability to scan our target with the aggressive option (<code>-A</code>). This scans the target with multiple options as service detection (<code>-sV</code>), OS detection (<code>-O</code>), traceroute (<code>--traceroute</code>), and with the default NSE scripts (<code>-sC</code>).</p>
<p><strong>Nmap - Aggressive Scan</strong></p>
<p>Nmap Scripting Engine</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -p <span class="hljs-number">80</span> -A
Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">17</span> <span class="hljs-number">01</span>:<span class="hljs-number">38</span> CEST
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>012s latency).

PORT   STATE SERVICE VERSION
<span class="hljs-number">80</span>/tcp open  http    Apache httpd <span class="hljs-number">2.4</span><span class="hljs-meta">.29</span> ((Ubuntu))
|_http-generator: WordPress <span class="hljs-number">5.3</span><span class="hljs-meta">.4</span>
|_http-server-header: Apache/<span class="hljs-number">2.4</span><span class="hljs-meta">.29</span> (Ubuntu)
|_http-title: blog.inlanefreight.com
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)
<span class="hljs-symbol">Warning:</span> OSScan results may be unreliable because we could <span class="hljs-keyword">not</span> find <span class="hljs-meta">at</span> least <span class="hljs-number">1</span> open <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> closed port
Aggressive OS guesses: Linux <span class="hljs-number">2.6</span><span class="hljs-meta">.32</span> (<span class="hljs-number">96</span>%), Linux <span class="hljs-number">3.2</span> - <span class="hljs-number">4.9</span> (<span class="hljs-number">96</span>%), Linux <span class="hljs-number">2.6</span><span class="hljs-meta">.32</span> - <span class="hljs-number">3.10</span> (<span class="hljs-number">96</span>%), Linux <span class="hljs-number">3.4</span> - <span class="hljs-number">3.10</span> (<span class="hljs-number">95</span>%), Linux <span class="hljs-number">3.1</span> (<span class="hljs-number">95</span>%), Linux <span class="hljs-number">3.2</span> (<span class="hljs-number">95</span>%), 
AXIS 210A <span class="hljs-keyword">or</span> <span class="hljs-number">211</span> Network Camera (Linux <span class="hljs-number">2.6</span><span class="hljs-meta">.17</span>) (<span class="hljs-number">94</span>%), Synology DiskStation Manager <span class="hljs-number">5.2</span>-<span class="hljs-number">5644</span> (<span class="hljs-number">94</span>%), Netgear RAIDiator <span class="hljs-number">4.2</span><span class="hljs-meta">.28</span> (<span class="hljs-number">94</span>%), 
Linux <span class="hljs-number">2.6</span><span class="hljs-meta">.32</span> - <span class="hljs-number">2.6</span><span class="hljs-meta">.35</span> (<span class="hljs-number">94</span>%)
No exact OS matches for host (<span class="hljs-keyword">test</span> conditions non-ideal).
Network Distance: <span class="hljs-number">1</span> hop

TRACEROUTE
HOP RTT      ADDRESS
<span class="hljs-number">1</span>   <span class="hljs-number">11.91</span> ms <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>

OS <span class="hljs-keyword">and</span> Service detection performed. Please report any incorrect results <span class="hljs-meta">at</span> https://nmap.org/submit/ .
Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">11.36</span> seconds
</code></pre>
<table data-header-hidden><thead><tr><th width="204"></th><th></th></tr></thead><tbody><tr><td><strong>Scanning Options</strong></td><td><strong>Description</strong></td></tr><tr><td><code>10.129.2.28</code></td><td>Scans the specified target.</td></tr><tr><td><code>-p 25</code></td><td>Scans only the specified port.</td></tr><tr><td><code>-A</code></td><td>Performs service detection, OS detection, traceroute and uses defaults scripts to scan the target.</td></tr></tbody></table>

<p>With the help of the used scan option (<code>-A</code>), we found out what kind of web server (<code>Apache 2.4.29</code>) is running on the system, which web application (<code>WordPress 5.3.4</code>) is used, and the title (<code>blog.inlanefreight.com</code>) of the web page. Also, <code>Nmap</code> shows that it is likely to be <code>Linux</code> (<code>96%</code>) operating system.</p>
<hr>
<h3 id="vulnerability-assessment">Vulnerability Assessment</h3>
<p>Now let us move on to HTTP port 80 and see what information and vulnerabilities we can find using the <code>vuln</code> category from <code>NSE</code>.</p>
<p><strong>Nmap - Vuln Category</strong></p>
<p>Nmap Scripting Engine</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span> -p <span class="hljs-number">80</span> -sV --script vuln 

Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span>
Host is up (<span class="hljs-number">0.036</span>s latency).

PORT   STATE SERVICE VERSION
<span class="hljs-number">80</span>/tcp open  http    Apache httpd <span class="hljs-number">2.4</span><span class="hljs-number">.29</span> ((Ubuntu))
| <span class="hljs-type">http</span>-enum:
|   <span class="hljs-type">/wp</span>-login.php: Possible admin folder
|   <span class="hljs-type">/readme</span>.html: Wordpress version: <span class="hljs-number">2</span>
|   <span class="hljs-type">/: WordPress</span> version: <span class="hljs-number">5.3</span><span class="hljs-number">.4</span>
|   <span class="hljs-type">/wp</span>-includes/images/rss.png: Wordpress version <span class="hljs-number">2.2</span> found.
|   <span class="hljs-type">/wp</span>-includes/js/jquery/suggest.js: Wordpress version <span class="hljs-number">2.5</span> found.
|   <span class="hljs-type">/wp</span>-includes/images/blank.gif: Wordpress version <span class="hljs-number">2.6</span> found.
|   <span class="hljs-type">/wp</span>-includes/js/comment-reply.js: Wordpress version <span class="hljs-number">2.7</span> found.
|   <span class="hljs-type">/wp</span>-login.php: Wordpress login page.
|   <span class="hljs-type">/wp</span>-admin/upgrade.php: Wordpress login page.
|<span class="hljs-type">_</span>  /readme.html: Interesting, a readme.
|<span class="hljs-type">_http</span>-server-header: Apache/<span class="hljs-number">2.4</span><span class="hljs-number">.29</span> (Ubuntu)
|<span class="hljs-type">_http</span>-stored-xss: Couldn't find any stored XSS vulnerabilities.
| <span class="hljs-type">http</span>-wordpress-users:
| <span class="hljs-type">Username</span> found: admin
|<span class="hljs-type">_Search</span> stopped <span class="hljs-built_in">at</span> ID #<span class="hljs-number">25.</span> Increase the upper limit <span class="hljs-keyword">if</span> necessary <span class="hljs-built_in">with</span> 'http-wordpress-users.limit'
| <span class="hljs-type">vulners</span>:
|   <span class="hljs-type">cpe</span>:/a:apache:http_server:<span class="hljs-number">2.4</span><span class="hljs-number">.29</span>:
|         <span class="hljs-type">CVE</span><span class="hljs-number">-2019</span><span class="hljs-number">-0211</span>    <span class="hljs-number">7.2</span>    https://vulners.com/cve/CVE<span class="hljs-number">-2019</span><span class="hljs-number">-0211</span>
|         <span class="hljs-type">CVE</span><span class="hljs-number">-2018</span><span class="hljs-number">-1312</span>    <span class="hljs-number">6.8</span>    https://vulners.com/cve/CVE<span class="hljs-number">-2018</span><span class="hljs-number">-1312</span>
|         <span class="hljs-type">CVE</span><span class="hljs-number">-2017</span><span class="hljs-number">-15715</span>    <span class="hljs-number">6.8</span>    https://vulners.com/cve/CVE<span class="hljs-number">-2017</span><span class="hljs-number">-15715</span>
&lt;SNIP&gt;
</code></pre>
<table data-header-hidden><thead><tr><th width="207"></th><th></th></tr></thead><tbody><tr><td><strong>Scanning Options</strong></td><td><strong>Description</strong></td></tr><tr><td><code>10.129.2.28</code></td><td>Scans the specified target.</td></tr><tr><td><code>-p 80</code></td><td>Scans only the specified port.</td></tr><tr><td><code>-sV</code></td><td>Performs service version detection on specified ports.</td></tr><tr><td><code>--script vuln</code></td><td>Uses all related scripts from specified category.</td></tr></tbody></table>

<p>The scripts used for the last scan interact with the webserver and its web application to find out more information about their versions and check various databases to see if there are known vulnerabilities. More information about NSE scripts and the corresponding categories we can find at: <a href="https://nmap.org/nsedoc/index.html">https://nmap.org/nsedoc/index.html</a></p>
<h2 id="performance">Performance</h2>
<hr>
<p>Scanning performance plays a significant role when we need to scan an extensive network or are dealing with low network bandwidth. We can use various options to tell <code>Nmap</code> how fast (<code>-T &lt;0-5&gt;</code>), with which frequency (<code>--min-parallelism &lt;number&gt;</code>), which timeouts (<code>--max-rtt-timeout &lt;time&gt;</code>) the test packets should have, how many packets should be sent simultaneously (<code>--min-rate &lt;number&gt;</code>), and with the number of retries (<code>--max-retries &lt;number&gt;</code>) for the scanned ports the targets should be scanned.</p>
<hr>
<h3 id="timeouts">Timeouts</h3>
<p>When Nmap sends a packet, it takes some time (<code>Round-Trip-Time</code> - <code>RTT</code>) to receive a response from the scanned port. Generally, <code>Nmap</code> starts with a high timeout (<code>--min-RTT-timeout</code>) of 100ms. Let us look at an example by scanning the whole network with 256 hosts, including the top 100 ports.</p>
<p><strong>Default Scan</strong></p>
<p>Performance</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.0</span>/<span class="hljs-number">24</span> -F

&lt;SNIP&gt;
Nmap done: <span class="hljs-number">256</span> <span class="hljs-built_in">IP</span> addresses (<span class="hljs-number">10</span> hosts <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">39.44</span> seconds
</code></pre>
<p><strong>Optimized RTT</strong></p>
<p>Performance</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.0</span>/<span class="hljs-number">24</span> -F --initial-rtt-timeout 50ms --max-rtt-timeout 100ms

&lt;SNIP&gt;
Nmap done: <span class="hljs-number">256</span> <span class="hljs-built_in">IP</span> addresses (<span class="hljs-number">8</span> hosts <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">12.29</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.0/24</code></td>
<td>Scans the specified target network.</td>
</tr>
<tr>
<td><code>-F</code></td>
<td>Scans top 100 ports.</td>
</tr>
<tr>
<td><code>--initial-rtt-timeout 50ms</code></td>
<td>Sets the specified time value as initial RTT timeout.</td>
</tr>
<tr>
<td><code>--max-rtt-timeout 100ms</code></td>
<td>Sets the specified time value as maximum RTT timeout.</td>
</tr>
</tbody>
</table>
<p>When comparing the two scans, we can see that we found two hosts less with the optimized scan, but the scan took only a quarter of the time. From this, we can conclude that setting the initial RTT timeout (<code>--initial-rtt-timeout</code>) to too short a time period may cause us to overlook hosts.</p>
<hr>
<h3 id="max-retries">Max Retries</h3>
<p>Another way to increase the scans&#39; speed is to specify the retry rate of the sent packets (<code>--max-retries</code>). The default value for the retry rate is <code>10</code>, so if <code>Nmap</code> does not receive a response for a port, it will not send any more packets to the port and will be skipped.</p>
<p><strong>Default Scan</strong></p>
<p>Performance</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> -F | grep <span class="hljs-string">"/tcp"</span> | wc -l

<span class="hljs-number">23</span>
</code></pre>
<p><strong>Reduced Retries</strong></p>
<p>Performance</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> -F --max-retries <span class="hljs-number">0</span> | grep <span class="hljs-string">"/tcp"</span> | wc -l

<span class="hljs-number">21</span>
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.0/24</code></td>
<td>Scans the specified target network.</td>
</tr>
<tr>
<td><code>-F</code></td>
<td>Scans top 100 ports.</td>
</tr>
<tr>
<td><code>--max-retries 0</code></td>
<td>Sets the number of retries that will be performed during the scan.</td>
</tr>
</tbody>
</table>
<p>Again, we recognize that accelerating can also have a negative effect on our results, which means we can overlook important information.</p>
<hr>
<h3 id="rates">Rates</h3>
<p>During a white-box penetration test, we may get whitelisted for the security systems to check the systems in the network for vulnerabilities and not only test the protection measures. If we know the network bandwidth, we can work with the rate of packets sent, which significantly speeds up our scans with <code>Nmap</code>. When setting the minimum rate (<code>--min-rate &lt;number&gt;</code>) for sending packets, we tell <code>Nmap</code> to simultaneously send the specified number of packets. It will attempt to maintain the rate accordingly.</p>
<p><strong>Default Scan</strong></p>
<p>Performance</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo nmap 10.129.2.0/</span><span class="hljs-number">24</span> -F -oN tnet.<span class="hljs-keyword">default</span>

&lt;SNIP&gt;
Nmap <span class="hljs-string">done:</span> <span class="hljs-number">256</span> IP addresses (<span class="hljs-number">10</span> hosts up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">29.83</span> seconds
</code></pre>
<p><strong>Optimized Scan</strong></p>
<p>Performance</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.0</span>/<span class="hljs-number">24</span> -F -oN tnet.minrate300 --min-rate <span class="hljs-number">300</span>

&lt;SNIP&gt;
Nmap done: <span class="hljs-number">256</span> <span class="hljs-built_in">IP</span> addresses (<span class="hljs-number">10</span> hosts <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">8.67</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.0/24</code></td>
<td>Scans the specified target network.</td>
</tr>
<tr>
<td><code>-F</code></td>
<td>Scans top 100 ports.</td>
</tr>
<tr>
<td><code>-oN tnet.minrate300</code></td>
<td>Saves the results in normal formats, starting the specified file name.</td>
</tr>
<tr>
<td><code>--min-rate 300</code></td>
<td>Sets the minimum number of packets to be sent per second.</td>
</tr>
</tbody>
</table>
<hr>
<p><strong>Default Scan - Found Open Ports</strong></p>
<p>Performance</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ cat tnet.<span class="hljs-keyword">default</span> | grep <span class="hljs-string">"/tcp"</span> | wc -l

<span class="hljs-number">23</span>
</code></pre>
<p><strong>Optimized Scan - Found Open Ports</strong></p>
<p>Performance</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat tnet.minrate300 | <span class="hljs-type">grep</span> <span class="hljs-string">"/tcp"</span> | <span class="hljs-type">wc</span> -l

<span class="hljs-number">23</span>
</code></pre>
<hr>
<h3 id="timing">Timing</h3>
<p>Because such settings cannot always be optimized manually, as in a black-box penetration test, <code>Nmap</code> offers six different timing templates (<code>-T &lt;0-5&gt;</code>) for us to use. These values (<code>0-5</code>) determine the aggressiveness of our scans. This can also have negative effects if the scan is too aggressive, and security systems may block us due to the produced network traffic. The default timing template used when we have defined nothing else is the normal (<code>-T 3</code>).</p>
<ul>
<li><code>-T 0</code> / <code>-T paranoid</code></li>
<li><code>-T 1</code> / <code>-T sneaky</code></li>
<li><code>-T 2</code> / <code>-T polite</code></li>
<li><code>-T 3</code> / <code>-T normal</code></li>
<li><code>-T 4</code> / <code>-T aggressive</code></li>
<li><code>-T 5</code> / <code>-T insane</code></li>
</ul>
<p>These templates contain options that we can also set manually, and have seen some of them already. The developers determined the values set for these templates according to their best results, making it easier for us to adapt our scans to the corresponding network environment. The exact used options with their values we can find here: <a href="https://nmap.org/book/performance-timing-templates.html">https://nmap.org/book/performance-timing-templates.html</a></p>
<p><strong>Default Scan</strong></p>
<p>Performance</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo nmap 10.129.2.0/</span><span class="hljs-number">24</span> -F -oN tnet.<span class="hljs-keyword">default</span> 

&lt;SNIP&gt;
Nmap <span class="hljs-string">done:</span> <span class="hljs-number">256</span> IP addresses (<span class="hljs-number">10</span> hosts up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">32.44</span> seconds
</code></pre>
<p><strong>Insane Scan</strong></p>
<p>Performance</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.0</span>/<span class="hljs-number">24</span> -F -oN tnet.T5 -T <span class="hljs-number">5</span>

&lt;SNIP&gt;
Nmap done: <span class="hljs-number">256</span> <span class="hljs-built_in">IP</span> addresses (<span class="hljs-number">10</span> hosts <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">18.07</span> seconds
</code></pre>
<table>
<thead>
<tr>
<th><strong>Scanning Options</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>10.129.2.0/24</code></td>
<td>Scans the specified target network.</td>
</tr>
<tr>
<td><code>-F</code></td>
<td>Scans top 100 ports.</td>
</tr>
<tr>
<td><code>-oN tnet.T5</code></td>
<td>Saves the results in normal formats, starting the specified file name.</td>
</tr>
<tr>
<td><code>-T 5</code></td>
<td>Specifies the insane timing template.</td>
</tr>
</tbody>
</table>
<hr>
<p><strong>Default Scan - Found Open Ports</strong></p>
<p>Performance</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ cat tnet.<span class="hljs-keyword">default</span> | grep <span class="hljs-string">"/tcp"</span> | wc -l

<span class="hljs-number">23</span>
</code></pre>
<p><strong>Insane Scan - Found Open Ports</strong></p>
<p>Performance</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat tnet.T5 | <span class="hljs-type">grep</span> <span class="hljs-string">"/tcp"</span> | <span class="hljs-type">wc</span> -l

<span class="hljs-number">23</span>
</code></pre>
<hr>
<p>More information about scan performance we can find at <a href="https://nmap.org/book/man-performance.html">https://nmap.org/book/man-performance.html</a></p>
<ol>
<li>\
Page 9</li>
<li>Firewall and IDS/IPS Evasion</li>
</ol>
<h2 id="firewall-and-ids-ips-evasion">Firewall and IDS/IPS Evasion</h2>
<hr>
<p><code>Nmap</code> gives us many different ways to bypass firewalls rules and IDS/IPS. These methods include the fragmentation of packets, the use of decoys, and others that we will discuss in this section.</p>
<hr>
<h3 id="firewalls">Firewalls</h3>
<p>A firewall is a security measure against unauthorized connection attempts from external networks. Every firewall security system is based on a software component that monitors network traffic between the firewall and incoming data connections and decides how to handle the connection based on the rules that have been set. It checks whether individual network packets are being passed, ignored, or blocked. This mechanism is designed to prevent unwanted connections that could be potentially dangerous.</p>
<hr>
<h3 id="ids-ips">IDS/IPS</h3>
<p>Like the firewall, the intrusion detection system (<code>IDS</code>) and intrusion prevention system (<code>IPS</code>) are also software-based components. <code>IDS</code> scans the network for potential attacks, analyzes them, and reports any detected attacks. <code>IPS</code> complements <code>IDS</code> by taking specific defensive measures if a potential attack should have been detected. The analysis of such attacks is based on pattern matching and signatures. If specific patterns are detected, such as a service detection scan, <code>IPS</code> may prevent the pending connection attempts.</p>
<hr>
<p><strong>Determine Firewalls and Their Rules</strong></p>
<p>We already know that when a port is shown as filtered, it can have several reasons. In most cases, firewalls have certain rules set to handle specific connections. The packets can either be <code>dropped</code>, or <code>rejected</code>. The <code>dropped</code> packets are ignored, and no response is returned from the host.</p>
<p>This is different for <code>rejected</code> packets that are returned with an <code>RST</code> flag. These packets contain different types of ICMP error codes or contain nothing at all.</p>
<p>Such errors can be:</p>
<ul>
<li>Net Unreachable</li>
<li>Net Prohibited</li>
<li>Host Unreachable</li>
<li>Host Prohibited</li>
<li>Port Unreachable</li>
<li>Proto Unreachable</li>
</ul>
<p>Nmap&#39;s TCP ACK scan (<code>-sA</code>) method is much harder to filter for firewalls and IDS/IPS systems than regular SYN (<code>-sS</code>) or Connect scans (<code>sT</code>) because they only send a TCP packet with only the <code>ACK</code> flag. When a port is closed or open, the host must respond with an <code>RST</code> flag. Unlike outgoing connections, all connection attempts (with the <code>SYN</code> flag) from external networks are usually blocked by firewalls. However, the packets with the <code>ACK</code> flag are often passed by the firewall because the firewall cannot determine whether the connection was first established from the external network or the internal network.</p>
<p>If we look at these scans, we will see how the results differ.</p>
<p><strong>SYN-Scan</strong></p>
<p>Firewall and IDS/IPS Evasion</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -p <span class="hljs-number">21</span>,<span class="hljs-number">22</span>,<span class="hljs-number">25</span> -<span class="hljs-built_in">sS</span> -Pn -n --disable-arp-ping --packet-trace

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">21</span> <span class="hljs-number">14</span>:<span class="hljs-number">56</span> CEST
SENT (<span class="hljs-number">0.</span>0278s) TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">57347</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">22</span> S ttl=<span class="hljs-number">53</span> id=<span class="hljs-number">22412</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">4092255222</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
SENT (<span class="hljs-number">0.</span>0278s) TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">57347</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">25</span> S ttl=<span class="hljs-number">50</span> id=<span class="hljs-number">62291</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">4092255222</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
SENT (<span class="hljs-number">0.</span>0278s) TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">57347</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">21</span> S ttl=<span class="hljs-number">58</span> id=<span class="hljs-number">38696</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">4092255222</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
RCVD (<span class="hljs-number">0.</span>0329s) ICMP [<span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> &gt; <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span> Port <span class="hljs-number">21</span> unreachable (type=<span class="hljs-number">3</span>/code=<span class="hljs-number">3</span>) ] <span class="hljs-built_in">IP</span> [ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">40884</span> iplen=<span class="hljs-number">72</span> ]
RCVD (<span class="hljs-number">0.</span>0341s) TCP <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">22</span> &gt; <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">57347</span> SA ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">0</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">1153454414</span> win=<span class="hljs-number">64240</span> &lt;mss <span class="hljs-number">1460</span>&gt;
RCVD (<span class="hljs-number">1.</span>0386s) TCP <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">22</span> &gt; <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">57347</span> SA ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">0</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">1153454414</span> win=<span class="hljs-number">64240</span> &lt;mss <span class="hljs-number">1460</span>&gt;
SENT (<span class="hljs-number">1.</span>1366s) TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">57348</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">25</span> S ttl=<span class="hljs-number">44</span> id=<span class="hljs-number">6796</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">4092320759</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>0053s latency).

PORT   STATE    SERVICE
<span class="hljs-number">21</span>/tcp filtered ftp
<span class="hljs-number">22</span>/tcp open     ssh
<span class="hljs-number">25</span>/tcp filtered smtp
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.07</span> seconds
</code></pre>
<p><strong>ACK-Scan</strong></p>
<p>Firewall and IDS/IPS Evasion</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -p <span class="hljs-number">21</span>,<span class="hljs-number">22</span>,<span class="hljs-number">25</span> -sA -Pn -n --disable-arp-ping --packet-trace

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">21</span> <span class="hljs-number">14</span>:<span class="hljs-number">57</span> CEST
SENT (<span class="hljs-number">0.</span>0422s) TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">49343</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">21</span> A ttl=<span class="hljs-number">49</span> id=<span class="hljs-number">12381</span> iplen=<span class="hljs-number">40</span>  seq=<span class="hljs-number">0</span> win=<span class="hljs-number">1024</span>
SENT (<span class="hljs-number">0.</span>0423s) TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">49343</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">22</span> A ttl=<span class="hljs-number">41</span> id=<span class="hljs-number">5146</span> iplen=<span class="hljs-number">40</span>  seq=<span class="hljs-number">0</span> win=<span class="hljs-number">1024</span>
SENT (<span class="hljs-number">0.</span>0423s) TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">49343</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">25</span> A ttl=<span class="hljs-number">49</span> id=<span class="hljs-number">5800</span> iplen=<span class="hljs-number">40</span>  seq=<span class="hljs-number">0</span> win=<span class="hljs-number">1024</span>
RCVD (<span class="hljs-number">0.</span>1252s) ICMP [<span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> &gt; <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span> Port <span class="hljs-number">21</span> unreachable (type=<span class="hljs-number">3</span>/code=<span class="hljs-number">3</span>) ] <span class="hljs-built_in">IP</span> [ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">55628</span> iplen=<span class="hljs-number">68</span> ]
RCVD (<span class="hljs-number">0.</span>1268s) TCP <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">22</span> &gt; <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">49343</span> R ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">0</span> iplen=<span class="hljs-number">40</span>  seq=<span class="hljs-number">1660784500</span> win=<span class="hljs-number">0</span>
SENT (<span class="hljs-number">1.</span>3837s) TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">49344</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">25</span> A ttl=<span class="hljs-number">59</span> id=<span class="hljs-number">21915</span> iplen=<span class="hljs-number">40</span>  seq=<span class="hljs-number">0</span> win=<span class="hljs-number">1024</span>
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>083s latency).

PORT   STATE      SERVICE
<span class="hljs-number">21</span>/tcp filtered   ftp
<span class="hljs-number">22</span>/tcp unfiltered ssh
<span class="hljs-number">25</span>/tcp filtered   smtp
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.15</span> seconds
</code></pre>
<table data-header-hidden><thead><tr><th width="262"></th><th></th></tr></thead><tbody><tr><td><strong>Scanning Options</strong></td><td><strong>Description</strong></td></tr><tr><td><code>10.129.2.28</code></td><td>Scans the specified target.</td></tr><tr><td><code>-p 21,22,25</code></td><td>Scans only the specified ports.</td></tr><tr><td><code>-sS</code></td><td>Performs SYN scan on specified ports.</td></tr><tr><td><code>-sA</code></td><td>Performs ACK scan on specified ports.</td></tr><tr><td><code>-Pn</code></td><td>Disables ICMP Echo requests.</td></tr><tr><td><code>-n</code></td><td>Disables DNS resolution.</td></tr><tr><td><code>--disable-arp-ping</code></td><td>Disables ARP ping.</td></tr><tr><td><code>--packet-trace</code></td><td>Shows all packets sent and received.</td></tr></tbody></table>

<p>Please pay attention to the RCVD packets and its set flag we receive from our target. With the SYN scan (<code>-sS</code>) our target tries to establish the TCP connection by sending a packet back with the SYN-ACK (<code>SA</code>) flags set and with the ACK scan (<code>-sA</code>) we get the <code>RST</code> flag because TCP port 22 is open. For the TCP port 25, we do not receive any packets back, which indicates that the packets will be dropped.</p>
<hr>
<h3 id="detect-ids-ips">Detect IDS/IPS</h3>
<p>Unlike firewalls and their rules, the detection of IDS/IPS systems is much more difficult because these are passive traffic monitoring systems. <code>IDS systems</code> examine all connections between hosts. If the IDS finds packets containing the defined contents or specifications, the administrator is notified and takes appropriate action in the worst case.</p>
<p><code>IPS systems</code> take measures configured by the administrator independently to prevent potential attacks automatically. It is essential to know that IDS and IPS are different applications and that IPS serves as a complement to IDS.</p>
<p>Several virtual private servers (<code>VPS</code>) with different IP addresses are recommended to determine whether such systems are on the target network during a penetration test. If the administrator detects such a potential attack on the target network, the first step is to block the IP address from which the potential attack comes. As a result, we will no longer be able to access the network using that IP address, and our Internet Service Provider (<code>ISP</code>) will be contacted and blocked from all access to the Internet.</p>
<ul>
<li><code>IDS systems</code> alone are usually there to help administrators detect potential attacks on their network. They can then decide how to handle such connections. We can trigger certain security measures from an administrator, for example, by aggressively scanning a single port and its service. Based on whether specific security measures are taken, we can detect if the network has some monitoring applications or not.</li>
<li>One method to determine whether such <code>IPS system</code> is present in the target network is to scan from a single host (<code>VPS</code>). If at any time this host is blocked and has no access to the target network, we know that the administrator has taken some security measures. Accordingly, we can continue our penetration test with another <code>VPS</code>.</li>
</ul>
<p>Consequently, we know that we need to be quieter with our scans and, in the best case, disguise all interactions with the target network and its services.</p>
<hr>
<h3 id="decoys">Decoys</h3>
<p>There are cases in which administrators block specific subnets from different regions in principle. This prevents any access to the target network. Another example is when IPS should block us. For this reason, the Decoy scanning method (<code>-D</code>) is the right choice. With this method, Nmap generates various random IP addresses inserted into the IP header to disguise the origin of the packet sent. With this method, we can generate random (<code>RND</code>) a specific number (for example: <code>5</code>) of IP addresses separated by a colon (<code>:</code>). Our real IP address is then randomly placed between the generated IP addresses. In the next example, our real IP address is therefore placed in the second position. Another critical point is that the decoys must be alive. Otherwise, the service on the target may be unreachable due to SYN-flooding security mechanisms.</p>
<p><strong>Scan by Using Decoys</strong></p>
<p>Firewall and IDS/IPS Evasion</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -p <span class="hljs-number">80</span> -<span class="hljs-built_in">sS</span> -Pn -n --disable-arp-ping --packet-trace -D RND:<span class="hljs-number">5</span>

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">21</span> <span class="hljs-number">16</span>:<span class="hljs-number">14</span> CEST
SENT (<span class="hljs-number">0.</span>0378s) TCP <span class="hljs-number">102.52</span><span class="hljs-meta">.161</span><span class="hljs-meta">.59</span>:<span class="hljs-number">59289</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">80</span> S ttl=<span class="hljs-number">42</span> id=<span class="hljs-number">29822</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">3687542010</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
SENT (<span class="hljs-number">0.</span>0378s) TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">59289</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">80</span> S ttl=<span class="hljs-number">59</span> id=<span class="hljs-number">29822</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">3687542010</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
SENT (<span class="hljs-number">0.</span>0379s) TCP <span class="hljs-number">210.120</span><span class="hljs-meta">.38</span><span class="hljs-meta">.29</span>:<span class="hljs-number">59289</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">80</span> S ttl=<span class="hljs-number">37</span> id=<span class="hljs-number">29822</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">3687542010</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
SENT (<span class="hljs-number">0.</span>0379s) TCP <span class="hljs-number">191.6</span><span class="hljs-meta">.64</span><span class="hljs-meta">.171</span>:<span class="hljs-number">59289</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">80</span> S ttl=<span class="hljs-number">38</span> id=<span class="hljs-number">29822</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">3687542010</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
SENT (<span class="hljs-number">0.</span>0379s) TCP <span class="hljs-number">184.178</span><span class="hljs-meta">.194</span><span class="hljs-meta">.209</span>:<span class="hljs-number">59289</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">80</span> S ttl=<span class="hljs-number">39</span> id=<span class="hljs-number">29822</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">3687542010</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
SENT (<span class="hljs-number">0.</span>0379s) TCP <span class="hljs-number">43.21</span><span class="hljs-meta">.121</span><span class="hljs-meta">.33</span>:<span class="hljs-number">59289</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">80</span> S ttl=<span class="hljs-number">55</span> id=<span class="hljs-number">29822</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">3687542010</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
RCVD (<span class="hljs-number">0.</span>1370s) TCP <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">80</span> &gt; <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">59289</span> SA ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">0</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">4056111701</span> win=<span class="hljs-number">64240</span> &lt;mss <span class="hljs-number">1460</span>&gt;
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>099s latency).

PORT   STATE SERVICE
<span class="hljs-number">80</span>/tcp open  http
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.15</span> seconds
</code></pre>
<table data-header-hidden><thead><tr><th width="236"></th><th></th></tr></thead><tbody><tr><td><strong>Scanning Options</strong></td><td><strong>Description</strong></td></tr><tr><td><code>10.129.2.28</code></td><td>Scans the specified target.</td></tr><tr><td><code>-p 80</code></td><td>Scans only the specified ports.</td></tr><tr><td><code>-sS</code></td><td>Performs SYN scan on specified ports.</td></tr><tr><td><code>-Pn</code></td><td>Disables ICMP Echo requests.</td></tr><tr><td><code>-n</code></td><td>Disables DNS resolution.</td></tr><tr><td><code>--disable-arp-ping</code></td><td>Disables ARP ping.</td></tr><tr><td><code>--packet-trace</code></td><td>Shows all packets sent and received.</td></tr><tr><td><code>-D RND:5</code></td><td>Generates five random IP addresses that indicates the source IP the connection comes from.</td></tr></tbody></table>

<p>The spoofed packets are often filtered out by ISPs and routers, even though they come from the same network range. Therefore, we can also specify our VPS servers&#39; IP addresses and use them in combination with &quot;<code>IP ID</code>&quot; manipulation in the IP headers to scan the target.</p>
<p>Another scenario would be that only individual subnets would not have access to the server&#39;s specific services. So we can also manually specify the source IP address (<code>-S</code>) to test if we get better results with this one. Decoys can be used for SYN, ACK, ICMP scans, and OS detection scans. So let us look at such an example and determine which operating system it is most likely to be.</p>
<p><strong>Testing Firewall Rule</strong></p>
<p>Firewall and IDS/IPS Evasion</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span> -n -Pn -p445 -O

Starting Nmap <span class="hljs-number">7.80</span> ( <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org ) at 2020-06-22 01:23 CEST</span>
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.28</span>
Host is up (<span class="hljs-number">0.032</span>s latency).

PORT    STATE    SERVICE
<span class="hljs-number">445</span>/tcp filtered microsoft-ds
MAC <span class="hljs-string">Address:</span> <span class="hljs-string">DE:</span><span class="hljs-string">AD:</span><span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-string">BE:</span>EF (Intel Corporate)
Too many fingerprints match <span class="hljs-keyword">this</span> host to give specific OS details
Network <span class="hljs-string">Distance:</span> <span class="hljs-number">1</span> hop

OS detection performed. Please report any incorrect results at <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org/submit/ .</span>
Nmap <span class="hljs-string">done:</span> <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">3.14</span> seconds
</code></pre>
<p><strong>Scan by Using Different Source IP</strong></p>
<p>Firewall and IDS/IPS Evasion</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -n -Pn -p <span class="hljs-number">445</span> -O -S <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.200</span> -e tun0

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">22</span> <span class="hljs-number">01</span>:<span class="hljs-number">16</span> CEST
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>010s latency).

PORT    STATE SERVICE
<span class="hljs-number">445</span>/tcp open  microsoft-<span class="hljs-built_in">ds</span>
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)
<span class="hljs-symbol">Warning:</span> OSScan results may be unreliable because we could <span class="hljs-keyword">not</span> find <span class="hljs-meta">at</span> least <span class="hljs-number">1</span> open <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> closed port
Aggressive OS guesses: Linux <span class="hljs-number">2.6</span><span class="hljs-meta">.32</span> (<span class="hljs-number">96</span>%), Linux <span class="hljs-number">3.2</span> - <span class="hljs-number">4.9</span> (<span class="hljs-number">96</span>%), Linux <span class="hljs-number">2.6</span><span class="hljs-meta">.32</span> - <span class="hljs-number">3.10</span> (<span class="hljs-number">96</span>%), Linux <span class="hljs-number">3.4</span> - <span class="hljs-number">3.10</span> (<span class="hljs-number">95</span>%), Linux <span class="hljs-number">3.1</span> (<span class="hljs-number">95</span>%), Linux <span class="hljs-number">3.2</span> (<span class="hljs-number">95</span>%), AXIS 210A <span class="hljs-keyword">or</span> <span class="hljs-number">211</span> Network Camera (Linux <span class="hljs-number">2.6</span><span class="hljs-meta">.17</span>) (<span class="hljs-number">94</span>%), Synology DiskStation Manager <span class="hljs-number">5.2</span>-<span class="hljs-number">5644</span> (<span class="hljs-number">94</span>%), Linux <span class="hljs-number">2.6</span><span class="hljs-meta">.32</span> - <span class="hljs-number">2.6</span><span class="hljs-meta">.35</span> (<span class="hljs-number">94</span>%), Linux <span class="hljs-number">2.6</span><span class="hljs-meta">.32</span> - <span class="hljs-number">3.5</span> (<span class="hljs-number">94</span>%)
No exact OS matches for host (<span class="hljs-keyword">test</span> conditions non-ideal).
Network Distance: <span class="hljs-number">1</span> hop

OS detection performed. Please report any incorrect results <span class="hljs-meta">at</span> https://nmap.org/submit/ .
Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">4.11</span> seconds
</code></pre>
<table data-header-hidden><thead><tr><th width="192"></th><th></th></tr></thead><tbody><tr><td><strong>Scanning Options</strong></td><td><strong>Description</strong></td></tr><tr><td><code>10.129.2.28</code></td><td>Scans the specified target.</td></tr><tr><td><code>-n</code></td><td>Disables DNS resolution.</td></tr><tr><td><code>-Pn</code></td><td>Disables ICMP Echo requests.</td></tr><tr><td><code>-p 445</code></td><td>Scans only the specified ports.</td></tr><tr><td><code>-O</code></td><td>Performs operation system detection scan.</td></tr><tr><td><code>-S</code></td><td>Scans the target by using different source IP address.</td></tr><tr><td><code>10.129.2.200</code></td><td>Specifies the source IP address.</td></tr><tr><td><code>-e tun0</code></td><td>Sends all requests through the specified interface.</td></tr></tbody></table>

<hr>
<h3 id="dns-proxying">DNS Proxying</h3>
<p>By default, <code>Nmap</code> performs a reverse DNS resolution unless otherwise specified to find more important information about our target. These DNS queries are also passed in most cases because the given web server is supposed to be found and visited. The DNS queries are made over the <code>UDP port 53</code>. The <code>TCP port 53</code> was previously only used for the so-called &quot;<code>Zone transfers</code>&quot; between the DNS servers or data transfer larger than 512 bytes. More and more, this is changing due to IPv6 and DNSSEC expansions. These changes cause many DNS requests to be made via TCP port 53.</p>
<p>However, <code>Nmap</code> still gives us a way to specify DNS servers ourselves (<code>--dns-server &lt;ns&gt;,&lt;ns&gt;</code>). This method could be fundamental to us if we are in a demilitarized zone (<code>DMZ</code>). The company&#39;s DNS servers are usually more trusted than those from the Internet. So, for example, we could use them to interact with the hosts of the internal network. As another example, we can use <code>TCP port 53</code> as a source port (<code>--source-port</code>) for our scans. If the administrator uses the firewall to control this port and does not filter IDS/IPS properly, our TCP packets will be trusted and passed through.</p>
<p><strong>SYN-Scan of a Filtered Port</strong></p>
<p>Firewall and IDS/IPS Evasion</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -p50000 -<span class="hljs-built_in">sS</span> -Pn -n --disable-arp-ping --packet-trace

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">06</span>-<span class="hljs-number">21</span> <span class="hljs-number">22</span>:<span class="hljs-number">50</span> CEST
SENT (<span class="hljs-number">0.</span>0417s) TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">33436</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">50000</span> S ttl=<span class="hljs-number">41</span> id=<span class="hljs-number">21939</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">736533153</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
SENT (<span class="hljs-number">1.</span>0481s) TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">33437</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">50000</span> S ttl=<span class="hljs-number">46</span> id=<span class="hljs-number">6446</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">736598688</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span>.

PORT      STATE    SERVICE
<span class="hljs-number">50000</span>/tcp filtered ibm-db2

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">2.06</span> seconds
</code></pre>
<p><strong>SYN-Scan From DNS Port</strong></p>
<p>Firewall and IDS/IPS Evasion</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span> -p50000 -<span class="hljs-built_in">sS</span> -Pn -n --disable-arp-ping --packet-trace --source-port <span class="hljs-number">53</span>

SENT (<span class="hljs-number">0.</span>0482s) TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">53</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">50000</span> S ttl=<span class="hljs-number">58</span> id=<span class="hljs-number">27470</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">4003923435</span> win=<span class="hljs-number">1024</span> &lt;mss <span class="hljs-number">1460</span>&gt;
RCVD (<span class="hljs-number">0.</span>0608s) TCP <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>:<span class="hljs-number">50000</span> &gt; <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.2</span>:<span class="hljs-number">53</span> SA ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">0</span> iplen=<span class="hljs-number">44</span>  seq=<span class="hljs-number">540635485</span> win=<span class="hljs-number">64240</span> &lt;mss <span class="hljs-number">1460</span>&gt;
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.28</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>013s latency).

PORT      STATE SERVICE
<span class="hljs-number">50000</span>/tcp open  ibm-db2
MAC Address: DE:AD:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:BE:EF (Intel Corporate)

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.08</span> seconds
</code></pre>
<table data-header-hidden><thead><tr><th width="289"></th><th></th></tr></thead><tbody><tr><td><strong>Scanning Options</strong></td><td><strong>Description</strong></td></tr><tr><td><code>10.129.2.28</code></td><td>Scans the specified target.</td></tr><tr><td><code>-p 50000</code></td><td>Scans only the specified ports.</td></tr><tr><td><code>-sS</code></td><td>Performs SYN scan on specified ports.</td></tr><tr><td><code>-Pn</code></td><td>Disables ICMP Echo requests.</td></tr><tr><td><code>-n</code></td><td>Disables DNS resolution.</td></tr><tr><td><code>--disable-arp-ping</code></td><td>Disables ARP ping.</td></tr><tr><td><code>--packet-trace</code></td><td>Shows all packets sent and received.</td></tr><tr><td><code>--source-port 53</code></td><td>Performs the scans from specified source port.</td></tr></tbody></table>

<hr>
<p>Now that we have found out that the firewall accepts <code>TCP port 53</code>, it is very likely that IDS/IPS filters might also be configured much weaker than others. We can test this by trying to connect to this port by using <code>Netcat</code>.</p>
<p><strong>Connect To The Filtered Port</strong></p>
<p>Firewall and IDS/IPS Evasion</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ncat -nv --<span class="hljs-keyword">source</span>-port <span class="hljs-number">53</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">2.28</span> <span class="hljs-number">50000</span>

Nca<span class="hljs-variable">t:</span> Version <span class="hljs-number">7.80</span> ( http<span class="hljs-variable">s:</span>//<span class="hljs-keyword">nmap</span>.org/ncat )
Nca<span class="hljs-variable">t:</span> Connected <span class="hljs-keyword">to</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">2.28</span>:<span class="hljs-number">50000</span>.
<span class="hljs-number">220</span> ProFTPd
</code></pre>
<hr>
<h3 id="firewall-and-ids-ips-evasion-labs">Firewall and IDS/IPS Evasion Labs</h3>
<p>In the next three sections, we get different scenarios to practice where we have to scan our target. Firewall rules and IDS/IPS protect the systems, so we need to use the techniques shown to bypass the firewall rules and do this as quiet as possible. Otherwise, we will be blocked by IPS.</p>
